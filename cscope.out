cscope 15 /home/dcslab/btrfs_4.14               0003061941
	@Module.symvers

	@acl.c

19 
	~<lšux/fs.h
>

20 
	~<lšux/¡ršg.h
>

21 
	~<lšux/x©Œ.h
>

22 
	~<lšux/posix_aþ_x©Œ.h
>

23 
	~<lšux/posix_aþ.h
>

24 
	~<lšux/sched.h
>

25 
	~<lšux/¦ab.h
>

27 
	~"ù»e.h
"

28 
	~"bŒfs_šode.h
"

29 
	~"x©Œ.h
"

31 
posix_aþ
 *
	$bŒfs_g‘_aþ
(
šode
 *šode, 
ty³
)

33 
size
;

34 cÚ¡ *
Çme
;

35 *
v®ue
 = 
NULL
;

36 
posix_aþ
 *
aþ
;

38 
ty³
) {

39 
ACL_TYPE_ACCESS
:

40 
Çme
 = 
XATTR_NAME_POSIX_ACL_ACCESS
;

42 
ACL_TYPE_DEFAULT
:

43 
Çme
 = 
XATTR_NAME_POSIX_ACL_DEFAULT
;

46 
	`BUG
();

49 
size
 = 
	`__bŒfs_g‘x©Œ
(
šode
, 
Çme
, "", 0);

50 ià(
size
 > 0) {

51 
v®ue
 = 
	`kz®loc
(
size
, 
GFP_KERNEL
);

52 ià(!
v®ue
)

53  
	`ERR_PTR
(-
ENOMEM
);

54 
size
 = 
	`__bŒfs_g‘x©Œ
(
šode
, 
Çme
, 
v®ue
, size);

56 ià(
size
 > 0) {

57 
aþ
 = 
	`posix_aþ_äom_x©Œ
(&
š™_u£r_ns
, 
v®ue
, 
size
);

58 } ià(
size
 =ð-
ERANGE
 || siz=ð-
ENODATA
 || size == 0) {

59 
aþ
 = 
NULL
;

61 
aþ
 = 
	`ERR_PTR
(-
EIO
);

63 
	`kä“
(
v®ue
);

65  
aþ
;

66 
	}
}

71 
	$__bŒfs_£t_aþ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

72 
šode
 *šode, 
posix_aþ
 *
aþ
, 
ty³
)

74 
»t
, 
size
 = 0;

75 cÚ¡ *
Çme
;

76 *
v®ue
 = 
NULL
;

78 
ty³
) {

79 
ACL_TYPE_ACCESS
:

80 
Çme
 = 
XATTR_NAME_POSIX_ACL_ACCESS
;

82 
ACL_TYPE_DEFAULT
:

83 ià(!
	`S_ISDIR
(
šode
->
i_mode
))

84  
aþ
 ? -
EINVAL
 : 0;

85 
Çme
 = 
XATTR_NAME_POSIX_ACL_DEFAULT
;

88  -
EINVAL
;

91 ià(
aþ
) {

92 
size
 = 
	`posix_aþ_x©Œ_size
(
aþ
->
a_couÁ
);

93 
v®ue
 = 
	`km®loc
(
size
, 
GFP_KERNEL
);

94 ià(!
v®ue
) {

95 
»t
 = -
ENOMEM
;

96 
out
;

99 
»t
 = 
	`posix_aþ_to_x©Œ
(&
š™_u£r_ns
, 
aþ
, 
v®ue
, 
size
);

100 ià(
»t
 < 0)

101 
out
;

104 
»t
 = 
	`__bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
Çme
, 
v®ue
, 
size
, 0);

105 
out
:

106 
	`kä“
(
v®ue
);

108 ià(!
»t
)

109 
	`£t_ÿched_aþ
(
šode
, 
ty³
, 
aþ
);

111  
»t
;

112 
	}
}

114 
	$bŒfs_£t_aþ
(
šode
 *šode, 
posix_aþ
 *
aþ
, 
ty³
)

116 
»t
;

117 
umode_t
 
Þd_mode
 = 
šode
->
i_mode
;

119 ià(
ty³
 =ð
ACL_TYPE_ACCESS
 && 
aþ
) {

120 
»t
 = 
	`posix_aþ_upd©e_mode
(
šode
, &šode->
i_mode
, &
aþ
);

121 ià(
»t
)

122  
»t
;

124 
»t
 = 
	`__bŒfs_£t_aþ
(
NULL
, 
šode
, 
aþ
, 
ty³
);

125 ià(
»t
)

126 
šode
->
i_mode
 = 
Þd_mode
;

127  
»t
;

128 
	}
}

135 
	$bŒfs_š™_aþ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

136 
šode
 *šode, šod*
dœ
)

138 
posix_aþ
 *
deçuÉ_aþ
, *
aþ
;

139 
»t
 = 0;

142 ià(!
dœ
)

145 
»t
 = 
	`posix_aþ_ü—‹
(
dœ
, &
šode
->
i_mode
, &
deçuÉ_aþ
, &
aþ
);

146 ià(
»t
)

147  
»t
;

149 ià(
deçuÉ_aþ
) {

150 
»t
 = 
	`__bŒfs_£t_aþ
(
Œªs
, 
šode
, 
deçuÉ_aþ
,

151 
ACL_TYPE_DEFAULT
);

152 
	`posix_aþ_»Ëa£
(
deçuÉ_aþ
);

155 ià(
aþ
) {

156 ià(!
»t
)

157 
»t
 = 
	`__bŒfs_£t_aþ
(
Œªs
, 
šode
, 
aþ
,

158 
ACL_TYPE_ACCESS
);

159 
	`posix_aþ_»Ëa£
(
aþ
);

162 ià(!
deçuÉ_aþ
 && !
aþ
)

163 
	`ÿche_no_aþ
(
šode
);

164  
»t
;

165 
	}
}

	@async-thread.c

20 
	~<lšux/kth»ad.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/li¡.h
>

23 
	~<lšux/¥šlock.h
>

24 
	~<lšux/ä“z”.h
>

25 
	~"async-th»ad.h
"

26 
	~"ù»e.h
"

28 
	#WORK_DONE_BIT
 0

	)

29 
	#WORK_ORDER_DONE_BIT
 1

	)

30 
	#WORK_HIGH_PRIO_BIT
 2

	)

32 
	#NO_THRESHOLD
 (-1)

	)

33 
	#DFT_THRESHOLD
 (32)

	)

35 
	s__bŒfs_wÜkqueue
 {

36 
wÜkqueue_¡ruù
 *
	mnÜm®_wq
;

39 
bŒfs_fs_šfo
 *
	mfs_šfo
;

42 
li¡_h—d
 
	mÜd”ed_li¡
;

45 
¥šlock_t
 
	mli¡_lock
;

48 
©omic_t
 
	m³ndšg
;

51 
	mlim™_aùive
;

54 
	mcu¼’t_aùive
;

57 
	mth»sh
;

58 
	mcouÁ
;

59 
¥šlock_t
 
	mth»s_lock
;

62 
	sbŒfs_wÜkqueue
 {

63 
__bŒfs_wÜkqueue
 *
	mnÜm®
;

64 
__bŒfs_wÜkqueue
 *
	mhigh
;

67 
nÜm®_wÜk_h–³r
(
bŒfs_wÜk
 *
wÜk
);

69 
	#BTRFS_WORK_HELPER
(
Çme
) \

70 
bŒfs_
##
	`Çme
(
wÜk_¡ruù
 *
¬g
) \

72 
bŒfs_wÜk
 *
wÜk
 = 
	`cÚš”_of
(
¬g
, btrfs_work, \

73 
nÜm®_wÜk
); \

74 
	`nÜm®_wÜk_h–³r
(
wÜk
); \

75 }

	)

77 
bŒfs_fs_šfo
 *

78 
	$bŒfs_wÜkqueue_owÃr
(cÚ¡ 
__bŒfs_wÜkqueue
 *
wq
)

80  
wq
->
fs_šfo
;

81 
	}
}

83 
bŒfs_fs_šfo
 *

84 
	$bŒfs_wÜk_owÃr
(cÚ¡ 
bŒfs_wÜk
 *
wÜk
)

86  
wÜk
->
wq
->
fs_šfo
;

87 
	}
}

89 
boÞ
 
	$bŒfs_wÜkqueue_nÜm®_cÚge¡ed
(cÚ¡ 
bŒfs_wÜkqueue
 *
wq
)

97 ià(
wq
->
nÜm®
->
th»sh
 =ð
NO_THRESHOLD
)

98  
çl£
;

100  
	`©omic_»ad
(&
wq
->
nÜm®
->
³ndšg
è> wq->nÜm®->
th»sh
 * 2;

101 
	}
}

103 
BTRFS_WORK_HELPER
(
wÜk”_h–³r
);

104 
BTRFS_WORK_HELPER
(
d–®loc_h–³r
);

105 
BTRFS_WORK_HELPER
(
æush_d–®loc_h–³r
);

106 
BTRFS_WORK_HELPER
(
ÿche_h–³r
);

107 
BTRFS_WORK_HELPER
(
subm™_h–³r
);

108 
BTRFS_WORK_HELPER
(
fixup_h–³r
);

109 
BTRFS_WORK_HELPER
(
’dio_h–³r
);

110 
BTRFS_WORK_HELPER
(
’dio_m‘a_h–³r
);

111 
BTRFS_WORK_HELPER
(
’dio_m‘a_wr™e_h–³r
);

112 
BTRFS_WORK_HELPER
(
’dio_¿id56_h–³r
);

113 
BTRFS_WORK_HELPER
(
’dio_»·œ_h–³r
);

114 
BTRFS_WORK_HELPER
(
rmw_h–³r
);

115 
BTRFS_WORK_HELPER
(
’dio_wr™e_h–³r
);

116 
BTRFS_WORK_HELPER
(
ä“¥aû_wr™e_h–³r
);

117 
BTRFS_WORK_HELPER
(
d–ayed_m‘a_h–³r
);

118 
BTRFS_WORK_HELPER
(
»adah—d_h–³r
);

119 
BTRFS_WORK_HELPER
(
qgroup_»sÿn_h–³r
);

120 
BTRFS_WORK_HELPER
(
ex‹Á_»fs_h–³r
);

121 
BTRFS_WORK_HELPER
(
süub_h–³r
);

122 
BTRFS_WORK_HELPER
(
süubwrc_h–³r
);

123 
BTRFS_WORK_HELPER
(
süubnc_h–³r
);

124 
BTRFS_WORK_HELPER
(
süub·r™y_h–³r
);

126 
__bŒfs_wÜkqueue
 *

127 
	$__bŒfs_®loc_wÜkqueue
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
Çme
,

128 
æags
, 
lim™_aùive
, 
th»sh
)

130 
__bŒfs_wÜkqueue
 *
»t
 = 
	`kz®loc
((*»t), 
GFP_KERNEL
);

132 ià(!
»t
)

133  
NULL
;

135 
»t
->
fs_šfo
 = fs_info;

136 
»t
->
lim™_aùive
 =†imit_active;

137 
	`©omic_£t
(&
»t
->
³ndšg
, 0);

138 ià(
th»sh
 == 0)

139 
th»sh
 = 
DFT_THRESHOLD
;

141 ià(
th»sh
 < 
DFT_THRESHOLD
) {

142 
»t
->
cu¼’t_aùive
 = 
lim™_aùive
;

143 
»t
->
th»sh
 = 
NO_THRESHOLD
;

150 
»t
->
cu¼’t_aùive
 = 1;

151 
»t
->
th»sh
 =hresh;

154 ià(
æags
 & 
WQ_HIGHPRI
)

155 
»t
->
nÜm®_wq
 = 
	`®loc_wÜkqueue
("%s-%s-high", 
æags
,

156 
»t
->
cu¼’t_aùive
, "btrfs",

157 
Çme
);

159 
»t
->
nÜm®_wq
 = 
	`®loc_wÜkqueue
("%s-%s", 
æags
,

160 
»t
->
cu¼’t_aùive
, "btrfs",

161 
Çme
);

162 ià(!
»t
->
nÜm®_wq
) {

163 
	`kä“
(
»t
);

164  
NULL
;

167 
	`INIT_LIST_HEAD
(&
»t
->
Üd”ed_li¡
);

168 
	`¥š_lock_š™
(&
»t
->
li¡_lock
);

169 
	`¥š_lock_š™
(&
»t
->
th»s_lock
);

170 
	`Œaû_bŒfs_wÜkqueue_®loc
(
»t
, 
Çme
, 
æags
 & 
WQ_HIGHPRI
);

171  
»t
;

172 
	}
}

174 
šlše
 

175 
__bŒfs_de¡roy_wÜkqueue
(
__bŒfs_wÜkqueue
 *
wq
);

177 
bŒfs_wÜkqueue
 *
	$bŒfs_®loc_wÜkqueue
(
bŒfs_fs_šfo
 *
fs_šfo
,

178 cÚ¡ *
Çme
,

179 
æags
,

180 
lim™_aùive
,

181 
th»sh
)

183 
bŒfs_wÜkqueue
 *
»t
 = 
	`kz®loc
((*»t), 
GFP_KERNEL
);

185 ià(!
»t
)

186  
NULL
;

188 
»t
->
nÜm®
 = 
	`__bŒfs_®loc_wÜkqueue
(
fs_šfo
, 
Çme
,

189 
æags
 & ~
WQ_HIGHPRI
,

190 
lim™_aùive
, 
th»sh
);

191 ià(!
»t
->
nÜm®
) {

192 
	`kä“
(
»t
);

193  
NULL
;

196 ià(
æags
 & 
WQ_HIGHPRI
) {

197 
»t
->
high
 = 
	`__bŒfs_®loc_wÜkqueue
(
fs_šfo
, 
Çme
, 
æags
,

198 
lim™_aùive
, 
th»sh
);

199 ià(!
»t
->
high
) {

200 
	`__bŒfs_de¡roy_wÜkqueue
(
»t
->
nÜm®
);

201 
	`kä“
(
»t
);

202  
NULL
;

205  
»t
;

206 
	}
}

213 
šlše
 
	$th»sh_queue_hook
(
__bŒfs_wÜkqueue
 *
wq
)

215 ià(
wq
->
th»sh
 =ð
NO_THRESHOLD
)

217 
	`©omic_šc
(&
wq
->
³ndšg
);

218 
	}
}

225 
šlše
 
	$th»sh_exec_hook
(
__bŒfs_wÜkqueue
 *
wq
)

227 
Ãw_cu¼’t_aùive
;

228 
³ndšg
;

229 
Ãed_chªge
 = 0;

231 ià(
wq
->
th»sh
 =ð
NO_THRESHOLD
)

234 
	`©omic_dec
(&
wq
->
³ndšg
);

235 
	`¥š_lock
(&
wq
->
th»s_lock
);

240 
wq
->
couÁ
++;

241 
wq
->
couÁ
 %ð(wq->
th»sh
 / 4);

242 ià(!
wq
->
couÁ
)

243 
out
;

244 
Ãw_cu¼’t_aùive
 = 
wq
->
cu¼’t_aùive
;

250 
³ndšg
 = 
	`©omic_»ad
(&
wq
->pending);

251 ià(
³ndšg
 > 
wq
->
th»sh
)

252 
Ãw_cu¼’t_aùive
++;

253 ià(
³ndšg
 < 
wq
->
th»sh
 / 2)

254 
Ãw_cu¼’t_aùive
--;

255 
Ãw_cu¼’t_aùive
 = 
	`þamp_v®
Òew_cu¼’t_aùive, 1, 
wq
->
lim™_aùive
);

256 ià(
Ãw_cu¼’t_aùive
 !ð
wq
->
cu¼’t_aùive
) {

257 
Ãed_chªge
 = 1;

258 
wq
->
cu¼’t_aùive
 = 
Ãw_cu¼’t_aùive
;

260 
out
:

261 
	`¥š_uÆock
(&
wq
->
th»s_lock
);

263 ià(
Ãed_chªge
) {

264 
	`wÜkqueue_£t_max_aùive
(
wq
->
nÜm®_wq
, wq->
cu¼’t_aùive
);

266 
	}
}

268 
	$run_Üd”ed_wÜk
(
__bŒfs_wÜkqueue
 *
wq
)

270 
li¡_h—d
 *
li¡
 = &
wq
->
Üd”ed_li¡
;

271 
bŒfs_wÜk
 *
wÜk
;

272 
¥šlock_t
 *
lock
 = &
wq
->
li¡_lock
;

273 
æags
;

276 *
wg
;

278 
	`¥š_lock_œq§ve
(
lock
, 
æags
);

279 ià(
	`li¡_em±y
(
li¡
))

281 
wÜk
 = 
	`li¡_’Œy
(
li¡
->
Ãxt
, 
bŒfs_wÜk
,

282 
Üd”ed_li¡
);

283 ià(!
	`‹¡_b™
(
WORK_DONE_BIT
, &
wÜk
->
æags
))

292 ià(
	`‹¡_ªd_£t_b™
(
WORK_ORDER_DONE_BIT
, &
wÜk
->
æags
))

294 
	`Œaû_bŒfs_Üd”ed_sched
(
wÜk
);

295 
	`¥š_uÆock_œq»¡Üe
(
lock
, 
æags
);

296 
wÜk
->
	`Üd”ed_func
(work);

299 
	`¥š_lock_œq§ve
(
lock
, 
æags
);

300 
	`li¡_d–
(&
wÜk
->
Üd”ed_li¡
);

301 
	`¥š_uÆock_œq»¡Üe
(
lock
, 
æags
);

308 
wg
 = 
wÜk
;

309 
wÜk
->
	`Üd”ed_ä“
(work);

310 
	`Œaû_bŒfs_®l_wÜk_dÚe
(
wq
->
fs_šfo
, 
wg
);

312 
	`¥š_uÆock_œq»¡Üe
(
lock
, 
æags
);

313 
	}
}

315 
	$nÜm®_wÜk_h–³r
(
bŒfs_wÜk
 *
wÜk
)

317 
__bŒfs_wÜkqueue
 *
wq
;

318 *
wg
;

319 
Ãed_Üd”
 = 0;

329 ià(
wÜk
->
Üd”ed_func
)

330 
Ãed_Üd”
 = 1;

331 
wq
 = 
wÜk
->wq;

333 
wg
 = 
wÜk
;

335 
	`Œaû_bŒfs_wÜk_sched
(
wÜk
);

336 
	`th»sh_exec_hook
(
wq
);

337 
wÜk
->
	`func
(work);

338 ià(
Ãed_Üd”
) {

339 
	`£t_b™
(
WORK_DONE_BIT
, &
wÜk
->
æags
);

340 
	`run_Üd”ed_wÜk
(
wq
);

342 ià(!
Ãed_Üd”
)

343 
	`Œaû_bŒfs_®l_wÜk_dÚe
(
wq
->
fs_šfo
, 
wg
);

344 
	}
}

346 
	$bŒfs_š™_wÜk
(
bŒfs_wÜk
 *
wÜk
, 
bŒfs_wÜk_func_t
 
uniq_func
,

347 
bŒfs_func_t
 
func
,

348 
bŒfs_func_t
 
Üd”ed_func
,

349 
bŒfs_func_t
 
Üd”ed_ä“
)

351 
wÜk
->
func
 = func;

352 
wÜk
->
Üd”ed_func
 = ordered_func;

353 
wÜk
->
Üd”ed_ä“
 = ordered_free;

354 
	`INIT_WORK
(&
wÜk
->
nÜm®_wÜk
, 
uniq_func
);

355 
	`INIT_LIST_HEAD
(&
wÜk
->
Üd”ed_li¡
);

356 
wÜk
->
æags
 = 0;

357 
	}
}

359 
šlše
 
	$__bŒfs_queue_wÜk
(
__bŒfs_wÜkqueue
 *
wq
,

360 
bŒfs_wÜk
 *
wÜk
)

362 
æags
;

364 
wÜk
->
wq
 = wq;

365 
	`th»sh_queue_hook
(
wq
);

366 ià(
wÜk
->
Üd”ed_func
) {

367 
	`¥š_lock_œq§ve
(&
wq
->
li¡_lock
, 
æags
);

368 
	`li¡_add_ž
(&
wÜk
->
Üd”ed_li¡
, &
wq
->ordered_list);

369 
	`¥š_uÆock_œq»¡Üe
(&
wq
->
li¡_lock
, 
æags
);

371 
	`Œaû_bŒfs_wÜk_queued
(
wÜk
);

372 
	`queue_wÜk
(
wq
->
nÜm®_wq
, &
wÜk
->
nÜm®_wÜk
);

373 
	}
}

375 
	$bŒfs_queue_wÜk
(
bŒfs_wÜkqueue
 *
wq
,

376 
bŒfs_wÜk
 *
wÜk
)

378 
__bŒfs_wÜkqueue
 *
de¡_wq
;

380 ià(
	`‹¡_b™
(
WORK_HIGH_PRIO_BIT
, &
wÜk
->
æags
è&& 
wq
->
high
)

381 
de¡_wq
 = 
wq
->
high
;

383 
de¡_wq
 = 
wq
->
nÜm®
;

384 
	`__bŒfs_queue_wÜk
(
de¡_wq
, 
wÜk
);

385 
	}
}

387 
šlše
 

388 
	$__bŒfs_de¡roy_wÜkqueue
(
__bŒfs_wÜkqueue
 *
wq
)

390 
	`de¡roy_wÜkqueue
(
wq
->
nÜm®_wq
);

391 
	`Œaû_bŒfs_wÜkqueue_de¡roy
(
wq
);

392 
	`kä“
(
wq
);

393 
	}
}

395 
	$bŒfs_de¡roy_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
)

397 ià(!
wq
)

399 ià(
wq
->
high
)

400 
	`__bŒfs_de¡roy_wÜkqueue
(
wq
->
high
);

401 
	`__bŒfs_de¡roy_wÜkqueue
(
wq
->
nÜm®
);

402 
	`kä“
(
wq
);

403 
	}
}

405 
	$bŒfs_wÜkqueue_£t_max
(
bŒfs_wÜkqueue
 *
wq
, 
lim™_aùive
)

407 ià(!
wq
)

409 
wq
->
nÜm®
->
lim™_aùive
 =†imit_active;

410 ià(
wq
->
high
)

411 
wq
->
high
->
lim™_aùive
 =†imit_active;

412 
	}
}

414 
	$bŒfs_£t_wÜk_high_´iÜ™y
(
bŒfs_wÜk
 *
wÜk
)

416 
	`£t_b™
(
WORK_HIGH_PRIO_BIT
, &
wÜk
->
æags
);

417 
	}
}

	@async-thread.h

20 #iâdeà
__BTRFS_ASYNC_THREAD_


21 
	#__BTRFS_ASYNC_THREAD_


	)

22 
	~<lšux/wÜkqueue.h
>

24 
	gbŒfs_fs_šfo
;

25 
	gbŒfs_wÜkqueue
;

27 
	g__bŒfs_wÜkqueue
;

28 
	gbŒfs_wÜk
;

29 (*
	tbŒfs_func_t
)(
	tbŒfs_wÜk
 *
	t¬g
);

30 (*
	tbŒfs_wÜk_func_t
)(
	twÜk_¡ruù
 *
	t¬g
);

32 
	sbŒfs_wÜk
 {

33 
bŒfs_func_t
 
func
;

34 
bŒfs_func_t
 
Üd”ed_func
;

35 
bŒfs_func_t
 
Üd”ed_ä“
;

38 
wÜk_¡ruù
 
nÜm®_wÜk
;

39 
li¡_h—d
 
Üd”ed_li¡
;

40 
__bŒfs_wÜkqueue
 *
wq
;

41 
æags
;

44 
	#BTRFS_WORK_HELPER_PROTO
(
Çme
) \

45 
bŒfs_
##
	`Çme
(
wÜk_¡ruù
 *
¬g
)

	)

47 
	`BTRFS_WORK_HELPER_PROTO
(
wÜk”_h–³r
);

48 
	`BTRFS_WORK_HELPER_PROTO
(
d–®loc_h–³r
);

49 
	`BTRFS_WORK_HELPER_PROTO
(
æush_d–®loc_h–³r
);

50 
	`BTRFS_WORK_HELPER_PROTO
(
ÿche_h–³r
);

51 
	`BTRFS_WORK_HELPER_PROTO
(
subm™_h–³r
);

52 
	`BTRFS_WORK_HELPER_PROTO
(
fixup_h–³r
);

53 
	`BTRFS_WORK_HELPER_PROTO
(
’dio_h–³r
);

54 
	`BTRFS_WORK_HELPER_PROTO
(
’dio_m‘a_h–³r
);

55 
	`BTRFS_WORK_HELPER_PROTO
(
’dio_m‘a_wr™e_h–³r
);

56 
	`BTRFS_WORK_HELPER_PROTO
(
’dio_¿id56_h–³r
);

57 
	`BTRFS_WORK_HELPER_PROTO
(
’dio_»·œ_h–³r
);

58 
	`BTRFS_WORK_HELPER_PROTO
(
rmw_h–³r
);

59 
	`BTRFS_WORK_HELPER_PROTO
(
’dio_wr™e_h–³r
);

60 
	`BTRFS_WORK_HELPER_PROTO
(
ä“¥aû_wr™e_h–³r
);

61 
	`BTRFS_WORK_HELPER_PROTO
(
d–ayed_m‘a_h–³r
);

62 
	`BTRFS_WORK_HELPER_PROTO
(
»adah—d_h–³r
);

63 
	`BTRFS_WORK_HELPER_PROTO
(
qgroup_»sÿn_h–³r
);

64 
	`BTRFS_WORK_HELPER_PROTO
(
ex‹Á_»fs_h–³r
);

65 
	`BTRFS_WORK_HELPER_PROTO
(
süub_h–³r
);

66 
	`BTRFS_WORK_HELPER_PROTO
(
süubwrc_h–³r
);

67 
	`BTRFS_WORK_HELPER_PROTO
(
süubnc_h–³r
);

68 
	`BTRFS_WORK_HELPER_PROTO
(
süub·r™y_h–³r
);

71 
bŒfs_wÜkqueue
 *
	`bŒfs_®loc_wÜkqueue
(
bŒfs_fs_šfo
 *
fs_šfo
,

72 cÚ¡ *
Çme
,

73 
æags
,

74 
lim™_aùive
,

75 
th»sh
);

76 
	`bŒfs_š™_wÜk
(
bŒfs_wÜk
 *
wÜk
, 
bŒfs_wÜk_func_t
 
h–³r
,

77 
bŒfs_func_t
 
func
,

78 
bŒfs_func_t
 
Üd”ed_func
,

79 
bŒfs_func_t
 
Üd”ed_ä“
);

80 
	`bŒfs_queue_wÜk
(
bŒfs_wÜkqueue
 *
wq
,

81 
bŒfs_wÜk
 *
wÜk
);

82 
	`bŒfs_de¡roy_wÜkqueue
(
bŒfs_wÜkqueue
 *
wq
);

83 
	`bŒfs_wÜkqueue_£t_max
(
bŒfs_wÜkqueue
 *
wq
, 
max
);

84 
	`bŒfs_£t_wÜk_high_´iÜ™y
(
bŒfs_wÜk
 *
wÜk
);

85 
bŒfs_fs_šfo
 *
	`bŒfs_wÜk_owÃr
(cÚ¡ 
bŒfs_wÜk
 *
wÜk
);

86 
bŒfs_fs_šfo
 *
	`bŒfs_wÜkqueue_owÃr
(cÚ¡ 
__bŒfs_wÜkqueue
 *
wq
);

87 
boÞ
 
	`bŒfs_wÜkqueue_nÜm®_cÚge¡ed
(cÚ¡ 
bŒfs_wÜkqueue
 *
wq
);

	@backref.c

19 
	~<lšux/mm.h
>

20 
	~<lšux/rbŒ“.h
>

21 
	~<Œaû/ev’ts/bŒfs.h
>

22 
	~"ù»e.h
"

23 
	~"disk-io.h
"

24 
	~"back»f.h
"

25 
	~"uli¡.h
"

26 
	~"Œª§ùiÚ.h
"

27 
	~"d–ayed-»f.h
"

28 
	~"lockšg.h
"

31 
	#BACKREF_FOUND_SHARED
 6

	)

33 
	sex‹Á_šode_–em
 {

34 
u64
 
	mšum
;

35 
u64
 
	moff£t
;

36 
ex‹Á_šode_–em
 *
	mÃxt
;

39 
	$check_ex‹Á_š_eb
(cÚ¡ 
bŒfs_key
 *
key
,

40 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

41 cÚ¡ 
bŒfs_fže_ex‹Á_™em
 *
fi
,

42 
u64
 
ex‹Á_™em_pos
,

43 
ex‹Á_šode_–em
 **
e›
)

45 
u64
 
off£t
 = 0;

46 
ex‹Á_šode_–em
 *
e
;

48 ià(!
	`bŒfs_fže_ex‹Á_com´essiÚ
(
eb
, 
fi
) &&

49 !
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
eb
, 
fi
) &&

50 !
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
eb
, 
fi
)) {

51 
u64
 
d©a_off£t
;

52 
u64
 
d©a_Ën
;

54 
d©a_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
fi
);

55 
d©a_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
eb
, 
fi
);

57 ià(
ex‹Á_™em_pos
 < 
d©a_off£t
 ||

58 
ex‹Á_™em_pos
 >ð
d©a_off£t
 + 
d©a_Ën
)

60 
off£t
 = 
ex‹Á_™em_pos
 - 
d©a_off£t
;

63 
e
 = 
	`km®loc
((*e), 
GFP_NOFS
);

64 ià(!
e
)

65  -
ENOMEM
;

67 
e
->
Ãxt
 = *
e›
;

68 
e
->
šum
 = 
key
->
objeùid
;

69 
e
->
off£t
 = 
key
->offset + offset;

70 *
e›
 = 
e
;

73 
	}
}

75 
	$ä“_šode_–em_li¡
(
ex‹Á_šode_–em
 *
e›
)

77 
ex‹Á_šode_–em
 *
e›_Ãxt
;

79 ; 
e›
;ƒ› = 
e›_Ãxt
) {

80 
e›_Ãxt
 = 
e›
->
Ãxt
;

81 
	`kä“
(
e›
);

83 
	}
}

85 
	$fšd_ex‹Á_š_eb
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

86 
u64
 
wª‹d_disk_by‹
, u64 
ex‹Á_™em_pos
,

87 
ex‹Á_šode_–em
 **
e›
)

89 
u64
 
disk_by‹
;

90 
bŒfs_key
 
key
;

91 
bŒfs_fže_ex‹Á_™em
 *
fi
;

92 
¦Ù
;

93 
Ä™ems
;

94 
ex‹Á_ty³
;

95 
»t
;

102 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

103 
¦Ù
 = 0; slÙ < 
Ä™ems
; ++slot) {

104 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
¦Ù
);

105 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

107 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

108 
ex‹Á_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
fi
);

109 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
)

112 
disk_by‹
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

113 ià(
disk_by‹
 !ð
wª‹d_disk_by‹
)

116 
»t
 = 
	`check_ex‹Á_š_eb
(&
key
, 
eb
, 
fi
, 
ex‹Á_™em_pos
, 
e›
);

117 ià(
»t
 < 0)

118  
»t
;

122 
	}
}

124 
	s´eá»e
 {

125 
rb_roÙ
 
	mroÙ
;

126 
	mcouÁ
;

129 
	#PREFTREE_INIT
 { .
roÙ
 = 
RB_ROOT
, .
couÁ
 = 0 }

	)

131 
	s´eá»es
 {

132 
´eá»e
 
	mdœeù
;

133 
´eá»e
 
	mšdœeù
;

134 
´eá»e
 
	mšdœeù_missšg_keys
;

145 
	ssh¬e_check
 {

146 
u64
 
	mroÙ_objeùid
;

147 
u64
 
	mšum
;

148 
	msh¬e_couÁ
;

151 
šlše
 
	$ex‹Á_is_sh¬ed
(
sh¬e_check
 *
sc
)

153  (
sc
 && sc->
sh¬e_couÁ
 > 1è? 
BACKREF_FOUND_SHARED
 : 0;

154 
	}
}

156 
kmem_ÿche
 *
	gbŒfs_´–im_»f_ÿche
;

158 
__š™
 
	$bŒfs_´–im_»f_š™
()

160 
bŒfs_´–im_»f_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_prelim_ref",

161 (
´–im_»f
),

163 
SLAB_MEM_SPREAD
,

164 
NULL
);

165 ià(!
bŒfs_´–im_»f_ÿche
)

166  -
ENOMEM
;

168 
	}
}

170 
	$bŒfs_´–im_»f_ex™
()

172 
	`kmem_ÿche_de¡roy
(
bŒfs_´–im_»f_ÿche
);

173 
	}
}

175 
	$ä“_´ef
(
´–im_»f
 *
»f
)

177 
	`kmem_ÿche_ä“
(
bŒfs_´–im_»f_ÿche
, 
»f
);

178 
	}
}

185 
	$´–im_»f_com·»
(
´–im_»f
 *
»f1
,

186 
´–im_»f
 *
»f2
)

188 ià(
»f1
->
Ëv–
 < 
»f2
->level)

190 ià(
»f1
->
Ëv–
 > 
»f2
->level)

192 ià(
»f1
->
roÙ_id
 < 
»f2
->root_id)

194 ià(
»f1
->
roÙ_id
 > 
»f2
->root_id)

196 ià(
»f1
->
key_fÜ_£¬ch
.
ty³
 < 
»f2
->key_for_search.type)

198 ià(
»f1
->
key_fÜ_£¬ch
.
ty³
 > 
»f2
->key_for_search.type)

200 ià(
»f1
->
key_fÜ_£¬ch
.
objeùid
 < 
»f2
->key_for_search.objectid)

202 ià(
»f1
->
key_fÜ_£¬ch
.
objeùid
 > 
»f2
->key_for_search.objectid)

204 ià(
»f1
->
key_fÜ_£¬ch
.
off£t
 < 
»f2
->key_for_search.offset)

206 ià(
»f1
->
key_fÜ_£¬ch
.
off£t
 > 
»f2
->key_for_search.offset)

208 ià(
»f1
->
·»Á
 < 
»f2
->parent)

210 ià(
»f1
->
·»Á
 > 
»f2
->parent)

214 
	}
}

216 
	$upd©e_sh¬e_couÁ
(
sh¬e_check
 *
sc
, 
ÞdcouÁ
, 
ÃwcouÁ
)

218 ià((!
sc
è|| (
ÞdcouÁ
 =ð0 && 
ÃwcouÁ
 < 1))

221 ià(
ÞdcouÁ
 > 0 && 
ÃwcouÁ
 < 1)

222 
sc
->
sh¬e_couÁ
--;

223 ià(
ÞdcouÁ
 < 1 && 
ÃwcouÁ
 > 0)

224 
sc
->
sh¬e_couÁ
++;

225 
	}
}

232 
	$´–im_»f_š£¹
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

233 
´eá»e
 *preftree,

234 
´–im_»f
 *
Ãw»f
,

235 
sh¬e_check
 *
sc
)

237 
rb_roÙ
 *
roÙ
;

238 
rb_node
 **
p
;

239 
rb_node
 *
·»Á
 = 
NULL
;

240 
´–im_»f
 *
»f
;

241 
»suÉ
;

243 
roÙ
 = &
´eá»e
->root;

244 
p
 = &
roÙ
->
rb_node
;

246 *
p
) {

247 
·»Á
 = *
p
;

248 
»f
 = 
	`rb_’Œy
(
·»Á
, 
´–im_»f
, 
rbnode
);

249 
»suÉ
 = 
	`´–im_»f_com·»
(
»f
, 
Ãw»f
);

250 ià(
»suÉ
 < 0) {

251 
p
 = &(*p)->
rb_Ëá
;

252 } ià(
»suÉ
 > 0) {

253 
p
 = &(*p)->
rb_right
;

256 
ex‹Á_šode_–em
 *
e›
 = 
»f
->
šode_li¡
;

258 
e›
 &&ƒ›->
Ãxt
)

259 
e›
 =ƒ›->
Ãxt
;

261 ià(!
e›
)

262 
»f
->
šode_li¡
 = 
Ãw»f
->inode_list;

264 
e›
->
Ãxt
 = 
Ãw»f
->
šode_li¡
;

265 
	`Œaû_bŒfs_´–im_»f_m”ge
(
fs_šfo
, 
»f
, 
Ãw»f
,

266 
´eá»e
->
couÁ
);

272 
	`upd©e_sh¬e_couÁ
(
sc
, 
»f
->
couÁ
,

273 
»f
->
couÁ
 + 
Ãw»f
->count);

274 
»f
->
couÁ
 +ð
Ãw»f
->count;

275 
	`ä“_´ef
(
Ãw»f
);

280 
	`upd©e_sh¬e_couÁ
(
sc
, 0, 
Ãw»f
->
couÁ
);

281 
´eá»e
->
couÁ
++;

282 
	`Œaû_bŒfs_´–im_»f_š£¹
(
fs_šfo
, 
Ãw»f
, 
NULL
, 
´eá»e
->
couÁ
);

283 
	`rb_lšk_node
(&
Ãw»f
->
rbnode
, 
·»Á
, 
p
);

284 
	`rb_š£¹_cÞÜ
(&
Ãw»f
->
rbnode
, 
roÙ
);

285 
	}
}

291 
	$´–im_»Ëa£
(
´eá»e
 *preftree)

293 
´–im_»f
 *
»f
, *
Ãxt_»f
;

295 
	`rbŒ“_po¡Üd”_fÜ_—ch_’Œy_§ã
(
»f
, 
Ãxt_»f
, &
´eá»e
->
roÙ
,

296 
rbnode
)

297 
	`ä“_´ef
(
»f
);

299 
´eá»e
->
roÙ
 = 
RB_ROOT
;

300 
´eá»e
->
couÁ
 = 0;

301 
	}
}

341 
	$add_´–im_»f
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

342 
´eá»e
 *´eá»e, 
u64
 
roÙ_id
,

343 cÚ¡ 
bŒfs_key
 *
key
, 
Ëv–
, 
u64
 
·»Á
,

344 
u64
 
wª‹d_disk_by‹
, 
couÁ
,

345 
sh¬e_check
 *
sc
, 
gå_t
 
gå_mask
)

347 
´–im_»f
 *
»f
;

349 ià(
roÙ_id
 =ð
BTRFS_DATA_RELOC_TREE_OBJECTID
)

352 
»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_´–im_»f_ÿche
, 
gå_mask
);

353 ià(!
»f
)

354  -
ENOMEM
;

356 
»f
->
roÙ_id
 =„oot_id;

357 ià(
key
) {

358 
»f
->
key_fÜ_£¬ch
 = *
key
;

378 ià(
»f
->
key_fÜ_£¬ch
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
 &&

379 
»f
->
key_fÜ_£¬ch
.
off£t
 >ð
LLONG_MAX
)

380 
»f
->
key_fÜ_£¬ch
.
off£t
 = 0;

382 
	`mem£t
(&
»f
->
key_fÜ_£¬ch
, 0, (ref->key_for_search));

385 
»f
->
šode_li¡
 = 
NULL
;

386 
»f
->
Ëv–
 =†evel;

387 
»f
->
couÁ
 = count;

388 
»f
->
·»Á
 =…arent;

389 
»f
->
wª‹d_disk_by‹
 = wanted_disk_byte;

390 
	`´–im_»f_š£¹
(
fs_šfo
, 
´eá»e
, 
»f
, 
sc
);

391  
	`ex‹Á_is_sh¬ed
(
sc
);

392 
	}
}

395 
	$add_dœeù_»f
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

396 
´eá»es
 *´eá»es, 
Ëv–
, 
u64
 
·»Á
,

397 
u64
 
wª‹d_disk_by‹
, 
couÁ
,

398 
sh¬e_check
 *
sc
, 
gå_t
 
gå_mask
)

400  
	`add_´–im_»f
(
fs_šfo
, &
´eá»es
->
dœeù
, 0, 
NULL
, 
Ëv–
,

401 
·»Á
, 
wª‹d_disk_by‹
, 
couÁ
, 
sc
, 
gå_mask
);

402 
	}
}

405 
	$add_šdœeù_»f
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

406 
´eá»es
 *´eá»es, 
u64
 
roÙ_id
,

407 cÚ¡ 
bŒfs_key
 *
key
, 
Ëv–
,

408 
u64
 
wª‹d_disk_by‹
, 
couÁ
,

409 
sh¬e_check
 *
sc
, 
gå_t
 
gå_mask
)

411 
´eá»e
 *
Œ“
 = &
´eá»es
->
šdœeù
;

413 ià(!
key
)

414 
Œ“
 = &
´eá»es
->
šdœeù_missšg_keys
;

415  
	`add_´–im_»f
(
fs_šfo
, 
Œ“
, 
roÙ_id
, 
key
, 
Ëv–
, 0,

416 
wª‹d_disk_by‹
, 
couÁ
, 
sc
, 
gå_mask
);

417 
	}
}

419 
	$add_®l_·»Ás
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

420 
uli¡
 *
·»Ás
, 
´–im_»f
 *
»f
,

421 
Ëv–
, 
u64
 
time_£q
, cÚ¡ u64 *
ex‹Á_™em_pos
,

422 
u64
 
tÙ®_»fs
)

424 
»t
 = 0;

425 
¦Ù
;

426 
ex‹Á_bufãr
 *
eb
;

427 
bŒfs_key
 
key
;

428 
bŒfs_key
 *
key_fÜ_£¬ch
 = &
»f
->key_for_search;

429 
bŒfs_fže_ex‹Á_™em
 *
fi
;

430 
ex‹Á_šode_–em
 *
e›
 = 
NULL
, *
Þd
 = NULL;

431 
u64
 
disk_by‹
;

432 
u64
 
wª‹d_disk_by‹
 = 
»f
->wanted_disk_byte;

433 
u64
 
couÁ
 = 0;

435 ià(
Ëv–
 != 0) {

436 
eb
 = 
·th
->
nodes
[
Ëv–
];

437 
»t
 = 
	`uli¡_add
(
·»Ás
, 
eb
->
¡¬t
, 0, 
GFP_NOFS
);

438 ià(
»t
 < 0)

439  
»t
;

448 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

449 ià(
time_£q
 =ð
SEQ_LAST
)

450 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

452 
»t
 = 
	`bŒfs_Ãxt_Þd_Ëaf
(
roÙ
, 
·th
, 
time_£q
);

455 !
»t
 && 
couÁ
 < 
tÙ®_»fs
) {

456 
eb
 = 
·th
->
nodes
[0];

457 
¦Ù
 = 
·th
->
¦Ùs
[0];

459 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
¦Ù
);

461 ià(
key
.
objeùid
 !ð
key_fÜ_£¬ch
->objectid ||

462 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

465 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

466 
disk_by‹
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

468 ià(
disk_by‹
 =ð
wª‹d_disk_by‹
) {

469 
e›
 = 
NULL
;

470 
Þd
 = 
NULL
;

471 
couÁ
++;

472 ià(
ex‹Á_™em_pos
) {

473 
»t
 = 
	`check_ex‹Á_š_eb
(&
key
, 
eb
, 
fi
,

474 *
ex‹Á_™em_pos
,

475 &
e›
);

476 ià(
»t
 < 0)

479 ià(
»t
 > 0)

480 
Ãxt
;

481 
»t
 = 
	`uli¡_add_m”ge_±r
(
·»Ás
, 
eb
->
¡¬t
,

482 
e›
, (**)&
Þd
, 
GFP_NOFS
);

483 ià(
»t
 < 0)

485 ià(!
»t
 && 
ex‹Á_™em_pos
) {

486 
Þd
->
Ãxt
)

487 
Þd
 = old->
Ãxt
;

488 
Þd
->
Ãxt
 = 
e›
;

490 
e›
 = 
NULL
;

492 
Ãxt
:

493 ià(
time_£q
 =ð
SEQ_LAST
)

494 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

496 
»t
 = 
	`bŒfs_Ãxt_Þd_™em
(
roÙ
, 
·th
, 
time_£q
);

499 ià(
»t
 > 0)

500 
»t
 = 0;

501 ià(
»t
 < 0)

502 
	`ä“_šode_–em_li¡
(
e›
);

503  
»t
;

504 
	}
}

510 
	$»sÞve_šdœeù_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

511 
bŒfs_·th
 *
·th
, 
u64
 
time_£q
,

512 
´–im_»f
 *
»f
, 
uli¡
 *
·»Ás
,

513 cÚ¡ 
u64
 *
ex‹Á_™em_pos
, u64 
tÙ®_»fs
)

515 
bŒfs_roÙ
 *
roÙ
;

516 
bŒfs_key
 
roÙ_key
;

517 
ex‹Á_bufãr
 *
eb
;

518 
»t
 = 0;

519 
roÙ_Ëv–
;

520 
Ëv–
 = 
»f
->level;

521 
šdex
;

523 
roÙ_key
.
objeùid
 = 
»f
->
roÙ_id
;

524 
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

525 
roÙ_key
.
off£t
 = (
u64
)-1;

527 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

529 
roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, &
roÙ_key
, 
çl£
);

530 ià(
	`IS_ERR
(
roÙ
)) {

531 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

532 
»t
 = 
	`PTR_ERR
(
roÙ
);

533 
out
;

536 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
)) {

537 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

538 
»t
 = -
ENOENT
;

539 
out
;

542 ià(
·th
->
£¬ch_comm™_roÙ
)

543 
roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
comm™_roÙ
);

544 ià(
time_£q
 =ð
SEQ_LAST
)

545 
roÙ_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

547 
roÙ_Ëv–
 = 
	`bŒfs_Þd_roÙ_Ëv–
(
roÙ
, 
time_£q
);

549 ià(
roÙ_Ëv–
 + 1 =ð
Ëv–
) {

550 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

551 
out
;

554 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

555 ià(
time_£q
 =ð
SEQ_LAST
)

556 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
»f
->
key_fÜ_£¬ch
, 
·th
,

559 
»t
 = 
	`bŒfs_£¬ch_Þd_¦Ù
(
roÙ
, &
»f
->
key_fÜ_£¬ch
, 
·th
,

560 
time_£q
);

563 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

565 
	`bŒfs_debug
(
fs_šfo
,

567 
»f
->
roÙ_id
, 
Ëv–
,„ef->
couÁ
, 
»t
,

568 
»f
->
key_fÜ_£¬ch
.
objeùid
,„ef->key_fÜ_£¬ch.
ty³
,

569 
»f
->
key_fÜ_£¬ch
.
off£t
);

570 ià(
»t
 < 0)

571 
out
;

573 
eb
 = 
·th
->
nodes
[
Ëv–
];

574 !
eb
) {

575 ià(
	`WARN_ON
(!
Ëv–
)) {

576 
»t
 = 1;

577 
out
;

579 
Ëv–
--;

580 
eb
 = 
·th
->
nodes
[
Ëv–
];

583 
»t
 = 
	`add_®l_·»Ás
(
roÙ
, 
·th
, 
·»Ás
, 
»f
, 
Ëv–
, 
time_£q
,

584 
ex‹Á_™em_pos
, 
tÙ®_»fs
);

585 
out
:

586 
·th
->
lowe¡_Ëv–
 = 0;

587 
	`bŒfs_»Ëa£_·th
(
·th
);

588  
»t
;

589 
	}
}

591 
ex‹Á_šode_–em
 *

592 
	$unode_aux_to_šode_li¡
(
uli¡_node
 *
node
)

594 ià(!
node
)

595  
NULL
;

596  (
ex‹Á_šode_–em
 *)(
ušŒ_t
)
node
->
aux
;

597 
	}
}

615 
	$»sÞve_šdœeù_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

616 
bŒfs_·th
 *
·th
, 
u64
 
time_£q
,

617 
´eá»es
 *preftrees,

618 cÚ¡ 
u64
 *
ex‹Á_™em_pos
, u64 
tÙ®_»fs
,

619 
sh¬e_check
 *
sc
)

621 
”r
;

622 
»t
 = 0;

623 
uli¡
 *
·»Ás
;

624 
uli¡_node
 *
node
;

625 
uli¡_™”©Ü
 
u™”
;

626 
rb_node
 *
ºode
;

628 
·»Ás
 = 
	`uli¡_®loc
(
GFP_NOFS
);

629 ià(!
·»Ás
)

630  -
ENOMEM
;

638 (
ºode
 = 
	`rb_fœ¡
(&
´eá»es
->
šdœeù
.
roÙ
))) {

639 
´–im_»f
 *
»f
;

641 
»f
 = 
	`rb_’Œy
(
ºode
, 
´–im_»f
, 
rbnode
);

642 ià(
	`WARN
(
»f
->
·»Á
,

644 
»t
 = -
EINVAL
;

645 
out
;

648 
	`rb_”a£
(&
»f
->
rbnode
, &
´eá»es
->
šdœeù
.
roÙ
);

649 
´eá»es
->
šdœeù
.
couÁ
--;

651 ià(
»f
->
couÁ
 == 0) {

652 
	`ä“_´ef
(
»f
);

656 ià(
sc
 && sc->
roÙ_objeùid
 &&

657 
»f
->
roÙ_id
 !ð
sc
->
roÙ_objeùid
) {

658 
	`ä“_´ef
(
»f
);

659 
»t
 = 
BACKREF_FOUND_SHARED
;

660 
out
;

662 
”r
 = 
	`»sÞve_šdœeù_»f
(
fs_šfo
, 
·th
, 
time_£q
, 
»f
,

663 
·»Ás
, 
ex‹Á_™em_pos
,

664 
tÙ®_»fs
);

669 ià(
”r
 =ð-
ENOENT
) {

670 
	`´–im_»f_š£¹
(
fs_šfo
, &
´eá»es
->
dœeù
, 
»f
,

671 
NULL
);

673 } ià(
”r
) {

674 
	`ä“_´ef
(
»f
);

675 
»t
 = 
”r
;

676 
out
;

680 
	`ULIST_ITER_INIT
(&
u™”
);

681 
node
 = 
	`uli¡_Ãxt
(
·»Ás
, &
u™”
);

682 
»f
->
·»Á
 = 
node
 ?‚ode->
v®
 : 0;

683 
»f
->
šode_li¡
 = 
	`unode_aux_to_šode_li¡
(
node
);

686 (
node
 = 
	`uli¡_Ãxt
(
·»Ás
, &
u™”
))) {

687 
´–im_»f
 *
Ãw_»f
;

689 
Ãw_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_´–im_»f_ÿche
,

690 
GFP_NOFS
);

691 ià(!
Ãw_»f
) {

692 
	`ä“_´ef
(
»f
);

693 
»t
 = -
ENOMEM
;

694 
out
;

696 
	`memýy
(
Ãw_»f
, 
»f
, (*ref));

697 
Ãw_»f
->
·»Á
 = 
node
->
v®
;

698 
Ãw_»f
->
šode_li¡
 = 
	`unode_aux_to_šode_li¡
(
node
);

699 
	`´–im_»f_š£¹
(
fs_šfo
, &
´eá»es
->
dœeù
,

700 
Ãw_»f
, 
NULL
);

707 
	`´–im_»f_š£¹
(
fs_šfo
, &
´eá»es
->
dœeù
, 
»f
, 
NULL
);

709 
	`uli¡_»š™
(
·»Ás
);

710 
	`cÚd_»sched
();

712 
out
:

713 
	`uli¡_ä“
(
·»Ás
);

714  
»t
;

715 
	}
}

720 
	$add_missšg_keys
(
bŒfs_fs_šfo
 *
fs_šfo
,

721 
´eá»es
 *preftrees)

723 
´–im_»f
 *
»f
;

724 
ex‹Á_bufãr
 *
eb
;

725 
´eá»e
 *
Œ“
 = &
´eá»es
->
šdœeù_missšg_keys
;

726 
rb_node
 *
node
;

728 (
node
 = 
	`rb_fœ¡
(&
Œ“
->
roÙ
))) {

729 
»f
 = 
	`rb_’Œy
(
node
, 
´–im_»f
, 
rbnode
);

730 
	`rb_”a£
(
node
, &
Œ“
->
roÙ
);

732 
	`BUG_ON
(
»f
->
·»Á
);

733 
	`BUG_ON
(
»f
->
key_fÜ_£¬ch
.
ty³
);

734 
	`BUG_ON
(!
»f
->
wª‹d_disk_by‹
);

736 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
»f
->
wª‹d_disk_by‹
, 0);

737 ià(
	`IS_ERR
(
eb
)) {

738 
	`ä“_´ef
(
»f
);

739  
	`PTR_ERR
(
eb
);

740 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

741 
	`ä“_´ef
(
»f
);

742 
	`ä“_ex‹Á_bufãr
(
eb
);

743  -
EIO
;

745 
	`bŒfs_Œ“_»ad_lock
(
eb
);

746 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

747 
	`bŒfs_™em_key_to_ýu
(
eb
, &
»f
->
key_fÜ_£¬ch
, 0);

749 
	`bŒfs_node_key_to_ýu
(
eb
, &
»f
->
key_fÜ_£¬ch
, 0);

750 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

751 
	`ä“_ex‹Á_bufãr
(
eb
);

752 
	`´–im_»f_š£¹
(
fs_šfo
, &
´eá»es
->
šdœeù
, 
»f
, 
NULL
);

753 
	`cÚd_»sched
();

756 
	}
}

762 
	$add_d–ayed_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

763 
bŒfs_d–ayed_»f_h—d
 *
h—d
, 
u64
 
£q
,

764 
´eá»es
 *´eá»es, 
u64
 *
tÙ®_»fs
,

765 
sh¬e_check
 *
sc
)

767 
bŒfs_d–ayed_»f_node
 *
node
;

768 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
 = 
h—d
->extent_op;

769 
bŒfs_key
 
key
;

770 
bŒfs_key
 
tmp_Ý_key
;

771 
bŒfs_key
 *
Ý_key
 = 
NULL
;

772 
couÁ
;

773 
»t
 = 0;

775 ià(
ex‹Á_Ý
 &&ƒx‹Á_Ý->
upd©e_key
) {

776 
	`bŒfs_disk_key_to_ýu
(&
tmp_Ý_key
, &
ex‹Á_Ý
->
key
);

777 
Ý_key
 = &
tmp_Ý_key
;

780 
	`¥š_lock
(&
h—d
->
lock
);

781 
	`li¡_fÜ_—ch_’Œy
(
node
, &
h—d
->
»f_li¡
, 
li¡
) {

782 ià(
node
->
£q
 > seq)

785 
node
->
aùiÚ
) {

786 
BTRFS_ADD_DELAYED_EXTENT
:

787 
BTRFS_UPDATE_DELAYED_HEAD
:

788 
	`WARN_ON
(1);

790 
BTRFS_ADD_DELAYED_REF
:

791 
couÁ
 = 
node
->
»f_mod
;

793 
BTRFS_DROP_DELAYED_REF
:

794 
couÁ
 = 
node
->
»f_mod
 * -1;

797 
	`BUG_ON
(1);

799 *
tÙ®_»fs
 +ð
couÁ
;

800 
node
->
ty³
) {

801 
BTRFS_TREE_BLOCK_REF_KEY
: {

803 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

805 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

806 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
»f
->
roÙ
,

807 &
tmp_Ý_key
, 
»f
->
Ëv–
 + 1,

808 
node
->
by‹Ä
, 
couÁ
, 
sc
,

809 
GFP_ATOMIC
);

812 
BTRFS_SHARED_BLOCK_REF_KEY
: {

814 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

816 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

818 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 
»f
->
Ëv–
 + 1,

819 
»f
->
·»Á
, 
node
->
by‹Ä
, 
couÁ
,

820 
sc
, 
GFP_ATOMIC
);

823 
BTRFS_EXTENT_DATA_REF_KEY
: {

825 
bŒfs_d–ayed_d©a_»f
 *
»f
;

826 
»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
node
);

828 
key
.
objeùid
 = 
»f
->objectid;

829 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

830 
key
.
off£t
 = 
»f
->offset;

836 ià(
sc
 && sc->
šum
 && 
»f
->
objeùid
 != sc->inum) {

837 
»t
 = 
BACKREF_FOUND_SHARED
;

838 
out
;

841 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
»f
->
roÙ
,

842 &
key
, 0, 
node
->
by‹Ä
, 
couÁ
, 
sc
,

843 
GFP_ATOMIC
);

846 
BTRFS_SHARED_DATA_REF_KEY
: {

848 
bŒfs_d–ayed_d©a_»f
 *
»f
;

850 
»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
node
);

852 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 0, 
»f
->
·»Á
,

853 
node
->
by‹Ä
, 
couÁ
, 
sc
,

854 
GFP_ATOMIC
);

858 
	`WARN_ON
(1);

864 ià(
»t
 && (»ˆ!ð
BACKREF_FOUND_SHARED
))

867 ià(!
»t
)

868 
»t
 = 
	`ex‹Á_is_sh¬ed
(
sc
);

869 
out
:

870 
	`¥š_uÆock
(&
h—d
->
lock
);

871  
»t
;

872 
	}
}

879 
	$add_šlše_»fs
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

880 
bŒfs_·th
 *
·th
, 
u64
 
by‹Ä
,

881 *
šfo_Ëv–
, 
´eá»es
 *preftrees,

882 
u64
 *
tÙ®_»fs
, 
sh¬e_check
 *
sc
)

884 
»t
 = 0;

885 
¦Ù
;

886 
ex‹Á_bufãr
 *
Ëaf
;

887 
bŒfs_key
 
key
;

888 
bŒfs_key
 
found_key
;

889 
±r
;

890 
’d
;

891 
bŒfs_ex‹Á_™em
 *
ei
;

892 
u64
 
æags
;

893 
u64
 
™em_size
;

898 
Ëaf
 = 
·th
->
nodes
[0];

899 
¦Ù
 = 
·th
->
¦Ùs
[0];

901 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

902 
	`BUG_ON
(
™em_size
 < (*
ei
));

904 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

905 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

906 *
tÙ®_»fs
 +ð
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

907 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

909 
±r
 = ()(
ei
 + 1);

910 
’d
 = ()
ei
 + 
™em_size
;

912 ià(
found_key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

913 
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

914 
bŒfs_Œ“_block_šfo
 *
šfo
;

916 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)
±r
;

917 *
šfo_Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
šfo
);

918 
±r
 +ð(
bŒfs_Œ“_block_šfo
);

919 
	`BUG_ON
(
±r
 > 
’d
);

920 } ià(
found_key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
) {

921 *
šfo_Ëv–
 = 
found_key
.
off£t
;

923 
	`BUG_ON
(!(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
));

926 
±r
 < 
’d
) {

927 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

928 
u64
 
off£t
;

929 
ty³
;

931 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

932 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

933 
BTRFS_REF_TYPE_ANY
);

934 ià(
ty³
 =ð
BTRFS_REF_TYPE_INVALID
)

935  -
EINVAL
;

937 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
);

939 
ty³
) {

940 
BTRFS_SHARED_BLOCK_REF_KEY
:

941 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
,

942 *
šfo_Ëv–
 + 1, 
off£t
,

943 
by‹Ä
, 1, 
NULL
, 
GFP_NOFS
);

945 
BTRFS_SHARED_DATA_REF_KEY
: {

946 
bŒfs_sh¬ed_d©a_»f
 *
sd»f
;

947 
couÁ
;

949 
sd»f
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

950 
couÁ
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
sd»f
);

952 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 0, 
off£t
,

953 
by‹Ä
, 
couÁ
, 
sc
, 
GFP_NOFS
);

956 
BTRFS_TREE_BLOCK_REF_KEY
:

957 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
off£t
,

958 
NULL
, *
šfo_Ëv–
 + 1,

959 
by‹Ä
, 1, 
NULL
, 
GFP_NOFS
);

961 
BTRFS_EXTENT_DATA_REF_KEY
: {

962 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

963 
couÁ
;

964 
u64
 
roÙ
;

966 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

967 
couÁ
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

968 
key
.
objeùid
 = 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
,

969 
d»f
);

970 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

971 
key
.
off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

973 ià(
sc
 && sc->
šum
 && 
key
.
objeùid
 != sc->inum) {

974 
»t
 = 
BACKREF_FOUND_SHARED
;

978 
roÙ
 = 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
);

980 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
roÙ
,

981 &
key
, 0, 
by‹Ä
, 
couÁ
,

982 
sc
, 
GFP_NOFS
);

986 
	`WARN_ON
(1);

988 ià(
»t
)

989  
»t
;

990 
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

994 
	}
}

1001 
	$add_keyed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

1002 
bŒfs_·th
 *
·th
, 
u64
 
by‹Ä
,

1003 
šfo_Ëv–
, 
´eá»es
 *preftrees,

1004 
sh¬e_check
 *
sc
)

1006 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

1007 
»t
;

1008 
¦Ù
;

1009 
ex‹Á_bufãr
 *
Ëaf
;

1010 
bŒfs_key
 
key
;

1013 
»t
 = 
	`bŒfs_Ãxt_™em
(
ex‹Á_roÙ
, 
·th
);

1014 ià(
»t
 < 0)

1016 ià(
»t
) {

1017 
»t
 = 0;

1021 
¦Ù
 = 
·th
->
¦Ùs
[0];

1022 
Ëaf
 = 
·th
->
nodes
[0];

1023 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

1025 ià(
key
.
objeùid
 !ð
by‹Ä
)

1027 ià(
key
.
ty³
 < 
BTRFS_TREE_BLOCK_REF_KEY
)

1029 ià(
key
.
ty³
 > 
BTRFS_SHARED_DATA_REF_KEY
)

1032 
key
.
ty³
) {

1033 
BTRFS_SHARED_BLOCK_REF_KEY
:

1035 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
,

1036 
šfo_Ëv–
 + 1, 
key
.
off£t
,

1037 
by‹Ä
, 1, 
NULL
, 
GFP_NOFS
);

1039 
BTRFS_SHARED_DATA_REF_KEY
: {

1041 
bŒfs_sh¬ed_d©a_»f
 *
sd»f
;

1042 
couÁ
;

1044 
sd»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

1045 
bŒfs_sh¬ed_d©a_»f
);

1046 
couÁ
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
sd»f
);

1047 
»t
 = 
	`add_dœeù_»f
(
fs_šfo
, 
´eá»es
, 0,

1048 
key
.
off£t
, 
by‹Ä
, 
couÁ
,

1049 
sc
, 
GFP_NOFS
);

1052 
BTRFS_TREE_BLOCK_REF_KEY
:

1054 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
key
.
off£t
,

1055 
NULL
, 
šfo_Ëv–
 + 1, 
by‹Ä
,

1056 1, 
NULL
, 
GFP_NOFS
);

1058 
BTRFS_EXTENT_DATA_REF_KEY
: {

1060 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1061 
couÁ
;

1062 
u64
 
roÙ
;

1064 
d»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

1065 
bŒfs_ex‹Á_d©a_»f
);

1066 
couÁ
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

1067 
key
.
objeùid
 = 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
,

1068 
d»f
);

1069 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1070 
key
.
off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
);

1072 ià(
sc
 && sc->
šum
 && 
key
.
objeùid
 != sc->inum) {

1073 
»t
 = 
BACKREF_FOUND_SHARED
;

1077 
roÙ
 = 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
);

1078 
»t
 = 
	`add_šdœeù_»f
(
fs_šfo
, 
´eá»es
, 
roÙ
,

1079 &
key
, 0, 
by‹Ä
, 
couÁ
,

1080 
sc
, 
GFP_NOFS
);

1084 
	`WARN_ON
(1);

1086 ià(
»t
)

1087  
»t
;

1091  
»t
;

1092 
	}
}

1112 
	$fšd_·»Á_nodes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1113 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1114 
u64
 
time_£q
, 
uli¡
 *
»fs
,

1115 
uli¡
 *
roÙs
, cÚ¡ 
u64
 *
ex‹Á_™em_pos
,

1116 
sh¬e_check
 *
sc
)

1118 
bŒfs_key
 
key
;

1119 
bŒfs_·th
 *
·th
;

1120 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
 = 
NULL
;

1121 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

1122 
šfo_Ëv–
 = 0;

1123 
»t
;

1124 
´–im_»f
 *
»f
;

1125 
rb_node
 *
node
;

1126 
ex‹Á_šode_–em
 *
e›
 = 
NULL
;

1128 
u64
 
tÙ®_»fs
 = 0;

1129 
´eá»es
…reftrees = {

1130 .
dœeù
 = 
PREFTREE_INIT
,

1131 .
šdœeù
 = 
PREFTREE_INIT
,

1132 .
šdœeù_missšg_keys
 = 
PREFTREE_INIT


1135 
key
.
objeùid
 = 
by‹Ä
;

1136 
key
.
off£t
 = (
u64
)-1;

1137 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

1138 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

1140 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1142 
·th
 = 
	`bŒfs_®loc_·th
();

1143 ià(!
·th
)

1144  -
ENOMEM
;

1145 ià(!
Œªs
) {

1146 
·th
->
£¬ch_comm™_roÙ
 = 1;

1147 
·th
->
sk_lockšg
 = 1;

1150 ià(
time_£q
 =ð
SEQ_LAST
)

1151 
·th
->
sk_lockšg
 = 1;

1158 
agaš
:

1159 
h—d
 = 
NULL
;

1161 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

1162 ià(
»t
 < 0)

1163 
out
;

1164 
	`BUG_ON
(
»t
 == 0);

1166 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


1167 ià(
Œªs
 && 
	`lik–y
Ñ¿ns->
ty³
 !ð
__TRANS_DUMMY
) &&

1168 
time_£q
 !ð
SEQ_LAST
) {

1170 ià(
Œªs
 && 
time_£q
 !ð
SEQ_LAST
) {

1176 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1177 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1178 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

1179 ià(
h—d
) {

1180 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

1181 
	`»fcouÁ_šc
(&
h—d
->
node
.
»fs
);

1182 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1184 
	`bŒfs_»Ëa£_·th
(
·th
);

1190 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

1191 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

1192 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

1193 
agaš
;

1195 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1196 
»t
 = 
	`add_d–ayed_»fs
(
fs_šfo
, 
h—d
, 
time_£q
,

1197 &
´eá»es
, &
tÙ®_»fs
, 
sc
);

1198 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

1199 ià(
»t
)

1200 
out
;

1202 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1206 ià(
·th
->
¦Ùs
[0]) {

1207 
ex‹Á_bufãr
 *
Ëaf
;

1208 
¦Ù
;

1210 
·th
->
¦Ùs
[0]--;

1211 
Ëaf
 = 
·th
->
nodes
[0];

1212 
¦Ù
 = 
·th
->
¦Ùs
[0];

1213 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

1214 ià(
key
.
objeùid
 =ð
by‹Ä
 &&

1215 (
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 ||

1216 
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)) {

1217 
»t
 = 
	`add_šlše_»fs
(
fs_šfo
, 
·th
, 
by‹Ä
,

1218 &
šfo_Ëv–
, &
´eá»es
,

1219 &
tÙ®_»fs
, 
sc
);

1220 ià(
»t
)

1221 
out
;

1222 
»t
 = 
	`add_keyed_»fs
(
fs_šfo
, 
·th
, 
by‹Ä
, 
šfo_Ëv–
,

1223 &
´eá»es
, 
sc
);

1224 ià(
»t
)

1225 
out
;

1229 
	`bŒfs_»Ëa£_·th
(
·th
);

1231 
»t
 = 
	`add_missšg_keys
(
fs_šfo
, &
´eá»es
);

1232 ià(
»t
)

1233 
out
;

1235 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
´eá»es
.
šdœeù_missšg_keys
.
roÙ
));

1237 
»t
 = 
	`»sÞve_šdœeù_»fs
(
fs_šfo
, 
·th
, 
time_£q
, &
´eá»es
,

1238 
ex‹Á_™em_pos
, 
tÙ®_»fs
, 
sc
);

1239 ià(
»t
)

1240 
out
;

1242 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
´eá»es
.
šdœeù
.
roÙ
));

1251 
node
 = 
	`rb_fœ¡
(&
´eá»es
.
dœeù
.
roÙ
);

1252 
node
) {

1253 
»f
 = 
	`rb_’Œy
(
node
, 
´–im_»f
, 
rbnode
);

1254 
node
 = 
	`rb_Ãxt
(&
»f
->
rbnode
);

1255 
	`WARN_ON
(
»f
->
couÁ
 < 0);

1256 ià(
roÙs
 && 
»f
->
couÁ
 &&„ef->
roÙ_id
 &&„ef->
·»Á
 == 0) {

1257 ià(
sc
 && sc->
roÙ_objeùid
 &&

1258 
»f
->
roÙ_id
 !ð
sc
->
roÙ_objeùid
) {

1259 
»t
 = 
BACKREF_FOUND_SHARED
;

1260 
out
;

1264 
»t
 = 
	`uli¡_add
(
roÙs
, 
»f
->
roÙ_id
, 0, 
GFP_NOFS
);

1265 ià(
»t
 < 0)

1266 
out
;

1268 ià(
»f
->
couÁ
 &&„ef->
·»Á
) {

1269 ià(
ex‹Á_™em_pos
 && !
»f
->
šode_li¡
 &&

1270 
»f
->
Ëv–
 == 0) {

1271 
ex‹Á_bufãr
 *
eb
;

1273 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
»f
->
·»Á
, 0);

1274 ià(
	`IS_ERR
(
eb
)) {

1275 
»t
 = 
	`PTR_ERR
(
eb
);

1276 
out
;

1277 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

1278 
	`ä“_ex‹Á_bufãr
(
eb
);

1279 
»t
 = -
EIO
;

1280 
out
;

1282 
	`bŒfs_Œ“_»ad_lock
(
eb
);

1283 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

1284 
»t
 = 
	`fšd_ex‹Á_š_eb
(
eb
, 
by‹Ä
,

1285 *
ex‹Á_™em_pos
, &
e›
);

1286 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

1287 
	`ä“_ex‹Á_bufãr
(
eb
);

1288 ià(
»t
 < 0)

1289 
out
;

1290 
»f
->
šode_li¡
 = 
e›
;

1292 
»t
 = 
	`uli¡_add_m”ge_±r
(
»fs
, 
»f
->
·»Á
,

1293 
»f
->
šode_li¡
,

1294 (**)&
e›
, 
GFP_NOFS
);

1295 ià(
»t
 < 0)

1296 
out
;

1297 ià(!
»t
 && 
ex‹Á_™em_pos
) {

1302 
	`BUG_ON
(!
e›
);

1303 
e›
->
Ãxt
)

1304 
e›
 =ƒ›->
Ãxt
;

1305 
e›
->
Ãxt
 = 
»f
->
šode_li¡
;

1307 
e›
 = 
NULL
;

1309 
	`cÚd_»sched
();

1312 
out
:

1313 
	`bŒfs_ä“_·th
(
·th
);

1315 
	`´–im_»Ëa£
(&
´eá»es
.
dœeù
);

1316 
	`´–im_»Ëa£
(&
´eá»es
.
šdœeù
);

1317 
	`´–im_»Ëa£
(&
´eá»es
.
šdœeù_missšg_keys
);

1319 ià(
»t
 < 0)

1320 
	`ä“_šode_–em_li¡
(
e›
);

1321  
»t
;

1322 
	}
}

1324 
	$ä“_Ëaf_li¡
(
uli¡
 *
blocks
)

1326 
uli¡_node
 *
node
 = 
NULL
;

1327 
ex‹Á_šode_–em
 *
e›
;

1328 
uli¡_™”©Ü
 
u™”
;

1330 
	`ULIST_ITER_INIT
(&
u™”
);

1331 (
node
 = 
	`uli¡_Ãxt
(
blocks
, &
u™”
))) {

1332 ià(!
node
->
aux
)

1334 
e›
 = 
	`unode_aux_to_šode_li¡
(
node
);

1335 
	`ä“_šode_–em_li¡
(
e›
);

1336 
node
->
aux
 = 0;

1339 
	`uli¡_ä“
(
blocks
);

1340 
	}
}

1350 
	$bŒfs_fšd_®l_Ëafs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1351 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1352 
u64
 
time_£q
, 
uli¡
 **
Ëafs
,

1353 cÚ¡ 
u64
 *
ex‹Á_™em_pos
)

1355 
»t
;

1357 *
Ëafs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1358 ià(!*
Ëafs
)

1359  -
ENOMEM
;

1361 
»t
 = 
	`fšd_·»Á_nodes
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
time_£q
,

1362 *
Ëafs
, 
NULL
, 
ex‹Á_™em_pos
, NULL);

1363 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
) {

1364 
	`ä“_Ëaf_li¡
(*
Ëafs
);

1365  
»t
;

1369 
	}
}

1384 
	$bŒfs_fšd_®l_roÙs_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1385 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1386 
u64
 
time_£q
, 
uli¡
 **
roÙs
)

1388 
uli¡
 *
tmp
;

1389 
uli¡_node
 *
node
 = 
NULL
;

1390 
uli¡_™”©Ü
 
u™”
;

1391 
»t
;

1393 
tmp
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1394 ià(!
tmp
)

1395  -
ENOMEM
;

1396 *
roÙs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1397 ià(!*
roÙs
) {

1398 
	`uli¡_ä“
(
tmp
);

1399  -
ENOMEM
;

1402 
	`ULIST_ITER_INIT
(&
u™”
);

1404 
»t
 = 
	`fšd_·»Á_nodes
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
time_£q
,

1405 
tmp
, *
roÙs
, 
NULL
, NULL);

1406 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
) {

1407 
	`uli¡_ä“
(
tmp
);

1408 
	`uli¡_ä“
(*
roÙs
);

1409  
»t
;

1411 
node
 = 
	`uli¡_Ãxt
(
tmp
, &
u™”
);

1412 ià(!
node
)

1414 
by‹Ä
 = 
node
->
v®
;

1415 
	`cÚd_»sched
();

1418 
	`uli¡_ä“
(
tmp
);

1420 
	}
}

1422 
	$bŒfs_fšd_®l_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1423 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1424 
u64
 
time_£q
, 
uli¡
 **
roÙs
)

1426 
»t
;

1428 ià(!
Œªs
)

1429 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1430 
»t
 = 
	`bŒfs_fšd_®l_roÙs_§ã
(
Œªs
, 
fs_šfo
, 
by‹Ä
,

1431 
time_£q
, 
roÙs
);

1432 ià(!
Œªs
)

1433 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1434  
»t
;

1435 
	}
}

1451 
	$bŒfs_check_sh¬ed
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šum
, u64 
by‹Ä
)

1453 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1454 
bŒfs_Œªs_hªdË
 *
Œªs
;

1455 
uli¡
 *
tmp
 = 
NULL
;

1456 
uli¡
 *
roÙs
 = 
NULL
;

1457 
uli¡_™”©Ü
 
u™”
;

1458 
uli¡_node
 *
node
;

1459 
£q_li¡
 
–em
 = 
	`SEQ_LIST_INIT
(elem);

1460 
»t
 = 0;

1461 
sh¬e_check
 
sh¬ed
 = {

1462 .
roÙ_objeùid
 = 
roÙ
->
objeùid
,

1463 .
šum
 = inum,

1464 .
sh¬e_couÁ
 = 0,

1467 
tmp
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1468 
roÙs
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1469 ià(!
tmp
 || !
roÙs
) {

1470 
	`uli¡_ä“
(
tmp
);

1471 
	`uli¡_ä“
(
roÙs
);

1472  -
ENOMEM
;

1475 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

1476 ià(
	`IS_ERR
(
Œªs
)) {

1477 
Œªs
 = 
NULL
;

1478 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1480 
	`bŒfs_g‘_Œ“_mod_£q
(
fs_šfo
, &
–em
);

1483 
	`ULIST_ITER_INIT
(&
u™”
);

1485 
»t
 = 
	`fšd_·»Á_nodes
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
–em
.
£q
, 
tmp
,

1486 
roÙs
, 
NULL
, &
sh¬ed
);

1487 ià(
»t
 =ð
BACKREF_FOUND_SHARED
) {

1489 
»t
 = 1;

1492 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1494 
»t
 = 0;

1495 
node
 = 
	`uli¡_Ãxt
(
tmp
, &
u™”
);

1496 ià(!
node
)

1498 
by‹Ä
 = 
node
->
v®
;

1499 
	`cÚd_»sched
();

1502 ià(
Œªs
) {

1503 
	`bŒfs_put_Œ“_mod_£q
(
fs_šfo
, &
–em
);

1504 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1506 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1508 
	`uli¡_ä“
(
tmp
);

1509 
	`uli¡_ä“
(
roÙs
);

1510  
»t
;

1511 
	}
}

1513 
	$bŒfs_fšd_Úe_exŒef
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šode_objeùid
,

1514 
u64
 
¡¬t_off
, 
bŒfs_·th
 *
·th
,

1515 
bŒfs_šode_exŒef
 **
»t_exŒef
,

1516 
u64
 *
found_off
)

1518 
»t
, 
¦Ù
;

1519 
bŒfs_key
 
key
;

1520 
bŒfs_key
 
found_key
;

1521 
bŒfs_šode_exŒef
 *
exŒef
;

1522 cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
;

1523 
±r
;

1525 
key
.
objeùid
 = 
šode_objeùid
;

1526 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1527 
key
.
off£t
 = 
¡¬t_off
;

1529 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1530 ià(
»t
 < 0)

1531  
»t
;

1534 
Ëaf
 = 
·th
->
nodes
[0];

1535 
¦Ù
 = 
·th
->
¦Ùs
[0];

1536 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

1546 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1547 ià(
»t
) {

1548 ià(
»t
 >= 1)

1549 
»t
 = -
ENOENT
;

1555 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

1563 
»t
 = -
ENOENT
;

1564 ià(
found_key
.
objeùid
 !ð
šode_objeùid
)

1566 ià(
found_key
.
ty³
 !ð
BTRFS_INODE_EXTREF_KEY
)

1569 
»t
 = 0;

1570 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1571 
exŒef
 = (
bŒfs_šode_exŒef
 *)
±r
;

1572 *
»t_exŒef
 = 
exŒef
;

1573 ià(
found_off
)

1574 *
found_off
 = 
found_key
.
off£t
;

1578  
»t
;

1579 
	}
}

1595 *
	$bŒfs_»f_to_·th
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

1596 
u32
 
Çme_Ën
, 
Çme_off
,

1597 
ex‹Á_bufãr
 *
eb_š
, 
u64
 
·»Á
,

1598 *
de¡
, 
u32
 
size
)

1600 
¦Ù
;

1601 
u64
 
Ãxt_šum
;

1602 
»t
;

1603 
s64
 
by‹s_Ëá
 = ((s64)
size
) - 1;

1604 
ex‹Á_bufãr
 *
eb
 = 
eb_š
;

1605 
bŒfs_key
 
found_key
;

1606 
Ëave_¥šnšg
 = 
·th
->leave_spinning;

1607 
bŒfs_šode_»f
 *
œef
;

1609 ià(
by‹s_Ëá
 >= 0)

1610 
de¡
[
by‹s_Ëá
] = '\0';

1612 
·th
->
Ëave_¥šnšg
 = 1;

1614 
by‹s_Ëá
 -ð
Çme_Ën
;

1615 ià(
by‹s_Ëá
 >= 0)

1616 
	`»ad_ex‹Á_bufãr
(
eb
, 
de¡
 + 
by‹s_Ëá
,

1617 
Çme_off
, 
Çme_Ën
);

1618 ià(
eb
 !ð
eb_š
) {

1619 ià(!
·th
->
sk_lockšg
)

1620 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

1621 
	`ä“_ex‹Á_bufãr
(
eb
);

1623 
»t
 = 
	`bŒfs_fšd_™em
(
fs_roÙ
, 
·th
, 
·»Á
, 0,

1624 
BTRFS_INODE_REF_KEY
, &
found_key
);

1625 ià(
»t
 > 0)

1626 
»t
 = -
ENOENT
;

1627 ià(
»t
)

1630 
Ãxt_šum
 = 
found_key
.
off£t
;

1633 ià(
·»Á
 =ð
Ãxt_šum
)

1636 
¦Ù
 = 
·th
->
¦Ùs
[0];

1637 
eb
 = 
·th
->
nodes
[0];

1639 ià(
eb
 !ð
eb_š
) {

1640 ià(!
·th
->
sk_lockšg
)

1641 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

1642 
·th
->
nodes
[0] = 
NULL
;

1643 
·th
->
locks
[0] = 0;

1645 
	`bŒfs_»Ëa£_·th
(
·th
);

1646 
œef
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_»f
);

1648 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

1649 
Çme_off
 = ()(
œef
 + 1);

1651 
·»Á
 = 
Ãxt_šum
;

1652 --
by‹s_Ëá
;

1653 ià(
by‹s_Ëá
 >= 0)

1654 
de¡
[
by‹s_Ëá
] = '/';

1657 
	`bŒfs_»Ëa£_·th
(
·th
);

1658 
·th
->
Ëave_¥šnšg
 =†eave_spinning;

1660 ià(
»t
)

1661  
	`ERR_PTR
(
»t
);

1663  
de¡
 + 
by‹s_Ëá
;

1664 
	}
}

1671 
	$ex‹Á_äom_logiÿl
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

1672 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
found_key
,

1673 
u64
 *
æags_»t
)

1675 
»t
;

1676 
u64
 
æags
;

1677 
u64
 
size
 = 0;

1678 
u32
 
™em_size
;

1679 cÚ¡ 
ex‹Á_bufãr
 *
eb
;

1680 
bŒfs_ex‹Á_™em
 *
ei
;

1681 
bŒfs_key
 
key
;

1683 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

1684 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

1686 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1687 
key
.
objeùid
 = 
logiÿl
;

1688 
key
.
off£t
 = (
u64
)-1;

1690 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

1691 ià(
»t
 < 0)

1692  
»t
;

1694 
»t
 = 
	`bŒfs_´evious_ex‹Á_™em
(
fs_šfo
->
ex‹Á_roÙ
, 
·th
, 0);

1695 ià(
»t
) {

1696 ià(
»t
 > 0)

1697 
»t
 = -
ENOENT
;

1698  
»t
;

1700 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], 
found_key
,…©h->
¦Ùs
[0]);

1701 ià(
found_key
->
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

1702 
size
 = 
fs_šfo
->
nodesize
;

1703 ià(
found_key
->
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
)

1704 
size
 = 
found_key
->
off£t
;

1706 ià(
found_key
->
objeùid
 > 
logiÿl
 ||

1707 
found_key
->
objeùid
 + 
size
 <ð
logiÿl
) {

1708 
	`bŒfs_debug
(
fs_šfo
,

1709 "logiÿÈ%Îu i nÙ w™hš‡nyƒx‹Á", 
logiÿl
);

1710  -
ENOENT
;

1713 
eb
 = 
·th
->
nodes
[0];

1714 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
·th
->
¦Ùs
[0]);

1715 
	`BUG_ON
(
™em_size
 < (*
ei
));

1717 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1718 
æags
 = 
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
);

1720 
	`bŒfs_debug
(
fs_šfo
,

1722 
logiÿl
,†ogiÿÈ- 
found_key
->
objeùid
, found_key->objectid,

1723 
found_key
->
off£t
, 
æags
, 
™em_size
);

1725 
	`WARN_ON
(!
æags_»t
);

1726 ià(
æags_»t
) {

1727 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

1728 *
æags_»t
 = 
BTRFS_EXTENT_FLAG_TREE_BLOCK
;

1729 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)

1730 *
æags_»t
 = 
BTRFS_EXTENT_FLAG_DATA
;

1732 
	`BUG_ON
(1);

1736  -
EIO
;

1737 
	}
}

1747 
	$g‘_ex‹Á_šlše_»f
(*
±r
,

1748 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1749 cÚ¡ 
bŒfs_key
 *
key
,

1750 cÚ¡ 
bŒfs_ex‹Á_™em
 *
ei
,

1751 
u32
 
™em_size
,

1752 
bŒfs_ex‹Á_šlše_»f
 **
out_eœef
,

1753 *
out_ty³
)

1755 
’d
;

1756 
u64
 
æags
;

1757 
bŒfs_Œ“_block_šfo
 *
šfo
;

1759 ià(!*
±r
) {

1761 
æags
 = 
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
);

1762 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

1763 ià(
key
->
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
) {

1765 *
out_eœef
 =

1766 (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

1768 
	`WARN_ON
(
key
->
ty³
 !ð
BTRFS_EXTENT_ITEM_KEY
);

1769 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

1770 *
out_eœef
 =

1771 (
bŒfs_ex‹Á_šlše_»f
 *)(
šfo
 + 1);

1774 *
out_eœef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

1776 *
±r
 = ()*
out_eœef
;

1777 ià(()(*
±r
è>ð()
ei
 + 
™em_size
)

1778  -
ENOENT
;

1781 
’d
 = ()
ei
 + 
™em_size
;

1782 *
out_eœef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(*
±r
);

1783 *
out_ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
eb
, *
out_eœef
,

1784 
BTRFS_REF_TYPE_ANY
);

1785 ià(*
out_ty³
 =ð
BTRFS_REF_TYPE_INVALID
)

1786  -
EINVAL
;

1788 *
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(*
out_ty³
);

1789 
	`WARN_ON
(*
±r
 > 
’d
);

1790 ià(*
±r
 =ð
’d
)

1794 
	}
}

1803 
	$Œ“_back»f_fÜ_ex‹Á
(*
±r
, 
ex‹Á_bufãr
 *
eb
,

1804 
bŒfs_key
 *
key
, 
bŒfs_ex‹Á_™em
 *
ei
,

1805 
u32
 
™em_size
, 
u64
 *
out_roÙ
, 
u8
 *
out_Ëv–
)

1807 
»t
;

1808 
ty³
;

1809 
bŒfs_ex‹Á_šlše_»f
 *
eœef
;

1811 ià(*
±r
 == ()-1)

1815 
»t
 = 
	`g‘_ex‹Á_šlše_»f
(
±r
, 
eb
, 
key
, 
ei
, 
™em_size
,

1816 &
eœef
, &
ty³
);

1817 ià(
»t
 < 0)

1818  
»t
;

1820 ià(
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

1821 
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
)

1824 ià(
»t
 == 1)

1829 *
out_roÙ
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
eœef
);

1831 ià(
key
->
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
) {

1832 
bŒfs_Œ“_block_šfo
 *
šfo
;

1834 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

1835 *
out_Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
eb
, 
šfo
);

1837 
	`ASSERT
(
key
->
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
);

1838 *
out_Ëv–
 = (
u8
)
key
->
off£t
;

1841 ià(
»t
 == 1)

1842 *
±r
 = ()-1;

1845 
	}
}

1847 
	$™”©e_Ëaf_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

1848 
ex‹Á_šode_–em
 *
šode_li¡
,

1849 
u64
 
roÙ
, u64 
ex‹Á_™em_objeùid
,

1850 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
ùx
)

1852 
ex‹Á_šode_–em
 *
e›
;

1853 
»t
 = 0;

1855 
e›
 = 
šode_li¡
;ƒ›;ƒ› =ƒ›->
Ãxt
) {

1856 
	`bŒfs_debug
(
fs_šfo
,

1858 
ex‹Á_™em_objeùid
, 
e›
->
šum
,

1859 
e›
->
off£t
, 
roÙ
);

1860 
»t
 = 
	`™”©e
(
e›
->
šum
,ƒ›->
off£t
, 
roÙ
, 
ùx
);

1861 ià(
»t
) {

1862 
	`bŒfs_debug
(
fs_šfo
,

1864 
ex‹Á_™em_objeùid
, 
»t
);

1869  
»t
;

1870 
	}
}

1877 
	$™”©e_ex‹Á_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
,

1878 
u64
 
ex‹Á_™em_objeùid
, u64 
ex‹Á_™em_pos
,

1879 
£¬ch_comm™_roÙ
,

1880 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
ùx
)

1882 
»t
;

1883 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

1884 
uli¡
 *
»fs
 = 
NULL
;

1885 
uli¡
 *
roÙs
 = 
NULL
;

1886 
uli¡_node
 *
»f_node
 = 
NULL
;

1887 
uli¡_node
 *
roÙ_node
 = 
NULL
;

1888 
£q_li¡
 
Œ“_mod_£q_–em
 = 
	`SEQ_LIST_INIT
(tree_mod_seq_elem);

1889 
uli¡_™”©Ü
 
»f_u™”
;

1890 
uli¡_™”©Ü
 
roÙ_u™”
;

1892 
	`bŒfs_debug
(
fs_šfo
, "resolving‡ll inodes forƒxtent %llu",

1893 
ex‹Á_™em_objeùid
);

1895 ià(!
£¬ch_comm™_roÙ
) {

1896 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
fs_šfo
->
ex‹Á_roÙ
);

1897 ià(
	`IS_ERR
(
Œªs
))

1898  
	`PTR_ERR
(
Œªs
);

1899 
	`bŒfs_g‘_Œ“_mod_£q
(
fs_šfo
, &
Œ“_mod_£q_–em
);

1901 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1904 
»t
 = 
	`bŒfs_fšd_®l_Ëafs
(
Œªs
, 
fs_šfo
, 
ex‹Á_™em_objeùid
,

1905 
Œ“_mod_£q_–em
.
£q
, &
»fs
,

1906 &
ex‹Á_™em_pos
);

1907 ià(
»t
)

1908 
out
;

1910 
	`ULIST_ITER_INIT
(&
»f_u™”
);

1911 !
»t
 && (
»f_node
 = 
	`uli¡_Ãxt
(
»fs
, &
»f_u™”
))) {

1912 
»t
 = 
	`bŒfs_fšd_®l_roÙs_§ã
(
Œªs
, 
fs_šfo
, 
»f_node
->
v®
,

1913 
Œ“_mod_£q_–em
.
£q
, &
roÙs
);

1914 ià(
»t
)

1916 
	`ULIST_ITER_INIT
(&
roÙ_u™”
);

1917 !
»t
 && (
roÙ_node
 = 
	`uli¡_Ãxt
(
roÙs
, &
roÙ_u™”
))) {

1918 
	`bŒfs_debug
(
fs_šfo
,

1920 
roÙ_node
->
v®
, 
»f_node
->val,

1921 
»f_node
->
aux
);

1922 
»t
 = 
	`™”©e_Ëaf_»fs
(
fs_šfo
,

1923 (
ex‹Á_šode_–em
 *)

1924 (
ušŒ_t
)
»f_node
->
aux
,

1925 
roÙ_node
->
v®
,

1926 
ex‹Á_™em_objeùid
,

1927 
™”©e
, 
ùx
);

1929 
	`uli¡_ä“
(
roÙs
);

1932 
	`ä“_Ëaf_li¡
(
»fs
);

1933 
out
:

1934 ià(!
£¬ch_comm™_roÙ
) {

1935 
	`bŒfs_put_Œ“_mod_£q
(
fs_šfo
, &
Œ“_mod_£q_–em
);

1936 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1938 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1941  
»t
;

1942 
	}
}

1944 
	$™”©e_šodes_äom_logiÿl
(
u64
 
logiÿl
, 
bŒfs_fs_šfo
 *
fs_šfo
,

1945 
bŒfs_·th
 *
·th
,

1946 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
ùx
)

1948 
»t
;

1949 
u64
 
ex‹Á_™em_pos
;

1950 
u64
 
æags
 = 0;

1951 
bŒfs_key
 
found_key
;

1952 
£¬ch_comm™_roÙ
 = 
·th
->search_commit_root;

1954 
»t
 = 
	`ex‹Á_äom_logiÿl
(
fs_šfo
, 
logiÿl
, 
·th
, &
found_key
, &
æags
);

1955 
	`bŒfs_»Ëa£_·th
(
·th
);

1956 ià(
»t
 < 0)

1957  
»t
;

1958 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

1959  -
EINVAL
;

1961 
ex‹Á_™em_pos
 = 
logiÿl
 - 
found_key
.
objeùid
;

1962 
»t
 = 
	`™”©e_ex‹Á_šodes
(
fs_šfo
, 
found_key
.
objeùid
,

1963 
ex‹Á_™em_pos
, 
£¬ch_comm™_roÙ
,

1964 
™”©e
, 
ùx
);

1966  
»t
;

1967 
	}
}

1969 (
	t™”©e_œefs_t
)(
	tu64
 
	t·»Á
, 
	tu32
 
	tÇme_Ën
, 
	tÇme_off
,

1970 
	tex‹Á_bufãr
 *
	teb
, *
	tùx
);

1972 
	$™”©e_šode_»fs
(
u64
 
šum
, 
bŒfs_roÙ
 *
fs_roÙ
,

1973 
bŒfs_·th
 *
·th
,

1974 
™”©e_œefs_t
 *
™”©e
, *
ùx
)

1976 
»t
 = 0;

1977 
¦Ù
;

1978 
u32
 
cur
;

1979 
u32
 
Ën
;

1980 
u32
 
Çme_Ën
;

1981 
u64
 
·»Á
 = 0;

1982 
found
 = 0;

1983 
ex‹Á_bufãr
 *
eb
;

1984 
bŒfs_™em
 *
™em
;

1985 
bŒfs_šode_»f
 *
œef
;

1986 
bŒfs_key
 
found_key
;

1988 !
»t
) {

1989 
»t
 = 
	`bŒfs_fšd_™em
(
fs_roÙ
, 
·th
, 
šum
,

1990 
·»Á
 ?…¬’ˆ+ 1 : 0, 
BTRFS_INODE_REF_KEY
,

1991 &
found_key
);

1993 ià(
»t
 < 0)

1995 ià(
»t
) {

1996 
»t
 = 
found
 ? 0 : -
ENOENT
;

1999 ++
found
;

2001 
·»Á
 = 
found_key
.
off£t
;

2002 
¦Ù
 = 
·th
->
¦Ùs
[0];

2003 
eb
 = 
	`bŒfs_þÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2004 ià(!
eb
) {

2005 
»t
 = -
ENOMEM
;

2008 
	`ex‹Á_bufãr_g‘
(
eb
);

2009 
	`bŒfs_Œ“_»ad_lock
(
eb
);

2010 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

2011 
	`bŒfs_»Ëa£_·th
(
·th
);

2013 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

2014 
œef
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_»f
);

2016 
cur
 = 0; cu¸< 
	`bŒfs_™em_size
(
eb
, 
™em
); cu¸+ð
Ën
) {

2017 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

2019 
	`bŒfs_debug
(
fs_roÙ
->
fs_šfo
,

2021 
cur
, 
found_key
.
objeùid
, 
fs_roÙ
->objectid);

2022 
»t
 = 
	`™”©e
(
·»Á
, 
Çme_Ën
,

2023 ()(
œef
 + 1), 
eb
, 
ùx
);

2024 ià(
»t
)

2026 
Ën
 = (*
œef
è+ 
Çme_Ën
;

2027 
œef
 = (
bŒfs_šode_»f
 *)((*)œeà+ 
Ën
);

2029 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

2030 
	`ä“_ex‹Á_bufãr
(
eb
);

2033 
	`bŒfs_»Ëa£_·th
(
·th
);

2035  
»t
;

2036 
	}
}

2038 
	$™”©e_šode_exŒefs
(
u64
 
šum
, 
bŒfs_roÙ
 *
fs_roÙ
,

2039 
bŒfs_·th
 *
·th
,

2040 
™”©e_œefs_t
 *
™”©e
, *
ùx
)

2042 
»t
;

2043 
¦Ù
;

2044 
u64
 
off£t
 = 0;

2045 
u64
 
·»Á
;

2046 
found
 = 0;

2047 
ex‹Á_bufãr
 *
eb
;

2048 
bŒfs_šode_exŒef
 *
exŒef
;

2049 
u32
 
™em_size
;

2050 
u32
 
cur_off£t
;

2051 
±r
;

2054 
»t
 = 
	`bŒfs_fšd_Úe_exŒef
(
fs_roÙ
, 
šum
, 
off£t
, 
·th
, &
exŒef
,

2055 &
off£t
);

2056 ià(
»t
 < 0)

2058 ià(
»t
) {

2059 
»t
 = 
found
 ? 0 : -
ENOENT
;

2062 ++
found
;

2064 
¦Ù
 = 
·th
->
¦Ùs
[0];

2065 
eb
 = 
	`bŒfs_þÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2066 ià(!
eb
) {

2067 
»t
 = -
ENOMEM
;

2070 
	`ex‹Á_bufãr_g‘
(
eb
);

2072 
	`bŒfs_Œ“_»ad_lock
(
eb
);

2073 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

2074 
	`bŒfs_»Ëa£_·th
(
·th
);

2076 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

2077 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

2078 
cur_off£t
 = 0;

2080 
cur_off£t
 < 
™em_size
) {

2081 
u32
 
Çme_Ën
;

2083 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 + 
cur_off£t
);

2084 
·»Á
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

2085 
Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

2086 
»t
 = 
	`™”©e
(
·»Á
, 
Çme_Ën
,

2087 ()&
exŒef
->
Çme
, 
eb
, 
ùx
);

2088 ià(
»t
)

2091 
cur_off£t
 +ð
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

2092 
cur_off£t
 +ð(*
exŒef
);

2094 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

2095 
	`ä“_ex‹Á_bufãr
(
eb
);

2097 
off£t
++;

2100 
	`bŒfs_»Ëa£_·th
(
·th
);

2102  
»t
;

2103 
	}
}

2105 
	$™”©e_œefs
(
u64
 
šum
, 
bŒfs_roÙ
 *
fs_roÙ
,

2106 
bŒfs_·th
 *
·th
, 
™”©e_œefs_t
 *
™”©e
,

2107 *
ùx
)

2109 
»t
;

2110 
found_»fs
 = 0;

2112 
»t
 = 
	`™”©e_šode_»fs
(
šum
, 
fs_roÙ
, 
·th
, 
™”©e
, 
ùx
);

2113 ià(!
»t
)

2114 ++
found_»fs
;

2115 ià(
»t
 !ð-
ENOENT
)

2116  
»t
;

2118 
»t
 = 
	`™”©e_šode_exŒefs
(
šum
, 
fs_roÙ
, 
·th
, 
™”©e
, 
ùx
);

2119 ià(
»t
 =ð-
ENOENT
 && 
found_»fs
)

2122  
»t
;

2123 
	}
}

2129 
	$šode_to_·th
(
u64
 
šum
, 
u32
 
Çme_Ën
, 
Çme_off
,

2130 
ex‹Á_bufãr
 *
eb
, *
ùx
)

2132 
šode_fs_·ths
 *
©h
 = 
ùx
;

2133 *
f¥©h
;

2134 *
f¥©h_mš
;

2135 
i
 = 
©h
->
f¥©h
->
–em_út
;

2136 cÚ¡ 
s_±r
 = (*);

2137 
u32
 
by‹s_Ëá
;

2139 
by‹s_Ëá
 = 
©h
->
f¥©h
->by‹s_Ëá > 
s_±r
 ?

2140 
©h
->
f¥©h
->
by‹s_Ëá
 - 
s_±r
 : 0;

2142 
f¥©h_mš
 = (*)
©h
->
f¥©h
->
v®
 + (
i
 + 1è* 
s_±r
;

2143 
f¥©h
 = 
	`bŒfs_»f_to_·th
(
©h
->
fs_roÙ
, i·th->
bŒfs_·th
, 
Çme_Ën
,

2144 
Çme_off
, 
eb
, 
šum
, 
f¥©h_mš
, 
by‹s_Ëá
);

2145 ià(
	`IS_ERR
(
f¥©h
))

2146  
	`PTR_ERR
(
f¥©h
);

2148 ià(
f¥©h
 > 
f¥©h_mš
) {

2149 
©h
->
f¥©h
->
v®
[
i
] = (
u64
)()fspath;

2150 ++
©h
->
f¥©h
->
–em_út
;

2151 
©h
->
f¥©h
->
by‹s_Ëá
 = f¥©h - 
f¥©h_mš
;

2153 ++
©h
->
f¥©h
->
–em_mis£d
;

2154 
©h
->
f¥©h
->
by‹s_missšg
 +ð
f¥©h_mš
 - fspath;

2155 
©h
->
f¥©h
->
by‹s_Ëá
 = 0;

2159 
	}
}

2171 
	$·ths_äom_šode
(
u64
 
šum
, 
šode_fs_·ths
 *
©h
)

2173  
	`™”©e_œefs
(
šum
, 
©h
->
fs_roÙ
, i·th->
bŒfs_·th
,

2174 
šode_to_·th
, 
©h
);

2175 
	}
}

2177 
bŒfs_d©a_cÚš”
 *
	$š™_d©a_cÚš”
(
u32
 
tÙ®_by‹s
)

2179 
bŒfs_d©a_cÚš”
 *
d©a
;

2180 
size_t
 
®loc_by‹s
;

2182 
®loc_by‹s
 = 
	`max_t
(
size_t
, 
tÙ®_by‹s
, (*
d©a
));

2183 
d©a
 = 
	`kvm®loc
(
®loc_by‹s
, 
GFP_KERNEL
);

2184 ià(!
d©a
)

2185  
	`ERR_PTR
(-
ENOMEM
);

2187 ià(
tÙ®_by‹s
 >ð(*
d©a
)) {

2188 
d©a
->
by‹s_Ëá
 = 
tÙ®_by‹s
 - (*data);

2189 
d©a
->
by‹s_missšg
 = 0;

2191 
d©a
->
by‹s_missšg
 = (*d©aè- 
tÙ®_by‹s
;

2192 
d©a
->
by‹s_Ëá
 = 0;

2195 
d©a
->
–em_út
 = 0;

2196 
d©a
->
–em_mis£d
 = 0;

2198  
d©a
;

2199 
	}
}

2207 
šode_fs_·ths
 *
	$š™_©h
(
s32
 
tÙ®_by‹s
, 
bŒfs_roÙ
 *
fs_roÙ
,

2208 
bŒfs_·th
 *
·th
)

2210 
šode_fs_·ths
 *
iå
;

2211 
bŒfs_d©a_cÚš”
 *
f¥©h
;

2213 
f¥©h
 = 
	`š™_d©a_cÚš”
(
tÙ®_by‹s
);

2214 ià(
	`IS_ERR
(
f¥©h
))

2215  (*)
f¥©h
;

2217 
iå
 = 
	`km®loc
((*iå), 
GFP_KERNEL
);

2218 ià(!
iå
) {

2219 
	`kvä“
(
f¥©h
);

2220  
	`ERR_PTR
(-
ENOMEM
);

2223 
iå
->
bŒfs_·th
 = 
·th
;

2224 
iå
->
f¥©h
 = fspath;

2225 
iå
->
fs_roÙ
 = fs_root;

2227  
iå
;

2228 
	}
}

2230 
	$ä“_©h
(
šode_fs_·ths
 *
©h
)

2232 ià(!
©h
)

2234 
	`kvä“
(
©h
->
f¥©h
);

2235 
	`kä“
(
©h
);

2236 
	}
}

	@backref.h

19 #iâdeà
__BTRFS_BACKREF__


20 
	#__BTRFS_BACKREF__


	)

22 
	~<lšux/bŒfs.h
>

23 
	~"uli¡.h
"

24 
	~"ex‹Á_io.h
"

26 
	sšode_fs_·ths
 {

27 
bŒfs_·th
 *
	mbŒfs_·th
;

28 
bŒfs_roÙ
 *
	mfs_roÙ
;

29 
bŒfs_d©a_cÚš”
 *
	mf¥©h
;

32 (
	t™”©e_ex‹Á_šodes_t
)(
	tu64
 
	tšum
, u64 
	toff£t
, u64 
	troÙ
,

33 *
	tùx
);

35 
	`ex‹Á_äom_logiÿl
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
,

36 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
found_key
,

37 
u64
 *
æags
);

39 
	`Œ“_back»f_fÜ_ex‹Á
(*
±r
, 
ex‹Á_bufãr
 *
eb
,

40 
bŒfs_key
 *
key
, 
bŒfs_ex‹Á_™em
 *
ei
,

41 
u32
 
™em_size
, 
u64
 *
out_roÙ
, 
u8
 *
out_Ëv–
);

43 
	`™”©e_ex‹Á_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
,

44 
u64
 
ex‹Á_™em_objeùid
,

45 
u64
 
ex‹Á_off£t
, 
£¬ch_comm™_roÙ
,

46 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
ùx
);

48 
	`™”©e_šodes_äom_logiÿl
(
u64
 
logiÿl
, 
bŒfs_fs_šfo
 *
fs_šfo
,

49 
bŒfs_·th
 *
·th
,

50 
™”©e_ex‹Á_šodes_t
 *
™”©e
, *
ùx
);

52 
	`·ths_äom_šode
(
u64
 
šum
, 
šode_fs_·ths
 *
©h
);

54 
	`bŒfs_fšd_®l_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

55 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

56 
u64
 
time_£q
, 
uli¡
 **
roÙs
);

57 *
	`bŒfs_»f_to_·th
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

58 
u32
 
Çme_Ën
, 
Çme_off
,

59 
ex‹Á_bufãr
 *
eb_š
, 
u64
 
·»Á
,

60 *
de¡
, 
u32
 
size
);

62 
bŒfs_d©a_cÚš”
 *
	`š™_d©a_cÚš”
(
u32
 
tÙ®_by‹s
);

63 
šode_fs_·ths
 *
	`š™_©h
(
s32
 
tÙ®_by‹s
, 
bŒfs_roÙ
 *
fs_roÙ
,

64 
bŒfs_·th
 *
·th
);

65 
	`ä“_©h
(
šode_fs_·ths
 *
©h
);

67 
	`bŒfs_fšd_Úe_exŒef
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šode_objeùid
,

68 
u64
 
¡¬t_off
, 
bŒfs_·th
 *
·th
,

69 
bŒfs_šode_exŒef
 **
»t_exŒef
,

70 
u64
 *
found_off
);

71 
	`bŒfs_check_sh¬ed
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šum
, u64 
by‹Ä
);

73 
__š™
 
	`bŒfs_´–im_»f_š™
();

74 
	`bŒfs_´–im_»f_ex™
();

76 
	s´–im_»f
 {

77 
rb_node
 
rbnode
;

78 
u64
 
roÙ_id
;

79 
bŒfs_key
 
key_fÜ_£¬ch
;

80 
Ëv–
;

81 
couÁ
;

82 
ex‹Á_šode_–em
 *
šode_li¡
;

83 
u64
 
·»Á
;

84 
u64
 
wª‹d_disk_by‹
;

	@btrfs.mod.c

1 
	~<lšux/moduË.h
>

2 
	~<lšux/v”magic.h
>

3 
	~<lšux/compž”.h
>

5 
MODULE_INFO
(
v”magic
, 
VERMAGIC_STRING
);

6 
MODULE_INFO
(
Çme
, 
KBUILD_MODNAME
);

8 
__visibË
 
moduË
 
__this_moduË


9 
__©Œibu‹__
((
£ùiÚ
(".gnu.linkonce.this_module"))) = {

10 .
Çme
 = 
KBUILD_MODNAME
,

11 .
	gš™
 = 
š™_moduË
,

12 #ifdeà
CONFIG_MODULE_UNLOAD


13 .
	gex™
 = 
þ—nup_moduË
,

15 .
	g¬ch
 = 
MODULE_ARCH_INIT
,

18 cÚ¡ 
modv”siÚ_šfo
 
	g____v”siÚs
[]

19 
__u£d


20 
__©Œibu‹__
((
£ùiÚ
("__versions"))) = {

21 { 0xb7e93908, 
__VMLINUX_SYMBOL_STR
(
moduË_Ïyout
) },

22 { 0xb1b55a61, 
__VMLINUX_SYMBOL_STR
(
kobjeù_put
) },

23 { 0x88e45f09, 
__VMLINUX_SYMBOL_STR
(
blkdev_issue_disÿrd
) },

24 { 0xf201650a, 
__VMLINUX_SYMBOL_STR
(
k£t_ü—‹_ªd_add
) },

25 { 0xc0a9d57, 
__VMLINUX_SYMBOL_STR
(
®loc_·ges_cu¼’t
) },

26 { 0x2d3385d3, 
__VMLINUX_SYMBOL_STR
(
sy¡em_wq
) },

27 { 0x96377f43, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_de¡roy
) },

28 { 0xdf5f5327, 
__VMLINUX_SYMBOL_STR
(
k”Ãl_wr™e
) },

29 { 0x6b2daf6d, 
__VMLINUX_SYMBOL_STR
(
km®loc_ÿches
) },

30 { 0xd2b09û5, 
__VMLINUX_SYMBOL_STR
(
__km®loc
) },

31 { 0x35a355ad, 
__VMLINUX_SYMBOL_STR
(
fžem­_check_”rÜs
) },

32 { 0x405c1144, 
__VMLINUX_SYMBOL_STR
(
g‘_£cÚds
) },

33 { 0x9b388444, 
__VMLINUX_SYMBOL_STR
(
g‘_z”Ûd_·ge
) },

34 { 0xe36b5105, 
__VMLINUX_SYMBOL_STR
(
drÝ_Æšk
) },

35 { 0x5e7b92ed, 
__VMLINUX_SYMBOL_STR
(
£t_ªÚ_su³r
) },

36 { 0x7ÿbça9, 
__VMLINUX_SYMBOL_STR
(
subm™_bio_wa™
) },

37 { 0x107e5878, 
__VMLINUX_SYMBOL_STR
(
zlib_šæ©eEnd
) },

38 { 0x2c123«0, 
__VMLINUX_SYMBOL_STR
(
up_»ad
) },

39 { 0xûab0311, 
__VMLINUX_SYMBOL_STR
(
¡rchºul
) },

40 { 0xdaddbd5a, 
__VMLINUX_SYMBOL_STR
(
Œaû_hªdË_»tuº
) },

41 { 0x54e34ad6, 
__VMLINUX_SYMBOL_STR
(
blk_¡©us_to_”ºo
) },

42 { 0x60b4c793, 
__VMLINUX_SYMBOL_STR
(
bio_®loc_bio£t
) },

43 { 0x554631f5, 
__VMLINUX_SYMBOL_STR
(
make_bad_šode
) },

44 { 0x702b835b, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_Î£ek
) },

45 { 0x61cdf6d0, 
__VMLINUX_SYMBOL_STR
(
__m¬k_šode_dœty
) },

46 { 0xc6e442e8, 
__VMLINUX_SYMBOL_STR
(
debugfs_ü—‹_dœ
) },

47 { 0xe9563103, 
__VMLINUX_SYMBOL_STR
(
d_šv®id©e
) },

48 { 0x2d4c7b48, 
__VMLINUX_SYMBOL_STR
(
__£t_·ge_dœty_nobufãrs
) },

49 { 0xad830ç4, 
__VMLINUX_SYMBOL_STR
(
üy±o_®loc_shash
) },

50 { 0x27864d57, 
__VMLINUX_SYMBOL_STR
(
mem·r£
) },

51 { 0xû31b8a1, 
__VMLINUX_SYMBOL_STR
(
pv_lock_Ýs
) },

52 { 0x41767088, 
__VMLINUX_SYMBOL_STR
(
fžem­_çuÉ
) },

53 { 0x349cba85, 
__VMLINUX_SYMBOL_STR
(
¡rchr
) },

54 { 0x7¯1756e, 
__VMLINUX_SYMBOL_STR
(
kvä“
) },

55 { 0x227e30a2, 
__VMLINUX_SYMBOL_STR
(
šode_³rmissiÚ
) },

56 { 0xc942f02f, 
__VMLINUX_SYMBOL_STR
(
__þ—nÿche_g‘_·ge
) },

57 { 0x295928d6, 
__VMLINUX_SYMBOL_STR
(
g’”ic_wr™e_checks
) },

58 { 0x66d804b1, 
__VMLINUX_SYMBOL_STR
(
³rýu_couÁ”_de¡roy
) },

59 { 0xa0fbac79, 
__VMLINUX_SYMBOL_STR
(
wake_up_b™
) },

60 { 0x754d539c, 
__VMLINUX_SYMBOL_STR
(
¡¾’
) },

61 { 0x151f4898, 
__VMLINUX_SYMBOL_STR
(
scheduË_timeout_unš‹¼u±ibË
) },

62 { 0x60a13e90, 
__VMLINUX_SYMBOL_STR
(
rcu_b¬r›r
) },

63 { 0x43a53735, 
__VMLINUX_SYMBOL_STR
(
__®loc_wÜkqueue_key
) },

64 { 0xabÿa577, 
__VMLINUX_SYMBOL_STR
(
ä“_ªÚ_bdev
) },

65 { 0x8b7539a4, 
__VMLINUX_SYMBOL_STR
(
ig‘5_locked
) },

66 { 0xc1d8cçf, 
__VMLINUX_SYMBOL_STR
(
__fdg‘
) },

67 { 0x1cb49449, 
__VMLINUX_SYMBOL_STR
(
mig¿‹_·ge
) },

68 { 0x7446a061, 
__VMLINUX_SYMBOL_STR
(
wr™eback_šodes_sb_Ä
) },

69 { 0x333ad84b, 
__VMLINUX_SYMBOL_STR
(
fšd_g‘_·ges_cÚtig
) },

70 { 0x6b69682d, 
__VMLINUX_SYMBOL_STR
(
kžl_ªÚ_su³r
) },

71 { 0xã9da922, 
__VMLINUX_SYMBOL_STR
(
dg‘_·»Á
) },

72 { 0x87a82b74, 
__VMLINUX_SYMBOL_STR
(
bdev_»ad_Úly
) },

73 { 0xe41476d9, 
__VMLINUX_SYMBOL_STR
(
ZSTD_g‘P¬ams
) },

74 { 0xad73041f, 
__VMLINUX_SYMBOL_STR
(
autÜemove_wake_funùiÚ
) },

75 { 0x6a92974f, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_to_x©Œ
) },

76 { 0x19f462ab, 
__VMLINUX_SYMBOL_STR
(
kä“_ÿÎ_rcu
) },

77 { 0x30af45a1, 
__VMLINUX_SYMBOL_STR
(
ZSTD_š™CSŒ—m
) },

78 { 0x18b73¯e, 
__VMLINUX_SYMBOL_STR
(
fže_¿_¡©e_š™
) },

79 { 0xd1482b70, 
__VMLINUX_SYMBOL_STR
(
£q_esÿ³
) },

80 { 0x4e68e9be, 
__VMLINUX_SYMBOL_STR
(
rb_Ãxt_po¡Üd”
) },

81 { 0xd4c14632, 
__VMLINUX_SYMBOL_STR
(
sy¡em_unbound_wq
) },

82 { 0xbd0e3e46, 
__VMLINUX_SYMBOL_STR
(
£q_puts
) },

83 { 0x80acdda4, 
__VMLINUX_SYMBOL_STR
(
boÙ_ýu_d©a
) },

84 { 0x935c5e35, 
__VMLINUX_SYMBOL_STR
(
is_bad_šode
) },

85 { 0x49603fb8, 
__VMLINUX_SYMBOL_STR
(
£cur™y_sb_cÝy_d©a
) },

86 { 0x25¯6288, 
__VMLINUX_SYMBOL_STR
(
·geÿche_g‘_·ge
) },

87 { 0x88e8675d, 
__VMLINUX_SYMBOL_STR
(
downg¿de_wr™e
) },

88 { 0xabe73823, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_šode_·ges_¿nge
) },

89 { 0x4ab93369, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_Ý’
) },

90 { 0x84235773, 
__VMLINUX_SYMBOL_STR
(
·ge_ÿche_async_»adah—d
) },

91 { 0x1eç9e68, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_acûss_x©Œ_hªdËr
) },

92 { 0xacf4d843, 
__VMLINUX_SYMBOL_STR
(
m©ch_¡rdup
) },

93 { 0xb05c3fd6, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_upd©e_mode
) },

94 { 0x718af0bb, 
__VMLINUX_SYMBOL_STR
(
vfs_k”n_mouÁ
) },

95 { 0x179651ac, 
__VMLINUX_SYMBOL_STR
(
_¿w_»ad_lock
) },

96 { 0x720f007e, 
__VMLINUX_SYMBOL_STR
(
__lock_·ge
) },

97 { 0x13801a58, 
__VMLINUX_SYMBOL_STR
(
kobjeù_uev’t
) },

98 { 0xb1f32596, 
__VMLINUX_SYMBOL_STR
(
g_·ges_fÜ_wr™eback
) },

99 { 0xf9eãe9c, 
__VMLINUX_SYMBOL_STR
(
__¤cu_»ad_uÆock
) },

100 { 0xf827345f, 
__VMLINUX_SYMBOL_STR
(
fžem­_wr™e_ªd_wa™
) },

101 { 0x49ed86a0, 
__VMLINUX_SYMBOL_STR
(
ZSTD_’dSŒ—m
) },

102 { 0xb506ac26, 
__VMLINUX_SYMBOL_STR
(
__lock_bufãr
) },

103 { 0x96488c00, 
__VMLINUX_SYMBOL_STR
(
touch_©ime
) },

104 { 0xe075889a, 
__VMLINUX_SYMBOL_STR
(
d—ùiv©e_locked_su³r
) },

105 { 0xc0a3d105, 
__VMLINUX_SYMBOL_STR
(
fšd_Ãxt_b™
) },

106 { 0x555f6938, 
__VMLINUX_SYMBOL_STR
(
lock»f_g‘
) },

107 { 0xf09cc34, 
__VMLINUX_SYMBOL_STR
(
scheduË_timeout_kžÏbË
) },

108 { 0xc775d417, 
__VMLINUX_SYMBOL_STR
(
dput
) },

109 { 0xbeb—706, 
__VMLINUX_SYMBOL_STR
(
£q_´štf
) },

110 { 0x88bç7e, 
__VMLINUX_SYMBOL_STR
(
ÿnûl_wÜk_sync
) },

111 { 0xfã89088, 
__VMLINUX_SYMBOL_STR
(
sysfs_ü—‹_fžes
) },

112 { 0x7adeb8d4, 
__VMLINUX_SYMBOL_STR
(
ktime_g‘
) },

113 { 0x4e536271, 
__VMLINUX_SYMBOL_STR
(
__dyÇmic_´_debug
) },

114 { 0x“91879b, 
__VMLINUX_SYMBOL_STR
(
rb_fœ¡_po¡Üd”
) },

115 { 0x44e9a829, 
__VMLINUX_SYMBOL_STR
(
m©ch_tok’
) },

116 { 0x448—c3e, 
__VMLINUX_SYMBOL_STR
(
kmemdup
) },

117 { 0x3d26d251, 
__VMLINUX_SYMBOL_STR
(
šc_Æšk
) },

118 { 0x223af0a, 
__VMLINUX_SYMBOL_STR
(
fžp_þo£
) },

119 { 0xf0ef15b4, 
__VMLINUX_SYMBOL_STR
(
li¡_sÜt
) },

120 { 0xc69361dd, 
__VMLINUX_SYMBOL_STR
(
šv®id©e_šode_·ges2
) },

121 { 0x1f9b1fdd, 
__VMLINUX_SYMBOL_STR
(
š™_u£r_ns
) },

122 { 0xÿ924b13, 
__VMLINUX_SYMBOL_STR
(
bio_Œim
) },

123 { 0xb5dbd16a, 
__VMLINUX_SYMBOL_STR
(
__³rýu_couÁ”_sum
) },

124 { 0xa57405df, 
__VMLINUX_SYMBOL_STR
(
³rýu_couÁ”_add_b©ch
) },

125 { 0x251ed92f, 
__VMLINUX_SYMBOL_STR
(
add_to_·ge_ÿche_Ìu
) },

126 { 0x702e04a0, 
__VMLINUX_SYMBOL_STR
(
fžem­_fd©awa™_¿nge
) },

127 { 0x5bd3bf6a, 
__VMLINUX_SYMBOL_STR
(
down_wr™e_kžÏbË
) },

128 { 0xbf63e976, 
__VMLINUX_SYMBOL_STR
(
mu‹x_uÆock
) },

129 { 0x85df9b6c, 
__VMLINUX_SYMBOL_STR
(
¡r£p
) },

130 { 0x3f5f5292, 
__VMLINUX_SYMBOL_STR
(
bio_advªû
) },

131 { 0x9081e0fc, 
__VMLINUX_SYMBOL_STR
(
Œaû_ev’t_bufãr_»£rve
) },

132 { 0xa3454dc3, 
__VMLINUX_SYMBOL_STR
(
kobjeù_d–
) },

133 { 0xc87fcde9, 
__VMLINUX_SYMBOL_STR
(
g’”ic_»ad_dœ
) },

134 { 0x36«c3d8, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_gªg_lookup_¦Ù
) },

135 { 0x999e8297, 
__VMLINUX_SYMBOL_STR
(
vä“
) },

136 { 0x37746fde, 
__VMLINUX_SYMBOL_STR
(
ZSTD_š™DSŒ—m
) },

137 { 0xb14b9ddf, 
__VMLINUX_SYMBOL_STR
(
__g‘blk_gå
) },

138 { 0x4fd6db15, 
__VMLINUX_SYMBOL_STR
(
ig¿b
) },

139 { 0xfcb4d617, 
__VMLINUX_SYMBOL_STR
(
su³r_£tup_bdi
) },

140 { 0x3f009e80, 
__VMLINUX_SYMBOL_STR
(
out_of_lše_wa™_Ú_©omic_t
) },

141 { 0xc6476bf3, 
__VMLINUX_SYMBOL_STR
(
uÆock_bufãr
) },

142 { 0x7a2af7b4, 
__VMLINUX_SYMBOL_STR
(
ýu_numb”
) },

143 { 0x1ac5d3cb, 
__VMLINUX_SYMBOL_STR
(
¡rc¥n
) },

144 { 0x97651e6c, 
__VMLINUX_SYMBOL_STR
(
vmemm­_ba£
) },

145 { 0x6ãfd69b, 
__VMLINUX_SYMBOL_STR
(
»dœty_·ge_fÜ_wr™•age
) },

146 { 0x922f45a6, 
__VMLINUX_SYMBOL_STR
(
__b™m­_þ—r
) },

147 { 0x7ebd4be4, 
__VMLINUX_SYMBOL_STR
(
Œaû_´št_æags_£q
) },

148 { 0x882c89b5, 
__VMLINUX_SYMBOL_STR
(
debugfs_»move_»cursive
) },

149 { 0xf17“9b8, 
__VMLINUX_SYMBOL_STR
(
sysfs_»move_group
) },

150 { 0xc499«1e, 
__VMLINUX_SYMBOL_STR
(
k¡rdup
) },

151 { 0xd5983cb7, 
__VMLINUX_SYMBOL_STR
(
wbc_accouÁ_io
) },

152 { 0x77¯0eb7, 
__VMLINUX_SYMBOL_STR
(
£t_·ge_dœty
) },

153 { 0xf10637c7, 
__VMLINUX_SYMBOL_STR
(
kth»ad_ü—‹_Ú_node
) },

154 { 0x52026cdf, 
__VMLINUX_SYMBOL_STR
(
£cur™y_sb_·r£_Ýts_¡r
) },

155 { 0x15ba50a6, 
__VMLINUX_SYMBOL_STR
(
jiff›s
) },

156 { 0xc45e17d9, 
__VMLINUX_SYMBOL_STR
(
š£¹_šode_locked4
) },

157 { 0x7ã32873, 
__VMLINUX_SYMBOL_STR
(
rb_»¶aû_node
) },

158 { 0x88ac5db, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_£tsize
) },

159 { 0x16d6827b, 
__VMLINUX_SYMBOL_STR
(
iov_™”_çuÉ_š_»adabË
) },

160 { 0x296e389d, 
__VMLINUX_SYMBOL_STR
(
Œy_to_»Ëa£_·ge
) },

161 { 0xccdfd527, 
__VMLINUX_SYMBOL_STR
(
mu‹x_Œylock
) },

162 { 0x11919862, 
__VMLINUX_SYMBOL_STR
(
down_»ad
) },

163 { 0xe2d5255a, 
__VMLINUX_SYMBOL_STR
(
¡rcmp
) },

164 { 0xacb80883, 
__VMLINUX_SYMBOL_STR
(
kobjeù_ü—‹_ªd_add
) },

165 { 0x13ç665c, 
__VMLINUX_SYMBOL_STR
(
down_wr™e_Œylock
) },

166 { 0x7e3b873a, 
__VMLINUX_SYMBOL_STR
(
’d_·ge_wr™eback
) },

167 { 0x878469bd, 
__VMLINUX_SYMBOL_STR
(
ZSTD_decom´essSŒ—m
) },

168 { 0x962c4899, 
__VMLINUX_SYMBOL_STR
(
d_d–‘e
) },

169 { 0xeû1de16, 
__VMLINUX_SYMBOL_STR
(
com¶‘e_®l
) },

170 { 0xeû784c2, 
__VMLINUX_SYMBOL_STR
(
rb_fœ¡
) },

171 { 0x72“cbcd, 
__VMLINUX_SYMBOL_STR
(
šv®id©e_bdev
) },

172 { 0x16e77cb1, 
__VMLINUX_SYMBOL_STR
(
make_kgid
) },

173 { 0x19ad6985, 
__VMLINUX_SYMBOL_STR
(
__š™_wa™queue_h—d
) },

174 { 0xb44ad4b3, 
__VMLINUX_SYMBOL_STR
(
_cÝy_to_u£r
) },

175 { 0x17de3d5, 
__VMLINUX_SYMBOL_STR
(
Ä_ýu_ids
) },

176 { 0x5e0ef40f, 
__VMLINUX_SYMBOL_STR
(
bio_»£t
) },

177 { 0x53439884, 
__VMLINUX_SYMBOL_STR
(
wa™_fÜ_com¶‘iÚ
) },

178 { 0x27586567, 
__VMLINUX_SYMBOL_STR
(
__š£¹_šode_hash
) },

179 { 0x6a9b831f, 
__VMLINUX_SYMBOL_STR
(
šode_owÃr_Ü_ÿ·bË
) },

180 { 0xa084749a, 
__VMLINUX_SYMBOL_STR
(
__b™m­_Ü
) },

181 { 0xd27b25dd, 
__VMLINUX_SYMBOL_STR
(
blk_check_¶ugged
) },

182 { 0x8abada71, 
__VMLINUX_SYMBOL_STR
(
misc_»gi¡”
) },

183 { 0xc4ad579b, 
__VMLINUX_SYMBOL_STR
(
Œaû_defše_f›ld
) },

184 { 0x3c80c06c, 
__VMLINUX_SYMBOL_STR
(
k¡¹ouÎ
) },

185 { 0x2b30f429, 
__VMLINUX_SYMBOL_STR
(
¿id6_ÿÎ
) },

186 { 0xfb578fc5, 
__VMLINUX_SYMBOL_STR
(
mem£t
) },

187 { 0x3885911c, 
__VMLINUX_SYMBOL_STR
(
äom_kuid
) },

188 { 0xadbe8cû, 
__VMLINUX_SYMBOL_STR
(
£t_sk_iÝrio
) },

189 { 0xÿ6fc3e7, 
__VMLINUX_SYMBOL_STR
(
šode_add_by‹s
) },

190 { 0x1916e38c, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_uÆock_œq»¡Üe
) },

191 { 0x1d9ebfb1, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_sk
) },

192 { 0x308c0e7, 
__VMLINUX_SYMBOL_STR
(
»ad_ÿche_·ge_gå
) },

193 { 0x5b6c00e6, 
__VMLINUX_SYMBOL_STR
(
xÜ_blocks
) },

194 { 0xdfbeb8ad, 
__VMLINUX_SYMBOL_STR
(
”ºo_to_blk_¡©us
) },

195 { 0x269cfd2a, 
__VMLINUX_SYMBOL_STR
(
mu‹x_lock_š‹¼u±ibË
) },

196 { 0x605b10e8, 
__VMLINUX_SYMBOL_STR
(
__b»ad_gå
) },

197 { 0xf0c2bfû, 
__VMLINUX_SYMBOL_STR
(
__mu‹x_š™
) },

198 { 0x27e1a049, 
__VMLINUX_SYMBOL_STR
(
´štk
) },

199 { 0x55e84e5b, 
__VMLINUX_SYMBOL_STR
(
kth»ad_¡Ý
) },

200 { 0x6e863f7c, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_chmod
) },

201 { 0x1e63c3c6, 
__VMLINUX_SYMBOL_STR
(
sysfs_ü—‹_group
) },

202 { 0x1c69990f, 
__VMLINUX_SYMBOL_STR
(
d_obš_®Ÿs
) },

203 { 0xdbc53efc, 
__VMLINUX_SYMBOL_STR
(
__aud™_šode_chžd
) },

204 { 0x495cd7f9, 
__VMLINUX_SYMBOL_STR
(
þ—nup_¤cu_¡ruù
) },

205 { 0x449ad0a7, 
__VMLINUX_SYMBOL_STR
(
memcmp
) },

206 { 0x477e59a3, 
__VMLINUX_SYMBOL_STR
(
__ýu_Úlše_mask
) },

207 { 0xa2c54114, 
__VMLINUX_SYMBOL_STR
(
iov_™”_®ignm’t
) },

208 { 0xcf1b1760, 
__VMLINUX_SYMBOL_STR
(
üy±o_shash_upd©e
) },

209 { 0x8b418801, 
__VMLINUX_SYMBOL_STR
(
bio_add_·ge
) },

210 { 0x24c1bcd8, 
__VMLINUX_SYMBOL_STR
(
sg‘
) },

211 { 0xf3211984, 
__VMLINUX_SYMBOL_STR
(
kobjeù_š™_ªd_add
) },

212 { 0x7c1372e8, 
__VMLINUX_SYMBOL_STR
(
·nic
) },

213 { 0x9084b044, 
__VMLINUX_SYMBOL_STR
(
þ—r_·ge_”ms
) },

214 { 0xd8cû4d9, 
__VMLINUX_SYMBOL_STR
(
bio_þÚe_ç¡
) },

215 { 0x90cc0188, 
__VMLINUX_SYMBOL_STR
(
wa™_fÜ_com¶‘iÚ_io
) },

216 { 0xdfb92227, 
__VMLINUX_SYMBOL_STR
(
fže_»move_´ivs
) },

217 { 0x45926da1, 
__VMLINUX_SYMBOL_STR
(
wa™_fÜ_com¶‘iÚ_š‹¼u±ibË
) },

218 { 0x479c3c86, 
__VMLINUX_SYMBOL_STR
(
fšd_Ãxt_z”o_b™
) },

219 { 0xf31b3fd1, 
__VMLINUX_SYMBOL_STR
(
wÜkqueue_£t_max_aùive
) },

220 { 0xa1c76e0a, 
__VMLINUX_SYMBOL_STR
(
_cÚd_»sched
) },

221 { 0x4d9b652b, 
__VMLINUX_SYMBOL_STR
(
rb_”a£
) },

222 { 0x9166çda, 
__VMLINUX_SYMBOL_STR
(
¡ºýy
) },

223 { 0x88a450b7, 
__VMLINUX_SYMBOL_STR
(
Œaû_ev’t_»g
) },

224 { 0xe62426c7, 
__VMLINUX_SYMBOL_STR
(
äom_kgid
) },

225 { 0x49bb7de5, 
__VMLINUX_SYMBOL_STR
(
blkdev_g‘_by_·th
) },

226 { 0x7d«3a98, 
__VMLINUX_SYMBOL_STR
(
£cur™y_šode_š™_£cur™y
) },

227 { 0xû5ac24f, 
__VMLINUX_SYMBOL_STR
(
zlib_šæ©e_wÜk¥aûsize
) },

228 { 0xd68e1d1b, 
__VMLINUX_SYMBOL_STR
(
_¿w_»ad_Œylock
) },

229 { 0x5a921311, 
__VMLINUX_SYMBOL_STR
(
¡ºcmp
) },

230 { 0xdd0983c2, 
__VMLINUX_SYMBOL_STR
(
__·ge_ÿche_®loc
) },

231 { 0x925493f, 
__VMLINUX_SYMBOL_STR
(
þ—r_·ge_Üig
) },

232 { 0xb3fãcb5, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ä“
) },

233 { 0x74«d678, 
__VMLINUX_SYMBOL_STR
(
mu‹x_lock
) },

234 { 0xff236«, 
__VMLINUX_SYMBOL_STR
(
£t_Æšk
) },

235 { 0xc9ÿ7b76, 
__VMLINUX_SYMBOL_STR
(
__wa™_Ú_bufãr
) },

236 { 0x—ed6b03, 
__VMLINUX_SYMBOL_STR
(
fže_upd©e_time
) },

237 { 0xe8db8dd2, 
__VMLINUX_SYMBOL_STR
(
_¿w_wr™e_lock
) },

238 { 0x8c03d20c, 
__VMLINUX_SYMBOL_STR
(
de¡roy_wÜkqueue
) },

239 { 0x4496518, 
__VMLINUX_SYMBOL_STR
(
£‰r_cÝy
) },

240 { 0x1ã8a605, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_gªg_lookup_g
) },

241 { 0x6dc6dd56, 
__VMLINUX_SYMBOL_STR
(
down
) },

242 { 0xe2078ãd, 
__VMLINUX_SYMBOL_STR
(
sysfs_m”ge_group
) },

243 { 0x691a3976, 
__VMLINUX_SYMBOL_STR
(
noÝ_Î£ek
) },

244 { 0xc2cdbf1, 
__VMLINUX_SYMBOL_STR
(
synchrÚize_sched
) },

245 { 0xa681ã88, 
__VMLINUX_SYMBOL_STR
(
g’”©e_¿ndom_uuid
) },

246 { 0x67ba5b43, 
__VMLINUX_SYMBOL_STR
(
kobj_sysfs_Ýs
) },

247 { 0x3737d9a9, 
__VMLINUX_SYMBOL_STR
(
ZSTD_DSŒ—mWÜk¥aûBound
) },

248 { 0xb1d24410, 
__VMLINUX_SYMBOL_STR
(
sync_dœty_bufãr
) },

249 { 0xbb8821d9, 
__VMLINUX_SYMBOL_STR
(
__¤cu_»ad_lock
) },

250 { 0x891a91f5, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_·geÿche
) },

251 { 0x5240“7, 
__VMLINUX_SYMBOL_STR
(
³rýu_couÁ”_b©ch
) },

252 { 0x2446ed42, 
__VMLINUX_SYMBOL_STR
(
£t_ÿched_aþ
) },

253 { 0xfb1c658b, 
__VMLINUX_SYMBOL_STR
(
sysfs_»move_lšk
) },

254 { 0x4e3567f7, 
__VMLINUX_SYMBOL_STR
(
m©ch_št
) },

255 { 0xfb23499f, 
__VMLINUX_SYMBOL_STR
(
wa™_Ú_·ge_b™
) },

256 { 0x5a0b73d0, 
__VMLINUX_SYMBOL_STR
(
zlib_deæ©eIn™2
) },

257 { 0x488077c0, 
__VMLINUX_SYMBOL_STR
(
uÆock_·ge
) },

258 { 0x7ddade9e, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_»ad_™”
) },

259 { 0xe3a53f4c, 
__VMLINUX_SYMBOL_STR
(
sÜt
) },

260 { 0xã174b59, 
__VMLINUX_SYMBOL_STR
(
up_wr™e
) },

261 { 0xdb752182, 
__VMLINUX_SYMBOL_STR
(
kobjeù_add
) },

262 { 0xfd9c2af7, 
__VMLINUX_SYMBOL_STR
(
down_wr™e
) },

263 { 0x51543167, 
__VMLINUX_SYMBOL_STR
(
åut
) },

264 { 0x536fd709, 
__VMLINUX_SYMBOL_STR
(
sysfs_unm”ge_group
) },

265 { 0x45833549, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_dœeù_wr™e
) },

266 { 0x341795d7, 
__VMLINUX_SYMBOL_STR
(
³rf_Œaû_run_bpf_subm™
) },

267 { 0x2ab016d8, 
__VMLINUX_SYMBOL_STR
(
š™_¤cu_¡ruù
) },

268 { 0xad5f0017, 
__VMLINUX_SYMBOL_STR
(
³rf_Œaû_buf_®loc
) },

269 { 0x5û0“16, 
__VMLINUX_SYMBOL_STR
(
šode_nohighmem
) },

270 { 0x4e2b2420, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_ü—‹
) },

271 { 0x5a9«2c0, 
__VMLINUX_SYMBOL_STR
(
__b»l£
) },

272 { 0xã487975, 
__VMLINUX_SYMBOL_STR
(
š™_wa™_’Œy
) },

273 { 0x11488“f, 
__VMLINUX_SYMBOL_STR
(
b®ªû_dœty_·ges_¿‹lim™ed
) },

274 { 0xa74e0bc7, 
__VMLINUX_SYMBOL_STR
(
mouÁ_subŒ“
) },

275 { 0x4637a183, 
__VMLINUX_SYMBOL_STR
(
bio_’dio
) },

276 { 0x7e880422, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_d–‘e
) },

277 { 0x748529b9, 
__VMLINUX_SYMBOL_STR
(
bio_put
) },

278 { 0x4—5d10, 
__VMLINUX_SYMBOL_STR
(
ksize
) },

279 { 0x58e3306d, 
__VMLINUX_SYMBOL_STR
(
b™_wa™_io
) },

280 { 0x63a7e9d7, 
__VMLINUX_SYMBOL_STR
(
m¬k_·ge_acûs£d
) },

281 { 0x581f98da, 
__VMLINUX_SYMBOL_STR
(
zlib_šæ©e
) },

282 { 0x484f740c, 
__VMLINUX_SYMBOL_STR
(
”r£q_check
) },

283 { 0xe35çb6c, 
__VMLINUX_SYMBOL_STR
(
šode_š™_Úû
) },

284 { 0xb347bb2c, 
__VMLINUX_SYMBOL_STR
(
wÜk_busy
) },

285 { 0xc5bc25de, 
__VMLINUX_SYMBOL_STR
(
kvm®loc_node
) },

286 { 0x9a839c59, 
__VMLINUX_SYMBOL_STR
(
mÁput
) },

287 { 0x615911d7, 
__VMLINUX_SYMBOL_STR
(
__b™m­_£t
) },

288 { 0xd516194e, 
__VMLINUX_SYMBOL_STR
(
sysfs_ü—‹_lšk
) },

289 { 0x7cd8d75e, 
__VMLINUX_SYMBOL_STR
(
·ge_off£t_ba£
) },

290 { 0x47803c56, 
__VMLINUX_SYMBOL_STR
(
mÁ_drÝ_wr™e_fže
) },

291 { 0x783b3563, 
__VMLINUX_SYMBOL_STR
(
wake_up_©omic_t
) },

292 { 0x17c3d9a9, 
__VMLINUX_SYMBOL_STR
(
subm™_bio
) },

293 { 0xc6cbbc89, 
__VMLINUX_SYMBOL_STR
(
ÿ·bË
) },

294 { 0x6f2e4f46, 
__VMLINUX_SYMBOL_STR
(
__cÚd_»sched_lock
) },

295 { 0x23b4e0d7, 
__VMLINUX_SYMBOL_STR
(
þ—r_·ge_»p
) },

296 { 0xbd9074b1, 
__VMLINUX_SYMBOL_STR
(
blk_fšish_¶ug
) },

297 { 0xb0«d408, 
__VMLINUX_SYMBOL_STR
(
ZSTD_com´essSŒ—m
) },

298 { 0xd598cf48, 
__VMLINUX_SYMBOL_STR
(
x©Œ_fuÎ_Çme
) },

299 { 0x9f984513, 
__VMLINUX_SYMBOL_STR
(
¡¼chr
) },

300 { 0x6e6b49d3, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_gªg_lookup
) },

301 { 0x46c9514f, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc
) },

302 { 0x8ff4079b, 
__VMLINUX_SYMBOL_STR
(
pv_œq_Ýs
) },

303 { 0xc54488e8, 
__VMLINUX_SYMBOL_STR
(
__ä“_·ges
) },

304 { 0x11a75401, 
__VMLINUX_SYMBOL_STR
(
__check_¡icky
) },

305 { 0x6fd28b4c, 
__VMLINUX_SYMBOL_STR
(
accouÁ_·ge_»dœty
) },

306 { 0x1219b1ç, 
__VMLINUX_SYMBOL_STR
(
blkdev_put
) },

307 { 0x73û0fcf, 
__VMLINUX_SYMBOL_STR
(
bio_assocŸ‹_blkcg
) },

308 { 0xb2fd5ûb, 
__VMLINUX_SYMBOL_STR
(
__put_u£r_4
) },

309 { 0x33b84f74, 
__VMLINUX_SYMBOL_STR
(
cÝy_·ge
) },

310 { 0xad6û89b, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_g_£t
) },

311 { 0xa916b694, 
__VMLINUX_SYMBOL_STR
(
¡ºËn
) },

312 { 0xcc6effû, 
__VMLINUX_SYMBOL_STR
(
sim¶e_dœ_Ý”©iÚs
) },

313 { 0x9cd20c1a, 
__VMLINUX_SYMBOL_STR
(
__fžem­_£t_wb_”r
) },

314 { 0x217dacda, 
__VMLINUX_SYMBOL_STR
(
fs_kobj
) },

315 { 0x812e0ac4, 
__VMLINUX_SYMBOL_STR
(
sync_blockdev
) },

316 { 0x7540558e, 
__VMLINUX_SYMBOL_STR
(
šode_sub_by‹s
) },

317 { 0x5fda5e7f, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_šode_·ges_fš®
) },

318 { 0x756¯db0, 
__VMLINUX_SYMBOL_STR
(
make_kuid
) },

319 { 0x11b52d8e, 
__VMLINUX_SYMBOL_STR
(
Œaû_ev’t_ignÜe_this_pid
) },

320 { 0x37df02e9, 
__VMLINUX_SYMBOL_STR
(
·gevec_lookup_g
) },

321 { 0xf82ec573, 
__VMLINUX_SYMBOL_STR
(
rb_´ev
) },

322 { 0xe9f7149c, 
__VMLINUX_SYMBOL_STR
(
zlib_deæ©e_wÜk¥aûsize
) },

323 { 0xdb7305a1, 
__VMLINUX_SYMBOL_STR
(
__¡ack_chk_çž
) },

324 { 0x9cb986f2, 
__VMLINUX_SYMBOL_STR
(
vm®loc_ba£
) },

325 { 0xadfdfûf, 
__VMLINUX_SYMBOL_STR
(
__b™m­_ªdnÙ
) },

326 { 0x1000e51, 
__VMLINUX_SYMBOL_STR
(
scheduË
) },

327 { 0x8ddd8¯d, 
__VMLINUX_SYMBOL_STR
(
scheduË_timeout
) },

328 { 0xf4fded96, 
__VMLINUX_SYMBOL_STR
(
___¿‹lim™
) },

329 { 0x5f80b46d, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_äom_x©Œ
) },

330 { 0xfdfc0b3b, 
__VMLINUX_SYMBOL_STR
(
f›m­_fžl_Ãxt_ex‹Á
) },

331 { 0x11142ab7, 
__VMLINUX_SYMBOL_STR
(
bio£t_ü—‹
) },

332 { 0xe5815f8a, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock_œq
) },

333 { 0x92227f76, 
__VMLINUX_SYMBOL_STR
(
bio£t_š‹gr™y_ü—‹
) },

334 { 0x94d268d4, 
__VMLINUX_SYMBOL_STR
(
uÆock_Ãw_šode
) },

335 { 0xc86ff01a, 
__VMLINUX_SYMBOL_STR
(
mÁ_wªt_wr™e_fže
) },

336 { 0x489110“, 
__VMLINUX_SYMBOL_STR
(
šode_Ãwsize_ok
) },

337 { 0xe4b051cf, 
__VMLINUX_SYMBOL_STR
(
¿id6_d©­_»cov
) },

338 { 0x5e95b1cd, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_umask
) },

339 { 0x437e7d2b, 
__VMLINUX_SYMBOL_STR
(
·ge_ÿche_sync_»adah—d
) },

340 { 0x8f3e0b70, 
__VMLINUX_SYMBOL_STR
(
šode_£t_by‹s
) },

341 { 0xcf64692d, 
__VMLINUX_SYMBOL_STR
(
šode_g‘_by‹s
) },

342 { 0x211f68f1, 
__VMLINUX_SYMBOL_STR
(
g‘n¡imeofday64
) },

343 { 0x312077c8, 
__VMLINUX_SYMBOL_STR
(
üy±o_de¡roy_tfm
) },

344 { 0x68fdf007, 
__VMLINUX_SYMBOL_STR
(
Œaû_ev’t_bufãr_comm™
) },

345 { 0x3c58238c, 
__VMLINUX_SYMBOL_STR
(
wake_up_´oûss
) },

346 { 0x92203d5c, 
__VMLINUX_SYMBOL_STR
(
d_´uÃ_®Ÿ£s
) },

347 { 0xbaffff96, 
__VMLINUX_SYMBOL_STR
(
ZSTD_CSŒ—mWÜk¥aûBound
) },

348 { 0xb905c66, 
__VMLINUX_SYMBOL_STR
(
__³rýu_couÁ”_š™
) },

349 { 0xbdfb6dbb, 
__VMLINUX_SYMBOL_STR
(
__ãÁry__
) },

350 { 0x4475e7c9, 
__VMLINUX_SYMBOL_STR
(
vfs_£os
) },

351 { 0xa104¯b5, 
__VMLINUX_SYMBOL_STR
(
þ—r_·ge_dœty_fÜ_io
) },

352 { 0xec018b66, 
__VMLINUX_SYMBOL_STR
(
__¿dix_Œ“_š£¹
) },

353 { 0xd2c71289, 
__VMLINUX_SYMBOL_STR
(
subm™_bh
) },

354 { 0x8652—a3, 
__VMLINUX_SYMBOL_STR
(
down_»ad_Œylock
) },

355 { 0x4e9558bf, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_®loc_Œaû
) },

356 { 0x261d594c, 
__VMLINUX_SYMBOL_STR
(
dio_’d_io
) },

357 { 0xe259«9e, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock
) },

358 { 0x680ec266, 
__VMLINUX_SYMBOL_STR
(
_¿w_¥š_lock_œq§ve
) },

359 { 0x5363326c, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_g_þ—r
) },

360 { 0xa5526619, 
__VMLINUX_SYMBOL_STR
(
rb_š£¹_cÞÜ
) },

361 { 0x6çec18f, 
__VMLINUX_SYMBOL_STR
(
kmem_ÿche_ü—‹
) },

362 { 0x8d5d364e, 
__VMLINUX_SYMBOL_STR
(
d_tmpfže
) },

363 { 0x9edeûd2, 
__VMLINUX_SYMBOL_STR
(
»gi¡”_fžesy¡em
) },

364 { 0x35a88f28, 
__VMLINUX_SYMBOL_STR
(
zlib_šæ©eIn™2
) },

365 { 0x8e6c7eû, 
__VMLINUX_SYMBOL_STR
(
£q_d’Œy
) },

366 { 0xf2c43f3f, 
__VMLINUX_SYMBOL_STR
(
zlib_deæ©e
) },

367 { 0x4302d0eb, 
__VMLINUX_SYMBOL_STR
(
ä“_·ges
) },

368 { 0x75d61b65, 
__VMLINUX_SYMBOL_STR
(
synchrÚize_¤cu
) },

369 { 0x5df8fd57, 
__VMLINUX_SYMBOL_STR
(
ev’t_Œigg”s_ÿÎ
) },

370 { 0x5b205e34, 
__VMLINUX_SYMBOL_STR
(
__wake_up
) },

371 { 0x8bd717a2, 
__VMLINUX_SYMBOL_STR
(
sysfs_»move_fžes
) },

372 { 0xb3f7646e, 
__VMLINUX_SYMBOL_STR
(
kth»ad_should_¡Ý
) },

373 { 0x4c455cb5, 
__VMLINUX_SYMBOL_STR
(
__·gevec_»Ëa£
) },

374 { 0x1984d421, 
__VMLINUX_SYMBOL_STR
(
out_of_lše_wa™_Ú_b™
) },

375 { 0x69e43cfd, 
__VMLINUX_SYMBOL_STR
(
´•¬e_to_wa™_ev’t
) },

376 { 0x3db8d5cc, 
__VMLINUX_SYMBOL_STR
(
__‹¡_£t_·ge_wr™eback
) },

377 { 0xc3024baf, 
__VMLINUX_SYMBOL_STR
(
I_BDEV
) },

378 { 0xbe1d48e8, 
__VMLINUX_SYMBOL_STR
(
blockdev_su³rblock
) },

379 { 0x9a60e2a8, 
__VMLINUX_SYMBOL_STR
(
k£t_uÄegi¡”
) },

380 { 0x20d1e91, 
__VMLINUX_SYMBOL_STR
(
ut
) },

381 { 0x37a0cba, 
__VMLINUX_SYMBOL_STR
(
kä“
) },

382 { 0xcc414350, 
__VMLINUX_SYMBOL_STR
(
Œunÿ‹_·geÿche_¿nge
) },

383 { 0x6d3798e, 
__VMLINUX_SYMBOL_STR
(
g’”ic_³rmissiÚ
) },

384 { 0x9fda308b, 
__VMLINUX_SYMBOL_STR
(
šode_dio_wa™
) },

385 { 0x590b2531, 
__VMLINUX_SYMBOL_STR
(
·ge_g‘_lšk
) },

386 { 0xed90634e, 
__VMLINUX_SYMBOL_STR
(
ihÞd
) },

387 { 0x69acdf38, 
__VMLINUX_SYMBOL_STR
(
memýy
) },

388 { 0xf6c7ac56, 
__VMLINUX_SYMBOL_STR
(
__sb_’d_wr™e
) },

389 { 0x61520529, 
__VMLINUX_SYMBOL_STR
(
Œaû_´št_symbÞs_£q
) },

390 { 0x932e7837, 
__VMLINUX_SYMBOL_STR
(
Œaû_ev’t_¿w_š™
) },

391 { 0x643e0û5, 
__VMLINUX_SYMBOL_STR
(
ÿÎ_rcu_sched
) },

392 { 0x783“c86, 
__VMLINUX_SYMBOL_STR
(
cu¼’t_time
) },

393 { 0xc63e9462, 
__VMLINUX_SYMBOL_STR
(
´•¬e_to_wa™
) },

394 { 0xef7f3741, 
__VMLINUX_SYMBOL_STR
(
g’”ic_”rÜ_»move_·ge
) },

395 { 0xebbdb91e, 
__VMLINUX_SYMBOL_STR
(
d_¥liû_®Ÿs
) },

396 { 0xd0a91bab, 
__VMLINUX_SYMBOL_STR
(
sk_¥aûs
) },

397 { 0x3943e4d4, 
__VMLINUX_SYMBOL_STR
(
f¢Ùify
) },

398 { 0x1e26be3b, 
__VMLINUX_SYMBOL_STR
(
g‘_ªÚ_bdev
) },

399 { 0x1e3b3522, 
__VMLINUX_SYMBOL_STR
(
kobjeù_š™
) },

400 { 0x9754ec10, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_´–ßd
) },

401 { 0xeûb9c7e, 
__VMLINUX_SYMBOL_STR
(
sync_fžesy¡em
) },

402 { 0x78e739¯, 
__VMLINUX_SYMBOL_STR
(
up
) },

403 { 0x24ac2427, 
__VMLINUX_SYMBOL_STR
(
šv®id©e_m­pšg_·ges
) },

404 { 0x787c882b, 
__VMLINUX_SYMBOL_STR
(
lzo1x_1_com´ess
) },

405 { 0x9913af4c, 
__VMLINUX_SYMBOL_STR
(
fg‘
) },

406 { 0x50a90e8d, 
__VMLINUX_SYMBOL_STR
(
b£¬ch
) },

407 { 0x242e155, 
__VMLINUX_SYMBOL_STR
(
__sb_¡¬t_wr™e
) },

408 { 0x53569707, 
__VMLINUX_SYMBOL_STR
(
this_ýu_off
) },

409 { 0xd1a98c5e, 
__VMLINUX_SYMBOL_STR
(
d_make_roÙ
) },

410 { 0xf3—50bd, 
__VMLINUX_SYMBOL_STR
(
__blockdev_dœeù_IO
) },

411 { 0xf5ã954e, 
__VMLINUX_SYMBOL_STR
(
iov_™”_advªû
) },

412 { 0x4df8fbc, 
__VMLINUX_SYMBOL_STR
(
lzo1x_decom´ess_§ã
) },

413 { 0x6c3f70e0, 
__VMLINUX_SYMBOL_STR
(
guid_g’
) },

414 { 0xb352177e, 
__VMLINUX_SYMBOL_STR
(
fšd_fœ¡_b™
) },

415 { 0x9bd4b263, 
__VMLINUX_SYMBOL_STR
(
iov_™”_cÝy_äom_u£r_©omic
) },

416 { 0xc890c008, 
__VMLINUX_SYMBOL_STR
(
zlib_deæ©eEnd
) },

417 { 0xûd6bcd8, 
__VMLINUX_SYMBOL_STR
(
fšish_wa™
) },

418 { 0x1803a6ed, 
__VMLINUX_SYMBOL_STR
(
¿id6_2d©a_»cov
) },

419 { 0x92a6f160, 
__VMLINUX_SYMBOL_STR
(
¿dix_Œ“_lookup
) },

420 { 0x1ef03a54, 
__VMLINUX_SYMBOL_STR
(
fžem­_fd©awr™e_¿nge
) },

421 { 0xdf06e0c6, 
__VMLINUX_SYMBOL_STR
(
__fšd_g‘_block
) },

422 { 0xb9487b32, 
__VMLINUX_SYMBOL_STR
(
posix_aþ_deçuÉ_x©Œ_hªdËr
) },

423 { 0x63c4d61f, 
__VMLINUX_SYMBOL_STR
(
__b™m­_weight
) },

424 { 0xÿ9360b5, 
__VMLINUX_SYMBOL_STR
(
rb_Ãxt
) },

425 { 0x6be5f0a, 
__VMLINUX_SYMBOL_STR
(
uÄegi¡”_fžesy¡em
) },

426 { 0x8c846a39, 
__VMLINUX_SYMBOL_STR
(
š™_¥ecŸl_šode
) },

427 { 0x1e8e8436, 
__VMLINUX_SYMBOL_STR
(
£cur™y_sb_£t_mÁ_Ýts
) },

428 { 0x240b75e7, 
__VMLINUX_SYMBOL_STR
(
kobjeù_»Çme
) },

429 { 0xa283697, 
__VMLINUX_SYMBOL_STR
(
Œaû_¿w_ouut_´•
) },

430 { 0x9291cd3b, 
__VMLINUX_SYMBOL_STR
(
memdup_u£r
) },

431 { 0x2e0d2f7f, 
__VMLINUX_SYMBOL_STR
(
queue_wÜk_Ú
) },

432 { 0x4610«e6, 
__VMLINUX_SYMBOL_STR
(
com¶‘e
) },

433 { 0x6264077a, 
__VMLINUX_SYMBOL_STR
(
fžem­_m­_·ges
) },

434 { 0x28318305, 
__VMLINUX_SYMBOL_STR
(
¢´štf
) },

435 { 0x871c0a7e, 
__VMLINUX_SYMBOL_STR
(
f›m­_check_æags
) },

436 { 0xaf5b8886, 
__VMLINUX_SYMBOL_STR
(
Ãw_šode
) },

437 { 0x11ÿddc7, 
__VMLINUX_SYMBOL_STR
(
Œaû_£q_´štf
) },

438 { 0xb0e602eb, 
__VMLINUX_SYMBOL_STR
(
memmove
) },

439 { 0x822967“, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fže_¥liû_»ad
) },

440 { 0x959647c9, 
__VMLINUX_SYMBOL_STR
(
lookup_Úe_Ën
) },

441 { 0x4ûe62be, 
__VMLINUX_SYMBOL_STR
(
£t_blocksize
) },

442 { 0x708a79f7, 
__VMLINUX_SYMBOL_STR
(
__³rýu_couÁ”_com·»
) },

443 { 0xdf2c2742, 
__VMLINUX_SYMBOL_STR
(
rb_Ï¡
) },

444 { 0x174f9015, 
__VMLINUX_SYMBOL_STR
(
z”o_fžl_bio
) },

445 { 0x362ef408, 
__VMLINUX_SYMBOL_STR
(
_cÝy_äom_u£r
) },

446 { 0xa0805db2, 
__VMLINUX_SYMBOL_STR
(
bio£t_ä“
) },

447 { 0x702dbc98, 
__VMLINUX_SYMBOL_STR
(
__þ—nÿche_š™_fs
) },

448 { 0xb4314db0, 
__VMLINUX_SYMBOL_STR
(
þ—r_šode
) },

449 { 0x7d705738, 
__VMLINUX_SYMBOL_STR
(
blk_¡¬t_¶ug
) },

450 { 0xd97475e5, 
__VMLINUX_SYMBOL_STR
(
misc_d”egi¡”
) },

451 { 0x2a6c2cd8, 
__VMLINUX_SYMBOL_STR
(
·geÿche_isize_ex‹nded
) },

452 { 0x780bdde5, 
__VMLINUX_SYMBOL_STR
(
d_š¡ªtŸ‹
) },

453 { 0x51158265, 
__VMLINUX_SYMBOL_STR
(
__š™_rw£m
) },

454 { 0x48cû570, 
__VMLINUX_SYMBOL_STR
(
fžem­_æush
) },

455 { 0xcd87c62e, 
__VMLINUX_SYMBOL_STR
(
__put_·ge
) },

456 { 0x62bd7041, 
__VMLINUX_SYMBOL_STR
(
fže_check_ªd_advªû_wb_”r
) },

457 { 0x54031233, 
__VMLINUX_SYMBOL_STR
(
þ—r_Æšk
) },

458 { 0x274b986d, 
__VMLINUX_SYMBOL_STR
(
£‰r_´•¬e
) },

459 { 0xf3412d1a, 
__VMLINUX_SYMBOL_STR
(
vfs_fsync_¿nge
) },

460 { 0x7c2d098f, 
__VMLINUX_SYMBOL_STR
(
k»®loc
) },

461 { 0x20065679, 
__VMLINUX_SYMBOL_STR
(
g’”ic_fžÏ‰r
) },

462 { 0xa8f33b82, 
__VMLINUX_SYMBOL_STR
(
šode_š™_owÃr
) },

463 { 0xe914e41e, 
__VMLINUX_SYMBOL_STR
(
¡rýy
) },

464 { 0x844ab2c4, 
__VMLINUX_SYMBOL_STR
(
noÝ_backšg_dev_šfo
) },

465 { 0x8ad82482, 
__VMLINUX_SYMBOL_STR
(
fžp_Ý’
) },

466 { 0xc496617b, 
__VMLINUX_SYMBOL_STR
(
__·ge_fže_šdex
) },

469 cÚ¡ 
	g__moduË_d•’ds
[]

470 
__u£d


471 
__©Œibu‹__
((
£ùiÚ
(".modinfo"))) =

475 
MODULE_INFO
(
¤cv”siÚ
, "ACE83B6761B239C2D42B228");

	@btrfs_inode.h

19 #iâdeà
__BTRFS_I__


20 
	#__BTRFS_I__


	)

22 
	~<lšux/hash.h
>

23 
	~"ex‹Á_m­.h
"

24 
	~"ex‹Á_io.h
"

25 
	~"Üd”ed-d©a.h
"

26 
	~"d–ayed-šode.h
"

35 
	#BTRFS_INODE_ORDERED_DATA_CLOSE
 0

	)

36 
	#BTRFS_INODE_ORPHAN_META_RESERVED
 1

	)

37 
	#BTRFS_INODE_DUMMY
 2

	)

38 
	#BTRFS_INODE_IN_DEFRAG
 3

	)

39 
	#BTRFS_INODE_DELALLOC_META_RESERVED
 4

	)

40 
	#BTRFS_INODE_HAS_ORPHAN_ITEM
 5

	)

41 
	#BTRFS_INODE_HAS_ASYNC_EXTENT
 6

	)

42 
	#BTRFS_INODE_NEEDS_FULL_SYNC
 7

	)

43 
	#BTRFS_INODE_COPY_EVERYTHING
 8

	)

44 
	#BTRFS_INODE_IN_DELALLOC_LIST
 9

	)

45 
	#BTRFS_INODE_READDIO_NEED_LOCK
 10

	)

46 
	#BTRFS_INODE_HAS_PROPS
 11

	)

49 
	sbŒfs_šode
 {

51 
bŒfs_roÙ
 *
	mroÙ
;

56 
bŒfs_key
 
	mloÿtiÚ
;

63 
¥šlock_t
 
	mlock
;

66 
ex‹Á_m­_Œ“
 
	mex‹Á_Œ“
;

69 
ex‹Á_io_Œ“
 
	mio_Œ“
;

74 
ex‹Á_io_Œ“
 
	mio_çžu»_Œ“
;

77 
mu‹x
 
	mlog_mu‹x
;

80 
mu‹x
 
	md–®loc_mu‹x
;

83 
bŒfs_Üd”ed_šode_Œ“
 
	mÜd”ed_Œ“
;

89 
li¡_h—d
 
	md–®loc_šodes
;

92 
rb_node
 
	mrb_node
;

94 
	mruÁime_æags
;

97 
©omic_t
 
	msync_wr™”s
;

102 
u64
 
	mg’”©iÚ
;

107 
u64
 
	mÏ¡_Œªs
;

112 
u64
 
	mlogged_Œªs
;

117 
	mÏ¡_sub_Œªs
;

120 
	mÏ¡_log_comm™
;

125 
u64
 
	md–®loc_by‹s
;

132 
u64
 
	mÃw_d–®loc_by‹s
;

138 
u64
 
	mdeäag_by‹s
;

145 
u64
 
	mdisk_i_size
;

151 
u64
 
	mšdex_út
;

154 
u64
 
	mdœ_šdex
;

161 
u64
 
	mÏ¡_uÆšk_Œªs
;

167 
u64
 
	mcsum_by‹s
;

170 
u32
 
	mæags
;

178 
	mout¡ªdšg_ex‹Ás
;

179 
	m»£rved_ex‹Ás
;

184 
	m´Ý_com´ess
;

189 
	mdeäag_com´ess
;

191 
bŒfs_d–ayed_node
 *
	md–ayed_node
;

194 
time¥ec
 
	mi_Ùime
;

197 
li¡_h—d
 
	md–ayed_ut
;

198 
	md–ayed_ut_couÁ
;

208 
rw_£m­hÜe
 
	mdio_£m
;

210 
šode
 
	mvfs_šode
;

213 
bŒfs_fž‘y³_bË
[];

215 
šlše
 
bŒfs_šode
 *
	$BTRFS_I
(cÚ¡ 
šode
 *inode)

217  
	`cÚš”_of
(
šode
, 
bŒfs_šode
, 
vfs_šode
);

218 
	}
}

220 
šlše
 
	$bŒfs_šode_hash
(
u64
 
objeùid
,

221 cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

223 
u64
 
h
 = 
objeùid
 ^ (
roÙ
->objeùid * 
GOLDEN_RATIO_PRIME
);

225 #ià
BITS_PER_LONG
 == 32

226 
h
 = (h >> 32) ^ (h & 0xffffffff);

229  ()
h
;

230 
	}
}

232 
šlše
 
	$bŒfs_š£¹_šode_hash
(
šode
 *inode)

234 
h
 = 
	`bŒfs_šode_hash
(
šode
->
i_šo
, 
	`BTRFS_I
(šode)->
roÙ
);

236 
	`__š£¹_šode_hash
(
šode
, 
h
);

237 
	}
}

239 
šlše
 
u64
 
	$bŒfs_šo
(cÚ¡ 
bŒfs_šode
 *
šode
)

241 
u64
 
šo
 = 
šode
->
loÿtiÚ
.
objeùid
;

247 ià(!
šo
 || 
šode
->
loÿtiÚ
.
ty³
 =ð
BTRFS_ROOT_ITEM_KEY
)

248 
šo
 = 
šode
->
vfs_šode
.
i_šo
;

249  
šo
;

250 
	}
}

252 
šlše
 
	$bŒfs_i_size_wr™e
(
bŒfs_šode
 *
šode
, 
u64
 
size
)

254 
	`i_size_wr™e
(&
šode
->
vfs_šode
, 
size
);

255 
šode
->
disk_i_size
 = 
size
;

256 
	}
}

258 
šlše
 
boÞ
 
	$bŒfs_is_ä“_¥aû_šode
(
bŒfs_šode
 *
šode
)

260 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

262 ià(
roÙ
 =ðroÙ->
fs_šfo
->
Œ“_roÙ
 &&

263 
	`bŒfs_šo
(
šode
è!ð
BTRFS_BTREE_INODE_OBJECTID
)

264  
Œue
;

265 ià(
šode
->
loÿtiÚ
.
objeùid
 =ð
BTRFS_FREE_INO_OBJECTID
)

266  
Œue
;

267  
çl£
;

268 
	}
}

270 
šlše
 
	$bŒfs_šode_š_log
(
bŒfs_šode
 *
šode
, 
u64
 
g’”©iÚ
)

272 
»t
 = 0;

274 
	`¥š_lock
(&
šode
->
lock
);

275 ià(
šode
->
logged_Œªs
 =ð
g’”©iÚ
 &&

276 
šode
->
Ï¡_sub_Œªs
 <ðšode->
Ï¡_log_comm™
 &&

277 
šode
->
Ï¡_sub_Œªs
 <ðšode->
roÙ
->
Ï¡_log_comm™
) {

284 
	`smp_mb
();

285 ià(
	`li¡_em±y
(&
šode
->
ex‹Á_Œ“
.
modif›d_ex‹Ás
))

286 
»t
 = 1;

288 
	`¥š_uÆock
(&
šode
->
lock
);

289  
»t
;

290 
	}
}

292 
	#BTRFS_DIO_ORIG_BIO_SUBMITTED
 0x1

	)

294 
	sbŒfs_dio_´iv©e
 {

295 
šode
 *
	mšode
;

296 
	mæags
;

297 
u64
 
	mlogiÿl_off£t
;

298 
u64
 
	mdisk_by‹Ä
;

299 
u64
 
	mby‹s
;

300 *
	m´iv©e
;

303 
©omic_t
 
	m³ndšg_bios
;

306 
	m”rÜs
;

309 
bio
 *
	mÜig_bio
;

312 
bio
 *
	mdio_bio
;

318 
blk_¡©us_t
 (*
subio_’dio
)(
	mšode
 *, 
	mbŒfs_io_bio
 *,

319 
	mblk_¡©us_t
);

327 
šlše
 
	$bŒfs_šode_block_uÆocked_dio
(
bŒfs_šode
 *
šode
)

329 
	`£t_b™
(
BTRFS_INODE_READDIO_NEED_LOCK
, &
šode
->
ruÁime_æags
);

330 
	`smp_mb
();

331 
	}
}

333 
šlše
 
	$bŒfs_šode_»sume_uÆocked_dio
(
bŒfs_šode
 *
šode
)

335 
	`smp_mb__befÜe_©omic
();

336 
	`þ—r_b™
(
BTRFS_INODE_READDIO_NEED_LOCK
, &
šode
->
ruÁime_æags
);

337 
	}
}

339 
šlše
 
	$bŒfs_´št_d©a_csum_”rÜ
(
bŒfs_šode
 *
šode
,

340 
u64
 
logiÿl_¡¬t
, 
u32
 
csum
, u32 
csum_ex³ùed
, 
mœrÜ_num
)

342 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

345 ià(
roÙ
->
objeùid
 >ð
BTRFS_LAST_FREE_OBJECTID
)

346 
	`bŒfs_w¬n_¾
(
roÙ
->
fs_šfo
,

348 
roÙ
->
objeùid
, 
	`bŒfs_šo
(
šode
),

349 
logiÿl_¡¬t
, 
csum
, 
csum_ex³ùed
, 
mœrÜ_num
);

351 
	`bŒfs_w¬n_¾
(
roÙ
->
fs_šfo
,

353 
roÙ
->
objeùid
, 
	`bŒfs_šo
(
šode
),

354 
logiÿl_¡¬t
, 
csum
, 
csum_ex³ùed
, 
mœrÜ_num
);

355 
	}
}

357 
boÞ
 
bŒfs_·ge_exi¡s_š_¿nge
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
);

	@check-integrity.c

91 
	~<lšux/sched.h
>

92 
	~<lšux/¦ab.h
>

93 
	~<lšux/bufãr_h—d.h
>

94 
	~<lšux/mu‹x.h
>

95 
	~<lšux/g’hd.h
>

96 
	~<lšux/blkdev.h
>

97 
	~<lšux/mm.h
>

98 
	~<lšux/¡ršg.h
>

99 
	~"ù»e.h
"

100 
	~"disk-io.h
"

101 
	~"hash.h
"

102 
	~"Œª§ùiÚ.h
"

103 
	~"ex‹Á_io.h
"

104 
	~"vÞumes.h
"

105 
	~"´št-Œ“.h
"

106 
	~"lockšg.h
"

107 
	~"check-š‹gr™y.h
"

108 
	~"rcu-¡ršg.h
"

109 
	~"com´essiÚ.h
"

111 
	#BTRFSIC_BLOCK_HASHTABLE_SIZE
 0x10000

	)

112 
	#BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 0x10000

	)

113 
	#BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 0x100

	)

114 
	#BTRFSIC_BLOCK_MAGIC_NUMBER
 0x14491051

	)

115 
	#BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 0x11070807

	)

116 
	#BTRFSIC_DEV2STATE_MAGIC_NUMBER
 0x20111530

	)

117 
	#BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 20111300

	)

118 
	#BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
 (200 - 6è

	)

120 
	#BTRFSIC_GENERATION_UNKNOWN
 ((
u64
)-1)

	)

126 
	#BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
 0x00000001

	)

127 
	#BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
 0x00000002

	)

128 
	#BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
 0x00000004

	)

129 
	#BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
 0x00000008

	)

130 
	#BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 0x00000010

	)

131 
	#BTRFSIC_PRINT_MASK_END_IO_BIO_BH
 0x00000020

	)

132 
	#BTRFSIC_PRINT_MASK_VERBOSE
 0x00000040

	)

133 
	#BTRFSIC_PRINT_MASK_VERY_VERBOSE
 0x00000080

	)

134 
	#BTRFSIC_PRINT_MASK_INITIAL_TREE
 0x00000100

	)

135 
	#BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
 0x00000200

	)

136 
	#BTRFSIC_PRINT_MASK_INITIAL_DATABASE
 0x00000400

	)

137 
	#BTRFSIC_PRINT_MASK_NUM_COPIES
 0x00000800

	)

138 
	#BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
 0x00001000

	)

139 
	#BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
 0x00002000

	)

141 
	gbŒfsic_dev_¡©e
;

142 
	gbŒfsic_¡©e
;

144 
	sbŒfsic_block
 {

145 
u32
 
	mmagic_num
;

146 
	mis_m‘ad©a
:1;

147 
	mis_su³rblock
:1;

148 
	mis_iodÚe
:1;

149 
	miodÚe_w_”rÜ
:1;

150 
	mÃv”_wr™‹n
:1;

153 
	mmœrÜ_num
;

155 
bŒfsic_dev_¡©e
 *
	mdev_¡©e
;

156 
u64
 
	mdev_by‹Ä
;

157 
u64
 
	mlogiÿl_by‹Ä
;

158 
u64
 
	mg’”©iÚ
;

159 
bŒfs_disk_key
 
	mdisk_key
;

161 
li¡_h—d
 
	mcÞlisiÚ_»sÞvšg_node
;

162 
li¡_h—d
 
	m®l_blocks_node
;

165 
li¡_h—d
 
	m»f_to_li¡
;

166 
li¡_h—d
 
	m»f_äom_li¡
;

167 
bŒfsic_block
 *
	mÃxt_š_§me_bio
;

168 *
	mÜig_bio_bh_´iv©e
;

170 
bio_’d_io_t
 *
	mbio
;

171 
bh_’d_io_t
 *
	mbh
;

172 } 
	mÜig_bio_bh_’d_io
;

173 
	msubm™_bio_bh_rw
;

174 
u64
 
	mæush_g’
;

188 
	sbŒfsic_block_lšk
 {

189 
u32
 
	mmagic_num
;

190 
u32
 
	m»f_út
;

191 
li¡_h—d
 
	mnode_»f_to
;

192 
li¡_h—d
 
	mnode_»f_äom
;

193 
li¡_h—d
 
	mcÞlisiÚ_»sÞvšg_node
;

194 
bŒfsic_block
 *
	mblock_»f_to
;

195 
bŒfsic_block
 *
	mblock_»f_äom
;

196 
u64
 
	m·»Á_g’”©iÚ
;

199 
	sbŒfsic_dev_¡©e
 {

200 
u32
 
	mmagic_num
;

201 
block_deviû
 *
	mbdev
;

202 
bŒfsic_¡©e
 *
	m¡©e
;

203 
li¡_h—d
 
	mcÞlisiÚ_»sÞvšg_node
;

204 
bŒfsic_block
 
	mdummy_block_fÜ_bio_bh_æush
;

205 
u64
 
	mÏ¡_æush_g’
;

206 
	mÇme
[
BDEVNAME_SIZE
];

209 
	sbŒfsic_block_hashbË
 {

210 
li¡_h—d
 
	mbË
[
BTRFSIC_BLOCK_HASHTABLE_SIZE
];

213 
	sbŒfsic_block_lšk_hashbË
 {

214 
li¡_h—d
 
	mbË
[
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
];

217 
	sbŒfsic_dev_¡©e_hashbË
 {

218 
li¡_h—d
 
	mbË
[
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
];

221 
	sbŒfsic_block_d©a_ùx
 {

222 
u64
 
	m¡¬t
;

223 
u64
 
	mdev_by‹Ä
;

224 
u32
 
	mËn
;

225 
bŒfsic_dev_¡©e
 *
	mdev
;

226 **
	md©av
;

227 
·ge
 **
	m·gev
;

228 *
	mmem_to_ä“
;

233 
	sbŒfsic_¡ack_äame
 {

234 
u32
 
	mmagic
;

235 
u32
 
	mÄ
;

236 
	m”rÜ
;

237 
	mi
;

238 
	mlim™_Ã¡šg
;

239 
	mnum_cÝ›s
;

240 
	mmœrÜ_num
;

241 
bŒfsic_block
 *
	mblock
;

242 
bŒfsic_block_d©a_ùx
 *
	mblock_ùx
;

243 
bŒfsic_block
 *
	mÃxt_block
;

244 
bŒfsic_block_d©a_ùx
 
	mÃxt_block_ùx
;

245 
bŒfs_h—d”
 *
	mhdr
;

246 
bŒfsic_¡ack_äame
 *
	m´ev
;

250 
	sbŒfsic_¡©e
 {

251 
u32
 
	m´št_mask
;

252 
	mšþude_ex‹Á_d©a
;

253 
	mcsum_size
;

254 
li¡_h—d
 
	m®l_blocks_li¡
;

255 
bŒfsic_block_hashbË
 
	mblock_hashbË
;

256 
bŒfsic_block_lšk_hashbË
 
	mblock_lšk_hashbË
;

257 
bŒfs_fs_šfo
 *
	mfs_šfo
;

258 
u64
 
	mmax_su³rblock_g’”©iÚ
;

259 
bŒfsic_block
 *
	mÏ‹¡_su³rblock
;

260 
u32
 
	mm‘ablock_size
;

261 
u32
 
	md©ablock_size
;

264 
bŒfsic_block_š™
(
bŒfsic_block
 *
b
);

265 
bŒfsic_block
 *
bŒfsic_block_®loc
();

266 
bŒfsic_block_ä“
(
bŒfsic_block
 *
b
);

267 
bŒfsic_block_lšk_š™
(
bŒfsic_block_lšk
 *
n
);

268 
bŒfsic_block_lšk
 *
bŒfsic_block_lšk_®loc
();

269 
bŒfsic_block_lšk_ä“
(
bŒfsic_block_lšk
 *
n
);

270 
bŒfsic_dev_¡©e_š™
(
bŒfsic_dev_¡©e
 *
ds
);

271 
bŒfsic_dev_¡©e
 *
bŒfsic_dev_¡©e_®loc
();

272 
bŒfsic_dev_¡©e_ä“
(
bŒfsic_dev_¡©e
 *
ds
);

273 
bŒfsic_block_hashbË_š™
(
bŒfsic_block_hashbË
 *
h
);

274 
bŒfsic_block_hashbË_add
(
bŒfsic_block
 *
b
,

275 
bŒfsic_block_hashbË
 *
h
);

276 
bŒfsic_block_hashbË_»move
(
bŒfsic_block
 *
b
);

277 
bŒfsic_block
 *
bŒfsic_block_hashbË_lookup
(

278 
block_deviû
 *
bdev
,

279 
u64
 
dev_by‹Ä
,

280 
bŒfsic_block_hashbË
 *
h
);

281 
bŒfsic_block_lšk_hashbË_š™
(

282 
bŒfsic_block_lšk_hashbË
 *
h
);

283 
bŒfsic_block_lšk_hashbË_add
(

284 
bŒfsic_block_lšk
 *
l
,

285 
bŒfsic_block_lšk_hashbË
 *
h
);

286 
bŒfsic_block_lšk_hashbË_»move
(
bŒfsic_block_lšk
 *
l
);

287 
bŒfsic_block_lšk
 *
bŒfsic_block_lšk_hashbË_lookup
(

288 
block_deviû
 *
bdev_»f_to
,

289 
u64
 
dev_by‹Ä_»f_to
,

290 
block_deviû
 *
bdev_»f_äom
,

291 
u64
 
dev_by‹Ä_»f_äom
,

292 
bŒfsic_block_lšk_hashbË
 *
h
);

293 
bŒfsic_dev_¡©e_hashbË_š™
(

294 
bŒfsic_dev_¡©e_hashbË
 *
h
);

295 
bŒfsic_dev_¡©e_hashbË_add
(

296 
bŒfsic_dev_¡©e
 *
ds
,

297 
bŒfsic_dev_¡©e_hashbË
 *
h
);

298 
bŒfsic_dev_¡©e_hashbË_»move
(
bŒfsic_dev_¡©e
 *
ds
);

299 
bŒfsic_dev_¡©e
 *
bŒfsic_dev_¡©e_hashbË_lookup
(
dev_t
 
dev
,

300 
bŒfsic_dev_¡©e_hashbË
 *
h
);

301 
bŒfsic_¡ack_äame
 *
bŒfsic_¡ack_äame_®loc
();

302 
bŒfsic_¡ack_äame_ä“
(
bŒfsic_¡ack_äame
 *
sf
);

303 
bŒfsic_´oûss_su³rblock
(
bŒfsic_¡©e
 *
¡©e
,

304 
bŒfs_fs_deviûs
 *
fs_deviûs
);

305 
bŒfsic_´oûss_m‘ablock
(
bŒfsic_¡©e
 *
¡©e
,

306 
bŒfsic_block
 *
block
,

307 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

308 
lim™_Ã¡šg
, 
fÜû_iodÚe_æag
);

309 
bŒfsic_»ad_äom_block_d©a
(

310 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

311 *
d¡
, 
u32
 
off£t
, 
size_t
 
Ën
);

312 
bŒfsic_ü—‹_lšk_to_Ãxt_block
(

313 
bŒfsic_¡©e
 *
¡©e
,

314 
bŒfsic_block
 *
block
,

315 
bŒfsic_block_d©a_ùx


316 *
block_ùx
, 
u64
 
Ãxt_by‹Ä
,

317 
lim™_Ã¡šg
,

318 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

319 
bŒfsic_block
 **
Ãxt_blockp
,

320 
fÜû_iodÚe_æag
,

321 *
num_cÝ›¥
, *
mœrÜ_nump
,

322 
bŒfs_disk_key
 *
disk_key
,

323 
u64
 
·»Á_g’”©iÚ
);

324 
bŒfsic_hªdË_ex‹Á_d©a
(
bŒfsic_¡©e
 *
¡©e
,

325 
bŒfsic_block
 *
block
,

326 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

327 
u32
 
™em_off£t
, 
fÜû_iodÚe_æag
);

328 
bŒfsic_m­_block
(
bŒfsic_¡©e
 *
¡©e
, 
u64
 
by‹Ä
, 
u32
 
Ën
,

329 
bŒfsic_block_d©a_ùx
 *
block_ùx_out
,

330 
mœrÜ_num
);

331 
bŒfsic_»Ëa£_block_ùx
(
bŒfsic_block_d©a_ùx
 *
block_ùx
);

332 
bŒfsic_»ad_block
(
bŒfsic_¡©e
 *
¡©e
,

333 
bŒfsic_block_d©a_ùx
 *
block_ùx
);

334 
bŒfsic_dump_d©aba£
(
bŒfsic_¡©e
 *
¡©e
);

335 
bŒfsic_‹¡_fÜ_m‘ad©a
(
bŒfsic_¡©e
 *
¡©e
,

336 **
d©av
, 
num_·ges
);

337 
bŒfsic_´oûss_wr™‹n_block
(
bŒfsic_dev_¡©e
 *
dev_¡©e
,

338 
u64
 
dev_by‹Ä
, **
m­³d_d©av
,

339 
num_·ges
,

340 
bio
 *bio, *
bio_is_·tched
,

341 
bufãr_h—d
 *
bh
,

342 
subm™_bio_bh_rw
);

343 
bŒfsic_´oûss_wr™‹n_su³rblock
(

344 
bŒfsic_¡©e
 *
¡©e
,

345 
bŒfsic_block
 *cÚ¡ 
block
,

346 
bŒfs_su³r_block
 *cÚ¡ 
su³r_hdr
);

347 
bŒfsic_bio_’d_io
(
bio
 *
bp
);

348 
bŒfsic_bh_’d_io
(
bufãr_h—d
 *
bh
, 
u±od©e
);

349 
bŒfsic_is_block_»f_by_su³rblock
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

350 cÚ¡ 
bŒfsic_block
 *
block
,

351 
»cursiÚ_Ëv–
);

352 
bŒfsic_check_®l_»f_blocks
(
bŒfsic_¡©e
 *
¡©e
,

353 
bŒfsic_block
 *cÚ¡ 
block
,

354 
»cursiÚ_Ëv–
);

355 
bŒfsic_´št_add_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

356 cÚ¡ 
bŒfsic_block_lšk
 *
l
);

357 
bŒfsic_´št_»m_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

358 cÚ¡ 
bŒfsic_block_lšk
 *
l
);

359 
bŒfsic_g‘_block_ty³
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

360 cÚ¡ 
bŒfsic_block
 *
block
);

361 
bŒfsic_dump_Œ“
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
);

362 
bŒfsic_dump_Œ“_sub
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

363 cÚ¡ 
bŒfsic_block
 *
block
,

364 
šd’t_Ëv–
);

365 
bŒfsic_block_lšk
 *
bŒfsic_block_lšk_lookup_Ü_add
(

366 
bŒfsic_¡©e
 *
¡©e
,

367 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

368 
bŒfsic_block
 *
Ãxt_block
,

369 
bŒfsic_block
 *
äom_block
,

370 
u64
 
·»Á_g’”©iÚ
);

371 
bŒfsic_block
 *
bŒfsic_block_lookup_Ü_add
(

372 
bŒfsic_¡©e
 *
¡©e
,

373 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

374 cÚ¡ *
add™iÚ®_¡ršg
,

375 
is_m‘ad©a
,

376 
is_iodÚe
,

377 
Ãv”_wr™‹n
,

378 
mœrÜ_num
,

379 *
was_ü—‹d
);

380 
bŒfsic_´oûss_su³rblock_dev_mœrÜ
(

381 
bŒfsic_¡©e
 *
¡©e
,

382 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

383 
bŒfs_deviû
 *
deviû
,

384 
su³rblock_mœrÜ_num
,

385 
bŒfsic_dev_¡©e
 **
£Ëùed_dev_¡©e
,

386 
bŒfs_su³r_block
 *
£Ëùed_su³r
);

387 
bŒfsic_dev_¡©e
 *
bŒfsic_dev_¡©e_lookup
(
dev_t
 
dev
);

388 
bŒfsic_cmp_log_ªd_dev_by‹Ä
(
bŒfsic_¡©e
 *
¡©e
,

389 
u64
 
by‹Ä
,

390 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

391 
u64
 
dev_by‹Ä
);

393 
mu‹x
 
	gbŒfsic_mu‹x
;

394 
	gbŒfsic_is_š™Ÿlized
;

395 
bŒfsic_dev_¡©e_hashbË
 
	gbŒfsic_dev_¡©e_hashbË
;

398 
	$bŒfsic_block_š™
(
bŒfsic_block
 *
b
)

400 
b
->
magic_num
 = 
BTRFSIC_BLOCK_MAGIC_NUMBER
;

401 
b
->
dev_¡©e
 = 
NULL
;

402 
b
->
dev_by‹Ä
 = 0;

403 
b
->
logiÿl_by‹Ä
 = 0;

404 
b
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

405 
b
->
disk_key
.
objeùid
 = 0;

406 
b
->
disk_key
.
ty³
 = 0;

407 
b
->
disk_key
.
off£t
 = 0;

408 
b
->
is_m‘ad©a
 = 0;

409 
b
->
is_su³rblock
 = 0;

410 
b
->
is_iodÚe
 = 0;

411 
b
->
iodÚe_w_”rÜ
 = 0;

412 
b
->
Ãv”_wr™‹n
 = 0;

413 
b
->
mœrÜ_num
 = 0;

414 
b
->
Ãxt_š_§me_bio
 = 
NULL
;

415 
b
->
Üig_bio_bh_´iv©e
 = 
NULL
;

416 
b
->
Üig_bio_bh_’d_io
.
bio
 = 
NULL
;

417 
	`INIT_LIST_HEAD
(&
b
->
cÞlisiÚ_»sÞvšg_node
);

418 
	`INIT_LIST_HEAD
(&
b
->
®l_blocks_node
);

419 
	`INIT_LIST_HEAD
(&
b
->
»f_to_li¡
);

420 
	`INIT_LIST_HEAD
(&
b
->
»f_äom_li¡
);

421 
b
->
subm™_bio_bh_rw
 = 0;

422 
b
->
æush_g’
 = 0;

423 
	}
}

425 
bŒfsic_block
 *
	$bŒfsic_block_®loc
()

427 
bŒfsic_block
 *
b
;

429 
b
 = 
	`kz®loc
((*b), 
GFP_NOFS
);

430 ià(
NULL
 !ð
b
)

431 
	`bŒfsic_block_š™
(
b
);

433  
b
;

434 
	}
}

436 
	$bŒfsic_block_ä“
(
bŒfsic_block
 *
b
)

438 
	`BUG_ON
(!(
NULL
 =ð
b
 || 
BTRFSIC_BLOCK_MAGIC_NUMBER
 =ðb->
magic_num
));

439 
	`kä“
(
b
);

440 
	}
}

442 
	$bŒfsic_block_lšk_š™
(
bŒfsic_block_lšk
 *
l
)

444 
l
->
magic_num
 = 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
;

445 
l
->
»f_út
 = 1;

446 
	`INIT_LIST_HEAD
(&
l
->
node_»f_to
);

447 
	`INIT_LIST_HEAD
(&
l
->
node_»f_äom
);

448 
	`INIT_LIST_HEAD
(&
l
->
cÞlisiÚ_»sÞvšg_node
);

449 
l
->
block_»f_to
 = 
NULL
;

450 
l
->
block_»f_äom
 = 
NULL
;

451 
	}
}

453 
bŒfsic_block_lšk
 *
	$bŒfsic_block_lšk_®loc
()

455 
bŒfsic_block_lšk
 *
l
;

457 
l
 = 
	`kz®loc
((*l), 
GFP_NOFS
);

458 ià(
NULL
 !ð
l
)

459 
	`bŒfsic_block_lšk_š™
(
l
);

461  
l
;

462 
	}
}

464 
	$bŒfsic_block_lšk_ä“
(
bŒfsic_block_lšk
 *
l
)

466 
	`BUG_ON
(!(
NULL
 =ð
l
 || 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 =ðl->
magic_num
));

467 
	`kä“
(
l
);

468 
	}
}

470 
	$bŒfsic_dev_¡©e_š™
(
bŒfsic_dev_¡©e
 *
ds
)

472 
ds
->
magic_num
 = 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
;

473 
ds
->
bdev
 = 
NULL
;

474 
ds
->
¡©e
 = 
NULL
;

475 
ds
->
Çme
[0] = '\0';

476 
	`INIT_LIST_HEAD
(&
ds
->
cÞlisiÚ_»sÞvšg_node
);

477 
ds
->
Ï¡_æush_g’
 = 0;

478 
	`bŒfsic_block_š™
(&
ds
->
dummy_block_fÜ_bio_bh_æush
);

479 
ds
->
dummy_block_fÜ_bio_bh_æush
.
is_iodÚe
 = 1;

480 
ds
->
dummy_block_fÜ_bio_bh_æush
.
dev_¡©e
 = ds;

481 
	}
}

483 
bŒfsic_dev_¡©e
 *
	$bŒfsic_dev_¡©e_®loc
()

485 
bŒfsic_dev_¡©e
 *
ds
;

487 
ds
 = 
	`kz®loc
((*ds), 
GFP_NOFS
);

488 ià(
NULL
 !ð
ds
)

489 
	`bŒfsic_dev_¡©e_š™
(
ds
);

491  
ds
;

492 
	}
}

494 
	$bŒfsic_dev_¡©e_ä“
(
bŒfsic_dev_¡©e
 *
ds
)

496 
	`BUG_ON
(!(
NULL
 =ð
ds
 ||

497 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
 =ð
ds
->
magic_num
));

498 
	`kä“
(
ds
);

499 
	}
}

501 
	$bŒfsic_block_hashbË_š™
(
bŒfsic_block_hashbË
 *
h
)

503 
i
;

505 
i
 = 0; i < 
BTRFSIC_BLOCK_HASHTABLE_SIZE
; i++)

506 
	`INIT_LIST_HEAD
(
h
->
bË
 + 
i
);

507 
	}
}

509 
	$bŒfsic_block_hashbË_add
(
bŒfsic_block
 *
b
,

510 
bŒfsic_block_hashbË
 *
h
)

512 cÚ¡ 
hashv®
 =

513 ((()(
b
->
dev_by‹Ä
 >> 16)) ^

514 (()((
ušŒ_t
)
b
->
dev_¡©e
->
bdev
))) &

515 (
BTRFSIC_BLOCK_HASHTABLE_SIZE
 - 1);

517 
	`li¡_add
(&
b
->
cÞlisiÚ_»sÞvšg_node
, 
h
->
bË
 + 
hashv®
);

518 
	}
}

520 
	$bŒfsic_block_hashbË_»move
(
bŒfsic_block
 *
b
)

522 
	`li¡_d–
(&
b
->
cÞlisiÚ_»sÞvšg_node
);

523 
	}
}

525 
bŒfsic_block
 *
	$bŒfsic_block_hashbË_lookup
(

526 
block_deviû
 *
bdev
,

527 
u64
 
dev_by‹Ä
,

528 
bŒfsic_block_hashbË
 *
h
)

530 cÚ¡ 
hashv®
 =

531 ((()(
dev_by‹Ä
 >> 16)) ^

532 (()((
ušŒ_t
)
bdev
))) &

533 (
BTRFSIC_BLOCK_HASHTABLE_SIZE
 - 1);

534 
bŒfsic_block
 *
b
;

536 
	`li¡_fÜ_—ch_’Œy
(
b
, 
h
->
bË
 + 
hashv®
, 
cÞlisiÚ_»sÞvšg_node
) {

537 ià(
b
->
dev_¡©e
->
bdev
 =ðbdev && b->
dev_by‹Ä
 == dev_bytenr)

538  
b
;

541  
NULL
;

542 
	}
}

544 
	$bŒfsic_block_lšk_hashbË_š™
(

545 
bŒfsic_block_lšk_hashbË
 *
h
)

547 
i
;

549 
i
 = 0; i < 
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
; i++)

550 
	`INIT_LIST_HEAD
(
h
->
bË
 + 
i
);

551 
	}
}

553 
	$bŒfsic_block_lšk_hashbË_add
(

554 
bŒfsic_block_lšk
 *
l
,

555 
bŒfsic_block_lšk_hashbË
 *
h
)

557 cÚ¡ 
hashv®
 =

558 ((()(
l
->
block_»f_to
->
dev_by‹Ä
 >> 16)) ^

559 (()(
l
->
block_»f_äom
->
dev_by‹Ä
 >> 16)) ^

560 (()((
ušŒ_t
)
l
->
block_»f_to
->
dev_¡©e
->
bdev
)) ^

561 (()((
ušŒ_t
)
l
->
block_»f_äom
->
dev_¡©e
->
bdev
)))

562 & (
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 - 1);

564 
	`BUG_ON
(
NULL
 =ð
l
->
block_»f_to
);

565 
	`BUG_ON
(
NULL
 =ð
l
->
block_»f_äom
);

566 
	`li¡_add
(&
l
->
cÞlisiÚ_»sÞvšg_node
, 
h
->
bË
 + 
hashv®
);

567 
	}
}

569 
	$bŒfsic_block_lšk_hashbË_»move
(
bŒfsic_block_lšk
 *
l
)

571 
	`li¡_d–
(&
l
->
cÞlisiÚ_»sÞvšg_node
);

572 
	}
}

574 
bŒfsic_block_lšk
 *
	$bŒfsic_block_lšk_hashbË_lookup
(

575 
block_deviû
 *
bdev_»f_to
,

576 
u64
 
dev_by‹Ä_»f_to
,

577 
block_deviû
 *
bdev_»f_äom
,

578 
u64
 
dev_by‹Ä_»f_äom
,

579 
bŒfsic_block_lšk_hashbË
 *
h
)

581 cÚ¡ 
hashv®
 =

582 ((()(
dev_by‹Ä_»f_to
 >> 16)) ^

583 (()(
dev_by‹Ä_»f_äom
 >> 16)) ^

584 (()((
ušŒ_t
)
bdev_»f_to
)) ^

585 (()((
ušŒ_t
)
bdev_»f_äom
))) &

586 (
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 - 1);

587 
bŒfsic_block_lšk
 *
l
;

589 
	`li¡_fÜ_—ch_’Œy
(
l
, 
h
->
bË
 + 
hashv®
, 
cÞlisiÚ_»sÞvšg_node
) {

590 
	`BUG_ON
(
NULL
 =ð
l
->
block_»f_to
);

591 
	`BUG_ON
(
NULL
 =ð
l
->
block_»f_äom
);

592 ià(
l
->
block_»f_to
->
dev_¡©e
->
bdev
 =ð
bdev_»f_to
 &&

593 
l
->
block_»f_to
->
dev_by‹Ä
 =ð
dev_by‹Ä_»f_to
 &&

594 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
 =ð
bdev_»f_äom
 &&

595 
l
->
block_»f_äom
->
dev_by‹Ä
 =ð
dev_by‹Ä_»f_äom
)

596  
l
;

599  
NULL
;

600 
	}
}

602 
	$bŒfsic_dev_¡©e_hashbË_š™
(

603 
bŒfsic_dev_¡©e_hashbË
 *
h
)

605 
i
;

607 
i
 = 0; i < 
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
; i++)

608 
	`INIT_LIST_HEAD
(
h
->
bË
 + 
i
);

609 
	}
}

611 
	$bŒfsic_dev_¡©e_hashbË_add
(

612 
bŒfsic_dev_¡©e
 *
ds
,

613 
bŒfsic_dev_¡©e_hashbË
 *
h
)

615 cÚ¡ 
hashv®
 =

616 ((()((
ušŒ_t
)
ds
->
bdev
)) &

617 (
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 - 1));

619 
	`li¡_add
(&
ds
->
cÞlisiÚ_»sÞvšg_node
, 
h
->
bË
 + 
hashv®
);

620 
	}
}

622 
	$bŒfsic_dev_¡©e_hashbË_»move
(
bŒfsic_dev_¡©e
 *
ds
)

624 
	`li¡_d–
(&
ds
->
cÞlisiÚ_»sÞvšg_node
);

625 
	}
}

627 
bŒfsic_dev_¡©e
 *
	$bŒfsic_dev_¡©e_hashbË_lookup
(
dev_t
 
dev
,

628 
bŒfsic_dev_¡©e_hashbË
 *
h
)

630 cÚ¡ 
hashv®
 =

631 
dev
 & (
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 - 1);

632 
bŒfsic_dev_¡©e
 *
ds
;

634 
	`li¡_fÜ_—ch_’Œy
(
ds
, 
h
->
bË
 + 
hashv®
, 
cÞlisiÚ_»sÞvšg_node
) {

635 ià(
ds
->
bdev
->
bd_dev
 =ð
dev
)

636  
ds
;

639  
NULL
;

640 
	}
}

642 
	$bŒfsic_´oûss_su³rblock
(
bŒfsic_¡©e
 *
¡©e
,

643 
bŒfs_fs_deviûs
 *
fs_deviûs
)

645 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

646 
bŒfs_su³r_block
 *
£Ëùed_su³r
;

647 
li¡_h—d
 *
dev_h—d
 = &
fs_deviûs
->
deviûs
;

648 
bŒfs_deviû
 *
deviû
;

649 
bŒfsic_dev_¡©e
 *
£Ëùed_dev_¡©e
 = 
NULL
;

650 
»t
 = 0;

651 
·ss
;

653 
	`BUG_ON
(
NULL
 =ð
¡©e
);

654 
£Ëùed_su³r
 = 
	`kz®loc
((*£Ëùed_su³r), 
GFP_NOFS
);

655 ià(
NULL
 =ð
£Ëùed_su³r
) {

656 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

657  -
ENOMEM
;

660 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
dev_h—d
, 
dev_li¡
) {

661 
i
;

662 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

664 ià(!
deviû
->
bdev
 || !deviû->
Çme
)

667 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
deviû
->
bdev
->
bd_dev
);

668 
	`BUG_ON
(
NULL
 =ð
dev_¡©e
);

669 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

670 
»t
 = 
	`bŒfsic_´oûss_su³rblock_dev_mœrÜ
(

671 
¡©e
, 
dev_¡©e
, 
deviû
, 
i
,

672 &
£Ëùed_dev_¡©e
, 
£Ëùed_su³r
);

673 ià(0 !ð
»t
 && 0 =ð
i
) {

674 
	`kä“
(
£Ëùed_su³r
);

675  
»t
;

680 ià(
NULL
 =ð
¡©e
->
Ï‹¡_su³rblock
) {

681 
	`´_šfo
("btrfsic:‚o superblock found!\n");

682 
	`kä“
(
£Ëùed_su³r
);

686 
¡©e
->
csum_size
 = 
	`bŒfs_su³r_csum_size
(
£Ëùed_su³r
);

688 
·ss
 = 0;…ass < 3;…ass++) {

689 
num_cÝ›s
;

690 
mœrÜ_num
;

691 
u64
 
Ãxt_by‹Ä
;

693 
·ss
) {

695 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
£Ëùed_su³r
);

696 ià(
¡©e
->
´št_mask
 &

697 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

698 
	`´_šfo
("roÙ@%Îu\n", 
Ãxt_by‹Ä
);

701 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_chunk_roÙ
(
£Ëùed_su³r
);

702 ià(
¡©e
->
´št_mask
 &

703 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

704 
	`´_šfo
("chunk@%Îu\n", 
Ãxt_by‹Ä
);

707 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
£Ëùed_su³r
);

708 ià(0 =ð
Ãxt_by‹Ä
)

710 ià(
¡©e
->
´št_mask
 &

711 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

712 
	`´_šfo
("log@%Îu\n", 
Ãxt_by‹Ä
);

716 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

717 
¡©e
->
m‘ablock_size
);

718 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

719 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

720 
Ãxt_by‹Ä
, 
num_cÝ›s
);

722 
mœrÜ_num
 = 1; mœrÜ_num <ð
num_cÝ›s
; mirror_num++) {

723 
bŒfsic_block
 *
Ãxt_block
;

724 
bŒfsic_block_d©a_ùx
 
tmp_Ãxt_block_ùx
;

725 
bŒfsic_block_lšk
 *
l
;

727 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

728 
¡©e
->
m‘ablock_size
,

729 &
tmp_Ãxt_block_ùx
,

730 
mœrÜ_num
);

731 ià(
»t
) {

732 
	`´_šfo
("btrfsic: btrfsic_map_block(root @%llu, mirror %d) failed!\n",

733 
Ãxt_by‹Ä
, 
mœrÜ_num
);

734 
	`kä“
(
£Ëùed_su³r
);

738 
Ãxt_block
 = 
	`bŒfsic_block_hashbË_lookup
(

739 
tmp_Ãxt_block_ùx
.
dev
->
bdev
,

740 
tmp_Ãxt_block_ùx
.
dev_by‹Ä
,

741 &
¡©e
->
block_hashbË
);

742 
	`BUG_ON
(
NULL
 =ð
Ãxt_block
);

744 
l
 = 
	`bŒfsic_block_lšk_hashbË_lookup
(

745 
tmp_Ãxt_block_ùx
.
dev
->
bdev
,

746 
tmp_Ãxt_block_ùx
.
dev_by‹Ä
,

747 
¡©e
->
Ï‹¡_su³rblock
->
dev_¡©e
->

748 
bdev
,

749 
¡©e
->
Ï‹¡_su³rblock
->
dev_by‹Ä
,

750 &
¡©e
->
block_lšk_hashbË
);

751 
	`BUG_ON
(
NULL
 =ð
l
);

753 
»t
 = 
	`bŒfsic_»ad_block
(
¡©e
, &
tmp_Ãxt_block_ùx
);

754 ià(
»t
 < ()
PAGE_SIZE
) {

755 
	`´_šfo
("btrfsic:„ead @logical %llu failed!\n",

756 
tmp_Ãxt_block_ùx
.
¡¬t
);

757 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

758 
	`kä“
(
£Ëùed_su³r
);

762 
»t
 = 
	`bŒfsic_´oûss_m‘ablock
(
¡©e
,

763 
Ãxt_block
,

764 &
tmp_Ãxt_block_ùx
,

765 
BTRFS_MAX_LEVEL
 + 3, 1);

766 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

770 
	`kä“
(
£Ëùed_su³r
);

771  
»t
;

772 
	}
}

774 
	$bŒfsic_´oûss_su³rblock_dev_mœrÜ
(

775 
bŒfsic_¡©e
 *
¡©e
,

776 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

777 
bŒfs_deviû
 *
deviû
,

778 
su³rblock_mœrÜ_num
,

779 
bŒfsic_dev_¡©e
 **
£Ëùed_dev_¡©e
,

780 
bŒfs_su³r_block
 *
£Ëùed_su³r
)

782 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

783 
bŒfs_su³r_block
 *
su³r_tmp
;

784 
u64
 
dev_by‹Ä
;

785 
bufãr_h—d
 *
bh
;

786 
bŒfsic_block
 *
su³rblock_tmp
;

787 
·ss
;

788 
block_deviû
 *cÚ¡ 
su³rblock_bdev
 = 
deviû
->
bdev
;

791 
dev_by‹Ä
 = 
	`bŒfs_sb_off£t
(
su³rblock_mœrÜ_num
);

792 ià(
dev_by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 > 
deviû
->
comm™_tÙ®_by‹s
)

794 
bh
 = 
	`__b»ad
(
su³rblock_bdev
, 
dev_by‹Ä
 / 
BTRFS_BDEV_BLOCKSIZE
,

795 
BTRFS_SUPER_INFO_SIZE
);

796 ià(
NULL
 =ð
bh
)

798 
su³r_tmp
 = (
bŒfs_su³r_block
 *)

799 (
bh
->
b_d©a
 + (
dev_by‹Ä
 & (
BTRFS_BDEV_BLOCKSIZE
 - 1)));

801 ià(
	`bŒfs_su³r_by‹Ä
(
su³r_tmp
è!ð
dev_by‹Ä
 ||

802 
	`bŒfs_su³r_magic
(
su³r_tmp
è!ð
BTRFS_MAGIC
 ||

803 
	`memcmp
(
deviû
->
uuid
, 
su³r_tmp
->
dev_™em
.uuid, 
BTRFS_UUID_SIZE
) ||

804 
	`bŒfs_su³r_nodesize
(
su³r_tmp
è!ð
¡©e
->
m‘ablock_size
 ||

805 
	`bŒfs_su³r_£ùÜsize
(
su³r_tmp
è!ð
¡©e
->
d©ablock_size
) {

806 
	`b»l£
(
bh
);

810 
su³rblock_tmp
 =

811 
	`bŒfsic_block_hashbË_lookup
(
su³rblock_bdev
,

812 
dev_by‹Ä
,

813 &
¡©e
->
block_hashbË
);

814 ià(
NULL
 =ð
su³rblock_tmp
) {

815 
su³rblock_tmp
 = 
	`bŒfsic_block_®loc
();

816 ià(
NULL
 =ð
su³rblock_tmp
) {

817 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

818 
	`b»l£
(
bh
);

822 
su³rblock_tmp
->
dev_by‹Ä
 = dev_bytenr;

823 
su³rblock_tmp
->
dev_¡©e
 = dev_state;

824 
su³rblock_tmp
->
logiÿl_by‹Ä
 = 
dev_by‹Ä
;

825 
su³rblock_tmp
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r_tmp
);

826 
su³rblock_tmp
->
is_m‘ad©a
 = 1;

827 
su³rblock_tmp
->
is_su³rblock
 = 1;

828 
su³rblock_tmp
->
is_iodÚe
 = 1;

829 
su³rblock_tmp
->
Ãv”_wr™‹n
 = 0;

830 
su³rblock_tmp
->
mœrÜ_num
 = 1 + 
su³rblock_mœrÜ_num
;

831 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

832 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

834 
su³rblock_bdev
,

835 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
dev_by‹Ä
,

836 
dev_¡©e
->
Çme
, 
dev_by‹Ä
,

837 
su³rblock_mœrÜ_num
);

838 
	`li¡_add
(&
su³rblock_tmp
->
®l_blocks_node
,

839 &
¡©e
->
®l_blocks_li¡
);

840 
	`bŒfsic_block_hashbË_add
(
su³rblock_tmp
,

841 &
¡©e
->
block_hashbË
);

845 ià(
	`bŒfs_su³r_g’”©iÚ
(
su³r_tmp
) >

846 
¡©e
->
max_su³rblock_g’”©iÚ
 ||

847 0 =ð
¡©e
->
max_su³rblock_g’”©iÚ
) {

848 
	`memýy
(
£Ëùed_su³r
, 
su³r_tmp
, (*selected_super));

849 *
£Ëùed_dev_¡©e
 = 
dev_¡©e
;

850 
¡©e
->
max_su³rblock_g’”©iÚ
 =

851 
	`bŒfs_su³r_g’”©iÚ
(
su³r_tmp
);

852 
¡©e
->
Ï‹¡_su³rblock
 = 
su³rblock_tmp
;

855 
·ss
 = 0;…ass < 3;…ass++) {

856 
u64
 
Ãxt_by‹Ä
;

857 
num_cÝ›s
;

858 
mœrÜ_num
;

859 cÚ¡ *
add™iÚ®_¡ršg
 = 
NULL
;

860 
bŒfs_disk_key
 
tmp_disk_key
;

862 
tmp_disk_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

863 
tmp_disk_key
.
off£t
 = 0;

864 
·ss
) {

866 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

867 
BTRFS_ROOT_TREE_OBJECTID
);

868 
add™iÚ®_¡ršg
 = "initial„oot ";

869 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
su³r_tmp
);

872 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

873 
BTRFS_CHUNK_TREE_OBJECTID
);

874 
add™iÚ®_¡ršg
 = "initial chunk ";

875 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_chunk_roÙ
(
su³r_tmp
);

878 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

879 
BTRFS_TREE_LOG_OBJECTID
);

880 
add™iÚ®_¡ršg
 = "initial†og ";

881 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
su³r_tmp
);

882 ià(0 =ð
Ãxt_by‹Ä
)

887 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

888 
¡©e
->
m‘ablock_size
);

889 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

890 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

891 
Ãxt_by‹Ä
, 
num_cÝ›s
);

892 
mœrÜ_num
 = 1; mœrÜ_num <ð
num_cÝ›s
; mirror_num++) {

893 
bŒfsic_block
 *
Ãxt_block
;

894 
bŒfsic_block_d©a_ùx
 
tmp_Ãxt_block_ùx
;

895 
bŒfsic_block_lšk
 *
l
;

897 ià(
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

898 
¡©e
->
m‘ablock_size
,

899 &
tmp_Ãxt_block_ùx
,

900 
mœrÜ_num
)) {

901 
	`´_šfo
("btrfsic: btrfsic_map_block(bytenr @%llu, mirror %d) failed!\n",

902 
Ãxt_by‹Ä
, 
mœrÜ_num
);

903 
	`b»l£
(
bh
);

907 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(

908 
¡©e
, &
tmp_Ãxt_block_ùx
,

909 
add™iÚ®_¡ršg
, 1, 1, 0,

910 
mœrÜ_num
, 
NULL
);

911 ià(
NULL
 =ð
Ãxt_block
) {

912 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

913 
	`b»l£
(
bh
);

917 
Ãxt_block
->
disk_key
 = 
tmp_disk_key
;

918 
Ãxt_block
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

919 
l
 = 
	`bŒfsic_block_lšk_lookup_Ü_add
(

920 
¡©e
, &
tmp_Ãxt_block_ùx
,

921 
Ãxt_block
, 
su³rblock_tmp
,

922 
BTRFSIC_GENERATION_UNKNOWN
);

923 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

924 ià(
NULL
 =ð
l
) {

925 
	`b»l£
(
bh
);

930 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
)

931 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
su³rblock_tmp
, 0);

933 
	`b»l£
(
bh
);

935 
	}
}

937 
bŒfsic_¡ack_äame
 *
	$bŒfsic_¡ack_äame_®loc
()

939 
bŒfsic_¡ack_äame
 *
sf
;

941 
sf
 = 
	`kz®loc
((*sf), 
GFP_NOFS
);

942 ià(
NULL
 =ð
sf
)

943 
	`´_šfo
("btrfsic:‡lloc memory failed!\n");

945 
sf
->
magic
 = 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
;

946  
sf
;

947 
	}
}

949 
	$bŒfsic_¡ack_äame_ä“
(
bŒfsic_¡ack_äame
 *
sf
)

951 
	`BUG_ON
(!(
NULL
 =ð
sf
 ||

952 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 =ð
sf
->
magic
));

953 
	`kä“
(
sf
);

954 
	}
}

956 
	$bŒfsic_´oûss_m‘ablock
(

957 
bŒfsic_¡©e
 *
¡©e
,

958 
bŒfsic_block
 *cÚ¡ 
fœ¡_block
,

959 
bŒfsic_block_d©a_ùx
 *cÚ¡ 
fœ¡_block_ùx
,

960 
fœ¡_lim™_Ã¡šg
, 
fÜû_iodÚe_æag
)

962 
bŒfsic_¡ack_äame
 
š™Ÿl_¡ack_äame
 = { 0 };

963 
bŒfsic_¡ack_äame
 *
sf
;

964 
bŒfsic_¡ack_äame
 *
Ãxt_¡ack
;

965 
bŒfs_h—d”
 *cÚ¡ 
fœ¡_hdr
 =

966 (
bŒfs_h—d”
 *)
fœ¡_block_ùx
->
d©av
[0];

968 
	`BUG_ON
(!
fœ¡_hdr
);

969 
sf
 = &
š™Ÿl_¡ack_äame
;

970 
sf
->
”rÜ
 = 0;

971 
sf
->
i
 = -1;

972 
sf
->
lim™_Ã¡šg
 = 
fœ¡_lim™_Ã¡šg
;

973 
sf
->
block
 = 
fœ¡_block
;

974 
sf
->
block_ùx
 = 
fœ¡_block_ùx
;

975 
sf
->
Ãxt_block
 = 
NULL
;

976 
sf
->
hdr
 = 
fœ¡_hdr
;

977 
sf
->
´ev
 = 
NULL
;

979 
cÚtšue_w™h_Ãw_¡ack_äame
:

980 
sf
->
block
->
g’”©iÚ
 = 
	`Ë64_to_ýu
(sf->
hdr
->generation);

981 ià(0 =ð
sf
->
hdr
->
Ëv–
) {

982 
bŒfs_Ëaf
 *cÚ¡ 
Ëafhdr
 =

983 (
bŒfs_Ëaf
 *)
sf
->
hdr
;

985 ià(-1 =ð
sf
->
i
) {

986 
sf
->
Ä
 = 
	`bŒfs_¡ack_h—d”_Ä™ems
(&
Ëafhdr
->
h—d”
);

988 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

989 
	`´_šfo
("leaf %llu items %d generation %llu owner %llu\n",

990 
sf
->
block_ùx
->
¡¬t
, sf->
Ä
,

991 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

992 &
Ëafhdr
->
h—d”
),

993 
	`bŒfs_¡ack_h—d”_owÃr
(

994 &
Ëafhdr
->
h—d”
));

997 
cÚtšue_w™h_cu¼’t_Ëaf_¡ack_äame
:

998 ià(0 =ð
sf
->
num_cÝ›s
 || sf->
mœrÜ_num
 > sf->num_copies) {

999 
sf
->
i
++;

1000 
sf
->
num_cÝ›s
 = 0;

1003 ià(
sf
->
i
 < sf->
Ä
) {

1004 
bŒfs_™em
 
disk_™em
;

1005 
u32
 
disk_™em_off£t
 =

1006 (
ušŒ_t
)(
Ëafhdr
->
™ems
 + 
sf
->
i
) -

1007 (
ušŒ_t
)
Ëafhdr
;

1008 
bŒfs_disk_key
 *
disk_key
;

1009 
u8
 
ty³
;

1010 
u32
 
™em_off£t
;

1011 
u32
 
™em_size
;

1013 ià(
disk_™em_off£t
 + (
bŒfs_™em
) >

1014 
sf
->
block_ùx
->
Ën
) {

1015 
Ëaf_™em_out_of_bounû_”rÜ
:

1016 
	`´_šfo
("btrfsic:†eaf item out of bounce‡t†ogical %llu, dev %s\n",

1017 
sf
->
block_ùx
->
¡¬t
,

1018 
sf
->
block_ùx
->
dev
->
Çme
);

1019 
Úe_¡ack_äame_backw¬ds
;

1021 
	`bŒfsic_»ad_äom_block_d©a
(
sf
->
block_ùx
,

1022 &
disk_™em
,

1023 
disk_™em_off£t
,

1024 (
bŒfs_™em
));

1025 
™em_off£t
 = 
	`bŒfs_¡ack_™em_off£t
(&
disk_™em
);

1026 
™em_size
 = 
	`bŒfs_¡ack_™em_size
(&
disk_™em
);

1027 
disk_key
 = &
disk_™em
.
key
;

1028 
ty³
 = 
	`bŒfs_disk_key_ty³
(
disk_key
);

1030 ià(
BTRFS_ROOT_ITEM_KEY
 =ð
ty³
) {

1031 
bŒfs_roÙ_™em
 
roÙ_™em
;

1032 
u32
 
roÙ_™em_off£t
;

1033 
u64
 
Ãxt_by‹Ä
;

1035 
roÙ_™em_off£t
 = 
™em_off£t
 +

1036 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
);

1037 ià(
roÙ_™em_off£t
 + 
™em_size
 >

1038 
sf
->
block_ùx
->
Ën
)

1039 
Ëaf_™em_out_of_bounû_”rÜ
;

1040 
	`bŒfsic_»ad_äom_block_d©a
(

1041 
sf
->
block_ùx
, &
roÙ_™em
,

1042 
roÙ_™em_off£t
,

1043 
™em_size
);

1044 
Ãxt_by‹Ä
 = 
	`bŒfs_roÙ_by‹Ä
(&
roÙ_™em
);

1046 
sf
->
”rÜ
 =

1047 
	`bŒfsic_ü—‹_lšk_to_Ãxt_block
(

1048 
¡©e
,

1049 
sf
->
block
,

1050 
sf
->
block_ùx
,

1051 
Ãxt_by‹Ä
,

1052 
sf
->
lim™_Ã¡šg
,

1053 &
sf
->
Ãxt_block_ùx
,

1054 &
sf
->
Ãxt_block
,

1055 
fÜû_iodÚe_æag
,

1056 &
sf
->
num_cÝ›s
,

1057 &
sf
->
mœrÜ_num
,

1058 
disk_key
,

1059 
	`bŒfs_roÙ_g’”©iÚ
(

1060 &
roÙ_™em
));

1061 ià(
sf
->
”rÜ
)

1062 
Úe_¡ack_äame_backw¬ds
;

1064 ià(
NULL
 !ð
sf
->
Ãxt_block
) {

1065 
bŒfs_h—d”
 *cÚ¡ 
Ãxt_hdr
 =

1066 (
bŒfs_h—d”
 *)

1067 
sf
->
Ãxt_block_ùx
.
d©av
[0];

1069 
Ãxt_¡ack
 =

1070 
	`bŒfsic_¡ack_äame_®loc
();

1071 ià(
NULL
 =ð
Ãxt_¡ack
) {

1072 
sf
->
”rÜ
 = -1;

1073 
	`bŒfsic_»Ëa£_block_ùx
(

1074 &
sf
->

1075 
Ãxt_block_ùx
);

1076 
Úe_¡ack_äame_backw¬ds
;

1079 
Ãxt_¡ack
->
i
 = -1;

1080 
Ãxt_¡ack
->
block
 = 
sf
->
Ãxt_block
;

1081 
Ãxt_¡ack
->
block_ùx
 =

1082 &
sf
->
Ãxt_block_ùx
;

1083 
Ãxt_¡ack
->
Ãxt_block
 = 
NULL
;

1084 
Ãxt_¡ack
->
hdr
 = 
Ãxt_hdr
;

1085 
Ãxt_¡ack
->
lim™_Ã¡šg
 =

1086 
sf
->
lim™_Ã¡šg
 - 1;

1087 
Ãxt_¡ack
->
´ev
 = 
sf
;

1088 
sf
 = 
Ãxt_¡ack
;

1089 
cÚtšue_w™h_Ãw_¡ack_äame
;

1091 } ià(
BTRFS_EXTENT_DATA_KEY
 =ð
ty³
 &&

1092 
¡©e
->
šþude_ex‹Á_d©a
) {

1093 
sf
->
”rÜ
 = 
	`bŒfsic_hªdË_ex‹Á_d©a
(

1094 
¡©e
,

1095 
sf
->
block
,

1096 
sf
->
block_ùx
,

1097 
™em_off£t
,

1098 
fÜû_iodÚe_æag
);

1099 ià(
sf
->
”rÜ
)

1100 
Úe_¡ack_äame_backw¬ds
;

1103 
cÚtšue_w™h_cu¼’t_Ëaf_¡ack_äame
;

1106 
bŒfs_node
 *cÚ¡ 
nodehdr
 = (bŒfs_nod*)
sf
->
hdr
;

1108 ià(-1 =ð
sf
->
i
) {

1109 
sf
->
Ä
 = 
	`bŒfs_¡ack_h—d”_Ä™ems
(&
nodehdr
->
h—d”
);

1111 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1112 
	`´_šfo
("node %llu†evel %d items %d generation %llu owner %llu\n",

1113 
sf
->
block_ùx
->
¡¬t
,

1114 
nodehdr
->
h—d”
.
Ëv–
, 
sf
->
Ä
,

1115 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

1116 &
nodehdr
->
h—d”
),

1117 
	`bŒfs_¡ack_h—d”_owÃr
(

1118 &
nodehdr
->
h—d”
));

1121 
cÚtšue_w™h_cu¼’t_node_¡ack_äame
:

1122 ià(0 =ð
sf
->
num_cÝ›s
 || sf->
mœrÜ_num
 > sf->num_copies) {

1123 
sf
->
i
++;

1124 
sf
->
num_cÝ›s
 = 0;

1127 ià(
sf
->
i
 < sf->
Ä
) {

1128 
bŒfs_key_±r
 
key_±r
;

1129 
u32
 
key_±r_off£t
;

1130 
u64
 
Ãxt_by‹Ä
;

1132 
key_±r_off£t
 = (
ušŒ_t
)(
nodehdr
->
±rs
 + 
sf
->
i
) -

1133 (
ušŒ_t
)
nodehdr
;

1134 ià(
key_±r_off£t
 + (
bŒfs_key_±r
) >

1135 
sf
->
block_ùx
->
Ën
) {

1136 
	`´_šfo
("btrfsic:‚ode item out of bounce‡t†ogical %llu, dev %s\n",

1137 
sf
->
block_ùx
->
¡¬t
,

1138 
sf
->
block_ùx
->
dev
->
Çme
);

1139 
Úe_¡ack_äame_backw¬ds
;

1141 
	`bŒfsic_»ad_äom_block_d©a
(

1142 
sf
->
block_ùx
, &
key_±r
, 
key_±r_off£t
,

1143 (
bŒfs_key_±r
));

1144 
Ãxt_by‹Ä
 = 
	`bŒfs_¡ack_key_block±r
(&
key_±r
);

1146 
sf
->
”rÜ
 = 
	`bŒfsic_ü—‹_lšk_to_Ãxt_block
(

1147 
¡©e
,

1148 
sf
->
block
,

1149 
sf
->
block_ùx
,

1150 
Ãxt_by‹Ä
,

1151 
sf
->
lim™_Ã¡šg
,

1152 &
sf
->
Ãxt_block_ùx
,

1153 &
sf
->
Ãxt_block
,

1154 
fÜû_iodÚe_æag
,

1155 &
sf
->
num_cÝ›s
,

1156 &
sf
->
mœrÜ_num
,

1157 &
key_±r
.
key
,

1158 
	`bŒfs_¡ack_key_g’”©iÚ
(&
key_±r
));

1159 ià(
sf
->
”rÜ
)

1160 
Úe_¡ack_äame_backw¬ds
;

1162 ià(
NULL
 !ð
sf
->
Ãxt_block
) {

1163 
bŒfs_h—d”
 *cÚ¡ 
Ãxt_hdr
 =

1164 (
bŒfs_h—d”
 *)

1165 
sf
->
Ãxt_block_ùx
.
d©av
[0];

1167 
Ãxt_¡ack
 = 
	`bŒfsic_¡ack_äame_®loc
();

1168 ià(
NULL
 =ð
Ãxt_¡ack
) {

1169 
sf
->
”rÜ
 = -1;

1170 
Úe_¡ack_äame_backw¬ds
;

1173 
Ãxt_¡ack
->
i
 = -1;

1174 
Ãxt_¡ack
->
block
 = 
sf
->
Ãxt_block
;

1175 
Ãxt_¡ack
->
block_ùx
 = &
sf
->
Ãxt_block_ùx
;

1176 
Ãxt_¡ack
->
Ãxt_block
 = 
NULL
;

1177 
Ãxt_¡ack
->
hdr
 = 
Ãxt_hdr
;

1178 
Ãxt_¡ack
->
lim™_Ã¡šg
 =

1179 
sf
->
lim™_Ã¡šg
 - 1;

1180 
Ãxt_¡ack
->
´ev
 = 
sf
;

1181 
sf
 = 
Ãxt_¡ack
;

1182 
cÚtšue_w™h_Ãw_¡ack_äame
;

1185 
cÚtšue_w™h_cu¼’t_node_¡ack_äame
;

1189 
Úe_¡ack_äame_backw¬ds
:

1190 ià(
NULL
 !ð
sf
->
´ev
) {

1191 
bŒfsic_¡ack_äame
 *cÚ¡ 
´ev
 = 
sf
->prev;

1194 
	`bŒfsic_»Ëa£_block_ùx
(
sf
->
block_ùx
);

1196 ià(
sf
->
”rÜ
) {

1197 
´ev
->
”rÜ
 = 
sf
->error;

1198 
	`bŒfsic_¡ack_äame_ä“
(
sf
);

1199 
sf
 = 
´ev
;

1200 
Úe_¡ack_äame_backw¬ds
;

1203 
	`bŒfsic_¡ack_äame_ä“
(
sf
);

1204 
sf
 = 
´ev
;

1205 
cÚtšue_w™h_Ãw_¡ack_äame
;

1207 
	`BUG_ON
(&
š™Ÿl_¡ack_äame
 !ð
sf
);

1210  
sf
->
”rÜ
;

1211 
	}
}

1213 
	$bŒfsic_»ad_äom_block_d©a
(

1214 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

1215 *
d¡v
, 
u32
 
off£t
, 
size_t
 
Ën
)

1217 
size_t
 
cur
;

1218 
size_t
 
off£t_š_·ge
;

1219 *
kaddr
;

1220 *
d¡
 = (*)
d¡v
;

1221 
size_t
 
¡¬t_off£t
 = 
block_ùx
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

1222 
i
 = (
¡¬t_off£t
 + 
off£t
è>> 
PAGE_SHIFT
;

1224 
	`WARN_ON
(
off£t
 + 
Ën
 > 
block_ùx
->len);

1225 
off£t_š_·ge
 = (
¡¬t_off£t
 + 
off£t
è& (
PAGE_SIZE
 - 1);

1227 
Ën
 > 0) {

1228 
cur
 = 
	`mš
(
Ën
, ((
size_t
)
PAGE_SIZE
 - 
off£t_š_·ge
));

1229 
	`BUG_ON
(
i
 >ð
	`DIV_ROUND_UP
(
block_ùx
->
Ën
, 
PAGE_SIZE
));

1230 
kaddr
 = 
block_ùx
->
d©av
[
i
];

1231 
	`memýy
(
d¡
, 
kaddr
 + 
off£t_š_·ge
, 
cur
);

1233 
d¡
 +ð
cur
;

1234 
Ën
 -ð
cur
;

1235 
off£t_š_·ge
 = 0;

1236 
i
++;

1238 
	}
}

1240 
	$bŒfsic_ü—‹_lšk_to_Ãxt_block
(

1241 
bŒfsic_¡©e
 *
¡©e
,

1242 
bŒfsic_block
 *
block
,

1243 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

1244 
u64
 
Ãxt_by‹Ä
,

1245 
lim™_Ã¡šg
,

1246 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

1247 
bŒfsic_block
 **
Ãxt_blockp
,

1248 
fÜû_iodÚe_æag
,

1249 *
num_cÝ›¥
, *
mœrÜ_nump
,

1250 
bŒfs_disk_key
 *
disk_key
,

1251 
u64
 
·»Á_g’”©iÚ
)

1253 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1254 
bŒfsic_block
 *
Ãxt_block
 = 
NULL
;

1255 
»t
;

1256 
bŒfsic_block_lšk
 *
l
;

1257 
did_®loc_block_lšk
;

1258 
block_was_ü—‹d
;

1260 *
Ãxt_blockp
 = 
NULL
;

1261 ià(0 =ð*
num_cÝ›¥
) {

1262 *
num_cÝ›¥
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

1263 
¡©e
->
m‘ablock_size
);

1264 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

1265 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

1266 
Ãxt_by‹Ä
, *
num_cÝ›¥
);

1267 *
mœrÜ_nump
 = 1;

1270 ià(*
mœrÜ_nump
 > *
num_cÝ›¥
)

1273 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1274 
	`´_šfo
("btrfsic_create_link_to_next_block(mirror_num=%d)\n",

1275 *
mœrÜ_nump
);

1276 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

1277 
¡©e
->
m‘ablock_size
,

1278 
Ãxt_block_ùx
, *
mœrÜ_nump
);

1279 ià(
»t
) {

1280 
	`´_šfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

1281 
Ãxt_by‹Ä
, *
mœrÜ_nump
);

1282 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1283 *
Ãxt_blockp
 = 
NULL
;

1287 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(
¡©e
,

1288 
Ãxt_block_ùx
, "referenced ",

1289 1, 
fÜû_iodÚe_æag
,

1290 !
fÜû_iodÚe_æag
,

1291 *
mœrÜ_nump
,

1292 &
block_was_ü—‹d
);

1293 ià(
NULL
 =ð
Ãxt_block
) {

1294 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1295 *
Ãxt_blockp
 = 
NULL
;

1298 ià(
block_was_ü—‹d
) {

1299 
l
 = 
NULL
;

1300 
Ãxt_block
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

1302 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
) {

1303 ià(
Ãxt_block
->
logiÿl_by‹Ä
 !ð
Ãxt_by‹Ä
 &&

1304 !(!
Ãxt_block
->
is_m‘ad©a
 &&

1305 0 =ð
Ãxt_block
->
logiÿl_by‹Ä
))

1306 
	`´_šfo
("Referenced block @%llu (%s/%llu/%d) found in hashable, %c, bytenr mismatch (!= stored %llu).\n",

1307 
Ãxt_by‹Ä
, 
Ãxt_block_ùx
->
dev
->
Çme
,

1308 
Ãxt_block_ùx
->
dev_by‹Ä
, *
mœrÜ_nump
,

1309 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1310 
Ãxt_block
),

1311 
Ãxt_block
->
logiÿl_by‹Ä
);

1313 
	`´_šfo
("Referenced block @%llu (%s/%llu/%d) found in hashable, %c.\n",

1314 
Ãxt_by‹Ä
, 
Ãxt_block_ùx
->
dev
->
Çme
,

1315 
Ãxt_block_ùx
->
dev_by‹Ä
, *
mœrÜ_nump
,

1316 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1317 
Ãxt_block
));

1319 
Ãxt_block
->
logiÿl_by‹Ä
 = 
Ãxt_by‹Ä
;

1321 
Ãxt_block
->
mœrÜ_num
 = *
mœrÜ_nump
;

1322 
l
 = 
	`bŒfsic_block_lšk_hashbË_lookup
(

1323 
Ãxt_block_ùx
->
dev
->
bdev
,

1324 
Ãxt_block_ùx
->
dev_by‹Ä
,

1325 
block_ùx
->
dev
->
bdev
,

1326 
block_ùx
->
dev_by‹Ä
,

1327 &
¡©e
->
block_lšk_hashbË
);

1330 
Ãxt_block
->
disk_key
 = *disk_key;

1331 ià(
NULL
 =ð
l
) {

1332 
l
 = 
	`bŒfsic_block_lšk_®loc
();

1333 ià(
NULL
 =ð
l
) {

1334 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

1335 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1336 *
Ãxt_blockp
 = 
NULL
;

1340 
did_®loc_block_lšk
 = 1;

1341 
l
->
block_»f_to
 = 
Ãxt_block
;

1342 
l
->
block_»f_äom
 = 
block
;

1343 
l
->
»f_út
 = 1;

1344 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

1346 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1347 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

1349 
	`li¡_add
(&
l
->
node_»f_to
, &
block
->
»f_to_li¡
);

1350 
	`li¡_add
(&
l
->
node_»f_äom
, &
Ãxt_block
->
»f_äom_li¡
);

1352 
	`bŒfsic_block_lšk_hashbË_add
(
l
,

1353 &
¡©e
->
block_lšk_hashbË
);

1355 
did_®loc_block_lšk
 = 0;

1356 ià(0 =ð
lim™_Ã¡šg
) {

1357 
l
->
»f_út
++;

1358 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

1359 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1360 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

1364 ià(
lim™_Ã¡šg
 > 0 && 
did_®loc_block_lšk
) {

1365 
»t
 = 
	`bŒfsic_»ad_block
(
¡©e
, 
Ãxt_block_ùx
);

1366 ià(
»t
 < ()
Ãxt_block_ùx
->
Ën
) {

1367 
	`´_šfo
("btrfsic:„ead block @logical %llu failed!\n",

1368 
Ãxt_by‹Ä
);

1369 
	`bŒfsic_»Ëa£_block_ùx
(
Ãxt_block_ùx
);

1370 *
Ãxt_blockp
 = 
NULL
;

1374 *
Ãxt_blockp
 = 
Ãxt_block
;

1376 *
Ãxt_blockp
 = 
NULL
;

1378 (*
mœrÜ_nump
)++;

1381 
	}
}

1383 
	$bŒfsic_hªdË_ex‹Á_d©a
(

1384 
bŒfsic_¡©e
 *
¡©e
,

1385 
bŒfsic_block
 *
block
,

1386 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

1387 
u32
 
™em_off£t
, 
fÜû_iodÚe_æag
)

1389 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1390 
bŒfs_fže_ex‹Á_™em
 
fže_ex‹Á_™em
;

1391 
u64
 
fže_ex‹Á_™em_off£t
;

1392 
u64
 
Ãxt_by‹Ä
;

1393 
u64
 
num_by‹s
;

1394 
u64
 
g’”©iÚ
;

1395 
bŒfsic_block_lšk
 *
l
;

1396 
»t
;

1398 
fže_ex‹Á_™em_off£t
 = 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
) +

1399 
™em_off£t
;

1400 ià(
fže_ex‹Á_™em_off£t
 +

1401 
	`off£tof
(
bŒfs_fže_ex‹Á_™em
, 
disk_num_by‹s
) >

1402 
block_ùx
->
Ën
) {

1403 
	`´_šfo
("btrfsic: file item out of bounce‡t†ogical %llu, dev %s\n",

1404 
block_ùx
->
¡¬t
, block_ùx->
dev
->
Çme
);

1408 
	`bŒfsic_»ad_äom_block_d©a
(
block_ùx
, &
fže_ex‹Á_™em
,

1409 
fže_ex‹Á_™em_off£t
,

1410 
	`off£tof
(
bŒfs_fže_ex‹Á_™em
, 
disk_num_by‹s
));

1411 ià(
BTRFS_FILE_EXTENT_REG
 !ð
fže_ex‹Á_™em
.
ty³
 ||

1412 
	`bŒfs_¡ack_fže_ex‹Á_disk_by‹Ä
(&
fže_ex‹Á_™em
) == 0) {

1413 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1414 
	`´_šfo
("extent_data:ype %u, disk_bytenr = %llu\n",

1415 
fže_ex‹Á_™em
.
ty³
,

1416 
	`bŒfs_¡ack_fže_ex‹Á_disk_by‹Ä
(

1417 &
fže_ex‹Á_™em
));

1421 ià(
fže_ex‹Á_™em_off£t
 + (
bŒfs_fže_ex‹Á_™em
) >

1422 
block_ùx
->
Ën
) {

1423 
	`´_šfo
("btrfsic: file item out of bounce‡t†ogical %llu, dev %s\n",

1424 
block_ùx
->
¡¬t
, block_ùx->
dev
->
Çme
);

1427 
	`bŒfsic_»ad_äom_block_d©a
(
block_ùx
, &
fže_ex‹Á_™em
,

1428 
fže_ex‹Á_™em_off£t
,

1429 (
bŒfs_fže_ex‹Á_™em
));

1430 
Ãxt_by‹Ä
 = 
	`bŒfs_¡ack_fže_ex‹Á_disk_by‹Ä
(&
fže_ex‹Á_™em
);

1431 ià(
	`bŒfs_¡ack_fže_ex‹Á_com´essiÚ
(&
fže_ex‹Á_™em
) ==

1432 
BTRFS_COMPRESS_NONE
) {

1433 
Ãxt_by‹Ä
 +ð
	`bŒfs_¡ack_fže_ex‹Á_off£t
(&
fže_ex‹Á_™em
);

1434 
num_by‹s
 = 
	`bŒfs_¡ack_fže_ex‹Á_num_by‹s
(&
fže_ex‹Á_™em
);

1436 
num_by‹s
 = 
	`bŒfs_¡ack_fže_ex‹Á_disk_num_by‹s
(&
fže_ex‹Á_™em
);

1438 
g’”©iÚ
 = 
	`bŒfs_¡ack_fže_ex‹Á_g’”©iÚ
(&
fže_ex‹Á_™em
);

1440 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1441 
	`´_šfo
("extent_data:ype %u, disk_bytenr = %llu, offset = %llu,‚um_bytes = %llu\n",

1442 
fže_ex‹Á_™em
.
ty³
,

1443 
	`bŒfs_¡ack_fže_ex‹Á_disk_by‹Ä
(&
fže_ex‹Á_™em
),

1444 
	`bŒfs_¡ack_fže_ex‹Á_off£t
(&
fže_ex‹Á_™em
),

1445 
num_by‹s
);

1446 
num_by‹s
 > 0) {

1447 
u32
 
chunk_Ën
;

1448 
num_cÝ›s
;

1449 
mœrÜ_num
;

1451 ià(
num_by‹s
 > 
¡©e
->
d©ablock_size
)

1452 
chunk_Ën
 = 
¡©e
->
d©ablock_size
;

1454 
chunk_Ën
 = 
num_by‹s
;

1456 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

1457 
¡©e
->
d©ablock_size
);

1458 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

1459 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

1460 
Ãxt_by‹Ä
, 
num_cÝ›s
);

1461 
mœrÜ_num
 = 1; mœrÜ_num <ð
num_cÝ›s
; mirror_num++) {

1462 
bŒfsic_block_d©a_ùx
 
Ãxt_block_ùx
;

1463 
bŒfsic_block
 *
Ãxt_block
;

1464 
block_was_ü—‹d
;

1466 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1467 
	`´_šfo
("btrfsic_handle_extent_data(mirror_num=%d)\n",

1468 
mœrÜ_num
);

1469 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
)

1470 
	`´_šfo
("\tdisk_bytenr = %llu,‚um_bytes %u\n",

1471 
Ãxt_by‹Ä
, 
chunk_Ën
);

1472 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

1473 
chunk_Ën
, &
Ãxt_block_ùx
,

1474 
mœrÜ_num
);

1475 ià(
»t
) {

1476 
	`´_šfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

1477 
Ãxt_by‹Ä
, 
mœrÜ_num
);

1481 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(

1482 
¡©e
,

1483 &
Ãxt_block_ùx
,

1486 
fÜû_iodÚe_æag
,

1487 !
fÜû_iodÚe_æag
,

1488 
mœrÜ_num
,

1489 &
block_was_ü—‹d
);

1490 ià(
NULL
 =ð
Ãxt_block
) {

1491 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

1492 
	`bŒfsic_»Ëa£_block_ùx
(&
Ãxt_block_ùx
);

1495 ià(!
block_was_ü—‹d
) {

1496 ià((
¡©e
->
´št_mask
 &

1497 
BTRFSIC_PRINT_MASK_VERBOSE
) &&

1498 
Ãxt_block
->
logiÿl_by‹Ä
 !ð
Ãxt_by‹Ä
 &&

1499 !(!
Ãxt_block
->
is_m‘ad©a
 &&

1500 0 =ð
Ãxt_block
->
logiÿl_by‹Ä
)) {

1501 
	`´_šfo
("Referenced block @%llu (%s/%llu/%d) found in hashable, D, bytenr mismatch (!= stored %llu).\n",

1502 
Ãxt_by‹Ä
,

1503 
Ãxt_block_ùx
.
dev
->
Çme
,

1504 
Ãxt_block_ùx
.
dev_by‹Ä
,

1505 
mœrÜ_num
,

1506 
Ãxt_block
->
logiÿl_by‹Ä
);

1508 
Ãxt_block
->
logiÿl_by‹Ä
 = 
Ãxt_by‹Ä
;

1509 
Ãxt_block
->
mœrÜ_num
 = mirror_num;

1512 
l
 = 
	`bŒfsic_block_lšk_lookup_Ü_add
(
¡©e
,

1513 &
Ãxt_block_ùx
,

1514 
Ãxt_block
, 
block
,

1515 
g’”©iÚ
);

1516 
	`bŒfsic_»Ëa£_block_ùx
(&
Ãxt_block_ùx
);

1517 ià(
NULL
 =ð
l
)

1521 
Ãxt_by‹Ä
 +ð
chunk_Ën
;

1522 
num_by‹s
 -ð
chunk_Ën
;

1526 
	}
}

1528 
	$bŒfsic_m­_block
(
bŒfsic_¡©e
 *
¡©e
, 
u64
 
by‹Ä
, 
u32
 
Ën
,

1529 
bŒfsic_block_d©a_ùx
 *
block_ùx_out
,

1530 
mœrÜ_num
)

1532 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1533 
»t
;

1534 
u64
 
Ëngth
;

1535 
bŒfs_bio
 *
muÉi
 = 
NULL
;

1536 
bŒfs_deviû
 *
deviû
;

1538 
Ëngth
 = 
Ën
;

1539 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_READ
,

1540 
by‹Ä
, &
Ëngth
, &
muÉi
, 
mœrÜ_num
);

1542 ià(
»t
) {

1543 
block_ùx_out
->
¡¬t
 = 0;

1544 
block_ùx_out
->
dev_by‹Ä
 = 0;

1545 
block_ùx_out
->
Ën
 = 0;

1546 
block_ùx_out
->
dev
 = 
NULL
;

1547 
block_ùx_out
->
d©av
 = 
NULL
;

1548 
block_ùx_out
->
·gev
 = 
NULL
;

1549 
block_ùx_out
->
mem_to_ä“
 = 
NULL
;

1551  
»t
;

1554 
deviû
 = 
muÉi
->
¡res
[0].
dev
;

1555 
block_ùx_out
->
dev
 = 
	`bŒfsic_dev_¡©e_lookup
(
deviû
->
bdev
->
bd_dev
);

1556 
block_ùx_out
->
dev_by‹Ä
 = 
muÉi
->
¡res
[0].
physiÿl
;

1557 
block_ùx_out
->
¡¬t
 = 
by‹Ä
;

1558 
block_ùx_out
->
Ën
 =†en;

1559 
block_ùx_out
->
d©av
 = 
NULL
;

1560 
block_ùx_out
->
·gev
 = 
NULL
;

1561 
block_ùx_out
->
mem_to_ä“
 = 
NULL
;

1563 
	`kä“
(
muÉi
);

1564 ià(
NULL
 =ð
block_ùx_out
->
dev
) {

1565 
»t
 = -
ENXIO
;

1566 
	`´_šfo
("btrfsic:ƒrror, cannot†ookup dev (#1)!\n");

1569  
»t
;

1570 
	}
}

1572 
	$bŒfsic_»Ëa£_block_ùx
(
bŒfsic_block_d©a_ùx
 *
block_ùx
)

1574 ià(
block_ùx
->
mem_to_ä“
) {

1575 
num_·ges
;

1577 
	`BUG_ON
(!
block_ùx
->
d©av
);

1578 
	`BUG_ON
(!
block_ùx
->
·gev
);

1579 
num_·ges
 = (
block_ùx
->
Ën
 + (
u64
)
PAGE_SIZE
 - 1) >>

1580 
PAGE_SHIFT
;

1581 
num_·ges
 > 0) {

1582 
num_·ges
--;

1583 ià(
block_ùx
->
d©av
[
num_·ges
]) {

1584 
	`kunm­
(
block_ùx
->
·gev
[
num_·ges
]);

1585 
block_ùx
->
d©av
[
num_·ges
] = 
NULL
;

1587 ià(
block_ùx
->
·gev
[
num_·ges
]) {

1588 
	`__ä“_·ge
(
block_ùx
->
·gev
[
num_·ges
]);

1589 
block_ùx
->
·gev
[
num_·ges
] = 
NULL
;

1593 
	`kä“
(
block_ùx
->
mem_to_ä“
);

1594 
block_ùx
->
mem_to_ä“
 = 
NULL
;

1595 
block_ùx
->
·gev
 = 
NULL
;

1596 
block_ùx
->
d©av
 = 
NULL
;

1598 
	}
}

1600 
	$bŒfsic_»ad_block
(
bŒfsic_¡©e
 *
¡©e
,

1601 
bŒfsic_block_d©a_ùx
 *
block_ùx
)

1603 
num_·ges
;

1604 
i
;

1605 
u64
 
dev_by‹Ä
;

1606 
»t
;

1608 
	`BUG_ON
(
block_ùx
->
d©av
);

1609 
	`BUG_ON
(
block_ùx
->
·gev
);

1610 
	`BUG_ON
(
block_ùx
->
mem_to_ä“
);

1611 ià(
block_ùx
->
dev_by‹Ä
 & ((
u64
)
PAGE_SIZE
 - 1)) {

1612 
	`´_šfo
("btrfsic:„ead_block() with unaligned bytenr %llu\n",

1613 
block_ùx
->
dev_by‹Ä
);

1617 
num_·ges
 = (
block_ùx
->
Ën
 + (
u64
)
PAGE_SIZE
 - 1) >>

1618 
PAGE_SHIFT
;

1619 
block_ùx
->
mem_to_ä“
 = 
	`kz®loc
(((*block_ùx->
d©av
) +

1620 (*
block_ùx
->
·gev
)) *

1621 
num_·ges
, 
GFP_NOFS
);

1622 ià(!
block_ùx
->
mem_to_ä“
)

1623  -
ENOMEM
;

1624 
block_ùx
->
d©av
 = block_ùx->
mem_to_ä“
;

1625 
block_ùx
->
·gev
 = (
·ge
 **)(block_ùx->
d©av
 + 
num_·ges
);

1626 
i
 = 0; i < 
num_·ges
; i++) {

1627 
block_ùx
->
·gev
[
i
] = 
	`®loc_·ge
(
GFP_NOFS
);

1628 ià(!
block_ùx
->
·gev
[
i
])

1632 
dev_by‹Ä
 = 
block_ùx
->dev_bytenr;

1633 
i
 = 0; i < 
num_·ges
;) {

1634 
bio
 *bio;

1635 
j
;

1637 
bio
 = 
	`bŒfs_io_bio_®loc
(
num_·ges
 - 
i
);

1638 
	`bio_£t_dev
(
bio
, 
block_ùx
->
dev
->
bdev
);

1639 
bio
->
bi_™”
.
bi_£ùÜ
 = 
dev_by‹Ä
 >> 9;

1640 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

1642 
j
 = 
i
; j < 
num_·ges
; j++) {

1643 
»t
 = 
	`bio_add_·ge
(
bio
, 
block_ùx
->
·gev
[
j
],

1644 
PAGE_SIZE
, 0);

1645 ià(
PAGE_SIZE
 !ð
»t
)

1648 ià(
j
 =ð
i
) {

1649 
	`´_šfo
("btrfsic:ƒrror, failedo‡dd‡ single…age!\n");

1652 ià(
	`subm™_bio_wa™
(
bio
)) {

1653 
	`´_šfo
("btrfsic:„eadƒrror‡t†ogical %llu dev %s!\n",

1654 
block_ùx
->
¡¬t
, block_ùx->
dev
->
Çme
);

1655 
	`bio_put
(
bio
);

1658 
	`bio_put
(
bio
);

1659 
dev_by‹Ä
 +ð(
j
 - 
i
è* 
PAGE_SIZE
;

1660 
i
 = 
j
;

1662 
i
 = 0; i < 
num_·ges
; i++)

1663 
block_ùx
->
d©av
[
i
] = 
	`km­
(block_ùx->
·gev
[i]);

1665  
block_ùx
->
Ën
;

1666 
	}
}

1668 
	$bŒfsic_dump_d©aba£
(
bŒfsic_¡©e
 *
¡©e
)

1670 cÚ¡ 
bŒfsic_block
 *
b_®l
;

1672 
	`BUG_ON
(
NULL
 =ð
¡©e
);

1674 
	`´_šfo
("all_blocks_list:\n");

1675 
	`li¡_fÜ_—ch_’Œy
(
b_®l
, &
¡©e
->
®l_blocks_li¡
, 
®l_blocks_node
) {

1676 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

1678 
	`´_šfo
("%c-block @%llu (%s/%llu/%d)\n",

1679 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

1680 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
Çme
,

1681 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
);

1683 
	`li¡_fÜ_—ch_’Œy
(
l
, &
b_®l
->
»f_to_li¡
, 
node_»f_to
) {

1684 
	`´_šfo
(" %c @%llu (%s/%llu/%d)„efers %u*o %c @%llu (%s/%llu/%d)\n",

1685 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

1686 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
Çme
,

1687 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
,

1688 
l
->
»f_út
,

1689 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

1690 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

1691 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

1692 
l
->
block_»f_to
->
dev_by‹Ä
,

1693 
l
->
block_»f_to
->
mœrÜ_num
);

1696 
	`li¡_fÜ_—ch_’Œy
(
l
, &
b_®l
->
»f_äom_li¡
, 
node_»f_äom
) {

1697 
	`´_šfo
(" %c @%llu (%s/%llu/%d) is„ef %u* from %c @%llu (%s/%llu/%d)\n",

1698 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

1699 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
Çme
,

1700 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
,

1701 
l
->
»f_út
,

1702 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

1703 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

1704 
l
->
block_»f_äom
->
dev_¡©e
->
Çme
,

1705 
l
->
block_»f_äom
->
dev_by‹Ä
,

1706 
l
->
block_»f_äom
->
mœrÜ_num
);

1709 
	`´_šfo
("\n");

1711 
	}
}

1717 
	$bŒfsic_‹¡_fÜ_m‘ad©a
(
bŒfsic_¡©e
 *
¡©e
,

1718 **
d©av
, 
num_·ges
)

1720 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

1721 
bŒfs_h—d”
 *
h
;

1722 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

1723 
u32
 
üc
 = ~(u32)0;

1724 
i
;

1726 ià(
num_·ges
 * 
PAGE_SIZE
 < 
¡©e
->
m‘ablock_size
)

1728 
num_·ges
 = 
¡©e
->
m‘ablock_size
 >> 
PAGE_SHIFT
;

1729 
h
 = (
bŒfs_h—d”
 *)
d©av
[0];

1731 ià(
	`memcmp
(
h
->
fsid
, 
fs_šfo
->fsid, 
BTRFS_FSID_SIZE
))

1734 
i
 = 0; i < 
num_·ges
; i++) {

1735 
u8
 *
d©a
 = 
i
 ? 
d©av
[i] : (d©av[i] + 
BTRFS_CSUM_SIZE
);

1736 
size_t
 
subËn
 = 
i
 ? 
PAGE_SIZE
 :

1737 (
PAGE_SIZE
 - 
BTRFS_CSUM_SIZE
);

1739 
üc
 = 
	`bŒfs_üc32c
(üc, 
d©a
, 
subËn
);

1741 
	`bŒfs_csum_fš®
(
üc
, 
csum
);

1742 ià(
	`memcmp
(
csum
, 
h
->csum, 
¡©e
->
csum_size
))

1746 
	}
}

1748 
	$bŒfsic_´oûss_wr™‹n_block
(
bŒfsic_dev_¡©e
 *
dev_¡©e
,

1749 
u64
 
dev_by‹Ä
, **
m­³d_d©av
,

1750 
num_·ges
,

1751 
bio
 *bio, *
bio_is_·tched
,

1752 
bufãr_h—d
 *
bh
,

1753 
subm™_bio_bh_rw
)

1755 
is_m‘ad©a
;

1756 
bŒfsic_block
 *
block
;

1757 
bŒfsic_block_d©a_ùx
 
block_ùx
;

1758 
»t
;

1759 
bŒfsic_¡©e
 *
¡©e
 = 
dev_¡©e
->state;

1760 
block_deviû
 *
bdev
 = 
dev_¡©e
->bdev;

1761 
´oûs£d_Ën
;

1763 ià(
NULL
 !ð
bio_is_·tched
)

1764 *
bio_is_·tched
 = 0;

1766 
agaš
:

1767 ià(
num_·ges
 == 0)

1770 
´oûs£d_Ën
 = 0;

1771 
is_m‘ad©a
 = (0 =ð
	`bŒfsic_‹¡_fÜ_m‘ad©a
(
¡©e
, 
m­³d_d©av
,

1772 
num_·ges
));

1774 
block
 = 
	`bŒfsic_block_hashbË_lookup
(
bdev
, 
dev_by‹Ä
,

1775 &
¡©e
->
block_hashbË
);

1776 ià(
NULL
 !ð
block
) {

1777 
u64
 
by‹Ä
 = 0;

1778 
bŒfsic_block_lšk
 *
l
, *
tmp
;

1780 ià(
block
->
is_su³rblock
) {

1781 
by‹Ä
 = 
	`bŒfs_su³r_by‹Ä
((
bŒfs_su³r_block
 *)

1782 
m­³d_d©av
[0]);

1783 ià(
num_·ges
 * 
PAGE_SIZE
 <

1784 
BTRFS_SUPER_INFO_SIZE
) {

1785 
	`´_šfo
("btrfsic: cannot work withoo short bios!\n");

1788 
is_m‘ad©a
 = 1;

1789 
	`BUG_ON
(
BTRFS_SUPER_INFO_SIZE
 & (
PAGE_SIZE
 - 1));

1790 
´oûs£d_Ën
 = 
BTRFS_SUPER_INFO_SIZE
;

1791 ià(
¡©e
->
´št_mask
 &

1792 
BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
) {

1793 
	`´_šfo
("[before‚ew superblock is written]:\n");

1794 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
block
, 0);

1797 ià(
is_m‘ad©a
) {

1798 ià(!
block
->
is_su³rblock
) {

1799 ià(
num_·ges
 * 
PAGE_SIZE
 <

1800 
¡©e
->
m‘ablock_size
) {

1801 
	`´_šfo
("btrfsic: cannot work withoo short bios!\n");

1804 
´oûs£d_Ën
 = 
¡©e
->
m‘ablock_size
;

1805 
by‹Ä
 = 
	`bŒfs_¡ack_h—d”_by‹Ä
(

1806 (
bŒfs_h—d”
 *)

1807 
m­³d_d©av
[0]);

1808 
	`bŒfsic_cmp_log_ªd_dev_by‹Ä
(
¡©e
, 
by‹Ä
,

1809 
dev_¡©e
,

1810 
dev_by‹Ä
);

1812 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
) {

1813 ià(
block
->
logiÿl_by‹Ä
 !ð
by‹Ä
 &&

1814 !(!
block
->
is_m‘ad©a
 &&

1815 
block
->
logiÿl_by‹Ä
 == 0))

1816 
	`´_šfo
("Written block @%llu (%s/%llu/%d) found in hashable, %c, bytenr mismatch (!= stored %llu).\n",

1817 
by‹Ä
, 
dev_¡©e
->
Çme
,

1818 
dev_by‹Ä
,

1819 
block
->
mœrÜ_num
,

1820 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1821 
block
),

1822 
block
->
logiÿl_by‹Ä
);

1824 
	`´_šfo
("Written block @%llu (%s/%llu/%d) found in hashable, %c.\n",

1825 
by‹Ä
, 
dev_¡©e
->
Çme
,

1826 
dev_by‹Ä
, 
block
->
mœrÜ_num
,

1827 
	`bŒfsic_g‘_block_ty³
(
¡©e
,

1828 
block
));

1830 
block
->
logiÿl_by‹Ä
 = 
by‹Ä
;

1832 ià(
num_·ges
 * 
PAGE_SIZE
 <

1833 
¡©e
->
d©ablock_size
) {

1834 
	`´_šfo
("btrfsic: cannot work withoo short bios!\n");

1837 
´oûs£d_Ën
 = 
¡©e
->
d©ablock_size
;

1838 
by‹Ä
 = 
block
->
logiÿl_by‹Ä
;

1839 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1840 
	`´_šfo
("Written block @%llu (%s/%llu/%d) found in hashable, %c.\n",

1841 
by‹Ä
, 
dev_¡©e
->
Çme
, 
dev_by‹Ä
,

1842 
block
->
mœrÜ_num
,

1843 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
));

1846 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1847 
	`´_šfo
("ref_to_list: %cE,„ef_from_list: %cE\n",

1848 
	`li¡_em±y
(&
block
->
»f_to_li¡
) ? ' ' : '!',

1849 
	`li¡_em±y
(&
block
->
»f_äom_li¡
) ? ' ' : '!');

1850 ià(
	`bŒfsic_is_block_»f_by_su³rblock
(
¡©e
, 
block
, 0)) {

1851 
	`´_šfo
("btrfs:‡ttempto overwrite %c-block @%llu (%s/%llu/%d), old(gen=%llu, objectid=%llu,ype=%d, offset=%llu),‚ew(gen=%llu), which is„eferenced by most„ecent superblock (superblockgen=%llu)!\n",

1852 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
), 
by‹Ä
,

1853 
dev_¡©e
->
Çme
, 
dev_by‹Ä
, 
block
->
mœrÜ_num
,

1854 
block
->
g’”©iÚ
,

1855 
	`bŒfs_disk_key_objeùid
(&
block
->
disk_key
),

1856 
block
->
disk_key
.
ty³
,

1857 
	`bŒfs_disk_key_off£t
(&
block
->
disk_key
),

1858 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

1859 (
bŒfs_h—d”
 *è
m­³d_d©av
[0]),

1860 
¡©e
->
max_su³rblock_g’”©iÚ
);

1861 
	`bŒfsic_dump_Œ“
(
¡©e
);

1864 ià(!
block
->
is_iodÚe
 && !block->
Ãv”_wr™‹n
) {

1865 
	`´_šfo
("btrfs:‡ttempto overwrite %c-block @%llu (%s/%llu/%d), oldgen=%llu,‚ewgen=%llu, which is‚ot yet iodone!\n",

1866 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
), 
by‹Ä
,

1867 
dev_¡©e
->
Çme
, 
dev_by‹Ä
, 
block
->
mœrÜ_num
,

1868 
block
->
g’”©iÚ
,

1869 
	`bŒfs_¡ack_h—d”_g’”©iÚ
(

1870 (
bŒfs_h—d”
 *)

1871 
m­³d_d©av
[0]));

1873 
	`bŒfsic_dump_Œ“
(
¡©e
);

1874 
cÚtšue_loÝ
;

1883 
	`li¡_fÜ_—ch_’Œy_§ã
(
l
, 
tmp
, &
block
->
»f_to_li¡
,

1884 
node_»f_to
) {

1885 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

1886 
	`bŒfsic_´št_»m_lšk
(
¡©e
, 
l
);

1887 
l
->
»f_út
--;

1888 ià(0 =ð
l
->
»f_út
) {

1889 
	`li¡_d–
(&
l
->
node_»f_to
);

1890 
	`li¡_d–
(&
l
->
node_»f_äom
);

1891 
	`bŒfsic_block_lšk_hashbË_»move
(
l
);

1892 
	`bŒfsic_block_lšk_ä“
(
l
);

1896 
block_ùx
.
dev
 = 
dev_¡©e
;

1897 
block_ùx
.
dev_by‹Ä
 = dev_bytenr;

1898 
block_ùx
.
¡¬t
 = 
by‹Ä
;

1899 
block_ùx
.
Ën
 = 
´oûs£d_Ën
;

1900 
block_ùx
.
·gev
 = 
NULL
;

1901 
block_ùx
.
mem_to_ä“
 = 
NULL
;

1902 
block_ùx
.
d©av
 = 
m­³d_d©av
;

1904 ià(
is_m‘ad©a
 || 
¡©e
->
šþude_ex‹Á_d©a
) {

1905 
block
->
Ãv”_wr™‹n
 = 0;

1906 
block
->
iodÚe_w_”rÜ
 = 0;

1907 ià(
NULL
 !ð
bio
) {

1908 
block
->
is_iodÚe
 = 0;

1909 
	`BUG_ON
(
NULL
 =ð
bio_is_·tched
);

1910 ià(!*
bio_is_·tched
) {

1911 
block
->
Üig_bio_bh_´iv©e
 =

1912 
bio
->
bi_´iv©e
;

1913 
block
->
Üig_bio_bh_’d_io
.
bio
 =

1914 
bio
->
bi_’d_io
;

1915 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

1916 
bio
->
bi_´iv©e
 = 
block
;

1917 
bio
->
bi_’d_io
 = 
bŒfsic_bio_’d_io
;

1918 *
bio_is_·tched
 = 1;

1920 
bŒfsic_block
 *
chašed_block
 =

1921 (
bŒfsic_block
 *)

1922 
bio
->
bi_´iv©e
;

1924 
	`BUG_ON
(
NULL
 =ð
chašed_block
);

1925 
block
->
Üig_bio_bh_´iv©e
 =

1926 
chašed_block
->
Üig_bio_bh_´iv©e
;

1927 
block
->
Üig_bio_bh_’d_io
.
bio
 =

1928 
chašed_block
->
Üig_bio_bh_’d_io
.

1929 
bio
;

1930 
block
->
Ãxt_š_§me_bio
 = 
chašed_block
;

1931 
bio
->
bi_´iv©e
 = 
block
;

1933 } ià(
NULL
 !ð
bh
) {

1934 
block
->
is_iodÚe
 = 0;

1935 
block
->
Üig_bio_bh_´iv©e
 = 
bh
->
b_´iv©e
;

1936 
block
->
Üig_bio_bh_’d_io
.
bh
 = bh->
b_’d_io
;

1937 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

1938 
bh
->
b_´iv©e
 = 
block
;

1939 
bh
->
b_’d_io
 = 
bŒfsic_bh_’d_io
;

1941 
block
->
is_iodÚe
 = 1;

1942 
block
->
Üig_bio_bh_´iv©e
 = 
NULL
;

1943 
block
->
Üig_bio_bh_’d_io
.
bio
 = 
NULL
;

1944 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

1948 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

1949 
block
->
subm™_bio_bh_rw
 = submit_bio_bh_rw;

1950 ià(
is_m‘ad©a
) {

1951 
block
->
logiÿl_by‹Ä
 = 
by‹Ä
;

1952 
block
->
is_m‘ad©a
 = 1;

1953 ià(
block
->
is_su³rblock
) {

1954 
	`BUG_ON
(
PAGE_SIZE
 !=

1955 
BTRFS_SUPER_INFO_SIZE
);

1956 
»t
 = 
	`bŒfsic_´oûss_wr™‹n_su³rblock
(

1957 
¡©e
,

1958 
block
,

1959 (
bŒfs_su³r_block
 *)

1960 
m­³d_d©av
[0]);

1961 ià(
¡©e
->
´št_mask
 &

1962 
BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
) {

1963 
	`´_šfo
("[after‚ew superblock is written]:\n");

1964 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
block
, 0);

1967 
block
->
mœrÜ_num
 = 0;

1968 
»t
 = 
	`bŒfsic_´oûss_m‘ablock
(

1969 
¡©e
,

1970 
block
,

1971 &
block_ùx
,

1974 ià(
»t
)

1975 
	`´_šfo
("btrfsic: btrfsic_process_metablock(root @%llu) failed!\n",

1976 
dev_by‹Ä
);

1978 
block
->
is_m‘ad©a
 = 0;

1979 
block
->
mœrÜ_num
 = 0;

1980 
block
->
g’”©iÚ
 = 
BTRFSIC_GENERATION_UNKNOWN
;

1981 ià(!
¡©e
->
šþude_ex‹Á_d©a


1982 && 
	`li¡_em±y
(&
block
->
»f_äom_li¡
)) {

1989 
	`bŒfsic_block_hashbË_»move
(
block
);

1990 
	`li¡_d–
(&
block
->
®l_blocks_node
);

1991 
	`bŒfsic_block_ä“
(
block
);

1994 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

1997 
u64
 
by‹Ä
;

1999 ià(!
is_m‘ad©a
) {

2000 
´oûs£d_Ën
 = 
¡©e
->
d©ablock_size
;

2001 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2002 
	`´_šfo
("Written block (%s/%llu/?) !found in hashable, D.\n",

2003 
dev_¡©e
->
Çme
, 
dev_by‹Ä
);

2004 ià(!
¡©e
->
šþude_ex‹Á_d©a
) {

2006 
cÚtšue_loÝ
;

2011 
by‹Ä
 = 0;

2013 
´oûs£d_Ën
 = 
¡©e
->
m‘ablock_size
;

2014 
by‹Ä
 = 
	`bŒfs_¡ack_h—d”_by‹Ä
(

2015 (
bŒfs_h—d”
 *)

2016 
m­³d_d©av
[0]);

2017 
	`bŒfsic_cmp_log_ªd_dev_by‹Ä
(
¡©e
, 
by‹Ä
, 
dev_¡©e
,

2018 
dev_by‹Ä
);

2019 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2020 
	`´_šfo
("Written block @%llu (%s/%llu/?) !found in hashable, M.\n",

2021 
by‹Ä
, 
dev_¡©e
->
Çme
, 
dev_by‹Ä
);

2024 
block_ùx
.
dev
 = 
dev_¡©e
;

2025 
block_ùx
.
dev_by‹Ä
 = dev_bytenr;

2026 
block_ùx
.
¡¬t
 = 
by‹Ä
;

2027 
block_ùx
.
Ën
 = 
´oûs£d_Ën
;

2028 
block_ùx
.
·gev
 = 
NULL
;

2029 
block_ùx
.
mem_to_ä“
 = 
NULL
;

2030 
block_ùx
.
d©av
 = 
m­³d_d©av
;

2032 
block
 = 
	`bŒfsic_block_®loc
();

2033 ià(
NULL
 =ð
block
) {

2034 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

2035 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2036 
cÚtšue_loÝ
;

2038 
block
->
dev_¡©e
 = dev_state;

2039 
block
->
dev_by‹Ä
 = dev_bytenr;

2040 
block
->
logiÿl_by‹Ä
 = 
by‹Ä
;

2041 
block
->
is_m‘ad©a
 = is_metadata;

2042 
block
->
Ãv”_wr™‹n
 = 0;

2043 
block
->
iodÚe_w_”rÜ
 = 0;

2044 
block
->
mœrÜ_num
 = 0;

2045 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

2046 
block
->
subm™_bio_bh_rw
 = submit_bio_bh_rw;

2047 ià(
NULL
 !ð
bio
) {

2048 
block
->
is_iodÚe
 = 0;

2049 
	`BUG_ON
(
NULL
 =ð
bio_is_·tched
);

2050 ià(!*
bio_is_·tched
) {

2051 
block
->
Üig_bio_bh_´iv©e
 = 
bio
->
bi_´iv©e
;

2052 
block
->
Üig_bio_bh_’d_io
.
bio
 = bio->
bi_’d_io
;

2053 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2054 
bio
->
bi_´iv©e
 = 
block
;

2055 
bio
->
bi_’d_io
 = 
bŒfsic_bio_’d_io
;

2056 *
bio_is_·tched
 = 1;

2058 
bŒfsic_block
 *
chašed_block
 =

2059 (
bŒfsic_block
 *)

2060 
bio
->
bi_´iv©e
;

2062 
	`BUG_ON
(
NULL
 =ð
chašed_block
);

2063 
block
->
Üig_bio_bh_´iv©e
 =

2064 
chašed_block
->
Üig_bio_bh_´iv©e
;

2065 
block
->
Üig_bio_bh_’d_io
.
bio
 =

2066 
chašed_block
->
Üig_bio_bh_’d_io
.
bio
;

2067 
block
->
Ãxt_š_§me_bio
 = 
chašed_block
;

2068 
bio
->
bi_´iv©e
 = 
block
;

2070 } ià(
NULL
 !ð
bh
) {

2071 
block
->
is_iodÚe
 = 0;

2072 
block
->
Üig_bio_bh_´iv©e
 = 
bh
->
b_´iv©e
;

2073 
block
->
Üig_bio_bh_’d_io
.
bh
 = bh->
b_’d_io
;

2074 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2075 
bh
->
b_´iv©e
 = 
block
;

2076 
bh
->
b_’d_io
 = 
bŒfsic_bh_’d_io
;

2078 
block
->
is_iodÚe
 = 1;

2079 
block
->
Üig_bio_bh_´iv©e
 = 
NULL
;

2080 
block
->
Üig_bio_bh_’d_io
.
bio
 = 
NULL
;

2081 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2083 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2084 
	`´_šfo
("New written %c-block @%llu (%s/%llu/%d)\n",

2085 
is_m‘ad©a
 ? 'M' : 'D',

2086 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
Çme
,

2087 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2088 
	`li¡_add
(&
block
->
®l_blocks_node
, &
¡©e
->
®l_blocks_li¡
);

2089 
	`bŒfsic_block_hashbË_add
(
block
, &
¡©e
->
block_hashbË
);

2091 ià(
is_m‘ad©a
) {

2092 
»t
 = 
	`bŒfsic_´oûss_m‘ablock
(
¡©e
, 
block
,

2093 &
block_ùx
, 0, 0);

2094 ià(
»t
)

2095 
	`´_šfo
("btrfsic:…rocess_metablock(root @%llu) failed!\n",

2096 
dev_by‹Ä
);

2098 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2101 
cÚtšue_loÝ
:

2102 
	`BUG_ON
(!
´oûs£d_Ën
);

2103 
dev_by‹Ä
 +ð
´oûs£d_Ën
;

2104 
m­³d_d©av
 +ð
´oûs£d_Ën
 >> 
PAGE_SHIFT
;

2105 
num_·ges
 -ð
´oûs£d_Ën
 >> 
PAGE_SHIFT
;

2106 
agaš
;

2107 
	}
}

2109 
	$bŒfsic_bio_’d_io
(
bio
 *
bp
)

2111 
bŒfsic_block
 *
block
 = (bŒfsic_block *)
bp
->
bi_´iv©e
;

2112 
iodÚe_w_”rÜ
;

2116 
iodÚe_w_”rÜ
 = 0;

2117 ià(
bp
->
bi_¡©us
)

2118 
iodÚe_w_”rÜ
 = 1;

2120 
	`BUG_ON
(
NULL
 =ð
block
);

2121 
bp
->
bi_´iv©e
 = 
block
->
Üig_bio_bh_´iv©e
;

2122 
bp
->
bi_’d_io
 = 
block
->
Üig_bio_bh_’d_io
.
bio
;

2125 
bŒfsic_block
 *
Ãxt_block
;

2126 
bŒfsic_dev_¡©e
 *cÚ¡ 
dev_¡©e
 = 
block
->dev_state;

2128 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2129 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2130 
	`´_šfo
("bio_end_io(err=%d) for %c @%llu (%s/%llu/%d)\n",

2131 
bp
->
bi_¡©us
,

2132 
	`bŒfsic_g‘_block_ty³
(
dev_¡©e
->
¡©e
, 
block
),

2133 
block
->
logiÿl_by‹Ä
, 
dev_¡©e
->
Çme
,

2134 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2135 
Ãxt_block
 = 
block
->
Ãxt_š_§me_bio
;

2136 
block
->
iodÚe_w_”rÜ
 = iodone_w_error;

2137 ià(
block
->
subm™_bio_bh_rw
 & 
REQ_PREFLUSH
) {

2138 
dev_¡©e
->
Ï¡_æush_g’
++;

2139 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2140 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2141 
	`´_šfo
("bio_end_io()‚ew %s flush_gen=%llu\n",

2142 
dev_¡©e
->
Çme
,

2143 
dev_¡©e
->
Ï¡_æush_g’
);

2145 ià(
block
->
subm™_bio_bh_rw
 & 
REQ_FUA
)

2146 
block
->
æush_g’
 = 0;

2148 
block
->
is_iodÚe
 = 1;

2149 
block
 = 
Ãxt_block
;

2150 } 
NULL
 !ð
block
);

2152 
bp
->
	`bi_’d_io
(bp);

2153 
	}
}

2155 
	$bŒfsic_bh_’d_io
(
bufãr_h—d
 *
bh
, 
u±od©e
)

2157 
bŒfsic_block
 *
block
 = (bŒfsic_block *)
bh
->
b_´iv©e
;

2158 
iodÚe_w_”rÜ
 = !
u±od©e
;

2159 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

2161 
	`BUG_ON
(
NULL
 =ð
block
);

2162 
dev_¡©e
 = 
block
->dev_state;

2163 ià((
dev_¡©e
->
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2164 
	`´_šfo
("bh_end_io(error=%d) for %c @%llu (%s/%llu/%d)\n",

2165 
iodÚe_w_”rÜ
,

2166 
	`bŒfsic_g‘_block_ty³
(
dev_¡©e
->
¡©e
, 
block
),

2167 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
Çme
,

2168 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2170 
block
->
iodÚe_w_”rÜ
 = iodone_w_error;

2171 ià(
block
->
subm™_bio_bh_rw
 & 
REQ_PREFLUSH
) {

2172 
dev_¡©e
->
Ï¡_æush_g’
++;

2173 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2174 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
))

2175 
	`´_šfo
("bh_end_io()‚ew %s flush_gen=%llu\n",

2176 
dev_¡©e
->
Çme
, dev_¡©e->
Ï¡_æush_g’
);

2178 ià(
block
->
subm™_bio_bh_rw
 & 
REQ_FUA
)

2179 
block
->
æush_g’
 = 0;

2181 
bh
->
b_´iv©e
 = 
block
->
Üig_bio_bh_´iv©e
;

2182 
bh
->
b_’d_io
 = 
block
->
Üig_bio_bh_’d_io
.bh;

2183 
block
->
is_iodÚe
 = 1;

2184 
bh
->
	`b_’d_io
(bh, 
u±od©e
);

2185 
	}
}

2187 
	$bŒfsic_´oûss_wr™‹n_su³rblock
(

2188 
bŒfsic_¡©e
 *
¡©e
,

2189 
bŒfsic_block
 *cÚ¡ 
su³rblock
,

2190 
bŒfs_su³r_block
 *cÚ¡ 
su³r_hdr
)

2192 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

2193 
·ss
;

2195 
su³rblock
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
);

2196 ià(!(
su³rblock
->
g’”©iÚ
 > 
¡©e
->
max_su³rblock_g’”©iÚ
 ||

2197 0 =ð
¡©e
->
max_su³rblock_g’”©iÚ
)) {

2198 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

2199 
	`´_šfo
("btrfsic: superblock @%llu (%s/%llu/%d) with old gen %llu <= %llu\n",

2200 
su³rblock
->
logiÿl_by‹Ä
,

2201 
su³rblock
->
dev_¡©e
->
Çme
,

2202 
su³rblock
->
dev_by‹Ä
, su³rblock->
mœrÜ_num
,

2203 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
),

2204 
¡©e
->
max_su³rblock_g’”©iÚ
);

2206 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
)

2207 
	`´_šfo
("btrfsic: got‚ew superblock @%llu (%s/%llu/%d) with‚ew gen %llu > %llu\n",

2208 
su³rblock
->
logiÿl_by‹Ä
,

2209 
su³rblock
->
dev_¡©e
->
Çme
,

2210 
su³rblock
->
dev_by‹Ä
, su³rblock->
mœrÜ_num
,

2211 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
),

2212 
¡©e
->
max_su³rblock_g’”©iÚ
);

2214 
¡©e
->
max_su³rblock_g’”©iÚ
 =

2215 
	`bŒfs_su³r_g’”©iÚ
(
su³r_hdr
);

2216 
¡©e
->
Ï‹¡_su³rblock
 = 
su³rblock
;

2219 
·ss
 = 0;…ass < 3;…ass++) {

2220 
»t
;

2221 
u64
 
Ãxt_by‹Ä
;

2222 
bŒfsic_block
 *
Ãxt_block
;

2223 
bŒfsic_block_d©a_ùx
 
tmp_Ãxt_block_ùx
;

2224 
bŒfsic_block_lšk
 *
l
;

2225 
num_cÝ›s
;

2226 
mœrÜ_num
;

2227 cÚ¡ *
add™iÚ®_¡ršg
 = 
NULL
;

2228 
bŒfs_disk_key
 
tmp_disk_key
 = {0};

2230 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2231 
BTRFS_ROOT_ITEM_KEY
);

2232 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
, 0);

2234 
·ss
) {

2236 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2237 
BTRFS_ROOT_TREE_OBJECTID
);

2238 
add™iÚ®_¡ršg
 = "root ";

2239 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_roÙ
(
su³r_hdr
);

2240 ià(
¡©e
->
´št_mask
 &

2241 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2242 
	`´_šfo
("roÙ@%Îu\n", 
Ãxt_by‹Ä
);

2245 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2246 
BTRFS_CHUNK_TREE_OBJECTID
);

2247 
add™iÚ®_¡ršg
 = "chunk ";

2248 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_chunk_roÙ
(
su³r_hdr
);

2249 ià(
¡©e
->
´št_mask
 &

2250 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2251 
	`´_šfo
("chunk@%Îu\n", 
Ãxt_by‹Ä
);

2254 
	`bŒfs_£t_disk_key_objeùid
(&
tmp_disk_key
,

2255 
BTRFS_TREE_LOG_OBJECTID
);

2256 
add™iÚ®_¡ršg
 = "log ";

2257 
Ãxt_by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
su³r_hdr
);

2258 ià(0 =ð
Ãxt_by‹Ä
)

2260 ià(
¡©e
->
´št_mask
 &

2261 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
)

2262 
	`´_šfo
("log@%Îu\n", 
Ãxt_by‹Ä
);

2266 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
Ãxt_by‹Ä
,

2267 
BTRFS_SUPER_INFO_SIZE
);

2268 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_NUM_COPIES
)

2269 
	`´_šfo
("num_copies(log_bytenr=%llu) = %d\n",

2270 
Ãxt_by‹Ä
, 
num_cÝ›s
);

2271 
mœrÜ_num
 = 1; mœrÜ_num <ð
num_cÝ›s
; mirror_num++) {

2272 
was_ü—‹d
;

2274 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2275 
	`´_šfo
("bŒfsic_´oûss_wr™‹n_su³rblock(mœrÜ_num=%d)\n", 
mœrÜ_num
);

2276 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
Ãxt_by‹Ä
,

2277 
BTRFS_SUPER_INFO_SIZE
,

2278 &
tmp_Ãxt_block_ùx
,

2279 
mœrÜ_num
);

2280 ià(
»t
) {

2281 
	`´_šfo
("btrfsic: btrfsic_map_block(@%llu, mirror=%d) failed!\n",

2282 
Ãxt_by‹Ä
, 
mœrÜ_num
);

2286 
Ãxt_block
 = 
	`bŒfsic_block_lookup_Ü_add
(

2287 
¡©e
,

2288 &
tmp_Ãxt_block_ùx
,

2289 
add™iÚ®_¡ršg
,

2291 
mœrÜ_num
,

2292 &
was_ü—‹d
);

2293 ià(
NULL
 =ð
Ãxt_block
) {

2294 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

2295 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

2299 
Ãxt_block
->
disk_key
 = 
tmp_disk_key
;

2300 ià(
was_ü—‹d
)

2301 
Ãxt_block
->
g’”©iÚ
 =

2302 
BTRFSIC_GENERATION_UNKNOWN
;

2303 
l
 = 
	`bŒfsic_block_lšk_lookup_Ü_add
(

2304 
¡©e
,

2305 &
tmp_Ãxt_block_ùx
,

2306 
Ãxt_block
,

2307 
su³rblock
,

2308 
BTRFSIC_GENERATION_UNKNOWN
);

2309 
	`bŒfsic_»Ëa£_block_ùx
(&
tmp_Ãxt_block_ùx
);

2310 ià(
NULL
 =ð
l
)

2315 ià(
	`WARN_ON
(-1 =ð
	`bŒfsic_check_®l_»f_blocks
(
¡©e
, 
su³rblock
, 0)))

2316 
	`bŒfsic_dump_Œ“
(
¡©e
);

2319 
	}
}

2321 
	$bŒfsic_check_®l_»f_blocks
(
bŒfsic_¡©e
 *
¡©e
,

2322 
bŒfsic_block
 *cÚ¡ 
block
,

2323 
»cursiÚ_Ëv–
)

2325 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

2326 
»t
 = 0;

2328 ià(
»cursiÚ_Ëv–
 >ð3 + 
BTRFS_MAX_LEVEL
) {

2342 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2343 
	`´_šfo
("btrfsic:‡bort cyclic†inkage (case 1).\n");

2345  
»t
;

2352 
	`li¡_fÜ_—ch_’Œy
(
l
, &
block
->
»f_to_li¡
, 
node_»f_to
) {

2353 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2354 
	`´_šfo
("rl=%d, %c @%llu (%s/%llu/%d) %u*„eferso %c @%llu (%s/%llu/%d)\n",

2355 
»cursiÚ_Ëv–
,

2356 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2357 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
Çme
,

2358 
block
->
dev_by‹Ä
, block->
mœrÜ_num
,

2359 
l
->
»f_út
,

2360 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2361 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2362 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

2363 
l
->
block_»f_to
->
dev_by‹Ä
,

2364 
l
->
block_»f_to
->
mœrÜ_num
);

2365 ià(
l
->
block_»f_to
->
Ãv”_wr™‹n
) {

2366 
	`´_šfo
("btrfs:‡ttempto write superblock which„eferences block %c @%llu (%s/%llu/%d) which is‚ever written!\n",

2367 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2368 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2369 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

2370 
l
->
block_»f_to
->
dev_by‹Ä
,

2371 
l
->
block_»f_to
->
mœrÜ_num
);

2372 
»t
 = -1;

2373 } ià(!
l
->
block_»f_to
->
is_iodÚe
) {

2374 
	`´_šfo
("btrfs:‡ttempto write superblock which„eferences block %c @%llu (%s/%llu/%d) which is‚ot yet iodone!\n",

2375 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2376 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2377 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

2378 
l
->
block_»f_to
->
dev_by‹Ä
,

2379 
l
->
block_»f_to
->
mœrÜ_num
);

2380 
»t
 = -1;

2381 } ià(
l
->
block_»f_to
->
iodÚe_w_”rÜ
) {

2382 
	`´_šfo
("btrfs:‡ttempto write superblock which„eferences block %c @%llu (%s/%llu/%d) which has writeƒrror!\n",

2383 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2384 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2385 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

2386 
l
->
block_»f_to
->
dev_by‹Ä
,

2387 
l
->
block_»f_to
->
mœrÜ_num
);

2388 
»t
 = -1;

2389 } ià(
l
->
·»Á_g’”©iÚ
 !=

2390 
l
->
block_»f_to
->
g’”©iÚ
 &&

2391 
BTRFSIC_GENERATION_UNKNOWN
 !=

2392 
l
->
·»Á_g’”©iÚ
 &&

2393 
BTRFSIC_GENERATION_UNKNOWN
 !=

2394 
l
->
block_»f_to
->
g’”©iÚ
) {

2395 
	`´_šfo
("btrfs:‡ttempto write superblock which„eferences block %c @%llu (%s/%llu/%d) with generation %llu !=…arent generation %llu!\n",

2396 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2397 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2398 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

2399 
l
->
block_»f_to
->
dev_by‹Ä
,

2400 
l
->
block_»f_to
->
mœrÜ_num
,

2401 
l
->
block_»f_to
->
g’”©iÚ
,

2402 
l
->
·»Á_g’”©iÚ
);

2403 
»t
 = -1;

2404 } ià(
l
->
block_»f_to
->
æush_g’
 >

2405 
l
->
block_»f_to
->
dev_¡©e
->
Ï¡_æush_g’
) {

2406 
	`´_šfo
("btrfs:‡ttempto write superblock which„eferences block %c @%llu (%s/%llu/%d) which is‚ot flushed out of disk's write cache (block flush_gen=%llu, dev->flush_gen=%llu)!\n",

2407 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2408 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2409 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,

2410 
l
->
block_»f_to
->
dev_by‹Ä
,

2411 
l
->
block_»f_to
->
mœrÜ_num
, 
block
->
æush_g’
,

2412 
l
->
block_»f_to
->
dev_¡©e
->
Ï¡_æush_g’
);

2413 
»t
 = -1;

2414 } ià(-1 =ð
	`bŒfsic_check_®l_»f_blocks
(
¡©e
,

2415 
l
->
block_»f_to
,

2416 
»cursiÚ_Ëv–
 +

2418 
»t
 = -1;

2422  
»t
;

2423 
	}
}

2425 
	$bŒfsic_is_block_»f_by_su³rblock
(

2426 cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2427 cÚ¡ 
bŒfsic_block
 *
block
,

2428 
»cursiÚ_Ëv–
)

2430 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

2432 ià(
»cursiÚ_Ëv–
 >ð3 + 
BTRFS_MAX_LEVEL
) {

2434 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2435 
	`´_šfo
("btrfsic:‡bort cyclic†inkage (case 2).\n");

2444 
	`li¡_fÜ_—ch_’Œy
(
l
, &
block
->
»f_äom_li¡
, 
node_»f_äom
) {

2445 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2446 
	`´_šfo
("rl=%d, %c @%llu (%s/%llu/%d) is„ef %u* from %c @%llu (%s/%llu/%d)\n",

2447 
»cursiÚ_Ëv–
,

2448 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2449 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
Çme
,

2450 
block
->
dev_by‹Ä
, block->
mœrÜ_num
,

2451 
l
->
»f_út
,

2452 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

2453 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

2454 
l
->
block_»f_äom
->
dev_¡©e
->
Çme
,

2455 
l
->
block_»f_äom
->
dev_by‹Ä
,

2456 
l
->
block_»f_äom
->
mœrÜ_num
);

2457 ià(
l
->
block_»f_äom
->
is_su³rblock
 &&

2458 
¡©e
->
Ï‹¡_su³rblock
->
dev_by‹Ä
 ==

2459 
l
->
block_»f_äom
->
dev_by‹Ä
 &&

2460 
¡©e
->
Ï‹¡_su³rblock
->
dev_¡©e
->
bdev
 ==

2461 
l
->
block_»f_äom
->
dev_¡©e
->
bdev
)

2463 ià(
	`bŒfsic_is_block_»f_by_su³rblock
(
¡©e
,

2464 
l
->
block_»f_äom
,

2465 
»cursiÚ_Ëv–
 +

2471 
	}
}

2473 
	$bŒfsic_´št_add_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2474 cÚ¡ 
bŒfsic_block_lšk
 *
l
)

2476 
	`´_šfo
("Add %u*†ink from %c @%llu (%s/%llu/%d)o %c @%llu (%s/%llu/%d).\n",

2477 
l
->
»f_út
,

2478 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

2479 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

2480 
l
->
block_»f_äom
->
dev_¡©e
->
Çme
,

2481 
l
->
block_»f_äom
->
dev_by‹Ä
,†->block_»f_äom->
mœrÜ_num
,

2482 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2483 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2484 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,†->block_»f_to->
dev_by‹Ä
,

2485 
l
->
block_»f_to
->
mœrÜ_num
);

2486 
	}
}

2488 
	$bŒfsic_´št_»m_lšk
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2489 cÚ¡ 
bŒfsic_block_lšk
 *
l
)

2491 
	`´_šfo
("Rem %u*†ink from %c @%llu (%s/%llu/%d)o %c @%llu (%s/%llu/%d).\n",

2492 
l
->
»f_út
,

2493 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_äom
),

2494 
l
->
block_»f_äom
->
logiÿl_by‹Ä
,

2495 
l
->
block_»f_äom
->
dev_¡©e
->
Çme
,

2496 
l
->
block_»f_äom
->
dev_by‹Ä
,†->block_»f_äom->
mœrÜ_num
,

2497 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
l
->
block_»f_to
),

2498 
l
->
block_»f_to
->
logiÿl_by‹Ä
,

2499 
l
->
block_»f_to
->
dev_¡©e
->
Çme
,†->block_»f_to->
dev_by‹Ä
,

2500 
l
->
block_»f_to
->
mœrÜ_num
);

2501 
	}
}

2503 
	$bŒfsic_g‘_block_ty³
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2504 cÚ¡ 
bŒfsic_block
 *
block
)

2506 ià(
block
->
is_su³rblock
 &&

2507 
¡©e
->
Ï‹¡_su³rblock
->
dev_by‹Ä
 =ð
block
->dev_bytenr &&

2508 
¡©e
->
Ï‹¡_su³rblock
->
dev_¡©e
->
bdev
 =ð
block
->dev_state->bdev)

2510 ià(
block
->
is_su³rblock
)

2512 ià(
block
->
is_m‘ad©a
)

2516 
	}
}

2518 
	$bŒfsic_dump_Œ“
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
)

2520 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, s‹->
Ï‹¡_su³rblock
, 0);

2521 
	}
}

2523 
	$bŒfsic_dump_Œ“_sub
(cÚ¡ 
bŒfsic_¡©e
 *
¡©e
,

2524 cÚ¡ 
bŒfsic_block
 *
block
,

2525 
šd’t_Ëv–
)

2527 cÚ¡ 
bŒfsic_block_lšk
 *
l
;

2528 
šd’t_add
;

2529 
buf
[80];

2530 
cursÜ_pos™iÚ
;

2541 
šd’t_add
 = 
	`¥rštf
(
buf
, "%c-%llu(%s/%llu/%u)",

2542 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2543 
block
->
logiÿl_by‹Ä
, block->
dev_¡©e
->
Çme
,

2544 
block
->
dev_by‹Ä
, block->
mœrÜ_num
);

2545 ià(
šd’t_Ëv–
 + 
šd’t_add
 > 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
) {

2546 
	`´štk
("[...]\n");

2549 
	`´štk
(
buf
);

2550 
šd’t_Ëv–
 +ð
šd’t_add
;

2551 ià(
	`li¡_em±y
(&
block
->
»f_to_li¡
)) {

2552 
	`´štk
("\n");

2555 ià(
block
->
mœrÜ_num
 > 1 &&

2556 !(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
)) {

2557 
	`´štk
(" [...]\n");

2561 
cursÜ_pos™iÚ
 = 
šd’t_Ëv–
;

2562 
	`li¡_fÜ_—ch_’Œy
(
l
, &
block
->
»f_to_li¡
, 
node_»f_to
) {

2563 
cursÜ_pos™iÚ
 < 
šd’t_Ëv–
) {

2564 
	`´štk
(" ");

2565 
cursÜ_pos™iÚ
++;

2567 ià(
l
->
»f_út
 > 1)

2568 
šd’t_add
 = 
	`¥rštf
(
buf
, " %d*--> ", 
l
->
»f_út
);

2570 
šd’t_add
 = 
	`¥rštf
(
buf
, " --> ");

2571 ià(
šd’t_Ëv–
 + 
šd’t_add
 >

2572 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
) {

2573 
	`´štk
("[...]\n");

2574 
cursÜ_pos™iÚ
 = 0;

2578 
	`´štk
(
buf
);

2580 
	`bŒfsic_dump_Œ“_sub
(
¡©e
, 
l
->
block_»f_to
,

2581 
šd’t_Ëv–
 + 
šd’t_add
);

2582 
cursÜ_pos™iÚ
 = 0;

2584 
	}
}

2586 
bŒfsic_block_lšk
 *
	$bŒfsic_block_lšk_lookup_Ü_add
(

2587 
bŒfsic_¡©e
 *
¡©e
,

2588 
bŒfsic_block_d©a_ùx
 *
Ãxt_block_ùx
,

2589 
bŒfsic_block
 *
Ãxt_block
,

2590 
bŒfsic_block
 *
äom_block
,

2591 
u64
 
·»Á_g’”©iÚ
)

2593 
bŒfsic_block_lšk
 *
l
;

2595 
l
 = 
	`bŒfsic_block_lšk_hashbË_lookup
(
Ãxt_block_ùx
->
dev
->
bdev
,

2596 
Ãxt_block_ùx
->
dev_by‹Ä
,

2597 
äom_block
->
dev_¡©e
->
bdev
,

2598 
äom_block
->
dev_by‹Ä
,

2599 &
¡©e
->
block_lšk_hashbË
);

2600 ià(
NULL
 =ð
l
) {

2601 
l
 = 
	`bŒfsic_block_lšk_®loc
();

2602 ià(
NULL
 =ð
l
) {

2603 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

2604  
NULL
;

2607 
l
->
block_»f_to
 = 
Ãxt_block
;

2608 
l
->
block_»f_äom
 = 
äom_block
;

2609 
l
->
»f_út
 = 1;

2610 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

2612 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2613 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

2615 
	`li¡_add
(&
l
->
node_»f_to
, &
äom_block
->
»f_to_li¡
);

2616 
	`li¡_add
(&
l
->
node_»f_äom
, &
Ãxt_block
->
»f_äom_li¡
);

2618 
	`bŒfsic_block_lšk_hashbË_add
(
l
,

2619 &
¡©e
->
block_lšk_hashbË
);

2621 
l
->
»f_út
++;

2622 
l
->
·»Á_g’”©iÚ
 =…arent_generation;

2623 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2624 
	`bŒfsic_´št_add_lšk
(
¡©e
, 
l
);

2627  
l
;

2628 
	}
}

2630 
bŒfsic_block
 *
	$bŒfsic_block_lookup_Ü_add
(

2631 
bŒfsic_¡©e
 *
¡©e
,

2632 
bŒfsic_block_d©a_ùx
 *
block_ùx
,

2633 cÚ¡ *
add™iÚ®_¡ršg
,

2634 
is_m‘ad©a
,

2635 
is_iodÚe
,

2636 
Ãv”_wr™‹n
,

2637 
mœrÜ_num
,

2638 *
was_ü—‹d
)

2640 
bŒfsic_block
 *
block
;

2642 
block
 = 
	`bŒfsic_block_hashbË_lookup
(
block_ùx
->
dev
->
bdev
,

2643 
block_ùx
->
dev_by‹Ä
,

2644 &
¡©e
->
block_hashbË
);

2645 ià(
NULL
 =ð
block
) {

2646 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

2648 
block
 = 
	`bŒfsic_block_®loc
();

2649 ià(
NULL
 =ð
block
) {

2650 
	`´_šfo
("btrfsic:ƒrror, kmalloc failed!\n");

2651  
NULL
;

2653 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
block_ùx
->
dev
->
bdev
->
bd_dev
);

2654 ià(
NULL
 =ð
dev_¡©e
) {

2655 
	`´_šfo
("btrfsic:ƒrror,†ookup dev_state failed!\n");

2656 
	`bŒfsic_block_ä“
(
block
);

2657  
NULL
;

2659 
block
->
dev_¡©e
 = dev_state;

2660 
block
->
dev_by‹Ä
 = 
block_ùx
->dev_bytenr;

2661 
block
->
logiÿl_by‹Ä
 = 
block_ùx
->
¡¬t
;

2662 
block
->
is_m‘ad©a
 = is_metadata;

2663 
block
->
is_iodÚe
 = is_iodone;

2664 
block
->
Ãv”_wr™‹n
 =‚ever_written;

2665 
block
->
mœrÜ_num
 = mirror_num;

2666 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

2667 
	`´_šfo
("New %s%c-block @%llu (%s/%llu/%d)\n",

2668 
add™iÚ®_¡ršg
,

2669 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
block
),

2670 
block
->
logiÿl_by‹Ä
, 
dev_¡©e
->
Çme
,

2671 
block
->
dev_by‹Ä
, 
mœrÜ_num
);

2672 
	`li¡_add
(&
block
->
®l_blocks_node
, &
¡©e
->
®l_blocks_li¡
);

2673 
	`bŒfsic_block_hashbË_add
(
block
, &
¡©e
->
block_hashbË
);

2674 ià(
NULL
 !ð
was_ü—‹d
)

2675 *
was_ü—‹d
 = 1;

2677 ià(
NULL
 !ð
was_ü—‹d
)

2678 *
was_ü—‹d
 = 0;

2681  
block
;

2682 
	}
}

2684 
	$bŒfsic_cmp_log_ªd_dev_by‹Ä
(
bŒfsic_¡©e
 *
¡©e
,

2685 
u64
 
by‹Ä
,

2686 
bŒfsic_dev_¡©e
 *
dev_¡©e
,

2687 
u64
 
dev_by‹Ä
)

2689 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¡©e
->fs_info;

2690 
bŒfsic_block_d©a_ùx
 
block_ùx
;

2691 
num_cÝ›s
;

2692 
mœrÜ_num
;

2693 
m©ch
 = 0;

2694 
»t
;

2696 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
by‹Ä
, 
¡©e
->
m‘ablock_size
);

2698 
mœrÜ_num
 = 1; mœrÜ_num <ð
num_cÝ›s
; mirror_num++) {

2699 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
by‹Ä
, s‹->
m‘ablock_size
,

2700 &
block_ùx
, 
mœrÜ_num
);

2701 ià(
»t
) {

2702 
	`´_šfo
("btrfsic: btrfsic_map_block(logical @%llu, mirror %d) failed!\n",

2703 
by‹Ä
, 
mœrÜ_num
);

2707 ià(
dev_¡©e
->
bdev
 =ð
block_ùx
.
dev
->bdev &&

2708 
dev_by‹Ä
 =ð
block_ùx
.dev_bytenr) {

2709 
m©ch
++;

2710 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2713 
	`bŒfsic_»Ëa£_block_ùx
(&
block_ùx
);

2716 ià(
	`WARN_ON
(!
m©ch
)) {

2717 
	`´_šfo
("btrfs:‡ttempto write M-block which contains†ogical bytenrhat doesn't mapo dev+physical bytenr of submit_bio, buffer->log_bytenr=%llu, submit_bio(bdev=%s,…hys_bytenr=%llu)!\n",

2718 
by‹Ä
, 
dev_¡©e
->
Çme
, 
dev_by‹Ä
);

2719 
mœrÜ_num
 = 1; mœrÜ_num <ð
num_cÝ›s
; mirror_num++) {

2720 
»t
 = 
	`bŒfsic_m­_block
(
¡©e
, 
by‹Ä
,

2721 
¡©e
->
m‘ablock_size
,

2722 &
block_ùx
, 
mœrÜ_num
);

2723 ià(
»t
)

2726 
	`´_šfo
("Read†ogical bytenr @%llu mapso (%s/%llu/%d)\n",

2727 
by‹Ä
, 
block_ùx
.
dev
->
Çme
,

2728 
block_ùx
.
dev_by‹Ä
, 
mœrÜ_num
);

2731 
	}
}

2733 
bŒfsic_dev_¡©e
 *
	$bŒfsic_dev_¡©e_lookup
(
dev_t
 
dev
)

2735  
	`bŒfsic_dev_¡©e_hashbË_lookup
(
dev
,

2736 &
bŒfsic_dev_¡©e_hashbË
);

2737 
	}
}

2739 
	$bŒfsic_subm™_bh
(
Ý
, 
Ý_æags
, 
bufãr_h—d
 *
bh
)

2741 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

2743 ià(!
bŒfsic_is_š™Ÿlized
)

2744  
	`subm™_bh
(
Ý
, 
Ý_æags
, 
bh
);

2746 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2749 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
bh
->
b_bdev
->
bd_dev
);

2752 ià(
NULL
 !ð
dev_¡©e
 &&

2753 (
Ý
 =ð
REQ_OP_WRITE
è&& 
bh
->
b_size
 > 0) {

2754 
u64
 
dev_by‹Ä
;

2756 
dev_by‹Ä
 = 
BTRFS_BDEV_BLOCKSIZE
 * 
bh
->
b_blockÄ
;

2757 ià(
dev_¡©e
->
¡©e
->
´št_mask
 &

2758 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2759 
	`´_šfo
("submit_bh(op=0x%x,0x%x, blocknr=%llu (bytenr %llu), size=%zu, data=%p, bdev=%p)\n",

2760 
Ý
, 
Ý_æags
, ()
bh
->
b_blockÄ
,

2761 
dev_by‹Ä
, 
bh
->
b_size
, bh->
b_d©a
, bh->
b_bdev
);

2762 
	`bŒfsic_´oûss_wr™‹n_block
(
dev_¡©e
, 
dev_by‹Ä
,

2763 &
bh
->
b_d©a
, 1, 
NULL
,

2764 
NULL
, 
bh
, 
Ý_æags
);

2765 } ià(
NULL
 !ð
dev_¡©e
 && (
Ý_æags
 & 
REQ_PREFLUSH
)) {

2766 ià(
dev_¡©e
->
¡©e
->
´št_mask
 &

2767 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2768 
	`´_šfo
("submit_bh(op=0x%x,0x%x FLUSH, bdev=%p)\n",

2769 
Ý
, 
Ý_æags
, 
bh
->
b_bdev
);

2770 ià(!
dev_¡©e
->
dummy_block_fÜ_bio_bh_æush
.
is_iodÚe
) {

2771 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2772 (
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 |

2773 
BTRFSIC_PRINT_MASK_VERBOSE
)))

2774 
	`´_šfo
("btrfsic_submit_bh(%s) with FLUSH but dummy block‡lready in use (ignored)!\n",

2775 
dev_¡©e
->
Çme
);

2777 
bŒfsic_block
 *cÚ¡ 
block
 =

2778 &
dev_¡©e
->
dummy_block_fÜ_bio_bh_æush
;

2780 
block
->
is_iodÚe
 = 0;

2781 
block
->
Ãv”_wr™‹n
 = 0;

2782 
block
->
iodÚe_w_”rÜ
 = 0;

2783 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

2784 
block
->
subm™_bio_bh_rw
 = 
Ý_æags
;

2785 
block
->
Üig_bio_bh_´iv©e
 = 
bh
->
b_´iv©e
;

2786 
block
->
Üig_bio_bh_’d_io
.
bh
 = bh->
b_’d_io
;

2787 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2788 
bh
->
b_´iv©e
 = 
block
;

2789 
bh
->
b_’d_io
 = 
bŒfsic_bh_’d_io
;

2792 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2793  
	`subm™_bh
(
Ý
, 
Ý_æags
, 
bh
);

2794 
	}
}

2796 
	$__bŒfsic_subm™_bio
(
bio
 *bio)

2798 
bŒfsic_dev_¡©e
 *
dev_¡©e
;

2800 ià(!
bŒfsic_is_š™Ÿlized
)

2803 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2806 
dev_¡©e
 = 
	`bŒfsic_dev_¡©e_lookup
(
	`bio_dev
(
bio
));

2807 ià(
NULL
 !ð
dev_¡©e
 &&

2808 (
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
è&& 
	`bio_has_d©a
(bio)) {

2809 
i
 = 0;

2810 
u64
 
dev_by‹Ä
;

2811 
u64
 
cur_by‹Ä
;

2812 
bio_vec
 
bvec
;

2813 
bvec_™”
 
™”
;

2814 
bio_is_·tched
;

2815 **
m­³d_d©av
;

2816 
£gs
 = 
	`bio_£gm’ts
(
bio
);

2818 
dev_by‹Ä
 = 512 * 
bio
->
bi_™”
.
bi_£ùÜ
;

2819 
bio_is_·tched
 = 0;

2820 ià(
dev_¡©e
->
¡©e
->
´št_mask
 &

2821 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2822 
	`´_šfo
("submit_bio(rw=%d,0x%x, bi_vcnt=%u, bi_sector=%llu (bytenr %llu), bi_disk=%p)\n",

2823 
	`bio_Ý
(
bio
), bio->
bi_Ýf
, 
£gs
,

2824 ()
bio
->
bi_™”
.
bi_£ùÜ
,

2825 
dev_by‹Ä
, 
bio
->
bi_disk
);

2827 
m­³d_d©av
 = 
	`km®loc_¬¿y
(
£gs
,

2828 (*
m­³d_d©av
), 
GFP_NOFS
);

2829 ià(!
m­³d_d©av
)

2830 
Ëave
;

2831 
cur_by‹Ä
 = 
dev_by‹Ä
;

2833 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

2834 
	`BUG_ON
(
bvec
.
bv_Ën
 !ð
PAGE_SIZE
);

2835 
m­³d_d©av
[
i
] = 
	`km­
(
bvec
.
bv_·ge
);

2836 
i
++;

2838 ià(
dev_¡©e
->
¡©e
->
´št_mask
 &

2839 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
)

2840 
	`´_šfo
("#%u: bytenr=%llu,†en=%u, offset=%u\n",

2841 
i
, 
cur_by‹Ä
, 
bvec
.
bv_Ën
, bvec.
bv_off£t
);

2842 
cur_by‹Ä
 +ð
bvec
.
bv_Ën
;

2844 
	`bŒfsic_´oûss_wr™‹n_block
(
dev_¡©e
, 
dev_by‹Ä
,

2845 
m­³d_d©av
, 
£gs
,

2846 
bio
, &
bio_is_·tched
,

2847 
NULL
, 
bio
->
bi_Ýf
);

2848 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
)

2849 
	`kunm­
(
bvec
.
bv_·ge
);

2850 
	`kä“
(
m­³d_d©av
);

2851 } ià(
NULL
 !ð
dev_¡©e
 && (
bio
->
bi_Ýf
 & 
REQ_PREFLUSH
)) {

2852 ià(
dev_¡©e
->
¡©e
->
´št_mask
 &

2853 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
)

2854 
	`´_šfo
("submit_bio(rw=%d,0x%x FLUSH, disk=%p)\n",

2855 
	`bio_Ý
(
bio
), bio->
bi_Ýf
, bio->
bi_disk
);

2856 ià(!
dev_¡©e
->
dummy_block_fÜ_bio_bh_æush
.
is_iodÚe
) {

2857 ià((
dev_¡©e
->
¡©e
->
´št_mask
 &

2858 (
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 |

2859 
BTRFSIC_PRINT_MASK_VERBOSE
)))

2860 
	`´_šfo
("btrfsic_submit_bio(%s) with FLUSH but dummy block‡lready in use (ignored)!\n",

2861 
dev_¡©e
->
Çme
);

2863 
bŒfsic_block
 *cÚ¡ 
block
 =

2864 &
dev_¡©e
->
dummy_block_fÜ_bio_bh_æush
;

2866 
block
->
is_iodÚe
 = 0;

2867 
block
->
Ãv”_wr™‹n
 = 0;

2868 
block
->
iodÚe_w_”rÜ
 = 0;

2869 
block
->
æush_g’
 = 
dev_¡©e
->
Ï¡_æush_g’
 + 1;

2870 
block
->
subm™_bio_bh_rw
 = 
bio
->
bi_Ýf
;

2871 
block
->
Üig_bio_bh_´iv©e
 = 
bio
->
bi_´iv©e
;

2872 
block
->
Üig_bio_bh_’d_io
.
bio
 = bio->
bi_’d_io
;

2873 
block
->
Ãxt_š_§me_bio
 = 
NULL
;

2874 
bio
->
bi_´iv©e
 = 
block
;

2875 
bio
->
bi_’d_io
 = 
bŒfsic_bio_’d_io
;

2878 
Ëave
:

2879 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2880 
	}
}

2882 
	$bŒfsic_subm™_bio
(
bio
 *bio)

2884 
	`__bŒfsic_subm™_bio
(
bio
);

2885 
	`subm™_bio
(
bio
);

2886 
	}
}

2888 
	$bŒfsic_subm™_bio_wa™
(
bio
 *bio)

2890 
	`__bŒfsic_subm™_bio
(
bio
);

2891  
	`subm™_bio_wa™
(
bio
);

2892 
	}
}

2894 
	$bŒfsic_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
,

2895 
bŒfs_fs_deviûs
 *
fs_deviûs
,

2896 
šþudšg_ex‹Á_d©a
, 
u32
 
´št_mask
)

2898 
»t
;

2899 
bŒfsic_¡©e
 *
¡©e
;

2900 
li¡_h—d
 *
dev_h—d
 = &
fs_deviûs
->
deviûs
;

2901 
bŒfs_deviû
 *
deviû
;

2903 ià(
fs_šfo
->
nodesize
 & ((
u64
)
PAGE_SIZE
 - 1)) {

2904 
	`´_šfo
("btrfsic: cannot handle‚odesize %d‚ot being‡ multiple of PAGE_SIZE %ld!\n",

2905 
fs_šfo
->
nodesize
, 
PAGE_SIZE
);

2908 ià(
fs_šfo
->
£ùÜsize
 & ((
u64
)
PAGE_SIZE
 - 1)) {

2909 
	`´_šfo
("btrfsic: cannot handle sectorsize %d‚ot being‡ multiple of PAGE_SIZE %ld!\n",

2910 
fs_šfo
->
£ùÜsize
, 
PAGE_SIZE
);

2913 
¡©e
 = 
	`kvz®loc
((*¡©e), 
GFP_KERNEL
);

2914 ià(!
¡©e
) {

2915 
	`´_šfo
("btrfs check-integrity:‡llocation failed!\n");

2919 ià(!
bŒfsic_is_š™Ÿlized
) {

2920 
	`mu‹x_š™
(&
bŒfsic_mu‹x
);

2921 
	`bŒfsic_dev_¡©e_hashbË_š™
(&
bŒfsic_dev_¡©e_hashbË
);

2922 
bŒfsic_is_š™Ÿlized
 = 1;

2924 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2925 
¡©e
->
fs_šfo
 = fs_info;

2926 
¡©e
->
´št_mask
 =…rint_mask;

2927 
¡©e
->
šþude_ex‹Á_d©a
 = 
šþudšg_ex‹Á_d©a
;

2928 
¡©e
->
csum_size
 = 0;

2929 
¡©e
->
m‘ablock_size
 = 
fs_šfo
->
nodesize
;

2930 
¡©e
->
d©ablock_size
 = 
fs_šfo
->
£ùÜsize
;

2931 
	`INIT_LIST_HEAD
(&
¡©e
->
®l_blocks_li¡
);

2932 
	`bŒfsic_block_hashbË_š™
(&
¡©e
->
block_hashbË
);

2933 
	`bŒfsic_block_lšk_hashbË_š™
(&
¡©e
->
block_lšk_hashbË
);

2934 
¡©e
->
max_su³rblock_g’”©iÚ
 = 0;

2935 
¡©e
->
Ï‹¡_su³rblock
 = 
NULL
;

2937 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
dev_h—d
, 
dev_li¡
) {

2938 
bŒfsic_dev_¡©e
 *
ds
;

2939 cÚ¡ *
p
;

2941 ià(!
deviû
->
bdev
 || !deviû->
Çme
)

2944 
ds
 = 
	`bŒfsic_dev_¡©e_®loc
();

2945 ià(
NULL
 =ð
ds
) {

2946 
	`´_šfo
("btrfs check-integrity: kmalloc() failed!\n");

2947 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2950 
ds
->
bdev
 = 
deviû
->bdev;

2951 
ds
->
¡©e
 = state;

2952 
	`bdevÇme
(
ds
->
bdev
, ds->
Çme
);

2953 
ds
->
Çme
[
BDEVNAME_SIZE
 - 1] = '\0';

2954 
p
 = 
	`kba£Çme
(
ds
->
Çme
);

2955 
	`¡¾ýy
(
ds
->
Çme
, 
p
, (ds->name));

2956 
	`bŒfsic_dev_¡©e_hashbË_add
(
ds
,

2957 &
bŒfsic_dev_¡©e_hashbË
);

2960 
»t
 = 
	`bŒfsic_´oûss_su³rblock
(
¡©e
, 
fs_deviûs
);

2961 ià(0 !ð
»t
) {

2962 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2963 
	`bŒfsic_unmouÁ
(
fs_deviûs
);

2964  
»t
;

2967 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_DATABASE
)

2968 
	`bŒfsic_dump_d©aba£
(
¡©e
);

2969 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_INITIAL_TREE
)

2970 
	`bŒfsic_dump_Œ“
(
¡©e
);

2972 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

2974 
	}
}

2976 
	$bŒfsic_unmouÁ
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

2978 
bŒfsic_block
 *
b_®l
, *
tmp_®l
;

2979 
bŒfsic_¡©e
 *
¡©e
;

2980 
li¡_h—d
 *
dev_h—d
 = &
fs_deviûs
->
deviûs
;

2981 
bŒfs_deviû
 *
deviû
;

2983 ià(!
bŒfsic_is_š™Ÿlized
)

2986 
	`mu‹x_lock
(&
bŒfsic_mu‹x
);

2988 
¡©e
 = 
NULL
;

2989 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
dev_h—d
, 
dev_li¡
) {

2990 
bŒfsic_dev_¡©e
 *
ds
;

2992 ià(!
deviû
->
bdev
 || !deviû->
Çme
)

2995 
ds
 = 
	`bŒfsic_dev_¡©e_hashbË_lookup
(

2996 
deviû
->
bdev
->
bd_dev
,

2997 &
bŒfsic_dev_¡©e_hashbË
);

2998 ià(
NULL
 !ð
ds
) {

2999 
¡©e
 = 
ds
->state;

3000 
	`bŒfsic_dev_¡©e_hashbË_»move
(
ds
);

3001 
	`bŒfsic_dev_¡©e_ä“
(
ds
);

3005 ià(
NULL
 =ð
¡©e
) {

3006 
	`´_šfo
("btrfsic:ƒrror, cannot find state information on umount!\n");

3007 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

3016 
	`li¡_fÜ_—ch_’Œy_§ã
(
b_®l
, 
tmp_®l
, &
¡©e
->
®l_blocks_li¡
,

3017 
®l_blocks_node
) {

3018 
bŒfsic_block_lšk
 *
l
, *
tmp
;

3020 
	`li¡_fÜ_—ch_’Œy_§ã
(
l
, 
tmp
, &
b_®l
->
»f_to_li¡
,

3021 
node_»f_to
) {

3022 ià(
¡©e
->
´št_mask
 & 
BTRFSIC_PRINT_MASK_VERBOSE
)

3023 
	`bŒfsic_´št_»m_lšk
(
¡©e
, 
l
);

3025 
l
->
»f_út
--;

3026 ià(0 =ð
l
->
»f_út
)

3027 
	`bŒfsic_block_lšk_ä“
(
l
);

3030 ià(
b_®l
->
is_iodÚe
 || b_®l->
Ãv”_wr™‹n
)

3031 
	`bŒfsic_block_ä“
(
b_®l
);

3033 
	`´_šfo
("btrfs:‡ttempto free %c-block @%llu (%s/%llu/%d) on umount which is‚ot yet iodone!\n",

3034 
	`bŒfsic_g‘_block_ty³
(
¡©e
, 
b_®l
),

3035 
b_®l
->
logiÿl_by‹Ä
, b_®l->
dev_¡©e
->
Çme
,

3036 
b_®l
->
dev_by‹Ä
, b_®l->
mœrÜ_num
);

3039 
	`mu‹x_uÆock
(&
bŒfsic_mu‹x
);

3041 
	`kvä“
(
¡©e
);

3042 
	}
}

	@check-integrity.h

19 #ià!
defšed
(
__BTRFS_CHECK_INTEGRITY__
)

20 
	#__BTRFS_CHECK_INTEGRITY__


	)

22 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


23 
bŒfsic_subm™_bh
(
Ý
, 
Ý_æags
, 
bufãr_h—d
 *
bh
);

24 
bŒfsic_subm™_bio
(
bio
 *bio);

25 
bŒfsic_subm™_bio_wa™
(
bio
 *bio);

27 
	#bŒfsic_subm™_bh
 
subm™_bh


	)

28 
	#bŒfsic_subm™_bio
 
subm™_bio


	)

29 
	#bŒfsic_subm™_bio_wa™
 
subm™_bio_wa™


	)

32 
bŒfsic_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
,

33 
bŒfs_fs_deviûs
 *
fs_deviûs
,

34 
šþudšg_ex‹Á_d©a
, 
u32
 
´št_mask
);

35 
bŒfsic_unmouÁ
(
bŒfs_fs_deviûs
 *
fs_deviûs
);

	@compression.c

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/bio.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/fže.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/·gem­.h
>

25 
	~<lšux/highmem.h
>

26 
	~<lšux/time.h
>

27 
	~<lšux/š™.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/backšg-dev.h
>

30 
	~<lšux/m·ge.h
>

31 
	~<lšux/sw­.h
>

32 
	~<lšux/wr™eback.h
>

33 
	~<lšux/b™_¥šlock.h
>

34 
	~<lšux/¦ab.h
>

35 
	~<lšux/sched/mm.h
>

36 
	~"ù»e.h
"

37 
	~"disk-io.h
"

38 
	~"Œª§ùiÚ.h
"

39 
	~"bŒfs_šode.h
"

40 
	~"vÞumes.h
"

41 
	~"Üd”ed-d©a.h
"

42 
	~"com´essiÚ.h
"

43 
	~"ex‹Á_io.h
"

44 
	~"ex‹Á_m­.h
"

46 
bŒfs_decom´ess_bio
(
com´es£d_bio
 *
cb
);

48 
šlše
 
	$com´es£d_bio_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

49 
disk_size
)

51 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

53  (
com´es£d_bio
) +

54 (
	`DIV_ROUND_UP
(
disk_size
, 
fs_šfo
->
£ùÜsize
)è* 
csum_size
;

55 
	}
}

57 
	$check_com´es£d_csum
(
bŒfs_šode
 *
šode
,

58 
com´es£d_bio
 *
cb
,

59 
u64
 
disk_¡¬t
)

61 
»t
;

62 
·ge
 *page;

63 
i
;

64 *
kaddr
;

65 
u32
 
csum
;

66 
u32
 *
cb_sum
 = &
cb
->
sums
;

68 ià(
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
)

71 
i
 = 0; i < 
cb
->
Ä_·ges
; i++) {

72 
·ge
 = 
cb
->
com´es£d_·ges
[
i
];

73 
csum
 = ~(
u32
)0;

75 
kaddr
 = 
	`km­_©omic
(
·ge
);

76 
csum
 = 
	`bŒfs_csum_d©a
(
kaddr
, csum, 
PAGE_SIZE
);

77 
	`bŒfs_csum_fš®
(
csum
, (
u8
 *)&csum);

78 
	`kunm­_©omic
(
kaddr
);

80 ià(
csum
 !ð*
cb_sum
) {

81 
	`bŒfs_´št_d©a_csum_”rÜ
(
šode
, 
disk_¡¬t
, 
csum
,

82 *
cb_sum
, 
cb
->
mœrÜ_num
);

83 
»t
 = -
EIO
;

84 
çž
;

86 
cb_sum
++;

89 
»t
 = 0;

90 
çž
:

91  
»t
;

92 
	}
}

104 
	$’d_com´es£d_bio_»ad
(
bio
 *bio)

106 
com´es£d_bio
 *
cb
 = 
bio
->
bi_´iv©e
;

107 
šode
 *inode;

108 
·ge
 *page;

109 
šdex
;

110 
mœrÜ
 = 
	`bŒfs_io_bio
(
bio
)->
mœrÜ_num
;

111 
»t
 = 0;

113 ià(
bio
->
bi_¡©us
)

114 
cb
->
”rÜs
 = 1;

119 ià(!
	`»fcouÁ_dec_ªd_‹¡
(&
cb
->
³ndšg_bios
))

120 
out
;

126 
	`ASSERT
(
	`bŒfs_io_bio
(
cb
->
Üig_bio
));

127 
	`bŒfs_io_bio
(
cb
->
Üig_bio
)->
mœrÜ_num
 = 
mœrÜ
;

128 
cb
->
mœrÜ_num
 = 
mœrÜ
;

134 ià(
cb
->
”rÜs
 == 1)

135 
csum_çžed
;

137 
šode
 = 
cb
->inode;

138 
»t
 = 
	`check_com´es£d_csum
(
	`BTRFS_I
(
šode
), 
cb
,

139 (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
 << 9);

140 ià(
»t
)

141 
csum_çžed
;

146 
»t
 = 
	`bŒfs_decom´ess_bio
(
cb
);

148 
csum_çžed
:

149 ià(
»t
)

150 
cb
->
”rÜs
 = 1;

153 
šdex
 = 0;

154 
šdex
 = 0; index < 
cb
->
Ä_·ges
; index++) {

155 
·ge
 = 
cb
->
com´es£d_·ges
[
šdex
];

156 
·ge
->
m­pšg
 = 
NULL
;

157 
	`put_·ge
(
·ge
);

161 ià(
cb
->
”rÜs
) {

162 
	`bio_io_”rÜ
(
cb
->
Üig_bio
);

164 
i
;

165 
bio_vec
 *
bvec
;

171 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

172 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
cb
->
Üig_bio
, 
i
)

173 
	`S‘PageChecked
(
bvec
->
bv_·ge
);

175 
	`bio_’dio
(
cb
->
Üig_bio
);

179 
	`kä“
(
cb
->
com´es£d_·ges
);

180 
	`kä“
(
cb
);

181 
out
:

182 
	`bio_put
(
bio
);

183 
	}
}

189 
nošlše
 
	$’d_com´es£d_wr™eback
(
šode
 *inode,

190 cÚ¡ 
com´es£d_bio
 *
cb
)

192 
šdex
 = 
cb
->
¡¬t
 >> 
PAGE_SHIFT
;

193 
’d_šdex
 = (
cb
->
¡¬t
 + cb->
Ën
 - 1è>> 
PAGE_SHIFT
;

194 
·ge
 *
·ges
[16];

195 
Ä_·ges
 = 
’d_šdex
 - 
šdex
 + 1;

196 
i
;

197 
»t
;

199 ià(
cb
->
”rÜs
)

200 
	`m­pšg_£t_”rÜ
(
šode
->
i_m­pšg
, -
EIO
);

202 
Ä_·ges
 > 0) {

203 
»t
 = 
	`fšd_g‘_·ges_cÚtig
(
šode
->
i_m­pšg
, 
šdex
,

204 
	`mš_t
(,

205 
Ä_·ges
, 
	`ARRAY_SIZE
(
·ges
)),…ages);

206 ià(
»t
 == 0) {

207 
Ä_·ges
 -= 1;

208 
šdex
 += 1;

211 
i
 = 0; i < 
»t
; i++) {

212 ià(
cb
->
”rÜs
)

213 
	`S‘PageE¼Ü
(
·ges
[
i
]);

214 
	`’d_·ge_wr™eback
(
·ges
[
i
]);

215 
	`put_·ge
(
·ges
[
i
]);

217 
Ä_·ges
 -ð
»t
;

218 
šdex
 +ð
»t
;

221 
	}
}

231 
	$’d_com´es£d_bio_wr™e
(
bio
 *bio)

233 
ex‹Á_io_Œ“
 *
Œ“
;

234 
com´es£d_bio
 *
cb
 = 
bio
->
bi_´iv©e
;

235 
šode
 *inode;

236 
·ge
 *page;

237 
šdex
;

239 ià(
bio
->
bi_¡©us
)

240 
cb
->
”rÜs
 = 1;

245 ià(!
	`»fcouÁ_dec_ªd_‹¡
(&
cb
->
³ndšg_bios
))

246 
out
;

251 
šode
 = 
cb
->inode;

252 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

253 
cb
->
com´es£d_·ges
[0]->
m­pšg
 = cb->
šode
->
i_m­pšg
;

254 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
cb
->
com´es£d_·ges
[0],

255 
cb
->
¡¬t
,

256 
cb
->
¡¬t
 + cb->
Ën
 - 1,

257 
NULL
,

258 
bio
->
bi_¡©us
 ? 0 : 1);

259 
cb
->
com´es£d_·ges
[0]->
m­pšg
 = 
NULL
;

261 
	`’d_com´es£d_wr™eback
(
šode
, 
cb
);

268 
šdex
 = 0;

269 
šdex
 = 0; index < 
cb
->
Ä_·ges
; index++) {

270 
·ge
 = 
cb
->
com´es£d_·ges
[
šdex
];

271 
·ge
->
m­pšg
 = 
NULL
;

272 
	`put_·ge
(
·ge
);

276 
	`kä“
(
cb
->
com´es£d_·ges
);

277 
	`kä“
(
cb
);

278 
out
:

279 
	`bio_put
(
bio
);

280 
	}
}

291 
blk_¡©us_t
 
	$bŒfs_subm™_com´es£d_wr™e
(
šode
 *šode, 
u64
 
¡¬t
,

292 
Ën
, 
u64
 
disk_¡¬t
,

293 
com´es£d_Ën
,

294 
·ge
 **
com´es£d_·ges
,

295 
Ä_·ges
)

297 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

298 
bio
 *biØð
NULL
;

299 
com´es£d_bio
 *
cb
;

300 
by‹s_Ëá
;

301 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

302 
pg_šdex
 = 0;

303 
·ge
 *page;

304 
u64
 
fœ¡_by‹
 = 
disk_¡¬t
;

305 
block_deviû
 *
bdev
;

306 
blk_¡©us_t
 
»t
;

307 
sk_sum
 = 
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
;

309 
	`WARN_ON
(
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1));

310 
cb
 = 
	`km®loc
(
	`com´es£d_bio_size
(
fs_šfo
, 
com´es£d_Ën
), 
GFP_NOFS
);

311 ià(!
cb
)

312  
BLK_STS_RESOURCE
;

313 
	`»fcouÁ_£t
(&
cb
->
³ndšg_bios
, 0);

314 
cb
->
”rÜs
 = 0;

315 
cb
->
šode
 = inode;

316 
cb
->
¡¬t
 = start;

317 
cb
->
Ën
 =†en;

318 
cb
->
mœrÜ_num
 = 0;

319 
cb
->
com´es£d_·ges
 = compressed_pages;

320 
cb
->
com´es£d_Ën
 = compressed_len;

321 
cb
->
Üig_bio
 = 
NULL
;

322 
cb
->
Ä_·ges
 =‚r_pages;

324 
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

326 
bio
 = 
	`bŒfs_bio_®loc
(
bdev
, 
fœ¡_by‹
);

327 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

328 
bio
->
bi_´iv©e
 = 
cb
;

329 
bio
->
bi_’d_io
 = 
’d_com´es£d_bio_wr™e
;

330 
	`»fcouÁ_£t
(&
cb
->
³ndšg_bios
, 1);

333 
by‹s_Ëá
 = 
com´es£d_Ën
;

334 
pg_šdex
 = 0;…g_šdex < 
cb
->
Ä_·ges
;…g_index++) {

335 
subm™
 = 0;

337 
·ge
 = 
com´es£d_·ges
[
pg_šdex
];

338 
·ge
->
m­pšg
 = 
šode
->
i_m­pšg
;

339 ià(
bio
->
bi_™”
.
bi_size
)

340 
subm™
 = 
io_Œ“
->
Ýs
->
	`m”ge_bio_hook
(
·ge
, 0,

341 
PAGE_SIZE
,

342 
bio
, 0);

344 
·ge
->
m­pšg
 = 
NULL
;

345 ià(
subm™
 || 
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0) <

346 
PAGE_SIZE
) {

347 
	`bio_g‘
(
bio
);

355 
	`»fcouÁ_šc
(&
cb
->
³ndšg_bios
);

356 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
bio
,

357 
BTRFS_WQ_ENDIO_DATA
);

358 
	`BUG_ON
(
»t
);

360 ià(!
sk_sum
) {

361 
»t
 = 
	`bŒfs_csum_Úe_bio
(
šode
, 
bio
, 
¡¬t
, 1);

362 
	`BUG_ON
(
»t
);

365 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 0, 1);

366 ià(
»t
) {

367 
bio
->
bi_¡©us
 = 
»t
;

368 
	`bio_’dio
(
bio
);

371 
	`bio_put
(
bio
);

373 
bio
 = 
	`bŒfs_bio_®loc
(
bdev
, 
fœ¡_by‹
);

374 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

375 
bio
->
bi_´iv©e
 = 
cb
;

376 
bio
->
bi_’d_io
 = 
’d_com´es£d_bio_wr™e
;

377 
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0);

379 ià(
by‹s_Ëá
 < 
PAGE_SIZE
) {

380 
	`bŒfs_šfo
(
fs_šfo
,

382 
by‹s_Ëá
, 
cb
->
com´es£d_Ën
, cb->
Ä_·ges
);

384 
by‹s_Ëá
 -ð
PAGE_SIZE
;

385 
fœ¡_by‹
 +ð
PAGE_SIZE
;

386 
	`cÚd_»sched
();

388 
	`bio_g‘
(
bio
);

390 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
bio
, 
BTRFS_WQ_ENDIO_DATA
);

391 
	`BUG_ON
(
»t
);

393 ià(!
sk_sum
) {

394 
»t
 = 
	`bŒfs_csum_Úe_bio
(
šode
, 
bio
, 
¡¬t
, 1);

395 
	`BUG_ON
(
»t
);

398 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 0, 1);

399 ià(
»t
) {

400 
bio
->
bi_¡©us
 = 
»t
;

401 
	`bio_’dio
(
bio
);

404 
	`bio_put
(
bio
);

406 
	}
}

408 
u64
 
	$bio_’d_off£t
(
bio
 *bio)

410 
bio_vec
 *
Ï¡
 = &
bio
->
bi_io_vec
[bio->
bi_vút
 - 1];

412  
	`·ge_off£t
(
Ï¡
->
bv_·ge
è+†a¡->
bv_Ën
 +†a¡->
bv_off£t
;

413 
	}
}

415 
nošlše
 
	$add_¿_bio_·ges
(
šode
 *inode,

416 
u64
 
com´es£d_’d
,

417 
com´es£d_bio
 *
cb
)

419 
’d_šdex
;

420 
pg_šdex
;

421 
u64
 
Ï¡_off£t
;

422 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

423 
»t
;

424 
·ge
 *page;

425 
Ä_·ges
 = 0;

426 
ex‹Á_m­
 *
em
;

427 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

428 
ex‹Á_m­_Œ“
 *
em_Œ“
;

429 
ex‹Á_io_Œ“
 *
Œ“
;

430 
u64
 
’d
;

431 
mis£s
 = 0;

433 
Ï¡_off£t
 = 
	`bio_’d_off£t
(
cb
->
Üig_bio
);

434 
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

435 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

437 ià(
isize
 == 0)

440 
’d_šdex
 = (
	`i_size_»ad
(
šode
è- 1è>> 
PAGE_SHIFT
;

442 
Ï¡_off£t
 < 
com´es£d_’d
) {

443 
pg_šdex
 = 
Ï¡_off£t
 >> 
PAGE_SHIFT
;

445 ià(
pg_šdex
 > 
’d_šdex
)

448 
	`rcu_»ad_lock
();

449 
·ge
 = 
	`¿dix_Œ“_lookup
(&
m­pšg
->
·ge_Œ“
, 
pg_šdex
);

450 
	`rcu_»ad_uÆock
();

451 ià(
·ge
 && !
	`¿dix_Œ“_exû±iÚ®_’Œy
(page)) {

452 
mis£s
++;

453 ià(
mis£s
 > 4)

455 
Ãxt
;

458 
·ge
 = 
	`__·ge_ÿche_®loc
(
	`m­pšg_gå_cÚ¡¿št
(
m­pšg
,

459 ~
__GFP_FS
));

460 ià(!
·ge
)

463 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
, 
pg_šdex
, 
GFP_NOFS
)) {

464 
	`put_·ge
(
·ge
);

465 
Ãxt
;

468 
’d
 = 
Ï¡_off£t
 + 
PAGE_SIZE
 - 1;

474 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

475 
	`lock_ex‹Á
(
Œ“
, 
Ï¡_off£t
, 
’d
);

476 
	`»ad_lock
(&
em_Œ“
->
lock
);

477 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
Ï¡_off£t
,

478 
PAGE_SIZE
);

479 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

481 ià(!
em
 || 
Ï¡_off£t
 <ƒm->
¡¬t
 ||

482 (
Ï¡_off£t
 + 
PAGE_SIZE
 > 
	`ex‹Á_m­_’d
(
em
)) ||

483 (
em
->
block_¡¬t
 >> 9è!ð
cb
->
Üig_bio
->
bi_™”
.
bi_£ùÜ
) {

484 
	`ä“_ex‹Á_m­
(
em
);

485 
	`uÆock_ex‹Á
(
Œ“
, 
Ï¡_off£t
, 
’d
);

486 
	`uÆock_·ge
(
·ge
);

487 
	`put_·ge
(
·ge
);

490 
	`ä“_ex‹Á_m­
(
em
);

492 ià(
·ge
->
šdex
 =ð
’d_šdex
) {

493 *
u£½age
;

494 
size_t
 
z”o_off£t
 = 
isize
 & (
PAGE_SIZE
 - 1);

496 ià(
z”o_off£t
) {

497 
z”os
;

498 
z”os
 = 
PAGE_SIZE
 - 
z”o_off£t
;

499 
u£½age
 = 
	`km­_©omic
(
·ge
);

500 
	`mem£t
(
u£½age
 + 
z”o_off£t
, 0, 
z”os
);

501 
	`æush_dÿche_·ge
(
·ge
);

502 
	`kunm­_©omic
(
u£½age
);

506 
»t
 = 
	`bio_add_·ge
(
cb
->
Üig_bio
, 
·ge
,

507 
PAGE_SIZE
, 0);

509 ià(
»t
 =ð
PAGE_SIZE
) {

510 
Ä_·ges
++;

511 
	`put_·ge
(
·ge
);

513 
	`uÆock_ex‹Á
(
Œ“
, 
Ï¡_off£t
, 
’d
);

514 
	`uÆock_·ge
(
·ge
);

515 
	`put_·ge
(
·ge
);

518 
Ãxt
:

519 
Ï¡_off£t
 +ð
PAGE_SIZE
;

522 
	}
}

535 
blk_¡©us_t
 
	$bŒfs_subm™_com´es£d_»ad
(
šode
 *šode, 
bio
 *bio,

536 
mœrÜ_num
, 
bio_æags
)

538 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

539 
ex‹Á_io_Œ“
 *
Œ“
;

540 
ex‹Á_m­_Œ“
 *
em_Œ“
;

541 
com´es£d_bio
 *
cb
;

542 
com´es£d_Ën
;

543 
Ä_·ges
;

544 
pg_šdex
;

545 
·ge
 *page;

546 
block_deviû
 *
bdev
;

547 
bio
 *
comp_bio
;

548 
u64
 
cur_disk_by‹
 = (u64)
bio
->
bi_™”
.
bi_£ùÜ
 << 9;

549 
u64
 
em_Ën
;

550 
u64
 
em_¡¬t
;

551 
ex‹Á_m­
 *
em
;

552 
blk_¡©us_t
 
»t
 = 
BLK_STS_RESOURCE
;

553 
çži
 = 0;

554 
u32
 *
sums
;

556 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

557 
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

560 
	`»ad_lock
(&
em_Œ“
->
lock
);

561 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
,

562 
	`·ge_off£t
(
bio
->
bi_io_vec
->
bv_·ge
),

563 
PAGE_SIZE
);

564 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

565 ià(!
em
)

566  
BLK_STS_IOERR
;

568 
com´es£d_Ën
 = 
em
->
block_Ën
;

569 
cb
 = 
	`km®loc
(
	`com´es£d_bio_size
(
fs_šfo
, 
com´es£d_Ën
), 
GFP_NOFS
);

570 ià(!
cb
)

571 
out
;

573 
	`»fcouÁ_£t
(&
cb
->
³ndšg_bios
, 0);

574 
cb
->
”rÜs
 = 0;

575 
cb
->
šode
 = inode;

576 
cb
->
mœrÜ_num
 = mirror_num;

577 
sums
 = &
cb
->sums;

579 
cb
->
¡¬t
 = 
em
->
Üig_¡¬t
;

580 
em_Ën
 = 
em
->
Ën
;

581 
em_¡¬t
 = 
em
->
¡¬t
;

583 
	`ä“_ex‹Á_m­
(
em
);

584 
em
 = 
NULL
;

586 
cb
->
Ën
 = 
bio
->
bi_™”
.
bi_size
;

587 
cb
->
com´es£d_Ën
 = compressed_len;

588 
cb
->
com´ess_ty³
 = 
	`ex‹Á_com´ess_ty³
(
bio_æags
);

589 
cb
->
Üig_bio
 = 
bio
;

591 
Ä_·ges
 = 
	`DIV_ROUND_UP
(
com´es£d_Ën
, 
PAGE_SIZE
);

592 
cb
->
com´es£d_·ges
 = 
	`kÿÎoc
(
Ä_·ges
, (
·ge
 *),

593 
GFP_NOFS
);

594 ià(!
cb
->
com´es£d_·ges
)

595 
çž1
;

597 
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

599 
pg_šdex
 = 0;…g_šdex < 
Ä_·ges
;…g_index++) {

600 
cb
->
com´es£d_·ges
[
pg_šdex
] = 
	`®loc_·ge
(
GFP_NOFS
 |

601 
__GFP_HIGHMEM
);

602 ià(!
cb
->
com´es£d_·ges
[
pg_šdex
]) {

603 
çži
 = 
pg_šdex
 - 1;

604 
»t
 = 
BLK_STS_RESOURCE
;

605 
çž2
;

608 
çži
 = 
Ä_·ges
 - 1;

609 
cb
->
Ä_·ges
 =‚r_pages;

611 
	`add_¿_bio_·ges
(
šode
, 
em_¡¬t
 + 
em_Ën
, 
cb
);

614 
cb
->
Ën
 = 
bio
->
bi_™”
.
bi_size
;

616 
comp_bio
 = 
	`bŒfs_bio_®loc
(
bdev
, 
cur_disk_by‹
);

617 
	`bio_£t_Ý_©Œs
 (
comp_bio
, 
REQ_OP_READ
, 0);

618 
comp_bio
->
bi_´iv©e
 = 
cb
;

619 
comp_bio
->
bi_’d_io
 = 
’d_com´es£d_bio_»ad
;

620 
	`»fcouÁ_£t
(&
cb
->
³ndšg_bios
, 1);

622 
pg_šdex
 = 0;…g_šdex < 
Ä_·ges
;…g_index++) {

623 
subm™
 = 0;

625 
·ge
 = 
cb
->
com´es£d_·ges
[
pg_šdex
];

626 
·ge
->
m­pšg
 = 
šode
->
i_m­pšg
;

627 
·ge
->
šdex
 = 
em_¡¬t
 >> 
PAGE_SHIFT
;

629 ià(
comp_bio
->
bi_™”
.
bi_size
)

630 
subm™
 = 
Œ“
->
Ýs
->
	`m”ge_bio_hook
(
·ge
, 0,

631 
PAGE_SIZE
,

632 
comp_bio
, 0);

634 
·ge
->
m­pšg
 = 
NULL
;

635 ià(
subm™
 || 
	`bio_add_·ge
(
comp_bio
, 
·ge
, 
PAGE_SIZE
, 0) <

636 
PAGE_SIZE
) {

637 
	`bio_g‘
(
comp_bio
);

639 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
comp_bio
,

640 
BTRFS_WQ_ENDIO_DATA
);

641 
	`BUG_ON
(
»t
);

649 
	`»fcouÁ_šc
(&
cb
->
³ndšg_bios
);

651 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
)) {

652 
»t
 = 
	`bŒfs_lookup_bio_sums
(
šode
, 
comp_bio
,

653 
sums
);

654 
	`BUG_ON
(
»t
);

656 
sums
 +ð
	`DIV_ROUND_UP
(
comp_bio
->
bi_™”
.
bi_size
,

657 
fs_šfo
->
£ùÜsize
);

659 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
comp_bio
, 
mœrÜ_num
, 0);

660 ià(
»t
) {

661 
comp_bio
->
bi_¡©us
 = 
»t
;

662 
	`bio_’dio
(
comp_bio
);

665 
	`bio_put
(
comp_bio
);

667 
comp_bio
 = 
	`bŒfs_bio_®loc
(
bdev
, 
cur_disk_by‹
);

668 
	`bio_£t_Ý_©Œs
(
comp_bio
, 
REQ_OP_READ
, 0);

669 
comp_bio
->
bi_´iv©e
 = 
cb
;

670 
comp_bio
->
bi_’d_io
 = 
’d_com´es£d_bio_»ad
;

672 
	`bio_add_·ge
(
comp_bio
, 
·ge
, 
PAGE_SIZE
, 0);

674 
cur_disk_by‹
 +ð
PAGE_SIZE
;

676 
	`bio_g‘
(
comp_bio
);

678 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
comp_bio
, 
BTRFS_WQ_ENDIO_DATA
);

679 
	`BUG_ON
(
»t
);

681 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
)) {

682 
»t
 = 
	`bŒfs_lookup_bio_sums
(
šode
, 
comp_bio
, 
sums
);

683 
	`BUG_ON
(
»t
);

686 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
comp_bio
, 
mœrÜ_num
, 0);

687 ià(
»t
) {

688 
comp_bio
->
bi_¡©us
 = 
»t
;

689 
	`bio_’dio
(
comp_bio
);

692 
	`bio_put
(
comp_bio
);

695 
çž2
:

696 
çži
 >= 0) {

697 
	`__ä“_·ge
(
cb
->
com´es£d_·ges
[
çži
]);

698 
çži
--;

701 
	`kä“
(
cb
->
com´es£d_·ges
);

702 
çž1
:

703 
	`kä“
(
cb
);

704 
out
:

705 
	`ä“_ex‹Á_m­
(
em
);

706  
»t
;

707 
	}
}

710 
li¡_h—d
 
	midË_ws
;

711 
¥šlock_t
 
	mws_lock
;

713 
	mä“_ws
;

715 
©omic_t
 
	mtÙ®_ws
;

717 
wa™_queue_h—d_t
 
	mws_wa™
;

718 } 
	gbŒfs_comp_ws
[
BTRFS_COMPRESS_TYPES
];

720 cÚ¡ 
bŒfs_com´ess_Ý
 * cÚ¡ 
	gbŒfs_com´ess_Ý
[] = {

721 &
bŒfs_zlib_com´ess
,

722 &
bŒfs_lzo_com´ess
,

723 &
bŒfs_z¡d_com´ess
,

726 
__š™
 
	$bŒfs_š™_com´ess
()

728 
i
;

730 
i
 = 0; i < 
BTRFS_COMPRESS_TYPES
; i++) {

731 
li¡_h—d
 *
wÜk¥aû
;

733 
	`INIT_LIST_HEAD
(&
bŒfs_comp_ws
[
i
].
idË_ws
);

734 
	`¥š_lock_š™
(&
bŒfs_comp_ws
[
i
].
ws_lock
);

735 
	`©omic_£t
(&
bŒfs_comp_ws
[
i
].
tÙ®_ws
, 0);

736 
	`š™_wa™queue_h—d
(&
bŒfs_comp_ws
[
i
].
ws_wa™
);

742 
wÜk¥aû
 = 
bŒfs_com´ess_Ý
[
i
]->
	`®loc_wÜk¥aû
();

743 ià(
	`IS_ERR
(
wÜk¥aû
)) {

744 
	`´_w¬n
("BTRFS: cannot…reallocate compression workspace, willry†ater\n");

746 
	`©omic_£t
(&
bŒfs_comp_ws
[
i
].
tÙ®_ws
, 1);

747 
bŒfs_comp_ws
[
i
].
ä“_ws
 = 1;

748 
	`li¡_add
(
wÜk¥aû
, &
bŒfs_comp_ws
[
i
].
idË_ws
);

751 
	}
}

759 
li¡_h—d
 *
	$fšd_wÜk¥aû
(
ty³
)

761 
li¡_h—d
 *
wÜk¥aû
;

762 
ýus
 = 
	`num_Úlše_ýus
();

763 
idx
 = 
ty³
 - 1;

764 
nofs_æag
;

766 
li¡_h—d
 *
idË_ws
 = &
bŒfs_comp_ws
[
idx
].idle_ws;

767 
¥šlock_t
 *
ws_lock
 = &
bŒfs_comp_ws
[
idx
].ws_lock;

768 
©omic_t
 *
tÙ®_ws
 = &
bŒfs_comp_ws
[
idx
].total_ws;

769 
wa™_queue_h—d_t
 *
ws_wa™
 = &
bŒfs_comp_ws
[
idx
].ws_wait;

770 *
ä“_ws
 = &
bŒfs_comp_ws
[
idx
].free_ws;

771 
agaš
:

772 
	`¥š_lock
(
ws_lock
);

773 ià(!
	`li¡_em±y
(
idË_ws
)) {

774 
wÜk¥aû
 = 
idË_ws
->
Ãxt
;

775 
	`li¡_d–
(
wÜk¥aû
);

776 (*
ä“_ws
)--;

777 
	`¥š_uÆock
(
ws_lock
);

778  
wÜk¥aû
;

781 ià(
	`©omic_»ad
(
tÙ®_ws
è> 
ýus
) {

782 
	`DEFINE_WAIT
(
wa™
);

784 
	`¥š_uÆock
(
ws_lock
);

785 
	`´•¬e_to_wa™
(
ws_wa™
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

786 ià(
	`©omic_»ad
(
tÙ®_ws
è> 
ýus
 && !*
ä“_ws
)

787 
	`scheduË
();

788 
	`fšish_wa™
(
ws_wa™
, &
wa™
);

789 
agaš
;

791 
	`©omic_šc
(
tÙ®_ws
);

792 
	`¥š_uÆock
(
ws_lock
);

799 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

800 
wÜk¥aû
 = 
bŒfs_com´ess_Ý
[
idx
]->
	`®loc_wÜk¥aû
();

801 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

803 ià(
	`IS_ERR
(
wÜk¥aû
)) {

804 
	`©omic_dec
(
tÙ®_ws
);

805 
	`wake_up
(
ws_wa™
);

817 ià(
	`©omic_»ad
(
tÙ®_ws
) == 0) {

818 
	`DEFINE_RATELIMIT_STATE
(
_rs
,

819  60 * 
HZ
,

822 ià(
	`__¿‹lim™
(&
_rs
)) {

823 
	`´_w¬n
("BTRFS:‚o compression workspaces,†ow memory,„etrying\n");

826 
agaš
;

828  
wÜk¥aû
;

829 
	}
}

835 
	$ä“_wÜk¥aû
(
ty³
, 
li¡_h—d
 *
wÜk¥aû
)

837 
idx
 = 
ty³
 - 1;

838 
li¡_h—d
 *
idË_ws
 = &
bŒfs_comp_ws
[
idx
].idle_ws;

839 
¥šlock_t
 *
ws_lock
 = &
bŒfs_comp_ws
[
idx
].ws_lock;

840 
©omic_t
 *
tÙ®_ws
 = &
bŒfs_comp_ws
[
idx
].total_ws;

841 
wa™_queue_h—d_t
 *
ws_wa™
 = &
bŒfs_comp_ws
[
idx
].ws_wait;

842 *
ä“_ws
 = &
bŒfs_comp_ws
[
idx
].free_ws;

844 
	`¥š_lock
(
ws_lock
);

845 ià(*
ä“_ws
 <ð
	`num_Úlše_ýus
()) {

846 
	`li¡_add
(
wÜk¥aû
, 
idË_ws
);

847 (*
ä“_ws
)++;

848 
	`¥š_uÆock
(
ws_lock
);

849 
wake
;

851 
	`¥š_uÆock
(
ws_lock
);

853 
bŒfs_com´ess_Ý
[
idx
]->
	`ä“_wÜk¥aû
(
wÜk¥aû
);

854 
	`©omic_dec
(
tÙ®_ws
);

855 
wake
:

859 
	`smp_mb
();

860 ià(
	`wa™queue_aùive
(
ws_wa™
))

861 
	`wake_up
(
ws_wa™
);

862 
	}
}

867 
	$ä“_wÜk¥aûs
()

869 
li¡_h—d
 *
wÜk¥aû
;

870 
i
;

872 
i
 = 0; i < 
BTRFS_COMPRESS_TYPES
; i++) {

873 !
	`li¡_em±y
(&
bŒfs_comp_ws
[
i
].
idË_ws
)) {

874 
wÜk¥aû
 = 
bŒfs_comp_ws
[
i
].
idË_ws
.
Ãxt
;

875 
	`li¡_d–
(
wÜk¥aû
);

876 
bŒfs_com´ess_Ý
[
i
]->
	`ä“_wÜk¥aû
(
wÜk¥aû
);

877 
	`©omic_dec
(&
bŒfs_comp_ws
[
i
].
tÙ®_ws
);

880 
	}
}

900 
	$bŒfs_com´ess_·ges
(
ty³
, 
add»ss_¥aû
 *
m­pšg
,

901 
u64
 
¡¬t
, 
·ge
 **
·ges
,

902 *
out_·ges
,

903 *
tÙ®_š
,

904 *
tÙ®_out
)

906 
li¡_h—d
 *
wÜk¥aû
;

907 
»t
;

909 
wÜk¥aû
 = 
	`fšd_wÜk¥aû
(
ty³
);

911 
»t
 = 
bŒfs_com´ess_Ý
[
ty³
-1]->
	`com´ess_·ges
(
wÜk¥aû
, 
m­pšg
,

912 
¡¬t
, 
·ges
,

913 
out_·ges
,

914 
tÙ®_š
, 
tÙ®_out
);

915 
	`ä“_wÜk¥aû
(
ty³
, 
wÜk¥aû
);

916  
»t
;

917 
	}
}

933 
	$bŒfs_decom´ess_bio
(
com´es£d_bio
 *
cb
)

935 
li¡_h—d
 *
wÜk¥aû
;

936 
»t
;

937 
ty³
 = 
cb
->
com´ess_ty³
;

939 
wÜk¥aû
 = 
	`fšd_wÜk¥aû
(
ty³
);

940 
»t
 = 
bŒfs_com´ess_Ý
[
ty³
 - 1]->
	`decom´ess_bio
(
wÜk¥aû
, 
cb
);

941 
	`ä“_wÜk¥aû
(
ty³
, 
wÜk¥aû
);

943  
»t
;

944 
	}
}

951 
	$bŒfs_decom´ess
(
ty³
, *
d©a_š
, 
·ge
 *
de¡_·ge
,

952 
¡¬t_by‹
, 
size_t
 
¤þ’
, size_ˆ
de¡Ën
)

954 
li¡_h—d
 *
wÜk¥aû
;

955 
»t
;

957 
wÜk¥aû
 = 
	`fšd_wÜk¥aû
(
ty³
);

959 
»t
 = 
bŒfs_com´ess_Ý
[
ty³
-1]->
	`decom´ess
(
wÜk¥aû
, 
d©a_š
,

960 
de¡_·ge
, 
¡¬t_by‹
,

961 
¤þ’
, 
de¡Ën
);

963 
	`ä“_wÜk¥aû
(
ty³
, 
wÜk¥aû
);

964  
»t
;

965 
	}
}

967 
	$bŒfs_ex™_com´ess
()

969 
	`ä“_wÜk¥aûs
();

970 
	}
}

979 
	$bŒfs_decom´ess_buf2·ge
(cÚ¡ *
buf
, 
buf_¡¬t
,

980 
tÙ®_out
, 
u64
 
disk_¡¬t
,

981 
bio
 *bio)

983 
buf_off£t
;

984 
cu¼’t_buf_¡¬t
;

985 
¡¬t_by‹
;

986 
´ev_¡¬t_by‹
;

987 
wÜkšg_by‹s
 = 
tÙ®_out
 - 
buf_¡¬t
;

988 
by‹s
;

989 *
kaddr
;

990 
bio_vec
 
bvec
 = 
	`bio_™”_iovec
(
bio
, bio->
bi_™”
);

996 
¡¬t_by‹
 = 
	`·ge_off£t
(
bvec
.
bv_·ge
è- 
disk_¡¬t
;

999 ià(
tÙ®_out
 <ð
¡¬t_by‹
)

1006 ià(
tÙ®_out
 > 
¡¬t_by‹
 && 
buf_¡¬t
 < start_byte) {

1007 
buf_off£t
 = 
¡¬t_by‹
 - 
buf_¡¬t
;

1008 
wÜkšg_by‹s
 -ð
buf_off£t
;

1010 
buf_off£t
 = 0;

1012 
cu¼’t_buf_¡¬t
 = 
buf_¡¬t
;

1015 
wÜkšg_by‹s
 > 0) {

1016 
by‹s
 = 
	`mš_t
(, 
bvec
.
bv_Ën
,

1017 
PAGE_SIZE
 - 
buf_off£t
);

1018 
by‹s
 = 
	`mš
(by‹s, 
wÜkšg_by‹s
);

1020 
kaddr
 = 
	`km­_©omic
(
bvec
.
bv_·ge
);

1021 
	`memýy
(
kaddr
 + 
bvec
.
bv_off£t
, 
buf
 + 
buf_off£t
, 
by‹s
);

1022 
	`kunm­_©omic
(
kaddr
);

1023 
	`æush_dÿche_·ge
(
bvec
.
bv_·ge
);

1025 
buf_off£t
 +ð
by‹s
;

1026 
wÜkšg_by‹s
 -ð
by‹s
;

1027 
cu¼’t_buf_¡¬t
 +ð
by‹s
;

1030 
	`bio_advªû
(
bio
, 
by‹s
);

1031 ià(!
bio
->
bi_™”
.
bi_size
)

1033 
bvec
 = 
	`bio_™”_iovec
(
bio
, bio->
bi_™”
);

1034 
´ev_¡¬t_by‹
 = 
¡¬t_by‹
;

1035 
¡¬t_by‹
 = 
	`·ge_off£t
(
bvec
.
bv_·ge
è- 
disk_¡¬t
;

1043 ià(
¡¬t_by‹
 !ð
´ev_¡¬t_by‹
) {

1048 ià(
tÙ®_out
 <ð
¡¬t_by‹
)

1056 ià(
tÙ®_out
 > 
¡¬t_by‹
 &&

1057 
cu¼’t_buf_¡¬t
 < 
¡¬t_by‹
) {

1058 
buf_off£t
 = 
¡¬t_by‹
 - 
buf_¡¬t
;

1059 
wÜkšg_by‹s
 = 
tÙ®_out
 - 
¡¬t_by‹
;

1060 
cu¼’t_buf_¡¬t
 = 
buf_¡¬t
 + 
buf_off£t
;

1066 
	}
}

1083 
	$bŒfs_com´ess_heuri¡ic
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

1085 
u64
 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1086 
u64
 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

1087 
·ge
 *page;

1088 
»t
 = 1;

1090 
šdex
 <ð
’d_šdex
) {

1091 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

1092 
	`km­
(
·ge
);

1093 
	`kunm­
(
·ge
);

1094 
	`put_·ge
(
·ge
);

1095 
šdex
++;

1098  
»t
;

1099 
	}
}

	@compression.h

19 #iâdeà
__BTRFS_COMPRESSION_


20 
	#__BTRFS_COMPRESSION_


	)

33 
	#BTRFS_MAX_COMPRESSED
 (
SZ_128K
)

	)

35 
	#BTRFS_MAX_UNCOMPRESSED
 (
SZ_128K
)

	)

37 
	scom´es£d_bio
 {

39 
»fcouÁ_t
 
	m³ndšg_bios
;

42 
·ge
 **
	mcom´es£d_·ges
;

45 
šode
 *
	mšode
;

48 
u64
 
	m¡¬t
;

51 
	mËn
;

54 
	mcom´es£d_Ën
;

57 
	mcom´ess_ty³
;

60 
	mÄ_·ges
;

63 
	m”rÜs
;

64 
	mmœrÜ_num
;

67 
bio
 *
	mÜig_bio
;

73 
u32
 
	msums
;

76 
bŒfs_š™_com´ess
();

77 
bŒfs_ex™_com´ess
();

79 
bŒfs_com´ess_·ges
(
ty³
, 
add»ss_¥aû
 *
m­pšg
,

80 
u64
 
¡¬t
, 
·ge
 **
·ges
,

81 *
out_·ges
,

82 *
tÙ®_š
,

83 *
tÙ®_out
);

84 
bŒfs_decom´ess
(
ty³
, *
d©a_š
, 
·ge
 *
de¡_·ge
,

85 
¡¬t_by‹
, 
size_t
 
¤þ’
, size_ˆ
de¡Ën
);

86 
bŒfs_decom´ess_buf2·ge
(cÚ¡ *
buf
, 
buf_¡¬t
,

87 
tÙ®_out
, 
u64
 
disk_¡¬t
,

88 
bio
 *bio);

90 
blk_¡©us_t
 
bŒfs_subm™_com´es£d_wr™e
(
šode
 *šode, 
u64
 
¡¬t
,

91 
Ën
, 
u64
 
disk_¡¬t
,

92 
com´es£d_Ën
,

93 
·ge
 **
com´es£d_·ges
,

94 
Ä_·ges
);

95 
blk_¡©us_t
 
bŒfs_subm™_com´es£d_»ad
(
šode
 *šode, 
bio
 *bio,

96 
mœrÜ_num
, 
bio_æags
);

98 
	ebŒfs_com´essiÚ_ty³
 {

99 
	mBTRFS_COMPRESS_NONE
 = 0,

100 
	mBTRFS_COMPRESS_ZLIB
 = 1,

101 
	mBTRFS_COMPRESS_LZO
 = 2,

102 
	mBTRFS_COMPRESS_ZSTD
 = 3,

103 
	mBTRFS_COMPRESS_TYPES
 = 3,

106 
	sbŒfs_com´ess_Ý
 {

107 
	mli¡_h—d
 *(*
	m®loc_wÜk¥aû
)();

109 (*
	mä“_wÜk¥aû
)(
li¡_h—d
 *
	mwÜk¥aû
);

111 (*
	mcom´ess_·ges
)(
li¡_h—d
 *
	mwÜk¥aû
,

112 
add»ss_¥aû
 *
	mm­pšg
,

113 
u64
 
	m¡¬t
,

114 
·ge
 **
	m·ges
,

115 *
	mout_·ges
,

116 *
	mtÙ®_š
,

117 *
	mtÙ®_out
);

119 (*
	mdecom´ess_bio
)(
li¡_h—d
 *
	mwÜk¥aû
,

120 
com´es£d_bio
 *
	mcb
);

122 (*
	mdecom´ess
)(
li¡_h—d
 *
	mwÜk¥aû
,

123 *
	md©a_š
,

124 
·ge
 *
	mde¡_·ge
,

125 
	m¡¬t_by‹
,

126 
size_t
 
	m¤þ’
, size_ˆ
	mde¡Ën
);

129 cÚ¡ 
bŒfs_com´ess_Ý
 
bŒfs_zlib_com´ess
;

130 cÚ¡ 
bŒfs_com´ess_Ý
 
bŒfs_lzo_com´ess
;

131 cÚ¡ 
bŒfs_com´ess_Ý
 
bŒfs_z¡d_com´ess
;

133 
bŒfs_com´ess_heuri¡ic
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
);

	@ctree.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/rbŒ“.h
>

22 
	~<lšux/mm.h
>

23 
	~"ù»e.h
"

24 
	~"disk-io.h
"

25 
	~"Œª§ùiÚ.h
"

26 
	~"´št-Œ“.h
"

27 
	~"lockšg.h
"

29 
¥l™_node
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


30 *
roÙ
, 
bŒfs_·th
 *
·th
, 
Ëv–
);

31 
¥l™_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

32 cÚ¡ 
bŒfs_key
 *
šs_key
, 
bŒfs_·th
 *
·th
,

33 
d©a_size
, 
ex‹nd
);

34 
push_node_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

35 
bŒfs_fs_šfo
 *
fs_šfo
,

36 
ex‹Á_bufãr
 *
d¡
,

37 
ex‹Á_bufãr
 *
¤c
, 
em±y
);

38 
b®ªû_node_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

39 
bŒfs_fs_šfo
 *
fs_šfo
,

40 
ex‹Á_bufãr
 *
d¡_buf
,

41 
ex‹Á_bufãr
 *
¤c_buf
);

42 
d–_±r
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

43 
Ëv–
, 
¦Ù
);

44 
Œ“_mod_log_ä“_eb
(
bŒfs_fs_šfo
 *
fs_šfo
,

45 
ex‹Á_bufãr
 *
eb
);

47 
bŒfs_·th
 *
	$bŒfs_®loc_·th
()

49  
	`kmem_ÿche_z®loc
(
bŒfs_·th_ÿch•
, 
GFP_NOFS
);

50 
	}
}

56 
nošlše
 
	$bŒfs_£t_·th_blockšg
(
bŒfs_·th
 *
p
)

58 
i
;

59 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

60 ià(!
p
->
nodes
[
i
] || !p->
locks
[i])

62 
	`bŒfs_£t_lock_blockšg_rw
(
p
->
nodes
[
i
],…->
locks
[i]);

63 ià(
p
->
locks
[
i
] =ð
BTRFS_READ_LOCK
)

64 
p
->
locks
[
i
] = 
BTRFS_READ_LOCK_BLOCKING
;

65 ià(
p
->
locks
[
i
] =ð
BTRFS_WRITE_LOCK
)

66 
p
->
locks
[
i
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

68 
	}
}

78 
nošlše
 
	$bŒfs_þ—r_·th_blockšg
(
bŒfs_·th
 *
p
,

79 
ex‹Á_bufãr
 *
h–d
, 
h–d_rw
)

81 
i
;

83 ià(
h–d
) {

84 
	`bŒfs_£t_lock_blockšg_rw
(
h–d
, 
h–d_rw
);

85 ià(
h–d_rw
 =ð
BTRFS_WRITE_LOCK
)

86 
h–d_rw
 = 
BTRFS_WRITE_LOCK_BLOCKING
;

87 ià(
h–d_rw
 =ð
BTRFS_READ_LOCK
)

88 
h–d_rw
 = 
BTRFS_READ_LOCK_BLOCKING
;

90 
	`bŒfs_£t_·th_blockšg
(
p
);

92 
i
 = 
BTRFS_MAX_LEVEL
 - 1; i >= 0; i--) {

93 ià(
p
->
nodes
[
i
] &&…->
locks
[i]) {

94 
	`bŒfs_þ—r_lock_blockšg_rw
(
p
->
nodes
[
i
],…->
locks
[i]);

95 ià(
p
->
locks
[
i
] =ð
BTRFS_WRITE_LOCK_BLOCKING
)

96 
p
->
locks
[
i
] = 
BTRFS_WRITE_LOCK
;

97 ià(
p
->
locks
[
i
] =ð
BTRFS_READ_LOCK_BLOCKING
)

98 
p
->
locks
[
i
] = 
BTRFS_READ_LOCK
;

102 ià(
h–d
)

103 
	`bŒfs_þ—r_lock_blockšg_rw
(
h–d
, 
h–d_rw
);

104 
	}
}

107 
	$bŒfs_ä“_·th
(
bŒfs_·th
 *
p
)

109 ià(!
p
)

111 
	`bŒfs_»Ëa£_·th
(
p
);

112 
	`kmem_ÿche_ä“
(
bŒfs_·th_ÿch•
, 
p
);

113 
	}
}

121 
nošlše
 
	$bŒfs_»Ëa£_·th
(
bŒfs_·th
 *
p
)

123 
i
;

125 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++) {

126 
p
->
¦Ùs
[
i
] = 0;

127 ià(!
p
->
nodes
[
i
])

129 ià(
p
->
locks
[
i
]) {

130 
	`bŒfs_Œ“_uÆock_rw
(
p
->
nodes
[
i
],…->
locks
[i]);

131 
p
->
locks
[
i
] = 0;

133 
	`ä“_ex‹Á_bufãr
(
p
->
nodes
[
i
]);

134 
p
->
nodes
[
i
] = 
NULL
;

136 
	}
}

148 
ex‹Á_bufãr
 *
	$bŒfs_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

150 
ex‹Á_bufãr
 *
eb
;

153 
	`rcu_»ad_lock
();

154 
eb
 = 
	`rcu_d”eã»nû
(
roÙ
->
node
);

162 ià(
	`©omic_šc_nÙ_z”o
(&
eb
->
»fs
)) {

163 
	`rcu_»ad_uÆock
();

166 
	`rcu_»ad_uÆock
();

167 
	`synchrÚize_rcu
();

169  
eb
;

170 
	}
}

176 
ex‹Á_bufãr
 *
	$bŒfs_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

178 
ex‹Á_bufãr
 *
eb
;

181 
eb
 = 
	`bŒfs_roÙ_node
(
roÙ
);

182 
	`bŒfs_Œ“_lock
(
eb
);

183 ià(
eb
 =ð
roÙ
->
node
)

185 
	`bŒfs_Œ“_uÆock
(
eb
);

186 
	`ä“_ex‹Á_bufãr
(
eb
);

188  
eb
;

189 
	}
}

195 
ex‹Á_bufãr
 *
	$bŒfs_»ad_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
)

197 
ex‹Á_bufãr
 *
eb
;

200 
eb
 = 
	`bŒfs_roÙ_node
(
roÙ
);

201 
	`bŒfs_Œ“_»ad_lock
(
eb
);

202 ià(
eb
 =ð
roÙ
->
node
)

204 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

205 
	`ä“_ex‹Á_bufãr
(
eb
);

207  
eb
;

208 
	}
}

214 
	$add_roÙ_to_dœty_li¡
(
bŒfs_roÙ
 *
roÙ
)

216 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

218 ià(
	`‹¡_b™
(
BTRFS_ROOT_DIRTY
, &
roÙ
->
¡©e
) ||

219 !
	`‹¡_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
))

222 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

223 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_DIRTY
, &
roÙ
->
¡©e
)) {

225 ià(
roÙ
->
objeùid
 =ð
BTRFS_EXTENT_TREE_OBJECTID
)

226 
	`li¡_move_ž
(&
roÙ
->
dœty_li¡
,

227 &
fs_šfo
->
dœty_cowÚly_roÙs
);

229 
	`li¡_move
(&
roÙ
->
dœty_li¡
,

230 &
fs_šfo
->
dœty_cowÚly_roÙs
);

232 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

233 
	}
}

240 
	$bŒfs_cÝy_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

241 
bŒfs_roÙ
 *
roÙ
,

242 
ex‹Á_bufãr
 *
buf
,

243 
ex‹Á_bufãr
 **
cow_»t
, 
u64
 
Ãw_roÙ_objeùid
)

245 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

246 
ex‹Á_bufãr
 *
cow
;

247 
»t
 = 0;

248 
Ëv–
;

249 
bŒfs_disk_key
 
disk_key
;

251 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

252 
Œªs
->
Œªsid
 !ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
->transid);

253 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

254 
Œªs
->
Œªsid
 !ð
roÙ
->
Ï¡_Œªs
);

256 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

257 ià(
Ëv–
 == 0)

258 
	`bŒfs_™em_key
(
buf
, &
disk_key
, 0);

260 
	`bŒfs_node_key
(
buf
, &
disk_key
, 0);

262 
cow
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
Ãw_roÙ_objeùid
,

263 &
disk_key
, 
Ëv–
, 
buf
->
¡¬t
, 0);

264 ià(
	`IS_ERR
(
cow
))

265  
	`PTR_ERR
(
cow
);

267 
	`cÝy_ex‹Á_bufãr_fuÎ
(
cow
, 
buf
);

268 
	`bŒfs_£t_h—d”_by‹Ä
(
cow
, cow->
¡¬t
);

269 
	`bŒfs_£t_h—d”_g’”©iÚ
(
cow
, 
Œªs
->
Œªsid
);

270 
	`bŒfs_£t_h—d”_back»f_»v
(
cow
, 
BTRFS_MIXED_BACKREF_REV
);

271 
	`bŒfs_þ—r_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_WRITTEN
 |

272 
BTRFS_HEADER_FLAG_RELOC
);

273 ià(
Ãw_roÙ_objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
)

274 
	`bŒfs_£t_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_RELOC
);

276 
	`bŒfs_£t_h—d”_owÃr
(
cow
, 
Ãw_roÙ_objeùid
);

278 
	`wr™e_ex‹Á_bufãr_fsid
(
cow
, 
fs_šfo
->
fsid
);

280 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
buf
è> 
Œªs
->
Œªsid
);

281 ià(
Ãw_roÙ_objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
)

282 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

284 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 0);

286 ià(
»t
)

287  
»t
;

289 
	`bŒfs_m¬k_bufãr_dœty
(
cow
);

290 *
cow_»t
 = 
cow
;

292 
	}
}

294 
	emod_log_Ý
 {

295 
	mMOD_LOG_KEY_REPLACE
,

296 
	mMOD_LOG_KEY_ADD
,

297 
	mMOD_LOG_KEY_REMOVE
,

298 
	mMOD_LOG_KEY_REMOVE_WHILE_FREEING
,

299 
	mMOD_LOG_KEY_REMOVE_WHILE_MOVING
,

300 
	mMOD_LOG_MOVE_KEYS
,

301 
	mMOD_LOG_ROOT_REPLACE
,

304 
	sŒ“_mod_move
 {

305 
	md¡_¦Ù
;

306 
	mÄ_™ems
;

309 
	sŒ“_mod_roÙ
 {

310 
u64
 
	mlogiÿl
;

311 
u8
 
	mËv–
;

314 
	sŒ“_mod_–em
 {

315 
rb_node
 
	mnode
;

316 
u64
 
	mlogiÿl
;

317 
u64
 
	m£q
;

318 
mod_log_Ý
 
	mÝ
;

321 
	m¦Ù
;

324 
u64
 
	mg’”©iÚ
;

327 
bŒfs_disk_key
 
	mkey
;

328 
u64
 
	mblock±r
;

331 
Œ“_mod_move
 
	mmove
;

334 
Œ“_mod_roÙ
 
	mÞd_roÙ
;

337 
šlše
 
	$Œ“_mod_log_»ad_lock
(
bŒfs_fs_šfo
 *
fs_šfo
)

339 
	`»ad_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

340 
	}
}

342 
šlše
 
	$Œ“_mod_log_»ad_uÆock
(
bŒfs_fs_šfo
 *
fs_šfo
)

344 
	`»ad_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

345 
	}
}

347 
šlše
 
	$Œ“_mod_log_wr™e_lock
(
bŒfs_fs_šfo
 *
fs_šfo
)

349 
	`wr™e_lock
(&
fs_šfo
->
Œ“_mod_log_lock
);

350 
	}
}

352 
šlše
 
	$Œ“_mod_log_wr™e_uÆock
(
bŒfs_fs_šfo
 *
fs_šfo
)

354 
	`wr™e_uÆock
(&
fs_šfo
->
Œ“_mod_log_lock
);

355 
	}
}

360 
šlše
 
u64
 
	$bŒfs_šc_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
)

362  
	`©omic64_šc_»tuº
(&
fs_šfo
->
Œ“_mod_£q
);

363 
	}
}

373 
u64
 
	$bŒfs_g‘_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

374 
£q_li¡
 *
–em
)

376 
	`Œ“_mod_log_wr™e_lock
(
fs_šfo
);

377 
	`¥š_lock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

378 ià(!
–em
->
£q
) {

379 
–em
->
£q
 = 
	`bŒfs_šc_Œ“_mod_£q
(
fs_šfo
);

380 
	`li¡_add_ž
(&
–em
->
li¡
, &
fs_šfo
->
Œ“_mod_£q_li¡
);

382 
	`¥š_uÆock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

383 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

385  
–em
->
£q
;

386 
	}
}

388 
	$bŒfs_put_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

389 
£q_li¡
 *
–em
)

391 
rb_roÙ
 *
tm_roÙ
;

392 
rb_node
 *
node
;

393 
rb_node
 *
Ãxt
;

394 
£q_li¡
 *
cur_–em
;

395 
Œ“_mod_–em
 *
tm
;

396 
u64
 
mš_£q
 = (u64)-1;

397 
u64
 
£q_pu‰šg
 = 
–em
->
£q
;

399 ià(!
£q_pu‰šg
)

402 
	`¥š_lock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

403 
	`li¡_d–
(&
–em
->
li¡
);

404 
–em
->
£q
 = 0;

406 
	`li¡_fÜ_—ch_’Œy
(
cur_–em
, &
fs_šfo
->
Œ“_mod_£q_li¡
, 
li¡
) {

407 ià(
cur_–em
->
£q
 < 
mš_£q
) {

408 ià(
£q_pu‰šg
 > 
cur_–em
->
£q
) {

413 
	`¥š_uÆock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

416 
mš_£q
 = 
cur_–em
->
£q
;

419 
	`¥š_uÆock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

425 
	`Œ“_mod_log_wr™e_lock
(
fs_šfo
);

426 
tm_roÙ
 = &
fs_šfo
->
Œ“_mod_log
;

427 
node
 = 
	`rb_fœ¡
(
tm_roÙ
);‚ode;‚odð
Ãxt
) {

428 
Ãxt
 = 
	`rb_Ãxt
(
node
);

429 
tm
 = 
	`rb_’Œy
(
node
, 
Œ“_mod_–em
,‚ode);

430 ià(
tm
->
£q
 > 
mš_£q
)

432 
	`rb_”a£
(
node
, 
tm_roÙ
);

433 
	`kä“
(
tm
);

435 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

436 
	}
}

448 
nošlše
 

449 
	$__Œ“_mod_log_š£¹
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Œ“_mod_–em
 *
tm
)

451 
rb_roÙ
 *
tm_roÙ
;

452 
rb_node
 **
Ãw
;

453 
rb_node
 *
·»Á
 = 
NULL
;

454 
Œ“_mod_–em
 *
cur
;

456 
tm
->
£q
 = 
	`bŒfs_šc_Œ“_mod_£q
(
fs_šfo
);

458 
tm_roÙ
 = &
fs_šfo
->
Œ“_mod_log
;

459 
Ãw
 = &
tm_roÙ
->
rb_node
;

460 *
Ãw
) {

461 
cur
 = 
	`rb_’Œy
(*
Ãw
, 
Œ“_mod_–em
, 
node
);

462 
·»Á
 = *
Ãw
;

463 ià(
cur
->
logiÿl
 < 
tm
->logical)

464 
Ãw
 = &((*Ãw)->
rb_Ëá
);

465 ià(
cur
->
logiÿl
 > 
tm
->logical)

466 
Ãw
 = &((*Ãw)->
rb_right
);

467 ià(
cur
->
£q
 < 
tm
->seq)

468 
Ãw
 = &((*Ãw)->
rb_Ëá
);

469 ià(
cur
->
£q
 > 
tm
->seq)

470 
Ãw
 = &((*Ãw)->
rb_right
);

472  -
EEXIST
;

475 
	`rb_lšk_node
(&
tm
->
node
, 
·»Á
, 
Ãw
);

476 
	`rb_š£¹_cÞÜ
(&
tm
->
node
, 
tm_roÙ
);

478 
	}
}

486 
šlše
 
	$Œ“_mod_dÚt_log
(
bŒfs_fs_šfo
 *
fs_šfo
,

487 
ex‹Á_bufãr
 *
eb
) {

488 
	`smp_mb
();

489 ià(
	`li¡_em±y
(&(
fs_šfo
)->
Œ“_mod_£q_li¡
))

491 ià(
eb
 && 
	`bŒfs_h—d”_Ëv–
(eb) == 0)

494 
	`Œ“_mod_log_wr™e_lock
(
fs_šfo
);

495 ià(
	`li¡_em±y
(&(
fs_šfo
)->
Œ“_mod_£q_li¡
)) {

496 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

501 
	}
}

504 
šlše
 
	$Œ“_mod_Ãed_log
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

505 
ex‹Á_bufãr
 *
eb
)

507 
	`smp_mb
();

508 ià(
	`li¡_em±y
(&(
fs_šfo
)->
Œ“_mod_£q_li¡
))

510 ià(
eb
 && 
	`bŒfs_h—d”_Ëv–
(eb) == 0)

514 
	}
}

516 
Œ“_mod_–em
 *

517 
	$®loc_Œ“_mod_–em
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

518 
mod_log_Ý
 
Ý
, 
gå_t
 
æags
)

520 
Œ“_mod_–em
 *
tm
;

522 
tm
 = 
	`kz®loc
((*tm), 
æags
);

523 ià(!
tm
)

524  
NULL
;

526 
tm
->
logiÿl
 = 
eb
->
¡¬t
;

527 ià(
Ý
 !ð
MOD_LOG_KEY_ADD
) {

528 
	`bŒfs_node_key
(
eb
, &
tm
->
key
, 
¦Ù
);

529 
tm
->
block±r
 = 
	`bŒfs_node_block±r
(
eb
, 
¦Ù
);

531 
tm
->
Ý
 = op;

532 
tm
->
¦Ù
 = slot;

533 
tm
->
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
¦Ù
);

534 
	`RB_CLEAR_NODE
(&
tm
->
node
);

536  
tm
;

537 
	}
}

539 
nošlše
 

540 
	$Œ“_mod_log_š£¹_key
(
bŒfs_fs_šfo
 *
fs_šfo
,

541 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

542 
mod_log_Ý
 
Ý
, 
gå_t
 
æags
)

544 
Œ“_mod_–em
 *
tm
;

545 
»t
;

547 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
eb
))

550 
tm
 = 
	`®loc_Œ“_mod_–em
(
eb
, 
¦Ù
, 
Ý
, 
æags
);

551 ià(!
tm
)

552  -
ENOMEM
;

554 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
eb
)) {

555 
	`kä“
(
tm
);

559 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm
);

560 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

561 ià(
»t
)

562 
	`kä“
(
tm
);

564  
»t
;

565 
	}
}

567 
nošlše
 

568 
	$Œ“_mod_log_š£¹_move
(
bŒfs_fs_šfo
 *
fs_šfo
,

569 
ex‹Á_bufãr
 *
eb
, 
d¡_¦Ù
, 
¤c_¦Ù
,

570 
Ä_™ems
)

572 
Œ“_mod_–em
 *
tm
 = 
NULL
;

573 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

574 
»t
 = 0;

575 
i
;

576 
locked
 = 0;

578 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
eb
))

581 
tm_li¡
 = 
	`kÿÎoc
(
Ä_™ems
, (
Œ“_mod_–em
 *), 
GFP_NOFS
);

582 ià(!
tm_li¡
)

583  -
ENOMEM
;

585 
tm
 = 
	`kz®loc
((*tm), 
GFP_NOFS
);

586 ià(!
tm
) {

587 
»t
 = -
ENOMEM
;

588 
ä“_tms
;

591 
tm
->
logiÿl
 = 
eb
->
¡¬t
;

592 
tm
->
¦Ù
 = 
¤c_¦Ù
;

593 
tm
->
move
.
d¡_¦Ù
 = dst_slot;

594 
tm
->
move
.
Ä_™ems
 =‚r_items;

595 
tm
->
Ý
 = 
MOD_LOG_MOVE_KEYS
;

597 
i
 = 0; i + 
d¡_¦Ù
 < 
¤c_¦Ù
 && i < 
Ä_™ems
; i++) {

598 
tm_li¡
[
i
] = 
	`®loc_Œ“_mod_–em
(
eb
, i + 
d¡_¦Ù
,

599 
MOD_LOG_KEY_REMOVE_WHILE_MOVING
, 
GFP_NOFS
);

600 ià(!
tm_li¡
[
i
]) {

601 
»t
 = -
ENOMEM
;

602 
ä“_tms
;

606 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
eb
))

607 
ä“_tms
;

608 
locked
 = 1;

615 
i
 = 0; i + 
d¡_¦Ù
 < 
¤c_¦Ù
 && i < 
Ä_™ems
; i++) {

616 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡
[
i
]);

617 ià(
»t
)

618 
ä“_tms
;

621 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm
);

622 ià(
»t
)

623 
ä“_tms
;

624 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

625 
	`kä“
(
tm_li¡
);

628 
ä“_tms
:

629 
i
 = 0; i < 
Ä_™ems
; i++) {

630 ià(
tm_li¡
[
i
] && !
	`RB_EMPTY_NODE
(&tm_li¡[i]->
node
))

631 
	`rb_”a£
(&
tm_li¡
[
i
]->
node
, &
fs_šfo
->
Œ“_mod_log
);

632 
	`kä“
(
tm_li¡
[
i
]);

634 ià(
locked
)

635 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

636 
	`kä“
(
tm_li¡
);

637 
	`kä“
(
tm
);

639  
»t
;

640 
	}
}

642 
šlše
 

643 
	$__Œ“_mod_log_ä“_eb
(
bŒfs_fs_šfo
 *
fs_šfo
,

644 
Œ“_mod_–em
 **
tm_li¡
,

645 
Ä™ems
)

647 
i
, 
j
;

648 
»t
;

650 
i
 = 
Ä™ems
 - 1; i >= 0; i--) {

651 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡
[
i
]);

652 ià(
»t
) {

653 
j
 = 
Ä™ems
 - 1; j > 
i
; j--)

654 
	`rb_”a£
(&
tm_li¡
[
j
]->
node
,

655 &
fs_šfo
->
Œ“_mod_log
);

656  
»t
;

661 
	}
}

663 
nošlše
 

664 
	$Œ“_mod_log_š£¹_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

665 
ex‹Á_bufãr
 *
Þd_roÙ
,

666 
ex‹Á_bufãr
 *
Ãw_roÙ
,

667 
log_»mov®
)

669 
Œ“_mod_–em
 *
tm
 = 
NULL
;

670 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

671 
Ä™ems
 = 0;

672 
»t
 = 0;

673 
i
;

675 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
NULL
))

678 ià(
log_»mov®
 && 
	`bŒfs_h—d”_Ëv–
(
Þd_roÙ
) > 0) {

679 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Þd_roÙ
);

680 
tm_li¡
 = 
	`kÿÎoc
(
Ä™ems
, (
Œ“_mod_–em
 *),

681 
GFP_NOFS
);

682 ià(!
tm_li¡
) {

683 
»t
 = -
ENOMEM
;

684 
ä“_tms
;

686 
i
 = 0; i < 
Ä™ems
; i++) {

687 
tm_li¡
[
i
] = 
	`®loc_Œ“_mod_–em
(
Þd_roÙ
, i,

688 
MOD_LOG_KEY_REMOVE_WHILE_FREEING
, 
GFP_NOFS
);

689 ià(!
tm_li¡
[
i
]) {

690 
»t
 = -
ENOMEM
;

691 
ä“_tms
;

696 
tm
 = 
	`kz®loc
((*tm), 
GFP_NOFS
);

697 ià(!
tm
) {

698 
»t
 = -
ENOMEM
;

699 
ä“_tms
;

702 
tm
->
logiÿl
 = 
Ãw_roÙ
->
¡¬t
;

703 
tm
->
Þd_roÙ
.
logiÿl
 = old_roÙ->
¡¬t
;

704 
tm
->
Þd_roÙ
.
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(old_root);

705 
tm
->
g’”©iÚ
 = 
	`bŒfs_h—d”_g’”©iÚ
(
Þd_roÙ
);

706 
tm
->
Ý
 = 
MOD_LOG_ROOT_REPLACE
;

708 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
NULL
))

709 
ä“_tms
;

711 ià(
tm_li¡
)

712 
»t
 = 
	`__Œ“_mod_log_ä“_eb
(
fs_šfo
, 
tm_li¡
, 
Ä™ems
);

713 ià(!
»t
)

714 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm
);

716 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

717 ià(
»t
)

718 
ä“_tms
;

719 
	`kä“
(
tm_li¡
);

721  
»t
;

723 
ä“_tms
:

724 ià(
tm_li¡
) {

725 
i
 = 0; i < 
Ä™ems
; i++)

726 
	`kä“
(
tm_li¡
[
i
]);

727 
	`kä“
(
tm_li¡
);

729 
	`kä“
(
tm
);

731  
»t
;

732 
	}
}

734 
Œ“_mod_–em
 *

735 
	$__Œ“_mod_log_£¬ch
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
mš_£q
,

736 
sm®Ë¡
)

738 
rb_roÙ
 *
tm_roÙ
;

739 
rb_node
 *
node
;

740 
Œ“_mod_–em
 *
cur
 = 
NULL
;

741 
Œ“_mod_–em
 *
found
 = 
NULL
;

743 
	`Œ“_mod_log_»ad_lock
(
fs_šfo
);

744 
tm_roÙ
 = &
fs_šfo
->
Œ“_mod_log
;

745 
node
 = 
tm_roÙ
->
rb_node
;

746 
node
) {

747 
cur
 = 
	`rb_’Œy
(
node
, 
Œ“_mod_–em
,‚ode);

748 ià(
cur
->
logiÿl
 < 
¡¬t
) {

749 
node
 =‚ode->
rb_Ëá
;

750 } ià(
cur
->
logiÿl
 > 
¡¬t
) {

751 
node
 =‚ode->
rb_right
;

752 } ià(
cur
->
£q
 < 
mš_£q
) {

753 
node
 =‚ode->
rb_Ëá
;

754 } ià(!
sm®Ë¡
) {

756 ià(
found
)

757 
	`BUG_ON
(
found
->
£q
 > 
cur
->seq);

758 
found
 = 
cur
;

759 
node
 =‚ode->
rb_Ëá
;

760 } ià(
cur
->
£q
 > 
mš_£q
) {

762 ià(
found
)

763 
	`BUG_ON
(
found
->
£q
 < 
cur
->seq);

764 
found
 = 
cur
;

765 
node
 =‚ode->
rb_right
;

767 
found
 = 
cur
;

771 
	`Œ“_mod_log_»ad_uÆock
(
fs_šfo
);

773  
found
;

774 
	}
}

781 
Œ“_mod_–em
 *

782 
	$Œ“_mod_log_£¬ch_Þde¡
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
,

783 
u64
 
mš_£q
)

785  
	`__Œ“_mod_log_£¬ch
(
fs_šfo
, 
¡¬t
, 
mš_£q
, 1);

786 
	}
}

793 
Œ“_mod_–em
 *

794 
	$Œ“_mod_log_£¬ch
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
mš_£q
)

796  
	`__Œ“_mod_log_£¬ch
(
fs_šfo
, 
¡¬t
, 
mš_£q
, 0);

797 
	}
}

799 
nošlše
 

800 
	$Œ“_mod_log_eb_cÝy
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
d¡
,

801 
ex‹Á_bufãr
 *
¤c
, 
d¡_off£t
,

802 
¤c_off£t
, 
Ä_™ems
)

804 
»t
 = 0;

805 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

806 
Œ“_mod_–em
 **
tm_li¡_add
, **
tm_li¡_»m
;

807 
i
;

808 
locked
 = 0;

810 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
NULL
))

813 ià(
	`bŒfs_h—d”_Ëv–
(
d¡
è=ð0 && bŒfs_h—d”_Ëv–(
¤c
) == 0)

816 
tm_li¡
 = 
	`kÿÎoc
(
Ä_™ems
 * 2, (
Œ“_mod_–em
 *),

817 
GFP_NOFS
);

818 ià(!
tm_li¡
)

819  -
ENOMEM
;

821 
tm_li¡_add
 = 
tm_li¡
;

822 
tm_li¡_»m
 = 
tm_li¡
 + 
Ä_™ems
;

823 
i
 = 0; i < 
Ä_™ems
; i++) {

824 
tm_li¡_»m
[
i
] = 
	`®loc_Œ“_mod_–em
(
¤c
, i + 
¤c_off£t
,

825 
MOD_LOG_KEY_REMOVE
, 
GFP_NOFS
);

826 ià(!
tm_li¡_»m
[
i
]) {

827 
»t
 = -
ENOMEM
;

828 
ä“_tms
;

831 
tm_li¡_add
[
i
] = 
	`®loc_Œ“_mod_–em
(
d¡
, i + 
d¡_off£t
,

832 
MOD_LOG_KEY_ADD
, 
GFP_NOFS
);

833 ià(!
tm_li¡_add
[
i
]) {

834 
»t
 = -
ENOMEM
;

835 
ä“_tms
;

839 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
NULL
))

840 
ä“_tms
;

841 
locked
 = 1;

843 
i
 = 0; i < 
Ä_™ems
; i++) {

844 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡_»m
[
i
]);

845 ià(
»t
)

846 
ä“_tms
;

847 
»t
 = 
	`__Œ“_mod_log_š£¹
(
fs_šfo
, 
tm_li¡_add
[
i
]);

848 ià(
»t
)

849 
ä“_tms
;

852 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

853 
	`kä“
(
tm_li¡
);

857 
ä“_tms
:

858 
i
 = 0; i < 
Ä_™ems
 * 2; i++) {

859 ià(
tm_li¡
[
i
] && !
	`RB_EMPTY_NODE
(&tm_li¡[i]->
node
))

860 
	`rb_”a£
(&
tm_li¡
[
i
]->
node
, &
fs_šfo
->
Œ“_mod_log
);

861 
	`kä“
(
tm_li¡
[
i
]);

863 ià(
locked
)

864 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

865 
	`kä“
(
tm_li¡
);

867  
»t
;

868 
	}
}

870 
šlše
 

871 
	$Œ“_mod_log_eb_move
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
d¡
,

872 
d¡_off£t
, 
¤c_off£t
, 
Ä_™ems
)

874 
»t
;

875 
»t
 = 
	`Œ“_mod_log_š£¹_move
(
fs_šfo
, 
d¡
, 
d¡_off£t
, 
¤c_off£t
,

876 
Ä_™ems
);

877 
	`BUG_ON
(
»t
 < 0);

878 
	}
}

880 
nošlše
 

881 
	$Œ“_mod_log_£t_node_key
(
bŒfs_fs_šfo
 *
fs_šfo
,

882 
ex‹Á_bufãr
 *
eb
, 
¦Ù
, 
©omic
)

884 
»t
;

886 
»t
 = 
	`Œ“_mod_log_š£¹_key
(
fs_šfo
, 
eb
, 
¦Ù
,

887 
MOD_LOG_KEY_REPLACE
,

888 
©omic
 ? 
GFP_ATOMIC
 : 
GFP_NOFS
);

889 
	`BUG_ON
(
»t
 < 0);

890 
	}
}

892 
nošlše
 

893 
	$Œ“_mod_log_ä“_eb
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
eb
)

895 
Œ“_mod_–em
 **
tm_li¡
 = 
NULL
;

896 
Ä™ems
 = 0;

897 
i
;

898 
»t
 = 0;

900 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

903 ià(!
	`Œ“_mod_Ãed_log
(
fs_šfo
, 
NULL
))

906 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

907 
tm_li¡
 = 
	`kÿÎoc
(
Ä™ems
, (
Œ“_mod_–em
 *), 
GFP_NOFS
);

908 ià(!
tm_li¡
)

909  -
ENOMEM
;

911 
i
 = 0; i < 
Ä™ems
; i++) {

912 
tm_li¡
[
i
] = 
	`®loc_Œ“_mod_–em
(
eb
, i,

913 
MOD_LOG_KEY_REMOVE_WHILE_FREEING
, 
GFP_NOFS
);

914 ià(!
tm_li¡
[
i
]) {

915 
»t
 = -
ENOMEM
;

916 
ä“_tms
;

920 ià(
	`Œ“_mod_dÚt_log
(
fs_šfo
, 
eb
))

921 
ä“_tms
;

923 
»t
 = 
	`__Œ“_mod_log_ä“_eb
(
fs_šfo
, 
tm_li¡
, 
Ä™ems
);

924 
	`Œ“_mod_log_wr™e_uÆock
(
fs_šfo
);

925 ià(
»t
)

926 
ä“_tms
;

927 
	`kä“
(
tm_li¡
);

931 
ä“_tms
:

932 
i
 = 0; i < 
Ä™ems
; i++)

933 
	`kä“
(
tm_li¡
[
i
]);

934 
	`kä“
(
tm_li¡
);

936  
»t
;

937 
	}
}

939 
nošlše
 

940 
	$Œ“_mod_log_£t_roÙ_poš‹r
(
bŒfs_roÙ
 *
roÙ
,

941 
ex‹Á_bufãr
 *
Ãw_roÙ_node
,

942 
log_»mov®
)

944 
»t
;

945 
»t
 = 
	`Œ“_mod_log_š£¹_roÙ
(
roÙ
->
fs_šfo
,„oÙ->
node
,

946 
Ãw_roÙ_node
, 
log_»mov®
);

947 
	`BUG_ON
(
»t
 < 0);

948 
	}
}

953 
	$bŒfs_block_ÿn_be_sh¬ed
(
bŒfs_roÙ
 *
roÙ
,

954 
ex‹Á_bufãr
 *
buf
)

962 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

963 
buf
 !ð
roÙ
->
node
 && buà!ðroÙ->
comm™_roÙ
 &&

964 (
	`bŒfs_h—d”_g’”©iÚ
(
buf
) <=

965 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
) ||

966 
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
)))

968 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


969 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

970 
	`bŒfs_h—d”_back»f_»v
(
buf
è< 
BTRFS_MIXED_BACKREF_REV
)

974 
	}
}

976 
nošlše
 
	$upd©e_»f_fÜ_cow
(
bŒfs_Œªs_hªdË
 *
Œªs
,

977 
bŒfs_roÙ
 *
roÙ
,

978 
ex‹Á_bufãr
 *
buf
,

979 
ex‹Á_bufãr
 *
cow
,

980 *
Ï¡_»f
)

982 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

983 
u64
 
»fs
;

984 
u64
 
owÃr
;

985 
u64
 
æags
;

986 
u64
 
Ãw_æags
 = 0;

987 
»t
;

1006 ià(
	`bŒfs_block_ÿn_be_sh¬ed
(
roÙ
, 
buf
)) {

1007 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
, 
buf
->
¡¬t
,

1008 
	`bŒfs_h—d”_Ëv–
(
buf
), 1,

1009 &
»fs
, &
æags
);

1010 ià(
»t
)

1011  
»t
;

1012 ià(
»fs
 == 0) {

1013 
»t
 = -
EROFS
;

1014 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

1015  
»t
;

1018 
»fs
 = 1;

1019 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
 ||

1020 
	`bŒfs_h—d”_back»f_»v
(
buf
è< 
BTRFS_MIXED_BACKREF_REV
)

1021 
æags
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

1023 
æags
 = 0;

1026 
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
buf
);

1027 
	`BUG_ON
(
owÃr
 =ð
BTRFS_TREE_RELOC_OBJECTID
 &&

1028 !(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
));

1030 ià(
»fs
 > 1) {

1031 ià((
owÃr
 =ð
roÙ
->
roÙ_key
.
objeùid
 ||

1032 
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
) &&

1033 !(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)) {

1034 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
buf
, 1);

1035 
	`BUG_ON
(
»t
);

1037 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

1038 
BTRFS_TREE_RELOC_OBJECTID
) {

1039 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
buf
, 0);

1040 
	`BUG_ON
(
»t
);

1041 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

1042 
	`BUG_ON
(
»t
);

1044 
Ãw_æags
 |ð
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

1047 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

1048 
BTRFS_TREE_RELOC_OBJECTID
)

1049 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

1051 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 0);

1052 
	`BUG_ON
(
»t
);

1054 ià(
Ãw_æags
 != 0) {

1055 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

1057 
»t
 = 
	`bŒfs_£t_disk_ex‹Á_æags
(
Œªs
, 
fs_šfo
,

1058 
buf
->
¡¬t
,

1059 
buf
->
Ën
,

1060 
Ãw_æags
, 
Ëv–
, 0);

1061 ià(
»t
)

1062  
»t
;

1065 ià(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) {

1066 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

1067 
BTRFS_TREE_RELOC_OBJECTID
)

1068 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 1);

1070 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
cow
, 0);

1071 
	`BUG_ON
(
»t
);

1072 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
buf
, 1);

1073 
	`BUG_ON
(
»t
);

1075 
	`þ—n_Œ“_block
(
fs_šfo
, 
buf
);

1076 *
Ï¡_»f
 = 1;

1079 
	}
}

1093 
nošlše
 
	$__bŒfs_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1094 
bŒfs_roÙ
 *
roÙ
,

1095 
ex‹Á_bufãr
 *
buf
,

1096 
ex‹Á_bufãr
 *
·»Á
, 
·»Á_¦Ù
,

1097 
ex‹Á_bufãr
 **
cow_»t
,

1098 
u64
 
£¬ch_¡¬t
, u64 
em±y_size
)

1100 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1101 
bŒfs_disk_key
 
disk_key
;

1102 
ex‹Á_bufãr
 *
cow
;

1103 
Ëv–
, 
»t
;

1104 
Ï¡_»f
 = 0;

1105 
uÆock_Üig
 = 0;

1106 
u64
 
·»Á_¡¬t
 = 0;

1108 ià(*
cow_»t
 =ð
buf
)

1109 
uÆock_Üig
 = 1;

1111 
	`bŒfs_as£¹_Œ“_locked
(
buf
);

1113 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

1114 
Œªs
->
Œªsid
 !ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
->transid);

1115 
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

1116 
Œªs
->
Œªsid
 !ð
roÙ
->
Ï¡_Œªs
);

1118 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

1120 ià(
Ëv–
 == 0)

1121 
	`bŒfs_™em_key
(
buf
, &
disk_key
, 0);

1123 
	`bŒfs_node_key
(
buf
, &
disk_key
, 0);

1125 ià((
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
è&& 
·»Á
)

1126 
·»Á_¡¬t
 = 
·»Á
->
¡¬t
;

1128 
cow
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 
·»Á_¡¬t
,

1129 
roÙ
->
roÙ_key
.
objeùid
, &
disk_key
, 
Ëv–
,

1130 
£¬ch_¡¬t
, 
em±y_size
);

1131 ià(
	`IS_ERR
(
cow
))

1132  
	`PTR_ERR
(
cow
);

1136 
	`cÝy_ex‹Á_bufãr_fuÎ
(
cow
, 
buf
);

1137 
	`bŒfs_£t_h—d”_by‹Ä
(
cow
, cow->
¡¬t
);

1138 
	`bŒfs_£t_h—d”_g’”©iÚ
(
cow
, 
Œªs
->
Œªsid
);

1139 
	`bŒfs_£t_h—d”_back»f_»v
(
cow
, 
BTRFS_MIXED_BACKREF_REV
);

1140 
	`bŒfs_þ—r_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_WRITTEN
 |

1141 
BTRFS_HEADER_FLAG_RELOC
);

1142 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
)

1143 
	`bŒfs_£t_h—d”_æag
(
cow
, 
BTRFS_HEADER_FLAG_RELOC
);

1145 
	`bŒfs_£t_h—d”_owÃr
(
cow
, 
roÙ
->
roÙ_key
.
objeùid
);

1147 
	`wr™e_ex‹Á_bufãr_fsid
(
cow
, 
fs_šfo
->
fsid
);

1149 
»t
 = 
	`upd©e_»f_fÜ_cow
(
Œªs
, 
roÙ
, 
buf
, 
cow
, &
Ï¡_»f
);

1150 ià(
»t
) {

1151 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1152  
»t
;

1155 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
)) {

1156 
»t
 = 
	`bŒfs_»loc_cow_block
(
Œªs
, 
roÙ
, 
buf
, 
cow
);

1157 ià(
»t
) {

1158 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1159  
»t
;

1163 ià(
buf
 =ð
roÙ
->
node
) {

1164 
	`WARN_ON
(
·»Á
 &&…¬’ˆ!ð
buf
);

1165 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
 ||

1166 
	`bŒfs_h—d”_back»f_»v
(
buf
è< 
BTRFS_MIXED_BACKREF_REV
)

1167 
·»Á_¡¬t
 = 
buf
->
¡¬t
;

1169 
	`ex‹Á_bufãr_g‘
(
cow
);

1170 
	`Œ“_mod_log_£t_roÙ_poš‹r
(
roÙ
, 
cow
, 1);

1171 
	`rcu_assign_poš‹r
(
roÙ
->
node
, 
cow
);

1173 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
buf
, 
·»Á_¡¬t
,

1174 
Ï¡_»f
);

1175 
	`ä“_ex‹Á_bufãr
(
buf
);

1176 
	`add_roÙ_to_dœty_li¡
(
roÙ
);

1178 
	`WARN_ON
(
Œªs
->
Œªsid
 !ð
	`bŒfs_h—d”_g’”©iÚ
(
·»Á
));

1179 
	`Œ“_mod_log_š£¹_key
(
fs_šfo
, 
·»Á
, 
·»Á_¦Ù
,

1180 
MOD_LOG_KEY_REPLACE
, 
GFP_NOFS
);

1181 
	`bŒfs_£t_node_block±r
(
·»Á
, 
·»Á_¦Ù
,

1182 
cow
->
¡¬t
);

1183 
	`bŒfs_£t_node_±r_g’”©iÚ
(
·»Á
, 
·»Á_¦Ù
,

1184 
Œªs
->
Œªsid
);

1185 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

1186 ià(
Ï¡_»f
) {

1187 
»t
 = 
	`Œ“_mod_log_ä“_eb
(
fs_šfo
, 
buf
);

1188 ià(
»t
) {

1189 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1190  
»t
;

1193 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
buf
, 
·»Á_¡¬t
,

1194 
Ï¡_»f
);

1196 ià(
uÆock_Üig
)

1197 
	`bŒfs_Œ“_uÆock
(
buf
);

1198 
	`ä“_ex‹Á_bufãr_¡®e
(
buf
);

1199 
	`bŒfs_m¬k_bufãr_dœty
(
cow
);

1200 *
cow_»t
 = 
cow
;

1202 
	}
}

1208 
Œ“_mod_–em
 *

1209 
	$__Œ“_mod_log_Þde¡_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1210 
ex‹Á_bufãr
 *
eb_roÙ
, 
u64
 
time_£q
)

1212 
Œ“_mod_–em
 *
tm
;

1213 
Œ“_mod_–em
 *
found
 = 
NULL
;

1214 
u64
 
roÙ_logiÿl
 = 
eb_roÙ
->
¡¬t
;

1215 
loÝed
 = 0;

1217 ià(!
time_£q
)

1218  
NULL
;

1227 
tm
 = 
	`Œ“_mod_log_£¬ch_Þde¡
(
fs_šfo
, 
roÙ_logiÿl
,

1228 
time_£q
);

1229 ià(!
loÝed
 && !
tm
)

1230  
NULL
;

1236 ià(!
tm
)

1244 ià(
tm
->
Ý
 !ð
MOD_LOG_ROOT_REPLACE
)

1247 
found
 = 
tm
;

1248 
roÙ_logiÿl
 = 
tm
->
Þd_roÙ
.
logiÿl
;

1249 
loÝed
 = 1;

1253 ià(!
found
)

1254 
found
 = 
tm
;

1256  
found
;

1257 
	}
}

1265 
	$__Œ“_mod_log_»wšd
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
eb
,

1266 
u64
 
time_£q
, 
Œ“_mod_–em
 *
fœ¡_tm
)

1268 
u32
 
n
;

1269 
rb_node
 *
Ãxt
;

1270 
Œ“_mod_–em
 *
tm
 = 
fœ¡_tm
;

1271 
o_d¡
;

1272 
o_¤c
;

1273 
p_size
 = (
bŒfs_key_±r
);

1275 
n
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1276 
	`Œ“_mod_log_»ad_lock
(
fs_šfo
);

1277 
tm
 &&m->
£q
 >ð
time_£q
) {

1283 
tm
->
Ý
) {

1284 
MOD_LOG_KEY_REMOVE_WHILE_FREEING
:

1285 
	`BUG_ON
(
tm
->
¦Ù
 < 
n
);

1287 
MOD_LOG_KEY_REMOVE_WHILE_MOVING
:

1288 
MOD_LOG_KEY_REMOVE
:

1289 
	`bŒfs_£t_node_key
(
eb
, &
tm
->
key
,m->
¦Ù
);

1290 
	`bŒfs_£t_node_block±r
(
eb
, 
tm
->
¦Ù
,m->
block±r
);

1291 
	`bŒfs_£t_node_±r_g’”©iÚ
(
eb
, 
tm
->
¦Ù
,

1292 
tm
->
g’”©iÚ
);

1293 
n
++;

1295 
MOD_LOG_KEY_REPLACE
:

1296 
	`BUG_ON
(
tm
->
¦Ù
 >ð
n
);

1297 
	`bŒfs_£t_node_key
(
eb
, &
tm
->
key
,m->
¦Ù
);

1298 
	`bŒfs_£t_node_block±r
(
eb
, 
tm
->
¦Ù
,m->
block±r
);

1299 
	`bŒfs_£t_node_±r_g’”©iÚ
(
eb
, 
tm
->
¦Ù
,

1300 
tm
->
g’”©iÚ
);

1302 
MOD_LOG_KEY_ADD
:

1304 
n
--;

1306 
MOD_LOG_MOVE_KEYS
:

1307 
o_d¡
 = 
	`bŒfs_node_key_±r_off£t
(
tm
->
¦Ù
);

1308 
o_¤c
 = 
	`bŒfs_node_key_±r_off£t
(
tm
->
move
.
d¡_¦Ù
);

1309 
	`memmove_ex‹Á_bufãr
(
eb
, 
o_d¡
, 
o_¤c
,

1310 
tm
->
move
.
Ä_™ems
 * 
p_size
);

1312 
MOD_LOG_ROOT_REPLACE
:

1324 
Ãxt
 = 
	`rb_Ãxt
(&
tm
->
node
);

1325 ià(!
Ãxt
)

1327 
tm
 = 
	`rb_’Œy
(
Ãxt
, 
Œ“_mod_–em
, 
node
);

1328 ià(
tm
->
logiÿl
 !ð
fœ¡_tm
->logical)

1331 
	`Œ“_mod_log_»ad_uÆock
(
fs_šfo
);

1332 
	`bŒfs_£t_h—d”_Ä™ems
(
eb
, 
n
);

1333 
	}
}

1342 
ex‹Á_bufãr
 *

1343 
	$Œ“_mod_log_»wšd
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_·th
 *
·th
,

1344 
ex‹Á_bufãr
 *
eb
, 
u64
 
time_£q
)

1346 
ex‹Á_bufãr
 *
eb_»wš
;

1347 
Œ“_mod_–em
 *
tm
;

1349 ià(!
time_£q
)

1350  
eb
;

1352 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

1353  
eb
;

1355 
tm
 = 
	`Œ“_mod_log_£¬ch
(
fs_šfo
, 
eb
->
¡¬t
, 
time_£q
);

1356 ià(!
tm
)

1357  
eb
;

1359 
	`bŒfs_£t_·th_blockšg
(
·th
);

1360 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

1362 ià(
tm
->
Ý
 =ð
MOD_LOG_KEY_REMOVE_WHILE_FREEING
) {

1363 
	`BUG_ON
(
tm
->
¦Ù
 != 0);

1364 
eb_»wš
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
eb
->
¡¬t
);

1365 ià(!
eb_»wš
) {

1366 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

1367 
	`ä“_ex‹Á_bufãr
(
eb
);

1368  
NULL
;

1370 
	`bŒfs_£t_h—d”_by‹Ä
(
eb_»wš
, 
eb
->
¡¬t
);

1371 
	`bŒfs_£t_h—d”_back»f_»v
(
eb_»wš
,

1372 
	`bŒfs_h—d”_back»f_»v
(
eb
));

1373 
	`bŒfs_£t_h—d”_owÃr
(
eb_»wš
, 
	`bŒfs_h—d”_owÃr
(
eb
));

1374 
	`bŒfs_£t_h—d”_Ëv–
(
eb_»wš
, 
	`bŒfs_h—d”_Ëv–
(
eb
));

1376 
eb_»wš
 = 
	`bŒfs_þÚe_ex‹Á_bufãr
(
eb
);

1377 ià(!
eb_»wš
) {

1378 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

1379 
	`ä“_ex‹Á_bufãr
(
eb
);

1380  
NULL
;

1384 
	`bŒfs_þ—r_·th_blockšg
(
·th
, 
NULL
, 
BTRFS_READ_LOCK
);

1385 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

1386 
	`ä“_ex‹Á_bufãr
(
eb
);

1388 
	`ex‹Á_bufãr_g‘
(
eb_»wš
);

1389 
	`bŒfs_Œ“_»ad_lock
(
eb_»wš
);

1390 
	`__Œ“_mod_log_»wšd
(
fs_šfo
, 
eb_»wš
, 
time_£q
, 
tm
);

1391 
	`WARN_ON
(
	`bŒfs_h—d”_Ä™ems
(
eb_»wš
) >

1392 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

1394  
eb_»wš
;

1395 
	}
}

1404 
šlše
 
ex‹Á_bufãr
 *

1405 
	$g‘_Þd_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
)

1407 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1408 
Œ“_mod_–em
 *
tm
;

1409 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

1410 
ex‹Á_bufãr
 *
eb_roÙ
;

1411 
ex‹Á_bufãr
 *
Þd
;

1412 
Œ“_mod_roÙ
 *
Þd_roÙ
 = 
NULL
;

1413 
u64
 
Þd_g’”©iÚ
 = 0;

1414 
u64
 
logiÿl
;

1416 
eb_roÙ
 = 
	`bŒfs_»ad_lock_roÙ_node
(
roÙ
);

1417 
tm
 = 
	`__Œ“_mod_log_Þde¡_roÙ
(
fs_šfo
, 
eb_roÙ
, 
time_£q
);

1418 ià(!
tm
)

1419  
eb_roÙ
;

1421 ià(
tm
->
Ý
 =ð
MOD_LOG_ROOT_REPLACE
) {

1422 
Þd_roÙ
 = &
tm
->old_root;

1423 
Þd_g’”©iÚ
 = 
tm
->
g’”©iÚ
;

1424 
logiÿl
 = 
Þd_roÙ
->logical;

1426 
logiÿl
 = 
eb_roÙ
->
¡¬t
;

1429 
tm
 = 
	`Œ“_mod_log_£¬ch
(
fs_šfo
, 
logiÿl
, 
time_£q
);

1430 ià(
Þd_roÙ
 && 
tm
 &&m->
Ý
 !ð
MOD_LOG_KEY_REMOVE_WHILE_FREEING
) {

1431 
	`bŒfs_Œ“_»ad_uÆock
(
eb_roÙ
);

1432 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1433 
Þd
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
logiÿl
, 0);

1434 ià(
	`WARN_ON
(
	`IS_ERR
(
Þd
è|| !
	`ex‹Á_bufãr_u±od©e
(old))) {

1435 ià(!
	`IS_ERR
(
Þd
))

1436 
	`ä“_ex‹Á_bufãr
(
Þd
);

1437 
	`bŒfs_w¬n
(
fs_šfo
,

1439 
logiÿl
);

1441 
eb
 = 
	`bŒfs_þÚe_ex‹Á_bufãr
(
Þd
);

1442 
	`ä“_ex‹Á_bufãr
(
Þd
);

1444 } ià(
Þd_roÙ
) {

1445 
	`bŒfs_Œ“_»ad_uÆock
(
eb_roÙ
);

1446 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1447 
eb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
logiÿl
);

1449 
	`bŒfs_£t_lock_blockšg_rw
(
eb_roÙ
, 
BTRFS_READ_LOCK
);

1450 
eb
 = 
	`bŒfs_þÚe_ex‹Á_bufãr
(
eb_roÙ
);

1451 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb_roÙ
);

1452 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1455 ià(!
eb
)

1456  
NULL
;

1457 
	`ex‹Á_bufãr_g‘
(
eb
);

1458 
	`bŒfs_Œ“_»ad_lock
(
eb
);

1459 ià(
Þd_roÙ
) {

1460 
	`bŒfs_£t_h—d”_by‹Ä
(
eb
,ƒb->
¡¬t
);

1461 
	`bŒfs_£t_h—d”_back»f_»v
(
eb
, 
BTRFS_MIXED_BACKREF_REV
);

1462 
	`bŒfs_£t_h—d”_owÃr
(
eb
, 
	`bŒfs_h—d”_owÃr
(
eb_roÙ
));

1463 
	`bŒfs_£t_h—d”_Ëv–
(
eb
, 
Þd_roÙ
->
Ëv–
);

1464 
	`bŒfs_£t_h—d”_g’”©iÚ
(
eb
, 
Þd_g’”©iÚ
);

1466 ià(
tm
)

1467 
	`__Œ“_mod_log_»wšd
(
fs_šfo
, 
eb
, 
time_£q
, 
tm
);

1469 
	`WARN_ON
(
	`bŒfs_h—d”_Ëv–
(
eb
) != 0);

1470 
	`WARN_ON
(
	`bŒfs_h—d”_Ä™ems
(
eb
è> 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

1472  
eb
;

1473 
	}
}

1475 
	$bŒfs_Þd_roÙ_Ëv–
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
)

1477 
Œ“_mod_–em
 *
tm
;

1478 
Ëv–
;

1479 
ex‹Á_bufãr
 *
eb_roÙ
 = 
	`bŒfs_roÙ_node
(
roÙ
);

1481 
tm
 = 
	`__Œ“_mod_log_Þde¡_roÙ
(
roÙ
->
fs_šfo
, 
eb_roÙ
, 
time_£q
);

1482 ià(
tm
 &&m->
Ý
 =ð
MOD_LOG_ROOT_REPLACE
) {

1483 
Ëv–
 = 
tm
->
Þd_roÙ
.level;

1485 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb_roÙ
);

1487 
	`ä“_ex‹Á_bufãr
(
eb_roÙ
);

1489  
Ëv–
;

1490 
	}
}

1492 
šlše
 
	$should_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1493 
bŒfs_roÙ
 *
roÙ
,

1494 
ex‹Á_bufãr
 *
buf
)

1496 ià(
	`bŒfs_is_‹¡šg
(
roÙ
->
fs_šfo
))

1500 
	`smp_rmb
();

1513 ià(
	`bŒfs_h—d”_g’”©iÚ
(
buf
è=ð
Œªs
->
Œªsid
 &&

1514 !
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_WRITTEN
) &&

1515 !(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
 &&

1516 
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_RELOC
)) &&

1517 !
	`‹¡_b™
(
BTRFS_ROOT_FORCE_COW
, &
roÙ
->
¡©e
))

1520 
	}
}

1527 
nošlše
 
	$bŒfs_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1528 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

1529 
ex‹Á_bufãr
 *
·»Á
, 
·»Á_¦Ù
,

1530 
ex‹Á_bufãr
 **
cow_»t
)

1532 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1533 
u64
 
£¬ch_¡¬t
;

1534 
»t
;

1536 ià(
Œªs
->
Œª§ùiÚ
 !ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
)

1537 
	`WARN
(1, 
KERN_CRIT
 "trans %llu„unning %llu\n",

1538 
Œªs
->
Œªsid
,

1539 
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
Œªsid
);

1541 ià(
Œªs
->
Œªsid
 !ð
fs_šfo
->
g’”©iÚ
)

1542 
	`WARN
(1, 
KERN_CRIT
 "trans %llu„unning %llu\n",

1543 
Œªs
->
Œªsid
, 
fs_šfo
->
g’”©iÚ
);

1545 ià(!
	`should_cow_block
(
Œªs
, 
roÙ
, 
buf
)) {

1546 
Œªs
->
dœty
 = 
Œue
;

1547 *
cow_»t
 = 
buf
;

1551 
£¬ch_¡¬t
 = 
buf
->
¡¬t
 & ~((
u64
)
SZ_1G
 - 1);

1553 ià(
·»Á
)

1554 
	`bŒfs_£t_lock_blockšg
(
·»Á
);

1555 
	`bŒfs_£t_lock_blockšg
(
buf
);

1557 
»t
 = 
	`__bŒfs_cow_block
(
Œªs
, 
roÙ
, 
buf
, 
·»Á
,

1558 
·»Á_¦Ù
, 
cow_»t
, 
£¬ch_¡¬t
, 0);

1560 
	`Œaû_bŒfs_cow_block
(
roÙ
, 
buf
, *
cow_»t
);

1562  
»t
;

1563 
	}
}

1569 
	$þo£_blocks
(
u64
 
blockÄ
, u64 
Ùh”
, 
u32
 
blocksize
)

1571 ià(
blockÄ
 < 
Ùh”
 && oth” - (blockÄ + 
blocksize
) < 32768)

1573 ià(
blockÄ
 > 
Ùh”
 && blockÄ - (Ùh” + 
blocksize
) < 32768)

1576 
	}
}

1581 
	$comp_keys
(cÚ¡ 
bŒfs_disk_key
 *
disk
,

1582 cÚ¡ 
bŒfs_key
 *
k2
)

1584 
bŒfs_key
 
k1
;

1586 
	`bŒfs_disk_key_to_ýu
(&
k1
, 
disk
);

1588  
	`bŒfs_comp_ýu_keys
(&
k1
, 
k2
);

1589 
	}
}

1594 
	$bŒfs_comp_ýu_keys
(cÚ¡ 
bŒfs_key
 *
k1
, cÚ¡ bŒfs_key *
k2
)

1596 ià(
k1
->
objeùid
 > 
k2
->objectid)

1598 ià(
k1
->
objeùid
 < 
k2
->objectid)

1600 ià(
k1
->
ty³
 > 
k2
->type)

1602 ià(
k1
->
ty³
 < 
k2
->type)

1604 ià(
k1
->
off£t
 > 
k2
->offset)

1606 ià(
k1
->
off£t
 < 
k2
->offset)

1609 
	}
}

1616 
	$bŒfs_»®loc_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1617 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
·»Á
,

1618 
¡¬t_¦Ù
, 
u64
 *
Ï¡_»t
,

1619 
bŒfs_key
 *
´og»ss
)

1621 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1622 
ex‹Á_bufãr
 *
cur
;

1623 
u64
 
blockÄ
;

1624 
u64
 
g’
;

1625 
u64
 
£¬ch_¡¬t
 = *
Ï¡_»t
;

1626 
u64
 
Ï¡_block
 = 0;

1627 
u64
 
Ùh”
;

1628 
u32
 
·»Á_Ä™ems
;

1629 
’d_¦Ù
;

1630 
i
;

1631 
”r
 = 0;

1632 
·»Á_Ëv–
;

1633 
u±od©e
;

1634 
u32
 
blocksize
;

1635 
´og»ss_·s£d
 = 0;

1636 
bŒfs_disk_key
 
disk_key
;

1638 
·»Á_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

1640 
	`WARN_ON
(
Œªs
->
Œª§ùiÚ
 !ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
);

1641 
	`WARN_ON
(
Œªs
->
Œªsid
 !ð
fs_šfo
->
g’”©iÚ
);

1643 
·»Á_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

1644 
blocksize
 = 
fs_šfo
->
nodesize
;

1645 
’d_¦Ù
 = 
·»Á_Ä™ems
 - 1;

1647 ià(
·»Á_Ä™ems
 <= 1)

1650 
	`bŒfs_£t_lock_blockšg
(
·»Á
);

1652 
i
 = 
¡¬t_¦Ù
; i <ð
’d_¦Ù
; i++) {

1653 
þo£
 = 1;

1655 
	`bŒfs_node_key
(
·»Á
, &
disk_key
, 
i
);

1656 ià(!
´og»ss_·s£d
 && 
	`comp_keys
(&
disk_key
, 
´og»ss
) < 0)

1659 
´og»ss_·s£d
 = 1;

1660 
blockÄ
 = 
	`bŒfs_node_block±r
(
·»Á
, 
i
);

1661 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
i
);

1662 ià(
Ï¡_block
 == 0)

1663 
Ï¡_block
 = 
blockÄ
;

1665 ià(
i
 > 0) {

1666 
Ùh”
 = 
	`bŒfs_node_block±r
(
·»Á
, 
i
 - 1);

1667 
þo£
 = 
	`þo£_blocks
(
blockÄ
, 
Ùh”
, 
blocksize
);

1669 ià(!
þo£
 && 
i
 < 
’d_¦Ù
) {

1670 
Ùh”
 = 
	`bŒfs_node_block±r
(
·»Á
, 
i
 + 1);

1671 
þo£
 = 
	`þo£_blocks
(
blockÄ
, 
Ùh”
, 
blocksize
);

1673 ià(
þo£
) {

1674 
Ï¡_block
 = 
blockÄ
;

1678 
cur
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
blockÄ
);

1679 ià(
cur
)

1680 
u±od©e
 = 
	`bŒfs_bufãr_u±od©e
(
cur
, 
g’
, 0);

1682 
u±od©e
 = 0;

1683 ià(!
cur
 || !
u±od©e
) {

1684 ià(!
cur
) {

1685 
cur
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
blockÄ
, 
g’
);

1686 ià(
	`IS_ERR
(
cur
)) {

1687  
	`PTR_ERR
(
cur
);

1688 } ià(!
	`ex‹Á_bufãr_u±od©e
(
cur
)) {

1689 
	`ä“_ex‹Á_bufãr
(
cur
);

1690  -
EIO
;

1692 } ià(!
u±od©e
) {

1693 
”r
 = 
	`bŒfs_»ad_bufãr
(
cur
, 
g’
);

1694 ià(
”r
) {

1695 
	`ä“_ex‹Á_bufãr
(
cur
);

1696  
”r
;

1700 ià(
£¬ch_¡¬t
 == 0)

1701 
£¬ch_¡¬t
 = 
Ï¡_block
;

1703 
	`bŒfs_Œ“_lock
(
cur
);

1704 
	`bŒfs_£t_lock_blockšg
(
cur
);

1705 
”r
 = 
	`__bŒfs_cow_block
(
Œªs
, 
roÙ
, 
cur
, 
·»Á
, 
i
,

1706 &
cur
, 
£¬ch_¡¬t
,

1707 
	`mš
(16 * 
blocksize
,

1708 (
’d_¦Ù
 - 
i
è* 
blocksize
));

1709 ià(
”r
) {

1710 
	`bŒfs_Œ“_uÆock
(
cur
);

1711 
	`ä“_ex‹Á_bufãr
(
cur
);

1714 
£¬ch_¡¬t
 = 
cur
->
¡¬t
;

1715 
Ï¡_block
 = 
cur
->
¡¬t
;

1716 *
Ï¡_»t
 = 
£¬ch_¡¬t
;

1717 
	`bŒfs_Œ“_uÆock
(
cur
);

1718 
	`ä“_ex‹Á_bufãr
(
cur
);

1720  
”r
;

1721 
	}
}

1733 
nošlše
 
	$g’”ic_bš_£¬ch
(
ex‹Á_bufãr
 *
eb
,

1734 
p
, 
™em_size
,

1735 cÚ¡ 
bŒfs_key
 *
key
,

1736 
max
, *
¦Ù
)

1738 
low
 = 0;

1739 
high
 = 
max
;

1740 
mid
;

1741 
»t
;

1742 
bŒfs_disk_key
 *
tmp
 = 
NULL
;

1743 
bŒfs_disk_key
 
uÇligÃd
;

1744 
off£t
;

1745 *
kaddr
 = 
NULL
;

1746 
m­_¡¬t
 = 0;

1747 
m­_Ën
 = 0;

1748 
”r
;

1750 ià(
low
 > 
high
) {

1751 
	`bŒfs_”r
(
eb
->
fs_šfo
,

1753 
__func__
, 
low
, 
high
, 
eb
->
¡¬t
,

1754 
	`bŒfs_h—d”_owÃr
(
eb
), 
	`bŒfs_h—d”_Ëv–
(eb));

1755  -
EINVAL
;

1758 
low
 < 
high
) {

1759 
mid
 = (
low
 + 
high
) / 2;

1760 
off£t
 = 
p
 + 
mid
 * 
™em_size
;

1762 ià(!
kaddr
 || 
off£t
 < 
m­_¡¬t
 ||

1763 (
off£t
 + (
bŒfs_disk_key
)) >

1764 
m­_¡¬t
 + 
m­_Ën
) {

1766 
”r
 = 
	`m­_´iv©e_ex‹Á_bufãr
(
eb
, 
off£t
,

1767 (
bŒfs_disk_key
),

1768 &
kaddr
, &
m­_¡¬t
, &
m­_Ën
);

1770 ià(!
”r
) {

1771 
tmp
 = (
bŒfs_disk_key
 *)(
kaddr
 + 
off£t
 -

1772 
m­_¡¬t
);

1773 } ià(
”r
 == 1) {

1774 
	`»ad_ex‹Á_bufãr
(
eb
, &
uÇligÃd
,

1775 
off£t
, (
uÇligÃd
));

1776 
tmp
 = &
uÇligÃd
;

1778  
”r
;

1782 
tmp
 = (
bŒfs_disk_key
 *)(
kaddr
 + 
off£t
 -

1783 
m­_¡¬t
);

1785 
»t
 = 
	`comp_keys
(
tmp
, 
key
);

1787 ià(
»t
 < 0)

1788 
low
 = 
mid
 + 1;

1789 ià(
»t
 > 0)

1790 
high
 = 
mid
;

1792 *
¦Ù
 = 
mid
;

1796 *
¦Ù
 = 
low
;

1798 
	}
}

1804 
	$bš_£¬ch
(
ex‹Á_bufãr
 *
eb
, cÚ¡ 
bŒfs_key
 *
key
,

1805 
Ëv–
, *
¦Ù
)

1807 ià(
Ëv–
 == 0)

1808  
	`g’”ic_bš_£¬ch
(
eb
,

1809 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
),

1810 (
bŒfs_™em
),

1811 
key
, 
	`bŒfs_h—d”_Ä™ems
(
eb
),

1812 
¦Ù
);

1814  
	`g’”ic_bš_£¬ch
(
eb
,

1815 
	`off£tof
(
bŒfs_node
, 
±rs
),

1816 (
bŒfs_key_±r
),

1817 
key
, 
	`bŒfs_h—d”_Ä™ems
(
eb
),

1818 
¦Ù
);

1819 
	}
}

1821 
	$bŒfs_bš_£¬ch
(
ex‹Á_bufãr
 *
eb
, cÚ¡ 
bŒfs_key
 *
key
,

1822 
Ëv–
, *
¦Ù
)

1824  
	`bš_£¬ch
(
eb
, 
key
, 
Ëv–
, 
¦Ù
);

1825 
	}
}

1827 
	$roÙ_add_u£d
(
bŒfs_roÙ
 *
roÙ
, 
u32
 
size
)

1829 
	`¥š_lock
(&
roÙ
->
accouÁšg_lock
);

1830 
	`bŒfs_£t_roÙ_u£d
(&
roÙ
->
roÙ_™em
,

1831 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
è+ 
size
);

1832 
	`¥š_uÆock
(&
roÙ
->
accouÁšg_lock
);

1833 
	}
}

1835 
	$roÙ_sub_u£d
(
bŒfs_roÙ
 *
roÙ
, 
u32
 
size
)

1837 
	`¥š_lock
(&
roÙ
->
accouÁšg_lock
);

1838 
	`bŒfs_£t_roÙ_u£d
(&
roÙ
->
roÙ_™em
,

1839 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
è- 
size
);

1840 
	`¥š_uÆock
(&
roÙ
->
accouÁšg_lock
);

1841 
	}
}

1846 
nošlše
 
ex‹Á_bufãr
 *

1847 
	$»ad_node_¦Ù
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
·»Á
,

1848 
¦Ù
)

1850 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

1851 
ex‹Á_bufãr
 *
eb
;

1853 ià(
¦Ù
 < 0 || slÙ >ð
	`bŒfs_h—d”_Ä™ems
(
·»Á
))

1854  
	`ERR_PTR
(-
ENOENT
);

1856 
	`BUG_ON
(
Ëv–
 == 0);

1858 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
	`bŒfs_node_block±r
(
·»Á
, 
¦Ù
),

1859 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
));

1860 ià(!
	`IS_ERR
(
eb
è&& !
	`ex‹Á_bufãr_u±od©e
(eb)) {

1861 
	`ä“_ex‹Á_bufãr
(
eb
);

1862 
eb
 = 
	`ERR_PTR
(-
EIO
);

1865  
eb
;

1866 
	}
}

1873 
nošlše
 
	$b®ªû_Ëv–
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1874 
bŒfs_roÙ
 *
roÙ
,

1875 
bŒfs_·th
 *
·th
, 
Ëv–
)

1877 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1878 
ex‹Á_bufãr
 *
right
 = 
NULL
;

1879 
ex‹Á_bufãr
 *
mid
;

1880 
ex‹Á_bufãr
 *
Ëá
 = 
NULL
;

1881 
ex‹Á_bufãr
 *
·»Á
 = 
NULL
;

1882 
»t
 = 0;

1883 
w»t
;

1884 
p¦Ù
;

1885 
Üig_¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

1886 
u64
 
Üig_±r
;

1888 ià(
Ëv–
 == 0)

1891 
mid
 = 
·th
->
nodes
[
Ëv–
];

1893 
	`WARN_ON
(
·th
->
locks
[
Ëv–
] !ð
BTRFS_WRITE_LOCK
 &&

1894 
·th
->
locks
[
Ëv–
] !ð
BTRFS_WRITE_LOCK_BLOCKING
);

1895 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
mid
è!ð
Œªs
->
Œªsid
);

1897 
Üig_±r
 = 
	`bŒfs_node_block±r
(
mid
, 
Üig_¦Ù
);

1899 ià(
Ëv–
 < 
BTRFS_MAX_LEVEL
 - 1) {

1900 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1];

1901 
p¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

1908 ià(!
·»Á
) {

1909 
ex‹Á_bufãr
 *
chžd
;

1911 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) != 1)

1915 
chžd
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
mid
, 0);

1916 ià(
	`IS_ERR
(
chžd
)) {

1917 
»t
 = 
	`PTR_ERR
(
chžd
);

1918 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

1919 
’o¥c
;

1922 
	`bŒfs_Œ“_lock
(
chžd
);

1923 
	`bŒfs_£t_lock_blockšg
(
chžd
);

1924 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
chžd
, 
mid
, 0, &child);

1925 ià(
»t
) {

1926 
	`bŒfs_Œ“_uÆock
(
chžd
);

1927 
	`ä“_ex‹Á_bufãr
(
chžd
);

1928 
’o¥c
;

1931 
	`Œ“_mod_log_£t_roÙ_poš‹r
(
roÙ
, 
chžd
, 1);

1932 
	`rcu_assign_poš‹r
(
roÙ
->
node
, 
chžd
);

1934 
	`add_roÙ_to_dœty_li¡
(
roÙ
);

1935 
	`bŒfs_Œ“_uÆock
(
chžd
);

1937 
·th
->
locks
[
Ëv–
] = 0;

1938 
·th
->
nodes
[
Ëv–
] = 
NULL
;

1939 
	`þ—n_Œ“_block
(
fs_šfo
, 
mid
);

1940 
	`bŒfs_Œ“_uÆock
(
mid
);

1942 
	`ä“_ex‹Á_bufãr
(
mid
);

1944 
	`roÙ_sub_u£d
(
roÙ
, 
mid
->
Ën
);

1945 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
mid
, 0, 1);

1947 
	`ä“_ex‹Á_bufãr_¡®e
(
mid
);

1950 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) >

1951 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) / 4)

1954 
Ëá
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
·»Á
, 
p¦Ù
 - 1);

1955 ià(
	`IS_ERR
(
Ëá
))

1956 
Ëá
 = 
NULL
;

1958 ià(
Ëá
) {

1959 
	`bŒfs_Œ“_lock
(
Ëá
);

1960 
	`bŒfs_£t_lock_blockšg
(
Ëá
);

1961 
w»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëá
,

1962 
·»Á
, 
p¦Ù
 - 1, &
Ëá
);

1963 ià(
w»t
) {

1964 
»t
 = 
w»t
;

1965 
’o¥c
;

1969 
right
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
·»Á
, 
p¦Ù
 + 1);

1970 ià(
	`IS_ERR
(
right
))

1971 
right
 = 
NULL
;

1973 ià(
right
) {

1974 
	`bŒfs_Œ“_lock
(
right
);

1975 
	`bŒfs_£t_lock_blockšg
(
right
);

1976 
w»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
right
,

1977 
·»Á
, 
p¦Ù
 + 1, &
right
);

1978 ià(
w»t
) {

1979 
»t
 = 
w»t
;

1980 
’o¥c
;

1985 ià(
Ëá
) {

1986 
Üig_¦Ù
 +ð
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

1987 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
fs_šfo
, 
Ëá
, 
mid
, 1);

1988 ià(
w»t
 < 0)

1989 
»t
 = 
w»t
;

1995 ià(
right
) {

1996 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
fs_šfo
, 
mid
, 
right
, 1);

1997 ià(
w»t
 < 0 && w»ˆ!ð-
ENOSPC
)

1998 
»t
 = 
w»t
;

1999 ià(
	`bŒfs_h—d”_Ä™ems
(
right
) == 0) {

2000 
	`þ—n_Œ“_block
(
fs_šfo
, 
right
);

2001 
	`bŒfs_Œ“_uÆock
(
right
);

2002 
	`d–_±r
(
roÙ
, 
·th
, 
Ëv–
 + 1, 
p¦Ù
 + 1);

2003 
	`roÙ_sub_u£d
(
roÙ
, 
right
->
Ën
);

2004 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
right
, 0, 1);

2005 
	`ä“_ex‹Á_bufãr_¡®e
(
right
);

2006 
right
 = 
NULL
;

2008 
bŒfs_disk_key
 
right_key
;

2009 
	`bŒfs_node_key
(
right
, &
right_key
, 0);

2010 
	`Œ“_mod_log_£t_node_key
(
fs_šfo
, 
·»Á
,

2011 
p¦Ù
 + 1, 0);

2012 
	`bŒfs_£t_node_key
(
·»Á
, &
right_key
, 
p¦Ù
 + 1);

2013 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

2016 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) == 1) {

2026 ià(!
Ëá
) {

2027 
»t
 = -
EROFS
;

2028 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

2029 
’o¥c
;

2031 
w»t
 = 
	`b®ªû_node_right
(
Œªs
, 
fs_šfo
, 
mid
, 
Ëá
);

2032 ià(
w»t
 < 0) {

2033 
»t
 = 
w»t
;

2034 
’o¥c
;

2036 ià(
w»t
 == 1) {

2037 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
fs_šfo
, 
Ëá
, 
mid
, 1);

2038 ià(
w»t
 < 0)

2039 
»t
 = 
w»t
;

2041 
	`BUG_ON
(
w»t
 == 1);

2043 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
) == 0) {

2044 
	`þ—n_Œ“_block
(
fs_šfo
, 
mid
);

2045 
	`bŒfs_Œ“_uÆock
(
mid
);

2046 
	`d–_±r
(
roÙ
, 
·th
, 
Ëv–
 + 1, 
p¦Ù
);

2047 
	`roÙ_sub_u£d
(
roÙ
, 
mid
->
Ën
);

2048 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
mid
, 0, 1);

2049 
	`ä“_ex‹Á_bufãr_¡®e
(
mid
);

2050 
mid
 = 
NULL
;

2053 
bŒfs_disk_key
 
mid_key
;

2054 
	`bŒfs_node_key
(
mid
, &
mid_key
, 0);

2055 
	`Œ“_mod_log_£t_node_key
(
fs_šfo
, 
·»Á
, 
p¦Ù
, 0);

2056 
	`bŒfs_£t_node_key
(
·»Á
, &
mid_key
, 
p¦Ù
);

2057 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

2061 ià(
Ëá
) {

2062 ià(
	`bŒfs_h—d”_Ä™ems
(
Ëá
è> 
Üig_¦Ù
) {

2063 
	`ex‹Á_bufãr_g‘
(
Ëá
);

2065 
·th
->
nodes
[
Ëv–
] = 
Ëá
;

2066 
·th
->
¦Ùs
[
Ëv–
 + 1] -= 1;

2067 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

2068 ià(
mid
) {

2069 
	`bŒfs_Œ“_uÆock
(
mid
);

2070 
	`ä“_ex‹Á_bufãr
(
mid
);

2073 
Üig_¦Ù
 -ð
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

2074 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

2078 ià(
Üig_±r
 !=

2079 
	`bŒfs_node_block±r
(
·th
->
nodes
[
Ëv–
],…©h->
¦Ùs
[level]))

2080 
	`BUG
();

2081 
’o¥c
:

2082 ià(
right
) {

2083 
	`bŒfs_Œ“_uÆock
(
right
);

2084 
	`ä“_ex‹Á_bufãr
(
right
);

2086 ià(
Ëá
) {

2087 ià(
·th
->
nodes
[
Ëv–
] !ð
Ëá
)

2088 
	`bŒfs_Œ“_uÆock
(
Ëá
);

2089 
	`ä“_ex‹Á_bufãr
(
Ëá
);

2091  
»t
;

2092 
	}
}

2098 
nošlše
 
	$push_nodes_fÜ_š£¹
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2099 
bŒfs_roÙ
 *
roÙ
,

2100 
bŒfs_·th
 *
·th
, 
Ëv–
)

2102 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2103 
ex‹Á_bufãr
 *
right
 = 
NULL
;

2104 
ex‹Á_bufãr
 *
mid
;

2105 
ex‹Á_bufãr
 *
Ëá
 = 
NULL
;

2106 
ex‹Á_bufãr
 *
·»Á
 = 
NULL
;

2107 
»t
 = 0;

2108 
w»t
;

2109 
p¦Ù
;

2110 
Üig_¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

2112 ià(
Ëv–
 == 0)

2115 
mid
 = 
·th
->
nodes
[
Ëv–
];

2116 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
mid
è!ð
Œªs
->
Œªsid
);

2118 ià(
Ëv–
 < 
BTRFS_MAX_LEVEL
 - 1) {

2119 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1];

2120 
p¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

2123 ià(!
·»Á
)

2126 
Ëá
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
·»Á
, 
p¦Ù
 - 1);

2127 ià(
	`IS_ERR
(
Ëá
))

2128 
Ëá
 = 
NULL
;

2131 ià(
Ëá
) {

2132 
u32
 
Ëá_Ä
;

2134 
	`bŒfs_Œ“_lock
(
Ëá
);

2135 
	`bŒfs_£t_lock_blockšg
(
Ëá
);

2137 
Ëá_Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

2138 ià(
Ëá_Ä
 >ð
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 1) {

2139 
w»t
 = 1;

2141 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëá
, 
·»Á
,

2142 
p¦Ù
 - 1, &
Ëá
);

2143 ià(
»t
)

2144 
w»t
 = 1;

2146 
w»t
 = 
	`push_node_Ëá
(
Œªs
, 
fs_šfo
,

2147 
Ëá
, 
mid
, 0);

2150 ià(
w»t
 < 0)

2151 
»t
 = 
w»t
;

2152 ià(
w»t
 == 0) {

2153 
bŒfs_disk_key
 
disk_key
;

2154 
Üig_¦Ù
 +ð
Ëá_Ä
;

2155 
	`bŒfs_node_key
(
mid
, &
disk_key
, 0);

2156 
	`Œ“_mod_log_£t_node_key
(
fs_šfo
, 
·»Á
, 
p¦Ù
, 0);

2157 
	`bŒfs_£t_node_key
(
·»Á
, &
disk_key
, 
p¦Ù
);

2158 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

2159 ià(
	`bŒfs_h—d”_Ä™ems
(
Ëá
è> 
Üig_¦Ù
) {

2160 
·th
->
nodes
[
Ëv–
] = 
Ëá
;

2161 
·th
->
¦Ùs
[
Ëv–
 + 1] -= 1;

2162 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

2163 
	`bŒfs_Œ“_uÆock
(
mid
);

2164 
	`ä“_ex‹Á_bufãr
(
mid
);

2166 
Üig_¦Ù
 -=

2167 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

2168 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
;

2169 
	`bŒfs_Œ“_uÆock
(
Ëá
);

2170 
	`ä“_ex‹Á_bufãr
(
Ëá
);

2174 
	`bŒfs_Œ“_uÆock
(
Ëá
);

2175 
	`ä“_ex‹Á_bufãr
(
Ëá
);

2177 
right
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
·»Á
, 
p¦Ù
 + 1);

2178 ià(
	`IS_ERR
(
right
))

2179 
right
 = 
NULL
;

2184 ià(
right
) {

2185 
u32
 
right_Ä
;

2187 
	`bŒfs_Œ“_lock
(
right
);

2188 
	`bŒfs_£t_lock_blockšg
(
right
);

2190 
right_Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

2191 ià(
right_Ä
 >ð
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 1) {

2192 
w»t
 = 1;

2194 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
right
,

2195 
·»Á
, 
p¦Ù
 + 1,

2196 &
right
);

2197 ià(
»t
)

2198 
w»t
 = 1;

2200 
w»t
 = 
	`b®ªû_node_right
(
Œªs
, 
fs_šfo
,

2201 
right
, 
mid
);

2204 ià(
w»t
 < 0)

2205 
»t
 = 
w»t
;

2206 ià(
w»t
 == 0) {

2207 
bŒfs_disk_key
 
disk_key
;

2209 
	`bŒfs_node_key
(
right
, &
disk_key
, 0);

2210 
	`Œ“_mod_log_£t_node_key
(
fs_šfo
, 
·»Á
,

2211 
p¦Ù
 + 1, 0);

2212 
	`bŒfs_£t_node_key
(
·»Á
, &
disk_key
, 
p¦Ù
 + 1);

2213 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

2215 ià(
	`bŒfs_h—d”_Ä™ems
(
mid
è<ð
Üig_¦Ù
) {

2216 
·th
->
nodes
[
Ëv–
] = 
right
;

2217 
·th
->
¦Ùs
[
Ëv–
 + 1] += 1;

2218 
·th
->
¦Ùs
[
Ëv–
] = 
Üig_¦Ù
 -

2219 
	`bŒfs_h—d”_Ä™ems
(
mid
);

2220 
	`bŒfs_Œ“_uÆock
(
mid
);

2221 
	`ä“_ex‹Á_bufãr
(
mid
);

2223 
	`bŒfs_Œ“_uÆock
(
right
);

2224 
	`ä“_ex‹Á_bufãr
(
right
);

2228 
	`bŒfs_Œ“_uÆock
(
right
);

2229 
	`ä“_ex‹Á_bufãr
(
right
);

2232 
	}
}

2238 
	$»ada_fÜ_£¬ch
(
bŒfs_fs_šfo
 *
fs_šfo
,

2239 
bŒfs_·th
 *
·th
,

2240 
Ëv–
, 
¦Ù
, 
u64
 
objeùid
)

2242 
ex‹Á_bufãr
 *
node
;

2243 
bŒfs_disk_key
 
disk_key
;

2244 
u32
 
Ä™ems
;

2245 
u64
 
£¬ch
;

2246 
u64
 
rg‘
;

2247 
u64
 
Ä—d
 = 0;

2248 
ex‹Á_bufãr
 *
eb
;

2249 
u32
 
Ä
;

2250 
u32
 
blocksize
;

2251 
u32
 
nsÿn
 = 0;

2253 ià(
Ëv–
 != 1)

2256 ià(!
·th
->
nodes
[
Ëv–
])

2259 
node
 = 
·th
->
nodes
[
Ëv–
];

2261 
£¬ch
 = 
	`bŒfs_node_block±r
(
node
, 
¦Ù
);

2262 
blocksize
 = 
fs_šfo
->
nodesize
;

2263 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
£¬ch
);

2264 ià(
eb
) {

2265 
	`ä“_ex‹Á_bufãr
(
eb
);

2269 
rg‘
 = 
£¬ch
;

2271 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
node
);

2272 
Ä
 = 
¦Ù
;

2275 ià(
·th
->
»ada
 =ð
READA_BACK
) {

2276 ià(
Ä
 == 0)

2278 
Ä
--;

2279 } ià(
·th
->
»ada
 =ð
READA_FORWARD
) {

2280 
Ä
++;

2281 ià(
Ä
 >ð
Ä™ems
)

2284 ià(
·th
->
»ada
 =ð
READA_BACK
 && 
objeùid
) {

2285 
	`bŒfs_node_key
(
node
, &
disk_key
, 
Ä
);

2286 ià(
	`bŒfs_disk_key_objeùid
(&
disk_key
è!ð
objeùid
)

2289 
£¬ch
 = 
	`bŒfs_node_block±r
(
node
, 
Ä
);

2290 ià((
£¬ch
 <ð
rg‘
 &&arget - search <= 65536) ||

2291 (
£¬ch
 > 
rg‘
 && search -arget <= 65536)) {

2292 
	`»adah—d_Œ“_block
(
fs_šfo
, 
£¬ch
);

2293 
Ä—d
 +ð
blocksize
;

2295 
nsÿn
++;

2296 ià((
Ä—d
 > 65536 || 
nsÿn
 > 32))

2299 
	}
}

2301 
nošlše
 
	$»ada_fÜ_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
,

2302 
bŒfs_·th
 *
·th
, 
Ëv–
)

2304 
¦Ù
;

2305 
Ä™ems
;

2306 
ex‹Á_bufãr
 *
·»Á
;

2307 
ex‹Á_bufãr
 *
eb
;

2308 
u64
 
g’
;

2309 
u64
 
block1
 = 0;

2310 
u64
 
block2
 = 0;

2312 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1];

2313 ià(!
·»Á
)

2316 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

2317 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

2319 ià(
¦Ù
 > 0) {

2320 
block1
 = 
	`bŒfs_node_block±r
(
·»Á
, 
¦Ù
 - 1);

2321 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
 - 1);

2322 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
block1
);

2328 ià(
eb
 && 
	`bŒfs_bufãr_u±od©e
Ób, 
g’
, 1) != 0)

2329 
block1
 = 0;

2330 
	`ä“_ex‹Á_bufãr
(
eb
);

2332 ià(
¦Ù
 + 1 < 
Ä™ems
) {

2333 
block2
 = 
	`bŒfs_node_block±r
(
·»Á
, 
¦Ù
 + 1);

2334 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
 + 1);

2335 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
block2
);

2336 ià(
eb
 && 
	`bŒfs_bufãr_u±od©e
Ób, 
g’
, 1) != 0)

2337 
block2
 = 0;

2338 
	`ä“_ex‹Á_bufãr
(
eb
);

2341 ià(
block1
)

2342 
	`»adah—d_Œ“_block
(
fs_šfo
, 
block1
);

2343 ià(
block2
)

2344 
	`»adah—d_Œ“_block
(
fs_šfo
, 
block2
);

2345 
	}
}

2361 
nošlše
 
	$uÆock_up
(
bŒfs_·th
 *
·th
, 
Ëv–
,

2362 
lowe¡_uÆock
, 
mš_wr™e_lock_Ëv–
,

2363 *
wr™e_lock_Ëv–
)

2365 
i
;

2366 
sk_Ëv–
 = 
Ëv–
;

2367 
no_sks
 = 0;

2368 
ex‹Á_bufãr
 *
t
;

2370 
i
 = 
Ëv–
; i < 
BTRFS_MAX_LEVEL
; i++) {

2371 ià(!
·th
->
nodes
[
i
])

2373 ià(!
·th
->
locks
[
i
])

2375 ià(!
no_sks
 && 
·th
->
¦Ùs
[
i
] == 0) {

2376 
sk_Ëv–
 = 
i
 + 1;

2379 ià(!
no_sks
 && 
·th
->
k“p_locks
) {

2380 
u32
 
Ä™ems
;

2381 
t
 = 
·th
->
nodes
[
i
];

2382 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
t
);

2383 ià(
Ä™ems
 < 1 || 
·th
->
¦Ùs
[
i
] >=‚ritems - 1) {

2384 
sk_Ëv–
 = 
i
 + 1;

2388 ià(
sk_Ëv–
 < 
i
 && i >ð
lowe¡_uÆock
)

2389 
no_sks
 = 1;

2391 
t
 = 
·th
->
nodes
[
i
];

2392 ià(
i
 >ð
lowe¡_uÆock
 && i > 
sk_Ëv–
 && 
·th
->
locks
[i]) {

2393 
	`bŒfs_Œ“_uÆock_rw
(
t
, 
·th
->
locks
[
i
]);

2394 
·th
->
locks
[
i
] = 0;

2395 ià(
wr™e_lock_Ëv–
 &&

2396 
i
 > 
mš_wr™e_lock_Ëv–
 &&

2397 
i
 <ð*
wr™e_lock_Ëv–
) {

2398 *
wr™e_lock_Ëv–
 = 
i
 - 1;

2402 
	}
}

2413 
nošlše
 
	$bŒfs_uÆock_up_§ã
(
bŒfs_·th
 *
·th
, 
Ëv–
)

2415 
i
;

2417 ià(
·th
->
k“p_locks
)

2420 
i
 = 
Ëv–
; i < 
BTRFS_MAX_LEVEL
; i++) {

2421 ià(!
·th
->
nodes
[
i
])

2423 ià(!
·th
->
locks
[
i
])

2425 
	`bŒfs_Œ“_uÆock_rw
(
·th
->
nodes
[
i
],…©h->
locks
[i]);

2426 
·th
->
locks
[
i
] = 0;

2428 
	}
}

2439 
	$»ad_block_fÜ_£¬ch
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
,

2440 
ex‹Á_bufãr
 **
eb_»t
, 
Ëv–
, 
¦Ù
,

2441 cÚ¡ 
bŒfs_key
 *
key
)

2443 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2444 
u64
 
blockÄ
;

2445 
u64
 
g’
;

2446 
ex‹Á_bufãr
 *
b
 = *
eb_»t
;

2447 
ex‹Á_bufãr
 *
tmp
;

2448 
»t
;

2450 
blockÄ
 = 
	`bŒfs_node_block±r
(
b
, 
¦Ù
);

2451 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
b
, 
¦Ù
);

2453 
tmp
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
blockÄ
);

2454 ià(
tmp
) {

2456 ià(
	`bŒfs_bufãr_u±od©e
(
tmp
, 
g’
, 1) > 0) {

2457 *
eb_»t
 = 
tmp
;

2467 
	`bŒfs_£t_·th_blockšg
(
p
);

2470 
»t
 = 
	`bŒfs_»ad_bufãr
(
tmp
, 
g’
);

2471 ià(!
»t
) {

2472 *
eb_»t
 = 
tmp
;

2475 
	`ä“_ex‹Á_bufãr
(
tmp
);

2476 
	`bŒfs_»Ëa£_·th
(
p
);

2477  -
EIO
;

2487 
	`bŒfs_uÆock_up_§ã
(
p
, 
Ëv–
 + 1);

2488 
	`bŒfs_£t_·th_blockšg
(
p
);

2490 
	`ä“_ex‹Á_bufãr
(
tmp
);

2491 ià(
p
->
»ada
 !ð
READA_NONE
)

2492 
	`»ada_fÜ_£¬ch
(
fs_šfo
, 
p
, 
Ëv–
, 
¦Ù
, 
key
->
objeùid
);

2494 
	`bŒfs_»Ëa£_·th
(
p
);

2496 
»t
 = -
EAGAIN
;

2497 
tmp
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
blockÄ
, 0);

2498 ià(!
	`IS_ERR
(
tmp
)) {

2505 ià(!
	`bŒfs_bufãr_u±od©e
(
tmp
, 0, 0))

2506 
»t
 = -
EIO
;

2507 
	`ä“_ex‹Á_bufãr
(
tmp
);

2509 
»t
 = 
	`PTR_ERR
(
tmp
);

2511  
»t
;

2512 
	}
}

2524 
	$£tup_nodes_fÜ_£¬ch
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2525 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
,

2526 
ex‹Á_bufãr
 *
b
, 
Ëv–
, 
šs_Ën
,

2527 *
wr™e_lock_Ëv–
)

2529 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2530 
»t
;

2532 ià((
p
->
£¬ch_fÜ_¥l™
 || 
šs_Ën
 > 0è&& 
	`bŒfs_h—d”_Ä™ems
(
b
) >=

2533 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 3) {

2534 
¤‘
;

2536 ià(*
wr™e_lock_Ëv–
 < 
Ëv–
 + 1) {

2537 *
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

2538 
	`bŒfs_»Ëa£_·th
(
p
);

2539 
agaš
;

2542 
	`bŒfs_£t_·th_blockšg
(
p
);

2543 
	`»ada_fÜ_b®ªû
(
fs_šfo
, 
p
, 
Ëv–
);

2544 
¤‘
 = 
	`¥l™_node
(
Œªs
, 
roÙ
, 
p
, 
Ëv–
);

2545 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
NULL
, 0);

2547 
	`BUG_ON
(
¤‘
 > 0);

2548 ià(
¤‘
) {

2549 
»t
 = 
¤‘
;

2550 
dÚe
;

2552 
b
 = 
p
->
nodes
[
Ëv–
];

2553 } ià(
šs_Ën
 < 0 && 
	`bŒfs_h—d”_Ä™ems
(
b
) <

2554 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) / 2) {

2555 
¤‘
;

2557 ià(*
wr™e_lock_Ëv–
 < 
Ëv–
 + 1) {

2558 *
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

2559 
	`bŒfs_»Ëa£_·th
(
p
);

2560 
agaš
;

2563 
	`bŒfs_£t_·th_blockšg
(
p
);

2564 
	`»ada_fÜ_b®ªû
(
fs_šfo
, 
p
, 
Ëv–
);

2565 
¤‘
 = 
	`b®ªû_Ëv–
(
Œªs
, 
roÙ
, 
p
, 
Ëv–
);

2566 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
NULL
, 0);

2568 ià(
¤‘
) {

2569 
»t
 = 
¤‘
;

2570 
dÚe
;

2572 
b
 = 
p
->
nodes
[
Ëv–
];

2573 ià(!
b
) {

2574 
	`bŒfs_»Ëa£_·th
(
p
);

2575 
agaš
;

2577 
	`BUG_ON
(
	`bŒfs_h—d”_Ä™ems
(
b
) == 1);

2581 
agaš
:

2582 
»t
 = -
EAGAIN
;

2583 
dÚe
:

2584  
»t
;

2585 
	}
}

2587 
	$key_£¬ch_v®id©e
(
ex‹Á_bufãr
 *
b
,

2588 cÚ¡ 
bŒfs_key
 *
key
,

2589 
Ëv–
)

2591 #ifdeà
CONFIG_BTRFS_ASSERT


2592 
bŒfs_disk_key
 
disk_key
;

2594 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
key
);

2596 ià(
Ëv–
 == 0)

2597 
	`ASSERT
(!
	`memcmp_ex‹Á_bufãr
(
b
, &
disk_key
,

2598 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
[0].
key
),

2599 (
disk_key
)));

2601 
	`ASSERT
(!
	`memcmp_ex‹Á_bufãr
(
b
, &
disk_key
,

2602 
	`off£tof
(
bŒfs_node
, 
±rs
[0].
key
),

2603 (
disk_key
)));

2605 
	}
}

2607 
	$key_£¬ch
(
ex‹Á_bufãr
 *
b
, cÚ¡ 
bŒfs_key
 *
key
,

2608 
Ëv–
, *
´ev_cmp
, *
¦Ù
)

2610 ià(*
´ev_cmp
 != 0) {

2611 *
´ev_cmp
 = 
	`bš_£¬ch
(
b
, 
key
, 
Ëv–
, 
¦Ù
);

2612  *
´ev_cmp
;

2615 
	`key_£¬ch_v®id©e
(
b
, 
key
, 
Ëv–
);

2616 *
¦Ù
 = 0;

2619 
	}
}

2621 
	$bŒfs_fšd_™em
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

2622 
u64
 
iobjeùid
, u64 
ioff
, 
u8
 
key_ty³
,

2623 
bŒfs_key
 *
found_key
)

2625 
»t
;

2626 
bŒfs_key
 
key
;

2627 
ex‹Á_bufãr
 *
eb
;

2629 
	`ASSERT
(
·th
);

2630 
	`ASSERT
(
found_key
);

2632 
key
.
ty³
 = 
key_ty³
;

2633 
key
.
objeùid
 = 
iobjeùid
;

2634 
key
.
off£t
 = 
ioff
;

2636 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_roÙ
, &
key
, 
·th
, 0, 0);

2637 ià(
»t
 < 0)

2638  
»t
;

2640 
eb
 = 
·th
->
nodes
[0];

2641 ià(
»t
 && 
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

2642 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
fs_roÙ
, 
·th
);

2643 ià(
»t
)

2644  
»t
;

2645 
eb
 = 
·th
->
nodes
[0];

2648 
	`bŒfs_™em_key_to_ýu
(
eb
, 
found_key
, 
·th
->
¦Ùs
[0]);

2649 ià(
found_key
->
ty³
 !ð
key
.type ||

2650 
found_key
->
objeùid
 !ð
key
.objectid)

2654 
	}
}

2669 
	$bŒfs_£¬ch_¦Ù
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2670 cÚ¡ 
bŒfs_key
 *
key
, 
bŒfs_·th
 *
p
,

2671 
šs_Ën
, 
cow
)

2673 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2674 
ex‹Á_bufãr
 *
b
;

2675 
¦Ù
;

2676 
»t
;

2677 
”r
;

2678 
Ëv–
;

2679 
lowe¡_uÆock
 = 1;

2680 
roÙ_lock
;

2682 
wr™e_lock_Ëv–
 = 0;

2683 
u8
 
lowe¡_Ëv–
 = 0;

2684 
mš_wr™e_lock_Ëv–
;

2685 
´ev_cmp
;

2687 
lowe¡_Ëv–
 = 
p
->lowest_level;

2688 
	`WARN_ON
(
lowe¡_Ëv–
 && 
šs_Ën
 > 0);

2689 
	`WARN_ON
(
p
->
nodes
[0] !ð
NULL
);

2690 
	`BUG_ON
(!
cow
 && 
šs_Ën
);

2692 ià(
šs_Ën
 < 0) {

2693 
lowe¡_uÆock
 = 2;

2699 
wr™e_lock_Ëv–
 = 2;

2700 } ià(
šs_Ën
 > 0) {

2705 
wr™e_lock_Ëv–
 = 1;

2708 ià(!
cow
)

2709 
wr™e_lock_Ëv–
 = -1;

2711 ià(
cow
 && (
p
->
k“p_locks
 ||…->
lowe¡_Ëv–
))

2712 
wr™e_lock_Ëv–
 = 
BTRFS_MAX_LEVEL
;

2714 
mš_wr™e_lock_Ëv–
 = 
wr™e_lock_Ëv–
;

2716 
agaš
:

2717 
´ev_cmp
 = -1;

2721 
roÙ_lock
 = 
BTRFS_READ_LOCK
;

2722 
Ëv–
 = 0;

2723 ià(
p
->
£¬ch_comm™_roÙ
) {

2728 ià(
p
->
Ãed_comm™_£m
)

2729 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

2730 
b
 = 
roÙ
->
comm™_roÙ
;

2731 
	`ex‹Á_bufãr_g‘
(
b
);

2732 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2733 ià(
p
->
Ãed_comm™_£m
)

2734 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

2735 ià(!
p
->
sk_lockšg
)

2736 
	`bŒfs_Œ“_»ad_lock
(
b
);

2738 ià(
p
->
sk_lockšg
) {

2739 
b
 = 
	`bŒfs_roÙ_node
(
roÙ
);

2740 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2745 
b
 = 
	`bŒfs_»ad_lock_roÙ_node
(
roÙ
);

2746 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2747 ià(
Ëv–
 <ð
wr™e_lock_Ëv–
) {

2749 
	`bŒfs_Œ“_»ad_uÆock
(
b
);

2750 
	`ä“_ex‹Á_bufãr
(
b
);

2751 
b
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

2752 
roÙ_lock
 = 
BTRFS_WRITE_LOCK
;

2755 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2759 
p
->
nodes
[
Ëv–
] = 
b
;

2760 ià(!
p
->
sk_lockšg
)

2761 
p
->
locks
[
Ëv–
] = 
roÙ_lock
;

2763 
b
) {

2764 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2770 ià(
cow
) {

2776 ià(!
	`should_cow_block
(
Œªs
, 
roÙ
, 
b
)) {

2777 
Œªs
->
dœty
 = 
Œue
;

2778 
cow_dÚe
;

2785 ià(
Ëv–
 > 
wr™e_lock_Ëv–
 ||

2786 (
Ëv–
 + 1 > 
wr™e_lock_Ëv–
 &&

2787 
Ëv–
 + 1 < 
BTRFS_MAX_LEVEL
 &&

2788 
p
->
nodes
[
Ëv–
 + 1])) {

2789 
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

2790 
	`bŒfs_»Ëa£_·th
(
p
);

2791 
agaš
;

2794 
	`bŒfs_£t_·th_blockšg
(
p
);

2795 
”r
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
b
,

2796 
p
->
nodes
[
Ëv–
 + 1],

2797 
p
->
¦Ùs
[
Ëv–
 + 1], &
b
);

2798 ià(
”r
) {

2799 
»t
 = 
”r
;

2800 
dÚe
;

2803 
cow_dÚe
:

2804 
p
->
nodes
[
Ëv–
] = 
b
;

2805 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
NULL
, 0);

2818 ià(!
šs_Ën
 && !
p
->
k“p_locks
) {

2819 
u
 = 
Ëv–
 + 1;

2821 ià(
u
 < 
BTRFS_MAX_LEVEL
 && 
p
->
locks
[u]) {

2822 
	`bŒfs_Œ“_uÆock_rw
(
p
->
nodes
[
u
],…->
locks
[u]);

2823 
p
->
locks
[
u
] = 0;

2827 
»t
 = 
	`key_£¬ch
(
b
, 
key
, 
Ëv–
, &
´ev_cmp
, &
¦Ù
);

2828 ià(
»t
 < 0)

2829 
dÚe
;

2831 ià(
Ëv–
 != 0) {

2832 
dec
 = 0;

2833 ià(
»t
 && 
¦Ù
 > 0) {

2834 
dec
 = 1;

2835 
¦Ù
 -= 1;

2837 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

2838 
”r
 = 
	`£tup_nodes_fÜ_£¬ch
(
Œªs
, 
roÙ
, 
p
, 
b
, 
Ëv–
,

2839 
šs_Ën
, &
wr™e_lock_Ëv–
);

2840 ià(
”r
 =ð-
EAGAIN
)

2841 
agaš
;

2842 ià(
”r
) {

2843 
»t
 = 
”r
;

2844 
dÚe
;

2846 
b
 = 
p
->
nodes
[
Ëv–
];

2847 
¦Ù
 = 
p
->
¦Ùs
[
Ëv–
];

2855 ià(
¦Ù
 =ð0 && 
šs_Ën
 &&

2856 
wr™e_lock_Ëv–
 < 
Ëv–
 + 1) {

2857 
wr™e_lock_Ëv–
 = 
Ëv–
 + 1;

2858 
	`bŒfs_»Ëa£_·th
(
p
);

2859 
agaš
;

2862 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
,

2863 
mš_wr™e_lock_Ëv–
, &
wr™e_lock_Ëv–
);

2865 ià(
Ëv–
 =ð
lowe¡_Ëv–
) {

2866 ià(
dec
)

2867 
p
->
¦Ùs
[
Ëv–
]++;

2868 
dÚe
;

2871 
”r
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
p
, &
b
, 
Ëv–
,

2872 
¦Ù
, 
key
);

2873 ià(
”r
 =ð-
EAGAIN
)

2874 
agaš
;

2875 ià(
”r
) {

2876 
»t
 = 
”r
;

2877 
dÚe
;

2880 ià(!
p
->
sk_lockšg
) {

2881 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2882 ià(
Ëv–
 <ð
wr™e_lock_Ëv–
) {

2883 
”r
 = 
	`bŒfs_Œy_Œ“_wr™e_lock
(
b
);

2884 ià(!
”r
) {

2885 
	`bŒfs_£t_·th_blockšg
(
p
);

2886 
	`bŒfs_Œ“_lock
(
b
);

2887 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
b
,

2888 
BTRFS_WRITE_LOCK
);

2890 
p
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK
;

2892 
”r
 = 
	`bŒfs_Œ“_»ad_lock_©omic
(
b
);

2893 ià(!
”r
) {

2894 
	`bŒfs_£t_·th_blockšg
(
p
);

2895 
	`bŒfs_Œ“_»ad_lock
(
b
);

2896 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
b
,

2897 
BTRFS_READ_LOCK
);

2899 
p
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

2901 
p
->
nodes
[
Ëv–
] = 
b
;

2904 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

2905 ià(
šs_Ën
 > 0 &&

2906 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
b
è< 
šs_Ën
) {

2907 ià(
wr™e_lock_Ëv–
 < 1) {

2908 
wr™e_lock_Ëv–
 = 1;

2909 
	`bŒfs_»Ëa£_·th
(
p
);

2910 
agaš
;

2913 
	`bŒfs_£t_·th_blockšg
(
p
);

2914 
”r
 = 
	`¥l™_Ëaf
(
Œªs
, 
roÙ
, 
key
,

2915 
p
, 
šs_Ën
, 
»t
 == 0);

2916 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
NULL
, 0);

2918 
	`BUG_ON
(
”r
 > 0);

2919 ià(
”r
) {

2920 
»t
 = 
”r
;

2921 
dÚe
;

2924 ià(!
p
->
£¬ch_fÜ_¥l™
)

2925 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
,

2926 
mš_wr™e_lock_Ëv–
, &
wr™e_lock_Ëv–
);

2927 
dÚe
;

2930 
»t
 = 1;

2931 
dÚe
:

2936 ià(!
p
->
Ëave_¥šnšg
)

2937 
	`bŒfs_£t_·th_blockšg
(
p
);

2938 ià(
»t
 < 0 && !
p
->
sk_»Ëa£_Ú_”rÜ
)

2939 
	`bŒfs_»Ëa£_·th
(
p
);

2940  
»t
;

2941 
	}
}

2954 
	$bŒfs_£¬ch_Þd_¦Ù
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
key
,

2955 
bŒfs_·th
 *
p
, 
u64
 
time_£q
)

2957 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2958 
ex‹Á_bufãr
 *
b
;

2959 
¦Ù
;

2960 
»t
;

2961 
”r
;

2962 
Ëv–
;

2963 
lowe¡_uÆock
 = 1;

2964 
u8
 
lowe¡_Ëv–
 = 0;

2965 
´ev_cmp
 = -1;

2967 
lowe¡_Ëv–
 = 
p
->lowest_level;

2968 
	`WARN_ON
(
p
->
nodes
[0] !ð
NULL
);

2970 ià(
p
->
£¬ch_comm™_roÙ
) {

2971 
	`BUG_ON
(
time_£q
);

2972  
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
p
, 0, 0);

2975 
agaš
:

2976 
b
 = 
	`g‘_Þd_roÙ
(
roÙ
, 
time_£q
);

2977 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2978 
p
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

2980 
b
) {

2981 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

2982 
p
->
nodes
[
Ëv–
] = 
b
;

2983 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
NULL
, 0);

2991 
	`bŒfs_uÆock_up_§ã
(
p
, 
Ëv–
 + 1);

2997 
´ev_cmp
 = -1;

2998 
»t
 = 
	`key_£¬ch
(
b
, 
key
, 
Ëv–
, &
´ev_cmp
, &
¦Ù
);

3000 ià(
Ëv–
 != 0) {

3001 
dec
 = 0;

3002 ià(
»t
 && 
¦Ù
 > 0) {

3003 
dec
 = 1;

3004 
¦Ù
 -= 1;

3006 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

3007 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
, 0, 
NULL
);

3009 ià(
Ëv–
 =ð
lowe¡_Ëv–
) {

3010 ià(
dec
)

3011 
p
->
¦Ùs
[
Ëv–
]++;

3012 
dÚe
;

3015 
”r
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
p
, &
b
, 
Ëv–
,

3016 
¦Ù
, 
key
);

3017 ià(
”r
 =ð-
EAGAIN
)

3018 
agaš
;

3019 ià(
”r
) {

3020 
»t
 = 
”r
;

3021 
dÚe
;

3024 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
b
);

3025 
”r
 = 
	`bŒfs_Œ“_»ad_lock_©omic
(
b
);

3026 ià(!
”r
) {

3027 
	`bŒfs_£t_·th_blockšg
(
p
);

3028 
	`bŒfs_Œ“_»ad_lock
(
b
);

3029 
	`bŒfs_þ—r_·th_blockšg
(
p
, 
b
,

3030 
BTRFS_READ_LOCK
);

3032 
b
 = 
	`Œ“_mod_log_»wšd
(
fs_šfo
, 
p
, b, 
time_£q
);

3033 ià(!
b
) {

3034 
»t
 = -
ENOMEM
;

3035 
dÚe
;

3037 
p
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

3038 
p
->
nodes
[
Ëv–
] = 
b
;

3040 
p
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

3041 
	`uÆock_up
(
p
, 
Ëv–
, 
lowe¡_uÆock
, 0, 
NULL
);

3042 
dÚe
;

3045 
»t
 = 1;

3046 
dÚe
:

3047 ià(!
p
->
Ëave_¥šnšg
)

3048 
	`bŒfs_£t_·th_blockšg
(
p
);

3049 ià(
»t
 < 0)

3050 
	`bŒfs_»Ëa£_·th
(
p
);

3052  
»t
;

3053 
	}
}

3067 
	$bŒfs_£¬ch_¦Ù_fÜ_»ad
(
bŒfs_roÙ
 *
roÙ
,

3068 cÚ¡ 
bŒfs_key
 *
key
,

3069 
bŒfs_·th
 *
p
, 
fšd_high”
,

3070 
»tuº_ªy
)

3072 
»t
;

3073 
ex‹Á_bufãr
 *
Ëaf
;

3075 
agaš
:

3076 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
p
, 0, 0);

3077 ià(
»t
 <= 0)

3078  
»t
;

3086 
Ëaf
 = 
p
->
nodes
[0];

3088 ià(
fšd_high”
) {

3089 ià(
p
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

3090 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
p
);

3091 ià(
»t
 <= 0)

3092  
»t
;

3093 ià(!
»tuº_ªy
)

3099 
»tuº_ªy
 = 0;

3100 
fšd_high”
 = 0;

3101 
	`bŒfs_»Ëa£_·th
(
p
);

3102 
agaš
;

3105 ià(
p
->
¦Ùs
[0] == 0) {

3106 
»t
 = 
	`bŒfs_´ev_Ëaf
(
roÙ
, 
p
);

3107 ià(
»t
 < 0)

3108  
»t
;

3109 ià(!
»t
) {

3110 
Ëaf
 = 
p
->
nodes
[0];

3111 ià(
p
->
¦Ùs
[0] =ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

3112 
p
->
¦Ùs
[0]--;

3115 ià(!
»tuº_ªy
)

3121 
»tuº_ªy
 = 0;

3122 
fšd_high”
 = 1;

3123 
	`bŒfs_»Ëa£_·th
(
p
);

3124 
agaš
;

3126 --
p
->
¦Ùs
[0];

3130 
	}
}

3140 
	$fixup_low_keys
(
bŒfs_fs_šfo
 *
fs_šfo
,

3141 
bŒfs_·th
 *
·th
,

3142 
bŒfs_disk_key
 *
key
, 
Ëv–
)

3144 
i
;

3145 
ex‹Á_bufãr
 *
t
;

3147 
i
 = 
Ëv–
; i < 
BTRFS_MAX_LEVEL
; i++) {

3148 
t¦Ù
 = 
·th
->
¦Ùs
[
i
];

3149 ià(!
·th
->
nodes
[
i
])

3151 
t
 = 
·th
->
nodes
[
i
];

3152 
	`Œ“_mod_log_£t_node_key
(
fs_šfo
, 
t
, 
t¦Ù
, 1);

3153 
	`bŒfs_£t_node_key
(
t
, 
key
, 
t¦Ù
);

3154 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[
i
]);

3155 ià(
t¦Ù
 != 0)

3158 
	}
}

3166 
	$bŒfs_£t_™em_key_§ã
(
bŒfs_fs_šfo
 *
fs_šfo
,

3167 
bŒfs_·th
 *
·th
,

3168 cÚ¡ 
bŒfs_key
 *
Ãw_key
)

3170 
bŒfs_disk_key
 
disk_key
;

3171 
ex‹Á_bufãr
 *
eb
;

3172 
¦Ù
;

3174 
eb
 = 
·th
->
nodes
[0];

3175 
¦Ù
 = 
·th
->
¦Ùs
[0];

3176 ià(
¦Ù
 > 0) {

3177 
	`bŒfs_™em_key
(
eb
, &
disk_key
, 
¦Ù
 - 1);

3178 
	`BUG_ON
(
	`comp_keys
(&
disk_key
, 
Ãw_key
) >= 0);

3180 ià(
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
eb
) - 1) {

3181 
	`bŒfs_™em_key
(
eb
, &
disk_key
, 
¦Ù
 + 1);

3182 
	`BUG_ON
(
	`comp_keys
(&
disk_key
, 
Ãw_key
) <= 0);

3185 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
Ãw_key
);

3186 
	`bŒfs_£t_™em_key
(
eb
, &
disk_key
, 
¦Ù
);

3187 
	`bŒfs_m¬k_bufãr_dœty
(
eb
);

3188 ià(
¦Ù
 == 0)

3189 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 1);

3190 
	}
}

3199 
	$push_node_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3200 
bŒfs_fs_šfo
 *
fs_šfo
,

3201 
ex‹Á_bufãr
 *
d¡
,

3202 
ex‹Á_bufãr
 *
¤c
, 
em±y
)

3204 
push_™ems
 = 0;

3205 
¤c_Ä™ems
;

3206 
d¡_Ä™ems
;

3207 
»t
 = 0;

3209 
¤c_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
¤c
);

3210 
d¡_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
d¡
);

3211 
push_™ems
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
è- 
d¡_Ä™ems
;

3212 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
¤c
è!ð
Œªs
->
Œªsid
);

3213 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
d¡
è!ð
Œªs
->
Œªsid
);

3215 ià(!
em±y
 && 
¤c_Ä™ems
 <= 8)

3218 ià(
push_™ems
 <= 0)

3221 ià(
em±y
) {

3222 
push_™ems
 = 
	`mš
(
¤c_Ä™ems
,…ush_items);

3223 ià(
push_™ems
 < 
¤c_Ä™ems
) {

3227 ià(
¤c_Ä™ems
 - 
push_™ems
 < 8) {

3228 ià(
push_™ems
 <= 8)

3230 
push_™ems
 -= 8;

3234 
push_™ems
 = 
	`mš
(
¤c_Ä™ems
 - 8,…ush_items);

3236 
»t
 = 
	`Œ“_mod_log_eb_cÝy
(
fs_šfo
, 
d¡
, 
¤c
, 
d¡_Ä™ems
, 0,

3237 
push_™ems
);

3238 ià(
»t
) {

3239 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3240  
»t
;

3242 
	`cÝy_ex‹Á_bufãr
(
d¡
, 
¤c
,

3243 
	`bŒfs_node_key_±r_off£t
(
d¡_Ä™ems
),

3244 
	`bŒfs_node_key_±r_off£t
(0),

3245 
push_™ems
 * (
bŒfs_key_±r
));

3247 ià(
push_™ems
 < 
¤c_Ä™ems
) {

3252 
	`memmove_ex‹Á_bufãr
(
¤c
, 
	`bŒfs_node_key_±r_off£t
(0),

3253 
	`bŒfs_node_key_±r_off£t
(
push_™ems
),

3254 (
¤c_Ä™ems
 - 
push_™ems
) *

3255 (
bŒfs_key_±r
));

3257 
	`bŒfs_£t_h—d”_Ä™ems
(
¤c
, 
¤c_Ä™ems
 - 
push_™ems
);

3258 
	`bŒfs_£t_h—d”_Ä™ems
(
d¡
, 
d¡_Ä™ems
 + 
push_™ems
);

3259 
	`bŒfs_m¬k_bufãr_dœty
(
¤c
);

3260 
	`bŒfs_m¬k_bufãr_dœty
(
d¡
);

3262  
»t
;

3263 
	}
}

3274 
	$b®ªû_node_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3275 
bŒfs_fs_šfo
 *
fs_šfo
,

3276 
ex‹Á_bufãr
 *
d¡
,

3277 
ex‹Á_bufãr
 *
¤c
)

3279 
push_™ems
 = 0;

3280 
max_push
;

3281 
¤c_Ä™ems
;

3282 
d¡_Ä™ems
;

3283 
»t
 = 0;

3285 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
¤c
è!ð
Œªs
->
Œªsid
);

3286 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
d¡
è!ð
Œªs
->
Œªsid
);

3288 
¤c_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
¤c
);

3289 
d¡_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
d¡
);

3290 
push_™ems
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
è- 
d¡_Ä™ems
;

3291 ià(
push_™ems
 <= 0)

3294 ià(
¤c_Ä™ems
 < 4)

3297 
max_push
 = 
¤c_Ä™ems
 / 2 + 1;

3299 ià(
max_push
 >ð
¤c_Ä™ems
)

3302 ià(
max_push
 < 
push_™ems
)

3303 
push_™ems
 = 
max_push
;

3305 
	`Œ“_mod_log_eb_move
(
fs_šfo
, 
d¡
, 
push_™ems
, 0, 
d¡_Ä™ems
);

3306 
	`memmove_ex‹Á_bufãr
(
d¡
, 
	`bŒfs_node_key_±r_off£t
(
push_™ems
),

3307 
	`bŒfs_node_key_±r_off£t
(0),

3308 (
d¡_Ä™ems
) *

3309 (
bŒfs_key_±r
));

3311 
»t
 = 
	`Œ“_mod_log_eb_cÝy
(
fs_šfo
, 
d¡
, 
¤c
, 0,

3312 
¤c_Ä™ems
 - 
push_™ems
,…ush_items);

3313 ià(
»t
) {

3314 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3315  
»t
;

3317 
	`cÝy_ex‹Á_bufãr
(
d¡
, 
¤c
,

3318 
	`bŒfs_node_key_±r_off£t
(0),

3319 
	`bŒfs_node_key_±r_off£t
(
¤c_Ä™ems
 - 
push_™ems
),

3320 
push_™ems
 * (
bŒfs_key_±r
));

3322 
	`bŒfs_£t_h—d”_Ä™ems
(
¤c
, 
¤c_Ä™ems
 - 
push_™ems
);

3323 
	`bŒfs_£t_h—d”_Ä™ems
(
d¡
, 
d¡_Ä™ems
 + 
push_™ems
);

3325 
	`bŒfs_m¬k_bufãr_dœty
(
¤c
);

3326 
	`bŒfs_m¬k_bufãr_dœty
(
d¡
);

3328  
»t
;

3329 
	}
}

3338 
nošlše
 
	$š£¹_Ãw_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3339 
bŒfs_roÙ
 *
roÙ
,

3340 
bŒfs_·th
 *
·th
, 
Ëv–
)

3342 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3343 
u64
 
low”_g’
;

3344 
ex‹Á_bufãr
 *
low”
;

3345 
ex‹Á_bufãr
 *
c
;

3346 
ex‹Á_bufãr
 *
Þd
;

3347 
bŒfs_disk_key
 
low”_key
;

3349 
	`BUG_ON
(
·th
->
nodes
[
Ëv–
]);

3350 
	`BUG_ON
(
·th
->
nodes
[
Ëv–
-1] !ð
roÙ
->
node
);

3352 
low”
 = 
·th
->
nodes
[
Ëv–
-1];

3353 ià(
Ëv–
 == 1)

3354 
	`bŒfs_™em_key
(
low”
, &
low”_key
, 0);

3356 
	`bŒfs_node_key
(
low”
, &
low”_key
, 0);

3358 
c
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0,„oÙ->
roÙ_key
.
objeùid
,

3359 &
low”_key
, 
Ëv–
, 
roÙ
->
node
->
¡¬t
, 0);

3360 ià(
	`IS_ERR
(
c
))

3361  
	`PTR_ERR
(
c
);

3363 
	`roÙ_add_u£d
(
roÙ
, 
fs_šfo
->
nodesize
);

3365 
	`memz”o_ex‹Á_bufãr
(
c
, 0, (
bŒfs_h—d”
));

3366 
	`bŒfs_£t_h—d”_Ä™ems
(
c
, 1);

3367 
	`bŒfs_£t_h—d”_Ëv–
(
c
, 
Ëv–
);

3368 
	`bŒfs_£t_h—d”_by‹Ä
(
c
, c->
¡¬t
);

3369 
	`bŒfs_£t_h—d”_g’”©iÚ
(
c
, 
Œªs
->
Œªsid
);

3370 
	`bŒfs_£t_h—d”_back»f_»v
(
c
, 
BTRFS_MIXED_BACKREF_REV
);

3371 
	`bŒfs_£t_h—d”_owÃr
(
c
, 
roÙ
->
roÙ_key
.
objeùid
);

3373 
	`wr™e_ex‹Á_bufãr_fsid
(
c
, 
fs_šfo
->
fsid
);

3374 
	`wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
c
, 
fs_šfo
->
chunk_Œ“_uuid
);

3376 
	`bŒfs_£t_node_key
(
c
, &
low”_key
, 0);

3377 
	`bŒfs_£t_node_block±r
(
c
, 0, 
low”
->
¡¬t
);

3378 
low”_g’
 = 
	`bŒfs_h—d”_g’”©iÚ
(
low”
);

3379 
	`WARN_ON
(
low”_g’
 !ð
Œªs
->
Œªsid
);

3381 
	`bŒfs_£t_node_±r_g’”©iÚ
(
c
, 0, 
low”_g’
);

3383 
	`bŒfs_m¬k_bufãr_dœty
(
c
);

3385 
Þd
 = 
roÙ
->
node
;

3386 
	`Œ“_mod_log_£t_roÙ_poš‹r
(
roÙ
, 
c
, 0);

3387 
	`rcu_assign_poš‹r
(
roÙ
->
node
, 
c
);

3390 
	`ä“_ex‹Á_bufãr
(
Þd
);

3392 
	`add_roÙ_to_dœty_li¡
(
roÙ
);

3393 
	`ex‹Á_bufãr_g‘
(
c
);

3394 
·th
->
nodes
[
Ëv–
] = 
c
;

3395 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

3396 
·th
->
¦Ùs
[
Ëv–
] = 0;

3398 
	}
}

3407 
	$š£¹_±r
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3408 
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_·th
 *
·th
,

3409 
bŒfs_disk_key
 *
key
, 
u64
 
by‹Ä
,

3410 
¦Ù
, 
Ëv–
)

3412 
ex‹Á_bufãr
 *
low”
;

3413 
Ä™ems
;

3414 
»t
;

3416 
	`BUG_ON
(!
·th
->
nodes
[
Ëv–
]);

3417 
	`bŒfs_as£¹_Œ“_locked
(
·th
->
nodes
[
Ëv–
]);

3418 
low”
 = 
·th
->
nodes
[
Ëv–
];

3419 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
low”
);

3420 
	`BUG_ON
(
¦Ù
 > 
Ä™ems
);

3421 
	`BUG_ON
(
Ä™ems
 =ð
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

3422 ià(
¦Ù
 !ð
Ä™ems
) {

3423 ià(
Ëv–
)

3424 
	`Œ“_mod_log_eb_move
(
fs_šfo
, 
low”
, 
¦Ù
 + 1,

3425 
¦Ù
, 
Ä™ems
 - slot);

3426 
	`memmove_ex‹Á_bufãr
(
low”
,

3427 
	`bŒfs_node_key_±r_off£t
(
¦Ù
 + 1),

3428 
	`bŒfs_node_key_±r_off£t
(
¦Ù
),

3429 (
Ä™ems
 - 
¦Ù
è* (
bŒfs_key_±r
));

3431 ià(
Ëv–
) {

3432 
»t
 = 
	`Œ“_mod_log_š£¹_key
(
fs_šfo
, 
low”
, 
¦Ù
,

3433 
MOD_LOG_KEY_ADD
, 
GFP_NOFS
);

3434 
	`BUG_ON
(
»t
 < 0);

3436 
	`bŒfs_£t_node_key
(
low”
, 
key
, 
¦Ù
);

3437 
	`bŒfs_£t_node_block±r
(
low”
, 
¦Ù
, 
by‹Ä
);

3438 
	`WARN_ON
(
Œªs
->
Œªsid
 == 0);

3439 
	`bŒfs_£t_node_±r_g’”©iÚ
(
low”
, 
¦Ù
, 
Œªs
->
Œªsid
);

3440 
	`bŒfs_£t_h—d”_Ä™ems
(
low”
, 
Ä™ems
 + 1);

3441 
	`bŒfs_m¬k_bufãr_dœty
(
low”
);

3442 
	}
}

3453 
nošlše
 
	$¥l™_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3454 
bŒfs_roÙ
 *
roÙ
,

3455 
bŒfs_·th
 *
·th
, 
Ëv–
)

3457 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3458 
ex‹Á_bufãr
 *
c
;

3459 
ex‹Á_bufãr
 *
¥l™
;

3460 
bŒfs_disk_key
 
disk_key
;

3461 
mid
;

3462 
»t
;

3463 
u32
 
c_Ä™ems
;

3465 
c
 = 
·th
->
nodes
[
Ëv–
];

3466 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
c
è!ð
Œªs
->
Œªsid
);

3467 ià(
c
 =ð
roÙ
->
node
) {

3478 
»t
 = 
	`š£¹_Ãw_roÙ
(
Œªs
, 
roÙ
, 
·th
, 
Ëv–
 + 1);

3479 ià(
»t
)

3480  
»t
;

3482 
»t
 = 
	`push_nodes_fÜ_š£¹
(
Œªs
, 
roÙ
, 
·th
, 
Ëv–
);

3483 
c
 = 
·th
->
nodes
[
Ëv–
];

3484 ià(!
»t
 && 
	`bŒfs_h—d”_Ä™ems
(
c
) <

3485 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
) - 3)

3487 ià(
»t
 < 0)

3488  
»t
;

3491 
c_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
c
);

3492 
mid
 = (
c_Ä™ems
 + 1) / 2;

3493 
	`bŒfs_node_key
(
c
, &
disk_key
, 
mid
);

3495 
¥l™
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0,„oÙ->
roÙ_key
.
objeùid
,

3496 &
disk_key
, 
Ëv–
, 
c
->
¡¬t
, 0);

3497 ià(
	`IS_ERR
(
¥l™
))

3498  
	`PTR_ERR
(
¥l™
);

3500 
	`roÙ_add_u£d
(
roÙ
, 
fs_šfo
->
nodesize
);

3502 
	`memz”o_ex‹Á_bufãr
(
¥l™
, 0, (
bŒfs_h—d”
));

3503 
	`bŒfs_£t_h—d”_Ëv–
(
¥l™
, 
	`bŒfs_h—d”_Ëv–
(
c
));

3504 
	`bŒfs_£t_h—d”_by‹Ä
(
¥l™
, s¶™->
¡¬t
);

3505 
	`bŒfs_£t_h—d”_g’”©iÚ
(
¥l™
, 
Œªs
->
Œªsid
);

3506 
	`bŒfs_£t_h—d”_back»f_»v
(
¥l™
, 
BTRFS_MIXED_BACKREF_REV
);

3507 
	`bŒfs_£t_h—d”_owÃr
(
¥l™
, 
roÙ
->
roÙ_key
.
objeùid
);

3508 
	`wr™e_ex‹Á_bufãr_fsid
(
¥l™
, 
fs_šfo
->
fsid
);

3509 
	`wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
¥l™
, 
fs_šfo
->
chunk_Œ“_uuid
);

3511 
»t
 = 
	`Œ“_mod_log_eb_cÝy
(
fs_šfo
, 
¥l™
, 
c
, 0, 
mid
, 
c_Ä™ems
 - mid);

3512 ià(
»t
) {

3513 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3514  
»t
;

3516 
	`cÝy_ex‹Á_bufãr
(
¥l™
, 
c
,

3517 
	`bŒfs_node_key_±r_off£t
(0),

3518 
	`bŒfs_node_key_±r_off£t
(
mid
),

3519 (
c_Ä™ems
 - 
mid
è* (
bŒfs_key_±r
));

3520 
	`bŒfs_£t_h—d”_Ä™ems
(
¥l™
, 
c_Ä™ems
 - 
mid
);

3521 
	`bŒfs_£t_h—d”_Ä™ems
(
c
, 
mid
);

3522 
»t
 = 0;

3524 
	`bŒfs_m¬k_bufãr_dœty
(
c
);

3525 
	`bŒfs_m¬k_bufãr_dœty
(
¥l™
);

3527 
	`š£¹_±r
(
Œªs
, 
fs_šfo
, 
·th
, &
disk_key
, 
¥l™
->
¡¬t
,

3528 
·th
->
¦Ùs
[
Ëv–
 + 1] + 1,†evel + 1);

3530 ià(
·th
->
¦Ùs
[
Ëv–
] >ð
mid
) {

3531 
·th
->
¦Ùs
[
Ëv–
] -ð
mid
;

3532 
	`bŒfs_Œ“_uÆock
(
c
);

3533 
	`ä“_ex‹Á_bufãr
(
c
);

3534 
·th
->
nodes
[
Ëv–
] = 
¥l™
;

3535 
·th
->
¦Ùs
[
Ëv–
 + 1] += 1;

3537 
	`bŒfs_Œ“_uÆock
(
¥l™
);

3538 
	`ä“_ex‹Á_bufãr
(
¥l™
);

3540  
»t
;

3541 
	}
}

3548 
	$Ëaf_¥aû_u£d
(
ex‹Á_bufãr
 *
l
, 
¡¬t
, 
Ä
)

3550 
bŒfs_™em
 *
¡¬t_™em
;

3551 
bŒfs_™em
 *
’d_™em
;

3552 
bŒfs_m­_tok’
 
tok’
;

3553 
d©a_Ën
;

3554 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
l
);

3555 
’d
 = 
	`mš
(
Ä™ems
, 
¡¬t
 + 
Ä
) - 1;

3557 ià(!
Ä
)

3559 
	`bŒfs_š™_m­_tok’
(&
tok’
);

3560 
¡¬t_™em
 = 
	`bŒfs_™em_Ä
(
¡¬t
);

3561 
’d_™em
 = 
	`bŒfs_™em_Ä
(
’d
);

3562 
d©a_Ën
 = 
	`bŒfs_tok’_™em_off£t
(
l
, 
¡¬t_™em
, &
tok’
) +

3563 
	`bŒfs_tok’_™em_size
(
l
, 
¡¬t_™em
, &
tok’
);

3564 
d©a_Ën
 = d©a_ËÀ- 
	`bŒfs_tok’_™em_off£t
(
l
, 
’d_™em
, &
tok’
);

3565 
d©a_Ën
 +ð(
bŒfs_™em
è* 
Ä
;

3566 
	`WARN_ON
(
d©a_Ën
 < 0);

3567  
d©a_Ën
;

3568 
	}
}

3575 
nošlše
 
	$bŒfs_Ëaf_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

3576 
ex‹Á_bufãr
 *
Ëaf
)

3578 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

3579 
»t
;

3581 
»t
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
);

3582 ià(
»t
 < 0) {

3583 
	`bŒfs_ü™
(
fs_šfo
,

3585 
»t
,

3586 (è
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
),

3587 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
),‚ritems);

3589  
»t
;

3590 
	}
}

3596 
nošlše
 
	$__push_Ëaf_right
(
bŒfs_fs_šfo
 *
fs_šfo
,

3597 
bŒfs_·th
 *
·th
,

3598 
d©a_size
, 
em±y
,

3599 
ex‹Á_bufãr
 *
right
,

3600 
ä“_¥aû
, 
u32
 
Ëá_Ä™ems
,

3601 
u32
 
mš_¦Ù
)

3603 
ex‹Á_bufãr
 *
Ëá
 = 
·th
->
nodes
[0];

3604 
ex‹Á_bufãr
 *
uµ”
 = 
·th
->
nodes
[1];

3605 
bŒfs_m­_tok’
 
tok’
;

3606 
bŒfs_disk_key
 
disk_key
;

3607 
¦Ù
;

3608 
u32
 
i
;

3609 
push_¥aû
 = 0;

3610 
push_™ems
 = 0;

3611 
bŒfs_™em
 *
™em
;

3612 
u32
 
Ä
;

3613 
u32
 
right_Ä™ems
;

3614 
u32
 
d©a_’d
;

3615 
u32
 
this_™em_size
;

3617 
	`bŒfs_š™_m­_tok’
(&
tok’
);

3619 ià(
em±y
)

3620 
Ä
 = 0;

3622 
Ä
 = 
	`max_t
(
u32
, 1, 
mš_¦Ù
);

3624 ià(
·th
->
¦Ùs
[0] >ð
Ëá_Ä™ems
)

3625 
push_¥aû
 +ð
d©a_size
;

3627 
¦Ù
 = 
·th
->
¦Ùs
[1];

3628 
i
 = 
Ëá_Ä™ems
 - 1;

3629 
i
 >ð
Ä
) {

3630 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

3632 ià(!
em±y
 && 
push_™ems
 > 0) {

3633 ià(
·th
->
¦Ùs
[0] > 
i
)

3635 ià(
·th
->
¦Ùs
[0] =ð
i
) {

3636 
¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëá
);

3637 ià(
¥aû
 + 
push_¥aû
 * 2 > 
ä“_¥aû
)

3642 ià(
·th
->
¦Ùs
[0] =ð
i
)

3643 
push_¥aû
 +ð
d©a_size
;

3645 
this_™em_size
 = 
	`bŒfs_™em_size
(
Ëá
, 
™em
);

3646 ià(
this_™em_size
 + (*
™em
è+ 
push_¥aû
 > 
ä“_¥aû
)

3649 
push_™ems
++;

3650 
push_¥aû
 +ð
this_™em_size
 + (*
™em
);

3651 ià(
i
 == 0)

3653 
i
--;

3656 ià(
push_™ems
 == 0)

3657 
out_uÆock
;

3659 
	`WARN_ON
(!
em±y
 && 
push_™ems
 =ð
Ëá_Ä™ems
);

3662 
right_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

3664 
push_¥aû
 = 
	`bŒfs_™em_’d_Ä
(
Ëá
, 
Ëá_Ä™ems
 - 
push_™ems
);

3665 
push_¥aû
 -ð
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëá
);

3668 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
fs_šfo
, 
right
);

3669 
	`memmove_ex‹Á_bufãr
(
right
,

3670 
BTRFS_LEAF_DATA_OFFSET
 + 
d©a_’d
 - 
push_¥aû
,

3671 
BTRFS_LEAF_DATA_OFFSET
 + 
d©a_’d
,

3672 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
d©a_’d
);

3675 
	`cÝy_ex‹Á_bufãr
(
right
, 
Ëá
, 
BTRFS_LEAF_DATA_OFFSET
 +

3676 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
push_¥aû
,

3677 
BTRFS_LEAF_DATA_OFFSET
 + 
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëá
),

3678 
push_¥aû
);

3680 
	`memmove_ex‹Á_bufãr
(
right
, 
	`bŒfs_™em_Ä_off£t
(
push_™ems
),

3681 
	`bŒfs_™em_Ä_off£t
(0),

3682 
right_Ä™ems
 * (
bŒfs_™em
));

3685 
	`cÝy_ex‹Á_bufãr
(
right
, 
Ëá
, 
	`bŒfs_™em_Ä_off£t
(0),

3686 
	`bŒfs_™em_Ä_off£t
(
Ëá_Ä™ems
 - 
push_™ems
),

3687 
push_™ems
 * (
bŒfs_™em
));

3690 
right_Ä™ems
 +ð
push_™ems
;

3691 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 
right_Ä™ems
);

3692 
push_¥aû
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

3693 
i
 = 0; i < 
right_Ä™ems
; i++) {

3694 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

3695 
push_¥aû
 -ð
	`bŒfs_tok’_™em_size
(
right
, 
™em
, &
tok’
);

3696 
	`bŒfs_£t_tok’_™em_off£t
(
right
, 
™em
, 
push_¥aû
, &
tok’
);

3699 
Ëá_Ä™ems
 -ð
push_™ems
;

3700 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëá
, 
Ëá_Ä™ems
);

3702 ià(
Ëá_Ä™ems
)

3703 
	`bŒfs_m¬k_bufãr_dœty
(
Ëá
);

3705 
	`þ—n_Œ“_block
(
fs_šfo
, 
Ëá
);

3707 
	`bŒfs_m¬k_bufãr_dœty
(
right
);

3709 
	`bŒfs_™em_key
(
right
, &
disk_key
, 0);

3710 
	`bŒfs_£t_node_key
(
uµ”
, &
disk_key
, 
¦Ù
 + 1);

3711 
	`bŒfs_m¬k_bufãr_dœty
(
uµ”
);

3714 ià(
·th
->
¦Ùs
[0] >ð
Ëá_Ä™ems
) {

3715 
·th
->
¦Ùs
[0] -ð
Ëá_Ä™ems
;

3716 ià(
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]) == 0)

3717 
	`þ—n_Œ“_block
(
fs_šfo
, 
·th
->
nodes
[0]);

3718 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3719 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3720 
·th
->
nodes
[0] = 
right
;

3721 
·th
->
¦Ùs
[1] += 1;

3723 
	`bŒfs_Œ“_uÆock
(
right
);

3724 
	`ä“_ex‹Á_bufãr
(
right
);

3728 
out_uÆock
:

3729 
	`bŒfs_Œ“_uÆock
(
right
);

3730 
	`ä“_ex‹Á_bufãr
(
right
);

3732 
	}
}

3744 
	$push_Ëaf_right
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


3745 *
roÙ
, 
bŒfs_·th
 *
·th
,

3746 
mš_d©a_size
, 
d©a_size
,

3747 
em±y
, 
u32
 
mš_¦Ù
)

3749 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3750 
ex‹Á_bufãr
 *
Ëá
 = 
·th
->
nodes
[0];

3751 
ex‹Á_bufãr
 *
right
;

3752 
ex‹Á_bufãr
 *
uµ”
;

3753 
¦Ù
;

3754 
ä“_¥aû
;

3755 
u32
 
Ëá_Ä™ems
;

3756 
»t
;

3758 ià(!
·th
->
nodes
[1])

3761 
¦Ù
 = 
·th
->
¦Ùs
[1];

3762 
uµ”
 = 
·th
->
nodes
[1];

3763 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
uµ”
) - 1)

3766 
	`bŒfs_as£¹_Œ“_locked
(
·th
->
nodes
[1]);

3768 
right
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
uµ”
, 
¦Ù
 + 1);

3773 ià(
	`IS_ERR
(
right
))

3776 
	`bŒfs_Œ“_lock
(
right
);

3777 
	`bŒfs_£t_lock_blockšg
(
right
);

3779 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
right
);

3780 ià(
ä“_¥aû
 < 
d©a_size
)

3781 
out_uÆock
;

3784 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
right
, 
uµ”
,

3785 
¦Ù
 + 1, &
right
);

3786 ià(
»t
)

3787 
out_uÆock
;

3789 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
right
);

3790 ià(
ä“_¥aû
 < 
d©a_size
)

3791 
out_uÆock
;

3793 
Ëá_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

3794 ià(
Ëá_Ä™ems
 == 0)

3795 
out_uÆock
;

3797 ià(
·th
->
¦Ùs
[0] =ð
Ëá_Ä™ems
 && !
em±y
) {

3802 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3803 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3804 
·th
->
nodes
[0] = 
right
;

3805 
·th
->
¦Ùs
[0] = 0;

3806 
·th
->
¦Ùs
[1]++;

3810  
	`__push_Ëaf_right
(
fs_šfo
, 
·th
, 
mš_d©a_size
, 
em±y
,

3811 
right
, 
ä“_¥aû
, 
Ëá_Ä™ems
, 
mš_¦Ù
);

3812 
out_uÆock
:

3813 
	`bŒfs_Œ“_uÆock
(
right
);

3814 
	`ä“_ex‹Á_bufãr
(
right
);

3816 
	}
}

3826 
nošlše
 
	$__push_Ëaf_Ëá
(
bŒfs_fs_šfo
 *
fs_šfo
,

3827 
bŒfs_·th
 *
·th
, 
d©a_size
,

3828 
em±y
, 
ex‹Á_bufãr
 *
Ëá
,

3829 
ä“_¥aû
, 
u32
 
right_Ä™ems
,

3830 
u32
 
max_¦Ù
)

3832 
bŒfs_disk_key
 
disk_key
;

3833 
ex‹Á_bufãr
 *
right
 = 
·th
->
nodes
[0];

3834 
i
;

3835 
push_¥aû
 = 0;

3836 
push_™ems
 = 0;

3837 
bŒfs_™em
 *
™em
;

3838 
u32
 
Þd_Ëá_Ä™ems
;

3839 
u32
 
Ä
;

3840 
»t
 = 0;

3841 
u32
 
this_™em_size
;

3842 
u32
 
Þd_Ëá_™em_size
;

3843 
bŒfs_m­_tok’
 
tok’
;

3845 
	`bŒfs_š™_m­_tok’
(&
tok’
);

3847 ià(
em±y
)

3848 
Ä
 = 
	`mš
(
right_Ä™ems
, 
max_¦Ù
);

3850 
Ä
 = 
	`mš
(
right_Ä™ems
 - 1, 
max_¦Ù
);

3852 
i
 = 0; i < 
Ä
; i++) {

3853 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

3855 ià(!
em±y
 && 
push_™ems
 > 0) {

3856 ià(
·th
->
¦Ùs
[0] < 
i
)

3858 ià(
·th
->
¦Ùs
[0] =ð
i
) {

3859 
¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
right
);

3860 ià(
¥aû
 + 
push_¥aû
 * 2 > 
ä“_¥aû
)

3865 ià(
·th
->
¦Ùs
[0] =ð
i
)

3866 
push_¥aû
 +ð
d©a_size
;

3868 
this_™em_size
 = 
	`bŒfs_™em_size
(
right
, 
™em
);

3869 ià(
this_™em_size
 + (*
™em
è+ 
push_¥aû
 > 
ä“_¥aû
)

3872 
push_™ems
++;

3873 
push_¥aû
 +ð
this_™em_size
 + (*
™em
);

3876 ià(
push_™ems
 == 0) {

3877 
»t
 = 1;

3878 
out
;

3880 
	`WARN_ON
(!
em±y
 && 
push_™ems
 =ð
	`bŒfs_h—d”_Ä™ems
(
right
));

3883 
	`cÝy_ex‹Á_bufãr
(
Ëá
, 
right
,

3884 
	`bŒfs_™em_Ä_off£t
(
	`bŒfs_h—d”_Ä™ems
(
Ëá
)),

3885 
	`bŒfs_™em_Ä_off£t
(0),

3886 
push_™ems
 * (
bŒfs_™em
));

3888 
push_¥aû
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
) -

3889 
	`bŒfs_™em_off£t_Ä
(
right
, 
push_™ems
 - 1);

3891 
	`cÝy_ex‹Á_bufãr
(
Ëá
, 
right
, 
BTRFS_LEAF_DATA_OFFSET
 +

3892 
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëá
è- 
push_¥aû
,

3893 
BTRFS_LEAF_DATA_OFFSET
 +

3894 
	`bŒfs_™em_off£t_Ä
(
right
, 
push_™ems
 - 1),

3895 
push_¥aû
);

3896 
Þd_Ëá_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëá
);

3897 
	`BUG_ON
(
Þd_Ëá_Ä™ems
 <= 0);

3899 
Þd_Ëá_™em_size
 = 
	`bŒfs_™em_off£t_Ä
(
Ëá
, 
Þd_Ëá_Ä™ems
 - 1);

3900 
i
 = 
Þd_Ëá_Ä™ems
; i < old_Ëá_Ä™em + 
push_™ems
; i++) {

3901 
u32
 
ioff
;

3903 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

3905 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(
Ëá
, 
™em
, &
tok’
);

3906 
	`bŒfs_£t_tok’_™em_off£t
(
Ëá
, 
™em
,

3907 
ioff
 - (
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
Þd_Ëá_™em_size
),

3908 &
tok’
);

3910 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëá
, 
Þd_Ëá_Ä™ems
 + 
push_™ems
);

3913 ià(
push_™ems
 > 
right_Ä™ems
)

3914 
	`WARN
(1, 
KERN_CRIT
 "push i‹m %d‚¸%u\n", 
push_™ems
,

3915 
right_Ä™ems
);

3917 ià(
push_™ems
 < 
right_Ä™ems
) {

3918 
push_¥aû
 = 
	`bŒfs_™em_off£t_Ä
(
right
, 
push_™ems
 - 1) -

3919 
	`Ëaf_d©a_’d
(
fs_šfo
, 
right
);

3920 
	`memmove_ex‹Á_bufãr
(
right
, 
BTRFS_LEAF_DATA_OFFSET
 +

3921 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
push_¥aû
,

3922 
BTRFS_LEAF_DATA_OFFSET
 +

3923 
	`Ëaf_d©a_’d
(
fs_šfo
, 
right
), 
push_¥aû
);

3925 
	`memmove_ex‹Á_bufãr
(
right
, 
	`bŒfs_™em_Ä_off£t
(0),

3926 
	`bŒfs_™em_Ä_off£t
(
push_™ems
),

3927 (
	`bŒfs_h—d”_Ä™ems
(
right
è- 
push_™ems
) *

3928 (
bŒfs_™em
));

3930 
right_Ä™ems
 -ð
push_™ems
;

3931 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 
right_Ä™ems
);

3932 
push_¥aû
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

3933 
i
 = 0; i < 
right_Ä™ems
; i++) {

3934 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

3936 
push_¥aû
 =…ush_¥aû - 
	`bŒfs_tok’_™em_size
(
right
,

3937 
™em
, &
tok’
);

3938 
	`bŒfs_£t_tok’_™em_off£t
(
right
, 
™em
, 
push_¥aû
, &
tok’
);

3941 
	`bŒfs_m¬k_bufãr_dœty
(
Ëá
);

3942 ià(
right_Ä™ems
)

3943 
	`bŒfs_m¬k_bufãr_dœty
(
right
);

3945 
	`þ—n_Œ“_block
(
fs_šfo
, 
right
);

3947 
	`bŒfs_™em_key
(
right
, &
disk_key
, 0);

3948 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 1);

3951 ià(
·th
->
¦Ùs
[0] < 
push_™ems
) {

3952 
·th
->
¦Ùs
[0] +ð
Þd_Ëá_Ä™ems
;

3953 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

3954 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

3955 
·th
->
nodes
[0] = 
Ëá
;

3956 
·th
->
¦Ùs
[1] -= 1;

3958 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3959 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3960 
·th
->
¦Ùs
[0] -ð
push_™ems
;

3962 
	`BUG_ON
(
·th
->
¦Ùs
[0] < 0);

3963  
»t
;

3964 
out
:

3965 
	`bŒfs_Œ“_uÆock
(
Ëá
);

3966 
	`ä“_ex‹Á_bufãr
(
Ëá
);

3967  
»t
;

3968 
	}
}

3978 
	$push_Ëaf_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


3979 *
roÙ
, 
bŒfs_·th
 *
·th
, 
mš_d©a_size
,

3980 
d©a_size
, 
em±y
, 
u32
 
max_¦Ù
)

3982 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3983 
ex‹Á_bufãr
 *
right
 = 
·th
->
nodes
[0];

3984 
ex‹Á_bufãr
 *
Ëá
;

3985 
¦Ù
;

3986 
ä“_¥aû
;

3987 
u32
 
right_Ä™ems
;

3988 
»t
 = 0;

3990 
¦Ù
 = 
·th
->
¦Ùs
[1];

3991 ià(
¦Ù
 == 0)

3993 ià(!
·th
->
nodes
[1])

3996 
right_Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
right
);

3997 ià(
right_Ä™ems
 == 0)

4000 
	`bŒfs_as£¹_Œ“_locked
(
·th
->
nodes
[1]);

4002 
Ëá
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
·th
->
nodes
[1], 
¦Ù
 - 1);

4007 ià(
	`IS_ERR
(
Ëá
))

4010 
	`bŒfs_Œ“_lock
(
Ëá
);

4011 
	`bŒfs_£t_lock_blockšg
(
Ëá
);

4013 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëá
);

4014 ià(
ä“_¥aû
 < 
d©a_size
) {

4015 
»t
 = 1;

4016 
out
;

4020 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëá
,

4021 
·th
->
nodes
[1], 
¦Ù
 - 1, &
Ëá
);

4022 ià(
»t
) {

4024 ià(
»t
 =ð-
ENOSPC
)

4025 
»t
 = 1;

4026 
out
;

4029 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëá
);

4030 ià(
ä“_¥aû
 < 
d©a_size
) {

4031 
»t
 = 1;

4032 
out
;

4035  
	`__push_Ëaf_Ëá
(
fs_šfo
, 
·th
, 
mš_d©a_size
,

4036 
em±y
, 
Ëá
, 
ä“_¥aû
, 
right_Ä™ems
,

4037 
max_¦Ù
);

4038 
out
:

4039 
	`bŒfs_Œ“_uÆock
(
Ëá
);

4040 
	`ä“_ex‹Á_bufãr
(
Ëá
);

4041  
»t
;

4042 
	}
}

4048 
nošlše
 
	$cÝy_fÜ_¥l™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4049 
bŒfs_fs_šfo
 *
fs_šfo
,

4050 
bŒfs_·th
 *
·th
,

4051 
ex‹Á_bufãr
 *
l
,

4052 
ex‹Á_bufãr
 *
right
,

4053 
¦Ù
, 
mid
, 
Ä™ems
)

4055 
d©a_cÝy_size
;

4056 
¹_d©a_off
;

4057 
i
;

4058 
bŒfs_disk_key
 
disk_key
;

4059 
bŒfs_m­_tok’
 
tok’
;

4061 
	`bŒfs_š™_m­_tok’
(&
tok’
);

4063 
Ä™ems
 =‚r™em - 
mid
;

4064 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 
Ä™ems
);

4065 
d©a_cÝy_size
 = 
	`bŒfs_™em_’d_Ä
(
l
, 
mid
è- 
	`Ëaf_d©a_’d
(
fs_šfo
,†);

4067 
	`cÝy_ex‹Á_bufãr
(
right
, 
l
, 
	`bŒfs_™em_Ä_off£t
(0),

4068 
	`bŒfs_™em_Ä_off£t
(
mid
),

4069 
Ä™ems
 * (
bŒfs_™em
));

4071 
	`cÝy_ex‹Á_bufãr
(
right
, 
l
,

4072 
BTRFS_LEAF_DATA_OFFSET
 + 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
) -

4073 
d©a_cÝy_size
, 
BTRFS_LEAF_DATA_OFFSET
 +

4074 
	`Ëaf_d©a_’d
(
fs_šfo
, 
l
), 
d©a_cÝy_size
);

4076 
¹_d©a_off
 = 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
è- 
	`bŒfs_™em_’d_Ä
(
l
, 
mid
);

4078 
i
 = 0; i < 
Ä™ems
; i++) {

4079 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
i
);

4080 
u32
 
ioff
;

4082 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(
right
, 
™em
, &
tok’
);

4083 
	`bŒfs_£t_tok’_™em_off£t
(
right
, 
™em
,

4084 
ioff
 + 
¹_d©a_off
, &
tok’
);

4087 
	`bŒfs_£t_h—d”_Ä™ems
(
l
, 
mid
);

4088 
	`bŒfs_™em_key
(
right
, &
disk_key
, 0);

4089 
	`š£¹_±r
(
Œªs
, 
fs_šfo
, 
·th
, &
disk_key
, 
right
->
¡¬t
,

4090 
·th
->
¦Ùs
[1] + 1, 1);

4092 
	`bŒfs_m¬k_bufãr_dœty
(
right
);

4093 
	`bŒfs_m¬k_bufãr_dœty
(
l
);

4094 
	`BUG_ON
(
·th
->
¦Ùs
[0] !ð
¦Ù
);

4096 ià(
mid
 <ð
¦Ù
) {

4097 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

4098 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

4099 
·th
->
nodes
[0] = 
right
;

4100 
·th
->
¦Ùs
[0] -ð
mid
;

4101 
·th
->
¦Ùs
[1] += 1;

4103 
	`bŒfs_Œ“_uÆock
(
right
);

4104 
	`ä“_ex‹Á_bufãr
(
right
);

4107 
	`BUG_ON
(
·th
->
¦Ùs
[0] < 0);

4108 
	}
}

4120 
nošlše
 
	$push_fÜ_doubË_¥l™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4121 
bŒfs_roÙ
 *
roÙ
,

4122 
bŒfs_·th
 *
·th
,

4123 
d©a_size
)

4125 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4126 
»t
;

4127 
´og»ss
 = 0;

4128 
¦Ù
;

4129 
u32
 
Ä™ems
;

4130 
¥aû_Ãeded
 = 
d©a_size
;

4132 
¦Ù
 = 
·th
->
¦Ùs
[0];

4133 ià(
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]))

4134 
¥aû_Ãeded
 -ð
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
·th
->
nodes
[0]);

4140 
»t
 = 
	`push_Ëaf_right
(
Œªs
, 
roÙ
, 
·th
, 1, 
¥aû_Ãeded
, 0, 
¦Ù
);

4141 ià(
»t
 < 0)

4142  
»t
;

4144 ià(
»t
 == 0)

4145 
´og»ss
++;

4147 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

4152 ià(
·th
->
¦Ùs
[0] =ð0 ||…©h->¦Ùs[0] =ð
Ä™ems
)

4155 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
·th
->
nodes
[0]è>ð
d©a_size
)

4159 
¦Ù
 = 
·th
->
¦Ùs
[0];

4160 
¥aû_Ãeded
 = 
d©a_size
;

4161 ià(
¦Ù
 > 0)

4162 
¥aû_Ãeded
 -ð
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
·th
->
nodes
[0]);

4163 
»t
 = 
	`push_Ëaf_Ëá
(
Œªs
, 
roÙ
, 
·th
, 1, 
¥aû_Ãeded
, 0, 
¦Ù
);

4164 ià(
»t
 < 0)

4165  
»t
;

4167 ià(
»t
 == 0)

4168 
´og»ss
++;

4170 ià(
´og»ss
)

4173 
	}
}

4181 
nošlše
 
	$¥l™_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4182 
bŒfs_roÙ
 *
roÙ
,

4183 cÚ¡ 
bŒfs_key
 *
šs_key
,

4184 
bŒfs_·th
 *
·th
, 
d©a_size
,

4185 
ex‹nd
)

4187 
bŒfs_disk_key
 
disk_key
;

4188 
ex‹Á_bufãr
 *
l
;

4189 
u32
 
Ä™ems
;

4190 
mid
;

4191 
¦Ù
;

4192 
ex‹Á_bufãr
 *
right
;

4193 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4194 
»t
 = 0;

4195 
w»t
;

4196 
¥l™
;

4197 
num_doubËs
 = 0;

4198 
Œ›d_avoid_doubË
 = 0;

4200 
l
 = 
·th
->
nodes
[0];

4201 
¦Ù
 = 
·th
->
¦Ùs
[0];

4202 ià(
ex‹nd
 && 
d©a_size
 + 
	`bŒfs_™em_size_Ä
(
l
, 
¦Ù
) +

4203 (
bŒfs_™em
è> 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
))

4204  -
EOVERFLOW
;

4207 ià(
d©a_size
 && 
·th
->
nodes
[1]) {

4208 
¥aû_Ãeded
 = 
d©a_size
;

4210 ià(
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
l
))

4211 
¥aû_Ãeded
 -ð
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
l
);

4213 
w»t
 = 
	`push_Ëaf_right
(
Œªs
, 
roÙ
, 
·th
, 
¥aû_Ãeded
,

4214 
¥aû_Ãeded
, 0, 0);

4215 ià(
w»t
 < 0)

4216  
w»t
;

4217 ià(
w»t
) {

4218 
¥aû_Ãeded
 = 
d©a_size
;

4219 ià(
¦Ù
 > 0)

4220 
¥aû_Ãeded
 -ð
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
,

4221 
l
);

4222 
w»t
 = 
	`push_Ëaf_Ëá
(
Œªs
, 
roÙ
, 
·th
, 
¥aû_Ãeded
,

4223 
¥aû_Ãeded
, 0, (
u32
)-1);

4224 ià(
w»t
 < 0)

4225  
w»t
;

4227 
l
 = 
·th
->
nodes
[0];

4230 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
l
è>ð
d©a_size
)

4234 ià(!
·th
->
nodes
[1]) {

4235 
»t
 = 
	`š£¹_Ãw_roÙ
(
Œªs
, 
roÙ
, 
·th
, 1);

4236 ià(
»t
)

4237  
»t
;

4239 
agaš
:

4240 
¥l™
 = 1;

4241 
l
 = 
·th
->
nodes
[0];

4242 
¦Ù
 = 
·th
->
¦Ùs
[0];

4243 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
l
);

4244 
mid
 = (
Ä™ems
 + 1) / 2;

4246 ià(
mid
 <ð
¦Ù
) {

4247 ià(
Ä™ems
 == 1 ||

4248 
	`Ëaf_¥aû_u£d
(
l
, 
mid
, 
Ä™ems
 - midè+ 
d©a_size
 >

4249 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

4250 ià(
¦Ù
 >ð
Ä™ems
) {

4251 
¥l™
 = 0;

4253 
mid
 = 
¦Ù
;

4254 ià(
mid
 !ð
Ä™ems
 &&

4255 
	`Ëaf_¥aû_u£d
(
l
, 
mid
, 
Ä™ems
 - mid) +

4256 
d©a_size
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

4257 ià(
d©a_size
 && !
Œ›d_avoid_doubË
)

4258 
push_fÜ_doubË
;

4259 
¥l™
 = 2;

4264 ià(
	`Ëaf_¥aû_u£d
(
l
, 0, 
mid
è+ 
d©a_size
 >

4265 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

4266 ià(!
ex‹nd
 && 
d©a_size
 && 
¦Ù
 == 0) {

4267 
¥l™
 = 0;

4268 } ià((
ex‹nd
 || !
d©a_size
è&& 
¦Ù
 == 0) {

4269 
mid
 = 1;

4271 
mid
 = 
¦Ù
;

4272 ià(
mid
 !ð
Ä™ems
 &&

4273 
	`Ëaf_¥aû_u£d
(
l
, 
mid
, 
Ä™ems
 - mid) +

4274 
d©a_size
 > 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

4275 ià(
d©a_size
 && !
Œ›d_avoid_doubË
)

4276 
push_fÜ_doubË
;

4277 
¥l™
 = 2;

4283 ià(
¥l™
 == 0)

4284 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
šs_key
);

4286 
	`bŒfs_™em_key
(
l
, &
disk_key
, 
mid
);

4288 
right
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0,„oÙ->
roÙ_key
.
objeùid
,

4289 &
disk_key
, 0, 
l
->
¡¬t
, 0);

4290 ià(
	`IS_ERR
(
right
))

4291  
	`PTR_ERR
(
right
);

4293 
	`roÙ_add_u£d
(
roÙ
, 
fs_šfo
->
nodesize
);

4295 
	`memz”o_ex‹Á_bufãr
(
right
, 0, (
bŒfs_h—d”
));

4296 
	`bŒfs_£t_h—d”_by‹Ä
(
right
,„ight->
¡¬t
);

4297 
	`bŒfs_£t_h—d”_g’”©iÚ
(
right
, 
Œªs
->
Œªsid
);

4298 
	`bŒfs_£t_h—d”_back»f_»v
(
right
, 
BTRFS_MIXED_BACKREF_REV
);

4299 
	`bŒfs_£t_h—d”_owÃr
(
right
, 
roÙ
->
roÙ_key
.
objeùid
);

4300 
	`bŒfs_£t_h—d”_Ëv–
(
right
, 0);

4301 
	`wr™e_ex‹Á_bufãr_fsid
(
right
, 
fs_šfo
->
fsid
);

4302 
	`wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
right
, 
fs_šfo
->
chunk_Œ“_uuid
);

4304 ià(
¥l™
 == 0) {

4305 ià(
mid
 <ð
¦Ù
) {

4306 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 0);

4307 
	`š£¹_±r
(
Œªs
, 
fs_šfo
, 
·th
, &
disk_key
,

4308 
right
->
¡¬t
, 
·th
->
¦Ùs
[1] + 1, 1);

4309 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

4310 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

4311 
·th
->
nodes
[0] = 
right
;

4312 
·th
->
¦Ùs
[0] = 0;

4313 
·th
->
¦Ùs
[1] += 1;

4315 
	`bŒfs_£t_h—d”_Ä™ems
(
right
, 0);

4316 
	`š£¹_±r
(
Œªs
, 
fs_šfo
, 
·th
, &
disk_key
,

4317 
right
->
¡¬t
, 
·th
->
¦Ùs
[1], 1);

4318 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[0]);

4319 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[0]);

4320 
·th
->
nodes
[0] = 
right
;

4321 
·th
->
¦Ùs
[0] = 0;

4322 ià(
·th
->
¦Ùs
[1] == 0)

4323 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 1);

4330  
»t
;

4333 
	`cÝy_fÜ_¥l™
(
Œªs
, 
fs_šfo
, 
·th
, 
l
, 
right
, 
¦Ù
, 
mid
, 
Ä™ems
);

4335 ià(
¥l™
 == 2) {

4336 
	`BUG_ON
(
num_doubËs
 != 0);

4337 
num_doubËs
++;

4338 
agaš
;

4343 
push_fÜ_doubË
:

4344 
	`push_fÜ_doubË_¥l™
(
Œªs
, 
roÙ
, 
·th
, 
d©a_size
);

4345 
Œ›d_avoid_doubË
 = 1;

4346 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
·th
->
nodes
[0]è>ð
d©a_size
)

4348 
agaš
;

4349 
	}
}

4351 
nošlše
 
	$£tup_Ëaf_fÜ_¥l™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4352 
bŒfs_roÙ
 *
roÙ
,

4353 
bŒfs_·th
 *
·th
, 
šs_Ën
)

4355 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4356 
bŒfs_key
 
key
;

4357 
ex‹Á_bufãr
 *
Ëaf
;

4358 
bŒfs_fže_ex‹Á_™em
 *
fi
;

4359 
u64
 
ex‹Á_Ën
 = 0;

4360 
u32
 
™em_size
;

4361 
»t
;

4363 
Ëaf
 = 
·th
->
nodes
[0];

4364 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

4366 
	`BUG_ON
(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
 &&

4367 
key
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
);

4369 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
è>ð
šs_Ën
)

4372 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4373 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

4374 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4375 
bŒfs_fže_ex‹Á_™em
);

4376 
ex‹Á_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

4378 
	`bŒfs_»Ëa£_·th
(
·th
);

4380 
·th
->
k“p_locks
 = 1;

4381 
·th
->
£¬ch_fÜ_¥l™
 = 1;

4382 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

4383 
·th
->
£¬ch_fÜ_¥l™
 = 0;

4384 ià(
»t
 > 0)

4385 
»t
 = -
EAGAIN
;

4386 ià(
»t
 < 0)

4387 
”r
;

4389 
»t
 = -
EAGAIN
;

4390 
Ëaf
 = 
·th
->
nodes
[0];

4392 ià(
™em_size
 !ð
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]))

4393 
”r
;

4396 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
·th
->
nodes
[0]è>ð
šs_Ën
)

4397 
”r
;

4399 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

4400 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4401 
bŒfs_fže_ex‹Á_™em
);

4402 ià(
ex‹Á_Ën
 !ð
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
))

4403 
”r
;

4406 
	`bŒfs_£t_·th_blockšg
(
·th
);

4407 
»t
 = 
	`¥l™_Ëaf
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 1);

4408 ià(
»t
)

4409 
”r
;

4411 
·th
->
k“p_locks
 = 0;

4412 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

4414 
”r
:

4415 
·th
->
k“p_locks
 = 0;

4416  
»t
;

4417 
	}
}

4419 
nošlše
 
	$¥l™_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

4420 
bŒfs_·th
 *
·th
,

4421 cÚ¡ 
bŒfs_key
 *
Ãw_key
,

4422 
¥l™_off£t
)

4424 
ex‹Á_bufãr
 *
Ëaf
;

4425 
bŒfs_™em
 *
™em
;

4426 
bŒfs_™em
 *
Ãw_™em
;

4427 
¦Ù
;

4428 *
buf
;

4429 
u32
 
Ä™ems
;

4430 
u32
 
™em_size
;

4431 
u32
 
Üig_off£t
;

4432 
bŒfs_disk_key
 
disk_key
;

4434 
Ëaf
 = 
·th
->
nodes
[0];

4435 
	`BUG_ON
(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
è< (
bŒfs_™em
));

4437 
	`bŒfs_£t_·th_blockšg
(
·th
);

4439 
™em
 = 
	`bŒfs_™em_Ä
(
·th
->
¦Ùs
[0]);

4440 
Üig_off£t
 = 
	`bŒfs_™em_off£t
(
Ëaf
, 
™em
);

4441 
™em_size
 = 
	`bŒfs_™em_size
(
Ëaf
, 
™em
);

4443 
buf
 = 
	`km®loc
(
™em_size
, 
GFP_NOFS
);

4444 ià(!
buf
)

4445  -
ENOMEM
;

4447 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
buf
, 
	`bŒfs_™em_±r_off£t
(leaf,

4448 
·th
->
¦Ùs
[0]), 
™em_size
);

4450 
¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

4451 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4452 ià(
¦Ù
 !ð
Ä™ems
) {

4454 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
	`bŒfs_™em_Ä_off£t
(
¦Ù
 + 1),

4455 
	`bŒfs_™em_Ä_off£t
(
¦Ù
),

4456 (
Ä™ems
 - 
¦Ù
è* (
bŒfs_™em
));

4459 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
Ãw_key
);

4460 
	`bŒfs_£t_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
);

4462 
Ãw_™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

4464 
	`bŒfs_£t_™em_off£t
(
Ëaf
, 
Ãw_™em
, 
Üig_off£t
);

4465 
	`bŒfs_£t_™em_size
(
Ëaf
, 
Ãw_™em
, 
™em_size
 - 
¥l™_off£t
);

4467 
	`bŒfs_£t_™em_off£t
(
Ëaf
, 
™em
,

4468 
Üig_off£t
 + 
™em_size
 - 
¥l™_off£t
);

4469 
	`bŒfs_£t_™em_size
(
Ëaf
, 
™em
, 
¥l™_off£t
);

4471 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëaf
, 
Ä™ems
 + 1);

4474 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
buf
,

4475 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

4476 
¥l™_off£t
);

4479 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
buf
 + 
¥l™_off£t
,

4480 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
),

4481 
™em_size
 - 
¥l™_off£t
);

4482 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4484 
	`BUG_ON
(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) < 0);

4485 
	`kä“
(
buf
);

4487 
	}
}

4504 
	$bŒfs_¥l™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4505 
bŒfs_roÙ
 *
roÙ
,

4506 
bŒfs_·th
 *
·th
,

4507 cÚ¡ 
bŒfs_key
 *
Ãw_key
,

4508 
¥l™_off£t
)

4510 
»t
;

4511 
»t
 = 
	`£tup_Ëaf_fÜ_¥l™
(
Œªs
, 
roÙ
, 
·th
,

4512 (
bŒfs_™em
));

4513 ià(
»t
)

4514  
»t
;

4516 
»t
 = 
	`¥l™_™em
(
roÙ
->
fs_šfo
, 
·th
, 
Ãw_key
, 
¥l™_off£t
);

4517  
»t
;

4518 
	}
}

4528 
	$bŒfs_du¶iÿ‹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4529 
bŒfs_roÙ
 *
roÙ
,

4530 
bŒfs_·th
 *
·th
,

4531 cÚ¡ 
bŒfs_key
 *
Ãw_key
)

4533 
ex‹Á_bufãr
 *
Ëaf
;

4534 
»t
;

4535 
u32
 
™em_size
;

4537 
Ëaf
 = 
·th
->
nodes
[0];

4538 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4539 
»t
 = 
	`£tup_Ëaf_fÜ_¥l™
(
Œªs
, 
roÙ
, 
·th
,

4540 
™em_size
 + (
bŒfs_™em
));

4541 ià(
»t
)

4542  
»t
;

4544 
·th
->
¦Ùs
[0]++;

4545 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, 
·th
, 
Ãw_key
, &
™em_size
,

4546 
™em_size
, item_size +

4547 (
bŒfs_™em
), 1);

4548 
Ëaf
 = 
·th
->
nodes
[0];

4549 
	`memýy_ex‹Á_bufãr
(
Ëaf
,

4550 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

4551 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1),

4552 
™em_size
);

4554 
	}
}

4562 
	$bŒfs_Œunÿ‹_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

4563 
bŒfs_·th
 *
·th
, 
u32
 
Ãw_size
, 
äom_’d
)

4565 
¦Ù
;

4566 
ex‹Á_bufãr
 *
Ëaf
;

4567 
bŒfs_™em
 *
™em
;

4568 
u32
 
Ä™ems
;

4569 
d©a_’d
;

4570 
Þd_d©a_¡¬t
;

4571 
Þd_size
;

4572 
size_diff
;

4573 
i
;

4574 
bŒfs_m­_tok’
 
tok’
;

4576 
	`bŒfs_š™_m­_tok’
(&
tok’
);

4578 
Ëaf
 = 
·th
->
nodes
[0];

4579 
¦Ù
 = 
·th
->
¦Ùs
[0];

4581 
Þd_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

4582 ià(
Þd_size
 =ð
Ãw_size
)

4585 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4586 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëaf
);

4588 
Þd_d©a_¡¬t
 = 
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
¦Ù
);

4590 
size_diff
 = 
Þd_size
 - 
Ãw_size
;

4592 
	`BUG_ON
(
¦Ù
 < 0);

4593 
	`BUG_ON
(
¦Ù
 >ð
Ä™ems
);

4599 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

4600 
u32
 
ioff
;

4601 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

4603 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(
Ëaf
, 
™em
, &
tok’
);

4604 
	`bŒfs_£t_tok’_™em_off£t
(
Ëaf
, 
™em
,

4605 
ioff
 + 
size_diff
, &
tok’
);

4609 ià(
äom_’d
) {

4610 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
BTRFS_LEAF_DATA_OFFSET
 +

4611 
d©a_’d
 + 
size_diff
, 
BTRFS_LEAF_DATA_OFFSET
 +

4612 
d©a_’d
, 
Þd_d©a_¡¬t
 + 
Ãw_size
 - data_end);

4614 
bŒfs_disk_key
 
disk_key
;

4615 
u64
 
off£t
;

4617 
	`bŒfs_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
);

4619 ià(
	`bŒfs_disk_key_ty³
(&
disk_key
è=ð
BTRFS_EXTENT_DATA_KEY
) {

4620 
±r
;

4621 
bŒfs_fže_ex‹Á_™em
 *
fi
;

4623 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

4624 
bŒfs_fže_ex‹Á_™em
);

4625 
fi
 = (
bŒfs_fže_ex‹Á_™em
 *)(

4626 ()
fi
 - 
size_diff
);

4628 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
) ==

4629 
BTRFS_FILE_EXTENT_INLINE
) {

4630 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

4631 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,

4632 ()
fi
,

4633 
BTRFS_FILE_EXTENT_INLINE_DATA_START
);

4637 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
BTRFS_LEAF_DATA_OFFSET
 +

4638 
d©a_’d
 + 
size_diff
, 
BTRFS_LEAF_DATA_OFFSET
 +

4639 
d©a_’d
, 
Þd_d©a_¡¬t
 - data_end);

4641 
off£t
 = 
	`bŒfs_disk_key_off£t
(&
disk_key
);

4642 
	`bŒfs_£t_disk_key_off£t
(&
disk_key
, 
off£t
 + 
size_diff
);

4643 
	`bŒfs_£t_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
);

4644 ià(
¦Ù
 == 0)

4645 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 1);

4648 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

4649 
	`bŒfs_£t_™em_size
(
Ëaf
, 
™em
, 
Ãw_size
);

4650 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4652 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) < 0) {

4653 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4654 
	`BUG
();

4656 
	}
}

4661 
	$bŒfs_ex‹nd_™em
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_·th
 *
·th
,

4662 
u32
 
d©a_size
)

4664 
¦Ù
;

4665 
ex‹Á_bufãr
 *
Ëaf
;

4666 
bŒfs_™em
 *
™em
;

4667 
u32
 
Ä™ems
;

4668 
d©a_’d
;

4669 
Þd_d©a
;

4670 
Þd_size
;

4671 
i
;

4672 
bŒfs_m­_tok’
 
tok’
;

4674 
	`bŒfs_š™_m­_tok’
(&
tok’
);

4676 
Ëaf
 = 
·th
->
nodes
[0];

4678 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4679 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëaf
);

4681 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
è< 
d©a_size
) {

4682 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4683 
	`BUG
();

4685 
¦Ù
 = 
·th
->
¦Ùs
[0];

4686 
Þd_d©a
 = 
	`bŒfs_™em_’d_Ä
(
Ëaf
, 
¦Ù
);

4688 
	`BUG_ON
(
¦Ù
 < 0);

4689 ià(
¦Ù
 >ð
Ä™ems
) {

4690 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4691 
	`bŒfs_ü™
(
fs_šfo
, "slot %doo†arge,‚ritems %d",

4692 
¦Ù
, 
Ä™ems
);

4693 
	`BUG_ON
(1);

4700 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

4701 
u32
 
ioff
;

4702 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

4704 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(
Ëaf
, 
™em
, &
tok’
);

4705 
	`bŒfs_£t_tok’_™em_off£t
(
Ëaf
, 
™em
,

4706 
ioff
 - 
d©a_size
, &
tok’
);

4710 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
BTRFS_LEAF_DATA_OFFSET
 +

4711 
d©a_’d
 - 
d©a_size
, 
BTRFS_LEAF_DATA_OFFSET
 +

4712 
d©a_’d
, 
Þd_d©a
 - data_end);

4714 
d©a_’d
 = 
Þd_d©a
;

4715 
Þd_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

4716 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

4717 
	`bŒfs_£t_™em_size
(
Ëaf
, 
™em
, 
Þd_size
 + 
d©a_size
);

4718 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4720 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) < 0) {

4721 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4722 
	`BUG
();

4724 
	}
}

4731 
	$£tup_™ems_fÜ_š£¹
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

4732 cÚ¡ 
bŒfs_key
 *
ýu_key
, 
u32
 *
d©a_size
,

4733 
u32
 
tÙ®_d©a
, u32 
tÙ®_size
, 
Ä
)

4735 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4736 
bŒfs_™em
 *
™em
;

4737 
i
;

4738 
u32
 
Ä™ems
;

4739 
d©a_’d
;

4740 
bŒfs_disk_key
 
disk_key
;

4741 
ex‹Á_bufãr
 *
Ëaf
;

4742 
¦Ù
;

4743 
bŒfs_m­_tok’
 
tok’
;

4745 ià(
·th
->
¦Ùs
[0] == 0) {

4746 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
ýu_key
);

4747 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 1);

4749 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

4751 
	`bŒfs_š™_m­_tok’
(&
tok’
);

4753 
Ëaf
 = 
·th
->
nodes
[0];

4754 
¦Ù
 = 
·th
->
¦Ùs
[0];

4756 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4757 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëaf
);

4759 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
è< 
tÙ®_size
) {

4760 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4761 
	`bŒfs_ü™
(
fs_šfo
, "notƒnough freespace‚eed %u have %d",

4762 
tÙ®_size
, 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
));

4763 
	`BUG
();

4766 ià(
¦Ù
 !ð
Ä™ems
) {

4767 
Þd_d©a
 = 
	`bŒfs_™em_’d_Ä
(
Ëaf
, 
¦Ù
);

4769 ià(
Þd_d©a
 < 
d©a_’d
) {

4770 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4771 
	`bŒfs_ü™
(
fs_šfo
, "slot %d old_data %d data_end %d",

4772 
¦Ù
, 
Þd_d©a
, 
d©a_’d
);

4773 
	`BUG_ON
(1);

4779 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

4780 
u32
 
ioff
;

4782 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

4783 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(
Ëaf
, 
™em
, &
tok’
);

4784 
	`bŒfs_£t_tok’_™em_off£t
(
Ëaf
, 
™em
,

4785 
ioff
 - 
tÙ®_d©a
, &
tok’
);

4788 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
	`bŒfs_™em_Ä_off£t
(
¦Ù
 + 
Ä
),

4789 
	`bŒfs_™em_Ä_off£t
(
¦Ù
),

4790 (
Ä™ems
 - 
¦Ù
è* (
bŒfs_™em
));

4793 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
BTRFS_LEAF_DATA_OFFSET
 +

4794 
d©a_’d
 - 
tÙ®_d©a
, 
BTRFS_LEAF_DATA_OFFSET
 +

4795 
d©a_’d
, 
Þd_d©a
 - data_end);

4796 
d©a_’d
 = 
Þd_d©a
;

4800 
i
 = 0; i < 
Ä
; i++) {

4801 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
ýu_key
 + 
i
);

4802 
	`bŒfs_£t_™em_key
(
Ëaf
, &
disk_key
, 
¦Ù
 + 
i
);

4803 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
 + 
i
);

4804 
	`bŒfs_£t_tok’_™em_off£t
(
Ëaf
, 
™em
,

4805 
d©a_’d
 - 
d©a_size
[
i
], &
tok’
);

4806 
d©a_’d
 -ð
d©a_size
[
i
];

4807 
	`bŒfs_£t_tok’_™em_size
(
Ëaf
, 
™em
, 
d©a_size
[
i
], &
tok’
);

4810 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëaf
, 
Ä™ems
 + 
Ä
);

4811 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4813 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) < 0) {

4814 
	`bŒfs_´št_Ëaf
(
Ëaf
);

4815 
	`BUG
();

4817 
	}
}

4823 
	$bŒfs_š£¹_em±y_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4824 
bŒfs_roÙ
 *
roÙ
,

4825 
bŒfs_·th
 *
·th
,

4826 cÚ¡ 
bŒfs_key
 *
ýu_key
, 
u32
 *
d©a_size
,

4827 
Ä
)

4829 
»t
 = 0;

4830 
¦Ù
;

4831 
i
;

4832 
u32
 
tÙ®_size
 = 0;

4833 
u32
 
tÙ®_d©a
 = 0;

4835 
i
 = 0; i < 
Ä
; i++)

4836 
tÙ®_d©a
 +ð
d©a_size
[
i
];

4838 
tÙ®_size
 = 
tÙ®_d©a
 + (
Ä
 * (
bŒfs_™em
));

4839 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
ýu_key
, 
·th
, 
tÙ®_size
, 1);

4840 ià(
»t
 == 0)

4841  -
EEXIST
;

4842 ià(
»t
 < 0)

4843  
»t
;

4845 
¦Ù
 = 
·th
->
¦Ùs
[0];

4846 
	`BUG_ON
(
¦Ù
 < 0);

4848 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, 
·th
, 
ýu_key
, 
d©a_size
,

4849 
tÙ®_d©a
, 
tÙ®_size
, 
Ä
);

4851 
	}
}

4857 
	$bŒfs_š£¹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

4858 cÚ¡ 
bŒfs_key
 *
ýu_key
, *
d©a
,

4859 
u32
 
d©a_size
)

4861 
»t
 = 0;

4862 
bŒfs_·th
 *
·th
;

4863 
ex‹Á_bufãr
 *
Ëaf
;

4864 
±r
;

4866 
·th
 = 
	`bŒfs_®loc_·th
();

4867 ià(!
·th
)

4868  -
ENOMEM
;

4869 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
ýu_key
, 
d©a_size
);

4870 ià(!
»t
) {

4871 
Ëaf
 = 
·th
->
nodes
[0];

4872 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

4873 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
d©a
, 
±r
, 
d©a_size
);

4874 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4876 
	`bŒfs_ä“_·th
(
·th
);

4877  
»t
;

4878 
	}
}

4886 
	$d–_±r
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

4887 
Ëv–
, 
¦Ù
)

4889 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4890 
ex‹Á_bufãr
 *
·»Á
 = 
·th
->
nodes
[
Ëv–
];

4891 
u32
 
Ä™ems
;

4892 
»t
;

4894 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

4895 ià(
¦Ù
 !ð
Ä™ems
 - 1) {

4896 ià(
Ëv–
)

4897 
	`Œ“_mod_log_eb_move
(
fs_šfo
, 
·»Á
, 
¦Ù
,

4898 
¦Ù
 + 1, 
Ä™ems
 - slot - 1);

4899 
	`memmove_ex‹Á_bufãr
(
·»Á
,

4900 
	`bŒfs_node_key_±r_off£t
(
¦Ù
),

4901 
	`bŒfs_node_key_±r_off£t
(
¦Ù
 + 1),

4902 (
bŒfs_key_±r
) *

4903 (
Ä™ems
 - 
¦Ù
 - 1));

4904 } ià(
Ëv–
) {

4905 
»t
 = 
	`Œ“_mod_log_š£¹_key
(
fs_šfo
, 
·»Á
, 
¦Ù
,

4906 
MOD_LOG_KEY_REMOVE
, 
GFP_NOFS
);

4907 
	`BUG_ON
(
»t
 < 0);

4910 
Ä™ems
--;

4911 
	`bŒfs_£t_h—d”_Ä™ems
(
·»Á
, 
Ä™ems
);

4912 ià(
Ä™ems
 =ð0 && 
·»Á
 =ð
roÙ
->
node
) {

4913 
	`BUG_ON
(
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
) != 1);

4915 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

4916 } ià(
¦Ù
 == 0) {

4917 
bŒfs_disk_key
 
disk_key
;

4919 
	`bŒfs_node_key
(
·»Á
, &
disk_key
, 0);

4920 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 
Ëv–
 + 1);

4922 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

4923 
	}
}

4935 
nošlše
 
	$bŒfs_d–_Ëaf
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4936 
bŒfs_roÙ
 *
roÙ
,

4937 
bŒfs_·th
 *
·th
,

4938 
ex‹Á_bufãr
 *
Ëaf
)

4940 
	`WARN_ON
(
	`bŒfs_h—d”_g’”©iÚ
(
Ëaf
è!ð
Œªs
->
Œªsid
);

4941 
	`d–_±r
(
roÙ
, 
·th
, 1,…©h->
¦Ùs
[1]);

4947 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

4949 
	`roÙ_sub_u£d
(
roÙ
, 
Ëaf
->
Ën
);

4951 
	`ex‹Á_bufãr_g‘
(
Ëaf
);

4952 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
Ëaf
, 0, 1);

4953 
	`ä“_ex‹Á_bufãr_¡®e
(
Ëaf
);

4954 
	}
}

4959 
	$bŒfs_d–_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

4960 
bŒfs_·th
 *
·th
, 
¦Ù
, 
Ä
)

4962 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4963 
ex‹Á_bufãr
 *
Ëaf
;

4964 
bŒfs_™em
 *
™em
;

4965 
u32
 
Ï¡_off
;

4966 
u32
 
dsize
 = 0;

4967 
»t
 = 0;

4968 
w»t
;

4969 
i
;

4970 
u32
 
Ä™ems
;

4971 
bŒfs_m­_tok’
 
tok’
;

4973 
	`bŒfs_š™_m­_tok’
(&
tok’
);

4975 
Ëaf
 = 
·th
->
nodes
[0];

4976 
Ï¡_off
 = 
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
¦Ù
 + 
Ä
 - 1);

4978 
i
 = 0; i < 
Ä
; i++)

4979 
dsize
 +ð
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
 + 
i
);

4981 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4983 ià(
¦Ù
 + 
Ä
 !ð
Ä™ems
) {

4984 
d©a_’d
 = 
	`Ëaf_d©a_’d
(
fs_šfo
, 
Ëaf
);

4986 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
BTRFS_LEAF_DATA_OFFSET
 +

4987 
d©a_’d
 + 
dsize
,

4988 
BTRFS_LEAF_DATA_OFFSET
 + 
d©a_’d
,

4989 
Ï¡_off
 - 
d©a_’d
);

4991 
i
 = 
¦Ù
 + 
Ä
; i < 
Ä™ems
; i++) {

4992 
u32
 
ioff
;

4994 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

4995 
ioff
 = 
	`bŒfs_tok’_™em_off£t
(
Ëaf
, 
™em
, &
tok’
);

4996 
	`bŒfs_£t_tok’_™em_off£t
(
Ëaf
, 
™em
,

4997 
ioff
 + 
dsize
, &
tok’
);

5000 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
	`bŒfs_™em_Ä_off£t
(
¦Ù
),

5001 
	`bŒfs_™em_Ä_off£t
(
¦Ù
 + 
Ä
),

5002 (
bŒfs_™em
) *

5003 (
Ä™ems
 - 
¦Ù
 - 
Ä
));

5005 
	`bŒfs_£t_h—d”_Ä™ems
(
Ëaf
, 
Ä™ems
 - 
Ä
);

5006 
Ä™ems
 -ð
Ä
;

5009 ià(
Ä™ems
 == 0) {

5010 ià(
Ëaf
 =ð
roÙ
->
node
) {

5011 
	`bŒfs_£t_h—d”_Ëv–
(
Ëaf
, 0);

5013 
	`bŒfs_£t_·th_blockšg
(
·th
);

5014 
	`þ—n_Œ“_block
(
fs_šfo
, 
Ëaf
);

5015 
	`bŒfs_d–_Ëaf
(
Œªs
, 
roÙ
, 
·th
, 
Ëaf
);

5018 
u£d
 = 
	`Ëaf_¥aû_u£d
(
Ëaf
, 0, 
Ä™ems
);

5019 ià(
¦Ù
 == 0) {

5020 
bŒfs_disk_key
 
disk_key
;

5022 
	`bŒfs_™em_key
(
Ëaf
, &
disk_key
, 0);

5023 
	`fixup_low_keys
(
fs_šfo
, 
·th
, &
disk_key
, 1);

5027 ià(
u£d
 < 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
) / 3) {

5032 
¦Ù
 = 
·th
->
¦Ùs
[1];

5033 
	`ex‹Á_bufãr_g‘
(
Ëaf
);

5035 
	`bŒfs_£t_·th_blockšg
(
·th
);

5036 
w»t
 = 
	`push_Ëaf_Ëá
(
Œªs
, 
roÙ
, 
·th
, 1, 1,

5037 1, (
u32
)-1);

5038 ià(
w»t
 < 0 && w»ˆ!ð-
ENOSPC
)

5039 
»t
 = 
w»t
;

5041 ià(
·th
->
nodes
[0] =ð
Ëaf
 &&

5042 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

5043 
w»t
 = 
	`push_Ëaf_right
(
Œªs
, 
roÙ
, 
·th
, 1,

5045 ià(
w»t
 < 0 && w»ˆ!ð-
ENOSPC
)

5046 
»t
 = 
w»t
;

5049 ià(
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) == 0) {

5050 
·th
->
¦Ùs
[1] = 
¦Ù
;

5051 
	`bŒfs_d–_Ëaf
(
Œªs
, 
roÙ
, 
·th
, 
Ëaf
);

5052 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

5053 
»t
 = 0;

5060 ià(
·th
->
nodes
[0] =ð
Ëaf
)

5061 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

5062 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

5065 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

5068  
»t
;

5069 
	}
}

5079 
	$bŒfs_´ev_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
)

5081 
bŒfs_key
 
key
;

5082 
bŒfs_disk_key
 
found_key
;

5083 
»t
;

5085 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
, 0);

5087 ià(
key
.
off£t
 > 0) {

5088 
key
.
off£t
--;

5089 } ià(
key
.
ty³
 > 0) {

5090 
key
.
ty³
--;

5091 
key
.
off£t
 = (
u64
)-1;

5092 } ià(
key
.
objeùid
 > 0) {

5093 
key
.
objeùid
--;

5094 
key
.
ty³
 = (
u8
)-1;

5095 
key
.
off£t
 = (
u64
)-1;

5100 
	`bŒfs_»Ëa£_·th
(
·th
);

5101 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5102 ià(
»t
 < 0)

5103  
»t
;

5104 
	`bŒfs_™em_key
(
·th
->
nodes
[0], &
found_key
, 0);

5105 
»t
 = 
	`comp_keys
(&
found_key
, &
key
);

5116 ià(
»t
 <= 0)

5119 
	}
}

5143 
	$bŒfs_£¬ch_fÜw¬d
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
mš_key
,

5144 
bŒfs_·th
 *
·th
,

5145 
u64
 
mš_Œªs
)

5147 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5148 
ex‹Á_bufãr
 *
cur
;

5149 
bŒfs_key
 
found_key
;

5150 
¦Ù
;

5151 
¤‘
;

5152 
u32
 
Ä™ems
;

5153 
Ëv–
;

5154 
»t
 = 1;

5155 
k“p_locks
 = 
·th
->keep_locks;

5157 
·th
->
k“p_locks
 = 1;

5158 
agaš
:

5159 
cur
 = 
	`bŒfs_»ad_lock_roÙ_node
(
roÙ
);

5160 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
cur
);

5161 
	`WARN_ON
(
·th
->
nodes
[
Ëv–
]);

5162 
·th
->
nodes
[
Ëv–
] = 
cur
;

5163 
·th
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK
;

5165 ià(
	`bŒfs_h—d”_g’”©iÚ
(
cur
è< 
mš_Œªs
) {

5166 
»t
 = 1;

5167 
out
;

5170 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
cur
);

5171 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
cur
);

5172 
¤‘
 = 
	`bš_£¬ch
(
cur
, 
mš_key
, 
Ëv–
, &
¦Ù
);

5175 ià(
Ëv–
 =ð
·th
->
lowe¡_Ëv–
) {

5176 ià(
¦Ù
 >ð
Ä™ems
)

5177 
fšd_Ãxt_key
;

5178 
»t
 = 0;

5179 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

5180 
	`bŒfs_™em_key_to_ýu
(
cur
, &
found_key
, 
¦Ù
);

5181 
out
;

5183 ià(
¤‘
 && 
¦Ù
 > 0)

5184 
¦Ù
--;

5189 
¦Ù
 < 
Ä™ems
) {

5190 
u64
 
g’
;

5192 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
cur
, 
¦Ù
);

5193 ià(
g’
 < 
mš_Œªs
) {

5194 
¦Ù
++;

5199 
fšd_Ãxt_key
:

5204 ià(
¦Ù
 >ð
Ä™ems
) {

5205 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

5206 
	`bŒfs_£t_·th_blockšg
(
·th
);

5207 
¤‘
 = 
	`bŒfs_fšd_Ãxt_key
(
roÙ
, 
·th
, 
mš_key
, 
Ëv–
,

5208 
mš_Œªs
);

5209 ià(
¤‘
 == 0) {

5210 
	`bŒfs_»Ëa£_·th
(
·th
);

5211 
agaš
;

5213 
out
;

5217 
	`bŒfs_node_key_to_ýu
(
cur
, &
found_key
, 
¦Ù
);

5218 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

5219 ià(
Ëv–
 =ð
·th
->
lowe¡_Ëv–
) {

5220 
»t
 = 0;

5221 
out
;

5223 
	`bŒfs_£t_·th_blockšg
(
·th
);

5224 
cur
 = 
	`»ad_node_¦Ù
(
fs_šfo
, cur, 
¦Ù
);

5225 ià(
	`IS_ERR
(
cur
)) {

5226 
»t
 = 
	`PTR_ERR
(
cur
);

5227 
out
;

5230 
	`bŒfs_Œ“_»ad_lock
(
cur
);

5232 
·th
->
locks
[
Ëv–
 - 1] = 
BTRFS_READ_LOCK
;

5233 
·th
->
nodes
[
Ëv–
 - 1] = 
cur
;

5234 
	`uÆock_up
(
·th
, 
Ëv–
, 1, 0, 
NULL
);

5235 
	`bŒfs_þ—r_·th_blockšg
(
·th
, 
NULL
, 0);

5237 
out
:

5238 
·th
->
k“p_locks
 = keep_locks;

5239 ià(
»t
 == 0) {

5240 
	`bŒfs_uÆock_up_§ã
(
·th
,…©h->
lowe¡_Ëv–
 + 1);

5241 
	`bŒfs_£t_·th_blockšg
(
·th
);

5242 
	`memýy
(
mš_key
, &
found_key
, (found_key));

5244  
»t
;

5245 
	}
}

5247 
	$Œ“_move_down
(
bŒfs_fs_šfo
 *
fs_šfo
,

5248 
bŒfs_·th
 *
·th
,

5249 *
Ëv–
)

5251 
ex‹Á_bufãr
 *
eb
;

5253 
	`BUG_ON
(*
Ëv–
 == 0);

5254 
eb
 = 
	`»ad_node_¦Ù
(
fs_šfo
, 
·th
->
nodes
[*
Ëv–
],…©h->
¦Ùs
[*level]);

5255 ià(
	`IS_ERR
(
eb
))

5256  
	`PTR_ERR
(
eb
);

5258 
·th
->
nodes
[*
Ëv–
 - 1] = 
eb
;

5259 
·th
->
¦Ùs
[*
Ëv–
 - 1] = 0;

5260 (*
Ëv–
)--;

5262 
	}
}

5264 
	$Œ“_move_Ãxt_Ü_u²ext
(
bŒfs_·th
 *
·th
,

5265 *
Ëv–
, 
roÙ_Ëv–
)

5267 
»t
 = 0;

5268 
Ä™ems
;

5269 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[*
Ëv–
]);

5271 
·th
->
¦Ùs
[*
Ëv–
]++;

5273 
·th
->
¦Ùs
[*
Ëv–
] >ð
Ä™ems
) {

5274 ià(*
Ëv–
 =ð
roÙ_Ëv–
)

5278 
·th
->
¦Ùs
[*
Ëv–
] = 0;

5279 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[*
Ëv–
]);

5280 
·th
->
nodes
[*
Ëv–
] = 
NULL
;

5281 (*
Ëv–
)++;

5282 
·th
->
¦Ùs
[*
Ëv–
]++;

5284 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[*
Ëv–
]);

5285 
»t
 = 1;

5287  
»t
;

5288 
	}
}

5294 
	$Œ“_advªû
(
bŒfs_fs_šfo
 *
fs_šfo
,

5295 
bŒfs_·th
 *
·th
,

5296 *
Ëv–
, 
roÙ_Ëv–
,

5297 
®low_down
,

5298 
bŒfs_key
 *
key
)

5300 
»t
;

5302 ià(*
Ëv–
 =ð0 || !
®low_down
) {

5303 
»t
 = 
	`Œ“_move_Ãxt_Ü_u²ext
(
·th
, 
Ëv–
, 
roÙ_Ëv–
);

5305 
»t
 = 
	`Œ“_move_down
(
fs_šfo
, 
·th
, 
Ëv–
);

5307 ià(
»t
 >= 0) {

5308 ià(*
Ëv–
 == 0)

5309 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[*
Ëv–
], 
key
,

5310 
·th
->
¦Ùs
[*
Ëv–
]);

5312 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[*
Ëv–
], 
key
,

5313 
·th
->
¦Ùs
[*
Ëv–
]);

5315  
»t
;

5316 
	}
}

5318 
	$Œ“_com·»_™em
(
bŒfs_·th
 *
Ëá_·th
,

5319 
bŒfs_·th
 *
right_·th
,

5320 *
tmp_buf
)

5322 
cmp
;

5323 
Ën1
, 
Ën2
;

5324 
off1
, 
off2
;

5326 
Ën1
 = 
	`bŒfs_™em_size_Ä
(
Ëá_·th
->
nodes
[0],†eá_·th->
¦Ùs
[0]);

5327 
Ën2
 = 
	`bŒfs_™em_size_Ä
(
right_·th
->
nodes
[0],„ight_·th->
¦Ùs
[0]);

5328 ià(
Ën1
 !ð
Ën2
)

5331 
off1
 = 
	`bŒfs_™em_±r_off£t
(
Ëá_·th
->
nodes
[0],†eá_·th->
¦Ùs
[0]);

5332 
off2
 = 
	`bŒfs_™em_±r_off£t
(
right_·th
->
nodes
[0],

5333 
right_·th
->
¦Ùs
[0]);

5335 
	`»ad_ex‹Á_bufãr
(
Ëá_·th
->
nodes
[0], 
tmp_buf
, 
off1
, 
Ën1
);

5337 
cmp
 = 
	`memcmp_ex‹Á_bufãr
(
right_·th
->
nodes
[0], 
tmp_buf
, 
off2
, 
Ën1
);

5338 ià(
cmp
)

5341 
	}
}

5343 
	#ADVANCE
 1

	)

5344 
	#ADVANCE_ONLY_NEXT
 -1

	)

5359 
	$bŒfs_com·»_Œ“s
(
bŒfs_roÙ
 *
Ëá_roÙ
,

5360 
bŒfs_roÙ
 *
right_roÙ
,

5361 
bŒfs_chªged_cb_t
 
chªged_cb
, *
ùx
)

5363 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëá_roÙ
->fs_info;

5364 
»t
;

5365 
cmp
;

5366 
bŒfs_·th
 *
Ëá_·th
 = 
NULL
;

5367 
bŒfs_·th
 *
right_·th
 = 
NULL
;

5368 
bŒfs_key
 
Ëá_key
;

5369 
bŒfs_key
 
right_key
;

5370 *
tmp_buf
 = 
NULL
;

5371 
Ëá_roÙ_Ëv–
;

5372 
right_roÙ_Ëv–
;

5373 
Ëá_Ëv–
;

5374 
right_Ëv–
;

5375 
Ëá_’d_»ached
;

5376 
right_’d_»ached
;

5377 
advªû_Ëá
;

5378 
advªû_right
;

5379 
u64
 
Ëá_block±r
;

5380 
u64
 
right_block±r
;

5381 
u64
 
Ëá_g’
;

5382 
u64
 
right_g’
;

5384 
Ëá_·th
 = 
	`bŒfs_®loc_·th
();

5385 ià(!
Ëá_·th
) {

5386 
»t
 = -
ENOMEM
;

5387 
out
;

5389 
right_·th
 = 
	`bŒfs_®loc_·th
();

5390 ià(!
right_·th
) {

5391 
»t
 = -
ENOMEM
;

5392 
out
;

5395 
tmp_buf
 = 
	`kvm®loc
(
fs_šfo
->
nodesize
, 
GFP_KERNEL
);

5396 ià(!
tmp_buf
) {

5397 
»t
 = -
ENOMEM
;

5398 
out
;

5401 
Ëá_·th
->
£¬ch_comm™_roÙ
 = 1;

5402 
Ëá_·th
->
sk_lockšg
 = 1;

5403 
right_·th
->
£¬ch_comm™_roÙ
 = 1;

5404 
right_·th
->
sk_lockšg
 = 1;

5442 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

5443 
Ëá_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
Ëá_roÙ
->
comm™_roÙ
);

5444 
Ëá_roÙ_Ëv–
 = 
Ëá_Ëv–
;

5445 
Ëá_·th
->
nodes
[
Ëá_Ëv–
] = 
Ëá_roÙ
->
comm™_roÙ
;

5446 
	`ex‹Á_bufãr_g‘
(
Ëá_·th
->
nodes
[
Ëá_Ëv–
]);

5448 
right_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
right_roÙ
->
comm™_roÙ
);

5449 
right_roÙ_Ëv–
 = 
right_Ëv–
;

5450 
right_·th
->
nodes
[
right_Ëv–
] = 
right_roÙ
->
comm™_roÙ
;

5451 
	`ex‹Á_bufãr_g‘
(
right_·th
->
nodes
[
right_Ëv–
]);

5452 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

5454 ià(
Ëá_Ëv–
 == 0)

5455 
	`bŒfs_™em_key_to_ýu
(
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

5456 &
Ëá_key
, 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

5458 
	`bŒfs_node_key_to_ýu
(
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

5459 &
Ëá_key
, 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

5460 ià(
right_Ëv–
 == 0)

5461 
	`bŒfs_™em_key_to_ýu
(
right_·th
->
nodes
[
right_Ëv–
],

5462 &
right_key
, 
right_·th
->
¦Ùs
[
right_Ëv–
]);

5464 
	`bŒfs_node_key_to_ýu
(
right_·th
->
nodes
[
right_Ëv–
],

5465 &
right_key
, 
right_·th
->
¦Ùs
[
right_Ëv–
]);

5467 
Ëá_’d_»ached
 = 
right_’d_»ached
 = 0;

5468 
advªû_Ëá
 = 
advªû_right
 = 0;

5471 ià(
advªû_Ëá
 && !
Ëá_’d_»ached
) {

5472 
»t
 = 
	`Œ“_advªû
(
fs_šfo
, 
Ëá_·th
, &
Ëá_Ëv–
,

5473 
Ëá_roÙ_Ëv–
,

5474 
advªû_Ëá
 !ð
ADVANCE_ONLY_NEXT
,

5475 &
Ëá_key
);

5476 ià(
»t
 == -1)

5477 
Ëá_’d_»ached
 = 
ADVANCE
;

5478 ià(
»t
 < 0)

5479 
out
;

5480 
advªû_Ëá
 = 0;

5482 ià(
advªû_right
 && !
right_’d_»ached
) {

5483 
»t
 = 
	`Œ“_advªû
(
fs_šfo
, 
right_·th
, &
right_Ëv–
,

5484 
right_roÙ_Ëv–
,

5485 
advªû_right
 !ð
ADVANCE_ONLY_NEXT
,

5486 &
right_key
);

5487 ià(
»t
 == -1)

5488 
right_’d_»ached
 = 
ADVANCE
;

5489 ià(
»t
 < 0)

5490 
out
;

5491 
advªû_right
 = 0;

5494 ià(
Ëá_’d_»ached
 && 
right_’d_»ached
) {

5495 
»t
 = 0;

5496 
out
;

5497 } ià(
Ëá_’d_»ached
) {

5498 ià(
right_Ëv–
 == 0) {

5499 
»t
 = 
	`chªged_cb
(
Ëá_roÙ
, 
right_roÙ
,

5500 
Ëá_·th
, 
right_·th
,

5501 &
right_key
,

5502 
BTRFS_COMPARE_TREE_DELETED
,

5503 
ùx
);

5504 ià(
»t
 < 0)

5505 
out
;

5507 
advªû_right
 = 
ADVANCE
;

5509 } ià(
right_’d_»ached
) {

5510 ià(
Ëá_Ëv–
 == 0) {

5511 
»t
 = 
	`chªged_cb
(
Ëá_roÙ
, 
right_roÙ
,

5512 
Ëá_·th
, 
right_·th
,

5513 &
Ëá_key
,

5514 
BTRFS_COMPARE_TREE_NEW
,

5515 
ùx
);

5516 ià(
»t
 < 0)

5517 
out
;

5519 
advªû_Ëá
 = 
ADVANCE
;

5523 ià(
Ëá_Ëv–
 =ð0 && 
right_Ëv–
 == 0) {

5524 
cmp
 = 
	`bŒfs_comp_ýu_keys
(&
Ëá_key
, &
right_key
);

5525 ià(
cmp
 < 0) {

5526 
»t
 = 
	`chªged_cb
(
Ëá_roÙ
, 
right_roÙ
,

5527 
Ëá_·th
, 
right_·th
,

5528 &
Ëá_key
,

5529 
BTRFS_COMPARE_TREE_NEW
,

5530 
ùx
);

5531 ià(
»t
 < 0)

5532 
out
;

5533 
advªû_Ëá
 = 
ADVANCE
;

5534 } ià(
cmp
 > 0) {

5535 
»t
 = 
	`chªged_cb
(
Ëá_roÙ
, 
right_roÙ
,

5536 
Ëá_·th
, 
right_·th
,

5537 &
right_key
,

5538 
BTRFS_COMPARE_TREE_DELETED
,

5539 
ùx
);

5540 ià(
»t
 < 0)

5541 
out
;

5542 
advªû_right
 = 
ADVANCE
;

5544 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
;

5546 
	`WARN_ON
(!
	`ex‹Á_bufãr_u±od©e
(
Ëá_·th
->
nodes
[0]));

5547 
»t
 = 
	`Œ“_com·»_™em
(
Ëá_·th
, 
right_·th
,

5548 
tmp_buf
);

5549 ià(
»t
)

5550 
»suÉ
 = 
BTRFS_COMPARE_TREE_CHANGED
;

5552 
»suÉ
 = 
BTRFS_COMPARE_TREE_SAME
;

5553 
»t
 = 
	`chªged_cb
(
Ëá_roÙ
, 
right_roÙ
,

5554 
Ëá_·th
, 
right_·th
,

5555 &
Ëá_key
, 
»suÉ
, 
ùx
);

5556 ià(
»t
 < 0)

5557 
out
;

5558 
advªû_Ëá
 = 
ADVANCE
;

5559 
advªû_right
 = 
ADVANCE
;

5561 } ià(
Ëá_Ëv–
 =ð
right_Ëv–
) {

5562 
cmp
 = 
	`bŒfs_comp_ýu_keys
(&
Ëá_key
, &
right_key
);

5563 ià(
cmp
 < 0) {

5564 
advªû_Ëá
 = 
ADVANCE
;

5565 } ià(
cmp
 > 0) {

5566 
advªû_right
 = 
ADVANCE
;

5568 
Ëá_block±r
 = 
	`bŒfs_node_block±r
(

5569 
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

5570 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

5571 
right_block±r
 = 
	`bŒfs_node_block±r
(

5572 
right_·th
->
nodes
[
right_Ëv–
],

5573 
right_·th
->
¦Ùs
[
right_Ëv–
]);

5574 
Ëá_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(

5575 
Ëá_·th
->
nodes
[
Ëá_Ëv–
],

5576 
Ëá_·th
->
¦Ùs
[
Ëá_Ëv–
]);

5577 
right_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(

5578 
right_·th
->
nodes
[
right_Ëv–
],

5579 
right_·th
->
¦Ùs
[
right_Ëv–
]);

5580 ià(
Ëá_block±r
 =ð
right_block±r
 &&

5581 
Ëá_g’
 =ð
right_g’
) {

5586 
advªû_Ëá
 = 
ADVANCE_ONLY_NEXT
;

5587 
advªû_right
 = 
ADVANCE_ONLY_NEXT
;

5589 
advªû_Ëá
 = 
ADVANCE
;

5590 
advªû_right
 = 
ADVANCE
;

5593 } ià(
Ëá_Ëv–
 < 
right_Ëv–
) {

5594 
advªû_right
 = 
ADVANCE
;

5596 
advªû_Ëá
 = 
ADVANCE
;

5600 
out
:

5601 
	`bŒfs_ä“_·th
(
Ëá_·th
);

5602 
	`bŒfs_ä“_·th
(
right_·th
);

5603 
	`kvä“
(
tmp_buf
);

5604  
»t
;

5605 
	}
}

5618 
	$bŒfs_fšd_Ãxt_key
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

5619 
bŒfs_key
 *
key
, 
Ëv–
, 
u64
 
mš_Œªs
)

5621 
¦Ù
;

5622 
ex‹Á_bufãr
 *
c
;

5624 
	`WARN_ON
(!
·th
->
k“p_locks
);

5625 
Ëv–
 < 
BTRFS_MAX_LEVEL
) {

5626 ià(!
·th
->
nodes
[
Ëv–
])

5629 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
] + 1;

5630 
c
 = 
·th
->
nodes
[
Ëv–
];

5631 
Ãxt
:

5632 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
c
)) {

5633 
»t
;

5634 
Üig_lowe¡
;

5635 
bŒfs_key
 
cur_key
;

5636 ià(
Ëv–
 + 1 >ð
BTRFS_MAX_LEVEL
 ||

5637 !
·th
->
nodes
[
Ëv–
 + 1])

5640 ià(
·th
->
locks
[
Ëv–
 + 1]) {

5641 
Ëv–
++;

5645 
¦Ù
 = 
	`bŒfs_h—d”_Ä™ems
(
c
) - 1;

5646 ià(
Ëv–
 == 0)

5647 
	`bŒfs_™em_key_to_ýu
(
c
, &
cur_key
, 
¦Ù
);

5649 
	`bŒfs_node_key_to_ýu
(
c
, &
cur_key
, 
¦Ù
);

5651 
Üig_lowe¡
 = 
·th
->
lowe¡_Ëv–
;

5652 
	`bŒfs_»Ëa£_·th
(
·th
);

5653 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

5654 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
cur_key
, 
·th
,

5656 
·th
->
lowe¡_Ëv–
 = 
Üig_lowe¡
;

5657 ià(
»t
 < 0)

5658  
»t
;

5660 
c
 = 
·th
->
nodes
[
Ëv–
];

5661 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

5662 ià(
»t
 == 0)

5663 
¦Ù
++;

5664 
Ãxt
;

5667 ià(
Ëv–
 == 0)

5668 
	`bŒfs_™em_key_to_ýu
(
c
, 
key
, 
¦Ù
);

5670 
u64
 
g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
c
, 
¦Ù
);

5672 ià(
g’
 < 
mš_Œªs
) {

5673 
¦Ù
++;

5674 
Ãxt
;

5676 
	`bŒfs_node_key_to_ýu
(
c
, 
key
, 
¦Ù
);

5681 
	}
}

5688 
	$bŒfs_Ãxt_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
)

5690  
	`bŒfs_Ãxt_Þd_Ëaf
(
roÙ
, 
·th
, 0);

5691 
	}
}

5693 
	$bŒfs_Ãxt_Þd_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

5694 
u64
 
time_£q
)

5696 
¦Ù
;

5697 
Ëv–
;

5698 
ex‹Á_bufãr
 *
c
;

5699 
ex‹Á_bufãr
 *
Ãxt
;

5700 
bŒfs_key
 
key
;

5701 
u32
 
Ä™ems
;

5702 
»t
;

5703 
Þd_¥šnšg
 = 
·th
->
Ëave_¥šnšg
;

5704 
Ãxt_rw_lock
 = 0;

5706 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

5707 ià(
Ä™ems
 == 0)

5710 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
, 
Ä™ems
 - 1);

5711 
agaš
:

5712 
Ëv–
 = 1;

5713 
Ãxt
 = 
NULL
;

5714 
Ãxt_rw_lock
 = 0;

5715 
	`bŒfs_»Ëa£_·th
(
·th
);

5717 
·th
->
k“p_locks
 = 1;

5718 
·th
->
Ëave_¥šnšg
 = 1;

5720 ià(
time_£q
)

5721 
»t
 = 
	`bŒfs_£¬ch_Þd_¦Ù
(
roÙ
, &
key
, 
·th
, 
time_£q
);

5723 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5724 
·th
->
k“p_locks
 = 0;

5726 ià(
»t
 < 0)

5727  
»t
;

5729 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

5736 ià(
Ä™ems
 > 0 && 
·th
->
¦Ùs
[0] <‚ritems - 1) {

5737 ià(
»t
 == 0)

5738 
·th
->
¦Ùs
[0]++;

5739 
»t
 = 0;

5740 
dÚe
;

5756 ià(
Ä™ems
 > 0 && 
»t
 > 0 && 
·th
->
¦Ùs
[0] ==‚ritems - 1) {

5757 
»t
 = 0;

5758 
dÚe
;

5761 
Ëv–
 < 
BTRFS_MAX_LEVEL
) {

5762 ià(!
·th
->
nodes
[
Ëv–
]) {

5763 
»t
 = 1;

5764 
dÚe
;

5767 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
] + 1;

5768 
c
 = 
·th
->
nodes
[
Ëv–
];

5769 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
c
)) {

5770 
Ëv–
++;

5771 ià(
Ëv–
 =ð
BTRFS_MAX_LEVEL
) {

5772 
»t
 = 1;

5773 
dÚe
;

5778 ià(
Ãxt
) {

5779 
	`bŒfs_Œ“_uÆock_rw
(
Ãxt
, 
Ãxt_rw_lock
);

5780 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

5783 
Ãxt
 = 
c
;

5784 
Ãxt_rw_lock
 = 
·th
->
locks
[
Ëv–
];

5785 
»t
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
·th
, &
Ãxt
, 
Ëv–
,

5786 
¦Ù
, &
key
);

5787 ià(
»t
 =ð-
EAGAIN
)

5788 
agaš
;

5790 ià(
»t
 < 0) {

5791 
	`bŒfs_»Ëa£_·th
(
·th
);

5792 
dÚe
;

5795 ià(!
·th
->
sk_lockšg
) {

5796 
»t
 = 
	`bŒfs_Œy_Œ“_»ad_lock
(
Ãxt
);

5797 ià(!
»t
 && 
time_£q
) {

5805 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

5806 
	`bŒfs_»Ëa£_·th
(
·th
);

5807 
	`cÚd_»sched
();

5808 
agaš
;

5810 ià(!
»t
) {

5811 
	`bŒfs_£t_·th_blockšg
(
·th
);

5812 
	`bŒfs_Œ“_»ad_lock
(
Ãxt
);

5813 
	`bŒfs_þ—r_·th_blockšg
(
·th
, 
Ãxt
,

5814 
BTRFS_READ_LOCK
);

5816 
Ãxt_rw_lock
 = 
BTRFS_READ_LOCK
;

5820 
·th
->
¦Ùs
[
Ëv–
] = 
¦Ù
;

5822 
Ëv–
--;

5823 
c
 = 
·th
->
nodes
[
Ëv–
];

5824 ià(
·th
->
locks
[
Ëv–
])

5825 
	`bŒfs_Œ“_uÆock_rw
(
c
, 
·th
->
locks
[
Ëv–
]);

5827 
	`ä“_ex‹Á_bufãr
(
c
);

5828 
·th
->
nodes
[
Ëv–
] = 
Ãxt
;

5829 
·th
->
¦Ùs
[
Ëv–
] = 0;

5830 ià(!
·th
->
sk_lockšg
)

5831 
·th
->
locks
[
Ëv–
] = 
Ãxt_rw_lock
;

5832 ià(!
Ëv–
)

5835 
»t
 = 
	`»ad_block_fÜ_£¬ch
(
roÙ
, 
·th
, &
Ãxt
, 
Ëv–
,

5836 0, &
key
);

5837 ià(
»t
 =ð-
EAGAIN
)

5838 
agaš
;

5840 ià(
»t
 < 0) {

5841 
	`bŒfs_»Ëa£_·th
(
·th
);

5842 
dÚe
;

5845 ià(!
·th
->
sk_lockšg
) {

5846 
»t
 = 
	`bŒfs_Œy_Œ“_»ad_lock
(
Ãxt
);

5847 ià(!
»t
) {

5848 
	`bŒfs_£t_·th_blockšg
(
·th
);

5849 
	`bŒfs_Œ“_»ad_lock
(
Ãxt
);

5850 
	`bŒfs_þ—r_·th_blockšg
(
·th
, 
Ãxt
,

5851 
BTRFS_READ_LOCK
);

5853 
Ãxt_rw_lock
 = 
BTRFS_READ_LOCK
;

5856 
»t
 = 0;

5857 
dÚe
:

5858 
	`uÆock_up
(
·th
, 0, 1, 0, 
NULL
);

5859 
·th
->
Ëave_¥šnšg
 = 
Þd_¥šnšg
;

5860 ià(!
Þd_¥šnšg
)

5861 
	`bŒfs_£t_·th_blockšg
(
·th
);

5863  
»t
;

5864 
	}
}

5872 
	$bŒfs_´evious_™em
(
bŒfs_roÙ
 *
roÙ
,

5873 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
,

5874 
ty³
)

5876 
bŒfs_key
 
found_key
;

5877 
ex‹Á_bufãr
 *
Ëaf
;

5878 
u32
 
Ä™ems
;

5879 
»t
;

5882 ià(
·th
->
¦Ùs
[0] == 0) {

5883 
	`bŒfs_£t_·th_blockšg
(
·th
);

5884 
»t
 = 
	`bŒfs_´ev_Ëaf
(
roÙ
, 
·th
);

5885 ià(
»t
 != 0)

5886  
»t
;

5888 
·th
->
¦Ùs
[0]--;

5890 
Ëaf
 = 
·th
->
nodes
[0];

5891 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

5892 ià(
Ä™ems
 == 0)

5894 ià(
·th
->
¦Ùs
[0] =ð
Ä™ems
)

5895 
·th
->
¦Ùs
[0]--;

5897 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

5898 ià(
found_key
.
objeùid
 < 
mš_objeùid
)

5900 ià(
found_key
.
ty³
 ==ype)

5902 ià(
found_key
.
objeùid
 =ð
mš_objeùid
 &&

5903 
found_key
.
ty³
 <ype)

5907 
	}
}

5915 
	$bŒfs_´evious_ex‹Á_™em
(
bŒfs_roÙ
 *
roÙ
,

5916 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
)

5918 
bŒfs_key
 
found_key
;

5919 
ex‹Á_bufãr
 *
Ëaf
;

5920 
u32
 
Ä™ems
;

5921 
»t
;

5924 ià(
·th
->
¦Ùs
[0] == 0) {

5925 
	`bŒfs_£t_·th_blockšg
(
·th
);

5926 
»t
 = 
	`bŒfs_´ev_Ëaf
(
roÙ
, 
·th
);

5927 ià(
»t
 != 0)

5928  
»t
;

5930 
·th
->
¦Ùs
[0]--;

5932 
Ëaf
 = 
·th
->
nodes
[0];

5933 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

5934 ià(
Ä™ems
 == 0)

5936 ià(
·th
->
¦Ùs
[0] =ð
Ä™ems
)

5937 
·th
->
¦Ùs
[0]--;

5939 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

5940 ià(
found_key
.
objeùid
 < 
mš_objeùid
)

5942 ià(
found_key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 ||

5943 
found_key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

5945 ià(
found_key
.
objeùid
 =ð
mš_objeùid
 &&

5946 
found_key
.
ty³
 < 
BTRFS_EXTENT_ITEM_KEY
)

5950 
	}
}

	@ctree.h

19 #iâdeà
__BTRFS_CTREE__


20 
	#__BTRFS_CTREE__


	)

22 
	~<lšux/mm.h
>

23 
	~<lšux/sched/sigÇl.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/fs.h
>

26 
	~<lšux/rw£m.h
>

27 
	~<lšux/£m­hÜe.h
>

28 
	~<lšux/com¶‘iÚ.h
>

29 
	~<lšux/backšg-dev.h
>

30 
	~<lšux/wa™.h
>

31 
	~<lšux/¦ab.h
>

32 
	~<lšux/kobjeù.h
>

33 
	~<Œaû/ev’ts/bŒfs.h
>

34 
	~<asm/km­_ty³s.h
>

35 
	~<lšux/·gem­.h
>

36 
	~<lšux/bŒfs.h
>

37 
	~<lšux/bŒfs_Œ“.h
>

38 
	~<lšux/wÜkqueue.h
>

39 
	~<lšux/£cur™y.h
>

40 
	~<lšux/sizes.h
>

41 
	~<lšux/dyÇmic_debug.h
>

42 
	~<lšux/»fcouÁ.h
>

43 
	~"ex‹Á_io.h
"

44 
	~"ex‹Á_m­.h
"

45 
	~"async-th»ad.h
"

47 
	gbŒfs_Œªs_hªdË
;

48 
	gbŒfs_Œª§ùiÚ
;

49 
	gbŒfs_³ndšg_¢­shÙ
;

50 
kmem_ÿche
 *
bŒfs_Œªs_hªdË_ÿch•
;

51 
kmem_ÿche
 *
bŒfs_b™_¿dix_ÿch•
;

52 
kmem_ÿche
 *
bŒfs_·th_ÿch•
;

53 
kmem_ÿche
 *
bŒfs_ä“_¥aû_ÿch•
;

54 
	gbŒfs_Üd”ed_sum
;

56 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


57 
	#STATIC
 
nošlše


	)

59 
	#STATIC
 
nošlše


	)

62 
	#BTRFS_MAGIC
 0x4D5F53665248425FULL

	)

64 
	#BTRFS_MAX_MIRRORS
 3

	)

66 
	#BTRFS_MAX_LEVEL
 8

	)

68 
	#BTRFS_COMPAT_EXTENT_TREE_V0


	)

74 
	#BTRFS_MAX_METADATA_BLOCKSIZE
 65536

	)

80 
	#BTRFS_NAME_LEN
 255

	)

87 
	#BTRFS_LINK_MAX
 65535U

	)

89 cÚ¡ 
	gbŒfs_csum_sizes
[] = { 4 };

92 
	#BTRFS_EMPTY_DIR_SIZE
 0

	)

95 
	#BTRFS_IOPRIO_READA
 (
	`IOPRIO_PRIO_VALUE
(
IOPRIO_CLASS_IDLE
, 0))

	)

97 
	#BTRFS_DIRTY_METADATA_THRESH
 
SZ_32M


	)

99 
	#BTRFS_MAX_EXTENT_SIZE
 
SZ_128M


	)

104 
šlše
 
u32
 
	$couÁ_max_ex‹Ás
(
u64
 
size
)

106  
	`div_u64
(
size
 + 
BTRFS_MAX_EXTENT_SIZE
 - 1, BTRFS_MAX_EXTENT_SIZE);

107 
	}
}

109 
	sbŒfs_m­pšg_Œ“
 {

110 
ex‹Á_m­_Œ“
 
	mm­_Œ“
;

113 
šlše
 
	$bŒfs_chunk_™em_size
(
num_¡res
)

115 
	`BUG_ON
(
num_¡res
 == 0);

116  (
bŒfs_chunk
) +

117 (
bŒfs_¡re
è* (
num_¡res
 - 1);

118 
	}
}

123 
	#BTRFS_FS_STATE_ERROR
 0

	)

124 
	#BTRFS_FS_STATE_REMOUNTING
 1

	)

125 
	#BTRFS_FS_STATE_TRANS_ABORTED
 2

	)

126 
	#BTRFS_FS_STATE_DEV_REPLACING
 3

	)

127 
	#BTRFS_FS_STATE_DUMMY_FS_INFO
 4

	)

129 
	#BTRFS_BACKREF_REV_MAX
 256

	)

130 
	#BTRFS_BACKREF_REV_SHIFT
 56

	)

131 
	#BTRFS_BACKREF_REV_MASK
 (((
u64
)
BTRFS_BACKREF_REV_MAX
 - 1) << \

132 
BTRFS_BACKREF_REV_SHIFT
)

	)

134 
	#BTRFS_OLD_BACKREF_REV
 0

	)

135 
	#BTRFS_MIXED_BACKREF_REV
 1

	)

140 
	sbŒfs_h—d”
 {

142 
u8
 
	mcsum
[
BTRFS_CSUM_SIZE
];

143 
u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

144 
__Ë64
 
	mby‹Ä
;

145 
__Ë64
 
	mæags
;

148 
u8
 
	mchunk_Œ“_uuid
[
BTRFS_UUID_SIZE
];

149 
__Ë64
 
	mg’”©iÚ
;

150 
__Ë64
 
	mowÃr
;

151 
__Ë32
 
	mÄ™ems
;

152 
u8
 
	mËv–
;

153 } 
__©Œibu‹__
 ((
__·cked__
));

159 
	#BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
 2048

	)

166 
	#BTRFS_NUM_BACKUP_ROOTS
 4

	)

167 
	sbŒfs_roÙ_backup
 {

168 
__Ë64
 
	mŒ“_roÙ
;

169 
__Ë64
 
	mŒ“_roÙ_g’
;

171 
__Ë64
 
	mchunk_roÙ
;

172 
__Ë64
 
	mchunk_roÙ_g’
;

174 
__Ë64
 
	mex‹Á_roÙ
;

175 
__Ë64
 
	mex‹Á_roÙ_g’
;

177 
__Ë64
 
	mfs_roÙ
;

178 
__Ë64
 
	mfs_roÙ_g’
;

180 
__Ë64
 
	mdev_roÙ
;

181 
__Ë64
 
	mdev_roÙ_g’
;

183 
__Ë64
 
	mcsum_roÙ
;

184 
__Ë64
 
	mcsum_roÙ_g’
;

186 
__Ë64
 
	mtÙ®_by‹s
;

187 
__Ë64
 
	mby‹s_u£d
;

188 
__Ë64
 
	mnum_deviûs
;

190 
__Ë64
 
	munu£d_64
[4];

192 
u8
 
	mŒ“_roÙ_Ëv–
;

193 
u8
 
	mchunk_roÙ_Ëv–
;

194 
u8
 
	mex‹Á_roÙ_Ëv–
;

195 
u8
 
	mfs_roÙ_Ëv–
;

196 
u8
 
	mdev_roÙ_Ëv–
;

197 
u8
 
	mcsum_roÙ_Ëv–
;

199 
u8
 
	munu£d_8
[10];

200 } 
__©Œibu‹__
 ((
__·cked__
));

206 
	sbŒfs_su³r_block
 {

207 
u8
 
	mcsum
[
BTRFS_CSUM_SIZE
];

209 
u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

210 
__Ë64
 
	mby‹Ä
;

211 
__Ë64
 
	mæags
;

214 
__Ë64
 
	mmagic
;

215 
__Ë64
 
	mg’”©iÚ
;

216 
__Ë64
 
	mroÙ
;

217 
__Ë64
 
	mchunk_roÙ
;

218 
__Ë64
 
	mlog_roÙ
;

221 
__Ë64
 
	mlog_roÙ_Œªsid
;

222 
__Ë64
 
	mtÙ®_by‹s
;

223 
__Ë64
 
	mby‹s_u£d
;

224 
__Ë64
 
	mroÙ_dœ_objeùid
;

225 
__Ë64
 
	mnum_deviûs
;

226 
__Ë32
 
	m£ùÜsize
;

227 
__Ë32
 
	mnodesize
;

228 
__Ë32
 
	m__unu£d_Ëafsize
;

229 
__Ë32
 
	m¡resize
;

230 
__Ë32
 
	msys_chunk_¬¿y_size
;

231 
__Ë64
 
	mchunk_roÙ_g’”©iÚ
;

232 
__Ë64
 
	mcom·t_æags
;

233 
__Ë64
 
	mcom·t_ro_æags
;

234 
__Ë64
 
	mšcom·t_æags
;

235 
__Ë16
 
	mcsum_ty³
;

236 
u8
 
	mroÙ_Ëv–
;

237 
u8
 
	mchunk_roÙ_Ëv–
;

238 
u8
 
	mlog_roÙ_Ëv–
;

239 
bŒfs_dev_™em
 
	mdev_™em
;

241 
	mÏb–
[
BTRFS_LABEL_SIZE
];

243 
__Ë64
 
	mÿche_g’”©iÚ
;

244 
__Ë64
 
	muuid_Œ“_g’”©iÚ
;

247 
__Ë64
 
	m»£rved
[30];

248 
u8
 
	msys_chunk_¬¿y
[
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
];

249 
bŒfs_roÙ_backup
 
	msu³r_roÙs
[
BTRFS_NUM_BACKUP_ROOTS
];

250 } 
__©Œibu‹__
 ((
__·cked__
));

256 
	#BTRFS_FEATURE_COMPAT_SUPP
 0ULL

	)

257 
	#BTRFS_FEATURE_COMPAT_SAFE_SET
 0ULL

	)

258 
	#BTRFS_FEATURE_COMPAT_SAFE_CLEAR
 0ULL

	)

260 
	#BTRFS_FEATURE_COMPAT_RO_SUPP
 \

261 (
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
 | \

262 
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE_VALID
)

	)

264 
	#BTRFS_FEATURE_COMPAT_RO_SAFE_SET
 0ULL

	)

265 
	#BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
 0ULL

	)

267 
	#BTRFS_FEATURE_INCOMPAT_SUPP
 \

268 (
BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
 | \

269 
BTRFS_FEATURE_INCOMPAT_DEFAULT_SUBVOL
 | \

270 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
 | \

271 
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
 | \

272 
BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
 | \

273 
BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
 | \

274 
BTRFS_FEATURE_INCOMPAT_RAID56
 | \

275 
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
 | \

276 
BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA
 | \

277 
BTRFS_FEATURE_INCOMPAT_NO_HOLES
)

	)

279 
	#BTRFS_FEATURE_INCOMPAT_SAFE_SET
 \

280 (
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
)

	)

281 
	#BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
 0ULL

	)

287 
	sbŒfs_™em
 {

288 
bŒfs_disk_key
 
	mkey
;

289 
__Ë32
 
	moff£t
;

290 
__Ë32
 
	msize
;

291 } 
__©Œibu‹__
 ((
__·cked__
));

300 
	sbŒfs_Ëaf
 {

301 
bŒfs_h—d”
 
	mh—d”
;

302 
bŒfs_™em
 
	m™ems
[];

303 } 
__©Œibu‹__
 ((
__·cked__
));

309 
	sbŒfs_key_±r
 {

310 
bŒfs_disk_key
 
	mkey
;

311 
__Ë64
 
	mblock±r
;

312 
__Ë64
 
	mg’”©iÚ
;

313 } 
__©Œibu‹__
 ((
__·cked__
));

315 
	sbŒfs_node
 {

316 
bŒfs_h—d”
 
	mh—d”
;

317 
bŒfs_key_±r
 
	m±rs
[];

318 } 
__©Œibu‹__
 ((
__·cked__
));

328 ’um { 
	mREADA_NONE
 = 0, 
	mREADA_BACK
, 
	mREADA_FORWARD
 };

329 
	sbŒfs_·th
 {

330 
ex‹Á_bufãr
 *
	mnodes
[
BTRFS_MAX_LEVEL
];

331 
	m¦Ùs
[
BTRFS_MAX_LEVEL
];

333 
u8
 
	mlocks
[
BTRFS_MAX_LEVEL
];

334 
u8
 
	m»ada
;

336 
u8
 
	mlowe¡_Ëv–
;

342 
	m£¬ch_fÜ_¥l™
:1;

343 
	mk“p_locks
:1;

344 
	msk_lockšg
:1;

345 
	mËave_¥šnšg
:1;

346 
	m£¬ch_comm™_roÙ
:1;

347 
	mÃed_comm™_£m
:1;

348 
	msk_»Ëa£_Ú_”rÜ
:1;

350 
	#BTRFS_MAX_EXTENT_ITEM_SIZE
(
r
è((
	`BTRFS_LEAF_DATA_SIZE
Ô->
fs_šfo
) >> 4) - \

351 (
bŒfs_™em
))

	)

352 
	sbŒfs_dev_»¶aû
 {

353 
u64
 
	m»¶aû_¡©e
;

354 
u64
 
	mtime_¡¬‹d
;

355 
u64
 
	mtime_¡Ý³d
;

356 
©omic64_t
 
	mnum_wr™e_”rÜs
;

357 
©omic64_t
 
	mnum_uncÜ»ùabË_»ad_”rÜs
;

359 
u64
 
	mcursÜ_Ëá
;

360 
u64
 
	mcomm™‹d_cursÜ_Ëá
;

361 
u64
 
	mcursÜ_Ëá_Ï¡_wr™e_of_™em
;

362 
u64
 
	mcursÜ_right
;

364 
u64
 
	mcÚt_»adšg_äom_¤cdev_mode
;

366 
	mis_v®id
;

367 
	m™em_Ãeds_wr™eback
;

368 
bŒfs_deviû
 *
	m¤cdev
;

369 
bŒfs_deviû
 *
	mtgtdev
;

371 
pid_t
 
	mlock_owÃr
;

372 
©omic_t
 
	mÃ¡šg_Ëv–
;

373 
mu‹x
 
	mlock_fšishšg_ÿnûl_unmouÁ
;

374 
rwlock_t
 
	mlock
;

375 
©omic_t
 
	m»ad_locks
;

376 
©omic_t
 
	mblockšg_»ad”s
;

377 
wa™_queue_h—d_t
 
	m»ad_lock_wq
;

379 
bŒfs_süub_´og»ss
 
	msüub_´og»ss
;

383 
	s¿id_kobjeù
 {

384 
	m¿id_ty³
;

385 
kobjeù
 
	mkobj
;

388 
	sbŒfs_¥aû_šfo
 {

389 
¥šlock_t
 
	mlock
;

391 
u64
 
	mtÙ®_by‹s
;

393 
u64
 
	mby‹s_u£d
;

395 
u64
 
	mby‹s_pšÃd
;

397 
u64
 
	mby‹s_»£rved
;

399 
u64
 
	mby‹s_may_u£
;

401 
u64
 
	mby‹s_»adÚly
;

403 
u64
 
	mmax_ex‹Á_size
;

407 
	mfuÎ
:1;

409 
	mchunk_®loc
:1;

411 
	mæush
:1;

413 
	mfÜû_®loc
;

416 
u64
 
	mdisk_u£d
;

417 
u64
 
	mdisk_tÙ®
;

420 
u64
 
	mæags
;

432 
³rýu_couÁ”
 
	mtÙ®_by‹s_pšÃd
;

434 
li¡_h—d
 
	mli¡
;

436 
li¡_h—d
 
	mro_bgs
;

437 
li¡_h—d
 
	m´iÜ™y_tick‘s
;

438 
li¡_h—d
 
	mtick‘s
;

443 
u64
 
	mtick‘s_id
;

445 
rw_£m­hÜe
 
	mgroups_£m
;

447 
li¡_h—d
 
	mblock_groups
[
BTRFS_NR_RAID_TYPES
];

448 
wa™_queue_h—d_t
 
	mwa™
;

450 
kobjeù
 
	mkobj
;

451 
kobjeù
 *
	mblock_group_kobjs
[
BTRFS_NR_RAID_TYPES
];

454 
	#BTRFS_BLOCK_RSV_GLOBAL
 1

	)

455 
	#BTRFS_BLOCK_RSV_DELALLOC
 2

	)

456 
	#BTRFS_BLOCK_RSV_TRANS
 3

	)

457 
	#BTRFS_BLOCK_RSV_CHUNK
 4

	)

458 
	#BTRFS_BLOCK_RSV_DELOPS
 5

	)

459 
	#BTRFS_BLOCK_RSV_EMPTY
 6

	)

460 
	#BTRFS_BLOCK_RSV_TEMP
 7

	)

462 
	sbŒfs_block_rsv
 {

463 
u64
 
	msize
;

464 
u64
 
	m»£rved
;

465 
bŒfs_¥aû_šfo
 *
	m¥aû_šfo
;

466 
¥šlock_t
 
	mlock
;

467 
	mfuÎ
;

468 
	mty³
;

469 
	mçžç¡
;

477 
	sbŒfs_ä“_þu¡”
 {

478 
¥šlock_t
 
	mlock
;

479 
¥šlock_t
 
	m»fžl_lock
;

480 
rb_roÙ
 
	mroÙ
;

483 
u64
 
	mmax_size
;

486 
u64
 
	mwšdow_¡¬t
;

489 
boÞ
 
	mäagm’‹d
;

491 
bŒfs_block_group_ÿche
 *
	mblock_group
;

497 
li¡_h—d
 
	mblock_group_li¡
;

500 
	ebŒfs_ÿchšg_ty³
 {

501 
	mBTRFS_CACHE_NO
 = 0,

502 
	mBTRFS_CACHE_STARTED
 = 1,

503 
	mBTRFS_CACHE_FAST
 = 2,

504 
	mBTRFS_CACHE_FINISHED
 = 3,

505 
	mBTRFS_CACHE_ERROR
 = 4,

508 
	ebŒfs_disk_ÿche_¡©e
 {

509 
	mBTRFS_DC_WRITTEN
 = 0,

510 
	mBTRFS_DC_ERROR
 = 1,

511 
	mBTRFS_DC_CLEAR
 = 2,

512 
	mBTRFS_DC_SETUP
 = 3,

515 
	sbŒfs_ÿchšg_cÚŒÞ
 {

516 
li¡_h—d
 
	mli¡
;

517 
mu‹x
 
	mmu‹x
;

518 
wa™_queue_h—d_t
 
	mwa™
;

519 
bŒfs_wÜk
 
	mwÜk
;

520 
bŒfs_block_group_ÿche
 *
	mblock_group
;

521 
u64
 
	m´og»ss
;

522 
»fcouÁ_t
 
	mcouÁ
;

526 
	#CACHING_CTL_WAKE_UP
 (1024 * 1024 * 2)

	)

528 
	sbŒfs_io_ùl
 {

529 *
	mcur
, *
	mÜig
;

530 
·ge
 *
	m·ge
;

531 
·ge
 **
	m·ges
;

532 
bŒfs_fs_šfo
 *
	mfs_šfo
;

533 
šode
 *
	mšode
;

534 
	msize
;

535 
	mšdex
;

536 
	mnum_·ges
;

537 
	m’Œ›s
;

538 
	mb™m­s
;

539 
	mcheck_ücs
:1;

545 
	sbŒfs_fuÎ_¡re_locks_Œ“
 {

546 
rb_roÙ
 
	mroÙ
;

547 
mu‹x
 
	mlock
;

550 
	sbŒfs_block_group_ÿche
 {

551 
bŒfs_key
 
	mkey
;

552 
bŒfs_block_group_™em
 
	m™em
;

553 
bŒfs_fs_šfo
 *
	mfs_šfo
;

554 
šode
 *
	mšode
;

555 
¥šlock_t
 
	mlock
;

556 
u64
 
	mpšÃd
;

557 
u64
 
	m»£rved
;

558 
u64
 
	md–®loc_by‹s
;

559 
u64
 
	mby‹s_su³r
;

560 
u64
 
	mæags
;

561 
u64
 
	mÿche_g’”©iÚ
;

567 
u32
 
	mb™m­_high_th»sh
;

573 
u32
 
	mb™m­_low_th»sh
;

580 
rw_£m­hÜe
 
	md©a_rw£m
;

583 
	mfuÎ_¡re_Ën
;

585 
	mro
;

586 
	mœef
:1;

587 
	mhas_ÿchšg_ùl
:1;

588 
	m»moved
:1;

590 
	mdisk_ÿche_¡©e
;

593 
	mÿched
;

594 
bŒfs_ÿchšg_cÚŒÞ
 *
	mÿchšg_ùl
;

595 
u64
 
	mÏ¡_by‹_to_uÅš
;

597 
bŒfs_¥aû_šfo
 *
	m¥aû_šfo
;

600 
bŒfs_ä“_¥aû_ùl
 *
	mä“_¥aû_ùl
;

603 
rb_node
 
	mÿche_node
;

606 
li¡_h—d
 
	mli¡
;

609 
©omic_t
 
	mcouÁ
;

614 
li¡_h—d
 
	mþu¡”_li¡
;

617 
li¡_h—d
 
	mbg_li¡
;

620 
li¡_h—d
 
	mro_li¡
;

622 
©omic_t
 
	mŒimmšg
;

625 
li¡_h—d
 
	mdœty_li¡
;

626 
li¡_h—d
 
	mio_li¡
;

628 
bŒfs_io_ùl
 
	mio_ùl
;

639 
©omic_t
 
	m»£rv©iÚs
;

649 
©omic_t
 
	mnocow_wr™”s
;

652 
mu‹x
 
	mä“_¥aû_lock
;

658 
	mÃeds_ä“_¥aû
;

661 
bŒfs_fuÎ_¡re_locks_Œ“
 
	mfuÎ_¡re_locks_roÙ
;

665 
	s£q_li¡
 {

666 
li¡_h—d
 
	mli¡
;

667 
u64
 
	m£q
;

670 
	#SEQ_LIST_INIT
(
Çme
è{ .
li¡
 = 
	`LIST_HEAD_INIT
(Òame).li¡), .
£q
 = 0 }

	)

672 
	#SEQ_LAST
 ((
u64
)-1)

	)

674 
	ebŒfs_Üphª_þ—nup_¡©e
 {

675 
	mORPHAN_CLEANUP_STARTED
 = 1,

676 
	mORPHAN_CLEANUP_DONE
 = 2,

680 
	sbŒfs_¡re_hash
 {

681 
li¡_h—d
 
	mhash_li¡
;

682 
wa™_queue_h—d_t
 
	mwa™
;

683 
¥šlock_t
 
	mlock
;

687 
	sbŒfs_¡re_hash_bË
 {

688 
li¡_h—d
 
	m¡re_ÿche
;

689 
¥šlock_t
 
	mÿche_lock
;

690 
	mÿche_size
;

691 
bŒfs_¡re_hash
 
	mbË
[];

694 
	#BTRFS_STRIPE_HASH_TABLE_BITS
 11

	)

696 
bŒfs_š™_async_»þaim_wÜk
(
wÜk_¡ruù
 *
wÜk
);

699 
	g»loc_cÚŒÞ
;

700 
	gbŒfs_deviû
;

701 
	gbŒfs_fs_deviûs
;

702 
	gbŒfs_b®ªû_cÚŒÞ
;

703 
	gbŒfs_d–ayed_roÙ
;

705 
	#BTRFS_FS_BARRIER
 1

	)

706 
	#BTRFS_FS_CLOSING_START
 2

	)

707 
	#BTRFS_FS_CLOSING_DONE
 3

	)

708 
	#BTRFS_FS_LOG_RECOVERING
 4

	)

709 
	#BTRFS_FS_OPEN
 5

	)

710 
	#BTRFS_FS_QUOTA_ENABLED
 6

	)

711 
	#BTRFS_FS_QUOTA_ENABLING
 7

	)

712 
	#BTRFS_FS_UPDATE_UUID_TREE_GEN
 9

	)

713 
	#BTRFS_FS_CREATING_FREE_SPACE_TREE
 10

	)

714 
	#BTRFS_FS_BTREE_ERR
 11

	)

715 
	#BTRFS_FS_LOG1_ERR
 12

	)

716 
	#BTRFS_FS_LOG2_ERR
 13

	)

717 
	#BTRFS_FS_QUOTA_OVERRIDE
 14

	)

719 
	#BTRFS_FS_FROZEN
 15

	)

725 
	#BTRFS_FS_EXCL_OP
 16

	)

727 
	sbŒfs_fs_šfo
 {

728 
u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

729 
u8
 
	mchunk_Œ“_uuid
[
BTRFS_UUID_SIZE
];

730 
	mæags
;

731 
bŒfs_roÙ
 *
	mex‹Á_roÙ
;

732 
bŒfs_roÙ
 *
	mŒ“_roÙ
;

733 
bŒfs_roÙ
 *
	mchunk_roÙ
;

734 
bŒfs_roÙ
 *
	mdev_roÙ
;

735 
bŒfs_roÙ
 *
	mfs_roÙ
;

736 
bŒfs_roÙ
 *
	mcsum_roÙ
;

737 
bŒfs_roÙ
 *
	mquÙa_roÙ
;

738 
bŒfs_roÙ
 *
	muuid_roÙ
;

739 
bŒfs_roÙ
 *
	mä“_¥aû_roÙ
;

742 
bŒfs_roÙ
 *
	mlog_roÙ_Œ“
;

744 
¥šlock_t
 
	mfs_roÙs_¿dix_lock
;

745 
¿dix_Œ“_roÙ
 
	mfs_roÙs_¿dix
;

748 
¥šlock_t
 
	mblock_group_ÿche_lock
;

749 
u64
 
	mfœ¡_logiÿl_by‹
;

750 
rb_roÙ
 
	mblock_group_ÿche_Œ“
;

753 
©omic64_t
 
	mä“_chunk_¥aû
;

755 
ex‹Á_io_Œ“
 
	mä“d_ex‹Ás
[2];

756 
ex‹Á_io_Œ“
 *
	mpšÃd_ex‹Ás
;

759 
bŒfs_m­pšg_Œ“
 
	mm­pšg_Œ“
;

765 
bŒfs_block_rsv
 
	mglob®_block_rsv
;

767 
bŒfs_block_rsv
 
	md–®loc_block_rsv
;

769 
bŒfs_block_rsv
 
	mŒªs_block_rsv
;

771 
bŒfs_block_rsv
 
	mchunk_block_rsv
;

773 
bŒfs_block_rsv
 
	md–ayed_block_rsv
;

775 
bŒfs_block_rsv
 
	mem±y_block_rsv
;

777 
u64
 
	mg’”©iÚ
;

778 
u64
 
	mÏ¡_Œªs_comm™‹d
;

779 
u64
 
	mavg_d–ayed_»f_ruÁime
;

785 
u64
 
	mÏ¡_Œªs_log_fuÎ_comm™
;

786 
	mmouÁ_Ýt
;

791 
	m³ndšg_chªges
;

792 
	mcom´ess_ty³
:4;

793 
	mcomm™_š‹rv®
;

800 
u64
 
	mmax_šlše
;

802 
bŒfs_Œª§ùiÚ
 *
	mruÂšg_Œª§ùiÚ
;

803 
wa™_queue_h—d_t
 
	mŒª§ùiÚ_thrÙŽe
;

804 
wa™_queue_h—d_t
 
	mŒª§ùiÚ_wa™
;

805 
wa™_queue_h—d_t
 
	mŒª§ùiÚ_blocked_wa™
;

806 
wa™_queue_h—d_t
 
	masync_subm™_wa™
;

818 
¥šlock_t
 
	msu³r_lock
;

819 
bŒfs_su³r_block
 *
	msu³r_cÝy
;

820 
bŒfs_su³r_block
 *
	msu³r_fÜ_comm™
;

821 
su³r_block
 *
	msb
;

822 
šode
 *
	mbŒ“_šode
;

823 
mu‹x
 
	mŒ“_log_mu‹x
;

824 
mu‹x
 
	mŒª§ùiÚ_kth»ad_mu‹x
;

825 
mu‹x
 
	mþ—Ãr_mu‹x
;

826 
mu‹x
 
	mchunk_mu‹x
;

827 
mu‹x
 
	mvÞume_mu‹x
;

833 
mu‹x
 
	mro_block_group_mu‹x
;

839 
bŒfs_¡re_hash_bË
 *
	m¡re_hash_bË
;

848 
mu‹x
 
	mÜd”ed_Ý”©iÚs_mu‹x
;

850 
rw_£m­hÜe
 
	mcomm™_roÙ_£m
;

852 
rw_£m­hÜe
 
	mþ—nup_wÜk_£m
;

854 
rw_£m­hÜe
 
	msubvÞ_£m
;

855 
¤cu_¡ruù
 
	msubvÞ_¤cu
;

857 
¥šlock_t
 
	mŒªs_lock
;

862 
mu‹x
 
	m»loc_mu‹x
;

864 
li¡_h—d
 
	mŒªs_li¡
;

865 
li¡_h—d
 
	md—d_roÙs
;

866 
li¡_h—d
 
	mÿchšg_block_groups
;

868 
¥šlock_t
 
	md–ayed_ut_lock
;

869 
li¡_h—d
 
	md–ayed_uts
;

870 
mu‹x
 
	mþ—Ãr_d–ayed_ut_mu‹x
;

873 
¥šlock_t
 
	mŒ“_mod_£q_lock
;

874 
©omic64_t
 
	mŒ“_mod_£q
;

875 
li¡_h—d
 
	mŒ“_mod_£q_li¡
;

878 
rwlock_t
 
	mŒ“_mod_log_lock
;

879 
rb_roÙ
 
	mŒ“_mod_log
;

881 
©omic_t
 
	mÄ_async_subm™s
;

882 
©omic_t
 
	masync_subm™_d¿ššg
;

883 
©omic_t
 
	mÄ_async_bios
;

884 
©omic_t
 
	masync_d–®loc_·ges
;

885 
©omic_t
 
	mÝ’_ioùl_Œªs
;

890 
¥šlock_t
 
	mÜd”ed_roÙ_lock
;

899 
li¡_h—d
 
	mÜd”ed_roÙs
;

901 
mu‹x
 
	md–®loc_roÙ_mu‹x
;

902 
¥šlock_t
 
	md–®loc_roÙ_lock
;

904 
li¡_h—d
 
	md–®loc_roÙs
;

916 
bŒfs_wÜkqueue
 *
	mwÜk”s
;

917 
bŒfs_wÜkqueue
 *
	md–®loc_wÜk”s
;

918 
bŒfs_wÜkqueue
 *
	mæush_wÜk”s
;

919 
bŒfs_wÜkqueue
 *
	m’dio_wÜk”s
;

920 
bŒfs_wÜkqueue
 *
	m’dio_m‘a_wÜk”s
;

921 
bŒfs_wÜkqueue
 *
	m’dio_¿id56_wÜk”s
;

922 
bŒfs_wÜkqueue
 *
	m’dio_»·œ_wÜk”s
;

923 
bŒfs_wÜkqueue
 *
	mrmw_wÜk”s
;

924 
bŒfs_wÜkqueue
 *
	m’dio_m‘a_wr™e_wÜk”s
;

925 
bŒfs_wÜkqueue
 *
	m’dio_wr™e_wÜk”s
;

926 
bŒfs_wÜkqueue
 *
	m’dio_ä“¥aû_wÜk”
;

927 
bŒfs_wÜkqueue
 *
	msubm™_wÜk”s
;

928 
bŒfs_wÜkqueue
 *
	mÿchšg_wÜk”s
;

929 
bŒfs_wÜkqueue
 *
	m»adah—d_wÜk”s
;

936 
bŒfs_wÜkqueue
 *
	mfixup_wÜk”s
;

937 
bŒfs_wÜkqueue
 *
	md–ayed_wÜk”s
;

940 
bŒfs_wÜkqueue
 *
	mex‹Á_wÜk”s
;

941 
sk_¡ruù
 *
	mŒª§ùiÚ_kth»ad
;

942 
sk_¡ruù
 *
	mþ—Ãr_kth»ad
;

943 
	mth»ad_poÞ_size
;

945 
kobjeù
 *
	m¥aû_šfo_kobj
;

947 
u64
 
	mtÙ®_pšÃd
;

950 
³rýu_couÁ”
 
	mdœty_m‘ad©a_by‹s
;

951 
³rýu_couÁ”
 
	md–®loc_by‹s
;

952 
s32
 
	mdœty_m‘ad©a_b©ch
;

953 
s32
 
	md–®loc_b©ch
;

955 
li¡_h—d
 
	mdœty_cowÚly_roÙs
;

957 
bŒfs_fs_deviûs
 *
	mfs_deviûs
;

964 
li¡_h—d
 
	m¥aû_šfo
;

966 
bŒfs_¥aû_šfo
 *
	md©a_sšfo
;

968 
»loc_cÚŒÞ
 *
	m»loc_ùl
;

971 
bŒfs_ä“_þu¡”
 
	md©a_®loc_þu¡”
;

974 
bŒfs_ä“_þu¡”
 
	mm‘a_®loc_þu¡”
;

977 
¥šlock_t
 
	mdeäag_šodes_lock
;

978 
rb_roÙ
 
	mdeäag_šodes
;

979 
©omic_t
 
	mdeäag_ruÂšg
;

982 
£qlock_t
 
	m´ofžes_lock
;

988 
u64
 
	mavaž_d©a_®loc_b™s
;

989 
u64
 
	mavaž_m‘ad©a_®loc_b™s
;

990 
u64
 
	mavaž_sy¡em_®loc_b™s
;

993 
¥šlock_t
 
	mb®ªû_lock
;

994 
mu‹x
 
	mb®ªû_mu‹x
;

995 
©omic_t
 
	mb®ªû_ruÂšg
;

996 
©omic_t
 
	mb®ªû_·u£_»q
;

997 
©omic_t
 
	mb®ªû_ÿnûl_»q
;

998 
bŒfs_b®ªû_cÚŒÞ
 *
	mb®ªû_ùl
;

999 
wa™_queue_h—d_t
 
	mb®ªû_wa™_q
;

1001 
	md©a_chunk_®loÿtiÚs
;

1002 
	mm‘ad©a_¿tio
;

1004 *
	mbdev_hÞd”
;

1007 
mu‹x
 
	msüub_lock
;

1008 
©omic_t
 
	msüubs_ruÂšg
;

1009 
©omic_t
 
	msüub_·u£_»q
;

1010 
©omic_t
 
	msüubs_·u£d
;

1011 
©omic_t
 
	msüub_ÿnûl_»q
;

1012 
wa™_queue_h—d_t
 
	msüub_·u£_wa™
;

1013 
	msüub_wÜk”s_»fút
;

1014 
bŒfs_wÜkqueue
 *
	msüub_wÜk”s
;

1015 
bŒfs_wÜkqueue
 *
	msüub_wr_com¶‘iÚ_wÜk”s
;

1016 
bŒfs_wÜkqueue
 *
	msüub_nocow_wÜk”s
;

1017 
bŒfs_wÜkqueue
 *
	msüub_·r™y_wÜk”s
;

1019 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


1020 
u32
 
	mcheck_š‹gr™y_´št_mask
;

1023 
u64
 
	mqgroup_æags
;

1026 
rb_roÙ
 
	mqgroup_Œ“
;

1027 
rb_roÙ
 
	mqgroup_Ý_Œ“
;

1028 
¥šlock_t
 
	mqgroup_lock
;

1029 
¥šlock_t
 
	mqgroup_Ý_lock
;

1030 
©omic_t
 
	mqgroup_Ý_£q
;

1036 
uli¡
 *
	mqgroup_uli¡
;

1039 
mu‹x
 
	mqgroup_ioùl_lock
;

1042 
li¡_h—d
 
	mdœty_qgroups
;

1045 
u64
 
	mqgroup_£q
;

1048 
mu‹x
 
	mqgroup_»sÿn_lock
;

1049 
bŒfs_key
 
	mqgroup_»sÿn_´og»ss
;

1050 
bŒfs_wÜkqueue
 *
	mqgroup_»sÿn_wÜk”s
;

1051 
com¶‘iÚ
 
	mqgroup_»sÿn_com¶‘iÚ
;

1052 
bŒfs_wÜk
 
	mqgroup_»sÿn_wÜk
;

1053 
boÞ
 
	mqgroup_»sÿn_ruÂšg
;

1056 
	mfs_¡©e
;

1058 
bŒfs_d–ayed_roÙ
 *
	md–ayed_roÙ
;

1061 
¥šlock_t
 
	m»ada_lock
;

1062 
¿dix_Œ“_roÙ
 
	m»ada_Œ“
;

1065 
©omic_t
 
	m»ada_wÜks_út
;

1068 
¥šlock_t
 
	mbufãr_lock
;

1069 
¿dix_Œ“_roÙ
 
	mbufãr_¿dix
;

1072 
	mbackup_roÙ_šdex
;

1075 
bŒfs_dev_»¶aû
 
	mdev_»¶aû
;

1077 
³rýu_couÁ”
 
	mbio_couÁ”
;

1078 
wa™_queue_h—d_t
 
	m»¶aû_wa™
;

1080 
£m­hÜe
 
	muuid_Œ“_»sÿn_£m
;

1083 
wÜk_¡ruù
 
	masync_»þaim_wÜk
;

1085 
¥šlock_t
 
	munu£d_bgs_lock
;

1086 
li¡_h—d
 
	munu£d_bgs
;

1087 
mu‹x
 
	munu£d_bg_uÅš_mu‹x
;

1088 
mu‹x
 
	md–‘e_unu£d_bgs_mu‹x
;

1091 
£cur™y_mÁ_Ýts
 
	m£cur™y_Ýts
;

1097 
li¡_h—d
 
	mpšÃd_chunks
;

1100 
u32
 
	mnodesize
;

1101 
u32
 
	m£ùÜsize
;

1102 
u32
 
	m¡resize
;

1105 
šlše
 
bŒfs_fs_šfo
 *
	$bŒfs_sb
(
su³r_block
 *
sb
)

1107  
sb
->
s_fs_šfo
;

1108 
	}
}

1110 
	sbŒfs_subvÞume_wr™”s
 {

1111 
³rýu_couÁ”
 
	mcouÁ”
;

1112 
wa™_queue_h—d_t
 
	mwa™
;

1125 
	#BTRFS_ROOT_IN_TRANS_SETUP
 0

	)

1126 
	#BTRFS_ROOT_REF_COWS
 1

	)

1127 
	#BTRFS_ROOT_TRACK_DIRTY
 2

	)

1128 
	#BTRFS_ROOT_IN_RADIX
 3

	)

1129 
	#BTRFS_ROOT_ORPHAN_ITEM_INSERTED
 4

	)

1130 
	#BTRFS_ROOT_DEFRAG_RUNNING
 5

	)

1131 
	#BTRFS_ROOT_FORCE_COW
 6

	)

1132 
	#BTRFS_ROOT_MULTI_LOG_TASKS
 7

	)

1133 
	#BTRFS_ROOT_DIRTY
 8

	)

1139 
	sbŒfs_roÙ
 {

1140 
ex‹Á_bufãr
 *
	mnode
;

1142 
ex‹Á_bufãr
 *
	mcomm™_roÙ
;

1143 
bŒfs_roÙ
 *
	mlog_roÙ
;

1144 
bŒfs_roÙ
 *
	m»loc_roÙ
;

1146 
	m¡©e
;

1147 
bŒfs_roÙ_™em
 
	mroÙ_™em
;

1148 
bŒfs_key
 
	mroÙ_key
;

1149 
bŒfs_fs_šfo
 *
	mfs_šfo
;

1150 
ex‹Á_io_Œ“
 
	mdœty_log_·ges
;

1152 
mu‹x
 
	mobjeùid_mu‹x
;

1154 
¥šlock_t
 
	maccouÁšg_lock
;

1155 
bŒfs_block_rsv
 *
	mblock_rsv
;

1158 
bŒfs_ä“_¥aû_ùl
 *
	mä“_šo_ùl
;

1159 
bŒfs_ÿchšg_ty³
 
	mšo_ÿche_¡©e
;

1160 
¥šlock_t
 
	mšo_ÿche_lock
;

1161 
wa™_queue_h—d_t
 
	mšo_ÿche_wa™
;

1162 
bŒfs_ä“_¥aû_ùl
 *
	mä“_šo_pšÃd
;

1163 
u64
 
	mšo_ÿche_´og»ss
;

1164 
šode
 *
	mšo_ÿche_šode
;

1166 
mu‹x
 
	mlog_mu‹x
;

1167 
wa™_queue_h—d_t
 
	mlog_wr™”_wa™
;

1168 
wa™_queue_h—d_t
 
	mlog_comm™_wa™
[2];

1169 
li¡_h—d
 
	mlog_ùxs
[2];

1170 
©omic_t
 
	mlog_wr™”s
;

1171 
©omic_t
 
	mlog_comm™
[2];

1172 
©omic_t
 
	mlog_b©ch
;

1173 
	mlog_Œªsid
;

1175 
	mlog_Œªsid_comm™‹d
;

1177 
	mÏ¡_log_comm™
;

1178 
pid_t
 
	mlog_¡¬t_pid
;

1180 
u64
 
	mobjeùid
;

1181 
u64
 
	mÏ¡_Œªs
;

1183 
u32
 
	mty³
;

1185 
u64
 
	mhighe¡_objeùid
;

1187 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


1189 
u64
 
	m®loc_by‹Ä
;

1192 
u64
 
	mdeäag_Œªs_¡¬t
;

1193 
bŒfs_key
 
	mdeäag_´og»ss
;

1194 
bŒfs_key
 
	mdeäag_max
;

1195 *
	mÇme
;

1198 
li¡_h—d
 
	mdœty_li¡
;

1200 
li¡_h—d
 
	mroÙ_li¡
;

1202 
¥šlock_t
 
	mlog_ex‹Ás_lock
[2];

1203 
li¡_h—d
 
	mlogged_li¡
[2];

1205 
¥šlock_t
 
	mÜphª_lock
;

1206 
©omic_t
 
	mÜphª_šodes
;

1207 
bŒfs_block_rsv
 *
	mÜphª_block_rsv
;

1208 
	mÜphª_þ—nup_¡©e
;

1210 
¥šlock_t
 
	mšode_lock
;

1212 
rb_roÙ
 
	mšode_Œ“
;

1218 
¿dix_Œ“_roÙ
 
	md–ayed_nodes_Œ“
;

1223 
dev_t
 
	mªÚ_dev
;

1225 
¥šlock_t
 
	mroÙ_™em_lock
;

1226 
»fcouÁ_t
 
	m»fs
;

1228 
mu‹x
 
	md–®loc_mu‹x
;

1229 
¥šlock_t
 
	md–®loc_lock
;

1235 
li¡_h—d
 
	md–®loc_šodes
;

1236 
li¡_h—d
 
	md–®loc_roÙ
;

1237 
u64
 
	mÄ_d–®loc_šodes
;

1239 
mu‹x
 
	mÜd”ed_ex‹Á_mu‹x
;

1244 
¥šlock_t
 
	mÜd”ed_ex‹Á_lock
;

1251 
li¡_h—d
 
	mÜd”ed_ex‹Ás
;

1252 
li¡_h—d
 
	mÜd”ed_roÙ
;

1253 
u64
 
	mÄ_Üd”ed_ex‹Ás
;

1259 
	m£nd_š_´og»ss
;

1260 
bŒfs_subvÞume_wr™”s
 *
	msubv_wr™”s
;

1261 
©omic_t
 
	mwžl_be_¢­shÙ‹d
;

1264 
©omic64_t
 
	mqgroup_m‘a_rsv
;

1267 
	sbŒfs_fže_´iv©e
 {

1268 
bŒfs_Œªs_hªdË
 *
	mŒªs
;

1269 *
	mfžldœ_buf
;

1272 
šlše
 
u32
 
	$bŒfs_šode_£ùÜsize
(cÚ¡ 
šode
 *inode)

1274  
	`bŒfs_sb
(
šode
->
i_sb
)->
£ùÜsize
;

1275 
	}
}

1277 
šlše
 
u32
 
	$BTRFS_LEAF_DATA_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

1280  
šfo
->
nodesize
 - (
bŒfs_h—d”
);

1281 
	}
}

1283 
	#BTRFS_LEAF_DATA_OFFSET
 
	`off£tof
(
bŒfs_Ëaf
, 
™ems
)

	)

1285 
šlše
 
u32
 
	$BTRFS_MAX_ITEM_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

1287  
	`BTRFS_LEAF_DATA_SIZE
(
šfo
è- (
bŒfs_™em
);

1288 
	}
}

1290 
šlše
 
u32
 
	$BTRFS_NODEPTRS_PER_BLOCK
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

1292  
	`BTRFS_LEAF_DATA_SIZE
(
šfo
è/ (
bŒfs_key_±r
);

1293 
	}
}

1295 
	#BTRFS_FILE_EXTENT_INLINE_DATA_START
 \

1296 (
	`off£tof
(
bŒfs_fže_ex‹Á_™em
, 
disk_by‹Ä
))

	)

1297 
šlše
 
u32
 
	$BTRFS_MAX_INLINE_DATA_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

1299  
	`BTRFS_MAX_ITEM_SIZE
(
šfo
) -

1300 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

1301 
	}
}

1303 
šlše
 
u32
 
	$BTRFS_MAX_XATTR_SIZE
(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)

1305  
	`BTRFS_MAX_ITEM_SIZE
(
šfo
è- (
bŒfs_dœ_™em
);

1306 
	}
}

1313 
	#BTRFS_MOUNT_NODATASUM
 (1 << 0)

	)

1314 
	#BTRFS_MOUNT_NODATACOW
 (1 << 1)

	)

1315 
	#BTRFS_MOUNT_NOBARRIER
 (1 << 2)

	)

1316 
	#BTRFS_MOUNT_SSD
 (1 << 3)

	)

1317 
	#BTRFS_MOUNT_DEGRADED
 (1 << 4)

	)

1318 
	#BTRFS_MOUNT_COMPRESS
 (1 << 5)

	)

1319 
	#BTRFS_MOUNT_NOTREELOG
 (1 << 6)

	)

1320 
	#BTRFS_MOUNT_FLUSHONCOMMIT
 (1 << 7)

	)

1321 
	#BTRFS_MOUNT_SSD_SPREAD
 (1 << 8)

	)

1322 
	#BTRFS_MOUNT_NOSSD
 (1 << 9)

	)

1323 
	#BTRFS_MOUNT_DISCARD
 (1 << 10)

	)

1324 
	#BTRFS_MOUNT_FORCE_COMPRESS
 (1 << 11)

	)

1325 
	#BTRFS_MOUNT_SPACE_CACHE
 (1 << 12)

	)

1326 
	#BTRFS_MOUNT_CLEAR_CACHE
 (1 << 13)

	)

1327 
	#BTRFS_MOUNT_USER_SUBVOL_RM_ALLOWED
 (1 << 14)

	)

1328 
	#BTRFS_MOUNT_ENOSPC_DEBUG
 (1 << 15)

	)

1329 
	#BTRFS_MOUNT_AUTO_DEFRAG
 (1 << 16)

	)

1330 
	#BTRFS_MOUNT_INODE_MAP_CACHE
 (1 << 17)

	)

1331 
	#BTRFS_MOUNT_USEBACKUPROOT
 (1 << 18)

	)

1332 
	#BTRFS_MOUNT_SKIP_BALANCE
 (1 << 19)

	)

1333 
	#BTRFS_MOUNT_CHECK_INTEGRITY
 (1 << 20)

	)

1334 
	#BTRFS_MOUNT_CHECK_INTEGRITY_INCLUDING_EXTENT_DATA
 (1 << 21)

	)

1335 
	#BTRFS_MOUNT_PANIC_ON_FATAL_ERROR
 (1 << 22)

	)

1336 
	#BTRFS_MOUNT_RESCAN_UUID_TREE
 (1 << 23)

	)

1337 
	#BTRFS_MOUNT_FRAGMENT_DATA
 (1 << 24)

	)

1338 
	#BTRFS_MOUNT_FRAGMENT_METADATA
 (1 << 25)

	)

1339 
	#BTRFS_MOUNT_FREE_SPACE_TREE
 (1 << 26)

	)

1340 
	#BTRFS_MOUNT_NOLOGREPLAY
 (1 << 27)

	)

1342 
	#BTRFS_DEFAULT_COMMIT_INTERVAL
 (30)

	)

1343 
	#BTRFS_DEFAULT_MAX_INLINE
 (2048)

	)

1345 
	#bŒfs_þ—r_Ýt
(
o
, 
Ýt
è((oè&ð~
BTRFS_MOUNT_
##Ýt)

	)

1346 
	#bŒfs_£t_Ýt
(
o
, 
Ýt
è((oè|ð
BTRFS_MOUNT_
##Ýt)

	)

1347 
	#bŒfs_¿w_‹¡_Ýt
(
o
, 
Ýt
è((oè& 
BTRFS_MOUNT_
##Ýt)

	)

1348 
	#bŒfs_‹¡_Ýt
(
fs_šfo
, 
Ýt
è((fs_šfo)->
mouÁ_Ýt
 & \

1349 
BTRFS_MOUNT_
##
Ýt
)

	)

1351 
	#bŒfs_£t_ªd_šfo
(
fs_šfo
, 
Ýt
, 
fmt
, 
¬gs
...) \

1353 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
Ýt
)) \

1354 
	`bŒfs_šfo
(
fs_šfo
, 
fmt
, ##
¬gs
); \

1355 
	`bŒfs_£t_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
Ýt
); \

1356 }

	)

1358 
	#bŒfs_þ—r_ªd_šfo
(
fs_šfo
, 
Ýt
, 
fmt
, 
¬gs
...) \

1360 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
Ýt
)) \

1361 
	`bŒfs_šfo
(
fs_šfo
, 
fmt
, ##
¬gs
); \

1362 
	`bŒfs_þ—r_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
Ýt
); \

1363 }

	)

1365 #ifdeà
CONFIG_BTRFS_DEBUG


1366 
šlše
 

1367 
	$bŒfs_should_äagm’t_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
)

1369 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

1371  (
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FRAGMENT_METADATA
) &&

1372 
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) ||

1373 (
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FRAGMENT_DATA
) &&

1374 
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
);

1375 
	}
}

1386 
	#BTRFS_PENDING_SET_INODE_MAP_CACHE
 (0)

	)

1387 
	#BTRFS_PENDING_CLEAR_INODE_MAP_CACHE
 (1)

	)

1388 
	#BTRFS_PENDING_COMMIT
 (2)

	)

1390 
	#bŒfs_‹¡_³ndšg
(
šfo
, 
Ýt
) \

1391 
	`‹¡_b™
(
BTRFS_PENDING_
##
Ýt
, &(
šfo
)->
³ndšg_chªges
)

	)

1392 
	#bŒfs_£t_³ndšg
(
šfo
, 
Ýt
) \

1393 
	`£t_b™
(
BTRFS_PENDING_
##
Ýt
, &(
šfo
)->
³ndšg_chªges
)

	)

1394 
	#bŒfs_þ—r_³ndšg
(
šfo
, 
Ýt
) \

1395 
	`þ—r_b™
(
BTRFS_PENDING_
##
Ýt
, &(
šfo
)->
³ndšg_chªges
)

	)

1403 
	#bŒfs_£t_³ndšg_ªd_šfo
(
šfo
, 
Ýt
, 
fmt
, 
¬gs
...) \

1405 ià(!
	`bŒfs_¿w_‹¡_Ýt
((
šfo
)->
mouÁ_Ýt
, 
Ýt
)) { \

1406 
	`bŒfs_šfo
((
šfo
), 
fmt
, ##
¬gs
); \

1407 
	`bŒfs_£t_³ndšg
((
šfo
), 
SET_
##
Ýt
); \

1408 
	`bŒfs_þ—r_³ndšg
((
šfo
), 
CLEAR_
##
Ýt
); \

1410 } 0)

	)

1412 
	#bŒfs_þ—r_³ndšg_ªd_šfo
(
šfo
, 
Ýt
, 
fmt
, 
¬gs
...) \

1414 ià(
	`bŒfs_¿w_‹¡_Ýt
((
šfo
)->
mouÁ_Ýt
, 
Ýt
)) { \

1415 
	`bŒfs_šfo
((
šfo
), 
fmt
, ##
¬gs
); \

1416 
	`bŒfs_£t_³ndšg
((
šfo
), 
CLEAR_
##
Ýt
); \

1417 
	`bŒfs_þ—r_³ndšg
((
šfo
), 
SET_
##
Ýt
); \

1419 } 0)

	)

1424 
	#BTRFS_INODE_NODATASUM
 (1 << 0)

	)

1425 
	#BTRFS_INODE_NODATACOW
 (1 << 1)

	)

1426 
	#BTRFS_INODE_READONLY
 (1 << 2)

	)

1427 
	#BTRFS_INODE_NOCOMPRESS
 (1 << 3)

	)

1428 
	#BTRFS_INODE_PREALLOC
 (1 << 4)

	)

1429 
	#BTRFS_INODE_SYNC
 (1 << 5)

	)

1430 
	#BTRFS_INODE_IMMUTABLE
 (1 << 6)

	)

1431 
	#BTRFS_INODE_APPEND
 (1 << 7)

	)

1432 
	#BTRFS_INODE_NODUMP
 (1 << 8)

	)

1433 
	#BTRFS_INODE_NOATIME
 (1 << 9)

	)

1434 
	#BTRFS_INODE_DIRSYNC
 (1 << 10)

	)

1435 
	#BTRFS_INODE_COMPRESS
 (1 << 11)

	)

1437 
	#BTRFS_INODE_ROOT_ITEM_INIT
 (1 << 31)

	)

1439 
	sbŒfs_m­_tok’
 {

1440 cÚ¡ 
ex‹Á_bufãr
 *
	meb
;

1441 *
	mkaddr
;

1442 
	moff£t
;

1445 
	#BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
by‹s
) \

1446 ((
by‹s
è>> (
fs_šfo
)->
sb
->
s_blocksize_b™s
)

	)

1448 
šlše
 
	$bŒfs_š™_m­_tok’
 (
bŒfs_m­_tok’
 *
tok’
)

1450 
tok’
->
kaddr
 = 
NULL
;

1451 
	}
}

1457 
	#Ë8_to_ýu
(
v
è(v)

	)

1458 
	#ýu_to_Ë8
(
v
è(v)

	)

1459 
	#__Ë8
 
u8


	)

1461 
	#»ad_eb_memb”
(
eb
, 
±r
, 
ty³
, 
memb”
, 
»suÉ
) (\

1462 
	`»ad_ex‹Á_bufãr
(
eb
, (*)(
»suÉ
), \

1463 (()(
±r
)) + \

1464 
	`off£tof
(
ty³
, 
memb”
), \

1465 (((
ty³
 *)0)->
memb”
)))

	)

1467 
	#wr™e_eb_memb”
(
eb
, 
±r
, 
ty³
, 
memb”
, 
»suÉ
) (\

1468 
	`wr™e_ex‹Á_bufãr
(
eb
, (*)(
»suÉ
), \

1469 (()(
±r
)) + \

1470 
	`off£tof
(
ty³
, 
memb”
), \

1471 (((
ty³
 *)0)->
memb”
)))

	)

1473 
	#DECLARE_BTRFS_SETGET_BITS
(
b™s
) \

1474 
u
##
b™s
 
bŒfs_g‘_tok’_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

1475 cÚ¡ *
±r
, 
off
, \

1476 
bŒfs_m­_tok’
 *
tok’
); \

1477 
bŒfs_£t_tok’_
##
	`b™s
(
ex‹Á_bufãr
 *
eb
, cÚ¡ *
±r
, \

1478 
off
, 
u
##
b™s
 
v®
, \

1479 
bŒfs_m­_tok’
 *
tok’
); \

1480 
šlše
 
u
##
b™s
 
bŒfs_g‘_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

1481 cÚ¡ *
±r
, \

1482 
off
) \

1484  
bŒfs_g‘_tok’_
##
	`b™s
(
eb
, 
±r
, 
off
, 
NULL
); \

1486 
šlše
 
bŒfs_£t_
##
	`b™s
(
ex‹Á_bufãr
 *
eb
, *
±r
,\

1487 
off
, 
u
##
b™s
 
v®
) \

1489 
bŒfs_£t_tok’_
##
	`b™s
(
eb
, 
±r
, 
off
, 
v®
, 
NULL
); \

1490 }

	)

1492 
	$DECLARE_BTRFS_SETGET_BITS
(8)

1493 
	$DECLARE_BTRFS_SETGET_BITS
(16)

1494 
	$DECLARE_BTRFS_SETGET_BITS
(32)

1495 
	$DECLARE_BTRFS_SETGET_BITS
(64)

1497 
	#BTRFS_SETGET_FUNCS
(
Çme
, 
ty³
, 
memb”
, 
b™s
) \

1498 
šlše
 
u
##
b™s
 
bŒfs_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

1499 cÚ¡ 
ty³
 *
s
) \

1501 
	`BUILD_BUG_ON
((
u
##
b™s
è!ð(((
ty³
 *)0))->
memb”
); \

1502  
bŒfs_g‘_
##
	`b™s
(
eb
, 
s
, 
	`off£tof
(
ty³
, 
memb”
)); \

1503 
	}
} \

1504 
šlše
 
bŒfs_£t_
##
	`Çme
(
ex‹Á_bufãr
 *
eb
, 
ty³
 *
s
, \

1505 
u
##
b™s
 
v®
) \

1507 
	`BUILD_BUG_ON
((
u
##
b™s
è!ð(((
ty³
 *)0))->
memb”
); \

1508 
bŒfs_£t_
##
	`b™s
(
eb
, 
s
, 
	`off£tof
(
ty³
, 
memb”
), 
v®
); \

1510 
šlše
 
u
##
b™s
 
bŒfs_tok’_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,\

1511 cÚ¡ 
ty³
 *
s
, \

1512 
bŒfs_m­_tok’
 *
tok’
) \

1514 
	`BUILD_BUG_ON
((
u
##
b™s
è!ð(((
ty³
 *)0))->
memb”
); \

1515  
bŒfs_g‘_tok’_
##
	`b™s
(
eb
, 
s
, 
	`off£tof
(
ty³
, 
memb”
), 
tok’
); \

1517 
šlše
 
bŒfs_£t_tok’_
##
	`Çme
(
ex‹Á_bufãr
 *
eb
, \

1518 
ty³
 *
s
, 
u
##
b™s
 
v®
, \

1519 
bŒfs_m­_tok’
 *
tok’
) \

1521 
	`BUILD_BUG_ON
((
u
##
b™s
è!ð(((
ty³
 *)0))->
memb”
); \

1522 
bŒfs_£t_tok’_
##
	`b™s
(
eb
, 
s
, 
	`off£tof
(
ty³
, 
memb”
), 
v®
, 
tok’
); \

1523 }

	)

1525 
	#BTRFS_SETGET_HEADER_FUNCS
(
Çme
, 
ty³
, 
memb”
, 
b™s
) \

1526 
šlše
 
u
##
b™s
 
bŒfs_
##
	`Çme
(cÚ¡ 
ex‹Á_bufãr
 *
eb
) \

1528 cÚ¡ 
ty³
 *
p
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]); \

1529 
u
##
b™s
 
»s
 = 
Ë
##b™s##
	`_to_ýu
(
p
->
memb”
); \

1530  
»s
; \

1532 
šlše
 
bŒfs_£t_
##
	`Çme
(
ex‹Á_bufãr
 *
eb
, \

1533 
u
##
b™s
 
v®
) \

1535 
ty³
 *
p
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]); \

1536 
p
->
memb”
 = 
ýu_to_Ë
##
	`b™s
(
v®
); \

1537 }

	)

1539 
	#BTRFS_SETGET_STACK_FUNCS
(
Çme
, 
ty³
, 
memb”
, 
b™s
) \

1540 
šlše
 
u
##
b™s
 
bŒfs_
##
	`Çme
(cÚ¡ 
ty³
 *
s
) \

1542  
Ë
##
b™s
##
	`_to_ýu
(
s
->
memb”
); \

1544 
šlše
 
bŒfs_£t_
##
	`Çme
(
ty³
 *
s
, 
u
##
b™s
 
v®
) \

1546 
s
->
memb”
 = 
ýu_to_Ë
##
	`b™s
(
v®
); \

1547 }

	)

1550 
šlše
 
u64
 
	$bŒfs_deviû_tÙ®_by‹s
(
ex‹Á_bufãr
 *
eb
,

1551 
bŒfs_dev_™em
 *
s
)

1553 
	`BUILD_BUG_ON
((
u64
) !=

1554 (((
bŒfs_dev_™em
 *)0))->
tÙ®_by‹s
);

1555  
	`bŒfs_g‘_64
(
eb
, 
s
, 
	`off£tof
(
bŒfs_dev_™em
,

1556 
tÙ®_by‹s
));

1557 
	}
}

1558 
šlše
 
	$bŒfs_£t_deviû_tÙ®_by‹s
(
ex‹Á_bufãr
 *
eb
,

1559 
bŒfs_dev_™em
 *
s
,

1560 
u64
 
v®
)

1562 
	`BUILD_BUG_ON
((
u64
) !=

1563 (((
bŒfs_dev_™em
 *)0))->
tÙ®_by‹s
);

1564 
	`WARN_ON
(!
	`IS_ALIGNED
(
v®
, 
eb
->
fs_šfo
->
£ùÜsize
));

1565 
	`bŒfs_£t_64
(
eb
, 
s
, 
	`off£tof
(
bŒfs_dev_™em
, 
tÙ®_by‹s
), 
v®
);

1566 
	}
}

1569 
BTRFS_SETGET_FUNCS
(
deviû_ty³
, 
bŒfs_dev_™em
, 
ty³
, 64);

1570 
BTRFS_SETGET_FUNCS
(
deviû_by‹s_u£d
, 
bŒfs_dev_™em
, 
by‹s_u£d
, 64);

1571 
BTRFS_SETGET_FUNCS
(
deviû_io_®ign
, 
bŒfs_dev_™em
, 
io_®ign
, 32);

1572 
BTRFS_SETGET_FUNCS
(
deviû_io_width
, 
bŒfs_dev_™em
, 
io_width
, 32);

1573 
BTRFS_SETGET_FUNCS
(
deviû_¡¬t_off£t
, 
bŒfs_dev_™em
,

1574 
¡¬t_off£t
, 64);

1575 
BTRFS_SETGET_FUNCS
(
deviû_£ùÜ_size
, 
bŒfs_dev_™em
, 
£ùÜ_size
, 32);

1576 
BTRFS_SETGET_FUNCS
(
deviû_id
, 
bŒfs_dev_™em
, 
devid
, 64);

1577 
BTRFS_SETGET_FUNCS
(
deviû_group
, 
bŒfs_dev_™em
, 
dev_group
, 32);

1578 
BTRFS_SETGET_FUNCS
(
deviû_£ek_¥“d
, 
bŒfs_dev_™em
, 
£ek_¥“d
, 8);

1579 
BTRFS_SETGET_FUNCS
(
deviû_bªdwidth
, 
bŒfs_dev_™em
, 
bªdwidth
, 8);

1580 
BTRFS_SETGET_FUNCS
(
deviû_g’”©iÚ
, 
bŒfs_dev_™em
, 
g’”©iÚ
, 64);

1582 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_ty³
, 
bŒfs_dev_™em
, 
ty³
, 64);

1583 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_tÙ®_by‹s
, 
bŒfs_dev_™em
,

1584 
tÙ®_by‹s
, 64);

1585 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_by‹s_u£d
, 
bŒfs_dev_™em
,

1586 
by‹s_u£d
, 64);

1587 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_io_®ign
, 
bŒfs_dev_™em
,

1588 
io_®ign
, 32);

1589 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_io_width
, 
bŒfs_dev_™em
,

1590 
io_width
, 32);

1591 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_£ùÜ_size
, 
bŒfs_dev_™em
,

1592 
£ùÜ_size
, 32);

1593 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_id
, 
bŒfs_dev_™em
, 
devid
, 64);

1594 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_group
, 
bŒfs_dev_™em
,

1595 
dev_group
, 32);

1596 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_£ek_¥“d
, 
bŒfs_dev_™em
,

1597 
£ek_¥“d
, 8);

1598 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_bªdwidth
, 
bŒfs_dev_™em
,

1599 
bªdwidth
, 8);

1600 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_deviû_g’”©iÚ
, 
bŒfs_dev_™em
,

1601 
g’”©iÚ
, 64);

1603 
šlše
 
	$bŒfs_deviû_uuid
(
bŒfs_dev_™em
 *
d
)

1605  ()
d
 + 
	`off£tof
(
bŒfs_dev_™em
, 
uuid
);

1606 
	}
}

1608 
šlše
 
	$bŒfs_deviû_fsid
(
bŒfs_dev_™em
 *
d
)

1610  ()
d
 + 
	`off£tof
(
bŒfs_dev_™em
, 
fsid
);

1611 
	}
}

1613 
BTRFS_SETGET_FUNCS
(
chunk_Ëngth
, 
bŒfs_chunk
, 
Ëngth
, 64);

1614 
BTRFS_SETGET_FUNCS
(
chunk_owÃr
, 
bŒfs_chunk
, 
owÃr
, 64);

1615 
BTRFS_SETGET_FUNCS
(
chunk_¡re_Ën
, 
bŒfs_chunk
, 
¡re_Ën
, 64);

1616 
BTRFS_SETGET_FUNCS
(
chunk_io_®ign
, 
bŒfs_chunk
, 
io_®ign
, 32);

1617 
BTRFS_SETGET_FUNCS
(
chunk_io_width
, 
bŒfs_chunk
, 
io_width
, 32);

1618 
BTRFS_SETGET_FUNCS
(
chunk_£ùÜ_size
, 
bŒfs_chunk
, 
£ùÜ_size
, 32);

1619 
BTRFS_SETGET_FUNCS
(
chunk_ty³
, 
bŒfs_chunk
, 
ty³
, 64);

1620 
BTRFS_SETGET_FUNCS
(
chunk_num_¡res
, 
bŒfs_chunk
, 
num_¡res
, 16);

1621 
BTRFS_SETGET_FUNCS
(
chunk_sub_¡res
, 
bŒfs_chunk
, 
sub_¡res
, 16);

1622 
BTRFS_SETGET_FUNCS
(
¡re_devid
, 
bŒfs_¡re
, 
devid
, 64);

1623 
BTRFS_SETGET_FUNCS
(
¡re_off£t
, 
bŒfs_¡re
, 
off£t
, 64);

1625 
šlše
 *
	$bŒfs_¡re_dev_uuid
(
bŒfs_¡re
 *
s
)

1627  (*)
s
 + 
	`off£tof
(
bŒfs_¡re
, 
dev_uuid
);

1628 
	}
}

1630 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_Ëngth
, 
bŒfs_chunk
, 
Ëngth
, 64);

1631 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_owÃr
, 
bŒfs_chunk
, 
owÃr
, 64);

1632 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_¡re_Ën
, 
bŒfs_chunk
,

1633 
¡re_Ën
, 64);

1634 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_io_®ign
, 
bŒfs_chunk
,

1635 
io_®ign
, 32);

1636 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_io_width
, 
bŒfs_chunk
,

1637 
io_width
, 32);

1638 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_£ùÜ_size
, 
bŒfs_chunk
,

1639 
£ùÜ_size
, 32);

1640 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_ty³
, 
bŒfs_chunk
, 
ty³
, 64);

1641 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_num_¡res
, 
bŒfs_chunk
,

1642 
num_¡res
, 16);

1643 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_chunk_sub_¡res
, 
bŒfs_chunk
,

1644 
sub_¡res
, 16);

1645 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_¡re_devid
, 
bŒfs_¡re
, 
devid
, 64);

1646 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_¡re_off£t
, 
bŒfs_¡re
, 
off£t
, 64);

1648 
šlše
 
bŒfs_¡re
 *
	$bŒfs_¡re_Ä
(
bŒfs_chunk
 *
c
,

1649 
Ä
)

1651 
off£t
 = ()
c
;

1652 
off£t
 +ð
	`off£tof
(
bŒfs_chunk
, 
¡re
);

1653 
off£t
 +ð
Ä
 * (
bŒfs_¡re
);

1654  (
bŒfs_¡re
 *)
off£t
;

1655 
	}
}

1657 
šlše
 *
	$bŒfs_¡re_dev_uuid_Ä
(
bŒfs_chunk
 *
c
, 
Ä
)

1659  
	`bŒfs_¡re_dev_uuid
(
	`bŒfs_¡re_Ä
(
c
, 
Ä
));

1660 
	}
}

1662 
šlše
 
u64
 
	$bŒfs_¡re_off£t_Ä
(
ex‹Á_bufãr
 *
eb
,

1663 
bŒfs_chunk
 *
c
, 
Ä
)

1665  
	`bŒfs_¡re_off£t
(
eb
, 
	`bŒfs_¡re_Ä
(
c
, 
Ä
));

1666 
	}
}

1668 
šlše
 
u64
 
	$bŒfs_¡re_devid_Ä
(
ex‹Á_bufãr
 *
eb
,

1669 
bŒfs_chunk
 *
c
, 
Ä
)

1671  
	`bŒfs_¡re_devid
(
eb
, 
	`bŒfs_¡re_Ä
(
c
, 
Ä
));

1672 
	}
}

1675 
BTRFS_SETGET_STACK_FUNCS
(
block_group_u£d
, 
bŒfs_block_group_™em
,

1676 
u£d
, 64);

1677 
BTRFS_SETGET_FUNCS
(
disk_block_group_u£d
, 
bŒfs_block_group_™em
,

1678 
u£d
, 64);

1679 
BTRFS_SETGET_STACK_FUNCS
(
block_group_chunk_objeùid
,

1680 
bŒfs_block_group_™em
, 
chunk_objeùid
, 64);

1682 
BTRFS_SETGET_FUNCS
(
disk_block_group_chunk_objeùid
,

1683 
bŒfs_block_group_™em
, 
chunk_objeùid
, 64);

1684 
BTRFS_SETGET_FUNCS
(
disk_block_group_æags
,

1685 
bŒfs_block_group_™em
, 
æags
, 64);

1686 
BTRFS_SETGET_STACK_FUNCS
(
block_group_æags
,

1687 
bŒfs_block_group_™em
, 
æags
, 64);

1690 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_ex‹Á_couÁ
, 
bŒfs_ä“_¥aû_šfo
,

1691 
ex‹Á_couÁ
, 32);

1692 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_æags
, 
bŒfs_ä“_¥aû_šfo
, 
æags
, 32);

1695 
BTRFS_SETGET_FUNCS
(
šode_»f_Çme_Ën
, 
bŒfs_šode_»f
, 
Çme_Ën
, 16);

1696 
BTRFS_SETGET_FUNCS
(
šode_»f_šdex
, 
bŒfs_šode_»f
, 
šdex
, 64);

1699 
BTRFS_SETGET_FUNCS
(
šode_exŒef_·»Á
, 
bŒfs_šode_exŒef
,

1700 
·»Á_objeùid
, 64);

1701 
BTRFS_SETGET_FUNCS
(
šode_exŒef_Çme_Ën
, 
bŒfs_šode_exŒef
,

1702 
Çme_Ën
, 16);

1703 
BTRFS_SETGET_FUNCS
(
šode_exŒef_šdex
, 
bŒfs_šode_exŒef
, 
šdex
, 64);

1706 
BTRFS_SETGET_FUNCS
(
šode_g’”©iÚ
, 
bŒfs_šode_™em
, 
g’”©iÚ
, 64);

1707 
BTRFS_SETGET_FUNCS
(
šode_£qu’û
, 
bŒfs_šode_™em
, 
£qu’û
, 64);

1708 
BTRFS_SETGET_FUNCS
(
šode_Œªsid
, 
bŒfs_šode_™em
, 
Œªsid
, 64);

1709 
BTRFS_SETGET_FUNCS
(
šode_size
, 
bŒfs_šode_™em
, 
size
, 64);

1710 
BTRFS_SETGET_FUNCS
(
šode_nby‹s
, 
bŒfs_šode_™em
, 
nby‹s
, 64);

1711 
BTRFS_SETGET_FUNCS
(
šode_block_group
, 
bŒfs_šode_™em
, 
block_group
, 64);

1712 
BTRFS_SETGET_FUNCS
(
šode_Æšk
, 
bŒfs_šode_™em
, 
Æšk
, 32);

1713 
BTRFS_SETGET_FUNCS
(
šode_uid
, 
bŒfs_šode_™em
, 
uid
, 32);

1714 
BTRFS_SETGET_FUNCS
(
šode_gid
, 
bŒfs_šode_™em
, 
gid
, 32);

1715 
BTRFS_SETGET_FUNCS
(
šode_mode
, 
bŒfs_šode_™em
, 
mode
, 32);

1716 
BTRFS_SETGET_FUNCS
(
šode_rdev
, 
bŒfs_šode_™em
, 
rdev
, 64);

1717 
BTRFS_SETGET_FUNCS
(
šode_æags
, 
bŒfs_šode_™em
, 
æags
, 64);

1718 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_g’”©iÚ
, 
bŒfs_šode_™em
,

1719 
g’”©iÚ
, 64);

1720 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_£qu’û
, 
bŒfs_šode_™em
,

1721 
£qu’û
, 64);

1722 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_Œªsid
, 
bŒfs_šode_™em
,

1723 
Œªsid
, 64);

1724 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_size
, 
bŒfs_šode_™em
, 
size
, 64);

1725 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_nby‹s
, 
bŒfs_šode_™em
,

1726 
nby‹s
, 64);

1727 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_block_group
, 
bŒfs_šode_™em
,

1728 
block_group
, 64);

1729 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_Æšk
, 
bŒfs_šode_™em
, 
Æšk
, 32);

1730 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_uid
, 
bŒfs_šode_™em
, 
uid
, 32);

1731 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_gid
, 
bŒfs_šode_™em
, 
gid
, 32);

1732 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_mode
, 
bŒfs_šode_™em
, 
mode
, 32);

1733 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_rdev
, 
bŒfs_šode_™em
, 
rdev
, 64);

1734 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_šode_æags
, 
bŒfs_šode_™em
, 
æags
, 64);

1735 
BTRFS_SETGET_FUNCS
(
time¥ec_£c
, 
bŒfs_time¥ec
, 
£c
, 64);

1736 
BTRFS_SETGET_FUNCS
(
time¥ec_n£c
, 
bŒfs_time¥ec
, 
n£c
, 32);

1737 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_time¥ec_£c
, 
bŒfs_time¥ec
, 
£c
, 64);

1738 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_time¥ec_n£c
, 
bŒfs_time¥ec
, 
n£c
, 32);

1741 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_chunk_Œ“
, 
bŒfs_dev_ex‹Á
,

1742 
chunk_Œ“
, 64);

1743 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_chunk_objeùid
, 
bŒfs_dev_ex‹Á
,

1744 
chunk_objeùid
, 64);

1745 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_chunk_off£t
, 
bŒfs_dev_ex‹Á
,

1746 
chunk_off£t
, 64);

1747 
BTRFS_SETGET_FUNCS
(
dev_ex‹Á_Ëngth
, 
bŒfs_dev_ex‹Á
, 
Ëngth
, 64);

1749 
šlše
 
	$bŒfs_dev_ex‹Á_chunk_Œ“_uuid
(
bŒfs_dev_ex‹Á
 *
dev
)

1751 
±r
 = 
	`off£tof
(
bŒfs_dev_ex‹Á
, 
chunk_Œ“_uuid
);

1752  ()
dev
 + 
±r
;

1753 
	}
}

1755 
BTRFS_SETGET_FUNCS
(
ex‹Á_»fs
, 
bŒfs_ex‹Á_™em
, 
»fs
, 64);

1756 
BTRFS_SETGET_FUNCS
(
ex‹Á_g’”©iÚ
, 
bŒfs_ex‹Á_™em
,

1757 
g’”©iÚ
, 64);

1758 
BTRFS_SETGET_FUNCS
(
ex‹Á_æags
, 
bŒfs_ex‹Á_™em
, 
æags
, 64);

1760 
BTRFS_SETGET_FUNCS
(
ex‹Á_»fs_v0
, 
bŒfs_ex‹Á_™em_v0
, 
»fs
, 32);

1763 
BTRFS_SETGET_FUNCS
(
Œ“_block_Ëv–
, 
bŒfs_Œ“_block_šfo
, 
Ëv–
, 8);

1765 
šlše
 
	$bŒfs_Œ“_block_key
(
ex‹Á_bufãr
 *
eb
,

1766 
bŒfs_Œ“_block_šfo
 *
™em
,

1767 
bŒfs_disk_key
 *
key
)

1769 
	`»ad_eb_memb”
(
eb
, 
™em
, 
bŒfs_Œ“_block_šfo
, 
key
, key);

1770 
	}
}

1772 
šlše
 
	$bŒfs_£t_Œ“_block_key
(
ex‹Á_bufãr
 *
eb
,

1773 
bŒfs_Œ“_block_šfo
 *
™em
,

1774 
bŒfs_disk_key
 *
key
)

1776 
	`wr™e_eb_memb”
(
eb
, 
™em
, 
bŒfs_Œ“_block_šfo
, 
key
, key);

1777 
	}
}

1779 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_roÙ
, 
bŒfs_ex‹Á_d©a_»f
,

1780 
roÙ
, 64);

1781 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_objeùid
, 
bŒfs_ex‹Á_d©a_»f
,

1782 
objeùid
, 64);

1783 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_off£t
, 
bŒfs_ex‹Á_d©a_»f
,

1784 
off£t
, 64);

1785 
BTRFS_SETGET_FUNCS
(
ex‹Á_d©a_»f_couÁ
, 
bŒfs_ex‹Á_d©a_»f
,

1786 
couÁ
, 32);

1788 
BTRFS_SETGET_FUNCS
(
sh¬ed_d©a_»f_couÁ
, 
bŒfs_sh¬ed_d©a_»f
,

1789 
couÁ
, 32);

1791 
BTRFS_SETGET_FUNCS
(
ex‹Á_šlše_»f_ty³
, 
bŒfs_ex‹Á_šlše_»f
,

1792 
ty³
, 8);

1793 
BTRFS_SETGET_FUNCS
(
ex‹Á_šlše_»f_off£t
, 
bŒfs_ex‹Á_šlše_»f
,

1794 
off£t
, 64);

1796 
šlše
 
u32
 
	$bŒfs_ex‹Á_šlše_»f_size
(
ty³
)

1798 ià(
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

1799 
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
)

1800  (
bŒfs_ex‹Á_šlše_»f
);

1801 ià(
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
)

1802  (
bŒfs_sh¬ed_d©a_»f
) +

1803 (
bŒfs_ex‹Á_šlše_»f
);

1804 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
)

1805  (
bŒfs_ex‹Á_d©a_»f
) +

1806 
	`off£tof
(
bŒfs_ex‹Á_šlše_»f
, 
off£t
);

1808 
	}
}

1810 
BTRFS_SETGET_FUNCS
(
»f_roÙ_v0
, 
bŒfs_ex‹Á_»f_v0
, 
roÙ
, 64);

1811 
BTRFS_SETGET_FUNCS
(
»f_g’”©iÚ_v0
, 
bŒfs_ex‹Á_»f_v0
,

1812 
g’”©iÚ
, 64);

1813 
BTRFS_SETGET_FUNCS
(
»f_objeùid_v0
, 
bŒfs_ex‹Á_»f_v0
, 
objeùid
, 64);

1814 
BTRFS_SETGET_FUNCS
(
»f_couÁ_v0
, 
bŒfs_ex‹Á_»f_v0
, 
couÁ
, 32);

1817 
BTRFS_SETGET_FUNCS
(
key_block±r
, 
bŒfs_key_±r
, 
block±r
, 64);

1818 
BTRFS_SETGET_FUNCS
(
key_g’”©iÚ
, 
bŒfs_key_±r
, 
g’”©iÚ
, 64);

1819 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_key_block±r
, 
bŒfs_key_±r
,

1820 
block±r
, 64);

1821 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_key_g’”©iÚ
, 
bŒfs_key_±r
,

1822 
g’”©iÚ
, 64);

1824 
šlše
 
u64
 
	$bŒfs_node_block±r
(
ex‹Á_bufãr
 *
eb
, 
Ä
)

1826 
±r
;

1827 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

1828 (
bŒfs_key_±r
è* 
Ä
;

1829  
	`bŒfs_key_block±r
(
eb
, (
bŒfs_key_±r
 *)
±r
);

1830 
	}
}

1832 
šlše
 
	$bŒfs_£t_node_block±r
(
ex‹Á_bufãr
 *
eb
,

1833 
Ä
, 
u64
 
v®
)

1835 
±r
;

1836 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

1837 (
bŒfs_key_±r
è* 
Ä
;

1838 
	`bŒfs_£t_key_block±r
(
eb
, (
bŒfs_key_±r
 *)
±r
, 
v®
);

1839 
	}
}

1841 
šlše
 
u64
 
	$bŒfs_node_±r_g’”©iÚ
(
ex‹Á_bufãr
 *
eb
, 
Ä
)

1843 
±r
;

1844 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

1845 (
bŒfs_key_±r
è* 
Ä
;

1846  
	`bŒfs_key_g’”©iÚ
(
eb
, (
bŒfs_key_±r
 *)
±r
);

1847 
	}
}

1849 
šlše
 
	$bŒfs_£t_node_±r_g’”©iÚ
(
ex‹Á_bufãr
 *
eb
,

1850 
Ä
, 
u64
 
v®
)

1852 
±r
;

1853 
±r
 = 
	`off£tof
(
bŒfs_node
, 
±rs
) +

1854 (
bŒfs_key_±r
è* 
Ä
;

1855 
	`bŒfs_£t_key_g’”©iÚ
(
eb
, (
bŒfs_key_±r
 *)
±r
, 
v®
);

1856 
	}
}

1858 
šlše
 
	$bŒfs_node_key_±r_off£t
(
Ä
)

1860  
	`off£tof
(
bŒfs_node
, 
±rs
) +

1861 (
bŒfs_key_±r
è* 
Ä
;

1862 
	}
}

1864 
bŒfs_node_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1865 
bŒfs_disk_key
 *
disk_key
, 
Ä
);

1867 
šlše
 
	$bŒfs_£t_node_key
(
ex‹Á_bufãr
 *
eb
,

1868 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

1870 
±r
;

1871 
±r
 = 
	`bŒfs_node_key_±r_off£t
(
Ä
);

1872 
	`wr™e_eb_memb”
(
eb
, (
bŒfs_key_±r
 *)
±r
,

1873 
bŒfs_key_±r
, 
key
, 
disk_key
);

1874 
	}
}

1877 
BTRFS_SETGET_FUNCS
(
™em_off£t
, 
bŒfs_™em
, 
off£t
, 32);

1878 
BTRFS_SETGET_FUNCS
(
™em_size
, 
bŒfs_™em
, 
size
, 32);

1879 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_™em_off£t
, 
bŒfs_™em
, 
off£t
, 32);

1880 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_™em_size
, 
bŒfs_™em
, 
size
, 32);

1882 
šlše
 
	$bŒfs_™em_Ä_off£t
(
Ä
)

1884  
	`off£tof
(
bŒfs_Ëaf
, 
™ems
) +

1885 (
bŒfs_™em
è* 
Ä
;

1886 
	}
}

1888 
šlše
 
bŒfs_™em
 *
	$bŒfs_™em_Ä
(
Ä
)

1890  (
bŒfs_™em
 *)
	`bŒfs_™em_Ä_off£t
(
Ä
);

1891 
	}
}

1893 
šlše
 
u32
 
	$bŒfs_™em_’d
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1894 
bŒfs_™em
 *
™em
)

1896  
	`bŒfs_™em_off£t
(
eb
, 
™em
è+ 
	`bŒfs_™em_size
(eb, item);

1897 
	}
}

1899 
šlše
 
u32
 
	$bŒfs_™em_’d_Ä
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

1901  
	`bŒfs_™em_’d
(
eb
, 
	`bŒfs_™em_Ä
(
Ä
));

1902 
	}
}

1904 
šlše
 
u32
 
	$bŒfs_™em_off£t_Ä
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

1906  
	`bŒfs_™em_off£t
(
eb
, 
	`bŒfs_™em_Ä
(
Ä
));

1907 
	}
}

1909 
šlše
 
u32
 
	$bŒfs_™em_size_Ä
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
Ä
)

1911  
	`bŒfs_™em_size
(
eb
, 
	`bŒfs_™em_Ä
(
Ä
));

1912 
	}
}

1914 
šlše
 
	$bŒfs_™em_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1915 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

1917 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
Ä
);

1918 
	`»ad_eb_memb”
(
eb
, 
™em
, 
bŒfs_™em
, 
key
, 
disk_key
);

1919 
	}
}

1921 
šlše
 
	$bŒfs_£t_™em_key
(
ex‹Á_bufãr
 *
eb
,

1922 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

1924 
bŒfs_™em
 *
™em
 = 
	`bŒfs_™em_Ä
(
Ä
);

1925 
	`wr™e_eb_memb”
(
eb
, 
™em
, 
bŒfs_™em
, 
key
, 
disk_key
);

1926 
	}
}

1928 
BTRFS_SETGET_FUNCS
(
dœ_log_’d
, 
bŒfs_dœ_log_™em
, 
’d
, 64);

1933 
BTRFS_SETGET_FUNCS
(
roÙ_»f_dœid
, 
bŒfs_roÙ_»f
, 
dœid
, 64);

1934 
BTRFS_SETGET_FUNCS
(
roÙ_»f_£qu’û
, 
bŒfs_roÙ_»f
, 
£qu’û
, 64);

1935 
BTRFS_SETGET_FUNCS
(
roÙ_»f_Çme_Ën
, 
bŒfs_roÙ_»f
, 
Çme_Ën
, 16);

1938 
BTRFS_SETGET_FUNCS
(
dœ_d©a_Ën
, 
bŒfs_dœ_™em
, 
d©a_Ën
, 16);

1939 
BTRFS_SETGET_FUNCS
(
dœ_ty³
, 
bŒfs_dœ_™em
, 
ty³
, 8);

1940 
BTRFS_SETGET_FUNCS
(
dœ_Çme_Ën
, 
bŒfs_dœ_™em
, 
Çme_Ën
, 16);

1941 
BTRFS_SETGET_FUNCS
(
dœ_Œªsid
, 
bŒfs_dœ_™em
, 
Œªsid
, 64);

1942 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_ty³
, 
bŒfs_dœ_™em
, 
ty³
, 8);

1943 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_d©a_Ën
, 
bŒfs_dœ_™em
,

1944 
d©a_Ën
, 16);

1945 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_Çme_Ën
, 
bŒfs_dœ_™em
,

1946 
Çme_Ën
, 16);

1947 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dœ_Œªsid
, 
bŒfs_dœ_™em
,

1948 
Œªsid
, 64);

1950 
šlše
 
	$bŒfs_dœ_™em_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1951 cÚ¡ 
bŒfs_dœ_™em
 *
™em
,

1952 
bŒfs_disk_key
 *
key
)

1954 
	`»ad_eb_memb”
(
eb
, 
™em
, 
bŒfs_dœ_™em
, 
loÿtiÚ
, 
key
);

1955 
	}
}

1957 
šlše
 
	$bŒfs_£t_dœ_™em_key
(
ex‹Á_bufãr
 *
eb
,

1958 
bŒfs_dœ_™em
 *
™em
,

1959 cÚ¡ 
bŒfs_disk_key
 *
key
)

1961 
	`wr™e_eb_memb”
(
eb
, 
™em
, 
bŒfs_dœ_™em
, 
loÿtiÚ
, 
key
);

1962 
	}
}

1964 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_’Œ›s
, 
bŒfs_ä“_¥aû_h—d”
,

1965 
num_’Œ›s
, 64);

1966 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_b™m­s
, 
bŒfs_ä“_¥aû_h—d”
,

1967 
num_b™m­s
, 64);

1968 
BTRFS_SETGET_FUNCS
(
ä“_¥aû_g’”©iÚ
, 
bŒfs_ä“_¥aû_h—d”
,

1969 
g’”©iÚ
, 64);

1971 
šlše
 
	$bŒfs_ä“_¥aû_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1972 cÚ¡ 
bŒfs_ä“_¥aû_h—d”
 *
h
,

1973 
bŒfs_disk_key
 *
key
)

1975 
	`»ad_eb_memb”
(
eb
, 
h
, 
bŒfs_ä“_¥aû_h—d”
, 
loÿtiÚ
, 
key
);

1976 
	}
}

1978 
šlše
 
	$bŒfs_£t_ä“_¥aû_key
(
ex‹Á_bufãr
 *
eb
,

1979 
bŒfs_ä“_¥aû_h—d”
 *
h
,

1980 cÚ¡ 
bŒfs_disk_key
 *
key
)

1982 
	`wr™e_eb_memb”
(
eb
, 
h
, 
bŒfs_ä“_¥aû_h—d”
, 
loÿtiÚ
, 
key
);

1983 
	}
}

1986 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_objeùid
, 
bŒfs_disk_key
,

1987 
objeùid
, 64);

1988 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_off£t
, 
bŒfs_disk_key
, 
off£t
, 64);

1989 
BTRFS_SETGET_STACK_FUNCS
(
disk_key_ty³
, 
bŒfs_disk_key
, 
ty³
, 8);

1991 
šlše
 
	$bŒfs_disk_key_to_ýu
(
bŒfs_key
 *
ýu
,

1992 cÚ¡ 
bŒfs_disk_key
 *
disk
)

1994 
ýu
->
off£t
 = 
	`Ë64_to_ýu
(
disk
->offset);

1995 
ýu
->
ty³
 = 
disk
->type;

1996 
ýu
->
objeùid
 = 
	`Ë64_to_ýu
(
disk
->objectid);

1997 
	}
}

1999 
šlše
 
	$bŒfs_ýu_key_to_disk
(
bŒfs_disk_key
 *
disk
,

2000 cÚ¡ 
bŒfs_key
 *
ýu
)

2002 
disk
->
off£t
 = 
	`ýu_to_Ë64
(
ýu
->offset);

2003 
disk
->
ty³
 = 
ýu
->type;

2004 
disk
->
objeùid
 = 
	`ýu_to_Ë64
(
ýu
->objectid);

2005 
	}
}

2007 
šlše
 
	$bŒfs_node_key_to_ýu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2008 
bŒfs_key
 *
key
, 
Ä
)

2010 
bŒfs_disk_key
 
disk_key
;

2011 
	`bŒfs_node_key
(
eb
, &
disk_key
, 
Ä
);

2012 
	`bŒfs_disk_key_to_ýu
(
key
, &
disk_key
);

2013 
	}
}

2015 
šlše
 
	$bŒfs_™em_key_to_ýu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2016 
bŒfs_key
 *
key
, 
Ä
)

2018 
bŒfs_disk_key
 
disk_key
;

2019 
	`bŒfs_™em_key
(
eb
, &
disk_key
, 
Ä
);

2020 
	`bŒfs_disk_key_to_ýu
(
key
, &
disk_key
);

2021 
	}
}

2023 
šlše
 
	$bŒfs_dœ_™em_key_to_ýu
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2024 cÚ¡ 
bŒfs_dœ_™em
 *
™em
,

2025 
bŒfs_key
 *
key
)

2027 
bŒfs_disk_key
 
disk_key
;

2028 
	`bŒfs_dœ_™em_key
(
eb
, 
™em
, &
disk_key
);

2029 
	`bŒfs_disk_key_to_ýu
(
key
, &
disk_key
);

2030 
	}
}

2032 
šlše
 
u8
 
	$bŒfs_key_ty³
(cÚ¡ 
bŒfs_key
 *
key
)

2034  
key
->
ty³
;

2035 
	}
}

2037 
šlše
 
	$bŒfs_£t_key_ty³
(
bŒfs_key
 *
key
, 
u8
 
v®
)

2039 
key
->
ty³
 = 
v®
;

2040 
	}
}

2043 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_by‹Ä
, 
bŒfs_h—d”
, 
by‹Ä
, 64);

2044 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_g’”©iÚ
, 
bŒfs_h—d”
,

2045 
g’”©iÚ
, 64);

2046 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_owÃr
, 
bŒfs_h—d”
, 
owÃr
, 64);

2047 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_Ä™ems
, 
bŒfs_h—d”
, 
Ä™ems
, 32);

2048 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_æags
, 
bŒfs_h—d”
, 
æags
, 64);

2049 
BTRFS_SETGET_HEADER_FUNCS
(
h—d”_Ëv–
, 
bŒfs_h—d”
, 
Ëv–
, 8);

2050 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_g’”©iÚ
, 
bŒfs_h—d”
,

2051 
g’”©iÚ
, 64);

2052 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_owÃr
, 
bŒfs_h—d”
, 
owÃr
, 64);

2053 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_Ä™ems
, 
bŒfs_h—d”
,

2054 
Ä™ems
, 32);

2055 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_h—d”_by‹Ä
, 
bŒfs_h—d”
, 
by‹Ä
, 64);

2057 
šlše
 
	$bŒfs_h—d”_æag
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, 
u64
 
æag
)

2059  (
	`bŒfs_h—d”_æags
(
eb
è& 
æag
) == flag;

2060 
	}
}

2062 
šlše
 
	$bŒfs_£t_h—d”_æag
(
ex‹Á_bufãr
 *
eb
, 
u64
 
æag
)

2064 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

2065 
	`bŒfs_£t_h—d”_æags
(
eb
, 
æags
 | 
æag
);

2066  (
æags
 & 
æag
) == flag;

2067 
	}
}

2069 
šlše
 
	$bŒfs_þ—r_h—d”_æag
(
ex‹Á_bufãr
 *
eb
, 
u64
 
æag
)

2071 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

2072 
	`bŒfs_£t_h—d”_æags
(
eb
, 
æags
 & ~
æag
);

2073  (
æags
 & 
æag
) == flag;

2074 
	}
}

2076 
šlše
 
	$bŒfs_h—d”_back»f_»v
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

2078 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

2079  
æags
 >> 
BTRFS_BACKREF_REV_SHIFT
;

2080 
	}
}

2082 
šlše
 
	$bŒfs_£t_h—d”_back»f_»v
(
ex‹Á_bufãr
 *
eb
,

2083 
»v
)

2085 
u64
 
æags
 = 
	`bŒfs_h—d”_æags
(
eb
);

2086 
æags
 &ð~
BTRFS_BACKREF_REV_MASK
;

2087 
æags
 |ð(
u64
)
»v
 << 
BTRFS_BACKREF_REV_SHIFT
;

2088 
	`bŒfs_£t_h—d”_æags
(
eb
, 
æags
);

2089 
	}
}

2091 
šlše
 
	$bŒfs_h—d”_fsid
()

2093  
	`off£tof
(
bŒfs_h—d”
, 
fsid
);

2094 
	}
}

2096 
šlše
 
	$bŒfs_h—d”_chunk_Œ“_uuid
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

2098  
	`off£tof
(
bŒfs_h—d”
, 
chunk_Œ“_uuid
);

2099 
	}
}

2101 
šlše
 
	$bŒfs_is_Ëaf
(cÚ¡ 
ex‹Á_bufãr
 *
eb
)

2103  
	`bŒfs_h—d”_Ëv–
(
eb
) == 0;

2104 
	}
}

2107 
BTRFS_SETGET_FUNCS
(
disk_roÙ_g’”©iÚ
, 
bŒfs_roÙ_™em
,

2108 
g’”©iÚ
, 64);

2109 
BTRFS_SETGET_FUNCS
(
disk_roÙ_»fs
, 
bŒfs_roÙ_™em
, 
»fs
, 32);

2110 
BTRFS_SETGET_FUNCS
(
disk_roÙ_by‹Ä
, 
bŒfs_roÙ_™em
, 
by‹Ä
, 64);

2111 
BTRFS_SETGET_FUNCS
(
disk_roÙ_Ëv–
, 
bŒfs_roÙ_™em
, 
Ëv–
, 8);

2113 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_g’”©iÚ
, 
bŒfs_roÙ_™em
,

2114 
g’”©iÚ
, 64);

2115 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_by‹Ä
, 
bŒfs_roÙ_™em
, 
by‹Ä
, 64);

2116 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_Ëv–
, 
bŒfs_roÙ_™em
, 
Ëv–
, 8);

2117 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_dœid
, 
bŒfs_roÙ_™em
,„oot_dirid, 64);

2118 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_»fs
, 
bŒfs_roÙ_™em
, 
»fs
, 32);

2119 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_æags
, 
bŒfs_roÙ_™em
, 
æags
, 64);

2120 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_u£d
, 
bŒfs_roÙ_™em
, 
by‹s_u£d
, 64);

2121 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_lim™
, 
bŒfs_roÙ_™em
, 
by‹_lim™
, 64);

2122 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_Ï¡_¢­shÙ
, 
bŒfs_roÙ_™em
,

2123 
Ï¡_¢­shÙ
, 64);

2124 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_g’”©iÚ_v2
, 
bŒfs_roÙ_™em
,

2125 
g’”©iÚ_v2
, 64);

2126 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_ù¿nsid
, 
bŒfs_roÙ_™em
,

2127 
ù¿nsid
, 64);

2128 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_Ù¿nsid
, 
bŒfs_roÙ_™em
,

2129 
Ù¿nsid
, 64);

2130 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_¡¿nsid
, 
bŒfs_roÙ_™em
,

2131 
¡¿nsid
, 64);

2132 
BTRFS_SETGET_STACK_FUNCS
(
roÙ_¹¿nsid
, 
bŒfs_roÙ_™em
,

2133 
¹¿nsid
, 64);

2135 
šlše
 
boÞ
 
	$bŒfs_roÙ_»adÚly
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

2137  (
roÙ
->
roÙ_™em
.
æags
 & 
	`ýu_to_Ë64
(
BTRFS_ROOT_SUBVOL_RDONLY
)) != 0;

2138 
	}
}

2140 
šlše
 
boÞ
 
	$bŒfs_roÙ_d—d
(cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

2142  (
roÙ
->
roÙ_™em
.
æags
 & 
	`ýu_to_Ë64
(
BTRFS_ROOT_SUBVOL_DEAD
)) != 0;

2143 
	}
}

2146 
BTRFS_SETGET_STACK_FUNCS
(
backup_Œ“_roÙ
, 
bŒfs_roÙ_backup
,

2147 
Œ“_roÙ
, 64);

2148 
BTRFS_SETGET_STACK_FUNCS
(
backup_Œ“_roÙ_g’
, 
bŒfs_roÙ_backup
,

2149 
Œ“_roÙ_g’
, 64);

2150 
BTRFS_SETGET_STACK_FUNCS
(
backup_Œ“_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

2151 
Œ“_roÙ_Ëv–
, 8);

2153 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roÙ
, 
bŒfs_roÙ_backup
,

2154 
chunk_roÙ
, 64);

2155 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roÙ_g’
, 
bŒfs_roÙ_backup
,

2156 
chunk_roÙ_g’
, 64);

2157 
BTRFS_SETGET_STACK_FUNCS
(
backup_chunk_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

2158 
chunk_roÙ_Ëv–
, 8);

2160 
BTRFS_SETGET_STACK_FUNCS
(
backup_ex‹Á_roÙ
, 
bŒfs_roÙ_backup
,

2161 
ex‹Á_roÙ
, 64);

2162 
BTRFS_SETGET_STACK_FUNCS
(
backup_ex‹Á_roÙ_g’
, 
bŒfs_roÙ_backup
,

2163 
ex‹Á_roÙ_g’
, 64);

2164 
BTRFS_SETGET_STACK_FUNCS
(
backup_ex‹Á_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

2165 
ex‹Á_roÙ_Ëv–
, 8);

2167 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roÙ
, 
bŒfs_roÙ_backup
,

2168 
fs_roÙ
, 64);

2169 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roÙ_g’
, 
bŒfs_roÙ_backup
,

2170 
fs_roÙ_g’
, 64);

2171 
BTRFS_SETGET_STACK_FUNCS
(
backup_fs_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

2172 
fs_roÙ_Ëv–
, 8);

2174 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roÙ
, 
bŒfs_roÙ_backup
,

2175 
dev_roÙ
, 64);

2176 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roÙ_g’
, 
bŒfs_roÙ_backup
,

2177 
dev_roÙ_g’
, 64);

2178 
BTRFS_SETGET_STACK_FUNCS
(
backup_dev_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

2179 
dev_roÙ_Ëv–
, 8);

2181 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roÙ
, 
bŒfs_roÙ_backup
,

2182 
csum_roÙ
, 64);

2183 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roÙ_g’
, 
bŒfs_roÙ_backup
,

2184 
csum_roÙ_g’
, 64);

2185 
BTRFS_SETGET_STACK_FUNCS
(
backup_csum_roÙ_Ëv–
, 
bŒfs_roÙ_backup
,

2186 
csum_roÙ_Ëv–
, 8);

2187 
BTRFS_SETGET_STACK_FUNCS
(
backup_tÙ®_by‹s
, 
bŒfs_roÙ_backup
,

2188 
tÙ®_by‹s
, 64);

2189 
BTRFS_SETGET_STACK_FUNCS
(
backup_by‹s_u£d
, 
bŒfs_roÙ_backup
,

2190 
by‹s_u£d
, 64);

2191 
BTRFS_SETGET_STACK_FUNCS
(
backup_num_deviûs
, 
bŒfs_roÙ_backup
,

2192 
num_deviûs
, 64);

2195 
BTRFS_SETGET_FUNCS
(
b®ªû_æags
, 
bŒfs_b®ªû_™em
, 
æags
, 64);

2197 
šlše
 
	$bŒfs_b®ªû_d©a
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2198 cÚ¡ 
bŒfs_b®ªû_™em
 *
bi
,

2199 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

2201 
	`»ad_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
d©a
, 
ba
);

2202 
	}
}

2204 
šlše
 
	$bŒfs_£t_b®ªû_d©a
(
ex‹Á_bufãr
 *
eb
,

2205 
bŒfs_b®ªû_™em
 *
bi
,

2206 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

2208 
	`wr™e_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
d©a
, 
ba
);

2209 
	}
}

2211 
šlše
 
	$bŒfs_b®ªû_m‘a
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2212 cÚ¡ 
bŒfs_b®ªû_™em
 *
bi
,

2213 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

2215 
	`»ad_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
m‘a
, 
ba
);

2216 
	}
}

2218 
šlše
 
	$bŒfs_£t_b®ªû_m‘a
(
ex‹Á_bufãr
 *
eb
,

2219 
bŒfs_b®ªû_™em
 *
bi
,

2220 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

2222 
	`wr™e_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
m‘a
, 
ba
);

2223 
	}
}

2225 
šlše
 
	$bŒfs_b®ªû_sys
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2226 cÚ¡ 
bŒfs_b®ªû_™em
 *
bi
,

2227 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

2229 
	`»ad_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
sys
, 
ba
);

2230 
	}
}

2232 
šlše
 
	$bŒfs_£t_b®ªû_sys
(
ex‹Á_bufãr
 *
eb
,

2233 
bŒfs_b®ªû_™em
 *
bi
,

2234 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
ba
)

2236 
	`wr™e_eb_memb”
(
eb
, 
bi
, 
bŒfs_b®ªû_™em
, 
sys
, 
ba
);

2237 
	}
}

2239 
šlše
 

2240 
	$bŒfs_disk_b®ªû_¬gs_to_ýu
(
bŒfs_b®ªû_¬gs
 *
ýu
,

2241 cÚ¡ 
bŒfs_disk_b®ªû_¬gs
 *
disk
)

2243 
	`mem£t
(
ýu
, 0, (*cpu));

2245 
ýu
->
´ofžes
 = 
	`Ë64_to_ýu
(
disk
->profiles);

2246 
ýu
->
u§ge
 = 
	`Ë64_to_ýu
(
disk
->usage);

2247 
ýu
->
devid
 = 
	`Ë64_to_ýu
(
disk
->devid);

2248 
ýu
->
p¡¬t
 = 
	`Ë64_to_ýu
(
disk
->pstart);

2249 
ýu
->
³nd
 = 
	`Ë64_to_ýu
(
disk
->pend);

2250 
ýu
->
v¡¬t
 = 
	`Ë64_to_ýu
(
disk
->vstart);

2251 
ýu
->
v’d
 = 
	`Ë64_to_ýu
(
disk
->vend);

2252 
ýu
->
rg‘
 = 
	`Ë64_to_ýu
(
disk
->target);

2253 
ýu
->
æags
 = 
	`Ë64_to_ýu
(
disk
->flags);

2254 
ýu
->
lim™
 = 
	`Ë64_to_ýu
(
disk
->limit);

2255 
ýu
->
¡res_mš
 = 
	`Ë32_to_ýu
(
disk
->stripes_min);

2256 
ýu
->
¡res_max
 = 
	`Ë32_to_ýu
(
disk
->stripes_max);

2257 
	}
}

2259 
šlše
 

2260 
	$bŒfs_ýu_b®ªû_¬gs_to_disk
(
bŒfs_disk_b®ªû_¬gs
 *
disk
,

2261 cÚ¡ 
bŒfs_b®ªû_¬gs
 *
ýu
)

2263 
	`mem£t
(
disk
, 0, (*disk));

2265 
disk
->
´ofžes
 = 
	`ýu_to_Ë64
(
ýu
->profiles);

2266 
disk
->
u§ge
 = 
	`ýu_to_Ë64
(
ýu
->usage);

2267 
disk
->
devid
 = 
	`ýu_to_Ë64
(
ýu
->devid);

2268 
disk
->
p¡¬t
 = 
	`ýu_to_Ë64
(
ýu
->pstart);

2269 
disk
->
³nd
 = 
	`ýu_to_Ë64
(
ýu
->pend);

2270 
disk
->
v¡¬t
 = 
	`ýu_to_Ë64
(
ýu
->vstart);

2271 
disk
->
v’d
 = 
	`ýu_to_Ë64
(
ýu
->vend);

2272 
disk
->
rg‘
 = 
	`ýu_to_Ë64
(
ýu
->target);

2273 
disk
->
æags
 = 
	`ýu_to_Ë64
(
ýu
->flags);

2274 
disk
->
lim™
 = 
	`ýu_to_Ë64
(
ýu
->limit);

2275 
disk
->
¡res_mš
 = 
	`ýu_to_Ë32
(
ýu
->stripes_min);

2276 
disk
->
¡res_max
 = 
	`ýu_to_Ë32
(
ýu
->stripes_max);

2277 
	}
}

2280 
BTRFS_SETGET_STACK_FUNCS
(
su³r_by‹Ä
, 
bŒfs_su³r_block
, 
by‹Ä
, 64);

2281 
BTRFS_SETGET_STACK_FUNCS
(
su³r_æags
, 
bŒfs_su³r_block
, 
æags
, 64);

2282 
BTRFS_SETGET_STACK_FUNCS
(
su³r_g’”©iÚ
, 
bŒfs_su³r_block
,

2283 
g’”©iÚ
, 64);

2284 
BTRFS_SETGET_STACK_FUNCS
(
su³r_roÙ
, 
bŒfs_su³r_block
, 
roÙ
, 64);

2285 
BTRFS_SETGET_STACK_FUNCS
(
su³r_sys_¬¿y_size
,

2286 
bŒfs_su³r_block
, 
sys_chunk_¬¿y_size
, 32);

2287 
BTRFS_SETGET_STACK_FUNCS
(
su³r_chunk_roÙ_g’”©iÚ
,

2288 
bŒfs_su³r_block
, 
chunk_roÙ_g’”©iÚ
, 64);

2289 
BTRFS_SETGET_STACK_FUNCS
(
su³r_roÙ_Ëv–
, 
bŒfs_su³r_block
,

2290 
roÙ_Ëv–
, 8);

2291 
BTRFS_SETGET_STACK_FUNCS
(
su³r_chunk_roÙ
, 
bŒfs_su³r_block
,

2292 
chunk_roÙ
, 64);

2293 
BTRFS_SETGET_STACK_FUNCS
(
su³r_chunk_roÙ_Ëv–
, 
bŒfs_su³r_block
,

2294 
chunk_roÙ_Ëv–
, 8);

2295 
BTRFS_SETGET_STACK_FUNCS
(
su³r_log_roÙ
, 
bŒfs_su³r_block
,

2296 
log_roÙ
, 64);

2297 
BTRFS_SETGET_STACK_FUNCS
(
su³r_log_roÙ_Œªsid
, 
bŒfs_su³r_block
,

2298 
log_roÙ_Œªsid
, 64);

2299 
BTRFS_SETGET_STACK_FUNCS
(
su³r_log_roÙ_Ëv–
, 
bŒfs_su³r_block
,

2300 
log_roÙ_Ëv–
, 8);

2301 
BTRFS_SETGET_STACK_FUNCS
(
su³r_tÙ®_by‹s
, 
bŒfs_su³r_block
,

2302 
tÙ®_by‹s
, 64);

2303 
BTRFS_SETGET_STACK_FUNCS
(
su³r_by‹s_u£d
, 
bŒfs_su³r_block
,

2304 
by‹s_u£d
, 64);

2305 
BTRFS_SETGET_STACK_FUNCS
(
su³r_£ùÜsize
, 
bŒfs_su³r_block
,

2306 
£ùÜsize
, 32);

2307 
BTRFS_SETGET_STACK_FUNCS
(
su³r_nodesize
, 
bŒfs_su³r_block
,

2308 
nodesize
, 32);

2309 
BTRFS_SETGET_STACK_FUNCS
(
su³r_¡resize
, 
bŒfs_su³r_block
,

2310 
¡resize
, 32);

2311 
BTRFS_SETGET_STACK_FUNCS
(
su³r_roÙ_dœ
, 
bŒfs_su³r_block
,

2312 
roÙ_dœ_objeùid
, 64);

2313 
BTRFS_SETGET_STACK_FUNCS
(
su³r_num_deviûs
, 
bŒfs_su³r_block
,

2314 
num_deviûs
, 64);

2315 
BTRFS_SETGET_STACK_FUNCS
(
su³r_com·t_æags
, 
bŒfs_su³r_block
,

2316 
com·t_æags
, 64);

2317 
BTRFS_SETGET_STACK_FUNCS
(
su³r_com·t_ro_æags
, 
bŒfs_su³r_block
,

2318 
com·t_ro_æags
, 64);

2319 
BTRFS_SETGET_STACK_FUNCS
(
su³r_šcom·t_æags
, 
bŒfs_su³r_block
,

2320 
šcom·t_æags
, 64);

2321 
BTRFS_SETGET_STACK_FUNCS
(
su³r_csum_ty³
, 
bŒfs_su³r_block
,

2322 
csum_ty³
, 16);

2323 
BTRFS_SETGET_STACK_FUNCS
(
su³r_ÿche_g’”©iÚ
, 
bŒfs_su³r_block
,

2324 
ÿche_g’”©iÚ
, 64);

2325 
BTRFS_SETGET_STACK_FUNCS
(
su³r_magic
, 
bŒfs_su³r_block
, 
magic
, 64);

2326 
BTRFS_SETGET_STACK_FUNCS
(
su³r_uuid_Œ“_g’”©iÚ
, 
bŒfs_su³r_block
,

2327 
uuid_Œ“_g’”©iÚ
, 64);

2329 
šlše
 
	$bŒfs_su³r_csum_size
(cÚ¡ 
bŒfs_su³r_block
 *
s
)

2331 
u16
 
t
 = 
	`bŒfs_su³r_csum_ty³
(
s
);

2335  
bŒfs_csum_sizes
[
t
];

2336 
	}
}

2344 
šlše
 
	$Ëaf_d©a_’d
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,

2345 cÚ¡ 
ex‹Á_bufãr
 *
Ëaf
)

2347 
u32
 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

2349 ià(
Ä
 == 0)

2350  
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
);

2351  
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
Ä
 - 1);

2352 
	}
}

2355 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_ty³
, 
bŒfs_fže_ex‹Á_™em
, 
ty³
, 8);

2356 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fže_ex‹Á_disk_by‹Ä
,

2357 
bŒfs_fže_ex‹Á_™em
, 
disk_by‹Ä
, 64);

2358 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fže_ex‹Á_off£t
,

2359 
bŒfs_fže_ex‹Á_™em
, 
off£t
, 64);

2360 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fže_ex‹Á_g’”©iÚ
,

2361 
bŒfs_fže_ex‹Á_™em
, 
g’”©iÚ
, 64);

2362 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fže_ex‹Á_num_by‹s
,

2363 
bŒfs_fže_ex‹Á_™em
, 
num_by‹s
, 64);

2364 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fže_ex‹Á_disk_num_by‹s
,

2365 
bŒfs_fže_ex‹Á_™em
, 
disk_num_by‹s
, 64);

2366 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_fže_ex‹Á_com´essiÚ
,

2367 
bŒfs_fže_ex‹Á_™em
, 
com´essiÚ
, 8);

2369 
šlše
 

2370 
	$bŒfs_fže_ex‹Á_šlše_¡¬t
(cÚ¡ 
bŒfs_fže_ex‹Á_™em
 *
e
)

2372  ()
e
 + 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

2373 
	}
}

2375 
šlše
 
u32
 
	$bŒfs_fže_ex‹Á_ÿlc_šlše_size
(
u32
 
d©asize
)

2377  
BTRFS_FILE_EXTENT_INLINE_DATA_START
 + 
d©asize
;

2378 
	}
}

2380 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_disk_by‹Ä
, 
bŒfs_fže_ex‹Á_™em
,

2381 
disk_by‹Ä
, 64);

2382 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_g’”©iÚ
, 
bŒfs_fže_ex‹Á_™em
,

2383 
g’”©iÚ
, 64);

2384 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_disk_num_by‹s
, 
bŒfs_fže_ex‹Á_™em
,

2385 
disk_num_by‹s
, 64);

2386 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_off£t
, 
bŒfs_fže_ex‹Á_™em
,

2387 
off£t
, 64);

2388 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_num_by‹s
, 
bŒfs_fže_ex‹Á_™em
,

2389 
num_by‹s
, 64);

2390 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_¿m_by‹s
, 
bŒfs_fže_ex‹Á_™em
,

2391 
¿m_by‹s
, 64);

2392 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_com´essiÚ
, 
bŒfs_fže_ex‹Á_™em
,

2393 
com´essiÚ
, 8);

2394 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_’üy±iÚ
, 
bŒfs_fže_ex‹Á_™em
,

2395 
’üy±iÚ
, 8);

2396 
BTRFS_SETGET_FUNCS
(
fže_ex‹Á_Ùh”_’codšg
, 
bŒfs_fže_ex‹Á_™em
,

2397 
Ùh”_’codšg
, 16);

2404 
šlše
 
u32
 
	$bŒfs_fže_ex‹Á_šlše_™em_Ën
(

2405 cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2406 
bŒfs_™em
 *
e
)

2408  
	`bŒfs_™em_size
(
eb
, 
e
è- 
BTRFS_FILE_EXTENT_INLINE_DATA_START
;

2409 
	}
}

2414 
šlše
 
u32
 
	$bŒfs_fže_ex‹Á_šlše_Ën
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2415 
¦Ù
,

2416 cÚ¡ 
bŒfs_fže_ex‹Á_™em
 *
fi
)

2418 
bŒfs_m­_tok’
 
tok’
;

2420 
	`bŒfs_š™_m­_tok’
(&
tok’
);

2425 ià(
	`bŒfs_tok’_fže_ex‹Á_com´essiÚ
(
eb
, 
fi
, &
tok’
) == 0 &&

2426 
	`bŒfs_tok’_fže_ex‹Á_’üy±iÚ
(
eb
, 
fi
, &
tok’
) == 0 &&

2427 
	`bŒfs_tok’_fže_ex‹Á_Ùh”_’codšg
(
eb
, 
fi
, &
tok’
) == 0) {

2428  
	`bŒfs_fže_ex‹Á_šlše_™em_Ën
(
eb
,

2429 
	`bŒfs_™em_Ä
(
¦Ù
));

2433  
	`bŒfs_tok’_fže_ex‹Á_¿m_by‹s
(
eb
, 
fi
, &
tok’
);

2434 
	}
}

2438 
šlše
 
u64
 
	$bŒfs_dev_¡©s_v®ue
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2439 cÚ¡ 
bŒfs_dev_¡©s_™em
 *
±r
,

2440 
šdex
)

2442 
u64
 
v®
;

2444 
	`»ad_ex‹Á_bufãr
(
eb
, &
v®
,

2445 
	`off£tof
(
bŒfs_dev_¡©s_™em
, 
v®ues
) +

2446 (()
±r
è+ (
šdex
 * (
u64
)),

2447 (
v®
));

2448  
v®
;

2449 
	}
}

2451 
šlše
 
	$bŒfs_£t_dev_¡©s_v®ue
(
ex‹Á_bufãr
 *
eb
,

2452 
bŒfs_dev_¡©s_™em
 *
±r
,

2453 
šdex
, 
u64
 
v®
)

2455 
	`wr™e_ex‹Á_bufãr
(
eb
, &
v®
,

2456 
	`off£tof
(
bŒfs_dev_¡©s_™em
, 
v®ues
) +

2457 (()
±r
è+ (
šdex
 * (
u64
)),

2458 (
v®
));

2459 
	}
}

2462 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_g’”©iÚ
, 
bŒfs_qgroup_¡©us_™em
,

2463 
g’”©iÚ
, 64);

2464 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_v”siÚ
, 
bŒfs_qgroup_¡©us_™em
,

2465 
v”siÚ
, 64);

2466 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_æags
, 
bŒfs_qgroup_¡©us_™em
,

2467 
æags
, 64);

2468 
BTRFS_SETGET_FUNCS
(
qgroup_¡©us_»sÿn
, 
bŒfs_qgroup_¡©us_™em
,

2469 
»sÿn
, 64);

2472 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_g’”©iÚ
, 
bŒfs_qgroup_šfo_™em
,

2473 
g’”©iÚ
, 64);

2474 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_rãr
, 
bŒfs_qgroup_šfo_™em
, 
rãr
, 64);

2475 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_rãr_cm´
, 
bŒfs_qgroup_šfo_™em
,

2476 
rãr_cm´
, 64);

2477 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_exþ
, 
bŒfs_qgroup_šfo_™em
, 
exþ
, 64);

2478 
BTRFS_SETGET_FUNCS
(
qgroup_šfo_exþ_cm´
, 
bŒfs_qgroup_šfo_™em
,

2479 
exþ_cm´
, 64);

2481 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_g’”©iÚ
,

2482 
bŒfs_qgroup_šfo_™em
, 
g’”©iÚ
, 64);

2483 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_rãr
, 
bŒfs_qgroup_šfo_™em
,

2484 
rãr
, 64);

2485 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_rãr_cm´
,

2486 
bŒfs_qgroup_šfo_™em
, 
rãr_cm´
, 64);

2487 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_exþ
, 
bŒfs_qgroup_šfo_™em
,

2488 
exþ
, 64);

2489 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_qgroup_šfo_exþ_cm´
,

2490 
bŒfs_qgroup_šfo_™em
, 
exþ_cm´
, 64);

2493 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_æags
, 
bŒfs_qgroup_lim™_™em
,

2494 
æags
, 64);

2495 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_max_rãr
, 
bŒfs_qgroup_lim™_™em
,

2496 
max_rãr
, 64);

2497 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_max_exþ
, 
bŒfs_qgroup_lim™_™em
,

2498 
max_exþ
, 64);

2499 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_rsv_rãr
, 
bŒfs_qgroup_lim™_™em
,

2500 
rsv_rãr
, 64);

2501 
BTRFS_SETGET_FUNCS
(
qgroup_lim™_rsv_exþ
, 
bŒfs_qgroup_lim™_™em
,

2502 
rsv_exþ
, 64);

2505 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_¤c_devid
,

2506 
bŒfs_dev_»¶aû_™em
, 
¤c_devid
, 64);

2507 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
,

2508 
bŒfs_dev_»¶aû_™em
, 
cÚt_»adšg_äom_¤cdev_mode
,

2510 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_»¶aû_¡©e
, 
bŒfs_dev_»¶aû_™em
,

2511 
»¶aû_¡©e
, 64);

2512 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_time_¡¬‹d
, 
bŒfs_dev_»¶aû_™em
,

2513 
time_¡¬‹d
, 64);

2514 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_time_¡Ý³d
, 
bŒfs_dev_»¶aû_™em
,

2515 
time_¡Ý³d
, 64);

2516 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_num_wr™e_”rÜs
, 
bŒfs_dev_»¶aû_™em
,

2517 
num_wr™e_”rÜs
, 64);

2518 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
,

2519 
bŒfs_dev_»¶aû_™em
, 
num_uncÜ»ùabË_»ad_”rÜs
,

2521 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_cursÜ_Ëá
, 
bŒfs_dev_»¶aû_™em
,

2522 
cursÜ_Ëá
, 64);

2523 
BTRFS_SETGET_FUNCS
(
dev_»¶aû_cursÜ_right
, 
bŒfs_dev_»¶aû_™em
,

2524 
cursÜ_right
, 64);

2526 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_¤c_devid
,

2527 
bŒfs_dev_»¶aû_™em
, 
¤c_devid
, 64);

2528 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
,

2529 
bŒfs_dev_»¶aû_™em
,

2530 
cÚt_»adšg_äom_¤cdev_mode
, 64);

2531 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_»¶aû_¡©e
,

2532 
bŒfs_dev_»¶aû_™em
, 
»¶aû_¡©e
, 64);

2533 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_time_¡¬‹d
,

2534 
bŒfs_dev_»¶aû_™em
, 
time_¡¬‹d
, 64);

2535 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_time_¡Ý³d
,

2536 
bŒfs_dev_»¶aû_™em
, 
time_¡Ý³d
, 64);

2537 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_num_wr™e_”rÜs
,

2538 
bŒfs_dev_»¶aû_™em
, 
num_wr™e_”rÜs
, 64);

2539 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
,

2540 
bŒfs_dev_»¶aû_™em
,

2541 
num_uncÜ»ùabË_»ad_”rÜs
, 64);

2542 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_cursÜ_Ëá
,

2543 
bŒfs_dev_»¶aû_™em
, 
cursÜ_Ëá
, 64);

2544 
BTRFS_SETGET_STACK_FUNCS
(
¡ack_dev_»¶aû_cursÜ_right
,

2545 
bŒfs_dev_»¶aû_™em
, 
cursÜ_right
, 64);

2548 
	#bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
ty³
) \

2549 ((
ty³
 *)(
BTRFS_LEAF_DATA_OFFSET
 + \

2550 
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
¦Ù
)))

	)

2552 
	#bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
) \

2553 (()(
BTRFS_LEAF_DATA_OFFSET
 + \

2554 
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
¦Ù
)))

	)

2556 
šlše
 
boÞ
 
	$bŒfs_mixed_¥aû_šfo
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
)

2558  ((
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

2559 (
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
));

2560 
	}
}

2562 
šlše
 
gå_t
 
	$bŒfs_®loc_wr™e_mask
(
add»ss_¥aû
 *
m­pšg
)

2564  
	`m­pšg_gå_cÚ¡¿št
(
m­pšg
, ~
__GFP_FS
);

2565 
	}
}

2569 
	ebŒfs_šlše_»f_ty³
 {

2570 
	mBTRFS_REF_TYPE_INVALID
 = 0,

2571 
	mBTRFS_REF_TYPE_BLOCK
 = 1,

2572 
	mBTRFS_REF_TYPE_DATA
 = 2,

2573 
	mBTRFS_REF_TYPE_ANY
 = 3,

2576 
bŒfs_g‘_ex‹Á_šlše_»f_ty³
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

2577 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

2578 
bŒfs_šlše_»f_ty³
 
is_d©a
);

2580 
u64
 
bŒfs_csum_by‹s_to_Ëaves
(
bŒfs_fs_šfo
 *
fs_šfo
, u64 
csum_by‹s
);

2582 
šlše
 
u64
 
	$bŒfs_ÿlc_Œªs_m‘ad©a_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

2583 
num_™ems
)

2585  (
u64
)
fs_šfo
->
nodesize
 * 
BTRFS_MAX_LEVEL
 * 2 * 
num_™ems
;

2586 
	}
}

2592 
šlše
 
u64
 
	$bŒfs_ÿlc_Œunc_m‘ad©a_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

2593 
num_™ems
)

2595  (
u64
)
fs_šfo
->
nodesize
 * 
BTRFS_MAX_LEVEL
 * 
num_™ems
;

2596 
	}
}

2598 
bŒfs_should_thrÙŽe_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2599 
bŒfs_fs_šfo
 *
fs_šfo
);

2600 
bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2601 
bŒfs_fs_šfo
 *
fs_šfo
);

2602 
bŒfs_dec_block_group_»£rv©iÚs
(
bŒfs_fs_šfo
 *
fs_šfo
,

2603 cÚ¡ 
u64
 
¡¬t
);

2604 
bŒfs_wa™_block_group_»£rv©iÚs
(
bŒfs_block_group_ÿche
 *
bg
);

2605 
boÞ
 
bŒfs_šc_nocow_wr™”s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

2606 
bŒfs_dec_nocow_wr™”s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

2607 
bŒfs_wa™_nocow_wr™”s
(
bŒfs_block_group_ÿche
 *
bg
);

2608 
bŒfs_put_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
);

2609 
bŒfs_run_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2610 
bŒfs_fs_šfo
 *
fs_šfo
, 
couÁ
);

2611 
bŒfs_async_run_d–ayed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

2612 
couÁ
, 
u64
 
Œªsid
, 
wa™
);

2613 
bŒfs_lookup_d©a_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
Ën
);

2614 
bŒfs_lookup_ex‹Á_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2615 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

2616 
u64
 
off£t
, 
m‘ad©a
, u64 *
»fs
, u64 *
æags
);

2617 
bŒfs_pš_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

2618 
u64
 
by‹Ä
, u64 
num
, 
»£rved
);

2619 
bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
bŒfs_fs_šfo
 *
fs_šfo
,

2620 
u64
 
by‹Ä
, u64 
num_by‹s
);

2621 
bŒfs_exþude_logged_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

2622 
ex‹Á_bufãr
 *
eb
);

2623 
bŒfs_üoss_»f_exi¡
(
bŒfs_roÙ
 *
roÙ
,

2624 
u64
 
objeùid
, u64 
off£t
, u64 
by‹Ä
);

2625 
bŒfs_block_group_ÿche
 *
bŒfs_lookup_block_group
(

2626 
bŒfs_fs_šfo
 *
šfo
,

2627 
u64
 
by‹Ä
);

2628 
bŒfs_g‘_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
);

2629 
bŒfs_put_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
);

2630 
g‘_block_group_šdex
(
bŒfs_block_group_ÿche
 *
ÿche
);

2631 
ex‹Á_bufãr
 *
bŒfs_®loc_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2632 
bŒfs_roÙ
 *
roÙ
,

2633 
u64
 
·»Á
, u64 
roÙ_objeùid
,

2634 cÚ¡ 
bŒfs_disk_key
 *
key
,

2635 
Ëv–
, 
u64
 
hšt
,

2636 
u64
 
em±y_size
);

2637 
bŒfs_ä“_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2638 
bŒfs_roÙ
 *
roÙ
,

2639 
ex‹Á_bufãr
 *
buf
,

2640 
u64
 
·»Á
, 
Ï¡_»f
);

2641 
bŒfs_®loc_»£rved_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2642 
u64
 
roÙ_objeùid
, u64 
owÃr
,

2643 
u64
 
off£t
, u64 
¿m_by‹s
,

2644 
bŒfs_key
 *
šs
);

2645 
bŒfs_®loc_logged_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2646 
bŒfs_fs_šfo
 *
fs_šfo
,

2647 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
,

2648 
bŒfs_key
 *
šs
);

2649 
bŒfs_»£rve_ex‹Á
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¿m_by‹s
, u64 
num_by‹s
,

2650 
u64
 
mš_®loc_size
, u64 
em±y_size
, u64 
hšt_by‹
,

2651 
bŒfs_key
 *
šs
, 
is_d©a
, 
d–®loc
);

2652 
bŒfs_šc_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2653 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
);

2654 
bŒfs_dec_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2655 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
);

2656 
bŒfs_£t_disk_ex‹Á_æags
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2657 
bŒfs_fs_šfo
 *
fs_šfo
,

2658 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
æags
,

2659 
Ëv–
, 
is_d©a
);

2660 
bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2661 
bŒfs_fs_šfo
 *
fs_šfo
,

2662 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
, u64 
roÙ_objeùid
,

2663 
u64
 
owÃr
, u64 
off£t
);

2665 
bŒfs_ä“_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

2666 
u64
 
¡¬t
, u64 
Ën
, 
d–®loc
);

2667 
bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

2668 
u64
 
¡¬t
, u64 
Ën
);

2669 
bŒfs_´•¬e_ex‹Á_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
);

2670 
bŒfs_fšish_ex‹Á_comm™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2671 
bŒfs_fs_šfo
 *
fs_šfo
);

2672 
bŒfs_šc_ex‹Á_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2673 
bŒfs_fs_šfo
 *
fs_šfo
,

2674 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

2675 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
);

2677 
bŒfs_¡¬t_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2678 
bŒfs_fs_šfo
 *
fs_šfo
);

2679 
bŒfs_wr™e_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2680 
bŒfs_fs_šfo
 *
fs_šfo
);

2681 
bŒfs_£tup_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2682 
bŒfs_fs_šfo
 *
fs_šfo
);

2683 
bŒfs_ex‹Á_»adÚly
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

2684 
bŒfs_ä“_block_groups
(
bŒfs_fs_šfo
 *
šfo
);

2685 
bŒfs_»ad_block_groups
(
bŒfs_fs_šfo
 *
šfo
);

2686 
bŒfs_ÿn_»loÿ‹
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

2687 
bŒfs_make_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2688 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹s_u£d
,

2689 
u64
 
ty³
, u64 
chunk_off£t
, u64 
size
);

2690 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œªs_»move_block_group
(

2691 
bŒfs_fs_šfo
 *
fs_šfo
,

2692 cÚ¡ 
u64
 
chunk_off£t
);

2693 
bŒfs_»move_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2694 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
group_¡¬t
,

2695 
ex‹Á_m­
 *
em
);

2696 
bŒfs_d–‘e_unu£d_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
);

2697 
bŒfs_g‘_block_group_Œimmšg
(
bŒfs_block_group_ÿche
 *
ÿche
);

2698 
bŒfs_put_block_group_Œimmšg
(
bŒfs_block_group_ÿche
 *
ÿche
);

2699 
bŒfs_ü—‹_³ndšg_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2700 
bŒfs_fs_šfo
 *
fs_šfo
);

2701 
u64
 
bŒfs_d©a_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
);

2702 
u64
 
bŒfs_m‘ad©a_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
);

2703 
u64
 
bŒfs_sy¡em_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
);

2704 
bŒfs_þ—r_¥aû_šfo_fuÎ
(
bŒfs_fs_šfo
 *
šfo
);

2706 
	ebŒfs_»£rve_æush_’um
 {

2708 
	mBTRFS_RESERVE_NO_FLUSH
,

2713 
	mBTRFS_RESERVE_FLUSH_LIMIT
,

2714 
	mBTRFS_RESERVE_FLUSH_ALL
,

2717 
	ebŒfs_æush_¡©e
 {

2718 
	mFLUSH_DELAYED_ITEMS_NR
 = 1,

2719 
	mFLUSH_DELAYED_ITEMS
 = 2,

2720 
	mFLUSH_DELALLOC
 = 3,

2721 
	mFLUSH_DELALLOC_WAIT
 = 4,

2722 
	mALLOC_CHUNK
 = 5,

2723 
	mCOMMIT_TRANS
 = 6,

2726 
bŒfs_®loc_d©a_chunk_Údemªd
(
bŒfs_šode
 *
šode
, 
u64
 
by‹s
);

2727 
bŒfs_check_d©a_ä“_¥aû
(
šode
 *inode,

2728 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

2729 
bŒfs_ä“_»£rved_d©a_¥aû
(
šode
 *inode,

2730 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

2731 
bŒfs_d–®loc_»Ëa£_¥aû
(
šode
 *inode,

2732 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

2733 
bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
 *šode, 
u64
 
¡¬t
,

2734 
u64
 
Ën
);

2735 
bŒfs_Œªs_»Ëa£_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2736 
bŒfs_fs_šfo
 *
fs_šfo
);

2737 
bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
);

2738 
bŒfs_Üphª_»£rve_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2739 
bŒfs_šode
 *
šode
);

2740 
bŒfs_Üphª_»Ëa£_m‘ad©a
(
bŒfs_šode
 *
šode
);

2741 
bŒfs_subvÞume_»£rve_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

2742 
bŒfs_block_rsv
 *
rsv
,

2743 
n™ems
,

2744 
u64
 *
qgroup_»£rved
, 
boÞ
 
u£_glob®_rsv
);

2745 
bŒfs_subvÞume_»Ëa£_m‘ad©a
(
bŒfs_fs_šfo
 *
fs_šfo
,

2746 
bŒfs_block_rsv
 *
rsv
);

2747 
bŒfs_d–®loc_»£rve_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
);

2748 
bŒfs_d–®loc_»Ëa£_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
);

2749 
bŒfs_d–®loc_»£rve_¥aû
(
šode
 *inode,

2750 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

2751 
bŒfs_š™_block_rsv
(
bŒfs_block_rsv
 *
rsv
, 
ty³
);

2752 
bŒfs_block_rsv
 *
bŒfs_®loc_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

2753 
ty³
);

2754 
bŒfs_ä“_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

2755 
bŒfs_block_rsv
 *
rsv
);

2756 
__bŒfs_ä“_block_rsv
(
bŒfs_block_rsv
 *
rsv
);

2757 
bŒfs_block_rsv_add
(
bŒfs_roÙ
 *
roÙ
,

2758 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

2759 
bŒfs_»£rve_æush_’um
 
æush
);

2760 
bŒfs_block_rsv_check
(
bŒfs_block_rsv
 *
block_rsv
, 
mš_çùÜ
);

2761 
bŒfs_block_rsv_»fžl
(
bŒfs_roÙ
 *
roÙ
,

2762 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
mš_»£rved
,

2763 
bŒfs_»£rve_æush_’um
 
æush
);

2764 
bŒfs_block_rsv_mig¿‹
(
bŒfs_block_rsv
 *
¤c_rsv
,

2765 
bŒfs_block_rsv
 *
d¡_rsv
, 
u64
 
num_by‹s
,

2766 
upd©e_size
);

2767 
bŒfs_cÚd_mig¿‹_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

2768 
bŒfs_block_rsv
 *
de¡
, 
u64
 
num_by‹s
,

2769 
mš_çùÜ
);

2770 
bŒfs_block_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
,

2771 
bŒfs_block_rsv
 *
block_rsv
,

2772 
u64
 
num_by‹s
);

2773 
bŒfs_šc_block_group_ro
(
bŒfs_fs_šfo
 *
fs_šfo
,

2774 
bŒfs_block_group_ÿche
 *
ÿche
);

2775 
bŒfs_dec_block_group_ro
(
bŒfs_block_group_ÿche
 *
ÿche
);

2776 
bŒfs_put_block_group_ÿche
(
bŒfs_fs_šfo
 *
šfo
);

2777 
u64
 
bŒfs_accouÁ_ro_block_groups_ä“_¥aû
(
bŒfs_¥aû_šfo
 *
sšfo
);

2778 
bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

2779 
u64
 
¡¬t
, u64 
’d
);

2780 
bŒfs_disÿrd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

2781 
u64
 
num_by‹s
, u64 *
aùu®_by‹s
);

2782 
bŒfs_fÜû_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2783 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
);

2784 
bŒfs_Œim_fs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
f¡rim_¿nge
 *
¿nge
);

2786 
bŒfs_š™_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
);

2787 
bŒfs_d–ayed_»fs_qgroup_accouÁšg
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2788 
bŒfs_fs_šfo
 *
fs_šfo
);

2789 
__g‘_¿id_šdex
(
u64
 
æags
);

2790 
bŒfs_¡¬t_wr™e_no_¢­shÙtšg
(
bŒfs_roÙ
 *
roÙ
);

2791 
bŒfs_’d_wr™e_no_¢­shÙtšg
(
bŒfs_roÙ
 *
roÙ
);

2792 
bŒfs_wa™_fÜ_¢­shÙ_ü—tiÚ
(
bŒfs_roÙ
 *
roÙ
);

2793 
check_sy¡em_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2794 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ 
u64
 
ty³
);

2795 
u64
 
add_Ãw_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

2796 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
¡¬t
, u64 
’d
);

2799 
bŒfs_bš_£¬ch
(
ex‹Á_bufãr
 *
eb
, cÚ¡ 
bŒfs_key
 *
key
,

2800 
Ëv–
, *
¦Ù
);

2801 
bŒfs_comp_ýu_keys
(cÚ¡ 
bŒfs_key
 *
k1
, cÚ¡ bŒfs_key *
k2
);

2802 
bŒfs_´evious_™em
(
bŒfs_roÙ
 *
roÙ
,

2803 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
,

2804 
ty³
);

2805 
bŒfs_´evious_ex‹Á_™em
(
bŒfs_roÙ
 *
roÙ
,

2806 
bŒfs_·th
 *
·th
, 
u64
 
mš_objeùid
);

2807 
bŒfs_£t_™em_key_§ã
(
bŒfs_fs_šfo
 *
fs_šfo
,

2808 
bŒfs_·th
 *
·th
,

2809 cÚ¡ 
bŒfs_key
 *
Ãw_key
);

2810 
ex‹Á_bufãr
 *
bŒfs_roÙ_node
(
bŒfs_roÙ
 *
roÙ
);

2811 
ex‹Á_bufãr
 *
bŒfs_lock_roÙ_node
(
bŒfs_roÙ
 *
roÙ
);

2812 
bŒfs_fšd_Ãxt_key
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

2813 
bŒfs_key
 *
key
, 
lowe¡_Ëv–
,

2814 
u64
 
mš_Œªs
);

2815 
bŒfs_£¬ch_fÜw¬d
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_key
 *
mš_key
,

2816 
bŒfs_·th
 *
·th
,

2817 
u64
 
mš_Œªs
);

2818 
	ebŒfs_com·»_Œ“_»suÉ
 {

2819 
	mBTRFS_COMPARE_TREE_NEW
,

2820 
	mBTRFS_COMPARE_TREE_DELETED
,

2821 
	mBTRFS_COMPARE_TREE_CHANGED
,

2822 
	mBTRFS_COMPARE_TREE_SAME
,

2824 (*
	tbŒfs_chªged_cb_t
)(
	tbŒfs_roÙ
 *
	tËá_roÙ
,

2825 
	tbŒfs_roÙ
 *
	tright_roÙ
,

2826 
	tbŒfs_·th
 *
	tËá_·th
,

2827 
	tbŒfs_·th
 *
	tright_·th
,

2828 
	tbŒfs_key
 *
	tkey
,

2829 
	tbŒfs_com·»_Œ“_»suÉ
 
	t»suÉ
,

2830 *
	tùx
);

2831 
	`bŒfs_com·»_Œ“s
(
bŒfs_roÙ
 *
Ëá_roÙ
,

2832 
bŒfs_roÙ
 *
right_roÙ
,

2833 
bŒfs_chªged_cb_t
 
cb
, *
ùx
);

2834 
	`bŒfs_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2835 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

2836 
ex‹Á_bufãr
 *
·»Á
, 
·»Á_¦Ù
,

2837 
ex‹Á_bufãr
 **
cow_»t
);

2838 
	`bŒfs_cÝy_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2839 
bŒfs_roÙ
 *
roÙ
,

2840 
ex‹Á_bufãr
 *
buf
,

2841 
ex‹Á_bufãr
 **
cow_»t
, 
u64
 
Ãw_roÙ_objeùid
);

2842 
	`bŒfs_block_ÿn_be_sh¬ed
(
bŒfs_roÙ
 *
roÙ
,

2843 
ex‹Á_bufãr
 *
buf
);

2844 
	`bŒfs_ex‹nd_™em
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_·th
 *
·th
,

2845 
u32
 
d©a_size
);

2846 
	`bŒfs_Œunÿ‹_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

2847 
bŒfs_·th
 *
·th
, 
u32
 
Ãw_size
, 
äom_’d
);

2848 
	`bŒfs_¥l™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2849 
bŒfs_roÙ
 *
roÙ
,

2850 
bŒfs_·th
 *
·th
,

2851 cÚ¡ 
bŒfs_key
 *
Ãw_key
,

2852 
¥l™_off£t
);

2853 
	`bŒfs_du¶iÿ‹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2854 
bŒfs_roÙ
 *
roÙ
,

2855 
bŒfs_·th
 *
·th
,

2856 cÚ¡ 
bŒfs_key
 *
Ãw_key
);

2857 
	`bŒfs_fšd_™em
(
bŒfs_roÙ
 *
fs_roÙ
, 
bŒfs_·th
 *
·th
,

2858 
u64
 
šum
, u64 
ioff
, 
u8
 
key_ty³
, 
bŒfs_key
 *
found_key
);

2859 
	`bŒfs_£¬ch_¦Ù
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2860 cÚ¡ 
bŒfs_key
 *
key
, 
bŒfs_·th
 *
p
,

2861 
šs_Ën
, 
cow
);

2862 
	`bŒfs_£¬ch_Þd_¦Ù
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
key
,

2863 
bŒfs_·th
 *
p
, 
u64
 
time_£q
);

2864 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
bŒfs_roÙ
 *
roÙ
,

2865 cÚ¡ 
bŒfs_key
 *
key
,

2866 
bŒfs_·th
 *
p
, 
fšd_high”
,

2867 
»tuº_ªy
);

2868 
	`bŒfs_»®loc_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2869 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
·»Á
,

2870 
¡¬t_¦Ù
, 
u64
 *
Ï¡_»t
,

2871 
bŒfs_key
 *
´og»ss
);

2872 
	`bŒfs_»Ëa£_·th
(
bŒfs_·th
 *
p
);

2873 
bŒfs_·th
 *
	`bŒfs_®loc_·th
();

2874 
	`bŒfs_ä“_·th
(
bŒfs_·th
 *
p
);

2875 
	`bŒfs_£t_·th_blockšg
(
bŒfs_·th
 *
p
);

2876 
	`bŒfs_þ—r_·th_blockšg
(
bŒfs_·th
 *
p
,

2877 
ex‹Á_bufãr
 *
h–d
, 
h–d_rw
);

2878 
	`bŒfs_uÆock_up_§ã
(
bŒfs_·th
 *
p
, 
Ëv–
);

2880 
	`bŒfs_d–_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2881 
bŒfs_·th
 *
·th
, 
¦Ù
, 
Ä
);

2882 
šlše
 
	$bŒfs_d–_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2883 
bŒfs_roÙ
 *
roÙ
,

2884 
bŒfs_·th
 *
·th
)

2886  
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 1);

2887 
	}
}

2889 
£tup_™ems_fÜ_š£¹
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

2890 cÚ¡ 
bŒfs_key
 *
ýu_key
, 
u32
 *
d©a_size
,

2891 
u32
 
tÙ®_d©a
, u32 
tÙ®_size
, 
Ä
);

2892 
bŒfs_š£¹_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2893 cÚ¡ 
bŒfs_key
 *
key
, *
d©a
, 
u32
 
d©a_size
);

2894 
bŒfs_š£¹_em±y_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2895 
bŒfs_roÙ
 *
roÙ
,

2896 
bŒfs_·th
 *
·th
,

2897 cÚ¡ 
bŒfs_key
 *
ýu_key
, 
u32
 *
d©a_size
,

2898 
Ä
);

2900 
šlše
 
	$bŒfs_š£¹_em±y_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2901 
bŒfs_roÙ
 *
roÙ
,

2902 
bŒfs_·th
 *
·th
,

2903 cÚ¡ 
bŒfs_key
 *
key
,

2904 
u32
 
d©a_size
)

2906  
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
roÙ
, 
·th
, 
key
, &
d©a_size
, 1);

2907 
	}
}

2909 
bŒfs_Ãxt_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
);

2910 
bŒfs_´ev_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
);

2911 
bŒfs_Ãxt_Þd_Ëaf
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

2912 
u64
 
time_£q
);

2913 
šlše
 
	$bŒfs_Ãxt_Þd_™em
(
bŒfs_roÙ
 *
roÙ
,

2914 
bŒfs_·th
 *
p
, 
u64
 
time_£q
)

2916 ++
p
->
¦Ùs
[0];

2917 ià(
p
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
Õ->
nodes
[0]))

2918  
	`bŒfs_Ãxt_Þd_Ëaf
(
roÙ
, 
p
, 
time_£q
);

2920 
	}
}

2921 
šlše
 
	$bŒfs_Ãxt_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
)

2923  
	`bŒfs_Ãxt_Þd_™em
(
roÙ
, 
p
, 0);

2924 
	}
}

2925 
bŒfs_Ëaf_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

2926 
ex‹Á_bufãr
 *
Ëaf
);

2927 
__mu¡_check
 
bŒfs_drÝ_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
,

2928 
bŒfs_block_rsv
 *
block_rsv
,

2929 
upd©e_»f
, 
fÜ_»loc
);

2930 
bŒfs_drÝ_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2931 
bŒfs_roÙ
 *
roÙ
,

2932 
ex‹Á_bufãr
 *
node
,

2933 
ex‹Á_bufãr
 *
·»Á
);

2934 
šlše
 
	$bŒfs_fs_þosšg
(
bŒfs_fs_šfo
 *
fs_šfo
)

2939 ià(
	`‹¡_b™
(
BTRFS_FS_CLOSING_START
, &
fs_šfo
->
æags
)) {

2940 ià(
	`‹¡_b™
(
BTRFS_FS_CLOSING_DONE
, &
fs_šfo
->
æags
))

2945 
	}
}

2952 
šlše
 
	$bŒfs_Ãed_þ—Ãr_¦“p
(
bŒfs_fs_šfo
 *
fs_šfo
)

2954  
fs_šfo
->
sb
->
s_æags
 & 
MS_RDONLY
 || 
	`bŒfs_fs_þosšg
(fs_info);

2955 
	}
}

2957 
šlše
 
	$ä“_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

2959 
	`kä“
(
fs_šfo
->
b®ªû_ùl
);

2960 
	`kä“
(
fs_šfo
->
d–ayed_roÙ
);

2961 
	`kä“
(
fs_šfo
->
ex‹Á_roÙ
);

2962 
	`kä“
(
fs_šfo
->
Œ“_roÙ
);

2963 
	`kä“
(
fs_šfo
->
chunk_roÙ
);

2964 
	`kä“
(
fs_šfo
->
dev_roÙ
);

2965 
	`kä“
(
fs_šfo
->
csum_roÙ
);

2966 
	`kä“
(
fs_šfo
->
quÙa_roÙ
);

2967 
	`kä“
(
fs_šfo
->
uuid_roÙ
);

2968 
	`kä“
(
fs_šfo
->
ä“_¥aû_roÙ
);

2969 
	`kä“
(
fs_šfo
->
su³r_cÝy
);

2970 
	`kä“
(
fs_šfo
->
su³r_fÜ_comm™
);

2971 
	`£cur™y_ä“_mÁ_Ýts
(&
fs_šfo
->
£cur™y_Ýts
);

2972 
	`kä“
(
fs_šfo
);

2973 
	}
}

2976 
u64
 
bŒfs_g‘_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

2977 
£q_li¡
 *
–em
);

2978 
bŒfs_put_Œ“_mod_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

2979 
£q_li¡
 *
–em
);

2980 
bŒfs_Þd_roÙ_Ëv–
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
time_£q
);

2983 
bŒfs_add_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2984 
bŒfs_fs_šfo
 *
fs_šfo
,

2985 
u64
 
roÙ_id
, u64 
»f_id
, u64 
dœid
, u64 
£qu’û
,

2986 cÚ¡ *
Çme
, 
Çme_Ën
);

2987 
bŒfs_d–_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2988 
bŒfs_fs_šfo
 *
fs_šfo
,

2989 
u64
 
roÙ_id
, u64 
»f_id
, u64 
dœid
, u64 *
£qu’û
,

2990 cÚ¡ *
Çme
, 
Çme_Ën
);

2991 
bŒfs_d–_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2992 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ 
bŒfs_key
 *
key
);

2993 
bŒfs_š£¹_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

2994 cÚ¡ 
bŒfs_key
 *
key
,

2995 
bŒfs_roÙ_™em
 *
™em
);

2996 
__mu¡_check
 
bŒfs_upd©e_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2997 
bŒfs_roÙ
 *
roÙ
,

2998 
bŒfs_key
 *
key
,

2999 
bŒfs_roÙ_™em
 *
™em
);

3000 
bŒfs_fšd_roÙ
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
£¬ch_key
,

3001 
bŒfs_·th
 *
·th
, 
bŒfs_roÙ_™em
 *
roÙ_™em
,

3002 
bŒfs_key
 *
roÙ_key
);

3003 
bŒfs_fšd_Üphª_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
);

3004 
bŒfs_£t_roÙ_node
(
bŒfs_roÙ_™em
 *
™em
,

3005 
ex‹Á_bufãr
 *
node
);

3006 
bŒfs_check_ªd_š™_roÙ_™em
(
bŒfs_roÙ_™em
 *
™em
);

3007 
bŒfs_upd©e_roÙ_times
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3008 
bŒfs_roÙ
 *
roÙ
);

3011 
bŒfs_uuid_Œ“_add
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3012 
bŒfs_fs_šfo
 *
fs_šfo
, 
u8
 *
uuid
, u8 
ty³
,

3013 
u64
 
subid
);

3014 
bŒfs_uuid_Œ“_»m
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3015 
bŒfs_fs_šfo
 *
fs_šfo
, 
u8
 *
uuid
, u8 
ty³
,

3016 
u64
 
subid
);

3017 
bŒfs_uuid_Œ“_™”©e
(
bŒfs_fs_šfo
 *
fs_šfo
,

3018 (*
check_func
)(
bŒfs_fs_šfo
 *, 
u8
 *, u8,

3019 
u64
));

3022 
	`bŒfs_check_dœ_™em_cÞlisiÚ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
dœ
,

3023 cÚ¡ *
Çme
, 
Çme_Ën
);

3024 
	`bŒfs_š£¹_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3025 
bŒfs_roÙ
 *
roÙ
, cÚ¡ *
Çme
,

3026 
Çme_Ën
, 
bŒfs_šode
 *
dœ
,

3027 
bŒfs_key
 *
loÿtiÚ
, 
u8
 
ty³
, 
u64
 
šdex
);

3028 
bŒfs_dœ_™em
 *
	`bŒfs_lookup_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3029 
bŒfs_roÙ
 *
roÙ
,

3030 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

3031 cÚ¡ *
Çme
, 
Çme_Ën
,

3032 
mod
);

3033 
bŒfs_dœ_™em
 *

3034 
	`bŒfs_lookup_dœ_šdex_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3035 
bŒfs_roÙ
 *
roÙ
,

3036 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

3037 
u64
 
objeùid
, cÚ¡ *
Çme
, 
Çme_Ën
,

3038 
mod
);

3039 
bŒfs_dœ_™em
 *

3040 
	`bŒfs_£¬ch_dœ_šdex_™em
(
bŒfs_roÙ
 *
roÙ
,

3041 
bŒfs_·th
 *
·th
, 
u64
 
dœid
,

3042 cÚ¡ *
Çme
, 
Çme_Ën
);

3043 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3044 
bŒfs_roÙ
 *
roÙ
,

3045 
bŒfs_·th
 *
·th
,

3046 
bŒfs_dœ_™em
 *
di
);

3047 
	`bŒfs_š£¹_x©Œ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3048 
bŒfs_roÙ
 *
roÙ
,

3049 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

3050 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

3051 cÚ¡ *
d©a
, 
u16
 
d©a_Ën
);

3052 
bŒfs_dœ_™em
 *
	`bŒfs_lookup_x©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3053 
bŒfs_roÙ
 *
roÙ
,

3054 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

3055 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

3056 
mod
);

3057 
	`v”ify_dœ_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

3058 
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
,

3059 
bŒfs_dœ_™em
 *
dœ_™em
);

3060 
bŒfs_dœ_™em
 *
	`bŒfs_m©ch_dœ_™em_Çme
(
bŒfs_fs_šfo
 *
fs_šfo
,

3061 
bŒfs_·th
 *
·th
,

3062 cÚ¡ *
Çme
,

3063 
Çme_Ën
);

3064 
boÞ
 
	`bŒfs_is_Çme_Ën_v®id
(
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
,

3065 
¡¬t
, 
u16
 
Çme_Ën
);

3068 
	`bŒfs_š£¹_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3069 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
);

3070 
	`bŒfs_d–_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3071 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
);

3072 
	`bŒfs_fšd_Üphª_™em
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
);

3075 
	`bŒfs_š£¹_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3076 
bŒfs_roÙ
 *
roÙ
,

3077 cÚ¡ *
Çme
, 
Çme_Ën
,

3078 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 
šdex
);

3079 
	`bŒfs_d–_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3080 
bŒfs_roÙ
 *
roÙ
,

3081 cÚ¡ *
Çme
, 
Çme_Ën
,

3082 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 *
šdex
);

3083 
	`bŒfs_š£¹_em±y_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3084 
bŒfs_roÙ
 *
roÙ
,

3085 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
);

3086 
	`bŒfs_lookup_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


3087 *
roÙ
, 
bŒfs_·th
 *
·th
,

3088 
bŒfs_key
 *
loÿtiÚ
, 
mod
);

3090 
bŒfs_šode_exŒef
 *

3091 
	`bŒfs_lookup_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3092 
bŒfs_roÙ
 *
roÙ
,

3093 
bŒfs_·th
 *
·th
,

3094 cÚ¡ *
Çme
, 
Çme_Ën
,

3095 
u64
 
šode_objeùid
, u64 
»f_objeùid
, 
šs_Ën
,

3096 
cow
);

3098 
	`bŒfs_fšd_Çme_š_ext_back»f
(
bŒfs_·th
 *
·th
,

3099 
u64
 
»f_objeùid
, cÚ¡ *
Çme
,

3100 
Çme_Ën
,

3101 
bŒfs_šode_exŒef
 **
exŒef_»t
);

3104 
bŒfs_dio_´iv©e
;

3105 
	`bŒfs_d–_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3106 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
, u64 
Ën
);

3107 
blk_¡©us_t
 
	`bŒfs_lookup_bio_sums
(
šode
 *šode, 
bio
 *bio, 
u32
 *
d¡
);

3108 
blk_¡©us_t
 
	`bŒfs_lookup_bio_sums_dio
(
šode
 *šode, 
bio
 *bio,

3109 
u64
 
logiÿl_off£t
);

3110 
	`bŒfs_š£¹_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3111 
bŒfs_roÙ
 *
roÙ
,

3112 
u64
 
objeùid
, u64 
pos
,

3113 
u64
 
disk_off£t
, u64 
disk_num_by‹s
,

3114 
u64
 
num_by‹s
, u64 
off£t
, u64 
¿m_by‹s
,

3115 
u8
 
com´essiÚ
, u8 
’üy±iÚ
, 
u16
 
Ùh”_’codšg
);

3116 
	`bŒfs_lookup_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3117 
bŒfs_roÙ
 *
roÙ
,

3118 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

3119 
u64
 
by‹Ä
, 
mod
);

3120 
	`bŒfs_csum_fže_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3121 
bŒfs_roÙ
 *
roÙ
,

3122 
bŒfs_Üd”ed_sum
 *
sums
);

3123 
blk_¡©us_t
 
	`bŒfs_csum_Úe_bio
(
šode
 *šode, 
bio
 *bio,

3124 
u64
 
fže_¡¬t
, 
cÚtig
);

3125 
	`bŒfs_lookup_csums_¿nge
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
’d
,

3126 
li¡_h—d
 *
li¡
, 
£¬ch_comm™
);

3127 
	`bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
bŒfs_šode
 *
šode
,

3128 cÚ¡ 
bŒfs_·th
 *
·th
,

3129 
bŒfs_fže_ex‹Á_™em
 *
fi
,

3130 cÚ¡ 
boÞ
 
Ãw_šlše
,

3131 
ex‹Á_m­
 *
em
);

3134 
	sbŒfs_d–®loc_wÜk
 {

3135 
šode
 *inode;

3136 
d–ay_ut
;

3137 
com¶‘iÚ
 completion;

3138 
li¡_h—d
 
li¡
;

3139 
bŒfs_wÜk
 
wÜk
;

3142 
bŒfs_d–®loc_wÜk
 *
	`bŒfs_®loc_d–®loc_wÜk
(
šode
 *inode,

3143 
d–ay_ut
);

3144 
	`bŒfs_wa™_ªd_ä“_d–®loc_wÜk
(
bŒfs_d–®loc_wÜk
 *
wÜk
);

3146 
ex‹Á_m­
 *
	`bŒfs_g‘_ex‹Á_f›m­
(
bŒfs_šode
 *
šode
,

3147 
·ge
 *·ge, 
size_t
 
pg_off£t
, 
u64
 
¡¬t
,

3148 
u64
 
Ën
, 
ü—‹
);

3149 
nošlše
 
	`ÿn_nocow_ex‹Á
(
šode
 *šode, 
u64
 
off£t
, u64 *
Ën
,

3150 
u64
 *
Üig_¡¬t
, u64 *
Üig_block_Ën
,

3151 
u64
 *
¿m_by‹s
);

3153 
šode
 *
	`bŒfs_lookup_d’Œy
(šod*
dœ
, 
d’Œy
 *dentry);

3154 
	`bŒfs_£t_šode_šdex
(
bŒfs_šode
 *
dœ
, 
u64
 *
šdex
);

3155 
	`bŒfs_uÆšk_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3156 
bŒfs_roÙ
 *
roÙ
,

3157 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

3158 cÚ¡ *
Çme
, 
Çme_Ën
);

3159 
	`bŒfs_add_lšk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3160 
bŒfs_šode
 *
·»Á_šode
, bŒfs_šod*
šode
,

3161 cÚ¡ *
Çme
, 
Çme_Ën
, 
add_back»f
, 
u64
 
šdex
);

3162 
	`bŒfs_uÆšk_subvÞ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3163 
bŒfs_roÙ
 *
roÙ
,

3164 
šode
 *
dœ
, 
u64
 
objeùid
,

3165 cÚ¡ *
Çme
, 
Çme_Ën
);

3166 
	`bŒfs_Œunÿ‹_block
(
šode
 *šode, 
loff_t
 
äom
,†off_ˆ
Ën
,

3167 
äÚt
);

3168 
	`bŒfs_Œunÿ‹_šode_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3169 
bŒfs_roÙ
 *
roÙ
,

3170 
šode
 *šode, 
u64
 
Ãw_size
,

3171 
u32
 
mš_ty³
);

3173 
	`bŒfs_¡¬t_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
, 
d–ay_ut
);

3174 
	`bŒfs_¡¬t_d–®loc_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
d–ay_ut
,

3175 
Ä
);

3176 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

3177 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
dedu³
);

3178 
	`bŒfs_ü—‹_subvÞ_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3179 
bŒfs_roÙ
 *
Ãw_roÙ
,

3180 
bŒfs_roÙ
 *
·»Á_roÙ
,

3181 
u64
 
Ãw_dœid
);

3182 
	`bŒfs_m”ge_bio_hook
(
·ge
 *·ge, 
off£t
,

3183 
size_t
 
size
, 
bio
 *bio,

3184 
bio_æags
);

3185 
	`bŒfs_£t_¿nge_wr™eback
(*
´iv©e_d©a
, 
u64
 
¡¬t
, u64 
’d
);

3186 
	`bŒfs_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
);

3187 
	`bŒfs_»ad·ge
(
fže
 *fže, 
·ge
 *page);

3188 
	`bŒfs_eviù_šode
(
šode
 *inode);

3189 
	`bŒfs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒÞ
 *
wbc
);

3190 
šode
 *
	`bŒfs_®loc_šode
(
su³r_block
 *
sb
);

3191 
	`bŒfs_de¡roy_šode
(
šode
 *inode);

3192 
	`bŒfs_drÝ_šode
(
šode
 *inode);

3193 
	`bŒfs_š™_ÿch•
();

3194 
	`bŒfs_de¡roy_ÿch•
();

3195 
	`bŒfs_ioùl_Œªs_’d
(
fže
 *file);

3196 
šode
 *
	`bŒfs_ig‘
(
su³r_block
 *
s
, 
bŒfs_key
 *
loÿtiÚ
,

3197 
bŒfs_roÙ
 *
roÙ
, *
was_Ãw
);

3198 
ex‹Á_m­
 *
	`bŒfs_g‘_ex‹Á
(
bŒfs_šode
 *
šode
,

3199 
·ge
 *·ge, 
size_t
 
pg_off£t
,

3200 
u64
 
¡¬t
, u64 
’d
, 
ü—‹
);

3201 
	`bŒfs_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3202 
bŒfs_roÙ
 *
roÙ
,

3203 
šode
 *inode);

3204 
	`bŒfs_upd©e_šode_çÎback
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3205 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode);

3206 
	`bŒfs_Üphª_add
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3207 
bŒfs_šode
 *
šode
);

3208 
	`bŒfs_Üphª_þ—nup
(
bŒfs_roÙ
 *
roÙ
);

3209 
	`bŒfs_Üphª_comm™_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3210 
bŒfs_roÙ
 *
roÙ
);

3211 
	`bŒfs_cÚt_ex·nd
(
šode
 *šode, 
loff_t
 
Þdsize
,†off_ˆ
size
);

3212 
	`bŒfs_šv®id©e_šodes
(
bŒfs_roÙ
 *
roÙ
);

3213 
	`bŒfs_add_d–ayed_ut
(
šode
 *inode);

3214 
	`bŒfs_run_d–ayed_uts
(
bŒfs_fs_šfo
 *
fs_šfo
);

3215 
	`bŒfs_´—Îoc_fže_¿nge
(
šode
 *šode, 
mode
,

3216 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

3217 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
);

3218 
	`bŒfs_´—Îoc_fže_¿nge_Œªs
(
šode
 *inode,

3219 
bŒfs_Œªs_hªdË
 *
Œªs
, 
mode
,

3220 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

3221 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
);

3222 cÚ¡ 
d’Œy_Ý”©iÚs
 
bŒfs_d’Œy_Ý”©iÚs
;

3223 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3224 
	`bŒfs_‹¡_šode_£t_Ýs
(
šode
 *inode);

3228 
	`bŒfs_ioùl
(
fže
 *fže, 
cmd
, 
¬g
);

3229 
	`bŒfs_com·t_ioùl
(
fže
 *fže, 
cmd
, 
¬g
);

3230 
	`bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
(
__u£r
 *
¬g
);

3231 
	`bŒfs_upd©e_iæags
(
šode
 *inode);

3232 
	`bŒfs_is_em±y_uuid
(
u8
 *
uuid
);

3233 
	`bŒfs_deäag_fže
(
šode
 *šode, 
fže
 *file,

3234 
bŒfs_ioùl_deäag_¿nge_¬gs
 *
¿nge
,

3235 
u64
 
Ãw”_thª
, 
max_·ges
);

3236 
	`bŒfs_g‘_block_group_šfo
(
li¡_h—d
 *
groups_li¡
,

3237 
bŒfs_ioùl_¥aû_šfo
 *
¥aû
);

3238 
	`upd©e_ioùl_b®ªû_¬gs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
lock
,

3239 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
);

3240 
ssize_t
 
	`bŒfs_dedu³_fže_¿nge
(
fže
 *
¤c_fže
, 
u64
 
loff
, u64 
Þ’
,

3241 
fže
 *
d¡_fže
, 
u64
 
d¡_loff
);

3244 
	`bŒfs_auto_deäag_š™
();

3245 
	`bŒfs_auto_deäag_ex™
();

3246 
	`bŒfs_add_šode_deäag
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3247 
bŒfs_šode
 *
šode
);

3248 
	`bŒfs_run_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
);

3249 
	`bŒfs_þ—nup_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
);

3250 
	`bŒfs_sync_fže
(
fže
 *fže, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
);

3251 
	`bŒfs_drÝ_ex‹Á_ÿche
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

3252 
sk_pšÃd
);

3253 cÚ¡ 
fže_Ý”©iÚs
 
bŒfs_fže_Ý”©iÚs
;

3254 
	`__bŒfs_drÝ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3255 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

3256 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
’d
,

3257 
u64
 *
drÝ_’d
, 
drÝ_ÿche
,

3258 
»¶aû_ex‹Á
,

3259 
u32
 
ex‹Á_™em_size
,

3260 *
key_š£¹ed
);

3261 
	`bŒfs_drÝ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3262 
bŒfs_roÙ
 *
roÙ
, 
šode
 *šode, 
u64
 
¡¬t
,

3263 
u64
 
’d
, 
drÝ_ÿche
);

3264 
	`bŒfs_m¬k_ex‹Á_wr™‹n
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3265 
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
);

3266 
	`bŒfs_»Ëa£_fže
(
šode
 *šode, 
fže
 *file);

3267 
	`bŒfs_dœty_·ges
(
šode
 *šode, 
·ge
 **
·ges
,

3268 
size_t
 
num_·ges
, 
loff_t
 
pos
, size_ˆ
wr™e_by‹s
,

3269 
ex‹Á_¡©e
 **
ÿched
);

3270 
	`bŒfs_fd©awr™e_¿nge
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
);

3271 
	`bŒfs_þÚe_fže_¿nge
(
fže
 *
fže_š
, 
loff_t
 
pos_š
,

3272 
fže
 *
fže_out
, 
loff_t
 
pos_out
, 
u64
 
Ën
);

3275 
	`bŒfs_deäag_Ëaves
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3276 
bŒfs_roÙ
 *
roÙ
);

3279 
	`bŒfs_š™_sysfs
();

3280 
	`bŒfs_ex™_sysfs
();

3281 
	`bŒfs_sysfs_add_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
);

3282 
	`bŒfs_sysfs_»move_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
);

3285 
ssize_t
 
	`bŒfs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
size
);

3288 
	`bŒfs_·r£_ÝtiÚs
(
bŒfs_fs_šfo
 *
šfo
, *
ÝtiÚs
,

3289 
Ãw_æags
);

3290 
	`bŒfs_sync_fs
(
su³r_block
 *
sb
, 
wa™
);

3292 
šlše
 
	$__´štf
(2, 3)

3293 
	$bŒfs_no_´štk
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
fmt
, ...)

3295 
	}
}

3297 #ifdeà
CONFIG_PRINTK


3298 
	$__´štf
(2, 3)

3299 
	`bŒfs_´štk
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
fmt
, ...);

3301 
	#bŒfs_´štk
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3302 
	`bŒfs_no_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
)

	)

3305 
	#bŒfs_em”g
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3306 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

3307 
	#bŒfs_®”t
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3308 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

3309 
	#bŒfs_ü™
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3310 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

3311 
	#bŒfs_”r
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3312 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

3313 
	#bŒfs_w¬n
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3314 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

3315 
	#bŒfs_nÙiû
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3316 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

3317 
	#bŒfs_šfo
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3318 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

3323 
	#bŒfs_em”g_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3324 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

3325 
	#bŒfs_®”t_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3326 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

3327 
	#bŒfs_ü™_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3328 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

3329 
	#bŒfs_”r_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3330 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

3331 
	#bŒfs_w¬n_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3332 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

3333 
	#bŒfs_nÙiû_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3334 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

3335 
	#bŒfs_šfo_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3336 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

3341 
	#bŒfs_em”g_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3342 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

3343 
	#bŒfs_®”t_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3344 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

3345 
	#bŒfs_ü™_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3346 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

3347 
	#bŒfs_”r_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3348 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

3349 
	#bŒfs_w¬n_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3350 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

3351 
	#bŒfs_nÙiû_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3352 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

3353 
	#bŒfs_šfo_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3354 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

3359 
	#bŒfs_em”g_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3360 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_EMERG
 
fmt
, ##
¬gs
)

	)

3361 
	#bŒfs_®”t_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3362 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_ALERT
 
fmt
, ##
¬gs
)

	)

3363 
	#bŒfs_ü™_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3364 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_CRIT
 
fmt
, ##
¬gs
)

	)

3365 
	#bŒfs_”r_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3366 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_ERR
 
fmt
, ##
¬gs
)

	)

3367 
	#bŒfs_w¬n_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3368 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_WARNING
 
fmt
, ##
¬gs
)

	)

3369 
	#bŒfs_nÙiû_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3370 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_NOTICE
 
fmt
, ##
¬gs
)

	)

3371 
	#bŒfs_šfo_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3372 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_INFO
 
fmt
, ##
¬gs
)

	)

3374 #ià
	`defšed
(
CONFIG_DYNAMIC_DEBUG
)

3375 
	#bŒfs_debug
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3377 
	`DEFINE_DYNAMIC_DEBUG_METADATA
(
desütÜ
, 
fmt
); \

3378 ià(
	`uÆik–y
(
desütÜ
.
æags
 & 
_DPRINTK_FLAGS_PRINT
)) \

3379 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
); \

3380 
	}
} 0)

	)

3381 
	#bŒfs_debug_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3383 
	`DEFINE_DYNAMIC_DEBUG_METADATA
(
desütÜ
, 
fmt
); \

3384 ià(
	`uÆik–y
(
desütÜ
.
æags
 & 
_DPRINTK_FLAGS_PRINT
)) \

3385 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
); \

3386 } 0)

	)

3387 
	#bŒfs_debug_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3389 
	`DEFINE_DYNAMIC_DEBUG_METADATA
(
desütÜ
, 
fmt
); \

3390 ià(
	`uÆik–y
(
desütÜ
.
æags
 & 
_DPRINTK_FLAGS_PRINT
)) \

3391 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, \

3392 ##
¬gs
);\

3393 } 0)

	)

3394 
	#bŒfs_debug_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3396 
	`DEFINE_DYNAMIC_DEBUG_METADATA
(
desütÜ
, 
fmt
); \

3397 ià(
	`uÆik–y
(
desütÜ
.
æags
 & 
_DPRINTK_FLAGS_PRINT
)) \

3398 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, \

3399 ##
¬gs
); \

3400 } 0)

	)

3401 #–ià
defšed
(
DEBUG
)

3402 
	#bŒfs_debug
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3403 
	`bŒfs_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3404 
	#bŒfs_debug_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3405 
	`bŒfs_´štk_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3406 
	#bŒfs_debug_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3407 
	`bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3408 
	#bŒfs_debug_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3409 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3411 
	#bŒfs_debug
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3412 
	`bŒfs_no_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3413 
	#bŒfs_debug_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3414 
	`bŒfs_no_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3415 
	#bŒfs_debug_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3416 
	`bŒfs_no_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3417 
	#bŒfs_debug_¾
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3418 
	`bŒfs_no_´štk
(
fs_šfo
, 
KERN_DEBUG
 
fmt
, ##
¬gs
)

	)

3421 
	#bŒfs_´štk_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3423 
	`rcu_»ad_lock
(); \

3424 
	`bŒfs_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
); \

3425 
	`rcu_»ad_uÆock
(); \

3426 } 0)

	)

3428 
	#bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3430 
	`DEFINE_RATELIMIT_STATE
(
_rs
, \

3431 
DEFAULT_RATELIMIT_INTERVAL
, \

3432 
DEFAULT_RATELIMIT_BURST
); \

3433 ià(
	`__¿‹lim™
(&
_rs
)) \

3434 
	`bŒfs_´štk
(
fs_šfo
, 
fmt
, ##
¬gs
); \

3435 } 0)

	)

3437 
	#bŒfs_´štk_¾_š_rcu
(
fs_šfo
, 
fmt
, 
¬gs
...) \

3439 
	`rcu_»ad_lock
(); \

3440 
	`bŒfs_´štk_¿‹lim™ed
(
fs_šfo
, 
fmt
, ##
¬gs
); \

3441 
	`rcu_»ad_uÆock
(); \

3442 } 0)

	)

3444 #ifdeà
CONFIG_BTRFS_ASSERT


3446 
__cÞd


3447 
šlše
 
	$assçž
(*
ex´
, *
fže
, 
lše
)

3449 
	`´_”r
("assertion failed: %s, file: %s,†ine: %d\n",

3450 
ex´
, 
fže
, 
lše
);

3451 
	`BUG
();

3452 
	}
}

3454 
	#ASSERT
(
ex´
) \

3455 (
	`lik–y
(
ex´
è? ()0 : 
	`assçž
(#ex´, 
__FILE__
, 
__LINE__
))

	)

3457 
	#ASSERT
(
ex´
è(()0)

	)

3460 
	$__´štf
(5, 6)

3461 
__cÞd


3462 
	`__bŒfs_hªdË_fs_”rÜ
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

3463 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...);

3465 cÚ¡ *
	`bŒfs_decode_”rÜ
(
”ºo
);

3467 
__cÞd


3468 
	`__bŒfs_abÜt_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3469 cÚ¡ *
funùiÚ
,

3470 
lše
, 
”ºo
);

3476 
	#bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”ºo
) \

3479 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_FS_STATE_TRANS_ABORTED
, \

3480 &((
Œªs
)->
fs_šfo
->
fs_¡©e
))) { \

3481 ià((
”ºo
è!ð-
EIO
) { \

3482 
	`WARN
(1, 
KERN_DEBUG
 \

3484 (
”ºo
)); \

3486 
	`bŒfs_debug
((
Œªs
)->
fs_šfo
, \

3488 (
”ºo
)); \

3491 
	`__bŒfs_abÜt_Œª§ùiÚ
((
Œªs
), 
__func__
, \

3492 
__LINE__
, (
”ºo
)); \

3493 
	}
} 0)

	)

3495 
	#bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”ºo
, 
fmt
, 
¬gs
...) \

3497 
	`__bŒfs_hªdË_fs_”rÜ
((
fs_šfo
), 
__func__
, 
__LINE__
, \

3498 (
”ºo
), 
fmt
, ##
¬gs
); \

3499 } 0)

	)

3501 
	$__´štf
(5, 6)

3502 
__cÞd


3503 
	`__bŒfs_·nic
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

3504 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...);

3509 
	#bŒfs_·nic
(
fs_šfo
, 
”ºo
, 
fmt
, 
¬gs
...) \

3511 
	`__bŒfs_·nic
(
fs_šfo
, 
__func__
, 
__LINE__
, 
”ºo
, 
fmt
, ##
¬gs
); \

3512 
	`BUG
(); \

3513 
	}
} 0)

	)

3518 
	#bŒfs_£t_fs_šcom·t
(
__fs_šfo
, 
Ýt
) \

3519 
	`__bŒfs_£t_fs_šcom·t
((
__fs_šfo
), 
BTRFS_FEATURE_INCOMPAT_
##
Ýt
)

	)

3521 
šlše
 
	$__bŒfs_£t_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
,

3522 
u64
 
æag
)

3524 
bŒfs_su³r_block
 *
disk_su³r
;

3525 
u64
 
ã©u»s
;

3527 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

3528 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

3529 ià(!(
ã©u»s
 & 
æag
)) {

3530 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

3531 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

3532 ià(!(
ã©u»s
 & 
æag
)) {

3533 
ã©u»s
 |ð
æag
;

3534 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

3535 
	`bŒfs_šfo
(
fs_šfo
, "setting %llu feature flag",

3536 
æag
);

3538 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

3540 
	}
}

3542 
	#bŒfs_þ—r_fs_šcom·t
(
__fs_šfo
, 
Ýt
) \

3543 
	`__bŒfs_þ—r_fs_šcom·t
((
__fs_šfo
), 
BTRFS_FEATURE_INCOMPAT_
##
Ýt
)

	)

3545 
šlše
 
	$__bŒfs_þ—r_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
,

3546 
u64
 
æag
)

3548 
bŒfs_su³r_block
 *
disk_su³r
;

3549 
u64
 
ã©u»s
;

3551 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

3552 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

3553 ià(
ã©u»s
 & 
æag
) {

3554 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

3555 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

3556 ià(
ã©u»s
 & 
æag
) {

3557 
ã©u»s
 &ð~
æag
;

3558 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

3559 
	`bŒfs_šfo
(
fs_šfo
, "clearing %llu feature flag",

3560 
æag
);

3562 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

3564 
	}
}

3566 
	#bŒfs_fs_šcom·t
(
fs_šfo
, 
Ýt
) \

3567 
	`__bŒfs_fs_šcom·t
((
fs_šfo
), 
BTRFS_FEATURE_INCOMPAT_
##
Ýt
)

	)

3569 
šlše
 
boÞ
 
	$__bŒfs_fs_šcom·t
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
)

3571 
bŒfs_su³r_block
 *
disk_su³r
;

3572 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

3573  !!(
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
è& 
æag
);

3574 
	}
}

3576 
	#bŒfs_£t_fs_com·t_ro
(
__fs_šfo
, 
Ýt
) \

3577 
	`__bŒfs_£t_fs_com·t_ro
((
__fs_šfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
Ýt
)

	)

3579 
šlše
 
	$__bŒfs_£t_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
,

3580 
u64
 
æag
)

3582 
bŒfs_su³r_block
 *
disk_su³r
;

3583 
u64
 
ã©u»s
;

3585 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

3586 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

3587 ià(!(
ã©u»s
 & 
æag
)) {

3588 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

3589 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

3590 ià(!(
ã©u»s
 & 
æag
)) {

3591 
ã©u»s
 |ð
æag
;

3592 
	`bŒfs_£t_su³r_com·t_ro_æags
(
disk_su³r
, 
ã©u»s
);

3593 
	`bŒfs_šfo
(
fs_šfo
, "setting %llu„o feature flag",

3594 
æag
);

3596 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

3598 
	}
}

3600 
	#bŒfs_þ—r_fs_com·t_ro
(
__fs_šfo
, 
Ýt
) \

3601 
	`__bŒfs_þ—r_fs_com·t_ro
((
__fs_šfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
Ýt
)

	)

3603 
šlše
 
	$__bŒfs_þ—r_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
,

3604 
u64
 
æag
)

3606 
bŒfs_su³r_block
 *
disk_su³r
;

3607 
u64
 
ã©u»s
;

3609 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

3610 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

3611 ià(
ã©u»s
 & 
æag
) {

3612 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

3613 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

3614 ià(
ã©u»s
 & 
æag
) {

3615 
ã©u»s
 &ð~
æag
;

3616 
	`bŒfs_£t_su³r_com·t_ro_æags
(
disk_su³r
, 
ã©u»s
);

3617 
	`bŒfs_šfo
(
fs_šfo
, "clearing %llu„o feature flag",

3618 
æag
);

3620 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

3622 
	}
}

3624 
	#bŒfs_fs_com·t_ro
(
fs_šfo
, 
Ýt
) \

3625 
	`__bŒfs_fs_com·t_ro
((
fs_šfo
), 
BTRFS_FEATURE_COMPAT_RO_
##
Ýt
)

	)

3627 
šlše
 
	$__bŒfs_fs_com·t_ro
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
)

3629 
bŒfs_su³r_block
 *
disk_su³r
;

3630 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

3631  !!(
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
è& 
æag
);

3632 
	}
}

3635 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


3636 
posix_aþ
 *
bŒfs_g‘_aþ
(
šode
 *šode, 
ty³
);

3637 
bŒfs_£t_aþ
(
šode
 *šode, 
posix_aþ
 *
aþ
, 
ty³
);

3638 
bŒfs_š™_aþ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3639 
šode
 *šode, šod*
dœ
);

3641 
	#bŒfs_g‘_aþ
 
NULL


	)

3642 
	#bŒfs_£t_aþ
 
NULL


	)

3643 
šlše
 
	$bŒfs_š™_aþ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3644 
šode
 *šode, šod*
dœ
)

3647 
	}
}

3651 
bŒfs_»loÿ‹_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
group_¡¬t
);

3652 
bŒfs_š™_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3653 
bŒfs_roÙ
 *
roÙ
);

3654 
bŒfs_upd©e_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3655 
bŒfs_roÙ
 *
roÙ
);

3656 
bŒfs_»cov”_»loÿtiÚ
(
bŒfs_roÙ
 *
roÙ
);

3657 
bŒfs_»loc_þÚe_csums
(
šode
 *šode, 
u64
 
fže_pos
, u64 
Ën
);

3658 
bŒfs_»loc_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3659 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

3660 
ex‹Á_bufãr
 *
cow
);

3661 
bŒfs_»loc_´e_¢­shÙ
(
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
,

3662 
u64
 *
by‹s_to_»£rve
);

3663 
bŒfs_»loc_po¡_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3664 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
);

3667 
bŒfs_süub_dev
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
, u64 
¡¬t
,

3668 
u64
 
’d
, 
bŒfs_süub_´og»ss
 *
´og»ss
,

3669 
»adÚly
, 
is_dev_»¶aû
);

3670 
bŒfs_süub_·u£
(
bŒfs_fs_šfo
 *
fs_šfo
);

3671 
bŒfs_süub_cÚtšue
(
bŒfs_fs_šfo
 *
fs_šfo
);

3672 
bŒfs_süub_ÿnûl
(
bŒfs_fs_šfo
 *
šfo
);

3673 
bŒfs_süub_ÿnûl_dev
(
bŒfs_fs_šfo
 *
šfo
,

3674 
bŒfs_deviû
 *
dev
);

3675 
bŒfs_süub_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

3676 
bŒfs_süub_´og»ss
 *
´og»ss
);

3677 
šlše
 
	$bŒfs_š™_fuÎ_¡re_locks_Œ“
(

3678 
bŒfs_fuÎ_¡re_locks_Œ“
 *
locks_roÙ
)

3680 
locks_roÙ
->
roÙ
 = 
RB_ROOT
;

3681 
	`mu‹x_š™
(&
locks_roÙ
->
lock
);

3682 
	}
}

3685 
bŒfs_bio_couÁ”_šc_blocked
(
bŒfs_fs_šfo
 *
fs_šfo
);

3686 
bŒfs_bio_couÁ”_šc_noblocked
(
bŒfs_fs_šfo
 *
fs_šfo
);

3687 
bŒfs_bio_couÁ”_sub
(
bŒfs_fs_šfo
 *
fs_šfo
, 
s64
 
amouÁ
);

3689 
šlše
 
	$bŒfs_bio_couÁ”_dec
(
bŒfs_fs_šfo
 *
fs_šfo
)

3691 
	`bŒfs_bio_couÁ”_sub
(
fs_šfo
, 1);

3692 
	}
}

3695 
	s»ada_cÚŒÞ
 {

3696 
bŒfs_fs_šfo
 *
	mfs_šfo
;

3697 
bŒfs_key
 
	mkey_¡¬t
;

3698 
bŒfs_key
 
	mkey_’d
;

3699 
©omic_t
 
	m–ems
;

3700 
k»f
 
	m»fút
;

3701 
wa™_queue_h—d_t
 
	mwa™
;

3703 
»ada_cÚŒÞ
 *
bŒfs_»ada_add
(
bŒfs_roÙ
 *
roÙ
,

3704 
bŒfs_key
 *
¡¬t
, bŒfs_key *
’d
);

3705 
bŒfs_»ada_wa™
(*
hªdË
);

3706 
bŒfs_»ada_d‘ach
(*
hªdË
);

3707 
bŒ“_»adah—d_hook
(
ex‹Á_bufãr
 *
eb
, 
”r
);

3709 
šlše
 
	$is_f¡»e
(
u64
 
roÙid
)

3711 ià(
roÙid
 =ð
BTRFS_FS_TREE_OBJECTID
 ||

3712 ((
s64
)
roÙid
 >ð(s64)
BTRFS_FIRST_FREE_OBJECTID
 &&

3713 !
	`bŒfs_qgroup_Ëv–
(
roÙid
)))

3716 
	}
}

3718 
šlše
 
	$bŒfs_deäag_ÿnûÎed
(
bŒfs_fs_šfo
 *
fs_šfo
)

3720  
	`sigÇl_³ndšg
(
cu¼’t
);

3721 
	}
}

3724 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3725 
bŒfs_‹¡_de¡roy_šode
(
šode
 *inode);

3728 
šlše
 
	$bŒfs_is_‹¡šg
(
bŒfs_fs_šfo
 *
fs_šfo
)

3730 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3731 ià(
	`uÆik–y
(
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
,

3732 &
fs_šfo
->
fs_¡©e
)))

3736 
	}
}

	@dedupe.h

19 #iâdeà
__BTRFS_DEDUPE__


20 
	#__BTRFS_DEDUPE__


	)

23 
	gbŒfs_dedu³_hash
;

	@delayed-inode.c

20 
	~<lšux/¦ab.h
>

21 
	~"d–ayed-šode.h
"

22 
	~"disk-io.h
"

23 
	~"Œª§ùiÚ.h
"

24 
	~"ù»e.h
"

26 
	#BTRFS_DELAYED_WRITEBACK
 512

	)

27 
	#BTRFS_DELAYED_BACKGROUND
 128

	)

28 
	#BTRFS_DELAYED_BATCH
 16

	)

30 
kmem_ÿche
 *
	gd–ayed_node_ÿche
;

32 
__š™
 
	$bŒfs_d–ayed_šode_š™
()

34 
d–ayed_node_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_delayed_node",

35 (
bŒfs_d–ayed_node
),

37 
SLAB_MEM_SPREAD
,

38 
NULL
);

39 ià(!
d–ayed_node_ÿche
)

40  -
ENOMEM
;

42 
	}
}

44 
	$bŒfs_d–ayed_šode_ex™
()

46 
	`kmem_ÿche_de¡roy
(
d–ayed_node_ÿche
);

47 
	}
}

49 
šlše
 
	$bŒfs_š™_d–ayed_node
(

50 
bŒfs_d–ayed_node
 *
d–ayed_node
,

51 
bŒfs_roÙ
 *
roÙ
, 
u64
 
šode_id
)

53 
d–ayed_node
->
roÙ
 =„oot;

54 
d–ayed_node
->
šode_id
 = inode_id;

55 
	`»fcouÁ_£t
(&
d–ayed_node
->
»fs
, 0);

56 
d–ayed_node
->
šs_roÙ
 = 
RB_ROOT
;

57 
d–ayed_node
->
d–_roÙ
 = 
RB_ROOT
;

58 
	`mu‹x_š™
(&
d–ayed_node
->
mu‹x
);

59 
	`INIT_LIST_HEAD
(&
d–ayed_node
->
n_li¡
);

60 
	`INIT_LIST_HEAD
(&
d–ayed_node
->
p_li¡
);

61 
	}
}

63 
šlše
 
	$bŒfs_is_cÚtšuous_d–ayed_™em
(

64 
bŒfs_d–ayed_™em
 *
™em1
,

65 
bŒfs_d–ayed_™em
 *
™em2
)

67 ià(
™em1
->
key
.
ty³
 =ð
BTRFS_DIR_INDEX_KEY
 &&

68 
™em1
->
key
.
objeùid
 =ð
™em2
->key.objectid &&

69 
™em1
->
key
.
ty³
 =ð
™em2
->key.type &&

70 
™em1
->
key
.
off£t
 + 1 =ð
™em2
->key.offset)

73 
	}
}

75 
bŒfs_d–ayed_node
 *
	$bŒfs_g‘_d–ayed_node
(

76 
bŒfs_šode
 *btrfs_inode)

78 
bŒfs_roÙ
 *
roÙ
 = 
bŒfs_šode
->root;

79 
u64
 
šo
 = 
	`bŒfs_šo
(
bŒfs_šode
);

80 
bŒfs_d–ayed_node
 *
node
;

82 
node
 = 
	`READ_ONCE
(
bŒfs_šode
->
d–ayed_node
);

83 ià(
node
) {

84 
	`»fcouÁ_šc
(&
node
->
»fs
);

85  
node
;

88 
	`¥š_lock
(&
roÙ
->
šode_lock
);

89 
node
 = 
	`¿dix_Œ“_lookup
(&
roÙ
->
d–ayed_nodes_Œ“
, 
šo
);

90 ià(
node
) {

91 ià(
bŒfs_šode
->
d–ayed_node
) {

92 
	`»fcouÁ_šc
(&
node
->
»fs
);

93 
	`BUG_ON
(
bŒfs_šode
->
d–ayed_node
 !ð
node
);

94 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

95  
node
;

97 
bŒfs_šode
->
d–ayed_node
 = 
node
;

99 
	`»fcouÁ_add
(2, &
node
->
»fs
);

100 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

101  
node
;

103 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

105  
NULL
;

106 
	}
}

109 
bŒfs_d–ayed_node
 *
	$bŒfs_g‘_Ü_ü—‹_d–ayed_node
(

110 
bŒfs_šode
 *btrfs_inode)

112 
bŒfs_d–ayed_node
 *
node
;

113 
bŒfs_roÙ
 *
roÙ
 = 
bŒfs_šode
->root;

114 
u64
 
šo
 = 
	`bŒfs_šo
(
bŒfs_šode
);

115 
»t
;

117 
agaš
:

118 
node
 = 
	`bŒfs_g‘_d–ayed_node
(
bŒfs_šode
);

119 ià(
node
)

120  
node
;

122 
node
 = 
	`kmem_ÿche_z®loc
(
d–ayed_node_ÿche
, 
GFP_NOFS
);

123 ià(!
node
)

124  
	`ERR_PTR
(-
ENOMEM
);

125 
	`bŒfs_š™_d–ayed_node
(
node
, 
roÙ
, 
šo
);

128 
	`»fcouÁ_£t
(&
node
->
»fs
, 2);

130 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

131 ià(
»t
) {

132 
	`kmem_ÿche_ä“
(
d–ayed_node_ÿche
, 
node
);

133  
	`ERR_PTR
(
»t
);

136 
	`¥š_lock
(&
roÙ
->
šode_lock
);

137 
»t
 = 
	`¿dix_Œ“_š£¹
(&
roÙ
->
d–ayed_nodes_Œ“
, 
šo
, 
node
);

138 ià(
»t
 =ð-
EEXIST
) {

139 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

140 
	`kmem_ÿche_ä“
(
d–ayed_node_ÿche
, 
node
);

141 
	`¿dix_Œ“_´–ßd_’d
();

142 
agaš
;

144 
bŒfs_šode
->
d–ayed_node
 = 
node
;

145 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

146 
	`¿dix_Œ“_´–ßd_’d
();

148  
node
;

149 
	}
}

156 
	$bŒfs_queue_d–ayed_node
(
bŒfs_d–ayed_roÙ
 *
roÙ
,

157 
bŒfs_d–ayed_node
 *
node
,

158 
mod
)

160 
	`¥š_lock
(&
roÙ
->
lock
);

161 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
)) {

162 ià(!
	`li¡_em±y
(&
node
->
p_li¡
))

163 
	`li¡_move_ž
(&
node
->
p_li¡
, &
roÙ
->
´•¬e_li¡
);

164 ià(
mod
)

165 
	`li¡_add_ž
(&
node
->
p_li¡
, &
roÙ
->
´•¬e_li¡
);

167 
	`li¡_add_ž
(&
node
->
n_li¡
, &
roÙ
->
node_li¡
);

168 
	`li¡_add_ž
(&
node
->
p_li¡
, &
roÙ
->
´•¬e_li¡
);

169 
	`»fcouÁ_šc
(&
node
->
»fs
);

170 
roÙ
->
nodes
++;

171 
	`£t_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
);

173 
	`¥š_uÆock
(&
roÙ
->
lock
);

174 
	}
}

177 
	$bŒfs_dequeue_d–ayed_node
(
bŒfs_d–ayed_roÙ
 *
roÙ
,

178 
bŒfs_d–ayed_node
 *
node
)

180 
	`¥š_lock
(&
roÙ
->
lock
);

181 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
)) {

182 
roÙ
->
nodes
--;

183 
	`»fcouÁ_dec
(&
node
->
»fs
);

184 
	`li¡_d–_š™
(&
node
->
n_li¡
);

185 ià(!
	`li¡_em±y
(&
node
->
p_li¡
))

186 
	`li¡_d–_š™
(&
node
->
p_li¡
);

187 
	`þ—r_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
);

189 
	`¥š_uÆock
(&
roÙ
->
lock
);

190 
	}
}

192 
bŒfs_d–ayed_node
 *
	$bŒfs_fœ¡_d–ayed_node
(

193 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

195 
li¡_h—d
 *
p
;

196 
bŒfs_d–ayed_node
 *
node
 = 
NULL
;

198 
	`¥š_lock
(&
d–ayed_roÙ
->
lock
);

199 ià(
	`li¡_em±y
(&
d–ayed_roÙ
->
node_li¡
))

200 
out
;

202 
p
 = 
d–ayed_roÙ
->
node_li¡
.
Ãxt
;

203 
node
 = 
	`li¡_’Œy
(
p
, 
bŒfs_d–ayed_node
, 
n_li¡
);

204 
	`»fcouÁ_šc
(&
node
->
»fs
);

205 
out
:

206 
	`¥š_uÆock
(&
d–ayed_roÙ
->
lock
);

208  
node
;

209 
	}
}

211 
bŒfs_d–ayed_node
 *
	$bŒfs_Ãxt_d–ayed_node
(

212 
bŒfs_d–ayed_node
 *
node
)

214 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

215 
li¡_h—d
 *
p
;

216 
bŒfs_d–ayed_node
 *
Ãxt
 = 
NULL
;

218 
d–ayed_roÙ
 = 
node
->
roÙ
->
fs_šfo
->delayed_root;

219 
	`¥š_lock
(&
d–ayed_roÙ
->
lock
);

220 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_IN_LIST
, &
node
->
æags
)) {

222 ià(
	`li¡_em±y
(&
d–ayed_roÙ
->
node_li¡
))

223 
out
;

224 
p
 = 
d–ayed_roÙ
->
node_li¡
.
Ãxt
;

225 } ià(
	`li¡_is_Ï¡
(&
node
->
n_li¡
, &
d–ayed_roÙ
->
node_li¡
))

226 
out
;

228 
p
 = 
node
->
n_li¡
.
Ãxt
;

230 
Ãxt
 = 
	`li¡_’Œy
(
p
, 
bŒfs_d–ayed_node
, 
n_li¡
);

231 
	`»fcouÁ_šc
(&
Ãxt
->
»fs
);

232 
out
:

233 
	`¥š_uÆock
(&
d–ayed_roÙ
->
lock
);

235  
Ãxt
;

236 
	}
}

238 
	$__bŒfs_»Ëa£_d–ayed_node
(

239 
bŒfs_d–ayed_node
 *
d–ayed_node
,

240 
mod
)

242 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

244 ià(!
d–ayed_node
)

247 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

249 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

250 ià(
d–ayed_node
->
couÁ
)

251 
	`bŒfs_queue_d–ayed_node
(
d–ayed_roÙ
, 
d–ayed_node
, 
mod
);

253 
	`bŒfs_dequeue_d–ayed_node
(
d–ayed_roÙ
, 
d–ayed_node
);

254 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

256 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
d–ayed_node
->
»fs
)) {

257 
boÞ
 
ä“
 = 
çl£
;

258 
bŒfs_roÙ
 *
roÙ
 = 
d–ayed_node
->root;

259 
	`¥š_lock
(&
roÙ
->
šode_lock
);

260 ià(
	`»fcouÁ_»ad
(&
d–ayed_node
->
»fs
) == 0) {

261 
	`¿dix_Œ“_d–‘e
(&
roÙ
->
d–ayed_nodes_Œ“
,

262 
d–ayed_node
->
šode_id
);

263 
ä“
 = 
Œue
;

265 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

266 ià(
ä“
)

267 
	`kmem_ÿche_ä“
(
d–ayed_node_ÿche
, 
d–ayed_node
);

269 
	}
}

271 
šlše
 
	$bŒfs_»Ëa£_d–ayed_node
(
bŒfs_d–ayed_node
 *
node
)

273 
	`__bŒfs_»Ëa£_d–ayed_node
(
node
, 0);

274 
	}
}

276 
bŒfs_d–ayed_node
 *
	$bŒfs_fœ¡_´•¬ed_d–ayed_node
(

277 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

279 
li¡_h—d
 *
p
;

280 
bŒfs_d–ayed_node
 *
node
 = 
NULL
;

282 
	`¥š_lock
(&
d–ayed_roÙ
->
lock
);

283 ià(
	`li¡_em±y
(&
d–ayed_roÙ
->
´•¬e_li¡
))

284 
out
;

286 
p
 = 
d–ayed_roÙ
->
´•¬e_li¡
.
Ãxt
;

287 
	`li¡_d–_š™
(
p
);

288 
node
 = 
	`li¡_’Œy
(
p
, 
bŒfs_d–ayed_node
, 
p_li¡
);

289 
	`»fcouÁ_šc
(&
node
->
»fs
);

290 
out
:

291 
	`¥š_uÆock
(&
d–ayed_roÙ
->
lock
);

293  
node
;

294 
	}
}

296 
šlše
 
	$bŒfs_»Ëa£_´•¬ed_d–ayed_node
(

297 
bŒfs_d–ayed_node
 *
node
)

299 
	`__bŒfs_»Ëa£_d–ayed_node
(
node
, 1);

300 
	}
}

302 
bŒfs_d–ayed_™em
 *
	$bŒfs_®loc_d–ayed_™em
(
u32
 
d©a_Ën
)

304 
bŒfs_d–ayed_™em
 *
™em
;

305 
™em
 = 
	`km®loc
((*™emè+ 
d©a_Ën
, 
GFP_NOFS
);

306 ià(
™em
) {

307 
™em
->
d©a_Ën
 = data_len;

308 
™em
->
šs_Ü_d–
 = 0;

309 
™em
->
by‹s_»£rved
 = 0;

310 
™em
->
d–ayed_node
 = 
NULL
;

311 
	`»fcouÁ_£t
(&
™em
->
»fs
, 1);

313  
™em
;

314 
	}
}

326 
bŒfs_d–ayed_™em
 *
	$__bŒfs_lookup_d–ayed_™em
(

327 
rb_roÙ
 *
roÙ
,

328 
bŒfs_key
 *
key
,

329 
bŒfs_d–ayed_™em
 **
´ev
,

330 
bŒfs_d–ayed_™em
 **
Ãxt
)

332 
rb_node
 *
node
, *
´ev_node
 = 
NULL
;

333 
bŒfs_d–ayed_™em
 *
d–ayed_™em
 = 
NULL
;

334 
»t
 = 0;

336 
node
 = 
roÙ
->
rb_node
;

338 
node
) {

339 
d–ayed_™em
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_™em
,

340 
rb_node
);

341 
´ev_node
 = 
node
;

342 
»t
 = 
	`bŒfs_comp_ýu_keys
(&
d–ayed_™em
->
key
, key);

343 ià(
»t
 < 0)

344 
node
 =‚ode->
rb_right
;

345 ià(
»t
 > 0)

346 
node
 =‚ode->
rb_Ëá
;

348  
d–ayed_™em
;

351 ià(
´ev
) {

352 ià(!
´ev_node
)

353 *
´ev
 = 
NULL
;

354 ià(
»t
 < 0)

355 *
´ev
 = 
d–ayed_™em
;

356 ià((
node
 = 
	`rb_´ev
(
´ev_node
)è!ð
NULL
) {

357 *
´ev
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_™em
,

358 
rb_node
);

360 *
´ev
 = 
NULL
;

363 ià(
Ãxt
) {

364 ià(!
´ev_node
)

365 *
Ãxt
 = 
NULL
;

366 ià(
»t
 > 0)

367 *
Ãxt
 = 
d–ayed_™em
;

368 ià((
node
 = 
	`rb_Ãxt
(
´ev_node
)è!ð
NULL
) {

369 *
Ãxt
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_™em
,

370 
rb_node
);

372 *
Ãxt
 = 
NULL
;

374  
NULL
;

375 
	}
}

377 
bŒfs_d–ayed_™em
 *
	$__bŒfs_lookup_d–ayed_š£¹iÚ_™em
(

378 
bŒfs_d–ayed_node
 *
d–ayed_node
,

379 
bŒfs_key
 *
key
)

381  
	`__bŒfs_lookup_d–ayed_™em
(&
d–ayed_node
->
šs_roÙ
, 
key
,

382 
NULL
, NULL);

383 
	}
}

385 
	$__bŒfs_add_d–ayed_™em
(
bŒfs_d–ayed_node
 *
d–ayed_node
,

386 
bŒfs_d–ayed_™em
 *
šs
,

387 
aùiÚ
)

389 
rb_node
 **
p
, *
node
;

390 
rb_node
 *
·»Á_node
 = 
NULL
;

391 
rb_roÙ
 *
roÙ
;

392 
bŒfs_d–ayed_™em
 *
™em
;

393 
cmp
;

395 ià(
aùiÚ
 =ð
BTRFS_DELAYED_INSERTION_ITEM
)

396 
roÙ
 = &
d–ayed_node
->
šs_roÙ
;

397 ià(
aùiÚ
 =ð
BTRFS_DELAYED_DELETION_ITEM
)

398 
roÙ
 = &
d–ayed_node
->
d–_roÙ
;

400 
	`BUG
();

401 
p
 = &
roÙ
->
rb_node
;

402 
node
 = &
šs
->
rb_node
;

404 *
p
) {

405 
·»Á_node
 = *
p
;

406 
™em
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_d–ayed_™em
,

407 
rb_node
);

409 
cmp
 = 
	`bŒfs_comp_ýu_keys
(&
™em
->
key
, &
šs
->key);

410 ià(
cmp
 < 0)

411 
p
 = &(*p)->
rb_right
;

412 ià(
cmp
 > 0)

413 
p
 = &(*p)->
rb_Ëá
;

415  -
EEXIST
;

418 
	`rb_lšk_node
(
node
, 
·»Á_node
, 
p
);

419 
	`rb_š£¹_cÞÜ
(
node
, 
roÙ
);

420 
šs
->
d–ayed_node
 = delayed_node;

421 
šs
->
šs_Ü_d–
 = 
aùiÚ
;

423 ià(
šs
->
key
.
ty³
 =ð
BTRFS_DIR_INDEX_KEY
 &&

424 
aùiÚ
 =ð
BTRFS_DELAYED_INSERTION_ITEM
 &&

425 
šs
->
key
.
off£t
 >ð
d–ayed_node
->
šdex_út
)

426 
d–ayed_node
->
šdex_út
 = 
šs
->
key
.
off£t
 + 1;

428 
d–ayed_node
->
couÁ
++;

429 
	`©omic_šc
(&
d–ayed_node
->
roÙ
->
fs_šfo
->
d–ayed_roÙ
->
™ems
);

431 
	}
}

433 
	$__bŒfs_add_d–ayed_š£¹iÚ_™em
(
bŒfs_d–ayed_node
 *
node
,

434 
bŒfs_d–ayed_™em
 *
™em
)

436  
	`__bŒfs_add_d–ayed_™em
(
node
, 
™em
,

437 
BTRFS_DELAYED_INSERTION_ITEM
);

438 
	}
}

440 
	$__bŒfs_add_d–ayed_d–‘iÚ_™em
(
bŒfs_d–ayed_node
 *
node
,

441 
bŒfs_d–ayed_™em
 *
™em
)

443  
	`__bŒfs_add_d–ayed_™em
(
node
, 
™em
,

444 
BTRFS_DELAYED_DELETION_ITEM
);

445 
	}
}

447 
	$fšish_Úe_™em
(
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

449 
£q
 = 
	`©omic_šc_»tuº
(&
d–ayed_roÙ
->
™ems_£q
);

454 ià((
	`©omic_dec_»tuº
(&
d–ayed_roÙ
->
™ems
) <

455 
BTRFS_DELAYED_BACKGROUND
 || 
£q
 % 
BTRFS_DELAYED_BATCH
 == 0) &&

456 
	`wa™queue_aùive
(&
d–ayed_roÙ
->
wa™
))

457 
	`wake_up
(&
d–ayed_roÙ
->
wa™
);

458 
	}
}

460 
	$__bŒfs_»move_d–ayed_™em
(
bŒfs_d–ayed_™em
 *
d–ayed_™em
)

462 
rb_roÙ
 *
roÙ
;

463 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

465 
d–ayed_roÙ
 = 
d–ayed_™em
->
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

467 
	`BUG_ON
(!
d–ayed_roÙ
);

468 
	`BUG_ON
(
d–ayed_™em
->
šs_Ü_d–
 !ð
BTRFS_DELAYED_DELETION_ITEM
 &&

469 
d–ayed_™em
->
šs_Ü_d–
 !ð
BTRFS_DELAYED_INSERTION_ITEM
);

471 ià(
d–ayed_™em
->
šs_Ü_d–
 =ð
BTRFS_DELAYED_INSERTION_ITEM
)

472 
roÙ
 = &
d–ayed_™em
->
d–ayed_node
->
šs_roÙ
;

474 
roÙ
 = &
d–ayed_™em
->
d–ayed_node
->
d–_roÙ
;

476 
	`rb_”a£
(&
d–ayed_™em
->
rb_node
, 
roÙ
);

477 
d–ayed_™em
->
d–ayed_node
->
couÁ
--;

479 
	`fšish_Úe_™em
(
d–ayed_roÙ
);

480 
	}
}

482 
	$bŒfs_»Ëa£_d–ayed_™em
(
bŒfs_d–ayed_™em
 *
™em
)

484 ià(
™em
) {

485 
	`__bŒfs_»move_d–ayed_™em
(
™em
);

486 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
™em
->
»fs
))

487 
	`kä“
(
™em
);

489 
	}
}

491 
bŒfs_d–ayed_™em
 *
	$__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(

492 
bŒfs_d–ayed_node
 *
d–ayed_node
)

494 
rb_node
 *
p
;

495 
bŒfs_d–ayed_™em
 *
™em
 = 
NULL
;

497 
p
 = 
	`rb_fœ¡
(&
d–ayed_node
->
šs_roÙ
);

498 ià(
p
)

499 
™em
 = 
	`rb_’Œy
(
p
, 
bŒfs_d–ayed_™em
, 
rb_node
);

501  
™em
;

502 
	}
}

504 
bŒfs_d–ayed_™em
 *
	$__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(

505 
bŒfs_d–ayed_node
 *
d–ayed_node
)

507 
rb_node
 *
p
;

508 
bŒfs_d–ayed_™em
 *
™em
 = 
NULL
;

510 
p
 = 
	`rb_fœ¡
(&
d–ayed_node
->
d–_roÙ
);

511 ià(
p
)

512 
™em
 = 
	`rb_’Œy
(
p
, 
bŒfs_d–ayed_™em
, 
rb_node
);

514  
™em
;

515 
	}
}

517 
bŒfs_d–ayed_™em
 *
	$__bŒfs_Ãxt_d–ayed_™em
(

518 
bŒfs_d–ayed_™em
 *
™em
)

520 
rb_node
 *
p
;

521 
bŒfs_d–ayed_™em
 *
Ãxt
 = 
NULL
;

523 
p
 = 
	`rb_Ãxt
(&
™em
->
rb_node
);

524 ià(
p
)

525 
Ãxt
 = 
	`rb_’Œy
(
p
, 
bŒfs_d–ayed_™em
, 
rb_node
);

527  
Ãxt
;

528 
	}
}

530 
	$bŒfs_d–ayed_™em_»£rve_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

531 
bŒfs_fs_šfo
 *
fs_šfo
,

532 
bŒfs_d–ayed_™em
 *
™em
)

534 
bŒfs_block_rsv
 *
¤c_rsv
;

535 
bŒfs_block_rsv
 *
d¡_rsv
;

536 
u64
 
num_by‹s
;

537 
»t
;

539 ià(!
Œªs
->
by‹s_»£rved
)

542 
¤c_rsv
 = 
Œªs
->
block_rsv
;

543 
d¡_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

545 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

546 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
¤c_rsv
, 
d¡_rsv
, 
num_by‹s
, 1);

547 ià(!
»t
) {

548 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_item",

549 
™em
->
key
.
objeùid
,

550 
num_by‹s
, 1);

551 
™em
->
by‹s_»£rved
 = 
num_by‹s
;

554  
»t
;

555 
	}
}

557 
	$bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
bŒfs_fs_šfo
 *
fs_šfo
,

558 
bŒfs_d–ayed_™em
 *
™em
)

560 
bŒfs_block_rsv
 *
rsv
;

562 ià(!
™em
->
by‹s_»£rved
)

565 
rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

566 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_item",

567 
™em
->
key
.
objeùid
, i‹m->
by‹s_»£rved
,

569 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
,

570 
™em
->
by‹s_»£rved
);

571 
	}
}

573 
	$bŒfs_d–ayed_šode_»£rve_m‘ad©a
(

574 
bŒfs_Œªs_hªdË
 *
Œªs
,

575 
bŒfs_roÙ
 *
roÙ
,

576 
bŒfs_šode
 *
šode
,

577 
bŒfs_d–ayed_node
 *
node
)

579 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

580 
bŒfs_block_rsv
 *
¤c_rsv
;

581 
bŒfs_block_rsv
 *
d¡_rsv
;

582 
u64
 
num_by‹s
;

583 
»t
;

584 
boÞ
 
»Ëa£
 = 
çl£
;

586 
¤c_rsv
 = 
Œªs
->
block_rsv
;

587 
d¡_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

589 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

604 ià(
¤c_rsv
 && src_rsv->
ty³
 =ð
BTRFS_BLOCK_RSV_DELALLOC
) {

605 
	`¥š_lock
(&
šode
->
lock
);

606 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_INODE_DELALLOC_META_RESERVED
,

607 &
šode
->
ruÁime_æags
))

608 
»Ëa£
 = 
Œue
;

610 
¤c_rsv
 = 
NULL
;

611 
	`¥š_uÆock
(&
šode
->
lock
);

623 ià(!
¤c_rsv
 || (!
Œªs
->
by‹s_»£rved
 &&

624 
¤c_rsv
->
ty³
 !ð
BTRFS_BLOCK_RSV_DELALLOC
)) {

625 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, 
d¡_rsv
, 
num_by‹s
,

626 
BTRFS_RESERVE_NO_FLUSH
);

633 ià(
»t
 =ð-
EAGAIN
)

634 
»t
 = -
ENOSPC
;

635 ià(!
»t
) {

636 
node
->
by‹s_»£rved
 = 
num_by‹s
;

637 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
,

639 
	`bŒfs_šo
(
šode
),

640 
num_by‹s
, 1);

642  
»t
;

645 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
¤c_rsv
, 
d¡_rsv
, 
num_by‹s
, 1);

660 ià(!
»t
) {

661 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_inode",

662 
	`bŒfs_šo
(
šode
), 
num_by‹s
, 1);

663 
node
->
by‹s_»£rved
 = 
num_by‹s
;

666 ià(
»Ëa£
) {

667 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delalloc",

668 
	`bŒfs_šo
(
šode
), 
num_by‹s
, 0);

669 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
¤c_rsv
, 
num_by‹s
);

672  
»t
;

673 
	}
}

675 
	$bŒfs_d–ayed_šode_»Ëa£_m‘ad©a
(
bŒfs_fs_šfo
 *
fs_šfo
,

676 
bŒfs_d–ayed_node
 *
node
)

678 
bŒfs_block_rsv
 *
rsv
;

680 ià(!
node
->
by‹s_»£rved
)

683 
rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

684 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delayed_inode",

685 
node
->
šode_id
,‚ode->
by‹s_»£rved
, 0);

686 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
,

687 
node
->
by‹s_»£rved
);

688 
node
->
by‹s_»£rved
 = 0;

689 
	}
}

695 
	$bŒfs_b©ch_š£¹_™ems
(
bŒfs_roÙ
 *
roÙ
,

696 
bŒfs_·th
 *
·th
,

697 
bŒfs_d–ayed_™em
 *
™em
)

699 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

700 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

701 
ä“_¥aû
;

702 
tÙ®_d©a_size
 = 0, 
tÙ®_size
 = 0;

703 
ex‹Á_bufãr
 *
Ëaf
;

704 *
d©a_±r
;

705 
bŒfs_key
 *
keys
;

706 
u32
 *
d©a_size
;

707 
li¡_h—d
 
h—d
;

708 
¦Ù
;

709 
n™ems
;

710 
i
;

711 
»t
 = 0;

713 
	`BUG_ON
(!
·th
->
nodes
[0]);

715 
Ëaf
 = 
·th
->
nodes
[0];

716 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
);

717 
	`INIT_LIST_HEAD
(&
h—d
);

719 
Ãxt
 = 
™em
;

720 
n™ems
 = 0;

725 
tÙ®_size
 + 
Ãxt
->
d©a_Ën
 + (
bŒfs_™em
) <=

726 
ä“_¥aû
) {

727 
tÙ®_d©a_size
 +ð
Ãxt
->
d©a_Ën
;

728 
tÙ®_size
 +ð
Ãxt
->
d©a_Ën
 + (
bŒfs_™em
);

729 
	`li¡_add_ž
(&
Ãxt
->
Œ“_li¡
, &
h—d
);

730 
n™ems
++;

732 
cu¼
 = 
Ãxt
;

733 
Ãxt
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
cu¼
);

734 ià(!
Ãxt
)

737 ià(!
	`bŒfs_is_cÚtšuous_d–ayed_™em
(
cu¼
, 
Ãxt
))

741 ià(!
n™ems
) {

742 
»t
 = 0;

743 
out
;

751 
	`bŒfs_£t_·th_blockšg
(
·th
);

753 
keys
 = 
	`km®loc_¬¿y
(
n™ems
, (
bŒfs_key
), 
GFP_NOFS
);

754 ià(!
keys
) {

755 
»t
 = -
ENOMEM
;

756 
out
;

759 
d©a_size
 = 
	`km®loc_¬¿y
(
n™ems
, (
u32
), 
GFP_NOFS
);

760 ià(!
d©a_size
) {

761 
»t
 = -
ENOMEM
;

762 
”rÜ
;

766 
i
 = 0;

767 
	`li¡_fÜ_—ch_’Œy
(
Ãxt
, &
h—d
, 
Œ“_li¡
) {

768 
keys
[
i
] = 
Ãxt
->
key
;

769 
d©a_size
[
i
] = 
Ãxt
->
d©a_Ën
;

770 
i
++;

774 
	`bŒfs_þ—r_·th_blockšg
(
·th
, 
NULL
, 0);

777 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, 
·th
, 
keys
, 
d©a_size
,

778 
tÙ®_d©a_size
, 
tÙ®_size
, 
n™ems
);

781 
¦Ù
 = 
·th
->
¦Ùs
[0];

782 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
h—d
, 
Œ“_li¡
) {

783 
d©a_±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, );

784 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, &
cu¼
->
d©a
,

785 ()
d©a_±r
,

786 
cu¼
->
d©a_Ën
);

787 
¦Ù
++;

789 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
fs_šfo
, 
cu¼
);

791 
	`li¡_d–
(&
cu¼
->
Œ“_li¡
);

792 
	`bŒfs_»Ëa£_d–ayed_™em
(
cu¼
);

795 
”rÜ
:

796 
	`kä“
(
d©a_size
);

797 
	`kä“
(
keys
);

798 
out
:

799  
»t
;

800 
	}
}

806 
	$bŒfs_š£¹_d–ayed_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

807 
bŒfs_roÙ
 *
roÙ
,

808 
bŒfs_·th
 *
·th
,

809 
bŒfs_d–ayed_™em
 *
d–ayed_™em
)

811 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

812 
ex‹Á_bufãr
 *
Ëaf
;

813 *
±r
;

814 
»t
;

816 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
d–ayed_™em
->
key
,

817 
d–ayed_™em
->
d©a_Ën
);

818 ià(
»t
 < 0 &&„‘ !ð-
EEXIST
)

819  
»t
;

821 
Ëaf
 = 
·th
->
nodes
[0];

823 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

825 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
d–ayed_™em
->
d©a
, ()
±r
,

826 
d–ayed_™em
->
d©a_Ën
);

827 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

829 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
fs_šfo
, 
d–ayed_™em
);

831 
	}
}

837 
	$bŒfs_š£¹_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

838 
bŒfs_·th
 *
·th
,

839 
bŒfs_roÙ
 *
roÙ
,

840 
bŒfs_d–ayed_node
 *
node
)

842 
bŒfs_d–ayed_™em
 *
cu¼
, *
´ev
;

843 
»t
 = 0;

845 
do_agaš
:

846 
	`mu‹x_lock
(&
node
->
mu‹x
);

847 
cu¼
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
node
);

848 ià(!
cu¼
)

849 
š£¹_’d
;

851 
»t
 = 
	`bŒfs_š£¹_d–ayed_™em
(
Œªs
, 
roÙ
, 
·th
, 
cu¼
);

852 ià(
»t
 < 0) {

853 
	`bŒfs_»Ëa£_·th
(
·th
);

854 
š£¹_’d
;

857 
´ev
 = 
cu¼
;

858 
cu¼
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
´ev
);

859 ià(
cu¼
 && 
	`bŒfs_is_cÚtšuous_d–ayed_™em
(
´ev
, curr)) {

861 
·th
->
¦Ùs
[0]++;

862 
	`bŒfs_b©ch_š£¹_™ems
(
roÙ
, 
·th
, 
cu¼
);

864 
	`bŒfs_»Ëa£_d–ayed_™em
(
´ev
);

865 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

867 
	`bŒfs_»Ëa£_·th
(
·th
);

868 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

869 
do_agaš
;

871 
š£¹_’d
:

872 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

873  
»t
;

874 
	}
}

876 
	$bŒfs_b©ch_d–‘e_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

877 
bŒfs_roÙ
 *
roÙ
,

878 
bŒfs_·th
 *
·th
,

879 
bŒfs_d–ayed_™em
 *
™em
)

881 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

882 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

883 
ex‹Á_bufãr
 *
Ëaf
;

884 
bŒfs_key
 
key
;

885 
li¡_h—d
 
h—d
;

886 
n™ems
, 
i
, 
Ï¡_™em
;

887 
»t
 = 0;

889 
	`BUG_ON
(!
·th
->
nodes
[0]);

891 
Ëaf
 = 
·th
->
nodes
[0];

893 
i
 = 
·th
->
¦Ùs
[0];

894 
Ï¡_™em
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) - 1;

895 ià(
i
 > 
Ï¡_™em
)

896  -
ENOENT
;

898 
Ãxt
 = 
™em
;

899 
	`INIT_LIST_HEAD
(&
h—d
);

900 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
i
);

901 
n™ems
 = 0;

905 
	`bŒfs_comp_ýu_keys
(&
Ãxt
->
key
, &key) == 0) {

906 
	`li¡_add_ž
(&
Ãxt
->
Œ“_li¡
, &
h—d
);

907 
n™ems
++;

909 
cu¼
 = 
Ãxt
;

910 
Ãxt
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
cu¼
);

911 ià(!
Ãxt
)

914 ià(!
	`bŒfs_is_cÚtšuous_d–ayed_™em
(
cu¼
, 
Ãxt
))

917 
i
++;

918 ià(
i
 > 
Ï¡_™em
)

920 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
i
);

923 ià(!
n™ems
)

926 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
n™ems
);

927 ià(
»t
)

928 
out
;

930 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
h—d
, 
Œ“_li¡
) {

931 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
fs_šfo
, 
cu¼
);

932 
	`li¡_d–
(&
cu¼
->
Œ“_li¡
);

933 
	`bŒfs_»Ëa£_d–ayed_™em
(
cu¼
);

936 
out
:

937  
»t
;

938 
	}
}

940 
	$bŒfs_d–‘e_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

941 
bŒfs_·th
 *
·th
,

942 
bŒfs_roÙ
 *
roÙ
,

943 
bŒfs_d–ayed_node
 *
node
)

945 
bŒfs_d–ayed_™em
 *
cu¼
, *
´ev
;

946 
»t
 = 0;

948 
do_agaš
:

949 
	`mu‹x_lock
(&
node
->
mu‹x
);

950 
cu¼
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
node
);

951 ià(!
cu¼
)

952 
d–‘e_çž
;

954 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
cu¼
->
key
, 
·th
, -1, 1);

955 ià(
»t
 < 0)

956 
d–‘e_çž
;

957 ià(
»t
 > 0) {

962 
´ev
 = 
cu¼
;

963 
cu¼
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
´ev
);

964 
	`bŒfs_»Ëa£_d–ayed_™em
(
´ev
);

965 
»t
 = 0;

966 
	`bŒfs_»Ëa£_·th
(
·th
);

967 ià(
cu¼
) {

968 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

969 
do_agaš
;

971 
d–‘e_çž
;

974 
	`bŒfs_b©ch_d–‘e_™ems
(
Œªs
, 
roÙ
, 
·th
, 
cu¼
);

975 
	`bŒfs_»Ëa£_·th
(
·th
);

976 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

977 
do_agaš
;

979 
d–‘e_çž
:

980 
	`bŒfs_»Ëa£_·th
(
·th
);

981 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

982  
»t
;

983 
	}
}

985 
	$bŒfs_»Ëa£_d–ayed_šode
(
bŒfs_d–ayed_node
 *
d–ayed_node
)

987 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

989 ià(
d–ayed_node
 &&

990 
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

991 
	`BUG_ON
(!
d–ayed_node
->
roÙ
);

992 
	`þ—r_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
);

993 
d–ayed_node
->
couÁ
--;

995 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

996 
	`fšish_Úe_™em
(
d–ayed_roÙ
);

998 
	}
}

1000 
	$bŒfs_»Ëa£_d–ayed_œef
(
bŒfs_d–ayed_node
 *
d–ayed_node
)

1002 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

1004 
	`ASSERT
(
d–ayed_node
->
roÙ
);

1005 
	`þ—r_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
);

1006 
d–ayed_node
->
couÁ
--;

1008 
d–ayed_roÙ
 = 
d–ayed_node
->
roÙ
->
fs_šfo
->delayed_root;

1009 
	`fšish_Úe_™em
(
d–ayed_roÙ
);

1010 
	}
}

1012 
	$__bŒfs_upd©e_d–ayed_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1013 
bŒfs_roÙ
 *
roÙ
,

1014 
bŒfs_·th
 *
·th
,

1015 
bŒfs_d–ayed_node
 *
node
)

1017 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1018 
bŒfs_key
 
key
;

1019 
bŒfs_šode_™em
 *
šode_™em
;

1020 
ex‹Á_bufãr
 *
Ëaf
;

1021 
mod
;

1022 
»t
;

1024 
key
.
objeùid
 = 
node
->
šode_id
;

1025 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

1026 
key
.
off£t
 = 0;

1028 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
node
->
æags
))

1029 
mod
 = -1;

1031 
mod
 = 1;

1033 
»t
 = 
	`bŒfs_lookup_šode
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
mod
);

1034 ià(
»t
 > 0) {

1035 
	`bŒfs_»Ëa£_·th
(
·th
);

1036  -
ENOENT
;

1037 } ià(
»t
 < 0) {

1038  
»t
;

1041 
Ëaf
 = 
·th
->
nodes
[0];

1042 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1043 
bŒfs_šode_™em
);

1044 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, &
node
->
šode_™em
, ()inode_item,

1045 (
bŒfs_šode_™em
));

1046 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1048 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
node
->
æags
))

1049 
no_œef
;

1051 
·th
->
¦Ùs
[0]++;

1052 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

1053 
£¬ch
;

1054 
agaš
:

1055 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1056 ià(
key
.
objeùid
 !ð
node
->
šode_id
)

1057 
out
;

1059 ià(
key
.
ty³
 !ð
BTRFS_INODE_REF_KEY
 &&

1060 
key
.
ty³
 !ð
BTRFS_INODE_EXTREF_KEY
)

1061 
out
;

1068 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1069 
out
:

1070 
	`bŒfs_»Ëa£_d–ayed_œef
(
node
);

1071 
no_œef
:

1072 
	`bŒfs_»Ëa£_·th
(
·th
);

1073 
”r_out
:

1074 
	`bŒfs_d–ayed_šode_»Ëa£_m‘ad©a
(
fs_šfo
, 
node
);

1075 
	`bŒfs_»Ëa£_d–ayed_šode
(
node
);

1077  
»t
;

1079 
£¬ch
:

1080 
	`bŒfs_»Ëa£_·th
(
·th
);

1082 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1083 
key
.
off£t
 = -1;

1084 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1085 ià(
»t
 < 0)

1086 
”r_out
;

1087 
	`ASSERT
(
»t
);

1089 
»t
 = 0;

1090 
Ëaf
 = 
·th
->
nodes
[0];

1091 
·th
->
¦Ùs
[0]--;

1092 
agaš
;

1093 
	}
}

1095 
šlše
 
	$bŒfs_upd©e_d–ayed_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1096 
bŒfs_roÙ
 *
roÙ
,

1097 
bŒfs_·th
 *
·th
,

1098 
bŒfs_d–ayed_node
 *
node
)

1100 
»t
;

1102 
	`mu‹x_lock
(&
node
->
mu‹x
);

1103 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
node
->
æags
)) {

1104 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1108 
»t
 = 
	`__bŒfs_upd©e_d–ayed_šode
(
Œªs
, 
roÙ
, 
·th
, 
node
);

1109 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1110  
»t
;

1111 
	}
}

1113 
šlše
 

1114 
	$__bŒfs_comm™_šode_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1115 
bŒfs_·th
 *
·th
,

1116 
bŒfs_d–ayed_node
 *
node
)

1118 
»t
;

1120 
»t
 = 
	`bŒfs_š£¹_d–ayed_™ems
(
Œªs
, 
·th
, 
node
->
roÙ
,‚ode);

1121 ià(
»t
)

1122  
»t
;

1124 
»t
 = 
	`bŒfs_d–‘e_d–ayed_™ems
(
Œªs
, 
·th
, 
node
->
roÙ
,‚ode);

1125 ià(
»t
)

1126  
»t
;

1128 
»t
 = 
	`bŒfs_upd©e_d–ayed_šode
(
Œªs
, 
node
->
roÙ
, 
·th
,‚ode);

1129  
»t
;

1130 
	}
}

1138 
	$__bŒfs_run_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1139 
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
)

1141 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

1142 
bŒfs_d–ayed_node
 *
cu¼_node
, *
´ev_node
;

1143 
bŒfs_·th
 *
·th
;

1144 
bŒfs_block_rsv
 *
block_rsv
;

1145 
»t
 = 0;

1146 
boÞ
 
couÁ
 = (
Ä
 > 0);

1148 ià(
Œªs
->
abÜ‹d
)

1149  -
EIO
;

1151 
·th
 = 
	`bŒfs_®loc_·th
();

1152 ià(!
·th
)

1153  -
ENOMEM
;

1154 
·th
->
Ëave_¥šnšg
 = 1;

1156 
block_rsv
 = 
Œªs
->block_rsv;

1157 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

1159 
d–ayed_roÙ
 = 
fs_šfo
->delayed_root;

1161 
cu¼_node
 = 
	`bŒfs_fœ¡_d–ayed_node
(
d–ayed_roÙ
);

1162 
cu¼_node
 && (!
couÁ
 || (couÁ && 
Ä
--))) {

1163 
»t
 = 
	`__bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
·th
,

1164 
cu¼_node
);

1165 ià(
»t
) {

1166 
	`bŒfs_»Ëa£_d–ayed_node
(
cu¼_node
);

1167 
cu¼_node
 = 
NULL
;

1168 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1172 
´ev_node
 = 
cu¼_node
;

1173 
cu¼_node
 = 
	`bŒfs_Ãxt_d–ayed_node
(curr_node);

1174 
	`bŒfs_»Ëa£_d–ayed_node
(
´ev_node
);

1177 ià(
cu¼_node
)

1178 
	`bŒfs_»Ëa£_d–ayed_node
(
cu¼_node
);

1179 
	`bŒfs_ä“_·th
(
·th
);

1180 
Œªs
->
block_rsv
 = block_rsv;

1182  
»t
;

1183 
	}
}

1185 
	$bŒfs_run_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1186 
bŒfs_fs_šfo
 *
fs_šfo
)

1188  
	`__bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
, -1);

1189 
	}
}

1191 
	$bŒfs_run_d–ayed_™ems_Ä
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1192 
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
)

1194  
	`__bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
, 
Ä
);

1195 
	}
}

1197 
	$bŒfs_comm™_šode_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1198 
bŒfs_šode
 *
šode
)

1200 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

1201 
bŒfs_·th
 *
·th
;

1202 
bŒfs_block_rsv
 *
block_rsv
;

1203 
»t
;

1205 ià(!
d–ayed_node
)

1208 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1209 ià(!
d–ayed_node
->
couÁ
) {

1210 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1211 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1214 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1216 
·th
 = 
	`bŒfs_®loc_·th
();

1217 ià(!
·th
) {

1218 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1219  -
ENOMEM
;

1221 
·th
->
Ëave_¥šnšg
 = 1;

1223 
block_rsv
 = 
Œªs
->block_rsv;

1224 
Œªs
->
block_rsv
 = &
d–ayed_node
->
roÙ
->
fs_šfo
->
d–ayed_block_rsv
;

1226 
»t
 = 
	`__bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
·th
, 
d–ayed_node
);

1228 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1229 
	`bŒfs_ä“_·th
(
·th
);

1230 
Œªs
->
block_rsv
 = block_rsv;

1232  
»t
;

1233 
	}
}

1235 
	$bŒfs_comm™_šode_d–ayed_šode
(
bŒfs_šode
 *
šode
)

1237 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1238 
bŒfs_Œªs_hªdË
 *
Œªs
;

1239 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

1240 
bŒfs_·th
 *
·th
;

1241 
bŒfs_block_rsv
 *
block_rsv
;

1242 
»t
;

1244 ià(!
d–ayed_node
)

1247 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1248 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1249 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1250 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1253 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1255 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
d–ayed_node
->
roÙ
);

1256 ià(
	`IS_ERR
(
Œªs
)) {

1257 
»t
 = 
	`PTR_ERR
(
Œªs
);

1258 
out
;

1261 
·th
 = 
	`bŒfs_®loc_·th
();

1262 ià(!
·th
) {

1263 
»t
 = -
ENOMEM
;

1264 
Œªs_out
;

1266 
·th
->
Ëave_¥šnšg
 = 1;

1268 
block_rsv
 = 
Œªs
->block_rsv;

1269 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

1271 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1272 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
))

1273 
»t
 = 
	`__bŒfs_upd©e_d–ayed_šode
(
Œªs
, 
d–ayed_node
->
roÙ
,

1274 
·th
, 
d–ayed_node
);

1276 
»t
 = 0;

1277 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1279 
	`bŒfs_ä“_·th
(
·th
);

1280 
Œªs
->
block_rsv
 = block_rsv;

1281 
Œªs_out
:

1282 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1283 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

1284 
out
:

1285 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1287  
»t
;

1288 
	}
}

1290 
	$bŒfs_»move_d–ayed_node
(
bŒfs_šode
 *
šode
)

1292 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1294 
d–ayed_node
 = 
	`READ_ONCE
(
šode
->delayed_node);

1295 ià(!
d–ayed_node
)

1298 
šode
->
d–ayed_node
 = 
NULL
;

1299 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1300 
	}
}

1302 
	sbŒfs_async_d–ayed_wÜk
 {

1303 
bŒfs_d–ayed_roÙ
 *
	md–ayed_roÙ
;

1304 
	mÄ
;

1305 
bŒfs_wÜk
 
	mwÜk
;

1308 
	$bŒfs_async_run_d–ayed_roÙ
(
bŒfs_wÜk
 *
wÜk
)

1310 
bŒfs_async_d–ayed_wÜk
 *
async_wÜk
;

1311 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
;

1312 
bŒfs_Œªs_hªdË
 *
Œªs
;

1313 
bŒfs_·th
 *
·th
;

1314 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
NULL
;

1315 
bŒfs_roÙ
 *
roÙ
;

1316 
bŒfs_block_rsv
 *
block_rsv
;

1317 
tÙ®_dÚe
 = 0;

1319 
async_wÜk
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_async_d–ayed_wÜk
, work);

1320 
d–ayed_roÙ
 = 
async_wÜk
->delayed_root;

1322 
·th
 = 
	`bŒfs_®loc_·th
();

1323 ià(!
·th
)

1324 
out
;

1326 
agaš
:

1327 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è< 
BTRFS_DELAYED_BACKGROUND
 / 2)

1328 
ä“_·th
;

1330 
d–ayed_node
 = 
	`bŒfs_fœ¡_´•¬ed_d–ayed_node
(
d–ayed_roÙ
);

1331 ià(!
d–ayed_node
)

1332 
ä“_·th
;

1334 
·th
->
Ëave_¥šnšg
 = 1;

1335 
roÙ
 = 
d–ayed_node
->root;

1337 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

1338 ià(
	`IS_ERR
(
Œªs
))

1339 
»Ëa£_·th
;

1341 
block_rsv
 = 
Œªs
->block_rsv;

1342 
Œªs
->
block_rsv
 = &
roÙ
->
fs_šfo
->
d–ayed_block_rsv
;

1344 
	`__bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
·th
, 
d–ayed_node
);

1346 
Œªs
->
block_rsv
 = block_rsv;

1347 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1348 
	`bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
roÙ
->
fs_šfo
);

1350 
»Ëa£_·th
:

1351 
	`bŒfs_»Ëa£_·th
(
·th
);

1352 
tÙ®_dÚe
++;

1354 
	`bŒfs_»Ëa£_´•¬ed_d–ayed_node
(
d–ayed_node
);

1355 ià((
async_wÜk
->
Ä
 =ð0 && 
tÙ®_dÚe
 < 
BTRFS_DELAYED_WRITEBACK
) ||

1356 
tÙ®_dÚe
 < 
async_wÜk
->
Ä
)

1357 
agaš
;

1359 
ä“_·th
:

1360 
	`bŒfs_ä“_·th
(
·th
);

1361 
out
:

1362 
	`wake_up
(&
d–ayed_roÙ
->
wa™
);

1363 
	`kä“
(
async_wÜk
);

1364 
	}
}

1367 
	$bŒfs_wq_run_d–ayed_node
(
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
,

1368 
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
)

1370 
bŒfs_async_d–ayed_wÜk
 *
async_wÜk
;

1372 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è< 
BTRFS_DELAYED_BACKGROUND
 ||

1373 
	`bŒfs_wÜkqueue_nÜm®_cÚge¡ed
(
fs_šfo
->
d–ayed_wÜk”s
))

1376 
async_wÜk
 = 
	`km®loc
((*async_wÜk), 
GFP_NOFS
);

1377 ià(!
async_wÜk
)

1378  -
ENOMEM
;

1380 
async_wÜk
->
d–ayed_roÙ
 = delayed_root;

1381 
	`bŒfs_š™_wÜk
(&
async_wÜk
->
wÜk
, 
bŒfs_d–ayed_m‘a_h–³r
,

1382 
bŒfs_async_run_d–ayed_roÙ
, 
NULL
, NULL);

1383 
async_wÜk
->
Ä
 =‚r;

1385 
	`bŒfs_queue_wÜk
(
fs_šfo
->
d–ayed_wÜk”s
, &
async_wÜk
->
wÜk
);

1387 
	}
}

1389 
	$bŒfs_as£¹_d–ayed_roÙ_em±y
(
bŒfs_fs_šfo
 *
fs_šfo
)

1391 
	`WARN_ON
(
	`bŒfs_fœ¡_d–ayed_node
(
fs_šfo
->
d–ayed_roÙ
));

1392 
	}
}

1394 
	$could_’d_wa™
(
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
, 
£q
)

1396 
v®
 = 
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems_£q
);

1398 ià(
v®
 < 
£q
 || v® >ð£q + 
BTRFS_DELAYED_BATCH
)

1401 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è< 
BTRFS_DELAYED_BACKGROUND
)

1405 
	}
}

1407 
	$bŒfs_b®ªû_d–ayed_™ems
(
bŒfs_fs_šfo
 *
fs_šfo
)

1409 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
 = 
fs_šfo
->delayed_root;

1411 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è< 
BTRFS_DELAYED_BACKGROUND
)

1414 ià(
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems
è>ð
BTRFS_DELAYED_WRITEBACK
) {

1415 
£q
;

1416 
»t
;

1418 
£q
 = 
	`©omic_»ad
(&
d–ayed_roÙ
->
™ems_£q
);

1420 
»t
 = 
	`bŒfs_wq_run_d–ayed_node
(
d–ayed_roÙ
, 
fs_šfo
, 0);

1421 ià(
»t
)

1424 
	`wa™_ev’t_š‹¼u±ibË
(
d–ayed_roÙ
->
wa™
,

1425 
	`could_’d_wa™
(
d–ayed_roÙ
, 
£q
));

1429 
	`bŒfs_wq_run_d–ayed_node
(
d–ayed_roÙ
, 
fs_šfo
, 
BTRFS_DELAYED_BATCH
);

1430 
	}
}

1433 
	$bŒfs_š£¹_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1434 
bŒfs_fs_šfo
 *
fs_šfo
,

1435 cÚ¡ *
Çme
, 
Çme_Ën
,

1436 
bŒfs_šode
 *
dœ
,

1437 
bŒfs_disk_key
 *
disk_key
, 
u8
 
ty³
,

1438 
u64
 
šdex
)

1440 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1441 
bŒfs_d–ayed_™em
 *
d–ayed_™em
;

1442 
bŒfs_dœ_™em
 *
dœ_™em
;

1443 
»t
;

1445 
d–ayed_node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
dœ
);

1446 ià(
	`IS_ERR
(
d–ayed_node
))

1447  
	`PTR_ERR
(
d–ayed_node
);

1449 
d–ayed_™em
 = 
	`bŒfs_®loc_d–ayed_™em
((*
dœ_™em
è+ 
Çme_Ën
);

1450 ià(!
d–ayed_™em
) {

1451 
»t
 = -
ENOMEM
;

1452 
»Ëa£_node
;

1455 
d–ayed_™em
->
key
.
objeùid
 = 
	`bŒfs_šo
(
dœ
);

1456 
d–ayed_™em
->
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

1457 
d–ayed_™em
->
key
.
off£t
 = 
šdex
;

1459 
dœ_™em
 = (
bŒfs_dœ_™em
 *)
d–ayed_™em
->
d©a
;

1460 
dœ_™em
->
loÿtiÚ
 = *
disk_key
;

1461 
	`bŒfs_£t_¡ack_dœ_Œªsid
(
dœ_™em
, 
Œªs
->
Œªsid
);

1462 
	`bŒfs_£t_¡ack_dœ_d©a_Ën
(
dœ_™em
, 0);

1463 
	`bŒfs_£t_¡ack_dœ_Çme_Ën
(
dœ_™em
, 
Çme_Ën
);

1464 
	`bŒfs_£t_¡ack_dœ_ty³
(
dœ_™em
, 
ty³
);

1465 
	`memýy
((*)(
dœ_™em
 + 1), 
Çme
, 
Çme_Ën
);

1467 
»t
 = 
	`bŒfs_d–ayed_™em_»£rve_m‘ad©a
(
Œªs
, 
fs_šfo
, 
d–ayed_™em
);

1472 
	`BUG_ON
(
»t
);

1475 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1476 
»t
 = 
	`__bŒfs_add_d–ayed_š£¹iÚ_™em
(
d–ayed_node
, 
d–ayed_™em
);

1477 ià(
	`uÆik–y
(
»t
)) {

1478 
	`bŒfs_”r
(
fs_šfo
,

1480 
Çme_Ën
, 
Çme
, 
d–ayed_node
->
roÙ
->
objeùid
,

1481 
d–ayed_node
->
šode_id
, 
»t
);

1482 
	`BUG
();

1484 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1486 
»Ëa£_node
:

1487 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1488  
»t
;

1489 
	}
}

1491 
	$bŒfs_d–‘e_d–ayed_š£¹iÚ_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

1492 
bŒfs_d–ayed_node
 *
node
,

1493 
bŒfs_key
 *
key
)

1495 
bŒfs_d–ayed_™em
 *
™em
;

1497 
	`mu‹x_lock
(&
node
->
mu‹x
);

1498 
™em
 = 
	`__bŒfs_lookup_d–ayed_š£¹iÚ_™em
(
node
, 
key
);

1499 ià(!
™em
) {

1500 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1504 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
fs_šfo
, 
™em
);

1505 
	`bŒfs_»Ëa£_d–ayed_™em
(
™em
);

1506 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1508 
	}
}

1510 
	$bŒfs_d–‘e_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1511 
bŒfs_fs_šfo
 *
fs_šfo
,

1512 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
)

1514 
bŒfs_d–ayed_node
 *
node
;

1515 
bŒfs_d–ayed_™em
 *
™em
;

1516 
bŒfs_key
 
™em_key
;

1517 
»t
;

1519 
node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
dœ
);

1520 ià(
	`IS_ERR
(
node
))

1521  
	`PTR_ERR
(
node
);

1523 
™em_key
.
objeùid
 = 
	`bŒfs_šo
(
dœ
);

1524 
™em_key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

1525 
™em_key
.
off£t
 = 
šdex
;

1527 
»t
 = 
	`bŒfs_d–‘e_d–ayed_š£¹iÚ_™em
(
fs_šfo
, 
node
, &
™em_key
);

1528 ià(!
»t
)

1529 
’d
;

1531 
™em
 = 
	`bŒfs_®loc_d–ayed_™em
(0);

1532 ià(!
™em
) {

1533 
»t
 = -
ENOMEM
;

1534 
’d
;

1537 
™em
->
key
 = 
™em_key
;

1539 
»t
 = 
	`bŒfs_d–ayed_™em_»£rve_m‘ad©a
(
Œªs
, 
fs_šfo
, 
™em
);

1544 
	`BUG_ON
(
»t
);

1546 
	`mu‹x_lock
(&
node
->
mu‹x
);

1547 
»t
 = 
	`__bŒfs_add_d–ayed_d–‘iÚ_™em
(
node
, 
™em
);

1548 ià(
	`uÆik–y
(
»t
)) {

1549 
	`bŒfs_”r
(
fs_šfo
,

1551 
šdex
, 
node
->
roÙ
->
objeùid
,‚ode->
šode_id
, 
»t
);

1552 
	`BUG
();

1554 
	`mu‹x_uÆock
(&
node
->
mu‹x
);

1555 
’d
:

1556 
	`bŒfs_»Ëa£_d–ayed_node
(
node
);

1557  
»t
;

1558 
	}
}

1560 
	$bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
bŒfs_šode
 *
šode
)

1562 
bŒfs_d–ayed_node
 *
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

1564 ià(!
d–ayed_node
)

1565  -
ENOENT
;

1572 ià(!
d–ayed_node
->
šdex_út
) {

1573 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1574  -
EINVAL
;

1577 
šode
->
šdex_út
 = 
d–ayed_node
->index_cnt;

1578 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1580 
	}
}

1582 
boÞ
 
	$bŒfs_»addœ_g‘_d–ayed_™ems
(
šode
 *inode,

1583 
li¡_h—d
 *
šs_li¡
,

1584 
li¡_h—d
 *
d–_li¡
)

1586 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1587 
bŒfs_d–ayed_™em
 *
™em
;

1589 
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
	`BTRFS_I
(
šode
));

1590 ià(!
d–ayed_node
)

1591  
çl£
;

1597 
	`šode_uÆock_sh¬ed
(
šode
);

1598 
	`šode_lock
(
šode
);

1600 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1601 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
d–ayed_node
);

1602 
™em
) {

1603 
	`»fcouÁ_šc
(&
™em
->
»fs
);

1604 
	`li¡_add_ž
(&
™em
->
»addœ_li¡
, 
šs_li¡
);

1605 
™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(item);

1608 
™em
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
d–ayed_node
);

1609 
™em
) {

1610 
	`»fcouÁ_šc
(&
™em
->
»fs
);

1611 
	`li¡_add_ž
(&
™em
->
»addœ_li¡
, 
d–_li¡
);

1612 
™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(item);

1614 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1624 
	`»fcouÁ_dec
(&
d–ayed_node
->
»fs
);

1626  
Œue
;

1627 
	}
}

1629 
	$bŒfs_»addœ_put_d–ayed_™ems
(
šode
 *inode,

1630 
li¡_h—d
 *
šs_li¡
,

1631 
li¡_h—d
 *
d–_li¡
)

1633 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

1635 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
šs_li¡
, 
»addœ_li¡
) {

1636 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1637 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1638 
	`kä“
(
cu¼
);

1641 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
d–_li¡
, 
»addœ_li¡
) {

1642 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1643 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1644 
	`kä“
(
cu¼
);

1651 
	`downg¿de_wr™e
(&
šode
->
i_rw£m
);

1652 
	}
}

1654 
	$bŒfs_should_d–‘e_dœ_šdex
(
li¡_h—d
 *
d–_li¡
,

1655 
u64
 
šdex
)

1657 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

1658 
»t
;

1660 ià(
	`li¡_em±y
(
d–_li¡
))

1663 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
d–_li¡
, 
»addœ_li¡
) {

1664 ià(
cu¼
->
key
.
off£t
 > 
šdex
)

1667 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1668 
»t
 = (
cu¼
->
key
.
off£t
 =ð
šdex
);

1670 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1671 
	`kä“
(
cu¼
);

1673 ià(
»t
)

1679 
	}
}

1685 
	$bŒfs_»addœ_d–ayed_dœ_šdex
(
dœ_cÚ‹xt
 *
ùx
,

1686 
li¡_h—d
 *
šs_li¡
)

1688 
bŒfs_dœ_™em
 *
di
;

1689 
bŒfs_d–ayed_™em
 *
cu¼
, *
Ãxt
;

1690 
bŒfs_key
 
loÿtiÚ
;

1691 *
Çme
;

1692 
Çme_Ën
;

1693 
ov”
 = 0;

1694 
d_ty³
;

1696 ià(
	`li¡_em±y
(
šs_li¡
))

1704 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, 
šs_li¡
, 
»addœ_li¡
) {

1705 
	`li¡_d–
(&
cu¼
->
»addœ_li¡
);

1707 ià(
cu¼
->
key
.
off£t
 < 
ùx
->
pos
) {

1708 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1709 
	`kä“
(
cu¼
);

1713 
ùx
->
pos
 = 
cu¼
->
key
.
off£t
;

1715 
di
 = (
bŒfs_dœ_™em
 *)
cu¼
->
d©a
;

1716 
Çme
 = (*)(
di
 + 1);

1717 
Çme_Ën
 = 
	`bŒfs_¡ack_dœ_Çme_Ën
(
di
);

1719 
d_ty³
 = 
bŒfs_fž‘y³_bË
[
di
->
ty³
];

1720 
	`bŒfs_disk_key_to_ýu
(&
loÿtiÚ
, &
di
->location);

1722 
ov”
 = !
	`dœ_em™
(
ùx
, 
Çme
, 
Çme_Ën
,

1723 
loÿtiÚ
.
objeùid
, 
d_ty³
);

1725 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
cu¼
->
»fs
))

1726 
	`kä“
(
cu¼
);

1728 ià(
ov”
)

1730 
ùx
->
pos
++;

1733 
	}
}

1735 
	$fžl_¡ack_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1736 
bŒfs_šode_™em
 *
šode_™em
,

1737 
šode
 *inode)

1739 
	`bŒfs_£t_¡ack_šode_uid
(
šode_™em
, 
	`i_uid_»ad
(
šode
));

1740 
	`bŒfs_£t_¡ack_šode_gid
(
šode_™em
, 
	`i_gid_»ad
(
šode
));

1741 
	`bŒfs_£t_¡ack_šode_size
(
šode_™em
, 
	`BTRFS_I
(
šode
)->
disk_i_size
);

1742 
	`bŒfs_£t_¡ack_šode_mode
(
šode_™em
, 
šode
->
i_mode
);

1743 
	`bŒfs_£t_¡ack_šode_Æšk
(
šode_™em
, 
šode
->
i_Æšk
);

1744 
	`bŒfs_£t_¡ack_šode_nby‹s
(
šode_™em
, 
	`šode_g‘_by‹s
(
šode
));

1745 
	`bŒfs_£t_¡ack_šode_g’”©iÚ
(
šode_™em
,

1746 
	`BTRFS_I
(
šode
)->
g’”©iÚ
);

1747 
	`bŒfs_£t_¡ack_šode_£qu’û
(
šode_™em
, 
šode
->
i_v”siÚ
);

1748 
	`bŒfs_£t_¡ack_šode_Œªsid
(
šode_™em
, 
Œªs
->
Œªsid
);

1749 
	`bŒfs_£t_¡ack_šode_rdev
(
šode_™em
, 
šode
->
i_rdev
);

1750 
	`bŒfs_£t_¡ack_šode_æags
(
šode_™em
, 
	`BTRFS_I
(
šode
)->
æags
);

1751 
	`bŒfs_£t_¡ack_šode_block_group
(
šode_™em
, 0);

1753 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
©ime
,

1754 
šode
->
i_©ime
.
tv_£c
);

1755 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
©ime
,

1756 
šode
->
i_©ime
.
tv_n£c
);

1758 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
mtime
,

1759 
šode
->
i_mtime
.
tv_£c
);

1760 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
mtime
,

1761 
šode
->
i_mtime
.
tv_n£c
);

1763 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
ùime
,

1764 
šode
->
i_ùime
.
tv_£c
);

1765 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
ùime
,

1766 
šode
->
i_ùime
.
tv_n£c
);

1768 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
šode_™em
->
Ùime
,

1769 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
);

1770 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
šode_™em
->
Ùime
,

1771 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
);

1772 
	}
}

1774 
	$bŒfs_fžl_šode
(
šode
 *šode, 
u32
 *
rdev
)

1776 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1777 
bŒfs_šode_™em
 *
šode_™em
;

1779 
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
	`BTRFS_I
(
šode
));

1780 ià(!
d–ayed_node
)

1781  -
ENOENT
;

1783 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1784 ià(!
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1785 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1786 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1787  -
ENOENT
;

1790 
šode_™em
 = &
d–ayed_node
->inode_item;

1792 
	`i_uid_wr™e
(
šode
, 
	`bŒfs_¡ack_šode_uid
(
šode_™em
));

1793 
	`i_gid_wr™e
(
šode
, 
	`bŒfs_¡ack_šode_gid
(
šode_™em
));

1794 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
	`bŒfs_¡ack_šode_size
(
šode_™em
));

1795 
šode
->
i_mode
 = 
	`bŒfs_¡ack_šode_mode
(
šode_™em
);

1796 
	`£t_Æšk
(
šode
, 
	`bŒfs_¡ack_šode_Æšk
(
šode_™em
));

1797 
	`šode_£t_by‹s
(
šode
, 
	`bŒfs_¡ack_šode_nby‹s
(
šode_™em
));

1798 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
	`bŒfs_¡ack_šode_g’”©iÚ
(
šode_™em
);

1799 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
	`bŒfs_¡ack_šode_Œªsid
(
šode_™em
);

1801 
šode
->
i_v”siÚ
 = 
	`bŒfs_¡ack_šode_£qu’û
(
šode_™em
);

1802 
šode
->
i_rdev
 = 0;

1803 *
rdev
 = 
	`bŒfs_¡ack_šode_rdev
(
šode_™em
);

1804 
	`BTRFS_I
(
šode
)->
æags
 = 
	`bŒfs_¡ack_šode_æags
(
šode_™em
);

1806 
šode
->
i_©ime
.
tv_£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
©ime
);

1807 
šode
->
i_©ime
.
tv_n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
©ime
);

1809 
šode
->
i_mtime
.
tv_£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
mtime
);

1810 
šode
->
i_mtime
.
tv_n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
mtime
);

1812 
šode
->
i_ùime
.
tv_£c
 = 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
ùime
);

1813 
šode
->
i_ùime
.
tv_n£c
 = 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
ùime
);

1815 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
 =

1816 
	`bŒfs_¡ack_time¥ec_£c
(&
šode_™em
->
Ùime
);

1817 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
 =

1818 
	`bŒfs_¡ack_time¥ec_n£c
(&
šode_™em
->
Ùime
);

1820 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

1821 
	`BTRFS_I
(
šode
)->
šdex_út
 = (
u64
)-1;

1823 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1824 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1826 
	}
}

1828 
	$bŒfs_d–ayed_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1829 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode)

1831 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1832 
»t
 = 0;

1834 
d–ayed_node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
	`BTRFS_I
(
šode
));

1835 ià(
	`IS_ERR
(
d–ayed_node
))

1836  
	`PTR_ERR
(
d–ayed_node
);

1838 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1839 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1840 
	`fžl_¡ack_šode_™em
(
Œªs
, &
d–ayed_node
->
šode_™em
, 
šode
);

1841 
»Ëa£_node
;

1844 
»t
 = 
	`bŒfs_d–ayed_šode_»£rve_m‘ad©a
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
šode
),

1845 
d–ayed_node
);

1846 ià(
»t
)

1847 
»Ëa£_node
;

1849 
	`fžl_¡ack_šode_™em
(
Œªs
, &
d–ayed_node
->
šode_™em
, 
šode
);

1850 
	`£t_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
);

1851 
d–ayed_node
->
couÁ
++;

1852 
	`©omic_šc
(&
roÙ
->
fs_šfo
->
d–ayed_roÙ
->
™ems
);

1853 
»Ëa£_node
:

1854 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1855 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1856  
»t
;

1857 
	}
}

1859 
	$bŒfs_d–ayed_d–‘e_šode_»f
(
bŒfs_šode
 *
šode
)

1861 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1862 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1869 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

1870  -
EAGAIN
;

1872 
d–ayed_node
 = 
	`bŒfs_g‘_Ü_ü—‹_d–ayed_node
(
šode
);

1873 ià(
	`IS_ERR
(
d–ayed_node
))

1874  
	`PTR_ERR
(
d–ayed_node
);

1890 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1891 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
))

1892 
»Ëa£_node
;

1894 
	`£t_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
);

1895 
d–ayed_node
->
couÁ
++;

1896 
	`©omic_šc
(&
fs_šfo
->
d–ayed_roÙ
->
™ems
);

1897 
»Ëa£_node
:

1898 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1899 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1901 
	}
}

1903 
	$__bŒfs_kžl_d–ayed_node
(
bŒfs_d–ayed_node
 *
d–ayed_node
)

1905 
bŒfs_roÙ
 *
roÙ
 = 
d–ayed_node
->root;

1906 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1907 
bŒfs_d–ayed_™em
 *
cu¼_™em
, *
´ev_™em
;

1909 
	`mu‹x_lock
(&
d–ayed_node
->
mu‹x
);

1910 
cu¼_™em
 = 
	`__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
(
d–ayed_node
);

1911 
cu¼_™em
) {

1912 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
fs_šfo
, 
cu¼_™em
);

1913 
´ev_™em
 = 
cu¼_™em
;

1914 
cu¼_™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
´ev_™em
);

1915 
	`bŒfs_»Ëa£_d–ayed_™em
(
´ev_™em
);

1918 
cu¼_™em
 = 
	`__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
(
d–ayed_node
);

1919 
cu¼_™em
) {

1920 
	`bŒfs_d–ayed_™em_»Ëa£_m‘ad©a
(
fs_šfo
, 
cu¼_™em
);

1921 
´ev_™em
 = 
cu¼_™em
;

1922 
cu¼_™em
 = 
	`__bŒfs_Ãxt_d–ayed_™em
(
´ev_™em
);

1923 
	`bŒfs_»Ëa£_d–ayed_™em
(
´ev_™em
);

1926 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_DEL_IREF
, &
d–ayed_node
->
æags
))

1927 
	`bŒfs_»Ëa£_d–ayed_œef
(
d–ayed_node
);

1929 ià(
	`‹¡_b™
(
BTRFS_DELAYED_NODE_INODE_DIRTY
, &
d–ayed_node
->
æags
)) {

1930 
	`bŒfs_d–ayed_šode_»Ëa£_m‘ad©a
(
fs_šfo
, 
d–ayed_node
);

1931 
	`bŒfs_»Ëa£_d–ayed_šode
(
d–ayed_node
);

1933 
	`mu‹x_uÆock
(&
d–ayed_node
->
mu‹x
);

1934 
	}
}

1936 
	$bŒfs_kžl_d–ayed_šode_™ems
(
bŒfs_šode
 *
šode
)

1938 
bŒfs_d–ayed_node
 *
d–ayed_node
;

1940 
d–ayed_node
 = 
	`bŒfs_g‘_d–ayed_node
(
šode
);

1941 ià(!
d–ayed_node
)

1944 
	`__bŒfs_kžl_d–ayed_node
(
d–ayed_node
);

1945 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_node
);

1946 
	}
}

1948 
	$bŒfs_kžl_®l_d–ayed_nodes
(
bŒfs_roÙ
 *
roÙ
)

1950 
u64
 
šode_id
 = 0;

1951 
bŒfs_d–ayed_node
 *
d–ayed_nodes
[8];

1952 
i
, 
n
;

1955 
	`¥š_lock
(&
roÙ
->
šode_lock
);

1956 
n
 = 
	`¿dix_Œ“_gªg_lookup
(&
roÙ
->
d–ayed_nodes_Œ“
,

1957 (**)
d–ayed_nodes
, 
šode_id
,

1958 
	`ARRAY_SIZE
(
d–ayed_nodes
));

1959 ià(!
n
) {

1960 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

1964 
šode_id
 = 
d–ayed_nodes
[
n
 - 1]->inode_id + 1;

1966 
i
 = 0; i < 
n
; i++)

1967 
	`»fcouÁ_šc
(&
d–ayed_nodes
[
i
]->
»fs
);

1968 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

1970 
i
 = 0; i < 
n
; i++) {

1971 
	`__bŒfs_kžl_d–ayed_node
(
d–ayed_nodes
[
i
]);

1972 
	`bŒfs_»Ëa£_d–ayed_node
(
d–ayed_nodes
[
i
]);

1975 
	}
}

1977 
	$bŒfs_de¡roy_d–ayed_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

1979 
bŒfs_d–ayed_node
 *
cu¼_node
, *
´ev_node
;

1981 
cu¼_node
 = 
	`bŒfs_fœ¡_d–ayed_node
(
fs_šfo
->
d–ayed_roÙ
);

1982 
cu¼_node
) {

1983 
	`__bŒfs_kžl_d–ayed_node
(
cu¼_node
);

1985 
´ev_node
 = 
cu¼_node
;

1986 
cu¼_node
 = 
	`bŒfs_Ãxt_d–ayed_node
(curr_node);

1987 
	`bŒfs_»Ëa£_d–ayed_node
(
´ev_node
);

1989 
	}
}

	@delayed-inode.h

20 #iâdeà
__DELAYED_TREE_OPERATION_H


21 
	#__DELAYED_TREE_OPERATION_H


	)

23 
	~<lšux/rbŒ“.h
>

24 
	~<lšux/¥šlock.h
>

25 
	~<lšux/mu‹x.h
>

26 
	~<lšux/li¡.h
>

27 
	~<lšux/wa™.h
>

28 
	~<lšux/©omic.h
>

29 
	~<lšux/»fcouÁ.h
>

30 
	~"ù»e.h
"

33 
	#BTRFS_DELAYED_INSERTION_ITEM
 1

	)

34 
	#BTRFS_DELAYED_DELETION_ITEM
 2

	)

36 
	sbŒfs_d–ayed_roÙ
 {

37 
¥šlock_t
 
	mlock
;

38 
li¡_h—d
 
	mnode_li¡
;

44 
li¡_h—d
 
	m´•¬e_li¡
;

45 
©omic_t
 
	m™ems
;

46 
©omic_t
 
	m™ems_£q
;

47 
	mnodes
;

48 
wa™_queue_h—d_t
 
	mwa™
;

51 
	#BTRFS_DELAYED_NODE_IN_LIST
 0

	)

52 
	#BTRFS_DELAYED_NODE_INODE_DIRTY
 1

	)

53 
	#BTRFS_DELAYED_NODE_DEL_IREF
 2

	)

55 
	sbŒfs_d–ayed_node
 {

56 
u64
 
	mšode_id
;

57 
u64
 
	mby‹s_»£rved
;

58 
bŒfs_roÙ
 *
	mroÙ
;

60 
li¡_h—d
 
	mn_li¡
;

65 
li¡_h—d
 
	mp_li¡
;

66 
rb_roÙ
 
	mšs_roÙ
;

67 
rb_roÙ
 
	md–_roÙ
;

68 
mu‹x
 
	mmu‹x
;

69 
bŒfs_šode_™em
 
	mšode_™em
;

70 
»fcouÁ_t
 
	m»fs
;

71 
u64
 
	mšdex_út
;

72 
	mæags
;

73 
	mcouÁ
;

76 
	sbŒfs_d–ayed_™em
 {

77 
rb_node
 
	mrb_node
;

78 
bŒfs_key
 
	mkey
;

79 
li¡_h—d
 
	mŒ“_li¡
;

80 
li¡_h—d
 
	m»addœ_li¡
;

81 
u64
 
	mby‹s_»£rved
;

82 
bŒfs_d–ayed_node
 *
	md–ayed_node
;

83 
»fcouÁ_t
 
	m»fs
;

84 
	mšs_Ü_d–
;

85 
u32
 
	md©a_Ën
;

86 
	md©a
[0];

89 
šlše
 
	$bŒfs_š™_d–ayed_roÙ
(

90 
bŒfs_d–ayed_roÙ
 *
d–ayed_roÙ
)

92 
	`©omic_£t
(&
d–ayed_roÙ
->
™ems
, 0);

93 
	`©omic_£t
(&
d–ayed_roÙ
->
™ems_£q
, 0);

94 
d–ayed_roÙ
->
nodes
 = 0;

95 
	`¥š_lock_š™
(&
d–ayed_roÙ
->
lock
);

96 
	`š™_wa™queue_h—d
(&
d–ayed_roÙ
->
wa™
);

97 
	`INIT_LIST_HEAD
(&
d–ayed_roÙ
->
node_li¡
);

98 
	`INIT_LIST_HEAD
(&
d–ayed_roÙ
->
´•¬e_li¡
);

99 
	}
}

101 
bŒfs_š£¹_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

102 
bŒfs_fs_šfo
 *
fs_šfo
,

103 cÚ¡ *
Çme
, 
Çme_Ën
,

104 
bŒfs_šode
 *
dœ
,

105 
bŒfs_disk_key
 *
disk_key
, 
u8
 
ty³
,

106 
u64
 
šdex
);

108 
bŒfs_d–‘e_d–ayed_dœ_šdex
(
bŒfs_Œªs_hªdË
 *
Œªs
,

109 
bŒfs_fs_šfo
 *
fs_šfo
,

110 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
);

112 
bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
bŒfs_šode
 *
šode
);

114 
bŒfs_run_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

115 
bŒfs_fs_šfo
 *
fs_šfo
);

116 
bŒfs_run_d–ayed_™ems_Ä
(
bŒfs_Œªs_hªdË
 *
Œªs
,

117 
bŒfs_fs_šfo
 *
fs_šfo
, 
Ä
);

119 
bŒfs_b®ªû_d–ayed_™ems
(
bŒfs_fs_šfo
 *
fs_šfo
);

121 
bŒfs_comm™_šode_d–ayed_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

122 
bŒfs_šode
 *
šode
);

124 
bŒfs_»move_d–ayed_node
(
bŒfs_šode
 *
šode
);

125 
bŒfs_kžl_d–ayed_šode_™ems
(
bŒfs_šode
 *
šode
);

126 
bŒfs_comm™_šode_d–ayed_šode
(
bŒfs_šode
 *
šode
);

129 
bŒfs_d–ayed_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

130 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode);

131 
bŒfs_fžl_šode
(
šode
 *šode, 
u32
 *
rdev
);

132 
bŒfs_d–ayed_d–‘e_šode_»f
(
bŒfs_šode
 *
šode
);

135 
bŒfs_kžl_®l_d–ayed_nodes
(
bŒfs_roÙ
 *
roÙ
);

138 
bŒfs_de¡roy_d–ayed_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
);

141 
boÞ
 
bŒfs_»addœ_g‘_d–ayed_™ems
(
šode
 *inode,

142 
li¡_h—d
 *
šs_li¡
,

143 
li¡_h—d
 *
d–_li¡
);

144 
bŒfs_»addœ_put_d–ayed_™ems
(
šode
 *inode,

145 
li¡_h—d
 *
šs_li¡
,

146 
li¡_h—d
 *
d–_li¡
);

147 
bŒfs_should_d–‘e_dœ_šdex
(
li¡_h—d
 *
d–_li¡
,

148 
u64
 
šdex
);

149 
bŒfs_»addœ_d–ayed_dœ_šdex
(
dœ_cÚ‹xt
 *
ùx
,

150 
li¡_h—d
 *
šs_li¡
);

153 
__š™
 
bŒfs_d–ayed_šode_š™
();

154 
bŒfs_d–ayed_šode_ex™
();

157 
bŒfs_as£¹_d–ayed_roÙ_em±y
(
bŒfs_fs_šfo
 *
fs_šfo
);

	@delayed-ref.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/sÜt.h
>

22 
	~"ù»e.h
"

23 
	~"d–ayed-»f.h
"

24 
	~"Œª§ùiÚ.h
"

25 
	~"qgroup.h
"

27 
kmem_ÿche
 *
	gbŒfs_d–ayed_»f_h—d_ÿch•
;

28 
kmem_ÿche
 *
	gbŒfs_d–ayed_Œ“_»f_ÿch•
;

29 
kmem_ÿche
 *
	gbŒfs_d–ayed_d©a_»f_ÿch•
;

30 
kmem_ÿche
 *
	gbŒfs_d–ayed_ex‹Á_Ý_ÿch•
;

43 
	$comp_Œ“_»fs
(
bŒfs_d–ayed_Œ“_»f
 *
»f2
,

44 
bŒfs_d–ayed_Œ“_»f
 *
»f1
, 
ty³
)

46 ià(
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
) {

47 ià(
»f1
->
roÙ
 < 
»f2
->root)

49 ià(
»f1
->
roÙ
 > 
»f2
->root)

52 ià(
»f1
->
·»Á
 < 
»f2
->parent)

54 ià(
»f1
->
·»Á
 > 
»f2
->parent)

58 
	}
}

63 
	$comp_d©a_»fs
(
bŒfs_d–ayed_d©a_»f
 *
»f2
,

64 
bŒfs_d–ayed_d©a_»f
 *
»f1
)

66 ià(
»f1
->
node
.
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

67 ià(
»f1
->
roÙ
 < 
»f2
->root)

69 ià(
»f1
->
roÙ
 > 
»f2
->root)

71 ià(
»f1
->
objeùid
 < 
»f2
->objectid)

73 ià(
»f1
->
objeùid
 > 
»f2
->objectid)

75 ià(
»f1
->
off£t
 < 
»f2
->offset)

77 ià(
»f1
->
off£t
 > 
»f2
->offset)

80 ià(
»f1
->
·»Á
 < 
»f2
->parent)

82 ià(
»f1
->
·»Á
 > 
»f2
->parent)

86 
	}
}

89 
bŒfs_d–ayed_»f_h—d
 *
	$hŒ“_š£¹
(
rb_roÙ
 *
roÙ
,

90 
rb_node
 *
node
)

92 
rb_node
 **
p
 = &
roÙ
->rb_node;

93 
rb_node
 *
·»Á_node
 = 
NULL
;

94 
bŒfs_d–ayed_»f_h—d
 *
’Œy
;

95 
bŒfs_d–ayed_»f_h—d
 *
šs
;

96 
u64
 
by‹Ä
;

98 
šs
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
, 
h»f_node
);

99 
by‹Ä
 = 
šs
->
node
.bytenr;

100 *
p
) {

101 
·»Á_node
 = *
p
;

102 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_d–ayed_»f_h—d
,

103 
h»f_node
);

105 ià(
by‹Ä
 < 
’Œy
->
node
.bytenr)

106 
p
 = &(*p)->
rb_Ëá
;

107 ià(
by‹Ä
 > 
’Œy
->
node
.bytenr)

108 
p
 = &(*p)->
rb_right
;

110  
’Œy
;

113 
	`rb_lšk_node
(
node
, 
·»Á_node
, 
p
);

114 
	`rb_š£¹_cÞÜ
(
node
, 
roÙ
);

115  
NULL
;

116 
	}
}

124 
bŒfs_d–ayed_»f_h—d
 *

125 
	$fšd_»f_h—d
(
rb_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

126 
»tuº_bigg”
)

128 
rb_node
 *
n
;

129 
bŒfs_d–ayed_»f_h—d
 *
’Œy
;

131 
n
 = 
roÙ
->
rb_node
;

132 
’Œy
 = 
NULL
;

133 
n
) {

134 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_h—d
, 
h»f_node
);

136 ià(
by‹Ä
 < 
’Œy
->
node
.bytenr)

137 
n
 =‚->
rb_Ëá
;

138 ià(
by‹Ä
 > 
’Œy
->
node
.bytenr)

139 
n
 =‚->
rb_right
;

141  
’Œy
;

143 ià(
’Œy
 && 
»tuº_bigg”
) {

144 ià(
by‹Ä
 > 
’Œy
->
node
.bytenr) {

145 
n
 = 
	`rb_Ãxt
(&
’Œy
->
h»f_node
);

146 ià(!
n
)

147 
n
 = 
	`rb_fœ¡
(
roÙ
);

148 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_h—d
,

149 
h»f_node
);

150  
’Œy
;

152  
’Œy
;

154  
NULL
;

155 
	}
}

157 
	$bŒfs_d–ayed_»f_lock
(
bŒfs_Œªs_hªdË
 *
Œªs
,

158 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

160 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

162 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

163 
	`as£¹_¥š_locked
(&
d–ayed_»fs
->
lock
);

164 ià(
	`mu‹x_Œylock
(&
h—d
->
mu‹x
))

167 
	`»fcouÁ_šc
(&
h—d
->
node
.
»fs
);

168 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

170 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

171 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

172 ià(!
h—d
->
node
.
š_Œ“
) {

173 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

174 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

175  -
EAGAIN
;

177 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

179 
	}
}

181 
šlše
 
	$drÝ_d–ayed_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

182 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

183 
bŒfs_d–ayed_»f_h—d
 *
h—d
,

184 
bŒfs_d–ayed_»f_node
 *
»f
)

186 ià(
	`bŒfs_d–ayed_»f_is_h—d
(
»f
)) {

187 
h—d
 = 
	`bŒfs_d–ayed_node_to_h—d
(
»f
);

188 
	`rb_”a£
(&
h—d
->
h»f_node
, &
d–ayed_»fs
->
h»f_roÙ
);

190 
	`as£¹_¥š_locked
(&
h—d
->
lock
);

191 
	`li¡_d–
(&
»f
->
li¡
);

192 ià(!
	`li¡_em±y
(&
»f
->
add_li¡
))

193 
	`li¡_d–
(&
»f
->
add_li¡
);

195 
»f
->
š_Œ“
 = 0;

196 
	`bŒfs_put_d–ayed_»f
(
»f
);

197 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

198 ià(
Œªs
->
d–ayed_»f_upd©es
)

199 
Œªs
->
d–ayed_»f_upd©es
--;

200 
	}
}

202 
boÞ
 
	$m”ge_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

203 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

204 
bŒfs_d–ayed_»f_h—d
 *
h—d
,

205 
bŒfs_d–ayed_»f_node
 *
»f
,

206 
u64
 
£q
)

208 
bŒfs_d–ayed_»f_node
 *
Ãxt
;

209 
boÞ
 
dÚe
 = 
çl£
;

211 
Ãxt
 = 
	`li¡_fœ¡_’Œy
(&
h—d
->
»f_li¡
, 
bŒfs_d–ayed_»f_node
,

212 
li¡
);

213 !
dÚe
 && &
Ãxt
->
li¡
 !ð&
h—d
->
»f_li¡
) {

214 
mod
;

215 
bŒfs_d–ayed_»f_node
 *
Ãxt2
;

217 
Ãxt2
 = 
	`li¡_Ãxt_’Œy
(
Ãxt
, 
li¡
);

219 ià(
Ãxt
 =ð
»f
)

220 
Ãxt
;

222 ià(
£q
 && 
Ãxt
->seq >= seq)

223 
Ãxt
;

225 ià(
Ãxt
->
ty³
 !ð
»f
->type)

226 
Ãxt
;

228 ià((
»f
->
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

229 
»f
->
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
) &&

230 
	`comp_Œ“_»fs
(
	`bŒfs_d–ayed_node_to_Œ“_»f
(
»f
),

231 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
Ãxt
),

232 
»f
->
ty³
))

233 
Ãxt
;

234 ià((
»f
->
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
 ||

235 
»f
->
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) &&

236 
	`comp_d©a_»fs
(
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f
),

237 
	`bŒfs_d–ayed_node_to_d©a_»f
(
Ãxt
)))

238 
Ãxt
;

240 ià(
»f
->
aùiÚ
 =ð
Ãxt
->action) {

241 
mod
 = 
Ãxt
->
»f_mod
;

243 ià(
»f
->
»f_mod
 < 
Ãxt
->ref_mod) {

244 
	`sw­
(
»f
, 
Ãxt
);

245 
dÚe
 = 
Œue
;

247 
mod
 = -
Ãxt
->
»f_mod
;

250 
	`drÝ_d–ayed_»f
(
Œªs
, 
d–ayed_»fs
, 
h—d
, 
Ãxt
);

251 
»f
->
»f_mod
 +ð
mod
;

252 ià(
»f
->
»f_mod
 == 0) {

253 
	`drÝ_d–ayed_»f
(
Œªs
, 
d–ayed_»fs
, 
h—d
, 
»f
);

254 
dÚe
 = 
Œue
;

259 
	`WARN_ON
(
»f
->
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

260 
»f
->
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
);

262 
Ãxt
:

263 
Ãxt
 = 
Ãxt2
;

266  
dÚe
;

267 
	}
}

269 
	$bŒfs_m”ge_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

270 
bŒfs_fs_šfo
 *
fs_šfo
,

271 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

272 
bŒfs_d–ayed_»f_h—d
 *
h—d
)

274 
bŒfs_d–ayed_»f_node
 *
»f
;

275 
u64
 
£q
 = 0;

277 
	`as£¹_¥š_locked
(&
h—d
->
lock
);

279 ià(
	`li¡_em±y
(&
h—d
->
»f_li¡
))

283 ià(
h—d
->
is_d©a
)

286 
	`¥š_lock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

287 ià(!
	`li¡_em±y
(&
fs_šfo
->
Œ“_mod_£q_li¡
)) {

288 
£q_li¡
 *
–em
;

290 
–em
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
Œ“_mod_£q_li¡
,

291 
£q_li¡
, 
li¡
);

292 
£q
 = 
–em
->seq;

294 
	`¥š_uÆock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

296 
»f
 = 
	`li¡_fœ¡_’Œy
(&
h—d
->
»f_li¡
, 
bŒfs_d–ayed_»f_node
,

297 
li¡
);

298 &
»f
->
li¡
 !ð&
h—d
->
»f_li¡
) {

299 ià(
£q
 && 
»f
->seq >= seq)

300 
Ãxt
;

302 ià(
	`m”ge_»f
(
Œªs
, 
d–ayed_»fs
, 
h—d
, 
»f
, 
£q
)) {

303 ià(
	`li¡_em±y
(&
h—d
->
»f_li¡
))

305 
»f
 = 
	`li¡_fœ¡_’Œy
(&
h—d
->
»f_li¡
,

306 
bŒfs_d–ayed_»f_node
,

307 
li¡
);

310 
Ãxt
:

311 
»f
 = 
	`li¡_Ãxt_’Œy
Ôef, 
li¡
);

313 
	}
}

315 
	$bŒfs_check_d–ayed_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

316 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

317 
u64
 
£q
)

319 
£q_li¡
 *
–em
;

320 
»t
 = 0;

322 
	`¥š_lock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

323 ià(!
	`li¡_em±y
(&
fs_šfo
->
Œ“_mod_£q_li¡
)) {

324 
–em
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
Œ“_mod_£q_li¡
,

325 
£q_li¡
, 
li¡
);

326 ià(
£q
 >ð
–em
->seq) {

327 
	`bŒfs_debug
(
fs_šfo
,

329 (
u32
)(
£q
 >> 32), (u32)seq,

330 (
u32
)(
–em
->
£q
 >> 32), (u32)elem->seq,

331 
d–ayed_»fs
);

332 
»t
 = 1;

336 
	`¥š_uÆock
(&
fs_šfo
->
Œ“_mod_£q_lock
);

337  
»t
;

338 
	}
}

340 
bŒfs_d–ayed_»f_h—d
 *

341 
	$bŒfs_£Ëù_»f_h—d
(
bŒfs_Œªs_hªdË
 *
Œªs
)

343 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

344 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

345 
u64
 
¡¬t
;

346 
boÞ
 
loÝ
 = 
çl£
;

348 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

350 
agaš
:

351 
¡¬t
 = 
d–ayed_»fs
->
run_d–ayed_¡¬t
;

352 
h—d
 = 
	`fšd_»f_h—d
(&
d–ayed_»fs
->
h»f_roÙ
, 
¡¬t
, 1);

353 ià(!
h—d
 && !
loÝ
) {

354 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 0;

355 
¡¬t
 = 0;

356 
loÝ
 = 
Œue
;

357 
h—d
 = 
	`fšd_»f_h—d
(&
d–ayed_»fs
->
h»f_roÙ
, 
¡¬t
, 1);

358 ià(!
h—d
)

359  
NULL
;

360 } ià(!
h—d
 && 
loÝ
) {

361  
NULL
;

364 
h—d
->
´oûssšg
) {

365 
rb_node
 *
node
;

367 
node
 = 
	`rb_Ãxt
(&
h—d
->
h»f_node
);

368 ià(!
node
) {

369 ià(
loÝ
)

370  
NULL
;

371 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 0;

372 
¡¬t
 = 0;

373 
loÝ
 = 
Œue
;

374 
agaš
;

376 
h—d
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
,

377 
h»f_node
);

380 
h—d
->
´oûssšg
 = 1;

381 
	`WARN_ON
(
d–ayed_»fs
->
num_h—ds_»ady
 == 0);

382 
d–ayed_»fs
->
num_h—ds_»ady
--;

383 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 
h—d
->
node
.
by‹Ä
 +

384 
h—d
->
node
.
num_by‹s
;

385  
h—d
;

386 
	}
}

395 
	$add_d–ayed_»f_ž_m”ge
(
bŒfs_Œªs_hªdË
 *
Œªs
,

396 
bŒfs_d–ayed_»f_roÙ
 *
roÙ
,

397 
bŒfs_d–ayed_»f_h—d
 *
h»f
,

398 
bŒfs_d–ayed_»f_node
 *
»f
)

400 
bŒfs_d–ayed_»f_node
 *
exi¡
;

401 
mod
;

402 
»t
 = 0;

404 
	`¥š_lock
(&
h»f
->
lock
);

406 ià(
	`li¡_em±y
(&
h»f
->
»f_li¡
))

407 
add_ž
;

408 
exi¡
 = 
	`li¡_’Œy
(
h»f
->
»f_li¡
.
´ev
, 
bŒfs_d–ayed_»f_node
,

409 
li¡
);

411 ià(
exi¡
->
ty³
 !ð
»f
->ty³ ||ƒxi¡->
£q
 !=„ef->seq)

412 
add_ž
;

414 ià((
exi¡
->
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

415 
exi¡
->
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
) &&

416 
	`comp_Œ“_»fs
(
	`bŒfs_d–ayed_node_to_Œ“_»f
(
exi¡
),

417 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
»f
),

418 
»f
->
ty³
))

419 
add_ž
;

420 ià((
exi¡
->
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
 ||

421 
exi¡
->
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) &&

422 
	`comp_d©a_»fs
(
	`bŒfs_d–ayed_node_to_d©a_»f
(
exi¡
),

423 
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f
)))

424 
add_ž
;

427 
»t
 = 1;

428 ià(
exi¡
->
aùiÚ
 =ð
»f
->action) {

429 
mod
 = 
»f
->
»f_mod
;

432 ià(
exi¡
->
»f_mod
 < 
»f
->ref_mod) {

433 
exi¡
->
aùiÚ
 = 
»f
->action;

434 
mod
 = -
exi¡
->
»f_mod
;

435 
exi¡
->
»f_mod
 = 
»f
->ref_mod;

436 ià(
»f
->
aùiÚ
 =ð
BTRFS_ADD_DELAYED_REF
)

437 
	`li¡_add_ž
(&
exi¡
->
add_li¡
,

438 &
h»f
->
»f_add_li¡
);

439 ià(
»f
->
aùiÚ
 =ð
BTRFS_DROP_DELAYED_REF
) {

440 
	`ASSERT
(!
	`li¡_em±y
(&
exi¡
->
add_li¡
));

441 
	`li¡_d–
(&
exi¡
->
add_li¡
);

443 
	`ASSERT
(0);

446 
mod
 = -
»f
->
»f_mod
;

448 
exi¡
->
»f_mod
 +ð
mod
;

451 ià(
exi¡
->
»f_mod
 == 0)

452 
	`drÝ_d–ayed_»f
(
Œªs
, 
roÙ
, 
h»f
, 
exi¡
);

453 
	`¥š_uÆock
(&
h»f
->
lock
);

454  
»t
;

456 
add_ž
:

457 
	`li¡_add_ž
(&
»f
->
li¡
, &
h»f
->
»f_li¡
);

458 ià(
»f
->
aùiÚ
 =ð
BTRFS_ADD_DELAYED_REF
)

459 
	`li¡_add_ž
(&
»f
->
add_li¡
, &
h»f
->
»f_add_li¡
);

460 
	`©omic_šc
(&
roÙ
->
num_’Œ›s
);

461 
Œªs
->
d–ayed_»f_upd©es
++;

462 
	`¥š_uÆock
(&
h»f
->
lock
);

463  
»t
;

464 
	}
}

470 
nošlše
 

471 
	$upd©e_exi¡šg_h—d_»f
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

472 
bŒfs_d–ayed_»f_node
 *
exi¡šg
,

473 
bŒfs_d–ayed_»f_node
 *
upd©e
,

474 *
Þd_»f_mod_»t
)

476 
bŒfs_d–ayed_»f_h—d
 *
exi¡šg_»f
;

477 
bŒfs_d–ayed_»f_h—d
 *
»f
;

478 
Þd_»f_mod
;

480 
exi¡šg_»f
 = 
	`bŒfs_d–ayed_node_to_h—d
(
exi¡šg
);

481 
»f
 = 
	`bŒfs_d–ayed_node_to_h—d
(
upd©e
);

482 
	`BUG_ON
(
exi¡šg_»f
->
is_d©a
 !ð
»f
->is_data);

484 
	`¥š_lock
(&
exi¡šg_»f
->
lock
);

485 ià(
»f
->
mu¡_š£¹_»£rved
) {

493 
exi¡šg_»f
->
mu¡_š£¹_»£rved
 = 
»f
->must_insert_reserved;

499 
exi¡šg
->
num_by‹s
 = 
upd©e
->num_bytes;

503 ià(
»f
->
ex‹Á_Ý
) {

504 ià(!
exi¡šg_»f
->
ex‹Á_Ý
) {

505 
exi¡šg_»f
->
ex‹Á_Ý
 = 
»f
->extent_op;

507 ià(
»f
->
ex‹Á_Ý
->
upd©e_key
) {

508 
	`memýy
(&
exi¡šg_»f
->
ex‹Á_Ý
->
key
,

509 &
»f
->
ex‹Á_Ý
->
key
,

510 (
»f
->
ex‹Á_Ý
->
key
));

511 
exi¡šg_»f
->
ex‹Á_Ý
->
upd©e_key
 = 
Œue
;

513 ià(
»f
->
ex‹Á_Ý
->
upd©e_æags
) {

514 
exi¡šg_»f
->
ex‹Á_Ý
->
æags_to_£t
 |=

515 
»f
->
ex‹Á_Ý
->
æags_to_£t
;

516 
exi¡šg_»f
->
ex‹Á_Ý
->
upd©e_æags
 = 
Œue
;

518 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
»f
->
ex‹Á_Ý
);

526 
Þd_»f_mod
 = 
exi¡šg_»f
->
tÙ®_»f_mod
;

527 ià(
Þd_»f_mod_»t
)

528 *
Þd_»f_mod_»t
 = 
Þd_»f_mod
;

529 
exi¡šg
->
»f_mod
 +ð
upd©e
->ref_mod;

530 
exi¡šg_»f
->
tÙ®_»f_mod
 +ð
upd©e
->
»f_mod
;

536 ià(
exi¡šg_»f
->
is_d©a
) {

537 ià(
exi¡šg_»f
->
tÙ®_»f_mod
 >ð0 && 
Þd_»f_mod
 < 0)

538 
d–ayed_»fs
->
³ndšg_csums
 -ð
exi¡šg
->
num_by‹s
;

539 ià(
exi¡šg_»f
->
tÙ®_»f_mod
 < 0 && 
Þd_»f_mod
 >= 0)

540 
d–ayed_»fs
->
³ndšg_csums
 +ð
exi¡šg
->
num_by‹s
;

542 
	`¥š_uÆock
(&
exi¡šg_»f
->
lock
);

543 
	}
}

550 
nošlše
 
bŒfs_d–ayed_»f_h—d
 *

551 
	$add_d–ayed_»f_h—d
(
bŒfs_fs_šfo
 *
fs_šfo
,

552 
bŒfs_Œªs_hªdË
 *
Œªs
,

553 
bŒfs_d–ayed_»f_node
 *
»f
,

554 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
,

555 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
»f_roÙ
, u64 
»£rved
,

556 
aùiÚ
, 
is_d©a
, *
q»cÜd_š£¹ed_»t
,

557 *
Þd_»f_mod
, *
Ãw_»f_mod
)

559 
bŒfs_d–ayed_»f_h—d
 *
exi¡šg
;

560 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
 = 
NULL
;

561 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

562 
couÁ_mod
 = 1;

563 
mu¡_š£¹_»£rved
 = 0;

564 
q»cÜd_š£¹ed
 = 0;

567 
	`BUG_ON
(!
is_d©a
 && 
»£rved
);

573 ià(
aùiÚ
 =ð
BTRFS_UPDATE_DELAYED_HEAD
)

574 
couÁ_mod
 = 0;

575 ià(
aùiÚ
 =ð
BTRFS_DROP_DELAYED_REF
)

576 
couÁ_mod
 = -1;

589 ià(
aùiÚ
 =ð
BTRFS_ADD_DELAYED_EXTENT
)

590 
mu¡_š£¹_»£rved
 = 1;

592 
mu¡_š£¹_»£rved
 = 0;

594 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

597 
	`»fcouÁ_£t
(&
»f
->
»fs
, 1);

598 
»f
->
by‹Ä
 = bytenr;

599 
»f
->
num_by‹s
 =‚um_bytes;

600 
»f
->
»f_mod
 = 
couÁ_mod
;

601 
»f
->
ty³
 = 0;

602 
»f
->
aùiÚ
 = 0;

603 
»f
->
is_h—d
 = 1;

604 
»f
->
š_Œ“
 = 1;

605 
»f
->
£q
 = 0;

607 
h—d_»f
 = 
	`bŒfs_d–ayed_node_to_h—d
(
»f
);

608 
h—d_»f
->
mu¡_š£¹_»£rved
 = must_insert_reserved;

609 
h—d_»f
->
is_d©a
 = is_data;

610 
	`INIT_LIST_HEAD
(&
h—d_»f
->
»f_li¡
);

611 
	`INIT_LIST_HEAD
(&
h—d_»f
->
»f_add_li¡
);

612 
h—d_»f
->
´oûssšg
 = 0;

613 
h—d_»f
->
tÙ®_»f_mod
 = 
couÁ_mod
;

614 
h—d_»f
->
qgroup_»£rved
 = 0;

615 
h—d_»f
->
qgroup_»f_roÙ
 = 0;

618 ià(
q»cÜd
) {

619 ià(
»f_roÙ
 && 
»£rved
) {

620 
h—d_»f
->
qgroup_»f_roÙ
 = 
»f_roÙ
;

621 
h—d_»f
->
qgroup_»£rved
 = 
»£rved
;

624 
q»cÜd
->
by‹Ä
 = bytenr;

625 
q»cÜd
->
num_by‹s
 =‚um_bytes;

626 
q»cÜd
->
Þd_roÙs
 = 
NULL
;

628 if(
	`bŒfs_qgroup_Œaû_ex‹Á_nÞock
(
fs_šfo
,

629 
d–ayed_»fs
, 
q»cÜd
))

630 
	`kä“
(
q»cÜd
);

632 
q»cÜd_š£¹ed
 = 1;

635 
	`¥š_lock_š™
(&
h—d_»f
->
lock
);

636 
	`mu‹x_š™
(&
h—d_»f
->
mu‹x
);

638 
	`Œaû_add_d–ayed_»f_h—d
(
fs_šfo
, 
»f
, 
h—d_»f
, 
aùiÚ
);

640 
exi¡šg
 = 
	`hŒ“_š£¹
(&
d–ayed_»fs
->
h»f_roÙ
,

641 &
h—d_»f
->
h»f_node
);

642 ià(
exi¡šg
) {

643 
	`WARN_ON
(
»f_roÙ
 && 
»£rved
 && 
exi¡šg
->
qgroup_»f_roÙ


644 && 
exi¡šg
->
qgroup_»£rved
);

645 
	`upd©e_exi¡šg_h—d_»f
(
d–ayed_»fs
, &
exi¡šg
->
node
, 
»f
,

646 
Þd_»f_mod
);

651 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
h—d_»f
);

652 
h—d_»f
 = 
exi¡šg
;

654 ià(
Þd_»f_mod
)

655 *
Þd_»f_mod
 = 0;

656 ià(
is_d©a
 && 
couÁ_mod
 < 0)

657 
d–ayed_»fs
->
³ndšg_csums
 +ð
num_by‹s
;

658 
d–ayed_»fs
->
num_h—ds
++;

659 
d–ayed_»fs
->
num_h—ds_»ady
++;

660 
	`©omic_šc
(&
d–ayed_»fs
->
num_’Œ›s
);

661 
Œªs
->
d–ayed_»f_upd©es
++;

663 ià(
q»cÜd_š£¹ed_»t
)

664 *
q»cÜd_š£¹ed_»t
 = 
q»cÜd_š£¹ed
;

665 ià(
Ãw_»f_mod
)

666 *
Ãw_»f_mod
 = 
h—d_»f
->
tÙ®_»f_mod
;

667  
h—d_»f
;

668 
	}
}

673 
nošlše
 

674 
	$add_d–ayed_Œ“_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

675 
bŒfs_Œªs_hªdË
 *
Œªs
,

676 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
,

677 
bŒfs_d–ayed_»f_node
 *
»f
, 
u64
 
by‹Ä
,

678 
u64
 
num_by‹s
, u64 
·»Á
, u64 
»f_roÙ
, 
Ëv–
,

679 
aùiÚ
)

681 
bŒfs_d–ayed_Œ“_»f
 *
fuÎ_»f
;

682 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

683 
u64
 
£q
 = 0;

684 
»t
;

686 ià(
aùiÚ
 =ð
BTRFS_ADD_DELAYED_EXTENT
)

687 
aùiÚ
 = 
BTRFS_ADD_DELAYED_REF
;

689 ià(
	`is_f¡»e
(
»f_roÙ
))

690 
£q
 = 
	`©omic64_»ad
(&
fs_šfo
->
Œ“_mod_£q
);

691 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

694 
	`»fcouÁ_£t
(&
»f
->
»fs
, 1);

695 
»f
->
by‹Ä
 = bytenr;

696 
»f
->
num_by‹s
 =‚um_bytes;

697 
»f
->
»f_mod
 = 1;

698 
»f
->
aùiÚ
 =‡ction;

699 
»f
->
is_h—d
 = 0;

700 
»f
->
š_Œ“
 = 1;

701 
»f
->
£q
 = seq;

702 
	`INIT_LIST_HEAD
(&
»f
->
li¡
);

703 
	`INIT_LIST_HEAD
(&
»f
->
add_li¡
);

705 
fuÎ_»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
»f
);

706 
fuÎ_»f
->
·»Á
 =…arent;

707 
fuÎ_»f
->
roÙ
 = 
»f_roÙ
;

708 ià(
·»Á
)

709 
»f
->
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

711 
»f
->
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

712 
fuÎ_»f
->
Ëv–
 =†evel;

714 
	`Œaû_add_d–ayed_Œ“_»f
(
fs_šfo
, 
»f
, 
fuÎ_»f
, 
aùiÚ
);

716 
»t
 = 
	`add_d–ayed_»f_ž_m”ge
(
Œªs
, 
d–ayed_»fs
, 
h—d_»f
, 
»f
);

722 ià(
»t
 > 0)

723 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
fuÎ_»f
);

724 
	}
}

729 
nošlše
 

730 
	$add_d–ayed_d©a_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

731 
bŒfs_Œªs_hªdË
 *
Œªs
,

732 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
,

733 
bŒfs_d–ayed_»f_node
 *
»f
, 
u64
 
by‹Ä
,

734 
u64
 
num_by‹s
, u64 
·»Á
, u64 
»f_roÙ
, u64 
owÃr
,

735 
u64
 
off£t
, 
aùiÚ
)

737 
bŒfs_d–ayed_d©a_»f
 *
fuÎ_»f
;

738 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

739 
u64
 
£q
 = 0;

740 
»t
;

742 ià(
aùiÚ
 =ð
BTRFS_ADD_DELAYED_EXTENT
)

743 
aùiÚ
 = 
BTRFS_ADD_DELAYED_REF
;

745 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

747 ià(
	`is_f¡»e
(
»f_roÙ
))

748 
£q
 = 
	`©omic64_»ad
(&
fs_šfo
->
Œ“_mod_£q
);

751 
	`»fcouÁ_£t
(&
»f
->
»fs
, 1);

752 
»f
->
by‹Ä
 = bytenr;

753 
»f
->
num_by‹s
 =‚um_bytes;

754 
»f
->
»f_mod
 = 1;

755 
»f
->
aùiÚ
 =‡ction;

756 
»f
->
is_h—d
 = 0;

757 
»f
->
š_Œ“
 = 1;

758 
»f
->
£q
 = seq;

759 
	`INIT_LIST_HEAD
(&
»f
->
li¡
);

760 
	`INIT_LIST_HEAD
(&
»f
->
add_li¡
);

762 
fuÎ_»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f
);

763 
fuÎ_»f
->
·»Á
 =…arent;

764 
fuÎ_»f
->
roÙ
 = 
»f_roÙ
;

765 ià(
·»Á
)

766 
»f
->
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

768 
»f
->
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

770 
fuÎ_»f
->
objeùid
 = 
owÃr
;

771 
fuÎ_»f
->
off£t
 = offset;

773 
	`Œaû_add_d–ayed_d©a_»f
(
fs_šfo
, 
»f
, 
fuÎ_»f
, 
aùiÚ
);

775 
»t
 = 
	`add_d–ayed_»f_ž_m”ge
(
Œªs
, 
d–ayed_»fs
, 
h—d_»f
, 
»f
);

777 ià(
»t
 > 0)

778 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
fuÎ_»f
);

779 
	}
}

786 
	$bŒfs_add_d–ayed_Œ“_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

787 
bŒfs_Œªs_hªdË
 *
Œªs
,

788 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

789 
u64
 
»f_roÙ
, 
Ëv–
, 
aùiÚ
,

790 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

791 *
Þd_»f_mod
, *
Ãw_»f_mod
)

793 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

794 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
;

795 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

796 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
 = 
NULL
;

797 
q»cÜd_š£¹ed
;

799 
	`BUG_ON
(
ex‹Á_Ý
 &&ƒx‹Á_Ý->
is_d©a
);

800 
»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
GFP_NOFS
);

801 ià(!
»f
)

802  -
ENOMEM
;

804 
h—d_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
GFP_NOFS
);

805 ià(!
h—d_»f
)

806 
ä“_»f
;

808 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) &&

809 
	`is_f¡»e
(
»f_roÙ
)) {

810 
»cÜd
 = 
	`km®loc
((*»cÜd), 
GFP_NOFS
);

811 ià(!
»cÜd
)

812 
ä“_h—d_»f
;

815 
h—d_»f
->
ex‹Á_Ý
 =ƒxtent_op;

817 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

818 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

824 
h—d_»f
 = 
	`add_d–ayed_»f_h—d
(
fs_šfo
, 
Œªs
, &h—d_»f->
node
, 
»cÜd
,

825 
by‹Ä
, 
num_by‹s
, 0, 0, 
aùiÚ
, 0,

826 &
q»cÜd_š£¹ed
, 
Þd_»f_mod
,

827 
Ãw_»f_mod
);

829 
	`add_d–ayed_Œ“_»f
(
fs_šfo
, 
Œªs
, 
h—d_»f
, &
»f
->
node
, 
by‹Ä
,

830 
num_by‹s
, 
·»Á
, 
»f_roÙ
, 
Ëv–
, 
aùiÚ
);

831 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

833 ià(
q»cÜd_š£¹ed
)

834  
	`bŒfs_qgroup_Œaû_ex‹Á_po¡
(
fs_šfo
, 
»cÜd
);

837 
ä“_h—d_»f
:

838 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
h—d_»f
);

839 
ä“_»f
:

840 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
»f
);

842  -
ENOMEM
;

843 
	}
}

848 
	$bŒfs_add_d–ayed_d©a_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

849 
bŒfs_Œªs_hªdË
 *
Œªs
,

850 
u64
 
by‹Ä
, u64 
num_by‹s
,

851 
u64
 
·»Á
, u64 
»f_roÙ
,

852 
u64
 
owÃr
, u64 
off£t
, u64 
»£rved
, 
aùiÚ
,

853 *
Þd_»f_mod
, *
Ãw_»f_mod
)

855 
bŒfs_d–ayed_d©a_»f
 *
»f
;

856 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
;

857 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

858 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
 = 
NULL
;

859 
q»cÜd_š£¹ed
;

861 
»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
GFP_NOFS
);

862 ià(!
»f
)

863  -
ENOMEM
;

865 
h—d_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
GFP_NOFS
);

866 ià(!
h—d_»f
) {

867 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

868  -
ENOMEM
;

871 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) &&

872 
	`is_f¡»e
(
»f_roÙ
)) {

873 
»cÜd
 = 
	`km®loc
((*»cÜd), 
GFP_NOFS
);

874 ià(!
»cÜd
) {

875 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

876 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
,

877 
h—d_»f
);

878  -
ENOMEM
;

882 
h—d_»f
->
ex‹Á_Ý
 = 
NULL
;

884 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

885 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

891 
h—d_»f
 = 
	`add_d–ayed_»f_h—d
(
fs_šfo
, 
Œªs
, &h—d_»f->
node
, 
»cÜd
,

892 
by‹Ä
, 
num_by‹s
, 
»f_roÙ
, 
»£rved
,

893 
aùiÚ
, 1, &
q»cÜd_š£¹ed
,

894 
Þd_»f_mod
, 
Ãw_»f_mod
);

896 
	`add_d–ayed_d©a_»f
(
fs_šfo
, 
Œªs
, 
h—d_»f
, &
»f
->
node
, 
by‹Ä
,

897 
num_by‹s
, 
·»Á
, 
»f_roÙ
, 
owÃr
, 
off£t
,

898 
aùiÚ
);

899 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

901 ià(
q»cÜd_š£¹ed
)

902  
	`bŒfs_qgroup_Œaû_ex‹Á_po¡
(
fs_šfo
, 
»cÜd
);

904 
	}
}

906 
	$bŒfs_add_d–ayed_ex‹Á_Ý
(
bŒfs_fs_šfo
 *
fs_šfo
,

907 
bŒfs_Œªs_hªdË
 *
Œªs
,

908 
u64
 
by‹Ä
, u64 
num_by‹s
,

909 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
)

911 
bŒfs_d–ayed_»f_h—d
 *
h—d_»f
;

912 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

914 
h—d_»f
 = 
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
GFP_NOFS
);

915 ià(!
h—d_»f
)

916  -
ENOMEM
;

918 
h—d_»f
->
ex‹Á_Ý
 =ƒxtent_op;

920 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

921 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

923 
	`add_d–ayed_»f_h—d
(
fs_šfo
, 
Œªs
, &
h—d_»f
->
node
, 
NULL
, 
by‹Ä
,

924 
num_by‹s
, 0, 0, 
BTRFS_UPDATE_DELAYED_HEAD
,

925 
ex‹Á_Ý
->
is_d©a
, 
NULL
, NULL, NULL);

927 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

929 
	}
}

936 
bŒfs_d–ayed_»f_h—d
 *

937 
	$bŒfs_fšd_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
, 
u64
 
by‹Ä
)

939  
	`fšd_»f_h—d
(&
d–ayed_»fs
->
h»f_roÙ
, 
by‹Ä
, 0);

940 
	}
}

942 
	$bŒfs_d–ayed_»f_ex™
()

944 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_»f_h—d_ÿch•
);

945 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_Œ“_»f_ÿch•
);

946 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_d©a_»f_ÿch•
);

947 
	`kmem_ÿche_de¡roy
(
bŒfs_d–ayed_ex‹Á_Ý_ÿch•
);

948 
	}
}

950 
	$bŒfs_d–ayed_»f_š™
()

952 
bŒfs_d–ayed_»f_h—d_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

954 (
bŒfs_d–ayed_»f_h—d
), 0,

955 
SLAB_MEM_SPREAD
, 
NULL
);

956 ià(!
bŒfs_d–ayed_»f_h—d_ÿch•
)

957 
çž
;

959 
bŒfs_d–ayed_Œ“_»f_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

961 (
bŒfs_d–ayed_Œ“_»f
), 0,

962 
SLAB_MEM_SPREAD
, 
NULL
);

963 ià(!
bŒfs_d–ayed_Œ“_»f_ÿch•
)

964 
çž
;

966 
bŒfs_d–ayed_d©a_»f_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

968 (
bŒfs_d–ayed_d©a_»f
), 0,

969 
SLAB_MEM_SPREAD
, 
NULL
);

970 ià(!
bŒfs_d–ayed_d©a_»f_ÿch•
)

971 
çž
;

973 
bŒfs_d–ayed_ex‹Á_Ý_ÿch•
 = 
	`kmem_ÿche_ü—‹
(

975 (
bŒfs_d–ayed_ex‹Á_Ý
), 0,

976 
SLAB_MEM_SPREAD
, 
NULL
);

977 ià(!
bŒfs_d–ayed_ex‹Á_Ý_ÿch•
)

978 
çž
;

981 
çž
:

982 
	`bŒfs_d–ayed_»f_ex™
();

983  -
ENOMEM
;

984 
	}
}

	@delayed-ref.h

18 #iâdeà
__DELAYED_REF__


19 
	#__DELAYED_REF__


	)

21 
	~<lšux/»fcouÁ.h
>

24 
	#BTRFS_ADD_DELAYED_REF
 1

	)

25 
	#BTRFS_DROP_DELAYED_REF
 2

	)

26 
	#BTRFS_ADD_DELAYED_EXTENT
 3

	)

27 
	#BTRFS_UPDATE_DELAYED_HEAD
 4

	)

38 
	sbŒfs_d–ayed_»f_node
 {

40 
li¡_h—d
 
	mli¡
;

46 
li¡_h—d
 
	madd_li¡
;

49 
u64
 
	mby‹Ä
;

52 
u64
 
	mnum_by‹s
;

55 
u64
 
	m£q
;

58 
»fcouÁ_t
 
	m»fs
;

69 
	m»f_mod
;

71 
	maùiÚ
:8;

72 
	mty³
:8;

74 
	mis_h—d
:1;

75 
	mš_Œ“
:1;

78 
	sbŒfs_d–ayed_ex‹Á_Ý
 {

79 
bŒfs_disk_key
 
	mkey
;

80 
u8
 
	mËv–
;

81 
boÞ
 
	mupd©e_key
;

82 
boÞ
 
	mupd©e_æags
;

83 
boÞ
 
	mis_d©a
;

84 
u64
 
	mæags_to_£t
;

93 
	sbŒfs_d–ayed_»f_h—d
 {

94 
bŒfs_d–ayed_»f_node
 
	mnode
;

100 
mu‹x
 
	mmu‹x
;

102 
¥šlock_t
 
	mlock
;

103 
li¡_h—d
 
	m»f_li¡
;

105 
li¡_h—d
 
	m»f_add_li¡
;

107 
rb_node
 
	mh»f_node
;

109 
bŒfs_d–ayed_ex‹Á_Ý
 *
	mex‹Á_Ý
;

116 
	mtÙ®_»f_mod
;

126 
u64
 
	mqgroup_»f_roÙ
;

127 
u64
 
	mqgroup_»£rved
;

141 
	mmu¡_š£¹_»£rved
:1;

142 
	mis_d©a
:1;

143 
	m´oûssšg
:1;

146 
	sbŒfs_d–ayed_Œ“_»f
 {

147 
bŒfs_d–ayed_»f_node
 
	mnode
;

148 
u64
 
	mroÙ
;

149 
u64
 
	m·»Á
;

150 
	mËv–
;

153 
	sbŒfs_d–ayed_d©a_»f
 {

154 
bŒfs_d–ayed_»f_node
 
	mnode
;

155 
u64
 
	mroÙ
;

156 
u64
 
	m·»Á
;

157 
u64
 
	mobjeùid
;

158 
u64
 
	moff£t
;

161 
	sbŒfs_d–ayed_»f_roÙ
 {

163 
rb_roÙ
 
	mh»f_roÙ
;

166 
rb_roÙ
 
	mdœty_ex‹Á_roÙ
;

169 
¥šlock_t
 
	mlock
;

174 
©omic_t
 
	mnum_’Œ›s
;

177 
	mnum_h—ds
;

180 
	mnum_h—ds_»ady
;

182 
u64
 
	m³ndšg_csums
;

189 
	mæushšg
;

191 
u64
 
	mrun_d–ayed_¡¬t
;

199 
u64
 
	mqgroup_to_sk
;

202 
kmem_ÿche
 *
bŒfs_d–ayed_»f_h—d_ÿch•
;

203 
kmem_ÿche
 *
bŒfs_d–ayed_Œ“_»f_ÿch•
;

204 
kmem_ÿche
 *
bŒfs_d–ayed_d©a_»f_ÿch•
;

205 
kmem_ÿche
 *
bŒfs_d–ayed_ex‹Á_Ý_ÿch•
;

207 
bŒfs_d–ayed_»f_š™
();

208 
bŒfs_d–ayed_»f_ex™
();

210 
šlše
 
bŒfs_d–ayed_ex‹Á_Ý
 *

211 
	$bŒfs_®loc_d–ayed_ex‹Á_Ý
()

213  
	`kmem_ÿche_®loc
(
bŒfs_d–ayed_ex‹Á_Ý_ÿch•
, 
GFP_NOFS
);

214 
	}
}

216 
šlše
 

217 
	$bŒfs_ä“_d–ayed_ex‹Á_Ý
(
bŒfs_d–ayed_ex‹Á_Ý
 *
Ý
)

219 ià(
Ý
)

220 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_ex‹Á_Ý_ÿch•
, 
Ý
);

221 
	}
}

223 
šlše
 
	$bŒfs_put_d–ayed_»f
(
bŒfs_d–ayed_»f_node
 *
»f
)

225 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
»f
->
»fs
) == 0);

226 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»f
->
»fs
)) {

227 
	`WARN_ON
(
»f
->
š_Œ“
);

228 
»f
->
ty³
) {

229 
BTRFS_TREE_BLOCK_REF_KEY
:

230 
BTRFS_SHARED_BLOCK_REF_KEY
:

231 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_Œ“_»f_ÿch•
, 
»f
);

233 
BTRFS_EXTENT_DATA_REF_KEY
:

234 
BTRFS_SHARED_DATA_REF_KEY
:

235 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_d©a_»f_ÿch•
, 
»f
);

238 
	`kmem_ÿche_ä“
(
bŒfs_d–ayed_»f_h—d_ÿch•
, 
»f
);

241 
	`BUG
();

244 
	}
}

246 
bŒfs_add_d–ayed_Œ“_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

247 
bŒfs_Œªs_hªdË
 *
Œªs
,

248 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

249 
u64
 
»f_roÙ
, 
Ëv–
, 
aùiÚ
,

250 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

251 *
Þd_»f_mod
, *
Ãw_»f_mod
);

252 
bŒfs_add_d–ayed_d©a_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

253 
bŒfs_Œªs_hªdË
 *
Œªs
,

254 
u64
 
by‹Ä
, u64 
num_by‹s
,

255 
u64
 
·»Á
, u64 
»f_roÙ
,

256 
u64
 
owÃr
, u64 
off£t
, u64 
»£rved
, 
aùiÚ
,

257 *
Þd_»f_mod
, *
Ãw_»f_mod
);

258 
bŒfs_add_d–ayed_ex‹Á_Ý
(
bŒfs_fs_šfo
 *
fs_šfo
,

259 
bŒfs_Œªs_hªdË
 *
Œªs
,

260 
u64
 
by‹Ä
, u64 
num_by‹s
,

261 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
);

262 
bŒfs_m”ge_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

263 
bŒfs_fs_šfo
 *
fs_šfo
,

264 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

265 
bŒfs_d–ayed_»f_h—d
 *
h—d
);

267 
bŒfs_d–ayed_»f_h—d
 *

268 
bŒfs_fšd_d–ayed_»f_h—d
(
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

269 
u64
 
by‹Ä
);

270 
bŒfs_d–ayed_»f_lock
(
bŒfs_Œªs_hªdË
 *
Œªs
,

271 
bŒfs_d–ayed_»f_h—d
 *
h—d
);

272 
šlše
 
	$bŒfs_d–ayed_»f_uÆock
(
bŒfs_d–ayed_»f_h—d
 *
h—d
)

274 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

275 
	}
}

278 
bŒfs_d–ayed_»f_h—d
 *

279 
bŒfs_£Ëù_»f_h—d
(
bŒfs_Œªs_hªdË
 *
Œªs
);

281 
bŒfs_check_d–ayed_£q
(
bŒfs_fs_šfo
 *
fs_šfo
,

282 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

283 
u64
 
£q
);

289 
	$bŒfs_d–ayed_»f_is_h—d
(
bŒfs_d–ayed_»f_node
 *
node
)

291  
node
->
is_h—d
;

292 
	}
}

297 
šlše
 
bŒfs_d–ayed_Œ“_»f
 *

298 
	$bŒfs_d–ayed_node_to_Œ“_»f
(
bŒfs_d–ayed_»f_node
 *
node
)

300 
	`WARN_ON
(
	`bŒfs_d–ayed_»f_is_h—d
(
node
));

301  
	`cÚš”_of
(
node
, 
bŒfs_d–ayed_Œ“_»f
,‚ode);

302 
	}
}

304 
šlše
 
bŒfs_d–ayed_d©a_»f
 *

305 
	$bŒfs_d–ayed_node_to_d©a_»f
(
bŒfs_d–ayed_»f_node
 *
node
)

307 
	`WARN_ON
(
	`bŒfs_d–ayed_»f_is_h—d
(
node
));

308  
	`cÚš”_of
(
node
, 
bŒfs_d–ayed_d©a_»f
,‚ode);

309 
	}
}

311 
šlše
 
bŒfs_d–ayed_»f_h—d
 *

312 
	$bŒfs_d–ayed_node_to_h—d
(
bŒfs_d–ayed_»f_node
 *
node
)

314 
	`WARN_ON
(!
	`bŒfs_d–ayed_»f_is_h—d
(
node
));

315  
	`cÚš”_of
(
node
, 
bŒfs_d–ayed_»f_h—d
,‚ode);

316 
	}
}

	@dev-replace.c

18 
	~<lšux/sched.h
>

19 
	~<lšux/bio.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/¿ndom.h
>

24 
	~<lšux/iocÚ‹xt.h
>

25 
	~<lšux/ÿ·bž™y.h
>

26 
	~<lšux/kth»ad.h
>

27 
	~<lšux/m©h64.h
>

28 
	~<asm/div64.h
>

29 
	~"ù»e.h
"

30 
	~"ex‹Á_m­.h
"

31 
	~"disk-io.h
"

32 
	~"Œª§ùiÚ.h
"

33 
	~"´št-Œ“.h
"

34 
	~"vÞumes.h
"

35 
	~"async-th»ad.h
"

36 
	~"check-š‹gr™y.h
"

37 
	~"rcu-¡ršg.h
"

38 
	~"dev-»¶aû.h
"

39 
	~"sysfs.h
"

41 
bŒfs_dev_»¶aû_fšishšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

42 
süub_»t
);

43 
bŒfs_dev_»¶aû_upd©e_deviû_š_m­pšg_Œ“
(

44 
bŒfs_fs_šfo
 *
fs_šfo
,

45 
bŒfs_deviû
 *
¤cdev
,

46 
bŒfs_deviû
 *
tgtdev
);

47 
u64
 
__bŒfs_dev_»¶aû_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
);

48 
bŒfs_dev_»¶aû_kth»ad
(*
d©a
);

49 
bŒfs_dev_»¶aû_cÚtšue_Ú_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
);

52 
	$bŒfs_š™_dev_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
)

54 
bŒfs_key
 
key
;

55 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

56 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

57 
ex‹Á_bufãr
 *
eb
;

58 
¦Ù
;

59 
»t
 = 0;

60 
bŒfs_·th
 *
·th
 = 
NULL
;

61 
™em_size
;

62 
bŒfs_dev_»¶aû_™em
 *
±r
;

63 
u64
 
¤c_devid
;

65 
·th
 = 
	`bŒfs_®loc_·th
();

66 ià(!
·th
) {

67 
»t
 = -
ENOMEM
;

68 
out
;

71 
key
.
objeùid
 = 0;

72 
key
.
ty³
 = 
BTRFS_DEV_REPLACE_KEY
;

73 
key
.
off£t
 = 0;

74 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
dev_roÙ
, &
key
, 
·th
, 0, 0);

75 ià(
»t
) {

76 
no_v®id_dev_»¶aû_’Œy_found
:

77 
»t
 = 0;

78 
dev_»¶aû
->
»¶aû_¡©e
 =

79 
BTRFS_DEV_REPLACE_ITEM_STATE_NEVER_STARTED
;

80 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
 =

81 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
;

82 
dev_»¶aû
->
»¶aû_¡©e
 = 0;

83 
dev_»¶aû
->
time_¡¬‹d
 = 0;

84 
dev_»¶aû
->
time_¡Ý³d
 = 0;

85 
	`©omic64_£t
(&
dev_»¶aû
->
num_wr™e_”rÜs
, 0);

86 
	`©omic64_£t
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
, 0);

87 
dev_»¶aû
->
cursÜ_Ëá
 = 0;

88 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 = 0;

89 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 = 0;

90 
dev_»¶aû
->
cursÜ_right
 = 0;

91 
dev_»¶aû
->
¤cdev
 = 
NULL
;

92 
dev_»¶aû
->
tgtdev
 = 
NULL
;

93 
dev_»¶aû
->
is_v®id
 = 0;

94 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 0;

95 
out
;

97 
¦Ù
 = 
·th
->
¦Ùs
[0];

98 
eb
 = 
·th
->
nodes
[0];

99 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

100 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dev_»¶aû_™em
);

102 ià(
™em_size
 !ð(
bŒfs_dev_»¶aû_™em
)) {

103 
	`bŒfs_w¬n
(
fs_šfo
,

105 
no_v®id_dev_»¶aû_’Œy_found
;

108 
¤c_devid
 = 
	`bŒfs_dev_»¶aû_¤c_devid
(
eb
, 
±r
);

109 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
 =

110 
	`bŒfs_dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
(
eb
, 
±r
);

111 
dev_»¶aû
->
»¶aû_¡©e
 = 
	`bŒfs_dev_»¶aû_»¶aû_¡©e
(
eb
, 
±r
);

112 
dev_»¶aû
->
time_¡¬‹d
 = 
	`bŒfs_dev_»¶aû_time_¡¬‹d
(
eb
, 
±r
);

113 
dev_»¶aû
->
time_¡Ý³d
 =

114 
	`bŒfs_dev_»¶aû_time_¡Ý³d
(
eb
, 
±r
);

115 
	`©omic64_£t
(&
dev_»¶aû
->
num_wr™e_”rÜs
,

116 
	`bŒfs_dev_»¶aû_num_wr™e_”rÜs
(
eb
, 
±r
));

117 
	`©omic64_£t
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
,

118 
	`bŒfs_dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
(
eb
, 
±r
));

119 
dev_»¶aû
->
cursÜ_Ëá
 = 
	`bŒfs_dev_»¶aû_cursÜ_Ëá
(
eb
, 
±r
);

120 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 = dev_»¶aû->
cursÜ_Ëá
;

121 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 = dev_»¶aû->
cursÜ_Ëá
;

122 
dev_»¶aû
->
cursÜ_right
 = 
	`bŒfs_dev_»¶aû_cursÜ_right
(
eb
, 
±r
);

123 
dev_»¶aû
->
is_v®id
 = 1;

125 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 0;

126 
dev_»¶aû
->
»¶aû_¡©e
) {

127 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

128 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

129 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

130 
dev_»¶aû
->
¤cdev
 = 
NULL
;

131 
dev_»¶aû
->
tgtdev
 = 
NULL
;

133 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

134 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

135 
dev_»¶aû
->
¤cdev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
¤c_devid
,

136 
NULL
, NULL);

137 
dev_»¶aû
->
tgtdev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
,

138 
BTRFS_DEV_REPLACE_DEVID
,

139 
NULL
, NULL);

144 ià(!
dev_»¶aû
->
¤cdev
 &&

145 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DEGRADED
)) {

146 
»t
 = -
EIO
;

147 
	`bŒfs_w¬n
(
fs_šfo
,

149 
	`bŒfs_w¬n
(
fs_šfo
,

151 
¤c_devid
);

153 ià(!
dev_»¶aû
->
tgtdev
 &&

154 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DEGRADED
)) {

155 
»t
 = -
EIO
;

156 
	`bŒfs_w¬n
(
fs_šfo
,

158 
	`bŒfs_w¬n
(
fs_šfo
,

160 
BTRFS_DEV_REPLACE_DEVID
);

162 ià(
dev_»¶aû
->
tgtdev
) {

163 ià(
dev_»¶aû
->
¤cdev
) {

164 
dev_»¶aû
->
tgtdev
->
tÙ®_by‹s
 =

165 
dev_»¶aû
->
¤cdev
->
tÙ®_by‹s
;

166 
dev_»¶aû
->
tgtdev
->
disk_tÙ®_by‹s
 =

167 
dev_»¶aû
->
¤cdev
->
disk_tÙ®_by‹s
;

168 
dev_»¶aû
->
tgtdev
->
comm™_tÙ®_by‹s
 =

169 
dev_»¶aû
->
¤cdev
->
comm™_tÙ®_by‹s
;

170 
dev_»¶aû
->
tgtdev
->
by‹s_u£d
 =

171 
dev_»¶aû
->
¤cdev
->
by‹s_u£d
;

172 
dev_»¶aû
->
tgtdev
->
comm™_by‹s_u£d
 =

173 
dev_»¶aû
->
¤cdev
->
comm™_by‹s_u£d
;

175 
dev_»¶aû
->
tgtdev
->
is_tgtdev_fÜ_dev_»¶aû
 = 1;

176 
	`bŒfs_š™_dev_»¶aû_tgtdev_fÜ_»sume
(
fs_šfo
,

177 
dev_»¶aû
->
tgtdev
);

182 
out
:

183 
	`bŒfs_ä“_·th
(
·th
);

184  
»t
;

185 
	}
}

191 
	$bŒfs_run_dev_»¶aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

192 
bŒfs_fs_šfo
 *
fs_šfo
)

194 
»t
;

195 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

196 
bŒfs_·th
 *
·th
;

197 
bŒfs_key
 
key
;

198 
ex‹Á_bufãr
 *
eb
;

199 
bŒfs_dev_»¶aû_™em
 *
±r
;

200 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

202 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 0);

203 ià(!
dev_»¶aû
->
is_v®id
 ||

204 !
dev_»¶aû
->
™em_Ãeds_wr™eback
) {

205 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

208 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

210 
key
.
objeùid
 = 0;

211 
key
.
ty³
 = 
BTRFS_DEV_REPLACE_KEY
;

212 
key
.
off£t
 = 0;

214 
·th
 = 
	`bŒfs_®loc_·th
();

215 ià(!
·th
) {

216 
»t
 = -
ENOMEM
;

217 
out
;

219 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
dev_roÙ
, &
key
, 
·th
, -1, 1);

220 ià(
»t
 < 0) {

221 
	`bŒfs_w¬n
(
fs_šfo
,

223 
»t
);

224 
out
;

227 ià(
»t
 == 0 &&

228 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]è< (*
±r
)) {

240 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
dev_roÙ
, 
·th
);

241 ià(
»t
 != 0) {

242 
	`bŒfs_w¬n
(
fs_šfo
,

244 
»t
);

245 
out
;

247 
»t
 = 1;

250 ià(
»t
 == 1) {

252 
	`bŒfs_»Ëa£_·th
(
·th
);

253 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
dev_roÙ
, 
·th
,

254 &
key
, (*
±r
));

255 ià(
»t
 < 0) {

256 
	`bŒfs_w¬n
(
fs_šfo
,

257 "š£¹ dev_»¶aû i‹m fažed %d!", 
»t
);

258 
out
;

262 
eb
 = 
·th
->
nodes
[0];

263 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0],

264 
bŒfs_dev_»¶aû_™em
);

266 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

267 ià(
dev_»¶aû
->
¤cdev
)

268 
	`bŒfs_£t_dev_»¶aû_¤c_devid
(
eb
, 
±r
,

269 
dev_»¶aû
->
¤cdev
->
devid
);

271 
	`bŒfs_£t_dev_»¶aû_¤c_devid
(
eb
, 
±r
, (
u64
)-1);

272 
	`bŒfs_£t_dev_»¶aû_cÚt_»adšg_äom_¤cdev_mode
(
eb
, 
±r
,

273 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
);

274 
	`bŒfs_£t_dev_»¶aû_»¶aû_¡©e
(
eb
, 
±r
,

275 
dev_»¶aû
->
»¶aû_¡©e
);

276 
	`bŒfs_£t_dev_»¶aû_time_¡¬‹d
(
eb
, 
±r
, 
dev_»¶aû
->
time_¡¬‹d
);

277 
	`bŒfs_£t_dev_»¶aû_time_¡Ý³d
(
eb
, 
±r
, 
dev_»¶aû
->
time_¡Ý³d
);

278 
	`bŒfs_£t_dev_»¶aû_num_wr™e_”rÜs
(
eb
, 
±r
,

279 
	`©omic64_»ad
(&
dev_»¶aû
->
num_wr™e_”rÜs
));

280 
	`bŒfs_£t_dev_»¶aû_num_uncÜ»ùabË_»ad_”rÜs
(
eb
, 
±r
,

281 
	`©omic64_»ad
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
));

282 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 =

283 
dev_»¶aû
->
cursÜ_Ëá
;

284 
	`bŒfs_£t_dev_»¶aû_cursÜ_Ëá
(
eb
, 
±r
,

285 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
);

286 
	`bŒfs_£t_dev_»¶aû_cursÜ_right
(
eb
, 
±r
,

287 
dev_»¶aû
->
cursÜ_right
);

288 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 0;

289 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

291 
	`bŒfs_m¬k_bufãr_dœty
(
eb
);

293 
out
:

294 
	`bŒfs_ä“_·th
(
·th
);

296  
»t
;

297 
	}
}

299 
	$bŒfs_aá”_dev_»¶aû_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
)

301 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

303 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 =

304 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
;

305 
	}
}

307 
	$bŒfs_dev_»¶aû_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
,

308 cÚ¡ *
tgtdev_Çme
, 
u64
 
¤cdevid
, cÚ¡ *
¤cdev_Çme
,

309 
»ad_¤c
)

311 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

312 
bŒfs_Œªs_hªdË
 *
Œªs
;

313 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

314 
»t
;

315 
bŒfs_deviû
 *
tgt_deviû
 = 
NULL
;

316 
bŒfs_deviû
 *
¤c_deviû
 = 
NULL
;

319 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

320 
»t
 = 
	`bŒfs_fšd_deviû_by_dev¥ec
(
fs_šfo
, 
¤cdevid
,

321 
¤cdev_Çme
, &
¤c_deviû
);

322 ià(
»t
) {

323 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

324  
»t
;

327 
»t
 = 
	`bŒfs_š™_dev_»¶aû_tgtdev
(
fs_šfo
, 
tgtdev_Çme
,

328 
¤c_deviû
, &
tgt_deviû
);

329 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

330 ià(
»t
)

331  
»t
;

337 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

338 ià(!
	`IS_ERR
(
Œªs
)) {

339 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

340 ià(
»t
)

341  
»t
;

342 } ià(
	`PTR_ERR
(
Œªs
è!ð-
ENOENT
) {

343  
	`PTR_ERR
(
Œªs
);

346 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

347 
dev_»¶aû
->
»¶aû_¡©e
) {

348 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

349 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

350 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

352 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

353 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

354 
»t
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED
;

355 
Ëave
;

358 
dev_»¶aû
->
cÚt_»adšg_äom_¤cdev_mode
 = 
»ad_¤c
;

359 
	`WARN_ON
(!
¤c_deviû
);

360 
dev_»¶aû
->
¤cdev
 = 
¤c_deviû
;

361 
	`WARN_ON
(!
tgt_deviû
);

362 
dev_»¶aû
->
tgtdev
 = 
tgt_deviû
;

364 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

366 
¤c_deviû
->
missšg
 ? "<missing disk>" :

367 
	`rcu_¡r_d”ef
(
¤c_deviû
->
Çme
),

368 
¤c_deviû
->
devid
,

369 
	`rcu_¡r_d”ef
(
tgt_deviû
->
Çme
));

375 
dev_»¶aû
->
»¶aû_¡©e
 = 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
;

376 
dev_»¶aû
->
time_¡¬‹d
 = 
	`g‘_£cÚds
();

377 
dev_»¶aû
->
cursÜ_Ëá
 = 0;

378 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
 = 0;

379 
dev_»¶aû
->
cursÜ_Ëá_Ï¡_wr™e_of_™em
 = 0;

380 
dev_»¶aû
->
cursÜ_right
 = 0;

381 
dev_»¶aû
->
is_v®id
 = 1;

382 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

383 
	`©omic64_£t
(&
dev_»¶aû
->
num_wr™e_”rÜs
, 0);

384 
	`©omic64_£t
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
, 0);

385 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

387 
»t
 = 
	`bŒfs_sysfs_add_deviû_lšk
(
tgt_deviû
->
fs_deviûs
,gt_device);

388 ià(
»t
)

389 
	`bŒfs_”r
(
fs_šfo
, "kobj‡dd dev fažed %d", 
»t
);

391 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

394 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

395 ià(
	`IS_ERR
(
Œªs
)) {

396 
»t
 = 
	`PTR_ERR
(
Œªs
);

397 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

398 
Ëave
;

401 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

402 
	`WARN_ON
(
»t
);

405 
»t
 = 
	`bŒfs_süub_dev
(
fs_šfo
, 
¤c_deviû
->
devid
, 0,

406 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
¤c_deviû
),

407 &
dev_»¶aû
->
süub_´og»ss
, 0, 1);

409 
»t
 = 
	`bŒfs_dev_»¶aû_fšishšg
(
fs_šfo
,„et);

410 ià(
»t
 =ð-
EINPROGRESS
) {

411 
»t
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
;

413 
	`WARN_ON
(
»t
);

416  
»t
;

418 
Ëave
:

419 
dev_»¶aû
->
¤cdev
 = 
NULL
;

420 
dev_»¶aû
->
tgtdev
 = 
NULL
;

421 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

422 
	`bŒfs_de¡roy_dev_»¶aû_tgtdev
(
fs_šfo
, 
tgt_deviû
);

423  
»t
;

424 
	}
}

426 
	$bŒfs_dev_»¶aû_by_ioùl
(
bŒfs_fs_šfo
 *
fs_šfo
,

427 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
)

429 
»t
;

431 
¬gs
->
¡¬t
.
cÚt_»adšg_äom_¤cdev_mode
) {

432 
BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
:

433 
BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID
:

436  -
EINVAL
;

439 ià((
¬gs
->
¡¬t
.
¤cdevid
 =ð0 &&‡rgs->¡¬t.
¤cdev_Çme
[0] == '\0') ||

440 
¬gs
->
¡¬t
.
tgtdev_Çme
[0] == '\0')

441  -
EINVAL
;

443 
»t
 = 
	`bŒfs_dev_»¶aû_¡¬t
(
fs_šfo
, 
¬gs
->
¡¬t
.
tgtdev_Çme
,

444 
¬gs
->
¡¬t
.
¤cdevid
,

445 
¬gs
->
¡¬t
.
¤cdev_Çme
,

446 
¬gs
->
¡¬t
.
cÚt_»adšg_äom_¤cdev_mode
);

447 
¬gs
->
»suÉ
 = 
»t
;

449 ià(
»t
 =ð
BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
)

450 
»t
 = 0;

452  
»t
;

453 
	}
}

458 
	$bŒfs_rm_dev_»¶aû_blocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

460 
	`£t_b™
(
BTRFS_FS_STATE_DEV_REPLACING
, &
fs_šfo
->
fs_¡©e
);

461 
	`wa™_ev’t
(
fs_šfo
->
»¶aû_wa™
, !
	`³rýu_couÁ”_sum
(

462 &
fs_šfo
->
bio_couÁ”
));

463 
	}
}

468 
	$bŒfs_rm_dev_»¶aû_unblocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

470 
	`þ—r_b™
(
BTRFS_FS_STATE_DEV_REPLACING
, &
fs_šfo
->
fs_¡©e
);

471 
	`wake_up
(&
fs_šfo
->
»¶aû_wa™
);

472 
	}
}

474 
	$bŒfs_dev_»¶aû_fšishšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

475 
süub_»t
)

477 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

478 
bŒfs_deviû
 *
tgt_deviû
;

479 
bŒfs_deviû
 *
¤c_deviû
;

480 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

481 
u8
 
uuid_tmp
[
BTRFS_UUID_SIZE
];

482 
bŒfs_Œªs_hªdË
 *
Œªs
;

483 
»t
 = 0;

486 
	`mu‹x_lock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

488 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 0);

490 ià(
dev_»¶aû
->
»¶aû_¡©e
 !=

491 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
) {

492 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

493 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

497 
tgt_deviû
 = 
dev_»¶aû
->
tgtdev
;

498 
¤c_deviû
 = 
dev_»¶aû
->
¤cdev
;

499 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

505 
»t
 = 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 0, -1);

506 ià(
»t
) {

507 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

508  
»t
;

510 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

512 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

513 ià(
	`IS_ERR
(
Œªs
)) {

514 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

515  
	`PTR_ERR
(
Œªs
);

517 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

518 
	`WARN_ON
(
»t
);

520 
	`mu‹x_lock
(&
uuid_mu‹x
);

522 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

523 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

524 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

525 
dev_»¶aû
->
»¶aû_¡©e
 =

526 
süub_»t
 ? 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED


527 : 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
;

528 
dev_»¶aû
->
tgtdev
 = 
NULL
;

529 
dev_»¶aû
->
¤cdev
 = 
NULL
;

530 
dev_»¶aû
->
time_¡Ý³d
 = 
	`g‘_£cÚds
();

531 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

534 ià(!
süub_»t
) {

535 
	`bŒfs_dev_»¶aû_upd©e_deviû_š_m­pšg_Œ“
(
fs_šfo
,

536 
¤c_deviû
,

537 
tgt_deviû
);

539 
	`bŒfs_”r_š_rcu
(
fs_šfo
,

541 
¤c_deviû
->
missšg
 ? "<missing disk>" :

542 
	`rcu_¡r_d”ef
(
¤c_deviû
->
Çme
),

543 
¤c_deviû
->
devid
,

544 
	`rcu_¡r_d”ef
(
tgt_deviû
->
Çme
), 
süub_»t
);

545 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

546 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

547 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

548 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

549 
	`bŒfs_rm_dev_»¶aû_blocked
(
fs_šfo
);

550 ià(
tgt_deviû
)

551 
	`bŒfs_de¡roy_dev_»¶aû_tgtdev
(
fs_šfo
, 
tgt_deviû
);

552 
	`bŒfs_rm_dev_»¶aû_unblocked
(
fs_šfo
);

553 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

555  
süub_»t
;

558 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

560 
¤c_deviû
->
missšg
 ? "<missing disk>" :

561 
	`rcu_¡r_d”ef
(
¤c_deviû
->
Çme
),

562 
¤c_deviû
->
devid
,

563 
	`rcu_¡r_d”ef
(
tgt_deviû
->
Çme
));

564 
tgt_deviû
->
is_tgtdev_fÜ_dev_»¶aû
 = 0;

565 
tgt_deviû
->
devid
 = 
¤c_deviû
->devid;

566 
¤c_deviû
->
devid
 = 
BTRFS_DEV_REPLACE_DEVID
;

567 
	`memýy
(
uuid_tmp
, 
tgt_deviû
->
uuid
, (uuid_tmp));

568 
	`memýy
(
tgt_deviû
->
uuid
, 
¤c_deviû
->uuid, (tgt_device->uuid));

569 
	`memýy
(
¤c_deviû
->
uuid
, 
uuid_tmp
, (src_device->uuid));

570 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
tgt_deviû
, 
¤c_deviû
->
tÙ®_by‹s
);

571 
	`bŒfs_deviû_£t_disk_tÙ®_by‹s
(
tgt_deviû
,

572 
¤c_deviû
->
disk_tÙ®_by‹s
);

573 
	`bŒfs_deviû_£t_by‹s_u£d
(
tgt_deviû
, 
¤c_deviû
->
by‹s_u£d
);

574 
	`ASSERT
(
	`li¡_em±y
(&
¤c_deviû
->
»sized_li¡
));

575 
tgt_deviû
->
comm™_tÙ®_by‹s
 = 
¤c_deviû
->commit_total_bytes;

576 
tgt_deviû
->
comm™_by‹s_u£d
 = 
¤c_deviû
->
by‹s_u£d
;

578 
	`bŒfs_assign_Ãxt_aùive_deviû
(
fs_šfo
, 
¤c_deviû
, 
tgt_deviû
);

580 
	`li¡_add
(&
tgt_deviû
->
dev_®loc_li¡
, &
fs_šfo
->
fs_deviûs
->
®loc_li¡
);

581 
fs_šfo
->
fs_deviûs
->
rw_deviûs
++;

583 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

585 
	`bŒfs_rm_dev_»¶aû_blocked
(
fs_šfo
);

587 
	`bŒfs_rm_dev_»¶aû_»move_¤cdev
(
fs_šfo
, 
¤c_deviû
);

589 
	`bŒfs_rm_dev_»¶aû_unblocked
(
fs_šfo
);

598 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

599 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

600 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

603 
	`bŒfs_sysfs_rm_deviû_lšk
(
fs_šfo
->
fs_deviûs
, 
¤c_deviû
);

604 
	`bŒfs_rm_dev_»¶aû_ä“_¤cdev
(
fs_šfo
, 
¤c_deviû
);

607 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

608 ià(!
	`IS_ERR
(
Œªs
))

609 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

611 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

614 
	}
}

616 
	$bŒfs_dev_»¶aû_upd©e_deviû_š_m­pšg_Œ“
(

617 
bŒfs_fs_šfo
 *
fs_šfo
,

618 
bŒfs_deviû
 *
¤cdev
,

619 
bŒfs_deviû
 *
tgtdev
)

621 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

622 
ex‹Á_m­
 *
em
;

623 
m­_lookup
 *
m­
;

624 
u64
 
¡¬t
 = 0;

625 
i
;

627 
	`wr™e_lock
(&
em_Œ“
->
lock
);

629 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, (
u64
)-1);

630 ià(!
em
)

632 
m­
 = 
em
->
m­_lookup
;

633 
i
 = 0; i < 
m­
->
num_¡res
; i++)

634 ià(
¤cdev
 =ð
m­
->
¡res
[
i
].
dev
)

635 
m­
->
¡res
[
i
].
dev
 = 
tgtdev
;

636 
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

637 
	`ä“_ex‹Á_m­
(
em
);

638 } 
¡¬t
);

639 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

640 
	}
}

647 
u64
 
	$bŒfs_dev_»¶aû_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
)

649 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

650 
u64
 
»t
 = 0;

652 
dev_»¶aû
->
»¶aû_¡©e
) {

653 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

654 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

655 
»t
 = 0;

657 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

658 
»t
 = 1000;

660 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

661 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

662 
»t
 = 
	`div64_u64
(
dev_»¶aû
->
cursÜ_Ëá
,

663 
	`div_u64
(
	`bŒfs_deviû_g‘_tÙ®_by‹s
(

664 
dev_»¶aû
->
¤cdev
), 1000));

668  
»t
;

669 
	}
}

671 
	$bŒfs_dev_»¶aû_¡©us
(
bŒfs_fs_šfo
 *
fs_šfo
,

672 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
)

674 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

676 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 0);

679 
¬gs
->
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

680 
¬gs
->
¡©us
.
»¶aû_¡©e
 = 
dev_»¶aû
->replace_state;

681 
¬gs
->
¡©us
.
time_¡¬‹d
 = 
dev_»¶aû
->time_started;

682 
¬gs
->
¡©us
.
time_¡Ý³d
 = 
dev_»¶aû
->time_stopped;

683 
¬gs
->
¡©us
.
num_wr™e_”rÜs
 =

684 
	`©omic64_»ad
(&
dev_»¶aû
->
num_wr™e_”rÜs
);

685 
¬gs
->
¡©us
.
num_uncÜ»ùabË_»ad_”rÜs
 =

686 
	`©omic64_»ad
(&
dev_»¶aû
->
num_uncÜ»ùabË_»ad_”rÜs
);

687 
¬gs
->
¡©us
.
´og»ss_1000
 = 
	`bŒfs_dev_»¶aû_´og»ss
(
fs_šfo
);

688 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

689 
	}
}

691 
	$bŒfs_dev_»¶aû_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
,

692 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
)

694 
¬gs
->
»suÉ
 = 
	`__bŒfs_dev_»¶aû_ÿnûl
(
fs_šfo
);

696 
	}
}

698 
u64
 
	$__bŒfs_dev_»¶aû_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
)

700 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

701 
bŒfs_deviû
 *
tgt_deviû
 = 
NULL
;

702 
bŒfs_Œªs_hªdË
 *
Œªs
;

703 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

704 
u64
 
»suÉ
;

705 
»t
;

707 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

708  -
EROFS
;

710 
	`mu‹x_lock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

711 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

712 
dev_»¶aû
->
»¶aû_¡©e
) {

713 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

714 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

715 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

716 
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
;

717 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

718 
Ëave
;

719 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

720 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

721 
»suÉ
 = 
BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
;

722 
tgt_deviû
 = 
dev_»¶aû
->
tgtdev
;

723 
dev_»¶aû
->
tgtdev
 = 
NULL
;

724 
dev_»¶aû
->
¤cdev
 = 
NULL
;

727 
dev_»¶aû
->
»¶aû_¡©e
 = 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
;

728 
dev_»¶aû
->
time_¡Ý³d
 = 
	`g‘_£cÚds
();

729 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

730 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

731 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

733 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

734 ià(
	`IS_ERR
(
Œªs
)) {

735 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

736  
	`PTR_ERR
(
Œªs
);

738 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

739 
	`WARN_ON
(
»t
);

740 ià(
tgt_deviû
)

741 
	`bŒfs_de¡roy_dev_»¶aû_tgtdev
(
fs_šfo
, 
tgt_deviû
);

743 
Ëave
:

744 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

745  
»suÉ
;

746 
	}
}

748 
	$bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
)

750 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

752 
	`mu‹x_lock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

753 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

754 
dev_»¶aû
->
»¶aû_¡©e
) {

755 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

756 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

757 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

758 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

760 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

761 
dev_»¶aû
->
»¶aû_¡©e
 =

762 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
;

763 
dev_»¶aû
->
time_¡Ý³d
 = 
	`g‘_£cÚds
();

764 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

765 
	`bŒfs_šfo
(
fs_šfo
, "suspending dev_replace for unmount");

769 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

770 
	`mu‹x_uÆock
(&
dev_»¶aû
->
lock_fšishšg_ÿnûl_unmouÁ
);

771 
	}
}

774 
	$bŒfs_»sume_dev_»¶aû_async
(
bŒfs_fs_šfo
 *
fs_šfo
)

776 
sk_¡ruù
 *
sk
;

777 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

779 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 1);

780 
dev_»¶aû
->
»¶aû_¡©e
) {

781 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

782 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

783 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

784 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

786 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

788 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

789 
dev_»¶aû
->
»¶aû_¡©e
 =

790 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
;

793 ià(!
dev_»¶aû
->
tgtdev
 || !dev_»¶aû->tgtdev->
bdev
) {

794 
	`bŒfs_šfo
(
fs_šfo
,

796 
	`bŒfs_šfo
(
fs_šfo
,

798 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

801 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 1);

803 
	`WARN_ON
(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
));

804 
sk
 = 
	`kth»ad_run
(
bŒfs_dev_»¶aû_kth»ad
, 
fs_šfo
, "btrfs-devrepl");

805  
	`PTR_ERR_OR_ZERO
(
sk
);

806 
	}
}

808 
	$bŒfs_dev_»¶aû_kth»ad
(*
d©a
)

810 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

811 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

812 
u64
 
´og»ss
;

814 
´og»ss
 = 
	`bŒfs_dev_»¶aû_´og»ss
(
fs_šfo
);

815 
´og»ss
 = 
	`div_u64
(progress, 10);

816 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

818 
dev_»¶aû
->
¤cdev
->
missšg
 ? "<missing disk>"

819 : 
	`rcu_¡r_d”ef
(
dev_»¶aû
->
¤cdev
->
Çme
),

820 
dev_»¶aû
->
¤cdev
->
devid
,

821 
dev_»¶aû
->
tgtdev
 ? 
	`rcu_¡r_d”ef
(dev_»¶aû->tgtdev->
Çme
)

823 ()
´og»ss
);

825 
	`bŒfs_dev_»¶aû_cÚtšue_Ú_mouÁ
(
fs_šfo
);

826 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

829 
	}
}

831 
	$bŒfs_dev_»¶aû_cÚtšue_Ú_mouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
)

833 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

834 
»t
;

836 
»t
 = 
	`bŒfs_süub_dev
(
fs_šfo
, 
dev_»¶aû
->
¤cdev
->
devid
,

837 
dev_»¶aû
->
comm™‹d_cursÜ_Ëá
,

838 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
dev_»¶aû
->
¤cdev
),

839 &
dev_»¶aû
->
süub_´og»ss
, 0, 1);

840 
»t
 = 
	`bŒfs_dev_»¶aû_fšishšg
(
fs_šfo
,„et);

841 
	`WARN_ON
(
»t
);

843 
	}
}

845 
	$bŒfs_dev_»¶aû_is_Úgošg
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
)

847 ià(!
dev_»¶aû
->
is_v®id
)

850 
dev_»¶aû
->
»¶aû_¡©e
) {

851 
BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
:

852 
BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
:

853 
BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
:

855 
BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
:

856 
BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
:

870 
	}
}

872 
	$bŒfs_dev_»¶aû_lock
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
, 
rw
)

874 ià(
rw
 == 1) {

876 
agaš
:

877 
	`wa™_ev’t
(
dev_»¶aû
->
»ad_lock_wq
,

878 
	`©omic_»ad
(&
dev_»¶aû
->
blockšg_»ad”s
) == 0);

879 
	`wr™e_lock
(&
dev_»¶aû
->
lock
);

880 ià(
	`©omic_»ad
(&
dev_»¶aû
->
blockšg_»ad”s
)) {

881 
	`wr™e_uÆock
(&
dev_»¶aû
->
lock
);

882 
agaš
;

885 
	`»ad_lock
(&
dev_»¶aû
->
lock
);

886 
	`©omic_šc
(&
dev_»¶aû
->
»ad_locks
);

888 
	}
}

890 
	$bŒfs_dev_»¶aû_uÆock
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
, 
rw
)

892 ià(
rw
 == 1) {

894 
	`ASSERT
(
	`©omic_»ad
(&
dev_»¶aû
->
blockšg_»ad”s
) == 0);

895 
	`wr™e_uÆock
(&
dev_»¶aû
->
lock
);

897 
	`ASSERT
(
	`©omic_»ad
(&
dev_»¶aû
->
»ad_locks
) > 0);

898 
	`©omic_dec
(&
dev_»¶aû
->
»ad_locks
);

899 
	`»ad_uÆock
(&
dev_»¶aû
->
lock
);

901 
	}
}

904 
	$bŒfs_dev_»¶aû_£t_lock_blockšg
(

905 
bŒfs_dev_»¶aû
 *
dev_»¶aû
)

908 
	`ASSERT
(
	`©omic_»ad
(&
dev_»¶aû
->
»ad_locks
) > 0);

909 
	`©omic_šc
(&
dev_»¶aû
->
blockšg_»ad”s
);

910 
	`»ad_uÆock
(&
dev_»¶aû
->
lock
);

911 
	}
}

914 
	$bŒfs_dev_»¶aû_þ—r_lock_blockšg
(

915 
bŒfs_dev_»¶aû
 *
dev_»¶aû
)

918 
	`ASSERT
(
	`©omic_»ad
(&
dev_»¶aû
->
»ad_locks
) > 0);

919 
	`ASSERT
(
	`©omic_»ad
(&
dev_»¶aû
->
blockšg_»ad”s
) > 0);

920 
	`»ad_lock
(&
dev_»¶aû
->
lock
);

921 ià(
	`©omic_dec_ªd_‹¡
(&
dev_»¶aû
->
blockšg_»ad”s
) &&

922 
	`wa™queue_aùive
(&
dev_»¶aû
->
»ad_lock_wq
))

923 
	`wake_up
(&
dev_»¶aû
->
»ad_lock_wq
);

924 
	}
}

926 
	$bŒfs_bio_couÁ”_šc_noblocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

928 
	`³rýu_couÁ”_šc
(&
fs_šfo
->
bio_couÁ”
);

929 
	}
}

931 
	$bŒfs_bio_couÁ”_sub
(
bŒfs_fs_šfo
 *
fs_šfo
, 
s64
 
amouÁ
)

933 
	`³rýu_couÁ”_sub
(&
fs_šfo
->
bio_couÁ”
, 
amouÁ
);

935 ià(
	`wa™queue_aùive
(&
fs_šfo
->
»¶aû_wa™
))

936 
	`wake_up
(&
fs_šfo
->
»¶aû_wa™
);

937 
	}
}

939 
	$bŒfs_bio_couÁ”_šc_blocked
(
bŒfs_fs_šfo
 *
fs_šfo
)

942 
	`³rýu_couÁ”_šc
(&
fs_šfo
->
bio_couÁ”
);

943 ià(
	`lik–y
(!
	`‹¡_b™
(
BTRFS_FS_STATE_DEV_REPLACING
,

944 &
fs_šfo
->
fs_¡©e
)))

947 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

948 
	`wa™_ev’t
(
fs_šfo
->
»¶aû_wa™
,

949 !
	`‹¡_b™
(
BTRFS_FS_STATE_DEV_REPLACING
,

950 &
fs_šfo
->
fs_¡©e
));

952 
	}
}

	@dev-replace.h

19 #ià!
defšed
(
__BTRFS_DEV_REPLACE__
)

20 
	#__BTRFS_DEV_REPLACE__


	)

22 
	gbŒfs_ioùl_dev_»¶aû_¬gs
;

24 
bŒfs_š™_dev_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
);

25 
bŒfs_run_dev_»¶aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

26 
bŒfs_fs_šfo
 *
fs_šfo
);

27 
bŒfs_aá”_dev_»¶aû_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
);

28 
bŒfs_dev_»¶aû_by_ioùl
(
bŒfs_fs_šfo
 *
fs_šfo
,

29 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
);

30 
bŒfs_dev_»¶aû_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
,

31 cÚ¡ *
tgtdev_Çme
, 
u64
 
¤cdevid
, cÚ¡ *
¤cdev_Çme
,

32 
»ad_¤c
);

33 
bŒfs_dev_»¶aû_¡©us
(
bŒfs_fs_šfo
 *
fs_šfo
,

34 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
);

35 
bŒfs_dev_»¶aû_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
,

36 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
¬gs
);

37 
bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
bŒfs_fs_šfo
 *
fs_šfo
);

38 
bŒfs_»sume_dev_»¶aû_async
(
bŒfs_fs_šfo
 *
fs_šfo
);

39 
bŒfs_dev_»¶aû_is_Úgošg
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
);

40 
bŒfs_dev_»¶aû_lock
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
, 
rw
);

41 
bŒfs_dev_»¶aû_uÆock
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
, 
rw
);

42 
bŒfs_dev_»¶aû_£t_lock_blockšg
(
bŒfs_dev_»¶aû
 *
dev_»¶aû
);

43 
bŒfs_dev_»¶aû_þ—r_lock_blockšg
(

44 
bŒfs_dev_»¶aû
 *
dev_»¶aû
);

46 
šlše
 
	$bŒfs_dev_»¶aû_¡©s_šc
(
©omic64_t
 *
¡©_v®ue
)

48 
	`©omic64_šc
(
¡©_v®ue
);

49 
	}
}

	@dir-item.c

19 
	~"ù»e.h
"

20 
	~"disk-io.h
"

21 
	~"hash.h
"

22 
	~"Œª§ùiÚ.h
"

32 
bŒfs_dœ_™em
 *
	$š£¹_w™h_ov”æow
(
bŒfs_Œªs_hªdË


33 *
Œªs
,

34 
bŒfs_roÙ
 *
roÙ
,

35 
bŒfs_·th
 *
·th
,

36 
bŒfs_key
 *
ýu_key
,

37 
u32
 
d©a_size
,

38 cÚ¡ *
Çme
,

39 
Çme_Ën
)

41 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

42 
»t
;

43 *
±r
;

44 
bŒfs_™em
 *
™em
;

45 
ex‹Á_bufãr
 *
Ëaf
;

47 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
ýu_key
, 
d©a_size
);

48 ià(
»t
 =ð-
EEXIST
) {

49 
bŒfs_dœ_™em
 *
di
;

50 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

51 ià(
di
)

52  
	`ERR_PTR
(-
EEXIST
);

53 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, 
d©a_size
);

54 } ià(
»t
 < 0)

55  
	`ERR_PTR
(
»t
);

56 
	`WARN_ON
(
»t
 > 0);

57 
Ëaf
 = 
·th
->
nodes
[0];

58 
™em
 = 
	`bŒfs_™em_Ä
(
·th
->
¦Ùs
[0]);

59 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

60 
	`BUG_ON
(
d©a_size
 > 
	`bŒfs_™em_size
(
Ëaf
, 
™em
));

61 
±r
 +ð
	`bŒfs_™em_size
(
Ëaf
, 
™em
è- 
d©a_size
;

62  (
bŒfs_dœ_™em
 *)
±r
;

63 
	}
}

69 
	$bŒfs_š£¹_x©Œ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

70 
bŒfs_roÙ
 *
roÙ
,

71 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

72 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

73 cÚ¡ *
d©a
, 
u16
 
d©a_Ën
)

75 
»t
 = 0;

76 
bŒfs_dœ_™em
 *
dœ_™em
;

77 
Çme_±r
, 
d©a_±r
;

78 
bŒfs_key
 
key
, 
loÿtiÚ
;

79 
bŒfs_disk_key
 
disk_key
;

80 
ex‹Á_bufãr
 *
Ëaf
;

81 
u32
 
d©a_size
;

83 ià(
Çme_Ën
 + 
d©a_Ën
 > 
	`BTRFS_MAX_XATTR_SIZE
(
roÙ
->
fs_šfo
))

84  -
ENOSPC
;

86 
key
.
objeùid
 = objectid;

87 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

88 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

90 
d©a_size
 = (*
dœ_™em
è+ 
Çme_Ën
 + 
d©a_Ën
;

91 
dœ_™em
 = 
	`š£¹_w™h_ov”æow
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
d©a_size
,

92 
Çme
, 
Çme_Ën
);

93 ià(
	`IS_ERR
(
dœ_™em
))

94  
	`PTR_ERR
(
dœ_™em
);

95 
	`mem£t
(&
loÿtiÚ
, 0, (location));

97 
Ëaf
 = 
·th
->
nodes
[0];

98 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, &
loÿtiÚ
);

99 
	`bŒfs_£t_dœ_™em_key
(
Ëaf
, 
dœ_™em
, &
disk_key
);

100 
	`bŒfs_£t_dœ_ty³
(
Ëaf
, 
dœ_™em
, 
BTRFS_FT_XATTR
);

101 
	`bŒfs_£t_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
, 
Çme_Ën
);

102 
	`bŒfs_£t_dœ_Œªsid
(
Ëaf
, 
dœ_™em
, 
Œªs
->
Œªsid
);

103 
	`bŒfs_£t_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
, 
d©a_Ën
);

104 
Çme_±r
 = ()(
dœ_™em
 + 1);

105 
d©a_±r
 = ()((*)
Çme_±r
 + 
Çme_Ën
);

107 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
);

108 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
d©a
, 
d©a_±r
, 
d©a_Ën
);

109 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

111  
»t
;

112 
	}
}

122 
	$bŒfs_š£¹_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


123 *
roÙ
, cÚ¡ *
Çme
, 
Çme_Ën
,

124 
bŒfs_šode
 *
dœ
, 
bŒfs_key
 *
loÿtiÚ
,

125 
u8
 
ty³
, 
u64
 
šdex
)

127 
»t
 = 0;

128 
»t2
 = 0;

129 
bŒfs_·th
 *
·th
;

130 
bŒfs_dœ_™em
 *
dœ_™em
;

131 
ex‹Á_bufãr
 *
Ëaf
;

132 
Çme_±r
;

133 
bŒfs_key
 
key
;

134 
bŒfs_disk_key
 
disk_key
;

135 
u32
 
d©a_size
;

137 
key
.
objeùid
 = 
	`bŒfs_šo
(
dœ
);

138 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

139 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

141 
·th
 = 
	`bŒfs_®loc_·th
();

142 ià(!
·th
)

143  -
ENOMEM
;

144 
·th
->
Ëave_¥šnšg
 = 1;

146 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
loÿtiÚ
);

148 
d©a_size
 = (*
dœ_™em
è+ 
Çme_Ën
;

149 
dœ_™em
 = 
	`š£¹_w™h_ov”æow
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
d©a_size
,

150 
Çme
, 
Çme_Ën
);

151 ià(
	`IS_ERR
(
dœ_™em
)) {

152 
»t
 = 
	`PTR_ERR
(
dœ_™em
);

153 ià(
»t
 =ð-
EEXIST
)

154 
£cÚd_š£¹
;

155 
out_ä“
;

158 
Ëaf
 = 
·th
->
nodes
[0];

159 
	`bŒfs_£t_dœ_™em_key
(
Ëaf
, 
dœ_™em
, &
disk_key
);

160 
	`bŒfs_£t_dœ_ty³
(
Ëaf
, 
dœ_™em
, 
ty³
);

161 
	`bŒfs_£t_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
, 0);

162 
	`bŒfs_£t_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
, 
Çme_Ën
);

163 
	`bŒfs_£t_dœ_Œªsid
(
Ëaf
, 
dœ_™em
, 
Œªs
->
Œªsid
);

164 
Çme_±r
 = ()(
dœ_™em
 + 1);

166 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
);

167 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

169 
£cÚd_š£¹
:

171 ià(
roÙ
 =ðroÙ->
fs_šfo
->
Œ“_roÙ
) {

172 
»t
 = 0;

173 
out_ä“
;

175 
	`bŒfs_»Ëa£_·th
(
·th
);

177 
»t2
 = 
	`bŒfs_š£¹_d–ayed_dœ_šdex
(
Œªs
, 
roÙ
->
fs_šfo
, 
Çme
,

178 
Çme_Ën
, 
dœ
, &
disk_key
, 
ty³
, 
šdex
);

179 
out_ä“
:

180 
	`bŒfs_ä“_·th
(
·th
);

181 ià(
»t
)

182  
»t
;

183 ià(
»t2
)

184  
»t2
;

186 
	}
}

193 
bŒfs_dœ_™em
 *
	$bŒfs_lookup_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

194 
bŒfs_roÙ
 *
roÙ
,

195 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

196 cÚ¡ *
Çme
, 
Çme_Ën
,

197 
mod
)

199 
»t
;

200 
bŒfs_key
 
key
;

201 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

202 
cow
 = 
mod
 != 0;

204 
key
.
objeùid
 = 
dœ
;

205 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

207 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

209 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 
cow
);

210 ià(
»t
 < 0)

211  
	`ERR_PTR
(
»t
);

212 ià(
»t
 > 0)

213  
NULL
;

215  
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

216 
	}
}

218 
	$bŒfs_check_dœ_™em_cÞlisiÚ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
dœ
,

219 cÚ¡ *
Çme
, 
Çme_Ën
)

221 
»t
;

222 
bŒfs_key
 
key
;

223 
bŒfs_dœ_™em
 *
di
;

224 
d©a_size
;

225 
ex‹Á_bufãr
 *
Ëaf
;

226 
¦Ù
;

227 
bŒfs_·th
 *
·th
;

230 
·th
 = 
	`bŒfs_®loc_·th
();

231 ià(!
·th
)

232  -
ENOMEM
;

234 
key
.
objeùid
 = 
dœ
;

235 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

236 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

238 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

241 ià(
»t
 < 0)

242 
out
;

245 ià(
»t
 > 0) {

246 
»t
 = 0;

247 
out
;

251 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

252 ià(
di
) {

254 
»t
 = -
EEXIST
;

255 
out
;

262 
d©a_size
 = (*
di
è+ 
Çme_Ën
;

263 
Ëaf
 = 
·th
->
nodes
[0];

264 
¦Ù
 = 
·th
->
¦Ùs
[0];

265 ià(
d©a_size
 + 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
) +

266 (
bŒfs_™em
è> 
	`BTRFS_LEAF_DATA_SIZE
(
roÙ
->
fs_šfo
)) {

267 
»t
 = -
EOVERFLOW
;

270 
»t
 = 0;

272 
out
:

273 
	`bŒfs_ä“_·th
(
·th
);

274  
»t
;

275 
	}
}

285 
bŒfs_dœ_™em
 *

286 
	$bŒfs_lookup_dœ_šdex_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

287 
bŒfs_roÙ
 *
roÙ
,

288 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

289 
u64
 
objeùid
, cÚ¡ *
Çme
, 
Çme_Ën
,

290 
mod
)

292 
»t
;

293 
bŒfs_key
 
key
;

294 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

295 
cow
 = 
mod
 != 0;

297 
key
.
objeùid
 = 
dœ
;

298 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

299 
key
.
off£t
 = 
objeùid
;

301 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 
cow
);

302 ià(
»t
 < 0)

303  
	`ERR_PTR
(
»t
);

304 ià(
»t
 > 0)

305  
	`ERR_PTR
(-
ENOENT
);

306  
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

307 
	}
}

309 
bŒfs_dœ_™em
 *

310 
	$bŒfs_£¬ch_dœ_šdex_™em
(
bŒfs_roÙ
 *
roÙ
,

311 
bŒfs_·th
 *
·th
, 
u64
 
dœid
,

312 cÚ¡ *
Çme
, 
Çme_Ën
)

314 
ex‹Á_bufãr
 *
Ëaf
;

315 
bŒfs_dœ_™em
 *
di
;

316 
bŒfs_key
 
key
;

317 
u32
 
Ä™ems
;

318 
»t
;

320 
key
.
objeùid
 = 
dœid
;

321 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

322 
key
.
off£t
 = 0;

324 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

325 ià(
»t
 < 0)

326  
	`ERR_PTR
(
»t
);

328 
Ëaf
 = 
·th
->
nodes
[0];

329 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

332 ià(
·th
->
¦Ùs
[0] >ð
Ä™ems
) {

333 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

334 ià(
»t
 < 0)

335  
	`ERR_PTR
(
»t
);

336 ià(
»t
 > 0)

338 
Ëaf
 = 
·th
->
nodes
[0];

339 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

343 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

344 ià(
key
.
objeùid
 !ð
dœid
 || key.
ty³
 !ð
BTRFS_DIR_INDEX_KEY
)

347 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
,

348 
Çme
, 
Çme_Ën
);

349 ià(
di
)

350  
di
;

352 
·th
->
¦Ùs
[0]++;

354  
NULL
;

355 
	}
}

357 
bŒfs_dœ_™em
 *
	$bŒfs_lookup_x©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

358 
bŒfs_roÙ
 *
roÙ
,

359 
bŒfs_·th
 *
·th
, 
u64
 
dœ
,

360 cÚ¡ *
Çme
, 
u16
 
Çme_Ën
,

361 
mod
)

363 
»t
;

364 
bŒfs_key
 
key
;

365 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

366 
cow
 = 
mod
 != 0;

368 
key
.
objeùid
 = 
dœ
;

369 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

370 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
Çme
, 
Çme_Ën
);

371 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 
cow
);

372 ià(
»t
 < 0)

373  
	`ERR_PTR
(
»t
);

374 ià(
»t
 > 0)

375  
NULL
;

377  
	`bŒfs_m©ch_dœ_™em_Çme
(
roÙ
->
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

378 
	}
}

385 
bŒfs_dœ_™em
 *
	$bŒfs_m©ch_dœ_™em_Çme
(
bŒfs_fs_šfo
 *
fs_šfo
,

386 
bŒfs_·th
 *
·th
,

387 cÚ¡ *
Çme
, 
Çme_Ën
)

389 
bŒfs_dœ_™em
 *
dœ_™em
;

390 
Çme_±r
;

391 
u32
 
tÙ®_Ën
;

392 
u32
 
cur
 = 0;

393 
u32
 
this_Ën
;

394 
ex‹Á_bufãr
 *
Ëaf
;

396 
Ëaf
 = 
·th
->
nodes
[0];

397 
dœ_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dœ_™em
);

399 
tÙ®_Ën
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

400 
cur
 < 
tÙ®_Ën
) {

401 
this_Ën
 = (*
dœ_™em
) +

402 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
) +

403 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
);

404 
Çme_±r
 = ()(
dœ_™em
 + 1);

406 ià(
	`v”ify_dœ_™em
(
fs_šfo
, 
Ëaf
, 
·th
->
¦Ùs
[0], 
dœ_™em
))

407  
NULL
;

408 ià(
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
è=ð
Çme_Ën
 &&

409 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
) == 0)

410  
dœ_™em
;

412 
cur
 +ð
this_Ën
;

413 
dœ_™em
 = (
bŒfs_dœ_™em
 *)((*)dir_item +

414 
this_Ën
);

416  
NULL
;

417 
	}
}

423 
	$bŒfs_d–‘e_Úe_dœ_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

424 
bŒfs_roÙ
 *
roÙ
,

425 
bŒfs_·th
 *
·th
,

426 
bŒfs_dœ_™em
 *
di
)

429 
ex‹Á_bufãr
 *
Ëaf
;

430 
u32
 
sub_™em_Ën
;

431 
u32
 
™em_Ën
;

432 
»t
 = 0;

434 
Ëaf
 = 
·th
->
nodes
[0];

435 
sub_™em_Ën
 = (*
di
è+ 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, di) +

436 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

437 
™em_Ën
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

438 ià(
sub_™em_Ën
 =ð
™em_Ën
) {

439 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

442 
±r
 = ()
di
;

443 
¡¬t
;

445 
¡¬t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

446 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
sub_™em_Ën
,

447 
™em_Ën
 - (
±r
 + 
sub_™em_Ën
 - 
¡¬t
));

448 
	`bŒfs_Œunÿ‹_™em
(
roÙ
->
fs_šfo
, 
·th
,

449 
™em_Ën
 - 
sub_™em_Ën
, 1);

451  
»t
;

452 
	}
}

454 
	$v”ify_dœ_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

455 
ex‹Á_bufãr
 *
Ëaf
,

456 
¦Ù
,

457 
bŒfs_dœ_™em
 *
dœ_™em
)

459 
u16
 
Çm–’
 = 
BTRFS_NAME_LEN
;

460 
»t
;

461 
u8
 
ty³
 = 
	`bŒfs_dœ_ty³
(
Ëaf
, 
dœ_™em
);

463 ià(
ty³
 >ð
BTRFS_FT_MAX
) {

464 
	`bŒfs_ü™
(
fs_šfo
, "šv®id dœ i‹my³: %d", ()
ty³
);

468 ià(
ty³
 =ð
BTRFS_FT_XATTR
)

469 
Çm–’
 = 
XATTR_NAME_MAX
;

471 ià(
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
è> 
Çm–’
) {

472 
	`bŒfs_ü™
(
fs_šfo
, "invalid dir item‚ame†en: %u",

473 ()
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
));

477 
Çm–’
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
);

478 
»t
 = 
	`bŒfs_is_Çme_Ën_v®id
(
Ëaf
, 
¦Ù
,

479 ()(
dœ_™em
 + 1), 
Çm–’
);

480 ià(!
»t
)

484 ià((
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
) +

485 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
)) >

486 
	`BTRFS_MAX_XATTR_SIZE
(
fs_šfo
)) {

487 
	`bŒfs_ü™
(
fs_šfo
, "invalid dir item‚ame + data†en: %u + %u",

488 ()
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
dœ_™em
),

489 ()
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
dœ_™em
));

494 
	}
}

496 
boÞ
 
	$bŒfs_is_Çme_Ën_v®id
(
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
,

497 
¡¬t
, 
u16
 
Çme_Ën
)

499 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Ëaf
->fs_info;

500 
bŒfs_key
 
key
;

501 
u32
 
»ad_¡¬t
;

502 
u32
 
»ad_’d
;

503 
u32
 
™em_¡¬t
;

504 
u32
 
™em_’d
;

505 
u32
 
size
;

506 
boÞ
 
»t
 = 
Œue
;

508 
	`ASSERT
(
¡¬t
 > 
BTRFS_LEAF_DATA_OFFSET
);

510 
»ad_¡¬t
 = 
¡¬t
 - 
BTRFS_LEAF_DATA_OFFSET
;

511 
»ad_’d
 = 
»ad_¡¬t
 + 
Çme_Ën
;

512 
™em_¡¬t
 = 
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
¦Ù
);

513 
™em_’d
 = 
	`bŒfs_™em_’d_Ä
(
Ëaf
, 
¦Ù
);

515 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

517 
key
.
ty³
) {

518 
BTRFS_DIR_ITEM_KEY
:

519 
BTRFS_XATTR_ITEM_KEY
:

520 
BTRFS_DIR_INDEX_KEY
:

521 
size
 = (
bŒfs_dœ_™em
);

523 
BTRFS_INODE_REF_KEY
:

524 
size
 = (
bŒfs_šode_»f
);

526 
BTRFS_INODE_EXTREF_KEY
:

527 
size
 = (
bŒfs_šode_exŒef
);

529 
BTRFS_ROOT_REF_KEY
:

530 
BTRFS_ROOT_BACKREF_KEY
:

531 
size
 = (
bŒfs_roÙ_»f
);

534 
»t
 = 
çl£
;

535 
out
;

538 ià(
»ad_¡¬t
 < 
™em_¡¬t
) {

539 
»t
 = 
çl£
;

540 
out
;

542 ià(
»ad_’d
 > 
™em_’d
) {

543 
»t
 = 
çl£
;

544 
out
;

548 ià(
»ad_¡¬t
 - 
™em_¡¬t
 < 
size
) {

549 
»t
 = 
çl£
;

550 
out
;

553 
out
:

554 ià(!
»t
)

555 
	`bŒfs_ü™
(
fs_šfo
, "invalid dir item‚ame†en: %u",

556 ()
Çme_Ën
);

557  
»t
;

558 
	}
}

	@disk-io.c

19 
	~<lšux/fs.h
>

20 
	~<lšux/blkdev.h
>

21 
	~<lšux/sÿ‰”li¡.h
>

22 
	~<lšux/sw­.h
>

23 
	~<lšux/¿dix-Œ“.h
>

24 
	~<lšux/wr™eback.h
>

25 
	~<lšux/bufãr_h—d.h
>

26 
	~<lšux/wÜkqueue.h
>

27 
	~<lšux/kth»ad.h
>

28 
	~<lšux/¦ab.h
>

29 
	~<lšux/mig¿‹.h
>

30 
	~<lšux/¿‹lim™.h
>

31 
	~<lšux/uuid.h
>

32 
	~<lšux/£m­hÜe.h
>

33 
	~<asm/uÇligÃd.h
>

34 
	~"ù»e.h
"

35 
	~"disk-io.h
"

36 
	~"hash.h
"

37 
	~"Œª§ùiÚ.h
"

38 
	~"bŒfs_šode.h
"

39 
	~"vÞumes.h
"

40 
	~"´št-Œ“.h
"

41 
	~"lockšg.h
"

42 
	~"Œ“-log.h
"

43 
	~"ä“-¥aû-ÿche.h
"

44 
	~"ä“-¥aû-Œ“.h
"

45 
	~"šode-m­.h
"

46 
	~"check-š‹gr™y.h
"

47 
	~"rcu-¡ršg.h
"

48 
	~"dev-»¶aû.h
"

49 
	~"¿id56.h
"

50 
	~"sysfs.h
"

51 
	~"qgroup.h
"

52 
	~"com´essiÚ.h
"

54 #ifdeà
CONFIG_X86


55 
	~<asm/ýuã©u».h
>

58 
	#BTRFS_SUPER_FLAG_SUPP
 (
BTRFS_HEADER_FLAG_WRITTEN
 |\

59 
BTRFS_HEADER_FLAG_RELOC
 |\

60 
BTRFS_SUPER_FLAG_ERROR
 |\

61 
BTRFS_SUPER_FLAG_SEEDING
 |\

62 
BTRFS_SUPER_FLAG_METADUMP
)

	)

64 cÚ¡ 
ex‹Á_io_Ýs
 
	gbŒ“_ex‹Á_io_Ýs
;

65 
’d_wÜkqueue_â
(
bŒfs_wÜk
 *
wÜk
);

66 
ä“_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
);

67 
bŒfs_check_su³r_v®id
(
bŒfs_fs_šfo
 *
fs_šfo
);

68 
bŒfs_de¡roy_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
);

69 
bŒfs_de¡roy_d–ayed_»fs
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

70 
bŒfs_fs_šfo
 *
fs_šfo
);

71 
bŒfs_de¡roy_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
);

72 
bŒfs_de¡roy_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

73 
ex‹Á_io_Œ“
 *
dœty_·ges
,

74 
m¬k
);

75 
bŒfs_de¡roy_pšÃd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

76 
ex‹Á_io_Œ“
 *
pšÃd_ex‹Ás
);

77 
bŒfs_þ—nup_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
);

78 
bŒfs_”rÜ_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
);

85 
	sbŒfs_’d_io_wq
 {

86 
bio
 *
	mbio
;

87 
bio_’d_io_t
 *
	m’d_io
;

88 *
	m´iv©e
;

89 
bŒfs_fs_šfo
 *
	mšfo
;

90 
blk_¡©us_t
 
	m¡©us
;

91 
bŒfs_wq_’dio_ty³
 
	mm‘ad©a
;

92 
bŒfs_wÜk
 
	mwÜk
;

95 
kmem_ÿche
 *
	gbŒfs_’d_io_wq_ÿche
;

97 
__š™
 
	$bŒfs_’d_io_wq_š™
()

99 
bŒfs_’d_io_wq_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_end_io_wq",

100 (
bŒfs_’d_io_wq
),

102 
SLAB_MEM_SPREAD
,

103 
NULL
);

104 ià(!
bŒfs_’d_io_wq_ÿche
)

105  -
ENOMEM
;

107 
	}
}

109 
	$bŒfs_’d_io_wq_ex™
()

111 
	`kmem_ÿche_de¡roy
(
bŒfs_’d_io_wq_ÿche
);

112 
	}
}

119 
	sasync_subm™_bio
 {

120 *
	m´iv©e_d©a
;

121 
bŒfs_fs_šfo
 *
	mfs_šfo
;

122 
bio
 *
	mbio
;

123 
ex‹Á_subm™_bio_hook_t
 *
	msubm™_bio_¡¬t
;

124 
ex‹Á_subm™_bio_hook_t
 *
	msubm™_bio_dÚe
;

125 
	mmœrÜ_num
;

126 
	mbio_æags
;

131 
u64
 
	mbio_off£t
;

132 
bŒfs_wÜk
 
	mwÜk
;

133 
blk_¡©us_t
 
	m¡©us
;

159 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


160 #ià
BTRFS_MAX_LEVEL
 != 8

164 
	sbŒfs_lockd•_key£t
 {

165 
u64
 
	mid
;

166 cÚ¡ *
	mÇme_¡em
;

167 
	mÇmes
[
BTRFS_MAX_LEVEL
 + 1][20];

168 
lock_þass_key
 
	mkeys
[
BTRFS_MAX_LEVEL
 + 1];

169 } 
	gbŒfs_lockd•_key£ts
[] = {

170 { .
id
 = 
BTRFS_ROOT_TREE_OBJECTID
, .
	gÇme_¡em
 = "root" },

171 { .
	gid
 = 
BTRFS_EXTENT_TREE_OBJECTID
, .
	gÇme_¡em
 = "extent" },

172 { .
	gid
 = 
BTRFS_CHUNK_TREE_OBJECTID
, .
	gÇme_¡em
 = "chunk" },

173 { .
	gid
 = 
BTRFS_DEV_TREE_OBJECTID
, .
	gÇme_¡em
 = "dev" },

174 { .
	gid
 = 
BTRFS_FS_TREE_OBJECTID
, .
	gÇme_¡em
 = "fs" },

175 { .
	gid
 = 
BTRFS_CSUM_TREE_OBJECTID
, .
	gÇme_¡em
 = "csum" },

176 { .
	gid
 = 
BTRFS_QUOTA_TREE_OBJECTID
, .
	gÇme_¡em
 = "quota" },

177 { .
	gid
 = 
BTRFS_TREE_LOG_OBJECTID
, .
	gÇme_¡em
 = "log" },

178 { .
	gid
 = 
BTRFS_TREE_RELOC_OBJECTID
, .
	gÇme_¡em
 = "treloc" },

179 { .
	gid
 = 
BTRFS_DATA_RELOC_TREE_OBJECTID
, .
	gÇme_¡em
 = "dreloc" },

180 { .
	gid
 = 
BTRFS_UUID_TREE_OBJECTID
, .
	gÇme_¡em
 = "uuid" },

181 { .
	gid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
, .
	gÇme_¡em
 = "free-space" },

182 { .
	gid
 = 0, .
	gÇme_¡em
 = "tree" },

185 
__š™
 
	$bŒfs_š™_lockd•
()

187 
i
, 
j
;

190 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_lockd•_key£ts
); i++) {

191 
bŒfs_lockd•_key£t
 *
ks
 = &
bŒfs_lockd•_key£ts
[
i
];

193 
j
 = 0; j < 
	`ARRAY_SIZE
(
ks
->
Çmes
); j++)

194 
	`¢´štf
(
ks
->
Çmes
[
j
], (ks->names[j]),

195 "bŒfs-%s-%02d", 
ks
->
Çme_¡em
, 
j
);

197 
	}
}

199 
	$bŒfs_£t_bufãr_lockd•_þass
(
u64
 
objeùid
, 
ex‹Á_bufãr
 *
eb
,

200 
Ëv–
)

202 
bŒfs_lockd•_key£t
 *
ks
;

204 
	`BUG_ON
(
Ëv–
 >ð
	`ARRAY_SIZE
(
ks
->
keys
));

207 
ks
 = 
bŒfs_lockd•_key£ts
; ks->
id
; ks++)

208 ià(
ks
->
id
 =ð
objeùid
)

211 
	`lockd•_£t_þass_ªd_Çme
(&
eb
->
lock
,

212 &
ks
->
keys
[
Ëv–
], ks->
Çmes
[level]);

213 
	}
}

221 
ex‹Á_m­
 *
	$bŒ“_g‘_ex‹Á
(
bŒfs_šode
 *
šode
,

222 
·ge
 *·ge, 
size_t
 
pg_off£t
, 
u64
 
¡¬t
, u64 
Ën
,

223 
ü—‹
)

225 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

226 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

227 
ex‹Á_m­
 *
em
;

228 
»t
;

230 
	`»ad_lock
(&
em_Œ“
->
lock
);

231 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

232 ià(
em
) {

233 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

234 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

235 
out
;

237 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

239 
em
 = 
	`®loc_ex‹Á_m­
();

240 ià(!
em
) {

241 
em
 = 
	`ERR_PTR
(-
ENOMEM
);

242 
out
;

244 
em
->
¡¬t
 = 0;

245 
em
->
Ën
 = (
u64
)-1;

246 
em
->
block_Ën
 = (
u64
)-1;

247 
em
->
block_¡¬t
 = 0;

248 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

250 
	`wr™e_lock
(&
em_Œ“
->
lock
);

251 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

252 ià(
»t
 =ð-
EEXIST
) {

253 
	`ä“_ex‹Á_m­
(
em
);

254 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

255 ià(!
em
)

256 
em
 = 
	`ERR_PTR
(-
EIO
);

257 } ià(
»t
) {

258 
	`ä“_ex‹Á_m­
(
em
);

259 
em
 = 
	`ERR_PTR
(
»t
);

261 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

263 
out
:

264  
em
;

265 
	}
}

267 
u32
 
	$bŒfs_csum_d©a
(cÚ¡ *
d©a
, 
u32
 
£ed
, 
size_t
 
Ën
)

269  
	`bŒfs_üc32c
(
£ed
, 
d©a
, 
Ën
);

270 
	}
}

272 
	$bŒfs_csum_fš®
(
u32
 
üc
, 
u8
 *
»suÉ
)

274 
	`put_uÇligÃd_Ë32
(~
üc
, 
»suÉ
);

275 
	}
}

281 
	$csum_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

282 
ex‹Á_bufãr
 *
buf
,

283 
v”ify
)

285 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

286 *
»suÉ
 = 
NULL
;

287 
Ën
;

288 
cur_Ën
;

289 
off£t
 = 
BTRFS_CSUM_SIZE
;

290 *
kaddr
;

291 
m­_¡¬t
;

292 
m­_Ën
;

293 
”r
;

294 
u32
 
üc
 = ~(u32)0;

295 
šlše_»suÉ
;

297 
Ën
 = 
buf
->ËÀ- 
off£t
;

298 
Ën
 > 0) {

299 
”r
 = 
	`m­_´iv©e_ex‹Á_bufãr
(
buf
, 
off£t
, 32,

300 &
kaddr
, &
m­_¡¬t
, &
m­_Ën
);

301 ià(
”r
)

302  
”r
;

303 
cur_Ën
 = 
	`mš
(
Ën
, 
m­_Ën
 - (
off£t
 - 
m­_¡¬t
));

304 
üc
 = 
	`bŒfs_csum_d©a
(
kaddr
 + 
off£t
 - 
m­_¡¬t
,

305 
üc
, 
cur_Ën
);

306 
Ën
 -ð
cur_Ën
;

307 
off£t
 +ð
cur_Ën
;

309 ià(
csum_size
 > (
šlše_»suÉ
)) {

310 
»suÉ
 = 
	`kz®loc
(
csum_size
, 
GFP_NOFS
);

311 ià(!
»suÉ
)

312  -
ENOMEM
;

314 
»suÉ
 = (*)&
šlše_»suÉ
;

317 
	`bŒfs_csum_fš®
(
üc
, 
»suÉ
);

319 ià(
v”ify
) {

320 ià(
	`memcmp_ex‹Á_bufãr
(
buf
, 
»suÉ
, 0, 
csum_size
)) {

321 
u32
 
v®
;

322 
u32
 
found
 = 0;

323 
	`memýy
(&
found
, 
»suÉ
, 
csum_size
);

325 
	`»ad_ex‹Á_bufãr
(
buf
, &
v®
, 0, 
csum_size
);

326 
	`bŒfs_w¬n_¾
(
fs_šfo
,

328 
fs_šfo
->
sb
->
s_id
, 
buf
->
¡¬t
,

329 
v®
, 
found
, 
	`bŒfs_h—d”_Ëv–
(
buf
));

330 ià(
»suÉ
 !ð(*)&
šlše_»suÉ
)

331 
	`kä“
(
»suÉ
);

332  -
EUCLEAN
;

335 
	`wr™e_ex‹Á_bufãr
(
buf
, 
»suÉ
, 0, 
csum_size
);

337 ià(
»suÉ
 !ð(*)&
šlše_»suÉ
)

338 
	`kä“
(
»suÉ
);

340 
	}
}

348 
	$v”ify_·»Á_Œªsid
(
ex‹Á_io_Œ“
 *
io_Œ“
,

349 
ex‹Á_bufãr
 *
eb
, 
u64
 
·»Á_Œªsid
,

350 
©omic
)

352 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

353 
»t
;

354 
boÞ
 
Ãed_lock
 = (
cu¼’t
->
jouº®_šfo
 =ð
BTRFS_SEND_TRANS_STUB
);

356 ià(!
·»Á_Œªsid
 || 
	`bŒfs_h—d”_g’”©iÚ
(
eb
) ==…arent_transid)

359 ià(
©omic
)

360  -
EAGAIN
;

362 ià(
Ãed_lock
) {

363 
	`bŒfs_Œ“_»ad_lock
(
eb
);

364 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

367 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
eb
->
¡¬t
,ƒb->¡¬ˆ+ƒb->
Ën
 - 1,

368 &
ÿched_¡©e
);

369 ià(
	`ex‹Á_bufãr_u±od©e
(
eb
) &&

370 
	`bŒfs_h—d”_g’”©iÚ
(
eb
è=ð
·»Á_Œªsid
) {

371 
»t
 = 0;

372 
out
;

374 
	`bŒfs_”r_¾
(
eb
->
fs_šfo
,

376 
eb
->
¡¬t
,

377 
·»Á_Œªsid
, 
	`bŒfs_h—d”_g’”©iÚ
(
eb
));

378 
»t
 = 1;

388 ià(!
	`ex‹Á_bufãr_und”_io
(
eb
))

389 
	`þ—r_ex‹Á_bufãr_u±od©e
(
eb
);

390 
out
:

391 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
eb
->
¡¬t
,ƒb->¡¬ˆ+ƒb->
Ën
 - 1,

392 &
ÿched_¡©e
, 
GFP_NOFS
);

393 ià(
Ãed_lock
)

394 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

395  
»t
;

396 
	}
}

402 
	$bŒfs_check_su³r_csum
(
bŒfs_fs_šfo
 *
fs_šfo
,

403 *
¿w_disk_sb
)

405 
bŒfs_su³r_block
 *
disk_sb
 =

406 (
bŒfs_su³r_block
 *)
¿w_disk_sb
;

407 
u16
 
csum_ty³
 = 
	`bŒfs_su³r_csum_ty³
(
disk_sb
);

408 
»t
 = 0;

410 ià(
csum_ty³
 =ð
BTRFS_CSUM_TYPE_CRC32
) {

411 
u32
 
üc
 = ~(u32)0;

412 cÚ¡ 
csum_size
 = (
üc
);

413 
»suÉ
[
csum_size
];

420 
üc
 = 
	`bŒfs_csum_d©a
(
¿w_disk_sb
 + 
BTRFS_CSUM_SIZE
,

421 
üc
, 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
);

422 
	`bŒfs_csum_fš®
(
üc
, 
»suÉ
);

424 ià(
	`memcmp
(
¿w_disk_sb
, 
»suÉ
, 
csum_size
))

425 
»t
 = 1;

428 ià(
csum_ty³
 >ð
	`ARRAY_SIZE
(
bŒfs_csum_sizes
)) {

429 
	`bŒfs_”r
(
fs_šfo
, "unsupported checksum‡lgorithm %u",

430 
csum_ty³
);

431 
»t
 = 1;

434  
»t
;

435 
	}
}

441 
	$bŒ“_»ad_ex‹Á_bufãr_·ges
(
bŒfs_fs_šfo
 *
fs_šfo
,

442 
ex‹Á_bufãr
 *
eb
,

443 
u64
 
·»Á_Œªsid
)

445 
ex‹Á_io_Œ“
 *
io_Œ“
;

446 
çžed
 = 0;

447 
»t
;

448 
num_cÝ›s
 = 0;

449 
mœrÜ_num
 = 0;

450 
çžed_mœrÜ
 = 0;

452 
	`þ—r_b™
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bæags
);

453 
io_Œ“
 = &
	`BTRFS_I
(
fs_šfo
->
bŒ“_šode
)->io_tree;

455 
»t
 = 
	`»ad_ex‹Á_bufãr_·ges
(
io_Œ“
, 
eb
, 
WAIT_COMPLETE
,

456 
bŒ“_g‘_ex‹Á
, 
mœrÜ_num
);

457 ià(!
»t
) {

458 ià(!
	`v”ify_·»Á_Œªsid
(
io_Œ“
, 
eb
,

459 
·»Á_Œªsid
, 0))

462 
»t
 = -
EIO
;

470 ià(
	`‹¡_b™
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bæags
))

473 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
,

474 
eb
->
¡¬t
,ƒb->
Ën
);

475 ià(
num_cÝ›s
 == 1)

478 ià(!
çžed_mœrÜ
) {

479 
çžed
 = 1;

480 
çžed_mœrÜ
 = 
eb
->
»ad_mœrÜ
;

483 
mœrÜ_num
++;

484 ià(
mœrÜ_num
 =ð
çžed_mœrÜ
)

485 
mœrÜ_num
++;

487 ià(
mœrÜ_num
 > 
num_cÝ›s
)

491 ià(
çžed
 && !
»t
 && 
çžed_mœrÜ
)

492 
	`»·œ_eb_io_çžu»
(
fs_šfo
, 
eb
, 
çžed_mœrÜ
);

494  
»t
;

495 
	}
}

502 
	$csum_dœty_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
, 
·ge
 *page)

504 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

505 
u64
 
found_¡¬t
;

506 
ex‹Á_bufãr
 *
eb
;

508 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

509 ià(
·ge
 !ð
eb
->
·ges
[0])

512 
found_¡¬t
 = 
	`bŒfs_h—d”_by‹Ä
(
eb
);

517 ià(
	`WARN_ON
(
found_¡¬t
 !ð
¡¬t
))

518  -
EUCLEAN
;

519 ià(
	`WARN_ON
(!
	`PageU±od©e
(
·ge
)))

520  -
EUCLEAN
;

522 
	`ASSERT
(
	`memcmp_ex‹Á_bufãr
(
eb
, 
fs_šfo
->
fsid
,

523 
	`bŒfs_h—d”_fsid
(), 
BTRFS_FSID_SIZE
) == 0);

525  
	`csum_Œ“_block
(
fs_šfo
, 
eb
, 0);

526 
	}
}

528 
	$check_Œ“_block_fsid
(
bŒfs_fs_šfo
 *
fs_šfo
,

529 
ex‹Á_bufãr
 *
eb
)

531 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

532 
u8
 
fsid
[
BTRFS_FSID_SIZE
];

533 
»t
 = 1;

535 
	`»ad_ex‹Á_bufãr
(
eb
, 
fsid
, 
	`bŒfs_h—d”_fsid
(), 
BTRFS_FSID_SIZE
);

536 
fs_deviûs
) {

537 ià(!
	`memcmp
(
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
)) {

538 
»t
 = 0;

541 
fs_deviûs
 = fs_deviûs->
£ed
;

543  
»t
;

544 
	}
}

546 
	#CORRUPT
(
»asÚ
, 
eb
, 
roÙ
, 
¦Ù
) \

547 
	`bŒfs_ü™
(
roÙ
->
fs_šfo
, \

549 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0 ? "leaf" : "node", \

550 
»asÚ
, 
	`bŒfs_h—d”_by‹Ä
(
eb
), 
roÙ
->
objeùid
, 
¦Ù
)

	)

552 
nošlše
 
	$check_Ëaf
(
bŒfs_roÙ
 *
roÙ
,

553 
ex‹Á_bufãr
 *
Ëaf
)

555 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

556 
bŒfs_key
 
key
;

557 
bŒfs_key
 
Ëaf_key
;

558 
u32
 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

559 
¦Ù
;

569 ià(
Ä™ems
 =ð0 && !
	`bŒfs_h—d”_æag
(
Ëaf
, 
BTRFS_HEADER_FLAG_RELOC
)) {

570 
bŒfs_roÙ
 *
check_roÙ
;

572 
key
.
objeùid
 = 
	`bŒfs_h—d”_owÃr
(
Ëaf
);

573 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

574 
key
.
off£t
 = (
u64
)-1;

576 
check_roÙ
 = 
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, &
key
, 
çl£
);

581 ià(!
	`IS_ERR_OR_NULL
(
check_roÙ
)) {

582 
ex‹Á_bufãr
 *
eb
;

584 
eb
 = 
	`bŒfs_roÙ_node
(
check_roÙ
);

586 ià(
Ëaf
 !ð
eb
) {

587 
	`CORRUPT
("non-root†eaf's‚ritems is 0",

588 
Ëaf
, 
check_roÙ
, 0);

589 
	`ä“_ex‹Á_bufãr
(
eb
);

590  -
EIO
;

592 
	`ä“_ex‹Á_bufãr
(
eb
);

597 ià(
Ä™ems
 == 0)

601 ià(
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 0è+ 
	`bŒfs_™em_size_Ä
(leaf, 0) !=

602 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

603 
	`CORRUPT
("šv®id i‹m off£ˆsiz·œ", 
Ëaf
, 
roÙ
, 0);

604  -
EIO
;

614 
¦Ù
 = 0; slÙ < 
Ä™ems
 - 1; slot++) {

615 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
Ëaf_key
, 
¦Ù
);

616 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
 + 1);

619 ià(
	`bŒfs_comp_ýu_keys
(&
Ëaf_key
, &
key
) >= 0) {

620 
	`CORRUPT
("bad key ord”", 
Ëaf
, 
roÙ
, 
¦Ù
);

621  -
EIO
;

629 ià(
	`bŒfs_™em_off£t_Ä
(
Ëaf
, 
¦Ù
) !=

630 
	`bŒfs_™em_’d_Ä
(
Ëaf
, 
¦Ù
 + 1)) {

631 
	`CORRUPT
("¦Ù off£ˆbad", 
Ëaf
, 
roÙ
, 
¦Ù
);

632  -
EIO
;

640 ià(
	`bŒfs_™em_’d_Ä
(
Ëaf
, 
¦Ù
) >

641 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
)) {

642 
	`CORRUPT
("¦Ùƒnd outsidoàËaf", 
Ëaf
, 
roÙ
, 
¦Ù
);

643  -
EIO
;

648 
	}
}

650 
	$check_node
(
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
node
)

652 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
node
);

653 
bŒfs_key
 
key
, 
Ãxt_key
;

654 
¦Ù
;

655 
u64
 
by‹Ä
;

656 
»t
 = 0;

658 ià(
Ä
 =ð0 ||‚¸> 
	`BTRFS_NODEPTRS_PER_BLOCK
(
roÙ
->
fs_šfo
)) {

659 
	`bŒfs_ü™
(
roÙ
->
fs_šfo
,

661 
node
->
¡¬t
, 
roÙ
->
objeùid
, 
Ä
);

662  -
EIO
;

665 
¦Ù
 = 0; slÙ < 
Ä
 - 1; slot++) {

666 
by‹Ä
 = 
	`bŒfs_node_block±r
(
node
, 
¦Ù
);

667 
	`bŒfs_node_key_to_ýu
(
node
, &
key
, 
¦Ù
);

668 
	`bŒfs_node_key_to_ýu
(
node
, &
Ãxt_key
, 
¦Ù
 + 1);

670 ià(!
by‹Ä
) {

671 
	`CORRUPT
("šv®id i‹m slÙ", 
node
, 
roÙ
, 
¦Ù
);

672 
»t
 = -
EIO
;

673 
out
;

676 ià(
	`bŒfs_comp_ýu_keys
(&
key
, &
Ãxt_key
) >= 0) {

677 
	`CORRUPT
("bad key ord”", 
node
, 
roÙ
, 
¦Ù
);

678 
»t
 = -
EIO
;

679 
out
;

682 
out
:

683  
»t
;

684 
	}
}

686 
	$bŒ“_»ad·ge_’d_io_hook
(
bŒfs_io_bio
 *
io_bio
,

687 
u64
 
phy_off£t
, 
·ge
 *page,

688 
u64
 
¡¬t
, u64 
’d
, 
mœrÜ
)

690 
u64
 
found_¡¬t
;

691 
found_Ëv–
;

692 
ex‹Á_bufãr
 *
eb
;

693 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->root;

694 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

695 
»t
 = 0;

696 
»ads_dÚe
;

698 ià(!
·ge
->
´iv©e
)

699 
out
;

701 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

706 
	`ex‹Á_bufãr_g‘
(
eb
);

708 
»ads_dÚe
 = 
	`©omic_dec_ªd_‹¡
(&
eb
->
io_·ges
);

709 ià(!
»ads_dÚe
)

710 
”r
;

712 
eb
->
»ad_mœrÜ
 = 
mœrÜ
;

713 ià(
	`‹¡_b™
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bæags
)) {

714 
»t
 = -
EIO
;

715 
”r
;

718 
found_¡¬t
 = 
	`bŒfs_h—d”_by‹Ä
(
eb
);

719 ià(
found_¡¬t
 !ð
eb
->
¡¬t
) {

720 
	`bŒfs_”r_¾
(
fs_šfo
, "badree block start %llu %llu",

721 
found_¡¬t
, 
eb
->
¡¬t
);

722 
»t
 = -
EIO
;

723 
”r
;

725 ià(
	`check_Œ“_block_fsid
(
fs_šfo
, 
eb
)) {

726 
	`bŒfs_”r_¾
(
fs_šfo
, "bad fsid on block %llu",

727 
eb
->
¡¬t
);

728 
»t
 = -
EIO
;

729 
”r
;

731 
found_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

732 ià(
found_Ëv–
 >ð
BTRFS_MAX_LEVEL
) {

733 
	`bŒfs_”r
(
fs_šfo
, "badree block†evel %d",

734 ()
	`bŒfs_h—d”_Ëv–
(
eb
));

735 
»t
 = -
EIO
;

736 
”r
;

739 
	`bŒfs_£t_bufãr_lockd•_þass
(
	`bŒfs_h—d”_owÃr
(
eb
),

740 
eb
, 
found_Ëv–
);

742 
»t
 = 
	`csum_Œ“_block
(
fs_šfo
, 
eb
, 1);

743 ià(
»t
)

744 
”r
;

751 ià(
found_Ëv–
 =ð0 && 
	`check_Ëaf
(
roÙ
, 
eb
)) {

752 
	`£t_b™
(
EXTENT_BUFFER_CORRUPT
, &
eb
->
bæags
);

753 
»t
 = -
EIO
;

756 ià(
found_Ëv–
 > 0 && 
	`check_node
(
roÙ
, 
eb
))

757 
»t
 = -
EIO
;

759 ià(!
»t
)

760 
	`£t_ex‹Á_bufãr_u±od©e
(
eb
);

761 
”r
:

762 ià(
»ads_dÚe
 &&

763 
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_READAHEAD
, &
eb
->
bæags
))

764 
	`bŒ“_»adah—d_hook
(
eb
, 
»t
);

766 ià(
»t
) {

772 
	`©omic_šc
(&
eb
->
io_·ges
);

773 
	`þ—r_ex‹Á_bufãr_u±od©e
(
eb
);

775 
	`ä“_ex‹Á_bufãr
(
eb
);

776 
out
:

777  
»t
;

778 
	}
}

780 
	$bŒ“_io_çžed_hook
(
·ge
 *·ge, 
çžed_mœrÜ
)

782 
ex‹Á_bufãr
 *
eb
;

784 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

785 
	`£t_b™
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bæags
);

786 
eb
->
»ad_mœrÜ
 = 
çžed_mœrÜ
;

787 
	`©omic_dec
(&
eb
->
io_·ges
);

788 ià(
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_READAHEAD
, &
eb
->
bæags
))

789 
	`bŒ“_»adah—d_hook
(
eb
, -
EIO
);

790  -
EIO
;

791 
	}
}

793 
	$’d_wÜkqueue_bio
(
bio
 *bio)

795 
bŒfs_’d_io_wq
 *
’d_io_wq
 = 
bio
->
bi_´iv©e
;

796 
bŒfs_fs_šfo
 *
fs_šfo
;

797 
bŒfs_wÜkqueue
 *
wq
;

798 
bŒfs_wÜk_func_t
 
func
;

800 
fs_šfo
 = 
’d_io_wq
->
šfo
;

801 
’d_io_wq
->
¡©us
 = 
bio
->
bi_¡©us
;

803 ià(
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
) {

804 ià(
’d_io_wq
->
m‘ad©a
 =ð
BTRFS_WQ_ENDIO_METADATA
) {

805 
wq
 = 
fs_šfo
->
’dio_m‘a_wr™e_wÜk”s
;

806 
func
 = 
bŒfs_’dio_m‘a_wr™e_h–³r
;

807 } ià(
’d_io_wq
->
m‘ad©a
 =ð
BTRFS_WQ_ENDIO_FREE_SPACE
) {

808 
wq
 = 
fs_šfo
->
’dio_ä“¥aû_wÜk”
;

809 
func
 = 
bŒfs_ä“¥aû_wr™e_h–³r
;

810 } ià(
’d_io_wq
->
m‘ad©a
 =ð
BTRFS_WQ_ENDIO_RAID56
) {

811 
wq
 = 
fs_šfo
->
’dio_¿id56_wÜk”s
;

812 
func
 = 
bŒfs_’dio_¿id56_h–³r
;

814 
wq
 = 
fs_šfo
->
’dio_wr™e_wÜk”s
;

815 
func
 = 
bŒfs_’dio_wr™e_h–³r
;

818 ià(
	`uÆik–y
(
’d_io_wq
->
m‘ad©a
 ==

819 
BTRFS_WQ_ENDIO_DIO_REPAIR
)) {

820 
wq
 = 
fs_šfo
->
’dio_»·œ_wÜk”s
;

821 
func
 = 
bŒfs_’dio_»·œ_h–³r
;

822 } ià(
’d_io_wq
->
m‘ad©a
 =ð
BTRFS_WQ_ENDIO_RAID56
) {

823 
wq
 = 
fs_šfo
->
’dio_¿id56_wÜk”s
;

824 
func
 = 
bŒfs_’dio_¿id56_h–³r
;

825 } ià(
’d_io_wq
->
m‘ad©a
) {

826 
wq
 = 
fs_šfo
->
’dio_m‘a_wÜk”s
;

827 
func
 = 
bŒfs_’dio_m‘a_h–³r
;

829 
wq
 = 
fs_šfo
->
’dio_wÜk”s
;

830 
func
 = 
bŒfs_’dio_h–³r
;

834 
	`bŒfs_š™_wÜk
(&
’d_io_wq
->
wÜk
, 
func
, 
’d_wÜkqueue_â
, 
NULL
, NULL);

835 
	`bŒfs_queue_wÜk
(
wq
, &
’d_io_wq
->
wÜk
);

836 
	}
}

838 
blk_¡©us_t
 
	$bŒfs_bio_wq_’d_io
(
bŒfs_fs_šfo
 *
šfo
, 
bio
 *bio,

839 
bŒfs_wq_’dio_ty³
 
m‘ad©a
)

841 
bŒfs_’d_io_wq
 *
’d_io_wq
;

843 
’d_io_wq
 = 
	`kmem_ÿche_®loc
(
bŒfs_’d_io_wq_ÿche
, 
GFP_NOFS
);

844 ià(!
’d_io_wq
)

845  
BLK_STS_RESOURCE
;

847 
’d_io_wq
->
´iv©e
 = 
bio
->
bi_´iv©e
;

848 
’d_io_wq
->
’d_io
 = 
bio
->
bi_’d_io
;

849 
’d_io_wq
->
šfo
 = info;

850 
’d_io_wq
->
¡©us
 = 0;

851 
’d_io_wq
->
bio
 = bio;

852 
’d_io_wq
->
m‘ad©a
 = metadata;

854 
bio
->
bi_´iv©e
 = 
’d_io_wq
;

855 
bio
->
bi_’d_io
 = 
’d_wÜkqueue_bio
;

857 
	}
}

859 
	$bŒfs_async_subm™_lim™
(
bŒfs_fs_šfo
 *
šfo
)

861 
lim™
 = 
	`mš_t
(,

862 
šfo
->
th»ad_poÞ_size
,

863 
šfo
->
fs_deviûs
->
Ý’_deviûs
);

864  256 * 
lim™
;

865 
	}
}

867 
	$run_Úe_async_¡¬t
(
bŒfs_wÜk
 *
wÜk
)

869 
async_subm™_bio
 *
async
;

870 
blk_¡©us_t
 
»t
;

872 
async
 = 
	`cÚš”_of
(
wÜk
, 
async_subm™_bio
, work);

873 
»t
 = 
async
->
	`subm™_bio_¡¬t
×sync->
´iv©e_d©a
,‡sync->
bio
,

874 
async
->
mœrÜ_num
,‡sync->
bio_æags
,

875 
async
->
bio_off£t
);

876 ià(
»t
)

877 
async
->
¡©us
 = 
»t
;

878 
	}
}

880 
	$run_Úe_async_dÚe
(
bŒfs_wÜk
 *
wÜk
)

882 
bŒfs_fs_šfo
 *
fs_šfo
;

883 
async_subm™_bio
 *
async
;

884 
lim™
;

886 
async
 = 
	`cÚš”_of
(
wÜk
, 
async_subm™_bio
, work);

887 
fs_šfo
 = 
async
->fs_info;

889 
lim™
 = 
	`bŒfs_async_subm™_lim™
(
fs_šfo
);

890 
lim™
 =†imit * 2 / 3;

895 ià(
	`©omic_dec_»tuº
(&
fs_šfo
->
Ä_async_subm™s
è< 
lim™
 &&

896 
	`wa™queue_aùive
(&
fs_šfo
->
async_subm™_wa™
))

897 
	`wake_up
(&
fs_šfo
->
async_subm™_wa™
);

900 ià(
async
->
¡©us
) {

901 
async
->
bio
->
bi_¡©us
 =‡sync->
¡©us
;

902 
	`bio_’dio
(
async
->
bio
);

906 
async
->
	`subm™_bio_dÚe
×sync->
´iv©e_d©a
,‡sync->
bio
,‡sync->
mœrÜ_num
,

907 
async
->
bio_æags
,‡sync->
bio_off£t
);

908 
	}
}

910 
	$run_Úe_async_ä“
(
bŒfs_wÜk
 *
wÜk
)

912 
async_subm™_bio
 *
async
;

914 
async
 = 
	`cÚš”_of
(
wÜk
, 
async_subm™_bio
, work);

915 
	`kä“
(
async
);

916 
	}
}

918 
blk_¡©us_t
 
	$bŒfs_wq_subm™_bio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

919 
mœrÜ_num
, 
bio_æags
,

920 
u64
 
bio_off£t
, *
´iv©e_d©a
,

921 
ex‹Á_subm™_bio_hook_t
 *
subm™_bio_¡¬t
,

922 
ex‹Á_subm™_bio_hook_t
 *
subm™_bio_dÚe
)

924 
async_subm™_bio
 *
async
;

926 
async
 = 
	`km®loc
((*async), 
GFP_NOFS
);

927 ià(!
async
)

928  
BLK_STS_RESOURCE
;

930 
async
->
´iv©e_d©a
 =…rivate_data;

931 
async
->
fs_šfo
 = fs_info;

932 
async
->
bio
 = bio;

933 
async
->
mœrÜ_num
 = mirror_num;

934 
async
->
subm™_bio_¡¬t
 = submit_bio_start;

935 
async
->
subm™_bio_dÚe
 = submit_bio_done;

937 
	`bŒfs_š™_wÜk
(&
async
->
wÜk
, 
bŒfs_wÜk”_h–³r
, 
run_Úe_async_¡¬t
,

938 
run_Úe_async_dÚe
, 
run_Úe_async_ä“
);

940 
async
->
bio_æags
 = bio_flags;

941 
async
->
bio_off£t
 = bio_offset;

943 
async
->
¡©us
 = 0;

945 
	`©omic_šc
(&
fs_šfo
->
Ä_async_subm™s
);

947 ià(
	`Ý_is_sync
(
bio
->
bi_Ýf
))

948 
	`bŒfs_£t_wÜk_high_´iÜ™y
(&
async
->
wÜk
);

950 
	`bŒfs_queue_wÜk
(
fs_šfo
->
wÜk”s
, &
async
->
wÜk
);

952 
	`©omic_»ad
(&
fs_šfo
->
async_subm™_d¿ššg
) &&

953 
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
)) {

954 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

955 (
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) == 0));

959 
	}
}

961 
blk_¡©us_t
 
	$bŒ“_csum_Úe_bio
(
bio
 *bio)

963 
bio_vec
 *
bvec
;

964 
bŒfs_roÙ
 *
roÙ
;

965 
i
, 
»t
 = 0;

967 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

968 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

969 
roÙ
 = 
	`BTRFS_I
(
bvec
->
bv_·ge
->
m­pšg
->
ho¡
)->root;

970 
»t
 = 
	`csum_dœty_bufãr
(
roÙ
->
fs_šfo
, 
bvec
->
bv_·ge
);

971 ià(
»t
)

975  
	`”ºo_to_blk_¡©us
(
»t
);

976 
	}
}

978 
blk_¡©us_t
 
	$__bŒ“_subm™_bio_¡¬t
(*
´iv©e_d©a
, 
bio
 *bio,

979 
mœrÜ_num
, 
bio_æags
,

980 
u64
 
bio_off£t
)

986  
	`bŒ“_csum_Úe_bio
(
bio
);

987 
	}
}

989 
blk_¡©us_t
 
	$__bŒ“_subm™_bio_dÚe
(*
´iv©e_d©a
, 
bio
 *bio,

990 
mœrÜ_num
, 
bio_æags
,

991 
u64
 
bio_off£t
)

993 
šode
 *šodð
´iv©e_d©a
;

994 
blk_¡©us_t
 
»t
;

1000 
»t
 = 
	`bŒfs_m­_bio
(
	`bŒfs_sb
(
šode
->
i_sb
), 
bio
, 
mœrÜ_num
, 1);

1001 ià(
»t
) {

1002 
bio
->
bi_¡©us
 = 
»t
;

1003 
	`bio_’dio
(
bio
);

1005  
»t
;

1006 
	}
}

1008 
	$check_async_wr™e
(
bio_æags
)

1010 ià(
bio_æags
 & 
EXTENT_BIO_TREE_LOG
)

1012 #ifdeà
CONFIG_X86


1013 ià(
	`¡©ic_ýu_has
(
X86_FEATURE_XMM4_2
))

1017 
	}
}

1019 
blk_¡©us_t
 
	$bŒ“_subm™_bio_hook
(*
´iv©e_d©a
, 
bio
 *bio,

1020 
mœrÜ_num
, 
bio_æags
,

1021 
u64
 
bio_off£t
)

1023 
šode
 *šodð
´iv©e_d©a
;

1024 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1025 
async
 = 
	`check_async_wr™e
(
bio_æags
);

1026 
blk_¡©us_t
 
»t
;

1028 ià(
	`bio_Ý
(
bio
è!ð
REQ_OP_WRITE
) {

1033 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
bio
,

1034 
BTRFS_WQ_ENDIO_METADATA
);

1035 ià(
»t
)

1036 
out_w_”rÜ
;

1037 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 0);

1038 } ià(!
async
) {

1039 
»t
 = 
	`bŒ“_csum_Úe_bio
(
bio
);

1040 ià(
»t
)

1041 
out_w_”rÜ
;

1042 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 0);

1048 
»t
 = 
	`bŒfs_wq_subm™_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 0,

1049 
bio_off£t
, 
´iv©e_d©a
,

1050 
__bŒ“_subm™_bio_¡¬t
,

1051 
__bŒ“_subm™_bio_dÚe
);

1054 ià(
»t
)

1055 
out_w_”rÜ
;

1058 
out_w_”rÜ
:

1059 
bio
->
bi_¡©us
 = 
»t
;

1060 
	`bio_’dio
(
bio
);

1061  
»t
;

1062 
	}
}

1064 #ifdeà
CONFIG_MIGRATION


1065 
	$bŒ“_mig¿‹·ge
(
add»ss_¥aû
 *
m­pšg
,

1066 
·ge
 *
Ãw·ge
, page *page,

1067 
mig¿‹_mode
 
mode
)

1073 ià(
	`PageDœty
(
·ge
))

1074  -
EAGAIN
;

1079 ià(
	`·ge_has_´iv©e
(
·ge
) &&

1080 !
	`Œy_to_»Ëa£_·ge
(
·ge
, 
GFP_KERNEL
))

1081  -
EAGAIN
;

1082  
	`mig¿‹_·ge
(
m­pšg
, 
Ãw·ge
, 
·ge
, 
mode
);

1083 
	}
}

1087 
	$bŒ“_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

1088 
wr™eback_cÚŒÞ
 *
wbc
)

1090 
bŒfs_fs_šfo
 *
fs_šfo
;

1091 
»t
;

1093 ià(
wbc
->
sync_mode
 =ð
WB_SYNC_NONE
) {

1095 ià(
wbc
->
fÜ_kupd©e
)

1098 
fs_šfo
 = 
	`BTRFS_I
(
m­pšg
->
ho¡
)->
roÙ
->fs_info;

1100 
»t
 = 
	`³rýu_couÁ”_com·»
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

1101 
BTRFS_DIRTY_METADATA_THRESH
);

1102 ià(
»t
 < 0)

1105  
	`bŒ“_wr™e_ÿche_·ges
(
m­pšg
, 
wbc
);

1106 
	}
}

1108 
	$bŒ“_»ad·ge
(
fže
 *fže, 
·ge
 *page)

1110 
ex‹Á_io_Œ“
 *
Œ“
;

1111 
Œ“
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
io_Œ“
;

1112  
	`ex‹Á_»ad_fuÎ_·ge
(
Œ“
, 
·ge
, 
bŒ“_g‘_ex‹Á
, 0);

1113 
	}
}

1115 
	$bŒ“_»Ëa£·ge
(
·ge
 *·ge, 
gå_t
 
gå_æags
)

1117 ià(
	`PageWr™eback
(
·ge
è|| 
	`PageDœty
(page))

1120  
	`Œy_»Ëa£_ex‹Á_bufãr
(
·ge
);

1121 
	}
}

1123 
	$bŒ“_šv®id©•age
(
·ge
 *·ge, 
off£t
,

1124 
Ëngth
)

1126 
ex‹Á_io_Œ“
 *
Œ“
;

1127 
Œ“
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
io_Œ“
;

1128 
	`ex‹Á_šv®id©•age
(
Œ“
, 
·ge
, 
off£t
);

1129 
	`bŒ“_»Ëa£·ge
(
·ge
, 
GFP_NOFS
);

1130 ià(
	`PagePriv©e
(
·ge
)) {

1131 
	`bŒfs_w¬n
(
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
roÙ
->
fs_šfo
,

1133 ()
	`·ge_off£t
(
·ge
));

1134 
	`CË¬PagePriv©e
(
·ge
);

1135 
	`£t_·ge_´iv©e
(
·ge
, 0);

1136 
	`put_·ge
(
·ge
);

1138 
	}
}

1140 
	$bŒ“_£t_·ge_dœty
(
·ge
 *page)

1142 #ifdeà
DEBUG


1143 
ex‹Á_bufãr
 *
eb
;

1145 
	`BUG_ON
(!
	`PagePriv©e
(
·ge
));

1146 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

1147 
	`BUG_ON
(!
eb
);

1148 
	`BUG_ON
(!
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

1149 
	`BUG_ON
(!
	`©omic_»ad
(&
eb
->
»fs
));

1150 
	`bŒfs_as£¹_Œ“_locked
(
eb
);

1152  
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

1153 
	}
}

1155 cÚ¡ 
add»ss_¥aû_Ý”©iÚs
 
	gbŒ“_aÝs
 = {

1156 .
»ad·ge
 = 
bŒ“_»ad·ge
,

1157 .
	gwr™•ages
 = 
bŒ“_wr™•ages
,

1158 .
	g»Ëa£·ge
 = 
bŒ“_»Ëa£·ge
,

1159 .
	gšv®id©•age
 = 
bŒ“_šv®id©•age
,

1160 #ifdeà
CONFIG_MIGRATION


1161 .
	gmig¿‹·ge
 = 
bŒ“_mig¿‹·ge
,

1163 .
	g£t_·ge_dœty
 = 
bŒ“_£t_·ge_dœty
,

1166 
	$»adah—d_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

1168 
ex‹Á_bufãr
 *
buf
 = 
NULL
;

1169 
šode
 *
bŒ“_šode
 = 
fs_šfo
->btree_inode;

1171 
buf
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
);

1172 ià(
	`IS_ERR
(
buf
))

1174 
	`»ad_ex‹Á_bufãr_·ges
(&
	`BTRFS_I
(
bŒ“_šode
)->
io_Œ“
,

1175 
buf
, 
WAIT_NONE
, 
bŒ“_g‘_ex‹Á
, 0);

1176 
	`ä“_ex‹Á_bufãr
(
buf
);

1177 
	}
}

1179 
	$»ada_Œ“_block_æagged
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1180 
mœrÜ_num
, 
ex‹Á_bufãr
 **
eb
)

1182 
ex‹Á_bufãr
 *
buf
 = 
NULL
;

1183 
šode
 *
bŒ“_šode
 = 
fs_šfo
->btree_inode;

1184 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
bŒ“_šode
)->io_tree;

1185 
»t
;

1187 
buf
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
);

1188 ià(
	`IS_ERR
(
buf
))

1191 
	`£t_b™
(
EXTENT_BUFFER_READAHEAD
, &
buf
->
bæags
);

1193 
»t
 = 
	`»ad_ex‹Á_bufãr_·ges
(
io_Œ“
, 
buf
, 
WAIT_PAGE_LOCK
,

1194 
bŒ“_g‘_ex‹Á
, 
mœrÜ_num
);

1195 ià(
»t
) {

1196 
	`ä“_ex‹Á_bufãr
(
buf
);

1197  
»t
;

1200 ià(
	`‹¡_b™
(
EXTENT_BUFFER_CORRUPT
, &
buf
->
bæags
)) {

1201 
	`ä“_ex‹Á_bufãr
(
buf
);

1202  -
EIO
;

1203 } ià(
	`ex‹Á_bufãr_u±od©e
(
buf
)) {

1204 *
eb
 = 
buf
;

1206 
	`ä“_ex‹Á_bufãr
(
buf
);

1209 
	}
}

1211 
ex‹Á_bufãr
 *
	$bŒfs_fšd_ü—‹_Œ“_block
(

1212 
bŒfs_fs_šfo
 *
fs_šfo
,

1213 
u64
 
by‹Ä
)

1215 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

1216  
	`®loc_‹¡_ex‹Á_bufãr
(
fs_šfo
, 
by‹Ä
);

1217  
	`®loc_ex‹Á_bufãr
(
fs_šfo
, 
by‹Ä
);

1218 
	}
}

1221 
	$bŒfs_wr™e_Œ“_block
(
ex‹Á_bufãr
 *
buf
)

1223  
	`fžem­_fd©awr™e_¿nge
(
buf
->
·ges
[0]->
m­pšg
, buf->
¡¬t
,

1224 
buf
->
¡¬t
 + buf->
Ën
 - 1);

1225 
	}
}

1227 
	$bŒfs_wa™_Œ“_block_wr™eback
(
ex‹Á_bufãr
 *
buf
)

1229 
	`fžem­_fd©awa™_¿nge
(
buf
->
·ges
[0]->
m­pšg
,

1230 
buf
->
¡¬t
, buf->¡¬ˆ+ buf->
Ën
 - 1);

1231 
	}
}

1233 
ex‹Á_bufãr
 *
	$»ad_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

1234 
u64
 
·»Á_Œªsid
)

1236 
ex‹Á_bufãr
 *
buf
 = 
NULL
;

1237 
»t
;

1239 
buf
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
);

1240 ià(
	`IS_ERR
(
buf
))

1241  
buf
;

1243 
»t
 = 
	`bŒ“_»ad_ex‹Á_bufãr_·ges
(
fs_šfo
, 
buf
, 
·»Á_Œªsid
);

1244 ià(
»t
) {

1245 
	`ä“_ex‹Á_bufãr
(
buf
);

1246  
	`ERR_PTR
(
»t
);

1248  
buf
;

1250 
	}
}

1252 
	$þ—n_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

1253 
ex‹Á_bufãr
 *
buf
)

1255 ià(
	`bŒfs_h—d”_g’”©iÚ
(
buf
) ==

1256 
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
Œªsid
) {

1257 
	`bŒfs_as£¹_Œ“_locked
(
buf
);

1259 ià(
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_DIRTY
, &
buf
->
bæags
)) {

1260 
	`³rýu_couÁ”_add_b©ch
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

1261 -
buf
->
Ën
,

1262 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

1264 
	`bŒfs_£t_lock_blockšg
(
buf
);

1265 
	`þ—r_ex‹Á_bufãr_dœty
(
buf
);

1268 
	}
}

1270 
bŒfs_subvÞume_wr™”s
 *
	$bŒfs_®loc_subvÞume_wr™”s
()

1272 
bŒfs_subvÞume_wr™”s
 *
wr™”s
;

1273 
»t
;

1275 
wr™”s
 = 
	`km®loc
((*wr™”s), 
GFP_NOFS
);

1276 ià(!
wr™”s
)

1277  
	`ERR_PTR
(-
ENOMEM
);

1279 
»t
 = 
	`³rýu_couÁ”_š™
(&
wr™”s
->
couÁ”
, 0, 
GFP_KERNEL
);

1280 ià(
»t
 < 0) {

1281 
	`kä“
(
wr™”s
);

1282  
	`ERR_PTR
(
»t
);

1285 
	`š™_wa™queue_h—d
(&
wr™”s
->
wa™
);

1286  
wr™”s
;

1287 
	}
}

1290 
	$bŒfs_ä“_subvÞume_wr™”s
(
bŒfs_subvÞume_wr™”s
 *
wr™”s
)

1292 
	`³rýu_couÁ”_de¡roy
(&
wr™”s
->
couÁ”
);

1293 
	`kä“
(
wr™”s
);

1294 
	}
}

1296 
	$__£tup_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_fs_šfo
 *
fs_šfo
,

1297 
u64
 
objeùid
)

1299 
boÞ
 
dummy
 = 
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
);

1300 
roÙ
->
node
 = 
NULL
;

1301 
roÙ
->
comm™_roÙ
 = 
NULL
;

1302 
roÙ
->
¡©e
 = 0;

1303 
roÙ
->
Üphª_þ—nup_¡©e
 = 0;

1305 
roÙ
->
objeùid
 = objectid;

1306 
roÙ
->
Ï¡_Œªs
 = 0;

1307 
roÙ
->
highe¡_objeùid
 = 0;

1308 
roÙ
->
Ä_d–®loc_šodes
 = 0;

1309 
roÙ
->
Ä_Üd”ed_ex‹Ás
 = 0;

1310 
roÙ
->
Çme
 = 
NULL
;

1311 
roÙ
->
šode_Œ“
 = 
RB_ROOT
;

1312 
	`INIT_RADIX_TREE
(&
roÙ
->
d–ayed_nodes_Œ“
, 
GFP_ATOMIC
);

1313 
roÙ
->
block_rsv
 = 
NULL
;

1314 
roÙ
->
Üphª_block_rsv
 = 
NULL
;

1316 
	`INIT_LIST_HEAD
(&
roÙ
->
dœty_li¡
);

1317 
	`INIT_LIST_HEAD
(&
roÙ
->
roÙ_li¡
);

1318 
	`INIT_LIST_HEAD
(&
roÙ
->
d–®loc_šodes
);

1319 
	`INIT_LIST_HEAD
(&
roÙ
->
d–®loc_roÙ
);

1320 
	`INIT_LIST_HEAD
(&
roÙ
->
Üd”ed_ex‹Ás
);

1321 
	`INIT_LIST_HEAD
(&
roÙ
->
Üd”ed_roÙ
);

1322 
	`INIT_LIST_HEAD
(&
roÙ
->
logged_li¡
[0]);

1323 
	`INIT_LIST_HEAD
(&
roÙ
->
logged_li¡
[1]);

1324 
	`¥š_lock_š™
(&
roÙ
->
Üphª_lock
);

1325 
	`¥š_lock_š™
(&
roÙ
->
šode_lock
);

1326 
	`¥š_lock_š™
(&
roÙ
->
d–®loc_lock
);

1327 
	`¥š_lock_š™
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

1328 
	`¥š_lock_š™
(&
roÙ
->
accouÁšg_lock
);

1329 
	`¥š_lock_š™
(&
roÙ
->
log_ex‹Ás_lock
[0]);

1330 
	`¥š_lock_š™
(&
roÙ
->
log_ex‹Ás_lock
[1]);

1331 
	`mu‹x_š™
(&
roÙ
->
objeùid_mu‹x
);

1332 
	`mu‹x_š™
(&
roÙ
->
log_mu‹x
);

1333 
	`mu‹x_š™
(&
roÙ
->
Üd”ed_ex‹Á_mu‹x
);

1334 
	`mu‹x_š™
(&
roÙ
->
d–®loc_mu‹x
);

1335 
	`š™_wa™queue_h—d
(&
roÙ
->
log_wr™”_wa™
);

1336 
	`š™_wa™queue_h—d
(&
roÙ
->
log_comm™_wa™
[0]);

1337 
	`š™_wa™queue_h—d
(&
roÙ
->
log_comm™_wa™
[1]);

1338 
	`INIT_LIST_HEAD
(&
roÙ
->
log_ùxs
[0]);

1339 
	`INIT_LIST_HEAD
(&
roÙ
->
log_ùxs
[1]);

1340 
	`©omic_£t
(&
roÙ
->
log_comm™
[0], 0);

1341 
	`©omic_£t
(&
roÙ
->
log_comm™
[1], 0);

1342 
	`©omic_£t
(&
roÙ
->
log_wr™”s
, 0);

1343 
	`©omic_£t
(&
roÙ
->
log_b©ch
, 0);

1344 
	`©omic_£t
(&
roÙ
->
Üphª_šodes
, 0);

1345 
	`»fcouÁ_£t
(&
roÙ
->
»fs
, 1);

1346 
	`©omic_£t
(&
roÙ
->
wžl_be_¢­shÙ‹d
, 0);

1347 
	`©omic64_£t
(&
roÙ
->
qgroup_m‘a_rsv
, 0);

1348 
roÙ
->
log_Œªsid
 = 0;

1349 
roÙ
->
log_Œªsid_comm™‹d
 = -1;

1350 
roÙ
->
Ï¡_log_comm™
 = 0;

1351 ià(!
dummy
)

1352 
	`ex‹Á_io_Œ“_š™
(&
roÙ
->
dœty_log_·ges
, 
NULL
);

1354 
	`mem£t
(&
roÙ
->
roÙ_key
, 0, (root->root_key));

1355 
	`mem£t
(&
roÙ
->
roÙ_™em
, 0, (root->root_item));

1356 
	`mem£t
(&
roÙ
->
deäag_´og»ss
, 0, (root->defrag_progress));

1357 ià(!
dummy
)

1358 
roÙ
->
deäag_Œªs_¡¬t
 = 
fs_šfo
->
g’”©iÚ
;

1360 
roÙ
->
deäag_Œªs_¡¬t
 = 0;

1361 
roÙ
->
roÙ_key
.
objeùid
 = objectid;

1362 
roÙ
->
ªÚ_dev
 = 0;

1364 
	`¥š_lock_š™
(&
roÙ
->
roÙ_™em_lock
);

1365 
	}
}

1367 
bŒfs_roÙ
 *
	$bŒfs_®loc_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1368 
gå_t
 
æags
)

1370 
bŒfs_roÙ
 *
roÙ
 = 
	`kz®loc
((*roÙ), 
æags
);

1371 ià(
roÙ
)

1372 
roÙ
->
fs_šfo
 = fs_info;

1373  
roÙ
;

1374 
	}
}

1376 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


1378 
bŒfs_roÙ
 *
	$bŒfs_®loc_dummy_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
)

1380 
bŒfs_roÙ
 *
roÙ
;

1382 ià(!
fs_šfo
)

1383  
	`ERR_PTR
(-
EINVAL
);

1385 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
GFP_KERNEL
);

1386 ià(!
roÙ
)

1387  
	`ERR_PTR
(-
ENOMEM
);

1390 
	`__£tup_roÙ
(
roÙ
, 
fs_šfo
, 
BTRFS_ROOT_TREE_OBJECTID
);

1391 
roÙ
->
®loc_by‹Ä
 = 0;

1393  
roÙ
;

1394 
	}
}

1397 
bŒfs_roÙ
 *
	$bŒfs_ü—‹_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1398 
bŒfs_fs_šfo
 *
fs_šfo
,

1399 
u64
 
objeùid
)

1401 
ex‹Á_bufãr
 *
Ëaf
;

1402 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1403 
bŒfs_roÙ
 *
roÙ
;

1404 
bŒfs_key
 
key
;

1405 
»t
 = 0;

1406 
uuid_Ë
 
uuid
;

1408 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
GFP_KERNEL
);

1409 ià(!
roÙ
)

1410  
	`ERR_PTR
(-
ENOMEM
);

1412 
	`__£tup_roÙ
(
roÙ
, 
fs_šfo
, 
objeùid
);

1413 
roÙ
->
roÙ_key
.
objeùid
 = objectid;

1414 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1415 
roÙ
->
roÙ_key
.
off£t
 = 0;

1417 
Ëaf
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
objeùid
, 
NULL
, 0, 0, 0);

1418 ià(
	`IS_ERR
(
Ëaf
)) {

1419 
»t
 = 
	`PTR_ERR
(
Ëaf
);

1420 
Ëaf
 = 
NULL
;

1421 
çž
;

1424 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, 0, (
bŒfs_h—d”
));

1425 
	`bŒfs_£t_h—d”_by‹Ä
(
Ëaf
,†—f->
¡¬t
);

1426 
	`bŒfs_£t_h—d”_g’”©iÚ
(
Ëaf
, 
Œªs
->
Œªsid
);

1427 
	`bŒfs_£t_h—d”_back»f_»v
(
Ëaf
, 
BTRFS_MIXED_BACKREF_REV
);

1428 
	`bŒfs_£t_h—d”_owÃr
(
Ëaf
, 
objeùid
);

1429 
roÙ
->
node
 = 
Ëaf
;

1431 
	`wr™e_ex‹Á_bufãr_fsid
(
Ëaf
, 
fs_šfo
->
fsid
);

1432 
	`wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
Ëaf
, 
fs_šfo
->
chunk_Œ“_uuid
);

1433 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1435 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

1436 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

1438 
roÙ
->
roÙ_™em
.
æags
 = 0;

1439 
roÙ
->
roÙ_™em
.
by‹_lim™
 = 0;

1440 
	`bŒfs_£t_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
, 
Ëaf
->
¡¬t
);

1441 
	`bŒfs_£t_roÙ_g’”©iÚ
(&
roÙ
->
roÙ_™em
, 
Œªs
->
Œªsid
);

1442 
	`bŒfs_£t_roÙ_Ëv–
(&
roÙ
->
roÙ_™em
, 0);

1443 
	`bŒfs_£t_roÙ_»fs
(&
roÙ
->
roÙ_™em
, 1);

1444 
	`bŒfs_£t_roÙ_u£d
(&
roÙ
->
roÙ_™em
, 
Ëaf
->
Ën
);

1445 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
, 0);

1446 
	`bŒfs_£t_roÙ_dœid
(&
roÙ
->
roÙ_™em
, 0);

1447 
	`uuid_Ë_g’
(&
uuid
);

1448 
	`memýy
(
roÙ
->
roÙ_™em
.
uuid
, uuid.
b
, 
BTRFS_UUID_SIZE
);

1449 
roÙ
->
roÙ_™em
.
drÝ_Ëv–
 = 0;

1451 
key
.
objeùid
 = objectid;

1452 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1453 
key
.
off£t
 = 0;

1454 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
Œ“_roÙ
, &
key
, &
roÙ
->
roÙ_™em
);

1455 ià(
»t
)

1456 
çž
;

1458 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

1460  
roÙ
;

1462 
çž
:

1463 ià(
Ëaf
) {

1464 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

1465 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

1466 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

1468 
	`kä“
(
roÙ
);

1470  
	`ERR_PTR
(
»t
);

1471 
	}
}

1473 
bŒfs_roÙ
 *
	$®loc_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1474 
bŒfs_fs_šfo
 *
fs_šfo
)

1476 
bŒfs_roÙ
 *
roÙ
;

1477 
ex‹Á_bufãr
 *
Ëaf
;

1479 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
GFP_NOFS
);

1480 ià(!
roÙ
)

1481  
	`ERR_PTR
(-
ENOMEM
);

1483 
	`__£tup_roÙ
(
roÙ
, 
fs_šfo
, 
BTRFS_TREE_LOG_OBJECTID
);

1485 
roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_TREE_LOG_OBJECTID
;

1486 
roÙ
->
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1487 
roÙ
->
roÙ_key
.
off£t
 = 
BTRFS_TREE_LOG_OBJECTID
;

1498 
Ëaf
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
BTRFS_TREE_LOG_OBJECTID
,

1499 
NULL
, 0, 0, 0);

1500 ià(
	`IS_ERR
(
Ëaf
)) {

1501 
	`kä“
(
roÙ
);

1502  
	`ERR_CAST
(
Ëaf
);

1505 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, 0, (
bŒfs_h—d”
));

1506 
	`bŒfs_£t_h—d”_by‹Ä
(
Ëaf
,†—f->
¡¬t
);

1507 
	`bŒfs_£t_h—d”_g’”©iÚ
(
Ëaf
, 
Œªs
->
Œªsid
);

1508 
	`bŒfs_£t_h—d”_back»f_»v
(
Ëaf
, 
BTRFS_MIXED_BACKREF_REV
);

1509 
	`bŒfs_£t_h—d”_owÃr
(
Ëaf
, 
BTRFS_TREE_LOG_OBJECTID
);

1510 
roÙ
->
node
 = 
Ëaf
;

1512 
	`wr™e_ex‹Á_bufãr_fsid
(
roÙ
->
node
, 
fs_šfo
->
fsid
);

1513 
	`bŒfs_m¬k_bufãr_dœty
(
roÙ
->
node
);

1514 
	`bŒfs_Œ“_uÆock
(
roÙ
->
node
);

1515  
roÙ
;

1516 
	}
}

1518 
	$bŒfs_š™_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1519 
bŒfs_fs_šfo
 *
fs_šfo
)

1521 
bŒfs_roÙ
 *
log_roÙ
;

1523 
log_roÙ
 = 
	`®loc_log_Œ“
(
Œªs
, 
fs_šfo
);

1524 ià(
	`IS_ERR
(
log_roÙ
))

1525  
	`PTR_ERR
(
log_roÙ
);

1526 
	`WARN_ON
(
fs_šfo
->
log_roÙ_Œ“
);

1527 
fs_šfo
->
log_roÙ_Œ“
 = 
log_roÙ
;

1529 
	}
}

1531 
	$bŒfs_add_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1532 
bŒfs_roÙ
 *
roÙ
)

1534 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1535 
bŒfs_roÙ
 *
log_roÙ
;

1536 
bŒfs_šode_™em
 *
šode_™em
;

1538 
log_roÙ
 = 
	`®loc_log_Œ“
(
Œªs
, 
fs_šfo
);

1539 ià(
	`IS_ERR
(
log_roÙ
))

1540  
	`PTR_ERR
(
log_roÙ
);

1542 
log_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

1543 
log_roÙ
->
roÙ_key
.
off£t
 = 
roÙ
->roÙ_key.
objeùid
;

1545 
šode_™em
 = &
log_roÙ
->
roÙ_™em
.
šode
;

1546 
	`bŒfs_£t_¡ack_šode_g’”©iÚ
(
šode_™em
, 1);

1547 
	`bŒfs_£t_¡ack_šode_size
(
šode_™em
, 3);

1548 
	`bŒfs_£t_¡ack_šode_Æšk
(
šode_™em
, 1);

1549 
	`bŒfs_£t_¡ack_šode_nby‹s
(
šode_™em
,

1550 
fs_šfo
->
nodesize
);

1551 
	`bŒfs_£t_¡ack_šode_mode
(
šode_™em
, 
S_IFDIR
 | 0755);

1553 
	`bŒfs_£t_roÙ_node
(&
log_roÙ
->
roÙ_™em
,†og_roÙ->
node
);

1555 
	`WARN_ON
(
roÙ
->
log_roÙ
);

1556 
roÙ
->
log_roÙ
 =†og_root;

1557 
roÙ
->
log_Œªsid
 = 0;

1558 
roÙ
->
log_Œªsid_comm™‹d
 = -1;

1559 
roÙ
->
Ï¡_log_comm™
 = 0;

1561 
	}
}

1563 
bŒfs_roÙ
 *
	$bŒfs_»ad_Œ“_roÙ
(
bŒfs_roÙ
 *
Œ“_roÙ
,

1564 
bŒfs_key
 *
key
)

1566 
bŒfs_roÙ
 *
roÙ
;

1567 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œ“_roÙ
->fs_info;

1568 
bŒfs_·th
 *
·th
;

1569 
u64
 
g’”©iÚ
;

1570 
»t
;

1572 
·th
 = 
	`bŒfs_®loc_·th
();

1573 ià(!
·th
)

1574  
	`ERR_PTR
(-
ENOMEM
);

1576 
roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
GFP_NOFS
);

1577 ià(!
roÙ
) {

1578 
»t
 = -
ENOMEM
;

1579 
®loc_çž
;

1582 
	`__£tup_roÙ
(
roÙ
, 
fs_šfo
, 
key
->
objeùid
);

1584 
»t
 = 
	`bŒfs_fšd_roÙ
(
Œ“_roÙ
, 
key
, 
·th
,

1585 &
roÙ
->
roÙ_™em
, &roÙ->
roÙ_key
);

1586 ià(
»t
) {

1587 ià(
»t
 > 0)

1588 
»t
 = -
ENOENT
;

1589 
fšd_çž
;

1592 
g’”©iÚ
 = 
	`bŒfs_roÙ_g’”©iÚ
(&
roÙ
->
roÙ_™em
);

1593 
roÙ
->
node
 = 
	`»ad_Œ“_block
(
fs_šfo
,

1594 
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
),

1595 
g’”©iÚ
);

1596 ià(
	`IS_ERR
(
roÙ
->
node
)) {

1597 
»t
 = 
	`PTR_ERR
(
roÙ
->
node
);

1598 
fšd_çž
;

1599 } ià(!
	`bŒfs_bufãr_u±od©e
(
roÙ
->
node
, 
g’”©iÚ
, 0)) {

1600 
»t
 = -
EIO
;

1601 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

1602 
fšd_çž
;

1604 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

1605 
out
:

1606 
	`bŒfs_ä“_·th
(
·th
);

1607  
roÙ
;

1609 
fšd_çž
:

1610 
	`kä“
(
roÙ
);

1611 
®loc_çž
:

1612 
roÙ
 = 
	`ERR_PTR
(
»t
);

1613 
out
;

1614 
	}
}

1616 
bŒfs_roÙ
 *
	$bŒfs_»ad_fs_roÙ
(
bŒfs_roÙ
 *
Œ“_roÙ
,

1617 
bŒfs_key
 *
loÿtiÚ
)

1619 
bŒfs_roÙ
 *
roÙ
;

1621 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, 
loÿtiÚ
);

1622 ià(
	`IS_ERR
(
roÙ
))

1623  
roÙ
;

1625 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
) {

1626 
	`£t_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
);

1627 
	`bŒfs_check_ªd_š™_roÙ_™em
(&
roÙ
->
roÙ_™em
);

1630  
roÙ
;

1631 
	}
}

1633 
	$bŒfs_š™_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1635 
»t
;

1636 
bŒfs_subvÞume_wr™”s
 *
wr™”s
;

1638 
roÙ
->
ä“_šo_ùl
 = 
	`kz®loc
((*roÙ->ä“_šo_ùl), 
GFP_NOFS
);

1639 
roÙ
->
ä“_šo_pšÃd
 = 
	`kz®loc
((*root->free_ino_pinned),

1640 
GFP_NOFS
);

1641 ià(!
roÙ
->
ä“_šo_pšÃd
 || !roÙ->
ä“_šo_ùl
) {

1642 
»t
 = -
ENOMEM
;

1643 
çž
;

1646 
wr™”s
 = 
	`bŒfs_®loc_subvÞume_wr™”s
();

1647 ià(
	`IS_ERR
(
wr™”s
)) {

1648 
»t
 = 
	`PTR_ERR
(
wr™”s
);

1649 
çž
;

1651 
roÙ
->
subv_wr™”s
 = 
wr™”s
;

1653 
	`bŒfs_š™_ä“_šo_ùl
(
roÙ
);

1654 
	`¥š_lock_š™
(&
roÙ
->
šo_ÿche_lock
);

1655 
	`š™_wa™queue_h—d
(&
roÙ
->
šo_ÿche_wa™
);

1657 
»t
 = 
	`g‘_ªÚ_bdev
(&
roÙ
->
ªÚ_dev
);

1658 ià(
»t
)

1659 
çž
;

1661 
	`mu‹x_lock
(&
roÙ
->
objeùid_mu‹x
);

1662 
»t
 = 
	`bŒfs_fšd_highe¡_objeùid
(
roÙ
,

1663 &
roÙ
->
highe¡_objeùid
);

1664 ià(
»t
) {

1665 
	`mu‹x_uÆock
(&
roÙ
->
objeùid_mu‹x
);

1666 
çž
;

1669 
	`ASSERT
(
roÙ
->
highe¡_objeùid
 <ð
BTRFS_LAST_FREE_OBJECTID
);

1671 
	`mu‹x_uÆock
(&
roÙ
->
objeùid_mu‹x
);

1674 
çž
:

1676  
»t
;

1677 
	}
}

1679 
bŒfs_roÙ
 *
	$bŒfs_lookup_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1680 
u64
 
roÙ_id
)

1682 
bŒfs_roÙ
 *
roÙ
;

1684 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1685 
roÙ
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

1686 ()
roÙ_id
);

1687 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1688  
roÙ
;

1689 
	}
}

1691 
	$bŒfs_š£¹_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1692 
bŒfs_roÙ
 *
roÙ
)

1694 
»t
;

1696 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

1697 ià(
»t
)

1698  
»t
;

1700 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1701 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
fs_roÙs_¿dix
,

1702 ()
roÙ
->
roÙ_key
.
objeùid
,

1703 
roÙ
);

1704 ià(
»t
 == 0)

1705 
	`£t_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
);

1706 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1707 
	`¿dix_Œ“_´–ßd_’d
();

1709  
»t
;

1710 
	}
}

1712 
bŒfs_roÙ
 *
	$bŒfs_g‘_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1713 
bŒfs_key
 *
loÿtiÚ
,

1714 
boÞ
 
check_»f
)

1716 
bŒfs_roÙ
 *
roÙ
;

1717 
bŒfs_·th
 *
·th
;

1718 
bŒfs_key
 
key
;

1719 
»t
;

1721 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_ROOT_TREE_OBJECTID
)

1722  
fs_šfo
->
Œ“_roÙ
;

1723 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_EXTENT_TREE_OBJECTID
)

1724  
fs_šfo
->
ex‹Á_roÙ
;

1725 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_CHUNK_TREE_OBJECTID
)

1726  
fs_šfo
->
chunk_roÙ
;

1727 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_DEV_TREE_OBJECTID
)

1728  
fs_šfo
->
dev_roÙ
;

1729 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_CSUM_TREE_OBJECTID
)

1730  
fs_šfo
->
csum_roÙ
;

1731 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_QUOTA_TREE_OBJECTID
)

1732  
fs_šfo
->
quÙa_roÙ
 ? fs_info->quota_root :

1733 
	`ERR_PTR
(-
ENOENT
);

1734 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_UUID_TREE_OBJECTID
)

1735  
fs_šfo
->
uuid_roÙ
 ? fs_info->uuid_root :

1736 
	`ERR_PTR
(-
ENOENT
);

1737 ià(
loÿtiÚ
->
objeùid
 =ð
BTRFS_FREE_SPACE_TREE_OBJECTID
)

1738  
fs_šfo
->
ä“_¥aû_roÙ
 ? fs_info->free_space_root :

1739 
	`ERR_PTR
(-
ENOENT
);

1740 
agaš
:

1741 
roÙ
 = 
	`bŒfs_lookup_fs_roÙ
(
fs_šfo
, 
loÿtiÚ
->
objeùid
);

1742 ià(
roÙ
) {

1743 ià(
check_»f
 && 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

1744  
	`ERR_PTR
(-
ENOENT
);

1745  
roÙ
;

1748 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ
(
fs_šfo
->
Œ“_roÙ
, 
loÿtiÚ
);

1749 ià(
	`IS_ERR
(
roÙ
))

1750  
roÙ
;

1752 ià(
check_»f
 && 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

1753 
»t
 = -
ENOENT
;

1754 
çž
;

1757 
»t
 = 
	`bŒfs_š™_fs_roÙ
(
roÙ
);

1758 ià(
»t
)

1759 
çž
;

1761 
·th
 = 
	`bŒfs_®loc_·th
();

1762 ià(!
·th
) {

1763 
»t
 = -
ENOMEM
;

1764 
çž
;

1766 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

1767 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1768 
key
.
off£t
 = 
loÿtiÚ
->
objeùid
;

1770 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

1771 
	`bŒfs_ä“_·th
(
·th
);

1772 ià(
»t
 < 0)

1773 
çž
;

1774 ià(
»t
 == 0)

1775 
	`£t_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
);

1777 
»t
 = 
	`bŒfs_š£¹_fs_roÙ
(
fs_šfo
, 
roÙ
);

1778 ià(
»t
) {

1779 ià(
»t
 =ð-
EEXIST
) {

1780 
	`ä“_fs_roÙ
(
roÙ
);

1781 
agaš
;

1783 
çž
;

1785  
roÙ
;

1786 
çž
:

1787 
	`ä“_fs_roÙ
(
roÙ
);

1788  
	`ERR_PTR
(
»t
);

1789 
	}
}

1791 
	$bŒfs_cÚge¡ed_â
(*
cÚge¡ed_d©a
, 
bdi_b™s
)

1793 
bŒfs_fs_šfo
 *
šfo
 = (bŒfs_fs_šfØ*)
cÚge¡ed_d©a
;

1794 
»t
 = 0;

1795 
bŒfs_deviû
 *
deviû
;

1796 
backšg_dev_šfo
 *
bdi
;

1798 
	`rcu_»ad_lock
();

1799 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
šfo
->
fs_deviûs
->
deviûs
, 
dev_li¡
) {

1800 ià(!
deviû
->
bdev
)

1802 
bdi
 = 
deviû
->
bdev
->
bd_bdi
;

1803 ià(
	`bdi_cÚge¡ed
(
bdi
, 
bdi_b™s
)) {

1804 
»t
 = 1;

1808 
	`rcu_»ad_uÆock
();

1809  
»t
;

1810 
	}
}

1816 
	$’d_wÜkqueue_â
(
bŒfs_wÜk
 *
wÜk
)

1818 
bio
 *bio;

1819 
bŒfs_’d_io_wq
 *
’d_io_wq
;

1821 
’d_io_wq
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_’d_io_wq
, work);

1822 
bio
 = 
’d_io_wq
->bio;

1824 
bio
->
bi_¡©us
 = 
’d_io_wq
->
¡©us
;

1825 
bio
->
bi_´iv©e
 = 
’d_io_wq
->
´iv©e
;

1826 
bio
->
bi_’d_io
 = 
’d_io_wq
->
’d_io
;

1827 
	`kmem_ÿche_ä“
(
bŒfs_’d_io_wq_ÿche
, 
’d_io_wq
);

1828 
	`bio_’dio
(
bio
);

1829 
	}
}

1831 
	$þ—Ãr_kth»ad
(*
¬g
)

1833 
bŒfs_roÙ
 *
roÙ
 = 
¬g
;

1834 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1835 
agaš
;

1836 
bŒfs_Œªs_hªdË
 *
Œªs
;

1839 
agaš
 = 0;

1842 ià(
	`bŒfs_Ãed_þ—Ãr_¦“p
(
fs_šfo
))

1843 
¦“p
;

1849 ià(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
))

1850 
¦“p
;

1852 ià(!
	`mu‹x_Œylock
(&
fs_šfo
->
þ—Ãr_mu‹x
))

1853 
¦“p
;

1859 ià(
	`bŒfs_Ãed_þ—Ãr_¦“p
(
fs_šfo
)) {

1860 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

1861 
¦“p
;

1864 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_d–ayed_ut_mu‹x
);

1865 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

1866 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_d–ayed_ut_mu‹x
);

1868 
agaš
 = 
	`bŒfs_þ—n_Úe_d–‘ed_¢­shÙ
(
roÙ
);

1869 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

1875 
	`bŒfs_run_deäag_šodes
(
fs_šfo
);

1885 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

1886 
¦“p
:

1887 ià(!
agaš
) {

1888 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

1889 ià(!
	`kth»ad_should_¡Ý
())

1890 
	`scheduË
();

1891 
	`__£t_cu¼’t_¡©e
(
TASK_RUNNING
);

1893 } !
	`kth»ad_should_¡Ý
());

1906 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

1907 ià(
	`IS_ERR
(
Œªs
)) {

1908 ià(
	`PTR_ERR
(
Œªs
è!ð-
ENOENT
)

1909 
	`bŒfs_”r
(
fs_šfo
,

1911 
	`PTR_ERR
(
Œªs
));

1913 
»t
;

1915 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1916 ià(
»t
)

1917 
	`bŒfs_”r
(
fs_šfo
,

1919 
»t
);

1923 
	}
}

1925 
	$Œª§ùiÚ_kth»ad
(*
¬g
)

1927 
bŒfs_roÙ
 *
roÙ
 = 
¬g
;

1928 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1929 
bŒfs_Œªs_hªdË
 *
Œªs
;

1930 
bŒfs_Œª§ùiÚ
 *
cur
;

1931 
u64
 
Œªsid
;

1932 
now
;

1933 
d–ay
;

1934 
boÞ
 
ÿÂÙ_comm™
;

1937 
ÿÂÙ_comm™
 = 
çl£
;

1938 
d–ay
 = 
HZ
 * 
fs_šfo
->
comm™_š‹rv®
;

1939 
	`mu‹x_lock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

1941 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1942 
cur
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

1943 ià(!
cur
) {

1944 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1945 
¦“p
;

1948 
now
 = 
	`g‘_£cÚds
();

1949 ià(
cur
->
¡©e
 < 
TRANS_STATE_BLOCKED
 &&

1950 (
now
 < 
cur
->
¡¬t_time
 ||

1951 
now
 - 
cur
->
¡¬t_time
 < 
fs_šfo
->
comm™_š‹rv®
)) {

1952 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1953 
d–ay
 = 
HZ
 * 5;

1954 
¦“p
;

1956 
Œªsid
 = 
cur
->transid;

1957 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1960 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

1961 ià(
	`IS_ERR
(
Œªs
)) {

1962 ià(
	`PTR_ERR
(
Œªs
è!ð-
ENOENT
)

1963 
ÿÂÙ_comm™
 = 
Œue
;

1964 
¦“p
;

1966 ià(
Œªsid
 =ð
Œªs
->transid) {

1967 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1969 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1971 
¦“p
:

1972 
	`wake_up_´oûss
(
fs_šfo
->
þ—Ãr_kth»ad
);

1973 
	`mu‹x_uÆock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

1975 ià(
	`uÆik–y
(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
,

1976 &
fs_šfo
->
fs_¡©e
)))

1977 
	`bŒfs_þ—nup_Œª§ùiÚ
(
fs_šfo
);

1978 
	`£t_cu¼’t_¡©e
(
TASK_INTERRUPTIBLE
);

1979 ià(!
	`kth»ad_should_¡Ý
() &&

1980 (!
	`bŒfs_Œª§ùiÚ_blocked
(
fs_šfo
) ||

1981 
ÿÂÙ_comm™
))

1982 
	`scheduË_timeout
(
d–ay
);

1983 
	`__£t_cu¼’t_¡©e
(
TASK_RUNNING
);

1984 } !
	`kth»ad_should_¡Ý
());

1986 
	}
}

1997 
	$fšd_Ãwe¡_su³r_backup
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
Ãwe¡_g’
)

1999 
u64
 
cur
;

2000 
Ãwe¡_šdex
 = -1;

2001 
bŒfs_roÙ_backup
 *
roÙ_backup
;

2002 
i
;

2004 
i
 = 0; i < 
BTRFS_NUM_BACKUP_ROOTS
; i++) {

2005 
roÙ_backup
 = 
šfo
->
su³r_cÝy
->
su³r_roÙs
 + 
i
;

2006 
cur
 = 
	`bŒfs_backup_Œ“_roÙ_g’
(
roÙ_backup
);

2007 ià(
cur
 =ð
Ãwe¡_g’
)

2008 
Ãwe¡_šdex
 = 
i
;

2012 ià(
Ãwe¡_šdex
 =ð
BTRFS_NUM_BACKUP_ROOTS
 - 1) {

2013 
roÙ_backup
 = 
šfo
->
su³r_cÝy
->
su³r_roÙs
;

2014 
cur
 = 
	`bŒfs_backup_Œ“_roÙ_g’
(
roÙ_backup
);

2015 ià(
cur
 =ð
Ãwe¡_g’
)

2016 
Ãwe¡_šdex
 = 0;

2018  
Ãwe¡_šdex
;

2019 
	}
}

2027 
	$fšd_Þde¡_su³r_backup
(
bŒfs_fs_šfo
 *
šfo
,

2028 
u64
 
Ãwe¡_g’
)

2030 
Ãwe¡_šdex
 = -1;

2032 
Ãwe¡_šdex
 = 
	`fšd_Ãwe¡_su³r_backup
(
šfo
, 
Ãwe¡_g’
);

2034 ià(
Ãwe¡_šdex
 == -1) {

2035 
šfo
->
backup_roÙ_šdex
 = 0;

2037 
šfo
->
backup_roÙ_šdex
 = (
Ãwe¡_šdex
 + 1è% 
BTRFS_NUM_BACKUP_ROOTS
;

2039 
	}
}

2046 
	$backup_su³r_roÙs
(
bŒfs_fs_šfo
 *
šfo
)

2048 
Ãxt_backup
;

2049 
bŒfs_roÙ_backup
 *
roÙ_backup
;

2050 
Ï¡_backup
;

2052 
Ãxt_backup
 = 
šfo
->
backup_roÙ_šdex
;

2053 
Ï¡_backup
 = (
Ãxt_backup
 + 
BTRFS_NUM_BACKUP_ROOTS
 - 1) %

2054 
BTRFS_NUM_BACKUP_ROOTS
;

2060 
roÙ_backup
 = 
šfo
->
su³r_fÜ_comm™
->
su³r_roÙs
 + 
Ï¡_backup
;

2061 ià(
	`bŒfs_backup_Œ“_roÙ_g’
(
roÙ_backup
) ==

2062 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
Œ“_roÙ
->
node
))

2063 
Ãxt_backup
 = 
Ï¡_backup
;

2065 
roÙ_backup
 = 
šfo
->
su³r_fÜ_comm™
->
su³r_roÙs
 + 
Ãxt_backup
;

2071 
	`mem£t
(
roÙ_backup
, 0, (*root_backup));

2073 
šfo
->
backup_roÙ_šdex
 = (
Ãxt_backup
 + 1è% 
BTRFS_NUM_BACKUP_ROOTS
;

2075 
	`bŒfs_£t_backup_Œ“_roÙ
(
roÙ_backup
, 
šfo
->
Œ“_roÙ
->
node
->
¡¬t
);

2076 
	`bŒfs_£t_backup_Œ“_roÙ_g’
(
roÙ_backup
,

2077 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
Œ“_roÙ
->
node
));

2079 
	`bŒfs_£t_backup_Œ“_roÙ_Ëv–
(
roÙ_backup
,

2080 
	`bŒfs_h—d”_Ëv–
(
šfo
->
Œ“_roÙ
->
node
));

2082 
	`bŒfs_£t_backup_chunk_roÙ
(
roÙ_backup
, 
šfo
->
chunk_roÙ
->
node
->
¡¬t
);

2083 
	`bŒfs_£t_backup_chunk_roÙ_g’
(
roÙ_backup
,

2084 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
chunk_roÙ
->
node
));

2085 
	`bŒfs_£t_backup_chunk_roÙ_Ëv–
(
roÙ_backup
,

2086 
	`bŒfs_h—d”_Ëv–
(
šfo
->
chunk_roÙ
->
node
));

2088 
	`bŒfs_£t_backup_ex‹Á_roÙ
(
roÙ_backup
, 
šfo
->
ex‹Á_roÙ
->
node
->
¡¬t
);

2089 
	`bŒfs_£t_backup_ex‹Á_roÙ_g’
(
roÙ_backup
,

2090 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
ex‹Á_roÙ
->
node
));

2091 
	`bŒfs_£t_backup_ex‹Á_roÙ_Ëv–
(
roÙ_backup
,

2092 
	`bŒfs_h—d”_Ëv–
(
šfo
->
ex‹Á_roÙ
->
node
));

2098 ià(
šfo
->
fs_roÙ
 && info->fs_roÙ->
node
) {

2099 
	`bŒfs_£t_backup_fs_roÙ
(
roÙ_backup
,

2100 
šfo
->
fs_roÙ
->
node
->
¡¬t
);

2101 
	`bŒfs_£t_backup_fs_roÙ_g’
(
roÙ_backup
,

2102 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
fs_roÙ
->
node
));

2103 
	`bŒfs_£t_backup_fs_roÙ_Ëv–
(
roÙ_backup
,

2104 
	`bŒfs_h—d”_Ëv–
(
šfo
->
fs_roÙ
->
node
));

2107 
	`bŒfs_£t_backup_dev_roÙ
(
roÙ_backup
, 
šfo
->
dev_roÙ
->
node
->
¡¬t
);

2108 
	`bŒfs_£t_backup_dev_roÙ_g’
(
roÙ_backup
,

2109 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
dev_roÙ
->
node
));

2110 
	`bŒfs_£t_backup_dev_roÙ_Ëv–
(
roÙ_backup
,

2111 
	`bŒfs_h—d”_Ëv–
(
šfo
->
dev_roÙ
->
node
));

2113 
	`bŒfs_£t_backup_csum_roÙ
(
roÙ_backup
, 
šfo
->
csum_roÙ
->
node
->
¡¬t
);

2114 
	`bŒfs_£t_backup_csum_roÙ_g’
(
roÙ_backup
,

2115 
	`bŒfs_h—d”_g’”©iÚ
(
šfo
->
csum_roÙ
->
node
));

2116 
	`bŒfs_£t_backup_csum_roÙ_Ëv–
(
roÙ_backup
,

2117 
	`bŒfs_h—d”_Ëv–
(
šfo
->
csum_roÙ
->
node
));

2119 
	`bŒfs_£t_backup_tÙ®_by‹s
(
roÙ_backup
,

2120 
	`bŒfs_su³r_tÙ®_by‹s
(
šfo
->
su³r_cÝy
));

2121 
	`bŒfs_£t_backup_by‹s_u£d
(
roÙ_backup
,

2122 
	`bŒfs_su³r_by‹s_u£d
(
šfo
->
su³r_cÝy
));

2123 
	`bŒfs_£t_backup_num_deviûs
(
roÙ_backup
,

2124 
	`bŒfs_su³r_num_deviûs
(
šfo
->
su³r_cÝy
));

2130 
	`memýy
(&
šfo
->
su³r_cÝy
->
su³r_roÙs
,

2131 &
šfo
->
su³r_fÜ_comm™
->
su³r_roÙs
,

2132 (*
roÙ_backup
è* 
BTRFS_NUM_BACKUP_ROOTS
);

2133 
	}
}

2143 
nošlše
 
	$Ãxt_roÙ_backup
(
bŒfs_fs_šfo
 *
šfo
,

2144 
bŒfs_su³r_block
 *
su³r
,

2145 *
num_backups_Œ›d
, *
backup_šdex
)

2147 
bŒfs_roÙ_backup
 *
roÙ_backup
;

2148 
Ãwe¡
 = *
backup_šdex
;

2150 ià(*
num_backups_Œ›d
 == 0) {

2151 
u64
 
g’
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r
);

2153 
Ãwe¡
 = 
	`fšd_Ãwe¡_su³r_backup
(
šfo
, 
g’
);

2154 ià(
Ãwe¡
 == -1)

2157 *
backup_šdex
 = 
Ãwe¡
;

2158 *
num_backups_Œ›d
 = 1;

2159 } ià(*
num_backups_Œ›d
 =ð
BTRFS_NUM_BACKUP_ROOTS
) {

2164 
Ãwe¡
 = (*
backup_šdex
 + 
BTRFS_NUM_BACKUP_ROOTS
 - 1) %

2165 
BTRFS_NUM_BACKUP_ROOTS
;

2166 *
backup_šdex
 = 
Ãwe¡
;

2167 *
num_backups_Œ›d
 += 1;

2169 
roÙ_backup
 = 
su³r
->
su³r_roÙs
 + 
Ãwe¡
;

2171 
	`bŒfs_£t_su³r_g’”©iÚ
(
su³r
,

2172 
	`bŒfs_backup_Œ“_roÙ_g’
(
roÙ_backup
));

2173 
	`bŒfs_£t_su³r_roÙ
(
su³r
, 
	`bŒfs_backup_Œ“_roÙ
(
roÙ_backup
));

2174 
	`bŒfs_£t_su³r_roÙ_Ëv–
(
su³r
,

2175 
	`bŒfs_backup_Œ“_roÙ_Ëv–
(
roÙ_backup
));

2176 
	`bŒfs_£t_su³r_by‹s_u£d
(
su³r
, 
	`bŒfs_backup_by‹s_u£d
(
roÙ_backup
));

2182 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
su³r
, 
	`bŒfs_backup_tÙ®_by‹s
(
roÙ_backup
));

2183 
	`bŒfs_£t_su³r_num_deviûs
(
su³r
, 
	`bŒfs_backup_num_deviûs
(
roÙ_backup
));

2185 
	}
}

2188 
	$bŒfs_¡Ý_®l_wÜk”s
(
bŒfs_fs_šfo
 *
fs_šfo
)

2190 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
fixup_wÜk”s
);

2191 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
d–®loc_wÜk”s
);

2192 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
wÜk”s
);

2193 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_wÜk”s
);

2194 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_¿id56_wÜk”s
);

2195 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_»·œ_wÜk”s
);

2196 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
rmw_wÜk”s
);

2197 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_wr™e_wÜk”s
);

2198 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_ä“¥aû_wÜk”
);

2199 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
subm™_wÜk”s
);

2200 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
d–ayed_wÜk”s
);

2201 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
ÿchšg_wÜk”s
);

2202 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
»adah—d_wÜk”s
);

2203 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
æush_wÜk”s
);

2204 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
);

2205 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
ex‹Á_wÜk”s
);

2211 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_m‘a_wÜk”s
);

2212 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
’dio_m‘a_wr™e_wÜk”s
);

2213 
	}
}

2215 
	$ä“_roÙ_ex‹Á_bufãrs
(
bŒfs_roÙ
 *
roÙ
)

2217 ià(
roÙ
) {

2218 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

2219 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

2220 
roÙ
->
node
 = 
NULL
;

2221 
roÙ
->
comm™_roÙ
 = 
NULL
;

2223 
	}
}

2226 
	$ä“_roÙ_poš‹rs
(
bŒfs_fs_šfo
 *
šfo
, 
chunk_roÙ
)

2228 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
Œ“_roÙ
);

2230 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
dev_roÙ
);

2231 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
ex‹Á_roÙ
);

2232 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
csum_roÙ
);

2233 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
quÙa_roÙ
);

2234 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
uuid_roÙ
);

2235 ià(
chunk_roÙ
)

2236 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
chunk_roÙ
);

2237 
	`ä“_roÙ_ex‹Á_bufãrs
(
šfo
->
ä“_¥aû_roÙ
);

2238 
	}
}

2240 
	$bŒfs_ä“_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2242 
»t
;

2243 
bŒfs_roÙ
 *
gªg
[8];

2244 
i
;

2246 !
	`li¡_em±y
(&
fs_šfo
->
d—d_roÙs
)) {

2247 
gªg
[0] = 
	`li¡_’Œy
(
fs_šfo
->
d—d_roÙs
.
Ãxt
,

2248 
bŒfs_roÙ
, 
roÙ_li¡
);

2249 
	`li¡_d–
(&
gªg
[0]->
roÙ_li¡
);

2251 ià(
	`‹¡_b™
(
BTRFS_ROOT_IN_RADIX
, &
gªg
[0]->
¡©e
)) {

2252 
	`bŒfs_drÝ_ªd_ä“_fs_roÙ
(
fs_šfo
, 
gªg
[0]);

2254 
	`ä“_ex‹Á_bufãr
(
gªg
[0]->
node
);

2255 
	`ä“_ex‹Á_bufãr
(
gªg
[0]->
comm™_roÙ
);

2256 
	`bŒfs_put_fs_roÙ
(
gªg
[0]);

2261 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

2262 (**)
gªg
, 0,

2263 
	`ARRAY_SIZE
(
gªg
));

2264 ià(!
»t
)

2266 
i
 = 0; i < 
»t
; i++)

2267 
	`bŒfs_drÝ_ªd_ä“_fs_roÙ
(
fs_šfo
, 
gªg
[
i
]);

2270 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

2271 
	`bŒfs_ä“_log_roÙ_Œ“
(
NULL
, 
fs_šfo
);

2272 
	`bŒfs_de¡roy_pšÃd_ex‹Á
(
fs_šfo
, fs_šfo->
pšÃd_ex‹Ás
);

2274 
	}
}

2276 
	$bŒfs_š™_süub
(
bŒfs_fs_šfo
 *
fs_šfo
)

2278 
	`mu‹x_š™
(&
fs_šfo
->
süub_lock
);

2279 
	`©omic_£t
(&
fs_šfo
->
süubs_ruÂšg
, 0);

2280 
	`©omic_£t
(&
fs_šfo
->
süub_·u£_»q
, 0);

2281 
	`©omic_£t
(&
fs_šfo
->
süubs_·u£d
, 0);

2282 
	`©omic_£t
(&
fs_šfo
->
süub_ÿnûl_»q
, 0);

2283 
	`š™_wa™queue_h—d
(&
fs_šfo
->
süub_·u£_wa™
);

2284 
fs_šfo
->
süub_wÜk”s_»fút
 = 0;

2285 
	}
}

2287 
	$bŒfs_š™_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

2289 
	`¥š_lock_š™
(&
fs_šfo
->
b®ªû_lock
);

2290 
	`mu‹x_š™
(&
fs_šfo
->
b®ªû_mu‹x
);

2291 
	`©omic_£t
(&
fs_šfo
->
b®ªû_ruÂšg
, 0);

2292 
	`©omic_£t
(&
fs_šfo
->
b®ªû_·u£_»q
, 0);

2293 
	`©omic_£t
(&
fs_šfo
->
b®ªû_ÿnûl_»q
, 0);

2294 
fs_šfo
->
b®ªû_ùl
 = 
NULL
;

2295 
	`š™_wa™queue_h—d
(&
fs_šfo
->
b®ªû_wa™_q
);

2296 
	}
}

2298 
	$bŒfs_š™_bŒ“_šode
(
bŒfs_fs_šfo
 *
fs_šfo
)

2300 
šode
 *šodð
fs_šfo
->
bŒ“_šode
;

2302 
šode
->
i_šo
 = 
BTRFS_BTREE_INODE_OBJECTID
;

2303 
	`£t_Æšk
(
šode
, 1);

2309 
šode
->
i_size
 = 
OFFSET_MAX
;

2310 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒ“_aÝs
;

2312 
	`RB_CLEAR_NODE
(&
	`BTRFS_I
(
šode
)->
rb_node
);

2313 
	`ex‹Á_io_Œ“_š™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, inode);

2314 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Œack_u±od©e
 = 0;

2315 
	`ex‹Á_m­_Œ“_š™
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
);

2317 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Ýs
 = &
bŒ“_ex‹Á_io_Ýs
;

2319 
	`BTRFS_I
(
šode
)->
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

2320 
	`mem£t
(&
	`BTRFS_I
(
šode
)->
loÿtiÚ
, 0, (
bŒfs_key
));

2321 
	`£t_b™
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

2322 
	`bŒfs_š£¹_šode_hash
(
šode
);

2323 
	}
}

2325 
	$bŒfs_š™_dev_»¶aû_locks
(
bŒfs_fs_šfo
 *
fs_šfo
)

2327 
fs_šfo
->
dev_»¶aû
.
lock_owÃr
 = 0;

2328 
	`©omic_£t
(&
fs_šfo
->
dev_»¶aû
.
Ã¡šg_Ëv–
, 0);

2329 
	`mu‹x_š™
(&
fs_šfo
->
dev_»¶aû
.
lock_fšishšg_ÿnûl_unmouÁ
);

2330 
	`rwlock_š™
(&
fs_šfo
->
dev_»¶aû
.
lock
);

2331 
	`©omic_£t
(&
fs_šfo
->
dev_»¶aû
.
»ad_locks
, 0);

2332 
	`©omic_£t
(&
fs_šfo
->
dev_»¶aû
.
blockšg_»ad”s
, 0);

2333 
	`š™_wa™queue_h—d
(&
fs_šfo
->
»¶aû_wa™
);

2334 
	`š™_wa™queue_h—d
(&
fs_šfo
->
dev_»¶aû
.
»ad_lock_wq
);

2335 
	}
}

2337 
	$bŒfs_š™_qgroup
(
bŒfs_fs_šfo
 *
fs_šfo
)

2339 
	`¥š_lock_š™
(&
fs_šfo
->
qgroup_lock
);

2340 
	`mu‹x_š™
(&
fs_šfo
->
qgroup_ioùl_lock
);

2341 
fs_šfo
->
qgroup_Œ“
 = 
RB_ROOT
;

2342 
fs_šfo
->
qgroup_Ý_Œ“
 = 
RB_ROOT
;

2343 
	`INIT_LIST_HEAD
(&
fs_šfo
->
dœty_qgroups
);

2344 
fs_šfo
->
qgroup_£q
 = 1;

2345 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

2346 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
çl£
;

2347 
	`mu‹x_š™
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2348 
	}
}

2350 
	$bŒfs_š™_wÜkqueues
(
bŒfs_fs_šfo
 *
fs_šfo
,

2351 
bŒfs_fs_deviûs
 *
fs_deviûs
)

2353 
max_aùive
 = 
fs_šfo
->
th»ad_poÞ_size
;

2354 
æags
 = 
WQ_MEM_RECLAIM
 | 
WQ_FREEZABLE
 | 
WQ_UNBOUND
;

2356 
fs_šfo
->
wÜk”s
 =

2357 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "worker",

2358 
æags
 | 
WQ_HIGHPRI
, 
max_aùive
, 16);

2360 
fs_šfo
->
d–®loc_wÜk”s
 =

2361 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "delalloc",

2362 
æags
, 
max_aùive
, 2);

2364 
fs_šfo
->
æush_wÜk”s
 =

2365 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "flush_delalloc",

2366 
æags
, 
max_aùive
, 0);

2368 
fs_šfo
->
ÿchšg_wÜk”s
 =

2369 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "ÿche", 
æags
, 
max_aùive
, 0);

2376 
fs_šfo
->
subm™_wÜk”s
 =

2377 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "subm™", 
æags
,

2378 
	`mš_t
(
u64
, 
fs_deviûs
->
num_deviûs
,

2379 
max_aùive
), 64);

2381 
fs_šfo
->
fixup_wÜk”s
 =

2382 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "fixup", 
æags
, 1, 0);

2388 
fs_šfo
->
’dio_wÜk”s
 =

2389 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio", 
æags
, 
max_aùive
, 4);

2390 
fs_šfo
->
’dio_m‘a_wÜk”s
 =

2391 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio-m‘a", 
æags
,

2392 
max_aùive
, 4);

2393 
fs_šfo
->
’dio_m‘a_wr™e_wÜk”s
 =

2394 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio-m‘a-wr™e", 
æags
,

2395 
max_aùive
, 2);

2396 
fs_šfo
->
’dio_¿id56_wÜk”s
 =

2397 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio-¿id56", 
æags
,

2398 
max_aùive
, 4);

2399 
fs_šfo
->
’dio_»·œ_wÜk”s
 =

2400 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio-»·œ", 
æags
, 1, 0);

2401 
fs_šfo
->
rmw_wÜk”s
 =

2402 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "rmw", 
æags
, 
max_aùive
, 2);

2403 
fs_šfo
->
’dio_wr™e_wÜk”s
 =

2404 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "’dio-wr™e", 
æags
,

2405 
max_aùive
, 2);

2406 
fs_šfo
->
’dio_ä“¥aû_wÜk”
 =

2407 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "ä“¥aû-wr™e", 
æags
,

2408 
max_aùive
, 0);

2409 
fs_šfo
->
d–ayed_wÜk”s
 =

2410 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "d–ayed-m‘a", 
æags
,

2411 
max_aùive
, 0);

2412 
fs_šfo
->
»adah—d_wÜk”s
 =

2413 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "»adah—d", 
æags
,

2414 
max_aùive
, 2);

2415 
fs_šfo
->
qgroup_»sÿn_wÜk”s
 =

2416 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "qgroup-»sÿn", 
æags
, 1, 0);

2417 
fs_šfo
->
ex‹Á_wÜk”s
 =

2418 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "ex‹Á-»fs", 
æags
,

2419 
	`mš_t
(
u64
, 
fs_deviûs
->
num_deviûs
,

2420 
max_aùive
), 8);

2422 ià(!(
fs_šfo
->
wÜk”s
 && fs_šfo->
d–®loc_wÜk”s
 &&

2423 
fs_šfo
->
subm™_wÜk”s
 && fs_šfo->
æush_wÜk”s
 &&

2424 
fs_šfo
->
’dio_wÜk”s
 && fs_šfo->
’dio_m‘a_wÜk”s
 &&

2425 
fs_šfo
->
’dio_m‘a_wr™e_wÜk”s
 &&

2426 
fs_šfo
->
’dio_»·œ_wÜk”s
 &&

2427 
fs_šfo
->
’dio_wr™e_wÜk”s
 && fs_šfo->
’dio_¿id56_wÜk”s
 &&

2428 
fs_šfo
->
’dio_ä“¥aû_wÜk”
 && fs_šfo->
rmw_wÜk”s
 &&

2429 
fs_šfo
->
ÿchšg_wÜk”s
 && fs_šfo->
»adah—d_wÜk”s
 &&

2430 
fs_šfo
->
fixup_wÜk”s
 && fs_šfo->
d–ayed_wÜk”s
 &&

2431 
fs_šfo
->
ex‹Á_wÜk”s
 &&

2432 
fs_šfo
->
qgroup_»sÿn_wÜk”s
)) {

2433  -
ENOMEM
;

2437 
	}
}

2439 
	$bŒfs_»¶ay_log
(
bŒfs_fs_šfo
 *
fs_šfo
,

2440 
bŒfs_fs_deviûs
 *
fs_deviûs
)

2442 
»t
;

2443 
bŒfs_roÙ
 *
log_Œ“_roÙ
;

2444 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

2445 
u64
 
by‹Ä
 = 
	`bŒfs_su³r_log_roÙ
(
disk_su³r
);

2447 ià(
fs_deviûs
->
rw_deviûs
 == 0) {

2448 
	`bŒfs_w¬n
(
fs_šfo
, "log„eplay„equired on RO media");

2449  -
EIO
;

2452 
log_Œ“_roÙ
 = 
	`bŒfs_®loc_roÙ
(
fs_šfo
, 
GFP_KERNEL
);

2453 ià(!
log_Œ“_roÙ
)

2454  -
ENOMEM
;

2456 
	`__£tup_roÙ
(
log_Œ“_roÙ
, 
fs_šfo
, 
BTRFS_TREE_LOG_OBJECTID
);

2458 
log_Œ“_roÙ
->
node
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
by‹Ä
,

2459 
fs_šfo
->
g’”©iÚ
 + 1);

2460 ià(
	`IS_ERR
(
log_Œ“_roÙ
->
node
)) {

2461 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„ead†ogree");

2462 
»t
 = 
	`PTR_ERR
(
log_Œ“_roÙ
->
node
);

2463 
	`kä“
(
log_Œ“_roÙ
);

2464  
»t
;

2465 } ià(!
	`ex‹Á_bufãr_u±od©e
(
log_Œ“_roÙ
->
node
)) {

2466 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead†ogree");

2467 
	`ä“_ex‹Á_bufãr
(
log_Œ“_roÙ
->
node
);

2468 
	`kä“
(
log_Œ“_roÙ
);

2469  -
EIO
;

2472 
»t
 = 
	`bŒfs_»cov”_log_Œ“s
(
log_Œ“_roÙ
);

2473 ià(
»t
) {

2474 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2476 
	`ä“_ex‹Á_bufãr
(
log_Œ“_roÙ
->
node
);

2477 
	`kä“
(
log_Œ“_roÙ
);

2478  
»t
;

2481 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

2482 
»t
 = 
	`bŒfs_comm™_su³r
(
fs_šfo
);

2483 ià(
»t
)

2484  
»t
;

2488 
	}
}

2490 
	$bŒfs_»ad_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

2492 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

2493 
bŒfs_roÙ
 *
roÙ
;

2494 
bŒfs_key
 
loÿtiÚ
;

2495 
»t
;

2497 
	`BUG_ON
(!
fs_šfo
->
Œ“_roÙ
);

2499 
loÿtiÚ
.
objeùid
 = 
BTRFS_EXTENT_TREE_OBJECTID
;

2500 
loÿtiÚ
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2501 
loÿtiÚ
.
off£t
 = 0;

2503 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2504 ià(
	`IS_ERR
(
roÙ
))

2505  
	`PTR_ERR
(
roÙ
);

2506 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2507 
fs_šfo
->
ex‹Á_roÙ
 = 
roÙ
;

2509 
loÿtiÚ
.
objeùid
 = 
BTRFS_DEV_TREE_OBJECTID
;

2510 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2511 ià(
	`IS_ERR
(
roÙ
))

2512  
	`PTR_ERR
(
roÙ
);

2513 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2514 
fs_šfo
->
dev_roÙ
 = 
roÙ
;

2515 
	`bŒfs_š™_deviûs_Ï‹
(
fs_šfo
);

2517 
loÿtiÚ
.
objeùid
 = 
BTRFS_CSUM_TREE_OBJECTID
;

2518 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2519 ià(
	`IS_ERR
(
roÙ
))

2520  
	`PTR_ERR
(
roÙ
);

2521 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2522 
fs_šfo
->
csum_roÙ
 = 
roÙ
;

2524 
loÿtiÚ
.
objeùid
 = 
BTRFS_QUOTA_TREE_OBJECTID
;

2525 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2526 ià(!
	`IS_ERR
(
roÙ
)) {

2527 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2528 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

2529 
fs_šfo
->
quÙa_roÙ
 = 
roÙ
;

2532 
loÿtiÚ
.
objeùid
 = 
BTRFS_UUID_TREE_OBJECTID
;

2533 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2534 ià(
	`IS_ERR
(
roÙ
)) {

2535 
»t
 = 
	`PTR_ERR
(
roÙ
);

2536 ià(
»t
 !ð-
ENOENT
)

2537  
»t
;

2539 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2540 
fs_šfo
->
uuid_roÙ
 = 
roÙ
;

2543 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

2544 
loÿtiÚ
.
objeùid
 = 
BTRFS_FREE_SPACE_TREE_OBJECTID
;

2545 
roÙ
 = 
	`bŒfs_»ad_Œ“_roÙ
(
Œ“_roÙ
, &
loÿtiÚ
);

2546 ià(
	`IS_ERR
(
roÙ
))

2547  
	`PTR_ERR
(
roÙ
);

2548 
	`£t_b™
(
BTRFS_ROOT_TRACK_DIRTY
, &
roÙ
->
¡©e
);

2549 
fs_šfo
->
ä“_¥aû_roÙ
 = 
roÙ
;

2553 
	}
}

2555 
	$Ý’_ù»e
(
su³r_block
 *
sb
,

2556 
bŒfs_fs_deviûs
 *
fs_deviûs
,

2557 *
ÝtiÚs
)

2559 
u32
 
£ùÜsize
;

2560 
u32
 
nodesize
;

2561 
u32
 
¡resize
;

2562 
u64
 
g’”©iÚ
;

2563 
u64
 
ã©u»s
;

2564 
bŒfs_key
 
loÿtiÚ
;

2565 
bufãr_h—d
 *
bh
;

2566 
bŒfs_su³r_block
 *
disk_su³r
;

2567 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2568 
bŒfs_roÙ
 *
Œ“_roÙ
;

2569 
bŒfs_roÙ
 *
chunk_roÙ
;

2570 
»t
;

2571 
”r
 = -
EINVAL
;

2572 
num_backups_Œ›d
 = 0;

2573 
backup_šdex
 = 0;

2574 
max_aùive
;

2575 
þ—r_ä“_¥aû_Œ“
 = 0;

2577 
Œ“_roÙ
 = 
fs_šfo
->Œ“_roÙ = 
	`bŒfs_®loc_roÙ
(fs_šfo, 
GFP_KERNEL
);

2578 
chunk_roÙ
 = 
fs_šfo
->chunk_roÙ = 
	`bŒfs_®loc_roÙ
(fs_šfo, 
GFP_KERNEL
);

2579 ià(!
Œ“_roÙ
 || !
chunk_roÙ
) {

2580 
”r
 = -
ENOMEM
;

2581 
çž
;

2584 
»t
 = 
	`š™_¤cu_¡ruù
(&
fs_šfo
->
subvÞ_¤cu
);

2585 ià(
»t
) {

2586 
”r
 = 
»t
;

2587 
çž
;

2590 
»t
 = 
	`³rýu_couÁ”_š™
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
, 0, 
GFP_KERNEL
);

2591 ià(
»t
) {

2592 
”r
 = 
»t
;

2593 
çž_¤cu
;

2595 
fs_šfo
->
dœty_m‘ad©a_b©ch
 = 
PAGE_SIZE
 *

2596 (1 + 
	`žog2
(
Ä_ýu_ids
));

2598 
»t
 = 
	`³rýu_couÁ”_š™
(&
fs_šfo
->
d–®loc_by‹s
, 0, 
GFP_KERNEL
);

2599 ià(
»t
) {

2600 
”r
 = 
»t
;

2601 
çž_dœty_m‘ad©a_by‹s
;

2604 
»t
 = 
	`³rýu_couÁ”_š™
(&
fs_šfo
->
bio_couÁ”
, 0, 
GFP_KERNEL
);

2605 ià(
»t
) {

2606 
”r
 = 
»t
;

2607 
çž_d–®loc_by‹s
;

2610 
fs_šfo
->
bŒ“_šode
 = 
	`Ãw_šode
(
sb
);

2611 ià(!
fs_šfo
->
bŒ“_šode
) {

2612 
”r
 = -
ENOMEM
;

2613 
çž_bio_couÁ”
;

2616 
	`m­pšg_£t_gå_mask
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
, 
GFP_NOFS
);

2618 
	`INIT_RADIX_TREE
(&
fs_šfo
->
fs_roÙs_¿dix
, 
GFP_ATOMIC
);

2619 
	`INIT_RADIX_TREE
(&
fs_šfo
->
bufãr_¿dix
, 
GFP_ATOMIC
);

2620 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Œªs_li¡
);

2621 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d—d_roÙs
);

2622 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d–ayed_uts
);

2623 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d–®loc_roÙs
);

2624 
	`INIT_LIST_HEAD
(&
fs_šfo
->
ÿchšg_block_groups
);

2625 
	`¥š_lock_š™
(&
fs_šfo
->
d–®loc_roÙ_lock
);

2626 
	`¥š_lock_š™
(&
fs_šfo
->
Œªs_lock
);

2627 
	`¥š_lock_š™
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

2628 
	`¥š_lock_š™
(&
fs_šfo
->
d–ayed_ut_lock
);

2629 
	`¥š_lock_š™
(&
fs_šfo
->
deäag_šodes_lock
);

2630 
	`¥š_lock_š™
(&
fs_šfo
->
Œ“_mod_£q_lock
);

2631 
	`¥š_lock_š™
(&
fs_šfo
->
su³r_lock
);

2632 
	`¥š_lock_š™
(&
fs_šfo
->
qgroup_Ý_lock
);

2633 
	`¥š_lock_š™
(&
fs_šfo
->
bufãr_lock
);

2634 
	`¥š_lock_š™
(&
fs_šfo
->
unu£d_bgs_lock
);

2635 
	`rwlock_š™
(&
fs_šfo
->
Œ“_mod_log_lock
);

2636 
	`mu‹x_š™
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

2637 
	`mu‹x_š™
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

2638 
	`mu‹x_š™
(&
fs_šfo
->
»loc_mu‹x
);

2639 
	`mu‹x_š™
(&
fs_šfo
->
d–®loc_roÙ_mu‹x
);

2640 
	`mu‹x_š™
(&
fs_šfo
->
þ—Ãr_d–ayed_ut_mu‹x
);

2641 
	`£qlock_š™
(&
fs_šfo
->
´ofžes_lock
);

2643 
	`INIT_LIST_HEAD
(&
fs_šfo
->
dœty_cowÚly_roÙs
);

2644 
	`INIT_LIST_HEAD
(&
fs_šfo
->
¥aû_šfo
);

2645 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Œ“_mod_£q_li¡
);

2646 
	`INIT_LIST_HEAD
(&
fs_šfo
->
unu£d_bgs
);

2647 
	`bŒfs_m­pšg_š™
(&
fs_šfo
->
m­pšg_Œ“
);

2648 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
glob®_block_rsv
,

2649 
BTRFS_BLOCK_RSV_GLOBAL
);

2650 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
d–®loc_block_rsv
,

2651 
BTRFS_BLOCK_RSV_DELALLOC
);

2652 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
Œªs_block_rsv
, 
BTRFS_BLOCK_RSV_TRANS
);

2653 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
chunk_block_rsv
, 
BTRFS_BLOCK_RSV_CHUNK
);

2654 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
em±y_block_rsv
, 
BTRFS_BLOCK_RSV_EMPTY
);

2655 
	`bŒfs_š™_block_rsv
(&
fs_šfo
->
d–ayed_block_rsv
,

2656 
BTRFS_BLOCK_RSV_DELOPS
);

2657 
	`©omic_£t
(&
fs_šfo
->
Ä_async_subm™s
, 0);

2658 
	`©omic_£t
(&
fs_šfo
->
async_d–®loc_·ges
, 0);

2659 
	`©omic_£t
(&
fs_šfo
->
async_subm™_d¿ššg
, 0);

2660 
	`©omic_£t
(&
fs_šfo
->
Ä_async_bios
, 0);

2661 
	`©omic_£t
(&
fs_šfo
->
deäag_ruÂšg
, 0);

2662 
	`©omic_£t
(&
fs_šfo
->
qgroup_Ý_£q
, 0);

2663 
	`©omic_£t
(&
fs_šfo
->
»ada_wÜks_út
, 0);

2664 
	`©omic64_£t
(&
fs_šfo
->
Œ“_mod_£q
, 0);

2665 
fs_šfo
->
sb
 = sb;

2666 
fs_šfo
->
max_šlše
 = 
BTRFS_DEFAULT_MAX_INLINE
;

2667 
fs_šfo
->
m‘ad©a_¿tio
 = 0;

2668 
fs_šfo
->
deäag_šodes
 = 
RB_ROOT
;

2669 
	`©omic64_£t
(&
fs_šfo
->
ä“_chunk_¥aû
, 0);

2670 
fs_šfo
->
Œ“_mod_log
 = 
RB_ROOT
;

2671 
fs_šfo
->
comm™_š‹rv®
 = 
BTRFS_DEFAULT_COMMIT_INTERVAL
;

2672 
fs_šfo
->
avg_d–ayed_»f_ruÁime
 = 
NSEC_PER_SEC
 >> 6;

2674 
	`INIT_RADIX_TREE
(&
fs_šfo
->
»ada_Œ“
, 
GFP_NOFS
 & ~
__GFP_DIRECT_RECLAIM
);

2675 
	`¥š_lock_š™
(&
fs_šfo
->
»ada_lock
);

2677 
fs_šfo
->
th»ad_poÞ_size
 = 
	`mš_t
(,

2678 
	`num_Úlše_ýus
() + 2, 8);

2680 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Üd”ed_roÙs
);

2681 
	`¥š_lock_š™
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

2682 
fs_šfo
->
d–ayed_roÙ
 = 
	`km®loc
((
bŒfs_d–ayed_roÙ
),

2683 
GFP_KERNEL
);

2684 ià(!
fs_šfo
->
d–ayed_roÙ
) {

2685 
”r
 = -
ENOMEM
;

2686 
çž_ut
;

2688 
	`bŒfs_š™_d–ayed_roÙ
(
fs_šfo
->
d–ayed_roÙ
);

2690 
	`bŒfs_š™_süub
(
fs_šfo
);

2691 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


2692 
fs_šfo
->
check_š‹gr™y_´št_mask
 = 0;

2694 
	`bŒfs_š™_b®ªû
(
fs_šfo
);

2695 
	`bŒfs_š™_async_»þaim_wÜk
(&
fs_šfo
->
async_»þaim_wÜk
);

2697 
sb
->
s_blocksize
 = 
BTRFS_BDEV_BLOCKSIZE
;

2698 
sb
->
s_blocksize_b™s
 = 
	`blksize_b™s
(
BTRFS_BDEV_BLOCKSIZE
);

2700 
	`bŒfs_š™_bŒ“_šode
(
fs_šfo
);

2702 
	`¥š_lock_š™
(&
fs_šfo
->
block_group_ÿche_lock
);

2703 
fs_šfo
->
block_group_ÿche_Œ“
 = 
RB_ROOT
;

2704 
fs_šfo
->
fœ¡_logiÿl_by‹
 = (
u64
)-1;

2706 
	`ex‹Á_io_Œ“_š™
(&
fs_šfo
->
ä“d_ex‹Ás
[0], 
NULL
);

2707 
	`ex‹Á_io_Œ“_š™
(&
fs_šfo
->
ä“d_ex‹Ás
[1], 
NULL
);

2708 
fs_šfo
->
pšÃd_ex‹Ás
 = &fs_šfo->
ä“d_ex‹Ás
[0];

2709 
	`£t_b™
(
BTRFS_FS_BARRIER
, &
fs_šfo
->
æags
);

2711 
	`mu‹x_š™
(&
fs_šfo
->
Üd”ed_Ý”©iÚs_mu‹x
);

2712 
	`mu‹x_š™
(&
fs_šfo
->
Œ“_log_mu‹x
);

2713 
	`mu‹x_š™
(&
fs_šfo
->
chunk_mu‹x
);

2714 
	`mu‹x_š™
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

2715 
	`mu‹x_š™
(&
fs_šfo
->
þ—Ãr_mu‹x
);

2716 
	`mu‹x_š™
(&
fs_šfo
->
vÞume_mu‹x
);

2717 
	`mu‹x_š™
(&
fs_šfo
->
ro_block_group_mu‹x
);

2718 
	`š™_rw£m
(&
fs_šfo
->
comm™_roÙ_£m
);

2719 
	`š™_rw£m
(&
fs_šfo
->
þ—nup_wÜk_£m
);

2720 
	`š™_rw£m
(&
fs_šfo
->
subvÞ_£m
);

2721 
	`£ma_š™
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
, 1);

2723 
	`bŒfs_š™_dev_»¶aû_locks
(
fs_šfo
);

2724 
	`bŒfs_š™_qgroup
(
fs_šfo
);

2726 
	`bŒfs_š™_ä“_þu¡”
(&
fs_šfo
->
m‘a_®loc_þu¡”
);

2727 
	`bŒfs_š™_ä“_þu¡”
(&
fs_šfo
->
d©a_®loc_þu¡”
);

2729 
	`š™_wa™queue_h—d
(&
fs_šfo
->
Œª§ùiÚ_thrÙŽe
);

2730 
	`š™_wa™queue_h—d
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

2731 
	`š™_wa™queue_h—d
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

2732 
	`š™_wa™queue_h—d
(&
fs_šfo
->
async_subm™_wa™
);

2734 
	`INIT_LIST_HEAD
(&
fs_šfo
->
pšÃd_chunks
);

2737 
fs_šfo
->
nodesize
 = 4096;

2738 
fs_šfo
->
£ùÜsize
 = 4096;

2739 
fs_šfo
->
¡resize
 = 4096;

2741 
»t
 = 
	`bŒfs_®loc_¡re_hash_bË
(
fs_šfo
);

2742 ià(
»t
) {

2743 
”r
 = 
»t
;

2744 
çž_®loc
;

2747 
	`__£tup_roÙ
(
Œ“_roÙ
, 
fs_šfo
, 
BTRFS_ROOT_TREE_OBJECTID
);

2749 
	`šv®id©e_bdev
(
fs_deviûs
->
Ï‹¡_bdev
);

2754 
bh
 = 
	`bŒfs_»ad_dev_su³r
(
fs_deviûs
->
Ï‹¡_bdev
);

2755 ià(
	`IS_ERR
(
bh
)) {

2756 
”r
 = 
	`PTR_ERR
(
bh
);

2757 
çž_®loc
;

2764 ià(
	`bŒfs_check_su³r_csum
(
fs_šfo
, 
bh
->
b_d©a
)) {

2765 
	`bŒfs_”r
(
fs_šfo
, "superblock checksum mismatch");

2766 
”r
 = -
EINVAL
;

2767 
	`b»l£
(
bh
);

2768 
çž_®loc
;

2776 
	`memýy
(
fs_šfo
->
su³r_cÝy
, 
bh
->
b_d©a
, (*fs_info->super_copy));

2777 
	`memýy
(
fs_šfo
->
su³r_fÜ_comm™
, fs_šfo->
su³r_cÝy
,

2778 (*
fs_šfo
->
su³r_fÜ_comm™
));

2779 
	`b»l£
(
bh
);

2781 
	`memýy
(
fs_šfo
->
fsid
, fs_šfo->
su³r_cÝy
->fsid, 
BTRFS_FSID_SIZE
);

2783 
»t
 = 
	`bŒfs_check_su³r_v®id
(
fs_šfo
);

2784 ià(
»t
) {

2785 
	`bŒfs_”r
(
fs_šfo
, "superblock contains fatalƒrrors");

2786 
”r
 = -
EINVAL
;

2787 
çž_®loc
;

2790 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

2791 ià(!
	`bŒfs_su³r_roÙ
(
disk_su³r
))

2792 
çž_®loc
;

2795 ià(
	`bŒfs_su³r_æags
(
disk_su³r
è& 
BTRFS_SUPER_FLAG_ERROR
)

2796 
	`£t_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
);

2802 
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

2803 
	`fšd_Þde¡_su³r_backup
(
fs_šfo
, 
g’”©iÚ
);

2809 
fs_šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

2811 
»t
 = 
	`bŒfs_·r£_ÝtiÚs
(
fs_šfo
, 
ÝtiÚs
, 
sb
->
s_æags
);

2812 ià(
»t
) {

2813 
”r
 = 
»t
;

2814 
çž_®loc
;

2817 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
) &

2818 ~
BTRFS_FEATURE_INCOMPAT_SUPP
;

2819 ià(
ã©u»s
) {

2820 
	`bŒfs_”r
(
fs_šfo
,

2822 
ã©u»s
);

2823 
”r
 = -
EINVAL
;

2824 
çž_®loc
;

2827 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

2828 
ã©u»s
 |ð
BTRFS_FEATURE_INCOMPAT_MIXED_BACKREF
;

2829 ià(
fs_šfo
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_LZO
)

2830 
ã©u»s
 |ð
BTRFS_FEATURE_INCOMPAT_COMPRESS_LZO
;

2831 ià(
fs_šfo
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_ZSTD
)

2832 
ã©u»s
 |ð
BTRFS_FEATURE_INCOMPAT_COMPRESS_ZSTD
;

2834 ià(
ã©u»s
 & 
BTRFS_FEATURE_INCOMPAT_SKINNY_METADATA
)

2835 
	`bŒfs_šfo
(
fs_šfo
, "has skinnyƒxtents");

2841 ià(
	`bŒfs_su³r_nodesize
(
disk_su³r
è> 
PAGE_SIZE
) {

2842 ià(!(
ã©u»s
 & 
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
))

2843 
	`bŒfs_šfo
(
fs_šfo
,

2845 
ã©u»s
 |ð
BTRFS_FEATURE_INCOMPAT_BIG_METADATA
;

2848 
nodesize
 = 
	`bŒfs_su³r_nodesize
(
disk_su³r
);

2849 
£ùÜsize
 = 
	`bŒfs_su³r_£ùÜsize
(
disk_su³r
);

2850 
¡resize
 = 
£ùÜsize
;

2851 
fs_šfo
->
dœty_m‘ad©a_b©ch
 = 
nodesize
 * (1 + 
	`žog2
(
Ä_ýu_ids
));

2852 
fs_šfo
->
d–®loc_b©ch
 = 
£ùÜsize
 * 512 * (1 + 
	`žog2
(
Ä_ýu_ids
));

2855 
fs_šfo
->
nodesize
 =‚odesize;

2856 
fs_šfo
->
£ùÜsize
 = sectorsize;

2857 
fs_šfo
->
¡resize
 = stripesize;

2863 ià((
ã©u»s
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
) &&

2864 (
£ùÜsize
 !ð
nodesize
)) {

2865 
	`bŒfs_”r
(
fs_šfo
,

2867 
nodesize
, 
£ùÜsize
);

2868 
çž_®loc
;

2875 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

2877 
ã©u»s
 = 
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
) &

2878 ~
BTRFS_FEATURE_COMPAT_RO_SUPP
;

2879 ià(!
	`sb_rdÚly
(
sb
è&& 
ã©u»s
) {

2880 
	`bŒfs_”r
(
fs_šfo
,

2882 
ã©u»s
);

2883 
”r
 = -
EINVAL
;

2884 
çž_®loc
;

2887 
max_aùive
 = 
fs_šfo
->
th»ad_poÞ_size
;

2889 
»t
 = 
	`bŒfs_š™_wÜkqueues
(
fs_šfo
, 
fs_deviûs
);

2890 ià(
»t
) {

2891 
”r
 = 
»t
;

2892 
çž_sb_bufãr
;

2895 
sb
->
s_bdi
->
cÚge¡ed_â
 = 
bŒfs_cÚge¡ed_â
;

2896 
sb
->
s_bdi
->
cÚge¡ed_d©a
 = 
fs_šfo
;

2897 
sb
->
s_bdi
->
ÿ·bž™›s
 |ð
BDI_CAP_CGROUP_WRITEBACK
;

2898 
sb
->
s_bdi
->
¿_·ges
 = 
VM_MAX_READAHEAD
 * 1024 / 
PAGE_SIZE
;

2899 
sb
->
s_bdi
->
¿_·ges
 *ð
	`bŒfs_su³r_num_deviûs
(
disk_su³r
);

2900 
sb
->
s_bdi
->
¿_·ges
 = 
	`max
(sb->s_bdi->¿_·ges, 
SZ_4M
 / 
PAGE_SIZE
);

2902 
sb
->
s_blocksize
 = 
£ùÜsize
;

2903 
sb
->
s_blocksize_b™s
 = 
	`blksize_b™s
(
£ùÜsize
);

2905 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2906 
»t
 = 
	`bŒfs_»ad_sys_¬¿y
(
fs_šfo
);

2907 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2908 ià(
»t
) {

2909 
	`bŒfs_”r
(
fs_šfo
, "çžedØ»adhsy¡em‡¼ay: %d", 
»t
);

2910 
çž_sb_bufãr
;

2913 
g’”©iÚ
 = 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(
disk_su³r
);

2915 
	`__£tup_roÙ
(
chunk_roÙ
, 
fs_šfo
, 
BTRFS_CHUNK_TREE_OBJECTID
);

2917 
chunk_roÙ
->
node
 = 
	`»ad_Œ“_block
(
fs_šfo
,

2918 
	`bŒfs_su³r_chunk_roÙ
(
disk_su³r
),

2919 
g’”©iÚ
);

2920 ià(
	`IS_ERR
(
chunk_roÙ
->
node
) ||

2921 !
	`ex‹Á_bufãr_u±od©e
(
chunk_roÙ
->
node
)) {

2922 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead chunk„oot");

2923 ià(!
	`IS_ERR
(
chunk_roÙ
->
node
))

2924 
	`ä“_ex‹Á_bufãr
(
chunk_roÙ
->
node
);

2925 
chunk_roÙ
->
node
 = 
NULL
;

2926 
çž_Œ“_roÙs
;

2928 
	`bŒfs_£t_roÙ_node
(&
chunk_roÙ
->
roÙ_™em
, chunk_roÙ->
node
);

2929 
chunk_roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(chunk_root);

2931 
	`»ad_ex‹Á_bufãr
(
chunk_roÙ
->
node
, 
fs_šfo
->
chunk_Œ“_uuid
,

2932 
	`bŒfs_h—d”_chunk_Œ“_uuid
(
chunk_roÙ
->
node
), 
BTRFS_UUID_SIZE
);

2934 
»t
 = 
	`bŒfs_»ad_chunk_Œ“
(
fs_šfo
);

2935 ià(
»t
) {

2936 
	`bŒfs_”r
(
fs_šfo
, "çžedØ»ad chunk»e: %d", 
»t
);

2937 
çž_Œ“_roÙs
;

2944 
	`bŒfs_þo£_exŒa_deviûs
(
fs_deviûs
, 0);

2946 ià(!
fs_deviûs
->
Ï‹¡_bdev
) {

2947 
	`bŒfs_”r
(
fs_šfo
, "failedo„ead devices");

2948 
çž_Œ“_roÙs
;

2951 
»Œy_roÙ_backup
:

2952 
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

2954 
Œ“_roÙ
->
node
 = 
	`»ad_Œ“_block
(
fs_šfo
,

2955 
	`bŒfs_su³r_roÙ
(
disk_su³r
),

2956 
g’”©iÚ
);

2957 ià(
	`IS_ERR
(
Œ“_roÙ
->
node
) ||

2958 !
	`ex‹Á_bufãr_u±od©e
(
Œ“_roÙ
->
node
)) {

2959 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„eadree„oot");

2960 ià(!
	`IS_ERR
(
Œ“_roÙ
->
node
))

2961 
	`ä“_ex‹Á_bufãr
(
Œ“_roÙ
->
node
);

2962 
Œ“_roÙ
->
node
 = 
NULL
;

2963 
»cov”y_Œ“_roÙ
;

2966 
	`bŒfs_£t_roÙ_node
(&
Œ“_roÙ
->
roÙ_™em
,»e_roÙ->
node
);

2967 
Œ“_roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(tree_root);

2968 
	`bŒfs_£t_roÙ_»fs
(&
Œ“_roÙ
->
roÙ_™em
, 1);

2970 
	`mu‹x_lock
(&
Œ“_roÙ
->
objeùid_mu‹x
);

2971 
»t
 = 
	`bŒfs_fšd_highe¡_objeùid
(
Œ“_roÙ
,

2972 &
Œ“_roÙ
->
highe¡_objeùid
);

2973 ià(
»t
) {

2974 
	`mu‹x_uÆock
(&
Œ“_roÙ
->
objeùid_mu‹x
);

2975 
»cov”y_Œ“_roÙ
;

2978 
	`ASSERT
(
Œ“_roÙ
->
highe¡_objeùid
 <ð
BTRFS_LAST_FREE_OBJECTID
);

2980 
	`mu‹x_uÆock
(&
Œ“_roÙ
->
objeùid_mu‹x
);

2982 
»t
 = 
	`bŒfs_»ad_roÙs
(
fs_šfo
);

2983 ià(
»t
)

2984 
»cov”y_Œ“_roÙ
;

2986 
fs_šfo
->
g’”©iÚ
 = generation;

2987 
fs_šfo
->
Ï¡_Œªs_comm™‹d
 = 
g’”©iÚ
;

2989 
»t
 = 
	`bŒfs_»cov”_b®ªû
(
fs_šfo
);

2990 ià(
»t
) {

2991 
	`bŒfs_”r
(
fs_šfo
, "çžedØ»cov” b®ªû: %d", 
»t
);

2992 
çž_block_groups
;

2995 
»t
 = 
	`bŒfs_š™_dev_¡©s
(
fs_šfo
);

2996 ià(
»t
) {

2997 
	`bŒfs_”r
(
fs_šfo
, "çžedØš™ dev_¡©s: %d", 
»t
);

2998 
çž_block_groups
;

3001 
»t
 = 
	`bŒfs_š™_dev_»¶aû
(
fs_šfo
);

3002 ià(
»t
) {

3003 
	`bŒfs_”r
(
fs_šfo
, "çžedØš™ dev_»¶aû: %d", 
»t
);

3004 
çž_block_groups
;

3007 
	`bŒfs_þo£_exŒa_deviûs
(
fs_deviûs
, 1);

3009 
»t
 = 
	`bŒfs_sysfs_add_fsid
(
fs_deviûs
, 
NULL
);

3010 ià(
»t
) {

3011 
	`bŒfs_”r
(
fs_šfo
, "failedo init sysfs fsid interface: %d",

3012 
»t
);

3013 
çž_block_groups
;

3016 
»t
 = 
	`bŒfs_sysfs_add_deviû
(
fs_deviûs
);

3017 ià(
»t
) {

3018 
	`bŒfs_”r
(
fs_šfo
, "failedo init sysfs device interface: %d",

3019 
»t
);

3020 
çž_fsdev_sysfs
;

3023 
»t
 = 
	`bŒfs_sysfs_add_mouÁed
(
fs_šfo
);

3024 ià(
»t
) {

3025 
	`bŒfs_”r
(
fs_šfo
, "çžedØš™ sysf š‹rçû: %d", 
»t
);

3026 
çž_fsdev_sysfs
;

3029 
»t
 = 
	`bŒfs_š™_¥aû_šfo
(
fs_šfo
);

3030 ià(
»t
) {

3031 
	`bŒfs_”r
(
fs_šfo
, "çžedØš™Ÿliz¥aû info: %d", 
»t
);

3032 
çž_sysfs
;

3035 
»t
 = 
	`bŒfs_»ad_block_groups
(
fs_šfo
);

3036 ià(
»t
) {

3037 
	`bŒfs_”r
(
fs_šfo
, "çžedØ»ad block groups: %d", 
»t
);

3038 
çž_sysfs
;

3041 ià(!
	`sb_rdÚly
(
sb
è&& !
	`bŒfs_check_rw_deg¿dabË
(
fs_šfo
)) {

3042 
	`bŒfs_w¬n
(
fs_šfo
,

3044 
çž_sysfs
;

3047 
fs_šfo
->
þ—Ãr_kth»ad
 = 
	`kth»ad_run
(þ—Ãr_kth»ad, 
Œ“_roÙ
,

3049 ià(
	`IS_ERR
(
fs_šfo
->
þ—Ãr_kth»ad
))

3050 
çž_sysfs
;

3052 
fs_šfo
->
Œª§ùiÚ_kth»ad
 = 
	`kth»ad_run
(transaction_kthread,

3053 
Œ“_roÙ
,

3055 ià(
	`IS_ERR
(
fs_šfo
->
Œª§ùiÚ_kth»ad
))

3056 
çž_þ—Ãr
;

3058 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
NOSSD
) &&

3059 !
fs_šfo
->
fs_deviûs
->
rÙ©šg
) {

3060 
	`bŒfs_£t_ªd_šfo
(
fs_šfo
, 
SSD
, "enabling ssd optimizations");

3067 
	`bŒfs_­¶y_³ndšg_chªges
(
fs_šfo
);

3069 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


3070 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
CHECK_INTEGRITY
)) {

3071 
»t
 = 
	`bŒfsic_mouÁ
(
fs_šfo
, 
fs_deviûs
,

3072 
	`bŒfs_‹¡_Ýt
(
fs_šfo
,

3073 
CHECK_INTEGRITY_INCLUDING_EXTENT_DATA
) ?

3075 
fs_šfo
->
check_š‹gr™y_´št_mask
);

3076 ià(
»t
)

3077 
	`bŒfs_w¬n
(
fs_šfo
,

3079 
»t
);

3082 
»t
 = 
	`bŒfs_»ad_qgroup_cÚfig
(
fs_šfo
);

3083 ià(
»t
)

3084 
çž_Œªs_kth»ad
;

3087 ià(
	`bŒfs_su³r_log_roÙ
(
disk_su³r
) != 0 &&

3088 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
NOLOGREPLAY
)) {

3089 
»t
 = 
	`bŒfs_»¶ay_log
(
fs_šfo
, 
fs_deviûs
);

3090 ià(
»t
) {

3091 
”r
 = 
»t
;

3092 
çž_qgroup
;

3096 
»t
 = 
	`bŒfs_fšd_Üphª_roÙs
(
fs_šfo
);

3097 ià(
»t
)

3098 
çž_qgroup
;

3100 ià(!
	`sb_rdÚly
(
sb
)) {

3101 
»t
 = 
	`bŒfs_þ—nup_fs_roÙs
(
fs_šfo
);

3102 ià(
»t
)

3103 
çž_qgroup
;

3105 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

3106 
»t
 = 
	`bŒfs_»cov”_»loÿtiÚ
(
Œ“_roÙ
);

3107 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

3108 ià(
»t
 < 0) {

3109 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„ecover„elocation: %d",

3110 
»t
);

3111 
”r
 = -
EINVAL
;

3112 
çž_qgroup
;

3116 
loÿtiÚ
.
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

3117 
loÿtiÚ
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

3118 
loÿtiÚ
.
off£t
 = 0;

3120 
fs_šfo
->
fs_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(fs_šfo, &
loÿtiÚ
);

3121 ià(
	`IS_ERR
(
fs_šfo
->
fs_roÙ
)) {

3122 
”r
 = 
	`PTR_ERR
(
fs_šfo
->
fs_roÙ
);

3123 
çž_qgroup
;

3126 ià(
	`sb_rdÚly
(
sb
))

3129 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
CLEAR_CACHE
) &&

3130 
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

3131 
þ—r_ä“_¥aû_Œ“
 = 1;

3132 } ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

3133 !
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
)) {

3134 
	`bŒfs_w¬n
(
fs_šfo
, "free spaceree is invalid");

3135 
þ—r_ä“_¥aû_Œ“
 = 1;

3138 ià(
þ—r_ä“_¥aû_Œ“
) {

3139 
	`bŒfs_šfo
(
fs_šfo
, "clearing free spaceree");

3140 
»t
 = 
	`bŒfs_þ—r_ä“_¥aû_Œ“
(
fs_šfo
);

3141 ià(
»t
) {

3142 
	`bŒfs_w¬n
(
fs_šfo
,

3143 "çžedØþ—¸ä“ s·û»e: %d", 
»t
);

3144 
	`þo£_ù»e
(
fs_šfo
);

3145  
»t
;

3149 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FREE_SPACE_TREE
) &&

3150 !
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
)) {

3151 
	`bŒfs_šfo
(
fs_šfo
, "creating free spaceree");

3152 
»t
 = 
	`bŒfs_ü—‹_ä“_¥aû_Œ“
(
fs_šfo
);

3153 ià(
»t
) {

3154 
	`bŒfs_w¬n
(
fs_šfo
,

3155 "çžedØü—‹ f»¥aû»e: %d", 
»t
);

3156 
	`þo£_ù»e
(
fs_šfo
);

3157  
»t
;

3161 
	`down_»ad
(&
fs_šfo
->
þ—nup_wÜk_£m
);

3162 ià((
»t
 = 
	`bŒfs_Üphª_þ—nup
(
fs_šfo
->
fs_roÙ
)) ||

3163 (
»t
 = 
	`bŒfs_Üphª_þ—nup
(
fs_šfo
->
Œ“_roÙ
))) {

3164 
	`up_»ad
(&
fs_šfo
->
þ—nup_wÜk_£m
);

3165 
	`þo£_ù»e
(
fs_šfo
);

3166  
»t
;

3168 
	`up_»ad
(&
fs_šfo
->
þ—nup_wÜk_£m
);

3170 
»t
 = 
	`bŒfs_»sume_b®ªû_async
(
fs_šfo
);

3171 ià(
»t
) {

3172 
	`bŒfs_w¬n
(
fs_šfo
, "çžedØ»sumb®ªû: %d", 
»t
);

3173 
	`þo£_ù»e
(
fs_šfo
);

3174  
»t
;

3177 
»t
 = 
	`bŒfs_»sume_dev_»¶aû_async
(
fs_šfo
);

3178 ià(
»t
) {

3179 
	`bŒfs_w¬n
(
fs_šfo
, "çžedØ»sumdeviû„•Ïû: %d", 
»t
);

3180 
	`þo£_ù»e
(
fs_šfo
);

3181  
»t
;

3184 
	`bŒfs_qgroup_»sÿn_»sume
(
fs_šfo
);

3186 ià(!
fs_šfo
->
uuid_roÙ
) {

3187 
	`bŒfs_šfo
(
fs_šfo
, "creating UUIDree");

3188 
»t
 = 
	`bŒfs_ü—‹_uuid_Œ“
(
fs_šfo
);

3189 ià(
»t
) {

3190 
	`bŒfs_w¬n
(
fs_šfo
,

3191 "çžedØü—‹hUUID»e: %d", 
»t
);

3192 
	`þo£_ù»e
(
fs_šfo
);

3193  
»t
;

3195 } ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
RESCAN_UUID_TREE
) ||

3196 
fs_šfo
->
g’”©iÚ
 !=

3197 
	`bŒfs_su³r_uuid_Œ“_g’”©iÚ
(
disk_su³r
)) {

3198 
	`bŒfs_šfo
(
fs_šfo
, "checking UUIDree");

3199 
»t
 = 
	`bŒfs_check_uuid_Œ“
(
fs_šfo
);

3200 ià(
»t
) {

3201 
	`bŒfs_w¬n
(
fs_šfo
,

3202 "çžedØcheckhUUID»e: %d", 
»t
);

3203 
	`þo£_ù»e
(
fs_šfo
);

3204  
»t
;

3207 
	`£t_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
);

3209 
	`£t_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

3215 
	`bŒfs_þ—r_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
USEBACKUPROOT
);

3219 
çž_qgroup
:

3220 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

3221 
çž_Œªs_kth»ad
:

3222 
	`kth»ad_¡Ý
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

3223 
	`bŒfs_þ—nup_Œª§ùiÚ
(
fs_šfo
);

3224 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

3225 
çž_þ—Ãr
:

3226 
	`kth»ad_¡Ý
(
fs_šfo
->
þ—Ãr_kth»ad
);

3232 
	`fžem­_wr™e_ªd_wa™
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

3234 
çž_sysfs
:

3235 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

3237 
çž_fsdev_sysfs
:

3238 
	`bŒfs_sysfs_»move_fsid
(
fs_šfo
->
fs_deviûs
);

3240 
çž_block_groups
:

3241 
	`bŒfs_put_block_group_ÿche
(
fs_šfo
);

3243 
çž_Œ“_roÙs
:

3244 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 1);

3245 
	`šv®id©e_šode_·ges2
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

3247 
çž_sb_bufãr
:

3248 
	`bŒfs_¡Ý_®l_wÜk”s
(
fs_šfo
);

3249 
	`bŒfs_ä“_block_groups
(
fs_šfo
);

3250 
çž_®loc
:

3251 
çž_ut
:

3252 
	`bŒfs_m­pšg_Œ“_ä“
(&
fs_šfo
->
m­pšg_Œ“
);

3254 
	`ut
(
fs_šfo
->
bŒ“_šode
);

3255 
çž_bio_couÁ”
:

3256 
	`³rýu_couÁ”_de¡roy
(&
fs_šfo
->
bio_couÁ”
);

3257 
çž_d–®loc_by‹s
:

3258 
	`³rýu_couÁ”_de¡roy
(&
fs_šfo
->
d–®loc_by‹s
);

3259 
çž_dœty_m‘ad©a_by‹s
:

3260 
	`³rýu_couÁ”_de¡roy
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
);

3261 
çž_¤cu
:

3262 
	`þ—nup_¤cu_¡ruù
(&
fs_šfo
->
subvÞ_¤cu
);

3263 
çž
:

3264 
	`bŒfs_ä“_¡re_hash_bË
(
fs_šfo
);

3265 
	`bŒfs_þo£_deviûs
(
fs_šfo
->
fs_deviûs
);

3266  
”r
;

3268 
»cov”y_Œ“_roÙ
:

3269 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
USEBACKUPROOT
))

3270 
çž_Œ“_roÙs
;

3272 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 0);

3275 
	`bŒfs_£t_su³r_log_roÙ
(
disk_su³r
, 0);

3278 
	`bŒfs_£t_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
CLEAR_CACHE
);

3280 
»t
 = 
	`Ãxt_roÙ_backup
(
fs_šfo
, fs_šfo->
su³r_cÝy
,

3281 &
num_backups_Œ›d
, &
backup_šdex
);

3282 ià(
»t
 == -1)

3283 
çž_block_groups
;

3284 
»Œy_roÙ_backup
;

3285 
	}
}

3287 
	$bŒfs_’d_bufãr_wr™e_sync
(
bufãr_h—d
 *
bh
, 
u±od©e
)

3289 ià(
u±od©e
) {

3290 
	`£t_bufãr_u±od©e
(
bh
);

3292 
bŒfs_deviû
 *
deviû
 = (btrfs_device *)

3293 
bh
->
b_´iv©e
;

3295 
	`bŒfs_w¬n_¾_š_rcu
(
deviû
->
fs_šfo
,

3297 
	`rcu_¡r_d”ef
(
deviû
->
Çme
));

3301 
	`þ—r_bufãr_u±od©e
(
bh
);

3302 
	`bŒfs_dev_¡©_šc_ªd_´št
(
deviû
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

3304 
	`uÆock_bufãr
(
bh
);

3305 
	`put_bh
(
bh
);

3306 
	}
}

3308 
	$bŒfs_»ad_dev_Úe_su³r
(
block_deviû
 *
bdev
, 
cÝy_num
,

3309 
bufãr_h—d
 **
bh_»t
)

3311 
bufãr_h—d
 *
bh
;

3312 
bŒfs_su³r_block
 *
su³r
;

3313 
u64
 
by‹Ä
;

3315 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
cÝy_num
);

3316 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >ð
	`i_size_»ad
(
bdev
->
bd_šode
))

3317  -
EINVAL
;

3319 
bh
 = 
	`__b»ad
(
bdev
, 
by‹Ä
 / 
BTRFS_BDEV_BLOCKSIZE
, 
BTRFS_SUPER_INFO_SIZE
);

3324 ià(!
bh
)

3325  -
EIO
;

3327 
su³r
 = (
bŒfs_su³r_block
 *)
bh
->
b_d©a
;

3328 ià(
	`bŒfs_su³r_by‹Ä
(
su³r
è!ð
by‹Ä
 ||

3329 
	`bŒfs_su³r_magic
(
su³r
è!ð
BTRFS_MAGIC
) {

3330 
	`b»l£
(
bh
);

3331  -
EINVAL
;

3334 *
bh_»t
 = 
bh
;

3336 
	}
}

3339 
bufãr_h—d
 *
	$bŒfs_»ad_dev_su³r
(
block_deviû
 *
bdev
)

3341 
bufãr_h—d
 *
bh
;

3342 
bufãr_h—d
 *
Ï‹¡
 = 
NULL
;

3343 
bŒfs_su³r_block
 *
su³r
;

3344 
i
;

3345 
u64
 
Œªsid
 = 0;

3346 
»t
 = -
EINVAL
;

3353 
i
 = 0; i < 1; i++) {

3354 
»t
 = 
	`bŒfs_»ad_dev_Úe_su³r
(
bdev
, 
i
, &
bh
);

3355 ià(
»t
)

3358 
su³r
 = (
bŒfs_su³r_block
 *)
bh
->
b_d©a
;

3360 ià(!
Ï‹¡
 || 
	`bŒfs_su³r_g’”©iÚ
(
su³r
è> 
Œªsid
) {

3361 
	`b»l£
(
Ï‹¡
);

3362 
Ï‹¡
 = 
bh
;

3363 
Œªsid
 = 
	`bŒfs_su³r_g’”©iÚ
(
su³r
);

3365 
	`b»l£
(
bh
);

3369 ià(!
Ï‹¡
)

3370  
	`ERR_PTR
(
»t
);

3372  
Ï‹¡
;

3373 
	}
}

3385 
	$wr™e_dev_su³rs
(
bŒfs_deviû
 *
deviû
,

3386 
bŒfs_su³r_block
 *
sb
, 
max_mœrÜs
)

3388 
bufãr_h—d
 *
bh
;

3389 
i
;

3390 
»t
;

3391 
”rÜs
 = 0;

3392 
u32
 
üc
;

3393 
u64
 
by‹Ä
;

3395 ià(
max_mœrÜs
 == 0)

3396 
max_mœrÜs
 = 
BTRFS_SUPER_MIRROR_MAX
;

3398 
i
 = 0; i < 
max_mœrÜs
; i++) {

3399 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
i
);

3400 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >=

3401 
deviû
->
comm™_tÙ®_by‹s
)

3404 
	`bŒfs_£t_su³r_by‹Ä
(
sb
, 
by‹Ä
);

3406 
üc
 = ~(
u32
)0;

3407 
üc
 = 
	`bŒfs_csum_d©a
((cÚ¡ *)
sb
 + 
BTRFS_CSUM_SIZE
, crc,

3408 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
);

3409 
	`bŒfs_csum_fš®
(
üc
, 
sb
->
csum
);

3412 
bh
 = 
	`__g‘blk
(
deviû
->
bdev
, 
by‹Ä
 / 
BTRFS_BDEV_BLOCKSIZE
,

3413 
BTRFS_SUPER_INFO_SIZE
);

3414 ià(!
bh
) {

3415 
	`bŒfs_”r
(
deviû
->
fs_šfo
,

3417 
by‹Ä
);

3418 
”rÜs
++;

3422 
	`memýy
(
bh
->
b_d©a
, 
sb
, 
BTRFS_SUPER_INFO_SIZE
);

3425 
	`g‘_bh
(
bh
);

3427 
	`£t_bufãr_u±od©e
(
bh
);

3428 
	`lock_bufãr
(
bh
);

3429 
bh
->
b_’d_io
 = 
bŒfs_’d_bufãr_wr™e_sync
;

3430 
bh
->
b_´iv©e
 = 
deviû
;

3436 ià(
i
 == 0) {

3437 
»t
 = 
	`bŒfsic_subm™_bh
(
REQ_OP_WRITE
,

3438 
REQ_SYNC
 | 
REQ_FUA
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

3440 
»t
 = 
	`bŒfsic_subm™_bh
(
REQ_OP_WRITE
,

3441 
REQ_SYNC
 | 
REQ_META
 | 
REQ_PRIO
, 
bh
);

3443 ià(
»t
)

3444 
”rÜs
++;

3446  
”rÜs
 < 
i
 ? 0 : -1;

3447 
	}
}

3456 
	$wa™_dev_su³rs
(
bŒfs_deviû
 *
deviû
, 
max_mœrÜs
)

3458 
bufãr_h—d
 *
bh
;

3459 
i
;

3460 
”rÜs
 = 0;

3461 
u64
 
by‹Ä
;

3463 ià(
max_mœrÜs
 == 0)

3464 
max_mœrÜs
 = 
BTRFS_SUPER_MIRROR_MAX
;

3466 
i
 = 0; i < 
max_mœrÜs
; i++) {

3467 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
i
);

3468 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >=

3469 
deviû
->
comm™_tÙ®_by‹s
)

3472 
bh
 = 
	`__fšd_g‘_block
(
deviû
->
bdev
,

3473 
by‹Ä
 / 
BTRFS_BDEV_BLOCKSIZE
,

3474 
BTRFS_SUPER_INFO_SIZE
);

3475 ià(!
bh
) {

3476 
”rÜs
++;

3479 
	`wa™_Ú_bufãr
(
bh
);

3480 ià(!
	`bufãr_u±od©e
(
bh
))

3481 
”rÜs
++;

3484 
	`b»l£
(
bh
);

3487 
	`b»l£
(
bh
);

3490  
”rÜs
 < 
i
 ? 0 : -1;

3491 
	}
}

3497 
	$bŒfs_’d_em±y_b¬r›r
(
bio
 *bio)

3499 
	`com¶‘e
(
bio
->
bi_´iv©e
);

3500 
	}
}

3506 
	$wr™e_dev_æush
(
bŒfs_deviû
 *
deviû
)

3508 
»que¡_queue
 *
q
 = 
	`bdev_g‘_queue
(
deviû
->
bdev
);

3509 
bio
 *biØð
deviû
->
æush_bio
;

3511 ià(!
	`‹¡_b™
(
QUEUE_FLAG_WC
, &
q
->
queue_æags
))

3514 
	`bio_»£t
(
bio
);

3515 
bio
->
bi_’d_io
 = 
bŒfs_’d_em±y_b¬r›r
;

3516 
	`bio_£t_dev
(
bio
, 
deviû
->
bdev
);

3517 
bio
->
bi_Ýf
 = 
REQ_OP_WRITE
 | 
REQ_SYNC
 | 
REQ_PREFLUSH
;

3518 
	`š™_com¶‘iÚ
(&
deviû
->
æush_wa™
);

3519 
bio
->
bi_´iv©e
 = &
deviû
->
æush_wa™
;

3521 
	`bŒfsic_subm™_bio
(
bio
);

3522 
deviû
->
æush_bio_£Á
 = 1;

3523 
	}
}

3528 
blk_¡©us_t
 
	$wa™_dev_æush
(
bŒfs_deviû
 *
deviû
)

3530 
bio
 *biØð
deviû
->
æush_bio
;

3532 ià(!
deviû
->
æush_bio_£Á
)

3533  
BLK_STS_OK
;

3535 
deviû
->
æush_bio_£Á
 = 0;

3536 
	`wa™_fÜ_com¶‘iÚ_io
(&
deviû
->
æush_wa™
);

3538  
bio
->
bi_¡©us
;

3539 
	}
}

3541 
	$check_b¬r›r_”rÜ
(
bŒfs_fs_šfo
 *
fs_šfo
)

3543 ià(!
	`bŒfs_check_rw_deg¿dabË
(
fs_šfo
))

3544  -
EIO
;

3546 
	}
}

3552 
	$b¬r›r_®l_deviûs
(
bŒfs_fs_šfo
 *
šfo
)

3554 
li¡_h—d
 *
h—d
;

3555 
bŒfs_deviû
 *
dev
;

3556 
”rÜs_wa™
 = 0;

3557 
blk_¡©us_t
 
»t
;

3560 
h—d
 = &
šfo
->
fs_deviûs
->
deviûs
;

3561 
	`li¡_fÜ_—ch_’Œy_rcu
(
dev
, 
h—d
, 
dev_li¡
) {

3562 ià(
dev
->
missšg
)

3564 ià(!
dev
->
bdev
)

3566 ià(!
dev
->
š_fs_m‘ad©a
 || !dev->
wr™—bË
)

3569 
	`wr™e_dev_æush
(
dev
);

3570 
dev
->
Ï¡_æush_”rÜ
 = 
BLK_STS_OK
;

3574 
	`li¡_fÜ_—ch_’Œy_rcu
(
dev
, 
h—d
, 
dev_li¡
) {

3575 ià(
dev
->
missšg
)

3577 ià(!
dev
->
bdev
) {

3578 
”rÜs_wa™
++;

3581 ià(!
dev
->
š_fs_m‘ad©a
 || !dev->
wr™—bË
)

3584 
»t
 = 
	`wa™_dev_æush
(
dev
);

3585 ià(
»t
) {

3586 
dev
->
Ï¡_æush_”rÜ
 = 
»t
;

3587 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
,

3588 
BTRFS_DEV_STAT_FLUSH_ERRS
);

3589 
”rÜs_wa™
++;

3593 ià(
”rÜs_wa™
) {

3599  
	`check_b¬r›r_”rÜ
(
šfo
);

3602 
	}
}

3604 
	$bŒfs_g‘_num_tÞ”©ed_disk_b¬r›r_çžu»s
(
u64
 
æags
)

3606 
¿id_ty³
;

3607 
mš_tÞ”©ed
 = 
INT_MAX
;

3609 ià((
æags
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0 ||

3610 (
æags
 & 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
))

3611 
mš_tÞ”©ed
 = 
	`mš
(min_tolerated,

3612 
bŒfs_¿id_¬¿y
[
BTRFS_RAID_SINGLE
].

3613 
tÞ”©ed_çžu»s
);

3615 
¿id_ty³
 = 0;„aid_ty³ < 
BTRFS_NR_RAID_TYPES
;„aid_type++) {

3616 ià(
¿id_ty³
 =ð
BTRFS_RAID_SINGLE
)

3618 ià(!(
æags
 & 
bŒfs_¿id_group
[
¿id_ty³
]))

3620 
mš_tÞ”©ed
 = 
	`mš
(min_tolerated,

3621 
bŒfs_¿id_¬¿y
[
¿id_ty³
].

3622 
tÞ”©ed_çžu»s
);

3625 ià(
mš_tÞ”©ed
 =ð
INT_MAX
) {

3626 
	`´_w¬n
("BTRFS: unknowÀ¿id fÏg: %Îu", 
æags
);

3627 
mš_tÞ”©ed
 = 0;

3630  
mš_tÞ”©ed
;

3631 
	}
}

3633 
	$wr™e_®l_su³rs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
max_mœrÜs
)

3635 
li¡_h—d
 *
h—d
;

3636 
bŒfs_deviû
 *
dev
;

3637 
bŒfs_su³r_block
 *
sb
;

3638 
bŒfs_dev_™em
 *
dev_™em
;

3639 
»t
;

3640 
do_b¬r›rs
;

3641 
max_”rÜs
;

3642 
tÙ®_”rÜs
 = 0;

3643 
u64
 
æags
;

3645 
do_b¬r›rs
 = !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
NOBARRIER
);

3652 ià(
max_mœrÜs
 == 0)

3653 
	`backup_su³r_roÙs
(
fs_šfo
);

3655 
sb
 = 
fs_šfo
->
su³r_fÜ_comm™
;

3656 
dev_™em
 = &
sb
->dev_item;

3658 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3659 
h—d
 = &
fs_šfo
->
fs_deviûs
->
deviûs
;

3660 
max_”rÜs
 = 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cÝy
) - 1;

3662 ià(
do_b¬r›rs
) {

3663 
»t
 = 
	`b¬r›r_®l_deviûs
(
fs_šfo
);

3664 ià(
»t
) {

3665 
	`mu‹x_uÆock
(

3666 &
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3667 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

3669  
»t
;

3673 
	`li¡_fÜ_—ch_’Œy_rcu
(
dev
, 
h—d
, 
dev_li¡
) {

3674 ià(!
dev
->
bdev
) {

3675 
tÙ®_”rÜs
++;

3678 ià(!
dev
->
š_fs_m‘ad©a
 || !dev->
wr™—bË
)

3681 
	`bŒfs_£t_¡ack_deviû_g’”©iÚ
(
dev_™em
, 0);

3682 
	`bŒfs_£t_¡ack_deviû_ty³
(
dev_™em
, 
dev
->
ty³
);

3683 
	`bŒfs_£t_¡ack_deviû_id
(
dev_™em
, 
dev
->
devid
);

3684 
	`bŒfs_£t_¡ack_deviû_tÙ®_by‹s
(
dev_™em
,

3685 
dev
->
comm™_tÙ®_by‹s
);

3686 
	`bŒfs_£t_¡ack_deviû_by‹s_u£d
(
dev_™em
,

3687 
dev
->
comm™_by‹s_u£d
);

3688 
	`bŒfs_£t_¡ack_deviû_io_®ign
(
dev_™em
, 
dev
->
io_®ign
);

3689 
	`bŒfs_£t_¡ack_deviû_io_width
(
dev_™em
, 
dev
->
io_width
);

3690 
	`bŒfs_£t_¡ack_deviû_£ùÜ_size
(
dev_™em
, 
dev
->
£ùÜ_size
);

3691 
	`memýy
(
dev_™em
->
uuid
, 
dev
->uuid, 
BTRFS_UUID_SIZE
);

3692 
	`memýy
(
dev_™em
->
fsid
, 
dev
->
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
);

3694 
æags
 = 
	`bŒfs_su³r_æags
(
sb
);

3695 
	`bŒfs_£t_su³r_æags
(
sb
, 
æags
 | 
BTRFS_HEADER_FLAG_WRITTEN
);

3697 
»t
 = 
	`wr™e_dev_su³rs
(
dev
, 
sb
, 
max_mœrÜs
);

3698 ià(
»t
)

3699 
tÙ®_”rÜs
++;

3701 ià(
tÙ®_”rÜs
 > 
max_”rÜs
) {

3702 
	`bŒfs_”r
(
fs_šfo
, "%dƒrrors while writing supers",

3703 
tÙ®_”rÜs
);

3704 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3707 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
EIO
,

3709 
tÙ®_”rÜs
);

3710  -
EIO
;

3713 
tÙ®_”rÜs
 = 0;

3714 
	`li¡_fÜ_—ch_’Œy_rcu
(
dev
, 
h—d
, 
dev_li¡
) {

3715 ià(!
dev
->
bdev
)

3717 ià(!
dev
->
š_fs_m‘ad©a
 || !dev->
wr™—bË
)

3720 
»t
 = 
	`wa™_dev_su³rs
(
dev
, 
max_mœrÜs
);

3721 ià(
»t
)

3722 
tÙ®_”rÜs
++;

3724 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

3725 ià(
tÙ®_”rÜs
 > 
max_”rÜs
) {

3726 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
EIO
,

3728 
tÙ®_”rÜs
);

3729  -
EIO
;

3732 
	}
}

3735 
	$bŒfs_drÝ_ªd_ä“_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

3736 
bŒfs_roÙ
 *
roÙ
)

3738 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3739 
	`¿dix_Œ“_d–‘e
(&
fs_šfo
->
fs_roÙs_¿dix
,

3740 ()
roÙ
->
roÙ_key
.
objeùid
);

3741 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

3743 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

3744 
	`synchrÚize_¤cu
(&
fs_šfo
->
subvÞ_¤cu
);

3746 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

3747 
	`bŒfs_ä“_log
(
NULL
, 
roÙ
);

3748 ià(
roÙ
->
»loc_roÙ
) {

3749 
	`ä“_ex‹Á_bufãr
(
roÙ
->
»loc_roÙ
->
node
);

3750 
	`ä“_ex‹Á_bufãr
(
roÙ
->
»loc_roÙ
->
comm™_roÙ
);

3751 
	`bŒfs_put_fs_roÙ
(
roÙ
->
»loc_roÙ
);

3752 
roÙ
->
»loc_roÙ
 = 
NULL
;

3756 ià(
roÙ
->
ä“_šo_pšÃd
)

3757 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
roÙ
->
ä“_šo_pšÃd
);

3758 ià(
roÙ
->
ä“_šo_ùl
)

3759 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
roÙ
->
ä“_šo_ùl
);

3760 
	`ä“_fs_roÙ
(
roÙ
);

3761 
	}
}

3763 
	$ä“_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
)

3765 
	`ut
(
roÙ
->
šo_ÿche_šode
);

3766 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
roÙ
->
šode_Œ“
));

3767 
	`bŒfs_ä“_block_rsv
(
roÙ
->
fs_šfo
,„oÙ->
Üphª_block_rsv
);

3768 
roÙ
->
Üphª_block_rsv
 = 
NULL
;

3769 ià(
roÙ
->
ªÚ_dev
)

3770 
	`ä“_ªÚ_bdev
(
roÙ
->
ªÚ_dev
);

3771 ià(
roÙ
->
subv_wr™”s
)

3772 
	`bŒfs_ä“_subvÞume_wr™”s
(
roÙ
->
subv_wr™”s
);

3773 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

3774 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

3775 
	`kä“
(
roÙ
->
ä“_šo_ùl
);

3776 
	`kä“
(
roÙ
->
ä“_šo_pšÃd
);

3777 
	`kä“
(
roÙ
->
Çme
);

3778 
	`bŒfs_put_fs_roÙ
(
roÙ
);

3779 
	}
}

3781 
	$bŒfs_ä“_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
)

3783 
	`ä“_fs_roÙ
(
roÙ
);

3784 
	}
}

3786 
	$bŒfs_þ—nup_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

3788 
u64
 
roÙ_objeùid
 = 0;

3789 
bŒfs_roÙ
 *
gªg
[8];

3790 
i
 = 0;

3791 
”r
 = 0;

3792 
»t
 = 0;

3793 
šdex
;

3796 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

3797 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
fs_roÙs_¿dix
,

3798 (**)
gªg
, 
roÙ_objeùid
,

3799 
	`ARRAY_SIZE
(
gªg
));

3800 ià(!
»t
) {

3801 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

3804 
roÙ_objeùid
 = 
gªg
[
»t
 - 1]->
roÙ_key
.
objeùid
 + 1;

3806 
i
 = 0; i < 
»t
; i++) {

3808 ià(
	`bŒfs_roÙ_»fs
(&
gªg
[
i
]->
roÙ_™em
) == 0) {

3809 
gªg
[
i
] = 
NULL
;

3813 
gªg
[
i
] = 
	`bŒfs_g¿b_fs_roÙ
(gang[i]);

3815 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

3817 
i
 = 0; i < 
»t
; i++) {

3818 ià(!
gªg
[
i
])

3820 
roÙ_objeùid
 = 
gªg
[
i
]->
roÙ_key
.
objeùid
;

3821 
”r
 = 
	`bŒfs_Üphª_þ—nup
(
gªg
[
i
]);

3822 ià(
”r
)

3824 
	`bŒfs_put_fs_roÙ
(
gªg
[
i
]);

3826 
roÙ_objeùid
++;

3830 ; 
i
 < 
»t
; i++) {

3831 ià(
gªg
[
i
])

3832 
	`bŒfs_put_fs_roÙ
(
gªg
[
i
]);

3834  
”r
;

3835 
	}
}

3837 
	$bŒfs_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
)

3839 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3840 
bŒfs_Œªs_hªdË
 *
Œªs
;

3842 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

3843 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

3844 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

3845 
	`wake_up_´oûss
(
fs_šfo
->
þ—Ãr_kth»ad
);

3848 
	`down_wr™e
(&
fs_šfo
->
þ—nup_wÜk_£m
);

3849 
	`up_wr™e
(&
fs_šfo
->
þ—nup_wÜk_£m
);

3851 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3852 ià(
	`IS_ERR
(
Œªs
))

3853  
	`PTR_ERR
(
Œªs
);

3854  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3855 
	}
}

3857 
	$þo£_ù»e
(
bŒfs_fs_šfo
 *
fs_šfo
)

3859 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3860 
»t
;

3862 
	`£t_b™
(
BTRFS_FS_CLOSING_START
, &
fs_šfo
->
æags
);

3865 
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
çl£
);

3868 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

3870 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

3873 
	`bŒfs_·u£_b®ªû
(
fs_šfo
);

3875 
	`bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
fs_šfo
);

3877 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

3880 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

3881 (
	`©omic_»ad
(&
fs_šfo
->
deäag_ruÂšg
) == 0));

3884 
	`bŒfs_þ—nup_deäag_šodes
(
fs_šfo
);

3886 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
async_»þaim_wÜk
);

3888 ià(!
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

3894 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

3896 
»t
 = 
	`bŒfs_comm™_su³r
(
fs_šfo
);

3897 ià(
»t
)

3898 
	`bŒfs_”r
(
fs_šfo
, "comm™ su³¸»ˆ%d", 
»t
);

3901 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
))

3902 
	`bŒfs_”rÜ_comm™_su³r
(
fs_šfo
);

3904 
	`kth»ad_¡Ý
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

3905 
	`kth»ad_¡Ý
(
fs_šfo
->
þ—Ãr_kth»ad
);

3907 
	`£t_b™
(
BTRFS_FS_CLOSING_DONE
, &
fs_šfo
->
æags
);

3909 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

3911 ià(
	`³rýu_couÁ”_sum
(&
fs_šfo
->
d–®loc_by‹s
)) {

3912 
	`bŒfs_šfo
(
fs_šfo
, "at unmount delalloc count %lld",

3913 
	`³rýu_couÁ”_sum
(&
fs_šfo
->
d–®loc_by‹s
));

3916 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

3917 
	`bŒfs_sysfs_»move_fsid
(
fs_šfo
->
fs_deviûs
);

3919 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

3921 
	`bŒfs_put_block_group_ÿche
(
fs_šfo
);

3927 
	`šv®id©e_šode_·ges2
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

3928 
	`bŒfs_¡Ý_®l_wÜk”s
(
fs_šfo
);

3930 
	`bŒfs_ä“_block_groups
(
fs_šfo
);

3932 
	`þ—r_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

3933 
	`ä“_roÙ_poš‹rs
(
fs_šfo
, 1);

3935 
	`ut
(
fs_šfo
->
bŒ“_šode
);

3937 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


3938 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
CHECK_INTEGRITY
))

3939 
	`bŒfsic_unmouÁ
(
fs_šfo
->
fs_deviûs
);

3942 
	`bŒfs_þo£_deviûs
(
fs_šfo
->
fs_deviûs
);

3943 
	`bŒfs_m­pšg_Œ“_ä“
(&
fs_šfo
->
m­pšg_Œ“
);

3945 
	`³rýu_couÁ”_de¡roy
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
);

3946 
	`³rýu_couÁ”_de¡roy
(&
fs_šfo
->
d–®loc_by‹s
);

3947 
	`³rýu_couÁ”_de¡roy
(&
fs_šfo
->
bio_couÁ”
);

3948 
	`þ—nup_¤cu_¡ruù
(&
fs_šfo
->
subvÞ_¤cu
);

3950 
	`bŒfs_ä“_¡re_hash_bË
(
fs_šfo
);

3952 
	`__bŒfs_ä“_block_rsv
(
roÙ
->
Üphª_block_rsv
);

3953 
roÙ
->
Üphª_block_rsv
 = 
NULL
;

3955 !
	`li¡_em±y
(&
fs_šfo
->
pšÃd_chunks
)) {

3956 
ex‹Á_m­
 *
em
;

3958 
em
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
pšÃd_chunks
,

3959 
ex‹Á_m­
, 
li¡
);

3960 
	`li¡_d–_š™
(&
em
->
li¡
);

3961 
	`ä“_ex‹Á_m­
(
em
);

3963 
	}
}

3965 
	$bŒfs_bufãr_u±od©e
(
ex‹Á_bufãr
 *
buf
, 
u64
 
·»Á_Œªsid
,

3966 
©omic
)

3968 
»t
;

3969 
šode
 *
bŒ“_šode
 = 
buf
->
·ges
[0]->
m­pšg
->
ho¡
;

3971 
»t
 = 
	`ex‹Á_bufãr_u±od©e
(
buf
);

3972 ià(!
»t
)

3973  
»t
;

3975 
»t
 = 
	`v”ify_·»Á_Œªsid
(&
	`BTRFS_I
(
bŒ“_šode
)->
io_Œ“
, 
buf
,

3976 
·»Á_Œªsid
, 
©omic
);

3977 ià(
»t
 =ð-
EAGAIN
)

3978  
»t
;

3979  !
»t
;

3980 
	}
}

3982 
	$bŒfs_m¬k_bufãr_dœty
(
ex‹Á_bufãr
 *
buf
)

3984 
bŒfs_fs_šfo
 *
fs_šfo
;

3985 
bŒfs_roÙ
 *
roÙ
;

3986 
u64
 
Œªsid
 = 
	`bŒfs_h—d”_g’”©iÚ
(
buf
);

3987 
was_dœty
;

3989 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3995 ià(
	`uÆik–y
(
	`‹¡_b™
(
EXTENT_BUFFER_DUMMY
, &
buf
->
bæags
)))

3998 
roÙ
 = 
	`BTRFS_I
(
buf
->
·ges
[0]->
m­pšg
->
ho¡
)->root;

3999 
fs_šfo
 = 
roÙ
->fs_info;

4000 
	`bŒfs_as£¹_Œ“_locked
(
buf
);

4001 ià(
Œªsid
 !ð
fs_šfo
->
g’”©iÚ
)

4002 
	`WARN
(1, 
KERN_CRIT
 "btrfsransid mismatch buffer %llu, found %llu„unning %llu\n",

4003 
buf
->
¡¬t
, 
Œªsid
, 
fs_šfo
->
g’”©iÚ
);

4004 
was_dœty
 = 
	`£t_ex‹Á_bufãr_dœty
(
buf
);

4005 ià(!
was_dœty
)

4006 
	`³rýu_couÁ”_add_b©ch
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

4007 
buf
->
Ën
,

4008 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

4009 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


4010 ià(
	`bŒfs_h—d”_Ëv–
(
buf
è=ð0 && 
	`check_Ëaf
(
roÙ
, buf)) {

4011 
	`bŒfs_´št_Ëaf
(
buf
);

4012 
	`ASSERT
(0);

4015 
	}
}

4017 
	$__bŒfs_bŒ“_b®ªû_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
,

4018 
æush_d–ayed
)

4024 
»t
;

4026 ià(
cu¼’t
->
æags
 & 
PF_MEMALLOC
)

4029 ià(
æush_d–ayed
)

4030 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

4032 
»t
 = 
	`³rýu_couÁ”_com·»
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

4033 
BTRFS_DIRTY_METADATA_THRESH
);

4034 ià(
»t
 > 0) {

4035 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

4037 
	}
}

4039 
	$bŒfs_bŒ“_b®ªû_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
)

4041 
	`__bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
, 1);

4042 
	}
}

4044 
	$bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
bŒfs_fs_šfo
 *
fs_šfo
)

4046 
	`__bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
, 0);

4047 
	}
}

4049 
	$bŒfs_»ad_bufãr
(
ex‹Á_bufãr
 *
buf
, 
u64
 
·»Á_Œªsid
)

4051 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
buf
->
·ges
[0]->
m­pšg
->
ho¡
)->root;

4052 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4054  
	`bŒ“_»ad_ex‹Á_bufãr_·ges
(
fs_šfo
, 
buf
, 
·»Á_Œªsid
);

4055 
	}
}

4057 
	$bŒfs_check_su³r_v®id
(
bŒfs_fs_šfo
 *
fs_šfo
)

4059 
bŒfs_su³r_block
 *
sb
 = 
fs_šfo
->
su³r_cÝy
;

4060 
u64
 
nodesize
 = 
	`bŒfs_su³r_nodesize
(
sb
);

4061 
u64
 
£ùÜsize
 = 
	`bŒfs_su³r_£ùÜsize
(
sb
);

4062 
»t
 = 0;

4064 ià(
	`bŒfs_su³r_magic
(
sb
è!ð
BTRFS_MAGIC
) {

4065 
	`bŒfs_”r
(
fs_šfo
, "no valid FS found");

4066 
»t
 = -
EINVAL
;

4068 ià(
	`bŒfs_su³r_æags
(
sb
è& ~
BTRFS_SUPER_FLAG_SUPP
)

4069 
	`bŒfs_w¬n
(
fs_šfo
, "unrecognized super flag: %llu",

4070 
	`bŒfs_su³r_æags
(
sb
è& ~
BTRFS_SUPER_FLAG_SUPP
);

4071 ià(
	`bŒfs_su³r_roÙ_Ëv–
(
sb
è>ð
BTRFS_MAX_LEVEL
) {

4072 
	`bŒfs_”r
(
fs_šfo
, "tree_root†eveloo big: %d >= %d",

4073 
	`bŒfs_su³r_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

4074 
»t
 = -
EINVAL
;

4076 ià(
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
sb
è>ð
BTRFS_MAX_LEVEL
) {

4077 
	`bŒfs_”r
(
fs_šfo
, "chunk_root†eveloo big: %d >= %d",

4078 
	`bŒfs_su³r_chunk_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

4079 
»t
 = -
EINVAL
;

4081 ià(
	`bŒfs_su³r_log_roÙ_Ëv–
(
sb
è>ð
BTRFS_MAX_LEVEL
) {

4082 
	`bŒfs_”r
(
fs_šfo
, "log_root†eveloo big: %d >= %d",

4083 
	`bŒfs_su³r_log_roÙ_Ëv–
(
sb
), 
BTRFS_MAX_LEVEL
);

4084 
»t
 = -
EINVAL
;

4091 ià(!
	`is_pow”_of_2
(
£ùÜsize
) || sectorsize < 4096 ||

4092 
£ùÜsize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

4093 
	`bŒfs_”r
(
fs_šfo
, "šv®id seùÜsiz%Îu", 
£ùÜsize
);

4094 
»t
 = -
EINVAL
;

4097 ià(
£ùÜsize
 !ð
PAGE_SIZE
) {

4098 
	`bŒfs_”r
(
fs_šfo
,

4100 
£ùÜsize
, 
PAGE_SIZE
);

4101 
»t
 = -
EINVAL
;

4103 ià(!
	`is_pow”_of_2
(
nodesize
è||‚odesiz< 
£ùÜsize
 ||

4104 
nodesize
 > 
BTRFS_MAX_METADATA_BLOCKSIZE
) {

4105 
	`bŒfs_”r
(
fs_šfo
, "šv®id‚odesiz%Îu", 
nodesize
);

4106 
»t
 = -
EINVAL
;

4108 ià(
nodesize
 !ð
	`Ë32_to_ýu
(
sb
->
__unu£d_Ëafsize
)) {

4109 
	`bŒfs_”r
(
fs_šfo
, "invalid†eafsize %u, should be %llu",

4110 
	`Ë32_to_ýu
(
sb
->
__unu£d_Ëafsize
), 
nodesize
);

4111 
»t
 = -
EINVAL
;

4115 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_roÙ
(
sb
), 
£ùÜsize
)) {

4116 
	`bŒfs_w¬n
(
fs_šfo
, "tree_root block unaligned: %llu",

4117 
	`bŒfs_su³r_roÙ
(
sb
));

4118 
»t
 = -
EINVAL
;

4120 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_chunk_roÙ
(
sb
), 
£ùÜsize
)) {

4121 
	`bŒfs_w¬n
(
fs_šfo
, "chunk_root block unaligned: %llu",

4122 
	`bŒfs_su³r_chunk_roÙ
(
sb
));

4123 
»t
 = -
EINVAL
;

4125 ià(!
	`IS_ALIGNED
(
	`bŒfs_su³r_log_roÙ
(
sb
), 
£ùÜsize
)) {

4126 
	`bŒfs_w¬n
(
fs_šfo
, "log_root block unaligned: %llu",

4127 
	`bŒfs_su³r_log_roÙ
(
sb
));

4128 
»t
 = -
EINVAL
;

4131 ià(
	`memcmp
(
fs_šfo
->
fsid
, 
sb
->
dev_™em
.fsid, 
BTRFS_FSID_SIZE
) != 0) {

4132 
	`bŒfs_”r
(
fs_šfo
,

4134 
fs_šfo
->
fsid
, 
sb
->
dev_™em
.fsid);

4135 
»t
 = -
EINVAL
;

4142 ià(
	`bŒfs_su³r_by‹s_u£d
(
sb
è< 6 * 
	`bŒfs_su³r_nodesize
(sb)) {

4143 
	`bŒfs_”r
(
fs_šfo
, "bytes_used isoo small %llu",

4144 
	`bŒfs_su³r_by‹s_u£d
(
sb
));

4145 
»t
 = -
EINVAL
;

4147 ià(!
	`is_pow”_of_2
(
	`bŒfs_su³r_¡resize
(
sb
))) {

4148 
	`bŒfs_”r
(
fs_šfo
, "invalid stripesize %u",

4149 
	`bŒfs_su³r_¡resize
(
sb
));

4150 
»t
 = -
EINVAL
;

4152 ià(
	`bŒfs_su³r_num_deviûs
(
sb
) > (1UL << 31))

4153 
	`bŒfs_w¬n
(
fs_šfo
, "suspicious‚umber of devices: %llu",

4154 
	`bŒfs_su³r_num_deviûs
(
sb
));

4155 ià(
	`bŒfs_su³r_num_deviûs
(
sb
) == 0) {

4156 
	`bŒfs_”r
(
fs_šfo
, "number of devices is 0");

4157 
»t
 = -
EINVAL
;

4160 ià(
	`bŒfs_su³r_by‹Ä
(
sb
è!ð
BTRFS_SUPER_INFO_OFFSET
) {

4161 
	`bŒfs_”r
(
fs_šfo
, "super offset mismatch %llu != %u",

4162 
	`bŒfs_su³r_by‹Ä
(
sb
), 
BTRFS_SUPER_INFO_OFFSET
);

4163 
»t
 = -
EINVAL
;

4170 ià(
	`bŒfs_su³r_sys_¬¿y_size
(
sb
è> 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
) {

4171 
	`bŒfs_”r
(
fs_šfo
, "system chunk‡rrayoo big %u > %u",

4172 
	`bŒfs_su³r_sys_¬¿y_size
(
sb
),

4173 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
);

4174 
»t
 = -
EINVAL
;

4176 ià(
	`bŒfs_su³r_sys_¬¿y_size
(
sb
è< (
bŒfs_disk_key
)

4177 + (
bŒfs_chunk
)) {

4178 
	`bŒfs_”r
(
fs_šfo
, "system chunk‡rrayoo small %u < %zu",

4179 
	`bŒfs_su³r_sys_¬¿y_size
(
sb
),

4180 (
bŒfs_disk_key
)

4181 + (
bŒfs_chunk
));

4182 
»t
 = -
EINVAL
;

4189 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è< 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(sb))

4190 
	`bŒfs_w¬n
(
fs_šfo
,

4192 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

4193 
	`bŒfs_su³r_chunk_roÙ_g’”©iÚ
(
sb
));

4194 ià(
	`bŒfs_su³r_g’”©iÚ
(
sb
è< 
	`bŒfs_su³r_ÿche_g’”©iÚ
(sb)

4195 && 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
sb
è!ð(
u64
)-1)

4196 
	`bŒfs_w¬n
(
fs_šfo
,

4198 
	`bŒfs_su³r_g’”©iÚ
(
sb
),

4199 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
sb
));

4201  
»t
;

4202 
	}
}

4204 
	$bŒfs_”rÜ_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
)

4206 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

4207 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

4208 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

4210 
	`down_wr™e
(&
fs_šfo
->
þ—nup_wÜk_£m
);

4211 
	`up_wr™e
(&
fs_šfo
->
þ—nup_wÜk_£m
);

4214 
	`bŒfs_þ—nup_Œª§ùiÚ
(
fs_šfo
);

4215 
	}
}

4217 
	$bŒfs_de¡roy_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
)

4219 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4221 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

4226 
	`li¡_fÜ_—ch_’Œy
(
Üd”ed
, &
roÙ
->
Üd”ed_ex‹Ás
,

4227 
roÙ_ex‹Á_li¡
)

4228 
	`£t_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
);

4229 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

4230 
	}
}

4232 
	$bŒfs_de¡roy_®l_Üd”ed_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
)

4234 
bŒfs_roÙ
 *
roÙ
;

4235 
li¡_h—d
 
¥liû
;

4237 
	`INIT_LIST_HEAD
(&
¥liû
);

4239 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

4240 
	`li¡_¥liû_š™
(&
fs_šfo
->
Üd”ed_roÙs
, &
¥liû
);

4241 !
	`li¡_em±y
(&
¥liû
)) {

4242 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

4243 
Üd”ed_roÙ
);

4244 
	`li¡_move_ž
(&
roÙ
->
Üd”ed_roÙ
,

4245 &
fs_šfo
->
Üd”ed_roÙs
);

4247 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

4248 
	`bŒfs_de¡roy_Üd”ed_ex‹Ás
(
roÙ
);

4250 
	`cÚd_»sched
();

4251 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

4253 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

4254 
	}
}

4256 
	$bŒfs_de¡roy_d–ayed_»fs
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

4257 
bŒfs_fs_šfo
 *
fs_šfo
)

4259 
rb_node
 *
node
;

4260 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

4261 
bŒfs_d–ayed_»f_node
 *
»f
;

4262 
»t
 = 0;

4264 
d–ayed_»fs
 = &
Œªs
->delayed_refs;

4266 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

4267 ià(
	`©omic_»ad
(&
d–ayed_»fs
->
num_’Œ›s
) == 0) {

4268 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

4269 
	`bŒfs_šfo
(
fs_šfo
, "delayed_refs has NOƒntry");

4270  
»t
;

4273 (
node
 = 
	`rb_fœ¡
(&
d–ayed_»fs
->
h»f_roÙ
)è!ð
NULL
) {

4274 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

4275 
bŒfs_d–ayed_»f_node
 *
tmp
;

4276 
boÞ
 
pš_by‹s
 = 
çl£
;

4278 
h—d
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
,

4279 
h»f_node
);

4280 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

4281 
	`»fcouÁ_šc
(&
h—d
->
node
.
»fs
);

4282 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

4284 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

4285 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

4286 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

4287 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

4290 
	`¥š_lock
(&
h—d
->
lock
);

4291 
	`li¡_fÜ_—ch_’Œy_§ã_»v”£
(
»f
, 
tmp
, &
h—d
->
»f_li¡
,

4292 
li¡
) {

4293 
»f
->
š_Œ“
 = 0;

4294 
	`li¡_d–
(&
»f
->
li¡
);

4295 ià(!
	`li¡_em±y
(&
»f
->
add_li¡
))

4296 
	`li¡_d–
(&
»f
->
add_li¡
);

4297 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

4298 
	`bŒfs_put_d–ayed_»f
(
»f
);

4300 ià(
h—d
->
mu¡_š£¹_»£rved
)

4301 
pš_by‹s
 = 
Œue
;

4302 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
h—d
->
ex‹Á_Ý
);

4303 
d–ayed_»fs
->
num_h—ds
--;

4304 ià(
h—d
->
´oûssšg
 == 0)

4305 
d–ayed_»fs
->
num_h—ds_»ady
--;

4306 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

4307 
h—d
->
node
.
š_Œ“
 = 0;

4308 
	`rb_”a£
(&
h—d
->
h»f_node
, &
d–ayed_»fs
->
h»f_roÙ
);

4309 
	`¥š_uÆock
(&
h—d
->
lock
);

4310 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

4311 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

4313 ià(
pš_by‹s
)

4314 
	`bŒfs_pš_ex‹Á
(
fs_šfo
, 
h—d
->
node
.
by‹Ä
,

4315 
h—d
->
node
.
num_by‹s
, 1);

4316 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

4317 
	`cÚd_»sched
();

4318 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

4321 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

4323  
»t
;

4324 
	}
}

4326 
	$bŒfs_de¡roy_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
)

4328 
bŒfs_šode
 *btrfs_inode;

4329 
li¡_h—d
 
¥liû
;

4331 
	`INIT_LIST_HEAD
(&
¥liû
);

4333 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

4334 
	`li¡_¥liû_š™
(&
roÙ
->
d–®loc_šodes
, &
¥liû
);

4336 !
	`li¡_em±y
(&
¥liû
)) {

4337 
bŒfs_šode
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, btrfs_inode,

4338 
d–®loc_šodes
);

4340 
	`li¡_d–_š™
(&
bŒfs_šode
->
d–®loc_šodes
);

4341 
	`þ—r_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

4342 &
bŒfs_šode
->
ruÁime_æags
);

4343 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

4345 
	`bŒfs_šv®id©e_šodes
(
bŒfs_šode
->
roÙ
);

4347 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

4350 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

4351 
	}
}

4353 
	$bŒfs_de¡roy_®l_d–®loc_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

4355 
bŒfs_roÙ
 *
roÙ
;

4356 
li¡_h—d
 
¥liû
;

4358 
	`INIT_LIST_HEAD
(&
¥liû
);

4360 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

4361 
	`li¡_¥liû_š™
(&
fs_šfo
->
d–®loc_roÙs
, &
¥liû
);

4362 !
	`li¡_em±y
(&
¥liû
)) {

4363 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

4364 
d–®loc_roÙ
);

4365 
	`li¡_d–_š™
(&
roÙ
->
d–®loc_roÙ
);

4366 
roÙ
 = 
	`bŒfs_g¿b_fs_roÙ
(root);

4367 
	`BUG_ON
(!
roÙ
);

4368 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

4370 
	`bŒfs_de¡roy_d–®loc_šodes
(
roÙ
);

4371 
	`bŒfs_put_fs_roÙ
(
roÙ
);

4373 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

4375 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

4376 
	}
}

4378 
	$bŒfs_de¡roy_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

4379 
ex‹Á_io_Œ“
 *
dœty_·ges
,

4380 
m¬k
)

4382 
»t
;

4383 
ex‹Á_bufãr
 *
eb
;

4384 
u64
 
¡¬t
 = 0;

4385 
u64
 
’d
;

4388 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, &¡¬t, &
’d
,

4389 
m¬k
, 
NULL
);

4390 ià(
»t
)

4393 
	`þ—r_ex‹Á_b™s
(
dœty_·ges
, 
¡¬t
, 
’d
, 
m¬k
);

4394 
¡¬t
 <ð
’d
) {

4395 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

4396 
¡¬t
 +ð
fs_šfo
->
nodesize
;

4397 ià(!
eb
)

4399 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
eb
);

4401 ià(
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_DIRTY
,

4402 &
eb
->
bæags
))

4403 
	`þ—r_ex‹Á_bufãr_dœty
(
eb
);

4404 
	`ä“_ex‹Á_bufãr_¡®e
(
eb
);

4408  
»t
;

4409 
	}
}

4411 
	$bŒfs_de¡roy_pšÃd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

4412 
ex‹Á_io_Œ“
 *
pšÃd_ex‹Ás
)

4414 
ex‹Á_io_Œ“
 *
uÅš
;

4415 
u64
 
¡¬t
;

4416 
u64
 
’d
;

4417 
»t
;

4418 
boÞ
 
loÝ
 = 
Œue
;

4420 
uÅš
 = 
pšÃd_ex‹Ás
;

4421 
agaš
:

4423 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(
uÅš
, 0, &
¡¬t
, &
’d
,

4424 
EXTENT_DIRTY
, 
NULL
);

4425 ià(
»t
)

4428 
	`þ—r_ex‹Á_dœty
(
uÅš
, 
¡¬t
, 
’d
);

4429 
	`bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
fs_šfo
, 
¡¬t
, 
’d
);

4430 
	`cÚd_»sched
();

4433 ià(
loÝ
) {

4434 ià(
uÅš
 =ð&
fs_šfo
->
ä“d_ex‹Ás
[0])

4435 
uÅš
 = &
fs_šfo
->
ä“d_ex‹Ás
[1];

4437 
uÅš
 = &
fs_šfo
->
ä“d_ex‹Ás
[0];

4438 
loÝ
 = 
çl£
;

4439 
agaš
;

4443 
	}
}

4445 
	$bŒfs_þ—nup_bg_io
(
bŒfs_block_group_ÿche
 *
ÿche
)

4447 
šode
 *inode;

4449 
šode
 = 
ÿche
->
io_ùl
.inode;

4450 ià(
šode
) {

4451 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

4452 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

4453 
ÿche
->
io_ùl
.
šode
 = 
NULL
;

4454 
	`ut
(
šode
);

4456 
	`bŒfs_put_block_group
(
ÿche
);

4457 
	}
}

4459 
	$bŒfs_þ—nup_dœty_bgs
(
bŒfs_Œª§ùiÚ
 *
cur_Œªs
,

4460 
bŒfs_fs_šfo
 *
fs_šfo
)

4462 
bŒfs_block_group_ÿche
 *
ÿche
;

4464 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

4465 !
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
)) {

4466 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
dœty_bgs
,

4467 
bŒfs_block_group_ÿche
,

4468 
dœty_li¡
);

4469 ià(!
ÿche
) {

4470 
	`bŒfs_”r
(
fs_šfo
, "orphan block group dirty_bgs†ist");

4471 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

4475 ià(!
	`li¡_em±y
(&
ÿche
->
io_li¡
)) {

4476 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

4477 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

4478 
	`bŒfs_þ—nup_bg_io
(
ÿche
);

4479 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

4482 
	`li¡_d–_š™
(&
ÿche
->
dœty_li¡
);

4483 
	`¥š_lock
(&
ÿche
->
lock
);

4484 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

4485 
	`¥š_uÆock
(&
ÿche
->
lock
);

4487 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

4488 
	`bŒfs_put_block_group
(
ÿche
);

4489 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

4491 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

4493 !
	`li¡_em±y
(&
cur_Œªs
->
io_bgs
)) {

4494 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
io_bgs
,

4495 
bŒfs_block_group_ÿche
,

4496 
io_li¡
);

4497 ià(!
ÿche
) {

4498 
	`bŒfs_”r
(
fs_šfo
, "orphan block group on io_bgs†ist");

4502 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

4503 
	`¥š_lock
(&
ÿche
->
lock
);

4504 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

4505 
	`¥š_uÆock
(&
ÿche
->
lock
);

4506 
	`bŒfs_þ—nup_bg_io
(
ÿche
);

4508 
	}
}

4510 
	$bŒfs_þ—nup_Úe_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
cur_Œªs
,

4511 
bŒfs_fs_šfo
 *
fs_šfo
)

4513 
	`bŒfs_þ—nup_dœty_bgs
(
cur_Œªs
, 
fs_šfo
);

4514 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
));

4515 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
io_bgs
));

4517 
	`bŒfs_de¡roy_d–ayed_»fs
(
cur_Œªs
, 
fs_šfo
);

4519 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_START
;

4520 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

4522 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_UNBLOCKED
;

4523 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

4525 
	`bŒfs_de¡roy_d–ayed_šodes
(
fs_šfo
);

4526 
	`bŒfs_as£¹_d–ayed_roÙ_em±y
(
fs_šfo
);

4528 
	`bŒfs_de¡roy_m¬ked_ex‹Ás
(
fs_šfo
, &
cur_Œªs
->
dœty_·ges
,

4529 
EXTENT_DIRTY
);

4530 
	`bŒfs_de¡roy_pšÃd_ex‹Á
(
fs_šfo
,

4531 
fs_šfo
->
pšÃd_ex‹Ás
);

4533 
cur_Œªs
->
¡©e
 =
TRANS_STATE_COMPLETED
;

4534 
	`wake_up
(&
cur_Œªs
->
comm™_wa™
);

4535 
	}
}

4537 
	$bŒfs_þ—nup_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
)

4539 
bŒfs_Œª§ùiÚ
 *
t
;

4541 
	`mu‹x_lock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

4543 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

4544 !
	`li¡_em±y
(&
fs_šfo
->
Œªs_li¡
)) {

4545 
t
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
Œªs_li¡
,

4546 
bŒfs_Œª§ùiÚ
, 
li¡
);

4547 ià(
t
->
¡©e
 >ð
TRANS_STATE_COMMIT_START
) {

4548 
	`»fcouÁ_šc
(&
t
->
u£_couÁ
);

4549 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

4550 
	`bŒfs_wa™_fÜ_comm™
(
fs_šfo
, 
t
->
Œªsid
);

4551 
	`bŒfs_put_Œª§ùiÚ
(
t
);

4552 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

4555 ià(
t
 =ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
) {

4556 
t
->
¡©e
 = 
TRANS_STATE_COMMIT_DOING
;

4557 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

4562 
	`wa™_ev’t
(
t
->
wr™”_wa™
,

4563 
	`©omic_»ad
(&
t
->
num_wr™”s
) == 0);

4565 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

4567 
	`bŒfs_þ—nup_Úe_Œª§ùiÚ
(
t
, 
fs_šfo
);

4569 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

4570 ià(
t
 =ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
)

4571 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

4572 
	`li¡_d–_š™
(&
t
->
li¡
);

4573 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

4575 
	`bŒfs_put_Œª§ùiÚ
(
t
);

4576 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
fs_šfo
->
Œ“_roÙ
);

4577 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

4579 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

4580 
	`bŒfs_de¡roy_®l_Üd”ed_ex‹Ás
(
fs_šfo
);

4581 
	`bŒfs_de¡roy_d–ayed_šodes
(
fs_šfo
);

4582 
	`bŒfs_as£¹_d–ayed_roÙ_em±y
(
fs_šfo
);

4583 
	`bŒfs_de¡roy_pšÃd_ex‹Á
(
fs_šfo
, fs_šfo->
pšÃd_ex‹Ás
);

4584 
	`bŒfs_de¡roy_®l_d–®loc_šodes
(
fs_šfo
);

4585 
	`mu‹x_uÆock
(&
fs_šfo
->
Œª§ùiÚ_kth»ad_mu‹x
);

4588 
	}
}

4590 
bŒfs_fs_šfo
 *
	$bŒ“_fs_šfo
(*
´iv©e_d©a
)

4592 
šode
 *šodð
´iv©e_d©a
;

4593  
	`bŒfs_sb
(
šode
->
i_sb
);

4594 
	}
}

4596 cÚ¡ 
ex‹Á_io_Ýs
 
	gbŒ“_ex‹Á_io_Ýs
 = {

4598 .
subm™_bio_hook
 = 
bŒ“_subm™_bio_hook
,

4599 .
	g»ad·ge_’d_io_hook
 = 
bŒ“_»ad·ge_’d_io_hook
,

4601 .
	gm”ge_bio_hook
 = 
bŒfs_m”ge_bio_hook
,

4602 .
	g»ad·ge_io_çžed_hook
 = 
bŒ“_io_çžed_hook
,

4603 .
	g£t_¿nge_wr™eback
 = 
bŒfs_£t_¿nge_wr™eback
,

4604 .
	gŒ“_fs_šfo
 = 
bŒ“_fs_šfo
,

	@disk-io.h

19 #iâdeà
__DISKIO__


20 
	#__DISKIO__


	)

22 
	#BTRFS_SUPER_INFO_OFFSET
 
SZ_64K


	)

23 
	#BTRFS_SUPER_INFO_SIZE
 4096

	)

25 
	#BTRFS_SUPER_MIRROR_MAX
 3

	)

26 
	#BTRFS_SUPER_MIRROR_SHIFT
 12

	)

34 
	#BTRFS_BDEV_BLOCKSIZE
 (4096)

	)

36 
	ebŒfs_wq_’dio_ty³
 {

37 
	mBTRFS_WQ_ENDIO_DATA
 = 0,

38 
	mBTRFS_WQ_ENDIO_METADATA
 = 1,

39 
	mBTRFS_WQ_ENDIO_FREE_SPACE
 = 2,

40 
	mBTRFS_WQ_ENDIO_RAID56
 = 3,

41 
	mBTRFS_WQ_ENDIO_DIO_REPAIR
 = 4,

44 
šlše
 
u64
 
	$bŒfs_sb_off£t
(
mœrÜ
)

46 
u64
 
¡¬t
 = 
SZ_16K
;

47 ià(
mœrÜ
)

48  
¡¬t
 << (
BTRFS_SUPER_MIRROR_SHIFT
 * 
mœrÜ
);

49  
BTRFS_SUPER_INFO_OFFSET
;

50 
	}
}

52 
	gbŒfs_deviû
;

53 
	gbŒfs_fs_deviûs
;

55 
ex‹Á_bufãr
 *
»ad_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

56 
u64
 
by‹Ä
, u64 
·»Á_Œªsid
);

57 
»adah—d_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
);

58 
»ada_Œ“_block_æagged
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

59 
mœrÜ_num
, 
ex‹Á_bufãr
 **
eb
);

60 
ex‹Á_bufãr
 *
bŒfs_fšd_ü—‹_Œ“_block
(

61 
bŒfs_fs_šfo
 *
fs_šfo
,

62 
u64
 
by‹Ä
);

63 
þ—n_Œ“_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
buf
);

64 
Ý’_ù»e
(
su³r_block
 *
sb
,

65 
bŒfs_fs_deviûs
 *
fs_deviûs
,

66 *
ÝtiÚs
);

67 
þo£_ù»e
(
bŒfs_fs_šfo
 *
fs_šfo
);

68 
wr™e_®l_su³rs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
max_mœrÜs
);

69 
bufãr_h—d
 *
bŒfs_»ad_dev_su³r
(
block_deviû
 *
bdev
);

70 
bŒfs_»ad_dev_Úe_su³r
(
block_deviû
 *
bdev
, 
cÝy_num
,

71 
bufãr_h—d
 **
bh_»t
);

72 
bŒfs_comm™_su³r
(
bŒfs_fs_šfo
 *
fs_šfo
);

73 
bŒfs_roÙ
 *
bŒfs_»ad_fs_roÙ
(bŒfs_roÙ *
Œ“_roÙ
,

74 
bŒfs_key
 *
loÿtiÚ
);

75 
bŒfs_š™_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
);

76 
bŒfs_roÙ
 *
bŒfs_lookup_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

77 
u64
 
roÙ_id
);

78 
bŒfs_š£¹_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

79 
bŒfs_roÙ
 *
roÙ
);

80 
bŒfs_ä“_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
);

82 
bŒfs_roÙ
 *
bŒfs_g‘_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

83 
bŒfs_key
 *
key
,

84 
boÞ
 
check_»f
);

85 
šlše
 
bŒfs_roÙ
 *

86 
	$bŒfs_»ad_fs_roÙ_no_Çme
(
bŒfs_fs_šfo
 *
fs_šfo
,

87 
bŒfs_key
 *
loÿtiÚ
)

89  
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, 
loÿtiÚ
, 
Œue
);

90 
	}
}

92 
bŒfs_þ—nup_fs_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
);

93 
bŒfs_bŒ“_b®ªû_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
);

94 
bŒfs_bŒ“_b®ªû_dœty_nod–ay
(
bŒfs_fs_šfo
 *
fs_šfo
);

95 
bŒfs_drÝ_ªd_ä“_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

96 
bŒfs_roÙ
 *
roÙ
);

97 
bŒfs_ä“_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
);

99 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


100 
bŒfs_roÙ
 *
bŒfs_®loc_dummy_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
);

110 
šlše
 
bŒfs_roÙ
 *
	$bŒfs_g¿b_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
)

112 ià(
	`»fcouÁ_šc_nÙ_z”o
(&
roÙ
->
»fs
))

113  
roÙ
;

114  
NULL
;

115 
	}
}

117 
šlše
 
	$bŒfs_put_fs_roÙ
(
bŒfs_roÙ
 *
roÙ
)

119 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
roÙ
->
»fs
))

120 
	`kä“
(
roÙ
);

121 
	}
}

123 
bŒfs_m¬k_bufãr_dœty
(
ex‹Á_bufãr
 *
buf
);

124 
bŒfs_bufãr_u±od©e
(
ex‹Á_bufãr
 *
buf
, 
u64
 
·»Á_Œªsid
,

125 
©omic
);

126 
bŒfs_»ad_bufãr
(
ex‹Á_bufãr
 *
buf
, 
u64
 
·»Á_Œªsid
);

127 
u32
 
bŒfs_csum_d©a
(cÚ¡ *
d©a
, u32 
£ed
, 
size_t
 
Ën
);

128 
bŒfs_csum_fš®
(
u32
 
üc
, 
u8
 *
»suÉ
);

129 
blk_¡©us_t
 
bŒfs_bio_wq_’d_io
(
bŒfs_fs_šfo
 *
šfo
, 
bio
 *bio,

130 
bŒfs_wq_’dio_ty³
 
m‘ad©a
);

131 
blk_¡©us_t
 
bŒfs_wq_subm™_bio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

132 
mœrÜ_num
, 
bio_æags
,

133 
u64
 
bio_off£t
, *
´iv©e_d©a
,

134 
ex‹Á_subm™_bio_hook_t
 *
subm™_bio_¡¬t
,

135 
ex‹Á_subm™_bio_hook_t
 *
subm™_bio_dÚe
);

136 
bŒfs_async_subm™_lim™
(
bŒfs_fs_šfo
 *
šfo
);

137 
bŒfs_wr™e_Œ“_block
(
ex‹Á_bufãr
 *
buf
);

138 
bŒfs_wa™_Œ“_block_wr™eback
(
ex‹Á_bufãr
 *
buf
);

139 
bŒfs_š™_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

140 
bŒfs_fs_šfo
 *
fs_šfo
);

141 
bŒfs_add_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

142 
bŒfs_roÙ
 *
roÙ
);

143 
bŒfs_þ—nup_dœty_bgs
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

144 
bŒfs_fs_šfo
 *
fs_šfo
);

145 
bŒfs_þ—nup_Úe_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

146 
bŒfs_fs_šfo
 *
fs_šfo
);

147 
bŒfs_roÙ
 *
bŒfs_ü—‹_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

148 
bŒfs_fs_šfo
 *
fs_šfo
,

149 
u64
 
objeùid
);

150 
bŒ“_lock_·ge_hook
(
·ge
 *·ge, *
d©a
,

151 (*
æush_â
)(*));

152 
	`bŒfs_g‘_num_tÞ”©ed_disk_b¬r›r_çžu»s
(
u64
 
æags
);

153 
__š™
 
	`bŒfs_’d_io_wq_š™
();

154 
	`bŒfs_’d_io_wq_ex™
();

156 #ifdeà
CONFIG_DEBUG_LOCK_ALLOC


157 
	`bŒfs_š™_lockd•
();

158 
	`bŒfs_£t_bufãr_lockd•_þass
(
u64
 
objeùid
,

159 
ex‹Á_bufãr
 *
eb
, 
Ëv–
);

161 
šlše
 
	$bŒfs_š™_lockd•
()

162 { 
	}
}

163 
šlše
 
	$bŒfs_£t_bufãr_lockd•_þass
(
u64
 
objeùid
,

164 
ex‹Á_bufãr
 *
eb
, 
Ëv–
)

166 
	}
}

	@export.c

2 
	~<lšux/fs.h
>

3 
	~<lšux/ty³s.h
>

4 
	~"ù»e.h
"

5 
	~"disk-io.h
"

6 
	~"bŒfs_šode.h
"

7 
	~"´št-Œ“.h
"

8 
	~"expÜt.h
"

10 
	#BTRFS_FID_SIZE_NON_CONNECTABLE
 (
	`off£tof
(
bŒfs_fid
, \

11 
·»Á_objeùid
è/ 4)

	)

12 
	#BTRFS_FID_SIZE_CONNECTABLE
 (
	`off£tof
(
bŒfs_fid
, \

13 
·»Á_roÙ_objeùid
è/ 4)

	)

14 
	#BTRFS_FID_SIZE_CONNECTABLE_ROOT
 ((
bŒfs_fid
è/ 4)

	)

16 
	$bŒfs_’code_fh
(
šode
 *šode, 
u32
 *
fh
, *
max_Ën
,

17 
šode
 *
·»Á
)

19 
bŒfs_fid
 *
fid
 = (bŒfs_fid *)
fh
;

20 
Ën
 = *
max_Ën
;

21 
ty³
;

23 ià(
·»Á
 && (
Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE
)) {

24 *
max_Ën
 = 
BTRFS_FID_SIZE_CONNECTABLE
;

25  
FILEID_INVALID
;

26 } ià(
Ën
 < 
BTRFS_FID_SIZE_NON_CONNECTABLE
) {

27 *
max_Ën
 = 
BTRFS_FID_SIZE_NON_CONNECTABLE
;

28  
FILEID_INVALID
;

31 
Ën
 = 
BTRFS_FID_SIZE_NON_CONNECTABLE
;

32 
ty³
 = 
FILEID_BTRFS_WITHOUT_PARENT
;

34 
fid
->
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

35 
fid
->
roÙ_objeùid
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
objeùid
;

36 
fid
->
g’
 = 
šode
->
i_g’”©iÚ
;

38 ià(
·»Á
) {

39 
u64
 
·»Á_roÙ_id
;

41 
fid
->
·»Á_objeùid
 = 
	`BTRFS_I
(
·»Á
)->
loÿtiÚ
.
objeùid
;

42 
fid
->
·»Á_g’
 = 
·»Á
->
i_g’”©iÚ
;

43 
·»Á_roÙ_id
 = 
	`BTRFS_I
(
·»Á
)->
roÙ
->
objeùid
;

45 ià(
·»Á_roÙ_id
 !ð
fid
->
roÙ_objeùid
) {

46 
fid
->
·»Á_roÙ_objeùid
 = 
·»Á_roÙ_id
;

47 
Ën
 = 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
;

48 
ty³
 = 
FILEID_BTRFS_WITH_PARENT_ROOT
;

50 
Ën
 = 
BTRFS_FID_SIZE_CONNECTABLE
;

51 
ty³
 = 
FILEID_BTRFS_WITH_PARENT
;

55 *
max_Ën
 = 
Ën
;

56  
ty³
;

57 
	}
}

59 
d’Œy
 *
	$bŒfs_g‘_d’Œy
(
su³r_block
 *
sb
, 
u64
 
objeùid
,

60 
u64
 
roÙ_objeùid
, 
u32
 
g’”©iÚ
,

61 
check_g’”©iÚ
)

63 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

64 
bŒfs_roÙ
 *
roÙ
;

65 
šode
 *inode;

66 
bŒfs_key
 
key
;

67 
šdex
;

68 
”r
 = 0;

70 ià(
objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
)

71  
	`ERR_PTR
(-
ESTALE
);

73 
key
.
objeùid
 = 
roÙ_objeùid
;

74 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

75 
key
.
off£t
 = (
u64
)-1;

77 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

79 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

80 ià(
	`IS_ERR
(
roÙ
)) {

81 
”r
 = 
	`PTR_ERR
(
roÙ
);

82 
çž
;

85 
key
.
objeùid
 = objectid;

86 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

87 
key
.
off£t
 = 0;

89 
šode
 = 
	`bŒfs_ig‘
(
sb
, &
key
, 
roÙ
, 
NULL
);

90 ià(
	`IS_ERR
(
šode
)) {

91 
”r
 = 
	`PTR_ERR
(
šode
);

92 
çž
;

95 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

97 ià(
check_g’”©iÚ
 && 
g’”©iÚ
 !ð
šode
->
i_g’”©iÚ
) {

98 
	`ut
(
šode
);

99  
	`ERR_PTR
(-
ESTALE
);

102  
	`d_obš_®Ÿs
(
šode
);

103 
çž
:

104 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

105  
	`ERR_PTR
(
”r
);

106 
	}
}

108 
d’Œy
 *
	$bŒfs_fh_to_·»Á
(
su³r_block
 *
sb
, 
fid
 *
fh
,

109 
fh_Ën
, 
fh_ty³
)

111 
bŒfs_fid
 *
fid
 = (bŒfs_fid *è
fh
;

112 
u64
 
objeùid
, 
roÙ_objeùid
;

113 
u32
 
g’”©iÚ
;

115 ià(
fh_ty³
 =ð
FILEID_BTRFS_WITH_PARENT
) {

116 ià(
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE
)

117  
NULL
;

118 
roÙ_objeùid
 = 
fid
->root_objectid;

119 } ià(
fh_ty³
 =ð
FILEID_BTRFS_WITH_PARENT_ROOT
) {

120 ià(
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
)

121  
NULL
;

122 
roÙ_objeùid
 = 
fid
->
·»Á_roÙ_objeùid
;

124  
NULL
;

126 
objeùid
 = 
fid
->
·»Á_objeùid
;

127 
g’”©iÚ
 = 
fid
->
·»Á_g’
;

129  
	`bŒfs_g‘_d’Œy
(
sb
, 
objeùid
, 
roÙ_objeùid
, 
g’”©iÚ
, 1);

130 
	}
}

132 
d’Œy
 *
	$bŒfs_fh_to_d’Œy
(
su³r_block
 *
sb
, 
fid
 *
fh
,

133 
fh_Ën
, 
fh_ty³
)

135 
bŒfs_fid
 *
fid
 = (bŒfs_fid *è
fh
;

136 
u64
 
objeùid
, 
roÙ_objeùid
;

137 
u32
 
g’”©iÚ
;

139 ià((
fh_ty³
 !ð
FILEID_BTRFS_WITH_PARENT
 ||

140 
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE
) &&

141 (
fh_ty³
 !ð
FILEID_BTRFS_WITH_PARENT_ROOT
 ||

142 
fh_Ën
 < 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
) &&

143 (
fh_ty³
 !ð
FILEID_BTRFS_WITHOUT_PARENT
 ||

144 
fh_Ën
 < 
BTRFS_FID_SIZE_NON_CONNECTABLE
))

145  
NULL
;

147 
objeùid
 = 
fid
->objectid;

148 
roÙ_objeùid
 = 
fid
->root_objectid;

149 
g’”©iÚ
 = 
fid
->
g’
;

151  
	`bŒfs_g‘_d’Œy
(
sb
, 
objeùid
, 
roÙ_objeùid
, 
g’”©iÚ
, 1);

152 
	}
}

154 
d’Œy
 *
	$bŒfs_g‘_·»Á
(
d’Œy
 *
chžd
)

156 
šode
 *
dœ
 = 
	`d_šode
(
chžd
);

157 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

158 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

159 
bŒfs_·th
 *
·th
;

160 
ex‹Á_bufãr
 *
Ëaf
;

161 
bŒfs_roÙ_»f
 *
»f
;

162 
bŒfs_key
 
key
;

163 
bŒfs_key
 
found_key
;

164 
»t
;

166 
·th
 = 
	`bŒfs_®loc_·th
();

167 ià(!
·th
)

168  
	`ERR_PTR
(-
ENOMEM
);

170 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)è=ð
BTRFS_FIRST_FREE_OBJECTID
) {

171 
key
.
objeùid
 = 
roÙ
->
roÙ_key
.objectid;

172 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

173 
key
.
off£t
 = (
u64
)-1;

174 
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

176 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

177 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

178 
key
.
off£t
 = (
u64
)-1;

181 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

182 ià(
»t
 < 0)

183 
çž
;

185 
	`BUG_ON
(
»t
 == 0);

186 ià(
·th
->
¦Ùs
[0] == 0) {

187 
»t
 = -
ENOENT
;

188 
çž
;

191 
·th
->
¦Ùs
[0]--;

192 
Ëaf
 = 
·th
->
nodes
[0];

194 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

195 ià(
found_key
.
objeùid
 !ð
key
.objeùid || found_key.
ty³
 != key.type) {

196 
»t
 = -
ENOENT
;

197 
çž
;

200 ià(
found_key
.
ty³
 =ð
BTRFS_ROOT_BACKREF_KEY
) {

201 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

202 
bŒfs_roÙ_»f
);

203 
key
.
objeùid
 = 
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
»f
);

205 
key
.
objeùid
 = 
found_key
.
off£t
;

207 
	`bŒfs_ä“_·th
(
·th
);

209 ià(
found_key
.
ty³
 =ð
BTRFS_ROOT_BACKREF_KEY
) {

210  
	`bŒfs_g‘_d’Œy
(
fs_šfo
->
sb
, 
key
.
objeùid
,

211 
found_key
.
off£t
, 0, 0);

214 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

215 
key
.
off£t
 = 0;

216  
	`d_obš_®Ÿs
(
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
roÙ
, 
NULL
));

217 
çž
:

218 
	`bŒfs_ä“_·th
(
·th
);

219  
	`ERR_PTR
(
»t
);

220 
	}
}

222 
	$bŒfs_g‘_Çme
(
d’Œy
 *
·»Á
, *
Çme
,

223 
d’Œy
 *
chžd
)

225 
šode
 *šodð
	`d_šode
(
chžd
);

226 
šode
 *
dœ
 = 
	`d_šode
(
·»Á
);

227 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

228 
bŒfs_·th
 *
·th
;

229 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

230 
bŒfs_šode_»f
 *
œef
;

231 
bŒfs_roÙ_»f
 *
¼ef
;

232 
ex‹Á_bufãr
 *
Ëaf
;

233 
Çme_±r
;

234 
bŒfs_key
 
key
;

235 
Çme_Ën
;

236 
»t
;

237 
u64
 
šo
;

239 ià(!
	`S_ISDIR
(
dœ
->
i_mode
))

240  -
EINVAL
;

242 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

244 
·th
 = 
	`bŒfs_®loc_·th
();

245 ià(!
·th
)

246  -
ENOMEM
;

247 
·th
->
Ëave_¥šnšg
 = 1;

249 ià(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

250 
key
.
objeùid
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.objectid;

251 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

252 
key
.
off£t
 = (
u64
)-1;

253 
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

255 
key
.
objeùid
 = 
šo
;

256 
key
.
off£t
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

257 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

260 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

261 ià(
»t
 < 0) {

262 
	`bŒfs_ä“_·th
(
·th
);

263  
»t
;

264 } ià(
»t
 > 0) {

265 ià(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

266 
·th
->
¦Ùs
[0]--;

268 
	`bŒfs_ä“_·th
(
·th
);

269  -
ENOENT
;

272 
Ëaf
 = 
·th
->
nodes
[0];

274 ià(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

275 
¼ef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

276 
bŒfs_roÙ_»f
);

277 
Çme_±r
 = ()(
¼ef
 + 1);

278 
Çme_Ën
 = 
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
¼ef
);

280 
œef
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

281 
bŒfs_šode_»f
);

282 
Çme_±r
 = ()(
œef
 + 1);

283 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
œef
);

286 
»t
 = 
	`bŒfs_is_Çme_Ën_v®id
(
Ëaf
, 
·th
->
¦Ùs
[0], 
Çme_±r
, 
Çme_Ën
);

287 ià(!
»t
) {

288 
	`bŒfs_ä“_·th
(
·th
);

289  -
EIO
;

291 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
);

292 
	`bŒfs_ä“_·th
(
·th
);

298 
Çme
[
Çme_Ën
] = '\0';

301 
	}
}

303 cÚ¡ 
expÜt_Ý”©iÚs
 
	gbŒfs_expÜt_Ýs
 = {

304 .
’code_fh
 = 
bŒfs_’code_fh
,

305 .
	gfh_to_d’Œy
 = 
bŒfs_fh_to_d’Œy
,

306 .
	gfh_to_·»Á
 = 
bŒfs_fh_to_·»Á
,

307 .
	gg‘_·»Á
 = 
bŒfs_g‘_·»Á
,

308 .
	gg‘_Çme
 = 
bŒfs_g‘_Çme
,

	@export.h

2 #iâdeà
BTRFS_EXPORT_H


3 
	#BTRFS_EXPORT_H


	)

5 
	~<lšux/expÜtfs.h
>

7 cÚ¡ 
expÜt_Ý”©iÚs
 
bŒfs_expÜt_Ýs
;

9 
	sbŒfs_fid
 {

10 
u64
 
	mobjeùid
;

11 
u64
 
	mroÙ_objeùid
;

12 
u32
 
	mg’
;

14 
u64
 
	m·»Á_objeùid
;

15 
u32
 
	m·»Á_g’
;

17 
u64
 
	m·»Á_roÙ_objeùid
;

18 } 
__©Œibu‹__
 ((
·cked
));

	@extent-tree.c

18 
	~<lšux/sched.h
>

19 
	~<lšux/sched/sigÇl.h
>

20 
	~<lšux/·gem­.h
>

21 
	~<lšux/wr™eback.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/sÜt.h
>

24 
	~<lšux/rcupd©e.h
>

25 
	~<lšux/kth»ad.h
>

26 
	~<lšux/¦ab.h
>

27 
	~<lšux/¿‹lim™.h
>

28 
	~<lšux/³rýu_couÁ”.h
>

29 
	~"hash.h
"

30 
	~"Œ“-log.h
"

31 
	~"disk-io.h
"

32 
	~"´št-Œ“.h
"

33 
	~"vÞumes.h
"

34 
	~"¿id56.h
"

35 
	~"lockšg.h
"

36 
	~"ä“-¥aû-ÿche.h
"

37 
	~"ä“-¥aû-Œ“.h
"

38 
	~"m©h.h
"

39 
	~"sysfs.h
"

40 
	~"qgroup.h
"

42 #undeà
SCRAMBLE_DELAYED_REFS


59 
	mCHUNK_ALLOC_NO_FORCE
 = 0,

60 
	mCHUNK_ALLOC_LIMITED
 = 1,

61 
	mCHUNK_ALLOC_FORCE
 = 2,

64 
upd©e_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

65 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

66 
u64
 
num_by‹s
, 
®loc
);

67 
__bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

68 
bŒfs_fs_šfo
 *
fs_šfo
,

69 
bŒfs_d–ayed_»f_node
 *
node
, 
u64
 
·»Á
,

70 
u64
 
roÙ_objeùid
, u64 
owÃr_objeùid
,

71 
u64
 
owÃr_off£t
, 
»fs_to_drÝ
,

72 
bŒfs_d–ayed_ex‹Á_Ý
 *
exŒa_Ý
);

73 
__run_d–ayed_ex‹Á_Ý
(
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

74 
ex‹Á_bufãr
 *
Ëaf
,

75 
bŒfs_ex‹Á_™em
 *
ei
);

76 
®loc_»£rved_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

77 
bŒfs_fs_šfo
 *
fs_šfo
,

78 
u64
 
·»Á
, u64 
roÙ_objeùid
,

79 
u64
 
æags
, u64 
owÃr
, u64 
off£t
,

80 
bŒfs_key
 *
šs
, 
»f_mod
);

81 
®loc_»£rved_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

82 
bŒfs_fs_šfo
 *
fs_šfo
,

83 
u64
 
·»Á
, u64 
roÙ_objeùid
,

84 
u64
 
æags
, 
bŒfs_disk_key
 *
key
,

85 
Ëv–
, 
bŒfs_key
 *
šs
);

86 
do_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

87 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
,

88 
fÜû
);

89 
fšd_Ãxt_key
(
bŒfs_·th
 *
·th
, 
Ëv–
,

90 
bŒfs_key
 *
key
);

91 
dump_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

92 
bŒfs_¥aû_šfo
 *
šfo
, 
u64
 
by‹s
,

93 
dump_block_groups
);

94 
bŒfs_add_»£rved_by‹s
(
bŒfs_block_group_ÿche
 *
ÿche
,

95 
u64
 
¿m_by‹s
, u64 
num_by‹s
, 
d–®loc
);

96 
bŒfs_ä“_»£rved_by‹s
(
bŒfs_block_group_ÿche
 *
ÿche
,

97 
u64
 
num_by‹s
, 
d–®loc
);

98 
block_rsv_u£_by‹s
(
bŒfs_block_rsv
 *
block_rsv
,

99 
u64
 
num_by‹s
);

100 
__»£rve_m‘ad©a_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

101 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

102 
u64
 
Üig_by‹s
,

103 
bŒfs_»£rve_æush_’um
 
æush
,

104 
boÞ
 
sy¡em_chunk
);

105 
¥aû_šfo_add_Ãw_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

106 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

107 
u64
 
num_by‹s
);

108 
¥aû_šfo_add_Þd_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

109 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

110 
u64
 
num_by‹s
);

112 
nošlše
 

113 
	$block_group_ÿche_dÚe
(
bŒfs_block_group_ÿche
 *
ÿche
)

115 
	`smp_mb
();

116  
ÿche
->
ÿched
 =ð
BTRFS_CACHE_FINISHED
 ||

117 
ÿche
->
ÿched
 =ð
BTRFS_CACHE_ERROR
;

118 
	}
}

120 
	$block_group_b™s
(
bŒfs_block_group_ÿche
 *
ÿche
, 
u64
 
b™s
)

122  (
ÿche
->
æags
 & 
b™s
) == bits;

123 
	}
}

125 
	$bŒfs_g‘_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
)

127 
	`©omic_šc
(&
ÿche
->
couÁ
);

128 
	}
}

130 
	$bŒfs_put_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
)

132 ià(
	`©omic_dec_ªd_‹¡
(&
ÿche
->
couÁ
)) {

133 
	`WARN_ON
(
ÿche
->
pšÃd
 > 0);

134 
	`WARN_ON
(
ÿche
->
»£rved
 > 0);

144 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
ÿche
->
fuÎ_¡re_locks_roÙ
.
roÙ
));

145 
	`kä“
(
ÿche
->
ä“_¥aû_ùl
);

146 
	`kä“
(
ÿche
);

148 
	}
}

154 
	$bŒfs_add_block_group_ÿche
(
bŒfs_fs_šfo
 *
šfo
,

155 
bŒfs_block_group_ÿche
 *
block_group
)

157 
rb_node
 **
p
;

158 
rb_node
 *
·»Á
 = 
NULL
;

159 
bŒfs_block_group_ÿche
 *
ÿche
;

161 
	`¥š_lock
(&
šfo
->
block_group_ÿche_lock
);

162 
p
 = &
šfo
->
block_group_ÿche_Œ“
.
rb_node
;

164 *
p
) {

165 
·»Á
 = *
p
;

166 
ÿche
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_block_group_ÿche
,

167 
ÿche_node
);

168 ià(
block_group
->
key
.
objeùid
 < 
ÿche
->key.objectid) {

169 
p
 = &(*p)->
rb_Ëá
;

170 } ià(
block_group
->
key
.
objeùid
 > 
ÿche
->key.objectid) {

171 
p
 = &(*p)->
rb_right
;

173 
	`¥š_uÆock
(&
šfo
->
block_group_ÿche_lock
);

174  -
EEXIST
;

178 
	`rb_lšk_node
(&
block_group
->
ÿche_node
, 
·»Á
, 
p
);

179 
	`rb_š£¹_cÞÜ
(&
block_group
->
ÿche_node
,

180 &
šfo
->
block_group_ÿche_Œ“
);

182 ià(
šfo
->
fœ¡_logiÿl_by‹
 > 
block_group
->
key
.
objeùid
)

183 
šfo
->
fœ¡_logiÿl_by‹
 = 
block_group
->
key
.
objeùid
;

185 
	`¥š_uÆock
(&
šfo
->
block_group_ÿche_lock
);

188 
	}
}

194 
bŒfs_block_group_ÿche
 *

195 
	$block_group_ÿche_Œ“_£¬ch
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
,

196 
cÚšs
)

198 
bŒfs_block_group_ÿche
 *
ÿche
, *
»t
 = 
NULL
;

199 
rb_node
 *
n
;

200 
u64
 
’d
, 
¡¬t
;

202 
	`¥š_lock
(&
šfo
->
block_group_ÿche_lock
);

203 
n
 = 
šfo
->
block_group_ÿche_Œ“
.
rb_node
;

205 
n
) {

206 
ÿche
 = 
	`rb_’Œy
(
n
, 
bŒfs_block_group_ÿche
,

207 
ÿche_node
);

208 
’d
 = 
ÿche
->
key
.
objeùid
 + cache->key.
off£t
 - 1;

209 
¡¬t
 = 
ÿche
->
key
.
objeùid
;

211 ià(
by‹Ä
 < 
¡¬t
) {

212 ià(!
cÚšs
 && (!
»t
 || 
¡¬t
 <„‘->
key
.
objeùid
))

213 
»t
 = 
ÿche
;

214 
n
 =‚->
rb_Ëá
;

215 } ià(
by‹Ä
 > 
¡¬t
) {

216 ià(
cÚšs
 && 
by‹Ä
 <ð
’d
) {

217 
»t
 = 
ÿche
;

220 
n
 =‚->
rb_right
;

222 
»t
 = 
ÿche
;

226 ià(
»t
) {

227 
	`bŒfs_g‘_block_group
(
»t
);

228 ià(
by‹Ä
 =ð0 && 
šfo
->
fœ¡_logiÿl_by‹
 > 
»t
->
key
.
objeùid
)

229 
šfo
->
fœ¡_logiÿl_by‹
 = 
»t
->
key
.
objeùid
;

231 
	`¥š_uÆock
(&
šfo
->
block_group_ÿche_lock
);

233  
»t
;

234 
	}
}

236 
	$add_exþuded_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

237 
u64
 
¡¬t
, u64 
num_by‹s
)

239 
u64
 
’d
 = 
¡¬t
 + 
num_by‹s
 - 1;

240 
	`£t_ex‹Á_b™s
(&
fs_šfo
->
ä“d_ex‹Ás
[0],

241 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
);

242 
	`£t_ex‹Á_b™s
(&
fs_šfo
->
ä“d_ex‹Ás
[1],

243 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
);

245 
	}
}

247 
	$ä“_exþuded_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

248 
bŒfs_block_group_ÿche
 *
ÿche
)

250 
u64
 
¡¬t
, 
’d
;

252 
¡¬t
 = 
ÿche
->
key
.
objeùid
;

253 
’d
 = 
¡¬t
 + 
ÿche
->
key
.
off£t
 - 1;

255 
	`þ—r_ex‹Á_b™s
(&
fs_šfo
->
ä“d_ex‹Ás
[0],

256 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
);

257 
	`þ—r_ex‹Á_b™s
(&
fs_šfo
->
ä“d_ex‹Ás
[1],

258 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
);

259 
	}
}

261 
	$exþude_su³r_¡res
(
bŒfs_fs_šfo
 *
fs_šfo
,

262 
bŒfs_block_group_ÿche
 *
ÿche
)

264 
u64
 
by‹Ä
;

265 
u64
 *
logiÿl
;

266 
¡re_Ën
;

267 
i
, 
Ä
, 
»t
;

269 ià(
ÿche
->
key
.
objeùid
 < 
BTRFS_SUPER_INFO_OFFSET
) {

270 
¡re_Ën
 = 
BTRFS_SUPER_INFO_OFFSET
 - 
ÿche
->
key
.
objeùid
;

271 
ÿche
->
by‹s_su³r
 +ð
¡re_Ën
;

272 
»t
 = 
	`add_exþuded_ex‹Á
(
fs_šfo
, 
ÿche
->
key
.
objeùid
,

273 
¡re_Ën
);

274 ià(
»t
)

275  
»t
;

278 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

279 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
i
);

280 
»t
 = 
	`bŒfs_rm­_block
(
fs_šfo
, 
ÿche
->
key
.
objeùid
,

281 
by‹Ä
, 0, &
logiÿl
, &
Ä
, &
¡re_Ën
);

282 ià(
»t
)

283  
»t
;

285 
Ä
--) {

286 
u64
 
¡¬t
, 
Ën
;

288 ià(
logiÿl
[
Ä
] > 
ÿche
->
key
.
objeùid
 +

289 
ÿche
->
key
.
off£t
)

292 ià(
logiÿl
[
Ä
] + 
¡re_Ën
 <ð
ÿche
->
key
.
objeùid
)

295 
¡¬t
 = 
logiÿl
[
Ä
];

296 ià(
¡¬t
 < 
ÿche
->
key
.
objeùid
) {

297 
¡¬t
 = 
ÿche
->
key
.
objeùid
;

298 
Ën
 = (
logiÿl
[
Ä
] + 
¡re_Ën
è- 
¡¬t
;

300 
Ën
 = 
	`mš_t
(
u64
, 
¡re_Ën
,

301 
ÿche
->
key
.
objeùid
 +

302 
ÿche
->
key
.
off£t
 - 
¡¬t
);

305 
ÿche
->
by‹s_su³r
 +ð
Ën
;

306 
»t
 = 
	`add_exþuded_ex‹Á
(
fs_šfo
, 
¡¬t
, 
Ën
);

307 ià(
»t
) {

308 
	`kä“
(
logiÿl
);

309  
»t
;

313 
	`kä“
(
logiÿl
);

316 
	}
}

318 
bŒfs_ÿchšg_cÚŒÞ
 *

319 
	$g‘_ÿchšg_cÚŒÞ
(
bŒfs_block_group_ÿche
 *
ÿche
)

321 
bŒfs_ÿchšg_cÚŒÞ
 *
ùl
;

323 
	`¥š_lock
(&
ÿche
->
lock
);

324 ià(!
ÿche
->
ÿchšg_ùl
) {

325 
	`¥š_uÆock
(&
ÿche
->
lock
);

326  
NULL
;

329 
ùl
 = 
ÿche
->
ÿchšg_ùl
;

330 
	`»fcouÁ_šc
(&
ùl
->
couÁ
);

331 
	`¥š_uÆock
(&
ÿche
->
lock
);

332  
ùl
;

333 
	}
}

335 
	$put_ÿchšg_cÚŒÞ
(
bŒfs_ÿchšg_cÚŒÞ
 *
ùl
)

337 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
ùl
->
couÁ
))

338 
	`kä“
(
ùl
);

339 
	}
}

341 #ifdeà
CONFIG_BTRFS_DEBUG


342 
	$äagm’t_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
)

344 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

345 
u64
 
¡¬t
 = 
block_group
->
key
.
objeùid
;

346 
u64
 
Ën
 = 
block_group
->
key
.
off£t
;

347 
u64
 
chunk
 = 
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
 ?

348 
fs_šfo
->
nodesize
 : fs_šfo->
£ùÜsize
;

349 
u64
 
¡•
 = 
chunk
 << 1;

351 
Ën
 > 
chunk
) {

352 
	`bŒfs_»move_ä“_¥aû
(
block_group
, 
¡¬t
, 
chunk
);

353 
¡¬t
 +ð
¡•
;

354 ià(
Ën
 < 
¡•
)

355 
Ën
 = 0;

357 
Ën
 -ð
¡•
;

359 
	}
}

367 
u64
 
	$add_Ãw_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

368 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
¡¬t
, u64 
’d
)

370 
u64
 
ex‹Á_¡¬t
, 
ex‹Á_’d
, 
size
, 
tÙ®_added
 = 0;

371 
»t
;

373 
¡¬t
 < 
’d
) {

374 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(
šfo
->
pšÃd_ex‹Ás
, 
¡¬t
,

375 &
ex‹Á_¡¬t
, &
ex‹Á_’d
,

376 
EXTENT_DIRTY
 | 
EXTENT_UPTODATE
,

377 
NULL
);

378 ià(
»t
)

381 ià(
ex‹Á_¡¬t
 <ð
¡¬t
) {

382 
¡¬t
 = 
ex‹Á_’d
 + 1;

383 } ià(
ex‹Á_¡¬t
 > 
¡¬t
 &&ƒx‹Á_¡¬ˆ< 
’d
) {

384 
size
 = 
ex‹Á_¡¬t
 - 
¡¬t
;

385 
tÙ®_added
 +ð
size
;

386 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
¡¬t
,

387 
size
);

388 
	`BUG_ON
(
»t
);

389 
¡¬t
 = 
ex‹Á_’d
 + 1;

395 ià(
¡¬t
 < 
’d
) {

396 
size
 = 
’d
 - 
¡¬t
;

397 
tÙ®_added
 +ð
size
;

398 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
¡¬t
, 
size
);

399 
	`BUG_ON
(
»t
);

402  
tÙ®_added
;

403 
	}
}

405 
	$lßd_ex‹Á_Œ“_ä“
(
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
)

407 
bŒfs_block_group_ÿche
 *
block_group
 = 
ÿchšg_ùl
->block_group;

408 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

409 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

410 
bŒfs_·th
 *
·th
;

411 
ex‹Á_bufãr
 *
Ëaf
;

412 
bŒfs_key
 
key
;

413 
u64
 
tÙ®_found
 = 0;

414 
u64
 
Ï¡
 = 0;

415 
u32
 
Ä™ems
;

416 
»t
;

417 
boÞ
 
wakeup
 = 
Œue
;

419 
·th
 = 
	`bŒfs_®loc_·th
();

420 ià(!
·th
)

421  -
ENOMEM
;

423 
Ï¡
 = 
	`max_t
(
u64
, 
block_group
->
key
.
objeùid
, 
BTRFS_SUPER_INFO_OFFSET
);

425 #ifdeà
CONFIG_BTRFS_DEBUG


431 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
block_group
))

432 
wakeup
 = 
çl£
;

440 
·th
->
sk_lockšg
 = 1;

441 
·th
->
£¬ch_comm™_roÙ
 = 1;

442 
·th
->
»ada
 = 
READA_FORWARD
;

444 
key
.
objeùid
 = 
Ï¡
;

445 
key
.
off£t
 = 0;

446 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

448 
Ãxt
:

449 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

450 ià(
»t
 < 0)

451 
out
;

453 
Ëaf
 = 
·th
->
nodes
[0];

454 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

457 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
) > 1) {

458 
Ï¡
 = (
u64
)-1;

462 ià(
·th
->
¦Ùs
[0] < 
Ä™ems
) {

463 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

465 
»t
 = 
	`fšd_Ãxt_key
(
·th
, 0, &
key
);

466 ià(
»t
)

469 ià(
	`Ãed_»sched
() ||

470 
	`rw£m_is_cÚ‹nded
(&
fs_šfo
->
comm™_roÙ_£m
)) {

471 ià(
wakeup
)

472 
ÿchšg_ùl
->
´og»ss
 = 
Ï¡
;

473 
	`bŒfs_»Ëa£_·th
(
·th
);

474 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

475 
	`mu‹x_uÆock
(&
ÿchšg_ùl
->
mu‹x
);

476 
	`cÚd_»sched
();

477 
	`mu‹x_lock
(&
ÿchšg_ùl
->
mu‹x
);

478 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

479 
Ãxt
;

482 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
ex‹Á_roÙ
, 
·th
);

483 ià(
»t
 < 0)

484 
out
;

485 ià(
»t
)

487 
Ëaf
 = 
·th
->
nodes
[0];

488 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

492 ià(
key
.
objeùid
 < 
Ï¡
) {

493 
key
.
objeùid
 = 
Ï¡
;

494 
key
.
off£t
 = 0;

495 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

497 ià(
wakeup
)

498 
ÿchšg_ùl
->
´og»ss
 = 
Ï¡
;

499 
	`bŒfs_»Ëa£_·th
(
·th
);

500 
Ãxt
;

503 ià(
key
.
objeùid
 < 
block_group
->key.objectid) {

504 
·th
->
¦Ùs
[0]++;

508 ià(
key
.
objeùid
 >ð
block_group
->key.objectid +

509 
block_group
->
key
.
off£t
)

512 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 ||

513 
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
) {

514 
tÙ®_found
 +ð
	`add_Ãw_ä“_¥aû
(
block_group
,

515 
fs_šfo
, 
Ï¡
,

516 
key
.
objeùid
);

517 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

518 
Ï¡
 = 
key
.
objeùid
 +

519 
fs_šfo
->
nodesize
;

521 
Ï¡
 = 
key
.
objeùid
 + key.
off£t
;

523 ià(
tÙ®_found
 > 
CACHING_CTL_WAKE_UP
) {

524 
tÙ®_found
 = 0;

525 ià(
wakeup
)

526 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

529 
·th
->
¦Ùs
[0]++;

531 
»t
 = 0;

533 
tÙ®_found
 +ð
	`add_Ãw_ä“_¥aû
(
block_group
, 
fs_šfo
, 
Ï¡
,

534 
block_group
->
key
.
objeùid
 +

535 
block_group
->
key
.
off£t
);

536 
ÿchšg_ùl
->
´og»ss
 = (
u64
)-1;

538 
out
:

539 
	`bŒfs_ä“_·th
(
·th
);

540  
»t
;

541 
	}
}

543 
nošlše
 
	$ÿchšg_th»ad
(
bŒfs_wÜk
 *
wÜk
)

545 
bŒfs_block_group_ÿche
 *
block_group
;

546 
bŒfs_fs_šfo
 *
fs_šfo
;

547 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

548 
bŒfs_roÙ
 *
ex‹Á_roÙ
;

549 
»t
;

551 
ÿchšg_ùl
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_ÿchšg_cÚŒÞ
, work);

552 
block_group
 = 
ÿchšg_ùl
->block_group;

553 
fs_šfo
 = 
block_group
->fs_info;

554 
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

556 
	`mu‹x_lock
(&
ÿchšg_ùl
->
mu‹x
);

557 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

559 ià(
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

560 
»t
 = 
	`lßd_ä“_¥aû_Œ“
(
ÿchšg_ùl
);

562 
»t
 = 
	`lßd_ex‹Á_Œ“_ä“
(
ÿchšg_ùl
);

564 
	`¥š_lock
(&
block_group
->
lock
);

565 
block_group
->
ÿchšg_ùl
 = 
NULL
;

566 
block_group
->
ÿched
 = 
»t
 ? 
BTRFS_CACHE_ERROR
 : 
BTRFS_CACHE_FINISHED
;

567 
	`¥š_uÆock
(&
block_group
->
lock
);

569 #ifdeà
CONFIG_BTRFS_DEBUG


570 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
block_group
)) {

571 
u64
 
by‹s_u£d
;

573 
	`¥š_lock
(&
block_group
->
¥aû_šfo
->
lock
);

574 
	`¥š_lock
(&
block_group
->
lock
);

575 
by‹s_u£d
 = 
block_group
->
key
.
off£t
 -

576 
	`bŒfs_block_group_u£d
(&
block_group
->
™em
);

577 
block_group
->
¥aû_šfo
->
by‹s_u£d
 += bytes_used >> 1;

578 
	`¥š_uÆock
(&
block_group
->
lock
);

579 
	`¥š_uÆock
(&
block_group
->
¥aû_šfo
->
lock
);

580 
	`äagm’t_ä“_¥aû
(
block_group
);

584 
ÿchšg_ùl
->
´og»ss
 = (
u64
)-1;

586 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

587 
	`ä“_exþuded_ex‹Ás
(
fs_šfo
, 
block_group
);

588 
	`mu‹x_uÆock
(&
ÿchšg_ùl
->
mu‹x
);

590 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

592 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

593 
	`bŒfs_put_block_group
(
block_group
);

594 
	}
}

596 
	$ÿche_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
,

597 
lßd_ÿche_Úly
)

599 
	`DEFINE_WAIT
(
wa™
);

600 
bŒfs_fs_šfo
 *
fs_šfo
 = 
ÿche
->fs_info;

601 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

602 
»t
 = 0;

604 
ÿchšg_ùl
 = 
	`kz®loc
((*ÿchšg_ùl), 
GFP_NOFS
);

605 ià(!
ÿchšg_ùl
)

606  -
ENOMEM
;

608 
	`INIT_LIST_HEAD
(&
ÿchšg_ùl
->
li¡
);

609 
	`mu‹x_š™
(&
ÿchšg_ùl
->
mu‹x
);

610 
	`š™_wa™queue_h—d
(&
ÿchšg_ùl
->
wa™
);

611 
ÿchšg_ùl
->
block_group
 = 
ÿche
;

612 
ÿchšg_ùl
->
´og»ss
 = 
ÿche
->
key
.
objeùid
;

613 
	`»fcouÁ_£t
(&
ÿchšg_ùl
->
couÁ
, 1);

614 
	`bŒfs_š™_wÜk
(&
ÿchšg_ùl
->
wÜk
, 
bŒfs_ÿche_h–³r
,

615 
ÿchšg_th»ad
, 
NULL
, NULL);

617 
	`¥š_lock
(&
ÿche
->
lock
);

630 
ÿche
->
ÿched
 =ð
BTRFS_CACHE_FAST
) {

631 
bŒfs_ÿchšg_cÚŒÞ
 *
ùl
;

633 
ùl
 = 
ÿche
->
ÿchšg_ùl
;

634 
	`»fcouÁ_šc
(&
ùl
->
couÁ
);

635 
	`´•¬e_to_wa™
(&
ùl
->
wa™
, &wa™, 
TASK_UNINTERRUPTIBLE
);

636 
	`¥š_uÆock
(&
ÿche
->
lock
);

638 
	`scheduË
();

640 
	`fšish_wa™
(&
ùl
->
wa™
, &wait);

641 
	`put_ÿchšg_cÚŒÞ
(
ùl
);

642 
	`¥š_lock
(&
ÿche
->
lock
);

645 ià(
ÿche
->
ÿched
 !ð
BTRFS_CACHE_NO
) {

646 
	`¥š_uÆock
(&
ÿche
->
lock
);

647 
	`kä“
(
ÿchšg_ùl
);

650 
	`WARN_ON
(
ÿche
->
ÿchšg_ùl
);

651 
ÿche
->
ÿchšg_ùl
 = caching_ctl;

652 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FAST
;

653 
	`¥š_uÆock
(&
ÿche
->
lock
);

655 ià(
fs_šfo
->
mouÁ_Ýt
 & 
BTRFS_MOUNT_SPACE_CACHE
) {

656 
	`mu‹x_lock
(&
ÿchšg_ùl
->
mu‹x
);

657 
»t
 = 
	`lßd_ä“_¥aû_ÿche
(
fs_šfo
, 
ÿche
);

659 
	`¥š_lock
(&
ÿche
->
lock
);

660 ià(
»t
 == 1) {

661 
ÿche
->
ÿchšg_ùl
 = 
NULL
;

662 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

663 
ÿche
->
Ï¡_by‹_to_uÅš
 = (
u64
)-1;

664 
ÿchšg_ùl
->
´og»ss
 = (
u64
)-1;

666 ià(
lßd_ÿche_Úly
) {

667 
ÿche
->
ÿchšg_ùl
 = 
NULL
;

668 
ÿche
->
ÿched
 = 
BTRFS_CACHE_NO
;

670 
ÿche
->
ÿched
 = 
BTRFS_CACHE_STARTED
;

671 
ÿche
->
has_ÿchšg_ùl
 = 1;

674 
	`¥š_uÆock
(&
ÿche
->
lock
);

675 #ifdeà
CONFIG_BTRFS_DEBUG


676 ià(
»t
 == 1 &&

677 
	`bŒfs_should_äagm’t_ä“_¥aû
(
ÿche
)) {

678 
u64
 
by‹s_u£d
;

680 
	`¥š_lock
(&
ÿche
->
¥aû_šfo
->
lock
);

681 
	`¥š_lock
(&
ÿche
->
lock
);

682 
by‹s_u£d
 = 
ÿche
->
key
.
off£t
 -

683 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
);

684 
ÿche
->
¥aû_šfo
->
by‹s_u£d
 += bytes_used >> 1;

685 
	`¥š_uÆock
(&
ÿche
->
lock
);

686 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

687 
	`äagm’t_ä“_¥aû
(
ÿche
);

690 
	`mu‹x_uÆock
(&
ÿchšg_ùl
->
mu‹x
);

692 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

693 ià(
»t
 == 1) {

694 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

695 
	`ä“_exþuded_ex‹Ás
(
fs_šfo
, 
ÿche
);

703 
	`¥š_lock
(&
ÿche
->
lock
);

704 ià(
lßd_ÿche_Úly
) {

705 
ÿche
->
ÿchšg_ùl
 = 
NULL
;

706 
ÿche
->
ÿched
 = 
BTRFS_CACHE_NO
;

708 
ÿche
->
ÿched
 = 
BTRFS_CACHE_STARTED
;

709 
ÿche
->
has_ÿchšg_ùl
 = 1;

711 
	`¥š_uÆock
(&
ÿche
->
lock
);

712 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

715 ià(
lßd_ÿche_Úly
) {

716 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

720 
	`down_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

721 
	`»fcouÁ_šc
(&
ÿchšg_ùl
->
couÁ
);

722 
	`li¡_add_ž
(&
ÿchšg_ùl
->
li¡
, &
fs_šfo
->
ÿchšg_block_groups
);

723 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

725 
	`bŒfs_g‘_block_group
(
ÿche
);

727 
	`bŒfs_queue_wÜk
(
fs_šfo
->
ÿchšg_wÜk”s
, &
ÿchšg_ùl
->
wÜk
);

729  
»t
;

730 
	}
}

735 
bŒfs_block_group_ÿche
 *

736 
	$bŒfs_lookup_fœ¡_block_group
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
)

738  
	`block_group_ÿche_Œ“_£¬ch
(
šfo
, 
by‹Ä
, 0);

739 
	}
}

744 
bŒfs_block_group_ÿche
 *
	$bŒfs_lookup_block_group
(

745 
bŒfs_fs_šfo
 *
šfo
,

746 
u64
 
by‹Ä
)

748  
	`block_group_ÿche_Œ“_£¬ch
(
šfo
, 
by‹Ä
, 1);

749 
	}
}

751 
bŒfs_¥aû_šfo
 *
	$__fšd_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
,

752 
u64
 
æags
)

754 
li¡_h—d
 *
h—d
 = &
šfo
->
¥aû_šfo
;

755 
bŒfs_¥aû_šfo
 *
found
;

757 
æags
 &ð
BTRFS_BLOCK_GROUP_TYPE_MASK
;

759 
	`rcu_»ad_lock
();

760 
	`li¡_fÜ_—ch_’Œy_rcu
(
found
, 
h—d
, 
li¡
) {

761 ià(
found
->
æags
 & flags) {

762 
	`rcu_»ad_uÆock
();

763  
found
;

766 
	`rcu_»ad_uÆock
();

767  
NULL
;

768 
	}
}

770 
	$add_pšÃd_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
s64
 
num_by‹s
,

771 
u64
 
owÃr
, u64 
roÙ_objeùid
)

773 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

774 
u64
 
æags
;

776 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

777 ià(
roÙ_objeùid
 =ð
BTRFS_CHUNK_TREE_OBJECTID
)

778 
æags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

780 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

782 
æags
 = 
BTRFS_BLOCK_GROUP_DATA
;

785 
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
æags
);

786 
	`ASSERT
(
¥aû_šfo
);

787 
	`³rýu_couÁ”_add
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
, 
num_by‹s
);

788 
	}
}

794 
	$bŒfs_þ—r_¥aû_šfo_fuÎ
(
bŒfs_fs_šfo
 *
šfo
)

796 
li¡_h—d
 *
h—d
 = &
šfo
->
¥aû_šfo
;

797 
bŒfs_¥aû_šfo
 *
found
;

799 
	`rcu_»ad_lock
();

800 
	`li¡_fÜ_—ch_’Œy_rcu
(
found
, 
h—d
, 
li¡
)

801 
found
->
fuÎ
 = 0;

802 
	`rcu_»ad_uÆock
();

803 
	}
}

806 
	$bŒfs_lookup_d©a_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
Ën
)

808 
»t
;

809 
bŒfs_key
 
key
;

810 
bŒfs_·th
 *
·th
;

812 
·th
 = 
	`bŒfs_®loc_·th
();

813 ià(!
·th
)

814  -
ENOMEM
;

816 
key
.
objeùid
 = 
¡¬t
;

817 
key
.
off£t
 = 
Ën
;

818 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

819 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

820 
	`bŒfs_ä“_·th
(
·th
);

821  
»t
;

822 
	}
}

833 
	$bŒfs_lookup_ex‹Á_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

834 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

835 
u64
 
off£t
, 
m‘ad©a
, u64 *
»fs
, u64 *
æags
)

837 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

838 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

839 
bŒfs_·th
 *
·th
;

840 
bŒfs_ex‹Á_™em
 *
ei
;

841 
ex‹Á_bufãr
 *
Ëaf
;

842 
bŒfs_key
 
key
;

843 
u32
 
™em_size
;

844 
u64
 
num_»fs
;

845 
u64
 
ex‹Á_æags
;

846 
»t
;

852 ià(
m‘ad©a
 && !
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
)) {

853 
off£t
 = 
fs_šfo
->
nodesize
;

854 
m‘ad©a
 = 0;

857 
·th
 = 
	`bŒfs_®loc_·th
();

858 ià(!
·th
)

859  -
ENOMEM
;

861 ià(!
Œªs
) {

862 
·th
->
sk_lockšg
 = 1;

863 
·th
->
£¬ch_comm™_roÙ
 = 1;

866 
£¬ch_agaš
:

867 
key
.
objeùid
 = 
by‹Ä
;

868 
key
.
off£t
 = offset;

869 ià(
m‘ad©a
)

870 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

872 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

874 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

875 ià(
»t
 < 0)

876 
out_ä“
;

878 ià(
»t
 > 0 && 
m‘ad©a
 && 
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
) {

879 ià(
·th
->
¦Ùs
[0]) {

880 
·th
->
¦Ùs
[0]--;

881 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

882 
·th
->
¦Ùs
[0]);

883 ià(
key
.
objeùid
 =ð
by‹Ä
 &&

884 
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

885 
key
.
off£t
 =ð
fs_šfo
->
nodesize
)

886 
»t
 = 0;

890 ià(
»t
 == 0) {

891 
Ëaf
 = 
·th
->
nodes
[0];

892 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

893 ià(
™em_size
 >ð(*
ei
)) {

894 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

895 
bŒfs_ex‹Á_™em
);

896 
num_»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

897 
ex‹Á_æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

899 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


900 
bŒfs_ex‹Á_™em_v0
 *
ei0
;

901 
	`BUG_ON
(
™em_size
 !ð(*
ei0
));

902 
ei0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

903 
bŒfs_ex‹Á_™em_v0
);

904 
num_»fs
 = 
	`bŒfs_ex‹Á_»fs_v0
(
Ëaf
, 
ei0
);

906 
ex‹Á_æags
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

908 
	`BUG
();

911 
	`BUG_ON
(
num_»fs
 == 0);

913 
num_»fs
 = 0;

914 
ex‹Á_æags
 = 0;

915 
»t
 = 0;

918 ià(!
Œªs
)

919 
out
;

921 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

922 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

923 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

924 ià(
h—d
) {

925 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

926 
	`»fcouÁ_šc
(&
h—d
->
node
.
»fs
);

927 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

929 
	`bŒfs_»Ëa£_·th
(
·th
);

935 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

936 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

937 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

938 
£¬ch_agaš
;

940 
	`¥š_lock
(&
h—d
->
lock
);

941 ià(
h—d
->
ex‹Á_Ý
 && h—d->ex‹Á_Ý->
upd©e_æags
)

942 
ex‹Á_æags
 |ð
h—d
->
ex‹Á_Ý
->
æags_to_£t
;

944 
	`BUG_ON
(
num_»fs
 == 0);

946 
num_»fs
 +ð
h—d
->
node
.
»f_mod
;

947 
	`¥š_uÆock
(&
h—d
->
lock
);

948 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

950 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

951 
out
:

952 
	`WARN_ON
(
num_»fs
 == 0);

953 ià(
»fs
)

954 *
»fs
 = 
num_»fs
;

955 ià(
æags
)

956 *
æags
 = 
ex‹Á_æags
;

957 
out_ä“
:

958 
	`bŒfs_ä“_·th
(
·th
);

959  
»t
;

960 
	}
}

1068 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1069 
	$cÚv”t_ex‹Á_™em_v0
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1070 
bŒfs_fs_šfo
 *
fs_šfo
,

1071 
bŒfs_·th
 *
·th
,

1072 
u64
 
owÃr
, 
u32
 
exŒa_size
)

1074 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

1075 
bŒfs_ex‹Á_™em
 *
™em
;

1076 
bŒfs_ex‹Á_™em_v0
 *
ei0
;

1077 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

1078 
bŒfs_Œ“_block_šfo
 *
bi
;

1079 
ex‹Á_bufãr
 *
Ëaf
;

1080 
bŒfs_key
 
key
;

1081 
bŒfs_key
 
found_key
;

1082 
u32
 
Ãw_size
 = (*
™em
);

1083 
u64
 
»fs
;

1084 
»t
;

1086 
Ëaf
 = 
·th
->
nodes
[0];

1087 
	`BUG_ON
(
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]è!ð(*
ei0
));

1089 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1090 
ei0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1091 
bŒfs_ex‹Á_™em_v0
);

1092 
»fs
 = 
	`bŒfs_ex‹Á_»fs_v0
(
Ëaf
, 
ei0
);

1094 ià(
owÃr
 =ð(
u64
)-1) {

1096 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

1097 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1098 ià(
»t
 < 0)

1099  
»t
;

1100 
	`BUG_ON
(
»t
 > 0);

1101 
Ëaf
 = 
·th
->
nodes
[0];

1103 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
,

1104 
·th
->
¦Ùs
[0]);

1105 
	`BUG_ON
(
key
.
objeùid
 !ð
found_key
.objectid);

1106 ià(
found_key
.
ty³
 !ð
BTRFS_EXTENT_REF_V0_KEY
) {

1107 
·th
->
¦Ùs
[0]++;

1110 
»f0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1111 
bŒfs_ex‹Á_»f_v0
);

1112 
owÃr
 = 
	`bŒfs_»f_objeùid_v0
(
Ëaf
, 
»f0
);

1116 
	`bŒfs_»Ëa£_·th
(
·th
);

1118 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
)

1119 
Ãw_size
 +ð(*
bi
);

1121 
Ãw_size
 -ð(*
ei0
);

1122 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
,

1123 
Ãw_size
 + 
exŒa_size
, 1);

1124 ià(
»t
 < 0)

1125  
»t
;

1126 
	`BUG_ON
(
»t
);

1128 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, 
Ãw_size
);

1130 
Ëaf
 = 
·th
->
nodes
[0];

1131 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1132 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
™em
, 
»fs
);

1134 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
™em
, 0);

1135 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1136 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
™em
,

1137 
BTRFS_EXTENT_FLAG_TREE_BLOCK
 |

1138 
BTRFS_BLOCK_FLAG_FULL_BACKREF
);

1139 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
™em
 + 1);

1141 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
bi
, (*bi));

1142 
	`bŒfs_£t_Œ“_block_Ëv–
(
Ëaf
, 
bi
, ()
owÃr
);

1144 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
™em
, 
BTRFS_EXTENT_FLAG_DATA
);

1146 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1148 
	}
}

1156 
	$bŒfs_g‘_ex‹Á_šlše_»f_ty³
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

1157 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

1158 
bŒfs_šlše_»f_ty³
 
is_d©a
)

1160 
ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
);

1161 
u64
 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

1163 ià(
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

1164 
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
 ||

1165 
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
 ||

1166 
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1167 ià(
is_d©a
 =ð
BTRFS_REF_TYPE_BLOCK
) {

1168 ià(
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
)

1169  
ty³
;

1170 ià(
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
) {

1171 
	`ASSERT
(
eb
->
fs_šfo
);

1177 ià(
off£t
 &&

1178 
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
nodesize
))

1179  
ty³
;

1181 } ià(
is_d©a
 =ð
BTRFS_REF_TYPE_DATA
) {

1182 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
)

1183  
ty³
;

1184 ià(
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

1185 
	`ASSERT
(
eb
->
fs_šfo
);

1191 ià(
off£t
 &&

1192 
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
nodesize
))

1193  
ty³
;

1196 
	`ASSERT
(
is_d©a
 =ð
BTRFS_REF_TYPE_ANY
);

1197  
ty³
;

1201 
	`bŒfs_´št_Ëaf
((
ex‹Á_bufãr
 *)
eb
);

1202 
	`bŒfs_”r
(
eb
->
fs_šfo
, "eb %llu invalidƒxtent inline„efype %d",

1203 
eb
->
¡¬t
, 
ty³
);

1204 
	`WARN_ON
(1);

1206  
BTRFS_REF_TYPE_INVALID
;

1207 
	}
}

1209 
u64
 
	$hash_ex‹Á_d©a_»f
(
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

1211 
u32
 
high_üc
 = ~(u32)0;

1212 
u32
 
low_üc
 = ~(u32)0;

1213 
__Ë64
 
Ënum
;

1215 
Ënum
 = 
	`ýu_to_Ë64
(
roÙ_objeùid
);

1216 
high_üc
 = 
	`bŒfs_üc32c
(high_üc, &
Ënum
, (lenum));

1217 
Ënum
 = 
	`ýu_to_Ë64
(
owÃr
);

1218 
low_üc
 = 
	`bŒfs_üc32c
Öow_üc, &
Ënum
, (lenum));

1219 
Ënum
 = 
	`ýu_to_Ë64
(
off£t
);

1220 
low_üc
 = 
	`bŒfs_üc32c
Öow_üc, &
Ënum
, (lenum));

1222  ((
u64
)
high_üc
 << 31è^ (u64)
low_üc
;

1223 
	}
}

1225 
u64
 
	$hash_ex‹Á_d©a_»f_™em
(
ex‹Á_bufãr
 *
Ëaf
,

1226 
bŒfs_ex‹Á_d©a_»f
 *
»f
)

1228  
	`hash_ex‹Á_d©a_»f
(
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
),

1229 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
),

1230 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
));

1231 
	}
}

1233 
	$m©ch_ex‹Á_d©a_»f
(
ex‹Á_bufãr
 *
Ëaf
,

1234 
bŒfs_ex‹Á_d©a_»f
 *
»f
,

1235 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

1237 ià(
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
è!ð
roÙ_objeùid
 ||

1238 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
è!ð
owÃr
 ||

1239 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
è!ð
off£t
)

1242 
	}
}

1244 
nošlše
 
	$lookup_ex‹Á_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1245 
bŒfs_fs_šfo
 *
fs_šfo
,

1246 
bŒfs_·th
 *
·th
,

1247 
u64
 
by‹Ä
, u64 
·»Á
,

1248 
u64
 
roÙ_objeùid
,

1249 
u64
 
owÃr
, u64 
off£t
)

1251 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

1252 
bŒfs_key
 
key
;

1253 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

1254 
ex‹Á_bufãr
 *
Ëaf
;

1255 
u32
 
Ä™ems
;

1256 
»t
;

1257 
»cow
;

1258 
”r
 = -
ENOENT
;

1260 
key
.
objeùid
 = 
by‹Ä
;

1261 ià(
·»Á
) {

1262 
key
.
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

1263 
key
.
off£t
 = 
·»Á
;

1265 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

1266 
key
.
off£t
 = 
	`hash_ex‹Á_d©a_»f
(
roÙ_objeùid
,

1267 
owÃr
, 
off£t
);

1269 
agaš
:

1270 
»cow
 = 0;

1271 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1272 ià(
»t
 < 0) {

1273 
”r
 = 
»t
;

1274 
çž
;

1277 ià(
·»Á
) {

1278 ià(!
»t
)

1280 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1281 
key
.
ty³
 = 
BTRFS_EXTENT_REF_V0_KEY
;

1282 
	`bŒfs_»Ëa£_·th
(
·th
);

1283 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1284 ià(
»t
 < 0) {

1285 
”r
 = 
»t
;

1286 
çž
;

1288 ià(!
»t
)

1291 
çž
;

1294 
Ëaf
 = 
·th
->
nodes
[0];

1295 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1297 ià(
·th
->
¦Ùs
[0] >ð
Ä™ems
) {

1298 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1299 ià(
»t
 < 0)

1300 
”r
 = 
»t
;

1301 ià(
»t
)

1302 
çž
;

1304 
Ëaf
 = 
·th
->
nodes
[0];

1305 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1306 
»cow
 = 1;

1309 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1310 ià(
key
.
objeùid
 !ð
by‹Ä
 ||

1311 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_REF_KEY
)

1312 
çž
;

1314 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1315 
bŒfs_ex‹Á_d©a_»f
);

1317 ià(
	`m©ch_ex‹Á_d©a_»f
(
Ëaf
, 
»f
, 
roÙ_objeùid
,

1318 
owÃr
, 
off£t
)) {

1319 ià(
»cow
) {

1320 
	`bŒfs_»Ëa£_·th
(
·th
);

1321 
agaš
;

1323 
”r
 = 0;

1326 
·th
->
¦Ùs
[0]++;

1328 
çž
:

1329  
”r
;

1330 
	}
}

1332 
nošlše
 
	$š£¹_ex‹Á_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1333 
bŒfs_fs_šfo
 *
fs_šfo
,

1334 
bŒfs_·th
 *
·th
,

1335 
u64
 
by‹Ä
, u64 
·»Á
,

1336 
u64
 
roÙ_objeùid
, u64 
owÃr
,

1337 
u64
 
off£t
, 
»fs_to_add
)

1339 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

1340 
bŒfs_key
 
key
;

1341 
ex‹Á_bufãr
 *
Ëaf
;

1342 
u32
 
size
;

1343 
u32
 
num_»fs
;

1344 
»t
;

1346 
key
.
objeùid
 = 
by‹Ä
;

1347 ià(
·»Á
) {

1348 
key
.
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

1349 
key
.
off£t
 = 
·»Á
;

1350 
size
 = (
bŒfs_sh¬ed_d©a_»f
);

1352 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

1353 
key
.
off£t
 = 
	`hash_ex‹Á_d©a_»f
(
roÙ_objeùid
,

1354 
owÃr
, 
off£t
);

1355 
size
 = (
bŒfs_ex‹Á_d©a_»f
);

1358 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
size
);

1359 ià(
»t
 &&„‘ !ð-
EEXIST
)

1360 
çž
;

1362 
Ëaf
 = 
·th
->
nodes
[0];

1363 ià(
·»Á
) {

1364 
bŒfs_sh¬ed_d©a_»f
 *
»f
;

1365 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1366 
bŒfs_sh¬ed_d©a_»f
);

1367 ià(
»t
 == 0) {

1368 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»fs_to_add
);

1370 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
);

1371 
num_»fs
 +ð
»fs_to_add
;

1372 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
num_»fs
);

1375 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

1376 
»t
 =ð-
EEXIST
) {

1377 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1378 
bŒfs_ex‹Á_d©a_»f
);

1379 ià(
	`m©ch_ex‹Á_d©a_»f
(
Ëaf
, 
»f
, 
roÙ_objeùid
,

1380 
owÃr
, 
off£t
))

1382 
	`bŒfs_»Ëa£_·th
(
·th
);

1383 
key
.
off£t
++;

1384 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

1385 
size
);

1386 ià(
»t
 &&„‘ !ð-
EEXIST
)

1387 
çž
;

1389 
Ëaf
 = 
·th
->
nodes
[0];

1391 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1392 
bŒfs_ex‹Á_d©a_»f
);

1393 ià(
»t
 == 0) {

1394 
	`bŒfs_£t_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
,

1395 
roÙ_objeùid
);

1396 
	`bŒfs_£t_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
, 
owÃr
);

1397 
	`bŒfs_£t_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
, 
off£t
);

1398 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»fs_to_add
);

1400 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
);

1401 
num_»fs
 +ð
»fs_to_add
;

1402 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
num_»fs
);

1405 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1406 
»t
 = 0;

1407 
çž
:

1408 
	`bŒfs_»Ëa£_·th
(
·th
);

1409  
»t
;

1410 
	}
}

1412 
nošlše
 
	$»move_ex‹Á_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1413 
bŒfs_fs_šfo
 *
fs_šfo
,

1414 
bŒfs_·th
 *
·th
,

1415 
»fs_to_drÝ
, *
Ï¡_»f
)

1417 
bŒfs_key
 
key
;

1418 
bŒfs_ex‹Á_d©a_»f
 *
»f1
 = 
NULL
;

1419 
bŒfs_sh¬ed_d©a_»f
 *
»f2
 = 
NULL
;

1420 
ex‹Á_bufãr
 *
Ëaf
;

1421 
u32
 
num_»fs
 = 0;

1422 
»t
 = 0;

1424 
Ëaf
 = 
·th
->
nodes
[0];

1425 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1427 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1428 
»f1
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1429 
bŒfs_ex‹Á_d©a_»f
);

1430 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
);

1431 } ià(
key
.
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

1432 
»f2
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1433 
bŒfs_sh¬ed_d©a_»f
);

1434 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
);

1435 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1436 } ià(
key
.
ty³
 =ð
BTRFS_EXTENT_REF_V0_KEY
) {

1437 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

1438 
»f0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1439 
bŒfs_ex‹Á_»f_v0
);

1440 
num_»fs
 = 
	`bŒfs_»f_couÁ_v0
(
Ëaf
, 
»f0
);

1443 
	`BUG
();

1446 
	`BUG_ON
(
num_»fs
 < 
»fs_to_drÝ
);

1447 
num_»fs
 -ð
»fs_to_drÝ
;

1449 ià(
num_»fs
 == 0) {

1450 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, 
·th
);

1451 *
Ï¡_»f
 = 1;

1453 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
)

1454 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
, 
num_»fs
);

1455 ià(
key
.
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
)

1456 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
, 
num_»fs
);

1457 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1459 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

1460 
»f0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1461 
bŒfs_ex‹Á_»f_v0
);

1462 
	`bŒfs_£t_»f_couÁ_v0
(
Ëaf
, 
»f0
, 
num_»fs
);

1465 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1467  
»t
;

1468 
	}
}

1470 
nošlše
 
u32
 
	$ex‹Á_d©a_»f_couÁ
(
bŒfs_·th
 *
·th
,

1471 
bŒfs_ex‹Á_šlše_»f
 *
œef
)

1473 
bŒfs_key
 
key
;

1474 
ex‹Á_bufãr
 *
Ëaf
;

1475 
bŒfs_ex‹Á_d©a_»f
 *
»f1
;

1476 
bŒfs_sh¬ed_d©a_»f
 *
»f2
;

1477 
u32
 
num_»fs
 = 0;

1478 
ty³
;

1480 
Ëaf
 = 
·th
->
nodes
[0];

1481 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1482 ià(
œef
) {

1487 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_REF_TYPE_DATA
);

1488 
	`ASSERT
(
ty³
 !ð
BTRFS_REF_TYPE_INVALID
);

1489 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1490 
»f1
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1491 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
);

1493 
»f2
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1494 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
);

1496 } ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1497 
»f1
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1498 
bŒfs_ex‹Á_d©a_»f
);

1499 
num_»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f1
);

1500 } ià(
key
.
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

1501 
»f2
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1502 
bŒfs_sh¬ed_d©a_»f
);

1503 
num_»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f2
);

1504 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1505 } ià(
key
.
ty³
 =ð
BTRFS_EXTENT_REF_V0_KEY
) {

1506 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

1507 
»f0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1508 
bŒfs_ex‹Á_»f_v0
);

1509 
num_»fs
 = 
	`bŒfs_»f_couÁ_v0
(
Ëaf
, 
»f0
);

1512 
	`WARN_ON
(1);

1514  
num_»fs
;

1515 
	}
}

1517 
nošlše
 
	$lookup_Œ“_block_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1518 
bŒfs_fs_šfo
 *
fs_šfo
,

1519 
bŒfs_·th
 *
·th
,

1520 
u64
 
by‹Ä
, u64 
·»Á
,

1521 
u64
 
roÙ_objeùid
)

1523 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

1524 
bŒfs_key
 
key
;

1525 
»t
;

1527 
key
.
objeùid
 = 
by‹Ä
;

1528 ià(
·»Á
) {

1529 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

1530 
key
.
off£t
 = 
·»Á
;

1532 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

1533 
key
.
off£t
 = 
roÙ_objeùid
;

1536 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1537 ià(
»t
 > 0)

1538 
»t
 = -
ENOENT
;

1539 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1540 ià(
»t
 =ð-
ENOENT
 && 
·»Á
) {

1541 
	`bŒfs_»Ëa£_·th
(
·th
);

1542 
key
.
ty³
 = 
BTRFS_EXTENT_REF_V0_KEY
;

1543 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1544 ià(
»t
 > 0)

1545 
»t
 = -
ENOENT
;

1548  
»t
;

1549 
	}
}

1551 
nošlše
 
	$š£¹_Œ“_block_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1552 
bŒfs_fs_šfo
 *
fs_šfo
,

1553 
bŒfs_·th
 *
·th
,

1554 
u64
 
by‹Ä
, u64 
·»Á
,

1555 
u64
 
roÙ_objeùid
)

1557 
bŒfs_key
 
key
;

1558 
»t
;

1560 
key
.
objeùid
 = 
by‹Ä
;

1561 ià(
·»Á
) {

1562 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

1563 
key
.
off£t
 = 
·»Á
;

1565 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

1566 
key
.
off£t
 = 
roÙ_objeùid
;

1569 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
,

1570 
·th
, &
key
, 0);

1571 
	`bŒfs_»Ëa£_·th
(
·th
);

1572  
»t
;

1573 
	}
}

1575 
šlše
 
	$ex‹Á_»f_ty³
(
u64
 
·»Á
, u64 
owÃr
)

1577 
ty³
;

1578 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1579 ià(
·»Á
 > 0)

1580 
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

1582 
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

1584 ià(
·»Á
 > 0)

1585 
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

1587 
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

1589  
ty³
;

1590 
	}
}

1592 
	$fšd_Ãxt_key
(
bŒfs_·th
 *
·th
, 
Ëv–
,

1593 
bŒfs_key
 *
key
)

1596 ; 
Ëv–
 < 
BTRFS_MAX_LEVEL
;†evel++) {

1597 ià(!
·th
->
nodes
[
Ëv–
])

1599 ià(
·th
->
¦Ùs
[
Ëv–
] + 1 >=

1600 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
]))

1602 ià(
Ëv–
 == 0)

1603 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[
Ëv–
], 
key
,

1604 
·th
->
¦Ùs
[
Ëv–
] + 1);

1606 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
Ëv–
], 
key
,

1607 
·th
->
¦Ùs
[
Ëv–
] + 1);

1611 
	}
}

1626 
nošlše_fÜ_¡ack


1627 
	$lookup_šlše_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1628 
bŒfs_fs_šfo
 *
fs_šfo
,

1629 
bŒfs_·th
 *
·th
,

1630 
bŒfs_ex‹Á_šlše_»f
 **
»f_»t
,

1631 
u64
 
by‹Ä
, u64 
num_by‹s
,

1632 
u64
 
·»Á
, u64 
roÙ_objeùid
,

1633 
u64
 
owÃr
, u64 
off£t
, 
š£¹
)

1635 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

1636 
bŒfs_key
 
key
;

1637 
ex‹Á_bufãr
 *
Ëaf
;

1638 
bŒfs_ex‹Á_™em
 *
ei
;

1639 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

1640 
u64
 
æags
;

1641 
u64
 
™em_size
;

1642 
±r
;

1643 
’d
;

1644 
exŒa_size
;

1645 
ty³
;

1646 
wªt
;

1647 
»t
;

1648 
”r
 = 0;

1649 
boÞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

1650 
Ãeded
;

1652 
key
.
objeùid
 = 
by‹Ä
;

1653 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1654 
key
.
off£t
 = 
num_by‹s
;

1656 
wªt
 = 
	`ex‹Á_»f_ty³
(
·»Á
, 
owÃr
);

1657 ià(
š£¹
) {

1658 
exŒa_size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
wªt
);

1659 
·th
->
k“p_locks
 = 1;

1661 
exŒa_size
 = -1;

1667 ià(
skšny_m‘ad©a
 && 
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1668 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

1669 
key
.
off£t
 = 
owÃr
;

1672 
agaš
:

1673 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
exŒa_size
, 1);

1674 ià(
»t
 < 0) {

1675 
”r
 = 
»t
;

1676 
out
;

1683 ià(
»t
 > 0 && 
skšny_m‘ad©a
) {

1684 
skšny_m‘ad©a
 = 
çl£
;

1685 ià(
·th
->
¦Ùs
[0]) {

1686 
·th
->
¦Ùs
[0]--;

1687 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

1688 
·th
->
¦Ùs
[0]);

1689 ià(
key
.
objeùid
 =ð
by‹Ä
 &&

1690 
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

1691 
key
.
off£t
 =ð
num_by‹s
)

1692 
»t
 = 0;

1694 ià(
»t
) {

1695 
key
.
objeùid
 = 
by‹Ä
;

1696 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1697 
key
.
off£t
 = 
num_by‹s
;

1698 
	`bŒfs_»Ëa£_·th
(
·th
);

1699 
agaš
;

1703 ià(
»t
 && !
š£¹
) {

1704 
”r
 = -
ENOENT
;

1705 
out
;

1706 } ià(
	`WARN_ON
(
»t
)) {

1707 
”r
 = -
EIO
;

1708 
out
;

1711 
Ëaf
 = 
·th
->
nodes
[0];

1712 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1713 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


1714 ià(
™em_size
 < (*
ei
)) {

1715 ià(!
š£¹
) {

1716 
”r
 = -
ENOENT
;

1717 
out
;

1719 
»t
 = 
	`cÚv”t_ex‹Á_™em_v0
(
Œªs
, 
fs_šfo
, 
·th
, 
owÃr
,

1720 
exŒa_size
);

1721 ià(
»t
 < 0) {

1722 
”r
 = 
»t
;

1723 
out
;

1725 
Ëaf
 = 
·th
->
nodes
[0];

1726 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1729 
	`BUG_ON
(
™em_size
 < (*
ei
));

1731 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1732 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

1734 
±r
 = ()(
ei
 + 1);

1735 
’d
 = ()
ei
 + 
™em_size
;

1737 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
 && !
skšny_m‘ad©a
) {

1738 
±r
 +ð(
bŒfs_Œ“_block_šfo
);

1739 
	`BUG_ON
(
±r
 > 
’d
);

1742 ià(
owÃr
 >ð
BTRFS_FIRST_FREE_OBJECTID
)

1743 
Ãeded
 = 
BTRFS_REF_TYPE_DATA
;

1745 
Ãeded
 = 
BTRFS_REF_TYPE_BLOCK
;

1747 
”r
 = -
ENOENT
;

1749 ià(
±r
 >ð
’d
) {

1750 
	`WARN_ON
(
±r
 > 
’d
);

1753 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

1754 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
Ãeded
);

1755 ià(
ty³
 =ð
BTRFS_REF_TYPE_INVALID
) {

1756 
”r
 = -
EINVAL
;

1757 
out
;

1760 ià(
wªt
 < 
ty³
)

1762 ià(
wªt
 > 
ty³
) {

1763 
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1767 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1768 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1769 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1770 ià(
	`m©ch_ex‹Á_d©a_»f
(
Ëaf
, 
d»f
, 
roÙ_objeùid
,

1771 
owÃr
, 
off£t
)) {

1772 
”r
 = 0;

1775 ià(
	`hash_ex‹Á_d©a_»f_™em
(
Ëaf
, 
d»f
) <

1776 
	`hash_ex‹Á_d©a_»f
(
roÙ_objeùid
, 
owÃr
, 
off£t
))

1779 
u64
 
»f_off£t
;

1780 
»f_off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
);

1781 ià(
·»Á
 > 0) {

1782 ià(
·»Á
 =ð
»f_off£t
) {

1783 
”r
 = 0;

1786 ià(
»f_off£t
 < 
·»Á
)

1789 ià(
roÙ_objeùid
 =ð
»f_off£t
) {

1790 
”r
 = 0;

1793 ià(
»f_off£t
 < 
roÙ_objeùid
)

1797 
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1799 ià(
”r
 =ð-
ENOENT
 && 
š£¹
) {

1800 ià(
™em_size
 + 
exŒa_size
 >=

1801 
	`BTRFS_MAX_EXTENT_ITEM_SIZE
(
roÙ
)) {

1802 
”r
 = -
EAGAIN
;

1803 
out
;

1811 ià(
	`fšd_Ãxt_key
(
·th
, 0, &
key
) == 0 &&

1812 
key
.
objeùid
 =ð
by‹Ä
 &&

1813 
key
.
ty³
 < 
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

1814 
”r
 = -
EAGAIN
;

1815 
out
;

1818 *
»f_»t
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

1819 
out
:

1820 ià(
š£¹
) {

1821 
·th
->
k“p_locks
 = 0;

1822 
	`bŒfs_uÆock_up_§ã
(
·th
, 1);

1824  
”r
;

1825 
	}
}

1830 
nošlše_fÜ_¡ack


1831 
	$£tup_šlše_ex‹Á_back»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

1832 
bŒfs_·th
 *
·th
,

1833 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

1834 
u64
 
·»Á
, u64 
roÙ_objeùid
,

1835 
u64
 
owÃr
, u64 
off£t
, 
»fs_to_add
,

1836 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
)

1838 
ex‹Á_bufãr
 *
Ëaf
;

1839 
bŒfs_ex‹Á_™em
 *
ei
;

1840 
±r
;

1841 
’d
;

1842 
™em_off£t
;

1843 
u64
 
»fs
;

1844 
size
;

1845 
ty³
;

1847 
Ëaf
 = 
·th
->
nodes
[0];

1848 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1849 
™em_off£t
 = ()
œef
 - ()
ei
;

1851 
ty³
 = 
	`ex‹Á_»f_ty³
(
·»Á
, 
owÃr
);

1852 
size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1854 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, 
size
);

1856 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1857 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

1858 
»fs
 +ð
»fs_to_add
;

1859 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ei
, 
»fs
);

1860 ià(
ex‹Á_Ý
)

1861 
	`__run_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
, 
Ëaf
, 
ei
);

1863 
±r
 = ()
ei
 + 
™em_off£t
;

1864 
’d
 = ()
ei
 + 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1865 ià(
±r
 < 
’d
 - 
size
)

1866 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
 + 
size
,…tr,

1867 
’d
 - 
size
 - 
±r
);

1869 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

1870 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
ty³
);

1871 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1872 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

1873 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1874 
	`bŒfs_£t_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
d»f
, 
roÙ_objeùid
);

1875 
	`bŒfs_£t_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
d»f
, 
owÃr
);

1876 
	`bŒfs_£t_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
d»f
, 
off£t
);

1877 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
, 
»fs_to_add
);

1878 } ià(
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

1879 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

1880 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1881 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
, 
»fs_to_add
);

1882 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

1883 } ià(
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
) {

1884 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

1886 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
roÙ_objeùid
);

1888 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1889 
	}
}

1891 
	$lookup_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1892 
bŒfs_fs_šfo
 *
fs_šfo
,

1893 
bŒfs_·th
 *
·th
,

1894 
bŒfs_ex‹Á_šlše_»f
 **
»f_»t
,

1895 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

1896 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

1898 
»t
;

1900 
»t
 = 
	`lookup_šlše_ex‹Á_back»f
(
Œªs
, 
fs_šfo
, 
·th
, 
»f_»t
,

1901 
by‹Ä
, 
num_by‹s
, 
·»Á
,

1902 
roÙ_objeùid
, 
owÃr
, 
off£t
, 0);

1903 ià(
»t
 !ð-
ENOENT
)

1904  
»t
;

1906 
	`bŒfs_»Ëa£_·th
(
·th
);

1907 *
»f_»t
 = 
NULL
;

1909 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

1910 
»t
 = 
	`lookup_Œ“_block_»f
(
Œªs
, 
fs_šfo
, 
·th
, 
by‹Ä
,

1911 
·»Á
, 
roÙ_objeùid
);

1913 
»t
 = 
	`lookup_ex‹Á_d©a_»f
(
Œªs
, 
fs_šfo
, 
·th
, 
by‹Ä
,

1914 
·»Á
, 
roÙ_objeùid
, 
owÃr
,

1915 
off£t
);

1917  
»t
;

1918 
	}
}

1923 
nošlše_fÜ_¡ack


1924 
	$upd©e_šlše_ex‹Á_back»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

1925 
bŒfs_·th
 *
·th
,

1926 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

1927 
»fs_to_mod
,

1928 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

1929 *
Ï¡_»f
)

1931 
ex‹Á_bufãr
 *
Ëaf
;

1932 
bŒfs_ex‹Á_™em
 *
ei
;

1933 
bŒfs_ex‹Á_d©a_»f
 *
d»f
 = 
NULL
;

1934 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
 = 
NULL
;

1935 
±r
;

1936 
’d
;

1937 
u32
 
™em_size
;

1938 
size
;

1939 
ty³
;

1940 
u64
 
»fs
;

1942 
Ëaf
 = 
·th
->
nodes
[0];

1943 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

1944 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

1945 
	`WARN_ON
(
»fs_to_mod
 < 0 && 
»fs
 +„efs_to_mod <= 0);

1946 
»fs
 +ð
»fs_to_mod
;

1947 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ei
, 
»fs
);

1948 ià(
ex‹Á_Ý
)

1949 
	`__run_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
, 
Ëaf
, 
ei
);

1955 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_REF_TYPE_ANY
);

1956 
	`ASSERT
(
ty³
 !ð
BTRFS_REF_TYPE_INVALID
);

1958 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

1959 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

1960 
»fs
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
);

1961 } ià(
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

1962 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

1963 
»fs
 = 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
);

1965 
»fs
 = 1;

1966 
	`BUG_ON
(
»fs_to_mod
 != -1);

1969 
	`BUG_ON
(
»fs_to_mod
 < 0 && 
»fs
 < -refs_to_mod);

1970 
»fs
 +ð
»fs_to_mod
;

1972 ià(
»fs
 > 0) {

1973 ià(
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
)

1974 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
d»f
, 
»fs
);

1976 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
¤ef
, 
»fs
);

1978 *
Ï¡_»f
 = 1;

1979 
size
 = 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

1980 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1981 
±r
 = ()
œef
;

1982 
’d
 = ()
ei
 + 
™em_size
;

1983 ià(
±r
 + 
size
 < 
’d
)

1984 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
size
,

1985 
’d
 - 
±r
 - 
size
);

1986 
™em_size
 -ð
size
;

1987 
	`bŒfs_Œunÿ‹_™em
(
fs_šfo
, 
·th
, 
™em_size
, 1);

1989 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1990 
	}
}

1992 
nošlše_fÜ_¡ack


1993 
	$š£¹_šlše_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1994 
bŒfs_fs_šfo
 *
fs_šfo
,

1995 
bŒfs_·th
 *
·th
,

1996 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

1997 
u64
 
roÙ_objeùid
, u64 
owÃr
,

1998 
u64
 
off£t
, 
»fs_to_add
,

1999 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
)

2001 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

2002 
»t
;

2004 
»t
 = 
	`lookup_šlše_ex‹Á_back»f
(
Œªs
, 
fs_šfo
, 
·th
, &
œef
,

2005 
by‹Ä
, 
num_by‹s
, 
·»Á
,

2006 
roÙ_objeùid
, 
owÃr
, 
off£t
, 1);

2007 ià(
»t
 == 0) {

2008 
	`BUG_ON
(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
);

2009 
	`upd©e_šlše_ex‹Á_back»f
(
fs_šfo
, 
·th
, 
œef
,

2010 
»fs_to_add
, 
ex‹Á_Ý
, 
NULL
);

2011 } ià(
»t
 =ð-
ENOENT
) {

2012 
	`£tup_šlše_ex‹Á_back»f
(
fs_šfo
, 
·th
, 
œef
, 
·»Á
,

2013 
roÙ_objeùid
, 
owÃr
, 
off£t
,

2014 
»fs_to_add
, 
ex‹Á_Ý
);

2015 
»t
 = 0;

2017  
»t
;

2018 
	}
}

2020 
	$š£¹_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2021 
bŒfs_fs_šfo
 *
fs_šfo
,

2022 
bŒfs_·th
 *
·th
,

2023 
u64
 
by‹Ä
, u64 
·»Á
, u64 
roÙ_objeùid
,

2024 
u64
 
owÃr
, u64 
off£t
, 
»fs_to_add
)

2026 
»t
;

2027 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

2028 
	`BUG_ON
(
»fs_to_add
 != 1);

2029 
»t
 = 
	`š£¹_Œ“_block_»f
(
Œªs
, 
fs_šfo
, 
·th
, 
by‹Ä
,

2030 
·»Á
, 
roÙ_objeùid
);

2032 
»t
 = 
	`š£¹_ex‹Á_d©a_»f
(
Œªs
, 
fs_šfo
, 
·th
, 
by‹Ä
,

2033 
·»Á
, 
roÙ_objeùid
,

2034 
owÃr
, 
off£t
, 
»fs_to_add
);

2036  
»t
;

2037 
	}
}

2039 
	$»move_ex‹Á_back»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2040 
bŒfs_fs_šfo
 *
fs_šfo
,

2041 
bŒfs_·th
 *
·th
,

2042 
bŒfs_ex‹Á_šlše_»f
 *
œef
,

2043 
»fs_to_drÝ
, 
is_d©a
, *
Ï¡_»f
)

2045 
»t
 = 0;

2047 
	`BUG_ON
(!
is_d©a
 && 
»fs_to_drÝ
 != 1);

2048 ià(
œef
) {

2049 
	`upd©e_šlše_ex‹Á_back»f
(
fs_šfo
, 
·th
, 
œef
,

2050 -
»fs_to_drÝ
, 
NULL
, 
Ï¡_»f
);

2051 } ià(
is_d©a
) {

2052 
»t
 = 
	`»move_ex‹Á_d©a_»f
(
Œªs
, 
fs_šfo
, 
·th
, 
»fs_to_drÝ
,

2053 
Ï¡_»f
);

2055 *
Ï¡_»f
 = 1;

2056 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, 
·th
);

2058  
»t
;

2059 
	}
}

2061 
	#š_¿nge
(
b
, 
fœ¡
, 
Ën
è((bè>ð(fœ¡è&& (bè< (fœ¡è+ (Ën))

	)

2062 
	$bŒfs_issue_disÿrd
(
block_deviû
 *
bdev
, 
u64
 
¡¬t
, u64 
Ën
,

2063 
u64
 *
disÿrded_by‹s
)

2065 
j
, 
»t
 = 0;

2066 
u64
 
by‹s_Ëá
, 
’d
;

2067 
u64
 
®igÃd_¡¬t
 = 
	`ALIGN
(
¡¬t
, 1 << 9);

2069 ià(
	`WARN_ON
(
¡¬t
 !ð
®igÃd_¡¬t
)) {

2070 
Ën
 -ð
®igÃd_¡¬t
 - 
¡¬t
;

2071 
Ën
 = 
	`round_down
(len, 1 << 9);

2072 
¡¬t
 = 
®igÃd_¡¬t
;

2075 *
disÿrded_by‹s
 = 0;

2077 ià(!
Ën
)

2080 
’d
 = 
¡¬t
 + 
Ën
;

2081 
by‹s_Ëá
 = 
Ën
;

2084 
j
 = 0; j < 
BTRFS_SUPER_MIRROR_MAX
; j++) {

2085 
u64
 
sb_¡¬t
 = 
	`bŒfs_sb_off£t
(
j
);

2086 
u64
 
sb_’d
 = 
sb_¡¬t
 + 
BTRFS_SUPER_INFO_SIZE
;

2087 
u64
 
size
 = 
sb_¡¬t
 - 
¡¬t
;

2089 ià(!
	`š_¿nge
(
sb_¡¬t
, 
¡¬t
, 
by‹s_Ëá
) &&

2090 !
	`š_¿nge
(
sb_’d
, 
¡¬t
, 
by‹s_Ëá
) &&

2091 !
	`š_¿nge
(
¡¬t
, 
sb_¡¬t
, 
BTRFS_SUPER_INFO_SIZE
))

2098 ià(
sb_¡¬t
 <ð
¡¬t
) {

2099 
¡¬t
 +ð
sb_’d
 - start;

2100 ià(
¡¬t
 > 
’d
) {

2101 
by‹s_Ëá
 = 0;

2104 
by‹s_Ëá
 = 
’d
 - 
¡¬t
;

2108 ià(
size
) {

2109 
»t
 = 
	`blkdev_issue_disÿrd
(
bdev
, 
¡¬t
 >> 9, 
size
 >> 9,

2110 
GFP_NOFS
, 0);

2111 ià(!
»t
)

2112 *
disÿrded_by‹s
 +ð
size
;

2113 ià(
»t
 !ð-
EOPNOTSUPP
)

2114  
»t
;

2117 
¡¬t
 = 
sb_’d
;

2118 ià(
¡¬t
 > 
’d
) {

2119 
by‹s_Ëá
 = 0;

2122 
by‹s_Ëá
 = 
’d
 - 
¡¬t
;

2125 ià(
by‹s_Ëá
) {

2126 
»t
 = 
	`blkdev_issue_disÿrd
(
bdev
, 
¡¬t
 >> 9, 
by‹s_Ëá
 >> 9,

2127 
GFP_NOFS
, 0);

2128 ià(!
»t
)

2129 *
disÿrded_by‹s
 +ð
by‹s_Ëá
;

2131  
»t
;

2132 
	}
}

2134 
	$bŒfs_disÿrd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

2135 
u64
 
num_by‹s
, u64 *
aùu®_by‹s
)

2137 
»t
;

2138 
u64
 
disÿrded_by‹s
 = 0;

2139 
bŒfs_bio
 *
bbio
 = 
NULL
;

2146 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

2148 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_DISCARD
, 
by‹Ä
, &
num_by‹s
,

2149 &
bbio
, 0);

2151 ià(!
»t
) {

2152 
bŒfs_bio_¡re
 *
¡re
 = 
bbio
->
¡res
;

2153 
i
;

2156 
i
 = 0; i < 
bbio
->
num_¡res
; i++, 
¡re
++) {

2157 
u64
 
by‹s
;

2158 ià(!
¡re
->
dev
->
ÿn_disÿrd
)

2161 
»t
 = 
	`bŒfs_issue_disÿrd
(
¡re
->
dev
->
bdev
,

2162 
¡re
->
physiÿl
,

2163 
¡re
->
Ëngth
,

2164 &
by‹s
);

2165 ià(!
»t
)

2166 
disÿrded_by‹s
 +ð
by‹s
;

2167 ià(
»t
 !ð-
EOPNOTSUPP
)

2175 
»t
 = 0;

2177 
	`bŒfs_put_bbio
(
bbio
);

2179 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2181 ià(
aùu®_by‹s
)

2182 *
aùu®_by‹s
 = 
disÿrded_by‹s
;

2185 ià(
»t
 =ð-
EOPNOTSUPP
)

2186 
»t
 = 0;

2187  
»t
;

2188 
	}
}

2191 
	$bŒfs_šc_ex‹Á_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2192 
bŒfs_fs_šfo
 *
fs_šfo
,

2193 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
,

2194 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
)

2196 
Þd_»f_mod
, 
Ãw_»f_mod
;

2197 
»t
;

2199 
	`BUG_ON
(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

2200 
roÙ_objeùid
 =ð
BTRFS_TREE_LOG_OBJECTID
);

2202 ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

2203 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
fs_šfo
, 
Œªs
, 
by‹Ä
,

2204 
num_by‹s
, 
·»Á
,

2205 
roÙ_objeùid
, ()
owÃr
,

2206 
BTRFS_ADD_DELAYED_REF
, 
NULL
,

2207 &
Þd_»f_mod
, &
Ãw_»f_mod
);

2209 
»t
 = 
	`bŒfs_add_d–ayed_d©a_»f
(
fs_šfo
, 
Œªs
, 
by‹Ä
,

2210 
num_by‹s
, 
·»Á
,

2211 
roÙ_objeùid
, 
owÃr
, 
off£t
,

2212 0, 
BTRFS_ADD_DELAYED_REF
,

2213 &
Þd_»f_mod
, &
Ãw_»f_mod
);

2216 ià(
»t
 =ð0 && 
Þd_»f_mod
 < 0 && 
Ãw_»f_mod
 >= 0)

2217 
	`add_pšÃd_by‹s
(
fs_šfo
, -
num_by‹s
, 
owÃr
, 
roÙ_objeùid
);

2219  
»t
;

2220 
	}
}

2222 
	$__bŒfs_šc_ex‹Á_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2223 
bŒfs_fs_šfo
 *
fs_šfo
,

2224 
bŒfs_d–ayed_»f_node
 *
node
,

2225 
u64
 
·»Á
, u64 
roÙ_objeùid
,

2226 
u64
 
owÃr
, u64 
off£t
, 
»fs_to_add
,

2227 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
)

2229 
bŒfs_·th
 *
·th
;

2230 
ex‹Á_bufãr
 *
Ëaf
;

2231 
bŒfs_ex‹Á_™em
 *
™em
;

2232 
bŒfs_key
 
key
;

2233 
u64
 
by‹Ä
 = 
node
->bytenr;

2234 
u64
 
num_by‹s
 = 
node
->num_bytes;

2235 
u64
 
»fs
;

2236 
»t
;

2238 
·th
 = 
	`bŒfs_®loc_·th
();

2239 ià(!
·th
)

2240  -
ENOMEM
;

2242 
·th
->
»ada
 = 
READA_FORWARD
;

2243 
·th
->
Ëave_¥šnšg
 = 1;

2245 
»t
 = 
	`š£¹_šlše_ex‹Á_back»f
(
Œªs
, 
fs_šfo
, 
·th
, 
by‹Ä
,

2246 
num_by‹s
, 
·»Á
, 
roÙ_objeùid
,

2247 
owÃr
, 
off£t
,

2248 
»fs_to_add
, 
ex‹Á_Ý
);

2249 ià((
»t
 < 0 &&„‘ !ð-
EAGAIN
) || !ret)

2250 
out
;

2257 
Ëaf
 = 
·th
->
nodes
[0];

2258 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2259 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

2260 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
™em
);

2261 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
™em
, 
»fs
 + 
»fs_to_add
);

2262 ià(
ex‹Á_Ý
)

2263 
	`__run_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
, 
Ëaf
, 
™em
);

2265 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2266 
	`bŒfs_»Ëa£_·th
(
·th
);

2268 
·th
->
»ada
 = 
READA_FORWARD
;

2269 
·th
->
Ëave_¥šnšg
 = 1;

2271 
»t
 = 
	`š£¹_ex‹Á_back»f
(
Œªs
, 
fs_šfo
, 
·th
, 
by‹Ä
, 
·»Á
,

2272 
roÙ_objeùid
, 
owÃr
, 
off£t
, 
»fs_to_add
);

2273 ià(
»t
)

2274 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2275 
out
:

2276 
	`bŒfs_ä“_·th
(
·th
);

2277  
»t
;

2278 
	}
}

2280 
	$run_d–ayed_d©a_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2281 
bŒfs_fs_šfo
 *
fs_šfo
,

2282 
bŒfs_d–ayed_»f_node
 *
node
,

2283 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

2284 
š£¹_»£rved
)

2286 
»t
 = 0;

2287 
bŒfs_d–ayed_d©a_»f
 *
»f
;

2288 
bŒfs_key
 
šs
;

2289 
u64
 
·»Á
 = 0;

2290 
u64
 
»f_roÙ
 = 0;

2291 
u64
 
æags
 = 0;

2293 
šs
.
objeùid
 = 
node
->
by‹Ä
;

2294 
šs
.
off£t
 = 
node
->
num_by‹s
;

2295 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2297 
»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
node
);

2298 
	`Œaû_run_d–ayed_d©a_»f
(
fs_šfo
, 
node
, 
»f
,‚ode->
aùiÚ
);

2300 ià(
node
->
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
)

2301 
·»Á
 = 
»f
->parent;

2302 
»f_roÙ
 = 
»f
->
roÙ
;

2304 ià(
node
->
aùiÚ
 =ð
BTRFS_ADD_DELAYED_REF
 && 
š£¹_»£rved
) {

2305 ià(
ex‹Á_Ý
)

2306 
æags
 |ð
ex‹Á_Ý
->
æags_to_£t
;

2307 
»t
 = 
	`®loc_»£rved_fže_ex‹Á
(
Œªs
, 
fs_šfo
,

2308 
·»Á
, 
»f_roÙ
, 
æags
,

2309 
»f
->
objeùid
,„ef->
off£t
,

2310 &
šs
, 
node
->
»f_mod
);

2311 } ià(
node
->
aùiÚ
 =ð
BTRFS_ADD_DELAYED_REF
) {

2312 
»t
 = 
	`__bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
node
, 
·»Á
,

2313 
»f_roÙ
, 
»f
->
objeùid
,

2314 
»f
->
off£t
, 
node
->
»f_mod
,

2315 
ex‹Á_Ý
);

2316 } ià(
node
->
aùiÚ
 =ð
BTRFS_DROP_DELAYED_REF
) {

2317 
»t
 = 
	`__bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
node
, 
·»Á
,

2318 
»f_roÙ
, 
»f
->
objeùid
,

2319 
»f
->
off£t
, 
node
->
»f_mod
,

2320 
ex‹Á_Ý
);

2322 
	`BUG
();

2324  
»t
;

2325 
	}
}

2327 
	$__run_d–ayed_ex‹Á_Ý
(
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

2328 
ex‹Á_bufãr
 *
Ëaf
,

2329 
bŒfs_ex‹Á_™em
 *
ei
)

2331 
u64
 
æags
 = 
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
);

2332 ià(
ex‹Á_Ý
->
upd©e_æags
) {

2333 
æags
 |ð
ex‹Á_Ý
->
æags_to_£t
;

2334 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
ei
, 
æags
);

2337 ià(
ex‹Á_Ý
->
upd©e_key
) {

2338 
bŒfs_Œ“_block_šfo
 *
bi
;

2339 
	`BUG_ON
(!(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
));

2340 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

2341 
	`bŒfs_£t_Œ“_block_key
(
Ëaf
, 
bi
, &
ex‹Á_Ý
->
key
);

2343 
	}
}

2345 
	$run_d–ayed_ex‹Á_Ý
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2346 
bŒfs_fs_šfo
 *
fs_šfo
,

2347 
bŒfs_d–ayed_»f_node
 *
node
,

2348 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
)

2350 
bŒfs_key
 
key
;

2351 
bŒfs_·th
 *
·th
;

2352 
bŒfs_ex‹Á_™em
 *
ei
;

2353 
ex‹Á_bufãr
 *
Ëaf
;

2354 
u32
 
™em_size
;

2355 
»t
;

2356 
”r
 = 0;

2357 
m‘ad©a
 = !
ex‹Á_Ý
->
is_d©a
;

2359 ià(
Œªs
->
abÜ‹d
)

2362 ià(
m‘ad©a
 && !
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

2363 
m‘ad©a
 = 0;

2365 
·th
 = 
	`bŒfs_®loc_·th
();

2366 ià(!
·th
)

2367  -
ENOMEM
;

2369 
key
.
objeùid
 = 
node
->
by‹Ä
;

2371 ià(
m‘ad©a
) {

2372 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

2373 
key
.
off£t
 = 
ex‹Á_Ý
->
Ëv–
;

2375 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2376 
key
.
off£t
 = 
node
->
num_by‹s
;

2379 
agaš
:

2380 
·th
->
»ada
 = 
READA_FORWARD
;

2381 
·th
->
Ëave_¥šnšg
 = 1;

2382 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 1);

2383 ià(
»t
 < 0) {

2384 
”r
 = 
»t
;

2385 
out
;

2387 ià(
»t
 > 0) {

2388 ià(
m‘ad©a
) {

2389 ià(
·th
->
¦Ùs
[0] > 0) {

2390 
·th
->
¦Ùs
[0]--;

2391 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

2392 
·th
->
¦Ùs
[0]);

2393 ià(
key
.
objeùid
 =ð
node
->
by‹Ä
 &&

2394 
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

2395 
key
.
off£t
 =ð
node
->
num_by‹s
)

2396 
»t
 = 0;

2398 ià(
»t
 > 0) {

2399 
	`bŒfs_»Ëa£_·th
(
·th
);

2400 
m‘ad©a
 = 0;

2402 
key
.
objeùid
 = 
node
->
by‹Ä
;

2403 
key
.
off£t
 = 
node
->
num_by‹s
;

2404 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2405 
agaš
;

2408 
”r
 = -
EIO
;

2409 
out
;

2413 
Ëaf
 = 
·th
->
nodes
[0];

2414 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

2415 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


2416 ià(
™em_size
 < (*
ei
)) {

2417 
»t
 = 
	`cÚv”t_ex‹Á_™em_v0
(
Œªs
, 
fs_šfo
, 
·th
, (
u64
)-1, 0);

2418 ià(
»t
 < 0) {

2419 
”r
 = 
»t
;

2420 
out
;

2422 
Ëaf
 = 
·th
->
nodes
[0];

2423 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

2426 
	`BUG_ON
(
™em_size
 < (*
ei
));

2427 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

2428 
	`__run_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
, 
Ëaf
, 
ei
);

2430 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2431 
out
:

2432 
	`bŒfs_ä“_·th
(
·th
);

2433  
”r
;

2434 
	}
}

2436 
	$run_d–ayed_Œ“_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2437 
bŒfs_fs_šfo
 *
fs_šfo
,

2438 
bŒfs_d–ayed_»f_node
 *
node
,

2439 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

2440 
š£¹_»£rved
)

2442 
»t
 = 0;

2443 
bŒfs_d–ayed_Œ“_»f
 *
»f
;

2444 
bŒfs_key
 
šs
;

2445 
u64
 
·»Á
 = 0;

2446 
u64
 
»f_roÙ
 = 0;

2447 
boÞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

2449 
»f
 = 
	`bŒfs_d–ayed_node_to_Œ“_»f
(
node
);

2450 
	`Œaû_run_d–ayed_Œ“_»f
(
fs_šfo
, 
node
, 
»f
,‚ode->
aùiÚ
);

2452 ià(
node
->
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
)

2453 
·»Á
 = 
»f
->parent;

2454 
»f_roÙ
 = 
»f
->
roÙ
;

2456 
šs
.
objeùid
 = 
node
->
by‹Ä
;

2457 ià(
skšny_m‘ad©a
) {

2458 
šs
.
off£t
 = 
»f
->
Ëv–
;

2459 
šs
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

2461 
šs
.
off£t
 = 
node
->
num_by‹s
;

2462 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2465 ià(
node
->
»f_mod
 != 1) {

2466 
	`bŒfs_”r
(
fs_šfo
,

2468 
node
->
by‹Ä
,‚ode->
»f_mod
,‚ode->
aùiÚ
, 
»f_roÙ
,

2469 
·»Á
);

2470  -
EIO
;

2472 ià(
node
->
aùiÚ
 =ð
BTRFS_ADD_DELAYED_REF
 && 
š£¹_»£rved
) {

2473 
	`BUG_ON
(!
ex‹Á_Ý
 || !ex‹Á_Ý->
upd©e_æags
);

2474 
»t
 = 
	`®loc_»£rved_Œ“_block
(
Œªs
, 
fs_šfo
,

2475 
·»Á
, 
»f_roÙ
,

2476 
ex‹Á_Ý
->
æags_to_£t
,

2477 &
ex‹Á_Ý
->
key
,

2478 
»f
->
Ëv–
, &
šs
);

2479 } ià(
node
->
aùiÚ
 =ð
BTRFS_ADD_DELAYED_REF
) {

2480 
»t
 = 
	`__bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
node
,

2481 
·»Á
, 
»f_roÙ
,

2482 
»f
->
Ëv–
, 0, 1,

2483 
ex‹Á_Ý
);

2484 } ià(
node
->
aùiÚ
 =ð
BTRFS_DROP_DELAYED_REF
) {

2485 
»t
 = 
	`__bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
node
,

2486 
·»Á
, 
»f_roÙ
,

2487 
»f
->
Ëv–
, 0, 1, 
ex‹Á_Ý
);

2489 
	`BUG
();

2491  
»t
;

2492 
	}
}

2495 
	$run_Úe_d–ayed_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2496 
bŒfs_fs_šfo
 *
fs_šfo
,

2497 
bŒfs_d–ayed_»f_node
 *
node
,

2498 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,

2499 
š£¹_»£rved
)

2501 
»t
 = 0;

2503 ià(
Œªs
->
abÜ‹d
) {

2504 ià(
š£¹_»£rved
)

2505 
	`bŒfs_pš_ex‹Á
(
fs_šfo
, 
node
->
by‹Ä
,

2506 
node
->
num_by‹s
, 1);

2510 ià(
	`bŒfs_d–ayed_»f_is_h—d
(
node
)) {

2511 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

2518 
	`BUG_ON
(
ex‹Á_Ý
);

2519 
h—d
 = 
	`bŒfs_d–ayed_node_to_h—d
(
node
);

2520 
	`Œaû_run_d–ayed_»f_h—d
(
fs_šfo
, 
node
, 
h—d
,‚ode->
aùiÚ
);

2522 ià(
h—d
->
tÙ®_»f_mod
 < 0) {

2523 
bŒfs_block_group_ÿche
 *
ÿche
;

2525 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
node
->
by‹Ä
);

2526 
	`ASSERT
(
ÿche
);

2527 
	`³rýu_couÁ”_add
(&
ÿche
->
¥aû_šfo
->
tÙ®_by‹s_pšÃd
,

2528 -
node
->
num_by‹s
);

2529 
	`bŒfs_put_block_group
(
ÿche
);

2532 ià(
š£¹_»£rved
) {

2533 
	`bŒfs_pš_ex‹Á
(
fs_šfo
, 
node
->
by‹Ä
,

2534 
node
->
num_by‹s
, 1);

2535 ià(
h—d
->
is_d©a
) {

2536 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
fs_šfo
,

2537 
node
->
by‹Ä
,

2538 
node
->
num_by‹s
);

2543 
	`bŒfs_qgroup_ä“_d–ayed_»f
(
fs_šfo
, 
h—d
->
qgroup_»f_roÙ
,

2544 
h—d
->
qgroup_»£rved
);

2545  
»t
;

2548 ià(
node
->
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 ||

2549 
node
->
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
)

2550 
»t
 = 
	`run_d–ayed_Œ“_»f
(
Œªs
, 
fs_šfo
, 
node
, 
ex‹Á_Ý
,

2551 
š£¹_»£rved
);

2552 ià(
node
->
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
 ||

2553 
node
->
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
)

2554 
»t
 = 
	`run_d–ayed_d©a_»f
(
Œªs
, 
fs_šfo
, 
node
, 
ex‹Á_Ý
,

2555 
š£¹_»£rved
);

2557 
	`BUG
();

2558  
»t
;

2559 
	}
}

2561 
šlše
 
bŒfs_d–ayed_»f_node
 *

2562 
	$£Ëù_d–ayed_»f
(
bŒfs_d–ayed_»f_h—d
 *
h—d
)

2564 
bŒfs_d–ayed_»f_node
 *
»f
;

2566 ià(
	`li¡_em±y
(&
h—d
->
»f_li¡
))

2567  
NULL
;

2575 ià(!
	`li¡_em±y
(&
h—d
->
»f_add_li¡
))

2576  
	`li¡_fœ¡_’Œy
(&
h—d
->
»f_add_li¡
,

2577 
bŒfs_d–ayed_»f_node
, 
add_li¡
);

2579 
»f
 = 
	`li¡_fœ¡_’Œy
(&
h—d
->
»f_li¡
, 
bŒfs_d–ayed_»f_node
,

2580 
li¡
);

2581 
	`ASSERT
(
	`li¡_em±y
(&
»f
->
add_li¡
));

2582  
»f
;

2583 
	}
}

2589 
nošlše
 
	$__bŒfs_run_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2590 
bŒfs_fs_šfo
 *
fs_šfo
,

2591 
Ä
)

2593 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

2594 
bŒfs_d–ayed_»f_node
 *
»f
;

2595 
bŒfs_d–ayed_»f_h—d
 *
locked_»f
 = 
NULL
;

2596 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
;

2597 
ktime_t
 
¡¬t
 = 
	`ktime_g‘
();

2598 
»t
;

2599 
couÁ
 = 0;

2600 
aùu®_couÁ
 = 0;

2601 
mu¡_š£¹_»£rved
 = 0;

2603 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

2605 ià(!
locked_»f
) {

2606 ià(
couÁ
 >ð
Ä
)

2609 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2610 
locked_»f
 = 
	`bŒfs_£Ëù_»f_h—d
(
Œªs
);

2611 ià(!
locked_»f
) {

2612 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2618 
»t
 = 
	`bŒfs_d–ayed_»f_lock
(
Œªs
, 
locked_»f
);

2619 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2626 ià(
»t
 =ð-
EAGAIN
) {

2627 
locked_»f
 = 
NULL
;

2628 
couÁ
++;

2645 
	`¥š_lock
(&
locked_»f
->
lock
);

2646 
	`bŒfs_m”ge_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 
d–ayed_»fs
,

2647 
locked_»f
);

2653 
»f
 = 
	`£Ëù_d–ayed_»f
(
locked_»f
);

2655 ià(
»f
 &&„ef->
£q
 &&

2656 
	`bŒfs_check_d–ayed_£q
(
fs_šfo
, 
d–ayed_»fs
, 
»f
->
£q
)) {

2657 
	`¥š_uÆock
(&
locked_»f
->
lock
);

2658 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2659 
locked_»f
->
´oûssšg
 = 0;

2660 
d–ayed_»fs
->
num_h—ds_»ady
++;

2661 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2662 
	`bŒfs_d–ayed_»f_uÆock
(
locked_»f
);

2663 
locked_»f
 = 
NULL
;

2664 
	`cÚd_»sched
();

2665 
couÁ
++;

2673 
mu¡_š£¹_»£rved
 = 
locked_»f
->must_insert_reserved;

2674 
locked_»f
->
mu¡_š£¹_»£rved
 = 0;

2676 
ex‹Á_Ý
 = 
locked_»f
->extent_op;

2677 
locked_»f
->
ex‹Á_Ý
 = 
NULL
;

2679 ià(!
»f
) {

2686 
»f
 = &
locked_»f
->
node
;

2688 ià(
ex‹Á_Ý
 && 
mu¡_š£¹_»£rved
) {

2689 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
);

2690 
ex‹Á_Ý
 = 
NULL
;

2693 ià(
ex‹Á_Ý
) {

2694 
	`¥š_uÆock
(&
locked_»f
->
lock
);

2695 
»t
 = 
	`run_d–ayed_ex‹Á_Ý
(
Œªs
, 
fs_šfo
,

2696 
»f
, 
ex‹Á_Ý
);

2697 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
);

2699 ià(
»t
) {

2706 ià(
mu¡_š£¹_»£rved
)

2707 
locked_»f
->
mu¡_š£¹_»£rved
 = 1;

2708 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2709 
locked_»f
->
´oûssšg
 = 0;

2710 
d–ayed_»fs
->
num_h—ds_»ady
++;

2711 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2712 
	`bŒfs_debug
(
fs_šfo
,

2714 
»t
);

2715 
	`bŒfs_d–ayed_»f_uÆock
(
locked_»f
);

2716  
»t
;

2726 
	`¥š_uÆock
(&
locked_»f
->
lock
);

2727 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2728 
	`¥š_lock
(&
locked_»f
->
lock
);

2729 ià(!
	`li¡_em±y
(&
locked_»f
->
»f_li¡
) ||

2730 
locked_»f
->
ex‹Á_Ý
) {

2731 
	`¥š_uÆock
(&
locked_»f
->
lock
);

2732 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2735 
»f
->
š_Œ“
 = 0;

2736 
d–ayed_»fs
->
num_h—ds
--;

2737 
	`rb_”a£
(&
locked_»f
->
h»f_node
,

2738 &
d–ayed_»fs
->
h»f_roÙ
);

2739 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2741 
aùu®_couÁ
++;

2742 
»f
->
š_Œ“
 = 0;

2743 
	`li¡_d–
(&
»f
->
li¡
);

2744 ià(!
	`li¡_em±y
(&
»f
->
add_li¡
))

2745 
	`li¡_d–
(&
»f
->
add_li¡
);

2747 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

2749 ià(!
	`bŒfs_d–ayed_»f_is_h—d
(
»f
)) {

2754 
»f
->
aùiÚ
) {

2755 
BTRFS_ADD_DELAYED_REF
:

2756 
BTRFS_ADD_DELAYED_EXTENT
:

2757 
locked_»f
->
node
.
»f_mod
 -ð
»f
->ref_mod;

2759 
BTRFS_DROP_DELAYED_REF
:

2760 
locked_»f
->
node
.
»f_mod
 +ð
»f
->ref_mod;

2763 
	`WARN_ON
(1);

2766 
	`¥š_uÆock
(&
locked_»f
->
lock
);

2768 
»t
 = 
	`run_Úe_d–ayed_»f
(
Œªs
, 
fs_šfo
, 
»f
, 
ex‹Á_Ý
,

2769 
mu¡_š£¹_»£rved
);

2771 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
);

2772 ià(
»t
) {

2773 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2774 
locked_»f
->
´oûssšg
 = 0;

2775 
d–ayed_»fs
->
num_h—ds_»ady
++;

2776 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2777 
	`bŒfs_d–ayed_»f_uÆock
(
locked_»f
);

2778 
	`bŒfs_put_d–ayed_»f
(
»f
);

2779 
	`bŒfs_debug
(
fs_šfo
, "run_one_delayed_ref„eturned %d",

2780 
»t
);

2781  
»t
;

2790 ià(
	`bŒfs_d–ayed_»f_is_h—d
(
»f
)) {

2791 ià(
locked_»f
->
is_d©a
 &&

2792 
locked_»f
->
tÙ®_»f_mod
 < 0) {

2793 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2794 
d–ayed_»fs
->
³ndšg_csums
 -ð
»f
->
num_by‹s
;

2795 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2797 
	`bŒfs_d–ayed_»f_uÆock
(
locked_»f
);

2798 
locked_»f
 = 
NULL
;

2800 
	`bŒfs_put_d–ayed_»f
(
»f
);

2801 
couÁ
++;

2802 
	`cÚd_»sched
();

2810 ià(
aùu®_couÁ
 > 0) {

2811 
u64
 
ruÁime
 = 
	`ktime_to_ns
(
	`ktime_sub
(
	`ktime_g‘
(), 
¡¬t
));

2812 
u64
 
avg
;

2818 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

2819 
avg
 = 
fs_šfo
->
avg_d–ayed_»f_ruÁime
 * 3 + 
ruÁime
;

2820 
fs_šfo
->
avg_d–ayed_»f_ruÁime
 = 
avg
 >> 2;

2821 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

2824 
	}
}

2826 #ifdeà
SCRAMBLE_DELAYED_REFS


2832 
u64
 
	$fšd_middË
(
rb_roÙ
 *
roÙ
)

2834 
rb_node
 *
n
 = 
roÙ
->rb_node;

2835 
bŒfs_d–ayed_»f_node
 *
’Œy
;

2836 
®t
 = 1;

2837 
u64
 
middË
;

2838 
u64
 
fœ¡
 = 0, 
Ï¡
 = 0;

2840 
n
 = 
	`rb_fœ¡
(
roÙ
);

2841 ià(
n
) {

2842 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
, 
rb_node
);

2843 
fœ¡
 = 
’Œy
->
by‹Ä
;

2845 
n
 = 
	`rb_Ï¡
(
roÙ
);

2846 ià(
n
) {

2847 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
, 
rb_node
);

2848 
Ï¡
 = 
’Œy
->
by‹Ä
;

2850 
n
 = 
roÙ
->
rb_node
;

2852 
n
) {

2853 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_d–ayed_»f_node
, 
rb_node
);

2854 
	`WARN_ON
(!
’Œy
->
š_Œ“
);

2856 
middË
 = 
’Œy
->
by‹Ä
;

2858 ià(
®t
)

2859 
n
 =‚->
rb_Ëá
;

2861 
n
 =‚->
rb_right
;

2863 
®t
 = 1 -‡lt;

2865  
middË
;

2866 
	}
}

2869 
šlše
 
u64
 
	$h—ds_to_Ëaves
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
h—ds
)

2871 
u64
 
num_by‹s
;

2873 
num_by‹s
 = 
h—ds
 * ((
bŒfs_ex‹Á_™em
) +

2874 (
bŒfs_ex‹Á_šlše_»f
));

2875 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

2876 
num_by‹s
 +ð
h—ds
 * (
bŒfs_Œ“_block_šfo
);

2882  
	`div_u64
(
num_by‹s
, 
	`BTRFS_LEAF_DATA_SIZE
(
fs_šfo
));

2883 
	}
}

2889 
u64
 
	$bŒfs_csum_by‹s_to_Ëaves
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
csum_by‹s
)

2891 
u64
 
csum_size
;

2892 
u64
 
num_csums_³r_Ëaf
;

2893 
u64
 
num_csums
;

2895 
csum_size
 = 
	`BTRFS_MAX_ITEM_SIZE
(
fs_šfo
);

2896 
num_csums_³r_Ëaf
 = 
	`div64_u64
(
csum_size
,

2897 (
u64
)
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
));

2898 
num_csums
 = 
	`div64_u64
(
csum_by‹s
, 
fs_šfo
->
£ùÜsize
);

2899 
num_csums
 +ð
num_csums_³r_Ëaf
 - 1;

2900 
num_csums
 = 
	`div64_u64
Òum_csums, 
num_csums_³r_Ëaf
);

2901  
num_csums
;

2902 
	}
}

2904 
	$bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2905 
bŒfs_fs_šfo
 *
fs_šfo
)

2907 
bŒfs_block_rsv
 *
glob®_rsv
;

2908 
u64
 
num_h—ds
 = 
Œªs
->
Œª§ùiÚ
->
d–ayed_»fs
.
num_h—ds_»ady
;

2909 
u64
 
csum_by‹s
 = 
Œªs
->
Œª§ùiÚ
->
d–ayed_»fs
.
³ndšg_csums
;

2910 
u64
 
num_dœty_bgs
 = 
Œªs
->
Œª§ùiÚ
->num_dirty_bgs;

2911 
u64
 
num_by‹s
, 
num_dœty_bgs_by‹s
;

2912 
»t
 = 0;

2914 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

2915 
num_h—ds
 = 
	`h—ds_to_Ëaves
(
fs_šfo
,‚um_heads);

2916 ià(
num_h—ds
 > 1)

2917 
num_by‹s
 +ð(
num_h—ds
 - 1è* 
fs_šfo
->
nodesize
;

2918 
num_by‹s
 <<= 1;

2919 
num_by‹s
 +ð
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
, 
csum_by‹s
) *

2920 
fs_šfo
->
nodesize
;

2921 
num_dœty_bgs_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
,

2922 
num_dœty_bgs
);

2923 
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

2929 ià(
glob®_rsv
->
¥aû_šfo
->
fuÎ
) {

2930 
num_dœty_bgs_by‹s
 <<= 1;

2931 
num_by‹s
 <<= 1;

2934 
	`¥š_lock
(&
glob®_rsv
->
lock
);

2935 ià(
glob®_rsv
->
»£rved
 <ð
num_by‹s
 + 
num_dœty_bgs_by‹s
)

2936 
»t
 = 1;

2937 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

2938  
»t
;

2939 
	}
}

2941 
	$bŒfs_should_thrÙŽe_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2942 
bŒfs_fs_šfo
 *
fs_šfo
)

2944 
u64
 
num_’Œ›s
 =

2945 
	`©omic_»ad
(&
Œªs
->
Œª§ùiÚ
->
d–ayed_»fs
.
num_’Œ›s
);

2946 
u64
 
avg_ruÁime
;

2947 
u64
 
v®
;

2949 
	`smp_mb
();

2950 
avg_ruÁime
 = 
fs_šfo
->
avg_d–ayed_»f_ruÁime
;

2951 
v®
 = 
num_’Œ›s
 * 
avg_ruÁime
;

2952 ià(
v®
 >ð
NSEC_PER_SEC
)

2954 ià(
v®
 >ð
NSEC_PER_SEC
 / 2)

2957  
	`bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
Œªs
, 
fs_šfo
);

2958 
	}
}

2960 
	sasync_d–ayed_»fs
 {

2961 
bŒfs_roÙ
 *
	mroÙ
;

2962 
u64
 
	mŒªsid
;

2963 
	mcouÁ
;

2964 
	m”rÜ
;

2965 
	msync
;

2966 
com¶‘iÚ
 
	mwa™
;

2967 
bŒfs_wÜk
 
	mwÜk
;

2970 
šlše
 
async_d–ayed_»fs
 *

2971 
	$to_async_d–ayed_»fs
(
bŒfs_wÜk
 *
wÜk
)

2973  
	`cÚš”_of
(
wÜk
, 
async_d–ayed_»fs
, work);

2974 
	}
}

2976 
	$d–ayed_»f_async_¡¬t
(
bŒfs_wÜk
 *
wÜk
)

2978 
async_d–ayed_»fs
 *
async
 = 
	`to_async_d–ayed_»fs
(
wÜk
);

2979 
bŒfs_Œªs_hªdË
 *
Œªs
;

2980 
bŒfs_fs_šfo
 *
fs_šfo
 = 
async
->
roÙ
->fs_info;

2981 
»t
;

2984 ià(
	`bŒfs_Œª§ùiÚ_blocked
(
fs_šfo
))

2985 
dÚe
;

2987 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
async
->
roÙ
);

2988 ià(
	`IS_ERR
(
Œªs
)) {

2989 
async
->
”rÜ
 = 
	`PTR_ERR
(
Œªs
);

2990 
dÚe
;

2997 
Œªs
->
sync
 = 
Œue
;

3000 ià(
Œªs
->
Œªsid
 > 
async
->transid)

3001 
’d
;

3003 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 
async
->
couÁ
);

3004 ià(
»t
)

3005 
async
->
”rÜ
 = 
»t
;

3006 
’d
:

3007 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3008 ià(
»t
 && !
async
->
”rÜ
)

3009 
async
->
”rÜ
 = 
»t
;

3010 
dÚe
:

3011 ià(
async
->
sync
)

3012 
	`com¶‘e
(&
async
->
wa™
);

3014 
	`kä“
(
async
);

3015 
	}
}

3017 
	$bŒfs_async_run_d–ayed_»fs
(
bŒfs_fs_šfo
 *
fs_šfo
,

3018 
couÁ
, 
u64
 
Œªsid
, 
wa™
)

3020 
async_d–ayed_»fs
 *
async
;

3021 
»t
;

3023 
async
 = 
	`km®loc
((*async), 
GFP_NOFS
);

3024 ià(!
async
)

3025  -
ENOMEM
;

3027 
async
->
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3028 
async
->
couÁ
 = count;

3029 
async
->
”rÜ
 = 0;

3030 
async
->
Œªsid
 =ransid;

3031 ià(
wa™
)

3032 
async
->
sync
 = 1;

3034 
async
->
sync
 = 0;

3035 
	`š™_com¶‘iÚ
(&
async
->
wa™
);

3037 
	`bŒfs_š™_wÜk
(&
async
->
wÜk
, 
bŒfs_ex‹Á_»fs_h–³r
,

3038 
d–ayed_»f_async_¡¬t
, 
NULL
, NULL);

3040 
	`bŒfs_queue_wÜk
(
fs_šfo
->
ex‹Á_wÜk”s
, &
async
->
wÜk
);

3042 ià(
wa™
) {

3043 
	`wa™_fÜ_com¶‘iÚ
(&
async
->
wa™
);

3044 
»t
 = 
async
->
”rÜ
;

3045 
	`kä“
(
async
);

3046  
»t
;

3049 
	}
}

3061 
	$bŒfs_run_d–ayed_»fs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3062 
bŒfs_fs_šfo
 *
fs_šfo
, 
couÁ
)

3064 
rb_node
 *
node
;

3065 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

3066 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

3067 
»t
;

3068 
run_®l
 = 
couÁ
 == ()-1;

3069 
boÞ
 
ÿn_æush_³ndšg_bgs
 = 
Œªs
->can_flush_pending_bgs;

3072 ià(
Œªs
->
abÜ‹d
)

3075 ià(
	`‹¡_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
))

3078 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

3079 ià(
couÁ
 == 0)

3080 
couÁ
 = 
	`©omic_»ad
(&
d–ayed_»fs
->
num_’Œ›s
) * 2;

3082 
agaš
:

3083 #ifdeà
SCRAMBLE_DELAYED_REFS


3084 
d–ayed_»fs
->
run_d–ayed_¡¬t
 = 
	`fšd_middË
(&d–ayed_»fs->
roÙ
);

3086 
Œªs
->
ÿn_æush_³ndšg_bgs
 = 
çl£
;

3087 
»t
 = 
	`__bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 
couÁ
);

3088 ià(
»t
 < 0) {

3089 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3090  
»t
;

3093 ià(
run_®l
) {

3094 ià(!
	`li¡_em±y
(&
Œªs
->
Ãw_bgs
))

3095 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
, 
fs_šfo
);

3097 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

3098 
node
 = 
	`rb_fœ¡
(&
d–ayed_»fs
->
h»f_roÙ
);

3099 ià(!
node
) {

3100 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3101 
out
;

3104 
node
) {

3105 
h—d
 = 
	`rb_’Œy
(
node
, 
bŒfs_d–ayed_»f_h—d
,

3106 
h»f_node
);

3107 ià(
	`bŒfs_d–ayed_»f_is_h—d
(&
h—d
->
node
)) {

3108 
bŒfs_d–ayed_»f_node
 *
»f
;

3110 
»f
 = &
h—d
->
node
;

3111 
	`»fcouÁ_šc
(&
»f
->
»fs
);

3113 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3118 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

3119 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

3121 
	`bŒfs_put_d–ayed_»f
(
»f
);

3122 
	`cÚd_»sched
();

3123 
agaš
;

3125 
	`WARN_ON
(1);

3127 
node
 = 
	`rb_Ãxt
(node);

3129 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3130 
	`cÚd_»sched
();

3131 
agaš
;

3133 
out
:

3134 
Œªs
->
ÿn_æush_³ndšg_bgs
 = can_flush_pending_bgs;

3136 
	}
}

3138 
	$bŒfs_£t_disk_ex‹Á_æags
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3139 
bŒfs_fs_šfo
 *
fs_šfo
,

3140 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
æags
,

3141 
Ëv–
, 
is_d©a
)

3143 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
;

3144 
»t
;

3146 
ex‹Á_Ý
 = 
	`bŒfs_®loc_d–ayed_ex‹Á_Ý
();

3147 ià(!
ex‹Á_Ý
)

3148  -
ENOMEM
;

3150 
ex‹Á_Ý
->
æags_to_£t
 = 
æags
;

3151 
ex‹Á_Ý
->
upd©e_æags
 = 
Œue
;

3152 
ex‹Á_Ý
->
upd©e_key
 = 
çl£
;

3153 
ex‹Á_Ý
->
is_d©a
 = is_d©¨? 
Œue
 : 
çl£
;

3154 
ex‹Á_Ý
->
Ëv–
 =†evel;

3156 
»t
 = 
	`bŒfs_add_d–ayed_ex‹Á_Ý
(
fs_šfo
, 
Œªs
, 
by‹Ä
,

3157 
num_by‹s
, 
ex‹Á_Ý
);

3158 ià(
»t
)

3159 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
);

3160  
»t
;

3161 
	}
}

3163 
nošlše
 
	$check_d–ayed_»f
(
bŒfs_roÙ
 *
roÙ
,

3164 
bŒfs_·th
 *
·th
,

3165 
u64
 
objeùid
, u64 
off£t
, u64 
by‹Ä
)

3167 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

3168 
bŒfs_d–ayed_»f_node
 *
»f
;

3169 
bŒfs_d–ayed_d©a_»f
 *
d©a_»f
;

3170 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

3171 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

3172 
»t
 = 0;

3174 
cur_Œªs
 = 
roÙ
->
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

3175 ià(!
cur_Œªs
)

3178 
d–ayed_»fs
 = &
cur_Œªs
->delayed_refs;

3179 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

3180 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

3181 ià(!
h—d
) {

3182 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3186 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
)) {

3187 
	`»fcouÁ_šc
(&
h—d
->
node
.
»fs
);

3188 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3190 
	`bŒfs_»Ëa£_·th
(
·th
);

3196 
	`mu‹x_lock
(&
h—d
->
mu‹x
);

3197 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

3198 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

3199  -
EAGAIN
;

3201 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

3203 
	`¥š_lock
(&
h—d
->
lock
);

3204 
	`li¡_fÜ_—ch_’Œy
(
»f
, &
h—d
->
»f_li¡
, 
li¡
) {

3206 ià(
»f
->
ty³
 !ð
BTRFS_EXTENT_DATA_REF_KEY
) {

3207 
»t
 = 1;

3211 
d©a_»f
 = 
	`bŒfs_d–ayed_node_to_d©a_»f
(
»f
);

3217 ià(
d©a_»f
->
roÙ
 !ðroÙ->
roÙ_key
.
objeùid
 ||

3218 
d©a_»f
->
objeùid
 != objectid ||

3219 
d©a_»f
->
off£t
 != offset) {

3220 
»t
 = 1;

3224 
	`¥š_uÆock
(&
h—d
->
lock
);

3225 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

3226  
»t
;

3227 
	}
}

3229 
nošlše
 
	$check_comm™‹d_»f
(
bŒfs_roÙ
 *
roÙ
,

3230 
bŒfs_·th
 *
·th
,

3231 
u64
 
objeùid
, u64 
off£t
, u64 
by‹Ä
)

3233 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3234 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

3235 
ex‹Á_bufãr
 *
Ëaf
;

3236 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

3237 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

3238 
bŒfs_ex‹Á_™em
 *
ei
;

3239 
bŒfs_key
 
key
;

3240 
u32
 
™em_size
;

3241 
ty³
;

3242 
»t
;

3244 
key
.
objeùid
 = 
by‹Ä
;

3245 
key
.
off£t
 = (
u64
)-1;

3246 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3248 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

3249 ià(
»t
 < 0)

3250 
out
;

3251 
	`BUG_ON
(
»t
 == 0);

3253 
»t
 = -
ENOENT
;

3254 ià(
·th
->
¦Ùs
[0] == 0)

3255 
out
;

3257 
·th
->
¦Ùs
[0]--;

3258 
Ëaf
 = 
·th
->
nodes
[0];

3259 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

3261 ià(
key
.
objeùid
 !ð
by‹Ä
 || key.
ty³
 !ð
BTRFS_EXTENT_ITEM_KEY
)

3262 
out
;

3264 
»t
 = 1;

3265 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

3266 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


3267 ià(
™em_size
 < (*
ei
)) {

3268 
	`WARN_ON
(
™em_size
 !ð(
bŒfs_ex‹Á_™em_v0
));

3269 
out
;

3272 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

3274 ià(
™em_size
 !ð(*
ei
) +

3275 
	`bŒfs_ex‹Á_šlše_»f_size
(
BTRFS_EXTENT_DATA_REF_KEY
))

3276 
out
;

3278 ià(
	`bŒfs_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
) <=

3279 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
))

3280 
out
;

3282 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

3284 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_REF_TYPE_DATA
);

3285 ià(
ty³
 !ð
BTRFS_EXTENT_DATA_REF_KEY
)

3286 
out
;

3288 
»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

3289 ià(
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
) !=

3290 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
) ||

3291 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
) !=

3292 
roÙ
->
roÙ_key
.
objeùid
 ||

3293 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
è!ð
objeùid
 ||

3294 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
è!ð
off£t
)

3295 
out
;

3297 
»t
 = 0;

3298 
out
:

3299  
»t
;

3300 
	}
}

3302 
	$bŒfs_üoss_»f_exi¡
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
, u64 
off£t
,

3303 
u64
 
by‹Ä
)

3305 
bŒfs_·th
 *
·th
;

3306 
»t
;

3307 
»t2
;

3309 
·th
 = 
	`bŒfs_®loc_·th
();

3310 ià(!
·th
)

3311  -
ENOENT
;

3314 
»t
 = 
	`check_comm™‹d_»f
(
roÙ
, 
·th
, 
objeùid
,

3315 
off£t
, 
by‹Ä
);

3316 ià(
»t
 &&„‘ !ð-
ENOENT
)

3317 
out
;

3319 
»t2
 = 
	`check_d–ayed_»f
(
roÙ
, 
·th
, 
objeùid
,

3320 
off£t
, 
by‹Ä
);

3321 } 
»t2
 =ð-
EAGAIN
);

3323 ià(
»t2
 &&„‘2 !ð-
ENOENT
) {

3324 
»t
 = 
»t2
;

3325 
out
;

3328 ià(
»t
 !ð-
ENOENT
 || 
»t2
 != -ENOENT)

3329 
»t
 = 0;

3330 
out
:

3331 
	`bŒfs_ä“_·th
(
·th
);

3332 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_DATA_RELOC_TREE_OBJECTID
)

3333 
	`WARN_ON
(
»t
 > 0);

3334  
»t
;

3335 
	}
}

3337 
	$__bŒfs_mod_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3338 
bŒfs_roÙ
 *
roÙ
,

3339 
ex‹Á_bufãr
 *
buf
,

3340 
fuÎ_back»f
, 
šc
)

3342 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3343 
u64
 
by‹Ä
;

3344 
u64
 
num_by‹s
;

3345 
u64
 
·»Á
;

3346 
u64
 
»f_roÙ
;

3347 
u32
 
Ä™ems
;

3348 
bŒfs_key
 
key
;

3349 
bŒfs_fže_ex‹Á_™em
 *
fi
;

3350 
i
;

3351 
Ëv–
;

3352 
»t
 = 0;

3353 (*
´oûss_func
)(
bŒfs_Œªs_hªdË
 *,

3354 
bŒfs_fs_šfo
 *,

3355 
u64
, u64, u64, u64, u64, u64);

3358 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

3361 
»f_roÙ
 = 
	`bŒfs_h—d”_owÃr
(
buf
);

3362 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
buf
);

3363 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

3365 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
è&& 
Ëv–
 == 0)

3368 ià(
šc
)

3369 
´oûss_func
 = 
bŒfs_šc_ex‹Á_»f
;

3371 
´oûss_func
 = 
bŒfs_ä“_ex‹Á
;

3373 ià(
fuÎ_back»f
)

3374 
·»Á
 = 
buf
->
¡¬t
;

3376 
·»Á
 = 0;

3378 
i
 = 0; i < 
Ä™ems
; i++) {

3379 ià(
Ëv–
 == 0) {

3380 
	`bŒfs_™em_key_to_ýu
(
buf
, &
key
, 
i
);

3381 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

3383 
fi
 = 
	`bŒfs_™em_±r
(
buf
, 
i
,

3384 
bŒfs_fže_ex‹Á_™em
);

3385 ià(
	`bŒfs_fže_ex‹Á_ty³
(
buf
, 
fi
) ==

3386 
BTRFS_FILE_EXTENT_INLINE
)

3388 
by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
buf
, 
fi
);

3389 ià(
by‹Ä
 == 0)

3392 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
buf
, 
fi
);

3393 
key
.
off£t
 -ð
	`bŒfs_fže_ex‹Á_off£t
(
buf
, 
fi
);

3394 
»t
 = 
	`´oûss_func
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

3395 
·»Á
, 
»f_roÙ
, 
key
.
objeùid
,

3396 
key
.
off£t
);

3397 ià(
»t
)

3398 
çž
;

3400 
by‹Ä
 = 
	`bŒfs_node_block±r
(
buf
, 
i
);

3401 
num_by‹s
 = 
fs_šfo
->
nodesize
;

3402 
»t
 = 
	`´oûss_func
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

3403 
·»Á
, 
»f_roÙ
, 
Ëv–
 - 1, 0);

3404 ià(
»t
)

3405 
çž
;

3409 
çž
:

3410  
»t
;

3411 
	}
}

3413 
	$bŒfs_šc_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

3414 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
)

3416  
	`__bŒfs_mod_»f
(
Œªs
, 
roÙ
, 
buf
, 
fuÎ_back»f
, 1);

3417 
	}
}

3419 
	$bŒfs_dec_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

3420 
ex‹Á_bufãr
 *
buf
, 
fuÎ_back»f
)

3422  
	`__bŒfs_mod_»f
(
Œªs
, 
roÙ
, 
buf
, 
fuÎ_back»f
, 0);

3423 
	}
}

3425 
	$wr™e_Úe_ÿche_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3426 
bŒfs_fs_šfo
 *
fs_šfo
,

3427 
bŒfs_·th
 *
·th
,

3428 
bŒfs_block_group_ÿche
 *
ÿche
)

3430 
»t
;

3431 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

3432 
bi
;

3433 
ex‹Á_bufãr
 *
Ëaf
;

3435 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
ex‹Á_roÙ
, &
ÿche
->
key
, 
·th
, 0, 1);

3436 ià(
»t
) {

3437 ià(
»t
 > 0)

3438 
»t
 = -
ENOENT
;

3439 
çž
;

3442 
Ëaf
 = 
·th
->
nodes
[0];

3443 
bi
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

3444 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, &
ÿche
->
™em
, 
bi
, (cache->item));

3445 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

3446 
çž
:

3447 
	`bŒfs_»Ëa£_·th
(
·th
);

3448  
»t
;

3450 
	}
}

3452 
bŒfs_block_group_ÿche
 *

3453 
	$Ãxt_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
,

3454 
bŒfs_block_group_ÿche
 *
ÿche
)

3456 
rb_node
 *
node
;

3458 
	`¥š_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

3461 ià(
	`RB_EMPTY_NODE
(&
ÿche
->
ÿche_node
)) {

3462 cÚ¡ 
u64
 
Ãxt_by‹Ä
 = 
ÿche
->
key
.
objeùid
 + cache->key.
off£t
;

3464 
	`¥š_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

3465 
	`bŒfs_put_block_group
(
ÿche
);

3466 
ÿche
 = 
	`bŒfs_lookup_fœ¡_block_group
(
fs_šfo
, 
Ãxt_by‹Ä
);  cache;

3468 
node
 = 
	`rb_Ãxt
(&
ÿche
->
ÿche_node
);

3469 
	`bŒfs_put_block_group
(
ÿche
);

3470 ià(
node
) {

3471 
ÿche
 = 
	`rb_’Œy
(
node
, 
bŒfs_block_group_ÿche
,

3472 
ÿche_node
);

3473 
	`bŒfs_g‘_block_group
(
ÿche
);

3475 
ÿche
 = 
NULL
;

3476 
	`¥š_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

3477  
ÿche
;

3478 
	}
}

3480 
	$ÿche_§ve_£tup
(
bŒfs_block_group_ÿche
 *
block_group
,

3481 
bŒfs_Œªs_hªdË
 *
Œªs
,

3482 
bŒfs_·th
 *
·th
)

3484 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3485 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3486 
šode
 *šodð
NULL
;

3487 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

3488 
u64
 
®loc_hšt
 = 0;

3489 
dcs
 = 
BTRFS_DC_ERROR
;

3490 
u64
 
num_·ges
 = 0;

3491 
»Œ›s
 = 0;

3492 
»t
 = 0;

3498 ià(
block_group
->
key
.
off£t
 < (100 * 
SZ_1M
)) {

3499 
	`¥š_lock
(&
block_group
->
lock
);

3500 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_WRITTEN
;

3501 
	`¥š_uÆock
(&
block_group
->
lock
);

3505 ià(
Œªs
->
abÜ‹d
)

3507 
agaš
:

3508 
šode
 = 
	`lookup_ä“_¥aû_šode
(
fs_šfo
, 
block_group
, 
·th
);

3509 ià(
	`IS_ERR
(
šode
è&& 
	`PTR_ERR
(šodeè!ð-
ENOENT
) {

3510 
»t
 = 
	`PTR_ERR
(
šode
);

3511 
	`bŒfs_»Ëa£_·th
(
·th
);

3512 
out
;

3515 ià(
	`IS_ERR
(
šode
)) {

3516 
	`BUG_ON
(
»Œ›s
);

3517 
»Œ›s
++;

3519 ià(
block_group
->
ro
)

3520 
out_ä“
;

3522 
»t
 = 
	`ü—‹_ä“_¥aû_šode
(
fs_šfo
, 
Œªs
, 
block_group
,

3523 
·th
);

3524 ià(
»t
)

3525 
out_ä“
;

3526 
agaš
;

3530 ià(
block_group
->
ÿche_g’”©iÚ
 =ð
Œªs
->
Œªsid
 &&

3531 
	`i_size_»ad
(
šode
)) {

3532 
dcs
 = 
BTRFS_DC_SETUP
;

3533 
out_put
;

3541 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

3542 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

3543 ià(
»t
) {

3554 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3555 
out_put
;

3557 
	`WARN_ON
(
»t
);

3559 ià(
	`i_size_»ad
(
šode
) > 0) {

3560 
»t
 = 
	`bŒfs_check_Œunc_ÿche_ä“_¥aû
(
fs_šfo
,

3561 &
fs_šfo
->
glob®_block_rsv
);

3562 ià(
»t
)

3563 
out_put
;

3565 
»t
 = 
	`bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
Œªs
, 
NULL
, 
šode
);

3566 ià(
»t
)

3567 
out_put
;

3570 
	`¥š_lock
(&
block_group
->
lock
);

3571 ià(
block_group
->
ÿched
 !ð
BTRFS_CACHE_FINISHED
 ||

3572 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SPACE_CACHE
)) {

3579 
dcs
 = 
BTRFS_DC_WRITTEN
;

3580 
	`¥š_uÆock
(&
block_group
->
lock
);

3581 
out_put
;

3583 
	`¥š_uÆock
(&
block_group
->
lock
);

3589 ià(
	`‹¡_b™
(
BTRFS_TRANS_CACHE_ENOSPC
, &
Œªs
->
Œª§ùiÚ
->
æags
)) {

3590 
»t
 = -
ENOSPC
;

3591 
out_put
;

3600 
num_·ges
 = 
	`div_u64
(
block_group
->
key
.
off£t
, 
SZ_256M
);

3601 ià(!
num_·ges
)

3602 
num_·ges
 = 1;

3604 
num_·ges
 *= 16;

3605 
num_·ges
 *ð
PAGE_SIZE
;

3607 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
šode
, &
d©a_»£rved
, 0, 
num_·ges
);

3608 ià(
»t
)

3609 
out_put
;

3611 
»t
 = 
	`bŒfs_´—Îoc_fže_¿nge_Œªs
(
šode
, 
Œªs
, 0, 0, 
num_·ges
,

3612 
num_·ges
,‚um_pages,

3613 &
®loc_hšt
);

3622 ià(!
»t
)

3623 
dcs
 = 
BTRFS_DC_SETUP
;

3624 ià(
»t
 =ð-
ENOSPC
)

3625 
	`£t_b™
(
BTRFS_TRANS_CACHE_ENOSPC
, &
Œªs
->
Œª§ùiÚ
->
æags
);

3627 
out_put
:

3628 
	`ut
(
šode
);

3629 
out_ä“
:

3630 
	`bŒfs_»Ëa£_·th
(
·th
);

3631 
out
:

3632 
	`¥š_lock
(&
block_group
->
lock
);

3633 ià(!
»t
 && 
dcs
 =ð
BTRFS_DC_SETUP
)

3634 
block_group
->
ÿche_g’”©iÚ
 = 
Œªs
->
Œªsid
;

3635 
block_group
->
disk_ÿche_¡©e
 = 
dcs
;

3636 
	`¥š_uÆock
(&
block_group
->
lock
);

3638 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

3639  
»t
;

3640 
	}
}

3642 
	$bŒfs_£tup_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3643 
bŒfs_fs_šfo
 *
fs_šfo
)

3645 
bŒfs_block_group_ÿche
 *
ÿche
, *
tmp
;

3646 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

3647 
bŒfs_·th
 *
·th
;

3649 ià(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
) ||

3650 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SPACE_CACHE
))

3653 
·th
 = 
	`bŒfs_®loc_·th
();

3654 ià(!
·th
)

3655  -
ENOMEM
;

3658 
	`li¡_fÜ_—ch_’Œy_§ã
(
ÿche
, 
tmp
, &
cur_Œªs
->
dœty_bgs
,

3659 
dœty_li¡
) {

3660 ià(
ÿche
->
disk_ÿche_¡©e
 =ð
BTRFS_DC_CLEAR
)

3661 
	`ÿche_§ve_£tup
(
ÿche
, 
Œªs
, 
·th
);

3664 
	`bŒfs_ä“_·th
(
·th
);

3666 
	}
}

3680 
	$bŒfs_¡¬t_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3681 
bŒfs_fs_šfo
 *
fs_šfo
)

3683 
bŒfs_block_group_ÿche
 *
ÿche
;

3684 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

3685 
»t
 = 0;

3686 
should_put
;

3687 
bŒfs_·th
 *
·th
 = 
NULL
;

3688 
	`LIST_HEAD
(
dœty
);

3689 
li¡_h—d
 *
io
 = &
cur_Œªs
->
io_bgs
;

3690 
num_¡¬‹d
 = 0;

3691 
loÝs
 = 0;

3693 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3694 ià(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
)) {

3695 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3698 
	`li¡_¥liû_š™
(&
cur_Œªs
->
dœty_bgs
, &
dœty
);

3699 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3701 
agaš
:

3706 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
, 
fs_šfo
);

3708 ià(!
·th
) {

3709 
·th
 = 
	`bŒfs_®loc_·th
();

3710 ià(!
·th
)

3711  -
ENOMEM
;

3719 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3720 !
	`li¡_em±y
(&
dœty
)) {

3721 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
dœty
,

3722 
bŒfs_block_group_ÿche
,

3723 
dœty_li¡
);

3729 ià(!
	`li¡_em±y
(&
ÿche
->
io_li¡
)) {

3730 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

3731 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
ÿche
, 
·th
);

3732 
	`bŒfs_put_block_group
(
ÿche
);

3744 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3745 
	`li¡_d–_š™
(&
ÿche
->
dœty_li¡
);

3746 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3748 
should_put
 = 1;

3750 
	`ÿche_§ve_£tup
(
ÿche
, 
Œªs
, 
·th
);

3752 ià(
ÿche
->
disk_ÿche_¡©e
 =ð
BTRFS_DC_SETUP
) {

3753 
ÿche
->
io_ùl
.
šode
 = 
NULL
;

3754 
»t
 = 
	`bŒfs_wr™e_out_ÿche
(
fs_šfo
, 
Œªs
,

3755 
ÿche
, 
·th
);

3756 ià(
»t
 =ð0 && 
ÿche
->
io_ùl
.
šode
) {

3757 
num_¡¬‹d
++;

3758 
should_put
 = 0;

3764 
	`li¡_add_ž
(&
ÿche
->
io_li¡
, 
io
);

3770 
»t
 = 0;

3773 ià(!
»t
) {

3774 
»t
 = 
	`wr™e_Úe_ÿche_group
(
Œªs
, 
fs_šfo
,

3775 
·th
, 
ÿche
);

3785 ià(
»t
 =ð-
ENOENT
) {

3786 
»t
 = 0;

3787 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3788 ià(
	`li¡_em±y
(&
ÿche
->
dœty_li¡
)) {

3789 
	`li¡_add_ž
(&
ÿche
->
dœty_li¡
,

3790 &
cur_Œªs
->
dœty_bgs
);

3791 
	`bŒfs_g‘_block_group
(
ÿche
);

3793 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3794 } ià(
»t
) {

3795 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3800 ià(
should_put
)

3801 
	`bŒfs_put_block_group
(
ÿche
);

3803 ià(
»t
)

3811 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3812 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3814 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

3820 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 0);

3821 ià(!
»t
 && 
loÝs
 == 0) {

3822 
loÝs
++;

3823 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3824 
	`li¡_¥liû_š™
(&
cur_Œªs
->
dœty_bgs
, &
dœty
);

3829 ià(!
	`li¡_em±y
(&
dœty
)) {

3830 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3831 
agaš
;

3833 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3834 } ià(
»t
 < 0) {

3835 
	`bŒfs_þ—nup_dœty_bgs
(
cur_Œªs
, 
fs_šfo
);

3838 
	`bŒfs_ä“_·th
(
·th
);

3839  
»t
;

3840 
	}
}

3842 
	$bŒfs_wr™e_dœty_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3843 
bŒfs_fs_šfo
 *
fs_šfo
)

3845 
bŒfs_block_group_ÿche
 *
ÿche
;

3846 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

3847 
»t
 = 0;

3848 
should_put
;

3849 
bŒfs_·th
 *
·th
;

3850 
li¡_h—d
 *
io
 = &
cur_Œªs
->
io_bgs
;

3851 
num_¡¬‹d
 = 0;

3853 
·th
 = 
	`bŒfs_®loc_·th
();

3854 ià(!
·th
)

3855  -
ENOMEM
;

3872 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3873 !
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
)) {

3874 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
cur_Œªs
->
dœty_bgs
,

3875 
bŒfs_block_group_ÿche
,

3876 
dœty_li¡
);

3883 ià(!
	`li¡_em±y
(&
ÿche
->
io_li¡
)) {

3884 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3885 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

3886 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
ÿche
, 
·th
);

3887 
	`bŒfs_put_block_group
(
ÿche
);

3888 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3895 
	`li¡_d–_š™
(&
ÿche
->
dœty_li¡
);

3896 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3897 
should_put
 = 1;

3899 
	`ÿche_§ve_£tup
(
ÿche
, 
Œªs
, 
·th
);

3901 ià(!
»t
)

3902 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
,

3905 ià(!
»t
 && 
ÿche
->
disk_ÿche_¡©e
 =ð
BTRFS_DC_SETUP
) {

3906 
ÿche
->
io_ùl
.
šode
 = 
NULL
;

3907 
»t
 = 
	`bŒfs_wr™e_out_ÿche
(
fs_šfo
, 
Œªs
,

3908 
ÿche
, 
·th
);

3909 ià(
»t
 =ð0 && 
ÿche
->
io_ùl
.
šode
) {

3910 
num_¡¬‹d
++;

3911 
should_put
 = 0;

3912 
	`li¡_add_ž
(&
ÿche
->
io_li¡
, 
io
);

3918 
»t
 = 0;

3921 ià(!
»t
) {

3922 
»t
 = 
	`wr™e_Úe_ÿche_group
(
Œªs
, 
fs_šfo
,

3923 
·th
, 
ÿche
);

3937 ià(
»t
 =ð-
ENOENT
) {

3938 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

3939 
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) == 1);

3940 
»t
 = 
	`wr™e_Úe_ÿche_group
(
Œªs
, 
fs_šfo
,

3941 
·th
, 
ÿche
);

3943 ià(
»t
)

3944 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3948 ià(
should_put
)

3949 
	`bŒfs_put_block_group
(
ÿche
);

3950 
	`¥š_lock
(&
cur_Œªs
->
dœty_bgs_lock
);

3952 
	`¥š_uÆock
(&
cur_Œªs
->
dœty_bgs_lock
);

3954 !
	`li¡_em±y
(
io
)) {

3955 
ÿche
 = 
	`li¡_fœ¡_’Œy
(
io
, 
bŒfs_block_group_ÿche
,

3956 
io_li¡
);

3957 
	`li¡_d–_š™
(&
ÿche
->
io_li¡
);

3958 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
ÿche
, 
·th
);

3959 
	`bŒfs_put_block_group
(
ÿche
);

3962 
	`bŒfs_ä“_·th
(
·th
);

3963  
»t
;

3964 
	}
}

3966 
	$bŒfs_ex‹Á_»adÚly
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

3968 
bŒfs_block_group_ÿche
 *
block_group
;

3969 
»adÚly
 = 0;

3971 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

3972 ià(!
block_group
 || block_group->
ro
)

3973 
»adÚly
 = 1;

3974 ià(
block_group
)

3975 
	`bŒfs_put_block_group
(
block_group
);

3976  
»adÚly
;

3977 
	}
}

3979 
boÞ
 
	$bŒfs_šc_nocow_wr™”s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

3981 
bŒfs_block_group_ÿche
 *
bg
;

3982 
boÞ
 
»t
 = 
Œue
;

3984 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

3985 ià(!
bg
)

3986  
çl£
;

3988 
	`¥š_lock
(&
bg
->
lock
);

3989 ià(
bg
->
ro
)

3990 
»t
 = 
çl£
;

3992 
	`©omic_šc
(&
bg
->
nocow_wr™”s
);

3993 
	`¥š_uÆock
(&
bg
->
lock
);

3996 ià(!
»t
)

3997 
	`bŒfs_put_block_group
(
bg
);

3999  
»t
;

4001 
	}
}

4003 
	$bŒfs_dec_nocow_wr™”s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

4005 
bŒfs_block_group_ÿche
 *
bg
;

4007 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

4008 
	`ASSERT
(
bg
);

4009 ià(
	`©omic_dec_ªd_‹¡
(&
bg
->
nocow_wr™”s
))

4010 
	`wake_up_©omic_t
(&
bg
->
nocow_wr™”s
);

4015 
	`bŒfs_put_block_group
(
bg
);

4016 
	`bŒfs_put_block_group
(
bg
);

4017 
	}
}

4019 
	$bŒfs_wa™_nocow_wr™”s_©omic_t
(
©omic_t
 *
a
)

4021 
	`scheduË
();

4023 
	}
}

4025 
	$bŒfs_wa™_nocow_wr™”s
(
bŒfs_block_group_ÿche
 *
bg
)

4027 
	`wa™_Ú_©omic_t
(&
bg
->
nocow_wr™”s
,

4028 
bŒfs_wa™_nocow_wr™”s_©omic_t
,

4029 
TASK_UNINTERRUPTIBLE
);

4030 
	}
}

4032 cÚ¡ *
	$®loc_Çme
(
u64
 
æags
)

4034 
æags
) {

4035 
BTRFS_BLOCK_GROUP_METADATA
|
BTRFS_BLOCK_GROUP_DATA
:

4037 
BTRFS_BLOCK_GROUP_METADATA
:

4039 
BTRFS_BLOCK_GROUP_DATA
:

4041 
BTRFS_BLOCK_GROUP_SYSTEM
:

4044 
	`WARN_ON
(1);

4047 
	}
}

4049 
	$ü—‹_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
æags
,

4050 
bŒfs_¥aû_šfo
 **
Ãw
)

4053 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

4054 
i
;

4055 
»t
;

4057 
¥aû_šfo
 = 
	`kz®loc
((*¥aû_šfo), 
GFP_NOFS
);

4058 ià(!
¥aû_šfo
)

4059  -
ENOMEM
;

4061 
»t
 = 
	`³rýu_couÁ”_š™
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
, 0,

4062 
GFP_KERNEL
);

4063 ià(
»t
) {

4064 
	`kä“
(
¥aû_šfo
);

4065  
»t
;

4068 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++)

4069 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
block_groups
[
i
]);

4070 
	`š™_rw£m
(&
¥aû_šfo
->
groups_£m
);

4071 
	`¥š_lock_š™
(&
¥aû_šfo
->
lock
);

4072 
¥aû_šfo
->
æags
 = fÏg & 
BTRFS_BLOCK_GROUP_TYPE_MASK
;

4073 
¥aû_šfo
->
fÜû_®loc
 = 
CHUNK_ALLOC_NO_FORCE
;

4074 
	`š™_wa™queue_h—d
(&
¥aû_šfo
->
wa™
);

4075 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
ro_bgs
);

4076 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
tick‘s
);

4077 
	`INIT_LIST_HEAD
(&
¥aû_šfo
->
´iÜ™y_tick‘s
);

4079 
»t
 = 
	`kobjeù_š™_ªd_add
(&
¥aû_šfo
->
kobj
, &
¥aû_šfo_kty³
,

4080 
šfo
->
¥aû_šfo_kobj
, "%s",

4081 
	`®loc_Çme
(
¥aû_šfo
->
æags
));

4082 ià(
»t
) {

4083 
	`³rýu_couÁ”_de¡roy
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
);

4084 
	`kä“
(
¥aû_šfo
);

4085  
»t
;

4088 *
Ãw
 = 
¥aû_šfo
;

4089 
	`li¡_add_rcu
(&
¥aû_šfo
->
li¡
, &
šfo
->space_info);

4090 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4091 
šfo
->
d©a_sšfo
 = 
¥aû_šfo
;

4093  
»t
;

4094 
	}
}

4096 
	$upd©e_¥aû_šfo
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
æags
,

4097 
u64
 
tÙ®_by‹s
, u64 
by‹s_u£d
,

4098 
u64
 
by‹s_»adÚly
,

4099 
bŒfs_¥aû_šfo
 **
¥aû_šfo
)

4101 
bŒfs_¥aû_šfo
 *
found
;

4102 
çùÜ
;

4104 ià(
æags
 & (
BTRFS_BLOCK_GROUP_DUP
 | 
BTRFS_BLOCK_GROUP_RAID1
 |

4105 
BTRFS_BLOCK_GROUP_RAID10
))

4106 
çùÜ
 = 2;

4108 
çùÜ
 = 1;

4110 
found
 = 
	`__fšd_¥aû_šfo
(
šfo
, 
æags
);

4111 
	`ASSERT
(
found
);

4112 
	`¥š_lock
(&
found
->
lock
);

4113 
found
->
tÙ®_by‹s
 +=otal_bytes;

4114 
found
->
disk_tÙ®
 +ð
tÙ®_by‹s
 * 
çùÜ
;

4115 
found
->
by‹s_u£d
 += bytes_used;

4116 
found
->
disk_u£d
 +ð
by‹s_u£d
 * 
çùÜ
;

4117 
found
->
by‹s_»adÚly
 += bytes_readonly;

4118 ià(
tÙ®_by‹s
 > 0)

4119 
found
->
fuÎ
 = 0;

4120 
	`¥aû_šfo_add_Ãw_by‹s
(
šfo
, 
found
, 
tÙ®_by‹s
 -

4121 
by‹s_u£d
 - 
by‹s_»adÚly
);

4122 
	`¥š_uÆock
(&
found
->
lock
);

4123 *
¥aû_šfo
 = 
found
;

4124 
	}
}

4126 
	$£t_avaž_®loc_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

4128 
u64
 
exŒa_æags
 = 
	`chunk_to_ex‹nded
(
æags
) &

4129 
BTRFS_EXTENDED_PROFILE_MASK
;

4131 
	`wr™e_£qlock
(&
fs_šfo
->
´ofžes_lock
);

4132 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4133 
fs_šfo
->
avaž_d©a_®loc_b™s
 |ð
exŒa_æags
;

4134 ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4135 
fs_šfo
->
avaž_m‘ad©a_®loc_b™s
 |ð
exŒa_æags
;

4136 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4137 
fs_šfo
->
avaž_sy¡em_®loc_b™s
 |ð
exŒa_æags
;

4138 
	`wr™e_£quÆock
(&
fs_šfo
->
´ofžes_lock
);

4139 
	}
}

4147 
u64
 
	$g‘_»¡re_rg‘
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

4149 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

4150 
u64
 
rg‘
 = 0;

4152 ià(!
bùl
)

4155 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
 &&

4156 
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

4157 
rg‘
 = 
BTRFS_BLOCK_GROUP_DATA
 | 
bùl
->
d©a
.target;

4158 } ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
 &&

4159 
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

4160 
rg‘
 = 
BTRFS_BLOCK_GROUP_SYSTEM
 | 
bùl
->
sys
.target;

4161 } ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
 &&

4162 
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) {

4163 
rg‘
 = 
BTRFS_BLOCK_GROUP_METADATA
 | 
bùl
->
m‘a
.target;

4166  
rg‘
;

4167 
	}
}

4176 
u64
 
	$bŒfs_»duû_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

4178 
u64
 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->
rw_deviûs
;

4179 
u64
 
rg‘
;

4180 
u64
 
¿id_ty³
;

4181 
u64
 
®lowed
 = 0;

4187 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4188 
rg‘
 = 
	`g‘_»¡re_rg‘
(
fs_šfo
, 
æags
);

4189 ià(
rg‘
) {

4191 ià((
æags
 & 
rg‘
è& 
BTRFS_EXTENDED_PROFILE_MASK
) {

4192 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4193  
	`ex‹nded_to_chunk
(
rg‘
);

4196 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4199 
¿id_ty³
 = 0;„aid_ty³ < 
BTRFS_NR_RAID_TYPES
;„aid_type++) {

4200 ià(
num_deviûs
 >ð
bŒfs_¿id_¬¿y
[
¿id_ty³
].
devs_mš
)

4201 
®lowed
 |ð
bŒfs_¿id_group
[
¿id_ty³
];

4203 
®lowed
 &ð
æags
;

4205 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID6
)

4206 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID6
;

4207 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID5
)

4208 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID5
;

4209 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID10
)

4210 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID10
;

4211 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID1
)

4212 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID1
;

4213 ià(
®lowed
 & 
BTRFS_BLOCK_GROUP_RAID0
)

4214 
®lowed
 = 
BTRFS_BLOCK_GROUP_RAID0
;

4216 
æags
 &ð~
BTRFS_BLOCK_GROUP_PROFILE_MASK
;

4218  
	`ex‹nded_to_chunk
(
æags
 | 
®lowed
);

4219 
	}
}

4221 
u64
 
	$g‘_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Üig_æags
)

4223 
£q
;

4224 
u64
 
æags
;

4227 
æags
 = 
Üig_æags
;

4228 
£q
 = 
	`»ad_£qbegš
(&
fs_šfo
->
´ofžes_lock
);

4230 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4231 
æags
 |ð
fs_šfo
->
avaž_d©a_®loc_b™s
;

4232 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

4233 
æags
 |ð
fs_šfo
->
avaž_sy¡em_®loc_b™s
;

4234 ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4235 
æags
 |ð
fs_šfo
->
avaž_m‘ad©a_®loc_b™s
;

4236 } 
	`»ad_£q»Œy
(&
fs_šfo
->
´ofžes_lock
, 
£q
));

4238  
	`bŒfs_»duû_®loc_´ofže
(
fs_šfo
, 
æags
);

4239 
	}
}

4241 
u64
 
	$g‘_®loc_´ofže_by_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
d©a
)

4243 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4244 
u64
 
æags
;

4245 
u64
 
»t
;

4247 ià(
d©a
)

4248 
æags
 = 
BTRFS_BLOCK_GROUP_DATA
;

4249 ià(
roÙ
 =ð
fs_šfo
->
chunk_roÙ
)

4250 
æags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

4252 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

4254 
»t
 = 
	`g‘_®loc_´ofže
(
fs_šfo
, 
æags
);

4255  
»t
;

4256 
	}
}

4258 
u64
 
	$bŒfs_d©a_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
)

4260  
	`g‘_®loc_´ofže
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_DATA
);

4261 
	}
}

4263 
u64
 
	$bŒfs_m‘ad©a_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
)

4265  
	`g‘_®loc_´ofže
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

4266 
	}
}

4268 
u64
 
	$bŒfs_sy¡em_®loc_´ofže
(
bŒfs_fs_šfo
 *
fs_šfo
)

4270  
	`g‘_®loc_´ofže
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

4271 
	}
}

4273 
u64
 
	$bŒfs_¥aû_šfo_u£d
(
bŒfs_¥aû_šfo
 *
s_šfo
,

4274 
boÞ
 
may_u£_šþuded
)

4276 
	`ASSERT
(
s_šfo
);

4277  
s_šfo
->
by‹s_u£d
 + s_šfo->
by‹s_»£rved
 +

4278 
s_šfo
->
by‹s_pšÃd
 + s_šfo->
by‹s_»adÚly
 +

4279 (
may_u£_šþuded
 ? 
s_šfo
->
by‹s_may_u£
 : 0);

4280 
	}
}

4282 
	$bŒfs_®loc_d©a_chunk_Údemªd
(
bŒfs_šode
 *
šode
, 
u64
 
by‹s
)

4284 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

4285 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4286 
bŒfs_¥aû_šfo
 *
d©a_sšfo
 = 
fs_šfo
->data_sinfo;

4287 
u64
 
u£d
;

4288 
»t
 = 0;

4289 
Ãed_comm™
 = 2;

4290 
have_pšÃd_¥aû
;

4293 
by‹s
 = 
	`ALIGN
(by‹s, 
fs_šfo
->
£ùÜsize
);

4295 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
)) {

4296 
Ãed_comm™
 = 0;

4297 
	`ASSERT
(
cu¼’t
->
jouº®_šfo
);

4300 
agaš
:

4302 
	`¥š_lock
(&
d©a_sšfo
->
lock
);

4303 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
d©a_sšfo
, 
Œue
);

4305 ià(
u£d
 + 
by‹s
 > 
d©a_sšfo
->
tÙ®_by‹s
) {

4306 
bŒfs_Œªs_hªdË
 *
Œªs
;

4312 ià(!
d©a_sšfo
->
fuÎ
) {

4313 
u64
 
®loc_rg‘
;

4315 
d©a_sšfo
->
fÜû_®loc
 = 
CHUNK_ALLOC_FORCE
;

4316 
	`¥š_uÆock
(&
d©a_sšfo
->
lock
);

4318 
®loc_rg‘
 = 
	`bŒfs_d©a_®loc_´ofže
(
fs_šfo
);

4329 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4330 ià(
	`IS_ERR
(
Œªs
))

4331  
	`PTR_ERR
(
Œªs
);

4333 
»t
 = 
	`do_chunk_®loc
(
Œªs
, 
fs_šfo
, 
®loc_rg‘
,

4334 
CHUNK_ALLOC_NO_FORCE
);

4335 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4336 ià(
»t
 < 0) {

4337 ià(
»t
 !ð-
ENOSPC
)

4338  
»t
;

4340 
have_pšÃd_¥aû
 = 1;

4341 
comm™_Œªs
;

4345 
agaš
;

4353 
have_pšÃd_¥aû
 = 
	`³rýu_couÁ”_com·»
(

4354 &
d©a_sšfo
->
tÙ®_by‹s_pšÃd
,

4355 
u£d
 + 
by‹s
 - 
d©a_sšfo
->
tÙ®_by‹s
);

4356 
	`¥š_uÆock
(&
d©a_sšfo
->
lock
);

4359 
comm™_Œªs
:

4360 ià(
Ãed_comm™
 &&

4361 !
	`©omic_»ad
(&
fs_šfo
->
Ý’_ioùl_Œªs
)) {

4362 
Ãed_comm™
--;

4364 ià(
Ãed_comm™
 > 0) {

4365 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 0, -1);

4366 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0,

4367 (
u64
)-1);

4370 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4371 ià(
	`IS_ERR
(
Œªs
))

4372  
	`PTR_ERR
(
Œªs
);

4373 ià(
have_pšÃd_¥aû
 >= 0 ||

4374 
	`‹¡_b™
(
BTRFS_TRANS_HAVE_FREE_BGS
,

4375 &
Œªs
->
Œª§ùiÚ
->
æags
) ||

4376 
Ãed_comm™
 > 0) {

4377 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4378 ià(
»t
)

4379  
»t
;

4385 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_d–ayed_ut_mu‹x
);

4386 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_d–ayed_ut_mu‹x
);

4387 
agaš
;

4389 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4393 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
,

4395 
d©a_sšfo
->
æags
, 
by‹s
, 1);

4396  -
ENOSPC
;

4398 
d©a_sšfo
->
by‹s_may_u£
 +ð
by‹s
;

4399 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

4400 
d©a_sšfo
->
æags
, 
by‹s
, 1);

4401 
	`¥š_uÆock
(&
d©a_sšfo
->
lock
);

4403  
»t
;

4404 
	}
}

4406 
	$bŒfs_check_d©a_ä“_¥aû
(
šode
 *inode,

4407 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

4409 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4410 
»t
;

4413 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
fs_šfo
->
£ùÜsize
) -

4414 
	`round_down
(
¡¬t
, 
fs_šfo
->
£ùÜsize
);

4415 
¡¬t
 = 
	`round_down
(¡¬t, 
fs_šfo
->
£ùÜsize
);

4417 
»t
 = 
	`bŒfs_®loc_d©a_chunk_Údemªd
(
	`BTRFS_I
(
šode
), 
Ën
);

4418 ià(
»t
 < 0)

4419  
»t
;

4422 
»t
 = 
	`bŒfs_qgroup_»£rve_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

4423 ià(
»t
 < 0)

4424 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
, 
¡¬t
, 
Ën
);

4426 
»t
 = 0;

4427  
»t
;

4428 
	}
}

4438 
	$bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
 *šode, 
u64
 
¡¬t
,

4439 
u64
 
Ën
)

4441 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4442 
bŒfs_¥aû_šfo
 *
d©a_sšfo
;

4445 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
fs_šfo
->
£ùÜsize
) -

4446 
	`round_down
(
¡¬t
, 
fs_šfo
->
£ùÜsize
);

4447 
¡¬t
 = 
	`round_down
(¡¬t, 
fs_šfo
->
£ùÜsize
);

4449 
d©a_sšfo
 = 
fs_šfo
->data_sinfo;

4450 
	`¥š_lock
(&
d©a_sšfo
->
lock
);

4451 ià(
	`WARN_ON
(
d©a_sšfo
->
by‹s_may_u£
 < 
Ën
))

4452 
d©a_sšfo
->
by‹s_may_u£
 = 0;

4454 
d©a_sšfo
->
by‹s_may_u£
 -ð
Ën
;

4455 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

4456 
d©a_sšfo
->
æags
, 
Ën
, 0);

4457 
	`¥š_uÆock
(&
d©a_sšfo
->
lock
);

4458 
	}
}

4467 
	$bŒfs_ä“_»£rved_d©a_¥aû
(
šode
 *inode,

4468 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

4470 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4473 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
roÙ
->
fs_šfo
->
£ùÜsize
) -

4474 
	`round_down
(
¡¬t
, 
roÙ
->
fs_šfo
->
£ùÜsize
);

4475 
¡¬t
 = 
	`round_down
(¡¬t, 
roÙ
->
fs_šfo
->
£ùÜsize
);

4477 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
, 
¡¬t
, 
Ën
);

4478 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

4479 
	}
}

4481 
	$fÜû_m‘ad©a_®loÿtiÚ
(
bŒfs_fs_šfo
 *
šfo
)

4483 
li¡_h—d
 *
h—d
 = &
šfo
->
¥aû_šfo
;

4484 
bŒfs_¥aû_šfo
 *
found
;

4486 
	`rcu_»ad_lock
();

4487 
	`li¡_fÜ_—ch_’Œy_rcu
(
found
, 
h—d
, 
li¡
) {

4488 ià(
found
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4489 
found
->
fÜû_®loc
 = 
CHUNK_ALLOC_FORCE
;

4491 
	`rcu_»ad_uÆock
();

4492 
	}
}

4494 
šlše
 
u64
 
	$ÿlc_glob®_rsv_Ãed_¥aû
(
bŒfs_block_rsv
 *
glob®
)

4496  (
glob®
->
size
 << 1);

4497 
	}
}

4499 
	$should_®loc_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

4500 
bŒfs_¥aû_šfo
 *
sšfo
, 
fÜû
)

4502 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

4503 
u64
 
by‹s_u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
sšfo
, 
çl£
);

4504 
u64
 
th»sh
;

4506 ià(
fÜû
 =ð
CHUNK_ALLOC_FORCE
)

4514 ià(
sšfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

4515 
by‹s_u£d
 +ð
	`ÿlc_glob®_rsv_Ãed_¥aû
(
glob®_rsv
);

4521 ià(
fÜû
 =ð
CHUNK_ALLOC_LIMITED
) {

4522 
th»sh
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
);

4523 
th»sh
 = 
	`max_t
(
u64
, 
SZ_64M
, 
	`div_çùÜ_fše
(thresh, 1));

4525 ià(
sšfo
->
tÙ®_by‹s
 - 
by‹s_u£d
 < 
th»sh
)

4529 ià(
by‹s_u£d
 + 
SZ_2M
 < 
	`div_çùÜ
(
sšfo
->
tÙ®_by‹s
, 8))

4532 
	}
}

4534 
u64
 
	$g‘_´ofže_num_devs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
)

4536 
u64
 
num_dev
;

4538 ià(
ty³
 & (
BTRFS_BLOCK_GROUP_RAID10
 |

4539 
BTRFS_BLOCK_GROUP_RAID0
 |

4540 
BTRFS_BLOCK_GROUP_RAID5
 |

4541 
BTRFS_BLOCK_GROUP_RAID6
))

4542 
num_dev
 = 
fs_šfo
->
fs_deviûs
->
rw_deviûs
;

4543 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1
)

4544 
num_dev
 = 2;

4546 
num_dev
 = 1;

4548  
num_dev
;

4549 
	}
}

4556 
	$check_sy¡em_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4557 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
)

4559 
bŒfs_¥aû_šfo
 *
šfo
;

4560 
u64
 
Ëá
;

4561 
u64
 
th»sh
;

4562 
»t
 = 0;

4563 
u64
 
num_devs
;

4569 
	`ASSERT
(
	`mu‹x_is_locked
(&
fs_šfo
->
chunk_mu‹x
));

4571 
šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

4572 
	`¥š_lock
(&
šfo
->
lock
);

4573 
Ëá
 = 
šfo
->
tÙ®_by‹s
 - 
	`bŒfs_¥aû_šfo_u£d
(šfo, 
Œue
);

4574 
	`¥š_uÆock
(&
šfo
->
lock
);

4576 
num_devs
 = 
	`g‘_´ofže_num_devs
(
fs_šfo
, 
ty³
);

4579 
th»sh
 = 
	`bŒfs_ÿlc_Œunc_m‘ad©a_size
(
fs_šfo
, 
num_devs
) +

4580 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

4582 ià(
Ëá
 < 
th»sh
 && 
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

4583 
	`bŒfs_šfo
(
fs_šfo
, "left=%llu,‚eed=%llu, flags=%llu",

4584 
Ëá
, 
th»sh
, 
ty³
);

4585 
	`dump_¥aû_šfo
(
fs_šfo
, 
šfo
, 0, 0);

4588 ià(
Ëá
 < 
th»sh
) {

4589 
u64
 
æags
 = 
	`bŒfs_sy¡em_®loc_´ofže
(
fs_šfo
);

4597 
»t
 = 
	`bŒfs_®loc_chunk
(
Œªs
, 
fs_šfo
, 
æags
);

4600 ià(!
»t
) {

4601 
»t
 = 
	`bŒfs_block_rsv_add
(
fs_šfo
->
chunk_roÙ
,

4602 &
fs_šfo
->
chunk_block_rsv
,

4603 
th»sh
, 
BTRFS_RESERVE_NO_FLUSH
);

4604 ià(!
»t
)

4605 
Œªs
->
chunk_by‹s_»£rved
 +ð
th»sh
;

4607 
	}
}

4618 
	$do_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4619 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
, 
fÜû
)

4621 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

4622 
wa™_fÜ_®loc
 = 0;

4623 
»t
 = 0;

4626 ià(
Œªs
->
®loÿtšg_chunk
)

4627  -
ENOSPC
;

4629 
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
æags
);

4630 ià(!
¥aû_šfo
) {

4631 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
, &
¥aû_šfo
);

4632 ià(
»t
)

4633  
»t
;

4636 
agaš
:

4637 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4638 ià(
fÜû
 < 
¥aû_šfo
->
fÜû_®loc
)

4639 
fÜû
 = 
¥aû_šfo
->
fÜû_®loc
;

4640 ià(
¥aû_šfo
->
fuÎ
) {

4641 ià(
	`should_®loc_chunk
(
fs_šfo
, 
¥aû_šfo
, 
fÜû
))

4642 
»t
 = -
ENOSPC
;

4644 
»t
 = 0;

4645 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4646  
»t
;

4649 ià(!
	`should_®loc_chunk
(
fs_šfo
, 
¥aû_šfo
, 
fÜû
)) {

4650 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4652 } ià(
¥aû_šfo
->
chunk_®loc
) {

4653 
wa™_fÜ_®loc
 = 1;

4655 
¥aû_šfo
->
chunk_®loc
 = 1;

4658 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4660 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4668 ià(
wa™_fÜ_®loc
) {

4669 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4670 
wa™_fÜ_®loc
 = 0;

4671 
agaš
;

4674 
Œªs
->
®loÿtšg_chunk
 = 
Œue
;

4680 ià(
	`bŒfs_mixed_¥aû_šfo
(
¥aû_šfo
))

4681 
æags
 |ð(
BTRFS_BLOCK_GROUP_DATA
 | 
BTRFS_BLOCK_GROUP_METADATA
);

4688 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
 && 
fs_šfo
->
m‘ad©a_¿tio
) {

4689 
fs_šfo
->
d©a_chunk_®loÿtiÚs
++;

4690 ià(!(
fs_šfo
->
d©a_chunk_®loÿtiÚs
 %

4691 
fs_šfo
->
m‘ad©a_¿tio
))

4692 
	`fÜû_m‘ad©a_®loÿtiÚ
(
fs_šfo
);

4699 
	`check_sy¡em_chunk
(
Œªs
, 
fs_šfo
, 
æags
);

4701 
»t
 = 
	`bŒfs_®loc_chunk
(
Œªs
, 
fs_šfo
, 
æags
);

4702 
Œªs
->
®loÿtšg_chunk
 = 
çl£
;

4704 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4705 ià(
»t
 < 0 &&„‘ !ð-
ENOSPC
)

4706 
out
;

4707 ià(
»t
)

4708 
¥aû_šfo
->
fuÎ
 = 1;

4710 
»t
 = 1;

4712 
¥aû_šfo
->
fÜû_®loc
 = 
CHUNK_ALLOC_NO_FORCE
;

4713 
out
:

4714 
¥aû_šfo
->
chunk_®loc
 = 0;

4715 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4716 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4731 ià(
Œªs
->
ÿn_æush_³ndšg_bgs
 &&

4732 
Œªs
->
chunk_by‹s_»£rved
 >ð(
u64
)
SZ_2M
) {

4733 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
, 
fs_šfo
);

4734 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

4736  
»t
;

4737 
	}
}

4739 
	$ÿn_ov”comm™
(
bŒfs_fs_šfo
 *
fs_šfo
,

4740 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 
by‹s
,

4741 
bŒfs_»£rve_æush_’um
 
æush
,

4742 
boÞ
 
sy¡em_chunk
)

4744 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

4745 
u64
 
´ofže
;

4746 
u64
 
¥aû_size
;

4747 
u64
 
avaž
;

4748 
u64
 
u£d
;

4751 ià(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

4754 ià(
sy¡em_chunk
)

4755 
´ofže
 = 
	`bŒfs_sy¡em_®loc_´ofže
(
fs_šfo
);

4757 
´ofže
 = 
	`bŒfs_m‘ad©a_®loc_´ofže
(
fs_šfo
);

4759 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
çl£
);

4767 
	`¥š_lock
(&
glob®_rsv
->
lock
);

4768 
¥aû_size
 = 
	`ÿlc_glob®_rsv_Ãed_¥aû
(
glob®_rsv
);

4769 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

4770 ià(
u£d
 + 
¥aû_size
 >ð
¥aû_šfo
->
tÙ®_by‹s
)

4773 
u£d
 +ð
¥aû_šfo
->
by‹s_may_u£
;

4775 
avaž
 = 
	`©omic64_»ad
(&
fs_šfo
->
ä“_chunk_¥aû
);

4783 ià(
´ofže
 & (
BTRFS_BLOCK_GROUP_DUP
 |

4784 
BTRFS_BLOCK_GROUP_RAID1
 |

4785 
BTRFS_BLOCK_GROUP_RAID10
))

4786 
avaž
 >>= 1;

4793 ià(
æush
 =ð
BTRFS_RESERVE_FLUSH_ALL
)

4794 
avaž
 >>= 3;

4796 
avaž
 >>= 1;

4798 ià(
u£d
 + 
by‹s
 < 
¥aû_šfo
->
tÙ®_by‹s
 + 
avaž
)

4801 
	}
}

4803 
	$bŒfs_wr™eback_šodes_sb_Ä
(
bŒfs_fs_šfo
 *
fs_šfo
,

4804 
Ä_·ges
, 
Ä_™ems
)

4806 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

4808 ià(
	`down_»ad_Œylock
(&
sb
->
s_umouÁ
)) {

4809 
	`wr™eback_šodes_sb_Ä
(
sb
, 
Ä_·ges
, 
WB_REASON_FS_FREE_SPACE
);

4810 
	`up_»ad
(&
sb
->
s_umouÁ
);

4819 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 0, 
Ä_™ems
);

4820 ià(!
cu¼’t
->
jouº®_šfo
)

4821 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
Ä_™ems
, 0, (
u64
)-1);

4823 
	}
}

4825 
šlše
 
u64
 
	$ÿlc_»þaim_™ems_Ä
(
bŒfs_fs_šfo
 *
fs_šfo
,

4826 
u64
 
to_»þaim
)

4828 
u64
 
by‹s
;

4829 
u64
 
Ä
;

4831 
by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

4832 
Ä
 = 
	`div64_u64
(
to_»þaim
, 
by‹s
);

4833 ià(!
Ä
)

4834 
Ä
 = 1;

4835  
Ä
;

4836 
	}
}

4838 
	#EXTENT_SIZE_PER_ITEM
 
SZ_256K


	)

4843 
	$shršk_d–®loc
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
to_»þaim
,

4844 
u64
 
Üig
, 
boÞ
 
wa™_Üd”ed
)

4846 
bŒfs_block_rsv
 *
block_rsv
;

4847 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

4848 
bŒfs_Œªs_hªdË
 *
Œªs
;

4849 
u64
 
d–®loc_by‹s
;

4850 
u64
 
max_»þaim
;

4851 
u64
 
™ems
;

4852 
time_Ëá
;

4853 
Ä_·ges
;

4854 
loÝs
;

4855 
bŒfs_»£rve_æush_’um
 
æush
;

4858 
™ems
 = 
	`ÿlc_»þaim_™ems_Ä
(
fs_šfo
, 
to_»þaim
);

4859 
to_»þaim
 = 
™ems
 * 
EXTENT_SIZE_PER_ITEM
;

4861 
Œªs
 = (
bŒfs_Œªs_hªdË
 *)
cu¼’t
->
jouº®_šfo
;

4862 
block_rsv
 = &
fs_šfo
->
d–®loc_block_rsv
;

4863 
¥aû_šfo
 = 
block_rsv
->space_info;

4865 
d–®loc_by‹s
 = 
	`³rýu_couÁ”_sum_pos™ive
(

4866 &
fs_šfo
->
d–®loc_by‹s
);

4867 ià(
d–®loc_by‹s
 == 0) {

4868 ià(
Œªs
)

4870 ià(
wa™_Üd”ed
)

4871 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
™ems
, 0, (
u64
)-1);

4875 
loÝs
 = 0;

4876 
d–®loc_by‹s
 && 
loÝs
 < 3) {

4877 
max_»þaim
 = 
	`mš
(
d–®loc_by‹s
, 
to_»þaim
);

4878 
Ä_·ges
 = 
max_»þaim
 >> 
PAGE_SHIFT
;

4879 
	`bŒfs_wr™eback_šodes_sb_Ä
(
fs_šfo
, 
Ä_·ges
, 
™ems
);

4884 
max_»þaim
 = 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
);

4885 ià(!
max_»þaim
)

4886 
sk_async
;

4888 ià(
max_»þaim
 <ð
Ä_·ges
)

4889 
max_»þaim
 = 0;

4891 
max_»þaim
 -ð
Ä_·ges
;

4893 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

4894 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
) <=

4895 ()
max_»þaim
);

4896 
sk_async
:

4897 ià(!
Œªs
)

4898 
æush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

4900 
æush
 = 
BTRFS_RESERVE_NO_FLUSH
;

4901 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

4902 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
) &&

4903 
	`li¡_em±y
(&
¥aû_šfo
->
´iÜ™y_tick‘s
)) {

4904 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4907 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

4909 
loÝs
++;

4910 ià(
wa™_Üd”ed
 && !
Œªs
) {

4911 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
™ems
, 0, (
u64
)-1);

4913 
time_Ëá
 = 
	`scheduË_timeout_kžÏbË
(1);

4914 ià(
time_Ëá
)

4917 
d–®loc_by‹s
 = 
	`³rýu_couÁ”_sum_pos™ive
(

4918 &
fs_šfo
->
d–®loc_by‹s
);

4920 
	}
}

4932 
	$may_comm™_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

4933 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

4934 
u64
 
by‹s
, 
fÜû
)

4936 
bŒfs_block_rsv
 *
d–ayed_rsv
 = &
fs_šfo
->
d–ayed_block_rsv
;

4937 
bŒfs_Œªs_hªdË
 *
Œªs
;

4939 
Œªs
 = (
bŒfs_Œªs_hªdË
 *)
cu¼’t
->
jouº®_šfo
;

4940 ià(
Œªs
)

4941  -
EAGAIN
;

4943 ià(
fÜû
)

4944 
comm™
;

4947 ià(
	`³rýu_couÁ”_com·»
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
,

4948 
by‹s
) >= 0)

4949 
comm™
;

4955 ià(
¥aû_šfo
 !ð
d–ayed_rsv
->space_info)

4956  -
ENOSPC
;

4958 
	`¥š_lock
(&
d–ayed_rsv
->
lock
);

4959 ià(
	`³rýu_couÁ”_com·»
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
,

4960 
by‹s
 - 
d–ayed_rsv
->
size
) < 0) {

4961 
	`¥š_uÆock
(&
d–ayed_rsv
->
lock
);

4962  -
ENOSPC
;

4964 
	`¥š_uÆock
(&
d–ayed_rsv
->
lock
);

4966 
comm™
:

4967 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
fs_šfo
->
ex‹Á_roÙ
);

4968 ià(
	`IS_ERR
(
Œªs
))

4969  -
ENOSPC
;

4971  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4972 
	}
}

4974 
	s»£rve_tick‘
 {

4975 
u64
 
	mby‹s
;

4976 
	m”rÜ
;

4977 
li¡_h—d
 
	mli¡
;

4978 
wa™_queue_h—d_t
 
	mwa™
;

4986 
	$æush_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

4987 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 
num_by‹s
,

4988 
¡©e
)

4990 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

4991 
bŒfs_Œªs_hªdË
 *
Œªs
;

4992 
Ä
;

4993 
»t
 = 0;

4995 
¡©e
) {

4996 
FLUSH_DELAYED_ITEMS_NR
:

4997 
FLUSH_DELAYED_ITEMS
:

4998 ià(
¡©e
 =ð
FLUSH_DELAYED_ITEMS_NR
)

4999 
Ä
 = 
	`ÿlc_»þaim_™ems_Ä
(
fs_šfo
, 
num_by‹s
) * 2;

5001 
Ä
 = -1;

5003 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

5004 ià(
	`IS_ERR
(
Œªs
)) {

5005 
»t
 = 
	`PTR_ERR
(
Œªs
);

5008 
»t
 = 
	`bŒfs_run_d–ayed_™ems_Ä
(
Œªs
, 
fs_šfo
, 
Ä
);

5009 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5011 
FLUSH_DELALLOC
:

5012 
FLUSH_DELALLOC_WAIT
:

5013 
	`shršk_d–®loc
(
fs_šfo
, 
num_by‹s
 * 2,‚um_bytes,

5014 
¡©e
 =ð
FLUSH_DELALLOC_WAIT
);

5016 
ALLOC_CHUNK
:

5017 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

5018 ià(
	`IS_ERR
(
Œªs
)) {

5019 
»t
 = 
	`PTR_ERR
(
Œªs
);

5022 
»t
 = 
	`do_chunk_®loc
(
Œªs
, 
fs_šfo
,

5023 
	`bŒfs_m‘ad©a_®loc_´ofže
(
fs_šfo
),

5024 
CHUNK_ALLOC_NO_FORCE
);

5025 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5026 ià(
»t
 > 0 ||„‘ =ð-
ENOSPC
)

5027 
»t
 = 0;

5029 
COMMIT_TRANS
:

5030 
»t
 = 
	`may_comm™_Œª§ùiÚ
(
fs_šfo
, 
¥aû_šfo
,

5031 
num_by‹s
, 0);

5034 
»t
 = -
ENOSPC
;

5038 
	`Œaû_bŒfs_æush_¥aû
(
fs_šfo
, 
¥aû_šfo
->
æags
, 
num_by‹s
, 
¡©e
,

5039 
»t
);

5041 
	}
}

5043 
šlše
 
u64


5044 
	$bŒfs_ÿlc_»þaim_m‘ad©a_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

5045 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5046 
boÞ
 
sy¡em_chunk
)

5048 
»£rve_tick‘
 *
tick‘
;

5049 
u64
 
u£d
;

5050 
u64
 
ex³ùed
;

5051 
u64
 
to_»þaim
 = 0;

5053 
	`li¡_fÜ_—ch_’Œy
(
tick‘
, &
¥aû_šfo
->
tick‘s
, 
li¡
)

5054 
to_»þaim
 +ð
tick‘
->
by‹s
;

5055 
	`li¡_fÜ_—ch_’Œy
(
tick‘
, &
¥aû_šfo
->
´iÜ™y_tick‘s
, 
li¡
)

5056 
to_»þaim
 +ð
tick‘
->
by‹s
;

5057 ià(
to_»þaim
)

5058  
to_»þaim
;

5060 
to_»þaim
 = 
	`mš_t
(
u64
, 
	`num_Úlše_ýus
(è* 
SZ_1M
, 
SZ_16M
);

5061 ià(
	`ÿn_ov”comm™
(
fs_šfo
, 
¥aû_šfo
, 
to_»þaim
,

5062 
BTRFS_RESERVE_FLUSH_ALL
, 
sy¡em_chunk
))

5065 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

5067 ià(
	`ÿn_ov”comm™
(
fs_šfo
, 
¥aû_šfo
, 
SZ_1M
,

5068 
BTRFS_RESERVE_FLUSH_ALL
, 
sy¡em_chunk
))

5069 
ex³ùed
 = 
	`div_çùÜ_fše
(
¥aû_šfo
->
tÙ®_by‹s
, 95);

5071 
ex³ùed
 = 
	`div_çùÜ_fše
(
¥aû_šfo
->
tÙ®_by‹s
, 90);

5073 ià(
u£d
 > 
ex³ùed
)

5074 
to_»þaim
 = 
u£d
 - 
ex³ùed
;

5076 
to_»þaim
 = 0;

5077 
to_»þaim
 = 
	`mš
Ño_»þaim, 
¥aû_šfo
->
by‹s_may_u£
 +

5078 
¥aû_šfo
->
by‹s_»£rved
);

5079  
to_»þaim
;

5080 
	}
}

5082 
šlše
 
	$Ãed_do_async_»þaim
(
bŒfs_fs_šfo
 *
fs_šfo
,

5083 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5084 
u64
 
u£d
, 
boÞ
 
sy¡em_chunk
)

5086 
u64
 
th»sh
 = 
	`div_çùÜ_fše
(
¥aû_šfo
->
tÙ®_by‹s
, 98);

5089 ià((
¥aû_šfo
->
by‹s_u£d
 + s·û_šfo->
by‹s_»£rved
è>ð
th»sh
)

5092 ià(!
	`bŒfs_ÿlc_»þaim_m‘ad©a_size
(
fs_šfo
, 
¥aû_šfo
,

5093 
sy¡em_chunk
))

5096  (
u£d
 >ð
th»sh
 && !
	`bŒfs_fs_þosšg
(
fs_šfo
) &&

5097 !
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
));

5098 
	}
}

5100 
	$wake_®l_tick‘s
(
li¡_h—d
 *
h—d
)

5102 
»£rve_tick‘
 *
tick‘
;

5104 !
	`li¡_em±y
(
h—d
)) {

5105 
tick‘
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
»£rve_tick‘
, 
li¡
);

5106 
	`li¡_d–_š™
(&
tick‘
->
li¡
);

5107 
tick‘
->
”rÜ
 = -
ENOSPC
;

5108 
	`wake_up
(&
tick‘
->
wa™
);

5110 
	}
}

5117 
	$bŒfs_async_»þaim_m‘ad©a_¥aû
(
wÜk_¡ruù
 *
wÜk
)

5119 
bŒfs_fs_šfo
 *
fs_šfo
;

5120 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

5121 
u64
 
to_»þaim
;

5122 
æush_¡©e
;

5123 
comm™_cyþes
 = 0;

5124 
u64
 
Ï¡_tick‘s_id
;

5126 
fs_šfo
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_fs_šfo
, 
async_»þaim_wÜk
);

5127 
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

5129 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5130 
to_»þaim
 = 
	`bŒfs_ÿlc_»þaim_m‘ad©a_size
(
fs_šfo
, 
¥aû_šfo
,

5131 
çl£
);

5132 ià(!
to_»þaim
) {

5133 
¥aû_šfo
->
æush
 = 0;

5134 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5137 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

5138 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5140 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

5142 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
to_»þaim
, 
æush_¡©e
);

5143 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5144 ià(
	`li¡_em±y
(&
¥aû_šfo
->
tick‘s
)) {

5145 
¥aû_šfo
->
æush
 = 0;

5146 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5149 
to_»þaim
 = 
	`bŒfs_ÿlc_»þaim_m‘ad©a_size
(
fs_šfo
,

5150 
¥aû_šfo
,

5151 
çl£
);

5152 ià(
Ï¡_tick‘s_id
 =ð
¥aû_šfo
->
tick‘s_id
) {

5153 
æush_¡©e
++;

5155 
Ï¡_tick‘s_id
 = 
¥aû_šfo
->
tick‘s_id
;

5156 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

5157 ià(
comm™_cyþes
)

5158 
comm™_cyþes
--;

5161 ià(
æush_¡©e
 > 
COMMIT_TRANS
) {

5162 
comm™_cyþes
++;

5163 ià(
comm™_cyþes
 > 2) {

5164 
	`wake_®l_tick‘s
(&
¥aû_šfo
->
tick‘s
);

5165 
¥aû_šfo
->
æush
 = 0;

5167 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

5170 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5171 } 
æush_¡©e
 <ð
COMMIT_TRANS
);

5172 
	}
}

5174 
	$bŒfs_š™_async_»þaim_wÜk
(
wÜk_¡ruù
 *
wÜk
)

5176 
	`INIT_WORK
(
wÜk
, 
bŒfs_async_»þaim_m‘ad©a_¥aû
);

5177 
	}
}

5179 
	$´iÜ™y_»þaim_m‘ad©a_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

5180 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5181 
»£rve_tick‘
 *
tick‘
)

5183 
u64
 
to_»þaim
;

5184 
æush_¡©e
 = 
FLUSH_DELAYED_ITEMS_NR
;

5186 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5187 
to_»þaim
 = 
	`bŒfs_ÿlc_»þaim_m‘ad©a_size
(
fs_šfo
, 
¥aû_šfo
,

5188 
çl£
);

5189 ià(!
to_»þaim
) {

5190 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5193 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5196 
	`æush_¥aû
(
fs_šfo
, 
¥aû_šfo
, 
to_»þaim
, 
æush_¡©e
);

5197 
æush_¡©e
++;

5198 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5199 ià(
tick‘
->
by‹s
 == 0) {

5200 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5203 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5209 ià(
æush_¡©e
 =ð
FLUSH_DELALLOC
 ||

5210 
æush_¡©e
 =ð
FLUSH_DELALLOC_WAIT
)

5211 
æush_¡©e
 = 
ALLOC_CHUNK
;

5212 } 
æush_¡©e
 < 
COMMIT_TRANS
);

5213 
	}
}

5215 
	$wa™_»£rve_tick‘
(
bŒfs_fs_šfo
 *
fs_šfo
,

5216 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5217 
»£rve_tick‘
 *
tick‘
, 
u64
 
Üig_by‹s
)

5220 
	`DEFINE_WAIT
(
wa™
);

5221 
»t
 = 0;

5223 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5224 
tick‘
->
by‹s
 > 0 &&ick‘->
”rÜ
 == 0) {

5225 
»t
 = 
	`´•¬e_to_wa™_ev’t
(&
tick‘
->
wa™
, &wa™, 
TASK_KILLABLE
);

5226 ià(
»t
) {

5227 
»t
 = -
EINTR
;

5230 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5232 
	`scheduË
();

5234 
	`fšish_wa™
(&
tick‘
->
wa™
, &wait);

5235 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5237 ià(!
»t
)

5238 
»t
 = 
tick‘
->
”rÜ
;

5239 ià(!
	`li¡_em±y
(&
tick‘
->
li¡
))

5240 
	`li¡_d–_š™
(&
tick‘
->
li¡
);

5241 ià(
tick‘
->
by‹s
 &&ick‘->by‹ < 
Üig_by‹s
) {

5242 
u64
 
num_by‹s
 = 
Üig_by‹s
 - 
tick‘
->
by‹s
;

5243 
¥aû_šfo
->
by‹s_may_u£
 -ð
num_by‹s
;

5244 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5245 
¥aû_šfo
->
æags
, 
num_by‹s
, 0);

5247 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5249  
»t
;

5250 
	}
}

5266 
	$__»£rve_m‘ad©a_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

5267 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5268 
u64
 
Üig_by‹s
,

5269 
bŒfs_»£rve_æush_’um
 
æush
,

5270 
boÞ
 
sy¡em_chunk
)

5272 
»£rve_tick‘
 
tick‘
;

5273 
u64
 
u£d
;

5274 
»t
 = 0;

5276 
	`ASSERT
(
Üig_by‹s
);

5277 
	`ASSERT
(!
cu¼’t
->
jouº®_šfo
 || 
æush
 !ð
BTRFS_RESERVE_FLUSH_ALL
);

5279 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5280 
»t
 = -
ENOSPC
;

5281 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

5288 ià(
u£d
 + 
Üig_by‹s
 <ð
¥aû_šfo
->
tÙ®_by‹s
) {

5289 
¥aû_šfo
->
by‹s_may_u£
 +ð
Üig_by‹s
;

5290 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5291 
¥aû_šfo
->
æags
, 
Üig_by‹s
, 1);

5292 
»t
 = 0;

5293 } ià(
	`ÿn_ov”comm™
(
fs_šfo
, 
¥aû_šfo
, 
Üig_by‹s
, 
æush
,

5294 
sy¡em_chunk
)) {

5295 
¥aû_šfo
->
by‹s_may_u£
 +ð
Üig_by‹s
;

5296 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5297 
¥aû_šfo
->
æags
, 
Üig_by‹s
, 1);

5298 
»t
 = 0;

5308 ià(
»t
 && 
æush
 !ð
BTRFS_RESERVE_NO_FLUSH
) {

5309 
tick‘
.
by‹s
 = 
Üig_by‹s
;

5310 
tick‘
.
”rÜ
 = 0;

5311 
	`š™_wa™queue_h—d
(&
tick‘
.
wa™
);

5312 ià(
æush
 =ð
BTRFS_RESERVE_FLUSH_ALL
) {

5313 
	`li¡_add_ž
(&
tick‘
.
li¡
, &
¥aû_šfo
->
tick‘s
);

5314 ià(!
¥aû_šfo
->
æush
) {

5315 
¥aû_šfo
->
æush
 = 1;

5316 
	`Œaû_bŒfs_Œigg”_æush
(
fs_šfo
,

5317 
¥aû_šfo
->
æags
,

5318 
Üig_by‹s
, 
æush
,

5320 
	`queue_wÜk
(
sy¡em_unbound_wq
,

5321 &
fs_šfo
->
async_»þaim_wÜk
);

5324 
	`li¡_add_ž
(&
tick‘
.
li¡
,

5325 &
¥aû_šfo
->
´iÜ™y_tick‘s
);

5327 } ià(!
»t
 && 
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

5328 
u£d
 +ð
Üig_by‹s
;

5334 ià(!
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
) &&

5335 
	`Ãed_do_async_»þaim
(
fs_šfo
, 
¥aû_šfo
,

5336 
u£d
, 
sy¡em_chunk
) &&

5337 !
	`wÜk_busy
(&
fs_šfo
->
async_»þaim_wÜk
)) {

5338 
	`Œaû_bŒfs_Œigg”_æush
(
fs_šfo
, 
¥aû_šfo
->
æags
,

5339 
Üig_by‹s
, 
æush
, "preempt");

5340 
	`queue_wÜk
(
sy¡em_unbound_wq
,

5341 &
fs_šfo
->
async_»þaim_wÜk
);

5344 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5345 ià(!
»t
 || 
æush
 =ð
BTRFS_RESERVE_NO_FLUSH
)

5346  
»t
;

5348 ià(
æush
 =ð
BTRFS_RESERVE_FLUSH_ALL
)

5349  
	`wa™_»£rve_tick‘
(
fs_šfo
, 
¥aû_šfo
, &
tick‘
,

5350 
Üig_by‹s
);

5352 
»t
 = 0;

5353 
	`´iÜ™y_»þaim_m‘ad©a_¥aû
(
fs_šfo
, 
¥aû_šfo
, &
tick‘
);

5354 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5355 ià(
tick‘
.
by‹s
) {

5356 ià(
tick‘
.
by‹s
 < 
Üig_by‹s
) {

5357 
u64
 
num_by‹s
 = 
Üig_by‹s
 - 
tick‘
.
by‹s
;

5358 
¥aû_šfo
->
by‹s_may_u£
 -ð
num_by‹s
;

5359 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5360 
¥aû_šfo
->
æags
,

5361 
num_by‹s
, 0);

5364 
	`li¡_d–_š™
(&
tick‘
.
li¡
);

5365 
»t
 = -
ENOSPC
;

5367 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5368 
	`ASSERT
(
	`li¡_em±y
(&
tick‘
.
li¡
));

5369  
»t
;

5370 
	}
}

5386 
	$»£rve_m‘ad©a_by‹s
(
bŒfs_roÙ
 *
roÙ
,

5387 
bŒfs_block_rsv
 *
block_rsv
,

5388 
u64
 
Üig_by‹s
,

5389 
bŒfs_»£rve_æush_’um
 
æush
)

5391 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5392 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

5393 
»t
;

5394 
boÞ
 
sy¡em_chunk
 = (
roÙ
 =ð
fs_šfo
->
chunk_roÙ
);

5396 
»t
 = 
	`__»£rve_m‘ad©a_by‹s
(
fs_šfo
, 
block_rsv
->
¥aû_šfo
,

5397 
Üig_by‹s
, 
æush
, 
sy¡em_chunk
);

5398 ià(
»t
 =ð-
ENOSPC
 &&

5399 
	`uÆik–y
(
roÙ
->
Üphª_þ—nup_¡©e
 =ð
ORPHAN_CLEANUP_STARTED
)) {

5400 ià(
block_rsv
 !ð
glob®_rsv
 &&

5401 !
	`block_rsv_u£_by‹s
(
glob®_rsv
, 
Üig_by‹s
))

5402 
»t
 = 0;

5404 ià(
»t
 =ð-
ENOSPC
)

5405 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info:enospc",

5406 
block_rsv
->
¥aû_šfo
->
æags
,

5407 
Üig_by‹s
, 1);

5408  
»t
;

5409 
	}
}

5411 
bŒfs_block_rsv
 *
	$g‘_block_rsv
(

5412 cÚ¡ 
bŒfs_Œªs_hªdË
 *
Œªs
,

5413 cÚ¡ 
bŒfs_roÙ
 *
roÙ
)

5415 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5416 
bŒfs_block_rsv
 *
block_rsv
 = 
NULL
;

5418 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) ||

5419 (
roÙ
 =ð
fs_šfo
->
csum_roÙ
 && 
Œªs
->
addšg_csums
) ||

5420 (
roÙ
 =ð
fs_šfo
->
uuid_roÙ
))

5421 
block_rsv
 = 
Œªs
->block_rsv;

5423 ià(!
block_rsv
)

5424 
block_rsv
 = 
roÙ
->block_rsv;

5426 ià(!
block_rsv
)

5427 
block_rsv
 = &
fs_šfo
->
em±y_block_rsv
;

5429  
block_rsv
;

5430 
	}
}

5432 
	$block_rsv_u£_by‹s
(
bŒfs_block_rsv
 *
block_rsv
,

5433 
u64
 
num_by‹s
)

5435 
»t
 = -
ENOSPC
;

5436 
	`¥š_lock
(&
block_rsv
->
lock
);

5437 ià(
block_rsv
->
»£rved
 >ð
num_by‹s
) {

5438 
block_rsv
->
»£rved
 -ð
num_by‹s
;

5439 ià(
block_rsv
->
»£rved
 < block_rsv->
size
)

5440 
block_rsv
->
fuÎ
 = 0;

5441 
»t
 = 0;

5443 
	`¥š_uÆock
(&
block_rsv
->
lock
);

5444  
»t
;

5445 
	}
}

5447 
	$block_rsv_add_by‹s
(
bŒfs_block_rsv
 *
block_rsv
,

5448 
u64
 
num_by‹s
, 
upd©e_size
)

5450 
	`¥š_lock
(&
block_rsv
->
lock
);

5451 
block_rsv
->
»£rved
 +ð
num_by‹s
;

5452 ià(
upd©e_size
)

5453 
block_rsv
->
size
 +ð
num_by‹s
;

5454 ià(
block_rsv
->
»£rved
 >ðblock_rsv->
size
)

5455 
block_rsv
->
fuÎ
 = 1;

5456 
	`¥š_uÆock
(&
block_rsv
->
lock
);

5457 
	}
}

5459 
	$bŒfs_cÚd_mig¿‹_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

5460 
bŒfs_block_rsv
 *
de¡
, 
u64
 
num_by‹s
,

5461 
mš_çùÜ
)

5463 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

5464 
u64
 
mš_by‹s
;

5466 ià(
glob®_rsv
->
¥aû_šfo
 !ð
de¡
->space_info)

5467  -
ENOSPC
;

5469 
	`¥š_lock
(&
glob®_rsv
->
lock
);

5470 
mš_by‹s
 = 
	`div_çùÜ
(
glob®_rsv
->
size
, 
mš_çùÜ
);

5471 ià(
glob®_rsv
->
»£rved
 < 
mš_by‹s
 + 
num_by‹s
) {

5472 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

5473  -
ENOSPC
;

5475 
glob®_rsv
->
»£rved
 -ð
num_by‹s
;

5476 ià(
glob®_rsv
->
»£rved
 < glob®_rsv->
size
)

5477 
glob®_rsv
->
fuÎ
 = 0;

5478 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

5480 
	`block_rsv_add_by‹s
(
de¡
, 
num_by‹s
, 1);

5482 
	}
}

5488 
	$¥aû_šfo_add_Þd_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

5489 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5490 
u64
 
num_by‹s
)

5492 
»£rve_tick‘
 *
tick‘
;

5493 
li¡_h—d
 *
h—d
;

5494 
u64
 
u£d
;

5495 
bŒfs_»£rve_æush_’um
 
æush
 = 
BTRFS_RESERVE_NO_FLUSH
;

5496 
boÞ
 
check_ov”comm™
 = 
çl£
;

5498 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

5499 
h—d
 = &
¥aû_šfo
->
´iÜ™y_tick‘s
;

5506 
u£d
 = 
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
Œue
);

5507 ià(
u£d
 - 
num_by‹s
 >ð
¥aû_šfo
->
tÙ®_by‹s
)

5508 
check_ov”comm™
 = 
Œue
;

5509 
agaš
:

5510 !
	`li¡_em±y
(
h—d
è&& 
num_by‹s
) {

5511 
tick‘
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
»£rve_tick‘
,

5512 
li¡
);

5517 ià(
check_ov”comm™
 &&

5518 !
	`ÿn_ov”comm™
(
fs_šfo
, 
¥aû_šfo
, 0, 
æush
, 
çl£
))

5520 ià(
num_by‹s
 >ð
tick‘
->
by‹s
) {

5521 
	`li¡_d–_š™
(&
tick‘
->
li¡
);

5522 
num_by‹s
 -ð
tick‘
->
by‹s
;

5523 
tick‘
->
by‹s
 = 0;

5524 
¥aû_šfo
->
tick‘s_id
++;

5525 
	`wake_up
(&
tick‘
->
wa™
);

5527 
tick‘
->
by‹s
 -ð
num_by‹s
;

5528 
num_by‹s
 = 0;

5532 ià(
num_by‹s
 && 
h—d
 =ð&
¥aû_šfo
->
´iÜ™y_tick‘s
) {

5533 
h—d
 = &
¥aû_šfo
->
tick‘s
;

5534 
æush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

5535 
agaš
;

5537 
¥aû_šfo
->
by‹s_may_u£
 -ð
num_by‹s
;

5538 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5539 
¥aû_šfo
->
æags
, 
num_by‹s
, 0);

5540 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

5541 
	}
}

5548 
	$¥aû_šfo_add_Ãw_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

5549 
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

5550 
u64
 
num_by‹s
)

5552 
»£rve_tick‘
 *
tick‘
;

5553 
li¡_h—d
 *
h—d
 = &
¥aû_šfo
->
´iÜ™y_tick‘s
;

5555 
agaš
:

5556 !
	`li¡_em±y
(
h—d
è&& 
num_by‹s
) {

5557 
tick‘
 = 
	`li¡_fœ¡_’Œy
(
h—d
, 
»£rve_tick‘
,

5558 
li¡
);

5559 ià(
num_by‹s
 >ð
tick‘
->
by‹s
) {

5560 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5561 
¥aû_šfo
->
æags
,

5562 
tick‘
->
by‹s
, 1);

5563 
	`li¡_d–_š™
(&
tick‘
->
li¡
);

5564 
num_by‹s
 -ð
tick‘
->
by‹s
;

5565 
¥aû_šfo
->
by‹s_may_u£
 +ð
tick‘
->
by‹s
;

5566 
tick‘
->
by‹s
 = 0;

5567 
¥aû_šfo
->
tick‘s_id
++;

5568 
	`wake_up
(&
tick‘
->
wa™
);

5570 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5571 
¥aû_šfo
->
æags
,

5572 
num_by‹s
, 1);

5573 
¥aû_šfo
->
by‹s_may_u£
 +ð
num_by‹s
;

5574 
tick‘
->
by‹s
 -ð
num_by‹s
;

5575 
num_by‹s
 = 0;

5579 ià(
num_by‹s
 && 
h—d
 =ð&
¥aû_šfo
->
´iÜ™y_tick‘s
) {

5580 
h—d
 = &
¥aû_šfo
->
tick‘s
;

5581 
agaš
;

5583 
	}
}

5585 
	$block_rsv_»Ëa£_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

5586 
bŒfs_block_rsv
 *
block_rsv
,

5587 
bŒfs_block_rsv
 *
de¡
, 
u64
 
num_by‹s
)

5589 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
block_rsv
->space_info;

5591 
	`¥š_lock
(&
block_rsv
->
lock
);

5592 ià(
num_by‹s
 =ð(
u64
)-1)

5593 
num_by‹s
 = 
block_rsv
->
size
;

5594 
block_rsv
->
size
 -ð
num_by‹s
;

5595 ià(
block_rsv
->
»£rved
 >ðblock_rsv->
size
) {

5596 
num_by‹s
 = 
block_rsv
->
»£rved
 - block_rsv->
size
;

5597 
block_rsv
->
»£rved
 = block_rsv->
size
;

5598 
block_rsv
->
fuÎ
 = 1;

5600 
num_by‹s
 = 0;

5602 
	`¥š_uÆock
(&
block_rsv
->
lock
);

5604 ià(
num_by‹s
 > 0) {

5605 ià(
de¡
) {

5606 
	`¥š_lock
(&
de¡
->
lock
);

5607 ià(!
de¡
->
fuÎ
) {

5608 
u64
 
by‹s_to_add
;

5610 
by‹s_to_add
 = 
de¡
->
size
 - de¡->
»£rved
;

5611 
by‹s_to_add
 = 
	`mš
(
num_by‹s
, bytes_to_add);

5612 
de¡
->
»£rved
 +ð
by‹s_to_add
;

5613 ià(
de¡
->
»£rved
 >ðde¡->
size
)

5614 
de¡
->
fuÎ
 = 1;

5615 
num_by‹s
 -ð
by‹s_to_add
;

5617 
	`¥š_uÆock
(&
de¡
->
lock
);

5619 ià(
num_by‹s
)

5620 
	`¥aû_šfo_add_Þd_by‹s
(
fs_šfo
, 
¥aû_šfo
,

5621 
num_by‹s
);

5623 
	}
}

5625 
	$bŒfs_block_rsv_mig¿‹
(
bŒfs_block_rsv
 *
¤c
,

5626 
bŒfs_block_rsv
 *
d¡
, 
u64
 
num_by‹s
,

5627 
upd©e_size
)

5629 
»t
;

5631 
»t
 = 
	`block_rsv_u£_by‹s
(
¤c
, 
num_by‹s
);

5632 ià(
»t
)

5633  
»t
;

5635 
	`block_rsv_add_by‹s
(
d¡
, 
num_by‹s
, 
upd©e_size
);

5637 
	}
}

5639 
	$bŒfs_š™_block_rsv
(
bŒfs_block_rsv
 *
rsv
, 
ty³
)

5641 
	`mem£t
(
rsv
, 0, (*rsv));

5642 
	`¥š_lock_š™
(&
rsv
->
lock
);

5643 
rsv
->
ty³
 =ype;

5644 
	}
}

5646 
bŒfs_block_rsv
 *
	$bŒfs_®loc_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

5647 
ty³
)

5649 
bŒfs_block_rsv
 *
block_rsv
;

5651 
block_rsv
 = 
	`km®loc
((*block_rsv), 
GFP_NOFS
);

5652 ià(!
block_rsv
)

5653  
NULL
;

5655 
	`bŒfs_š™_block_rsv
(
block_rsv
, 
ty³
);

5656 
block_rsv
->
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
,

5657 
BTRFS_BLOCK_GROUP_METADATA
);

5658  
block_rsv
;

5659 
	}
}

5661 
	$bŒfs_ä“_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

5662 
bŒfs_block_rsv
 *
rsv
)

5664 ià(!
rsv
)

5666 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, (
u64
)-1);

5667 
	`kä“
(
rsv
);

5668 
	}
}

5670 
	$__bŒfs_ä“_block_rsv
(
bŒfs_block_rsv
 *
rsv
)

5672 
	`kä“
(
rsv
);

5673 
	}
}

5675 
	$bŒfs_block_rsv_add
(
bŒfs_roÙ
 *
roÙ
,

5676 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
num_by‹s
,

5677 
bŒfs_»£rve_æush_’um
 
æush
)

5679 
»t
;

5681 ià(
num_by‹s
 == 0)

5684 
»t
 = 
	`»£rve_m‘ad©a_by‹s
(
roÙ
, 
block_rsv
, 
num_by‹s
, 
æush
);

5685 ià(!
»t
) {

5686 
	`block_rsv_add_by‹s
(
block_rsv
, 
num_by‹s
, 1);

5690  
»t
;

5691 
	}
}

5693 
	$bŒfs_block_rsv_check
(
bŒfs_block_rsv
 *
block_rsv
, 
mš_çùÜ
)

5695 
u64
 
num_by‹s
 = 0;

5696 
»t
 = -
ENOSPC
;

5698 ià(!
block_rsv
)

5701 
	`¥š_lock
(&
block_rsv
->
lock
);

5702 
num_by‹s
 = 
	`div_çùÜ
(
block_rsv
->
size
, 
mš_çùÜ
);

5703 ià(
block_rsv
->
»£rved
 >ð
num_by‹s
)

5704 
»t
 = 0;

5705 
	`¥š_uÆock
(&
block_rsv
->
lock
);

5707  
»t
;

5708 
	}
}

5710 
	$bŒfs_block_rsv_»fžl
(
bŒfs_roÙ
 *
roÙ
,

5711 
bŒfs_block_rsv
 *
block_rsv
, 
u64
 
mš_»£rved
,

5712 
bŒfs_»£rve_æush_’um
 
æush
)

5714 
u64
 
num_by‹s
 = 0;

5715 
»t
 = -
ENOSPC
;

5717 ià(!
block_rsv
)

5720 
	`¥š_lock
(&
block_rsv
->
lock
);

5721 
num_by‹s
 = 
mš_»£rved
;

5722 ià(
block_rsv
->
»£rved
 >ð
num_by‹s
)

5723 
»t
 = 0;

5725 
num_by‹s
 -ð
block_rsv
->
»£rved
;

5726 
	`¥š_uÆock
(&
block_rsv
->
lock
);

5728 ià(!
»t
)

5731 
»t
 = 
	`»£rve_m‘ad©a_by‹s
(
roÙ
, 
block_rsv
, 
num_by‹s
, 
æush
);

5732 ià(!
»t
) {

5733 
	`block_rsv_add_by‹s
(
block_rsv
, 
num_by‹s
, 0);

5737  
»t
;

5738 
	}
}

5740 
	$bŒfs_block_rsv_»Ëa£
(
bŒfs_fs_šfo
 *
fs_šfo
,

5741 
bŒfs_block_rsv
 *
block_rsv
,

5742 
u64
 
num_by‹s
)

5744 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

5746 ià(
glob®_rsv
 =ð
block_rsv
 ||

5747 
block_rsv
->
¥aû_šfo
 !ð
glob®_rsv
->space_info)

5748 
glob®_rsv
 = 
NULL
;

5749 
	`block_rsv_»Ëa£_by‹s
(
fs_šfo
, 
block_rsv
, 
glob®_rsv
, 
num_by‹s
);

5750 
	}
}

5752 
	$upd©e_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

5754 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

5755 
bŒfs_¥aû_šfo
 *
sšfo
 = 
block_rsv
->
¥aû_šfo
;

5756 
u64
 
num_by‹s
;

5763 
num_by‹s
 = 
	`bŒfs_roÙ_u£d
(&
fs_šfo
->
ex‹Á_roÙ
->
roÙ_™em
) +

5764 
	`bŒfs_roÙ_u£d
(&
fs_šfo
->
csum_roÙ
->
roÙ_™em
) +

5765 
	`bŒfs_roÙ_u£d
(&
fs_šfo
->
Œ“_roÙ
->
roÙ_™em
);

5766 
num_by‹s
 = 
	`max_t
(
u64
,‚um_by‹s, 
SZ_16M
);

5768 
	`¥š_lock
(&
sšfo
->
lock
);

5769 
	`¥š_lock
(&
block_rsv
->
lock
);

5771 
block_rsv
->
size
 = 
	`mš_t
(
u64
, 
num_by‹s
, 
SZ_512M
);

5773 ià(
block_rsv
->
»£rved
 < block_rsv->
size
) {

5774 
num_by‹s
 = 
	`bŒfs_¥aû_šfo_u£d
(
sšfo
, 
Œue
);

5775 ià(
sšfo
->
tÙ®_by‹s
 > 
num_by‹s
) {

5776 
num_by‹s
 = 
sšfo
->
tÙ®_by‹s
 -‚um_bytes;

5777 
num_by‹s
 = 
	`mš
(num_bytes,

5778 
block_rsv
->
size
 - block_rsv->
»£rved
);

5779 
block_rsv
->
»£rved
 +ð
num_by‹s
;

5780 
sšfo
->
by‹s_may_u£
 +ð
num_by‹s
;

5781 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5782 
sšfo
->
æags
, 
num_by‹s
,

5785 } ià(
block_rsv
->
»£rved
 > block_rsv->
size
) {

5786 
num_by‹s
 = 
block_rsv
->
»£rved
 - block_rsv->
size
;

5787 
sšfo
->
by‹s_may_u£
 -ð
num_by‹s
;

5788 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "space_info",

5789 
sšfo
->
æags
, 
num_by‹s
, 0);

5790 
block_rsv
->
»£rved
 = block_rsv->
size
;

5793 ià(
block_rsv
->
»£rved
 =ðblock_rsv->
size
)

5794 
block_rsv
->
fuÎ
 = 1;

5796 
block_rsv
->
fuÎ
 = 0;

5798 
	`¥š_uÆock
(&
block_rsv
->
lock
);

5799 
	`¥š_uÆock
(&
sšfo
->
lock
);

5800 
	}
}

5802 
	$š™_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

5804 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

5806 
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_SYSTEM
);

5807 
fs_šfo
->
chunk_block_rsv
.
¥aû_šfo
 = space_info;

5809 
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
BTRFS_BLOCK_GROUP_METADATA
);

5810 
fs_šfo
->
glob®_block_rsv
.
¥aû_šfo
 = space_info;

5811 
fs_šfo
->
d–®loc_block_rsv
.
¥aû_šfo
 = space_info;

5812 
fs_šfo
->
Œªs_block_rsv
.
¥aû_šfo
 = space_info;

5813 
fs_šfo
->
em±y_block_rsv
.
¥aû_šfo
 = space_info;

5814 
fs_šfo
->
d–ayed_block_rsv
.
¥aû_šfo
 = space_info;

5816 
fs_šfo
->
ex‹Á_roÙ
->
block_rsv
 = &fs_šfo->
glob®_block_rsv
;

5817 
fs_šfo
->
csum_roÙ
->
block_rsv
 = &fs_šfo->
glob®_block_rsv
;

5818 
fs_šfo
->
dev_roÙ
->
block_rsv
 = &fs_šfo->
glob®_block_rsv
;

5819 
fs_šfo
->
Œ“_roÙ
->
block_rsv
 = &fs_šfo->
glob®_block_rsv
;

5820 ià(
fs_šfo
->
quÙa_roÙ
)

5821 
fs_šfo
->
quÙa_roÙ
->
block_rsv
 = &fs_šfo->
glob®_block_rsv
;

5822 
fs_šfo
->
chunk_roÙ
->
block_rsv
 = &fs_šfo->
chunk_block_rsv
;

5824 
	`upd©e_glob®_block_rsv
(
fs_šfo
);

5825 
	}
}

5827 
	$»Ëa£_glob®_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
)

5829 
	`block_rsv_»Ëa£_by‹s
(
fs_šfo
, &fs_šfo->
glob®_block_rsv
, 
NULL
,

5830 (
u64
)-1);

5831 
	`WARN_ON
(
fs_šfo
->
d–®loc_block_rsv
.
size
 > 0);

5832 
	`WARN_ON
(
fs_šfo
->
d–®loc_block_rsv
.
»£rved
 > 0);

5833 
	`WARN_ON
(
fs_šfo
->
Œªs_block_rsv
.
size
 > 0);

5834 
	`WARN_ON
(
fs_šfo
->
Œªs_block_rsv
.
»£rved
 > 0);

5835 
	`WARN_ON
(
fs_šfo
->
chunk_block_rsv
.
size
 > 0);

5836 
	`WARN_ON
(
fs_šfo
->
chunk_block_rsv
.
»£rved
 > 0);

5837 
	`WARN_ON
(
fs_šfo
->
d–ayed_block_rsv
.
size
 > 0);

5838 
	`WARN_ON
(
fs_šfo
->
d–ayed_block_rsv
.
»£rved
 > 0);

5839 
	}
}

5841 
	$bŒfs_Œªs_»Ëa£_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5842 
bŒfs_fs_šfo
 *
fs_šfo
)

5844 ià(!
Œªs
->
block_rsv
)

5847 ià(!
Œªs
->
by‹s_»£rved
)

5850 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

5851 
Œªs
->
Œªsid
,¿ns->
by‹s_»£rved
, 0);

5852 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
Œªs
->
block_rsv
,

5853 
Œªs
->
by‹s_»£rved
);

5854 
Œªs
->
by‹s_»£rved
 = 0;

5855 
	}
}

5861 
	$bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
)

5863 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

5865 ià(!
Œªs
->
chunk_by‹s_»£rved
)

5868 
	`WARN_ON_ONCE
(!
	`li¡_em±y
(&
Œªs
->
Ãw_bgs
));

5870 
	`block_rsv_»Ëa£_by‹s
(
fs_šfo
, &fs_šfo->
chunk_block_rsv
, 
NULL
,

5871 
Œªs
->
chunk_by‹s_»£rved
);

5872 
Œªs
->
chunk_by‹s_»£rved
 = 0;

5873 
	}
}

5876 
	$bŒfs_Üphª_»£rve_m‘ad©a
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5877 
bŒfs_šode
 *
šode
)

5879 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

5880 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5887 
bŒfs_block_rsv
 *
¤c_rsv
 = 
Œªs
->
block_rsv
;

5888 
bŒfs_block_rsv
 *
d¡_rsv
 = 
roÙ
->
Üphª_block_rsv
;

5895 
u64
 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

5897 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "Üphª", 
	`bŒfs_šo
(
šode
),

5898 
num_by‹s
, 1);

5899  
	`bŒfs_block_rsv_mig¿‹
(
¤c_rsv
, 
d¡_rsv
, 
num_by‹s
, 1);

5900 
	}
}

5902 
	$bŒfs_Üphª_»Ëa£_m‘ad©a
(
bŒfs_šode
 *
šode
)

5904 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

5905 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5906 
u64
 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

5908 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "Üphª", 
	`bŒfs_šo
(
šode
),

5909 
num_by‹s
, 0);

5910 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
roÙ
->
Üphª_block_rsv
, 
num_by‹s
);

5911 
	}
}

5927 
	$bŒfs_subvÞume_»£rve_m‘ad©a
(
bŒfs_roÙ
 *
roÙ
,

5928 
bŒfs_block_rsv
 *
rsv
,

5929 
™ems
,

5930 
u64
 *
qgroup_»£rved
,

5931 
boÞ
 
u£_glob®_rsv
)

5933 
u64
 
num_by‹s
;

5934 
»t
;

5935 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5936 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

5938 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)) {

5940 
num_by‹s
 = 3 * 
fs_šfo
->
nodesize
;

5941 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
num_by‹s
, 
Œue
);

5942 ià(
»t
)

5943  
»t
;

5945 
num_by‹s
 = 0;

5948 *
qgroup_»£rved
 = 
num_by‹s
;

5950 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
™ems
);

5951 
rsv
->
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
,

5952 
BTRFS_BLOCK_GROUP_METADATA
);

5953 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, 
rsv
, 
num_by‹s
,

5954 
BTRFS_RESERVE_FLUSH_ALL
);

5956 ià(
»t
 =ð-
ENOSPC
 && 
u£_glob®_rsv
)

5957 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
glob®_rsv
, 
rsv
, 
num_by‹s
, 1);

5959 ià(
»t
 && *
qgroup_»£rved
)

5960 
	`bŒfs_qgroup_ä“_m‘a
(
roÙ
, *
qgroup_»£rved
);

5962  
»t
;

5963 
	}
}

5965 
	$bŒfs_subvÞume_»Ëa£_m‘ad©a
(
bŒfs_fs_šfo
 *
fs_šfo
,

5966 
bŒfs_block_rsv
 *
rsv
)

5968 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, (
u64
)-1);

5969 
	}
}

5981 
	$drÝ_out¡ªdšg_ex‹Á
(
bŒfs_šode
 *
šode
,

5982 
u64
 
num_by‹s
)

5984 
drÝ_šode_¥aû
 = 0;

5985 
drÝ³d_ex‹Ás
 = 0;

5986 
num_ex‹Ás
;

5988 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
num_by‹s
);

5989 
	`ASSERT
(
num_ex‹Ás
);

5990 
	`ASSERT
(
šode
->
out¡ªdšg_ex‹Ás
 >ð
num_ex‹Ás
);

5991 
šode
->
out¡ªdšg_ex‹Ás
 -ð
num_ex‹Ás
;

5993 ià(
šode
->
out¡ªdšg_ex‹Ás
 == 0 &&

5994 
	`‹¡_ªd_þ—r_b™
(
BTRFS_INODE_DELALLOC_META_RESERVED
,

5995 &
šode
->
ruÁime_æags
))

5996 
drÝ_šode_¥aû
 = 1;

6002 ià(
šode
->
out¡ªdšg_ex‹Ás
 >ðšode->
»£rved_ex‹Ás
)

6003  
drÝ_šode_¥aû
;

6005 
drÝ³d_ex‹Ás
 = 
šode
->
»£rved_ex‹Ás
 - inode->
out¡ªdšg_ex‹Ás
;

6006 
šode
->
»£rved_ex‹Ás
 -ð
drÝ³d_ex‹Ás
;

6007  
drÝ³d_ex‹Ás
 + 
drÝ_šode_¥aû
;

6008 
	}
}

6028 
u64
 
	$ÿlc_csum_m‘ad©a_size
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
,

6029 
»£rve
)

6031 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

6032 
u64
 
Þd_csums
, 
num_csums
;

6034 ià(
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
 && inode->
csum_by‹s
 == 0)

6037 
Þd_csums
 = 
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
, 
šode
->
csum_by‹s
);

6038 ià(
»£rve
)

6039 
šode
->
csum_by‹s
 +ð
num_by‹s
;

6041 
šode
->
csum_by‹s
 -ð
num_by‹s
;

6042 
num_csums
 = 
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
, 
šode
->
csum_by‹s
);

6045 ià(
Þd_csums
 =ð
num_csums
)

6048 ià(
»£rve
)

6049  
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
,

6050 
num_csums
 - 
Þd_csums
);

6052  
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
Þd_csums
 - 
num_csums
);

6053 
	}
}

6055 
	$bŒfs_d–®loc_»£rve_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
)

6057 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

6058 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6059 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
d–®loc_block_rsv
;

6060 
u64
 
to_»£rve
 = 0;

6061 
u64
 
csum_by‹s
;

6062 
Ä_ex‹Ás
;

6063 
bŒfs_»£rve_æush_’um
 
æush
 = 
BTRFS_RESERVE_FLUSH_ALL
;

6064 
»t
 = 0;

6065 
boÞ
 
d–®loc_lock
 = 
Œue
;

6066 
u64
 
to_ä“
 = 0;

6067 
drÝ³d
;

6068 
boÞ
 
»Ëa£_exŒa
 = 
çl£
;

6078 ià(
	`bŒfs_is_ä“_¥aû_šode
(
šode
)) {

6079 
æush
 = 
BTRFS_RESERVE_NO_FLUSH
;

6080 
d–®loc_lock
 = 
çl£
;

6081 } ià(
cu¼’t
->
jouº®_šfo
) {

6082 
æush
 = 
BTRFS_RESERVE_FLUSH_LIMIT
;

6085 ià(
æush
 !ð
BTRFS_RESERVE_NO_FLUSH
 &&

6086 
	`bŒfs_Œª§ùiÚ_š_comm™
(
fs_šfo
))

6087 
	`scheduË_timeout
(1);

6089 ià(
d–®loc_lock
)

6090 
	`mu‹x_lock
(&
šode
->
d–®loc_mu‹x
);

6092 
num_by‹s
 = 
	`ALIGN
Òum_by‹s, 
fs_šfo
->
£ùÜsize
);

6094 
	`¥š_lock
(&
šode
->
lock
);

6095 
Ä_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
num_by‹s
);

6096 
šode
->
out¡ªdšg_ex‹Ás
 +ð
Ä_ex‹Ás
;

6098 
Ä_ex‹Ás
 = 0;

6099 ià(
šode
->
out¡ªdšg_ex‹Ás
 > inode->
»£rved_ex‹Ás
)

6100 
Ä_ex‹Ás
 +ð
šode
->
out¡ªdšg_ex‹Ás
 -

6101 
šode
->
»£rved_ex‹Ás
;

6104 
to_»£rve
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
Ä_ex‹Ás
 + 1);

6105 
to_»£rve
 +ð
	`ÿlc_csum_m‘ad©a_size
(
šode
, 
num_by‹s
, 1);

6106 
csum_by‹s
 = 
šode
->csum_bytes;

6107 
	`¥š_uÆock
(&
šode
->
lock
);

6109 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)) {

6110 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a
(
roÙ
,

6111 
Ä_ex‹Ás
 * 
fs_šfo
->
nodesize
, 
Œue
);

6112 ià(
»t
)

6113 
out_çž
;

6116 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, 
block_rsv
, 
to_»£rve
, 
æush
);

6117 ià(
	`uÆik–y
(
»t
)) {

6118 
	`bŒfs_qgroup_ä“_m‘a
(
roÙ
,

6119 
Ä_ex‹Ás
 * 
fs_šfo
->
nodesize
);

6120 
out_çž
;

6123 
	`¥š_lock
(&
šode
->
lock
);

6124 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_INODE_DELALLOC_META_RESERVED
,

6125 &
šode
->
ruÁime_æags
)) {

6126 
to_»£rve
 -ð
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

6127 
»Ëa£_exŒa
 = 
Œue
;

6129 
šode
->
»£rved_ex‹Ás
 +ð
Ä_ex‹Ás
;

6130 
	`¥š_uÆock
(&
šode
->
lock
);

6132 ià(
d–®loc_lock
)

6133 
	`mu‹x_uÆock
(&
šode
->
d–®loc_mu‹x
);

6135 ià(
to_»£rve
)

6136 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delalloc",

6137 
	`bŒfs_šo
(
šode
), 
to_»£rve
, 1);

6138 ià(
»Ëa£_exŒa
)

6139 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
block_rsv
,

6140 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1));

6143 
out_çž
:

6144 
	`¥š_lock
(&
šode
->
lock
);

6145 
drÝ³d
 = 
	`drÝ_out¡ªdšg_ex‹Á
(
šode
, 
num_by‹s
);

6151 ià(
šode
->
csum_by‹s
 == csum_bytes) {

6152 
	`ÿlc_csum_m‘ad©a_size
(
šode
, 
num_by‹s
, 0);

6154 
u64
 
Üig_csum_by‹s
 = 
šode
->
csum_by‹s
;

6155 
u64
 
by‹s
;

6165 
by‹s
 = 
csum_by‹s
 - 
šode
->csum_bytes;

6166 
šode
->
csum_by‹s
 = csum_bytes;

6167 
to_ä“
 = 
	`ÿlc_csum_m‘ad©a_size
(
šode
, 
by‹s
, 0);

6175 
šode
->
csum_by‹s
 = csum_by‹ - 
num_by‹s
;

6176 
by‹s
 = 
csum_by‹s
 - 
Üig_csum_by‹s
;

6177 
by‹s
 = 
	`ÿlc_csum_m‘ad©a_size
(
šode
, bytes, 0);

6187 
šode
->
csum_by‹s
 = 
Üig_csum_by‹s
 - 
num_by‹s
;

6188 ià(
by‹s
 > 
to_ä“
)

6189 
to_ä“
 = 
by‹s
 -o_free;

6191 
to_ä“
 = 0;

6193 
	`¥š_uÆock
(&
šode
->
lock
);

6194 ià(
drÝ³d
)

6195 
to_ä“
 +ð
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
drÝ³d
);

6197 ià(
to_ä“
) {

6198 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
block_rsv
, 
to_ä“
);

6199 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "delalloc",

6200 
	`bŒfs_šo
(
šode
), 
to_ä“
, 0);

6202 ià(
d–®loc_lock
)

6203 
	`mu‹x_uÆock
(&
šode
->
d–®loc_mu‹x
);

6204  
»t
;

6205 
	}
}

6216 
	$bŒfs_d–®loc_»Ëa£_m‘ad©a
(
bŒfs_šode
 *
šode
, 
u64
 
num_by‹s
)

6218 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

6219 
u64
 
to_ä“
 = 0;

6220 
drÝ³d
;

6222 
num_by‹s
 = 
	`ALIGN
Òum_by‹s, 
fs_šfo
->
£ùÜsize
);

6223 
	`¥š_lock
(&
šode
->
lock
);

6224 
drÝ³d
 = 
	`drÝ_out¡ªdšg_ex‹Á
(
šode
, 
num_by‹s
);

6226 ià(
num_by‹s
)

6227 
to_ä“
 = 
	`ÿlc_csum_m‘ad©a_size
(
šode
, 
num_by‹s
, 0);

6228 
	`¥š_uÆock
(&
šode
->
lock
);

6229 ià(
drÝ³d
 > 0)

6230 
to_ä“
 +ð
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
drÝ³d
);

6232 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

6235 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "d–®loc", 
	`bŒfs_šo
(
šode
),

6236 
to_ä“
, 0);

6238 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
d–®loc_block_rsv
, 
to_ä“
);

6239 
	}
}

6266 
	$bŒfs_d–®loc_»£rve_¥aû
(
šode
 *inode,

6267 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

6269 
»t
;

6271 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

6272 ià(
»t
 < 0)

6273  
»t
;

6274 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
), 
Ën
);

6275 ià(
»t
 < 0)

6276 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, *
»£rved
, 
¡¬t
, 
Ën
);

6277  
»t
;

6278 
	}
}

6295 
	$bŒfs_d–®loc_»Ëa£_¥aû
(
šode
 *inode,

6296 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

6298 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
), 
Ën
);

6299 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

6300 
	}
}

6302 
	$upd©e_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6303 
bŒfs_fs_šfo
 *
šfo
, 
u64
 
by‹Ä
,

6304 
u64
 
num_by‹s
, 
®loc
)

6306 
bŒfs_block_group_ÿche
 *
ÿche
 = 
NULL
;

6307 
u64
 
tÙ®
 = 
num_by‹s
;

6308 
u64
 
Þd_v®
;

6309 
u64
 
by‹_š_group
;

6310 
çùÜ
;

6313 
	`¥š_lock
(&
šfo
->
d–®loc_roÙ_lock
);

6314 
Þd_v®
 = 
	`bŒfs_su³r_by‹s_u£d
(
šfo
->
su³r_cÝy
);

6315 ià(
®loc
)

6316 
Þd_v®
 +ð
num_by‹s
;

6318 
Þd_v®
 -ð
num_by‹s
;

6319 
	`bŒfs_£t_su³r_by‹s_u£d
(
šfo
->
su³r_cÝy
, 
Þd_v®
);

6320 
	`¥š_uÆock
(&
šfo
->
d–®loc_roÙ_lock
);

6322 
tÙ®
) {

6323 
ÿche
 = 
	`bŒfs_lookup_block_group
(
šfo
, 
by‹Ä
);

6324 ià(!
ÿche
)

6325  -
ENOENT
;

6326 ià(
ÿche
->
æags
 & (
BTRFS_BLOCK_GROUP_DUP
 |

6327 
BTRFS_BLOCK_GROUP_RAID1
 |

6328 
BTRFS_BLOCK_GROUP_RAID10
))

6329 
çùÜ
 = 2;

6331 
çùÜ
 = 1;

6338 ià(!
®loc
 && 
ÿche
->
ÿched
 =ð
BTRFS_CACHE_NO
)

6339 
	`ÿche_block_group
(
ÿche
, 1);

6341 
by‹_š_group
 = 
by‹Ä
 - 
ÿche
->
key
.
objeùid
;

6342 
	`WARN_ON
(
by‹_š_group
 > 
ÿche
->
key
.
off£t
);

6344 
	`¥š_lock
(&
ÿche
->
¥aû_šfo
->
lock
);

6345 
	`¥š_lock
(&
ÿche
->
lock
);

6347 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SPACE_CACHE
) &&

6348 
ÿche
->
disk_ÿche_¡©e
 < 
BTRFS_DC_CLEAR
)

6349 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

6351 
Þd_v®
 = 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
);

6352 
num_by‹s
 = 
	`mš
(
tÙ®
, 
ÿche
->
key
.
off£t
 - 
by‹_š_group
);

6353 ià(
®loc
) {

6354 
Þd_v®
 +ð
num_by‹s
;

6355 
	`bŒfs_£t_block_group_u£d
(&
ÿche
->
™em
, 
Þd_v®
);

6356 
ÿche
->
»£rved
 -ð
num_by‹s
;

6357 
ÿche
->
¥aû_šfo
->
by‹s_»£rved
 -ð
num_by‹s
;

6358 
ÿche
->
¥aû_šfo
->
by‹s_u£d
 +ð
num_by‹s
;

6359 
ÿche
->
¥aû_šfo
->
disk_u£d
 +ð
num_by‹s
 * 
çùÜ
;

6360 
	`¥š_uÆock
(&
ÿche
->
lock
);

6361 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

6363 
Þd_v®
 -ð
num_by‹s
;

6364 
	`bŒfs_£t_block_group_u£d
(&
ÿche
->
™em
, 
Þd_v®
);

6365 
ÿche
->
pšÃd
 +ð
num_by‹s
;

6366 
ÿche
->
¥aû_šfo
->
by‹s_pšÃd
 +ð
num_by‹s
;

6367 
ÿche
->
¥aû_šfo
->
by‹s_u£d
 -ð
num_by‹s
;

6368 
ÿche
->
¥aû_šfo
->
disk_u£d
 -ð
num_by‹s
 * 
çùÜ
;

6369 
	`¥š_uÆock
(&
ÿche
->
lock
);

6370 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

6372 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
šfo
, "pinned",

6373 
ÿche
->
¥aû_šfo
->
æags
,

6374 
num_by‹s
, 1);

6375 
	`³rýu_couÁ”_add
(&
ÿche
->
¥aû_šfo
->
tÙ®_by‹s_pšÃd
,

6376 
num_by‹s
);

6377 
	`£t_ex‹Á_dœty
(
šfo
->
pšÃd_ex‹Ás
,

6378 
by‹Ä
, by‹Ä + 
num_by‹s
 - 1,

6379 
GFP_NOFS
 | 
__GFP_NOFAIL
);

6382 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

6383 ià(
	`li¡_em±y
(&
ÿche
->
dœty_li¡
)) {

6384 
	`li¡_add_ž
(&
ÿche
->
dœty_li¡
,

6385 &
Œªs
->
Œª§ùiÚ
->
dœty_bgs
);

6386 
Œªs
->
Œª§ùiÚ
->
num_dœty_bgs
++;

6387 
	`bŒfs_g‘_block_group
(
ÿche
);

6389 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

6397 ià(!
®loc
 && 
Þd_v®
 == 0) {

6398 
	`¥š_lock
(&
šfo
->
unu£d_bgs_lock
);

6399 ià(
	`li¡_em±y
(&
ÿche
->
bg_li¡
)) {

6400 
	`bŒfs_g‘_block_group
(
ÿche
);

6401 
	`li¡_add_ž
(&
ÿche
->
bg_li¡
,

6402 &
šfo
->
unu£d_bgs
);

6404 
	`¥š_uÆock
(&
šfo
->
unu£d_bgs_lock
);

6407 
	`bŒfs_put_block_group
(
ÿche
);

6408 
tÙ®
 -ð
num_by‹s
;

6409 
by‹Ä
 +ð
num_by‹s
;

6412 
	}
}

6414 
u64
 
	$fœ¡_logiÿl_by‹
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
£¬ch_¡¬t
)

6416 
bŒfs_block_group_ÿche
 *
ÿche
;

6417 
u64
 
by‹Ä
;

6419 
	`¥š_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

6420 
by‹Ä
 = 
fs_šfo
->
fœ¡_logiÿl_by‹
;

6421 
	`¥š_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

6423 ià(
by‹Ä
 < (
u64
)-1)

6424  
by‹Ä
;

6426 
ÿche
 = 
	`bŒfs_lookup_fœ¡_block_group
(
fs_šfo
, 
£¬ch_¡¬t
);

6427 ià(!
ÿche
)

6430 
by‹Ä
 = 
ÿche
->
key
.
objeùid
;

6431 
	`bŒfs_put_block_group
(
ÿche
);

6433  
by‹Ä
;

6434 
	}
}

6436 
	$pš_down_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

6437 
bŒfs_block_group_ÿche
 *
ÿche
,

6438 
u64
 
by‹Ä
, u64 
num_by‹s
, 
»£rved
)

6440 
	`¥š_lock
(&
ÿche
->
¥aû_šfo
->
lock
);

6441 
	`¥š_lock
(&
ÿche
->
lock
);

6442 
ÿche
->
pšÃd
 +ð
num_by‹s
;

6443 
ÿche
->
¥aû_šfo
->
by‹s_pšÃd
 +ð
num_by‹s
;

6444 ià(
»£rved
) {

6445 
ÿche
->
»£rved
 -ð
num_by‹s
;

6446 
ÿche
->
¥aû_šfo
->
by‹s_»£rved
 -ð
num_by‹s
;

6448 
	`¥š_uÆock
(&
ÿche
->
lock
);

6449 
	`¥š_uÆock
(&
ÿche
->
¥aû_šfo
->
lock
);

6451 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "pinned",

6452 
ÿche
->
¥aû_šfo
->
æags
, 
num_by‹s
, 1);

6453 
	`³rýu_couÁ”_add
(&
ÿche
->
¥aû_šfo
->
tÙ®_by‹s_pšÃd
, 
num_by‹s
);

6454 
	`£t_ex‹Á_dœty
(
fs_šfo
->
pšÃd_ex‹Ás
, 
by‹Ä
,

6455 
by‹Ä
 + 
num_by‹s
 - 1, 
GFP_NOFS
 | 
__GFP_NOFAIL
);

6457 
	}
}

6462 
	$bŒfs_pš_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

6463 
u64
 
by‹Ä
, u64 
num_by‹s
, 
»£rved
)

6465 
bŒfs_block_group_ÿche
 *
ÿche
;

6467 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

6468 
	`BUG_ON
(!
ÿche
);

6470 
	`pš_down_ex‹Á
(
fs_šfo
, 
ÿche
, 
by‹Ä
, 
num_by‹s
, 
»£rved
);

6472 
	`bŒfs_put_block_group
(
ÿche
);

6474 
	}
}

6479 
	$bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
bŒfs_fs_šfo
 *
fs_šfo
,

6480 
u64
 
by‹Ä
, u64 
num_by‹s
)

6482 
bŒfs_block_group_ÿche
 *
ÿche
;

6483 
»t
;

6485 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

6486 ià(!
ÿche
)

6487  -
EINVAL
;

6495 
	`ÿche_block_group
(
ÿche
, 1);

6497 
	`pš_down_ex‹Á
(
fs_šfo
, 
ÿche
, 
by‹Ä
, 
num_by‹s
, 0);

6500 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
by‹Ä
, 
num_by‹s
);

6501 
	`bŒfs_put_block_group
(
ÿche
);

6502  
»t
;

6503 
	}
}

6505 
	$__exþude_logged_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

6506 
u64
 
¡¬t
, u64 
num_by‹s
)

6508 
»t
;

6509 
bŒfs_block_group_ÿche
 *
block_group
;

6510 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

6512 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

6513 ià(!
block_group
)

6514  -
EINVAL
;

6516 
	`ÿche_block_group
(
block_group
, 0);

6517 
ÿchšg_ùl
 = 
	`g‘_ÿchšg_cÚŒÞ
(
block_group
);

6519 ià(!
ÿchšg_ùl
) {

6521 
	`BUG_ON
(!
	`block_group_ÿche_dÚe
(
block_group
));

6522 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
block_group
, 
¡¬t
, 
num_by‹s
);

6524 
	`mu‹x_lock
(&
ÿchšg_ùl
->
mu‹x
);

6526 ià(
¡¬t
 >ð
ÿchšg_ùl
->
´og»ss
) {

6527 
»t
 = 
	`add_exþuded_ex‹Á
(
fs_šfo
, 
¡¬t
, 
num_by‹s
);

6528 } ià(
¡¬t
 + 
num_by‹s
 <ð
ÿchšg_ùl
->
´og»ss
) {

6529 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
block_group
,

6530 
¡¬t
, 
num_by‹s
);

6532 
num_by‹s
 = 
ÿchšg_ùl
->
´og»ss
 - 
¡¬t
;

6533 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
block_group
,

6534 
¡¬t
, 
num_by‹s
);

6535 ià(
»t
)

6536 
out_lock
;

6538 
num_by‹s
 = (
¡¬t
 +‚um_bytes) -

6539 
ÿchšg_ùl
->
´og»ss
;

6540 
¡¬t
 = 
ÿchšg_ùl
->
´og»ss
;

6541 
»t
 = 
	`add_exþuded_ex‹Á
(
fs_šfo
, 
¡¬t
, 
num_by‹s
);

6543 
out_lock
:

6544 
	`mu‹x_uÆock
(&
ÿchšg_ùl
->
mu‹x
);

6545 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

6547 
	`bŒfs_put_block_group
(
block_group
);

6548  
»t
;

6549 
	}
}

6551 
	$bŒfs_exþude_logged_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

6552 
ex‹Á_bufãr
 *
eb
)

6554 
bŒfs_fže_ex‹Á_™em
 *
™em
;

6555 
bŒfs_key
 
key
;

6556 
found_ty³
;

6557 
i
;

6559 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
))

6562 
i
 = 0; i < 
	`bŒfs_h—d”_Ä™ems
(
eb
); i++) {

6563 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
i
);

6564 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

6566 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
i
, 
bŒfs_fže_ex‹Á_™em
);

6567 
found_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
™em
);

6568 ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
)

6570 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
™em
) == 0)

6572 
key
.
objeùid
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
™em
);

6573 
key
.
off£t
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
eb
, 
™em
);

6574 
	`__exþude_logged_ex‹Á
(
fs_šfo
, 
key
.
objeùid
, key.
off£t
);

6578 
	}
}

6581 
	$bŒfs_šc_block_group_»£rv©iÚs
(
bŒfs_block_group_ÿche
 *
bg
)

6583 
	`©omic_šc
(&
bg
->
»£rv©iÚs
);

6584 
	}
}

6586 
	$bŒfs_dec_block_group_»£rv©iÚs
(
bŒfs_fs_šfo
 *
fs_šfo
,

6587 cÚ¡ 
u64
 
¡¬t
)

6589 
bŒfs_block_group_ÿche
 *
bg
;

6591 
bg
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

6592 
	`ASSERT
(
bg
);

6593 ià(
	`©omic_dec_ªd_‹¡
(&
bg
->
»£rv©iÚs
))

6594 
	`wake_up_©omic_t
(&
bg
->
»£rv©iÚs
);

6595 
	`bŒfs_put_block_group
(
bg
);

6596 
	}
}

6598 
	$bŒfs_wa™_bg_»£rv©iÚs_©omic_t
(
©omic_t
 *
a
)

6600 
	`scheduË
();

6602 
	}
}

6604 
	$bŒfs_wa™_block_group_»£rv©iÚs
(
bŒfs_block_group_ÿche
 *
bg
)

6606 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
bg
->space_info;

6608 
	`ASSERT
(
bg
->
ro
);

6610 ià(!(
bg
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

6623 
	`down_wr™e
(&
¥aû_šfo
->
groups_£m
);

6624 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

6626 
	`wa™_Ú_©omic_t
(&
bg
->
»£rv©iÚs
,

6627 
bŒfs_wa™_bg_»£rv©iÚs_©omic_t
,

6628 
TASK_UNINTERRUPTIBLE
);

6629 
	}
}

6643 
	$bŒfs_add_»£rved_by‹s
(
bŒfs_block_group_ÿche
 *
ÿche
,

6644 
u64
 
¿m_by‹s
, u64 
num_by‹s
, 
d–®loc
)

6646 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
ÿche
->space_info;

6647 
»t
 = 0;

6649 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

6650 
	`¥š_lock
(&
ÿche
->
lock
);

6651 ià(
ÿche
->
ro
) {

6652 
»t
 = -
EAGAIN
;

6654 
ÿche
->
»£rved
 +ð
num_by‹s
;

6655 
¥aû_šfo
->
by‹s_»£rved
 +ð
num_by‹s
;

6657 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
ÿche
->
fs_šfo
,

6658 "¥aû_šfo", 
¥aû_šfo
->
æags
,

6659 
¿m_by‹s
, 0);

6660 
¥aû_šfo
->
by‹s_may_u£
 -ð
¿m_by‹s
;

6661 ià(
d–®loc
)

6662 
ÿche
->
d–®loc_by‹s
 +ð
num_by‹s
;

6664 
	`¥š_uÆock
(&
ÿche
->
lock
);

6665 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

6666  
»t
;

6667 
	}
}

6681 
	$bŒfs_ä“_»£rved_by‹s
(
bŒfs_block_group_ÿche
 *
ÿche
,

6682 
u64
 
num_by‹s
, 
d–®loc
)

6684 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
ÿche
->space_info;

6685 
»t
 = 0;

6687 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

6688 
	`¥š_lock
(&
ÿche
->
lock
);

6689 ià(
ÿche
->
ro
)

6690 
¥aû_šfo
->
by‹s_»adÚly
 +ð
num_by‹s
;

6691 
ÿche
->
»£rved
 -ð
num_by‹s
;

6692 
¥aû_šfo
->
by‹s_»£rved
 -ð
num_by‹s
;

6694 ià(
d–®loc
)

6695 
ÿche
->
d–®loc_by‹s
 -ð
num_by‹s
;

6696 
	`¥š_uÆock
(&
ÿche
->
lock
);

6697 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

6698  
»t
;

6699 
	}
}

6700 
	$bŒfs_´•¬e_ex‹Á_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
)

6702 
bŒfs_ÿchšg_cÚŒÞ
 *
Ãxt
;

6703 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

6704 
bŒfs_block_group_ÿche
 *
ÿche
;

6706 
	`down_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

6708 
	`li¡_fÜ_—ch_’Œy_§ã
(
ÿchšg_ùl
, 
Ãxt
,

6709 &
fs_šfo
->
ÿchšg_block_groups
, 
li¡
) {

6710 
ÿche
 = 
ÿchšg_ùl
->
block_group
;

6711 ià(
	`block_group_ÿche_dÚe
(
ÿche
)) {

6712 
ÿche
->
Ï¡_by‹_to_uÅš
 = (
u64
)-1;

6713 
	`li¡_d–_š™
(&
ÿchšg_ùl
->
li¡
);

6714 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

6716 
ÿche
->
Ï¡_by‹_to_uÅš
 = 
ÿchšg_ùl
->
´og»ss
;

6720 ià(
fs_šfo
->
pšÃd_ex‹Ás
 =ð&fs_šfo->
ä“d_ex‹Ás
[0])

6721 
fs_šfo
->
pšÃd_ex‹Ás
 = &fs_šfo->
ä“d_ex‹Ás
[1];

6723 
fs_šfo
->
pšÃd_ex‹Ás
 = &fs_šfo->
ä“d_ex‹Ás
[0];

6725 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

6727 
	`upd©e_glob®_block_rsv
(
fs_šfo
);

6728 
	}
}

6734 
bŒfs_ä“_þu¡”
 *

6735 
	$ãtch_þu¡”_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

6736 
bŒfs_¥aû_šfo
 *
¥aû_šfo
, 
u64
 *
em±y_þu¡”
)

6738 
bŒfs_ä“_þu¡”
 *
»t
 = 
NULL
;

6740 *
em±y_þu¡”
 = 0;

6741 ià(
	`bŒfs_mixed_¥aû_šfo
(
¥aû_šfo
))

6742  
»t
;

6744 ià(
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

6745 
»t
 = &
fs_šfo
->
m‘a_®loc_þu¡”
;

6746 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SSD
))

6747 *
em±y_þu¡”
 = 
SZ_2M
;

6749 *
em±y_þu¡”
 = 
SZ_64K
;

6750 } ià((
¥aû_šfo
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

6751 
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SSD_SPREAD
)) {

6752 *
em±y_þu¡”
 = 
SZ_2M
;

6753 
»t
 = &
fs_šfo
->
d©a_®loc_þu¡”
;

6756  
»t
;

6757 
	}
}

6759 
	$uÅš_ex‹Á_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

6760 
u64
 
¡¬t
, u64 
’d
,

6761 cÚ¡ 
boÞ
 
»tuº_ä“_¥aû
)

6763 
bŒfs_block_group_ÿche
 *
ÿche
 = 
NULL
;

6764 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

6765 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

6766 
bŒfs_ä“_þu¡”
 *
þu¡”
 = 
NULL
;

6767 
u64
 
Ën
;

6768 
u64
 
tÙ®_uÅšÃd
 = 0;

6769 
u64
 
em±y_þu¡”
 = 0;

6770 
boÞ
 
»adÚly
;

6772 
¡¬t
 <ð
’d
) {

6773 
»adÚly
 = 
çl£
;

6774 ià(!
ÿche
 ||

6775 
¡¬t
 >ð
ÿche
->
key
.
objeùid
 + cache->key.
off£t
) {

6776 ià(
ÿche
)

6777 
	`bŒfs_put_block_group
(
ÿche
);

6778 
tÙ®_uÅšÃd
 = 0;

6779 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

6780 
	`BUG_ON
(!
ÿche
);

6782 
þu¡”
 = 
	`ãtch_þu¡”_šfo
(
fs_šfo
,

6783 
ÿche
->
¥aû_šfo
,

6784 &
em±y_þu¡”
);

6785 
em±y_þu¡”
 <<= 1;

6788 
Ën
 = 
ÿche
->
key
.
objeùid
 + cache->key.
off£t
 - 
¡¬t
;

6789 
Ën
 = 
	`mš
Ö’, 
’d
 + 1 - 
¡¬t
);

6791 ià(
¡¬t
 < 
ÿche
->
Ï¡_by‹_to_uÅš
) {

6792 
Ën
 = 
	`mš
Ö’, 
ÿche
->
Ï¡_by‹_to_uÅš
 - 
¡¬t
);

6793 ià(
»tuº_ä“_¥aû
)

6794 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
¡¬t
, 
Ën
);

6797 
¡¬t
 +ð
Ën
;

6798 
tÙ®_uÅšÃd
 +ð
Ën
;

6799 
¥aû_šfo
 = 
ÿche
->space_info;

6807 ià(
þu¡”
 && clu¡”->
äagm’‹d
 &&

6808 
tÙ®_uÅšÃd
 > 
em±y_þu¡”
) {

6809 
	`¥š_lock
(&
þu¡”
->
lock
);

6810 
þu¡”
->
äagm’‹d
 = 0;

6811 
	`¥š_uÆock
(&
þu¡”
->
lock
);

6814 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

6815 
	`¥š_lock
(&
ÿche
->
lock
);

6816 
ÿche
->
pšÃd
 -ð
Ën
;

6817 
¥aû_šfo
->
by‹s_pšÃd
 -ð
Ën
;

6819 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "pinned",

6820 
¥aû_šfo
->
æags
, 
Ën
, 0);

6821 
¥aû_šfo
->
max_ex‹Á_size
 = 0;

6822 
	`³rýu_couÁ”_add
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
, -
Ën
);

6823 ià(
ÿche
->
ro
) {

6824 
¥aû_šfo
->
by‹s_»adÚly
 +ð
Ën
;

6825 
»adÚly
 = 
Œue
;

6827 
	`¥š_uÆock
(&
ÿche
->
lock
);

6828 ià(!
»adÚly
 && 
»tuº_ä“_¥aû
 &&

6829 
glob®_rsv
->
¥aû_šfo
 == space_info) {

6830 
u64
 
to_add
 = 
Ën
;

6832 
	`¥š_lock
(&
glob®_rsv
->
lock
);

6833 ià(!
glob®_rsv
->
fuÎ
) {

6834 
to_add
 = 
	`mš
(
Ën
, 
glob®_rsv
->
size
 -

6835 
glob®_rsv
->
»£rved
);

6836 
glob®_rsv
->
»£rved
 +ð
to_add
;

6837 
¥aû_šfo
->
by‹s_may_u£
 +ð
to_add
;

6838 ià(
glob®_rsv
->
»£rved
 >ðglob®_rsv->
size
)

6839 
glob®_rsv
->
fuÎ
 = 1;

6840 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
,

6842 
¥aû_šfo
->
æags
,

6843 
to_add
, 1);

6844 
Ën
 -ð
to_add
;

6846 
	`¥š_uÆock
(&
glob®_rsv
->
lock
);

6848 ià(
Ën
)

6849 
	`¥aû_šfo_add_Ãw_by‹s
(
fs_šfo
, 
¥aû_šfo
,

6850 
Ën
);

6852 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

6855 ià(
ÿche
)

6856 
	`bŒfs_put_block_group
(
ÿche
);

6858 
	}
}

6860 
	$bŒfs_fšish_ex‹Á_comm™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6861 
bŒfs_fs_šfo
 *
fs_šfo
)

6863 
bŒfs_block_group_ÿche
 *
block_group
, *
tmp
;

6864 
li¡_h—d
 *
d–‘ed_bgs
;

6865 
ex‹Á_io_Œ“
 *
uÅš
;

6866 
u64
 
¡¬t
;

6867 
u64
 
’d
;

6868 
»t
;

6870 ià(
fs_šfo
->
pšÃd_ex‹Ás
 =ð&fs_šfo->
ä“d_ex‹Ás
[0])

6871 
uÅš
 = &
fs_šfo
->
ä“d_ex‹Ás
[1];

6873 
uÅš
 = &
fs_šfo
->
ä“d_ex‹Ás
[0];

6875 !
Œªs
->
abÜ‹d
) {

6876 
	`mu‹x_lock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

6877 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(
uÅš
, 0, &
¡¬t
, &
’d
,

6878 
EXTENT_DIRTY
, 
NULL
);

6879 ià(
»t
) {

6880 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

6884 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DISCARD
))

6885 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
, 
¡¬t
,

6886 
’d
 + 1 - 
¡¬t
, 
NULL
);

6888 
	`þ—r_ex‹Á_dœty
(
uÅš
, 
¡¬t
, 
’d
);

6889 
	`uÅš_ex‹Á_¿nge
(
fs_šfo
, 
¡¬t
, 
’d
, 
Œue
);

6890 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

6891 
	`cÚd_»sched
();

6899 
d–‘ed_bgs
 = &
Œªs
->
Œª§ùiÚ
->deleted_bgs;

6900 
	`li¡_fÜ_—ch_’Œy_§ã
(
block_group
, 
tmp
, 
d–‘ed_bgs
, 
bg_li¡
) {

6901 
u64
 
Œimmed
 = 0;

6903 
»t
 = -
EROFS
;

6904 ià(!
Œªs
->
abÜ‹d
)

6905 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
,

6906 
block_group
->
key
.
objeùid
,

6907 
block_group
->
key
.
off£t
,

6908 &
Œimmed
);

6910 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

6911 
	`bŒfs_put_block_group_Œimmšg
(
block_group
);

6912 
	`bŒfs_put_block_group
(
block_group
);

6914 ià(
»t
) {

6915 cÚ¡ *
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
»t
);

6916 
	`bŒfs_w¬n
(
fs_šfo
,

6918 
»t
, 
”r¡r
);

6923 
	}
}

6925 
	$__bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6926 
bŒfs_fs_šfo
 *
šfo
,

6927 
bŒfs_d–ayed_»f_node
 *
node
, 
u64
 
·»Á
,

6928 
u64
 
roÙ_objeùid
, u64 
owÃr_objeùid
,

6929 
u64
 
owÃr_off£t
, 
»fs_to_drÝ
,

6930 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
)

6932 
bŒfs_key
 
key
;

6933 
bŒfs_·th
 *
·th
;

6934 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
šfo
->extent_root;

6935 
ex‹Á_bufãr
 *
Ëaf
;

6936 
bŒfs_ex‹Á_™em
 *
ei
;

6937 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

6938 
»t
;

6939 
is_d©a
;

6940 
ex‹Á_¦Ù
 = 0;

6941 
found_ex‹Á
 = 0;

6942 
num_to_d–
 = 1;

6943 
u32
 
™em_size
;

6944 
u64
 
»fs
;

6945 
u64
 
by‹Ä
 = 
node
->bytenr;

6946 
u64
 
num_by‹s
 = 
node
->num_bytes;

6947 
Ï¡_»f
 = 0;

6948 
boÞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
šfo
, 
SKINNY_METADATA
);

6950 
·th
 = 
	`bŒfs_®loc_·th
();

6951 ià(!
·th
)

6952  -
ENOMEM
;

6954 
·th
->
»ada
 = 
READA_FORWARD
;

6955 
·th
->
Ëave_¥šnšg
 = 1;

6957 
is_d©a
 = 
owÃr_objeùid
 >ð
BTRFS_FIRST_FREE_OBJECTID
;

6958 
	`BUG_ON
(!
is_d©a
 && 
»fs_to_drÝ
 != 1);

6960 ià(
is_d©a
)

6961 
skšny_m‘ad©a
 = 0;

6963 
»t
 = 
	`lookup_ex‹Á_back»f
(
Œªs
, 
šfo
, 
·th
, &
œef
,

6964 
by‹Ä
, 
num_by‹s
, 
·»Á
,

6965 
roÙ_objeùid
, 
owÃr_objeùid
,

6966 
owÃr_off£t
);

6967 ià(
»t
 == 0) {

6968 
ex‹Á_¦Ù
 = 
·th
->
¦Ùs
[0];

6969 
ex‹Á_¦Ù
 >= 0) {

6970 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

6971 
ex‹Á_¦Ù
);

6972 ià(
key
.
objeùid
 !ð
by‹Ä
)

6974 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

6975 
key
.
off£t
 =ð
num_by‹s
) {

6976 
found_ex‹Á
 = 1;

6979 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
 &&

6980 
key
.
off£t
 =ð
owÃr_objeùid
) {

6981 
found_ex‹Á
 = 1;

6984 ià(
·th
->
¦Ùs
[0] - 
ex‹Á_¦Ù
 > 5)

6986 
ex‹Á_¦Ù
--;

6988 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


6989 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0], 
ex‹Á_¦Ù
);

6990 ià(
found_ex‹Á
 && 
™em_size
 < (*
ei
))

6991 
found_ex‹Á
 = 0;

6993 ià(!
found_ex‹Á
) {

6994 
	`BUG_ON
(
œef
);

6995 
»t
 = 
	`»move_ex‹Á_back»f
(
Œªs
, 
šfo
, 
·th
, 
NULL
,

6996 
»fs_to_drÝ
,

6997 
is_d©a
, &
Ï¡_»f
);

6998 ià(
»t
) {

6999 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7000 
out
;

7002 
	`bŒfs_»Ëa£_·th
(
·th
);

7003 
·th
->
Ëave_¥šnšg
 = 1;

7005 
key
.
objeùid
 = 
by‹Ä
;

7006 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

7007 
key
.
off£t
 = 
num_by‹s
;

7009 ià(!
is_d©a
 && 
skšny_m‘ad©a
) {

7010 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

7011 
key
.
off£t
 = 
owÃr_objeùid
;

7014 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
ex‹Á_roÙ
,

7015 &
key
, 
·th
, -1, 1);

7016 ià(
»t
 > 0 && 
skšny_m‘ad©a
 && 
·th
->
¦Ùs
[0]) {

7021 
·th
->
¦Ùs
[0]--;

7022 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

7023 
·th
->
¦Ùs
[0]);

7024 ià(
key
.
objeùid
 =ð
by‹Ä
 &&

7025 
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

7026 
key
.
off£t
 =ð
num_by‹s
)

7027 
»t
 = 0;

7030 ià(
»t
 > 0 && 
skšny_m‘ad©a
) {

7031 
skšny_m‘ad©a
 = 
çl£
;

7032 
key
.
objeùid
 = 
by‹Ä
;

7033 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

7034 
key
.
off£t
 = 
num_by‹s
;

7035 
	`bŒfs_»Ëa£_·th
(
·th
);

7036 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
ex‹Á_roÙ
,

7037 &
key
, 
·th
, -1, 1);

7040 ià(
»t
) {

7041 
	`bŒfs_”r
(
šfo
,

7043 
»t
, 
by‹Ä
);

7044 ià(
»t
 > 0)

7045 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

7047 ià(
»t
 < 0) {

7048 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7049 
out
;

7051 
ex‹Á_¦Ù
 = 
·th
->
¦Ùs
[0];

7053 } ià(
	`WARN_ON
(
»t
 =ð-
ENOENT
)) {

7054 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

7055 
	`bŒfs_”r
(
šfo
,

7057 
by‹Ä
, 
·»Á
, 
roÙ_objeùid
, 
owÃr_objeùid
,

7058 
owÃr_off£t
);

7059 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7060 
out
;

7062 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7063 
out
;

7066 
Ëaf
 = 
·th
->
nodes
[0];

7067 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
ex‹Á_¦Ù
);

7068 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


7069 ià(
™em_size
 < (*
ei
)) {

7070 
	`BUG_ON
(
found_ex‹Á
 || 
ex‹Á_¦Ù
 !ð
·th
->
¦Ùs
[0]);

7071 
»t
 = 
	`cÚv”t_ex‹Á_™em_v0
(
Œªs
, 
šfo
, 
·th
, 
owÃr_objeùid
,

7073 ià(
»t
 < 0) {

7074 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7075 
out
;

7078 
	`bŒfs_»Ëa£_·th
(
·th
);

7079 
·th
->
Ëave_¥šnšg
 = 1;

7081 
key
.
objeùid
 = 
by‹Ä
;

7082 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

7083 
key
.
off£t
 = 
num_by‹s
;

7085 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
ex‹Á_roÙ
, &
key
, 
·th
,

7087 ià(
»t
) {

7088 
	`bŒfs_”r
(
šfo
,

7090 
»t
, 
by‹Ä
);

7091 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

7093 ià(
»t
 < 0) {

7094 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7095 
out
;

7098 
ex‹Á_¦Ù
 = 
·th
->
¦Ùs
[0];

7099 
Ëaf
 = 
·th
->
nodes
[0];

7100 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
ex‹Á_¦Ù
);

7103 
	`BUG_ON
(
™em_size
 < (*
ei
));

7104 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
ex‹Á_¦Ù
,

7105 
bŒfs_ex‹Á_™em
);

7106 ià(
owÃr_objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

7107 
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
) {

7108 
bŒfs_Œ“_block_šfo
 *
bi
;

7109 
	`BUG_ON
(
™em_size
 < (*
ei
è+ (*
bi
));

7110 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

7111 
	`WARN_ON
(
owÃr_objeùid
 !ð
	`bŒfs_Œ“_block_Ëv–
(
Ëaf
, 
bi
));

7114 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
Ëaf
, 
ei
);

7115 ià(
»fs
 < 
»fs_to_drÝ
) {

7116 
	`bŒfs_”r
(
šfo
,

7118 
»fs_to_drÝ
, 
»fs
, 
by‹Ä
);

7119 
»t
 = -
EINVAL
;

7120 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7121 
out
;

7123 
»fs
 -ð
»fs_to_drÝ
;

7125 ià(
»fs
 > 0) {

7126 ià(
ex‹Á_Ý
)

7127 
	`__run_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
, 
Ëaf
, 
ei
);

7132 ià(
œef
) {

7133 
	`BUG_ON
(!
found_ex‹Á
);

7135 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ei
, 
»fs
);

7136 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

7138 ià(
found_ex‹Á
) {

7139 
»t
 = 
	`»move_ex‹Á_back»f
(
Œªs
, 
šfo
, 
·th
,

7140 
œef
, 
»fs_to_drÝ
,

7141 
is_d©a
, &
Ï¡_»f
);

7142 ià(
»t
) {

7143 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7144 
out
;

7148 ià(
found_ex‹Á
) {

7149 
	`BUG_ON
(
is_d©a
 && 
»fs_to_drÝ
 !=

7150 
	`ex‹Á_d©a_»f_couÁ
(
·th
, 
œef
));

7151 ià(
œef
) {

7152 
	`BUG_ON
(
·th
->
¦Ùs
[0] !ð
ex‹Á_¦Ù
);

7154 
	`BUG_ON
(
·th
->
¦Ùs
[0] !ð
ex‹Á_¦Ù
 + 1);

7155 
·th
->
¦Ùs
[0] = 
ex‹Á_¦Ù
;

7156 
num_to_d–
 = 2;

7160 
Ï¡_»f
 = 1;

7161 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
ex‹Á_roÙ
, 
·th
,…©h->
¦Ùs
[0],

7162 
num_to_d–
);

7163 ià(
»t
) {

7164 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7165 
out
;

7167 
	`bŒfs_»Ëa£_·th
(
·th
);

7169 ià(
is_d©a
) {

7170 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
šfo
, 
by‹Ä
, 
num_by‹s
);

7171 ià(
»t
) {

7172 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7173 
out
;

7177 
»t
 = 
	`add_to_ä“_¥aû_Œ“
(
Œªs
, 
šfo
, 
by‹Ä
, 
num_by‹s
);

7178 ià(
»t
) {

7179 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7180 
out
;

7183 
»t
 = 
	`upd©e_block_group
(
Œªs
, 
šfo
, 
by‹Ä
, 
num_by‹s
, 0);

7184 ià(
»t
) {

7185 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7186 
out
;

7189 
	`bŒfs_»Ëa£_·th
(
·th
);

7191 
out
:

7192 
	`bŒfs_ä“_·th
(
·th
);

7193  
»t
;

7194 
	}
}

7202 
nošlše
 
	$check_»f_þ—nup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7203 
u64
 
by‹Ä
)

7205 
bŒfs_d–ayed_»f_h—d
 *
h—d
;

7206 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

7207 
»t
 = 0;

7209 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

7210 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

7211 
h—d
 = 
	`bŒfs_fšd_d–ayed_»f_h—d
(
d–ayed_»fs
, 
by‹Ä
);

7212 ià(!
h—d
)

7213 
out_d–ayed_uÆock
;

7215 
	`¥š_lock
(&
h—d
->
lock
);

7216 ià(!
	`li¡_em±y
(&
h—d
->
»f_li¡
))

7217 
out
;

7219 ià(
h—d
->
ex‹Á_Ý
) {

7220 ià(!
h—d
->
mu¡_š£¹_»£rved
)

7221 
out
;

7222 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
h—d
->
ex‹Á_Ý
);

7223 
h—d
->
ex‹Á_Ý
 = 
NULL
;

7230 ià(!
	`mu‹x_Œylock
(&
h—d
->
mu‹x
))

7231 
out
;

7237 
h—d
->
node
.
š_Œ“
 = 0;

7238 
	`rb_”a£
(&
h—d
->
h»f_node
, &
d–ayed_»fs
->
h»f_roÙ
);

7240 
	`©omic_dec
(&
d–ayed_»fs
->
num_’Œ›s
);

7246 
d–ayed_»fs
->
num_h—ds
--;

7247 ià(
h—d
->
´oûssšg
 == 0)

7248 
d–ayed_»fs
->
num_h—ds_»ady
--;

7249 
h—d
->
´oûssšg
 = 0;

7250 
	`¥š_uÆock
(&
h—d
->
lock
);

7251 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

7253 
	`BUG_ON
(
h—d
->
ex‹Á_Ý
);

7254 ià(
h—d
->
mu¡_š£¹_»£rved
)

7255 
»t
 = 1;

7257 
	`mu‹x_uÆock
(&
h—d
->
mu‹x
);

7258 
	`bŒfs_put_d–ayed_»f
(&
h—d
->
node
);

7259  
»t
;

7260 
out
:

7261 
	`¥š_uÆock
(&
h—d
->
lock
);

7263 
out_d–ayed_uÆock
:

7264 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

7266 
	}
}

7268 
	$bŒfs_ä“_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7269 
bŒfs_roÙ
 *
roÙ
,

7270 
ex‹Á_bufãr
 *
buf
,

7271 
u64
 
·»Á
, 
Ï¡_»f
)

7273 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

7274 
pš
 = 1;

7275 
»t
;

7277 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
) {

7278 
Þd_»f_mod
, 
Ãw_»f_mod
;

7280 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
fs_šfo
, 
Œªs
, 
buf
->
¡¬t
,

7281 
buf
->
Ën
, 
·»Á
,

7282 
roÙ
->
roÙ_key
.
objeùid
,

7283 
	`bŒfs_h—d”_Ëv–
(
buf
),

7284 
BTRFS_DROP_DELAYED_REF
, 
NULL
,

7285 &
Þd_»f_mod
, &
Ãw_»f_mod
);

7286 
	`BUG_ON
(
»t
);

7287 
pš
 = 
Þd_»f_mod
 >ð0 && 
Ãw_»f_mod
 < 0;

7290 ià(
Ï¡_»f
 && 
	`bŒfs_h—d”_g’”©iÚ
(
buf
è=ð
Œªs
->
Œªsid
) {

7291 
bŒfs_block_group_ÿche
 *
ÿche
;

7293 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
) {

7294 
»t
 = 
	`check_»f_þ—nup
(
Œªs
, 
buf
->
¡¬t
);

7295 ià(!
»t
)

7296 
out
;

7299 
pš
 = 0;

7300 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
buf
->
¡¬t
);

7302 ià(
	`bŒfs_h—d”_æag
(
buf
, 
BTRFS_HEADER_FLAG_WRITTEN
)) {

7303 
	`pš_down_ex‹Á
(
fs_šfo
, 
ÿche
, 
buf
->
¡¬t
,

7304 
buf
->
Ën
, 1);

7305 
	`bŒfs_put_block_group
(
ÿche
);

7306 
out
;

7309 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
buf
->
bæags
));

7311 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
buf
->
¡¬t
, buf->
Ën
);

7312 
	`bŒfs_ä“_»£rved_by‹s
(
ÿche
, 
buf
->
Ën
, 0);

7313 
	`bŒfs_put_block_group
(
ÿche
);

7314 
	`Œaû_bŒfs_»£rved_ex‹Á_ä“
(
fs_šfo
, 
buf
->
¡¬t
, buf->
Ën
);

7316 
out
:

7317 ià(
pš
)

7318 
	`add_pšÃd_by‹s
(
fs_šfo
, 
buf
->
Ën
, 
	`bŒfs_h—d”_Ëv–
(buf),

7319 
roÙ
->
roÙ_key
.
objeùid
);

7321 ià(
Ï¡_»f
) {

7326 
	`þ—r_b™
(
EXTENT_BUFFER_CORRUPT
, &
buf
->
bæags
);

7328 
	}
}

7331 
	$bŒfs_ä“_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7332 
bŒfs_fs_šfo
 *
fs_šfo
,

7333 
u64
 
by‹Ä
, u64 
num_by‹s
, u64 
·»Á
, u64 
roÙ_objeùid
,

7334 
u64
 
owÃr
, u64 
off£t
)

7336 
Þd_»f_mod
, 
Ãw_»f_mod
;

7337 
»t
;

7339 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

7347 ià(
roÙ_objeùid
 =ð
BTRFS_TREE_LOG_OBJECTID
) {

7348 
	`WARN_ON
(
owÃr
 >ð
BTRFS_FIRST_FREE_OBJECTID
);

7350 
	`bŒfs_pš_ex‹Á
(
fs_šfo
, 
by‹Ä
, 
num_by‹s
, 1);

7351 
Þd_»f_mod
 = 
Ãw_»f_mod
 = 0;

7352 
»t
 = 0;

7353 } ià(
owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
) {

7354 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
fs_šfo
, 
Œªs
, 
by‹Ä
,

7355 
num_by‹s
, 
·»Á
,

7356 
roÙ_objeùid
, ()
owÃr
,

7357 
BTRFS_DROP_DELAYED_REF
, 
NULL
,

7358 &
Þd_»f_mod
, &
Ãw_»f_mod
);

7360 
»t
 = 
	`bŒfs_add_d–ayed_d©a_»f
(
fs_šfo
, 
Œªs
, 
by‹Ä
,

7361 
num_by‹s
, 
·»Á
,

7362 
roÙ_objeùid
, 
owÃr
, 
off£t
,

7363 0, 
BTRFS_DROP_DELAYED_REF
,

7364 &
Þd_»f_mod
, &
Ãw_»f_mod
);

7367 ià(
»t
 =ð0 && 
Þd_»f_mod
 >ð0 && 
Ãw_»f_mod
 < 0)

7368 
	`add_pšÃd_by‹s
(
fs_šfo
, 
num_by‹s
, 
owÃr
, 
roÙ_objeùid
);

7370  
»t
;

7371 
	}
}

7387 
nošlše
 

7388 
	$wa™_block_group_ÿche_´og»ss
(
bŒfs_block_group_ÿche
 *
ÿche
,

7389 
u64
 
num_by‹s
)

7391 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

7393 
ÿchšg_ùl
 = 
	`g‘_ÿchšg_cÚŒÞ
(
ÿche
);

7394 ià(!
ÿchšg_ùl
)

7397 
	`wa™_ev’t
(
ÿchšg_ùl
->
wa™
, 
	`block_group_ÿche_dÚe
(
ÿche
) ||

7398 (
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 >ð
num_by‹s
));

7400 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

7401 
	}
}

7403 
nošlše
 

7404 
	$wa™_block_group_ÿche_dÚe
(
bŒfs_block_group_ÿche
 *
ÿche
)

7406 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

7407 
»t
 = 0;

7409 
ÿchšg_ùl
 = 
	`g‘_ÿchšg_cÚŒÞ
(
ÿche
);

7410 ià(!
ÿchšg_ùl
)

7411  (
ÿche
->
ÿched
 =ð
BTRFS_CACHE_ERROR
è? -
EIO
 : 0;

7413 
	`wa™_ev’t
(
ÿchšg_ùl
->
wa™
, 
	`block_group_ÿche_dÚe
(
ÿche
));

7414 ià(
ÿche
->
ÿched
 =ð
BTRFS_CACHE_ERROR
)

7415 
»t
 = -
EIO
;

7416 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

7417  
»t
;

7418 
	}
}

7420 
	$__g‘_¿id_šdex
(
u64
 
æags
)

7422 ià(
æags
 & 
BTRFS_BLOCK_GROUP_RAID10
)

7423  
BTRFS_RAID_RAID10
;

7424 ià(
æags
 & 
BTRFS_BLOCK_GROUP_RAID1
)

7425  
BTRFS_RAID_RAID1
;

7426 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DUP
)

7427  
BTRFS_RAID_DUP
;

7428 ià(
æags
 & 
BTRFS_BLOCK_GROUP_RAID0
)

7429  
BTRFS_RAID_RAID0
;

7430 ià(
æags
 & 
BTRFS_BLOCK_GROUP_RAID5
)

7431  
BTRFS_RAID_RAID5
;

7432 ià(
æags
 & 
BTRFS_BLOCK_GROUP_RAID6
)

7433  
BTRFS_RAID_RAID6
;

7435  
BTRFS_RAID_SINGLE
;

7436 
	}
}

7438 
	$g‘_block_group_šdex
(
bŒfs_block_group_ÿche
 *
ÿche
)

7440  
	`__g‘_¿id_šdex
(
ÿche
->
æags
);

7441 
	}
}

7443 cÚ¡ *
	gbŒfs_¿id_ty³_Çmes
[
BTRFS_NR_RAID_TYPES
] = {

7444 [
BTRFS_RAID_RAID10
] = "raid10",

7445 [
BTRFS_RAID_RAID1
] = "raid1",

7446 [
BTRFS_RAID_DUP
] = "dup",

7447 [
BTRFS_RAID_RAID0
] = "raid0",

7448 [
BTRFS_RAID_SINGLE
] = "single",

7449 [
BTRFS_RAID_RAID5
] = "raid5",

7450 [
BTRFS_RAID_RAID6
] = "raid6",

7453 cÚ¡ *
	$g‘_¿id_Çme
(
bŒfs_¿id_ty³s
 
ty³
)

7455 ià(
ty³
 >ð
BTRFS_NR_RAID_TYPES
)

7456  
NULL
;

7458  
bŒfs_¿id_ty³_Çmes
[
ty³
];

7459 
	}
}

7461 
	ebŒfs_loÝ_ty³
 {

7462 
	mLOOP_CACHING_NOWAIT
 = 0,

7463 
	mLOOP_CACHING_WAIT
 = 1,

7464 
	mLOOP_ALLOC_CHUNK
 = 2,

7465 
	mLOOP_NO_EMPTY_SIZE
 = 3,

7468 
šlše
 

7469 
	$bŒfs_lock_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
,

7470 
d–®loc
)

7472 ià(
d–®loc
)

7473 
	`down_»ad
(&
ÿche
->
d©a_rw£m
);

7474 
	}
}

7476 
šlše
 

7477 
	$bŒfs_g¿b_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
,

7478 
d–®loc
)

7480 
	`bŒfs_g‘_block_group
(
ÿche
);

7481 ià(
d–®loc
)

7482 
	`down_»ad
(&
ÿche
->
d©a_rw£m
);

7483 
	}
}

7485 
bŒfs_block_group_ÿche
 *

7486 
	$bŒfs_lock_þu¡”
(
bŒfs_block_group_ÿche
 *
block_group
,

7487 
bŒfs_ä“_þu¡”
 *
þu¡”
,

7488 
d–®loc
)

7490 
bŒfs_block_group_ÿche
 *
u£d_bg
 = 
NULL
;

7492 
	`¥š_lock
(&
þu¡”
->
»fžl_lock
);

7494 
u£d_bg
 = 
þu¡”
->
block_group
;

7495 ià(!
u£d_bg
)

7496  
NULL
;

7498 ià(
u£d_bg
 =ð
block_group
)

7499  
u£d_bg
;

7501 
	`bŒfs_g‘_block_group
(
u£d_bg
);

7503 ià(!
d–®loc
)

7504  
u£d_bg
;

7506 ià(
	`down_»ad_Œylock
(&
u£d_bg
->
d©a_rw£m
))

7507  
u£d_bg
;

7509 
	`¥š_uÆock
(&
þu¡”
->
»fžl_lock
);

7512 
	`down_»ad_Ã¡ed
(&
u£d_bg
->
d©a_rw£m
, 
SINGLE_DEPTH_NESTING
);

7514 
	`¥š_lock
(&
þu¡”
->
»fžl_lock
);

7515 ià(
u£d_bg
 =ð
þu¡”
->
block_group
)

7516  
u£d_bg
;

7518 
	`up_»ad
(&
u£d_bg
->
d©a_rw£m
);

7519 
	`bŒfs_put_block_group
(
u£d_bg
);

7521 
	}
}

7523 
šlše
 

7524 
	$bŒfs_»Ëa£_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
,

7525 
d–®loc
)

7527 ià(
d–®loc
)

7528 
	`up_»ad
(&
ÿche
->
d©a_rw£m
);

7529 
	`bŒfs_put_block_group
(
ÿche
);

7530 
	}
}

7543 
nošlše
 
	$fšd_ä“_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

7544 
u64
 
¿m_by‹s
, u64 
num_by‹s
, u64 
em±y_size
,

7545 
u64
 
hšt_by‹
, 
bŒfs_key
 *
šs
,

7546 
u64
 
æags
, 
d–®loc
)

7548 
»t
 = 0;

7549 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

7550 
bŒfs_ä“_þu¡”
 *
Ï¡_±r
 = 
NULL
;

7551 
bŒfs_block_group_ÿche
 *
block_group
 = 
NULL
;

7552 
u64
 
£¬ch_¡¬t
 = 0;

7553 
u64
 
max_ex‹Á_size
 = 0;

7554 
u64
 
em±y_þu¡”
 = 0;

7555 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

7556 
loÝ
 = 0;

7557 
šdex
 = 
	`__g‘_¿id_šdex
(
æags
);

7558 
boÞ
 
çžed_þu¡”_»fžl
 = 
çl£
;

7559 
boÞ
 
çžed_®loc
 = 
çl£
;

7560 
boÞ
 
u£_þu¡”
 = 
Œue
;

7561 
boÞ
 
have_ÿchšg_bg
 = 
çl£
;

7562 
boÞ
 
Üig_have_ÿchšg_bg
 = 
çl£
;

7563 
boÞ
 
fuÎ_£¬ch
 = 
çl£
;

7565 
	`WARN_ON
(
num_by‹s
 < 
fs_šfo
->
£ùÜsize
);

7566 
šs
->
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

7567 
šs
->
objeùid
 = 0;

7568 
šs
->
off£t
 = 0;

7570 
	`Œaû_fšd_ä“_ex‹Á
(
fs_šfo
, 
num_by‹s
, 
em±y_size
, 
æags
);

7572 
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
æags
);

7573 ià(!
¥aû_šfo
) {

7574 
	`bŒfs_”r
(
fs_šfo
, "NØ¥aû infØfÜ %Îu", 
æags
);

7575  -
ENOSPC
;

7588 ià(
	`uÆik–y
(
¥aû_šfo
->
max_ex‹Á_size
)) {

7589 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

7590 ià(
¥aû_šfo
->
max_ex‹Á_size
 &&

7591 
num_by‹s
 > 
¥aû_šfo
->
max_ex‹Á_size
) {

7592 
šs
->
off£t
 = 
¥aû_šfo
->
max_ex‹Á_size
;

7593 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

7594  -
ENOSPC
;

7595 } ià(
¥aû_šfo
->
max_ex‹Á_size
) {

7596 
u£_þu¡”
 = 
çl£
;

7598 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

7601 
Ï¡_±r
 = 
	`ãtch_þu¡”_šfo
(
fs_šfo
, 
¥aû_šfo
, &
em±y_þu¡”
);

7602 ià(
Ï¡_±r
) {

7603 
	`¥š_lock
(&
Ï¡_±r
->
lock
);

7604 ià(
Ï¡_±r
->
block_group
)

7605 
hšt_by‹
 = 
Ï¡_±r
->
wšdow_¡¬t
;

7606 ià(
Ï¡_±r
->
äagm’‹d
) {

7612 
hšt_by‹
 = 
Ï¡_±r
->
wšdow_¡¬t
;

7613 
u£_þu¡”
 = 
çl£
;

7615 
	`¥š_uÆock
(&
Ï¡_±r
->
lock
);

7618 
£¬ch_¡¬t
 = 
	`max
(£¬ch_¡¬t, 
	`fœ¡_logiÿl_by‹
(
fs_šfo
, 0));

7619 
£¬ch_¡¬t
 = 
	`max
(£¬ch_¡¬t, 
hšt_by‹
);

7620 ià(
£¬ch_¡¬t
 =ð
hšt_by‹
) {

7621 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
£¬ch_¡¬t
);

7629 ià(
block_group
 && 
	`block_group_b™s
(block_group, 
æags
) &&

7630 
block_group
->
ÿched
 !ð
BTRFS_CACHE_NO
) {

7631 
	`down_»ad
(&
¥aû_šfo
->
groups_£m
);

7632 ià(
	`li¡_em±y
(&
block_group
->
li¡
) ||

7633 
block_group
->
ro
) {

7640 
	`bŒfs_put_block_group
(
block_group
);

7641 
	`up_»ad
(&
¥aû_šfo
->
groups_£m
);

7643 
šdex
 = 
	`g‘_block_group_šdex
(
block_group
);

7644 
	`bŒfs_lock_block_group
(
block_group
, 
d–®loc
);

7645 
have_block_group
;

7647 } ià(
block_group
) {

7648 
	`bŒfs_put_block_group
(
block_group
);

7651 
£¬ch
:

7652 
have_ÿchšg_bg
 = 
çl£
;

7653 ià(
šdex
 =ð0 || index =ð
	`__g‘_¿id_šdex
(
æags
))

7654 
fuÎ_£¬ch
 = 
Œue
;

7655 
	`down_»ad
(&
¥aû_šfo
->
groups_£m
);

7656 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
¥aû_šfo
->
block_groups
[
šdex
],

7657 
li¡
) {

7658 
u64
 
off£t
;

7659 
ÿched
;

7662 ià(
	`uÆik–y
(
block_group
->
ro
))

7665 
	`bŒfs_g¿b_block_group
(
block_group
, 
d–®loc
);

7666 
£¬ch_¡¬t
 = 
block_group
->
key
.
objeùid
;

7673 ià(!
	`block_group_b™s
(
block_group
, 
æags
)) {

7674 
u64
 
exŒa
 = 
BTRFS_BLOCK_GROUP_DUP
 |

7675 
BTRFS_BLOCK_GROUP_RAID1
 |

7676 
BTRFS_BLOCK_GROUP_RAID5
 |

7677 
BTRFS_BLOCK_GROUP_RAID6
 |

7678 
BTRFS_BLOCK_GROUP_RAID10
;

7685 ià((
æags
 & 
exŒa
è&& !(
block_group
->flags &ƒxtra))

7686 
loÝ
;

7689 
have_block_group
:

7690 
ÿched
 = 
	`block_group_ÿche_dÚe
(
block_group
);

7691 ià(
	`uÆik–y
(!
ÿched
)) {

7692 
have_ÿchšg_bg
 = 
Œue
;

7693 
»t
 = 
	`ÿche_block_group
(
block_group
, 0);

7694 
	`BUG_ON
(
»t
 < 0);

7695 
»t
 = 0;

7698 ià(
	`uÆik–y
(
block_group
->
ÿched
 =ð
BTRFS_CACHE_ERROR
))

7699 
loÝ
;

7705 ià(
Ï¡_±r
 && 
u£_þu¡”
) {

7706 
bŒfs_block_group_ÿche
 *
u£d_block_group
;

7707 
®igÃd_þu¡”
;

7712 
u£d_block_group
 = 
	`bŒfs_lock_þu¡”
(
block_group
,

7713 
Ï¡_±r
,

7714 
d–®loc
);

7715 ià(!
u£d_block_group
)

7716 
»fžl_þu¡”
;

7718 ià(
u£d_block_group
 !ð
block_group
 &&

7719 (
u£d_block_group
->
ro
 ||

7720 !
	`block_group_b™s
(
u£d_block_group
, 
æags
)))

7721 
»Ëa£_þu¡”
;

7723 
off£t
 = 
	`bŒfs_®loc_äom_þu¡”
(
u£d_block_group
,

7724 
Ï¡_±r
,

7725 
num_by‹s
,

7726 
u£d_block_group
->
key
.
objeùid
,

7727 &
max_ex‹Á_size
);

7728 ià(
off£t
) {

7730 
	`¥š_uÆock
(&
Ï¡_±r
->
»fžl_lock
);

7731 
	`Œaû_bŒfs_»£rve_ex‹Á_þu¡”
(
fs_šfo
,

7732 
u£d_block_group
,

7733 
£¬ch_¡¬t
, 
num_by‹s
);

7734 ià(
u£d_block_group
 !ð
block_group
) {

7735 
	`bŒfs_»Ëa£_block_group
(
block_group
,

7736 
d–®loc
);

7737 
block_group
 = 
u£d_block_group
;

7739 
checks
;

7742 
	`WARN_ON
(
Ï¡_±r
->
block_group
 !ð
u£d_block_group
);

7743 
»Ëa£_þu¡”
:

7759 ià(
loÝ
 >ð
LOOP_NO_EMPTY_SIZE
 &&

7760 
u£d_block_group
 !ð
block_group
) {

7761 
	`¥š_uÆock
(&
Ï¡_±r
->
»fžl_lock
);

7762 
	`bŒfs_»Ëa£_block_group
(
u£d_block_group
,

7763 
d–®loc
);

7764 
unþu¡”ed_®loc
;

7771 
	`bŒfs_»tuº_þu¡”_to_ä“_¥aû
(
NULL
, 
Ï¡_±r
);

7773 ià(
u£d_block_group
 !ð
block_group
)

7774 
	`bŒfs_»Ëa£_block_group
(
u£d_block_group
,

7775 
d–®loc
);

7776 
»fžl_þu¡”
:

7777 ià(
loÝ
 >ð
LOOP_NO_EMPTY_SIZE
) {

7778 
	`¥š_uÆock
(&
Ï¡_±r
->
»fžl_lock
);

7779 
unþu¡”ed_®loc
;

7782 
®igÃd_þu¡”
 = 
	`max_t
(,

7783 
em±y_þu¡”
 + 
em±y_size
,

7784 
block_group
->
fuÎ_¡re_Ën
);

7787 
»t
 = 
	`bŒfs_fšd_¥aû_þu¡”
(
fs_šfo
, 
block_group
,

7788 
Ï¡_±r
, 
£¬ch_¡¬t
,

7789 
num_by‹s
,

7790 
®igÃd_þu¡”
);

7791 ià(
»t
 == 0) {

7796 
off£t
 = 
	`bŒfs_®loc_äom_þu¡”
(
block_group
,

7797 
Ï¡_±r
,

7798 
num_by‹s
,

7799 
£¬ch_¡¬t
,

7800 &
max_ex‹Á_size
);

7801 ià(
off£t
) {

7803 
	`¥š_uÆock
(&
Ï¡_±r
->
»fžl_lock
);

7804 
	`Œaû_bŒfs_»£rve_ex‹Á_þu¡”
(
fs_šfo
,

7805 
block_group
, 
£¬ch_¡¬t
,

7806 
num_by‹s
);

7807 
checks
;

7809 } ià(!
ÿched
 && 
loÝ
 > 
LOOP_CACHING_NOWAIT


7810 && !
çžed_þu¡”_»fžl
) {

7811 
	`¥š_uÆock
(&
Ï¡_±r
->
»fžl_lock
);

7813 
çžed_þu¡”_»fžl
 = 
Œue
;

7814 
	`wa™_block_group_ÿche_´og»ss
(
block_group
,

7815 
num_by‹s
 + 
em±y_þu¡”
 + 
em±y_size
);

7816 
have_block_group
;

7825 
	`bŒfs_»tuº_þu¡”_to_ä“_¥aû
(
NULL
, 
Ï¡_±r
);

7826 
	`¥š_uÆock
(&
Ï¡_±r
->
»fžl_lock
);

7827 
loÝ
;

7830 
unþu¡”ed_®loc
:

7836 ià(
	`uÆik–y
(
Ï¡_±r
)) {

7837 
	`¥š_lock
(&
Ï¡_±r
->
lock
);

7838 
Ï¡_±r
->
äagm’‹d
 = 1;

7839 
	`¥š_uÆock
(&
Ï¡_±r
->
lock
);

7841 ià(
ÿched
) {

7842 
bŒfs_ä“_¥aû_ùl
 *
ùl
 =

7843 
block_group
->
ä“_¥aû_ùl
;

7845 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

7846 ià(
ùl
->
ä“_¥aû
 <

7847 
num_by‹s
 + 
em±y_þu¡”
 + 
em±y_size
) {

7848 ià(
ùl
->
ä“_¥aû
 > 
max_ex‹Á_size
)

7849 
max_ex‹Á_size
 = 
ùl
->
ä“_¥aû
;

7850 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

7851 
loÝ
;

7853 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

7856 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
block_group
, 
£¬ch_¡¬t
,

7857 
num_by‹s
, 
em±y_size
,

7858 &
max_ex‹Á_size
);

7868 ià(!
off£t
 && !
çžed_®loc
 && !
ÿched
 &&

7869 
loÝ
 > 
LOOP_CACHING_NOWAIT
) {

7870 
	`wa™_block_group_ÿche_´og»ss
(
block_group
,

7871 
num_by‹s
 + 
em±y_size
);

7872 
çžed_®loc
 = 
Œue
;

7873 
have_block_group
;

7874 } ià(!
off£t
) {

7875 
loÝ
;

7877 
checks
:

7878 
£¬ch_¡¬t
 = 
	`ALIGN
(
off£t
, 
fs_šfo
->
¡resize
);

7881 ià(
£¬ch_¡¬t
 + 
num_by‹s
 >

7882 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
) {

7883 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
off£t
, 
num_by‹s
);

7884 
loÝ
;

7887 ià(
off£t
 < 
£¬ch_¡¬t
)

7888 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
off£t
,

7889 
£¬ch_¡¬t
 - 
off£t
);

7890 
	`BUG_ON
(
off£t
 > 
£¬ch_¡¬t
);

7892 
»t
 = 
	`bŒfs_add_»£rved_by‹s
(
block_group
, 
¿m_by‹s
,

7893 
num_by‹s
, 
d–®loc
);

7894 ià(
»t
 =ð-
EAGAIN
) {

7895 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
off£t
, 
num_by‹s
);

7896 
loÝ
;

7898 
	`bŒfs_šc_block_group_»£rv©iÚs
(
block_group
);

7901 
šs
->
objeùid
 = 
£¬ch_¡¬t
;

7902 
šs
->
off£t
 = 
num_by‹s
;

7904 
	`Œaû_bŒfs_»£rve_ex‹Á
(
fs_šfo
, 
block_group
,

7905 
£¬ch_¡¬t
, 
num_by‹s
);

7906 
	`bŒfs_»Ëa£_block_group
(
block_group
, 
d–®loc
);

7908 
loÝ
:

7909 
çžed_þu¡”_»fžl
 = 
çl£
;

7910 
çžed_®loc
 = 
çl£
;

7911 
	`BUG_ON
(
šdex
 !ð
	`g‘_block_group_šdex
(
block_group
));

7912 
	`bŒfs_»Ëa£_block_group
(
block_group
, 
d–®loc
);

7913 
	`cÚd_»sched
();

7915 
	`up_»ad
(&
¥aû_šfo
->
groups_£m
);

7917 ià((
loÝ
 =ð
LOOP_CACHING_NOWAIT
è&& 
have_ÿchšg_bg


7918 && !
Üig_have_ÿchšg_bg
)

7919 
Üig_have_ÿchšg_bg
 = 
Œue
;

7921 ià(!
šs
->
objeùid
 && 
loÝ
 >ð
LOOP_CACHING_WAIT
 && 
have_ÿchšg_bg
)

7922 
£¬ch
;

7924 ià(!
šs
->
objeùid
 && ++
šdex
 < 
BTRFS_NR_RAID_TYPES
)

7925 
£¬ch
;

7935 ià(!
šs
->
objeùid
 && 
loÝ
 < 
LOOP_NO_EMPTY_SIZE
) {

7936 
šdex
 = 0;

7937 ià(
loÝ
 =ð
LOOP_CACHING_NOWAIT
) {

7943 ià(
Üig_have_ÿchšg_bg
 || !
fuÎ_£¬ch
)

7944 
loÝ
 = 
LOOP_CACHING_WAIT
;

7946 
loÝ
 = 
LOOP_ALLOC_CHUNK
;

7948 
loÝ
++;

7951 ià(
loÝ
 =ð
LOOP_ALLOC_CHUNK
) {

7952 
bŒfs_Œªs_hªdË
 *
Œªs
;

7953 
exi¡
 = 0;

7955 
Œªs
 = 
cu¼’t
->
jouº®_šfo
;

7956 ià(
Œªs
)

7957 
exi¡
 = 1;

7959 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

7961 ià(
	`IS_ERR
(
Œªs
)) {

7962 
»t
 = 
	`PTR_ERR
(
Œªs
);

7963 
out
;

7966 
»t
 = 
	`do_chunk_®loc
(
Œªs
, 
fs_šfo
, 
æags
,

7967 
CHUNK_ALLOC_FORCE
);

7974 ià(
»t
 =ð-
ENOSPC
)

7975 
loÝ
 = 
LOOP_NO_EMPTY_SIZE
;

7981 ià(
»t
 < 0 &&„‘ !ð-
ENOSPC
)

7982 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

7984 
»t
 = 0;

7985 ià(!
exi¡
)

7986 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

7987 ià(
»t
)

7988 
out
;

7991 ià(
loÝ
 =ð
LOOP_NO_EMPTY_SIZE
) {

7996 ià(
em±y_size
 == 0 &&

7997 
em±y_þu¡”
 == 0) {

7998 
»t
 = -
ENOSPC
;

7999 
out
;

8001 
em±y_size
 = 0;

8002 
em±y_þu¡”
 = 0;

8005 
£¬ch
;

8006 } ià(!
šs
->
objeùid
) {

8007 
»t
 = -
ENOSPC
;

8008 } ià(
šs
->
objeùid
) {

8009 ià(!
u£_þu¡”
 && 
Ï¡_±r
) {

8010 
	`¥š_lock
(&
Ï¡_±r
->
lock
);

8011 
Ï¡_±r
->
wšdow_¡¬t
 = 
šs
->
objeùid
;

8012 
	`¥š_uÆock
(&
Ï¡_±r
->
lock
);

8014 
»t
 = 0;

8016 
out
:

8017 ià(
»t
 =ð-
ENOSPC
) {

8018 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

8019 
¥aû_šfo
->
max_ex‹Á_size
 = max_extent_size;

8020 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

8021 
šs
->
off£t
 = 
max_ex‹Á_size
;

8023  
»t
;

8024 
	}
}

8026 
	$dump_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

8027 
bŒfs_¥aû_šfo
 *
šfo
, 
u64
 
by‹s
,

8028 
dump_block_groups
)

8030 
bŒfs_block_group_ÿche
 *
ÿche
;

8031 
šdex
 = 0;

8033 
	`¥š_lock
(&
šfo
->
lock
);

8034 
	`bŒfs_šfo
(
fs_šfo
, "space_info %llu has %llu free, is %sfull",

8035 
šfo
->
æags
,

8036 
šfo
->
tÙ®_by‹s
 - 
	`bŒfs_¥aû_šfo_u£d
(šfo, 
Œue
),

8037 
šfo
->
fuÎ
 ? "" : "not ");

8038 
	`bŒfs_šfo
(
fs_šfo
,

8040 
šfo
->
tÙ®_by‹s
, info->
by‹s_u£d
, info->
by‹s_pšÃd
,

8041 
šfo
->
by‹s_»£rved
, info->
by‹s_may_u£
,

8042 
šfo
->
by‹s_»adÚly
);

8043 
	`¥š_uÆock
(&
šfo
->
lock
);

8045 ià(!
dump_block_groups
)

8048 
	`down_»ad
(&
šfo
->
groups_£m
);

8049 
agaš
:

8050 
	`li¡_fÜ_—ch_’Œy
(
ÿche
, &
šfo
->
block_groups
[
šdex
], 
li¡
) {

8051 
	`¥š_lock
(&
ÿche
->
lock
);

8052 
	`bŒfs_šfo
(
fs_šfo
,

8054 
ÿche
->
key
.
objeùid
, cache->key.
off£t
,

8055 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
), cache->
pšÃd
,

8056 
ÿche
->
»£rved
, cache->
ro
 ? "[readonly]" : "");

8057 
	`bŒfs_dump_ä“_¥aû
(
ÿche
, 
by‹s
);

8058 
	`¥š_uÆock
(&
ÿche
->
lock
);

8060 ià(++
šdex
 < 
BTRFS_NR_RAID_TYPES
)

8061 
agaš
;

8062 
	`up_»ad
(&
šfo
->
groups_£m
);

8063 
	}
}

8065 
	$bŒfs_»£rve_ex‹Á
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¿m_by‹s
,

8066 
u64
 
num_by‹s
, u64 
mš_®loc_size
,

8067 
u64
 
em±y_size
, u64 
hšt_by‹
,

8068 
bŒfs_key
 *
šs
, 
is_d©a
, 
d–®loc
)

8070 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8071 
boÞ
 
fš®_Œ›d
 = 
num_by‹s
 =ð
mš_®loc_size
;

8072 
u64
 
æags
;

8073 
»t
;

8075 
æags
 = 
	`g‘_®loc_´ofže_by_roÙ
(
roÙ
, 
is_d©a
);

8076 
agaš
:

8077 
	`WARN_ON
(
num_by‹s
 < 
fs_šfo
->
£ùÜsize
);

8078 
»t
 = 
	`fšd_ä“_ex‹Á
(
fs_šfo
, 
¿m_by‹s
, 
num_by‹s
, 
em±y_size
,

8079 
hšt_by‹
, 
šs
, 
æags
, 
d–®loc
);

8080 ià(!
»t
 && !
is_d©a
) {

8081 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
->
objeùid
);

8082 } ià(
»t
 =ð-
ENOSPC
) {

8083 ià(!
fš®_Œ›d
 && 
šs
->
off£t
) {

8084 
num_by‹s
 = 
	`mš
Òum_by‹ >> 1, 
šs
->
off£t
);

8085 
num_by‹s
 = 
	`round_down
(num_bytes,

8086 
fs_šfo
->
£ùÜsize
);

8087 
num_by‹s
 = 
	`max
Òum_by‹s, 
mš_®loc_size
);

8088 
¿m_by‹s
 = 
num_by‹s
;

8089 ià(
num_by‹s
 =ð
mš_®loc_size
)

8090 
fš®_Œ›d
 = 
Œue
;

8091 
agaš
;

8092 } ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

8093 
bŒfs_¥aû_šfo
 *
sšfo
;

8095 
sšfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, 
æags
);

8096 
	`bŒfs_”r
(
fs_šfo
,

8098 
æags
, 
num_by‹s
);

8099 ià(
sšfo
)

8100 
	`dump_¥aû_šfo
(
fs_šfo
, 
sšfo
, 
num_by‹s
, 1);

8104  
»t
;

8105 
	}
}

8107 
	$__bŒfs_ä“_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

8108 
u64
 
¡¬t
, u64 
Ën
,

8109 
pš
, 
d–®loc
)

8111 
bŒfs_block_group_ÿche
 *
ÿche
;

8112 
»t
 = 0;

8114 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

8115 ià(!
ÿche
) {

8116 
	`bŒfs_”r
(
fs_šfo
, "Unableo find block group for %llu",

8117 
¡¬t
);

8118  -
ENOSPC
;

8121 ià(
pš
)

8122 
	`pš_down_ex‹Á
(
fs_šfo
, 
ÿche
, 
¡¬t
, 
Ën
, 1);

8124 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DISCARD
))

8125 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
, 
¡¬t
, 
Ën
, 
NULL
);

8126 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
¡¬t
, 
Ën
);

8127 
	`bŒfs_ä“_»£rved_by‹s
(
ÿche
, 
Ën
, 
d–®loc
);

8128 
	`Œaû_bŒfs_»£rved_ex‹Á_ä“
(
fs_šfo
, 
¡¬t
, 
Ën
);

8131 
	`bŒfs_put_block_group
(
ÿche
);

8132  
»t
;

8133 
	}
}

8135 
	$bŒfs_ä“_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

8136 
u64
 
¡¬t
, u64 
Ën
, 
d–®loc
)

8138  
	`__bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
¡¬t
, 
Ën
, 0, 
d–®loc
);

8139 
	}
}

8141 
	$bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

8142 
u64
 
¡¬t
, u64 
Ën
)

8144  
	`__bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
¡¬t
, 
Ën
, 1, 0);

8145 
	}
}

8147 
	$®loc_»£rved_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8148 
bŒfs_fs_šfo
 *
fs_šfo
,

8149 
u64
 
·»Á
, u64 
roÙ_objeùid
,

8150 
u64
 
æags
, u64 
owÃr
, u64 
off£t
,

8151 
bŒfs_key
 *
šs
, 
»f_mod
)

8153 
»t
;

8154 
bŒfs_ex‹Á_™em
 *
ex‹Á_™em
;

8155 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

8156 
bŒfs_·th
 *
·th
;

8157 
ex‹Á_bufãr
 *
Ëaf
;

8158 
ty³
;

8159 
u32
 
size
;

8161 ià(
·»Á
 > 0)

8162 
ty³
 = 
BTRFS_SHARED_DATA_REF_KEY
;

8164 
ty³
 = 
BTRFS_EXTENT_DATA_REF_KEY
;

8166 
size
 = (*
ex‹Á_™em
è+ 
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

8168 
·th
 = 
	`bŒfs_®loc_·th
();

8169 ià(!
·th
)

8170  -
ENOMEM
;

8172 
·th
->
Ëave_¥šnšg
 = 1;

8173 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, 
·th
,

8174 
šs
, 
size
);

8175 ià(
»t
) {

8176 
	`bŒfs_ä“_·th
(
·th
);

8177  
»t
;

8180 
Ëaf
 = 
·th
->
nodes
[0];

8181 
ex‹Á_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

8182 
bŒfs_ex‹Á_™em
);

8183 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ex‹Á_™em
, 
»f_mod
);

8184 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á_™em
, 
Œªs
->
Œªsid
);

8185 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
ex‹Á_™em
,

8186 
æags
 | 
BTRFS_EXTENT_FLAG_DATA
);

8188 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ex‹Á_™em
 + 1);

8189 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
ty³
);

8190 ià(
·»Á
 > 0) {

8191 
bŒfs_sh¬ed_d©a_»f
 *
»f
;

8192 
»f
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

8193 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

8194 
	`bŒfs_£t_sh¬ed_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»f_mod
);

8196 
bŒfs_ex‹Á_d©a_»f
 *
»f
;

8197 
»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

8198 
	`bŒfs_£t_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
, 
roÙ_objeùid
);

8199 
	`bŒfs_£t_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
, 
owÃr
);

8200 
	`bŒfs_£t_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
, 
off£t
);

8201 
	`bŒfs_£t_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
, 
»f_mod
);

8204 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

8205 
	`bŒfs_ä“_·th
(
·th
);

8207 
»t
 = 
	`»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
šs
->
objeùid
,

8208 
šs
->
off£t
);

8209 ià(
»t
)

8210  
»t
;

8212 
»t
 = 
	`upd©e_block_group
(
Œªs
, 
fs_šfo
, 
šs
->
objeùid
, ins->
off£t
, 1);

8213 ià(
»t
) {

8214 
	`bŒfs_”r
(
fs_šfo
, "update block group failed for %llu %llu",

8215 
šs
->
objeùid
, ins->
off£t
);

8216 
	`BUG
();

8218 
	`Œaû_bŒfs_»£rved_ex‹Á_®loc
(
fs_šfo
, 
šs
->
objeùid
, ins->
off£t
);

8219  
»t
;

8220 
	}
}

8222 
	$®loc_»£rved_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8223 
bŒfs_fs_šfo
 *
fs_šfo
,

8224 
u64
 
·»Á
, u64 
roÙ_objeùid
,

8225 
u64
 
æags
, 
bŒfs_disk_key
 *
key
,

8226 
Ëv–
, 
bŒfs_key
 *
šs
)

8228 
»t
;

8229 
bŒfs_ex‹Á_™em
 *
ex‹Á_™em
;

8230 
bŒfs_Œ“_block_šfo
 *
block_šfo
;

8231 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

8232 
bŒfs_·th
 *
·th
;

8233 
ex‹Á_bufãr
 *
Ëaf
;

8234 
u32
 
size
 = (*
ex‹Á_™em
è+ (*
œef
);

8235 
u64
 
num_by‹s
 = 
šs
->
off£t
;

8236 
boÞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

8238 ià(!
skšny_m‘ad©a
)

8239 
size
 +ð(*
block_šfo
);

8241 
·th
 = 
	`bŒfs_®loc_·th
();

8242 ià(!
·th
) {

8243 
	`bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(
fs_šfo
, 
šs
->
objeùid
,

8244 
fs_šfo
->
nodesize
);

8245  -
ENOMEM
;

8248 
·th
->
Ëave_¥šnšg
 = 1;

8249 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
fs_šfo
->
ex‹Á_roÙ
, 
·th
,

8250 
šs
, 
size
);

8251 ià(
»t
) {

8252 
	`bŒfs_ä“_·th
(
·th
);

8253 
	`bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(
fs_šfo
, 
šs
->
objeùid
,

8254 
fs_šfo
->
nodesize
);

8255  
»t
;

8258 
Ëaf
 = 
·th
->
nodes
[0];

8259 
ex‹Á_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

8260 
bŒfs_ex‹Á_™em
);

8261 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
ex‹Á_™em
, 1);

8262 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á_™em
, 
Œªs
->
Œªsid
);

8263 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
ex‹Á_™em
,

8264 
æags
 | 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

8266 ià(
skšny_m‘ad©a
) {

8267 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ex‹Á_™em
 + 1);

8268 
num_by‹s
 = 
fs_šfo
->
nodesize
;

8270 
block_šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ex‹Á_™em
 + 1);

8271 
	`bŒfs_£t_Œ“_block_key
(
Ëaf
, 
block_šfo
, 
key
);

8272 
	`bŒfs_£t_Œ“_block_Ëv–
(
Ëaf
, 
block_šfo
, 
Ëv–
);

8273 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
block_šfo
 + 1);

8276 ià(
·»Á
 > 0) {

8277 
	`BUG_ON
(!(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
));

8278 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

8279 
BTRFS_SHARED_BLOCK_REF_KEY
);

8280 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

8282 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

8283 
BTRFS_TREE_BLOCK_REF_KEY
);

8284 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
roÙ_objeùid
);

8287 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

8288 
	`bŒfs_ä“_·th
(
·th
);

8290 
»t
 = 
	`»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
šs
->
objeùid
,

8291 
num_by‹s
);

8292 ià(
»t
)

8293  
»t
;

8295 
»t
 = 
	`upd©e_block_group
(
Œªs
, 
fs_šfo
, 
šs
->
objeùid
,

8296 
fs_šfo
->
nodesize
, 1);

8297 ià(
»t
) {

8298 
	`bŒfs_”r
(
fs_šfo
, "update block group failed for %llu %llu",

8299 
šs
->
objeùid
, ins->
off£t
);

8300 
	`BUG
();

8303 
	`Œaû_bŒfs_»£rved_ex‹Á_®loc
(
fs_šfo
, 
šs
->
objeùid
,

8304 
fs_šfo
->
nodesize
);

8305  
»t
;

8306 
	}
}

8308 
	$bŒfs_®loc_»£rved_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8309 
u64
 
roÙ_objeùid
, u64 
owÃr
,

8310 
u64
 
off£t
, u64 
¿m_by‹s
,

8311 
bŒfs_key
 *
šs
)

8313 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

8314 
»t
;

8316 
	`BUG_ON
(
roÙ_objeùid
 =ð
BTRFS_TREE_LOG_OBJECTID
);

8318 
»t
 = 
	`bŒfs_add_d–ayed_d©a_»f
(
fs_šfo
, 
Œªs
, 
šs
->
objeùid
,

8319 
šs
->
off£t
, 0, 
roÙ_objeùid
, 
owÃr
,

8320 
off£t
, 
¿m_by‹s
,

8321 
BTRFS_ADD_DELAYED_EXTENT
, 
NULL
, NULL);

8322  
»t
;

8323 
	}
}

8330 
	$bŒfs_®loc_logged_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8331 
bŒfs_fs_šfo
 *
fs_šfo
,

8332 
u64
 
roÙ_objeùid
, u64 
owÃr
, u64 
off£t
,

8333 
bŒfs_key
 *
šs
)

8335 
»t
;

8336 
bŒfs_block_group_ÿche
 *
block_group
;

8337 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

8343 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
)) {

8344 
»t
 = 
	`__exþude_logged_ex‹Á
(
fs_šfo
, 
šs
->
objeùid
,

8345 
šs
->
off£t
);

8346 ià(
»t
)

8347  
»t
;

8350 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
šs
->
objeùid
);

8351 ià(!
block_group
)

8352  -
EINVAL
;

8354 
¥aû_šfo
 = 
block_group
->space_info;

8355 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

8356 
	`¥š_lock
(&
block_group
->
lock
);

8357 
¥aû_šfo
->
by‹s_»£rved
 +ð
šs
->
off£t
;

8358 
block_group
->
»£rved
 +ð
šs
->
off£t
;

8359 
	`¥š_uÆock
(&
block_group
->
lock
);

8360 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

8362 
»t
 = 
	`®loc_»£rved_fže_ex‹Á
(
Œªs
, 
fs_šfo
, 0, 
roÙ_objeùid
,

8363 0, 
owÃr
, 
off£t
, 
šs
, 1);

8364 
	`bŒfs_put_block_group
(
block_group
);

8365  
»t
;

8366 
	}
}

8368 
ex‹Á_bufãr
 *

8369 
	$bŒfs_š™_Ãw_bufãr
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

8370 
u64
 
by‹Ä
, 
Ëv–
)

8372 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8373 
ex‹Á_bufãr
 *
buf
;

8375 
buf
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
);

8376 ià(
	`IS_ERR
(
buf
))

8377  
buf
;

8379 
	`bŒfs_£t_h—d”_g’”©iÚ
(
buf
, 
Œªs
->
Œªsid
);

8380 
	`bŒfs_£t_bufãr_lockd•_þass
(
roÙ
->
roÙ_key
.
objeùid
, 
buf
, 
Ëv–
);

8381 
	`bŒfs_Œ“_lock
(
buf
);

8382 
	`þ—n_Œ“_block
(
fs_šfo
, 
buf
);

8383 
	`þ—r_b™
(
EXTENT_BUFFER_STALE
, &
buf
->
bæags
);

8385 
	`bŒfs_£t_lock_blockšg
(
buf
);

8386 
	`£t_ex‹Á_bufãr_u±od©e
(
buf
);

8388 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_LOG_OBJECTID
) {

8389 
buf
->
log_šdex
 = 
roÙ
->
log_Œªsid
 % 2;

8394 ià(
buf
->
log_šdex
 == 0)

8395 
	`£t_ex‹Á_dœty
(&
roÙ
->
dœty_log_·ges
, 
buf
->
¡¬t
,

8396 
buf
->
¡¬t
 + buf->
Ën
 - 1, 
GFP_NOFS
);

8398 
	`£t_ex‹Á_Ãw
(&
roÙ
->
dœty_log_·ges
, 
buf
->
¡¬t
,

8399 
buf
->
¡¬t
 + buf->
Ën
 - 1);

8401 
buf
->
log_šdex
 = -1;

8402 
	`£t_ex‹Á_dœty
(&
Œªs
->
Œª§ùiÚ
->
dœty_·ges
, 
buf
->
¡¬t
,

8403 
buf
->
¡¬t
 + buf->
Ën
 - 1, 
GFP_NOFS
);

8405 
Œªs
->
dœty
 = 
Œue
;

8407  
buf
;

8408 
	}
}

8410 
bŒfs_block_rsv
 *

8411 
	$u£_block_rsv
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8412 
bŒfs_roÙ
 *
roÙ
, 
u32
 
blocksize
)

8414 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8415 
bŒfs_block_rsv
 *
block_rsv
;

8416 
bŒfs_block_rsv
 *
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

8417 
»t
;

8418 
boÞ
 
glob®_upd©ed
 = 
çl£
;

8420 
block_rsv
 = 
	`g‘_block_rsv
(
Œªs
, 
roÙ
);

8422 ià(
	`uÆik–y
(
block_rsv
->
size
 == 0))

8423 
Œy_»£rve
;

8424 
agaš
:

8425 
»t
 = 
	`block_rsv_u£_by‹s
(
block_rsv
, 
blocksize
);

8426 ià(!
»t
)

8427  
block_rsv
;

8429 ià(
block_rsv
->
çžç¡
)

8430  
	`ERR_PTR
(
»t
);

8432 ià(
block_rsv
->
ty³
 =ð
BTRFS_BLOCK_RSV_GLOBAL
 && !
glob®_upd©ed
) {

8433 
glob®_upd©ed
 = 
Œue
;

8434 
	`upd©e_glob®_block_rsv
(
fs_šfo
);

8435 
agaš
;

8438 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

8439 
	`DEFINE_RATELIMIT_STATE
(
_rs
,

8440 
DEFAULT_RATELIMIT_INTERVAL
 * 10,

8442 ià(
	`__¿‹lim™
(&
_rs
))

8443 
	`WARN
(1, 
KERN_DEBUG


8444 "BTRFS: block„sv„‘uºed %d\n", 
»t
);

8446 
Œy_»£rve
:

8447 
»t
 = 
	`»£rve_m‘ad©a_by‹s
(
roÙ
, 
block_rsv
, 
blocksize
,

8448 
BTRFS_RESERVE_NO_FLUSH
);

8449 ià(!
»t
)

8450  
block_rsv
;

8456 ià(
block_rsv
->
ty³
 !ð
BTRFS_BLOCK_RSV_GLOBAL
 &&

8457 
block_rsv
->
¥aû_šfo
 =ð
glob®_rsv
->space_info) {

8458 
»t
 = 
	`block_rsv_u£_by‹s
(
glob®_rsv
, 
blocksize
);

8459 ià(!
»t
)

8460  
glob®_rsv
;

8462  
	`ERR_PTR
(
»t
);

8463 
	}
}

8465 
	$unu£_block_rsv
(
bŒfs_fs_šfo
 *
fs_šfo
,

8466 
bŒfs_block_rsv
 *
block_rsv
, 
u32
 
blocksize
)

8468 
	`block_rsv_add_by‹s
(
block_rsv
, 
blocksize
, 0);

8469 
	`block_rsv_»Ëa£_by‹s
(
fs_šfo
, 
block_rsv
, 
NULL
, 0);

8470 
	}
}

8476 
ex‹Á_bufãr
 *
	$bŒfs_®loc_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8477 
bŒfs_roÙ
 *
roÙ
,

8478 
u64
 
·»Á
, u64 
roÙ_objeùid
,

8479 cÚ¡ 
bŒfs_disk_key
 *
key
,

8480 
Ëv–
, 
u64
 
hšt
,

8481 
u64
 
em±y_size
)

8483 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8484 
bŒfs_key
 
šs
;

8485 
bŒfs_block_rsv
 *
block_rsv
;

8486 
ex‹Á_bufãr
 *
buf
;

8487 
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
;

8488 
u64
 
æags
 = 0;

8489 
»t
;

8490 
u32
 
blocksize
 = 
fs_šfo
->
nodesize
;

8491 
boÞ
 
skšny_m‘ad©a
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

8493 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


8494 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
)) {

8495 
buf
 = 
	`bŒfs_š™_Ãw_bufãr
(
Œªs
, 
roÙ
,„oÙ->
®loc_by‹Ä
,

8496 
Ëv–
);

8497 ià(!
	`IS_ERR
(
buf
))

8498 
roÙ
->
®loc_by‹Ä
 +ð
blocksize
;

8499  
buf
;

8503 
block_rsv
 = 
	`u£_block_rsv
(
Œªs
, 
roÙ
, 
blocksize
);

8504 ià(
	`IS_ERR
(
block_rsv
))

8505  
	`ERR_CAST
(
block_rsv
);

8507 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
blocksize
, blocksize, blocksize,

8508 
em±y_size
, 
hšt
, &
šs
, 0, 0);

8509 ià(
»t
)

8510 
out_unu£
;

8512 
buf
 = 
	`bŒfs_š™_Ãw_bufãr
(
Œªs
, 
roÙ
, 
šs
.
objeùid
, 
Ëv–
);

8513 ià(
	`IS_ERR
(
buf
)) {

8514 
»t
 = 
	`PTR_ERR
(
buf
);

8515 
out_ä“_»£rved
;

8518 ià(
roÙ_objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
) {

8519 ià(
·»Á
 == 0)

8520 
·»Á
 = 
šs
.
objeùid
;

8521 
æags
 |ð
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

8523 
	`BUG_ON
(
·»Á
 > 0);

8525 ià(
roÙ_objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
) {

8526 
ex‹Á_Ý
 = 
	`bŒfs_®loc_d–ayed_ex‹Á_Ý
();

8527 ià(!
ex‹Á_Ý
) {

8528 
»t
 = -
ENOMEM
;

8529 
out_ä“_buf
;

8531 ià(
key
)

8532 
	`memýy
(&
ex‹Á_Ý
->
key
, key, (extent_op->key));

8534 
	`mem£t
(&
ex‹Á_Ý
->
key
, 0, (extent_op->key));

8535 
ex‹Á_Ý
->
æags_to_£t
 = 
æags
;

8536 
ex‹Á_Ý
->
upd©e_key
 = 
skšny_m‘ad©a
 ? 
çl£
 : 
Œue
;

8537 
ex‹Á_Ý
->
upd©e_æags
 = 
Œue
;

8538 
ex‹Á_Ý
->
is_d©a
 = 
çl£
;

8539 
ex‹Á_Ý
->
Ëv–
 =†evel;

8541 
»t
 = 
	`bŒfs_add_d–ayed_Œ“_»f
(
fs_šfo
, 
Œªs
, 
šs
.
objeùid
,

8542 
šs
.
off£t
, 
·»Á
,

8543 
roÙ_objeùid
, 
Ëv–
,

8544 
BTRFS_ADD_DELAYED_EXTENT
,

8545 
ex‹Á_Ý
, 
NULL
, NULL);

8546 ià(
»t
)

8547 
out_ä“_d–ayed
;

8549  
buf
;

8551 
out_ä“_d–ayed
:

8552 
	`bŒfs_ä“_d–ayed_ex‹Á_Ý
(
ex‹Á_Ý
);

8553 
out_ä“_buf
:

8554 
	`ä“_ex‹Á_bufãr
(
buf
);

8555 
out_ä“_»£rved
:

8556 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 0);

8557 
out_unu£
:

8558 
	`unu£_block_rsv
(
fs_šfo
, 
block_rsv
, 
blocksize
);

8559  
	`ERR_PTR
(
»t
);

8560 
	}
}

8562 
	sw®k_cÚŒÞ
 {

8563 
u64
 
	m»fs
[
BTRFS_MAX_LEVEL
];

8564 
u64
 
	mæags
[
BTRFS_MAX_LEVEL
];

8565 
bŒfs_key
 
	mupd©e_´og»ss
;

8566 
	m¡age
;

8567 
	mËv–
;

8568 
	msh¬ed_Ëv–
;

8569 
	mupd©e_»f
;

8570 
	mk“p_locks
;

8571 
	m»ada_¦Ù
;

8572 
	m»ada_couÁ
;

8573 
	mfÜ_»loc
;

8576 
	#DROP_REFERENCE
 1

	)

8577 
	#UPDATE_BACKREF
 2

	)

8579 
nošlše
 
	$»ada_w®k_down
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8580 
bŒfs_roÙ
 *
roÙ
,

8581 
w®k_cÚŒÞ
 *
wc
,

8582 
bŒfs_·th
 *
·th
)

8584 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8585 
u64
 
by‹Ä
;

8586 
u64
 
g’”©iÚ
;

8587 
u64
 
»fs
;

8588 
u64
 
æags
;

8589 
u32
 
Ä™ems
;

8590 
bŒfs_key
 
key
;

8591 
ex‹Á_bufãr
 *
eb
;

8592 
»t
;

8593 
¦Ù
;

8594 
Ä—d
 = 0;

8596 ià(
·th
->
¦Ùs
[
wc
->
Ëv–
] < wc->
»ada_¦Ù
) {

8597 
wc
->
»ada_couÁ
 = wc->reada_count * 2 / 3;

8598 
wc
->
»ada_couÁ
 = 
	`max
(wc->reada_count, 2);

8600 
wc
->
»ada_couÁ
 = wc->reada_count * 3 / 2;

8601 
wc
->
»ada_couÁ
 = 
	`mš_t
(, wc->reada_count,

8602 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
));

8605 
eb
 = 
·th
->
nodes
[
wc
->
Ëv–
];

8606 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

8608 
¦Ù
 = 
·th
->
¦Ùs
[
wc
->
Ëv–
]; slÙ < 
Ä™ems
; slot++) {

8609 ià(
Ä—d
 >ð
wc
->
»ada_couÁ
)

8612 
	`cÚd_»sched
();

8613 
by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
, 
¦Ù
);

8614 
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
¦Ù
);

8616 ià(
¦Ù
 =ð
·th
->
¦Ùs
[
wc
->
Ëv–
])

8617 
»ada
;

8619 ià(
wc
->
¡age
 =ð
UPDATE_BACKREF
 &&

8620 
g’”©iÚ
 <ð
roÙ
->
roÙ_key
.
off£t
)

8624 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
, 
by‹Ä
,

8625 
wc
->
Ëv–
 - 1, 1, &
»fs
,

8626 &
æags
);

8628 ià(
»t
 < 0)

8630 
	`BUG_ON
(
»fs
 == 0);

8632 ià(
wc
->
¡age
 =ð
DROP_REFERENCE
) {

8633 ià(
»fs
 == 1)

8634 
»ada
;

8636 ià(
wc
->
Ëv–
 == 1 &&

8637 (
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

8639 ià(!
wc
->
upd©e_»f
 ||

8640 
g’”©iÚ
 <ð
roÙ
->
roÙ_key
.
off£t
)

8642 
	`bŒfs_node_key_to_ýu
(
eb
, &
key
, 
¦Ù
);

8643 
»t
 = 
	`bŒfs_comp_ýu_keys
(&
key
,

8644 &
wc
->
upd©e_´og»ss
);

8645 ià(
»t
 < 0)

8648 ià(
wc
->
Ëv–
 == 1 &&

8649 (
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

8652 
»ada
:

8653 
	`»adah—d_Œ“_block
(
fs_šfo
, 
by‹Ä
);

8654 
Ä—d
++;

8656 
wc
->
»ada_¦Ù
 = 
¦Ù
;

8657 
	}
}

8667 
nošlše
 
	$w®k_down_´oc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8668 
bŒfs_roÙ
 *
roÙ
,

8669 
bŒfs_·th
 *
·th
,

8670 
w®k_cÚŒÞ
 *
wc
, 
lookup_šfo
)

8672 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8673 
Ëv–
 = 
wc
->level;

8674 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[
Ëv–
];

8675 
u64
 
æag
 = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

8676 
»t
;

8678 ià(
wc
->
¡age
 =ð
UPDATE_BACKREF
 &&

8679 
	`bŒfs_h—d”_owÃr
(
eb
è!ð
roÙ
->
roÙ_key
.
objeùid
)

8686 ià(
lookup_šfo
 &&

8687 ((
wc
->
¡age
 =ð
DROP_REFERENCE
 && wc->
»fs
[
Ëv–
] != 1) ||

8688 (
wc
->
¡age
 =ð
UPDATE_BACKREF
 && !(wc->
æags
[
Ëv–
] & 
æag
)))) {

8689 
	`BUG_ON
(!
·th
->
locks
[
Ëv–
]);

8690 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
,

8691 
eb
->
¡¬t
, 
Ëv–
, 1,

8692 &
wc
->
»fs
[
Ëv–
],

8693 &
wc
->
æags
[
Ëv–
]);

8694 
	`BUG_ON
(
»t
 =ð-
ENOMEM
);

8695 ià(
»t
)

8696  
»t
;

8697 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] == 0);

8700 ià(
wc
->
¡age
 =ð
DROP_REFERENCE
) {

8701 ià(
wc
->
»fs
[
Ëv–
] > 1)

8704 ià(
·th
->
locks
[
Ëv–
] && !
wc
->
k“p_locks
) {

8705 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

8706 
·th
->
locks
[
Ëv–
] = 0;

8712 ià(!(
wc
->
æags
[
Ëv–
] & 
æag
)) {

8713 
	`BUG_ON
(!
·th
->
locks
[
Ëv–
]);

8714 
»t
 = 
	`bŒfs_šc_»f
(
Œªs
, 
roÙ
, 
eb
, 1);

8715 
	`BUG_ON
(
»t
);

8716 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
eb
, 0);

8717 
	`BUG_ON
(
»t
);

8718 
»t
 = 
	`bŒfs_£t_disk_ex‹Á_æags
(
Œªs
, 
fs_šfo
, 
eb
->
¡¬t
,

8719 
eb
->
Ën
, 
æag
,

8720 
	`bŒfs_h—d”_Ëv–
(
eb
), 0);

8721 
	`BUG_ON
(
»t
);

8722 
wc
->
æags
[
Ëv–
] |ð
æag
;

8729 ià(
·th
->
locks
[
Ëv–
] &&†evel > 0) {

8730 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

8731 
·th
->
locks
[
Ëv–
] = 0;

8734 
	}
}

8749 
nošlše
 
	$do_w®k_down
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8750 
bŒfs_roÙ
 *
roÙ
,

8751 
bŒfs_·th
 *
·th
,

8752 
w®k_cÚŒÞ
 *
wc
, *
lookup_šfo
)

8754 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8755 
u64
 
by‹Ä
;

8756 
u64
 
g’”©iÚ
;

8757 
u64
 
·»Á
;

8758 
u32
 
blocksize
;

8759 
bŒfs_key
 
key
;

8760 
ex‹Á_bufãr
 *
Ãxt
;

8761 
Ëv–
 = 
wc
->level;

8762 
»ada
 = 0;

8763 
»t
 = 0;

8764 
boÞ
 
Ãed_accouÁ
 = 
çl£
;

8766 
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·th
->
nodes
[
Ëv–
],

8767 
·th
->
¦Ùs
[
Ëv–
]);

8773 ià(
wc
->
¡age
 =ð
UPDATE_BACKREF
 &&

8774 
g’”©iÚ
 <ð
roÙ
->
roÙ_key
.
off£t
) {

8775 *
lookup_šfo
 = 1;

8779 
by‹Ä
 = 
	`bŒfs_node_block±r
(
·th
->
nodes
[
Ëv–
],…©h->
¦Ùs
[level]);

8780 
blocksize
 = 
fs_šfo
->
nodesize
;

8782 
Ãxt
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
by‹Ä
);

8783 ià(!
Ãxt
) {

8784 
Ãxt
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
);

8785 ià(
	`IS_ERR
(
Ãxt
))

8786  
	`PTR_ERR
(
Ãxt
);

8788 
	`bŒfs_£t_bufãr_lockd•_þass
(
roÙ
->
roÙ_key
.
objeùid
, 
Ãxt
,

8789 
Ëv–
 - 1);

8790 
»ada
 = 1;

8792 
	`bŒfs_Œ“_lock
(
Ãxt
);

8793 
	`bŒfs_£t_lock_blockšg
(
Ãxt
);

8795 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
Ëv–
 - 1, 1,

8796 &
wc
->
»fs
[
Ëv–
 - 1],

8797 &
wc
->
æags
[
Ëv–
 - 1]);

8798 ià(
»t
 < 0)

8799 
out_uÆock
;

8801 ià(
	`uÆik–y
(
wc
->
»fs
[
Ëv–
 - 1] == 0)) {

8802 
	`bŒfs_”r
(
fs_šfo
, "Missing„eferences.");

8803 
»t
 = -
EIO
;

8804 
out_uÆock
;

8806 *
lookup_šfo
 = 0;

8808 ià(
wc
->
¡age
 =ð
DROP_REFERENCE
) {

8809 ià(
wc
->
»fs
[
Ëv–
 - 1] > 1) {

8810 
Ãed_accouÁ
 = 
Œue
;

8811 ià(
Ëv–
 == 1 &&

8812 (
wc
->
æags
[0] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

8813 
sk
;

8815 ià(!
wc
->
upd©e_»f
 ||

8816 
g’”©iÚ
 <ð
roÙ
->
roÙ_key
.
off£t
)

8817 
sk
;

8819 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
Ëv–
], &
key
,

8820 
·th
->
¦Ùs
[
Ëv–
]);

8821 
»t
 = 
	`bŒfs_comp_ýu_keys
(&
key
, &
wc
->
upd©e_´og»ss
);

8822 ià(
»t
 < 0)

8823 
sk
;

8825 
wc
->
¡age
 = 
UPDATE_BACKREF
;

8826 
wc
->
sh¬ed_Ëv–
 = 
Ëv–
 - 1;

8829 ià(
Ëv–
 == 1 &&

8830 (
wc
->
æags
[0] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

8831 
sk
;

8834 ià(!
	`bŒfs_bufãr_u±od©e
(
Ãxt
, 
g’”©iÚ
, 0)) {

8835 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

8836 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

8837 
Ãxt
 = 
NULL
;

8838 *
lookup_šfo
 = 1;

8841 ià(!
Ãxt
) {

8842 ià(
»ada
 && 
Ëv–
 == 1)

8843 
	`»ada_w®k_down
(
Œªs
, 
roÙ
, 
wc
, 
·th
);

8844 
Ãxt
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
by‹Ä
, 
g’”©iÚ
);

8845 ià(
	`IS_ERR
(
Ãxt
)) {

8846  
	`PTR_ERR
(
Ãxt
);

8847 } ià(!
	`ex‹Á_bufãr_u±od©e
(
Ãxt
)) {

8848 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

8849  -
EIO
;

8851 
	`bŒfs_Œ“_lock
(
Ãxt
);

8852 
	`bŒfs_£t_lock_blockšg
(
Ãxt
);

8855 
Ëv–
--;

8856 
	`ASSERT
(
Ëv–
 =ð
	`bŒfs_h—d”_Ëv–
(
Ãxt
));

8857 ià(
Ëv–
 !ð
	`bŒfs_h—d”_Ëv–
(
Ãxt
)) {

8858 
	`bŒfs_”r
(
roÙ
->
fs_šfo
, "mismatched†evel");

8859 
»t
 = -
EIO
;

8860 
out_uÆock
;

8862 
·th
->
nodes
[
Ëv–
] = 
Ãxt
;

8863 
·th
->
¦Ùs
[
Ëv–
] = 0;

8864 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

8865 
wc
->
Ëv–
 =†evel;

8866 ià(
wc
->
Ëv–
 == 1)

8867 
wc
->
»ada_¦Ù
 = 0;

8869 
sk
:

8870 
wc
->
»fs
[
Ëv–
 - 1] = 0;

8871 
wc
->
æags
[
Ëv–
 - 1] = 0;

8872 ià(
wc
->
¡age
 =ð
DROP_REFERENCE
) {

8873 ià(
wc
->
æags
[
Ëv–
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
) {

8874 
·»Á
 = 
·th
->
nodes
[
Ëv–
]->
¡¬t
;

8876 
	`ASSERT
(
roÙ
->
roÙ_key
.
objeùid
 ==

8877 
	`bŒfs_h—d”_owÃr
(
·th
->
nodes
[
Ëv–
]));

8878 ià(
roÙ
->
roÙ_key
.
objeùid
 !=

8879 
	`bŒfs_h—d”_owÃr
(
·th
->
nodes
[
Ëv–
])) {

8880 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

8882 
»t
 = -
EIO
;

8883 
out_uÆock
;

8885 
·»Á
 = 0;

8888 ià(
Ãed_accouÁ
) {

8889 
»t
 = 
	`bŒfs_qgroup_Œaû_subŒ“
(
Œªs
, 
roÙ
, 
Ãxt
,

8890 
g’”©iÚ
, 
Ëv–
 - 1);

8891 ià(
»t
) {

8892 
	`bŒfs_”r_¾
(
fs_šfo
,

8894 
»t
);

8897 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
blocksize
,

8898 
·»Á
, 
roÙ
->
roÙ_key
.
objeùid
,

8899 
Ëv–
 - 1, 0);

8900 ià(
»t
)

8901 
out_uÆock
;

8904 *
lookup_šfo
 = 1;

8905 
»t
 = 1;

8907 
out_uÆock
:

8908 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

8909 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

8911  
»t
;

8912 
	}
}

8926 
nošlše
 
	$w®k_up_´oc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

8927 
bŒfs_roÙ
 *
roÙ
,

8928 
bŒfs_·th
 *
·th
,

8929 
w®k_cÚŒÞ
 *
wc
)

8931 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

8932 
»t
;

8933 
Ëv–
 = 
wc
->level;

8934 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[
Ëv–
];

8935 
u64
 
·»Á
 = 0;

8937 ià(
wc
->
¡age
 =ð
UPDATE_BACKREF
) {

8938 
	`BUG_ON
(
wc
->
sh¬ed_Ëv–
 < 
Ëv–
);

8939 ià(
Ëv–
 < 
wc
->
sh¬ed_Ëv–
)

8940 
out
;

8942 
»t
 = 
	`fšd_Ãxt_key
(
·th
, 
Ëv–
 + 1, &
wc
->
upd©e_´og»ss
);

8943 ià(
»t
 > 0)

8944 
wc
->
upd©e_»f
 = 0;

8946 
wc
->
¡age
 = 
DROP_REFERENCE
;

8947 
wc
->
sh¬ed_Ëv–
 = -1;

8948 
·th
->
¦Ùs
[
Ëv–
] = 0;

8955 ià(!
·th
->
locks
[
Ëv–
]) {

8956 
	`BUG_ON
(
Ëv–
 == 0);

8957 
	`bŒfs_Œ“_lock
(
eb
);

8958 
	`bŒfs_£t_lock_blockšg
(
eb
);

8959 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

8961 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
,

8962 
eb
->
¡¬t
, 
Ëv–
, 1,

8963 &
wc
->
»fs
[
Ëv–
],

8964 &
wc
->
æags
[
Ëv–
]);

8965 ià(
»t
 < 0) {

8966 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

8967 
·th
->
locks
[
Ëv–
] = 0;

8968  
»t
;

8970 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] == 0);

8971 ià(
wc
->
»fs
[
Ëv–
] == 1) {

8972 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

8973 
·th
->
locks
[
Ëv–
] = 0;

8980 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] > 1 && !
·th
->
locks
[level]);

8982 ià(
wc
->
»fs
[
Ëv–
] == 1) {

8983 ià(
Ëv–
 == 0) {

8984 ià(
wc
->
æags
[
Ëv–
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

8985 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
eb
, 1);

8987 
»t
 = 
	`bŒfs_dec_»f
(
Œªs
, 
roÙ
, 
eb
, 0);

8988 
	`BUG_ON
(
»t
);

8989 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
, 
fs_šfo
, 
eb
);

8990 ià(
»t
) {

8991 
	`bŒfs_”r_¾
(
fs_šfo
,

8993 
»t
);

8997 ià(!
·th
->
locks
[
Ëv–
] &&

8998 
	`bŒfs_h—d”_g’”©iÚ
(
eb
è=ð
Œªs
->
Œªsid
) {

8999 
	`bŒfs_Œ“_lock
(
eb
);

9000 
	`bŒfs_£t_lock_blockšg
(
eb
);

9001 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

9003 
	`þ—n_Œ“_block
(
fs_šfo
, 
eb
);

9006 ià(
eb
 =ð
roÙ
->
node
) {

9007 ià(
wc
->
æags
[
Ëv–
] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

9008 
·»Á
 = 
eb
->
¡¬t
;

9010 
	`BUG_ON
(
roÙ
->
roÙ_key
.
objeùid
 !=

9011 
	`bŒfs_h—d”_owÃr
(
eb
));

9013 ià(
wc
->
æags
[
Ëv–
 + 1] & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

9014 
·»Á
 = 
·th
->
nodes
[
Ëv–
 + 1]->
¡¬t
;

9016 
	`BUG_ON
(
roÙ
->
roÙ_key
.
objeùid
 !=

9017 
	`bŒfs_h—d”_owÃr
(
·th
->
nodes
[
Ëv–
 + 1]));

9020 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
roÙ
, 
eb
, 
·»Á
, 
wc
->
»fs
[
Ëv–
] == 1);

9021 
out
:

9022 
wc
->
»fs
[
Ëv–
] = 0;

9023 
wc
->
æags
[
Ëv–
] = 0;

9025 
	}
}

9027 
nošlše
 
	$w®k_down_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9028 
bŒfs_roÙ
 *
roÙ
,

9029 
bŒfs_·th
 *
·th
,

9030 
w®k_cÚŒÞ
 *
wc
)

9032 
Ëv–
 = 
wc
->level;

9033 
lookup_šfo
 = 1;

9034 
»t
;

9036 
Ëv–
 >= 0) {

9037 
»t
 = 
	`w®k_down_´oc
(
Œªs
, 
roÙ
, 
·th
, 
wc
, 
lookup_šfo
);

9038 ià(
»t
 > 0)

9041 ià(
Ëv–
 == 0)

9044 ià(
·th
->
¦Ùs
[
Ëv–
] >=

9045 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
]))

9048 
»t
 = 
	`do_w®k_down
(
Œªs
, 
roÙ
, 
·th
, 
wc
, &
lookup_šfo
);

9049 ià(
»t
 > 0) {

9050 
·th
->
¦Ùs
[
Ëv–
]++;

9052 } ià(
»t
 < 0)

9053  
»t
;

9054 
Ëv–
 = 
wc
->level;

9057 
	}
}

9059 
nošlše
 
	$w®k_up_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9060 
bŒfs_roÙ
 *
roÙ
,

9061 
bŒfs_·th
 *
·th
,

9062 
w®k_cÚŒÞ
 *
wc
, 
max_Ëv–
)

9064 
Ëv–
 = 
wc
->level;

9065 
»t
;

9067 
·th
->
¦Ùs
[
Ëv–
] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[level]);

9068 
Ëv–
 < 
max_Ëv–
 && 
·th
->
nodes
[level]) {

9069 
wc
->
Ëv–
 =†evel;

9070 ià(
·th
->
¦Ùs
[
Ëv–
] + 1 <

9071 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
])) {

9072 
·th
->
¦Ùs
[
Ëv–
]++;

9075 
»t
 = 
	`w®k_up_´oc
(
Œªs
, 
roÙ
, 
·th
, 
wc
);

9076 ià(
»t
 > 0)

9079 ià(
·th
->
locks
[
Ëv–
]) {

9080 
	`bŒfs_Œ“_uÆock_rw
(
·th
->
nodes
[
Ëv–
],

9081 
·th
->
locks
[
Ëv–
]);

9082 
·th
->
locks
[
Ëv–
] = 0;

9084 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
Ëv–
]);

9085 
·th
->
nodes
[
Ëv–
] = 
NULL
;

9086 
Ëv–
++;

9090 
	}
}

9105 
	$bŒfs_drÝ_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
,

9106 
bŒfs_block_rsv
 *
block_rsv
, 
upd©e_»f
,

9107 
fÜ_»loc
)

9109 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

9110 
bŒfs_·th
 *
·th
;

9111 
bŒfs_Œªs_hªdË
 *
Œªs
;

9112 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

9113 
bŒfs_roÙ_™em
 *
roÙ_™em
 = &
roÙ
->root_item;

9114 
w®k_cÚŒÞ
 *
wc
;

9115 
bŒfs_key
 
key
;

9116 
”r
 = 0;

9117 
»t
;

9118 
Ëv–
;

9119 
boÞ
 
roÙ_drÝ³d
 = 
çl£
;

9121 
	`bŒfs_debug
(
fs_šfo
, "DrÝ subvÞum%Îu", 
roÙ
->
objeùid
);

9123 
·th
 = 
	`bŒfs_®loc_·th
();

9124 ià(!
·th
) {

9125 
”r
 = -
ENOMEM
;

9126 
out
;

9129 
wc
 = 
	`kz®loc
((*wc), 
GFP_NOFS
);

9130 ià(!
wc
) {

9131 
	`bŒfs_ä“_·th
(
·th
);

9132 
”r
 = -
ENOMEM
;

9133 
out
;

9136 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

9137 ià(
	`IS_ERR
(
Œªs
)) {

9138 
”r
 = 
	`PTR_ERR
(
Œªs
);

9139 
out_ä“
;

9142 ià(
block_rsv
)

9143 
Œªs
->
block_rsv
 = block_rsv;

9145 ià(
	`bŒfs_disk_key_objeùid
(&
roÙ_™em
->
drÝ_´og»ss
) == 0) {

9146 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

9147 
·th
->
nodes
[
Ëv–
] = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

9148 
	`bŒfs_£t_lock_blockšg
(
·th
->
nodes
[
Ëv–
]);

9149 
·th
->
¦Ùs
[
Ëv–
] = 0;

9150 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

9151 
	`mem£t
(&
wc
->
upd©e_´og»ss
, 0,

9152 (
wc
->
upd©e_´og»ss
));

9154 
	`bŒfs_disk_key_to_ýu
(&
key
, &
roÙ_™em
->
drÝ_´og»ss
);

9155 
	`memýy
(&
wc
->
upd©e_´og»ss
, &
key
,

9156 (
wc
->
upd©e_´og»ss
));

9158 
Ëv–
 = 
roÙ_™em
->
drÝ_Ëv–
;

9159 
	`BUG_ON
(
Ëv–
 == 0);

9160 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

9161 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

9162 
·th
->
lowe¡_Ëv–
 = 0;

9163 ià(
»t
 < 0) {

9164 
”r
 = 
»t
;

9165 
out_’d_Œªs
;

9167 
	`WARN_ON
(
»t
 > 0);

9173 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

9175 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

9177 
	`bŒfs_Œ“_lock
(
·th
->
nodes
[
Ëv–
]);

9178 
	`bŒfs_£t_lock_blockšg
(
·th
->
nodes
[
Ëv–
]);

9179 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

9181 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
Œªs
, 
fs_šfo
,

9182 
·th
->
nodes
[
Ëv–
]->
¡¬t
,

9183 
Ëv–
, 1, &
wc
->
»fs
[level],

9184 &
wc
->
æags
[
Ëv–
]);

9185 ià(
»t
 < 0) {

9186 
”r
 = 
»t
;

9187 
out_’d_Œªs
;

9189 
	`BUG_ON
(
wc
->
»fs
[
Ëv–
] == 0);

9191 ià(
Ëv–
 =ð
roÙ_™em
->
drÝ_Ëv–
)

9194 
	`bŒfs_Œ“_uÆock
(
·th
->
nodes
[
Ëv–
]);

9195 
·th
->
locks
[
Ëv–
] = 0;

9196 
	`WARN_ON
(
wc
->
»fs
[
Ëv–
] != 1);

9197 
Ëv–
--;

9201 
wc
->
Ëv–
 =†evel;

9202 
wc
->
sh¬ed_Ëv–
 = -1;

9203 
wc
->
¡age
 = 
DROP_REFERENCE
;

9204 
wc
->
upd©e_»f
 = update_ref;

9205 
wc
->
k“p_locks
 = 0;

9206 
wc
->
fÜ_»loc
 = for_reloc;

9207 
wc
->
»ada_couÁ
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
);

9211 
»t
 = 
	`w®k_down_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
);

9212 ià(
»t
 < 0) {

9213 
”r
 = 
»t
;

9217 
»t
 = 
	`w®k_up_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
, 
BTRFS_MAX_LEVEL
);

9218 ià(
»t
 < 0) {

9219 
”r
 = 
»t
;

9223 ià(
»t
 > 0) {

9224 
	`BUG_ON
(
wc
->
¡age
 !ð
DROP_REFERENCE
);

9228 ià(
wc
->
¡age
 =ð
DROP_REFERENCE
) {

9229 
Ëv–
 = 
wc
->level;

9230 
	`bŒfs_node_key
(
·th
->
nodes
[
Ëv–
],

9231 &
roÙ_™em
->
drÝ_´og»ss
,

9232 
·th
->
¦Ùs
[
Ëv–
]);

9233 
roÙ_™em
->
drÝ_Ëv–
 = 
Ëv–
;

9236 
	`BUG_ON
(
wc
->
Ëv–
 == 0);

9237 ià(
	`bŒfs_should_’d_Œª§ùiÚ
(
Œªs
) ||

9238 (!
fÜ_»loc
 && 
	`bŒfs_Ãed_þ—Ãr_¦“p
(
fs_šfo
))) {

9239 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
Œ“_roÙ
,

9240 &
roÙ
->
roÙ_key
,

9241 
roÙ_™em
);

9242 ià(
»t
) {

9243 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9244 
”r
 = 
»t
;

9245 
out_’d_Œªs
;

9248 
	`bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
Œªs
);

9249 ià(!
fÜ_»loc
 && 
	`bŒfs_Ãed_þ—Ãr_¦“p
(
fs_šfo
)) {

9250 
	`bŒfs_debug
(
fs_šfo
,

9252 
”r
 = -
EAGAIN
;

9253 
out_ä“
;

9256 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

9257 ià(
	`IS_ERR
(
Œªs
)) {

9258 
”r
 = 
	`PTR_ERR
(
Œªs
);

9259 
out_ä“
;

9261 ià(
block_rsv
)

9262 
Œªs
->
block_rsv
 = block_rsv;

9265 
	`bŒfs_»Ëa£_·th
(
·th
);

9266 ià(
”r
)

9267 
out_’d_Œªs
;

9269 
»t
 = 
	`bŒfs_d–_roÙ
(
Œªs
, 
fs_šfo
, &
roÙ
->
roÙ_key
);

9270 ià(
»t
) {

9271 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9272 
out_’d_Œªs
;

9275 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
) {

9276 
»t
 = 
	`bŒfs_fšd_roÙ
(
Œ“_roÙ
, &
roÙ
->
roÙ_key
, 
·th
,

9277 
NULL
, NULL);

9278 ià(
»t
 < 0) {

9279 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9280 
”r
 = 
»t
;

9281 
out_’d_Œªs
;

9282 } ià(
»t
 > 0) {

9288 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
Œ“_roÙ
,

9289 
roÙ
->
roÙ_key
.
objeùid
);

9293 ià(
	`‹¡_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
)) {

9294 
	`bŒfs_add_drÝ³d_roÙ
(
Œªs
, 
roÙ
);

9296 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

9297 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

9298 
	`bŒfs_put_fs_roÙ
(
roÙ
);

9300 
roÙ_drÝ³d
 = 
Œue
;

9301 
out_’d_Œªs
:

9302 
	`bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
Œªs
);

9303 
out_ä“
:

9304 
	`kä“
(
wc
);

9305 
	`bŒfs_ä“_·th
(
·th
);

9306 
out
:

9314 ià(!
fÜ_»loc
 && 
roÙ_drÝ³d
 =ð
çl£
)

9315 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

9316 ià(
”r
 &&ƒ¼ !ð-
EAGAIN
)

9317 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
, 
NULL
);

9318  
”r
;

9319 
	}
}

9327 
	$bŒfs_drÝ_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9328 
bŒfs_roÙ
 *
roÙ
,

9329 
ex‹Á_bufãr
 *
node
,

9330 
ex‹Á_bufãr
 *
·»Á
)

9332 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

9333 
bŒfs_·th
 *
·th
;

9334 
w®k_cÚŒÞ
 *
wc
;

9335 
Ëv–
;

9336 
·»Á_Ëv–
;

9337 
»t
 = 0;

9338 
w»t
;

9340 
	`BUG_ON
(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
);

9342 
·th
 = 
	`bŒfs_®loc_·th
();

9343 ià(!
·th
)

9344  -
ENOMEM
;

9346 
wc
 = 
	`kz®loc
((*wc), 
GFP_NOFS
);

9347 ià(!
wc
) {

9348 
	`bŒfs_ä“_·th
(
·th
);

9349  -
ENOMEM
;

9352 
	`bŒfs_as£¹_Œ“_locked
(
·»Á
);

9353 
·»Á_Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

9354 
	`ex‹Á_bufãr_g‘
(
·»Á
);

9355 
·th
->
nodes
[
·»Á_Ëv–
] = 
·»Á
;

9356 
·th
->
¦Ùs
[
·»Á_Ëv–
] = 
	`bŒfs_h—d”_Ä™ems
(
·»Á
);

9358 
	`bŒfs_as£¹_Œ“_locked
(
node
);

9359 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
node
);

9360 
·th
->
nodes
[
Ëv–
] = 
node
;

9361 
·th
->
¦Ùs
[
Ëv–
] = 0;

9362 
·th
->
locks
[
Ëv–
] = 
BTRFS_WRITE_LOCK_BLOCKING
;

9364 
wc
->
»fs
[
·»Á_Ëv–
] = 1;

9365 
wc
->
æags
[
·»Á_Ëv–
] = 
BTRFS_BLOCK_FLAG_FULL_BACKREF
;

9366 
wc
->
Ëv–
 =†evel;

9367 
wc
->
sh¬ed_Ëv–
 = -1;

9368 
wc
->
¡age
 = 
DROP_REFERENCE
;

9369 
wc
->
upd©e_»f
 = 0;

9370 
wc
->
k“p_locks
 = 1;

9371 
wc
->
fÜ_»loc
 = 1;

9372 
wc
->
»ada_couÁ
 = 
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
);

9375 
w»t
 = 
	`w®k_down_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
);

9376 ià(
w»t
 < 0) {

9377 
»t
 = 
w»t
;

9381 
w»t
 = 
	`w®k_up_Œ“
(
Œªs
, 
roÙ
, 
·th
, 
wc
, 
·»Á_Ëv–
);

9382 ià(
w»t
 < 0)

9383 
»t
 = 
w»t
;

9384 ià(
w»t
 != 0)

9388 
	`kä“
(
wc
);

9389 
	`bŒfs_ä“_·th
(
·th
);

9390  
»t
;

9391 
	}
}

9393 
u64
 
	$upd©e_block_group_æags
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

9395 
u64
 
num_deviûs
;

9396 
u64
 
¡r³d
;

9402 
¡r³d
 = 
	`g‘_»¡re_rg‘
(
fs_šfo
, 
æags
);

9403 ià(
¡r³d
)

9404  
	`ex‹nded_to_chunk
(
¡r³d
);

9406 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->
rw_deviûs
;

9408 
¡r³d
 = 
BTRFS_BLOCK_GROUP_RAID0
 |

9409 
BTRFS_BLOCK_GROUP_RAID5
 | 
BTRFS_BLOCK_GROUP_RAID6
 |

9410 
BTRFS_BLOCK_GROUP_RAID1
 | 
BTRFS_BLOCK_GROUP_RAID10
;

9412 ià(
num_deviûs
 == 1) {

9413 
¡r³d
 |ð
BTRFS_BLOCK_GROUP_DUP
;

9414 
¡r³d
 = 
æags
 & ~stripped;

9417 ià(
æags
 & 
BTRFS_BLOCK_GROUP_RAID0
)

9418  
¡r³d
;

9421 ià(
æags
 & (
BTRFS_BLOCK_GROUP_RAID1
 |

9422 
BTRFS_BLOCK_GROUP_RAID10
))

9423  
¡r³d
 | 
BTRFS_BLOCK_GROUP_DUP
;

9426 ià(
æags
 & 
¡r³d
)

9427  
æags
;

9429 
¡r³d
 |ð
BTRFS_BLOCK_GROUP_DUP
;

9430 
¡r³d
 = 
æags
 & ~stripped;

9433 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DUP
)

9434  
¡r³d
 | 
BTRFS_BLOCK_GROUP_RAID1
;

9439  
æags
;

9440 
	}
}

9442 
	$šc_block_group_ro
(
bŒfs_block_group_ÿche
 *
ÿche
, 
fÜû
)

9444 
bŒfs_¥aû_šfo
 *
sšfo
 = 
ÿche
->
¥aû_šfo
;

9445 
u64
 
num_by‹s
;

9446 
u64
 
mš_®loÿbË_by‹s
;

9447 
»t
 = -
ENOSPC
;

9454 ià((
sšfo
->
æags
 &

9455 (
BTRFS_BLOCK_GROUP_SYSTEM
 | 
BTRFS_BLOCK_GROUP_METADATA
)) &&

9456 !
fÜû
)

9457 
mš_®loÿbË_by‹s
 = 
SZ_1M
;

9459 
mš_®loÿbË_by‹s
 = 0;

9461 
	`¥š_lock
(&
sšfo
->
lock
);

9462 
	`¥š_lock
(&
ÿche
->
lock
);

9464 ià(
ÿche
->
ro
) {

9465 
ÿche
->
ro
++;

9466 
»t
 = 0;

9467 
out
;

9470 
num_by‹s
 = 
ÿche
->
key
.
off£t
 - cache->
»£rved
 - cache->
pšÃd
 -

9471 
ÿche
->
by‹s_su³r
 - 
	`bŒfs_block_group_u£d
(&ÿche->
™em
);

9473 ià(
	`bŒfs_¥aû_šfo_u£d
(
sšfo
, 
Œue
è+ 
num_by‹s
 +

9474 
mš_®loÿbË_by‹s
 <ð
sšfo
->
tÙ®_by‹s
) {

9475 
sšfo
->
by‹s_»adÚly
 +ð
num_by‹s
;

9476 
ÿche
->
ro
++;

9477 
	`li¡_add_ž
(&
ÿche
->
ro_li¡
, &
sšfo
->
ro_bgs
);

9478 
»t
 = 0;

9480 
out
:

9481 
	`¥š_uÆock
(&
ÿche
->
lock
);

9482 
	`¥š_uÆock
(&
sšfo
->
lock
);

9483  
»t
;

9484 
	}
}

9486 
	$bŒfs_šc_block_group_ro
(
bŒfs_fs_šfo
 *
fs_šfo
,

9487 
bŒfs_block_group_ÿche
 *
ÿche
)

9490 
bŒfs_Œªs_hªdË
 *
Œªs
;

9491 
u64
 
®loc_æags
;

9492 
»t
;

9494 
agaš
:

9495 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
fs_šfo
->
ex‹Á_roÙ
);

9496 ià(
	`IS_ERR
(
Œªs
))

9497  
	`PTR_ERR
(
Œªs
);

9504 
	`mu‹x_lock
(&
fs_šfo
->
ro_block_group_mu‹x
);

9505 ià(
	`‹¡_b™
(
BTRFS_TRANS_DIRTY_BG_RUN
, &
Œªs
->
Œª§ùiÚ
->
æags
)) {

9506 
u64
 
Œªsid
 = 
Œªs
->transid;

9508 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

9509 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9511 
»t
 = 
	`bŒfs_wa™_fÜ_comm™
(
fs_šfo
, 
Œªsid
);

9512 ià(
»t
)

9513  
»t
;

9514 
agaš
;

9521 
®loc_æags
 = 
	`upd©e_block_group_æags
(
fs_šfo
, 
ÿche
->
æags
);

9522 ià(
®loc_æags
 !ð
ÿche
->
æags
) {

9523 
»t
 = 
	`do_chunk_®loc
(
Œªs
, 
fs_šfo
, 
®loc_æags
,

9524 
CHUNK_ALLOC_FORCE
);

9530 ià(
»t
 =ð-
ENOSPC
)

9531 
»t
 = 0;

9532 ià(
»t
 < 0)

9533 
out
;

9536 
»t
 = 
	`šc_block_group_ro
(
ÿche
, 0);

9537 ià(!
»t
)

9538 
out
;

9539 
®loc_æags
 = 
	`g‘_®loc_´ofže
(
fs_šfo
, 
ÿche
->
¥aû_šfo
->
æags
);

9540 
»t
 = 
	`do_chunk_®loc
(
Œªs
, 
fs_šfo
, 
®loc_æags
,

9541 
CHUNK_ALLOC_FORCE
);

9542 ià(
»t
 < 0)

9543 
out
;

9544 
»t
 = 
	`šc_block_group_ro
(
ÿche
, 0);

9545 
out
:

9546 ià(
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

9547 
®loc_æags
 = 
	`upd©e_block_group_æags
(
fs_šfo
, 
ÿche
->
æags
);

9548 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

9549 
	`check_sy¡em_chunk
(
Œªs
, 
fs_šfo
, 
®loc_æags
);

9550 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

9552 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

9554 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9555  
»t
;

9556 
	}
}

9558 
	$bŒfs_fÜû_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9559 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
)

9561 
u64
 
®loc_æags
 = 
	`g‘_®loc_´ofže
(
fs_šfo
, 
ty³
);

9563  
	`do_chunk_®loc
(
Œªs
, 
fs_šfo
, 
®loc_æags
, 
CHUNK_ALLOC_FORCE
);

9564 
	}
}

9570 
u64
 
	$bŒfs_accouÁ_ro_block_groups_ä“_¥aû
(
bŒfs_¥aû_šfo
 *
sšfo
)

9572 
bŒfs_block_group_ÿche
 *
block_group
;

9573 
u64
 
ä“_by‹s
 = 0;

9574 
çùÜ
;

9577 ià(
	`li¡_em±y
(&
sšfo
->
ro_bgs
))

9580 
	`¥š_lock
(&
sšfo
->
lock
);

9581 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
sšfo
->
ro_bgs
, 
ro_li¡
) {

9582 
	`¥š_lock
(&
block_group
->
lock
);

9584 ià(!
block_group
->
ro
) {

9585 
	`¥š_uÆock
(&
block_group
->
lock
);

9589 ià(
block_group
->
æags
 & (
BTRFS_BLOCK_GROUP_RAID1
 |

9590 
BTRFS_BLOCK_GROUP_RAID10
 |

9591 
BTRFS_BLOCK_GROUP_DUP
))

9592 
çùÜ
 = 2;

9594 
çùÜ
 = 1;

9596 
ä“_by‹s
 +ð(
block_group
->
key
.
off£t
 -

9597 
	`bŒfs_block_group_u£d
(&
block_group
->
™em
)) *

9598 
çùÜ
;

9600 
	`¥š_uÆock
(&
block_group
->
lock
);

9602 
	`¥š_uÆock
(&
sšfo
->
lock
);

9604  
ä“_by‹s
;

9605 
	}
}

9607 
	$bŒfs_dec_block_group_ro
(
bŒfs_block_group_ÿche
 *
ÿche
)

9609 
bŒfs_¥aû_šfo
 *
sšfo
 = 
ÿche
->
¥aû_šfo
;

9610 
u64
 
num_by‹s
;

9612 
	`BUG_ON
(!
ÿche
->
ro
);

9614 
	`¥š_lock
(&
sšfo
->
lock
);

9615 
	`¥š_lock
(&
ÿche
->
lock
);

9616 ià(!--
ÿche
->
ro
) {

9617 
num_by‹s
 = 
ÿche
->
key
.
off£t
 - cache->
»£rved
 -

9618 
ÿche
->
pšÃd
 - cache->
by‹s_su³r
 -

9619 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
);

9620 
sšfo
->
by‹s_»adÚly
 -ð
num_by‹s
;

9621 
	`li¡_d–_š™
(&
ÿche
->
ro_li¡
);

9623 
	`¥š_uÆock
(&
ÿche
->
lock
);

9624 
	`¥š_uÆock
(&
sšfo
->
lock
);

9625 
	}
}

9633 
	$bŒfs_ÿn_»loÿ‹
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
)

9635 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

9636 
bŒfs_block_group_ÿche
 *
block_group
;

9637 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

9638 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

9639 
bŒfs_deviû
 *
deviû
;

9640 
bŒfs_Œªs_hªdË
 *
Œªs
;

9641 
u64
 
mš_ä“
;

9642 
u64
 
dev_mš
 = 1;

9643 
u64
 
dev_Ä
 = 0;

9644 
u64
 
rg‘
;

9645 
debug
;

9646 
šdex
;

9647 
fuÎ
 = 0;

9648 
»t
 = 0;

9650 
debug
 = 
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
ENOSPC_DEBUG
);

9652 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

9655 ià(!
block_group
) {

9656 ià(
debug
)

9657 
	`bŒfs_w¬n
(
fs_šfo
,

9659 
by‹Ä
);

9663 
mš_ä“
 = 
	`bŒfs_block_group_u£d
(&
block_group
->
™em
);

9666 ià(!
mš_ä“
)

9667 
out
;

9669 
¥aû_šfo
 = 
block_group
->space_info;

9670 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

9672 
fuÎ
 = 
¥aû_šfo
->full;

9681 ià((
¥aû_šfo
->
tÙ®_by‹s
 !ð
block_group
->
key
.
off£t
) &&

9682 (
	`bŒfs_¥aû_šfo_u£d
(
¥aû_šfo
, 
çl£
è+ 
mš_ä“
 <

9683 
¥aû_šfo
->
tÙ®_by‹s
)) {

9684 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

9685 
out
;

9687 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

9696 
»t
 = -1;

9706 
rg‘
 = 
	`g‘_»¡re_rg‘
(
fs_šfo
, 
block_group
->
æags
);

9707 ià(
rg‘
) {

9708 
šdex
 = 
	`__g‘_¿id_šdex
(
	`ex‹nded_to_chunk
(
rg‘
));

9714 ià(
fuÎ
) {

9715 ià(
debug
)

9716 
	`bŒfs_w¬n
(
fs_šfo
,

9718 
block_group
->
key
.
objeùid
);

9719 
out
;

9722 
šdex
 = 
	`g‘_block_group_šdex
(
block_group
);

9725 ià(
šdex
 =ð
BTRFS_RAID_RAID10
) {

9726 
dev_mš
 = 4;

9728 
mš_ä“
 >>= 1;

9729 } ià(
šdex
 =ð
BTRFS_RAID_RAID1
) {

9730 
dev_mš
 = 2;

9731 } ià(
šdex
 =ð
BTRFS_RAID_DUP
) {

9733 
mš_ä“
 <<= 1;

9734 } ià(
šdex
 =ð
BTRFS_RAID_RAID0
) {

9735 
dev_mš
 = 
fs_deviûs
->
rw_deviûs
;

9736 
mš_ä“
 = 
	`div64_u64
(mš_ä“, 
dev_mš
);

9740 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

9741 ià(
	`IS_ERR
(
Œªs
)) {

9742 
»t
 = 
	`PTR_ERR
(
Œªs
);

9743 
out
;

9746 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

9747 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
®loc_li¡
, 
dev_®loc_li¡
) {

9748 
u64
 
dev_off£t
;

9754 ià(
deviû
->
tÙ®_by‹s
 > deviû->
by‹s_u£d
 + 
mš_ä“
 &&

9755 !
deviû
->
is_tgtdev_fÜ_dev_»¶aû
) {

9756 
»t
 = 
	`fšd_ä“_dev_ex‹Á
(
Œªs
, 
deviû
, 
mš_ä“
,

9757 &
dev_off£t
, 
NULL
);

9758 ià(!
»t
)

9759 
dev_Ä
++;

9761 ià(
dev_Ä
 >ð
dev_mš
)

9764 
»t
 = -1;

9767 ià(
debug
 && 
»t
 == -1)

9768 
	`bŒfs_w¬n
(
fs_šfo
,

9770 
block_group
->
key
.
objeùid
);

9771 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

9772 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9773 
out
:

9774 
	`bŒfs_put_block_group
(
block_group
);

9775  
»t
;

9776 
	}
}

9778 
	$fšd_fœ¡_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
,

9779 
bŒfs_·th
 *
·th
,

9780 
bŒfs_key
 *
key
)

9782 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

9783 
»t
 = 0;

9784 
bŒfs_key
 
found_key
;

9785 
ex‹Á_bufãr
 *
Ëaf
;

9786 
¦Ù
;

9788 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
·th
, 0, 0);

9789 ià(
»t
 < 0)

9790 
out
;

9793 
¦Ù
 = 
·th
->
¦Ùs
[0];

9794 
Ëaf
 = 
·th
->
nodes
[0];

9795 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

9796 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

9797 ià(
»t
 == 0)

9799 ià(
»t
 < 0)

9800 
out
;

9803 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

9805 ià(
found_key
.
objeùid
 >ð
key
->objectid &&

9806 
found_key
.
ty³
 =ð
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

9807 
ex‹Á_m­_Œ“
 *
em_Œ“
;

9808 
ex‹Á_m­
 *
em
;

9810 
em_Œ“
 = &
roÙ
->
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

9811 
	`»ad_lock
(&
em_Œ“
->
lock
);

9812 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
found_key
.
objeùid
,

9813 
found_key
.
off£t
);

9814 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

9815 ià(!
em
) {

9816 
	`bŒfs_”r
(
fs_šfo
,

9818 
found_key
.
objeùid
, found_key.
off£t
);

9819 
»t
 = -
ENOENT
;

9821 
»t
 = 0;

9823 
	`ä“_ex‹Á_m­
(
em
);

9824 
out
;

9826 
·th
->
¦Ùs
[0]++;

9828 
out
:

9829  
»t
;

9830 
	}
}

9832 
	$bŒfs_put_block_group_ÿche
(
bŒfs_fs_šfo
 *
šfo
)

9834 
bŒfs_block_group_ÿche
 *
block_group
;

9835 
u64
 
Ï¡
 = 0;

9838 
šode
 *inode;

9840 
block_group
 = 
	`bŒfs_lookup_fœ¡_block_group
(
šfo
, 
Ï¡
);

9841 
block_group
) {

9842 
	`¥š_lock
(&
block_group
->
lock
);

9843 ià(
block_group
->
œef
)

9845 
	`¥š_uÆock
(&
block_group
->
lock
);

9846 
block_group
 = 
	`Ãxt_block_group
(
šfo
, block_group);

9848 ià(!
block_group
) {

9849 ià(
Ï¡
 == 0)

9851 
Ï¡
 = 0;

9855 
šode
 = 
block_group
->inode;

9856 
block_group
->
œef
 = 0;

9857 
block_group
->
šode
 = 
NULL
;

9858 
	`¥š_uÆock
(&
block_group
->
lock
);

9859 
	`ASSERT
(
block_group
->
io_ùl
.
šode
 =ð
NULL
);

9860 
	`ut
(
šode
);

9861 
Ï¡
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

9862 
	`bŒfs_put_block_group
(
block_group
);

9864 
	}
}

9871 
	$bŒfs_ä“_block_groups
(
bŒfs_fs_šfo
 *
šfo
)

9873 
bŒfs_block_group_ÿche
 *
block_group
;

9874 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

9875 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
;

9876 
rb_node
 *
n
;

9878 
	`down_wr™e
(&
šfo
->
comm™_roÙ_£m
);

9879 !
	`li¡_em±y
(&
šfo
->
ÿchšg_block_groups
)) {

9880 
ÿchšg_ùl
 = 
	`li¡_’Œy
(
šfo
->
ÿchšg_block_groups
.
Ãxt
,

9881 
bŒfs_ÿchšg_cÚŒÞ
, 
li¡
);

9882 
	`li¡_d–
(&
ÿchšg_ùl
->
li¡
);

9883 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

9885 
	`up_wr™e
(&
šfo
->
comm™_roÙ_£m
);

9887 
	`¥š_lock
(&
šfo
->
unu£d_bgs_lock
);

9888 !
	`li¡_em±y
(&
šfo
->
unu£d_bgs
)) {

9889 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
šfo
->
unu£d_bgs
,

9890 
bŒfs_block_group_ÿche
,

9891 
bg_li¡
);

9892 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

9893 
	`bŒfs_put_block_group
(
block_group
);

9895 
	`¥š_uÆock
(&
šfo
->
unu£d_bgs_lock
);

9897 
	`¥š_lock
(&
šfo
->
block_group_ÿche_lock
);

9898 (
n
 = 
	`rb_Ï¡
(&
šfo
->
block_group_ÿche_Œ“
)è!ð
NULL
) {

9899 
block_group
 = 
	`rb_’Œy
(
n
, 
bŒfs_block_group_ÿche
,

9900 
ÿche_node
);

9901 
	`rb_”a£
(&
block_group
->
ÿche_node
,

9902 &
šfo
->
block_group_ÿche_Œ“
);

9903 
	`RB_CLEAR_NODE
(&
block_group
->
ÿche_node
);

9904 
	`¥š_uÆock
(&
šfo
->
block_group_ÿche_lock
);

9906 
	`down_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

9907 
	`li¡_d–
(&
block_group
->
li¡
);

9908 
	`up_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

9914 ià(
block_group
->
ÿched
 =ð
BTRFS_CACHE_NO
 ||

9915 
block_group
->
ÿched
 =ð
BTRFS_CACHE_ERROR
)

9916 
	`ä“_exþuded_ex‹Ás
(
šfo
, 
block_group
);

9918 
	`bŒfs_»move_ä“_¥aû_ÿche
(
block_group
);

9919 
	`ASSERT
(
block_group
->
ÿched
 !ð
BTRFS_CACHE_STARTED
);

9920 
	`ASSERT
(
	`li¡_em±y
(&
block_group
->
dœty_li¡
));

9921 
	`ASSERT
(
	`li¡_em±y
(&
block_group
->
io_li¡
));

9922 
	`ASSERT
(
	`li¡_em±y
(&
block_group
->
bg_li¡
));

9923 
	`ASSERT
(
	`©omic_»ad
(&
block_group
->
couÁ
) == 1);

9924 
	`bŒfs_put_block_group
(
block_group
);

9926 
	`¥š_lock
(&
šfo
->
block_group_ÿche_lock
);

9928 
	`¥š_uÆock
(&
šfo
->
block_group_ÿche_lock
);

9936 
	`synchrÚize_rcu
();

9938 
	`»Ëa£_glob®_block_rsv
(
šfo
);

9940 !
	`li¡_em±y
(&
šfo
->
¥aû_šfo
)) {

9941 
i
;

9943 
¥aû_šfo
 = 
	`li¡_’Œy
(
šfo
->¥aû_šfo.
Ãxt
,

9944 
bŒfs_¥aû_šfo
,

9945 
li¡
);

9951 ià(
	`WARN_ON
(
¥aû_šfo
->
by‹s_pšÃd
 > 0 ||

9952 
¥aû_šfo
->
by‹s_»£rved
 > 0 ||

9953 
¥aû_šfo
->
by‹s_may_u£
 > 0))

9954 
	`dump_¥aû_šfo
(
šfo
, 
¥aû_šfo
, 0, 0);

9955 
	`li¡_d–
(&
¥aû_šfo
->
li¡
);

9956 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

9957 
kobjeù
 *
kobj
;

9958 
kobj
 = 
¥aû_šfo
->
block_group_kobjs
[
i
];

9959 
¥aû_šfo
->
block_group_kobjs
[
i
] = 
NULL
;

9960 ià(
kobj
) {

9961 
	`kobjeù_d–
(
kobj
);

9962 
	`kobjeù_put
(
kobj
);

9965 
	`kobjeù_d–
(&
¥aû_šfo
->
kobj
);

9966 
	`kobjeù_put
(&
¥aû_šfo
->
kobj
);

9969 
	}
}

9971 
	$__lšk_block_group
(
bŒfs_¥aû_šfo
 *
¥aû_šfo
,

9972 
bŒfs_block_group_ÿche
 *
ÿche
)

9974 
šdex
 = 
	`g‘_block_group_šdex
(
ÿche
);

9975 
boÞ
 
fœ¡
 = 
çl£
;

9977 
	`down_wr™e
(&
¥aû_šfo
->
groups_£m
);

9978 ià(
	`li¡_em±y
(&
¥aû_šfo
->
block_groups
[
šdex
]))

9979 
fœ¡
 = 
Œue
;

9980 
	`li¡_add_ž
(&
ÿche
->
li¡
, &
¥aû_šfo
->
block_groups
[
šdex
]);

9981 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

9983 ià(
fœ¡
) {

9984 
¿id_kobjeù
 *
rkobj
;

9985 
»t
;

9987 
rkobj
 = 
	`kz®loc
((*rkobj), 
GFP_NOFS
);

9988 ià(!
rkobj
)

9989 
out_”r
;

9990 
rkobj
->
¿id_ty³
 = 
šdex
;

9991 
	`kobjeù_š™
(&
rkobj
->
kobj
, &
bŒfs_¿id_kty³
);

9992 
»t
 = 
	`kobjeù_add
(&
rkobj
->
kobj
, &
¥aû_šfo
->kobj,

9993 "%s", 
	`g‘_¿id_Çme
(
šdex
));

9994 ià(
»t
) {

9995 
	`kobjeù_put
(&
rkobj
->
kobj
);

9996 
out_”r
;

9998 
¥aû_šfo
->
block_group_kobjs
[
šdex
] = &
rkobj
->
kobj
;

10002 
out_”r
:

10003 
	`bŒfs_w¬n
(
ÿche
->
fs_šfo
,

10005 
	}
}

10007 
bŒfs_block_group_ÿche
 *

10008 
	$bŒfs_ü—‹_block_group_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

10009 
u64
 
¡¬t
, u64 
size
)

10011 
bŒfs_block_group_ÿche
 *
ÿche
;

10013 
ÿche
 = 
	`kz®loc
((*ÿche), 
GFP_NOFS
);

10014 ià(!
ÿche
)

10015  
NULL
;

10017 
ÿche
->
ä“_¥aû_ùl
 = 
	`kz®loc
((*cache->free_space_ctl),

10018 
GFP_NOFS
);

10019 ià(!
ÿche
->
ä“_¥aû_ùl
) {

10020 
	`kä“
(
ÿche
);

10021  
NULL
;

10024 
ÿche
->
key
.
objeùid
 = 
¡¬t
;

10025 
ÿche
->
key
.
off£t
 = 
size
;

10026 
ÿche
->
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

10028 
ÿche
->
fs_šfo
 = fs_info;

10029 
ÿche
->
fuÎ_¡re_Ën
 = 
	`bŒfs_fuÎ_¡re_Ën
(
fs_šfo
, 
¡¬t
);

10030 
	`£t_ä“_¥aû_Œ“_th»shÞds
(
ÿche
);

10032 
	`©omic_£t
(&
ÿche
->
couÁ
, 1);

10033 
	`¥š_lock_š™
(&
ÿche
->
lock
);

10034 
	`š™_rw£m
(&
ÿche
->
d©a_rw£m
);

10035 
	`INIT_LIST_HEAD
(&
ÿche
->
li¡
);

10036 
	`INIT_LIST_HEAD
(&
ÿche
->
þu¡”_li¡
);

10037 
	`INIT_LIST_HEAD
(&
ÿche
->
bg_li¡
);

10038 
	`INIT_LIST_HEAD
(&
ÿche
->
ro_li¡
);

10039 
	`INIT_LIST_HEAD
(&
ÿche
->
dœty_li¡
);

10040 
	`INIT_LIST_HEAD
(&
ÿche
->
io_li¡
);

10041 
	`bŒfs_š™_ä“_¥aû_ùl
(
ÿche
);

10042 
	`©omic_£t
(&
ÿche
->
Œimmšg
, 0);

10043 
	`mu‹x_š™
(&
ÿche
->
ä“_¥aû_lock
);

10044 
	`bŒfs_š™_fuÎ_¡re_locks_Œ“
(&
ÿche
->
fuÎ_¡re_locks_roÙ
);

10046  
ÿche
;

10047 
	}
}

10049 
	$bŒfs_»ad_block_groups
(
bŒfs_fs_šfo
 *
šfo
)

10051 
bŒfs_·th
 *
·th
;

10052 
»t
;

10053 
bŒfs_block_group_ÿche
 *
ÿche
;

10054 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

10055 
bŒfs_key
 
key
;

10056 
bŒfs_key
 
found_key
;

10057 
ex‹Á_bufãr
 *
Ëaf
;

10058 
Ãed_þ—r
 = 0;

10059 
u64
 
ÿche_g’
;

10060 
u64
 
ã©u»
;

10061 
mixed
;

10063 
ã©u»
 = 
	`bŒfs_su³r_šcom·t_æags
(
šfo
->
su³r_cÝy
);

10064 
mixed
 = !!(
ã©u»
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
);

10066 
key
.
objeùid
 = 0;

10067 
key
.
off£t
 = 0;

10068 
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

10069 
·th
 = 
	`bŒfs_®loc_·th
();

10070 ià(!
·th
)

10071  -
ENOMEM
;

10072 
·th
->
»ada
 = 
READA_FORWARD
;

10074 
ÿche_g’
 = 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
šfo
->
su³r_cÝy
);

10075 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SPACE_CACHE
) &&

10076 
	`bŒfs_su³r_g’”©iÚ
(
šfo
->
su³r_cÝy
è!ð
ÿche_g’
)

10077 
Ãed_þ—r
 = 1;

10078 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
CLEAR_CACHE
))

10079 
Ãed_þ—r
 = 1;

10082 
»t
 = 
	`fšd_fœ¡_block_group
(
šfo
, 
·th
, &
key
);

10083 ià(
»t
 > 0)

10085 ià(
»t
 != 0)

10086 
”rÜ
;

10088 
Ëaf
 = 
·th
->
nodes
[0];

10089 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

10091 
ÿche
 = 
	`bŒfs_ü—‹_block_group_ÿche
(
šfo
, 
found_key
.
objeùid
,

10092 
found_key
.
off£t
);

10093 ià(!
ÿche
) {

10094 
»t
 = -
ENOMEM
;

10095 
”rÜ
;

10098 ià(
Ãed_þ—r
) {

10109 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SPACE_CACHE
))

10110 
ÿche
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

10113 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
ÿche
->
™em
,

10114 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]),

10115 (
ÿche
->
™em
));

10116 
ÿche
->
æags
 = 
	`bŒfs_block_group_æags
(&ÿche->
™em
);

10117 ià(!
mixed
 &&

10118 ((
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

10119 (
ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))) {

10120 
	`bŒfs_”r
(
šfo
,

10122 
ÿche
->
key
.
objeùid
);

10123 
»t
 = -
EINVAL
;

10124 
”rÜ
;

10127 
key
.
objeùid
 = 
found_key
.objeùid + found_key.
off£t
;

10128 
	`bŒfs_»Ëa£_·th
(
·th
);

10135 
»t
 = 
	`exþude_su³r_¡res
(
šfo
, 
ÿche
);

10136 ià(
»t
) {

10141 
	`ä“_exþuded_ex‹Ás
(
šfo
, 
ÿche
);

10142 
	`bŒfs_put_block_group
(
ÿche
);

10143 
”rÜ
;

10153 ià(
found_key
.
off£t
 =ð
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
)) {

10154 
ÿche
->
Ï¡_by‹_to_uÅš
 = (
u64
)-1;

10155 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

10156 
	`ä“_exþuded_ex‹Ás
(
šfo
, 
ÿche
);

10157 } ià(
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
) == 0) {

10158 
ÿche
->
Ï¡_by‹_to_uÅš
 = (
u64
)-1;

10159 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

10160 
	`add_Ãw_ä“_¥aû
(
ÿche
, 
šfo
,

10161 
found_key
.
objeùid
,

10162 
found_key
.
objeùid
 +

10163 
found_key
.
off£t
);

10164 
	`ä“_exþuded_ex‹Ás
(
šfo
, 
ÿche
);

10167 
»t
 = 
	`bŒfs_add_block_group_ÿche
(
šfo
, 
ÿche
);

10168 ià(
»t
) {

10169 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

10170 
	`bŒfs_put_block_group
(
ÿche
);

10171 
”rÜ
;

10174 
	`Œaû_bŒfs_add_block_group
(
šfo
, 
ÿche
, 0);

10175 
	`upd©e_¥aû_šfo
(
šfo
, 
ÿche
->
æags
, 
found_key
.
off£t
,

10176 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
),

10177 
ÿche
->
by‹s_su³r
, &
¥aû_šfo
);

10179 
ÿche
->
¥aû_šfo
 = space_info;

10181 
	`__lšk_block_group
(
¥aû_šfo
, 
ÿche
);

10183 
	`£t_avaž_®loc_b™s
(
šfo
, 
ÿche
->
æags
);

10184 ià(
	`bŒfs_chunk_»adÚly
(
šfo
, 
ÿche
->
key
.
objeùid
)) {

10185 
	`šc_block_group_ro
(
ÿche
, 1);

10186 } ià(
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
) == 0) {

10187 
	`¥š_lock
(&
šfo
->
unu£d_bgs_lock
);

10189 ià(
	`li¡_em±y
(&
ÿche
->
bg_li¡
)) {

10190 
	`bŒfs_g‘_block_group
(
ÿche
);

10191 
	`li¡_add_ž
(&
ÿche
->
bg_li¡
,

10192 &
šfo
->
unu£d_bgs
);

10194 
	`¥š_uÆock
(&
šfo
->
unu£d_bgs_lock
);

10198 
	`li¡_fÜ_—ch_’Œy_rcu
(
¥aû_šfo
, &
šfo
->¥aû_šfo, 
li¡
) {

10199 ià(!(
	`g‘_®loc_´ofže
(
šfo
, 
¥aû_šfo
->
æags
) &

10200 (
BTRFS_BLOCK_GROUP_RAID10
 |

10201 
BTRFS_BLOCK_GROUP_RAID1
 |

10202 
BTRFS_BLOCK_GROUP_RAID5
 |

10203 
BTRFS_BLOCK_GROUP_RAID6
 |

10204 
BTRFS_BLOCK_GROUP_DUP
)))

10210 
	`li¡_fÜ_—ch_’Œy
(
ÿche
,

10211 &
¥aû_šfo
->
block_groups
[
BTRFS_RAID_RAID0
],

10212 
li¡
)

10213 
	`šc_block_group_ro
(
ÿche
, 1);

10214 
	`li¡_fÜ_—ch_’Œy
(
ÿche
,

10215 &
¥aû_šfo
->
block_groups
[
BTRFS_RAID_SINGLE
],

10216 
li¡
)

10217 
	`šc_block_group_ro
(
ÿche
, 1);

10220 
	`š™_glob®_block_rsv
(
šfo
);

10221 
»t
 = 0;

10222 
”rÜ
:

10223 
	`bŒfs_ä“_·th
(
·th
);

10224  
»t
;

10225 
	}
}

10227 
	$bŒfs_ü—‹_³ndšg_block_groups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

10228 
bŒfs_fs_šfo
 *
fs_šfo
)

10230 
bŒfs_block_group_ÿche
 *
block_group
, *
tmp
;

10231 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

10232 
bŒfs_block_group_™em
 
™em
;

10233 
bŒfs_key
 
key
;

10234 
»t
 = 0;

10235 
boÞ
 
ÿn_æush_³ndšg_bgs
 = 
Œªs
->can_flush_pending_bgs;

10237 
Œªs
->
ÿn_æush_³ndšg_bgs
 = 
çl£
;

10238 
	`li¡_fÜ_—ch_’Œy_§ã
(
block_group
, 
tmp
, &
Œªs
->
Ãw_bgs
, 
bg_li¡
) {

10239 ià(
»t
)

10240 
Ãxt
;

10242 
	`¥š_lock
(&
block_group
->
lock
);

10243 
	`memýy
(&
™em
, &
block_group
->item, (item));

10244 
	`memýy
(&
key
, &
block_group
->key, (key));

10245 
	`¥š_uÆock
(&
block_group
->
lock
);

10247 
»t
 = 
	`bŒfs_š£¹_™em
(
Œªs
, 
ex‹Á_roÙ
, &
key
, &
™em
,

10248 (
™em
));

10249 ià(
»t
)

10250 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10251 
»t
 = 
	`bŒfs_fšish_chunk_®loc
(
Œªs
, 
fs_šfo
, 
key
.
objeùid
,

10252 
key
.
off£t
);

10253 ià(
»t
)

10254 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10255 
	`add_block_group_ä“_¥aû
(
Œªs
, 
fs_šfo
, 
block_group
);

10257 
Ãxt
:

10258 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

10260 
Œªs
->
ÿn_æush_³ndšg_bgs
 = can_flush_pending_bgs;

10261 
	}
}

10263 
	$bŒfs_make_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

10264 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹s_u£d
,

10265 
u64
 
ty³
, u64 
chunk_off£t
, u64 
size
)

10267 
bŒfs_block_group_ÿche
 *
ÿche
;

10268 
»t
;

10270 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

10272 
ÿche
 = 
	`bŒfs_ü—‹_block_group_ÿche
(
fs_šfo
, 
chunk_off£t
, 
size
);

10273 ià(!
ÿche
)

10274  -
ENOMEM
;

10276 
	`bŒfs_£t_block_group_u£d
(&
ÿche
->
™em
, 
by‹s_u£d
);

10277 
	`bŒfs_£t_block_group_chunk_objeùid
(&
ÿche
->
™em
,

10278 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
);

10279 
	`bŒfs_£t_block_group_æags
(&
ÿche
->
™em
, 
ty³
);

10281 
ÿche
->
æags
 = 
ty³
;

10282 
ÿche
->
Ï¡_by‹_to_uÅš
 = (
u64
)-1;

10283 
ÿche
->
ÿched
 = 
BTRFS_CACHE_FINISHED
;

10284 
ÿche
->
Ãeds_ä“_¥aû
 = 1;

10285 
»t
 = 
	`exþude_su³r_¡res
(
fs_šfo
, 
ÿche
);

10286 ià(
»t
) {

10291 
	`ä“_exþuded_ex‹Ás
(
fs_šfo
, 
ÿche
);

10292 
	`bŒfs_put_block_group
(
ÿche
);

10293  
»t
;

10296 
	`add_Ãw_ä“_¥aû
(
ÿche
, 
fs_šfo
, 
chunk_off£t
, chunk_off£ˆ+ 
size
);

10298 
	`ä“_exþuded_ex‹Ás
(
fs_šfo
, 
ÿche
);

10300 #ifdeà
CONFIG_BTRFS_DEBUG


10301 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
ÿche
)) {

10302 
u64
 
Ãw_by‹s_u£d
 = 
size
 - 
by‹s_u£d
;

10304 
by‹s_u£d
 +ð
Ãw_by‹s_u£d
 >> 1;

10305 
	`äagm’t_ä“_¥aû
(
ÿche
);

10313 
ÿche
->
¥aû_šfo
 = 
	`__fšd_¥aû_šfo
(
fs_šfo
, cache->
æags
);

10314 ià(!
ÿche
->
¥aû_šfo
) {

10315 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
ÿche
->
æags
,

10316 &
ÿche
->
¥aû_šfo
);

10317 ià(
»t
) {

10318 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

10319 
	`bŒfs_put_block_group
(
ÿche
);

10320  
»t
;

10324 
»t
 = 
	`bŒfs_add_block_group_ÿche
(
fs_šfo
, 
ÿche
);

10325 ià(
»t
) {

10326 
	`bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
);

10327 
	`bŒfs_put_block_group
(
ÿche
);

10328  
»t
;

10335 
	`Œaû_bŒfs_add_block_group
(
fs_šfo
, 
ÿche
, 1);

10336 
	`upd©e_¥aû_šfo
(
fs_šfo
, 
ÿche
->
æags
, 
size
, 
by‹s_u£d
,

10337 
ÿche
->
by‹s_su³r
, &ÿche->
¥aû_šfo
);

10338 
	`upd©e_glob®_block_rsv
(
fs_šfo
);

10340 
	`__lšk_block_group
(
ÿche
->
¥aû_šfo
, cache);

10342 
	`li¡_add_ž
(&
ÿche
->
bg_li¡
, &
Œªs
->
Ãw_bgs
);

10344 
	`£t_avaž_®loc_b™s
(
fs_šfo
, 
ty³
);

10346 
	}
}

10348 
	$þ—r_avaž_®loc_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æags
)

10350 
u64
 
exŒa_æags
 = 
	`chunk_to_ex‹nded
(
æags
) &

10351 
BTRFS_EXTENDED_PROFILE_MASK
;

10353 
	`wr™e_£qlock
(&
fs_šfo
->
´ofžes_lock
);

10354 ià(
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

10355 
fs_šfo
->
avaž_d©a_®loc_b™s
 &ð~
exŒa_æags
;

10356 ià(
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
)

10357 
fs_šfo
->
avaž_m‘ad©a_®loc_b™s
 &ð~
exŒa_æags
;

10358 ià(
æags
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

10359 
fs_šfo
->
avaž_sy¡em_®loc_b™s
 &ð~
exŒa_æags
;

10360 
	`wr™e_£quÆock
(&
fs_šfo
->
´ofžes_lock
);

10361 
	}
}

10363 
	$bŒfs_»move_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

10364 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
group_¡¬t
,

10365 
ex‹Á_m­
 *
em
)

10367 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

10368 
bŒfs_·th
 *
·th
;

10369 
bŒfs_block_group_ÿche
 *
block_group
;

10370 
bŒfs_ä“_þu¡”
 *
þu¡”
;

10371 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

10372 
bŒfs_key
 
key
;

10373 
šode
 *inode;

10374 
kobjeù
 *
kobj
 = 
NULL
;

10375 
»t
;

10376 
šdex
;

10377 
çùÜ
;

10378 
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
 = 
NULL
;

10379 
boÞ
 
»move_em
;

10381 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
group_¡¬t
);

10382 
	`BUG_ON
(!
block_group
);

10383 
	`BUG_ON
(!
block_group
->
ro
);

10389 
	`ä“_exþuded_ex‹Ás
(
fs_šfo
, 
block_group
);

10391 
	`memýy
(&
key
, &
block_group
->key, (key));

10392 
šdex
 = 
	`g‘_block_group_šdex
(
block_group
);

10393 ià(
block_group
->
æags
 & (
BTRFS_BLOCK_GROUP_DUP
 |

10394 
BTRFS_BLOCK_GROUP_RAID1
 |

10395 
BTRFS_BLOCK_GROUP_RAID10
))

10396 
çùÜ
 = 2;

10398 
çùÜ
 = 1;

10401 
þu¡”
 = &
fs_šfo
->
d©a_®loc_þu¡”
;

10402 
	`¥š_lock
(&
þu¡”
->
»fžl_lock
);

10403 
	`bŒfs_»tuº_þu¡”_to_ä“_¥aû
(
block_group
, 
þu¡”
);

10404 
	`¥š_uÆock
(&
þu¡”
->
»fžl_lock
);

10410 
þu¡”
 = &
fs_šfo
->
m‘a_®loc_þu¡”
;

10411 
	`¥š_lock
(&
þu¡”
->
»fžl_lock
);

10412 
	`bŒfs_»tuº_þu¡”_to_ä“_¥aû
(
block_group
, 
þu¡”
);

10413 
	`¥š_uÆock
(&
þu¡”
->
»fžl_lock
);

10415 
·th
 = 
	`bŒfs_®loc_·th
();

10416 ià(!
·th
) {

10417 
»t
 = -
ENOMEM
;

10418 
out
;

10425 
šode
 = 
	`lookup_ä“_¥aû_šode
(
fs_šfo
, 
block_group
, 
·th
);

10427 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

10432 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

10433 ià(!
	`li¡_em±y
(&
block_group
->
io_li¡
)) {

10434 
	`li¡_d–_š™
(&
block_group
->
io_li¡
);

10436 
	`WARN_ON
(!
	`IS_ERR
(
šode
è&& inod!ð
block_group
->
io_ùl
.inode);

10438 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

10439 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
block_group
, 
·th
);

10440 
	`bŒfs_put_block_group
(
block_group
);

10441 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

10444 ià(!
	`li¡_em±y
(&
block_group
->
dœty_li¡
)) {

10445 
	`li¡_d–_š™
(&
block_group
->
dœty_li¡
);

10446 
	`bŒfs_put_block_group
(
block_group
);

10448 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

10449 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

10451 ià(!
	`IS_ERR
(
šode
)) {

10452 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

10453 ià(
»t
) {

10454 
	`bŒfs_add_d–ayed_ut
(
šode
);

10455 
out
;

10457 
	`þ—r_Æšk
(
šode
);

10459 
	`¥š_lock
(&
block_group
->
lock
);

10460 ià(
block_group
->
œef
) {

10461 
block_group
->
œef
 = 0;

10462 
block_group
->
šode
 = 
NULL
;

10463 
	`¥š_uÆock
(&
block_group
->
lock
);

10464 
	`ut
(
šode
);

10466 
	`¥š_uÆock
(&
block_group
->
lock
);

10469 
	`bŒfs_add_d–ayed_ut
(
šode
);

10472 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

10473 
key
.
off£t
 = 
block_group
->key.
objeùid
;

10474 
key
.
ty³
 = 0;

10476 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
Œ“_roÙ
, &
key
, 
·th
, -1, 1);

10477 ià(
»t
 < 0)

10478 
out
;

10479 ià(
»t
 > 0)

10480 
	`bŒfs_»Ëa£_·th
(
·th
);

10481 ià(
»t
 == 0) {

10482 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
Œ“_roÙ
, 
·th
);

10483 ià(
»t
)

10484 
out
;

10485 
	`bŒfs_»Ëa£_·th
(
·th
);

10488 
	`¥š_lock
(&
fs_šfo
->
block_group_ÿche_lock
);

10489 
	`rb_”a£
(&
block_group
->
ÿche_node
,

10490 &
fs_šfo
->
block_group_ÿche_Œ“
);

10491 
	`RB_CLEAR_NODE
(&
block_group
->
ÿche_node
);

10493 ià(
fs_šfo
->
fœ¡_logiÿl_by‹
 =ð
block_group
->
key
.
objeùid
)

10494 
fs_šfo
->
fœ¡_logiÿl_by‹
 = (
u64
)-1;

10495 
	`¥š_uÆock
(&
fs_šfo
->
block_group_ÿche_lock
);

10497 
	`down_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

10502 
	`li¡_d–_š™
(&
block_group
->
li¡
);

10503 ià(
	`li¡_em±y
(&
block_group
->
¥aû_šfo
->
block_groups
[
šdex
])) {

10504 
kobj
 = 
block_group
->
¥aû_šfo
->
block_group_kobjs
[
šdex
];

10505 
block_group
->
¥aû_šfo
->
block_group_kobjs
[
šdex
] = 
NULL
;

10506 
	`þ—r_avaž_®loc_b™s
(
fs_šfo
, 
block_group
->
æags
);

10508 
	`up_wr™e
(&
block_group
->
¥aû_šfo
->
groups_£m
);

10509 ià(
kobj
) {

10510 
	`kobjeù_d–
(
kobj
);

10511 
	`kobjeù_put
(
kobj
);

10514 ià(
block_group
->
has_ÿchšg_ùl
)

10515 
ÿchšg_ùl
 = 
	`g‘_ÿchšg_cÚŒÞ
(
block_group
);

10516 ià(
block_group
->
ÿched
 =ð
BTRFS_CACHE_STARTED
)

10517 
	`wa™_block_group_ÿche_dÚe
(
block_group
);

10518 ià(
block_group
->
has_ÿchšg_ùl
) {

10519 
	`down_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

10520 ià(!
ÿchšg_ùl
) {

10521 
bŒfs_ÿchšg_cÚŒÞ
 *
ùl
;

10523 
	`li¡_fÜ_—ch_’Œy
(
ùl
,

10524 &
fs_šfo
->
ÿchšg_block_groups
, 
li¡
)

10525 ià(
ùl
->
block_group
 == block_group) {

10526 
ÿchšg_ùl
 = 
ùl
;

10527 
	`»fcouÁ_šc
(&
ÿchšg_ùl
->
couÁ
);

10531 ià(
ÿchšg_ùl
)

10532 
	`li¡_d–_š™
(&
ÿchšg_ùl
->
li¡
);

10533 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

10534 ià(
ÿchšg_ùl
) {

10536 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

10537 
	`put_ÿchšg_cÚŒÞ
(
ÿchšg_ùl
);

10541 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

10542 ià(!
	`li¡_em±y
(&
block_group
->
dœty_li¡
)) {

10543 
	`WARN_ON
(1);

10545 ià(!
	`li¡_em±y
(&
block_group
->
io_li¡
)) {

10546 
	`WARN_ON
(1);

10548 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

10549 
	`bŒfs_»move_ä“_¥aû_ÿche
(
block_group
);

10551 
	`¥š_lock
(&
block_group
->
¥aû_šfo
->
lock
);

10552 
	`li¡_d–_š™
(&
block_group
->
ro_li¡
);

10554 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
ENOSPC_DEBUG
)) {

10555 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
tÙ®_by‹s


10556 < 
block_group
->
key
.
off£t
);

10557 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
by‹s_»adÚly


10558 < 
block_group
->
key
.
off£t
);

10559 
	`WARN_ON
(
block_group
->
¥aû_šfo
->
disk_tÙ®


10560 < 
block_group
->
key
.
off£t
 * 
çùÜ
);

10562 
block_group
->
¥aû_šfo
->
tÙ®_by‹s
 -ðblock_group->
key
.
off£t
;

10563 
block_group
->
¥aû_šfo
->
by‹s_»adÚly
 -ðblock_group->
key
.
off£t
;

10564 
block_group
->
¥aû_šfo
->
disk_tÙ®
 -ðblock_group->
key
.
off£t
 * 
çùÜ
;

10566 
	`¥š_uÆock
(&
block_group
->
¥aû_šfo
->
lock
);

10568 
	`memýy
(&
key
, &
block_group
->key, (key));

10570 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

10571 ià(!
	`li¡_em±y
(&
em
->
li¡
)) {

10573 
	`ä“_ex‹Á_m­
(
em
);

10575 
	`¥š_lock
(&
block_group
->
lock
);

10576 
block_group
->
»moved
 = 1;

10600 
»move_em
 = (
	`©omic_»ad
(&
block_group
->
Œimmšg
) == 0);

10606 ià(!
»move_em
) {

10618 
	`li¡_move_ž
(&
em
->
li¡
, &
fs_šfo
->
pšÃd_chunks
);

10620 
	`¥š_uÆock
(&
block_group
->
lock
);

10622 ià(
»move_em
) {

10623 
ex‹Á_m­_Œ“
 *
em_Œ“
;

10625 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

10626 
	`wr™e_lock
(&
em_Œ“
->
lock
);

10632 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

10633 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

10635 
	`ä“_ex‹Á_m­
(
em
);

10638 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

10640 
»t
 = 
	`»move_block_group_ä“_¥aû
(
Œªs
, 
fs_šfo
, 
block_group
);

10641 ià(
»t
)

10642 
out
;

10644 
	`bŒfs_put_block_group
(
block_group
);

10645 
	`bŒfs_put_block_group
(
block_group
);

10647 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

10648 ià(
»t
 > 0)

10649 
»t
 = -
EIO
;

10650 ià(
»t
 < 0)

10651 
out
;

10653 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

10654 
out
:

10655 
	`bŒfs_ä“_·th
(
·th
);

10656  
»t
;

10657 
	}
}

10659 
bŒfs_Œªs_hªdË
 *

10660 
	$bŒfs_¡¬t_Œªs_»move_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
,

10661 cÚ¡ 
u64
 
chunk_off£t
)

10663 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

10664 
ex‹Á_m­
 *
em
;

10665 
m­_lookup
 *
m­
;

10666 
num_™ems
;

10668 
	`»ad_lock
(&
em_Œ“
->
lock
);

10669 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
chunk_off£t
, 1);

10670 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

10671 
	`ASSERT
(
em
 &&ƒm->
¡¬t
 =ð
chunk_off£t
);

10692 
m­
 = 
em
->
m­_lookup
;

10693 
num_™ems
 = 3 + 
m­
->
num_¡res
;

10694 
	`ä“_ex‹Á_m­
(
em
);

10696  
	`bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(
fs_šfo
->
ex‹Á_roÙ
,

10697 
num_™ems
, 1);

10698 
	}
}

10704 
	$bŒfs_d–‘e_unu£d_bgs
(
bŒfs_fs_šfo
 *
fs_šfo
)

10706 
bŒfs_block_group_ÿche
 *
block_group
;

10707 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

10708 
bŒfs_Œªs_hªdË
 *
Œªs
;

10709 
»t
 = 0;

10711 ià(!
	`‹¡_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
))

10714 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

10715 !
	`li¡_em±y
(&
fs_šfo
->
unu£d_bgs
)) {

10716 
u64
 
¡¬t
, 
’d
;

10717 
Œimmšg
;

10719 
block_group
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
unu£d_bgs
,

10720 
bŒfs_block_group_ÿche
,

10721 
bg_li¡
);

10722 
	`li¡_d–_š™
(&
block_group
->
bg_li¡
);

10724 
¥aû_šfo
 = 
block_group
->space_info;

10726 ià(
»t
 || 
	`bŒfs_mixed_¥aû_šfo
(
¥aû_šfo
)) {

10727 
	`bŒfs_put_block_group
(
block_group
);

10730 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

10732 
	`mu‹x_lock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

10735 
	`down_wr™e
(&
¥aû_šfo
->
groups_£m
);

10736 
	`¥š_lock
(&
block_group
->
lock
);

10737 ià(
block_group
->
»£rved
 ||

10738 
	`bŒfs_block_group_u£d
(&
block_group
->
™em
) ||

10739 
block_group
->
ro
 ||

10740 
	`li¡_is_sšguÏr
(&
block_group
->
li¡
)) {

10747 
	`¥š_uÆock
(&
block_group
->
lock
);

10748 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

10749 
Ãxt
;

10751 
	`¥š_uÆock
(&
block_group
->
lock
);

10754 
»t
 = 
	`šc_block_group_ro
(
block_group
, 0);

10755 
	`up_wr™e
(&
¥aû_šfo
->
groups_£m
);

10756 ià(
»t
 < 0) {

10757 
»t
 = 0;

10758 
Ãxt
;

10765 
Œªs
 = 
	`bŒfs_¡¬t_Œªs_»move_block_group
(
fs_šfo
,

10766 
block_group
->
key
.
objeùid
);

10767 ià(
	`IS_ERR
(
Œªs
)) {

10768 
	`bŒfs_dec_block_group_ro
(
block_group
);

10769 
»t
 = 
	`PTR_ERR
(
Œªs
);

10770 
Ãxt
;

10777 
¡¬t
 = 
block_group
->
key
.
objeùid
;

10778 
’d
 = 
¡¬t
 + 
block_group
->
key
.
off£t
 - 1;

10790 
	`mu‹x_lock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

10791 
»t
 = 
	`þ—r_ex‹Á_b™s
(&
fs_šfo
->
ä“d_ex‹Ás
[0], 
¡¬t
, 
’d
,

10792 
EXTENT_DIRTY
);

10793 ià(
»t
) {

10794 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

10795 
	`bŒfs_dec_block_group_ro
(
block_group
);

10796 
’d_Œªs
;

10798 
»t
 = 
	`þ—r_ex‹Á_b™s
(&
fs_šfo
->
ä“d_ex‹Ás
[1], 
¡¬t
, 
’d
,

10799 
EXTENT_DIRTY
);

10800 ià(
»t
) {

10801 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

10802 
	`bŒfs_dec_block_group_ro
(
block_group
);

10803 
’d_Œªs
;

10805 
	`mu‹x_uÆock
(&
fs_šfo
->
unu£d_bg_uÅš_mu‹x
);

10808 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

10809 
	`¥š_lock
(&
block_group
->
lock
);

10811 
¥aû_šfo
->
by‹s_pšÃd
 -ð
block_group
->
pšÃd
;

10812 
¥aû_šfo
->
by‹s_»adÚly
 +ð
block_group
->
pšÃd
;

10813 
	`³rýu_couÁ”_add
(&
¥aû_šfo
->
tÙ®_by‹s_pšÃd
,

10814 -
block_group
->
pšÃd
);

10815 
block_group
->
pšÃd
 = 0;

10817 
	`¥š_uÆock
(&
block_group
->
lock
);

10818 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

10821 
Œimmšg
 = 
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DISCARD
);

10824 ià(
Œimmšg
)

10825 
	`bŒfs_g‘_block_group_Œimmšg
(
block_group
);

10831 
»t
 = 
	`bŒfs_»move_chunk
(
Œªs
, 
fs_šfo
,

10832 
block_group
->
key
.
objeùid
);

10834 ià(
»t
) {

10835 ià(
Œimmšg
)

10836 
	`bŒfs_put_block_group_Œimmšg
(
block_group
);

10837 
’d_Œªs
;

10845 ià(
Œimmšg
) {

10846 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

10852 
	`li¡_move
(&
block_group
->
bg_li¡
,

10853 &
Œªs
->
Œª§ùiÚ
->
d–‘ed_bgs
);

10854 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

10855 
	`bŒfs_g‘_block_group
(
block_group
);

10857 
’d_Œªs
:

10858 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10859 
Ãxt
:

10860 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

10861 
	`bŒfs_put_block_group
(
block_group
);

10862 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

10864 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

10865 
	}
}

10867 
	$bŒfs_š™_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

10869 
bŒfs_¥aû_šfo
 *
¥aû_šfo
;

10870 
bŒfs_su³r_block
 *
disk_su³r
;

10871 
u64
 
ã©u»s
;

10872 
u64
 
æags
;

10873 
mixed
 = 0;

10874 
»t
;

10876 
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

10877 ià(!
	`bŒfs_su³r_roÙ
(
disk_su³r
))

10878  -
EINVAL
;

10880 
ã©u»s
 = 
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

10881 ià(
ã©u»s
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

10882 
mixed
 = 1;

10884 
æags
 = 
BTRFS_BLOCK_GROUP_SYSTEM
;

10885 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
, &
¥aû_šfo
);

10886 ià(
»t
)

10887 
out
;

10889 ià(
mixed
) {

10890 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
 | 
BTRFS_BLOCK_GROUP_DATA
;

10891 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
, &
¥aû_šfo
);

10893 
æags
 = 
BTRFS_BLOCK_GROUP_METADATA
;

10894 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
, &
¥aû_šfo
);

10895 ià(
»t
)

10896 
out
;

10898 
æags
 = 
BTRFS_BLOCK_GROUP_DATA
;

10899 
»t
 = 
	`ü—‹_¥aû_šfo
(
fs_šfo
, 
æags
, &
¥aû_šfo
);

10901 
out
:

10902  
»t
;

10903 
	}
}

10905 
	$bŒfs_”rÜ_uÅš_ex‹Á_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

10906 
u64
 
¡¬t
, u64 
’d
)

10908  
	`uÅš_ex‹Á_¿nge
(
fs_šfo
, 
¡¬t
, 
’d
, 
çl£
);

10909 
	}
}

10929 
	$bŒfs_Œim_ä“_ex‹Ás
(
bŒfs_deviû
 *
deviû
,

10930 
u64
 
mšËn
, u64 *
Œimmed
)

10932 
u64
 
¡¬t
 = 0, 
Ën
 = 0;

10933 
»t
;

10935 *
Œimmed
 = 0;

10938 ià(!
deviû
->
wr™—bË
)

10942 ià(
deviû
->
tÙ®_by‹s
 <ðdeviû->
by‹s_u£d
)

10945 
»t
 = 0;

10948 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

10949 
bŒfs_Œª§ùiÚ
 *
Œªs
;

10950 
u64
 
by‹s
;

10952 
»t
 = 
	`mu‹x_lock_š‹¼u±ibË
(&
fs_šfo
->
chunk_mu‹x
);

10953 ià(
»t
)

10954  
»t
;

10956 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

10958 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

10959 
Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

10960 ià(
Œªs
)

10961 
	`»fcouÁ_šc
(&
Œªs
->
u£_couÁ
);

10962 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

10964 
»t
 = 
	`fšd_ä“_dev_ex‹Á_¡¬t
(
Œªs
, 
deviû
, 
mšËn
, 
¡¬t
,

10965 &
¡¬t
, &
Ën
);

10966 ià(
Œªs
)

10967 
	`bŒfs_put_Œª§ùiÚ
(
Œªs
);

10969 ià(
»t
) {

10970 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

10971 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

10972 ià(
»t
 =ð-
ENOSPC
)

10973 
»t
 = 0;

10977 
»t
 = 
	`bŒfs_issue_disÿrd
(
deviû
->
bdev
, 
¡¬t
, 
Ën
, &
by‹s
);

10978 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

10979 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

10981 ià(
»t
)

10984 
¡¬t
 +ð
Ën
;

10985 *
Œimmed
 +ð
by‹s
;

10987 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

10988 
»t
 = -
ERESTARTSYS
;

10992 
	`cÚd_»sched
();

10995  
»t
;

10996 
	}
}

10998 
	$bŒfs_Œim_fs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
f¡rim_¿nge
 *
¿nge
)

11000 
bŒfs_block_group_ÿche
 *
ÿche
 = 
NULL
;

11001 
bŒfs_deviû
 *
deviû
;

11002 
li¡_h—d
 *
deviûs
;

11003 
u64
 
group_Œimmed
;

11004 
u64
 
¡¬t
;

11005 
u64
 
’d
;

11006 
u64
 
Œimmed
 = 0;

11007 
u64
 
tÙ®_by‹s
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
);

11008 
»t
 = 0;

11013 ià(
¿nge
->
Ën
 =ð
tÙ®_by‹s
)

11014 
ÿche
 = 
	`bŒfs_lookup_fœ¡_block_group
(
fs_šfo
, 
¿nge
->
¡¬t
);

11016 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¿nge
->
¡¬t
);

11018 
ÿche
) {

11019 ià(
ÿche
->
key
.
objeùid
 >ð(
¿nge
->
¡¬t
 +„ªge->
Ën
)) {

11020 
	`bŒfs_put_block_group
(
ÿche
);

11024 
¡¬t
 = 
	`max
(
¿nge
->¡¬t, 
ÿche
->
key
.
objeùid
);

11025 
’d
 = 
	`mš
(
¿nge
->
¡¬t
 +„ªge->
Ën
,

11026 
ÿche
->
key
.
objeùid
 + cache->key.
off£t
);

11028 ià(
’d
 - 
¡¬t
 >ð
¿nge
->
mšËn
) {

11029 ià(!
	`block_group_ÿche_dÚe
(
ÿche
)) {

11030 
»t
 = 
	`ÿche_block_group
(
ÿche
, 0);

11031 ià(
»t
) {

11032 
	`bŒfs_put_block_group
(
ÿche
);

11035 
»t
 = 
	`wa™_block_group_ÿche_dÚe
(
ÿche
);

11036 ià(
»t
) {

11037 
	`bŒfs_put_block_group
(
ÿche
);

11041 
»t
 = 
	`bŒfs_Œim_block_group
(
ÿche
,

11042 &
group_Œimmed
,

11043 
¡¬t
,

11044 
’d
,

11045 
¿nge
->
mšËn
);

11047 
Œimmed
 +ð
group_Œimmed
;

11048 ià(
»t
) {

11049 
	`bŒfs_put_block_group
(
ÿche
);

11054 
ÿche
 = 
	`Ãxt_block_group
(
fs_šfo
, cache);

11057 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

11058 
deviûs
 = &
fs_šfo
->
fs_deviûs
->
®loc_li¡
;

11059 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
deviûs
, 
dev_®loc_li¡
) {

11060 
»t
 = 
	`bŒfs_Œim_ä“_ex‹Ás
(
deviû
, 
¿nge
->
mšËn
,

11061 &
group_Œimmed
);

11062 ià(
»t
)

11065 
Œimmed
 +ð
group_Œimmed
;

11067 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

11069 
¿nge
->
Ën
 = 
Œimmed
;

11070  
»t
;

11071 
	}
}

11081 
	$bŒfs_’d_wr™e_no_¢­shÙtšg
(
bŒfs_roÙ
 *
roÙ
)

11083 
	`³rýu_couÁ”_dec
(&
roÙ
->
subv_wr™”s
->
couÁ”
);

11087 
	`smp_mb
();

11088 ià(
	`wa™queue_aùive
(&
roÙ
->
subv_wr™”s
->
wa™
))

11089 
	`wake_up
(&
roÙ
->
subv_wr™”s
->
wa™
);

11090 
	}
}

11092 
	$bŒfs_¡¬t_wr™e_no_¢­shÙtšg
(
bŒfs_roÙ
 *
roÙ
)

11094 ià(
	`©omic_»ad
(&
roÙ
->
wžl_be_¢­shÙ‹d
))

11097 
	`³rýu_couÁ”_šc
(&
roÙ
->
subv_wr™”s
->
couÁ”
);

11101 
	`smp_mb
();

11102 ià(
	`©omic_»ad
(&
roÙ
->
wžl_be_¢­shÙ‹d
)) {

11103 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

11107 
	}
}

11109 
	$wa™_¢­shÙtšg_©omic_t
(
©omic_t
 *
a
)

11111 
	`scheduË
();

11113 
	}
}

11115 
	$bŒfs_wa™_fÜ_¢­shÙ_ü—tiÚ
(
bŒfs_roÙ
 *
roÙ
)

11117 
Œue
) {

11118 
»t
;

11120 
»t
 = 
	`bŒfs_¡¬t_wr™e_no_¢­shÙtšg
(
roÙ
);

11121 ià(
»t
)

11123 
	`wa™_Ú_©omic_t
(&
roÙ
->
wžl_be_¢­shÙ‹d
,

11124 
wa™_¢­shÙtšg_©omic_t
,

11125 
TASK_UNINTERRUPTIBLE
);

11127 
	}
}

	@extent_io.c

2 
	~<lšux/b™Ýs.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/bio.h
>

5 
	~<lšux/mm.h
>

6 
	~<lšux/·gem­.h
>

7 
	~<lšux/·ge-æags.h
>

8 
	~<lšux/¥šlock.h
>

9 
	~<lšux/blkdev.h
>

10 
	~<lšux/sw­.h
>

11 
	~<lšux/wr™eback.h
>

12 
	~<lšux/·gevec.h
>

13 
	~<lšux/´eãtch.h
>

14 
	~<lšux/þ—nÿche.h
>

15 
	~"ex‹Á_io.h
"

16 
	~"ex‹Á_m­.h
"

17 
	~"ù»e.h
"

18 
	~"bŒfs_šode.h
"

19 
	~"vÞumes.h
"

20 
	~"check-š‹gr™y.h
"

21 
	~"lockšg.h
"

22 
	~"rcu-¡ršg.h
"

23 
	~"back»f.h
"

25 
kmem_ÿche
 *
	gex‹Á_¡©e_ÿche
;

26 
kmem_ÿche
 *
	gex‹Á_bufãr_ÿche
;

27 
bio_£t
 *
	gbŒfs_bio£t
;

29 
šlše
 
boÞ
 
	$ex‹Á_¡©e_š_Œ“
(cÚ¡ 
ex‹Á_¡©e
 *
¡©e
)

31  !
	`RB_EMPTY_NODE
(&
¡©e
->
rb_node
);

32 
	}
}

34 #ifdeà
CONFIG_BTRFS_DEBUG


35 
LIST_HEAD
(
bufãrs
);

36 
LIST_HEAD
(
¡©es
);

38 
DEFINE_SPINLOCK
(
Ëak_lock
);

40 
šlše


41 
	$bŒfs_Ëak_debug_add
(
li¡_h—d
 *
Ãw
, li¡_h—d *
h—d
)

43 
æags
;

45 
	`¥š_lock_œq§ve
(&
Ëak_lock
, 
æags
);

46 
	`li¡_add
(
Ãw
, 
h—d
);

47 
	`¥š_uÆock_œq»¡Üe
(&
Ëak_lock
, 
æags
);

48 
	}
}

50 
šlše


51 
	$bŒfs_Ëak_debug_d–
(
li¡_h—d
 *
’Œy
)

53 
æags
;

55 
	`¥š_lock_œq§ve
(&
Ëak_lock
, 
æags
);

56 
	`li¡_d–
(
’Œy
);

57 
	`¥š_uÆock_œq»¡Üe
(&
Ëak_lock
, 
æags
);

58 
	}
}

60 
šlše


61 
	$bŒfs_Ëak_debug_check
()

63 
ex‹Á_¡©e
 *
¡©e
;

64 
ex‹Á_bufãr
 *
eb
;

66 !
	`li¡_em±y
(&
¡©es
)) {

67 
¡©e
 = 
	`li¡_’Œy
(
¡©es
.
Ãxt
, 
ex‹Á_¡©e
, 
Ëak_li¡
);

68 
	`´_”r
("BTRFS: state†eak: start %lluƒnd %llu state %u inree %d„efs %d\n",

69 
¡©e
->
¡¬t
, s‹->
’d
, state->state,

70 
	`ex‹Á_¡©e_š_Œ“
(
¡©e
),

71 
	`»fcouÁ_»ad
(&
¡©e
->
»fs
));

72 
	`li¡_d–
(&
¡©e
->
Ëak_li¡
);

73 
	`kmem_ÿche_ä“
(
ex‹Á_¡©e_ÿche
, 
¡©e
);

76 !
	`li¡_em±y
(&
bufãrs
)) {

77 
eb
 = 
	`li¡_’Œy
(
bufãrs
.
Ãxt
, 
ex‹Á_bufãr
, 
Ëak_li¡
);

78 
	`´_”r
("BTRFS: buffer†eak start %llu†en %lu„efs %d\n",

79 
eb
->
¡¬t
,ƒb->
Ën
, 
	`©omic_»ad
(&eb->
»fs
));

80 
	`li¡_d–
(&
eb
->
Ëak_li¡
);

81 
	`kmem_ÿche_ä“
(
ex‹Á_bufãr_ÿche
, 
eb
);

83 
	}
}

85 
	#bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
) \

86 
	`__bŒfs_debug_check_ex‹Á_io_¿nge
(
__func__
, (
Œ“
), (
¡¬t
), (
’d
))

	)

87 
šlše
 
	$__bŒfs_debug_check_ex‹Á_io_¿nge
(cÚ¡ *
ÿÎ”
,

88 
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
)

90 ià(
Œ“
->
Ýs
 &&»e->Ýs->
check_ex‹Á_io_¿nge
)

91 
Œ“
->
Ýs
->
	`check_ex‹Á_io_¿nge
Ñ»e->
´iv©e_d©a
, 
ÿÎ”
,

92 
¡¬t
, 
’d
);

93 
	}
}

95 
	#bŒfs_Ëak_debug_add
(
Ãw
, 
h—d
èdØ{} 0)

	)

96 
	#bŒfs_Ëak_debug_d–
(
’Œy
èdØ{} 0)

	)

97 
	#bŒfs_Ëak_debug_check
(èdØ{} 0)

	)

98 
	#bŒfs_debug_check_ex‹Á_io_¿nge
(
c
, 
s
, 
e
èdØ{} 0)

	)

101 
	#BUFFER_LRU_MAX
 64

	)

103 
	sŒ“_’Œy
 {

104 
u64
 
	m¡¬t
;

105 
u64
 
	m’d
;

106 
rb_node
 
	mrb_node
;

109 
	sex‹Á_·ge_d©a
 {

110 
bio
 *
	mbio
;

111 
ex‹Á_io_Œ“
 *
	mŒ“
;

112 
g‘_ex‹Á_t
 *
	mg‘_ex‹Á
;

113 
	mbio_æags
;

118 
	mex‹Á_locked
:1;

121 
	msync_io
:1;

124 
	$add_ex‹Á_chªge£t
(
ex‹Á_¡©e
 *
¡©e
, 
b™s
,

125 
ex‹Á_chªge£t
 *
chªge£t
,

126 
£t
)

128 
»t
;

130 ià(!
chªge£t
)

132 ià(
£t
 && (
¡©e
->¡©& 
b™s
) == bits)

134 ià(!
£t
 && (
¡©e
->¡©& 
b™s
) == 0)

136 
chªge£t
->
by‹s_chªged
 +ð
¡©e
->
’d
 - s‹->
¡¬t
 + 1;

137 
»t
 = 
	`uli¡_add
(&
chªge£t
->
¿nge_chªged
, 
¡©e
->
¡¬t
, s‹->
’d
,

138 
GFP_ATOMIC
);

140 
	`BUG_ON
(
»t
 < 0);

141 
	}
}

143 
nošlše
 
æush_wr™e_bio
(*
d©a
);

144 
šlše
 
bŒfs_fs_šfo
 *

145 
	$Œ“_fs_šfo
(
ex‹Á_io_Œ“
 *
Œ“
)

147 ià(
Œ“
->
Ýs
)

148  
Œ“
->
Ýs
->
	`Œ“_fs_šfo
Ñ»e->
´iv©e_d©a
);

149  
NULL
;

150 
	}
}

152 
__š™
 
	$ex‹Á_io_š™
()

154 
ex‹Á_¡©e_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_extent_state",

155 (
ex‹Á_¡©e
), 0,

156 
SLAB_MEM_SPREAD
, 
NULL
);

157 ià(!
ex‹Á_¡©e_ÿche
)

158  -
ENOMEM
;

160 
ex‹Á_bufãr_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_extent_buffer",

161 (
ex‹Á_bufãr
), 0,

162 
SLAB_MEM_SPREAD
, 
NULL
);

163 ià(!
ex‹Á_bufãr_ÿche
)

164 
ä“_¡©e_ÿche
;

166 
bŒfs_bio£t
 = 
	`bio£t_ü—‹
(
BIO_POOL_SIZE
,

167 
	`off£tof
(
bŒfs_io_bio
, 
bio
),

168 
BIOSET_NEED_BVECS
);

169 ià(!
bŒfs_bio£t
)

170 
ä“_bufãr_ÿche
;

172 ià(
	`bio£t_š‹gr™y_ü—‹
(
bŒfs_bio£t
, 
BIO_POOL_SIZE
))

173 
ä“_bio£t
;

177 
ä“_bio£t
:

178 
	`bio£t_ä“
(
bŒfs_bio£t
);

179 
bŒfs_bio£t
 = 
NULL
;

181 
ä“_bufãr_ÿche
:

182 
	`kmem_ÿche_de¡roy
(
ex‹Á_bufãr_ÿche
);

183 
ex‹Á_bufãr_ÿche
 = 
NULL
;

185 
ä“_¡©e_ÿche
:

186 
	`kmem_ÿche_de¡roy
(
ex‹Á_¡©e_ÿche
);

187 
ex‹Á_¡©e_ÿche
 = 
NULL
;

188  -
ENOMEM
;

189 
	}
}

191 
	$ex‹Á_io_ex™
()

193 
	`bŒfs_Ëak_debug_check
();

199 
	`rcu_b¬r›r
();

200 
	`kmem_ÿche_de¡roy
(
ex‹Á_¡©e_ÿche
);

201 
	`kmem_ÿche_de¡roy
(
ex‹Á_bufãr_ÿche
);

202 ià(
bŒfs_bio£t
)

203 
	`bio£t_ä“
(
bŒfs_bio£t
);

204 
	}
}

206 
	$ex‹Á_io_Œ“_š™
(
ex‹Á_io_Œ“
 *
Œ“
,

207 *
´iv©e_d©a
)

209 
Œ“
->
¡©e
 = 
RB_ROOT
;

210 
Œ“
->
Ýs
 = 
NULL
;

211 
Œ“
->
dœty_by‹s
 = 0;

212 
	`¥š_lock_š™
(&
Œ“
->
lock
);

213 
Œ“
->
´iv©e_d©a
 =…rivate_data;

214 
	}
}

216 
ex‹Á_¡©e
 *
	$®loc_ex‹Á_¡©e
(
gå_t
 
mask
)

218 
ex‹Á_¡©e
 *
¡©e
;

224 
mask
 &ð~(
__GFP_DMA32
|
__GFP_HIGHMEM
);

225 
¡©e
 = 
	`kmem_ÿche_®loc
(
ex‹Á_¡©e_ÿche
, 
mask
);

226 ià(!
¡©e
)

227  
¡©e
;

228 
¡©e
->state = 0;

229 
¡©e
->
çž»c
 = 
NULL
;

230 
	`RB_CLEAR_NODE
(&
¡©e
->
rb_node
);

231 
	`bŒfs_Ëak_debug_add
(&
¡©e
->
Ëak_li¡
, &
¡©es
);

232 
	`»fcouÁ_£t
(&
¡©e
->
»fs
, 1);

233 
	`š™_wa™queue_h—d
(&
¡©e
->
wq
);

234 
	`Œaû_®loc_ex‹Á_¡©e
(
¡©e
, 
mask
, 
_RET_IP_
);

235  
¡©e
;

236 
	}
}

238 
	$ä“_ex‹Á_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

240 ià(!
¡©e
)

242 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
¡©e
->
»fs
)) {

243 
	`WARN_ON
(
	`ex‹Á_¡©e_š_Œ“
(
¡©e
));

244 
	`bŒfs_Ëak_debug_d–
(&
¡©e
->
Ëak_li¡
);

245 
	`Œaû_ä“_ex‹Á_¡©e
(
¡©e
, 
_RET_IP_
);

246 
	`kmem_ÿche_ä“
(
ex‹Á_¡©e_ÿche
, 
¡©e
);

248 
	}
}

250 
rb_node
 *
	$Œ“_š£¹
(
rb_roÙ
 *
roÙ
,

251 
rb_node
 *
£¬ch_¡¬t
,

252 
u64
 
off£t
,

253 
rb_node
 *
node
,

254 
rb_node
 ***
p_š
,

255 
rb_node
 **
·»Á_š
)

257 
rb_node
 **
p
;

258 
rb_node
 *
·»Á
 = 
NULL
;

259 
Œ“_’Œy
 *
’Œy
;

261 ià(
p_š
 && 
·»Á_š
) {

262 
p
 = *
p_š
;

263 
·»Á
 = *
·»Á_š
;

264 
do_š£¹
;

267 
p
 = 
£¬ch_¡¬t
 ? &£¬ch_¡¬ˆ: &
roÙ
->
rb_node
;

268 *
p
) {

269 
·»Á
 = *
p
;

270 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
Œ“_’Œy
, 
rb_node
);

272 ià(
off£t
 < 
’Œy
->
¡¬t
)

273 
p
 = &(*p)->
rb_Ëá
;

274 ià(
off£t
 > 
’Œy
->
’d
)

275 
p
 = &(*p)->
rb_right
;

277  
·»Á
;

280 
do_š£¹
:

281 
	`rb_lšk_node
(
node
, 
·»Á
, 
p
);

282 
	`rb_š£¹_cÞÜ
(
node
, 
roÙ
);

283  
NULL
;

284 
	}
}

286 
rb_node
 *
	$__‘»e_£¬ch
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
off£t
,

287 
rb_node
 **
´ev_»t
,

288 
rb_node
 **
Ãxt_»t
,

289 
rb_node
 ***
p_»t
,

290 
rb_node
 **
·»Á_»t
)

292 
rb_roÙ
 *
roÙ
 = &
Œ“
->
¡©e
;

293 
rb_node
 **
n
 = &
roÙ
->rb_node;

294 
rb_node
 *
´ev
 = 
NULL
;

295 
rb_node
 *
Üig_´ev
 = 
NULL
;

296 
Œ“_’Œy
 *
’Œy
;

297 
Œ“_’Œy
 *
´ev_’Œy
 = 
NULL
;

299 *
n
) {

300 
´ev
 = *
n
;

301 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
Œ“_’Œy
, 
rb_node
);

302 
´ev_’Œy
 = 
’Œy
;

304 ià(
off£t
 < 
’Œy
->
¡¬t
)

305 
n
 = &(*n)->
rb_Ëá
;

306 ià(
off£t
 > 
’Œy
->
’d
)

307 
n
 = &(*n)->
rb_right
;

309  *
n
;

312 ià(
p_»t
)

313 *
p_»t
 = 
n
;

314 ià(
·»Á_»t
)

315 *
·»Á_»t
 = 
´ev
;

317 ià(
´ev_»t
) {

318 
Üig_´ev
 = 
´ev
;

319 
´ev
 && 
off£t
 > 
´ev_’Œy
->
’d
) {

320 
´ev
 = 
	`rb_Ãxt
(prev);

321 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
Œ“_’Œy
, 
rb_node
);

323 *
´ev_»t
 = 
´ev
;

324 
´ev
 = 
Üig_´ev
;

327 ià(
Ãxt_»t
) {

328 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
Œ“_’Œy
, 
rb_node
);

329 
´ev
 && 
off£t
 < 
´ev_’Œy
->
¡¬t
) {

330 
´ev
 = 
	`rb_´ev
(prev);

331 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
Œ“_’Œy
, 
rb_node
);

333 *
Ãxt_»t
 = 
´ev
;

335  
NULL
;

336 
	}
}

338 
šlše
 
rb_node
 *

339 
	$Œ“_£¬ch_fÜ_š£¹
(
ex‹Á_io_Œ“
 *
Œ“
,

340 
u64
 
off£t
,

341 
rb_node
 ***
p_»t
,

342 
rb_node
 **
·»Á_»t
)

344 
rb_node
 *
´ev
 = 
NULL
;

345 
rb_node
 *
»t
;

347 
»t
 = 
	`__‘»e_£¬ch
(
Œ“
, 
off£t
, &
´ev
, 
NULL
, 
p_»t
, 
·»Á_»t
);

348 ià(!
»t
)

349  
´ev
;

350  
»t
;

351 
	}
}

353 
šlše
 
rb_node
 *
	$Œ“_£¬ch
(
ex‹Á_io_Œ“
 *
Œ“
,

354 
u64
 
off£t
)

356  
	`Œ“_£¬ch_fÜ_š£¹
(
Œ“
, 
off£t
, 
NULL
, NULL);

357 
	}
}

359 
	$m”ge_cb
(
ex‹Á_io_Œ“
 *
Œ“
, 
ex‹Á_¡©e
 *
Ãw
,

360 
ex‹Á_¡©e
 *
Ùh”
)

362 ià(
Œ“
->
Ýs
 &&»e->Ýs->
m”ge_ex‹Á_hook
)

363 
Œ“
->
Ýs
->
	`m”ge_ex‹Á_hook
Ñ»e->
´iv©e_d©a
, 
Ãw
, 
Ùh”
);

364 
	}
}

375 
	$m”ge_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

376 
ex‹Á_¡©e
 *
¡©e
)

378 
ex‹Á_¡©e
 *
Ùh”
;

379 
rb_node
 *
Ùh”_node
;

381 ià(
¡©e
->¡©& (
EXTENT_IOBITS
 | 
EXTENT_BOUNDARY
))

384 
Ùh”_node
 = 
	`rb_´ev
(&
¡©e
->
rb_node
);

385 ià(
Ùh”_node
) {

386 
Ùh”
 = 
	`rb_’Œy
(
Ùh”_node
, 
ex‹Á_¡©e
, 
rb_node
);

387 ià(
Ùh”
->
’d
 =ð
¡©e
->
¡¬t
 - 1 &&

388 
Ùh”
->
¡©e
 == state->state) {

389 
	`m”ge_cb
(
Œ“
, 
¡©e
, 
Ùh”
);

390 
¡©e
->
¡¬t
 = 
Ùh”
->start;

391 
	`rb_”a£
(&
Ùh”
->
rb_node
, &
Œ“
->
¡©e
);

392 
	`RB_CLEAR_NODE
(&
Ùh”
->
rb_node
);

393 
	`ä“_ex‹Á_¡©e
(
Ùh”
);

396 
Ùh”_node
 = 
	`rb_Ãxt
(&
¡©e
->
rb_node
);

397 ià(
Ùh”_node
) {

398 
Ùh”
 = 
	`rb_’Œy
(
Ùh”_node
, 
ex‹Á_¡©e
, 
rb_node
);

399 ià(
Ùh”
->
¡¬t
 =ð
¡©e
->
’d
 + 1 &&

400 
Ùh”
->
¡©e
 == state->state) {

401 
	`m”ge_cb
(
Œ“
, 
¡©e
, 
Ùh”
);

402 
¡©e
->
’d
 = 
Ùh”
->end;

403 
	`rb_”a£
(&
Ùh”
->
rb_node
, &
Œ“
->
¡©e
);

404 
	`RB_CLEAR_NODE
(&
Ùh”
->
rb_node
);

405 
	`ä“_ex‹Á_¡©e
(
Ùh”
);

408 
	}
}

410 
	$£t_¡©e_cb
(
ex‹Á_io_Œ“
 *
Œ“
,

411 
ex‹Á_¡©e
 *
¡©e
, *
b™s
)

413 ià(
Œ“
->
Ýs
 &&»e->Ýs->
£t_b™_hook
)

414 
Œ“
->
Ýs
->
	`£t_b™_hook
Ñ»e->
´iv©e_d©a
, 
¡©e
, 
b™s
);

415 
	}
}

417 
	$þ—r_¡©e_cb
(
ex‹Á_io_Œ“
 *
Œ“
,

418 
ex‹Á_¡©e
 *
¡©e
, *
b™s
)

420 ià(
Œ“
->
Ýs
 &&»e->Ýs->
þ—r_b™_hook
)

421 
Œ“
->
Ýs
->
	`þ—r_b™_hook
Ñ»e->
´iv©e_d©a
, 
¡©e
, 
b™s
);

422 
	}
}

424 
£t_¡©e_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

425 
ex‹Á_¡©e
 *
¡©e
, *
b™s
,

426 
ex‹Á_chªge£t
 *
chªge£t
);

438 
	$š£¹_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

439 
ex‹Á_¡©e
 *
¡©e
, 
u64
 
¡¬t
, u64 
’d
,

440 
rb_node
 ***
p
,

441 
rb_node
 **
·»Á
,

442 *
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

444 
rb_node
 *
node
;

446 ià(
’d
 < 
¡¬t
)

447 
	`WARN
(1, 
KERN_ERR
 "BTRFS:ƒnd < start %llu %llu\n",

448 
’d
, 
¡¬t
);

449 
¡©e
->
¡¬t
 = start;

450 
¡©e
->
’d
 =ƒnd;

452 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, 
b™s
, 
chªge£t
);

454 
node
 = 
	`Œ“_š£¹
(&
Œ“
->
¡©e
, 
NULL
, 
’d
, &¡©e->
rb_node
, 
p
, 
·»Á
);

455 ià(
node
) {

456 
ex‹Á_¡©e
 *
found
;

457 
found
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

458 
	`´_”r
("BTRFS: found‚ode %llu %llu on insert of %llu %llu\n",

459 
found
->
¡¬t
, found->
’d
, start,ƒnd);

460  -
EEXIST
;

462 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

464 
	}
}

466 
	$¥l™_cb
(
ex‹Á_io_Œ“
 *
Œ“
, 
ex‹Á_¡©e
 *
Üig
,

467 
u64
 
¥l™
)

469 ià(
Œ“
->
Ýs
 &&»e->Ýs->
¥l™_ex‹Á_hook
)

470 
Œ“
->
Ýs
->
	`¥l™_ex‹Á_hook
Ñ»e->
´iv©e_d©a
, 
Üig
, 
¥l™
);

471 
	}
}

487 
	$¥l™_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
ex‹Á_¡©e
 *
Üig
,

488 
ex‹Á_¡©e
 *
´—Îoc
, 
u64
 
¥l™
)

490 
rb_node
 *
node
;

492 
	`¥l™_cb
(
Œ“
, 
Üig
, 
¥l™
);

494 
´—Îoc
->
¡¬t
 = 
Üig
->start;

495 
´—Îoc
->
’d
 = 
¥l™
 - 1;

496 
´—Îoc
->
¡©e
 = 
Üig
->state;

497 
Üig
->
¡¬t
 = 
¥l™
;

499 
node
 = 
	`Œ“_š£¹
(&
Œ“
->
¡©e
, &
Üig
->
rb_node
, 
´—Îoc
->
’d
,

500 &
´—Îoc
->
rb_node
, 
NULL
, NULL);

501 ià(
node
) {

502 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

503  -
EEXIST
;

506 
	}
}

508 
ex‹Á_¡©e
 *
	$Ãxt_¡©e
(
ex‹Á_¡©e
 *
¡©e
)

510 
rb_node
 *
Ãxt
 = 
	`rb_Ãxt
(&
¡©e
->rb_node);

511 ià(
Ãxt
)

512  
	`rb_’Œy
(
Ãxt
, 
ex‹Á_¡©e
, 
rb_node
);

514  
NULL
;

515 
	}
}

524 
ex‹Á_¡©e
 *
	$þ—r_¡©e_b™
(
ex‹Á_io_Œ“
 *
Œ“
,

525 
ex‹Á_¡©e
 *
¡©e
,

526 *
b™s
, 
wake
,

527 
ex‹Á_chªge£t
 *
chªge£t
)

529 
ex‹Á_¡©e
 *
Ãxt
;

530 
b™s_to_þ—r
 = *
b™s
 & ~
EXTENT_CTLBITS
;

532 ià((
b™s_to_þ—r
 & 
EXTENT_DIRTY
è&& (
¡©e
->state & EXTENT_DIRTY)) {

533 
u64
 
¿nge
 = 
¡©e
->
’d
 - s‹->
¡¬t
 + 1;

534 
	`WARN_ON
(
¿nge
 > 
Œ“
->
dœty_by‹s
);

535 
Œ“
->
dœty_by‹s
 -ð
¿nge
;

537 
	`þ—r_¡©e_cb
(
Œ“
, 
¡©e
, 
b™s
);

538 
	`add_ex‹Á_chªge£t
(
¡©e
, 
b™s_to_þ—r
, 
chªge£t
, 0);

539 
¡©e
->¡©&ð~
b™s_to_þ—r
;

540 ià(
wake
)

541 
	`wake_up
(&
¡©e
->
wq
);

542 ià(
¡©e
->state == 0) {

543 
Ãxt
 = 
	`Ãxt_¡©e
(
¡©e
);

544 ià(
	`ex‹Á_¡©e_š_Œ“
(
¡©e
)) {

545 
	`rb_”a£
(&
¡©e
->
rb_node
, &
Œ“
->state);

546 
	`RB_CLEAR_NODE
(&
¡©e
->
rb_node
);

547 
	`ä“_ex‹Á_¡©e
(
¡©e
);

549 
	`WARN_ON
(1);

552 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

553 
Ãxt
 = 
	`Ãxt_¡©e
(
¡©e
);

555  
Ãxt
;

556 
	}
}

558 
ex‹Á_¡©e
 *

559 
	$®loc_ex‹Á_¡©e_©omic
(
ex‹Á_¡©e
 *
´—Îoc
)

561 ià(!
´—Îoc
)

562 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
GFP_ATOMIC
);

564  
´—Îoc
;

565 
	}
}

567 
	$ex‹Á_io_Œ“_·nic
(
ex‹Á_io_Œ“
 *
Œ“
, 
”r
)

569 
	`bŒfs_·nic
(
	`Œ“_fs_šfo
(
Œ“
), 
”r
,

571 
	}
}

585 
	$__þ—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

586 
b™s
, 
wake
, 
d–‘e
,

587 
ex‹Á_¡©e
 **
ÿched_¡©e
,

588 
gå_t
 
mask
, 
ex‹Á_chªge£t
 *
chªge£t
)

590 
ex‹Á_¡©e
 *
¡©e
;

591 
ex‹Á_¡©e
 *
ÿched
;

592 
ex‹Á_¡©e
 *
´—Îoc
 = 
NULL
;

593 
rb_node
 *
node
;

594 
u64
 
Ï¡_’d
;

595 
”r
;

596 
þ—r
 = 0;

598 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

600 ià(
b™s
 & 
EXTENT_DELALLOC
)

601 
b™s
 |ð
EXTENT_NORESERVE
;

603 ià(
d–‘e
)

604 
b™s
 |ð~
EXTENT_CTLBITS
;

605 
b™s
 |ð
EXTENT_FIRST_DELALLOC
;

607 ià(
b™s
 & (
EXTENT_IOBITS
 | 
EXTENT_BOUNDARY
))

608 
þ—r
 = 1;

609 
agaš
:

610 ià(!
´—Îoc
 && 
	`gåæags_®low_blockšg
(
mask
)) {

618 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
mask
);

621 
	`¥š_lock
(&
Œ“
->
lock
);

622 ià(
ÿched_¡©e
) {

623 
ÿched
 = *
ÿched_¡©e
;

625 ià(
þ—r
) {

626 *
ÿched_¡©e
 = 
NULL
;

627 
ÿched_¡©e
 = 
NULL
;

630 ià(
ÿched
 && 
	`ex‹Á_¡©e_š_Œ“
(cached) &&

631 
ÿched
->
¡¬t
 <ð¡¬ˆ&& cached->
’d
 > start) {

632 ià(
þ—r
)

633 
	`»fcouÁ_dec
(&
ÿched
->
»fs
);

634 
¡©e
 = 
ÿched
;

635 
h™_Ãxt
;

637 ià(
þ—r
)

638 
	`ä“_ex‹Á_¡©e
(
ÿched
);

644 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

645 ià(!
node
)

646 
out
;

647 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

648 
h™_Ãxt
:

649 ià(
¡©e
->
¡¬t
 > 
’d
)

650 
out
;

651 
	`WARN_ON
(
¡©e
->
’d
 < 
¡¬t
);

652 
Ï¡_’d
 = 
¡©e
->
’d
;

655 ià(!(
¡©e
->¡©& 
b™s
)) {

656 
¡©e
 = 
	`Ãxt_¡©e
(state);

657 
Ãxt
;

676 ià(
¡©e
->
¡¬t
 < start) {

677 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

678 
	`BUG_ON
(!
´—Îoc
);

679 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
¡¬t
);

680 ià(
”r
)

681 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

683 
´—Îoc
 = 
NULL
;

684 ià(
”r
)

685 
out
;

686 ià(
¡©e
->
’d
 <=ƒnd) {

687 
¡©e
 = 
	`þ—r_¡©e_b™
(
Œ“
, s‹, &
b™s
, 
wake
,

688 
chªge£t
);

689 
Ãxt
;

691 
£¬ch_agaš
;

699 ià(
¡©e
->
¡¬t
 <ð
’d
 && state->end >ƒnd) {

700 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

701 
	`BUG_ON
(!
´—Îoc
);

702 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
’d
 + 1);

703 ià(
”r
)

704 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

706 ià(
wake
)

707 
	`wake_up
(&
¡©e
->
wq
);

709 
	`þ—r_¡©e_b™
(
Œ“
, 
´—Îoc
, &
b™s
, 
wake
, 
chªge£t
);

711 
´—Îoc
 = 
NULL
;

712 
out
;

715 
¡©e
 = 
	`þ—r_¡©e_b™
(
Œ“
, s‹, &
b™s
, 
wake
, 
chªge£t
);

716 
Ãxt
:

717 ià(
Ï¡_’d
 =ð(
u64
)-1)

718 
out
;

719 
¡¬t
 = 
Ï¡_’d
 + 1;

720 ià(
¡¬t
 <ð
’d
 && 
¡©e
 && !
	`Ãed_»sched
())

721 
h™_Ãxt
;

723 
£¬ch_agaš
:

724 ià(
¡¬t
 > 
’d
)

725 
out
;

726 
	`¥š_uÆock
(&
Œ“
->
lock
);

727 ià(
	`gåæags_®low_blockšg
(
mask
))

728 
	`cÚd_»sched
();

729 
agaš
;

731 
out
:

732 
	`¥š_uÆock
(&
Œ“
->
lock
);

733 ià(
´—Îoc
)

734 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

738 
	}
}

740 
	$wa™_Ú_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

741 
ex‹Á_¡©e
 *
¡©e
)

742 
	`__»Ëa£s
(
Œ“
->
lock
)

743 
	`__acquœes
(
Œ“
->
lock
)

745 
	`DEFINE_WAIT
(
wa™
);

746 
	`´•¬e_to_wa™
(&
¡©e
->
wq
, &
wa™
, 
TASK_UNINTERRUPTIBLE
);

747 
	`¥š_uÆock
(&
Œ“
->
lock
);

748 
	`scheduË
();

749 
	`¥š_lock
(&
Œ“
->
lock
);

750 
	`fšish_wa™
(&
¡©e
->
wq
, &
wa™
);

751 
	}
}

758 
	$wa™_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

759 
b™s
)

761 
ex‹Á_¡©e
 *
¡©e
;

762 
rb_node
 *
node
;

764 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

766 
	`¥š_lock
(&
Œ“
->
lock
);

767 
agaš
:

773 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

774 
´oûss_node
:

775 ià(!
node
)

778 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

780 ià(
¡©e
->
¡¬t
 > 
’d
)

781 
out
;

783 ià(
¡©e
->¡©& 
b™s
) {

784 
¡¬t
 = 
¡©e
->start;

785 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

786 
	`wa™_Ú_¡©e
(
Œ“
, 
¡©e
);

787 
	`ä“_ex‹Á_¡©e
(
¡©e
);

788 
agaš
;

790 
¡¬t
 = 
¡©e
->
’d
 + 1;

792 ià(
¡¬t
 > 
’d
)

795 ià(!
	`cÚd_»sched_lock
(&
Œ“
->
lock
)) {

796 
node
 = 
	`rb_Ãxt
(node);

797 
´oûss_node
;

800 
out
:

801 
	`¥š_uÆock
(&
Œ“
->
lock
);

802 
	}
}

804 
	$£t_¡©e_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

805 
ex‹Á_¡©e
 *
¡©e
,

806 *
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

808 
b™s_to_£t
 = *
b™s
 & ~
EXTENT_CTLBITS
;

810 
	`£t_¡©e_cb
(
Œ“
, 
¡©e
, 
b™s
);

811 ià((
b™s_to_£t
 & 
EXTENT_DIRTY
è&& !(
¡©e
->state & EXTENT_DIRTY)) {

812 
u64
 
¿nge
 = 
¡©e
->
’d
 - s‹->
¡¬t
 + 1;

813 
Œ“
->
dœty_by‹s
 +ð
¿nge
;

815 
	`add_ex‹Á_chªge£t
(
¡©e
, 
b™s_to_£t
, 
chªge£t
, 1);

816 
¡©e
->¡©|ð
b™s_to_£t
;

817 
	}
}

819 
	$ÿche_¡©e_if_æags
(
ex‹Á_¡©e
 *
¡©e
,

820 
ex‹Á_¡©e
 **
ÿched_±r
,

821 
æags
)

823 ià(
ÿched_±r
 && !(*cached_ptr)) {

824 ià(!
æags
 || (
¡©e
->state & flags)) {

825 *
ÿched_±r
 = 
¡©e
;

826 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

829 
	}
}

831 
	$ÿche_¡©e
(
ex‹Á_¡©e
 *
¡©e
,

832 
ex‹Á_¡©e
 **
ÿched_±r
)

834  
	`ÿche_¡©e_if_æags
(
¡©e
, 
ÿched_±r
,

835 
EXTENT_IOBITS
 | 
EXTENT_BOUNDARY
);

836 
	}
}

849 
__mu¡_check


850 
	$__£t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

851 
b™s
, 
exþusive_b™s
,

852 
u64
 *
çžed_¡¬t
, 
ex‹Á_¡©e
 **
ÿched_¡©e
,

853 
gå_t
 
mask
, 
ex‹Á_chªge£t
 *
chªge£t
)

855 
ex‹Á_¡©e
 *
¡©e
;

856 
ex‹Á_¡©e
 *
´—Îoc
 = 
NULL
;

857 
rb_node
 *
node
;

858 
rb_node
 **
p
;

859 
rb_node
 *
·»Á
;

860 
”r
 = 0;

861 
u64
 
Ï¡_¡¬t
;

862 
u64
 
Ï¡_’d
;

864 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

866 
b™s
 |ð
EXTENT_FIRST_DELALLOC
;

867 
agaš
:

868 ià(!
´—Îoc
 && 
	`gåæags_®low_blockšg
(
mask
)) {

876 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
mask
);

879 
	`¥š_lock
(&
Œ“
->
lock
);

880 ià(
ÿched_¡©e
 && *cached_state) {

881 
¡©e
 = *
ÿched_¡©e
;

882 ià(
¡©e
->
¡¬t
 <ð¡¬ˆ&& s‹->
’d
 > start &&

883 
	`ex‹Á_¡©e_š_Œ“
(
¡©e
)) {

884 
node
 = &
¡©e
->
rb_node
;

885 
h™_Ãxt
;

892 
node
 = 
	`Œ“_£¬ch_fÜ_š£¹
(
Œ“
, 
¡¬t
, &
p
, &
·»Á
);

893 ià(!
node
) {

894 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

895 
	`BUG_ON
(!
´—Îoc
);

896 
”r
 = 
	`š£¹_¡©e
(
Œ“
, 
´—Îoc
, 
¡¬t
, 
’d
,

897 &
p
, &
·»Á
, &
b™s
, 
chªge£t
);

898 ià(
”r
)

899 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

901 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

902 
´—Îoc
 = 
NULL
;

903 
out
;

905 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

906 
h™_Ãxt
:

907 
Ï¡_¡¬t
 = 
¡©e
->
¡¬t
;

908 
Ï¡_’d
 = 
¡©e
->
’d
;

916 ià(
¡©e
->
¡¬t
 =ð¡¬ˆ&& s‹->
’d
 <=ƒnd) {

917 ià(
¡©e
->¡©& 
exþusive_b™s
) {

918 *
çžed_¡¬t
 = 
¡©e
->
¡¬t
;

919 
”r
 = -
EEXIST
;

920 
out
;

923 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, &
b™s
, 
chªge£t
);

924 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

925 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

926 ià(
Ï¡_’d
 =ð(
u64
)-1)

927 
out
;

928 
¡¬t
 = 
Ï¡_’d
 + 1;

929 
¡©e
 = 
	`Ãxt_¡©e
(state);

930 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

931 !
	`Ãed_»sched
())

932 
h™_Ãxt
;

933 
£¬ch_agaš
;

952 ià(
¡©e
->
¡¬t
 < start) {

953 ià(
¡©e
->¡©& 
exþusive_b™s
) {

954 *
çžed_¡¬t
 = 
¡¬t
;

955 
”r
 = -
EEXIST
;

956 
out
;

959 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

960 
	`BUG_ON
(!
´—Îoc
);

961 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
¡¬t
);

962 ià(
”r
)

963 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

965 
´—Îoc
 = 
NULL
;

966 ià(
”r
)

967 
out
;

968 ià(
¡©e
->
’d
 <=ƒnd) {

969 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, &
b™s
, 
chªge£t
);

970 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

971 
	`m”ge_¡©e
(
Œ“
, 
¡©e
);

972 ià(
Ï¡_’d
 =ð(
u64
)-1)

973 
out
;

974 
¡¬t
 = 
Ï¡_’d
 + 1;

975 
¡©e
 = 
	`Ãxt_¡©e
(state);

976 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

977 !
	`Ãed_»sched
())

978 
h™_Ãxt
;

980 
£¬ch_agaš
;

989 ià(
¡©e
->
¡¬t
 > start) {

990 
u64
 
this_’d
;

991 ià(
’d
 < 
Ï¡_¡¬t
)

992 
this_’d
 = 
’d
;

994 
this_’d
 = 
Ï¡_¡¬t
 - 1;

996 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

997 
	`BUG_ON
(!
´—Îoc
);

1003 
”r
 = 
	`š£¹_¡©e
(
Œ“
, 
´—Îoc
, 
¡¬t
, 
this_’d
,

1004 
NULL
, NULL, &
b™s
, 
chªge£t
);

1005 ià(
”r
)

1006 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1008 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1009 
´—Îoc
 = 
NULL
;

1010 
¡¬t
 = 
this_’d
 + 1;

1011 
£¬ch_agaš
;

1019 ià(
¡©e
->
¡¬t
 <ð
’d
 && state->end >ƒnd) {

1020 ià(
¡©e
->¡©& 
exþusive_b™s
) {

1021 *
çžed_¡¬t
 = 
¡¬t
;

1022 
”r
 = -
EEXIST
;

1023 
out
;

1026 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1027 
	`BUG_ON
(!
´—Îoc
);

1028 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
’d
 + 1);

1029 ià(
”r
)

1030 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1032 
	`£t_¡©e_b™s
(
Œ“
, 
´—Îoc
, &
b™s
, 
chªge£t
);

1033 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1034 
	`m”ge_¡©e
(
Œ“
, 
´—Îoc
);

1035 
´—Îoc
 = 
NULL
;

1036 
out
;

1039 
£¬ch_agaš
:

1040 ià(
¡¬t
 > 
’d
)

1041 
out
;

1042 
	`¥š_uÆock
(&
Œ“
->
lock
);

1043 ià(
	`gåæags_®low_blockšg
(
mask
))

1044 
	`cÚd_»sched
();

1045 
agaš
;

1047 
out
:

1048 
	`¥š_uÆock
(&
Œ“
->
lock
);

1049 ià(
´—Îoc
)

1050 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

1052  
”r
;

1054 
	}
}

1056 
	$£t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1057 
b™s
, 
u64
 * 
çžed_¡¬t
,

1058 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
gå_t
 
mask
)

1060  
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 0, 
çžed_¡¬t
,

1061 
ÿched_¡©e
, 
mask
, 
NULL
);

1062 
	}
}

1083 
	$cÚv”t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1084 
b™s
, 
þ—r_b™s
,

1085 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1087 
ex‹Á_¡©e
 *
¡©e
;

1088 
ex‹Á_¡©e
 *
´—Îoc
 = 
NULL
;

1089 
rb_node
 *
node
;

1090 
rb_node
 **
p
;

1091 
rb_node
 *
·»Á
;

1092 
”r
 = 0;

1093 
u64
 
Ï¡_¡¬t
;

1094 
u64
 
Ï¡_’d
;

1095 
boÞ
 
fœ¡_™”©iÚ
 = 
Œue
;

1097 
	`bŒfs_debug_check_ex‹Á_io_¿nge
(
Œ“
, 
¡¬t
, 
’d
);

1099 
agaš
:

1100 ià(!
´—Îoc
) {

1108 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e
(
GFP_NOFS
);

1109 ià(!
´—Îoc
 && !
fœ¡_™”©iÚ
)

1110  -
ENOMEM
;

1113 
	`¥š_lock
(&
Œ“
->
lock
);

1114 ià(
ÿched_¡©e
 && *cached_state) {

1115 
¡©e
 = *
ÿched_¡©e
;

1116 ià(
¡©e
->
¡¬t
 <ð¡¬ˆ&& s‹->
’d
 > start &&

1117 
	`ex‹Á_¡©e_š_Œ“
(
¡©e
)) {

1118 
node
 = &
¡©e
->
rb_node
;

1119 
h™_Ãxt
;

1127 
node
 = 
	`Œ“_£¬ch_fÜ_š£¹
(
Œ“
, 
¡¬t
, &
p
, &
·»Á
);

1128 ià(!
node
) {

1129 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1130 ià(!
´—Îoc
) {

1131 
”r
 = -
ENOMEM
;

1132 
out
;

1134 
”r
 = 
	`š£¹_¡©e
(
Œ“
, 
´—Îoc
, 
¡¬t
, 
’d
,

1135 &
p
, &
·»Á
, &
b™s
, 
NULL
);

1136 ià(
”r
)

1137 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1138 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1139 
´—Îoc
 = 
NULL
;

1140 
out
;

1142 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1143 
h™_Ãxt
:

1144 
Ï¡_¡¬t
 = 
¡©e
->
¡¬t
;

1145 
Ï¡_’d
 = 
¡©e
->
’d
;

1153 ià(
¡©e
->
¡¬t
 =ð¡¬ˆ&& s‹->
’d
 <=ƒnd) {

1154 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, &
b™s
, 
NULL
);

1155 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1156 
¡©e
 = 
	`þ—r_¡©e_b™
(
Œ“
, s‹, &
þ—r_b™s
, 0, 
NULL
);

1157 ià(
Ï¡_’d
 =ð(
u64
)-1)

1158 
out
;

1159 
¡¬t
 = 
Ï¡_’d
 + 1;

1160 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

1161 !
	`Ãed_»sched
())

1162 
h™_Ãxt
;

1163 
£¬ch_agaš
;

1182 ià(
¡©e
->
¡¬t
 < start) {

1183 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1184 ià(!
´—Îoc
) {

1185 
”r
 = -
ENOMEM
;

1186 
out
;

1188 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
¡¬t
);

1189 ià(
”r
)

1190 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1191 
´—Îoc
 = 
NULL
;

1192 ià(
”r
)

1193 
out
;

1194 ià(
¡©e
->
’d
 <=ƒnd) {

1195 
	`£t_¡©e_b™s
(
Œ“
, 
¡©e
, &
b™s
, 
NULL
);

1196 
	`ÿche_¡©e
(
¡©e
, 
ÿched_¡©e
);

1197 
¡©e
 = 
	`þ—r_¡©e_b™
(
Œ“
, s‹, &
þ—r_b™s
, 0,

1198 
NULL
);

1199 ià(
Ï¡_’d
 =ð(
u64
)-1)

1200 
out
;

1201 
¡¬t
 = 
Ï¡_’d
 + 1;

1202 ià(
¡¬t
 < 
’d
 && 
¡©e
 && state->start == start &&

1203 !
	`Ãed_»sched
())

1204 
h™_Ãxt
;

1206 
£¬ch_agaš
;

1215 ià(
¡©e
->
¡¬t
 > start) {

1216 
u64
 
this_’d
;

1217 ià(
’d
 < 
Ï¡_¡¬t
)

1218 
this_’d
 = 
’d
;

1220 
this_’d
 = 
Ï¡_¡¬t
 - 1;

1222 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1223 ià(!
´—Îoc
) {

1224 
”r
 = -
ENOMEM
;

1225 
out
;

1232 
”r
 = 
	`š£¹_¡©e
(
Œ“
, 
´—Îoc
, 
¡¬t
, 
this_’d
,

1233 
NULL
, NULL, &
b™s
, NULL);

1234 ià(
”r
)

1235 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1236 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1237 
´—Îoc
 = 
NULL
;

1238 
¡¬t
 = 
this_’d
 + 1;

1239 
£¬ch_agaš
;

1247 ià(
¡©e
->
¡¬t
 <ð
’d
 && state->end >ƒnd) {

1248 
´—Îoc
 = 
	`®loc_ex‹Á_¡©e_©omic
(prealloc);

1249 ià(!
´—Îoc
) {

1250 
”r
 = -
ENOMEM
;

1251 
out
;

1254 
”r
 = 
	`¥l™_¡©e
(
Œ“
, 
¡©e
, 
´—Îoc
, 
’d
 + 1);

1255 ià(
”r
)

1256 
	`ex‹Á_io_Œ“_·nic
(
Œ“
, 
”r
);

1258 
	`£t_¡©e_b™s
(
Œ“
, 
´—Îoc
, &
b™s
, 
NULL
);

1259 
	`ÿche_¡©e
(
´—Îoc
, 
ÿched_¡©e
);

1260 
	`þ—r_¡©e_b™
(
Œ“
, 
´—Îoc
, &
þ—r_b™s
, 0, 
NULL
);

1261 
´—Îoc
 = 
NULL
;

1262 
out
;

1265 
£¬ch_agaš
:

1266 ià(
¡¬t
 > 
’d
)

1267 
out
;

1268 
	`¥š_uÆock
(&
Œ“
->
lock
);

1269 
	`cÚd_»sched
();

1270 
fœ¡_™”©iÚ
 = 
çl£
;

1271 
agaš
;

1273 
out
:

1274 
	`¥š_uÆock
(&
Œ“
->
lock
);

1275 ià(
´—Îoc
)

1276 
	`ä“_ex‹Á_¡©e
(
´—Îoc
);

1278  
”r
;

1279 
	}
}

1282 
	$£t_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1283 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

1291 
	`BUG_ON
(
b™s
 & 
EXTENT_LOCKED
);

1293  
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 0, 
NULL
, NULL, 
GFP_NOFS
,

1294 
chªge£t
);

1295 
	}
}

1297 
	$þ—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1298 
b™s
, 
wake
, 
d–‘e
,

1299 
ex‹Á_¡©e
 **
ÿched
, 
gå_t
 
mask
)

1301  
	`__þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
wake
, 
d–‘e
,

1302 
ÿched
, 
mask
, 
NULL
);

1303 
	}
}

1305 
	$þ—r_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1306 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
)

1312 
	`BUG_ON
(
b™s
 & 
EXTENT_LOCKED
);

1314  
	`__þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 0, 0, 
NULL
, 
GFP_NOFS
,

1315 
chªge£t
);

1316 
	}
}

1322 
	$lock_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1323 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1325 
”r
;

1326 
u64
 
çžed_¡¬t
;

1329 
”r
 = 
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
,

1330 
EXTENT_LOCKED
, &
çžed_¡¬t
,

1331 
ÿched_¡©e
, 
GFP_NOFS
, 
NULL
);

1332 ià(
”r
 =ð-
EEXIST
) {

1333 
	`wa™_ex‹Á_b™
(
Œ“
, 
çžed_¡¬t
, 
’d
, 
EXTENT_LOCKED
);

1334 
¡¬t
 = 
çžed_¡¬t
;

1337 
	`WARN_ON
(
¡¬t
 > 
’d
);

1339  
”r
;

1340 
	}
}

1342 
	$Œy_lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
)

1344 
”r
;

1345 
u64
 
çžed_¡¬t
;

1347 
”r
 = 
	`__£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, EXTENT_LOCKED,

1348 &
çžed_¡¬t
, 
NULL
, 
GFP_NOFS
, NULL);

1349 ià(
”r
 =ð-
EEXIST
) {

1350 ià(
çžed_¡¬t
 > 
¡¬t
)

1351 
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
çžed_¡¬t
 - 1,

1352 
EXTENT_LOCKED
, 1, 0, 
NULL
, 
GFP_NOFS
);

1356 
	}
}

1358 
	$ex‹Á_¿nge_þ—r_dœty_fÜ_io
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

1360 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1361 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

1362 
·ge
 *page;

1364 
šdex
 <ð
’d_šdex
) {

1365 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

1366 
	`BUG_ON
(!
·ge
);

1367 
	`þ—r_·ge_dœty_fÜ_io
(
·ge
);

1368 
	`put_·ge
(
·ge
);

1369 
šdex
++;

1371 
	}
}

1373 
	$ex‹Á_¿nge_»dœty_fÜ_io
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

1375 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1376 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

1377 
·ge
 *page;

1379 
šdex
 <ð
’d_šdex
) {

1380 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

1381 
	`BUG_ON
(!
·ge
);

1382 
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

1383 
	`accouÁ_·ge_»dœty
(
·ge
);

1384 
	`put_·ge
(
·ge
);

1385 
šdex
++;

1387 
	}
}

1392 
	$£t_¿nge_wr™eback
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
)

1394 
Œ“
->
Ýs
->
	`£t_¿nge_wr™eback
Ñ»e->
´iv©e_d©a
, 
¡¬t
, 
’d
);

1395 
	}
}

1401 
ex‹Á_¡©e
 *

1402 
	$fšd_fœ¡_ex‹Á_b™_¡©e
(
ex‹Á_io_Œ“
 *
Œ“
,

1403 
u64
 
¡¬t
, 
b™s
)

1405 
rb_node
 *
node
;

1406 
ex‹Á_¡©e
 *
¡©e
;

1412 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

1413 ià(!
node
)

1414 
out
;

1417 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1418 ià(
¡©e
->
’d
 >ð
¡¬t
 && (¡©e->¡©& 
b™s
))

1419  
¡©e
;

1421 
node
 = 
	`rb_Ãxt
(node);

1422 ià(!
node
)

1425 
out
:

1426  
NULL
;

1427 
	}
}

1436 
	$fšd_fœ¡_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

1437 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
b™s
,

1438 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1440 
ex‹Á_¡©e
 *
¡©e
;

1441 
rb_node
 *
n
;

1442 
»t
 = 1;

1444 
	`¥š_lock
(&
Œ“
->
lock
);

1445 ià(
ÿched_¡©e
 && *cached_state) {

1446 
¡©e
 = *
ÿched_¡©e
;

1447 ià(
¡©e
->
’d
 =ð
¡¬t
 - 1 && 
	`ex‹Á_¡©e_š_Œ“
(state)) {

1448 
n
 = 
	`rb_Ãxt
(&
¡©e
->
rb_node
);

1449 
n
) {

1450 
¡©e
 = 
	`rb_’Œy
(
n
, 
ex‹Á_¡©e
,

1451 
rb_node
);

1452 ià(
¡©e
->¡©& 
b™s
)

1453 
gÙ_™
;

1454 
n
 = 
	`rb_Ãxt
(n);

1456 
	`ä“_ex‹Á_¡©e
(*
ÿched_¡©e
);

1457 *
ÿched_¡©e
 = 
NULL
;

1458 
out
;

1460 
	`ä“_ex‹Á_¡©e
(*
ÿched_¡©e
);

1461 *
ÿched_¡©e
 = 
NULL
;

1464 
¡©e
 = 
	`fšd_fœ¡_ex‹Á_b™_¡©e
(
Œ“
, 
¡¬t
, 
b™s
);

1465 
gÙ_™
:

1466 ià(
¡©e
) {

1467 
	`ÿche_¡©e_if_æags
(
¡©e
, 
ÿched_¡©e
, 0);

1468 *
¡¬t_»t
 = 
¡©e
->
¡¬t
;

1469 *
’d_»t
 = 
¡©e
->
’d
;

1470 
»t
 = 0;

1472 
out
:

1473 
	`¥š_uÆock
(&
Œ“
->
lock
);

1474  
»t
;

1475 
	}
}

1483 
nošlše
 
u64
 
	$fšd_d–®loc_¿nge
(
ex‹Á_io_Œ“
 *
Œ“
,

1484 
u64
 *
¡¬t
, u64 *
’d
, u64 
max_by‹s
,

1485 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1487 
rb_node
 *
node
;

1488 
ex‹Á_¡©e
 *
¡©e
;

1489 
u64
 
cur_¡¬t
 = *
¡¬t
;

1490 
u64
 
found
 = 0;

1491 
u64
 
tÙ®_by‹s
 = 0;

1493 
	`¥š_lock
(&
Œ“
->
lock
);

1499 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
cur_¡¬t
);

1500 ià(!
node
) {

1501 ià(!
found
)

1502 *
’d
 = (
u64
)-1;

1503 
out
;

1507 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1508 ià(
found
 && (
¡©e
->
¡¬t
 !ð
cur_¡¬t
 ||

1509 (
¡©e
->¡©& 
EXTENT_BOUNDARY
))) {

1510 
out
;

1512 ià(!(
¡©e
->¡©& 
EXTENT_DELALLOC
)) {

1513 ià(!
found
)

1514 *
’d
 = 
¡©e
->end;

1515 
out
;

1517 ià(!
found
) {

1518 *
¡¬t
 = 
¡©e
->start;

1519 *
ÿched_¡©e
 = 
¡©e
;

1520 
	`»fcouÁ_šc
(&
¡©e
->
»fs
);

1522 
found
++;

1523 *
’d
 = 
¡©e
->end;

1524 
cur_¡¬t
 = 
¡©e
->
’d
 + 1;

1525 
node
 = 
	`rb_Ãxt
(node);

1526 
tÙ®_by‹s
 +ð
¡©e
->
’d
 - s‹->
¡¬t
 + 1;

1527 ià(
tÙ®_by‹s
 >ð
max_by‹s
)

1529 ià(!
node
)

1532 
out
:

1533 
	`¥š_uÆock
(&
Œ“
->
lock
);

1534  
found
;

1535 
	}
}

1537 
__´oûss_·ges_cÚtig
(
add»ss_¥aû
 *
m­pšg
,

1538 
·ge
 *
locked_·ge
,

1539 
pgoff_t
 
¡¬t_šdex
,…goff_ˆ
’d_šdex
,

1540 
·ge_Ýs
, 
pgoff_t
 *
šdex_»t
);

1542 
nošlše
 
	$__uÆock_fÜ_d–®loc
(
šode
 *inode,

1543 
·ge
 *
locked_·ge
,

1544 
u64
 
¡¬t
, u64 
’d
)

1546 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

1547 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

1549 
	`ASSERT
(
locked_·ge
);

1550 ià(
šdex
 =ð
locked_·ge
->šdex && 
’d_šdex
 == index)

1553 
	`__´oûss_·ges_cÚtig
(
šode
->
i_m­pšg
, 
locked_·ge
, 
šdex
, 
’d_šdex
,

1554 
PAGE_UNLOCK
, 
NULL
);

1555 
	}
}

1557 
nošlše
 
	$lock_d–®loc_·ges
(
šode
 *inode,

1558 
·ge
 *
locked_·ge
,

1559 
u64
 
d–®loc_¡¬t
,

1560 
u64
 
d–®loc_’d
)

1562 
šdex
 = 
d–®loc_¡¬t
 >> 
PAGE_SHIFT
;

1563 
šdex_»t
 = 
šdex
;

1564 
’d_šdex
 = 
d–®loc_’d
 >> 
PAGE_SHIFT
;

1565 
»t
;

1567 
	`ASSERT
(
locked_·ge
);

1568 ià(
šdex
 =ð
locked_·ge
->šdex && index =ð
’d_šdex
)

1571 
»t
 = 
	`__´oûss_·ges_cÚtig
(
šode
->
i_m­pšg
, 
locked_·ge
, 
šdex
,

1572 
’d_šdex
, 
PAGE_LOCK
, &
šdex_»t
);

1573 ià(
»t
 =ð-
EAGAIN
)

1574 
	`__uÆock_fÜ_d–®loc
(
šode
, 
locked_·ge
, 
d–®loc_¡¬t
,

1575 (
u64
)
šdex_»t
 << 
PAGE_SHIFT
);

1576  
»t
;

1577 
	}
}

1585 
STATIC
 
u64
 
	$fšd_lock_d–®loc_¿nge
(
šode
 *inode,

1586 
ex‹Á_io_Œ“
 *
Œ“
,

1587 
·ge
 *
locked_·ge
, 
u64
 *
¡¬t
,

1588 
u64
 *
’d
, u64 
max_by‹s
)

1590 
u64
 
d–®loc_¡¬t
;

1591 
u64
 
d–®loc_’d
;

1592 
u64
 
found
;

1593 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1594 
»t
;

1595 
loÝs
 = 0;

1597 
agaš
:

1599 
d–®loc_¡¬t
 = *
¡¬t
;

1600 
d–®loc_’d
 = 0;

1601 
found
 = 
	`fšd_d–®loc_¿nge
(
Œ“
, &
d–®loc_¡¬t
, &
d–®loc_’d
,

1602 
max_by‹s
, &
ÿched_¡©e
);

1603 ià(!
found
 || 
d–®loc_’d
 <ð*
¡¬t
) {

1604 *
¡¬t
 = 
d–®loc_¡¬t
;

1605 *
’d
 = 
d–®loc_’d
;

1606 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1615 ià(
d–®loc_¡¬t
 < *
¡¬t
)

1616 
d–®loc_¡¬t
 = *
¡¬t
;

1621 ià(
d–®loc_’d
 + 1 - 
d–®loc_¡¬t
 > 
max_by‹s
)

1622 
d–®loc_’d
 = 
d–®loc_¡¬t
 + 
max_by‹s
 - 1;

1625 
»t
 = 
	`lock_d–®loc_·ges
(
šode
, 
locked_·ge
,

1626 
d–®loc_¡¬t
, 
d–®loc_’d
);

1627 ià(
»t
 =ð-
EAGAIN
) {

1631 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1632 
ÿched_¡©e
 = 
NULL
;

1633 ià(!
loÝs
) {

1634 
max_by‹s
 = 
PAGE_SIZE
;

1635 
loÝs
 = 1;

1636 
agaš
;

1638 
found
 = 0;

1639 
out_çžed
;

1642 
	`BUG_ON
(
»t
);

1645 
	`lock_ex‹Á_b™s
(
Œ“
, 
d–®loc_¡¬t
, 
d–®loc_’d
, &
ÿched_¡©e
);

1648 
»t
 = 
	`‹¡_¿nge_b™
(
Œ“
, 
d–®loc_¡¬t
, 
d–®loc_’d
,

1649 
EXTENT_DELALLOC
, 1, 
ÿched_¡©e
);

1650 ià(!
»t
) {

1651 
	`uÆock_ex‹Á_ÿched
(
Œ“
, 
d–®loc_¡¬t
, 
d–®loc_’d
,

1652 &
ÿched_¡©e
, 
GFP_NOFS
);

1653 
	`__uÆock_fÜ_d–®loc
(
šode
, 
locked_·ge
,

1654 
d–®loc_¡¬t
, 
d–®loc_’d
);

1655 
	`cÚd_»sched
();

1656 
agaš
;

1658 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1659 *
¡¬t
 = 
d–®loc_¡¬t
;

1660 *
’d
 = 
d–®loc_’d
;

1661 
out_çžed
:

1662  
found
;

1663 
	}
}

1665 
	$__´oûss_·ges_cÚtig
(
add»ss_¥aû
 *
m­pšg
,

1666 
·ge
 *
locked_·ge
,

1667 
pgoff_t
 
¡¬t_šdex
,…goff_ˆ
’d_šdex
,

1668 
·ge_Ýs
, 
pgoff_t
 *
šdex_»t
)

1670 
Ä_·ges
 = 
’d_šdex
 - 
¡¬t_šdex
 + 1;

1671 
·ges_locked
 = 0;

1672 
pgoff_t
 
šdex
 = 
¡¬t_šdex
;

1673 
·ge
 *
·ges
[16];

1674 
»t
;

1675 
”r
 = 0;

1676 
i
;

1678 ià(
·ge_Ýs
 & 
PAGE_LOCK
) {

1679 
	`ASSERT
(
·ge_Ýs
 =ð
PAGE_LOCK
);

1680 
	`ASSERT
(
šdex_»t
 && *šdex_»ˆ=ð
¡¬t_šdex
);

1683 ià((
·ge_Ýs
 & 
PAGE_SET_ERROR
è&& 
Ä_·ges
 > 0)

1684 
	`m­pšg_£t_”rÜ
(
m­pšg
, -
EIO
);

1686 
Ä_·ges
 > 0) {

1687 
»t
 = 
	`fšd_g‘_·ges_cÚtig
(
m­pšg
, 
šdex
,

1688 
	`mš_t
(,

1689 
Ä_·ges
, 
	`ARRAY_SIZE
(
·ges
)),…ages);

1690 ià(
»t
 == 0) {

1695 
	`ASSERT
(
·ge_Ýs
 & 
PAGE_LOCK
);

1696 
”r
 = -
EAGAIN
;

1697 
out
;

1700 
i
 = 0; i < 
»t
; i++) {

1701 ià(
·ge_Ýs
 & 
PAGE_SET_PRIVATE2
)

1702 
	`S‘PagePriv©e2
(
·ges
[
i
]);

1704 ià(
·ges
[
i
] =ð
locked_·ge
) {

1705 
	`put_·ge
(
·ges
[
i
]);

1706 
·ges_locked
++;

1709 ià(
·ge_Ýs
 & 
PAGE_CLEAR_DIRTY
)

1710 
	`þ—r_·ge_dœty_fÜ_io
(
·ges
[
i
]);

1711 ià(
·ge_Ýs
 & 
PAGE_SET_WRITEBACK
)

1712 
	`£t_·ge_wr™eback
(
·ges
[
i
]);

1713 ià(
·ge_Ýs
 & 
PAGE_SET_ERROR
)

1714 
	`S‘PageE¼Ü
(
·ges
[
i
]);

1715 ià(
·ge_Ýs
 & 
PAGE_END_WRITEBACK
)

1716 
	`’d_·ge_wr™eback
(
·ges
[
i
]);

1717 ià(
·ge_Ýs
 & 
PAGE_UNLOCK
)

1718 
	`uÆock_·ge
(
·ges
[
i
]);

1719 ià(
·ge_Ýs
 & 
PAGE_LOCK
) {

1720 
	`lock_·ge
(
·ges
[
i
]);

1721 ià(!
	`PageDœty
(
·ges
[
i
]) ||

1722 
·ges
[
i
]->
m­pšg
 != mapping) {

1723 
	`uÆock_·ge
(
·ges
[
i
]);

1724 
	`put_·ge
(
·ges
[
i
]);

1725 
”r
 = -
EAGAIN
;

1726 
out
;

1729 
	`put_·ge
(
·ges
[
i
]);

1730 
·ges_locked
++;

1732 
Ä_·ges
 -ð
»t
;

1733 
šdex
 +ð
»t
;

1734 
	`cÚd_»sched
();

1736 
out
:

1737 ià(
”r
 && 
šdex_»t
)

1738 *
šdex_»t
 = 
¡¬t_šdex
 + 
·ges_locked
 - 1;

1739  
”r
;

1740 
	}
}

1742 
	$ex‹Á_þ—r_uÆock_d–®loc
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

1743 
u64
 
d–®loc_’d
, 
·ge
 *
locked_·ge
,

1744 
þ—r_b™s
,

1745 
·ge_Ýs
)

1747 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
, 
þ—r_b™s
, 1, 0,

1748 
NULL
, 
GFP_NOFS
);

1750 
	`__´oûss_·ges_cÚtig
(
šode
->
i_m­pšg
, 
locked_·ge
,

1751 
¡¬t
 >> 
PAGE_SHIFT
, 
’d
 >> PAGE_SHIFT,

1752 
·ge_Ýs
, 
NULL
);

1753 
	}
}

1760 
u64
 
	$couÁ_¿nge_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

1761 
u64
 *
¡¬t
, u64 
£¬ch_’d
, u64 
max_by‹s
,

1762 
b™s
, 
cÚtig
)

1764 
rb_node
 *
node
;

1765 
ex‹Á_¡©e
 *
¡©e
;

1766 
u64
 
cur_¡¬t
 = *
¡¬t
;

1767 
u64
 
tÙ®_by‹s
 = 0;

1768 
u64
 
Ï¡
 = 0;

1769 
found
 = 0;

1771 ià(
	`WARN_ON
(
£¬ch_’d
 <ð
cur_¡¬t
))

1774 
	`¥š_lock
(&
Œ“
->
lock
);

1775 ià(
cur_¡¬t
 =ð0 && 
b™s
 =ð
EXTENT_DIRTY
) {

1776 
tÙ®_by‹s
 = 
Œ“
->
dœty_by‹s
;

1777 
out
;

1783 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
cur_¡¬t
);

1784 ià(!
node
)

1785 
out
;

1788 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1789 ià(
¡©e
->
¡¬t
 > 
£¬ch_’d
)

1791 ià(
cÚtig
 && 
found
 && 
¡©e
->
¡¬t
 > 
Ï¡
 + 1)

1793 ià(
¡©e
->
’d
 >ð
cur_¡¬t
 && (¡©e->¡©& 
b™s
) == bits) {

1794 
tÙ®_by‹s
 +ð
	`mš
(
£¬ch_’d
, 
¡©e
->
’d
) + 1 -

1795 
	`max
(
cur_¡¬t
, 
¡©e
->
¡¬t
);

1796 ià(
tÙ®_by‹s
 >ð
max_by‹s
)

1798 ià(!
found
) {

1799 *
¡¬t
 = 
	`max
(
cur_¡¬t
, 
¡©e
->start);

1800 
found
 = 1;

1802 
Ï¡
 = 
¡©e
->
’d
;

1803 } ià(
cÚtig
 && 
found
) {

1806 
node
 = 
	`rb_Ãxt
(node);

1807 ià(!
node
)

1810 
out
:

1811 
	`¥š_uÆock
(&
Œ“
->
lock
);

1812  
tÙ®_by‹s
;

1813 
	}
}

1819 
nošlše
 
	$£t_¡©e_çž»c
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

1820 
io_çžu»_»cÜd
 *
çž»c
)

1822 
rb_node
 *
node
;

1823 
ex‹Á_¡©e
 *
¡©e
;

1824 
»t
 = 0;

1826 
	`¥š_lock
(&
Œ“
->
lock
);

1831 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

1832 ià(!
node
) {

1833 
»t
 = -
ENOENT
;

1834 
out
;

1836 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1837 ià(
¡©e
->
¡¬t
 != start) {

1838 
»t
 = -
ENOENT
;

1839 
out
;

1841 
¡©e
->
çž»c
 = failrec;

1842 
out
:

1843 
	`¥š_uÆock
(&
Œ“
->
lock
);

1844  
»t
;

1845 
	}
}

1847 
nošlše
 
	$g‘_¡©e_çž»c
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

1848 
io_çžu»_»cÜd
 **
çž»c
)

1850 
rb_node
 *
node
;

1851 
ex‹Á_¡©e
 *
¡©e
;

1852 
»t
 = 0;

1854 
	`¥š_lock
(&
Œ“
->
lock
);

1859 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

1860 ià(!
node
) {

1861 
»t
 = -
ENOENT
;

1862 
out
;

1864 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1865 ià(
¡©e
->
¡¬t
 != start) {

1866 
»t
 = -
ENOENT
;

1867 
out
;

1869 *
çž»c
 = 
¡©e
->failrec;

1870 
out
:

1871 
	`¥š_uÆock
(&
Œ“
->
lock
);

1872  
»t
;

1873 
	}
}

1881 
	$‹¡_¿nge_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

1882 
b™s
, 
fžËd
, 
ex‹Á_¡©e
 *
ÿched
)

1884 
ex‹Á_¡©e
 *
¡©e
 = 
NULL
;

1885 
rb_node
 *
node
;

1886 
b™£t
 = 0;

1888 
	`¥š_lock
(&
Œ“
->
lock
);

1889 ià(
ÿched
 && 
	`ex‹Á_¡©e_š_Œ“
(ÿchedè&& cached->
¡¬t
 <= start &&

1890 
ÿched
->
’d
 > 
¡¬t
)

1891 
node
 = &
ÿched
->
rb_node
;

1893 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
¡¬t
);

1894 
node
 && 
¡¬t
 <ð
’d
) {

1895 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

1897 ià(
fžËd
 && 
¡©e
->
¡¬t
 > start) {

1898 
b™£t
 = 0;

1902 ià(
¡©e
->
¡¬t
 > 
’d
)

1905 ià(
¡©e
->¡©& 
b™s
) {

1906 
b™£t
 = 1;

1907 ià(!
fžËd
)

1909 } ià(
fžËd
) {

1910 
b™£t
 = 0;

1914 ià(
¡©e
->
’d
 =ð(
u64
)-1)

1917 
¡¬t
 = 
¡©e
->
’d
 + 1;

1918 ià(
¡¬t
 > 
’d
)

1920 
node
 = 
	`rb_Ãxt
(node);

1921 ià(!
node
) {

1922 ià(
fžËd
)

1923 
b™£t
 = 0;

1927 
	`¥š_uÆock
(&
Œ“
->
lock
);

1928  
b™£t
;

1929 
	}
}

1935 
	$check_·ge_u±od©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page)

1937 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

1938 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

1939 ià(
	`‹¡_¿nge_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
, 1, 
NULL
))

1940 
	`S‘PageU±od©e
(
·ge
);

1941 
	}
}

1943 
	$ä“_io_çžu»
(
ex‹Á_io_Œ“
 *
çžu»_Œ“
,

1944 
ex‹Á_io_Œ“
 *
io_Œ“
,

1945 
io_çžu»_»cÜd
 *
»c
)

1947 
»t
;

1948 
”r
 = 0;

1950 
	`£t_¡©e_çž»c
(
çžu»_Œ“
, 
»c
->
¡¬t
, 
NULL
);

1951 
»t
 = 
	`þ—r_ex‹Á_b™s
(
çžu»_Œ“
, 
»c
->
¡¬t
,

1952 
»c
->
¡¬t
 +„ec->
Ën
 - 1,

1953 
EXTENT_LOCKED
 | 
EXTENT_DIRTY
);

1954 ià(
»t
)

1955 
”r
 = 
»t
;

1957 
»t
 = 
	`þ—r_ex‹Á_b™s
(
io_Œ“
, 
»c
->
¡¬t
,

1958 
»c
->
¡¬t
 +„ec->
Ën
 - 1,

1959 
EXTENT_DAMAGED
);

1960 ià(
»t
 && !
”r
)

1961 
”r
 = 
»t
;

1963 
	`kä“
(
»c
);

1964  
”r
;

1965 
	}
}

1977 
	$»·œ_io_çžu»
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
šo
, u64 
¡¬t
,

1978 
u64
 
Ëngth
, u64 
logiÿl
, 
·ge
 *page,

1979 
pg_off£t
, 
mœrÜ_num
)

1981 
bio
 *bio;

1982 
bŒfs_deviû
 *
dev
;

1983 
u64
 
m­_Ëngth
 = 0;

1984 
u64
 
£ùÜ
;

1985 
bŒfs_bio
 *
bbio
 = 
NULL
;

1986 
»t
;

1988 
	`ASSERT
(!(
fs_šfo
->
sb
->
s_æags
 & 
MS_RDONLY
));

1989 
	`BUG_ON
(!
mœrÜ_num
);

1991 
bio
 = 
	`bŒfs_io_bio_®loc
(1);

1992 
bio
->
bi_™”
.
bi_size
 = 0;

1993 
m­_Ëngth
 = 
Ëngth
;

2000 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

2001 ià(
	`bŒfs_is_·r™y_mœrÜ
(
fs_šfo
, 
logiÿl
, 
Ëngth
)) {

2008 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_READ
, 
logiÿl
,

2009 &
m­_Ëngth
, &
bbio
, 0);

2010 ià(
»t
) {

2011 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2012 
	`bio_put
(
bio
);

2013  -
EIO
;

2015 
	`ASSERT
(
bbio
->
mœrÜ_num
 == 1);

2017 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_WRITE
, 
logiÿl
,

2018 &
m­_Ëngth
, &
bbio
, 
mœrÜ_num
);

2019 ià(
»t
) {

2020 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2021 
	`bio_put
(
bio
);

2022  -
EIO
;

2024 
	`BUG_ON
(
mœrÜ_num
 !ð
bbio
->mirror_num);

2027 
£ùÜ
 = 
bbio
->
¡res
[bbio->
mœrÜ_num
 - 1].
physiÿl
 >> 9;

2028 
bio
->
bi_™”
.
bi_£ùÜ
 = 
£ùÜ
;

2029 
dev
 = 
bbio
->
¡res
[bbio->
mœrÜ_num
 - 1].dev;

2030 
	`bŒfs_put_bbio
(
bbio
);

2031 ià(!
dev
 || !dev->
bdev
 || !dev->
wr™—bË
) {

2032 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2033 
	`bio_put
(
bio
);

2034  -
EIO
;

2036 
	`bio_£t_dev
(
bio
, 
dev
->
bdev
);

2037 
bio
->
bi_Ýf
 = 
REQ_OP_WRITE
 | 
REQ_SYNC
;

2038 
	`bio_add_·ge
(
bio
, 
·ge
, 
Ëngth
, 
pg_off£t
);

2040 ià(
	`bŒfsic_subm™_bio_wa™
(
bio
)) {

2042 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2043 
	`bio_put
(
bio
);

2044 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

2045  -
EIO
;

2048 
	`bŒfs_šfo_¾_š_rcu
(
fs_šfo
,

2050 
šo
, 
¡¬t
,

2051 
	`rcu_¡r_d”ef
(
dev
->
Çme
), 
£ùÜ
);

2052 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2053 
	`bio_put
(
bio
);

2055 
	}
}

2057 
	$»·œ_eb_io_çžu»
(
bŒfs_fs_šfo
 *
fs_šfo
,

2058 
ex‹Á_bufãr
 *
eb
, 
mœrÜ_num
)

2060 
u64
 
¡¬t
 = 
eb
->start;

2061 
i
, 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

2062 
»t
 = 0;

2064 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

2065  -
EROFS
;

2067 
i
 = 0; i < 
num_·ges
; i++) {

2068 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

2070 
»t
 = 
	`»·œ_io_çžu»
(
fs_šfo
, 0, 
¡¬t
, 
PAGE_SIZE
, s¹, 
p
,

2071 
¡¬t
 - 
	`·ge_off£t
(
p
), 
mœrÜ_num
);

2072 ià(
»t
)

2074 
¡¬t
 +ð
PAGE_SIZE
;

2077  
»t
;

2078 
	}
}

2084 
	$þ—n_io_çžu»
(
bŒfs_fs_šfo
 *
fs_šfo
,

2085 
ex‹Á_io_Œ“
 *
çžu»_Œ“
,

2086 
ex‹Á_io_Œ“
 *
io_Œ“
, 
u64
 
¡¬t
,

2087 
·ge
 *·ge, 
u64
 
šo
, 
pg_off£t
)

2089 
u64
 
´iv©e
;

2090 
io_çžu»_»cÜd
 *
çž»c
;

2091 
ex‹Á_¡©e
 *
¡©e
;

2092 
num_cÝ›s
;

2093 
»t
;

2095 
´iv©e
 = 0;

2096 
»t
 = 
	`couÁ_¿nge_b™s
(
çžu»_Œ“
, &
´iv©e
, (
u64
)-1, 1,

2097 
EXTENT_DIRTY
, 0);

2098 ià(!
»t
)

2101 
»t
 = 
	`g‘_¡©e_çž»c
(
çžu»_Œ“
, 
¡¬t
, &
çž»c
);

2102 ià(
»t
)

2105 
	`BUG_ON
(!
çž»c
->
this_mœrÜ
);

2107 ià(
çž»c
->
š_v®id©iÚ
) {

2109 
	`bŒfs_debug
(
fs_šfo
,

2111 
çž»c
->
¡¬t
);

2112 
out
;

2114 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

2115 
out
;

2117 
	`¥š_lock
(&
io_Œ“
->
lock
);

2118 
¡©e
 = 
	`fšd_fœ¡_ex‹Á_b™_¡©e
(
io_Œ“
,

2119 
çž»c
->
¡¬t
,

2120 
EXTENT_LOCKED
);

2121 
	`¥š_uÆock
(&
io_Œ“
->
lock
);

2123 ià(
¡©e
 && s‹->
¡¬t
 <ð
çž»c
->start &&

2124 
¡©e
->
’d
 >ð
çž»c
->
¡¬t
 + faž»c->
Ën
 - 1) {

2125 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
çž»c
->
logiÿl
,

2126 
çž»c
->
Ën
);

2127 ià(
num_cÝ›s
 > 1) {

2128 
	`»·œ_io_çžu»
(
fs_šfo
, 
šo
, 
¡¬t
, 
çž»c
->
Ën
,

2129 
çž»c
->
logiÿl
, 
·ge
, 
pg_off£t
,

2130 
çž»c
->
çžed_mœrÜ
);

2134 
out
:

2135 
	`ä“_io_çžu»
(
çžu»_Œ“
, 
io_Œ“
, 
çž»c
);

2138 
	}
}

2146 
	$bŒfs_ä“_io_çžu»_»cÜd
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
)

2148 
ex‹Á_io_Œ“
 *
çžu»_Œ“
 = &
šode
->
io_çžu»_Œ“
;

2149 
io_çžu»_»cÜd
 *
çž»c
;

2150 
ex‹Á_¡©e
 *
¡©e
, *
Ãxt
;

2152 ià(
	`RB_EMPTY_ROOT
(&
çžu»_Œ“
->
¡©e
))

2155 
	`¥š_lock
(&
çžu»_Œ“
->
lock
);

2156 
¡©e
 = 
	`fšd_fœ¡_ex‹Á_b™_¡©e
(
çžu»_Œ“
, 
¡¬t
, 
EXTENT_DIRTY
);

2157 
¡©e
) {

2158 ià(
¡©e
->
¡¬t
 > 
’d
)

2161 
	`ASSERT
(
¡©e
->
’d
 <=ƒnd);

2163 
Ãxt
 = 
	`Ãxt_¡©e
(
¡©e
);

2165 
çž»c
 = 
¡©e
->failrec;

2166 
	`ä“_ex‹Á_¡©e
(
¡©e
);

2167 
	`kä“
(
çž»c
);

2169 
¡©e
 = 
Ãxt
;

2171 
	`¥š_uÆock
(&
çžu»_Œ“
->
lock
);

2172 
	}
}

2174 
	$bŒfs_g‘_io_çžu»_»cÜd
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

2175 
io_çžu»_»cÜd
 **
çž»c_»t
)

2177 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2178 
io_çžu»_»cÜd
 *
çž»c
;

2179 
ex‹Á_m­
 *
em
;

2180 
ex‹Á_io_Œ“
 *
çžu»_Œ“
 = &
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
;

2181 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

2182 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

2183 
»t
;

2184 
u64
 
logiÿl
;

2186 
»t
 = 
	`g‘_¡©e_çž»c
(
çžu»_Œ“
, 
¡¬t
, &
çž»c
);

2187 ià(
»t
) {

2188 
çž»c
 = 
	`kz®loc
((*çž»c), 
GFP_NOFS
);

2189 ià(!
çž»c
)

2190  -
ENOMEM
;

2192 
çž»c
->
¡¬t
 = start;

2193 
çž»c
->
Ën
 = 
’d
 - 
¡¬t
 + 1;

2194 
çž»c
->
this_mœrÜ
 = 0;

2195 
çž»c
->
bio_æags
 = 0;

2196 
çž»c
->
š_v®id©iÚ
 = 0;

2198 
	`»ad_lock
(&
em_Œ“
->
lock
);

2199 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
çž»c
->
Ën
);

2200 ià(!
em
) {

2201 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

2202 
	`kä“
(
çž»c
);

2203  -
EIO
;

2206 ià(
em
->
¡¬t
 > s¹ ||ƒm->¡¬ˆ+ƒm->
Ën
 <= start) {

2207 
	`ä“_ex‹Á_m­
(
em
);

2208 
em
 = 
NULL
;

2210 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

2211 ià(!
em
) {

2212 
	`kä“
(
çž»c
);

2213  -
EIO
;

2216 
logiÿl
 = 
¡¬t
 - 
em
->start;

2217 
logiÿl
 = 
em
->
block_¡¬t
 +†ogical;

2218 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
)) {

2219 
logiÿl
 = 
em
->
block_¡¬t
;

2220 
çž»c
->
bio_æags
 = 
EXTENT_BIO_COMPRESSED
;

2221 
	`ex‹Á_£t_com´ess_ty³
(&
çž»c
->
bio_æags
,

2222 
em
->
com´ess_ty³
);

2225 
	`bŒfs_debug
(
fs_šfo
,

2227 
logiÿl
, 
¡¬t
, 
çž»c
->
Ën
);

2229 
çž»c
->
logiÿl
 =†ogical;

2230 
	`ä“_ex‹Á_m­
(
em
);

2233 
»t
 = 
	`£t_ex‹Á_b™s
(
çžu»_Œ“
, 
¡¬t
, 
’d
,

2234 
EXTENT_LOCKED
 | 
EXTENT_DIRTY
);

2235 ià(
»t
 >= 0)

2236 
»t
 = 
	`£t_¡©e_çž»c
(
çžu»_Œ“
, 
¡¬t
, 
çž»c
);

2238 ià(
»t
 >= 0)

2239 
»t
 = 
	`£t_ex‹Á_b™s
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_DAMAGED
);

2240 ià(
»t
 < 0) {

2241 
	`kä“
(
çž»c
);

2242  
»t
;

2245 
	`bŒfs_debug
(
fs_šfo
,

2247 
çž»c
->
logiÿl
, faž»c->
¡¬t
, faž»c->
Ën
,

2248 
çž»c
->
š_v®id©iÚ
);

2256 *
çž»c_»t
 = 
çž»c
;

2259 
	}
}

2261 
boÞ
 
	$bŒfs_check_»·œabË
(
šode
 *šode, 
bio
 *
çžed_bio
,

2262 
io_çžu»_»cÜd
 *
çž»c
, 
çžed_mœrÜ
)

2264 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2265 
num_cÝ›s
;

2267 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
çž»c
->
logiÿl
, faž»c->
Ën
);

2268 ià(
num_cÝ›s
 == 1) {

2274 
	`bŒfs_debug
(
fs_šfo
,

2276 
num_cÝ›s
, 
çž»c
->
this_mœrÜ
, 
çžed_mœrÜ
);

2277  
çl£
;

2285 ià(
çžed_bio
->
bi_vút
 > 1) {

2294 
	`BUG_ON
(
çž»c
->
š_v®id©iÚ
);

2295 
çž»c
->
š_v®id©iÚ
 = 1;

2296 
çž»c
->
this_mœrÜ
 = 
çžed_mœrÜ
;

2303 ià(
çž»c
->
š_v®id©iÚ
) {

2304 
	`BUG_ON
(
çž»c
->
this_mœrÜ
 !ð
çžed_mœrÜ
);

2305 
çž»c
->
š_v®id©iÚ
 = 0;

2306 
çž»c
->
this_mœrÜ
 = 0;

2308 
çž»c
->
çžed_mœrÜ
 = failed_mirror;

2309 
çž»c
->
this_mœrÜ
++;

2310 ià(
çž»c
->
this_mœrÜ
 =ð
çžed_mœrÜ
)

2311 
çž»c
->
this_mœrÜ
++;

2314 ià(
çž»c
->
this_mœrÜ
 > 
num_cÝ›s
) {

2315 
	`bŒfs_debug
(
fs_šfo
,

2317 
num_cÝ›s
, 
çž»c
->
this_mœrÜ
, 
çžed_mœrÜ
);

2318  
çl£
;

2321  
Œue
;

2322 
	}
}

2325 
bio
 *
	$bŒfs_ü—‹_»·œ_bio
(
šode
 *šode, 
bio
 *
çžed_bio
,

2326 
io_çžu»_»cÜd
 *
çž»c
,

2327 
·ge
 *·ge, 
pg_off£t
, 
icsum
,

2328 
bio_’d_io_t
 *
’dio_func
, *
d©a
)

2330 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2331 
bio
 *bio;

2332 
bŒfs_io_bio
 *
bŒfs_çžed_bio
;

2333 
bŒfs_io_bio
 *
bŒfs_bio
;

2335 
bio
 = 
	`bŒfs_io_bio_®loc
(1);

2336 
bio
->
bi_’d_io
 = 
’dio_func
;

2337 
bio
->
bi_™”
.
bi_£ùÜ
 = 
çž»c
->
logiÿl
 >> 9;

2338 
	`bio_£t_dev
(
bio
, 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
);

2339 
bio
->
bi_™”
.
bi_size
 = 0;

2340 
bio
->
bi_´iv©e
 = 
d©a
;

2342 
bŒfs_çžed_bio
 = 
	`bŒfs_io_bio
(
çžed_bio
);

2343 ià(
bŒfs_çžed_bio
->
csum
) {

2344 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

2346 
bŒfs_bio
 = 
	`bŒfs_io_bio
(
bio
);

2347 
bŒfs_bio
->
csum
 = bŒfs_bio->
csum_šlše
;

2348 
icsum
 *ð
csum_size
;

2349 
	`memýy
(
bŒfs_bio
->
csum
, 
bŒfs_çžed_bio
->csum + 
icsum
,

2350 
csum_size
);

2353 
	`bio_add_·ge
(
bio
, 
·ge
, 
çž»c
->
Ën
, 
pg_off£t
);

2355  
bio
;

2356 
	}
}

2366 
	$bio_»ad·ge_”rÜ
(
bio
 *
çžed_bio
, 
u64
 
phy_off£t
,

2367 
·ge
 *·ge, 
u64
 
¡¬t
, u64 
’d
,

2368 
çžed_mœrÜ
)

2370 
io_çžu»_»cÜd
 *
çž»c
;

2371 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

2372 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

2373 
ex‹Á_io_Œ“
 *
çžu»_Œ“
 = &
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
;

2374 
bio
 *bio;

2375 
»ad_mode
 = 0;

2376 
blk_¡©us_t
 
¡©us
;

2377 
»t
;

2379 
	`BUG_ON
(
	`bio_Ý
(
çžed_bio
è=ð
REQ_OP_WRITE
);

2381 
»t
 = 
	`bŒfs_g‘_io_çžu»_»cÜd
(
šode
, 
¡¬t
, 
’d
, &
çž»c
);

2382 ià(
»t
)

2383  
»t
;

2385 ià(!
	`bŒfs_check_»·œabË
(
šode
, 
çžed_bio
, 
çž»c
,

2386 
çžed_mœrÜ
)) {

2387 
	`ä“_io_çžu»
(
çžu»_Œ“
, 
Œ“
, 
çž»c
);

2388  -
EIO
;

2391 ià(
çžed_bio
->
bi_vút
 > 1)

2392 
»ad_mode
 |ð
REQ_FAILFAST_DEV
;

2394 
phy_off£t
 >>ð
šode
->
i_sb
->
s_blocksize_b™s
;

2395 
bio
 = 
	`bŒfs_ü—‹_»·œ_bio
(
šode
, 
çžed_bio
, 
çž»c
, 
·ge
,

2396 
¡¬t
 - 
	`·ge_off£t
(
·ge
),

2397 ()
phy_off£t
, 
çžed_bio
->
bi_’d_io
,

2398 
NULL
);

2399 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 
»ad_mode
);

2401 
	`bŒfs_debug
(
	`bŒfs_sb
(
šode
->
i_sb
),

2403 
»ad_mode
, 
çž»c
->
this_mœrÜ
, faž»c->
š_v®id©iÚ
);

2405 
¡©us
 = 
Œ“
->
Ýs
->
	`subm™_bio_hook
Ñ»e->
´iv©e_d©a
, 
bio
, 
çž»c
->
this_mœrÜ
,

2406 
çž»c
->
bio_æags
, 0);

2407 ià(
¡©us
) {

2408 
	`ä“_io_çžu»
(
çžu»_Œ“
, 
Œ“
, 
çž»c
);

2409 
	`bio_put
(
bio
);

2410 
»t
 = 
	`blk_¡©us_to_”ºo
(
¡©us
);

2413  
»t
;

2414 
	}
}

2418 
	$’d_ex‹Á_wr™•age
(
·ge
 *·ge, 
”r
, 
u64
 
¡¬t
, u64 
’d
)

2420 
u±od©e
 = (
”r
 == 0);

2421 
ex‹Á_io_Œ“
 *
Œ“
;

2422 
»t
 = 0;

2424 
Œ“
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
io_Œ“
;

2426 ià(
Œ“
->
Ýs
 &&»e->Ýs->
wr™•age_’d_io_hook
)

2427 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
·ge
, 
¡¬t
, 
’d
, 
NULL
,

2428 
u±od©e
);

2430 ià(!
u±od©e
) {

2431 
	`CË¬PageU±od©e
(
·ge
);

2432 
	`S‘PageE¼Ü
(
·ge
);

2433 
»t
 = 
”r
 < 0 ?ƒ¼ : -
EIO
;

2434 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, 
»t
);

2436 
	}
}

2447 
	$’d_bio_ex‹Á_wr™•age
(
bio
 *bio)

2449 
”rÜ
 = 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
);

2450 
bio_vec
 *
bvec
;

2451 
u64
 
¡¬t
;

2452 
u64
 
’d
;

2453 
i
;

2455 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

2456 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

2457 
·ge
 *·gð
bvec
->
bv_·ge
;

2458 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

2459 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2466 ià(
bvec
->
bv_off£t
 || bvec->
bv_Ën
 !ð
PAGE_SIZE
) {

2467 ià(
bvec
->
bv_off£t
 + bvec->
bv_Ën
 !ð
PAGE_SIZE
)

2468 
	`bŒfs_”r
(
fs_šfo
,

2470 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

2472 
	`bŒfs_šfo
(
fs_šfo
,

2474 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

2477 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

2478 
’d
 = 
¡¬t
 + 
bvec
->
bv_off£t
 + bvec->
bv_Ën
 - 1;

2480 
	`’d_ex‹Á_wr™•age
(
·ge
, 
”rÜ
, 
¡¬t
, 
’d
);

2481 
	`’d_·ge_wr™eback
(
·ge
);

2484 
	`bio_put
(
bio
);

2485 
	}
}

2488 
	$’dio_»ad·ge_»Ëa£_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
Ën
,

2489 
u±od©e
)

2491 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

2492 
u64
 
’d
 = 
¡¬t
 + 
Ën
 - 1;

2494 ià(
u±od©e
 && 
Œ“
->
Œack_u±od©e
)

2495 
	`£t_ex‹Á_u±od©e
(
Œ“
, 
¡¬t
, 
’d
, &
ÿched
, 
GFP_ATOMIC
);

2496 
	`uÆock_ex‹Á_ÿched
(
Œ“
, 
¡¬t
, 
’d
, &
ÿched
, 
GFP_ATOMIC
);

2497 
	}
}

2510 
	$’d_bio_ex‹Á_»ad·ge
(
bio
 *bio)

2512 
bio_vec
 *
bvec
;

2513 
u±od©e
 = !
bio
->
bi_¡©us
;

2514 
bŒfs_io_bio
 *
io_bio
 = 
	`bŒfs_io_bio
(
bio
);

2515 
ex‹Á_io_Œ“
 *
Œ“
, *
çžu»_Œ“
;

2516 
u64
 
off£t
 = 0;

2517 
u64
 
¡¬t
;

2518 
u64
 
’d
;

2519 
u64
 
Ën
;

2520 
u64
 
ex‹Á_¡¬t
 = 0;

2521 
u64
 
ex‹Á_Ën
 = 0;

2522 
mœrÜ
;

2523 
»t
;

2524 
i
;

2526 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

2527 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

2528 
·ge
 *·gð
bvec
->
bv_·ge
;

2529 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

2530 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2532 
	`bŒfs_debug
(
fs_šfo
,

2534 (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
, bio->
bi_¡©us
,

2535 
io_bio
->
mœrÜ_num
);

2536 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

2537 
çžu»_Œ“
 = &
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
;

2544 ià(
bvec
->
bv_off£t
 || bvec->
bv_Ën
 !ð
PAGE_SIZE
) {

2545 ià(
bvec
->
bv_off£t
 + bvec->
bv_Ën
 !ð
PAGE_SIZE
)

2546 
	`bŒfs_”r
(
fs_šfo
,

2548 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

2550 
	`bŒfs_šfo
(
fs_šfo
,

2552 
bvec
->
bv_off£t
, bvec->
bv_Ën
);

2555 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

2556 
’d
 = 
¡¬t
 + 
bvec
->
bv_off£t
 + bvec->
bv_Ën
 - 1;

2557 
Ën
 = 
bvec
->
bv_Ën
;

2559 
mœrÜ
 = 
io_bio
->
mœrÜ_num
;

2560 ià(
	`lik–y
(
u±od©e
 && 
Œ“
->
Ýs
)) {

2561 
»t
 = 
Œ“
->
Ýs
->
	`»ad·ge_’d_io_hook
(
io_bio
, 
off£t
,

2562 
·ge
, 
¡¬t
, 
’d
,

2563 
mœrÜ
);

2564 ià(
»t
)

2565 
u±od©e
 = 0;

2567 
	`þ—n_io_çžu»
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

2568 
çžu»_Œ“
, 
Œ“
, 
¡¬t
,

2569 
·ge
,

2570 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 0);

2573 ià(
	`lik–y
(
u±od©e
))

2574 
»ad·ge_ok
;

2576 ià(
Œ“
->
Ýs
) {

2577 
»t
 = 
Œ“
->
Ýs
->
	`»ad·ge_io_çžed_hook
(
·ge
, 
mœrÜ
);

2578 ià(
»t
 =ð-
EAGAIN
) {

2593 
»t
 = 
	`bio_»ad·ge_”rÜ
(
bio
, 
off£t
, 
·ge
,

2594 
¡¬t
, 
’d
, 
mœrÜ
);

2595 ià(
»t
 == 0) {

2596 
u±od©e
 = !
bio
->
bi_¡©us
;

2597 
off£t
 +ð
Ën
;

2607 
	`ASSERT
(
»t
 =ð-
EIO
);

2609 
»ad·ge_ok
:

2610 ià(
	`lik–y
(
u±od©e
)) {

2611 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

2612 
pgoff_t
 
’d_šdex
 = 
i_size
 >> 
PAGE_SHIFT
;

2613 
off
;

2616 
off
 = 
i_size
 & (
PAGE_SIZE
-1);

2617 ià(
·ge
->
šdex
 =ð
’d_šdex
 && 
off
)

2618 
	`z”o_u£r_£gm’t
(
·ge
, 
off
, 
PAGE_SIZE
);

2619 
	`S‘PageU±od©e
(
·ge
);

2621 
	`CË¬PageU±od©e
(
·ge
);

2622 
	`S‘PageE¼Ü
(
·ge
);

2624 
	`uÆock_·ge
(
·ge
);

2625 
off£t
 +ð
Ën
;

2627 ià(
	`uÆik–y
(!
u±od©e
)) {

2628 ià(
ex‹Á_Ën
) {

2629 
	`’dio_»ad·ge_»Ëa£_ex‹Á
(
Œ“
,

2630 
ex‹Á_¡¬t
,

2631 
ex‹Á_Ën
, 1);

2632 
ex‹Á_¡¬t
 = 0;

2633 
ex‹Á_Ën
 = 0;

2635 
	`’dio_»ad·ge_»Ëa£_ex‹Á
(
Œ“
, 
¡¬t
,

2636 
’d
 - 
¡¬t
 + 1, 0);

2637 } ià(!
ex‹Á_Ën
) {

2638 
ex‹Á_¡¬t
 = 
¡¬t
;

2639 
ex‹Á_Ën
 = 
’d
 + 1 - 
¡¬t
;

2640 } ià(
ex‹Á_¡¬t
 + 
ex‹Á_Ën
 =ð
¡¬t
) {

2641 
ex‹Á_Ën
 +ð
’d
 + 1 - 
¡¬t
;

2643 
	`’dio_»ad·ge_»Ëa£_ex‹Á
(
Œ“
, 
ex‹Á_¡¬t
,

2644 
ex‹Á_Ën
, 
u±od©e
);

2645 
ex‹Á_¡¬t
 = 
¡¬t
;

2646 
ex‹Á_Ën
 = 
’d
 + 1 - 
¡¬t
;

2650 ià(
ex‹Á_Ën
)

2651 
	`’dio_»ad·ge_»Ëa£_ex‹Á
(
Œ“
, 
ex‹Á_¡¬t
, 
ex‹Á_Ën
,

2652 
u±od©e
);

2653 ià(
io_bio
->
’d_io
)

2654 
io_bio
->
	`’d_io
(io_bio, 
	`blk_¡©us_to_”ºo
(
bio
->
bi_¡©us
));

2655 
	`bio_put
(
bio
);

2656 
	}
}

2663 
šlše
 
	$bŒfs_io_bio_š™
(
bŒfs_io_bio
 *
bŒfs_bio
)

2665 
	`mem£t
(
bŒfs_bio
, 0, 
	`off£tof
(
bŒfs_io_bio
, 
bio
));

2666 
	}
}

2673 
bio
 *
	$bŒfs_bio_®loc
(
block_deviû
 *
bdev
, 
u64
 
fœ¡_by‹
)

2675 
bio
 *bio;

2677 
bio
 = 
	`bio_®loc_bio£t
(
GFP_NOFS
, 
BIO_MAX_PAGES
, 
bŒfs_bio£t
);

2678 
	`bio_£t_dev
(
bio
, 
bdev
);

2679 
bio
->
bi_™”
.
bi_£ùÜ
 = 
fœ¡_by‹
 >> 9;

2680 
	`bŒfs_io_bio_š™
(
	`bŒfs_io_bio
(
bio
));

2681  
bio
;

2682 
	}
}

2684 
bio
 *
	$bŒfs_bio_þÚe
(
bio
 *bio)

2686 
bŒfs_io_bio
 *
bŒfs_bio
;

2687 
bio
 *
Ãw
;

2690 
Ãw
 = 
	`bio_þÚe_ç¡
(
bio
, 
GFP_NOFS
, 
bŒfs_bio£t
);

2691 
bŒfs_bio
 = 
	`bŒfs_io_bio
(
Ãw
);

2692 
	`bŒfs_io_bio_š™
(
bŒfs_bio
);

2693 
bŒfs_bio
->
™”
 = 
bio
->
bi_™”
;

2694  
Ãw
;

2695 
	}
}

2697 
bio
 *
	$bŒfs_io_bio_®loc
(
Ä_iovecs
)

2699 
bio
 *bio;

2702 
bio
 = 
	`bio_®loc_bio£t
(
GFP_NOFS
, 
Ä_iovecs
, 
bŒfs_bio£t
);

2703 
	`bŒfs_io_bio_š™
(
	`bŒfs_io_bio
(
bio
));

2704  
bio
;

2705 
	}
}

2707 
bio
 *
	$bŒfs_bio_þÚe_·¹Ÿl
(
bio
 *
Üig
, 
off£t
, 
size
)

2709 
bio
 *bio;

2710 
bŒfs_io_bio
 *
bŒfs_bio
;

2713 
bio
 = 
	`bio_þÚe_ç¡
(
Üig
, 
GFP_NOFS
, 
bŒfs_bio£t
);

2714 
	`ASSERT
(
bio
);

2716 
bŒfs_bio
 = 
	`bŒfs_io_bio
(
bio
);

2717 
	`bŒfs_io_bio_š™
(
bŒfs_bio
);

2719 
	`bio_Œim
(
bio
, 
off£t
 >> 9, 
size
 >> 9);

2720 
bŒfs_bio
->
™”
 = 
bio
->
bi_™”
;

2721  
bio
;

2722 
	}
}

2724 
__mu¡_check
 
	$subm™_Úe_bio
(
bio
 *bio, 
mœrÜ_num
,

2725 
bio_æags
)

2727 
blk_¡©us_t
 
»t
 = 0;

2728 
bio_vec
 *
bvec
 = 
bio
->
bi_io_vec
 + bio->
bi_vút
 - 1;

2729 
·ge
 *·gð
bvec
->
bv_·ge
;

2730 
ex‹Á_io_Œ“
 *
Œ“
 = 
bio
->
bi_´iv©e
;

2731 
u64
 
¡¬t
;

2733 
¡¬t
 = 
	`·ge_off£t
(
·ge
è+ 
bvec
->
bv_off£t
;

2735 
bio
->
bi_´iv©e
 = 
NULL
;

2736 
	`bio_g‘
(
bio
);

2738 ià(
Œ“
->
Ýs
)

2739 
»t
 = 
Œ“
->
Ýs
->
	`subm™_bio_hook
Ñ»e->
´iv©e_d©a
, 
bio
,

2740 
mœrÜ_num
, 
bio_æags
, 
¡¬t
);

2742 
	`bŒfsic_subm™_bio
(
bio
);

2744 
	`bio_put
(
bio
);

2745  
	`blk_¡©us_to_”ºo
(
»t
);

2746 
	}
}

2748 
	$m”ge_bio
(
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

2749 
off£t
, 
size_t
 
size
, 
bio
 *bio,

2750 
bio_æags
)

2752 
»t
 = 0;

2753 ià(
Œ“
->
Ýs
)

2754 
»t
 = 
Œ“
->
Ýs
->
	`m”ge_bio_hook
(
·ge
, 
off£t
, 
size
, 
bio
,

2755 
bio_æags
);

2756  
»t
;

2758 
	}
}

2763 
	$subm™_ex‹Á_·ge
(
Ýf
, 
ex‹Á_io_Œ“
 *
Œ“
,

2764 
wr™eback_cÚŒÞ
 *
wbc
,

2765 
·ge
 *·ge, 
£ùÜ_t
 
£ùÜ
,

2766 
size_t
 
size
, 
off£t
,

2767 
block_deviû
 *
bdev
,

2768 
bio
 **
bio_»t
,

2769 
bio_’d_io_t
 
’d_io_func
,

2770 
mœrÜ_num
,

2771 
´ev_bio_æags
,

2772 
bio_æags
,

2773 
boÞ
 
fÜû_bio_subm™
)

2775 
»t
 = 0;

2776 
bio
 *bio;

2777 
cÚtig
 = 0;

2778 
Þd_com´es£d
 = 
´ev_bio_æags
 & 
EXTENT_BIO_COMPRESSED
;

2779 
size_t
 
·ge_size
 = 
	`mš_t
(size_t, 
size
, 
PAGE_SIZE
);

2781 ià(
bio_»t
 && *bio_ret) {

2782 
bio
 = *
bio_»t
;

2783 ià(
Þd_com´es£d
)

2784 
cÚtig
 = 
bio
->
bi_™”
.
bi_£ùÜ
 =ð
£ùÜ
;

2786 
cÚtig
 = 
	`bio_’d_£ùÜ
(
bio
è=ð
£ùÜ
;

2788 ià(
´ev_bio_æags
 !ð
bio_æags
 || !
cÚtig
 ||

2789 
fÜû_bio_subm™
 ||

2790 
	`m”ge_bio
(
Œ“
, 
·ge
, 
off£t
, 
·ge_size
, 
bio
, 
bio_æags
) ||

2791 
	`bio_add_·ge
(
bio
, 
·ge
, 
·ge_size
, 
off£t
) <…age_size) {

2792 
»t
 = 
	`subm™_Úe_bio
(
bio
, 
mœrÜ_num
, 
´ev_bio_æags
);

2793 ià(
»t
 < 0) {

2794 *
bio_»t
 = 
NULL
;

2795  
»t
;

2797 
bio
 = 
NULL
;

2799 ià(
wbc
)

2800 
	`wbc_accouÁ_io
(
wbc
, 
·ge
, 
·ge_size
);

2805 
bio
 = 
	`bŒfs_bio_®loc
(
bdev
, (
u64
)
£ùÜ
 << 9);

2806 
	`bio_add_·ge
(
bio
, 
·ge
, 
·ge_size
, 
off£t
);

2807 
bio
->
bi_’d_io
 = 
’d_io_func
;

2808 
bio
->
bi_´iv©e
 = 
Œ“
;

2809 
bio
->
bi_wr™e_hšt
 = 
·ge
->
m­pšg
->
ho¡
->
i_wr™e_hšt
;

2810 
bio
->
bi_Ýf
 = 
Ýf
;

2811 ià(
wbc
) {

2812 
	`wbc_š™_bio
(
wbc
, 
bio
);

2813 
	`wbc_accouÁ_io
(
wbc
, 
·ge
, 
·ge_size
);

2816 ià(
bio_»t
)

2817 *
bio_»t
 = 
bio
;

2819 
»t
 = 
	`subm™_Úe_bio
(
bio
, 
mœrÜ_num
, 
bio_æags
);

2821  
»t
;

2822 
	}
}

2824 
	$©ch_ex‹Á_bufãr_·ge
(
ex‹Á_bufãr
 *
eb
,

2825 
·ge
 *page)

2827 ià(!
	`PagePriv©e
(
·ge
)) {

2828 
	`S‘PagePriv©e
(
·ge
);

2829 
	`g‘_·ge
(
·ge
);

2830 
	`£t_·ge_´iv©e
(
·ge
, ()
eb
);

2832 
	`WARN_ON
(
·ge
->
´iv©e
 !ð()
eb
);

2834 
	}
}

2836 
	$£t_·ge_ex‹Á_m­³d
(
·ge
 *page)

2838 ià(!
	`PagePriv©e
(
·ge
)) {

2839 
	`S‘PagePriv©e
(
·ge
);

2840 
	`g‘_·ge
(
·ge
);

2841 
	`£t_·ge_´iv©e
(
·ge
, 
EXTENT_PAGE_PRIVATE
);

2843 
	}
}

2845 
ex‹Á_m­
 *

2846 
	$__g‘_ex‹Á_m­
(
šode
 *šode, 
·ge
 *·ge, 
size_t
 
pg_off£t
,

2847 
u64
 
¡¬t
, u64 
Ën
, 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

2848 
ex‹Á_m­
 **
em_ÿched
)

2850 
ex‹Á_m­
 *
em
;

2852 ià(
em_ÿched
 && *em_cached) {

2853 
em
 = *
em_ÿched
;

2854 ià(
	`ex‹Á_m­_š_Œ“
(
em
è&& 
¡¬t
 >=ƒm->start &&

2855 
¡¬t
 < 
	`ex‹Á_m­_’d
(
em
)) {

2856 
	`»fcouÁ_šc
(&
em
->
»fs
);

2857  
em
;

2860 
	`ä“_ex‹Á_m­
(
em
);

2861 *
em_ÿched
 = 
NULL
;

2864 
em
 = 
	`g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
·ge
, 
pg_off£t
, 
¡¬t
, 
Ën
, 0);

2865 ià(
em_ÿched
 && !
	`IS_ERR_OR_NULL
(
em
)) {

2866 
	`BUG_ON
(*
em_ÿched
);

2867 
	`»fcouÁ_šc
(&
em
->
»fs
);

2868 *
em_ÿched
 = 
em
;

2870  
em
;

2871 
	}
}

2879 
	$__do_»ad·ge
(
ex‹Á_io_Œ“
 *
Œ“
,

2880 
·ge
 *page,

2881 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

2882 
ex‹Á_m­
 **
em_ÿched
,

2883 
bio
 **bio, 
mœrÜ_num
,

2884 *
bio_æags
, 
»ad_æags
,

2885 
u64
 *
´ev_em_¡¬t
)

2887 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

2888 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

2889 
u64
 
·ge_’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

2890 
u64
 
’d
;

2891 
u64
 
cur
 = 
¡¬t
;

2892 
u64
 
ex‹Á_off£t
;

2893 
u64
 
Ï¡_by‹
 = 
	`i_size_»ad
(
šode
);

2894 
u64
 
block_¡¬t
;

2895 
u64
 
cur_’d
;

2896 
£ùÜ_t
 
£ùÜ
;

2897 
ex‹Á_m­
 *
em
;

2898 
block_deviû
 *
bdev
;

2899 
»t
 = 0;

2900 
Ä
 = 0;

2901 
size_t
 
pg_off£t
 = 0;

2902 
size_t
 
iosize
;

2903 
size_t
 
disk_io_size
;

2904 
size_t
 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

2905 
this_bio_æag
 = 0;

2907 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

2909 
’d
 = 
·ge_’d
;

2910 ià(!
	`PageU±od©e
(
·ge
)) {

2911 ià(
	`þ—nÿche_g‘_·ge
(
·ge
) == 0) {

2912 
	`BUG_ON
(
blocksize
 !ð
PAGE_SIZE
);

2913 
	`uÆock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
);

2914 
out
;

2918 ià(
·ge
->
šdex
 =ð
Ï¡_by‹
 >> 
PAGE_SHIFT
) {

2919 *
u£½age
;

2920 
size_t
 
z”o_off£t
 = 
Ï¡_by‹
 & (
PAGE_SIZE
 - 1);

2922 ià(
z”o_off£t
) {

2923 
iosize
 = 
PAGE_SIZE
 - 
z”o_off£t
;

2924 
u£½age
 = 
	`km­_©omic
(
·ge
);

2925 
	`mem£t
(
u£½age
 + 
z”o_off£t
, 0, 
iosize
);

2926 
	`æush_dÿche_·ge
(
·ge
);

2927 
	`kunm­_©omic
(
u£½age
);

2930 
cur
 <ð
’d
) {

2931 
boÞ
 
fÜû_bio_subm™
 = 
çl£
;

2933 ià(
cur
 >ð
Ï¡_by‹
) {

2934 *
u£½age
;

2935 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

2937 
iosize
 = 
PAGE_SIZE
 - 
pg_off£t
;

2938 
u£½age
 = 
	`km­_©omic
(
·ge
);

2939 
	`mem£t
(
u£½age
 + 
pg_off£t
, 0, 
iosize
);

2940 
	`æush_dÿche_·ge
(
·ge
);

2941 
	`kunm­_©omic
(
u£½age
);

2942 
	`£t_ex‹Á_u±od©e
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1,

2943 &
ÿched
, 
GFP_NOFS
);

2944 
	`uÆock_ex‹Á_ÿched
(
Œ“
, 
cur
,

2945 
cur
 + 
iosize
 - 1,

2946 &
ÿched
, 
GFP_NOFS
);

2949 
em
 = 
	`__g‘_ex‹Á_m­
(
šode
, 
·ge
, 
pg_off£t
, 
cur
,

2950 
’d
 - 
cur
 + 1, 
g‘_ex‹Á
, 
em_ÿched
);

2951 ià(
	`IS_ERR_OR_NULL
(
em
)) {

2952 
	`S‘PageE¼Ü
(
·ge
);

2953 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, 
’d
);

2956 
ex‹Á_off£t
 = 
cur
 - 
em
->
¡¬t
;

2957 
	`BUG_ON
(
	`ex‹Á_m­_’d
(
em
è<ð
cur
);

2958 
	`BUG_ON
(
’d
 < 
cur
);

2960 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
)) {

2961 
this_bio_æag
 |ð
EXTENT_BIO_COMPRESSED
;

2962 
	`ex‹Á_£t_com´ess_ty³
(&
this_bio_æag
,

2963 
em
->
com´ess_ty³
);

2966 
iosize
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
è- 
cur
, 
’d
 - cur + 1);

2967 
cur_’d
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
è- 1, 
’d
);

2968 
iosize
 = 
	`ALIGN
(iosize, 
blocksize
);

2969 ià(
this_bio_æag
 & 
EXTENT_BIO_COMPRESSED
) {

2970 
disk_io_size
 = 
em
->
block_Ën
;

2971 
£ùÜ
 = 
em
->
block_¡¬t
 >> 9;

2973 
£ùÜ
 = (
em
->
block_¡¬t
 + 
ex‹Á_off£t
) >> 9;

2974 
disk_io_size
 = 
iosize
;

2976 
bdev
 = 
em
->bdev;

2977 
block_¡¬t
 = 
em
->block_start;

2978 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

2979 
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

3015 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
) &&

3016 
´ev_em_¡¬t
 && *´ev_em_¡¬ˆ!ð(
u64
)-1 &&

3017 *
´ev_em_¡¬t
 !ð
em
->
Üig_¡¬t
)

3018 
fÜû_bio_subm™
 = 
Œue
;

3020 ià(
´ev_em_¡¬t
)

3021 *
´ev_em_¡¬t
 = 
em
->
Üig_¡¬t
;

3023 
	`ä“_ex‹Á_m­
(
em
);

3024 
em
 = 
NULL
;

3027 ià(
block_¡¬t
 =ð
EXTENT_MAP_HOLE
) {

3028 *
u£½age
;

3029 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

3031 
u£½age
 = 
	`km­_©omic
(
·ge
);

3032 
	`mem£t
(
u£½age
 + 
pg_off£t
, 0, 
iosize
);

3033 
	`æush_dÿche_·ge
(
·ge
);

3034 
	`kunm­_©omic
(
u£½age
);

3036 
	`£t_ex‹Á_u±od©e
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1,

3037 &
ÿched
, 
GFP_NOFS
);

3038 
	`uÆock_ex‹Á_ÿched
(
Œ“
, 
cur
,

3039 
cur
 + 
iosize
 - 1,

3040 &
ÿched
, 
GFP_NOFS
);

3041 
cur
 = cu¸+ 
iosize
;

3042 
pg_off£t
 +ð
iosize
;

3046 ià(
	`‹¡_¿nge_b™
(
Œ“
, 
cur
, 
cur_’d
,

3047 
EXTENT_UPTODATE
, 1, 
NULL
)) {

3048 
	`check_·ge_u±od©e
(
Œ“
, 
·ge
);

3049 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1);

3050 
cur
 = cu¸+ 
iosize
;

3051 
pg_off£t
 +ð
iosize
;

3057 ià(
block_¡¬t
 =ð
EXTENT_MAP_INLINE
) {

3058 
	`S‘PageE¼Ü
(
·ge
);

3059 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1);

3060 
cur
 = cu¸+ 
iosize
;

3061 
pg_off£t
 +ð
iosize
;

3065 
»t
 = 
	`subm™_ex‹Á_·ge
(
REQ_OP_READ
 | 
»ad_æags
, 
Œ“
, 
NULL
,

3066 
·ge
, 
£ùÜ
, 
disk_io_size
, 
pg_off£t
,

3067 
bdev
, 
bio
,

3068 
’d_bio_ex‹Á_»ad·ge
, 
mœrÜ_num
,

3069 *
bio_æags
,

3070 
this_bio_æag
,

3071 
fÜû_bio_subm™
);

3072 ià(!
»t
) {

3073 
Ä
++;

3074 *
bio_æags
 = 
this_bio_æag
;

3076 
	`S‘PageE¼Ü
(
·ge
);

3077 
	`uÆock_ex‹Á
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1);

3078 
out
;

3080 
cur
 = cu¸+ 
iosize
;

3081 
pg_off£t
 +ð
iosize
;

3083 
out
:

3084 ià(!
Ä
) {

3085 ià(!
	`PageE¼Ü
(
·ge
))

3086 
	`S‘PageU±od©e
(
·ge
);

3087 
	`uÆock_·ge
(
·ge
);

3089  
»t
;

3090 
	}
}

3092 
šlše
 
	$__do_cÚtiguous_»ad·ges
(
ex‹Á_io_Œ“
 *
Œ“
,

3093 
·ge
 *
·ges
[], 
Ä_·ges
,

3094 
u64
 
¡¬t
, u64 
’d
,

3095 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

3096 
ex‹Á_m­
 **
em_ÿched
,

3097 
bio
 **bio, 
mœrÜ_num
,

3098 *
bio_æags
,

3099 
u64
 *
´ev_em_¡¬t
)

3101 
šode
 *inode;

3102 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

3103 
šdex
;

3105 
šode
 = 
·ges
[0]->
m­pšg
->
ho¡
;

3107 
	`lock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
);

3108 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
,

3109 
’d
 - 
¡¬t
 + 1);

3110 ià(!
Üd”ed
)

3112 
	`uÆock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
);

3113 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

3114 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

3117 
šdex
 = 0; index < 
Ä_·ges
; index++) {

3118 
	`__do_»ad·ge
(
Œ“
, 
·ges
[
šdex
], 
g‘_ex‹Á
, 
em_ÿched
, 
bio
,

3119 
mœrÜ_num
, 
bio_æags
, 0, 
´ev_em_¡¬t
);

3120 
	`put_·ge
(
·ges
[
šdex
]);

3122 
	}
}

3124 
	$__ex‹Á_»ad·ges
(
ex‹Á_io_Œ“
 *
Œ“
,

3125 
·ge
 *
·ges
[],

3126 
Ä_·ges
, 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

3127 
ex‹Á_m­
 **
em_ÿched
,

3128 
bio
 **bio, 
mœrÜ_num
,

3129 *
bio_æags
,

3130 
u64
 *
´ev_em_¡¬t
)

3132 
u64
 
¡¬t
 = 0;

3133 
u64
 
’d
 = 0;

3134 
u64
 
·ge_¡¬t
;

3135 
šdex
;

3136 
fœ¡_šdex
 = 0;

3138 
šdex
 = 0; index < 
Ä_·ges
; index++) {

3139 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ges
[
šdex
]);

3140 ià(!
’d
) {

3141 
¡¬t
 = 
·ge_¡¬t
;

3142 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

3143 
fœ¡_šdex
 = 
šdex
;

3144 } ià(
’d
 + 1 =ð
·ge_¡¬t
) {

3145 
’d
 +ð
PAGE_SIZE
;

3147 
	`__do_cÚtiguous_»ad·ges
(
Œ“
, &
·ges
[
fœ¡_šdex
],

3148 
šdex
 - 
fœ¡_šdex
, 
¡¬t
,

3149 
’d
, 
g‘_ex‹Á
, 
em_ÿched
,

3150 
bio
, 
mœrÜ_num
, 
bio_æags
,

3151 
´ev_em_¡¬t
);

3152 
¡¬t
 = 
·ge_¡¬t
;

3153 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

3154 
fœ¡_šdex
 = 
šdex
;

3158 ià(
’d
)

3159 
	`__do_cÚtiguous_»ad·ges
(
Œ“
, &
·ges
[
fœ¡_šdex
],

3160 
šdex
 - 
fœ¡_šdex
, 
¡¬t
,

3161 
’d
, 
g‘_ex‹Á
, 
em_ÿched
, 
bio
,

3162 
mœrÜ_num
, 
bio_æags
,

3163 
´ev_em_¡¬t
);

3164 
	}
}

3166 
	$__ex‹Á_»ad_fuÎ_·ge
(
ex‹Á_io_Œ“
 *
Œ“
,

3167 
·ge
 *page,

3168 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

3169 
bio
 **bio, 
mœrÜ_num
,

3170 *
bio_æags
,

3171 
»ad_æags
)

3173 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

3174 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

3175 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

3176 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

3177 
»t
;

3180 
	`lock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
);

3181 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
,

3182 
PAGE_SIZE
);

3183 ià(!
Üd”ed
)

3185 
	`uÆock_ex‹Á
(
Œ“
, 
¡¬t
, 
’d
);

3186 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

3187 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

3190 
»t
 = 
	`__do_»ad·ge
(
Œ“
, 
·ge
, 
g‘_ex‹Á
, 
NULL
, 
bio
, 
mœrÜ_num
,

3191 
bio_æags
, 
»ad_æags
, 
NULL
);

3192  
»t
;

3193 
	}
}

3195 
	$ex‹Á_»ad_fuÎ_·ge
(
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

3196 
g‘_ex‹Á_t
 *
g‘_ex‹Á
, 
mœrÜ_num
)

3198 
bio
 *biØð
NULL
;

3199 
bio_æags
 = 0;

3200 
»t
;

3202 
»t
 = 
	`__ex‹Á_»ad_fuÎ_·ge
(
Œ“
, 
·ge
, 
g‘_ex‹Á
, &
bio
, 
mœrÜ_num
,

3203 &
bio_æags
, 0);

3204 ià(
bio
)

3205 
»t
 = 
	`subm™_Úe_bio
(
bio
, 
mœrÜ_num
, 
bio_æags
);

3206  
»t
;

3207 
	}
}

3209 
	$upd©e_Ä_wr™‹n
(
wr™eback_cÚŒÞ
 *
wbc
,

3210 
Ä_wr™‹n
)

3212 
wbc
->
Ä_to_wr™e
 -ð
Ä_wr™‹n
;

3213 
	}
}

3225 
nošlše_fÜ_¡ack
 
	$wr™•age_d–®loc
(
šode
 *inode,

3226 
·ge
 *·ge, 
wr™eback_cÚŒÞ
 *
wbc
,

3227 
ex‹Á_·ge_d©a
 *
•d
,

3228 
u64
 
d–®loc_¡¬t
,

3229 *
Ä_wr™‹n
)

3231 
ex‹Á_io_Œ“
 *
Œ“
 = 
•d
->tree;

3232 
u64
 
·ge_’d
 = 
d–®loc_¡¬t
 + 
PAGE_SIZE
 - 1;

3233 
u64
 
Ä_d–®loc
;

3234 
u64
 
d–®loc_to_wr™e
 = 0;

3235 
u64
 
d–®loc_’d
 = 0;

3236 
»t
;

3237 
·ge_¡¬‹d
 = 0;

3239 ià(
•d
->
ex‹Á_locked
 || !
Œ“
->
Ýs
 || !Œ“->Ýs->
fžl_d–®loc
)

3242 
d–®loc_’d
 < 
·ge_’d
) {

3243 
Ä_d–®loc
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, 
Œ“
,

3244 
·ge
,

3245 &
d–®loc_¡¬t
,

3246 &
d–®loc_’d
,

3247 
BTRFS_MAX_EXTENT_SIZE
);

3248 ià(
Ä_d–®loc
 == 0) {

3249 
d–®loc_¡¬t
 = 
d–®loc_’d
 + 1;

3252 
»t
 = 
Œ“
->
Ýs
->
	`fžl_d–®loc
(
šode
, 
·ge
,

3253 
d–®loc_¡¬t
,

3254 
d–®loc_’d
,

3255 &
·ge_¡¬‹d
,

3256 
Ä_wr™‹n
);

3258 ià(
»t
) {

3259 
	`S‘PageE¼Ü
(
·ge
);

3265 
»t
 =„‘ < 0 ?„‘ : -
EIO
;

3266 
dÚe
;

3272 
d–®loc_to_wr™e
 +ð(
d–®loc_’d
 - 
d–®loc_¡¬t
 +

3273 
PAGE_SIZE
è>> 
PAGE_SHIFT
;

3274 
d–®loc_¡¬t
 = 
d–®loc_’d
 + 1;

3276 ià(
wbc
->
Ä_to_wr™e
 < 
d–®loc_to_wr™e
) {

3277 
th»sh
 = 8192;

3279 ià(
d–®loc_to_wr™e
 < 
th»sh
 * 2)

3280 
th»sh
 = 
d–®loc_to_wr™e
;

3281 
wbc
->
Ä_to_wr™e
 = 
	`mš_t
(
u64
, 
d–®loc_to_wr™e
,

3282 
th»sh
);

3288 ià(
·ge_¡¬‹d
) {

3294 
wbc
->
Ä_to_wr™e
 -ð*
Ä_wr™‹n
;

3298 
»t
 = 0;

3300 
dÚe
:

3301  
»t
;

3302 
	}
}

3312 
nošlše_fÜ_¡ack
 
	$__ex‹Á_wr™•age_io
(
šode
 *inode,

3313 
·ge
 *page,

3314 
wr™eback_cÚŒÞ
 *
wbc
,

3315 
ex‹Á_·ge_d©a
 *
•d
,

3316 
loff_t
 
i_size
,

3317 
Ä_wr™‹n
,

3318 
wr™e_æags
, *
Ä_»t
)

3320 
ex‹Á_io_Œ“
 *
Œ“
 = 
•d
->tree;

3321 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

3322 
u64
 
·ge_’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

3323 
u64
 
’d
;

3324 
u64
 
cur
 = 
¡¬t
;

3325 
u64
 
ex‹Á_off£t
;

3326 
u64
 
block_¡¬t
;

3327 
u64
 
iosize
;

3328 
£ùÜ_t
 
£ùÜ
;

3329 
ex‹Á_m­
 *
em
;

3330 
block_deviû
 *
bdev
;

3331 
size_t
 
pg_off£t
 = 0;

3332 
size_t
 
blocksize
;

3333 
»t
 = 0;

3334 
Ä
 = 0;

3335 
boÞ
 
com´es£d
;

3337 ià(
Œ“
->
Ýs
 &&»e->Ýs->
wr™•age_¡¬t_hook
) {

3338 
»t
 = 
Œ“
->
Ýs
->
	`wr™•age_¡¬t_hook
(
·ge
, 
¡¬t
,

3339 
·ge_’d
);

3340 ià(
»t
) {

3342 ià(
»t
 =ð-
EBUSY
)

3343 
wbc
->
·ges_sk³d
++;

3345 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

3347 
	`upd©e_Ä_wr™‹n
(
wbc
, 
Ä_wr™‹n
);

3348 
	`uÆock_·ge
(
·ge
);

3357 
	`upd©e_Ä_wr™‹n
(
wbc
, 
Ä_wr™‹n
 + 1);

3359 
’d
 = 
·ge_’d
;

3360 ià(
i_size
 <ð
¡¬t
) {

3361 ià(
Œ“
->
Ýs
 &&»e->Ýs->
wr™•age_’d_io_hook
)

3362 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
·ge
, 
¡¬t
,

3363 
·ge_’d
, 
NULL
, 1);

3364 
dÚe
;

3367 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

3369 
cur
 <ð
’d
) {

3370 
u64
 
em_’d
;

3372 ià(
cur
 >ð
i_size
) {

3373 ià(
Œ“
->
Ýs
 &&»e->Ýs->
wr™•age_’d_io_hook
)

3374 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
·ge
, 
cur
,

3375 
·ge_’d
, 
NULL
, 1);

3378 
em
 = 
•d
->
	`g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
·ge
, 
pg_off£t
, 
cur
,

3379 
’d
 - 
cur
 + 1, 1);

3380 ià(
	`IS_ERR_OR_NULL
(
em
)) {

3381 
	`S‘PageE¼Ü
(
·ge
);

3382 
»t
 = 
	`PTR_ERR_OR_ZERO
(
em
);

3386 
ex‹Á_off£t
 = 
cur
 - 
em
->
¡¬t
;

3387 
em_’d
 = 
	`ex‹Á_m­_’d
(
em
);

3388 
	`BUG_ON
(
em_’d
 <ð
cur
);

3389 
	`BUG_ON
(
’d
 < 
cur
);

3390 
iosize
 = 
	`mš
(
em_’d
 - 
cur
, 
’d
 - cur + 1);

3391 
iosize
 = 
	`ALIGN
(iosize, 
blocksize
);

3392 
£ùÜ
 = (
em
->
block_¡¬t
 + 
ex‹Á_off£t
) >> 9;

3393 
bdev
 = 
em
->bdev;

3394 
block_¡¬t
 = 
em
->block_start;

3395 
com´es£d
 = 
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

3396 
	`ä“_ex‹Á_m­
(
em
);

3397 
em
 = 
NULL
;

3403 ià(
com´es£d
 || 
block_¡¬t
 =ð
EXTENT_MAP_HOLE
 ||

3404 
block_¡¬t
 =ð
EXTENT_MAP_INLINE
) {

3409 ià(!
com´es£d
 && 
Œ“
->
Ýs
 &&

3410 
Œ“
->
Ýs
->
wr™•age_’d_io_hook
)

3411 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
·ge
, 
cur
,

3412 
cur
 + 
iosize
 - 1,

3413 
NULL
, 1);

3414 ià(
com´es£d
) {

3419 
Ä
++;

3422 
cur
 +ð
iosize
;

3423 
pg_off£t
 +ð
iosize
;

3427 
	`£t_¿nge_wr™eback
(
Œ“
, 
cur
, cu¸+ 
iosize
 - 1);

3428 ià(!
	`PageWr™eback
(
·ge
)) {

3429 
	`bŒfs_”r
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

3431 
·ge
->
šdex
, 
cur
, 
’d
);

3434 
»t
 = 
	`subm™_ex‹Á_·ge
(
REQ_OP_WRITE
 | 
wr™e_æags
, 
Œ“
, 
wbc
,

3435 
·ge
, 
£ùÜ
, 
iosize
, 
pg_off£t
,

3436 
bdev
, &
•d
->
bio
,

3437 
’d_bio_ex‹Á_wr™•age
,

3438 0, 0, 0, 
çl£
);

3439 ià(
»t
) {

3440 
	`S‘PageE¼Ü
(
·ge
);

3441 ià(
	`PageWr™eback
(
·ge
))

3442 
	`’d_·ge_wr™eback
(
·ge
);

3445 
cur
 = cu¸+ 
iosize
;

3446 
pg_off£t
 +ð
iosize
;

3447 
Ä
++;

3449 
dÚe
:

3450 *
Ä_»t
 = 
Ä
;

3451  
»t
;

3452 
	}
}

3460 
	$__ex‹Á_wr™•age
(
·ge
 *·ge, 
wr™eback_cÚŒÞ
 *
wbc
,

3461 *
d©a
)

3463 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

3464 
ex‹Á_·ge_d©a
 *
•d
 = 
d©a
;

3465 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

3466 
u64
 
·ge_’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

3467 
»t
;

3468 
Ä
 = 0;

3469 
size_t
 
pg_off£t
 = 0;

3470 
loff_t
 
i_size
 = 
	`i_size_»ad
(
šode
);

3471 
’d_šdex
 = 
i_size
 >> 
PAGE_SHIFT
;

3472 
wr™e_æags
 = 0;

3473 
Ä_wr™‹n
 = 0;

3475 
wr™e_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
);

3477 
	`Œaû___ex‹Á_wr™•age
(
·ge
, 
šode
, 
wbc
);

3479 
	`WARN_ON
(!
	`PageLocked
(
·ge
));

3481 
	`CË¬PageE¼Ü
(
·ge
);

3483 
pg_off£t
 = 
i_size
 & (
PAGE_SIZE
 - 1);

3484 ià(
·ge
->
šdex
 > 
’d_šdex
 ||

3485 (
·ge
->
šdex
 =ð
’d_šdex
 && !
pg_off£t
)) {

3486 
·ge
->
m­pšg
->
a_Ýs
->
	`šv®id©•age
Õage, 0, 
PAGE_SIZE
);

3487 
	`uÆock_·ge
(
·ge
);

3491 ià(
·ge
->
šdex
 =ð
’d_šdex
) {

3492 *
u£½age
;

3494 
u£½age
 = 
	`km­_©omic
(
·ge
);

3495 
	`mem£t
(
u£½age
 + 
pg_off£t
, 0,

3496 
PAGE_SIZE
 - 
pg_off£t
);

3497 
	`kunm­_©omic
(
u£½age
);

3498 
	`æush_dÿche_·ge
(
·ge
);

3501 
pg_off£t
 = 0;

3503 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

3505 
»t
 = 
	`wr™•age_d–®loc
(
šode
, 
·ge
, 
wbc
, 
•d
, 
¡¬t
, &
Ä_wr™‹n
);

3506 ià(
»t
 == 1)

3507 
dÚe_uÆocked
;

3508 ià(
»t
)

3509 
dÚe
;

3511 
»t
 = 
	`__ex‹Á_wr™•age_io
(
šode
, 
·ge
, 
wbc
, 
•d
,

3512 
i_size
, 
Ä_wr™‹n
, 
wr™e_æags
, &
Ä
);

3513 ià(
»t
 == 1)

3514 
dÚe_uÆocked
;

3516 
dÚe
:

3517 ià(
Ä
 == 0) {

3519 
	`£t_·ge_wr™eback
(
·ge
);

3520 
	`’d_·ge_wr™eback
(
·ge
);

3522 ià(
	`PageE¼Ü
(
·ge
)) {

3523 
»t
 =„‘ < 0 ?„‘ : -
EIO
;

3524 
	`’d_ex‹Á_wr™•age
(
·ge
, 
»t
, 
¡¬t
, 
·ge_’d
);

3526 
	`uÆock_·ge
(
·ge
);

3527  
»t
;

3529 
dÚe_uÆocked
:

3531 
	}
}

3533 
	$wa™_Ú_ex‹Á_bufãr_wr™eback
(
ex‹Á_bufãr
 *
eb
)

3535 
	`wa™_Ú_b™_io
(&
eb
->
bæags
, 
EXTENT_BUFFER_WRITEBACK
,

3536 
TASK_UNINTERRUPTIBLE
);

3537 
	}
}

3539 
nošlše_fÜ_¡ack
 

3540 
	$lock_ex‹Á_bufãr_fÜ_io
(
ex‹Á_bufãr
 *
eb
,

3541 
bŒfs_fs_šfo
 *
fs_šfo
,

3542 
ex‹Á_·ge_d©a
 *
•d
)

3544 
i
, 
num_·ges
;

3545 
æush
 = 0;

3546 
»t
 = 0;

3548 ià(!
	`bŒfs_Œy_Œ“_wr™e_lock
(
eb
)) {

3549 
æush
 = 1;

3550 
	`æush_wr™e_bio
(
•d
);

3551 
	`bŒfs_Œ“_lock
(
eb
);

3554 ià(
	`‹¡_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
)) {

3555 
	`bŒfs_Œ“_uÆock
(
eb
);

3556 ià(!
•d
->
sync_io
)

3558 ià(!
æush
) {

3559 
	`æush_wr™e_bio
(
•d
);

3560 
æush
 = 1;

3563 
	`wa™_Ú_ex‹Á_bufãr_wr™eback
(
eb
);

3564 
	`bŒfs_Œ“_lock
(
eb
);

3565 ià(!
	`‹¡_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
))

3567 
	`bŒfs_Œ“_uÆock
(
eb
);

3576 
	`¥š_lock
(&
eb
->
»fs_lock
);

3577 ià(
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
)) {

3578 
	`£t_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
);

3579 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3580 
	`bŒfs_£t_h—d”_æag
(
eb
, 
BTRFS_HEADER_FLAG_WRITTEN
);

3581 
	`³rýu_couÁ”_add_b©ch
(&
fs_šfo
->
dœty_m‘ad©a_by‹s
,

3582 -
eb
->
Ën
,

3583 
fs_šfo
->
dœty_m‘ad©a_b©ch
);

3584 
»t
 = 1;

3586 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

3589 
	`bŒfs_Œ“_uÆock
(
eb
);

3591 ià(!
»t
)

3592  
»t
;

3594 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

3595 
i
 = 0; i < 
num_·ges
; i++) {

3596 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

3598 ià(!
	`Œylock_·ge
(
p
)) {

3599 ià(!
æush
) {

3600 
	`æush_wr™e_bio
(
•d
);

3601 
æush
 = 1;

3603 
	`lock_·ge
(
p
);

3607  
»t
;

3608 
	}
}

3610 
	$’d_ex‹Á_bufãr_wr™eback
(
ex‹Á_bufãr
 *
eb
)

3612 
	`þ—r_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
);

3613 
	`smp_mb__aá”_©omic
();

3614 
	`wake_up_b™
(&
eb
->
bæags
, 
EXTENT_BUFFER_WRITEBACK
);

3615 
	}
}

3617 
	$£t_bŒ“_iÛ¼
(
·ge
 *page)

3619 
ex‹Á_bufãr
 *
eb
 = (ex‹Á_bufã¸*)
·ge
->
´iv©e
;

3621 
	`S‘PageE¼Ü
(
·ge
);

3622 ià(
	`‹¡_ªd_£t_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
))

3663 
eb
->
log_šdex
) {

3665 
	`£t_b™
(
BTRFS_FS_BTREE_ERR
, &
eb
->
fs_šfo
->
æags
);

3668 
	`£t_b™
(
BTRFS_FS_LOG1_ERR
, &
eb
->
fs_šfo
->
æags
);

3671 
	`£t_b™
(
BTRFS_FS_LOG2_ERR
, &
eb
->
fs_šfo
->
æags
);

3674 
	`BUG
();

3676 
	}
}

3678 
	$’d_bio_ex‹Á_bufãr_wr™•age
(
bio
 *bio)

3680 
bio_vec
 *
bvec
;

3681 
ex‹Á_bufãr
 *
eb
;

3682 
i
, 
dÚe
;

3684 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

3685 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

3686 
·ge
 *·gð
bvec
->
bv_·ge
;

3688 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

3689 
	`BUG_ON
(!
eb
);

3690 
dÚe
 = 
	`©omic_dec_ªd_‹¡
(&
eb
->
io_·ges
);

3692 ià(
bio
->
bi_¡©us
 ||

3693 
	`‹¡_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
)) {

3694 
	`CË¬PageU±od©e
(
·ge
);

3695 
	`£t_bŒ“_iÛ¼
(
·ge
);

3698 
	`’d_·ge_wr™eback
(
·ge
);

3700 ià(!
dÚe
)

3703 
	`’d_ex‹Á_bufãr_wr™eback
(
eb
);

3706 
	`bio_put
(
bio
);

3707 
	}
}

3709 
nošlše_fÜ_¡ack
 
	$wr™e_Úe_eb
(
ex‹Á_bufãr
 *
eb
,

3710 
bŒfs_fs_šfo
 *
fs_šfo
,

3711 
wr™eback_cÚŒÞ
 *
wbc
,

3712 
ex‹Á_·ge_d©a
 *
•d
)

3714 
block_deviû
 *
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

3715 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
fs_šfo
->
bŒ“_šode
)->
io_Œ“
;

3716 
u64
 
off£t
 = 
eb
->
¡¬t
;

3717 
u32
 
Ä™ems
;

3718 
i
, 
num_·ges
;

3719 
bio_æags
 = 0;

3720 
¡¬t
, 
’d
;

3721 
wr™e_æags
 = 
	`wbc_to_wr™e_æags
(
wbc
è| 
REQ_META
;

3722 
»t
 = 0;

3724 
	`þ—r_b™
(
EXTENT_BUFFER_WRITE_ERR
, &
eb
->
bæags
);

3725 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

3726 
	`©omic_£t
(&
eb
->
io_·ges
, 
num_·ges
);

3727 ià(
	`bŒfs_h—d”_owÃr
(
eb
è=ð
BTRFS_TREE_LOG_OBJECTID
)

3728 
bio_æags
 = 
EXTENT_BIO_TREE_LOG
;

3731 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

3732 ià(
	`bŒfs_h—d”_Ëv–
(
eb
) > 0) {

3733 
’d
 = 
	`bŒfs_node_key_±r_off£t
(
Ä™ems
);

3735 
	`memz”o_ex‹Á_bufãr
(
eb
, 
’d
,ƒb->
Ën
 -ƒnd);

3741 
¡¬t
 = 
	`bŒfs_™em_Ä_off£t
(
Ä™ems
);

3742 
’d
 = 
BTRFS_LEAF_DATA_OFFSET
 + 
	`Ëaf_d©a_’d
(
fs_šfo
, 
eb
);

3743 
	`memz”o_ex‹Á_bufãr
(
eb
, 
¡¬t
, 
’d
 - start);

3746 
i
 = 0; i < 
num_·ges
; i++) {

3747 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

3749 
	`þ—r_·ge_dœty_fÜ_io
(
p
);

3750 
	`£t_·ge_wr™eback
(
p
);

3751 
»t
 = 
	`subm™_ex‹Á_·ge
(
REQ_OP_WRITE
 | 
wr™e_æags
, 
Œ“
, 
wbc
,

3752 
p
, 
off£t
 >> 9, 
PAGE_SIZE
, 0, 
bdev
,

3753 &
•d
->
bio
,

3754 
’d_bio_ex‹Á_bufãr_wr™•age
,

3755 0, 
•d
->
bio_æags
, bio_æags, 
çl£
);

3756 
•d
->
bio_æags
 = bio_flags;

3757 ià(
»t
) {

3758 
	`£t_bŒ“_iÛ¼
(
p
);

3759 ià(
	`PageWr™eback
(
p
))

3760 
	`’d_·ge_wr™eback
(
p
);

3761 ià(
	`©omic_sub_ªd_‹¡
(
num_·ges
 - 
i
, &
eb
->
io_·ges
))

3762 
	`’d_ex‹Á_bufãr_wr™eback
(
eb
);

3763 
»t
 = -
EIO
;

3766 
off£t
 +ð
PAGE_SIZE
;

3767 
	`upd©e_Ä_wr™‹n
(
wbc
, 1);

3768 
	`uÆock_·ge
(
p
);

3771 ià(
	`uÆik–y
(
»t
)) {

3772 ; 
i
 < 
num_·ges
; i++) {

3773 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

3774 
	`þ—r_·ge_dœty_fÜ_io
(
p
);

3775 
	`uÆock_·ge
(
p
);

3779  
»t
;

3780 
	}
}

3782 
	$bŒ“_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

3783 
wr™eback_cÚŒÞ
 *
wbc
)

3785 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
m­pšg
->
ho¡
)->
io_Œ“
;

3786 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`BTRFS_I
(
m­pšg
->
ho¡
)->
roÙ
->fs_info;

3787 
ex‹Á_bufãr
 *
eb
, *
´ev_eb
 = 
NULL
;

3788 
ex‹Á_·ge_d©a
 
•d
 = {

3789 .
bio
 = 
NULL
,

3790 .
Œ“
 =ree,

3791 .
ex‹Á_locked
 = 0,

3792 .
sync_io
 = 
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
,

3793 .
bio_æags
 = 0,

3795 
»t
 = 0;

3796 
dÚe
 = 0;

3797 
Ä_to_wr™e_dÚe
 = 0;

3798 
·gevec
 
pvec
;

3799 
Ä_·ges
;

3800 
pgoff_t
 
šdex
;

3801 
pgoff_t
 
’d
;

3802 
sÿÂed
 = 0;

3803 
g
;

3805 
	`·gevec_š™
(&
pvec
, 0);

3806 ià(
wbc
->
¿nge_cyþic
) {

3807 
šdex
 = 
m­pšg
->
wr™eback_šdex
;

3808 
’d
 = -1;

3810 
šdex
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

3811 
’d
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

3812 
sÿÂed
 = 1;

3814 ià(
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
)

3815 
g
 = 
PAGECACHE_TAG_TOWRITE
;

3817 
g
 = 
PAGECACHE_TAG_DIRTY
;

3818 
»Œy
:

3819 ià(
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
)

3820 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
šdex
, 
’d
);

3821 !
dÚe
 && !
Ä_to_wr™e_dÚe
 && (
šdex
 <ð
’d
) &&

3822 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
šdex
, 
g
,

3823 
	`mš
(
’d
 - 
šdex
, (
pgoff_t
)
PAGEVEC_SIZE
-1) + 1))) {

3824 
i
;

3826 
sÿÂed
 = 1;

3827 
i
 = 0; i < 
Ä_·ges
; i++) {

3828 
·ge
 *·gð
pvec
.
·ges
[
i
];

3830 ià(!
	`PagePriv©e
(
·ge
))

3833 ià(!
wbc
->
¿nge_cyþic
 && 
·ge
->
šdex
 > 
’d
) {

3834 
dÚe
 = 1;

3838 
	`¥š_lock
(&
m­pšg
->
´iv©e_lock
);

3839 ià(!
	`PagePriv©e
(
·ge
)) {

3840 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

3844 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

3851 ià(
	`WARN_ON
(!
eb
)) {

3852 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

3856 ià(
eb
 =ð
´ev_eb
) {

3857 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

3861 
»t
 = 
	`©omic_šc_nÙ_z”o
(&
eb
->
»fs
);

3862 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

3863 ià(!
»t
)

3866 
´ev_eb
 = 
eb
;

3867 
»t
 = 
	`lock_ex‹Á_bufãr_fÜ_io
(
eb
, 
fs_šfo
, &
•d
);

3868 ià(!
»t
) {

3869 
	`ä“_ex‹Á_bufãr
(
eb
);

3873 
»t
 = 
	`wr™e_Úe_eb
(
eb
, 
fs_šfo
, 
wbc
, &
•d
);

3874 ià(
»t
) {

3875 
dÚe
 = 1;

3876 
	`ä“_ex‹Á_bufãr
(
eb
);

3879 
	`ä“_ex‹Á_bufãr
(
eb
);

3886 
Ä_to_wr™e_dÚe
 = 
wbc
->
Ä_to_wr™e
 <= 0;

3888 
	`·gevec_»Ëa£
(&
pvec
);

3889 
	`cÚd_»sched
();

3891 ià(!
sÿÂed
 && !
dÚe
) {

3896 
sÿÂed
 = 1;

3897 
šdex
 = 0;

3898 
»Œy
;

3900 
	`æush_wr™e_bio
(&
•d
);

3901  
»t
;

3902 
	}
}

3919 
	$ex‹Á_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

3920 
wr™eback_cÚŒÞ
 *
wbc
,

3921 
wr™•age_t
 
wr™•age
, *
d©a
,

3922 (*
æush_â
)(*))

3924 
šode
 *šodð
m­pšg
->
ho¡
;

3925 
»t
 = 0;

3926 
dÚe
 = 0;

3927 
Ä_to_wr™e_dÚe
 = 0;

3928 
·gevec
 
pvec
;

3929 
Ä_·ges
;

3930 
pgoff_t
 
šdex
;

3931 
pgoff_t
 
’d
;

3932 
pgoff_t
 
dÚe_šdex
;

3933 
¿nge_whÞe
 = 0;

3934 
sÿÂed
 = 0;

3935 
g
;

3946 ià(!
	`ig¿b
(
šode
))

3949 
	`·gevec_š™
(&
pvec
, 0);

3950 ià(
wbc
->
¿nge_cyþic
) {

3951 
šdex
 = 
m­pšg
->
wr™eback_šdex
;

3952 
’d
 = -1;

3954 
šdex
 = 
wbc
->
¿nge_¡¬t
 >> 
PAGE_SHIFT
;

3955 
’d
 = 
wbc
->
¿nge_’d
 >> 
PAGE_SHIFT
;

3956 ià(
wbc
->
¿nge_¡¬t
 =ð0 && wbc->
¿nge_’d
 =ð
LLONG_MAX
)

3957 
¿nge_whÞe
 = 1;

3958 
sÿÂed
 = 1;

3960 ià(
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
)

3961 
g
 = 
PAGECACHE_TAG_TOWRITE
;

3963 
g
 = 
PAGECACHE_TAG_DIRTY
;

3964 
»Œy
:

3965 ià(
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
)

3966 
	`g_·ges_fÜ_wr™eback
(
m­pšg
, 
šdex
, 
’d
);

3967 
dÚe_šdex
 = 
šdex
;

3968 !
dÚe
 && !
Ä_to_wr™e_dÚe
 && (
šdex
 <ð
’d
) &&

3969 (
Ä_·ges
 = 
	`·gevec_lookup_g
(&
pvec
, 
m­pšg
, &
šdex
, 
g
,

3970 
	`mš
(
’d
 - 
šdex
, (
pgoff_t
)
PAGEVEC_SIZE
-1) + 1))) {

3971 
i
;

3973 
sÿÂed
 = 1;

3974 
i
 = 0; i < 
Ä_·ges
; i++) {

3975 
·ge
 *·gð
pvec
.
·ges
[
i
];

3977 
dÚe_šdex
 = 
·ge
->
šdex
;

3985 ià(!
	`Œylock_·ge
(
·ge
)) {

3986 
	`æush_â
(
d©a
);

3987 
	`lock_·ge
(
·ge
);

3990 ià(
	`uÆik–y
(
·ge
->
m­pšg
 != mapping)) {

3991 
	`uÆock_·ge
(
·ge
);

3995 ià(!
wbc
->
¿nge_cyþic
 && 
·ge
->
šdex
 > 
’d
) {

3996 
dÚe
 = 1;

3997 
	`uÆock_·ge
(
·ge
);

4001 ià(
wbc
->
sync_mode
 !ð
WB_SYNC_NONE
) {

4002 ià(
	`PageWr™eback
(
·ge
))

4003 
	`æush_â
(
d©a
);

4004 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

4007 ià(
	`PageWr™eback
(
·ge
) ||

4008 !
	`þ—r_·ge_dœty_fÜ_io
(
·ge
)) {

4009 
	`uÆock_·ge
(
·ge
);

4013 
»t
 = (*
wr™•age
)(
·ge
, 
wbc
, 
d©a
);

4015 ià(
	`uÆik–y
(
»t
 =ð
AOP_WRITEPAGE_ACTIVATE
)) {

4016 
	`uÆock_·ge
(
·ge
);

4017 
»t
 = 0;

4019 ià(
»t
 < 0) {

4029 
dÚe_šdex
 = 
·ge
->
šdex
 + 1;

4030 
dÚe
 = 1;

4039 
Ä_to_wr™e_dÚe
 = 
wbc
->
Ä_to_wr™e
 <= 0;

4041 
	`·gevec_»Ëa£
(&
pvec
);

4042 
	`cÚd_»sched
();

4044 ià(!
sÿÂed
 && !
dÚe
) {

4049 
sÿÂed
 = 1;

4050 
šdex
 = 0;

4051 
»Œy
;

4054 ià(
wbc
->
¿nge_cyþic
 || (wbc->
Ä_to_wr™e
 > 0 && 
¿nge_whÞe
))

4055 
m­pšg
->
wr™eback_šdex
 = 
dÚe_šdex
;

4057 
	`bŒfs_add_d–ayed_ut
(
šode
);

4058  
»t
;

4059 
	}
}

4061 
	$æush_•d_wr™e_bio
(
ex‹Á_·ge_d©a
 *
•d
)

4063 ià(
•d
->
bio
) {

4064 
»t
;

4066 
»t
 = 
	`subm™_Úe_bio
(
•d
->
bio
, 0,ƒpd->
bio_æags
);

4067 
	`BUG_ON
(
»t
 < 0);

4068 
•d
->
bio
 = 
NULL
;

4070 
	}
}

4072 
nošlše
 
	$æush_wr™e_bio
(*
d©a
)

4074 
ex‹Á_·ge_d©a
 *
•d
 = 
d©a
;

4075 
	`æush_•d_wr™e_bio
(
•d
);

4076 
	}
}

4078 
	$ex‹Á_wr™e_fuÎ_·ge
(
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

4079 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

4080 
wr™eback_cÚŒÞ
 *
wbc
)

4082 
»t
;

4083 
ex‹Á_·ge_d©a
 
•d
 = {

4084 .
bio
 = 
NULL
,

4085 .
Œ“
 =ree,

4086 .
g‘_ex‹Á
 = get_extent,

4087 .
ex‹Á_locked
 = 0,

4088 .
sync_io
 = 
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
,

4089 .
bio_æags
 = 0,

4092 
»t
 = 
	`__ex‹Á_wr™•age
(
·ge
, 
wbc
, &
•d
);

4094 
	`æush_•d_wr™e_bio
(&
•d
);

4095  
»t
;

4096 
	}
}

4098 
	$ex‹Á_wr™e_locked_¿nge
(
ex‹Á_io_Œ“
 *
Œ“
, 
šode
 *inode,

4099 
u64
 
¡¬t
, u64 
’d
, 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

4100 
mode
)

4102 
»t
 = 0;

4103 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4104 
·ge
 *page;

4105 
Ä_·ges
 = (
’d
 - 
¡¬t
 + 
PAGE_SIZE
) >>

4106 
PAGE_SHIFT
;

4108 
ex‹Á_·ge_d©a
 
•d
 = {

4109 .
bio
 = 
NULL
,

4110 .
Œ“
 =ree,

4111 .
g‘_ex‹Á
 = get_extent,

4112 .
ex‹Á_locked
 = 1,

4113 .
sync_io
 = 
mode
 =ð
WB_SYNC_ALL
,

4114 .
bio_æags
 = 0,

4116 
wr™eback_cÚŒÞ
 
wbc_wr™•ages
 = {

4117 .
sync_mode
 = 
mode
,

4118 .
Ä_to_wr™e
 = 
Ä_·ges
 * 2,

4119 .
¿nge_¡¬t
 = 
¡¬t
,

4120 .
¿nge_’d
 = 
’d
 + 1,

4123 
¡¬t
 <ð
’d
) {

4124 
·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

4125 ià(
	`þ—r_·ge_dœty_fÜ_io
(
·ge
))

4126 
»t
 = 
	`__ex‹Á_wr™•age
(
·ge
, &
wbc_wr™•ages
, &
•d
);

4128 ià(
Œ“
->
Ýs
 &&»e->Ýs->
wr™•age_’d_io_hook
)

4129 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
·ge
, 
¡¬t
,

4130 
¡¬t
 + 
PAGE_SIZE
 - 1,

4131 
NULL
, 1);

4132 
	`uÆock_·ge
(
·ge
);

4134 
	`put_·ge
(
·ge
);

4135 
¡¬t
 +ð
PAGE_SIZE
;

4138 
	`æush_•d_wr™e_bio
(&
•d
);

4139  
»t
;

4140 
	}
}

4142 
	$ex‹Á_wr™•ages
(
ex‹Á_io_Œ“
 *
Œ“
,

4143 
add»ss_¥aû
 *
m­pšg
,

4144 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

4145 
wr™eback_cÚŒÞ
 *
wbc
)

4147 
»t
 = 0;

4148 
ex‹Á_·ge_d©a
 
•d
 = {

4149 .
bio
 = 
NULL
,

4150 .
Œ“
 =ree,

4151 .
g‘_ex‹Á
 = get_extent,

4152 .
ex‹Á_locked
 = 0,

4153 .
sync_io
 = 
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
,

4154 .
bio_æags
 = 0,

4157 
»t
 = 
	`ex‹Á_wr™e_ÿche_·ges
(
m­pšg
, 
wbc
, 
__ex‹Á_wr™•age
, &
•d
,

4158 
æush_wr™e_bio
);

4159 
	`æush_•d_wr™e_bio
(&
•d
);

4160  
»t
;

4161 
	}
}

4163 
	$ex‹Á_»ad·ges
(
ex‹Á_io_Œ“
 *
Œ“
,

4164 
add»ss_¥aû
 *
m­pšg
,

4165 
li¡_h—d
 *
·ges
, 
Ä_·ges
,

4166 
g‘_ex‹Á_t
 
g‘_ex‹Á
)

4168 
bio
 *biØð
NULL
;

4169 
·ge_idx
;

4170 
bio_æags
 = 0;

4171 
·ge
 *
·g•oÞ
[16];

4172 
·ge
 *page;

4173 
ex‹Á_m­
 *
em_ÿched
 = 
NULL
;

4174 
Ä
 = 0;

4175 
u64
 
´ev_em_¡¬t
 = (u64)-1;

4177 
·ge_idx
 = 0;…age_idx < 
Ä_·ges
;…age_idx++) {

4178 
·ge
 = 
	`li¡_’Œy
(
·ges
->
´ev
, ·ge, 
Ìu
);

4180 
	`´eãtchw
(&
·ge
->
æags
);

4181 
	`li¡_d–
(&
·ge
->
Ìu
);

4182 ià(
	`add_to_·ge_ÿche_Ìu
(
·ge
, 
m­pšg
,

4183 
·ge
->
šdex
,

4184 
	`»adah—d_gå_mask
(
m­pšg
))) {

4185 
	`put_·ge
(
·ge
);

4189 
·g•oÞ
[
Ä
++] = 
·ge
;

4190 ià(
Ä
 < 
	`ARRAY_SIZE
(
·g•oÞ
))

4192 
	`__ex‹Á_»ad·ges
(
Œ“
, 
·g•oÞ
, 
Ä
, 
g‘_ex‹Á
, &
em_ÿched
,

4193 &
bio
, 0, &
bio_æags
, &
´ev_em_¡¬t
);

4194 
Ä
 = 0;

4196 ià(
Ä
)

4197 
	`__ex‹Á_»ad·ges
(
Œ“
, 
·g•oÞ
, 
Ä
, 
g‘_ex‹Á
, &
em_ÿched
,

4198 &
bio
, 0, &
bio_æags
, &
´ev_em_¡¬t
);

4200 ià(
em_ÿched
)

4201 
	`ä“_ex‹Á_m­
(
em_ÿched
);

4203 
	`BUG_ON
(!
	`li¡_em±y
(
·ges
));

4204 ià(
bio
)

4205  
	`subm™_Úe_bio
(
bio
, 0, 
bio_æags
);

4207 
	}
}

4214 
	$ex‹Á_šv®id©•age
(
ex‹Á_io_Œ“
 *
Œ“
,

4215 
·ge
 *·ge, 
off£t
)

4217 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4218 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

4219 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

4220 
size_t
 
blocksize
 = 
·ge
->
m­pšg
->
ho¡
->
i_sb
->
s_blocksize
;

4222 
¡¬t
 +ð
	`ALIGN
(
off£t
, 
blocksize
);

4223 ià(
¡¬t
 > 
’d
)

4226 
	`lock_ex‹Á_b™s
(
Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

4227 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

4228 
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

4229 
EXTENT_LOCKED
 | 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

4230 
EXTENT_DO_ACCOUNTING
,

4231 1, 1, &
ÿched_¡©e
, 
GFP_NOFS
);

4233 
	}
}

4240 
	$Œy_»Ëa£_ex‹Á_¡©e
(
ex‹Á_m­_Œ“
 *
m­
,

4241 
ex‹Á_io_Œ“
 *
Œ“
,

4242 
·ge
 *·ge, 
gå_t
 
mask
)

4244 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

4245 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

4246 
»t
 = 1;

4248 ià(
	`‹¡_¿nge_b™
(
Œ“
, 
¡¬t
, 
’d
,

4249 
EXTENT_IOBITS
, 0, 
NULL
))

4250 
»t
 = 0;

4256 
»t
 = 
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

4257 ~(
EXTENT_LOCKED
 | 
EXTENT_NODATASUM
),

4258 0, 0, 
NULL
, 
mask
);

4263 ià(
»t
 < 0)

4264 
»t
 = 0;

4266 
»t
 = 1;

4268  
»t
;

4269 
	}
}

4276 
	$Œy_»Ëa£_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
m­
,

4277 
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

4278 
gå_t
 
mask
)

4280 
ex‹Á_m­
 *
em
;

4281 
u64
 
¡¬t
 = 
	`·ge_off£t
(
·ge
);

4282 
u64
 
’d
 = 
¡¬t
 + 
PAGE_SIZE
 - 1;

4284 ià(
	`gåæags_®low_blockšg
(
mask
) &&

4285 
·ge
->
m­pšg
->
ho¡
->
i_size
 > 
SZ_16M
) {

4286 
u64
 
Ën
;

4287 
¡¬t
 <ð
’d
) {

4288 
Ën
 = 
’d
 - 
¡¬t
 + 1;

4289 
	`wr™e_lock
(&
m­
->
lock
);

4290 
em
 = 
	`lookup_ex‹Á_m­pšg
(
m­
, 
¡¬t
, 
Ën
);

4291 ià(!
em
) {

4292 
	`wr™e_uÆock
(&
m­
->
lock
);

4295 ià(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
) ||

4296 
em
->
¡¬t
 != start) {

4297 
	`wr™e_uÆock
(&
m­
->
lock
);

4298 
	`ä“_ex‹Á_m­
(
em
);

4301 ià(!
	`‹¡_¿nge_b™
(
Œ“
, 
em
->
¡¬t
,

4302 
	`ex‹Á_m­_’d
(
em
) - 1,

4303 
EXTENT_LOCKED
 | 
EXTENT_WRITEBACK
,

4304 0, 
NULL
)) {

4305 
	`»move_ex‹Á_m­pšg
(
m­
, 
em
);

4307 
	`ä“_ex‹Á_m­
(
em
);

4309 
¡¬t
 = 
	`ex‹Á_m­_’d
(
em
);

4310 
	`wr™e_uÆock
(&
m­
->
lock
);

4313 
	`ä“_ex‹Á_m­
(
em
);

4316  
	`Œy_»Ëa£_ex‹Á_¡©e
(
m­
, 
Œ“
, 
·ge
, 
mask
);

4317 
	}
}

4323 
ex‹Á_m­
 *
	$g‘_ex‹Á_sk_hÞes
(
šode
 *inode,

4324 
u64
 
off£t
,

4325 
u64
 
Ï¡
,

4326 
g‘_ex‹Á_t
 *
g‘_ex‹Á
)

4328 
u64
 
£ùÜsize
 = 
	`bŒfs_šode_£ùÜsize
(
šode
);

4329 
ex‹Á_m­
 *
em
;

4330 
u64
 
Ën
;

4332 ià(
off£t
 >ð
Ï¡
)

4333  
NULL
;

4336 
Ën
 = 
Ï¡
 - 
off£t
;

4337 ià(
Ën
 == 0)

4339 
Ën
 = 
	`ALIGN
Ö’, 
£ùÜsize
);

4340 
em
 = 
	`g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
Ën
, 0);

4341 ià(
	`IS_ERR_OR_NULL
(
em
))

4342  
em
;

4345 ià(!
	`‹¡_b™
(
EXTENT_FLAG_VACANCY
, &
em
->
æags
) &&

4346 
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

4347  
em
;

4351 
off£t
 = 
	`ex‹Á_m­_’d
(
em
);

4352 
	`ä“_ex‹Á_m­
(
em
);

4353 ià(
off£t
 >ð
Ï¡
)

4356  
NULL
;

4357 
	}
}

4364 
	sf›m­_ÿche
 {

4365 
u64
 
	moff£t
;

4366 
u64
 
	mphys
;

4367 
u64
 
	mËn
;

4368 
u32
 
	mæags
;

4369 
boÞ
 
	mÿched
;

4382 
	$em™_f›m­_ex‹Á
(
f›m­_ex‹Á_šfo
 *
f›šfo
,

4383 
f›m­_ÿche
 *
ÿche
,

4384 
u64
 
off£t
, u64 
phys
, u64 
Ën
, 
u32
 
æags
)

4386 
»t
 = 0;

4388 ià(!
ÿche
->
ÿched
)

4389 
assign
;

4398 ià(
ÿche
->
off£t
 + cache->
Ën
 > offset) {

4399 
	`WARN_ON
(1);

4400  -
EINVAL
;

4414 ià(
ÿche
->
off£t
 + cache->
Ën
 == offset &&

4415 
ÿche
->
phys
 + cache->
Ën
 ==…hys &&

4416 (
ÿche
->
æags
 & ~
FIEMAP_EXTENT_LAST
) ==

4417 (
æags
 & ~
FIEMAP_EXTENT_LAST
)) {

4418 
ÿche
->
Ën
 +=†en;

4419 
ÿche
->
æags
 |= flags;

4420 
Œy_subm™_Ï¡
;

4424 
»t
 = 
	`f›m­_fžl_Ãxt_ex‹Á
(
f›šfo
, 
ÿche
->
off£t
, cache->
phys
,

4425 
ÿche
->
Ën
, cache->
æags
);

4426 
ÿche
->
ÿched
 = 
çl£
;

4427 ià(
»t
)

4428  
»t
;

4429 
assign
:

4430 
ÿche
->
ÿched
 = 
Œue
;

4431 
ÿche
->
off£t
 = offset;

4432 
ÿche
->
phys
 =…hys;

4433 
ÿche
->
Ën
 =†en;

4434 
ÿche
->
æags
 = flags;

4435 
Œy_subm™_Ï¡
:

4436 ià(
ÿche
->
æags
 & 
FIEMAP_EXTENT_LAST
) {

4437 
»t
 = 
	`f›m­_fžl_Ãxt_ex‹Á
(
f›šfo
, 
ÿche
->
off£t
,

4438 
ÿche
->
phys
, cache->
Ën
, cache->
æags
);

4439 
ÿche
->
ÿched
 = 
çl£
;

4441  
»t
;

4442 
	}
}

4455 
	$em™_Ï¡_f›m­_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

4456 
f›m­_ex‹Á_šfo
 *
f›šfo
,

4457 
f›m­_ÿche
 *
ÿche
)

4459 
»t
;

4461 ià(!
ÿche
->
ÿched
)

4464 
»t
 = 
	`f›m­_fžl_Ãxt_ex‹Á
(
f›šfo
, 
ÿche
->
off£t
, cache->
phys
,

4465 
ÿche
->
Ën
, cache->
æags
);

4466 
ÿche
->
ÿched
 = 
çl£
;

4467 ià(
»t
 > 0)

4468 
»t
 = 0;

4469  
»t
;

4470 
	}
}

4472 
	$ex‹Á_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

4473 
__u64
 
¡¬t
, __u64 
Ën
, 
g‘_ex‹Á_t
 *
g‘_ex‹Á
)

4475 
»t
 = 0;

4476 
u64
 
off
 = 
¡¬t
;

4477 
u64
 
max
 = 
¡¬t
 + 
Ën
;

4478 
u32
 
æags
 = 0;

4479 
u32
 
found_ty³
;

4480 
u64
 
Ï¡
;

4481 
u64
 
Ï¡_fÜ_g‘_ex‹Á
 = 0;

4482 
u64
 
disko
 = 0;

4483 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

4484 
bŒfs_key
 
found_key
;

4485 
ex‹Á_m­
 *
em
 = 
NULL
;

4486 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4487 
bŒfs_·th
 *
·th
;

4488 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4489 
f›m­_ÿche
 
ÿche
 = { 0 };

4490 
’d
 = 0;

4491 
u64
 
em_¡¬t
 = 0;

4492 
u64
 
em_Ën
 = 0;

4493 
u64
 
em_’d
 = 0;

4495 ià(
Ën
 == 0)

4496  -
EINVAL
;

4498 
·th
 = 
	`bŒfs_®loc_·th
();

4499 ià(!
·th
)

4500  -
ENOMEM
;

4501 
·th
->
Ëave_¥šnšg
 = 1;

4503 
¡¬t
 = 
	`round_down
(¡¬t, 
	`bŒfs_šode_£ùÜsize
(
šode
));

4504 
Ën
 = 
	`round_up
(
max
, 
	`bŒfs_šode_£ùÜsize
(
šode
)è- 
¡¬t
;

4510 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
NULL
, 
roÙ
, 
·th
,

4511 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), -1, 0);

4512 ià(
»t
 < 0) {

4513 
	`bŒfs_ä“_·th
(
·th
);

4514  
»t
;

4516 
	`WARN_ON
(!
»t
);

4517 ià(
»t
 == 1)

4518 
»t
 = 0;

4521 
·th
->
¦Ùs
[0]--;

4522 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,…©h->
¦Ùs
[0]);

4523 
found_ty³
 = 
found_key
.
ty³
;

4526 ià(
found_key
.
objeùid
 !ð
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)) ||

4527 
found_ty³
 !ð
BTRFS_EXTENT_DATA_KEY
) {

4529 
Ï¡
 = (
u64
)-1;

4530 
Ï¡_fÜ_g‘_ex‹Á
 = 
isize
;

4537 
Ï¡
 = 
found_key
.
off£t
;

4538 
Ï¡_fÜ_g‘_ex‹Á
 = 
Ï¡
 + 1;

4540 
	`bŒfs_»Ëa£_·th
(
·th
);

4547 ià(
Ï¡
 < 
isize
) {

4548 
Ï¡
 = (
u64
)-1;

4549 
Ï¡_fÜ_g‘_ex‹Á
 = 
isize
;

4552 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1,

4553 &
ÿched_¡©e
);

4555 
em
 = 
	`g‘_ex‹Á_sk_hÞes
(
šode
, 
¡¬t
, 
Ï¡_fÜ_g‘_ex‹Á
,

4556 
g‘_ex‹Á
);

4557 ià(!
em
)

4558 
out
;

4559 ià(
	`IS_ERR
(
em
)) {

4560 
»t
 = 
	`PTR_ERR
(
em
);

4561 
out
;

4564 !
’d
) {

4565 
u64
 
off£t_š_ex‹Á
 = 0;

4568 ià(
em
->
¡¬t
 >ð
max
 || 
	`ex‹Á_m­_’d
Ómè< 
off
)

4577 
em_¡¬t
 = 
	`max
(
em
->
¡¬t
, 
off
);

4585 ià(!
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
))

4586 
off£t_š_ex‹Á
 = 
em_¡¬t
 - 
em
->
¡¬t
;

4587 
em_’d
 = 
	`ex‹Á_m­_’d
(
em
);

4588 
em_Ën
 = 
em_’d
 - 
em_¡¬t
;

4589 
disko
 = 0;

4590 
æags
 = 0;

4595 
off
 = 
	`ex‹Á_m­_’d
(
em
);

4596 ià(
off
 >ð
max
)

4597 
’d
 = 1;

4599 ià(
em
->
block_¡¬t
 =ð
EXTENT_MAP_LAST_BYTE
) {

4600 
’d
 = 1;

4601 
æags
 |ð
FIEMAP_EXTENT_LAST
;

4602 } ià(
em
->
block_¡¬t
 =ð
EXTENT_MAP_INLINE
) {

4603 
æags
 |ð(
FIEMAP_EXTENT_DATA_INLINE
 |

4604 
FIEMAP_EXTENT_NOT_ALIGNED
);

4605 } ià(
em
->
block_¡¬t
 =ð
EXTENT_MAP_DELALLOC
) {

4606 
æags
 |ð(
FIEMAP_EXTENT_DELALLOC
 |

4607 
FIEMAP_EXTENT_UNKNOWN
);

4608 } ià(
f›šfo
->
fi_ex‹Ás_max
) {

4609 
u64
 
by‹Ä
 = 
em
->
block_¡¬t
 -

4610 (
em
->
¡¬t
 -ƒm->
Üig_¡¬t
);

4612 
disko
 = 
em
->
block_¡¬t
 + 
off£t_š_ex‹Á
;

4621 
»t
 = 
	`bŒfs_check_sh¬ed
(
roÙ
,

4622 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

4623 
by‹Ä
);

4624 ià(
»t
 < 0)

4625 
out_ä“
;

4626 ià(
»t
)

4627 
æags
 |ð
FIEMAP_EXTENT_SHARED
;

4628 
»t
 = 0;

4630 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
))

4631 
æags
 |ð
FIEMAP_EXTENT_ENCODED
;

4632 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

4633 
æags
 |ð
FIEMAP_EXTENT_UNWRITTEN
;

4635 
	`ä“_ex‹Á_m­
(
em
);

4636 
em
 = 
NULL
;

4637 ià((
em_¡¬t
 >ð
Ï¡
è|| 
em_Ën
 =ð(
u64
)-1 ||

4638 (
Ï¡
 =ð(
u64
)-1 && 
isize
 <ð
em_’d
)) {

4639 
æags
 |ð
FIEMAP_EXTENT_LAST
;

4640 
’d
 = 1;

4644 
em
 = 
	`g‘_ex‹Á_sk_hÞes
(
šode
, 
off
, 
Ï¡_fÜ_g‘_ex‹Á
,

4645 
g‘_ex‹Á
);

4646 ià(
	`IS_ERR
(
em
)) {

4647 
»t
 = 
	`PTR_ERR
(
em
);

4648 
out
;

4650 ià(!
em
) {

4651 
æags
 |ð
FIEMAP_EXTENT_LAST
;

4652 
’d
 = 1;

4654 
»t
 = 
	`em™_f›m­_ex‹Á
(
f›šfo
, &
ÿche
, 
em_¡¬t
, 
disko
,

4655 
em_Ën
, 
æags
);

4656 ià(
»t
) {

4657 ià(
»t
 == 1)

4658 
»t
 = 0;

4659 
out_ä“
;

4662 
out_ä“
:

4663 ià(!
»t
)

4664 
»t
 = 
	`em™_Ï¡_f›m­_ÿche
(
roÙ
->
fs_šfo
, 
f›šfo
, &
ÿche
);

4665 
	`ä“_ex‹Á_m­
(
em
);

4666 
out
:

4667 
	`bŒfs_ä“_·th
(
·th
);

4668 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, s¹ + 
Ën
 - 1,

4669 &
ÿched_¡©e
, 
GFP_NOFS
);

4670  
»t
;

4671 
	}
}

4673 
	$__ä“_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

4675 
	`bŒfs_Ëak_debug_d–
(&
eb
->
Ëak_li¡
);

4676 
	`kmem_ÿche_ä“
(
ex‹Á_bufãr_ÿche
, 
eb
);

4677 
	}
}

4679 
	$ex‹Á_bufãr_und”_io
(
ex‹Á_bufãr
 *
eb
)

4681  (
	`©omic_»ad
(&
eb
->
io_·ges
) ||

4682 
	`‹¡_b™
(
EXTENT_BUFFER_WRITEBACK
, &
eb
->
bæags
) ||

4683 
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

4684 
	}
}

4689 
	$bŒfs_»Ëa£_ex‹Á_bufãr_·ge
(
ex‹Á_bufãr
 *
eb
)

4691 
šdex
;

4692 
·ge
 *page;

4693 
m­³d
 = !
	`‹¡_b™
(
EXTENT_BUFFER_DUMMY
, &
eb
->
bæags
);

4695 
	`BUG_ON
(
	`ex‹Á_bufãr_und”_io
(
eb
));

4697 
šdex
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

4698 ià(
šdex
 == 0)

4702 
šdex
--;

4703 
·ge
 = 
eb
->
·ges
[
šdex
];

4704 ià(!
·ge
)

4706 ià(
m­³d
)

4707 
	`¥š_lock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4715 ià(
	`PagePriv©e
(
·ge
) &&

4716 
·ge
->
´iv©e
 =ð()
eb
) {

4717 
	`BUG_ON
(
	`‹¡_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
));

4718 
	`BUG_ON
(
	`PageDœty
(
·ge
));

4719 
	`BUG_ON
(
	`PageWr™eback
(
·ge
));

4724 
	`CË¬PagePriv©e
(
·ge
);

4725 
	`£t_·ge_´iv©e
(
·ge
, 0);

4727 
	`put_·ge
(
·ge
);

4730 ià(
m­³d
)

4731 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

4734 
	`put_·ge
(
·ge
);

4735 } 
šdex
 != 0);

4736 
	}
}

4741 
šlše
 
	$bŒfs_»Ëa£_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

4743 
	`bŒfs_»Ëa£_ex‹Á_bufãr_·ge
(
eb
);

4744 
	`__ä“_ex‹Á_bufãr
(
eb
);

4745 
	}
}

4747 
ex‹Á_bufãr
 *

4748 
	$__®loc_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
,

4749 
Ën
)

4751 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

4753 
eb
 = 
	`kmem_ÿche_z®loc
(
ex‹Á_bufãr_ÿche
, 
GFP_NOFS
|
__GFP_NOFAIL
);

4754 
eb
->
¡¬t
 = start;

4755 
eb
->
Ën
 =†en;

4756 
eb
->
fs_šfo
 = fs_info;

4757 
eb
->
bæags
 = 0;

4758 
	`rwlock_š™
(&
eb
->
lock
);

4759 
	`©omic_£t
(&
eb
->
wr™e_locks
, 0);

4760 
	`©omic_£t
(&
eb
->
»ad_locks
, 0);

4761 
	`©omic_£t
(&
eb
->
blockšg_»ad”s
, 0);

4762 
	`©omic_£t
(&
eb
->
blockšg_wr™”s
, 0);

4763 
	`©omic_£t
(&
eb
->
¥šnšg_»ad”s
, 0);

4764 
	`©omic_£t
(&
eb
->
¥šnšg_wr™”s
, 0);

4765 
eb
->
lock_Ã¡ed
 = 0;

4766 
	`š™_wa™queue_h—d
(&
eb
->
wr™e_lock_wq
);

4767 
	`š™_wa™queue_h—d
(&
eb
->
»ad_lock_wq
);

4769 
	`bŒfs_Ëak_debug_add
(&
eb
->
Ëak_li¡
, &
bufãrs
);

4771 
	`¥š_lock_š™
(&
eb
->
»fs_lock
);

4772 
	`©omic_£t
(&
eb
->
»fs
, 1);

4773 
	`©omic_£t
(&
eb
->
io_·ges
, 0);

4778 
	`BUILD_BUG_ON
(
BTRFS_MAX_METADATA_BLOCKSIZE


4779 > 
MAX_INLINE_EXTENT_BUFFER_SIZE
);

4780 
	`BUG_ON
(
Ën
 > 
MAX_INLINE_EXTENT_BUFFER_SIZE
);

4782  
eb
;

4783 
	}
}

4785 
ex‹Á_bufãr
 *
	$bŒfs_þÚe_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
¤c
)

4787 
i
;

4788 
·ge
 *
p
;

4789 
ex‹Á_bufãr
 *
Ãw
;

4790 
num_·ges
 = 
	`num_ex‹Á_·ges
(
¤c
->
¡¬t
, src->
Ën
);

4792 
Ãw
 = 
	`__®loc_ex‹Á_bufãr
(
¤c
->
fs_šfo
, src->
¡¬t
, src->
Ën
);

4793 ià(
Ãw
 =ð
NULL
)

4794  
NULL
;

4796 
i
 = 0; i < 
num_·ges
; i++) {

4797 
p
 = 
	`®loc_·ge
(
GFP_NOFS
);

4798 ià(!
p
) {

4799 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
Ãw
);

4800  
NULL
;

4802 
	`©ch_ex‹Á_bufãr_·ge
(
Ãw
, 
p
);

4803 
	`WARN_ON
(
	`PageDœty
(
p
));

4804 
	`S‘PageU±od©e
(
p
);

4805 
Ãw
->
·ges
[
i
] = 
p
;

4806 
	`cÝy_·ge
(
	`·ge_add»ss
(
p
),…age_add»ss(
¤c
->
·ges
[
i
]));

4809 
	`£t_b™
(
EXTENT_BUFFER_UPTODATE
, &
Ãw
->
bæags
);

4810 
	`£t_b™
(
EXTENT_BUFFER_DUMMY
, &
Ãw
->
bæags
);

4812  
Ãw
;

4813 
	}
}

4815 
ex‹Á_bufãr
 *
	$__®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

4816 
u64
 
¡¬t
, 
Ën
)

4818 
ex‹Á_bufãr
 *
eb
;

4819 
num_·ges
;

4820 
i
;

4822 
num_·ges
 = 
	`num_ex‹Á_·ges
(
¡¬t
, 
Ën
);

4824 
eb
 = 
	`__®loc_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
, 
Ën
);

4825 ià(!
eb
)

4826  
NULL
;

4828 
i
 = 0; i < 
num_·ges
; i++) {

4829 
eb
->
·ges
[
i
] = 
	`®loc_·ge
(
GFP_NOFS
);

4830 ià(!
eb
->
·ges
[
i
])

4831 
”r
;

4833 
	`£t_ex‹Á_bufãr_u±od©e
(
eb
);

4834 
	`bŒfs_£t_h—d”_Ä™ems
(
eb
, 0);

4835 
	`£t_b™
(
EXTENT_BUFFER_DUMMY
, &
eb
->
bæags
);

4837  
eb
;

4838 
”r
:

4839 ; 
i
 > 0; i--)

4840 
	`__ä“_·ge
(
eb
->
·ges
[
i
 - 1]);

4841 
	`__ä“_ex‹Á_bufãr
(
eb
);

4842  
NULL
;

4843 
	}
}

4845 
ex‹Á_bufãr
 *
	$®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

4846 
u64
 
¡¬t
)

4848  
	`__®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
, fs_šfo->
nodesize
);

4849 
	}
}

4851 
	$check_bufãr_Œ“_»f
(
ex‹Á_bufãr
 *
eb
)

4853 
»fs
;

4874 
»fs
 = 
	`©omic_»ad
(&
eb
->refs);

4875 ià(
»fs
 >ð2 && 
	`‹¡_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

4878 
	`¥š_lock
(&
eb
->
»fs_lock
);

4879 ià(!
	`‹¡_ªd_£t_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

4880 
	`©omic_šc
(&
eb
->
»fs
);

4881 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

4882 
	}
}

4884 
	$m¬k_ex‹Á_bufãr_acûs£d
(
ex‹Á_bufãr
 *
eb
,

4885 
·ge
 *
acûs£d
)

4887 
num_·ges
, 
i
;

4889 
	`check_bufãr_Œ“_»f
(
eb
);

4891 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

4892 
i
 = 0; i < 
num_·ges
; i++) {

4893 
·ge
 *
p
 = 
eb
->
·ges
[
i
];

4895 ià(
p
 !ð
acûs£d
)

4896 
	`m¬k_·ge_acûs£d
(
p
);

4898 
	}
}

4900 
ex‹Á_bufãr
 *
	$fšd_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

4901 
u64
 
¡¬t
)

4903 
ex‹Á_bufãr
 *
eb
;

4905 
	`rcu_»ad_lock
();

4906 
eb
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
bufãr_¿dix
,

4907 
¡¬t
 >> 
PAGE_SHIFT
);

4908 ià(
eb
 && 
	`©omic_šc_nÙ_z”o
(&eb->
»fs
)) {

4909 
	`rcu_»ad_uÆock
();

4925 ià(
	`‹¡_b™
(
EXTENT_BUFFER_STALE
, &
eb
->
bæags
)) {

4926 
	`¥š_lock
(&
eb
->
»fs_lock
);

4927 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

4929 
	`m¬k_ex‹Á_bufãr_acûs£d
(
eb
, 
NULL
);

4930  
eb
;

4932 
	`rcu_»ad_uÆock
();

4934  
NULL
;

4935 
	}
}

4937 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


4938 
ex‹Á_bufãr
 *
	$®loc_‹¡_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

4939 
u64
 
¡¬t
)

4941 
ex‹Á_bufãr
 *
eb
, *
exi¡s
 = 
NULL
;

4942 
»t
;

4944 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

4945 ià(
eb
)

4946  
eb
;

4947 
eb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

4948 ià(!
eb
)

4949  
NULL
;

4950 
eb
->
fs_šfo
 = fs_info;

4951 
agaš
:

4952 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

4953 ià(
»t
)

4954 
ä“_eb
;

4955 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

4956 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
bufãr_¿dix
,

4957 
¡¬t
 >> 
PAGE_SHIFT
, 
eb
);

4958 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

4959 
	`¿dix_Œ“_´–ßd_’d
();

4960 ià(
»t
 =ð-
EEXIST
) {

4961 
exi¡s
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

4962 ià(
exi¡s
)

4963 
ä“_eb
;

4965 
agaš
;

4967 
	`check_bufãr_Œ“_»f
(
eb
);

4968 
	`£t_b™
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bæags
);

4976 
	`©omic_šc
(&
eb
->
»fs
);

4977  
eb
;

4978 
ä“_eb
:

4979 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
eb
);

4980  
exi¡s
;

4981 
	}
}

4984 
ex‹Á_bufãr
 *
	$®loc_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

4985 
u64
 
¡¬t
)

4987 
Ën
 = 
fs_šfo
->
nodesize
;

4988 
num_·ges
 = 
	`num_ex‹Á_·ges
(
¡¬t
, 
Ën
);

4989 
i
;

4990 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

4991 
ex‹Á_bufãr
 *
eb
;

4992 
ex‹Á_bufãr
 *
exi¡s
 = 
NULL
;

4993 
·ge
 *
p
;

4994 
add»ss_¥aû
 *
m­pšg
 = 
fs_šfo
->
bŒ“_šode
->
i_m­pšg
;

4995 
u±od©e
 = 1;

4996 
»t
;

4998 ià(!
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
)) {

4999 
	`bŒfs_”r
(
fs_šfo
, "bad»block s¹ %Îu", 
¡¬t
);

5000  
	`ERR_PTR
(-
EINVAL
);

5003 
eb
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

5004 ià(
eb
)

5005  
eb
;

5007 
eb
 = 
	`__®loc_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
, 
Ën
);

5008 ià(!
eb
)

5009  
	`ERR_PTR
(-
ENOMEM
);

5011 
i
 = 0; i < 
num_·ges
; i++, 
šdex
++) {

5012 
p
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
šdex
, 
GFP_NOFS
|
__GFP_NOFAIL
);

5013 ià(!
p
) {

5014 
exi¡s
 = 
	`ERR_PTR
(-
ENOMEM
);

5015 
ä“_eb
;

5018 
	`¥š_lock
(&
m­pšg
->
´iv©e_lock
);

5019 ià(
	`PagePriv©e
(
p
)) {

5027 
exi¡s
 = (
ex‹Á_bufãr
 *)
p
->
´iv©e
;

5028 ià(
	`©omic_šc_nÙ_z”o
(&
exi¡s
->
»fs
)) {

5029 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

5030 
	`uÆock_·ge
(
p
);

5031 
	`put_·ge
(
p
);

5032 
	`m¬k_ex‹Á_bufãr_acûs£d
(
exi¡s
, 
p
);

5033 
ä“_eb
;

5035 
exi¡s
 = 
NULL
;

5041 
	`CË¬PagePriv©e
(
p
);

5042 
	`WARN_ON
(
	`PageDœty
(
p
));

5043 
	`put_·ge
(
p
);

5045 
	`©ch_ex‹Á_bufãr_·ge
(
eb
, 
p
);

5046 
	`¥š_uÆock
(&
m­pšg
->
´iv©e_lock
);

5047 
	`WARN_ON
(
	`PageDœty
(
p
));

5048 
eb
->
·ges
[
i
] = 
p
;

5049 ià(!
	`PageU±od©e
(
p
))

5050 
u±od©e
 = 0;

5057 ià(
u±od©e
)

5058 
	`£t_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

5059 
agaš
:

5060 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_NOFS
);

5061 ià(
»t
) {

5062 
exi¡s
 = 
	`ERR_PTR
(
»t
);

5063 
ä“_eb
;

5066 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

5067 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
bufãr_¿dix
,

5068 
¡¬t
 >> 
PAGE_SHIFT
, 
eb
);

5069 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

5070 
	`¿dix_Œ“_´–ßd_’d
();

5071 ià(
»t
 =ð-
EEXIST
) {

5072 
exi¡s
 = 
	`fšd_ex‹Á_bufãr
(
fs_šfo
, 
¡¬t
);

5073 ià(
exi¡s
)

5074 
ä“_eb
;

5076 
agaš
;

5079 
	`check_bufãr_Œ“_»f
(
eb
);

5080 
	`£t_b™
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bæags
);

5091 
	`S‘PageChecked
(
eb
->
·ges
[0]);

5092 
i
 = 1; i < 
num_·ges
; i++) {

5093 
p
 = 
eb
->
·ges
[
i
];

5094 
	`CË¬PageChecked
(
p
);

5095 
	`uÆock_·ge
(
p
);

5097 
	`uÆock_·ge
(
eb
->
·ges
[0]);

5098  
eb
;

5100 
ä“_eb
:

5101 
	`WARN_ON
(!
	`©omic_dec_ªd_‹¡
(&
eb
->
»fs
));

5102 
i
 = 0; i < 
num_·ges
; i++) {

5103 ià(
eb
->
·ges
[
i
])

5104 
	`uÆock_·ge
(
eb
->
·ges
[
i
]);

5107 
	`bŒfs_»Ëa£_ex‹Á_bufãr
(
eb
);

5108  
exi¡s
;

5109 
	}
}

5111 
šlše
 
	$bŒfs_»Ëa£_ex‹Á_bufãr_rcu
(
rcu_h—d
 *
h—d
)

5113 
ex‹Á_bufãr
 *
eb
 =

5114 
	`cÚš”_of
(
h—d
, 
ex‹Á_bufãr
, 
rcu_h—d
);

5116 
	`__ä“_ex‹Á_bufãr
(
eb
);

5117 
	}
}

5120 
	$»Ëa£_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

5122 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

5123 ià(
	`©omic_dec_ªd_‹¡
(&
eb
->
»fs
)) {

5124 ià(
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_IN_TREE
, &
eb
->
bæags
)) {

5125 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

5127 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

5129 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

5130 
	`¿dix_Œ“_d–‘e
(&
fs_šfo
->
bufãr_¿dix
,

5131 
eb
->
¡¬t
 >> 
PAGE_SHIFT
);

5132 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

5134 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

5138 
	`bŒfs_»Ëa£_ex‹Á_bufãr_·ge
(
eb
);

5139 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


5140 ià(
	`uÆik–y
(
	`‹¡_b™
(
EXTENT_BUFFER_DUMMY
, &
eb
->
bæags
))) {

5141 
	`__ä“_ex‹Á_bufãr
(
eb
);

5145 
	`ÿÎ_rcu
(&
eb
->
rcu_h—d
, 
bŒfs_»Ëa£_ex‹Á_bufãr_rcu
);

5148 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

5151 
	}
}

5153 
	$ä“_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
)

5155 
»fs
;

5156 
Þd
;

5157 ià(!
eb
)

5161 
»fs
 = 
	`©omic_»ad
(&
eb
->refs);

5162 ià(
»fs
 <= 3)

5164 
Þd
 = 
	`©omic_cmpxchg
(&
eb
->
»fs
,„efs,„efs - 1);

5165 ià(
Þd
 =ð
»fs
)

5169 
	`¥š_lock
(&
eb
->
»fs_lock
);

5170 ià(
	`©omic_»ad
(&
eb
->
»fs
) == 2 &&

5171 
	`‹¡_b™
(
EXTENT_BUFFER_DUMMY
, &
eb
->
bæags
))

5172 
	`©omic_dec
(&
eb
->
»fs
);

5174 ià(
	`©omic_»ad
(&
eb
->
»fs
) == 2 &&

5175 
	`‹¡_b™
(
EXTENT_BUFFER_STALE
, &
eb
->
bæags
) &&

5176 !
	`ex‹Á_bufãr_und”_io
(
eb
) &&

5177 
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

5178 
	`©omic_dec
(&
eb
->
»fs
);

5184 
	`»Ëa£_ex‹Á_bufãr
(
eb
);

5185 
	}
}

5187 
	$ä“_ex‹Á_bufãr_¡®e
(
ex‹Á_bufãr
 *
eb
)

5189 ià(!
eb
)

5192 
	`¥š_lock
(&
eb
->
»fs_lock
);

5193 
	`£t_b™
(
EXTENT_BUFFER_STALE
, &
eb
->
bæags
);

5195 ià(
	`©omic_»ad
(&
eb
->
»fs
è=ð2 && !
	`ex‹Á_bufãr_und”_io
(eb) &&

5196 
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
))

5197 
	`©omic_dec
(&
eb
->
»fs
);

5198 
	`»Ëa£_ex‹Á_bufãr
(
eb
);

5199 
	}
}

5201 
	$þ—r_ex‹Á_bufãr_dœty
(
ex‹Á_bufãr
 *
eb
)

5203 
i
;

5204 
num_·ges
;

5205 
·ge
 *page;

5207 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

5209 
i
 = 0; i < 
num_·ges
; i++) {

5210 
·ge
 = 
eb
->
·ges
[
i
];

5211 ià(!
	`PageDœty
(
·ge
))

5214 
	`lock_·ge
(
·ge
);

5215 
	`WARN_ON
(!
	`PagePriv©e
(
·ge
));

5217 
	`þ—r_·ge_dœty_fÜ_io
(
·ge
);

5218 
	`¥š_lock_œq
(&
·ge
->
m­pšg
->
Œ“_lock
);

5219 ià(!
	`PageDœty
(
·ge
)) {

5220 
	`¿dix_Œ“_g_þ—r
(&
·ge
->
m­pšg
->
·ge_Œ“
,

5221 
	`·ge_šdex
(
·ge
),

5222 
PAGECACHE_TAG_DIRTY
);

5224 
	`¥š_uÆock_œq
(&
·ge
->
m­pšg
->
Œ“_lock
);

5225 
	`CË¬PageE¼Ü
(
·ge
);

5226 
	`uÆock_·ge
(
·ge
);

5228 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

5229 
	}
}

5231 
	$£t_ex‹Á_bufãr_dœty
(
ex‹Á_bufãr
 *
eb
)

5233 
i
;

5234 
num_·ges
;

5235 
was_dœty
 = 0;

5237 
	`check_bufãr_Œ“_»f
(
eb
);

5239 
was_dœty
 = 
	`‹¡_ªd_£t_b™
(
EXTENT_BUFFER_DIRTY
, &
eb
->
bæags
);

5241 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

5242 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
»fs
) == 0);

5243 
	`WARN_ON
(!
	`‹¡_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
));

5245 
i
 = 0; i < 
num_·ges
; i++)

5246 
	`£t_·ge_dœty
(
eb
->
·ges
[
i
]);

5247  
was_dœty
;

5248 
	}
}

5250 
	$þ—r_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
)

5252 
i
;

5253 
·ge
 *page;

5254 
num_·ges
;

5256 
	`þ—r_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

5257 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

5258 
i
 = 0; i < 
num_·ges
; i++) {

5259 
·ge
 = 
eb
->
·ges
[
i
];

5260 ià(
·ge
)

5261 
	`CË¬PageU±od©e
(
·ge
);

5263 
	}
}

5265 
	$£t_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
)

5267 
i
;

5268 
·ge
 *page;

5269 
num_·ges
;

5271 
	`£t_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

5272 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

5273 
i
 = 0; i < 
num_·ges
; i++) {

5274 
·ge
 = 
eb
->
·ges
[
i
];

5275 
	`S‘PageU±od©e
(
·ge
);

5277 
	}
}

5279 
	$ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
)

5281  
	`‹¡_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

5282 
	}
}

5284 
	$»ad_ex‹Á_bufãr_·ges
(
ex‹Á_io_Œ“
 *
Œ“
,

5285 
ex‹Á_bufãr
 *
eb
, 
wa™
,

5286 
g‘_ex‹Á_t
 *
g‘_ex‹Á
, 
mœrÜ_num
)

5288 
i
;

5289 
·ge
 *page;

5290 
”r
;

5291 
»t
 = 0;

5292 
locked_·ges
 = 0;

5293 
®l_u±od©e
 = 1;

5294 
num_·ges
;

5295 
num_»ads
 = 0;

5296 
bio
 *biØð
NULL
;

5297 
bio_æags
 = 0;

5299 ià(
	`‹¡_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
))

5302 
num_·ges
 = 
	`num_ex‹Á_·ges
(
eb
->
¡¬t
,ƒb->
Ën
);

5303 
i
 = 0; i < 
num_·ges
; i++) {

5304 
·ge
 = 
eb
->
·ges
[
i
];

5305 ià(
wa™
 =ð
WAIT_NONE
) {

5306 ià(!
	`Œylock_·ge
(
·ge
))

5307 
uÆock_ex™
;

5309 
	`lock_·ge
(
·ge
);

5311 
locked_·ges
++;

5318 
i
 = 0; i < 
num_·ges
; i++) {

5319 
·ge
 = 
eb
->
·ges
[
i
];

5320 ià(!
	`PageU±od©e
(
·ge
)) {

5321 
num_»ads
++;

5322 
®l_u±od©e
 = 0;

5326 ià(
®l_u±od©e
) {

5327 
	`£t_b™
(
EXTENT_BUFFER_UPTODATE
, &
eb
->
bæags
);

5328 
uÆock_ex™
;

5331 
	`þ—r_b™
(
EXTENT_BUFFER_READ_ERR
, &
eb
->
bæags
);

5332 
eb
->
»ad_mœrÜ
 = 0;

5333 
	`©omic_£t
(&
eb
->
io_·ges
, 
num_»ads
);

5334 
i
 = 0; i < 
num_·ges
; i++) {

5335 
·ge
 = 
eb
->
·ges
[
i
];

5337 ià(!
	`PageU±od©e
(
·ge
)) {

5338 ià(
»t
) {

5339 
	`©omic_dec
(&
eb
->
io_·ges
);

5340 
	`uÆock_·ge
(
·ge
);

5344 
	`CË¬PageE¼Ü
(
·ge
);

5345 
”r
 = 
	`__ex‹Á_»ad_fuÎ_·ge
(
Œ“
, 
·ge
,

5346 
g‘_ex‹Á
, &
bio
,

5347 
mœrÜ_num
, &
bio_æags
,

5348 
REQ_META
);

5349 ià(
”r
) {

5350 
»t
 = 
”r
;

5359 
	`©omic_dec
(&
eb
->
io_·ges
);

5362 
	`uÆock_·ge
(
·ge
);

5366 ià(
bio
) {

5367 
”r
 = 
	`subm™_Úe_bio
(
bio
, 
mœrÜ_num
, 
bio_æags
);

5368 ià(
”r
)

5369  
”r
;

5372 ià(
»t
 || 
wa™
 !ð
WAIT_COMPLETE
)

5373  
»t
;

5375 
i
 = 0; i < 
num_·ges
; i++) {

5376 
·ge
 = 
eb
->
·ges
[
i
];

5377 
	`wa™_Ú_·ge_locked
(
·ge
);

5378 ià(!
	`PageU±od©e
(
·ge
))

5379 
»t
 = -
EIO
;

5382  
»t
;

5384 
uÆock_ex™
:

5385 
locked_·ges
 > 0) {

5386 
locked_·ges
--;

5387 
·ge
 = 
eb
->
·ges
[
locked_·ges
];

5388 
	`uÆock_·ge
(
·ge
);

5390  
»t
;

5391 
	}
}

5393 
	$»ad_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, *
d¡v
,

5394 
¡¬t
, 
Ën
)

5396 
size_t
 
cur
;

5397 
size_t
 
off£t
;

5398 
·ge
 *page;

5399 *
kaddr
;

5400 *
d¡
 = (*)
d¡v
;

5401 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5402 
i
 = (
¡¬t_off£t
 + 
¡¬t
è>> 
PAGE_SHIFT
;

5404 ià(
¡¬t
 + 
Ën
 > 
eb
->len) {

5405 
	`WARN
(1, 
KERN_ERR
 "btrfs bad mappingƒb start %llu†en %lu, wanted %lu %lu\n",

5406 
eb
->
¡¬t
,ƒb->
Ën
, start,†en);

5407 
	`mem£t
(
d¡
, 0, 
Ën
);

5411 
off£t
 = (
¡¬t_off£t
 + 
¡¬t
è& (
PAGE_SIZE
 - 1);

5413 
Ën
 > 0) {

5414 
·ge
 = 
eb
->
·ges
[
i
];

5416 
cur
 = 
	`mš
(
Ën
, (
PAGE_SIZE
 - 
off£t
));

5417 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5418 
	`memýy
(
d¡
, 
kaddr
 + 
off£t
, 
cur
);

5420 
d¡
 +ð
cur
;

5421 
Ën
 -ð
cur
;

5422 
off£t
 = 0;

5423 
i
++;

5425 
	}
}

5427 
	$»ad_ex‹Á_bufãr_to_u£r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

5428 
__u£r
 *
d¡v
,

5429 
¡¬t
, 
Ën
)

5431 
size_t
 
cur
;

5432 
size_t
 
off£t
;

5433 
·ge
 *page;

5434 *
kaddr
;

5435 
__u£r
 *
d¡
 = (__u£¸*)
d¡v
;

5436 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5437 
i
 = (
¡¬t_off£t
 + 
¡¬t
è>> 
PAGE_SHIFT
;

5438 
»t
 = 0;

5440 
	`WARN_ON
(
¡¬t
 > 
eb
->
Ën
);

5441 
	`WARN_ON
(
¡¬t
 + 
Ën
 > 
eb
->start +ƒb->len);

5443 
off£t
 = (
¡¬t_off£t
 + 
¡¬t
è& (
PAGE_SIZE
 - 1);

5445 
Ën
 > 0) {

5446 
·ge
 = 
eb
->
·ges
[
i
];

5448 
cur
 = 
	`mš
(
Ën
, (
PAGE_SIZE
 - 
off£t
));

5449 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5450 ià(
	`cÝy_to_u£r
(
d¡
, 
kaddr
 + 
off£t
, 
cur
)) {

5451 
»t
 = -
EFAULT
;

5455 
d¡
 +ð
cur
;

5456 
Ën
 -ð
cur
;

5457 
off£t
 = 0;

5458 
i
++;

5461  
»t
;

5462 
	}
}

5469 
	$m­_´iv©e_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

5470 
¡¬t
, 
mš_Ën
,

5471 **
m­
, *
m­_¡¬t
,

5472 *
m­_Ën
)

5474 
size_t
 
off£t
 = 
¡¬t
 & (
PAGE_SIZE
 - 1);

5475 *
kaddr
;

5476 
·ge
 *
p
;

5477 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5478 
i
 = (
¡¬t_off£t
 + 
¡¬t
è>> 
PAGE_SHIFT
;

5479 
’d_i
 = (
¡¬t_off£t
 + 
¡¬t
 + 
mš_Ën
 - 1) >>

5480 
PAGE_SHIFT
;

5482 ià(
¡¬t
 + 
mš_Ën
 > 
eb
->
Ën
) {

5483 
	`WARN
(1, 
KERN_ERR
 "btrfs bad mappingƒb start %llu†en %lu, wanted %lu %lu\n",

5484 
eb
->
¡¬t
,ƒb->
Ën
, s¹, 
mš_Ën
);

5485  -
EINVAL
;

5488 ià(
i
 !ð
’d_i
)

5491 ià(
i
 == 0) {

5492 
off£t
 = 
¡¬t_off£t
;

5493 *
m­_¡¬t
 = 0;

5495 
off£t
 = 0;

5496 *
m­_¡¬t
 = ((
u64
)
i
 << 
PAGE_SHIFT
è- 
¡¬t_off£t
;

5499 
p
 = 
eb
->
·ges
[
i
];

5500 
kaddr
 = 
	`·ge_add»ss
(
p
);

5501 *
m­
 = 
kaddr
 + 
off£t
;

5502 *
m­_Ën
 = 
PAGE_SIZE
 - 
off£t
;

5504 
	}
}

5506 
	$memcmp_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
±rv
,

5507 
¡¬t
, 
Ën
)

5509 
size_t
 
cur
;

5510 
size_t
 
off£t
;

5511 
·ge
 *page;

5512 *
kaddr
;

5513 *
±r
 = (*)
±rv
;

5514 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5515 
i
 = (
¡¬t_off£t
 + 
¡¬t
è>> 
PAGE_SHIFT
;

5516 
»t
 = 0;

5518 
	`WARN_ON
(
¡¬t
 > 
eb
->
Ën
);

5519 
	`WARN_ON
(
¡¬t
 + 
Ën
 > 
eb
->start +ƒb->len);

5521 
off£t
 = (
¡¬t_off£t
 + 
¡¬t
è& (
PAGE_SIZE
 - 1);

5523 
Ën
 > 0) {

5524 
·ge
 = 
eb
->
·ges
[
i
];

5526 
cur
 = 
	`mš
(
Ën
, (
PAGE_SIZE
 - 
off£t
));

5528 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5529 
»t
 = 
	`memcmp
(
±r
, 
kaddr
 + 
off£t
, 
cur
);

5530 ià(
»t
)

5533 
±r
 +ð
cur
;

5534 
Ën
 -ð
cur
;

5535 
off£t
 = 0;

5536 
i
++;

5538  
»t
;

5539 
	}
}

5541 
	$wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
ex‹Á_bufãr
 *
eb
,

5542 cÚ¡ *
¤cv
)

5544 *
kaddr
;

5546 
	`WARN_ON
(!
	`PageU±od©e
(
eb
->
·ges
[0]));

5547 
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]);

5548 
	`memýy
(
kaddr
 + 
	`off£tof
(
bŒfs_h—d”
, 
chunk_Œ“_uuid
), 
¤cv
,

5549 
BTRFS_FSID_SIZE
);

5550 
	}
}

5552 
	$wr™e_ex‹Á_bufãr_fsid
(
ex‹Á_bufãr
 *
eb
, cÚ¡ *
¤cv
)

5554 *
kaddr
;

5556 
	`WARN_ON
(!
	`PageU±od©e
(
eb
->
·ges
[0]));

5557 
kaddr
 = 
	`·ge_add»ss
(
eb
->
·ges
[0]);

5558 
	`memýy
(
kaddr
 + 
	`off£tof
(
bŒfs_h—d”
, 
fsid
), 
¤cv
,

5559 
BTRFS_FSID_SIZE
);

5560 
	}
}

5562 
	$wr™e_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
, cÚ¡ *
¤cv
,

5563 
¡¬t
, 
Ën
)

5565 
size_t
 
cur
;

5566 
size_t
 
off£t
;

5567 
·ge
 *page;

5568 *
kaddr
;

5569 *
¤c
 = (*)
¤cv
;

5570 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5571 
i
 = (
¡¬t_off£t
 + 
¡¬t
è>> 
PAGE_SHIFT
;

5573 
	`WARN_ON
(
¡¬t
 > 
eb
->
Ën
);

5574 
	`WARN_ON
(
¡¬t
 + 
Ën
 > 
eb
->start +ƒb->len);

5576 
off£t
 = (
¡¬t_off£t
 + 
¡¬t
è& (
PAGE_SIZE
 - 1);

5578 
Ën
 > 0) {

5579 
·ge
 = 
eb
->
·ges
[
i
];

5580 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5582 
cur
 = 
	`mš
(
Ën
, 
PAGE_SIZE
 - 
off£t
);

5583 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5584 
	`memýy
(
kaddr
 + 
off£t
, 
¤c
, 
cur
);

5586 
¤c
 +ð
cur
;

5587 
Ën
 -ð
cur
;

5588 
off£t
 = 0;

5589 
i
++;

5591 
	}
}

5593 
	$memz”o_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

5594 
Ën
)

5596 
size_t
 
cur
;

5597 
size_t
 
off£t
;

5598 
·ge
 *page;

5599 *
kaddr
;

5600 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5601 
i
 = (
¡¬t_off£t
 + 
¡¬t
è>> 
PAGE_SHIFT
;

5603 
	`WARN_ON
(
¡¬t
 > 
eb
->
Ën
);

5604 
	`WARN_ON
(
¡¬t
 + 
Ën
 > 
eb
->start +ƒb->len);

5606 
off£t
 = (
¡¬t_off£t
 + 
¡¬t
è& (
PAGE_SIZE
 - 1);

5608 
Ën
 > 0) {

5609 
·ge
 = 
eb
->
·ges
[
i
];

5610 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5612 
cur
 = 
	`mš
(
Ën
, 
PAGE_SIZE
 - 
off£t
);

5613 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5614 
	`mem£t
(
kaddr
 + 
off£t
, 0, 
cur
);

5616 
Ën
 -ð
cur
;

5617 
off£t
 = 0;

5618 
i
++;

5620 
	}
}

5622 
	$cÝy_ex‹Á_bufãr_fuÎ
(
ex‹Á_bufãr
 *
d¡
,

5623 
ex‹Á_bufãr
 *
¤c
)

5625 
i
;

5626 
num_·ges
;

5628 
	`ASSERT
(
d¡
->
Ën
 =ð
¤c
->len);

5630 
num_·ges
 = 
	`num_ex‹Á_·ges
(
d¡
->
¡¬t
, d¡->
Ën
);

5631 
i
 = 0; i < 
num_·ges
; i++)

5632 
	`cÝy_·ge
(
	`·ge_add»ss
(
d¡
->
·ges
[
i
]),

5633 
	`·ge_add»ss
(
¤c
->
·ges
[
i
]));

5634 
	}
}

5636 
	$cÝy_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
d¡
, ex‹Á_bufã¸*
¤c
,

5637 
d¡_off£t
, 
¤c_off£t
,

5638 
Ën
)

5640 
u64
 
d¡_Ën
 = 
d¡
->
Ën
;

5641 
size_t
 
cur
;

5642 
size_t
 
off£t
;

5643 
·ge
 *page;

5644 *
kaddr
;

5645 
size_t
 
¡¬t_off£t
 = 
d¡
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5646 
i
 = (
¡¬t_off£t
 + 
d¡_off£t
è>> 
PAGE_SHIFT
;

5648 
	`WARN_ON
(
¤c
->
Ën
 !ð
d¡_Ën
);

5650 
off£t
 = (
¡¬t_off£t
 + 
d¡_off£t
) &

5651 (
PAGE_SIZE
 - 1);

5653 
Ën
 > 0) {

5654 
·ge
 = 
d¡
->
·ges
[
i
];

5655 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5657 
cur
 = 
	`mš
(
Ën
, ()(
PAGE_SIZE
 - 
off£t
));

5659 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5660 
	`»ad_ex‹Á_bufãr
(
¤c
, 
kaddr
 + 
off£t
, 
¤c_off£t
, 
cur
);

5662 
¤c_off£t
 +ð
cur
;

5663 
Ën
 -ð
cur
;

5664 
off£t
 = 0;

5665 
i
++;

5667 
	}
}

5669 
	$Ë_b™m­_£t
(
u8
 *
m­
, 
¡¬t
, 
Ën
)

5671 
u8
 *
p
 = 
m­
 + 
	`BIT_BYTE
(
¡¬t
);

5672 cÚ¡ 
size
 = 
¡¬t
 + 
Ën
;

5673 
b™s_to_£t
 = 
BITS_PER_BYTE
 - (
¡¬t
 % BITS_PER_BYTE);

5674 
u8
 
mask_to_£t
 = 
	`BITMAP_FIRST_BYTE_MASK
(
¡¬t
);

5676 
Ën
 - 
b™s_to_£t
 >= 0) {

5677 *
p
 |ð
mask_to_£t
;

5678 
Ën
 -ð
b™s_to_£t
;

5679 
b™s_to_£t
 = 
BITS_PER_BYTE
;

5680 
mask_to_£t
 = ~0;

5681 
p
++;

5683 ià(
Ën
) {

5684 
mask_to_£t
 &ð
	`BITMAP_LAST_BYTE_MASK
(
size
);

5685 *
p
 |ð
mask_to_£t
;

5687 
	}
}

5689 
	$Ë_b™m­_þ—r
(
u8
 *
m­
, 
¡¬t
, 
Ën
)

5691 
u8
 *
p
 = 
m­
 + 
	`BIT_BYTE
(
¡¬t
);

5692 cÚ¡ 
size
 = 
¡¬t
 + 
Ën
;

5693 
b™s_to_þ—r
 = 
BITS_PER_BYTE
 - (
¡¬t
 % BITS_PER_BYTE);

5694 
u8
 
mask_to_þ—r
 = 
	`BITMAP_FIRST_BYTE_MASK
(
¡¬t
);

5696 
Ën
 - 
b™s_to_þ—r
 >= 0) {

5697 *
p
 &ð~
mask_to_þ—r
;

5698 
Ën
 -ð
b™s_to_þ—r
;

5699 
b™s_to_þ—r
 = 
BITS_PER_BYTE
;

5700 
mask_to_þ—r
 = ~0;

5701 
p
++;

5703 ià(
Ën
) {

5704 
mask_to_þ—r
 &ð
	`BITMAP_LAST_BYTE_MASK
(
size
);

5705 *
p
 &ð~
mask_to_þ—r
;

5707 
	}
}

5722 
šlše
 
	$eb_b™m­_off£t
(
ex‹Á_bufãr
 *
eb
,

5723 
¡¬t
, 
Ä
,

5724 *
·ge_šdex
,

5725 
size_t
 *
·ge_off£t
)

5727 
size_t
 
¡¬t_off£t
 = 
eb
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5728 
size_t
 
by‹_off£t
 = 
	`BIT_BYTE
(
Ä
);

5729 
size_t
 
off£t
;

5736 
off£t
 = 
¡¬t_off£t
 + 
¡¬t
 + 
by‹_off£t
;

5738 *
·ge_šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

5739 *
·ge_off£t
 = 
off£t
 & (
PAGE_SIZE
 - 1);

5740 
	}
}

5748 
	$ex‹Á_bufãr_‹¡_b™
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

5749 
Ä
)

5751 
u8
 *
kaddr
;

5752 
·ge
 *page;

5753 
i
;

5754 
size_t
 
off£t
;

5756 
	`eb_b™m­_off£t
(
eb
, 
¡¬t
, 
Ä
, &
i
, &
off£t
);

5757 
·ge
 = 
eb
->
·ges
[
i
];

5758 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5759 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5760  1U & (
kaddr
[
off£t
] >> (
Ä
 & (
BITS_PER_BYTE
 - 1)));

5761 
	}
}

5770 
	$ex‹Á_bufãr_b™m­_£t
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

5771 
pos
, 
Ën
)

5773 
u8
 *
kaddr
;

5774 
·ge
 *page;

5775 
i
;

5776 
size_t
 
off£t
;

5777 cÚ¡ 
size
 = 
pos
 + 
Ën
;

5778 
b™s_to_£t
 = 
BITS_PER_BYTE
 - (
pos
 % BITS_PER_BYTE);

5779 
u8
 
mask_to_£t
 = 
	`BITMAP_FIRST_BYTE_MASK
(
pos
);

5781 
	`eb_b™m­_off£t
(
eb
, 
¡¬t
, 
pos
, &
i
, &
off£t
);

5782 
·ge
 = 
eb
->
·ges
[
i
];

5783 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5784 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5786 
Ën
 >ð
b™s_to_£t
) {

5787 
kaddr
[
off£t
] |ð
mask_to_£t
;

5788 
Ën
 -ð
b™s_to_£t
;

5789 
b™s_to_£t
 = 
BITS_PER_BYTE
;

5790 
mask_to_£t
 = ~0;

5791 ià(++
off£t
 >ð
PAGE_SIZE
 && 
Ën
 > 0) {

5792 
off£t
 = 0;

5793 
·ge
 = 
eb
->
·ges
[++
i
];

5794 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5795 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5798 ià(
Ën
) {

5799 
mask_to_£t
 &ð
	`BITMAP_LAST_BYTE_MASK
(
size
);

5800 
kaddr
[
off£t
] |ð
mask_to_£t
;

5802 
	}
}

5812 
	$ex‹Á_bufãr_b™m­_þ—r
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

5813 
pos
, 
Ën
)

5815 
u8
 *
kaddr
;

5816 
·ge
 *page;

5817 
i
;

5818 
size_t
 
off£t
;

5819 cÚ¡ 
size
 = 
pos
 + 
Ën
;

5820 
b™s_to_þ—r
 = 
BITS_PER_BYTE
 - (
pos
 % BITS_PER_BYTE);

5821 
u8
 
mask_to_þ—r
 = 
	`BITMAP_FIRST_BYTE_MASK
(
pos
);

5823 
	`eb_b™m­_off£t
(
eb
, 
¡¬t
, 
pos
, &
i
, &
off£t
);

5824 
·ge
 = 
eb
->
·ges
[
i
];

5825 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5826 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5828 
Ën
 >ð
b™s_to_þ—r
) {

5829 
kaddr
[
off£t
] &ð~
mask_to_þ—r
;

5830 
Ën
 -ð
b™s_to_þ—r
;

5831 
b™s_to_þ—r
 = 
BITS_PER_BYTE
;

5832 
mask_to_þ—r
 = ~0;

5833 ià(++
off£t
 >ð
PAGE_SIZE
 && 
Ën
 > 0) {

5834 
off£t
 = 0;

5835 
·ge
 = 
eb
->
·ges
[++
i
];

5836 
	`WARN_ON
(!
	`PageU±od©e
(
·ge
));

5837 
kaddr
 = 
	`·ge_add»ss
(
·ge
);

5840 ià(
Ën
) {

5841 
mask_to_þ—r
 &ð
	`BITMAP_LAST_BYTE_MASK
(
size
);

5842 
kaddr
[
off£t
] &ð~
mask_to_þ—r
;

5844 
	}
}

5846 
šlše
 
boÞ
 
	$¬—s_ov”Ïp
(
¤c
, 
d¡
, 
Ën
)

5848 
di¡ªû
 = (
¤c
 > 
d¡
) ? src - dst : dst - src;

5849  
di¡ªû
 < 
Ën
;

5850 
	}
}

5852 
	$cÝy_·ges
(
·ge
 *
d¡_·ge
, ·g*
¤c_·ge
,

5853 
d¡_off
, 
¤c_off
,

5854 
Ën
)

5856 *
d¡_kaddr
 = 
	`·ge_add»ss
(
d¡_·ge
);

5857 *
¤c_kaddr
;

5858 
mu¡_memmove
 = 0;

5860 ià(
d¡_·ge
 !ð
¤c_·ge
) {

5861 
¤c_kaddr
 = 
	`·ge_add»ss
(
¤c_·ge
);

5863 
¤c_kaddr
 = 
d¡_kaddr
;

5864 ià(
	`¬—s_ov”Ïp
(
¤c_off
, 
d¡_off
, 
Ën
))

5865 
mu¡_memmove
 = 1;

5868 ià(
mu¡_memmove
)

5869 
	`memmove
(
d¡_kaddr
 + 
d¡_off
, 
¤c_kaddr
 + 
¤c_off
, 
Ën
);

5871 
	`memýy
(
d¡_kaddr
 + 
d¡_off
, 
¤c_kaddr
 + 
¤c_off
, 
Ën
);

5872 
	}
}

5874 
	$memýy_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
d¡
, 
d¡_off£t
,

5875 
¤c_off£t
, 
Ën
)

5877 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d¡
->fs_info;

5878 
size_t
 
cur
;

5879 
size_t
 
d¡_off_š_·ge
;

5880 
size_t
 
¤c_off_š_·ge
;

5881 
size_t
 
¡¬t_off£t
 = 
d¡
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5882 
d¡_i
;

5883 
¤c_i
;

5885 ià(
¤c_off£t
 + 
Ën
 > 
d¡
->len) {

5886 
	`bŒfs_”r
(
fs_šfo
,

5888 
¤c_off£t
, 
Ën
, 
d¡
->len);

5889 
	`BUG_ON
(1);

5891 ià(
d¡_off£t
 + 
Ën
 > 
d¡
->len) {

5892 
	`bŒfs_”r
(
fs_šfo
,

5894 
d¡_off£t
, 
Ën
, 
d¡
->len);

5895 
	`BUG_ON
(1);

5898 
Ën
 > 0) {

5899 
d¡_off_š_·ge
 = (
¡¬t_off£t
 + 
d¡_off£t
) &

5900 (
PAGE_SIZE
 - 1);

5901 
¤c_off_š_·ge
 = (
¡¬t_off£t
 + 
¤c_off£t
) &

5902 (
PAGE_SIZE
 - 1);

5904 
d¡_i
 = (
¡¬t_off£t
 + 
d¡_off£t
è>> 
PAGE_SHIFT
;

5905 
¤c_i
 = (
¡¬t_off£t
 + 
¤c_off£t
è>> 
PAGE_SHIFT
;

5907 
cur
 = 
	`mš
(
Ën
, ()(
PAGE_SIZE
 -

5908 
¤c_off_š_·ge
));

5909 
cur
 = 
	`mš_t
(, cur,

5910 ()(
PAGE_SIZE
 - 
d¡_off_š_·ge
));

5912 
	`cÝy_·ges
(
d¡
->
·ges
[
d¡_i
], d¡->·ges[
¤c_i
],

5913 
d¡_off_š_·ge
, 
¤c_off_š_·ge
, 
cur
);

5915 
¤c_off£t
 +ð
cur
;

5916 
d¡_off£t
 +ð
cur
;

5917 
Ën
 -ð
cur
;

5919 
	}
}

5921 
	$memmove_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
d¡
, 
d¡_off£t
,

5922 
¤c_off£t
, 
Ën
)

5924 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d¡
->fs_info;

5925 
size_t
 
cur
;

5926 
size_t
 
d¡_off_š_·ge
;

5927 
size_t
 
¤c_off_š_·ge
;

5928 
d¡_’d
 = 
d¡_off£t
 + 
Ën
 - 1;

5929 
¤c_’d
 = 
¤c_off£t
 + 
Ën
 - 1;

5930 
size_t
 
¡¬t_off£t
 = 
d¡
->
¡¬t
 & ((
u64
)
PAGE_SIZE
 - 1);

5931 
d¡_i
;

5932 
¤c_i
;

5934 ià(
¤c_off£t
 + 
Ën
 > 
d¡
->len) {

5935 
	`bŒfs_”r
(
fs_šfo
,

5937 
¤c_off£t
, 
Ën
, 
d¡
->len);

5938 
	`BUG_ON
(1);

5940 ià(
d¡_off£t
 + 
Ën
 > 
d¡
->len) {

5941 
	`bŒfs_”r
(
fs_šfo
,

5943 
d¡_off£t
, 
Ën
, 
d¡
->len);

5944 
	`BUG_ON
(1);

5946 ià(
d¡_off£t
 < 
¤c_off£t
) {

5947 
	`memýy_ex‹Á_bufãr
(
d¡
, 
d¡_off£t
, 
¤c_off£t
, 
Ën
);

5950 
Ën
 > 0) {

5951 
d¡_i
 = (
¡¬t_off£t
 + 
d¡_’d
è>> 
PAGE_SHIFT
;

5952 
¤c_i
 = (
¡¬t_off£t
 + 
¤c_’d
è>> 
PAGE_SHIFT
;

5954 
d¡_off_š_·ge
 = (
¡¬t_off£t
 + 
d¡_’d
) &

5955 (
PAGE_SIZE
 - 1);

5956 
¤c_off_š_·ge
 = (
¡¬t_off£t
 + 
¤c_’d
) &

5957 (
PAGE_SIZE
 - 1);

5959 
cur
 = 
	`mš_t
(, 
Ën
, 
¤c_off_š_·ge
 + 1);

5960 
cur
 = 
	`mš
(cur, 
d¡_off_š_·ge
 + 1);

5961 
	`cÝy_·ges
(
d¡
->
·ges
[
d¡_i
], d¡->·ges[
¤c_i
],

5962 
d¡_off_š_·ge
 - 
cur
 + 1,

5963 
¤c_off_š_·ge
 - 
cur
 + 1, cur);

5965 
d¡_’d
 -ð
cur
;

5966 
¤c_’d
 -ð
cur
;

5967 
Ën
 -ð
cur
;

5969 
	}
}

5971 
	$Œy_»Ëa£_ex‹Á_bufãr
(
·ge
 *page)

5973 
ex‹Á_bufãr
 *
eb
;

5979 
	`¥š_lock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

5980 ià(!
	`PagePriv©e
(
·ge
)) {

5981 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

5985 
eb
 = (
ex‹Á_bufãr
 *)
·ge
->
´iv©e
;

5986 
	`BUG_ON
(!
eb
);

5993 
	`¥š_lock
(&
eb
->
»fs_lock
);

5994 ià(
	`©omic_»ad
(&
eb
->
»fs
è!ð1 || 
	`ex‹Á_bufãr_und”_io
(eb)) {

5995 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

5996 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

5999 
	`¥š_uÆock
(&
·ge
->
m­pšg
->
´iv©e_lock
);

6005 ià(!
	`‹¡_ªd_þ—r_b™
(
EXTENT_BUFFER_TREE_REF
, &
eb
->
bæags
)) {

6006 
	`¥š_uÆock
(&
eb
->
»fs_lock
);

6010  
	`»Ëa£_ex‹Á_bufãr
(
eb
);

6011 
	}
}

	@extent_io.h

2 #iâdeà
__EXTENTIO__


3 
	#__EXTENTIO__


	)

5 
	~<lšux/rbŒ“.h
>

6 
	~<lšux/»fcouÁ.h
>

7 
	~"uli¡.h
"

10 
	#EXTENT_DIRTY
 (1U << 0)

	)

11 
	#EXTENT_WRITEBACK
 (1U << 1)

	)

12 
	#EXTENT_UPTODATE
 (1U << 2)

	)

13 
	#EXTENT_LOCKED
 (1U << 3)

	)

14 
	#EXTENT_NEW
 (1U << 4)

	)

15 
	#EXTENT_DELALLOC
 (1U << 5)

	)

16 
	#EXTENT_DEFRAG
 (1U << 6)

	)

17 
	#EXTENT_BOUNDARY
 (1U << 9)

	)

18 
	#EXTENT_NODATASUM
 (1U << 10)

	)

19 
	#EXTENT_CLEAR_META_RESV
 (1U << 11)

	)

20 
	#EXTENT_FIRST_DELALLOC
 (1U << 12)

	)

21 
	#EXTENT_NEED_WAIT
 (1U << 13)

	)

22 
	#EXTENT_DAMAGED
 (1U << 14)

	)

23 
	#EXTENT_NORESERVE
 (1U << 15)

	)

24 
	#EXTENT_QGROUP_RESERVED
 (1U << 16)

	)

25 
	#EXTENT_CLEAR_DATA_RESV
 (1U << 17)

	)

26 
	#EXTENT_DELALLOC_NEW
 (1U << 18)

	)

27 
	#EXTENT_IOBITS
 (
EXTENT_LOCKED
 | 
EXTENT_WRITEBACK
)

	)

28 
	#EXTENT_DO_ACCOUNTING
 (
EXTENT_CLEAR_META_RESV
 | \

29 
EXTENT_CLEAR_DATA_RESV
)

	)

30 
	#EXTENT_CTLBITS
 (
EXTENT_DO_ACCOUNTING
 | 
EXTENT_FIRST_DELALLOC
)

	)

36 
	#EXTENT_BIO_COMPRESSED
 1

	)

37 
	#EXTENT_BIO_TREE_LOG
 2

	)

38 
	#EXTENT_BIO_FLAG_SHIFT
 16

	)

41 
	#EXTENT_BUFFER_UPTODATE
 0

	)

42 
	#EXTENT_BUFFER_DIRTY
 2

	)

43 
	#EXTENT_BUFFER_CORRUPT
 3

	)

44 
	#EXTENT_BUFFER_READAHEAD
 4

	)

45 
	#EXTENT_BUFFER_TREE_REF
 5

	)

46 
	#EXTENT_BUFFER_STALE
 6

	)

47 
	#EXTENT_BUFFER_WRITEBACK
 7

	)

48 
	#EXTENT_BUFFER_READ_ERR
 8

	)

49 
	#EXTENT_BUFFER_DUMMY
 9

	)

50 
	#EXTENT_BUFFER_IN_TREE
 10

	)

51 
	#EXTENT_BUFFER_WRITE_ERR
 11

	)

54 
	#PAGE_UNLOCK
 (1 << 0)

	)

55 
	#PAGE_CLEAR_DIRTY
 (1 << 1)

	)

56 
	#PAGE_SET_WRITEBACK
 (1 << 2)

	)

57 
	#PAGE_END_WRITEBACK
 (1 << 3)

	)

58 
	#PAGE_SET_PRIVATE2
 (1 << 4)

	)

59 
	#PAGE_SET_ERROR
 (1 << 5)

	)

60 
	#PAGE_LOCK
 (1 << 6)

	)

66 
	#EXTENT_PAGE_PRIVATE
 1

	)

75 
	#BIT_BYTE
(
Ä
è(Òrè/ 
BITS_PER_BYTE
)

	)

76 
	#BYTE_MASK
 ((1 << 
BITS_PER_BYTE
è- 1)

	)

77 
	#BITMAP_FIRST_BYTE_MASK
(
¡¬t
) \

78 ((
BYTE_MASK
 << ((
¡¬t
è& (
BITS_PER_BYTE
 - 1))è& BYTE_MASK)

	)

79 
	#BITMAP_LAST_BYTE_MASK
(
nb™s
) \

80 (
BYTE_MASK
 >> (-(
nb™s
è& (
BITS_PER_BYTE
 - 1)))

	)

82 
šlše
 
	$Ë_‹¡_b™
(
Ä
, cÚ¡ 
u8
 *
addr
)

84  1U & (
addr
[
	`BIT_BYTE
(
Ä
)] >> (Ä & (
BITS_PER_BYTE
-1)));

85 
	}
}

87 
Ë_b™m­_£t
(
u8
 *
m­
, 
¡¬t
, 
Ën
);

88 
Ë_b™m­_þ—r
(
u8
 *
m­
, 
¡¬t
, 
Ën
);

90 
	gex‹Á_¡©e
;

91 
	gbŒfs_roÙ
;

92 
	gbŒfs_šode
;

93 
	gbŒfs_io_bio
;

94 
	gio_çžu»_»cÜd
;

96 
	$blk_¡©us_t
 (
	tex‹Á_subm™_bio_hook_t
)(*
	t´iv©e_d©a
, 
	tbio
 *bio,

97 
	tmœrÜ_num
, 
	tbio_æags
,

98 
	tu64
 
	tbio_off£t
);

99 
	sex‹Á_io_Ýs
 {

104 
ex‹Á_subm™_bio_hook_t
 *
subm™_bio_hook
;

105 (*
»ad·ge_’d_io_hook
)(
bŒfs_io_bio
 *
io_bio
, 
u64
 
phy_off£t
,

106 
·ge
 *·ge, 
u64
 
¡¬t
, u64 
’d
,

107 
mœrÜ
);

108 (*
m”ge_bio_hook
)(
·ge
 *·ge, 
off£t
,

109 
size_t
 
size
, 
bio
 *bio,

110 
bio_æags
);

111 (*
»ad·ge_io_çžed_hook
)(
·ge
 *·ge, 
çžed_mœrÜ
);

112 
bŒfs_fs_šfo
 *(*
Œ“_fs_šfo
)(*
´iv©e_d©a
);

113 (*
£t_¿nge_wr™eback
)(*
´iv©e_d©a
, 
u64
 
¡¬t
, u64 
’d
);

118 (*
fžl_d–®loc
)(*
´iv©e_d©a
, 
·ge
 *
locked_·ge
,

119 
u64
 
¡¬t
, u64 
’d
, *
·ge_¡¬‹d
,

120 *
Ä_wr™‹n
);

122 (*
wr™•age_¡¬t_hook
)(
·ge
 *·ge, 
u64
 
¡¬t
, u64 
’d
);

123 (*
wr™•age_’d_io_hook
)(
·ge
 *·ge, 
u64
 
¡¬t
, u64 
’d
,

124 
ex‹Á_¡©e
 *
¡©e
, 
u±od©e
);

125 (*
£t_b™_hook
)(*
´iv©e_d©a
, 
ex‹Á_¡©e
 *
¡©e
,

126 *
b™s
);

127 (*
þ—r_b™_hook
)(*
´iv©e_d©a
,

128 
ex‹Á_¡©e
 *
¡©e
,

129 *
b™s
);

130 (*
m”ge_ex‹Á_hook
)(*
´iv©e_d©a
,

131 
ex‹Á_¡©e
 *
Ãw
,

132 
ex‹Á_¡©e
 *
Ùh”
);

133 (*
¥l™_ex‹Á_hook
)(*
´iv©e_d©a
,

134 
ex‹Á_¡©e
 *
Üig
, 
u64
 
¥l™
);

135 (*
check_ex‹Á_io_¿nge
)(*
´iv©e_d©a
, cÚ¡ *
ÿÎ”
,

136 
u64
 
¡¬t
, u64 
’d
);

139 
	sex‹Á_io_Œ“
 {

140 
rb_roÙ
 
¡©e
;

141 *
´iv©e_d©a
;

142 
u64
 
dœty_by‹s
;

143 
Œack_u±od©e
;

144 
¥šlock_t
 
lock
;

145 cÚ¡ 
ex‹Á_io_Ýs
 *
Ýs
;

148 
	sex‹Á_¡©e
 {

149 
u64
 
¡¬t
;

150 
u64
 
’d
;

151 
rb_node
„b_node;

154 
wa™_queue_h—d_t
 
wq
;

155 
»fcouÁ_t
 
»fs
;

156 
¡©e
;

158 
io_çžu»_»cÜd
 *
çž»c
;

160 #ifdeà
CONFIG_BTRFS_DEBUG


161 
li¡_h—d
 
Ëak_li¡
;

165 
	#INLINE_EXTENT_BUFFER_PAGES
 16

	)

166 
	#MAX_INLINE_EXTENT_BUFFER_SIZE
 (
INLINE_EXTENT_BUFFER_PAGES
 * 
PAGE_SIZE
)

	)

167 
	sex‹Á_bufãr
 {

168 
u64
 
¡¬t
;

169 
Ën
;

170 
bæags
;

171 
bŒfs_fs_šfo
 *
fs_šfo
;

172 
¥šlock_t
 
»fs_lock
;

173 
©omic_t
 
»fs
;

174 
©omic_t
 
io_·ges
;

175 
»ad_mœrÜ
;

176 
rcu_h—d
„cu_head;

177 
pid_t
 
lock_owÃr
;

180 
©omic_t
 
wr™e_locks
;

181 
©omic_t
 
»ad_locks
;

182 
©omic_t
 
blockšg_wr™”s
;

183 
©omic_t
 
blockšg_»ad”s
;

184 
©omic_t
 
¥šnšg_»ad”s
;

185 
©omic_t
 
¥šnšg_wr™”s
;

186 
lock_Ã¡ed
;

188 
log_šdex
;

191 
rwlock_t
 
lock
;

196 
wa™_queue_h—d_t
 
wr™e_lock_wq
;

201 
wa™_queue_h—d_t
 
»ad_lock_wq
;

202 
·ge
 *
·ges
[
INLINE_EXTENT_BUFFER_PAGES
];

203 #ifdeà
CONFIG_BTRFS_DEBUG


204 
li¡_h—d
 
Ëak_li¡
;

211 
	sex‹Á_chªge£t
 {

213 
by‹s_chªged
;

216 
uli¡
 
¿nge_chªged
;

219 
šlše
 
	$ex‹Á_chªge£t_š™
(
ex‹Á_chªge£t
 *
chªge£t
)

221 
chªge£t
->
by‹s_chªged
 = 0;

222 
	`uli¡_š™
(&
chªge£t
->
¿nge_chªged
);

223 
	}
}

225 
šlše
 
ex‹Á_chªge£t
 *
	$ex‹Á_chªge£t_®loc
()

227 
ex‹Á_chªge£t
 *
»t
;

229 
»t
 = 
	`km®loc
((*»t), 
GFP_KERNEL
);

230 ià(!
»t
)

231  
NULL
;

233 
	`ex‹Á_chªge£t_š™
(
»t
);

234  
»t
;

235 
	}
}

237 
šlše
 
	$ex‹Á_chªge£t_»Ëa£
(
ex‹Á_chªge£t
 *
chªge£t
)

239 ià(!
chªge£t
)

241 
chªge£t
->
by‹s_chªged
 = 0;

242 
	`uli¡_»Ëa£
(&
chªge£t
->
¿nge_chªged
);

243 
	}
}

245 
šlše
 
	$ex‹Á_chªge£t_ä“
(
ex‹Á_chªge£t
 *
chªge£t
)

247 ià(!
chªge£t
)

249 
	`ex‹Á_chªge£t_»Ëa£
(
chªge£t
);

250 
	`kä“
(
chªge£t
);

251 
	}
}

253 
šlše
 
	$ex‹Á_£t_com´ess_ty³
(*
bio_æags
,

254 
com´ess_ty³
)

256 *
bio_æags
 |ð
com´ess_ty³
 << 
EXTENT_BIO_FLAG_SHIFT
;

257 
	}
}

259 
šlše
 
	$ex‹Á_com´ess_ty³
(
bio_æags
)

261  
bio_æags
 >> 
EXTENT_BIO_FLAG_SHIFT
;

262 
	}
}

264 
	gex‹Á_m­_Œ“
;

266 
	gex‹Á_m­
 *(
	tg‘_ex‹Á_t
)(
	tbŒfs_šode
 *
	tšode
,

267 
	t·ge
 *page,

268 
	tsize_t
 
	tpg_off£t
,

269 
	tu64
 
	t¡¬t
, u64 
	tËn
,

270 
	tü—‹
);

272 
ex‹Á_io_Œ“_š™
(
ex‹Á_io_Œ“
 *
Œ“
, *
´iv©e_d©a
);

273 
Œy_»Ëa£_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
m­
,

274 
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

275 
gå_t
 
mask
);

276 
Œy_»Ëa£_ex‹Á_bufãr
(
·ge
 *page);

277 
lock_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

278 
ex‹Á_¡©e
 **
ÿched
);

280 
šlše
 
	$lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
)

282  
	`lock_ex‹Á_b™s
(
Œ“
, 
¡¬t
, 
’d
, 
NULL
);

283 
	}
}

285 
Œy_lock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
);

286 
ex‹Á_»ad_fuÎ_·ge
(
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

287 
g‘_ex‹Á_t
 *
g‘_ex‹Á
, 
mœrÜ_num
);

288 
__š™
 
ex‹Á_io_š™
();

289 
ex‹Á_io_ex™
();

291 
u64
 
couÁ_¿nge_b™s
(
ex‹Á_io_Œ“
 *
Œ“
,

292 
u64
 *
¡¬t
, u64 
£¬ch_’d
,

293 
u64
 
max_by‹s
, 
b™s
, 
cÚtig
);

295 
ä“_ex‹Á_¡©e
(
ex‹Á_¡©e
 *
¡©e
);

296 
‹¡_¿nge_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

297 
b™s
, 
fžËd
,

298 
ex‹Á_¡©e
 *
ÿched_¡©e
);

299 
þ—r_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

300 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
);

301 
þ—r_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

302 
b™s
, 
wake
, 
d–‘e
,

303 
ex‹Á_¡©e
 **
ÿched
, 
gå_t
 
mask
);

305 
šlše
 
	$uÆock_ex‹Á
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
)

307  
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, 1, 0, 
NULL
,

308 
GFP_NOFS
);

309 
	}
}

311 
šlše
 
	$uÆock_ex‹Á_ÿched
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

312 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched
, 
gå_t
 
mask
)

314  
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
, 1, 0, 
ÿched
,

315 
mask
);

316 
	}
}

318 
šlše
 
	$þ—r_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

319 
u64
 
’d
, 
b™s
)

321 
wake
 = 0;

323 ià(
b™s
 & 
EXTENT_LOCKED
)

324 
wake
 = 1;

326  
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
wake
, 0, 
NULL
,

327 
GFP_NOFS
);

328 
	}
}

330 
£t_»cÜd_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

331 
b™s
, 
ex‹Á_chªge£t
 *
chªge£t
);

332 
£t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

333 
b™s
, 
u64
 *
çžed_¡¬t
,

334 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
gå_t
 
mask
);

336 
šlše
 
	$£t_ex‹Á_b™s
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

337 
u64
 
’d
, 
b™s
)

339  
	`£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
b™s
, 
NULL
, NULL, 
GFP_NOFS
);

340 
	}
}

342 
šlše
 
	$þ—r_ex‹Á_u±od©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

343 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
gå_t
 
mask
)

345  
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
, 0, 0,

346 
ÿched_¡©e
, 
mask
);

347 
	}
}

349 
šlše
 
	$£t_ex‹Á_dœty
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

350 
u64
 
’d
, 
gå_t
 
mask
)

352  
	`£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_DIRTY
, 
NULL
,

353 
NULL
, 
mask
);

354 
	}
}

356 
šlše
 
	$þ—r_ex‹Á_dœty
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

357 
u64
 
’d
)

359  
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

360 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

361 
EXTENT_DO_ACCOUNTING
, 0, 0, 
NULL
, 
GFP_NOFS
);

362 
	}
}

364 
cÚv”t_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,

365 
b™s
, 
þ—r_b™s
,

366 
ex‹Á_¡©e
 **
ÿched_¡©e
);

368 
šlše
 
	$£t_ex‹Á_d–®loc
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

369 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched_¡©e
)

371  
	`£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

372 
EXTENT_DELALLOC
 | 
EXTENT_UPTODATE
,

373 
NULL
, 
ÿched_¡©e
, 
GFP_NOFS
);

374 
	}
}

376 
šlše
 
	$£t_ex‹Á_deäag
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

377 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched_¡©e
)

379  
	`£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

380 
EXTENT_DELALLOC
 | 
EXTENT_UPTODATE
 | 
EXTENT_DEFRAG
,

381 
NULL
, 
ÿched_¡©e
, 
GFP_NOFS
);

382 
	}
}

384 
šlše
 
	$£t_ex‹Á_Ãw
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

385 
u64
 
’d
)

387  
	`£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_NEW
, 
NULL
, NULL,

388 
GFP_NOFS
);

389 
	}
}

391 
šlše
 
	$£t_ex‹Á_u±od©e
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

392 
u64
 
’d
, 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
gå_t
 
mask
)

394  
	`£t_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
, 
EXTENT_UPTODATE
, 
NULL
,

395 
ÿched_¡©e
, 
mask
);

396 
	}
}

398 
fšd_fœ¡_ex‹Á_b™
(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
,

399 
u64
 *
¡¬t_»t
, u64 *
’d_»t
, 
b™s
,

400 
ex‹Á_¡©e
 **
ÿched_¡©e
);

401 
ex‹Á_šv®id©•age
(
ex‹Á_io_Œ“
 *
Œ“
,

402 
·ge
 *·ge, 
off£t
);

403 
ex‹Á_wr™e_fuÎ_·ge
(
ex‹Á_io_Œ“
 *
Œ“
, 
·ge
 *page,

404 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

405 
wr™eback_cÚŒÞ
 *
wbc
);

406 
ex‹Á_wr™e_locked_¿nge
(
ex‹Á_io_Œ“
 *
Œ“
, 
šode
 *inode,

407 
u64
 
¡¬t
, u64 
’d
, 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

408 
mode
);

409 
ex‹Á_wr™•ages
(
ex‹Á_io_Œ“
 *
Œ“
,

410 
add»ss_¥aû
 *
m­pšg
,

411 
g‘_ex‹Á_t
 *
g‘_ex‹Á
,

412 
wr™eback_cÚŒÞ
 *
wbc
);

413 
bŒ“_wr™e_ÿche_·ges
(
add»ss_¥aû
 *
m­pšg
,

414 
wr™eback_cÚŒÞ
 *
wbc
);

415 
ex‹Á_»ad·ges
(
ex‹Á_io_Œ“
 *
Œ“
,

416 
add»ss_¥aû
 *
m­pšg
,

417 
li¡_h—d
 *
·ges
, 
Ä_·ges
,

418 
g‘_ex‹Á_t
 
g‘_ex‹Á
);

419 
ex‹Á_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

420 
__u64
 
¡¬t
, __u64 
Ën
, 
g‘_ex‹Á_t
 *
g‘_ex‹Á
);

421 
£t_·ge_ex‹Á_m­³d
(
·ge
 *page);

423 
ex‹Á_bufãr
 *
®loc_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

424 
u64
 
¡¬t
);

425 
ex‹Á_bufãr
 *
__®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

426 
u64
 
¡¬t
, 
Ën
);

427 
ex‹Á_bufãr
 *
®loc_dummy_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

428 
u64
 
¡¬t
);

429 
ex‹Á_bufãr
 *
bŒfs_þÚe_ex‹Á_bufãr
(ex‹Á_bufã¸*
¤c
);

430 
ex‹Á_bufãr
 *
fšd_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

431 
u64
 
¡¬t
);

432 
ä“_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
);

433 
ä“_ex‹Á_bufãr_¡®e
(
ex‹Á_bufãr
 *
eb
);

434 
	#WAIT_NONE
 0

	)

435 
	#WAIT_COMPLETE
 1

	)

436 
	#WAIT_PAGE_LOCK
 2

	)

437 
»ad_ex‹Á_bufãr_·ges
(
ex‹Á_io_Œ“
 *
Œ“
,

438 
ex‹Á_bufãr
 *
eb
, 
wa™
,

439 
g‘_ex‹Á_t
 *
g‘_ex‹Á
, 
mœrÜ_num
);

440 
wa™_Ú_ex‹Á_bufãr_wr™eback
(
ex‹Á_bufãr
 *
eb
);

442 
šlše
 
	$num_ex‹Á_·ges
(
u64
 
¡¬t
, u64 
Ën
)

444  ((
¡¬t
 + 
Ën
 + 
PAGE_SIZE
 - 1è>> 
PAGE_SHIFT
) -

445 (
¡¬t
 >> 
PAGE_SHIFT
);

446 
	}
}

448 
šlše
 
	$ex‹Á_bufãr_g‘
(
ex‹Á_bufãr
 *
eb
)

450 
	`©omic_šc
(&
eb
->
»fs
);

451 
	}
}

453 
memcmp_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, cÚ¡ *
±rv
,

454 
¡¬t
, 
Ën
);

455 
»ad_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, *
d¡
,

456 
¡¬t
,

457 
Ën
);

458 
»ad_ex‹Á_bufãr_to_u£r
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

459 
__u£r
 *
d¡
, 
¡¬t
,

460 
Ën
);

461 
wr™e_ex‹Á_bufãr_fsid
(
ex‹Á_bufãr
 *
eb
, cÚ¡ *
¤c
);

462 
wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
ex‹Á_bufãr
 *
eb
,

463 cÚ¡ *
¤c
);

464 
wr™e_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
, cÚ¡ *
¤c
,

465 
¡¬t
, 
Ën
);

466 
cÝy_ex‹Á_bufãr_fuÎ
(
ex‹Á_bufãr
 *
d¡
,

467 
ex‹Á_bufãr
 *
¤c
);

468 
cÝy_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
d¡
, ex‹Á_bufã¸*
¤c
,

469 
d¡_off£t
, 
¤c_off£t
,

470 
Ën
);

471 
memýy_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
d¡
, 
d¡_off£t
,

472 
¤c_off£t
, 
Ën
);

473 
memmove_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
d¡
, 
d¡_off£t
,

474 
¤c_off£t
, 
Ën
);

475 
memz”o_ex‹Á_bufãr
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

476 
Ën
);

477 
ex‹Á_bufãr_‹¡_b™
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

478 
pos
);

479 
ex‹Á_bufãr_b™m­_£t
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

480 
pos
, 
Ën
);

481 
ex‹Á_bufãr_b™m­_þ—r
(
ex‹Á_bufãr
 *
eb
, 
¡¬t
,

482 
pos
, 
Ën
);

483 
þ—r_ex‹Á_bufãr_dœty
(
ex‹Á_bufãr
 *
eb
);

484 
£t_ex‹Á_bufãr_dœty
(
ex‹Á_bufãr
 *
eb
);

485 
£t_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
);

486 
þ—r_ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
);

487 
ex‹Á_bufãr_u±od©e
(
ex‹Á_bufãr
 *
eb
);

488 
ex‹Á_bufãr_und”_io
(
ex‹Á_bufãr
 *
eb
);

489 
m­_´iv©e_ex‹Á_bufãr
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

490 
off£t
, 
mš_Ën
,

491 **
m­
, *
m­_¡¬t
,

492 *
m­_Ën
);

493 
ex‹Á_¿nge_þ—r_dœty_fÜ_io
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
);

494 
ex‹Á_¿nge_»dœty_fÜ_io
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
);

495 
ex‹Á_þ—r_uÆock_d–®loc
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

496 
u64
 
d–®loc_’d
, 
·ge
 *
locked_·ge
,

497 
b™s_to_þ—r
,

498 
·ge_Ýs
);

499 
bio
 *
bŒfs_bio_®loc
(
block_deviû
 *
bdev
, 
u64
 
fœ¡_by‹
);

500 
bio
 *
bŒfs_io_bio_®loc
(
Ä_iovecs
);

501 
bio
 *
bŒfs_bio_þÚe
(bio *bio);

502 
bio
 *
bŒfs_bio_þÚe_·¹Ÿl
(biØ*
Üig
, 
off£t
, 
size
);

504 
	gbŒfs_fs_šfo
;

505 
	gbŒfs_šode
;

507 
»·œ_io_çžu»
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
šo
, u64 
¡¬t
,

508 
u64
 
Ëngth
, u64 
logiÿl
, 
·ge
 *page,

509 
pg_off£t
, 
mœrÜ_num
);

510 
þ—n_io_çžu»
(
bŒfs_fs_šfo
 *
fs_šfo
,

511 
ex‹Á_io_Œ“
 *
çžu»_Œ“
,

512 
ex‹Á_io_Œ“
 *
io_Œ“
, 
u64
 
¡¬t
,

513 
·ge
 *·ge, 
u64
 
šo
, 
pg_off£t
);

514 
’d_ex‹Á_wr™•age
(
·ge
 *·ge, 
”r
, 
u64
 
¡¬t
, u64 
’d
);

515 
»·œ_eb_io_çžu»
(
bŒfs_fs_šfo
 *
fs_šfo
,

516 
ex‹Á_bufãr
 *
eb
, 
mœrÜ_num
);

526 
	sio_çžu»_»cÜd
 {

527 
·ge
 *
	m·ge
;

528 
u64
 
	m¡¬t
;

529 
u64
 
	mËn
;

530 
u64
 
	mlogiÿl
;

531 
	mbio_æags
;

532 
	mthis_mœrÜ
;

533 
	mçžed_mœrÜ
;

534 
	mš_v®id©iÚ
;

538 
bŒfs_ä“_io_çžu»_»cÜd
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
,

539 
u64
 
’d
);

540 
bŒfs_g‘_io_çžu»_»cÜd
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

541 
io_çžu»_»cÜd
 **
çž»c_»t
);

542 
boÞ
 
bŒfs_check_»·œabË
(
šode
 *šode, 
bio
 *
çžed_bio
,

543 
io_çžu»_»cÜd
 *
çž»c
, 
çž_mœrÜ
);

544 
bio
 *
bŒfs_ü—‹_»·œ_bio
(
šode
 *šode, biØ*
çžed_bio
,

545 
io_çžu»_»cÜd
 *
çž»c
,

546 
·ge
 *·ge, 
pg_off£t
, 
icsum
,

547 
bio_’d_io_t
 *
’dio_func
, *
d©a
);

548 
ä“_io_çžu»
(
ex‹Á_io_Œ“
 *
çžu»_Œ“
,

549 
ex‹Á_io_Œ“
 *
io_Œ“
,

550 
io_çžu»_»cÜd
 *
»c
);

551 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


552 
nošlše
 
u64
 
fšd_lock_d–®loc_¿nge
(
šode
 *inode,

553 
ex‹Á_io_Œ“
 *
Œ“
,

554 
·ge
 *
locked_·ge
, 
u64
 *
¡¬t
,

555 
u64
 *
’d
, u64 
max_by‹s
);

557 
ex‹Á_bufãr
 *
®loc_‹¡_ex‹Á_bufãr
(
bŒfs_fs_šfo
 *
fs_šfo
,

558 
u64
 
¡¬t
);

	@extent_map.c

2 
	~<lšux/”r.h
>

3 
	~<lšux/¦ab.h
>

4 
	~<lšux/¥šlock.h
>

5 
	~<lšux/h¬dœq.h
>

6 
	~"ù»e.h
"

7 
	~"ex‹Á_m­.h
"

8 
	~"com´essiÚ.h
"

11 
kmem_ÿche
 *
	gex‹Á_m­_ÿche
;

13 
__š™
 
	$ex‹Á_m­_š™
()

15 
ex‹Á_m­_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_extent_map",

16 (
ex‹Á_m­
), 0,

17 
SLAB_MEM_SPREAD
, 
NULL
);

18 ià(!
ex‹Á_m­_ÿche
)

19  -
ENOMEM
;

21 
	}
}

23 
	$ex‹Á_m­_ex™
()

25 
	`kmem_ÿche_de¡roy
(
ex‹Á_m­_ÿche
);

26 
	}
}

35 
	$ex‹Á_m­_Œ“_š™
(
ex‹Á_m­_Œ“
 *
Œ“
)

37 
Œ“
->
m­
 = 
RB_ROOT
;

38 
	`INIT_LIST_HEAD
(&
Œ“
->
modif›d_ex‹Ás
);

39 
	`rwlock_š™
(&
Œ“
->
lock
);

40 
	}
}

49 
ex‹Á_m­
 *
	$®loc_ex‹Á_m­
()

51 
ex‹Á_m­
 *
em
;

52 
em
 = 
	`kmem_ÿche_z®loc
(
ex‹Á_m­_ÿche
, 
GFP_NOFS
);

53 ià(!
em
)

54  
NULL
;

55 
	`RB_CLEAR_NODE
(&
em
->
rb_node
);

56 
em
->
æags
 = 0;

57 
em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

58 
em
->
g’”©iÚ
 = 0;

59 
	`»fcouÁ_£t
(&
em
->
»fs
, 1);

60 
	`INIT_LIST_HEAD
(&
em
->
li¡
);

61  
em
;

62 
	}
}

71 
	$ä“_ex‹Á_m­
(
ex‹Á_m­
 *
em
)

73 ià(!
em
)

75 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
em
->
»fs
) == 0);

76 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
em
->
»fs
)) {

77 
	`WARN_ON
(
	`ex‹Á_m­_š_Œ“
(
em
));

78 
	`WARN_ON
(!
	`li¡_em±y
(&
em
->
li¡
));

79 ià(
	`‹¡_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
))

80 
	`kä“
(
em
->
m­_lookup
);

81 
	`kmem_ÿche_ä“
(
ex‹Á_m­_ÿche
, 
em
);

83 
	}
}

86 
u64
 
	$¿nge_’d
(
u64
 
¡¬t
, u64 
Ën
)

88 ià(
¡¬t
 + 
Ën
 < start)

89  (
u64
)-1;

90  
¡¬t
 + 
Ën
;

91 
	}
}

93 
	$Œ“_š£¹
(
rb_roÙ
 *
roÙ
, 
ex‹Á_m­
 *
em
)

95 
rb_node
 **
p
 = &
roÙ
->rb_node;

96 
rb_node
 *
·»Á
 = 
NULL
;

97 
ex‹Á_m­
 *
’Œy
 = 
NULL
;

98 
rb_node
 *
Üig_·»Á
 = 
NULL
;

99 
u64
 
’d
 = 
	`¿nge_’d
(
em
->
¡¬t
,ƒm->
Ën
);

101 *
p
) {

102 
·»Á
 = *
p
;

103 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

105 ià(
em
->
¡¬t
 < 
’Œy
->start)

106 
p
 = &(*p)->
rb_Ëá
;

107 ià(
em
->
¡¬t
 >ð
	`ex‹Á_m­_’d
(
’Œy
))

108 
p
 = &(*p)->
rb_right
;

110  -
EEXIST
;

113 
Üig_·»Á
 = 
·»Á
;

114 
·»Á
 && 
em
->
¡¬t
 >ð
	`ex‹Á_m­_’d
(
’Œy
)) {

115 
·»Á
 = 
	`rb_Ãxt
(parent);

116 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

118 ià(
·»Á
)

119 ià(
’d
 > 
’Œy
->
¡¬t
 && 
em
->¡¬ˆ< 
	`ex‹Á_m­_’d
(entry))

120  -
EEXIST
;

122 
·»Á
 = 
Üig_·»Á
;

123 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

124 
·»Á
 && 
em
->
¡¬t
 < 
’Œy
->start) {

125 
·»Á
 = 
	`rb_´ev
(parent);

126 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
ex‹Á_m­
, 
rb_node
);

128 ià(
·»Á
)

129 ià(
’d
 > 
’Œy
->
¡¬t
 && 
em
->¡¬ˆ< 
	`ex‹Á_m­_’d
(entry))

130  -
EEXIST
;

132 
	`rb_lšk_node
(&
em
->
rb_node
, 
Üig_·»Á
, 
p
);

133 
	`rb_š£¹_cÞÜ
(&
em
->
rb_node
, 
roÙ
);

135 
	}
}

141 
rb_node
 *
	$__Œ“_£¬ch
(
rb_roÙ
 *
roÙ
, 
u64
 
off£t
,

142 
rb_node
 **
´ev_»t
,

143 
rb_node
 **
Ãxt_»t
)

145 
rb_node
 *
n
 = 
roÙ
->rb_node;

146 
rb_node
 *
´ev
 = 
NULL
;

147 
rb_node
 *
Üig_´ev
 = 
NULL
;

148 
ex‹Á_m­
 *
’Œy
;

149 
ex‹Á_m­
 *
´ev_’Œy
 = 
NULL
;

151 
n
) {

152 
’Œy
 = 
	`rb_’Œy
(
n
, 
ex‹Á_m­
, 
rb_node
);

153 
´ev
 = 
n
;

154 
´ev_’Œy
 = 
’Œy
;

156 ià(
off£t
 < 
’Œy
->
¡¬t
)

157 
n
 =‚->
rb_Ëá
;

158 ià(
off£t
 >ð
	`ex‹Á_m­_’d
(
’Œy
))

159 
n
 =‚->
rb_right
;

161  
n
;

164 ià(
´ev_»t
) {

165 
Üig_´ev
 = 
´ev
;

166 
´ev
 && 
off£t
 >ð
	`ex‹Á_m­_’d
(
´ev_’Œy
)) {

167 
´ev
 = 
	`rb_Ãxt
(prev);

168 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

170 *
´ev_»t
 = 
´ev
;

171 
´ev
 = 
Üig_´ev
;

174 ià(
Ãxt_»t
) {

175 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

176 
´ev
 && 
off£t
 < 
´ev_’Œy
->
¡¬t
) {

177 
´ev
 = 
	`rb_´ev
(prev);

178 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

180 *
Ãxt_»t
 = 
´ev
;

182  
NULL
;

183 
	}
}

186 
	$m”gabË_m­s
(
ex‹Á_m­
 *
´ev
, ex‹Á_m­ *
Ãxt
)

188 ià(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
´ev
->
æags
))

195 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
´ev
->
æags
))

198 ià(
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
´ev
->
æags
) ||

199 
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
Ãxt
->
æags
))

207 ià(!
	`li¡_em±y
(&
´ev
->
li¡
è|| !li¡_em±y(&
Ãxt
->list))

210 ià(
	`ex‹Á_m­_’d
(
´ev
è=ð
Ãxt
->
¡¬t
 &&

211 
´ev
->
æags
 =ð
Ãxt
->flags &&

212 
´ev
->
bdev
 =ð
Ãxt
->bdev &&

213 ((
Ãxt
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
 &&

214 
´ev
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
) ||

215 (
Ãxt
->
block_¡¬t
 =ð
EXTENT_MAP_INLINE
 &&

216 
´ev
->
block_¡¬t
 =ð
EXTENT_MAP_INLINE
) ||

217 (
Ãxt
->
block_¡¬t
 =ð
EXTENT_MAP_DELALLOC
 &&

218 
´ev
->
block_¡¬t
 =ð
EXTENT_MAP_DELALLOC
) ||

219 (
Ãxt
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
 - 1 &&

220 
Ãxt
->
block_¡¬t
 =ð
	`ex‹Á_m­_block_’d
(
´ev
)))) {

224 
	}
}

226 
	$Œy_m”ge_m­
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
)

228 
ex‹Á_m­
 *
m”ge
 = 
NULL
;

229 
rb_node
 *
rb
;

231 ià(
em
->
¡¬t
 != 0) {

232 
rb
 = 
	`rb_´ev
(&
em
->
rb_node
);

233 ià(
rb
)

234 
m”ge
 = 
	`rb_’Œy
(
rb
, 
ex‹Á_m­
, 
rb_node
);

235 ià(
rb
 && 
	`m”gabË_m­s
(
m”ge
, 
em
)) {

236 
em
->
¡¬t
 = 
m”ge
->start;

237 
em
->
Üig_¡¬t
 = 
m”ge
->orig_start;

238 
em
->
Ën
 +ð
m”ge
->len;

239 
em
->
block_Ën
 +ð
m”ge
->block_len;

240 
em
->
block_¡¬t
 = 
m”ge
->block_start;

241 
em
->
mod_Ën
 = (em->mod_ËÀ+ƒm->
mod_¡¬t
è- 
m”ge
->mod_start;

242 
em
->
mod_¡¬t
 = 
m”ge
->mod_start;

243 
em
->
g’”©iÚ
 = 
	`max
Óm->g’”©iÚ, 
m”ge
->generation);

245 
	`rb_”a£
(&
m”ge
->
rb_node
, &
Œ“
->
m­
);

246 
	`RB_CLEAR_NODE
(&
m”ge
->
rb_node
);

247 
	`ä“_ex‹Á_m­
(
m”ge
);

251 
rb
 = 
	`rb_Ãxt
(&
em
->
rb_node
);

252 ià(
rb
)

253 
m”ge
 = 
	`rb_’Œy
(
rb
, 
ex‹Á_m­
, 
rb_node
);

254 ià(
rb
 && 
	`m”gabË_m­s
(
em
, 
m”ge
)) {

255 
em
->
Ën
 +ð
m”ge
->len;

256 
em
->
block_Ën
 +ð
m”ge
->block_len;

257 
	`rb_”a£
(&
m”ge
->
rb_node
, &
Œ“
->
m­
);

258 
	`RB_CLEAR_NODE
(&
m”ge
->
rb_node
);

259 
em
->
mod_Ën
 = (
m”ge
->
mod_¡¬t
 + merge->mod_len) -ƒm->mod_start;

260 
em
->
g’”©iÚ
 = 
	`max
Óm->g’”©iÚ, 
m”ge
->generation);

261 
	`ä“_ex‹Á_m­
(
m”ge
);

263 
	}
}

276 
	$uÅš_ex‹Á_ÿche
(
ex‹Á_m­_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
Ën
,

277 
u64
 
g’
)

279 
»t
 = 0;

280 
ex‹Á_m­
 *
em
;

281 
boÞ
 
´—Îoc
 = 
çl£
;

283 
	`wr™e_lock
(&
Œ“
->
lock
);

284 
em
 = 
	`lookup_ex‹Á_m­pšg
(
Œ“
, 
¡¬t
, 
Ën
);

286 
	`WARN_ON
(!
em
 ||ƒm->
¡¬t
 != start);

288 ià(!
em
)

289 
out
;

291 
em
->
g’”©iÚ
 = 
g’
;

292 
	`þ—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

293 
em
->
mod_¡¬t
 =ƒm->
¡¬t
;

294 
em
->
mod_Ën
 =ƒm->
Ën
;

296 ià(
	`‹¡_b™
(
EXTENT_FLAG_FILLING
, &
em
->
æags
)) {

297 
´—Îoc
 = 
Œue
;

298 
	`þ—r_b™
(
EXTENT_FLAG_FILLING
, &
em
->
æags
);

301 
	`Œy_m”ge_m­
(
Œ“
, 
em
);

303 ià(
´—Îoc
) {

304 
em
->
mod_¡¬t
 =ƒm->
¡¬t
;

305 
em
->
mod_Ën
 =ƒm->
Ën
;

308 
	`ä“_ex‹Á_m­
(
em
);

309 
out
:

310 
	`wr™e_uÆock
(&
Œ“
->
lock
);

311  
»t
;

313 
	}
}

315 
	$þ—r_em_loggšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
)

317 
	`þ—r_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
);

318 ià(
	`ex‹Á_m­_š_Œ“
(
em
))

319 
	`Œy_m”ge_m­
(
Œ“
, 
em
);

320 
	}
}

322 
šlše
 
	$£tup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

323 
ex‹Á_m­
 *
em
,

324 
modif›d
)

326 
	`»fcouÁ_šc
(&
em
->
»fs
);

327 
em
->
mod_¡¬t
 =ƒm->
¡¬t
;

328 
em
->
mod_Ën
 =ƒm->
Ën
;

330 ià(
modif›d
)

331 
	`li¡_move
(&
em
->
li¡
, &
Œ“
->
modif›d_ex‹Ás
);

333 
	`Œy_m”ge_m­
(
Œ“
, 
em
);

334 
	}
}

346 
	$add_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

347 
ex‹Á_m­
 *
em
, 
modif›d
)

349 
»t
 = 0;

351 
»t
 = 
	`Œ“_š£¹
(&
Œ“
->
m­
, 
em
);

352 ià(
»t
)

353 
out
;

355 
	`£tup_ex‹Á_m­pšg
(
Œ“
, 
em
, 
modif›d
);

356 
out
:

357  
»t
;

358 
	}
}

360 
ex‹Á_m­
 *

361 
	$__lookup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

362 
u64
 
¡¬t
, u64 
Ën
, 
¡riù
)

364 
ex‹Á_m­
 *
em
;

365 
rb_node
 *rb_node;

366 
rb_node
 *
´ev
 = 
NULL
;

367 
rb_node
 *
Ãxt
 = 
NULL
;

368 
u64
 
’d
 = 
	`¿nge_’d
(
¡¬t
, 
Ën
);

370 
rb_node
 = 
	`__Œ“_£¬ch
(&
Œ“
->
m­
, 
¡¬t
, &
´ev
, &
Ãxt
);

371 ià(!
rb_node
) {

372 ià(
´ev
)

373 
rb_node
 = 
´ev
;

374 ià(
Ãxt
)

375 
rb_node
 = 
Ãxt
;

377  
NULL
;

380 
em
 = 
	`rb_’Œy
(
rb_node
, 
ex‹Á_m­
,„b_node);

382 ià(
¡riù
 && !(
’d
 > 
em
->
¡¬t
 && s¹ < 
	`ex‹Á_m­_’d
(em)))

383  
NULL
;

385 
	`»fcouÁ_šc
(&
em
->
»fs
);

386  
em
;

387 
	}
}

400 
ex‹Á_m­
 *
	$lookup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

401 
u64
 
¡¬t
, u64 
Ën
)

403  
	`__lookup_ex‹Á_m­pšg
(
Œ“
, 
¡¬t
, 
Ën
, 1);

404 
	}
}

417 
ex‹Á_m­
 *
	$£¬ch_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

418 
u64
 
¡¬t
, u64 
Ën
)

420  
	`__lookup_ex‹Á_m­pšg
(
Œ“
, 
¡¬t
, 
Ën
, 0);

421 
	}
}

431 
	$»move_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
)

433 
»t
 = 0;

435 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
));

436 
	`rb_”a£
(&
em
->
rb_node
, &
Œ“
->
m­
);

437 ià(!
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
))

438 
	`li¡_d–_š™
(&
em
->
li¡
);

439 
	`RB_CLEAR_NODE
(&
em
->
rb_node
);

440  
»t
;

441 
	}
}

443 
	$»¶aû_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

444 
ex‹Á_m­
 *
cur
,

445 
ex‹Á_m­
 *
Ãw
,

446 
modif›d
)

448 
	`WARN_ON
(
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
cur
->
æags
));

449 
	`ASSERT
(
	`ex‹Á_m­_š_Œ“
(
cur
));

450 ià(!
	`‹¡_b™
(
EXTENT_FLAG_LOGGING
, &
cur
->
æags
))

451 
	`li¡_d–_š™
(&
cur
->
li¡
);

452 
	`rb_»¶aû_node
(&
cur
->
rb_node
, &
Ãw
->rb_node, &
Œ“
->
m­
);

453 
	`RB_CLEAR_NODE
(&
cur
->
rb_node
);

455 
	`£tup_ex‹Á_m­pšg
(
Œ“
, 
Ãw
, 
modif›d
);

456 
	}
}

	@extent_map.h

2 #iâdeà
__EXTENTMAP__


3 
	#__EXTENTMAP__


	)

5 
	~<lšux/rbŒ“.h
>

6 
	~<lšux/»fcouÁ.h
>

8 
	#EXTENT_MAP_LAST_BYTE
 ((
u64
)-4)

	)

9 
	#EXTENT_MAP_HOLE
 ((
u64
)-3)

	)

10 
	#EXTENT_MAP_INLINE
 ((
u64
)-2)

	)

11 
	#EXTENT_MAP_DELALLOC
 ((
u64
)-1)

	)

14 
	#EXTENT_FLAG_PINNED
 0

	)

15 
	#EXTENT_FLAG_COMPRESSED
 1

	)

16 
	#EXTENT_FLAG_VACANCY
 2

	)

17 
	#EXTENT_FLAG_PREALLOC
 3

	)

18 
	#EXTENT_FLAG_LOGGING
 4

	)

19 
	#EXTENT_FLAG_FILLING
 5

	)

20 
	#EXTENT_FLAG_FS_MAPPING
 6

	)

22 
	sex‹Á_m­
 {

23 
rb_node
 
	mrb_node
;

26 
u64
 
	m¡¬t
;

27 
u64
 
	mËn
;

28 
u64
 
	mmod_¡¬t
;

29 
u64
 
	mmod_Ën
;

30 
u64
 
	mÜig_¡¬t
;

31 
u64
 
	mÜig_block_Ën
;

32 
u64
 
	m¿m_by‹s
;

33 
u64
 
	mblock_¡¬t
;

34 
u64
 
	mblock_Ën
;

35 
u64
 
	mg’”©iÚ
;

36 
	mæags
;

38 
block_deviû
 *
	mbdev
;

44 
m­_lookup
 *
	mm­_lookup
;

46 
»fcouÁ_t
 
	m»fs
;

47 
	mcom´ess_ty³
;

48 
li¡_h—d
 
	mli¡
;

51 
	sex‹Á_m­_Œ“
 {

52 
rb_roÙ
 
	mm­
;

53 
li¡_h—d
 
	mmodif›d_ex‹Ás
;

54 
rwlock_t
 
	mlock
;

57 
šlše
 
	$ex‹Á_m­_š_Œ“
(cÚ¡ 
ex‹Á_m­
 *
em
)

59  !
	`RB_EMPTY_NODE
(&
em
->
rb_node
);

60 
	}
}

62 
šlše
 
u64
 
	$ex‹Á_m­_’d
(
ex‹Á_m­
 *
em
)

64 ià(
em
->
¡¬t
 +ƒm->
Ën
 <ƒm->start)

65  (
u64
)-1;

66  
em
->
¡¬t
 +ƒm->
Ën
;

67 
	}
}

69 
šlše
 
u64
 
	$ex‹Á_m­_block_’d
(
ex‹Á_m­
 *
em
)

71 ià(
em
->
block_¡¬t
 +ƒm->
block_Ën
 <ƒm->block_start)

72  (
u64
)-1;

73  
em
->
block_¡¬t
 +ƒm->
block_Ën
;

74 
	}
}

76 
ex‹Á_m­_Œ“_š™
(
ex‹Á_m­_Œ“
 *
Œ“
);

77 
ex‹Á_m­
 *
lookup_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

78 
u64
 
¡¬t
, u64 
Ën
);

79 
add_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

80 
ex‹Á_m­
 *
em
, 
modif›d
);

81 
»move_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
);

82 
»¶aû_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

83 
ex‹Á_m­
 *
cur
,

84 
ex‹Á_m­
 *
Ãw
,

85 
modif›d
);

87 
ex‹Á_m­
 *
®loc_ex‹Á_m­
();

88 
ä“_ex‹Á_m­
(
ex‹Á_m­
 *
em
);

89 
__š™
 
ex‹Á_m­_š™
();

90 
ex‹Á_m­_ex™
();

91 
uÅš_ex‹Á_ÿche
(
ex‹Á_m­_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
Ën
, u64 
g’
);

92 
þ—r_em_loggšg
(
ex‹Á_m­_Œ“
 *
Œ“
, 
ex‹Á_m­
 *
em
);

93 
ex‹Á_m­
 *
£¬ch_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
Œ“
,

94 
u64
 
¡¬t
, u64 
Ën
);

	@file-item.c

19 
	~<lšux/bio.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/·gem­.h
>

22 
	~<lšux/highmem.h
>

23 
	~"ù»e.h
"

24 
	~"disk-io.h
"

25 
	~"Œª§ùiÚ.h
"

26 
	~"vÞumes.h
"

27 
	~"´št-Œ“.h
"

28 
	~"com´essiÚ.h
"

30 
	#__MAX_CSUM_ITEMS
(
r
, 
size
è(()(((
	`BTRFS_LEAF_DATA_SIZE
(r) - \

31 (
bŒfs_™em
) * 2) / \

32 
size
è- 1))

	)

34 
	#MAX_CSUM_ITEMS
(
r
, 
size
è(
	`mš_t
(
u32
, 
	`__MAX_CSUM_ITEMS
(r, size), \

35 
PAGE_SIZE
))

	)

37 
	#MAX_ORDERED_SUM_BYTES
(
fs_šfo
è((
PAGE_SIZE
 - \

38 (
bŒfs_Üd”ed_sum
)) / \

39 (
u32
è* (
fs_šfo
)->
£ùÜsize
)

	)

41 
	$bŒfs_š£¹_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

42 
bŒfs_roÙ
 *
roÙ
,

43 
u64
 
objeùid
, u64 
pos
,

44 
u64
 
disk_off£t
, u64 
disk_num_by‹s
,

45 
u64
 
num_by‹s
, u64 
off£t
, u64 
¿m_by‹s
,

46 
u8
 
com´essiÚ
, u8 
’üy±iÚ
, 
u16
 
Ùh”_’codšg
)

48 
»t
 = 0;

49 
bŒfs_fže_ex‹Á_™em
 *
™em
;

50 
bŒfs_key
 
fže_key
;

51 
bŒfs_·th
 *
·th
;

52 
ex‹Á_bufãr
 *
Ëaf
;

54 
·th
 = 
	`bŒfs_®loc_·th
();

55 ià(!
·th
)

56  -
ENOMEM
;

57 
fže_key
.
objeùid
 = objectid;

58 
fže_key
.
off£t
 = 
pos
;

59 
fže_key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

61 
·th
->
Ëave_¥šnšg
 = 1;

62 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
fže_key
,

63 (*
™em
));

64 ià(
»t
 < 0)

65 
out
;

66 
	`BUG_ON
(
»t
);

67 
Ëaf
 = 
·th
->
nodes
[0];

68 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

69 
bŒfs_fže_ex‹Á_™em
);

70 
	`bŒfs_£t_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
™em
, 
disk_off£t
);

71 
	`bŒfs_£t_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
™em
, 
disk_num_by‹s
);

72 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
™em
, 
off£t
);

73 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
™em
, 
num_by‹s
);

74 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
™em
, 
¿m_by‹s
);

75 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
™em
, 
Œªs
->
Œªsid
);

76 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
™em
, 
BTRFS_FILE_EXTENT_REG
);

77 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
, 
com´essiÚ
);

78 
	`bŒfs_£t_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
™em
, 
’üy±iÚ
);

79 
	`bŒfs_£t_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
™em
, 
Ùh”_’codšg
);

81 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

82 
out
:

83 
	`bŒfs_ä“_·th
(
·th
);

84  
»t
;

85 
	}
}

87 
bŒfs_csum_™em
 *

88 
	$bŒfs_lookup_csum
(
bŒfs_Œªs_hªdË
 *
Œªs
,

89 
bŒfs_roÙ
 *
roÙ
,

90 
bŒfs_·th
 *
·th
,

91 
u64
 
by‹Ä
, 
cow
)

93 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

94 
»t
;

95 
bŒfs_key
 
fže_key
;

96 
bŒfs_key
 
found_key
;

97 
bŒfs_csum_™em
 *
™em
;

98 
ex‹Á_bufãr
 *
Ëaf
;

99 
u64
 
csum_off£t
 = 0;

100 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

101 
csums_š_™em
;

103 
fže_key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

104 
fže_key
.
off£t
 = 
by‹Ä
;

105 
fže_key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

106 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
fže_key
, 
·th
, 0, 
cow
);

107 ià(
»t
 < 0)

108 
çž
;

109 
Ëaf
 = 
·th
->
nodes
[0];

110 ià(
»t
 > 0) {

111 
»t
 = 1;

112 ià(
·th
->
¦Ùs
[0] == 0)

113 
çž
;

114 
·th
->
¦Ùs
[0]--;

115 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

116 ià(
found_key
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
)

117 
çž
;

119 
csum_off£t
 = (
by‹Ä
 - 
found_key
.
off£t
) >>

120 
fs_šfo
->
sb
->
s_blocksize_b™s
;

121 
csums_š_™em
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

122 
csums_š_™em
 /ð
csum_size
;

124 ià(
csum_off£t
 =ð
csums_š_™em
) {

125 
»t
 = -
EFBIG
;

126 
çž
;

127 } ià(
csum_off£t
 > 
csums_š_™em
) {

128 
çž
;

131 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_csum_™em
);

132 
™em
 = (
bŒfs_csum_™em
 *)((*)item +

133 
csum_off£t
 * 
csum_size
);

134  
™em
;

135 
çž
:

136 ià(
»t
 > 0)

137 
»t
 = -
ENOENT
;

138  
	`ERR_PTR
(
»t
);

139 
	}
}

141 
	$bŒfs_lookup_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

142 
bŒfs_roÙ
 *
roÙ
,

143 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
,

144 
u64
 
off£t
, 
mod
)

146 
»t
;

147 
bŒfs_key
 
fže_key
;

148 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

149 
cow
 = 
mod
 != 0;

151 
fže_key
.
objeùid
 = objectid;

152 
fže_key
.
off£t
 = offset;

153 
fže_key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

154 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
fže_key
, 
·th
, 
šs_Ën
, 
cow
);

155  
»t
;

156 
	}
}

158 
	$bŒfs_io_bio_’dio_»ad·ge
(
bŒfs_io_bio
 *
bio
, 
”r
)

160 
	`kä“
(
bio
->
csum_®loÿ‹d
);

161 
	}
}

163 
blk_¡©us_t
 
	$__bŒfs_lookup_bio_sums
(
šode
 *šode, 
bio
 *bio,

164 
u64
 
logiÿl_off£t
, 
u32
 *
d¡
, 
dio
)

166 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

167 
bio_vec
 
bvec
;

168 
bvec_™”
 
™”
;

169 
bŒfs_io_bio
 *
bŒfs_bio
 = 
	`bŒfs_io_bio
(
bio
);

170 
bŒfs_csum_™em
 *
™em
 = 
NULL
;

171 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

172 
bŒfs_·th
 *
·th
;

173 
u8
 *
csum
;

174 
u64
 
off£t
 = 0;

175 
u64
 
™em_¡¬t_off£t
 = 0;

176 
u64
 
™em_Ï¡_off£t
 = 0;

177 
u64
 
disk_by‹Ä
;

178 
u64
 
·ge_by‹s_Ëá
;

179 
u32
 
diff
;

180 
nblocks
;

181 
couÁ
 = 0;

182 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

184 
·th
 = 
	`bŒfs_®loc_·th
();

185 ià(!
·th
)

186  
BLK_STS_RESOURCE
;

188 
nblocks
 = 
bio
->
bi_™”
.
bi_size
 >> 
šode
->
i_sb
->
s_blocksize_b™s
;

189 ià(!
d¡
) {

190 ià(
nblocks
 * 
csum_size
 > 
BTRFS_BIO_INLINE_CSUM_SIZE
) {

191 
bŒfs_bio
->
csum_®loÿ‹d
 = 
	`km®loc_¬¿y
(
nblocks
,

192 
csum_size
, 
GFP_NOFS
);

193 ià(!
bŒfs_bio
->
csum_®loÿ‹d
) {

194 
	`bŒfs_ä“_·th
(
·th
);

195  
BLK_STS_RESOURCE
;

197 
bŒfs_bio
->
csum
 = bŒfs_bio->
csum_®loÿ‹d
;

198 
bŒfs_bio
->
’d_io
 = 
bŒfs_io_bio_’dio_»ad·ge
;

200 
bŒfs_bio
->
csum
 = bŒfs_bio->
csum_šlše
;

202 
csum
 = 
bŒfs_bio
->csum;

204 
csum
 = (
u8
 *)
d¡
;

207 ià(
bio
->
bi_™”
.
bi_size
 > 
PAGE_SIZE
 * 8)

208 
·th
->
»ada
 = 
READA_FORWARD
;

216 ià(
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))) {

217 
·th
->
£¬ch_comm™_roÙ
 = 1;

218 
·th
->
sk_lockšg
 = 1;

221 
disk_by‹Ä
 = (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
 << 9;

222 ià(
dio
)

223 
off£t
 = 
logiÿl_off£t
;

225 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

226 
·ge_by‹s_Ëá
 = 
bvec
.
bv_Ën
;

227 ià(
couÁ
)

228 
Ãxt
;

230 ià(!
dio
)

231 
off£t
 = 
	`·ge_off£t
(
bvec
.
bv_·ge
è+ bvec.
bv_off£t
;

232 
couÁ
 = 
	`bŒfs_fšd_Üd”ed_sum
(
šode
, 
off£t
, 
disk_by‹Ä
,

233 (
u32
 *)
csum
, 
nblocks
);

234 ià(
couÁ
)

235 
found
;

237 ià(!
™em
 || 
disk_by‹Ä
 < 
™em_¡¬t_off£t
 ||

238 
disk_by‹Ä
 >ð
™em_Ï¡_off£t
) {

239 
bŒfs_key
 
found_key
;

240 
u32
 
™em_size
;

242 ià(
™em
)

243 
	`bŒfs_»Ëa£_·th
(
·th
);

244 
™em
 = 
	`bŒfs_lookup_csum
(
NULL
, 
fs_šfo
->
csum_roÙ
,

245 
·th
, 
disk_by‹Ä
, 0);

246 ià(
	`IS_ERR
(
™em
)) {

247 
couÁ
 = 1;

248 
	`mem£t
(
csum
, 0, 
csum_size
);

249 ià(
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.
objeùid
 ==

250 
BTRFS_DATA_RELOC_TREE_OBJECTID
) {

251 
	`£t_ex‹Á_b™s
(
io_Œ“
, 
off£t
,

252 
off£t
 + 
fs_šfo
->
£ùÜsize
 - 1,

253 
EXTENT_NODATASUM
);

255 
	`bŒfs_šfo_¾
(
fs_šfo
,

257 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
off£t
);

259 
™em
 = 
NULL
;

260 
	`bŒfs_»Ëa£_·th
(
·th
);

261 
found
;

263 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

264 
·th
->
¦Ùs
[0]);

266 
™em_¡¬t_off£t
 = 
found_key
.
off£t
;

267 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],

268 
·th
->
¦Ùs
[0]);

269 
™em_Ï¡_off£t
 = 
™em_¡¬t_off£t
 +

270 (
™em_size
 / 
csum_size
) *

271 
fs_šfo
->
£ùÜsize
;

272 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

273 
bŒfs_csum_™em
);

279 
diff
 = 
disk_by‹Ä
 - 
™em_¡¬t_off£t
;

280 
diff
 = difà/ 
fs_šfo
->
£ùÜsize
;

281 
diff
 = difà* 
csum_size
;

282 
couÁ
 = 
	`mš_t
(, 
nblocks
, (
™em_Ï¡_off£t
 - 
disk_by‹Ä
) >>

283 
šode
->
i_sb
->
s_blocksize_b™s
);

284 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
csum
,

285 (()
™em
è+ 
diff
,

286 
csum_size
 * 
couÁ
);

287 
found
:

288 
csum
 +ð
couÁ
 * 
csum_size
;

289 
nblocks
 -ð
couÁ
;

290 
Ãxt
:

291 
couÁ
--) {

292 
disk_by‹Ä
 +ð
fs_šfo
->
£ùÜsize
;

293 
off£t
 +ð
fs_šfo
->
£ùÜsize
;

294 
·ge_by‹s_Ëá
 -ð
fs_šfo
->
£ùÜsize
;

295 ià(!
·ge_by‹s_Ëá
)

300 
	`WARN_ON_ONCE
(
couÁ
);

301 
	`bŒfs_ä“_·th
(
·th
);

303 
	}
}

305 
blk_¡©us_t
 
	$bŒfs_lookup_bio_sums
(
šode
 *šode, 
bio
 *bio, 
u32
 *
d¡
)

307  
	`__bŒfs_lookup_bio_sums
(
šode
, 
bio
, 0, 
d¡
, 0);

308 
	}
}

310 
blk_¡©us_t
 
	$bŒfs_lookup_bio_sums_dio
(
šode
 *šode, 
bio
 *bio, 
u64
 
off£t
)

312  
	`__bŒfs_lookup_bio_sums
(
šode
, 
bio
, 
off£t
, 
NULL
, 1);

313 
	}
}

315 
	$bŒfs_lookup_csums_¿nge
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
’d
,

316 
li¡_h—d
 *
li¡
, 
£¬ch_comm™
)

318 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

319 
bŒfs_key
 
key
;

320 
bŒfs_·th
 *
·th
;

321 
ex‹Á_bufãr
 *
Ëaf
;

322 
bŒfs_Üd”ed_sum
 *
sums
;

323 
bŒfs_csum_™em
 *
™em
;

324 
	`LIST_HEAD
(
tm¶i¡
);

325 
off£t
;

326 
»t
;

327 
size_t
 
size
;

328 
u64
 
csum_’d
;

329 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

331 
	`ASSERT
(
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
) &&

332 
	`IS_ALIGNED
(
’d
 + 1, 
fs_šfo
->
£ùÜsize
));

334 
·th
 = 
	`bŒfs_®loc_·th
();

335 ià(!
·th
)

336  -
ENOMEM
;

338 ià(
£¬ch_comm™
) {

339 
·th
->
sk_lockšg
 = 1;

340 
·th
->
»ada
 = 
READA_FORWARD
;

341 
·th
->
£¬ch_comm™_roÙ
 = 1;

344 
key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

345 
key
.
off£t
 = 
¡¬t
;

346 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

348 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

349 ià(
»t
 < 0)

350 
çž
;

351 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

352 
Ëaf
 = 
·th
->
nodes
[0];

353 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0] - 1);

354 ià(
key
.
objeùid
 =ð
BTRFS_EXTENT_CSUM_OBJECTID
 &&

355 
key
.
ty³
 =ð
BTRFS_EXTENT_CSUM_KEY
) {

356 
off£t
 = (
¡¬t
 - 
key
.offset) >>

357 
fs_šfo
->
sb
->
s_blocksize_b™s
;

358 ià(
off£t
 * 
csum_size
 <

359 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1))

360 
·th
->
¦Ùs
[0]--;

364 
¡¬t
 <ð
’d
) {

365 
Ëaf
 = 
·th
->
nodes
[0];

366 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

367 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

368 ià(
»t
 < 0)

369 
çž
;

370 ià(
»t
 > 0)

372 
Ëaf
 = 
·th
->
nodes
[0];

375 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

376 ià(
key
.
objeùid
 !ð
BTRFS_EXTENT_CSUM_OBJECTID
 ||

377 
key
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

378 
key
.
off£t
 > 
’d
)

381 ià(
key
.
off£t
 > 
¡¬t
)

382 
¡¬t
 = 
key
.
off£t
;

384 
size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

385 
csum_’d
 = 
key
.
off£t
 + (
size
 / 
csum_size
è* 
fs_šfo
->
£ùÜsize
;

386 ià(
csum_’d
 <ð
¡¬t
) {

387 
·th
->
¦Ùs
[0]++;

391 
csum_’d
 = 
	`mš
(csum_’d, 
’d
 + 1);

392 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

393 
bŒfs_csum_™em
);

394 
¡¬t
 < 
csum_’d
) {

395 
size
 = 
	`mš_t
(
size_t
, 
csum_’d
 - 
¡¬t
,

396 
	`MAX_ORDERED_SUM_BYTES
(
fs_šfo
));

397 
sums
 = 
	`kz®loc
(
	`bŒfs_Üd”ed_sum_size
(
fs_šfo
, 
size
),

398 
GFP_NOFS
);

399 ià(!
sums
) {

400 
»t
 = -
ENOMEM
;

401 
çž
;

404 
sums
->
by‹Ä
 = 
¡¬t
;

405 
sums
->
Ën
 = ()
size
;

407 
off£t
 = (
¡¬t
 - 
key
.offset) >>

408 
fs_šfo
->
sb
->
s_blocksize_b™s
;

409 
off£t
 *ð
csum_size
;

410 
size
 >>ð
fs_šfo
->
sb
->
s_blocksize_b™s
;

412 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0],

413 
sums
->sums,

414 (()
™em
è+ 
off£t
,

415 
csum_size
 * 
size
);

417 
¡¬t
 +ð
fs_šfo
->
£ùÜsize
 * 
size
;

418 
	`li¡_add_ž
(&
sums
->
li¡
, &
tm¶i¡
);

420 
·th
->
¦Ùs
[0]++;

422 
»t
 = 0;

423 
çž
:

424 
»t
 < 0 && !
	`li¡_em±y
(&
tm¶i¡
)) {

425 
sums
 = 
	`li¡_’Œy
(
tm¶i¡
.
Ãxt
, 
bŒfs_Üd”ed_sum
, 
li¡
);

426 
	`li¡_d–
(&
sums
->
li¡
);

427 
	`kä“
(
sums
);

429 
	`li¡_¥liû_ž
(&
tm¶i¡
, 
li¡
);

431 
	`bŒfs_ä“_·th
(
·th
);

432  
»t
;

433 
	}
}

435 
blk_¡©us_t
 
	$bŒfs_csum_Úe_bio
(
šode
 *šode, 
bio
 *bio,

436 
u64
 
fže_¡¬t
, 
cÚtig
)

438 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

439 
bŒfs_Üd”ed_sum
 *
sums
;

440 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
 = 
NULL
;

441 *
d©a
;

442 
bvec_™”
 
™”
;

443 
bio_vec
 
bvec
;

444 
šdex
;

445 
Ä_£ùÜs
;

446 
tÙ®_by‹s
 = 0;

447 
this_sum_by‹s
 = 0;

448 
i
;

449 
u64
 
off£t
;

451 
sums
 = 
	`kz®loc
(
	`bŒfs_Üd”ed_sum_size
(
fs_šfo
, 
bio
->
bi_™”
.
bi_size
),

452 
GFP_NOFS
);

453 ià(!
sums
)

454  
BLK_STS_RESOURCE
;

456 
sums
->
Ën
 = 
bio
->
bi_™”
.
bi_size
;

457 
	`INIT_LIST_HEAD
(&
sums
->
li¡
);

459 ià(
cÚtig
)

460 
off£t
 = 
fže_¡¬t
;

462 
off£t
 = 0;

464 
sums
->
by‹Ä
 = (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
 << 9;

465 
šdex
 = 0;

467 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

468 ià(!
cÚtig
)

469 
off£t
 = 
	`·ge_off£t
(
bvec
.
bv_·ge
è+ bvec.
bv_off£t
;

471 ià(!
Üd”ed
) {

472 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
, 
off£t
);

473 
	`BUG_ON
(!
Üd”ed
);

476 
d©a
 = 
	`km­_©omic
(
bvec
.
bv_·ge
);

478 
Ä_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
,

479 
bvec
.
bv_Ën
 + 
fs_šfo
->
£ùÜsize


482 
i
 = 0; i < 
Ä_£ùÜs
; i++) {

483 ià(
off£t
 >ð
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 ||

484 
off£t
 < 
Üd”ed
->
fže_off£t
) {

485 
by‹s_Ëá
;

487 
	`kunm­_©omic
(
d©a
);

488 
sums
->
Ën
 = 
this_sum_by‹s
;

489 
this_sum_by‹s
 = 0;

490 
	`bŒfs_add_Üd”ed_sum
(
šode
, 
Üd”ed
, 
sums
);

491 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

493 
by‹s_Ëá
 = 
bio
->
bi_™”
.
bi_size
 - 
tÙ®_by‹s
;

495 
sums
 = 
	`kz®loc
(
	`bŒfs_Üd”ed_sum_size
(
fs_šfo
, 
by‹s_Ëá
),

496 
GFP_NOFS
);

497 
	`BUG_ON
(!
sums
);

498 
sums
->
Ën
 = 
by‹s_Ëá
;

499 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
,

500 
off£t
);

501 
	`ASSERT
(
Üd”ed
);

502 
sums
->
by‹Ä
 = ((
u64
)
bio
->
bi_™”
.
bi_£ùÜ
 << 9)

503 + 
tÙ®_by‹s
;

504 
šdex
 = 0;

506 
d©a
 = 
	`km­_©omic
(
bvec
.
bv_·ge
);

509 
sums
->sums[
šdex
] = ~(
u32
)0;

510 
sums
->sums[
šdex
]

511 ð
	`bŒfs_csum_d©a
(
d©a
 + 
bvec
.
bv_off£t


512 + (
i
 * 
fs_šfo
->
£ùÜsize
),

513 
sums
->sums[
šdex
],

514 
fs_šfo
->
£ùÜsize
);

515 
	`bŒfs_csum_fš®
(
sums
->sums[
šdex
],

516 (*)(
sums
->sum + 
šdex
));

517 
šdex
++;

518 
off£t
 +ð
fs_šfo
->
£ùÜsize
;

519 
this_sum_by‹s
 +ð
fs_šfo
->
£ùÜsize
;

520 
tÙ®_by‹s
 +ð
fs_šfo
->
£ùÜsize
;

523 
	`kunm­_©omic
(
d©a
);

525 
this_sum_by‹s
 = 0;

526 
	`bŒfs_add_Üd”ed_sum
(
šode
, 
Üd”ed
, 
sums
);

527 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

529 
	}
}

542 
nošlše
 
	$Œunÿ‹_Úe_csum
(
bŒfs_fs_šfo
 *
fs_šfo
,

543 
bŒfs_·th
 *
·th
,

544 
bŒfs_key
 *
key
,

545 
u64
 
by‹Ä
, u64 
Ën
)

547 
ex‹Á_bufãr
 *
Ëaf
;

548 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

549 
u64
 
csum_’d
;

550 
u64
 
’d_by‹
 = 
by‹Ä
 + 
Ën
;

551 
u32
 
blocksize_b™s
 = 
fs_šfo
->
sb
->
s_blocksize_b™s
;

553 
Ëaf
 = 
·th
->
nodes
[0];

554 
csum_’d
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]è/ 
csum_size
;

555 
csum_’d
 <<ð
fs_šfo
->
sb
->
s_blocksize_b™s
;

556 
csum_’d
 +ð
key
->
off£t
;

558 ià(
key
->
off£t
 < 
by‹Ä
 && 
csum_’d
 <ð
’d_by‹
) {

565 
u32
 
Ãw_size
 = (
by‹Ä
 - 
key
->
off£t
è>> 
blocksize_b™s
;

566 
Ãw_size
 *ð
csum_size
;

567 
	`bŒfs_Œunÿ‹_™em
(
fs_šfo
, 
·th
, 
Ãw_size
, 1);

568 } ià(
key
->
off£t
 >ð
by‹Ä
 && 
csum_’d
 > 
’d_by‹
 &&

569 
’d_by‹
 > 
key
->
off£t
) {

576 
u32
 
Ãw_size
 = (
csum_’d
 - 
’d_by‹
è>> 
blocksize_b™s
;

577 
Ãw_size
 *ð
csum_size
;

579 
	`bŒfs_Œunÿ‹_™em
(
fs_šfo
, 
·th
, 
Ãw_size
, 0);

581 
key
->
off£t
 = 
’d_by‹
;

582 
	`bŒfs_£t_™em_key_§ã
(
fs_šfo
, 
·th
, 
key
);

584 
	`BUG
();

586 
	}
}

592 
	$bŒfs_d–_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

593 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
, u64 
Ën
)

595 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
csum_roÙ
;

596 
bŒfs_·th
 *
·th
;

597 
bŒfs_key
 
key
;

598 
u64
 
’d_by‹
 = 
by‹Ä
 + 
Ën
;

599 
u64
 
csum_’d
;

600 
ex‹Á_bufãr
 *
Ëaf
;

601 
»t
;

602 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

603 
blocksize_b™s
 = 
fs_šfo
->
sb
->
s_blocksize_b™s
;

605 
·th
 = 
	`bŒfs_®loc_·th
();

606 ià(!
·th
)

607  -
ENOMEM
;

610 
key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

611 
key
.
off£t
 = 
’d_by‹
 - 1;

612 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

614 
·th
->
Ëave_¥šnšg
 = 1;

615 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

616 ià(
»t
 > 0) {

617 ià(
·th
->
¦Ùs
[0] == 0)

619 
·th
->
¦Ùs
[0]--;

620 } ià(
»t
 < 0) {

624 
Ëaf
 = 
·th
->
nodes
[0];

625 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

627 ià(
key
.
objeùid
 !ð
BTRFS_EXTENT_CSUM_OBJECTID
 ||

628 
key
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
) {

632 ià(
key
.
off£t
 >ð
’d_by‹
)

635 
csum_’d
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]è/ 
csum_size
;

636 
csum_’d
 <<ð
blocksize_b™s
;

637 
csum_’d
 +ð
key
.
off£t
;

640 ià(
csum_’d
 <ð
by‹Ä
)

644 ià(
key
.
off£t
 >ð
by‹Ä
 && 
csum_’d
 <ð
’d_by‹
) {

645 
d–_Ä
 = 1;

652 ià(
key
.
off£t
 > 
by‹Ä
 && 
·th
->
¦Ùs
[0] > 0) {

653 
¦Ù
 = 
·th
->
¦Ùs
[0] - 1;

655 
¦Ù
 >= 0) {

656 
bŒfs_key
 
pk
;

658 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
pk
, 
¦Ù
);

659 ià(
pk
.
off£t
 < 
by‹Ä
 ||

660 
pk
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

661 
pk
.
objeùid
 !=

662 
BTRFS_EXTENT_CSUM_OBJECTID
)

664 
·th
->
¦Ùs
[0] = 
¦Ù
;

665 
d–_Ä
++;

666 
key
.
off£t
 = 
pk
.offset;

667 
¦Ù
--;

670 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,

671 
·th
->
¦Ùs
[0], 
d–_Ä
);

672 ià(
»t
)

673 
out
;

674 ià(
key
.
off£t
 =ð
by‹Ä
)

676 } ià(
key
.
off£t
 < 
by‹Ä
 && 
csum_’d
 > 
’d_by‹
) {

677 
off£t
;

678 
shiá_Ën
;

679 
™em_off£t
;

698 
off£t
 = (
by‹Ä
 - 
key
.off£tè>> 
blocksize_b™s
;

699 
off£t
 *ð
csum_size
;

701 
shiá_Ën
 = (
Ën
 >> 
blocksize_b™s
è* 
csum_size
;

703 
™em_off£t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
,

704 
·th
->
¦Ùs
[0]);

706 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, 
™em_off£t
 + 
off£t
,

707 
shiá_Ën
);

708 
key
.
off£t
 = 
by‹Ä
;

714 
»t
 = 
	`bŒfs_¥l™_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 
off£t
);

715 ià(
»t
 &&„‘ !ð-
EAGAIN
) {

716 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

717 
out
;

720 
key
.
off£t
 = 
’d_by‹
 - 1;

722 
	`Œunÿ‹_Úe_csum
(
fs_šfo
, 
·th
, &
key
, 
by‹Ä
, 
Ën
);

723 ià(
key
.
off£t
 < 
by‹Ä
)

726 
	`bŒfs_»Ëa£_·th
(
·th
);

728 
»t
 = 0;

729 
out
:

730 
	`bŒfs_ä“_·th
(
·th
);

731  
»t
;

732 
	}
}

734 
	$bŒfs_csum_fže_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

735 
bŒfs_roÙ
 *
roÙ
,

736 
bŒfs_Üd”ed_sum
 *
sums
)

738 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

739 
bŒfs_key
 
fže_key
;

740 
bŒfs_key
 
found_key
;

741 
bŒfs_·th
 *
·th
;

742 
bŒfs_csum_™em
 *
™em
;

743 
bŒfs_csum_™em
 *
™em_’d
;

744 
ex‹Á_bufãr
 *
Ëaf
 = 
NULL
;

745 
u64
 
Ãxt_off£t
;

746 
u64
 
tÙ®_by‹s
 = 0;

747 
u64
 
csum_off£t
;

748 
u64
 
by‹Ä
;

749 
u32
 
Ä™ems
;

750 
u32
 
šs_size
;

751 
šdex
 = 0;

752 
found_Ãxt
;

753 
»t
;

754 
u16
 
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

756 
·th
 = 
	`bŒfs_®loc_·th
();

757 ià(!
·th
)

758  -
ENOMEM
;

759 
agaš
:

760 
Ãxt_off£t
 = (
u64
)-1;

761 
found_Ãxt
 = 0;

762 
by‹Ä
 = 
sums
->by‹Ä + 
tÙ®_by‹s
;

763 
fže_key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

764 
fže_key
.
off£t
 = 
by‹Ä
;

765 
fže_key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

767 
™em
 = 
	`bŒfs_lookup_csum
(
Œªs
, 
roÙ
, 
·th
, 
by‹Ä
, 1);

768 ià(!
	`IS_ERR
(
™em
)) {

769 
»t
 = 0;

770 
Ëaf
 = 
·th
->
nodes
[0];

771 
™em_’d
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

772 
bŒfs_csum_™em
);

773 
™em_’d
 = (
bŒfs_csum_™em
 *)((*)item_end +

774 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]));

775 
found
;

777 
»t
 = 
	`PTR_ERR
(
™em
);

778 ià(
»t
 !ð-
EFBIG
 &&„‘ !ð-
ENOENT
)

779 
çž_uÆock
;

781 ià(
»t
 =ð-
EFBIG
) {

782 
u32
 
™em_size
;

784 
Ëaf
 = 
·th
->
nodes
[0];

785 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

786 ià((
™em_size
 / 
csum_size
) >=

787 
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
)) {

789 
š£¹
;

792 
¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

794 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

795 ià(!
Ä™ems
 || (
·th
->
¦Ùs
[0] >=‚ritems - 1)) {

796 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

797 ià(
»t
 == 1)

798 
found_Ãxt
 = 1;

799 ià(
»t
 != 0)

800 
š£¹
;

801 
¦Ù
 = 
·th
->
¦Ùs
[0];

803 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
, 
¦Ù
);

804 ià(
found_key
.
objeùid
 !ð
BTRFS_EXTENT_CSUM_OBJECTID
 ||

805 
found_key
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
) {

806 
found_Ãxt
 = 1;

807 
š£¹
;

809 
Ãxt_off£t
 = 
found_key
.
off£t
;

810 
found_Ãxt
 = 1;

811 
š£¹
;

818 
	`bŒfs_»Ëa£_·th
(
·th
);

819 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
fže_key
, 
·th
,

820 
csum_size
, 1);

821 ià(
»t
 < 0)

822 
çž_uÆock
;

824 ià(
»t
 > 0) {

825 ià(
·th
->
¦Ùs
[0] == 0)

826 
š£¹
;

827 
·th
->
¦Ùs
[0]--;

830 
Ëaf
 = 
·th
->
nodes
[0];

831 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

832 
csum_off£t
 = (
by‹Ä
 - 
found_key
.
off£t
) >>

833 
fs_šfo
->
sb
->
s_blocksize_b™s
;

835 ià(
found_key
.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

836 
found_key
.
objeùid
 !ð
BTRFS_EXTENT_CSUM_OBJECTID
 ||

837 
csum_off£t
 >ð
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
)) {

838 
š£¹
;

841 ià(
csum_off£t
 =ð
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]) /

842 
csum_size
) {

843 
ex‹nd_Ä
;

844 
u64
 
tmp
;

845 
u32
 
diff
;

846 
u32
 
ä“_¥aû
;

848 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) <

849 (
bŒfs_™em
è+ 
csum_size
 * 2)

850 
š£¹
;

852 
ä“_¥aû
 = 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) -

853 (
bŒfs_™em
è- 
csum_size
;

854 
tmp
 = 
sums
->
Ën
 - 
tÙ®_by‹s
;

855 
tmp
 >>ð
fs_šfo
->
sb
->
s_blocksize_b™s
;

856 
	`WARN_ON
(
tmp
 < 1);

858 
ex‹nd_Ä
 = 
	`max_t
(, 1, ()
tmp
);

859 
diff
 = (
csum_off£t
 + 
ex‹nd_Ä
è* 
csum_size
;

860 
diff
 = 
	`mš
(diff,

861 
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
) * csum_size);

863 
diff
 = difà- 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

864 
diff
 = 
	`mš
(
ä“_¥aû
, diff);

865 
diff
 /ð
csum_size
;

866 
diff
 *ð
csum_size
;

868 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, 
diff
);

869 
»t
 = 0;

870 
csum
;

873 
š£¹
:

874 
	`bŒfs_»Ëa£_·th
(
·th
);

875 
csum_off£t
 = 0;

876 ià(
found_Ãxt
) {

877 
u64
 
tmp
;

879 
tmp
 = 
sums
->
Ën
 - 
tÙ®_by‹s
;

880 
tmp
 >>ð
fs_šfo
->
sb
->
s_blocksize_b™s
;

881 
tmp
 = 
	`mš
Ñmp, (
Ãxt_off£t
 - 
fže_key
.
off£t
) >>

882 
fs_šfo
->
sb
->
s_blocksize_b™s
);

884 
tmp
 = 
	`max_t
(
u64
, 1,mp);

885 
tmp
 = 
	`mš_t
(
u64
,mp, 
	`MAX_CSUM_ITEMS
(
fs_šfo
, 
csum_size
));

886 
šs_size
 = 
csum_size
 * 
tmp
;

888 
šs_size
 = 
csum_size
;

890 
·th
->
Ëave_¥šnšg
 = 1;

891 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
fže_key
,

892 
šs_size
);

893 
·th
->
Ëave_¥šnšg
 = 0;

894 ià(
»t
 < 0)

895 
çž_uÆock
;

896 ià(
	`WARN_ON
(
»t
 != 0))

897 
çž_uÆock
;

898 
Ëaf
 = 
·th
->
nodes
[0];

899 
csum
:

900 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_csum_™em
);

901 
™em_’d
 = (
bŒfs_csum_™em
 *)((*)
™em
 +

902 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]));

903 
™em
 = (
bŒfs_csum_™em
 *)((*)item +

904 
csum_off£t
 * 
csum_size
);

905 
found
:

906 
šs_size
 = (
u32
)(
sums
->
Ën
 - 
tÙ®_by‹s
) >>

907 
fs_šfo
->
sb
->
s_blocksize_b™s
;

908 
šs_size
 *ð
csum_size
;

909 
šs_size
 = 
	`mš_t
(
u32
, ()
™em_’d
 - ()
™em
,

910 
šs_size
);

911 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
sums
->sum + 
šdex
, ()
™em
,

912 
šs_size
);

914 
šs_size
 /ð
csum_size
;

915 
tÙ®_by‹s
 +ð
šs_size
 * 
fs_šfo
->
£ùÜsize
;

916 
šdex
 +ð
šs_size
;

918 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

919 ià(
tÙ®_by‹s
 < 
sums
->
Ën
) {

920 
	`bŒfs_»Ëa£_·th
(
·th
);

921 
	`cÚd_»sched
();

922 
agaš
;

924 
out
:

925 
	`bŒfs_ä“_·th
(
·th
);

926  
»t
;

928 
çž_uÆock
:

929 
out
;

930 
	}
}

932 
	$bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
bŒfs_šode
 *
šode
,

933 cÚ¡ 
bŒfs_·th
 *
·th
,

934 
bŒfs_fže_ex‹Á_™em
 *
fi
,

935 cÚ¡ 
boÞ
 
Ãw_šlše
,

936 
ex‹Á_m­
 *
em
)

938 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

939 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

940 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

941 cÚ¡ 
¦Ù
 = 
·th
->
¦Ùs
[0];

942 
bŒfs_key
 
key
;

943 
u64
 
ex‹Á_¡¬t
, 
ex‹Á_’d
;

944 
u64
 
by‹Ä
;

945 
u8
 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
);

946 
com´ess_ty³
 = 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
);

948 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

949 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

950 
ex‹Á_¡¬t
 = 
key
.
off£t
;

952 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

953 
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

954 
ex‹Á_’d
 = 
ex‹Á_¡¬t
 +

955 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

956 } ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

957 
size_t
 
size
;

958 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
, 
¦Ù
, 
fi
);

959 
ex‹Á_’d
 = 
	`ALIGN
(
ex‹Á_¡¬t
 + 
size
,

960 
fs_šfo
->
£ùÜsize
);

963 
em
->
¿m_by‹s
 = 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

964 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

965 
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

966 
em
->
¡¬t
 = 
ex‹Á_¡¬t
;

967 
em
->
Ën
 = 
ex‹Á_’d
 - 
ex‹Á_¡¬t
;

968 
em
->
Üig_¡¬t
 = 
ex‹Á_¡¬t
 -

969 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

970 
em
->
Üig_block_Ën
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

971 
by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

972 ià(
by‹Ä
 == 0) {

973 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

976 ià(
com´ess_ty³
 !ð
BTRFS_COMPRESS_NONE
) {

977 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

978 
em
->
com´ess_ty³
 = compress_type;

979 
em
->
block_¡¬t
 = 
by‹Ä
;

980 
em
->
block_Ën
 =ƒm->
Üig_block_Ën
;

982 
by‹Ä
 +ð
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

983 
em
->
block_¡¬t
 = 
by‹Ä
;

984 
em
->
block_Ën
 =ƒm->
Ën
;

985 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
)

986 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
);

988 } ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

989 
em
->
block_¡¬t
 = 
EXTENT_MAP_INLINE
;

990 
em
->
¡¬t
 = 
ex‹Á_¡¬t
;

991 
em
->
Ën
 = 
ex‹Á_’d
 - 
ex‹Á_¡¬t
;

996 
em
->
Üig_¡¬t
 = 
EXTENT_MAP_HOLE
;

997 
em
->
block_Ën
 = (
u64
)-1;

998 ià(!
Ãw_šlše
 && 
com´ess_ty³
 !ð
BTRFS_COMPRESS_NONE
) {

999 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

1000 
em
->
com´ess_ty³
 = compress_type;

1003 
	`bŒfs_”r
(
fs_šfo
,

1005 "roÙ %Îu", 
ty³
, 
	`bŒfs_šo
(
šode
), 
ex‹Á_¡¬t
,

1006 
roÙ
->
roÙ_key
.
objeùid
);

1008 
	}
}

	@file.c

19 
	~<lšux/fs.h
>

20 
	~<lšux/·gem­.h
>

21 
	~<lšux/highmem.h
>

22 
	~<lšux/time.h
>

23 
	~<lšux/š™.h
>

24 
	~<lšux/¡ršg.h
>

25 
	~<lšux/backšg-dev.h
>

26 
	~<lšux/m·ge.h
>

27 
	~<lšux/çÎoc.h
>

28 
	~<lšux/sw­.h
>

29 
	~<lšux/wr™eback.h
>

30 
	~<lšux/com·t.h
>

31 
	~<lšux/¦ab.h
>

32 
	~<lšux/bŒfs.h
>

33 
	~<lšux/uio.h
>

34 
	~"ù»e.h
"

35 
	~"disk-io.h
"

36 
	~"Œª§ùiÚ.h
"

37 
	~"bŒfs_šode.h
"

38 
	~"´št-Œ“.h
"

39 
	~"Œ“-log.h
"

40 
	~"lockšg.h
"

41 
	~"vÞumes.h
"

42 
	~"qgroup.h
"

43 
	~"com´essiÚ.h
"

45 
kmem_ÿche
 *
	gbŒfs_šode_deäag_ÿch•
;

51 
	sšode_deäag
 {

52 
rb_node
 
	mrb_node
;

54 
u64
 
	mšo
;

59 
u64
 
	mŒªsid
;

62 
u64
 
	mroÙ
;

65 
u64
 
	mÏ¡_off£t
;

68 
	mcyþed
;

71 
	$__com·»_šode_deäag
(
šode_deäag
 *
deäag1
,

72 
šode_deäag
 *
deäag2
)

74 ià(
deäag1
->
roÙ
 > 
deäag2
->root)

76 ià(
deäag1
->
roÙ
 < 
deäag2
->root)

78 ià(
deäag1
->
šo
 > 
deäag2
->ino)

80 ià(
deäag1
->
šo
 < 
deäag2
->ino)

84 
	}
}

95 
	$__bŒfs_add_šode_deäag
(
bŒfs_šode
 *
šode
,

96 
šode_deäag
 *
deäag
)

98 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

99 
šode_deäag
 *
’Œy
;

100 
rb_node
 **
p
;

101 
rb_node
 *
·»Á
 = 
NULL
;

102 
»t
;

104 
p
 = &
fs_šfo
->
deäag_šodes
.
rb_node
;

105 *
p
) {

106 
·»Á
 = *
p
;

107 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
šode_deäag
, 
rb_node
);

109 
»t
 = 
	`__com·»_šode_deäag
(
deäag
, 
’Œy
);

110 ià(
»t
 < 0)

111 
p
 = &
·»Á
->
rb_Ëá
;

112 ià(
»t
 > 0)

113 
p
 = &
·»Á
->
rb_right
;

119 ià(
deäag
->
Œªsid
 < 
’Œy
->transid)

120 
’Œy
->
Œªsid
 = 
deäag
->transid;

121 ià(
deäag
->
Ï¡_off£t
 > 
’Œy
->last_offset)

122 
’Œy
->
Ï¡_off£t
 = 
deäag
->last_offset;

123  -
EEXIST
;

126 
	`£t_b™
(
BTRFS_INODE_IN_DEFRAG
, &
šode
->
ruÁime_æags
);

127 
	`rb_lšk_node
(&
deäag
->
rb_node
, 
·»Á
, 
p
);

128 
	`rb_š£¹_cÞÜ
(&
deäag
->
rb_node
, &
fs_šfo
->
deäag_šodes
);

130 
	}
}

132 
šlše
 
	$__Ãed_auto_deäag
(
bŒfs_fs_šfo
 *
fs_šfo
)

134 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
AUTO_DEFRAG
))

137 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
))

141 
	}
}

147 
	$bŒfs_add_šode_deäag
(
bŒfs_Œªs_hªdË
 *
Œªs
,

148 
bŒfs_šode
 *
šode
)

150 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

151 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

152 
šode_deäag
 *
deäag
;

153 
u64
 
Œªsid
;

154 
»t
;

156 ià(!
	`__Ãed_auto_deäag
(
fs_šfo
))

159 ià(
	`‹¡_b™
(
BTRFS_INODE_IN_DEFRAG
, &
šode
->
ruÁime_æags
))

162 ià(
Œªs
)

163 
Œªsid
 = 
Œªs
->transid;

165 
Œªsid
 = 
šode
->
roÙ
->
Ï¡_Œªs
;

167 
deäag
 = 
	`kmem_ÿche_z®loc
(
bŒfs_šode_deäag_ÿch•
, 
GFP_NOFS
);

168 ià(!
deäag
)

169  -
ENOMEM
;

171 
deäag
->
šo
 = 
	`bŒfs_šo
(
šode
);

172 
deäag
->
Œªsid
 =ransid;

173 
deäag
->
roÙ
 =„oÙ->
roÙ_key
.
objeùid
;

175 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

176 ià(!
	`‹¡_b™
(
BTRFS_INODE_IN_DEFRAG
, &
šode
->
ruÁime_æags
)) {

182 
»t
 = 
	`__bŒfs_add_šode_deäag
(
šode
, 
deäag
);

183 ià(
»t
)

184 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

186 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

188 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

190 
	}
}

197 
	$bŒfs_»queue_šode_deäag
(
bŒfs_šode
 *
šode
,

198 
šode_deäag
 *
deäag
)

200 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

201 
»t
;

203 ià(!
	`__Ãed_auto_deäag
(
fs_šfo
))

204 
out
;

210 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

211 
»t
 = 
	`__bŒfs_add_šode_deäag
(
šode
, 
deäag
);

212 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

213 ià(
»t
)

214 
out
;

216 
out
:

217 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

218 
	}
}

224 
šode_deäag
 *

225 
	$bŒfs_pick_deäag_šode
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
roÙ
, u64 
šo
)

227 
šode_deäag
 *
’Œy
 = 
NULL
;

228 
šode_deäag
 
tmp
;

229 
rb_node
 *
p
;

230 
rb_node
 *
·»Á
 = 
NULL
;

231 
»t
;

233 
tmp
.
šo
 = ino;

234 
tmp
.
roÙ
 =„oot;

236 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

237 
p
 = 
fs_šfo
->
deäag_šodes
.
rb_node
;

238 
p
) {

239 
·»Á
 = 
p
;

240 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
šode_deäag
, 
rb_node
);

242 
»t
 = 
	`__com·»_šode_deäag
(&
tmp
, 
’Œy
);

243 ià(
»t
 < 0)

244 
p
 = 
·»Á
->
rb_Ëá
;

245 ià(
»t
 > 0)

246 
p
 = 
·»Á
->
rb_right
;

248 
out
;

251 ià(
·»Á
 && 
	`__com·»_šode_deäag
(&
tmp
, 
’Œy
) > 0) {

252 
·»Á
 = 
	`rb_Ãxt
(parent);

253 ià(
·»Á
)

254 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
šode_deäag
, 
rb_node
);

256 
’Œy
 = 
NULL
;

258 
out
:

259 ià(
’Œy
)

260 
	`rb_”a£
(
·»Á
, &
fs_šfo
->
deäag_šodes
);

261 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

262  
’Œy
;

263 
	}
}

265 
	$bŒfs_þ—nup_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

267 
šode_deäag
 *
deäag
;

268 
rb_node
 *
node
;

270 
	`¥š_lock
(&
fs_šfo
->
deäag_šodes_lock
);

271 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
deäag_šodes
);

272 
node
) {

273 
	`rb_”a£
(
node
, &
fs_šfo
->
deäag_šodes
);

274 
deäag
 = 
	`rb_’Œy
(
node
, 
šode_deäag
, 
rb_node
);

275 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

277 
	`cÚd_»sched_lock
(&
fs_šfo
->
deäag_šodes_lock
);

279 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
deäag_šodes
);

281 
	`¥š_uÆock
(&
fs_šfo
->
deäag_šodes_lock
);

282 
	}
}

284 
	#BTRFS_DEFRAG_BATCH
 1024

	)

286 
	$__bŒfs_run_deäag_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

287 
šode_deäag
 *
deäag
)

289 
bŒfs_roÙ
 *
šode_roÙ
;

290 
šode
 *inode;

291 
bŒfs_key
 
key
;

292 
bŒfs_ioùl_deäag_¿nge_¬gs
 
¿nge
;

293 
num_deäag
;

294 
šdex
;

295 
»t
;

298 
key
.
objeùid
 = 
deäag
->
roÙ
;

299 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

300 
key
.
off£t
 = (
u64
)-1;

302 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

304 
šode_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

305 ià(
	`IS_ERR
(
šode_roÙ
)) {

306 
»t
 = 
	`PTR_ERR
(
šode_roÙ
);

307 
þ—nup
;

310 
key
.
objeùid
 = 
deäag
->
šo
;

311 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

312 
key
.
off£t
 = 0;

313 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
šode_roÙ
, 
NULL
);

314 ià(
	`IS_ERR
(
šode
)) {

315 
»t
 = 
	`PTR_ERR
(
šode
);

316 
þ—nup
;

318 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

321 
	`þ—r_b™
(
BTRFS_INODE_IN_DEFRAG
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

322 
	`mem£t
(&
¿nge
, 0, (range));

323 
¿nge
.
Ën
 = (
u64
)-1;

324 
¿nge
.
¡¬t
 = 
deäag
->
Ï¡_off£t
;

326 
	`sb_¡¬t_wr™e
(
fs_šfo
->
sb
);

327 
num_deäag
 = 
	`bŒfs_deäag_fže
(
šode
, 
NULL
, &
¿nge
, 
deäag
->
Œªsid
,

328 
BTRFS_DEFRAG_BATCH
);

329 
	`sb_’d_wr™e
(
fs_šfo
->
sb
);

335 ià(
num_deäag
 =ð
BTRFS_DEFRAG_BATCH
) {

336 
deäag
->
Ï¡_off£t
 = 
¿nge
.
¡¬t
;

337 
	`bŒfs_»queue_šode_deäag
(
	`BTRFS_I
(
šode
), 
deäag
);

338 } ià(
deäag
->
Ï¡_off£t
 && !deäag->
cyþed
) {

344 
deäag
->
Ï¡_off£t
 = 0;

345 
deäag
->
cyþed
 = 1;

346 
	`bŒfs_»queue_šode_deäag
(
	`BTRFS_I
(
šode
), 
deäag
);

348 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

351 
	`ut
(
šode
);

353 
þ—nup
:

354 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

355 
	`kmem_ÿche_ä“
(
bŒfs_šode_deäag_ÿch•
, 
deäag
);

356  
»t
;

357 
	}
}

363 
	$bŒfs_run_deäag_šodes
(
bŒfs_fs_šfo
 *
fs_šfo
)

365 
šode_deäag
 *
deäag
;

366 
u64
 
fœ¡_šo
 = 0;

367 
u64
 
roÙ_objeùid
 = 0;

369 
	`©omic_šc
(&
fs_šfo
->
deäag_ruÂšg
);

372 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_REMOUNTING
,

373 &
fs_šfo
->
fs_¡©e
))

376 ià(!
	`__Ãed_auto_deäag
(
fs_šfo
))

380 
deäag
 = 
	`bŒfs_pick_deäag_šode
(
fs_šfo
, 
roÙ_objeùid
,

381 
fœ¡_šo
);

382 ià(!
deäag
) {

383 ià(
roÙ_objeùid
 || 
fœ¡_šo
) {

384 
roÙ_objeùid
 = 0;

385 
fœ¡_šo
 = 0;

392 
fœ¡_šo
 = 
deäag
->
šo
 + 1;

393 
roÙ_objeùid
 = 
deäag
->
roÙ
;

395 
	`__bŒfs_run_deäag_šode
(
fs_šfo
, 
deäag
);

397 
	`©omic_dec
(&
fs_šfo
->
deäag_ruÂšg
);

403 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

405 
	}
}

410 
nošlše
 
	$bŒfs_cÝy_äom_u£r
(
loff_t
 
pos
, 
size_t
 
wr™e_by‹s
,

411 
·ge
 **
´•¬ed_·ges
,

412 
iov_™”
 *
i
)

414 
size_t
 
cÝ›d
 = 0;

415 
size_t
 
tÙ®_cÝ›d
 = 0;

416 
pg
 = 0;

417 
off£t
 = 
pos
 & (
PAGE_SIZE
 - 1);

419 
wr™e_by‹s
 > 0) {

420 
size_t
 
couÁ
 = 
	`mš_t
(size_t,

421 
PAGE_SIZE
 - 
off£t
, 
wr™e_by‹s
);

422 
·ge
 *·gð
´•¬ed_·ges
[
pg
];

426 
cÝ›d
 = 
	`iov_™”_cÝy_äom_u£r_©omic
(
·ge
, 
i
, 
off£t
, 
couÁ
);

429 
	`æush_dÿche_·ge
(
·ge
);

440 ià(!
	`PageU±od©e
(
·ge
è&& 
cÝ›d
 < 
couÁ
)

441 
cÝ›d
 = 0;

443 
	`iov_™”_advªû
(
i
, 
cÝ›d
);

444 
wr™e_by‹s
 -ð
cÝ›d
;

445 
tÙ®_cÝ›d
 +ð
cÝ›d
;

448 ià(
	`uÆik–y
(
cÝ›d
 == 0))

451 ià(
cÝ›d
 < 
PAGE_SIZE
 - 
off£t
) {

452 
off£t
 +ð
cÝ›d
;

454 
pg
++;

455 
off£t
 = 0;

458  
tÙ®_cÝ›d
;

459 
	}
}

464 
	$bŒfs_drÝ_·ges
(
·ge
 **
·ges
, 
size_t
 
num_·ges
)

466 
size_t
 
i
;

467 
i
 = 0; i < 
num_·ges
; i++) {

474 
	`CË¬PageChecked
(
·ges
[
i
]);

475 
	`uÆock_·ge
(
·ges
[
i
]);

476 
	`put_·ge
(
·ges
[
i
]);

478 
	}
}

488 
	$bŒfs_dœty_·ges
(
šode
 *šode, 
·ge
 **
·ges
,

489 
size_t
 
num_·ges
, 
loff_t
 
pos
, size_ˆ
wr™e_by‹s
,

490 
ex‹Á_¡©e
 **
ÿched
)

492 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

493 
”r
 = 0;

494 
i
;

495 
u64
 
num_by‹s
;

496 
u64
 
¡¬t_pos
;

497 
u64
 
’d_of_Ï¡_block
;

498 
u64
 
’d_pos
 = 
pos
 + 
wr™e_by‹s
;

499 
loff_t
 
isize
 = 
	`i_size_»ad
(
šode
);

501 
¡¬t_pos
 = 
pos
 & ~((
u64
è
fs_šfo
->
£ùÜsize
 - 1);

502 
num_by‹s
 = 
	`round_up
(
wr™e_by‹s
 + 
pos
 - 
¡¬t_pos
,

503 
fs_šfo
->
£ùÜsize
);

505 
’d_of_Ï¡_block
 = 
¡¬t_pos
 + 
num_by‹s
 - 1;

506 
”r
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
¡¬t_pos
, 
’d_of_Ï¡_block
,

507 
ÿched
, 0);

508 ià(
”r
)

509  
”r
;

511 
i
 = 0; i < 
num_·ges
; i++) {

512 
·ge
 *
p
 = 
·ges
[
i
];

513 
	`S‘PageU±od©e
(
p
);

514 
	`CË¬PageChecked
(
p
);

515 
	`£t_·ge_dœty
(
p
);

523 ià(
’d_pos
 > 
isize
)

524 
	`i_size_wr™e
(
šode
, 
’d_pos
);

526 
	}
}

532 
	$bŒfs_drÝ_ex‹Á_ÿche
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
,

533 
sk_pšÃd
)

535 
ex‹Á_m­
 *
em
;

536 
ex‹Á_m­
 *
¥l™
 = 
NULL
;

537 
ex‹Á_m­
 *
¥l™2
 = 
NULL
;

538 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

539 
u64
 
Ën
 = 
’d
 - 
¡¬t
 + 1;

540 
u64
 
g’
;

541 
»t
;

542 
‹¡’d
 = 1;

543 
æags
;

544 
com´es£d
 = 0;

545 
boÞ
 
modif›d
;

547 
	`WARN_ON
(
’d
 < 
¡¬t
);

548 ià(
’d
 =ð(
u64
)-1) {

549 
Ën
 = (
u64
)-1;

550 
‹¡’d
 = 0;

553 
no_¥l™s
 = 0;

555 
modif›d
 = 
çl£
;

556 ià(!
¥l™
)

557 
¥l™
 = 
	`®loc_ex‹Á_m­
();

558 ià(!
¥l™2
)

559 
¥l™2
 = 
	`®loc_ex‹Á_m­
();

560 ià(!
¥l™
 || !
¥l™2
)

561 
no_¥l™s
 = 1;

563 
	`wr™e_lock
(&
em_Œ“
->
lock
);

564 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

565 ià(!
em
) {

566 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

569 
æags
 = 
em
->flags;

570 
g’
 = 
em
->
g’”©iÚ
;

571 ià(
sk_pšÃd
 && 
	`‹¡_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
)) {

572 ià(
‹¡’d
 && 
em
->
¡¬t
 +ƒm->
Ën
 >= start +†en) {

573 
	`ä“_ex‹Á_m­
(
em
);

574 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

577 
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

578 ià(
‹¡’d
)

579 
Ën
 = 
¡¬t
 +†’ - (
em
->start +ƒm->len);

580 
	`ä“_ex‹Á_m­
(
em
);

581 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

584 
com´es£d
 = 
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

585 
	`þ—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

586 
	`þ—r_b™
(
EXTENT_FLAG_LOGGING
, &
æags
);

587 
modif›d
 = !
	`li¡_em±y
(&
em
->
li¡
);

588 ià(
no_¥l™s
)

589 
Ãxt
;

591 ià(
em
->
¡¬t
 < start) {

592 
¥l™
->
¡¬t
 = 
em
->start;

593 
¥l™
->
Ën
 = 
¡¬t
 - 
em
->start;

595 ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
) {

596 
¥l™
->
Üig_¡¬t
 = 
em
->orig_start;

597 
¥l™
->
block_¡¬t
 = 
em
->block_start;

599 ià(
com´es£d
)

600 
¥l™
->
block_Ën
 = 
em
->block_len;

602 
¥l™
->
block_Ën
 = s¶™->
Ën
;

603 
¥l™
->
Üig_block_Ën
 = 
	`max
(¥l™->
block_Ën
,

604 
em
->
Üig_block_Ën
);

605 
¥l™
->
¿m_by‹s
 = 
em
->ram_bytes;

607 
¥l™
->
Üig_¡¬t
 = s¶™->
¡¬t
;

608 
¥l™
->
block_Ën
 = 0;

609 
¥l™
->
block_¡¬t
 = 
em
->block_start;

610 
¥l™
->
Üig_block_Ën
 = 0;

611 
¥l™
->
¿m_by‹s
 = s¶™->
Ën
;

614 
¥l™
->
g’”©iÚ
 = 
g’
;

615 
¥l™
->
bdev
 = 
em
->bdev;

616 
¥l™
->
æags
 = flags;

617 
¥l™
->
com´ess_ty³
 = 
em
->compress_type;

618 
	`»¶aû_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 
¥l™
, 
modif›d
);

619 
	`ä“_ex‹Á_m­
(
¥l™
);

620 
¥l™
 = 
¥l™2
;

621 
¥l™2
 = 
NULL
;

623 ià(
‹¡’d
 && 
em
->
¡¬t
 +ƒm->
Ën
 > start +†en) {

624 
u64
 
diff
 = 
¡¬t
 + 
Ën
 - 
em
->start;

626 
¥l™
->
¡¬t
 = s¹ + 
Ën
;

627 
¥l™
->
Ën
 = 
em
->
¡¬t
 +ƒm->len - (start +†en);

628 
¥l™
->
bdev
 = 
em
->bdev;

629 
¥l™
->
æags
 = flags;

630 
¥l™
->
com´ess_ty³
 = 
em
->compress_type;

631 
¥l™
->
g’”©iÚ
 = 
g’
;

633 ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
) {

634 
¥l™
->
Üig_block_Ën
 = 
	`max
(
em
->
block_Ën
,

635 
em
->
Üig_block_Ën
);

637 
¥l™
->
¿m_by‹s
 = 
em
->ram_bytes;

638 ià(
com´es£d
) {

639 
¥l™
->
block_Ën
 = 
em
->block_len;

640 
¥l™
->
block_¡¬t
 = 
em
->block_start;

641 
¥l™
->
Üig_¡¬t
 = 
em
->orig_start;

643 
¥l™
->
block_Ën
 = s¶™->
Ën
;

644 
¥l™
->
block_¡¬t
 = 
em
->block_start

645 + 
diff
;

646 
¥l™
->
Üig_¡¬t
 = 
em
->orig_start;

649 
¥l™
->
¿m_by‹s
 = s¶™->
Ën
;

650 
¥l™
->
Üig_¡¬t
 = s¶™->
¡¬t
;

651 
¥l™
->
block_Ën
 = 0;

652 
¥l™
->
block_¡¬t
 = 
em
->block_start;

653 
¥l™
->
Üig_block_Ën
 = 0;

656 ià(
	`ex‹Á_m­_š_Œ“
(
em
)) {

657 
	`»¶aû_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 
¥l™
,

658 
modif›d
);

660 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
¥l™
,

661 
modif›d
);

662 
	`ASSERT
(
»t
 == 0);

664 
	`ä“_ex‹Á_m­
(
¥l™
);

665 
¥l™
 = 
NULL
;

667 
Ãxt
:

668 ià(
	`ex‹Á_m­_š_Œ“
(
em
))

669 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

670 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

673 
	`ä“_ex‹Á_m­
(
em
);

675 
	`ä“_ex‹Á_m­
(
em
);

677 ià(
¥l™
)

678 
	`ä“_ex‹Á_m­
(
¥l™
);

679 ià(
¥l™2
)

680 
	`ä“_ex‹Á_m­
(
¥l™2
);

681 
	}
}

692 
	$__bŒfs_drÝ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

693 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

694 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
’d
,

695 
u64
 *
drÝ_’d
, 
drÝ_ÿche
,

696 
»¶aû_ex‹Á
,

697 
u32
 
ex‹Á_™em_size
,

698 *
key_š£¹ed
)

700 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

701 
ex‹Á_bufãr
 *
Ëaf
;

702 
bŒfs_fže_ex‹Á_™em
 *
fi
;

703 
bŒfs_key
 
key
;

704 
bŒfs_key
 
Ãw_key
;

705 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

706 
u64
 
£¬ch_¡¬t
 = 
¡¬t
;

707 
u64
 
disk_by‹Ä
 = 0;

708 
u64
 
num_by‹s
 = 0;

709 
u64
 
ex‹Á_off£t
 = 0;

710 
u64
 
ex‹Á_’d
 = 0;

711 
u64
 
Ï¡_’d
 = 
¡¬t
;

712 
d–_Ä
 = 0;

713 
d–_¦Ù
 = 0;

714 
ex‹Á_ty³
;

715 
»cow
;

716 
»t
;

717 
modify_Œ“
 = -1;

718 
upd©e_»fs
;

719 
found
 = 0;

720 
Ëafs_vis™ed
 = 0;

722 ià(
drÝ_ÿche
)

723 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
 - 1, 0);

725 ià(
¡¬t
 >ð
	`BTRFS_I
(
šode
)->
disk_i_size
 && !
»¶aû_ex‹Á
)

726 
modify_Œ“
 = 0;

728 
upd©e_»fs
 = (
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) ||

729 
roÙ
 =ð
fs_šfo
->
Œ“_roÙ
);

731 
»cow
 = 0;

732 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
Œªs
, 
roÙ
, 
·th
, 
šo
,

733 
£¬ch_¡¬t
, 
modify_Œ“
);

734 ià(
»t
 < 0)

736 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0 && 
£¬ch_¡¬t
 =ð
¡¬t
) {

737 
Ëaf
 = 
·th
->
nodes
[0];

738 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0] - 1);

739 ià(
key
.
objeùid
 =ð
šo
 &&

740 
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
)

741 
·th
->
¦Ùs
[0]--;

743 
»t
 = 0;

744 
Ëafs_vis™ed
++;

745 
Ãxt_¦Ù
:

746 
Ëaf
 = 
·th
->
nodes
[0];

747 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

748 
	`BUG_ON
(
d–_Ä
 > 0);

749 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

750 ià(
»t
 < 0)

752 ià(
»t
 > 0) {

753 
»t
 = 0;

756 
Ëafs_vis™ed
++;

757 
Ëaf
 = 
·th
->
nodes
[0];

758 
»cow
 = 1;

761 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

763 ià(
key
.
objeùid
 > 
šo
)

765 ià(
	`WARN_ON_ONCE
(
key
.
objeùid
 < 
šo
) ||

766 
key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
) {

767 
	`ASSERT
(
d–_Ä
 == 0);

768 
·th
->
¦Ùs
[0]++;

769 
Ãxt_¦Ù
;

771 ià(
key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 || key.
off£t
 >ð
’d
)

774 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

775 
bŒfs_fže_ex‹Á_™em
);

776 
ex‹Á_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
);

778 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

779 
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

780 
disk_by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

781 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

782 
ex‹Á_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

783 
ex‹Á_’d
 = 
key
.
off£t
 +

784 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

785 } ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

786 
ex‹Á_’d
 = 
key
.
off£t
 +

787 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
,

788 
·th
->
¦Ùs
[0], 
fi
);

791 
	`BUG
();

803 ià(
ex‹Á_’d
 =ð
key
.
off£t
 &&ƒx‹Á_’d >ð
£¬ch_¡¬t
) {

804 
Ï¡_’d
 = 
ex‹Á_’d
;

805 
d–‘e_ex‹Á_™em
;

808 ià(
ex‹Á_’d
 <ð
£¬ch_¡¬t
) {

809 
·th
->
¦Ùs
[0]++;

810 
Ãxt_¦Ù
;

813 
found
 = 1;

814 
£¬ch_¡¬t
 = 
	`max
(
key
.
off£t
, 
¡¬t
);

815 ià(
»cow
 || !
modify_Œ“
) {

816 
modify_Œ“
 = -1;

817 
	`bŒfs_»Ëa£_·th
(
·th
);

825 ià(
¡¬t
 > 
key
.
off£t
 && 
’d
 < 
ex‹Á_’d
) {

826 
	`BUG_ON
(
d–_Ä
 > 0);

827 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

828 
»t
 = -
EOPNOTSUPP
;

832 
	`memýy
(&
Ãw_key
, &
key
, (new_key));

833 
Ãw_key
.
off£t
 = 
¡¬t
;

834 
»t
 = 
	`bŒfs_du¶iÿ‹_™em
(
Œªs
, 
roÙ
, 
·th
,

835 &
Ãw_key
);

836 ià(
»t
 =ð-
EAGAIN
) {

837 
	`bŒfs_»Ëa£_·th
(
·th
);

840 ià(
»t
 < 0)

843 
Ëaf
 = 
·th
->
nodes
[0];

844 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

845 
bŒfs_fže_ex‹Á_™em
);

846 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

847 
¡¬t
 - 
key
.
off£t
);

849 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

850 
bŒfs_fže_ex‹Á_™em
);

852 
ex‹Á_off£t
 +ð
¡¬t
 - 
key
.
off£t
;

853 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 
ex‹Á_off£t
);

854 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

855 
ex‹Á_’d
 - 
¡¬t
);

856 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

858 ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0) {

859 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
,

860 
disk_by‹Ä
, 
num_by‹s
, 0,

861 
roÙ
->
roÙ_key
.
objeùid
,

862 
Ãw_key
.
objeùid
,

863 
¡¬t
 - 
ex‹Á_off£t
);

864 
	`BUG_ON
(
»t
);

866 
key
.
off£t
 = 
¡¬t
;

872 
Ï¡_’d
 = 
ex‹Á_’d
;

878 ià(
¡¬t
 <ð
key
.
off£t
 && 
’d
 < 
ex‹Á_’d
) {

879 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

880 
»t
 = -
EOPNOTSUPP
;

884 
	`memýy
(&
Ãw_key
, &
key
, (new_key));

885 
Ãw_key
.
off£t
 = 
’d
;

886 
	`bŒfs_£t_™em_key_§ã
(
fs_šfo
, 
·th
, &
Ãw_key
);

888 
ex‹Á_off£t
 +ð
’d
 - 
key
.
off£t
;

889 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 
ex‹Á_off£t
);

890 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

891 
ex‹Á_’d
 - 
’d
);

892 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

893 ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0)

894 
	`šode_sub_by‹s
(
šode
, 
’d
 - 
key
.
off£t
);

898 
£¬ch_¡¬t
 = 
ex‹Á_’d
;

903 ià(
¡¬t
 > 
key
.
off£t
 && 
’d
 >ð
ex‹Á_’d
) {

904 
	`BUG_ON
(
d–_Ä
 > 0);

905 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

906 
»t
 = -
EOPNOTSUPP
;

910 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

911 
¡¬t
 - 
key
.
off£t
);

912 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

913 ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0)

914 
	`šode_sub_by‹s
(
šode
, 
ex‹Á_’d
 - 
¡¬t
);

915 ià(
’d
 =ð
ex‹Á_’d
)

918 
·th
->
¦Ùs
[0]++;

919 
Ãxt_¦Ù
;

926 ià(
¡¬t
 <ð
key
.
off£t
 && 
’d
 >ð
ex‹Á_’d
) {

927 
d–‘e_ex‹Á_™em
:

928 ià(
d–_Ä
 == 0) {

929 
d–_¦Ù
 = 
·th
->
¦Ùs
[0];

930 
d–_Ä
 = 1;

932 
	`BUG_ON
(
d–_¦Ù
 + 
d–_Ä
 !ð
·th
->
¦Ùs
[0]);

933 
d–_Ä
++;

936 ià(
upd©e_»fs
 &&

937 
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

938 
	`šode_sub_by‹s
(
šode
,

939 
ex‹Á_’d
 - 
key
.
off£t
);

940 
ex‹Á_’d
 = 
	`ALIGN
(extent_end,

941 
fs_šfo
->
£ùÜsize
);

942 } ià(
upd©e_»fs
 && 
disk_by‹Ä
 > 0) {

943 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
,

944 
disk_by‹Ä
, 
num_by‹s
, 0,

945 
roÙ
->
roÙ_key
.
objeùid
,

946 
key
.
objeùid
, key.
off£t
 -

947 
ex‹Á_off£t
);

948 
	`BUG_ON
(
»t
);

949 
	`šode_sub_by‹s
(
šode
,

950 
ex‹Á_’d
 - 
key
.
off£t
);

953 ià(
’d
 =ð
ex‹Á_’d
)

956 ià(
·th
->
¦Ùs
[0] + 1 < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

957 
·th
->
¦Ùs
[0]++;

958 
Ãxt_¦Ù
;

961 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
d–_¦Ù
,

962 
d–_Ä
);

963 ià(
»t
) {

964 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

968 
d–_Ä
 = 0;

969 
d–_¦Ù
 = 0;

971 
	`bŒfs_»Ëa£_·th
(
·th
);

975 
	`BUG_ON
(1);

978 ià(!
»t
 && 
d–_Ä
 > 0) {

985 
·th
->
¦Ùs
[0] = 
d–_¦Ù
;

986 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
d–_¦Ù
, 
d–_Ä
);

987 ià(
»t
)

988 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

991 
Ëaf
 = 
·th
->
nodes
[0];

997 ià(!
»t
 && 
»¶aû_ex‹Á
 && 
Ëafs_vis™ed
 == 1 &&

998 (
·th
->
locks
[0] =ð
BTRFS_WRITE_LOCK_BLOCKING
 ||

999 
·th
->
locks
[0] =ð
BTRFS_WRITE_LOCK
) &&

1000 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) >=

1001 (
bŒfs_™em
è+ 
ex‹Á_™em_size
) {

1003 
key
.
objeùid
 = 
šo
;

1004 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1005 
key
.
off£t
 = 
¡¬t
;

1006 ià(!
d–_Ä
 && 
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

1007 
bŒfs_key
 
¦Ù_key
;

1009 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
¦Ù_key
, 
·th
->
¦Ùs
[0]);

1010 ià(
	`bŒfs_comp_ýu_keys
(&
key
, &
¦Ù_key
) > 0)

1011 
·th
->
¦Ùs
[0]++;

1013 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, 
·th
, &
key
,

1014 &
ex‹Á_™em_size
,

1015 
ex‹Á_™em_size
,

1016 (
bŒfs_™em
) +

1017 
ex‹Á_™em_size
, 1);

1018 *
key_š£¹ed
 = 1;

1021 ià(!
»¶aû_ex‹Á
 || !(*
key_š£¹ed
))

1022 
	`bŒfs_»Ëa£_·th
(
·th
);

1023 ià(
drÝ_’d
)

1024 *
drÝ_’d
 = 
found
 ? 
	`mš
(
’d
, 
Ï¡_’d
) :ƒnd;

1025  
»t
;

1026 
	}
}

1028 
	$bŒfs_drÝ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1029 
bŒfs_roÙ
 *
roÙ
, 
šode
 *šode, 
u64
 
¡¬t
,

1030 
u64
 
’d
, 
drÝ_ÿche
)

1032 
bŒfs_·th
 *
·th
;

1033 
»t
;

1035 
·th
 = 
	`bŒfs_®loc_·th
();

1036 ià(!
·th
)

1037  -
ENOMEM
;

1038 
»t
 = 
	`__bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
¡¬t
, 
’d
, 
NULL
,

1039 
drÝ_ÿche
, 0, 0, 
NULL
);

1040 
	`bŒfs_ä“_·th
(
·th
);

1041  
»t
;

1042 
	}
}

1044 
	$ex‹Á_m”g—bË
(
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
,

1045 
u64
 
objeùid
, u64 
by‹Ä
, u64 
Üig_off£t
,

1046 
u64
 *
¡¬t
, u64 *
’d
)

1048 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1049 
bŒfs_key
 
key
;

1050 
u64
 
ex‹Á_’d
;

1052 ià(
¦Ù
 < 0 || slÙ >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

1055 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

1056 ià(
key
.
objeùid
 !ðobjeùid || key.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

1059 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

1060 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
è!ð
BTRFS_FILE_EXTENT_REG
 ||

1061 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
è!ð
by‹Ä
 ||

1062 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
è!ð
key
.
off£t
 - 
Üig_off£t
 ||

1063 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

1064 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

1065 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
))

1068 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

1069 ià((*
¡¬t
 && *¡¬ˆ!ð
key
.
off£t
è|| (*
’d
 && *’d !ð
ex‹Á_’d
))

1072 *
¡¬t
 = 
key
.
off£t
;

1073 *
’d
 = 
ex‹Á_’d
;

1075 
	}
}

1084 
	$bŒfs_m¬k_ex‹Á_wr™‹n
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1085 
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
’d
)

1087 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1088 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1089 
ex‹Á_bufãr
 *
Ëaf
;

1090 
bŒfs_·th
 *
·th
;

1091 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1092 
bŒfs_key
 
key
;

1093 
bŒfs_key
 
Ãw_key
;

1094 
u64
 
by‹Ä
;

1095 
u64
 
num_by‹s
;

1096 
u64
 
ex‹Á_’d
;

1097 
u64
 
Üig_off£t
;

1098 
u64
 
Ùh”_¡¬t
;

1099 
u64
 
Ùh”_’d
;

1100 
u64
 
¥l™
;

1101 
d–_Ä
 = 0;

1102 
d–_¦Ù
 = 0;

1103 
»cow
;

1104 
»t
;

1105 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

1107 
·th
 = 
	`bŒfs_®loc_·th
();

1108 ià(!
·th
)

1109  -
ENOMEM
;

1110 
agaš
:

1111 
»cow
 = 0;

1112 
¥l™
 = 
¡¬t
;

1113 
key
.
objeùid
 = 
šo
;

1114 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1115 
key
.
off£t
 = 
¥l™
;

1117 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1118 ià(
»t
 < 0)

1119 
out
;

1120 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0)

1121 
·th
->
¦Ùs
[0]--;

1123 
Ëaf
 = 
·th
->
nodes
[0];

1124 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

1125 ià(
key
.
objeùid
 !ð
šo
 ||

1126 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
) {

1127 
»t
 = -
EINVAL
;

1128 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1129 
out
;

1131 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1132 
bŒfs_fže_ex‹Á_™em
);

1133 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
è!ð
BTRFS_FILE_EXTENT_PREALLOC
) {

1134 
»t
 = -
EINVAL
;

1135 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1136 
out
;

1138 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

1139 ià(
key
.
off£t
 > 
¡¬t
 || 
ex‹Á_’d
 < 
’d
) {

1140 
»t
 = -
EINVAL
;

1141 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1142 
out
;

1145 
by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1146 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

1147 
Üig_off£t
 = 
key
.
off£t
 - 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

1148 
	`memýy
(&
Ãw_key
, &
key
, (new_key));

1150 ià(
¡¬t
 =ð
key
.
off£t
 && 
’d
 < 
ex‹Á_’d
) {

1151 
Ùh”_¡¬t
 = 0;

1152 
Ùh”_’d
 = 
¡¬t
;

1153 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

1154 
šo
, 
by‹Ä
, 
Üig_off£t
,

1155 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

1156 
Ãw_key
.
off£t
 = 
’d
;

1157 
	`bŒfs_£t_™em_key_§ã
(
fs_šfo
, 
·th
, &
Ãw_key
);

1158 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1159 
bŒfs_fže_ex‹Á_™em
);

1160 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

1161 
Œªs
->
Œªsid
);

1162 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1163 
ex‹Á_’d
 - 
’d
);

1164 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
,

1165 
’d
 - 
Üig_off£t
);

1166 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

1167 
bŒfs_fže_ex‹Á_™em
);

1168 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

1169 
Œªs
->
Œªsid
);

1170 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1171 
’d
 - 
Ùh”_¡¬t
);

1172 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1173 
out
;

1177 ià(
¡¬t
 > 
key
.
off£t
 && 
’d
 =ð
ex‹Á_’d
) {

1178 
Ùh”_¡¬t
 = 
’d
;

1179 
Ùh”_’d
 = 0;

1180 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] + 1,

1181 
šo
, 
by‹Ä
, 
Üig_off£t
,

1182 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

1183 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1184 
bŒfs_fže_ex‹Á_™em
);

1185 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1186 
¡¬t
 - 
key
.
off£t
);

1187 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

1188 
Œªs
->
Œªsid
);

1189 
·th
->
¦Ùs
[0]++;

1190 
Ãw_key
.
off£t
 = 
¡¬t
;

1191 
	`bŒfs_£t_™em_key_§ã
(
fs_šfo
, 
·th
, &
Ãw_key
);

1193 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1194 
bŒfs_fže_ex‹Á_™em
);

1195 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
,

1196 
Œªs
->
Œªsid
);

1197 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1198 
Ùh”_’d
 - 
¡¬t
);

1199 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
,

1200 
¡¬t
 - 
Üig_off£t
);

1201 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1202 
out
;

1206 
¡¬t
 > 
key
.
off£t
 || 
’d
 < 
ex‹Á_’d
) {

1207 ià(
key
.
off£t
 =ð
¡¬t
)

1208 
¥l™
 = 
’d
;

1210 
Ãw_key
.
off£t
 = 
¥l™
;

1211 
»t
 = 
	`bŒfs_du¶iÿ‹_™em
(
Œªs
, 
roÙ
, 
·th
, &
Ãw_key
);

1212 ià(
»t
 =ð-
EAGAIN
) {

1213 
	`bŒfs_»Ëa£_·th
(
·th
);

1214 
agaš
;

1216 ià(
»t
 < 0) {

1217 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1218 
out
;

1221 
Ëaf
 = 
·th
->
nodes
[0];

1222 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

1223 
bŒfs_fže_ex‹Á_™em
);

1224 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

1225 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1226 
¥l™
 - 
key
.
off£t
);

1228 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1229 
bŒfs_fže_ex‹Á_™em
);

1231 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

1232 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 
¥l™
 - 
Üig_off£t
);

1233 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1234 
ex‹Á_’d
 - 
¥l™
);

1235 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1237 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

1238 0, 
roÙ
->
roÙ_key
.
objeùid
,

1239 
šo
, 
Üig_off£t
);

1240 ià(
»t
) {

1241 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1242 
out
;

1245 ià(
¥l™
 =ð
¡¬t
) {

1246 
key
.
off£t
 = 
¡¬t
;

1248 ià(
¡¬t
 !ð
key
.
off£t
) {

1249 
»t
 = -
EINVAL
;

1250 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1251 
out
;

1253 
·th
->
¦Ùs
[0]--;

1254 
ex‹Á_’d
 = 
’d
;

1256 
»cow
 = 1;

1259 
Ùh”_¡¬t
 = 
’d
;

1260 
Ùh”_’d
 = 0;

1261 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] + 1,

1262 
šo
, 
by‹Ä
, 
Üig_off£t
,

1263 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

1264 ià(
»cow
) {

1265 
	`bŒfs_»Ëa£_·th
(
·th
);

1266 
agaš
;

1268 
ex‹Á_’d
 = 
Ùh”_’d
;

1269 
d–_¦Ù
 = 
·th
->
¦Ùs
[0] + 1;

1270 
d–_Ä
++;

1271 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

1272 0, 
roÙ
->
roÙ_key
.
objeùid
,

1273 
šo
, 
Üig_off£t
);

1274 ià(
»t
) {

1275 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1276 
out
;

1279 
Ùh”_¡¬t
 = 0;

1280 
Ùh”_’d
 = 
¡¬t
;

1281 ià(
	`ex‹Á_m”g—bË
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1,

1282 
šo
, 
by‹Ä
, 
Üig_off£t
,

1283 &
Ùh”_¡¬t
, &
Ùh”_’d
)) {

1284 ià(
»cow
) {

1285 
	`bŒfs_»Ëa£_·th
(
·th
);

1286 
agaš
;

1288 
key
.
off£t
 = 
Ùh”_¡¬t
;

1289 
d–_¦Ù
 = 
·th
->
¦Ùs
[0];

1290 
d–_Ä
++;

1291 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

1292 0, 
roÙ
->
roÙ_key
.
objeùid
,

1293 
šo
, 
Üig_off£t
);

1294 ià(
»t
) {

1295 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1296 
out
;

1299 ià(
d–_Ä
 == 0) {

1300 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1301 
bŒfs_fže_ex‹Á_™em
);

1302 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
fi
,

1303 
BTRFS_FILE_EXTENT_REG
);

1304 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

1305 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1307 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
d–_¦Ù
 - 1,

1308 
bŒfs_fže_ex‹Á_™em
);

1309 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
fi
,

1310 
BTRFS_FILE_EXTENT_REG
);

1311 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

1312 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

1313 
ex‹Á_’d
 - 
key
.
off£t
);

1314 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1316 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
d–_¦Ù
, 
d–_Ä
);

1317 ià(
»t
 < 0) {

1318 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1319 
out
;

1322 
out
:

1323 
	`bŒfs_ä“_·th
(
·th
);

1325 
	}
}

1331 
	$´•¬e_u±od©e_·ge
(
šode
 *inode,

1332 
·ge
 *·ge, 
u64
 
pos
,

1333 
boÞ
 
fÜû_u±od©e
)

1335 
»t
 = 0;

1337 ià(((
pos
 & (
PAGE_SIZE
 - 1)è|| 
fÜû_u±od©e
) &&

1338 !
	`PageU±od©e
(
·ge
)) {

1339 
»t
 = 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

1340 ià(
»t
)

1341  
»t
;

1342 
	`lock_·ge
(
·ge
);

1343 ià(!
	`PageU±od©e
(
·ge
)) {

1344 
	`uÆock_·ge
(
·ge
);

1345  -
EIO
;

1347 ià(
·ge
->
m­pšg
 !ð
šode
->
i_m­pšg
) {

1348 
	`uÆock_·ge
(
·ge
);

1349  -
EAGAIN
;

1353 
	}
}

1358 
nošlše
 
	$´•¬e_·ges
(
šode
 *šode, 
·ge
 **
·ges
,

1359 
size_t
 
num_·ges
, 
loff_t
 
pos
,

1360 
size_t
 
wr™e_by‹s
, 
boÞ
 
fÜû_u±od©e
)

1362 
i
;

1363 
šdex
 = 
pos
 >> 
PAGE_SHIFT
;

1364 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

1365 
”r
 = 0;

1366 
çži
;

1368 
i
 = 0; i < 
num_·ges
; i++) {

1369 
agaš
:

1370 
·ges
[
i
] = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
 + i,

1371 
mask
 | 
__GFP_WRITE
);

1372 ià(!
·ges
[
i
]) {

1373 
çži
 = 
i
 - 1;

1374 
”r
 = -
ENOMEM
;

1375 
çž
;

1378 ià(
i
 == 0)

1379 
”r
 = 
	`´•¬e_u±od©e_·ge
(
šode
, 
·ges
[
i
], 
pos
,

1380 
fÜû_u±od©e
);

1381 ià(!
”r
 && 
i
 =ð
num_·ges
 - 1)

1382 
”r
 = 
	`´•¬e_u±od©e_·ge
(
šode
, 
·ges
[
i
],

1383 
pos
 + 
wr™e_by‹s
, 
çl£
);

1384 ià(
”r
) {

1385 
	`put_·ge
(
·ges
[
i
]);

1386 ià(
”r
 =ð-
EAGAIN
) {

1387 
”r
 = 0;

1388 
agaš
;

1390 
çži
 = 
i
 - 1;

1391 
çž
;

1393 
	`wa™_Ú_·ge_wr™eback
(
·ges
[
i
]);

1397 
çž
:

1398 
çži
 >= 0) {

1399 
	`uÆock_·ge
(
·ges
[
çži
]);

1400 
	`put_·ge
(
·ges
[
çži
]);

1401 
çži
--;

1403  
”r
;

1405 
	}
}

1407 
	$bŒfs_fšd_Ãw_d–®loc_by‹s
(
bŒfs_šode
 *
šode
,

1408 cÚ¡ 
u64
 
¡¬t
,

1409 cÚ¡ 
u64
 
Ën
,

1410 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1412 
u64
 
£¬ch_¡¬t
 = 
¡¬t
;

1413 cÚ¡ 
u64
 
’d
 = 
¡¬t
 + 
Ën
 - 1;

1415 
£¬ch_¡¬t
 < 
’d
) {

1416 cÚ¡ 
u64
 
£¬ch_Ën
 = 
’d
 - 
£¬ch_¡¬t
 + 1;

1417 
ex‹Á_m­
 *
em
;

1418 
u64
 
em_Ën
;

1419 
»t
 = 0;

1421 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
£¬ch_¡¬t
,

1422 
£¬ch_Ën
, 0);

1423 ià(
	`IS_ERR
(
em
))

1424  
	`PTR_ERR
(
em
);

1426 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
)

1427 
Ãxt
;

1429 
em_Ën
 = 
em
->
Ën
;

1430 ià(
em
->
¡¬t
 < 
£¬ch_¡¬t
)

1431 
em_Ën
 -ð
£¬ch_¡¬t
 - 
em
->
¡¬t
;

1432 ià(
em_Ën
 > 
£¬ch_Ën
)

1433 
em_Ën
 = 
£¬ch_Ën
;

1435 
»t
 = 
	`£t_ex‹Á_b™
(&
šode
->
io_Œ“
, 
£¬ch_¡¬t
,

1436 
£¬ch_¡¬t
 + 
em_Ën
 - 1,

1437 
EXTENT_DELALLOC_NEW
,

1438 
NULL
, 
ÿched_¡©e
, 
GFP_NOFS
);

1439 
Ãxt
:

1440 
£¬ch_¡¬t
 = 
	`ex‹Á_m­_’d
(
em
);

1441 
	`ä“_ex‹Á_m­
(
em
);

1442 ià(
»t
)

1443  
»t
;

1446 
	}
}

1458 
nošlše
 

1459 
	$lock_ªd_þ—nup_ex‹Á_if_Ãed
(
bŒfs_šode
 *
šode
, 
·ge
 **
·ges
,

1460 
size_t
 
num_·ges
, 
loff_t
 
pos
,

1461 
size_t
 
wr™e_by‹s
,

1462 
u64
 *
lock¡¬t
, u64 *
lock’d
,

1463 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1465 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1466 
u64
 
¡¬t_pos
;

1467 
u64
 
Ï¡_pos
;

1468 
i
;

1469 
»t
 = 0;

1471 
¡¬t_pos
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

1472 
Ï¡_pos
 = 
¡¬t_pos


1473 + 
	`round_up
(
pos
 + 
wr™e_by‹s
 - 
¡¬t_pos
,

1474 
fs_šfo
->
£ùÜsize
) - 1;

1476 ià(
¡¬t_pos
 < 
šode
->
vfs_šode
.
i_size
 ||

1477 (
šode
->
æags
 & 
BTRFS_INODE_PREALLOC
)) {

1478 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1479 
þ—r_b™s
;

1481 
	`lock_ex‹Á_b™s
(&
šode
->
io_Œ“
, 
¡¬t_pos
, 
Ï¡_pos
,

1482 
ÿched_¡©e
);

1483 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
¡¬t_pos
,

1484 
Ï¡_pos
 - 
¡¬t_pos
 + 1);

1485 ià(
Üd”ed
 &&

1486 
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 > 
¡¬t_pos
 &&

1487 
Üd”ed
->
fže_off£t
 <ð
Ï¡_pos
) {

1488 
	`uÆock_ex‹Á_ÿched
(&
šode
->
io_Œ“
, 
¡¬t_pos
,

1489 
Ï¡_pos
, 
ÿched_¡©e
, 
GFP_NOFS
);

1490 
i
 = 0; i < 
num_·ges
; i++) {

1491 
	`uÆock_·ge
(
·ges
[
i
]);

1492 
	`put_·ge
(
·ges
[
i
]);

1494 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(&
šode
->
vfs_šode
,

1495 
Üd”ed
, 1);

1496 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1497  -
EAGAIN
;

1499 ià(
Üd”ed
)

1500 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1501 
»t
 = 
	`bŒfs_fšd_Ãw_d–®loc_by‹s
(
šode
, 
¡¬t_pos
,

1502 
Ï¡_pos
 - 
¡¬t_pos
 + 1,

1503 
ÿched_¡©e
);

1504 
þ—r_b™s
 = 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

1505 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
;

1506 ià(
»t
)

1507 
þ—r_b™s
 |ð
EXTENT_DELALLOC_NEW
 | 
EXTENT_LOCKED
;

1508 
	`þ—r_ex‹Á_b™
(&
šode
->
io_Œ“
, 
¡¬t_pos
,

1509 
Ï¡_pos
, 
þ—r_b™s
,

1510 (
þ—r_b™s
 & 
EXTENT_LOCKED
) ? 1 : 0,

1511 0, 
ÿched_¡©e
, 
GFP_NOFS
);

1512 ià(
»t
)

1513  
»t
;

1514 *
lock¡¬t
 = 
¡¬t_pos
;

1515 *
lock’d
 = 
Ï¡_pos
;

1516 
»t
 = 1;

1519 
i
 = 0; i < 
num_·ges
; i++) {

1520 ià(
	`þ—r_·ge_dœty_fÜ_io
(
·ges
[
i
]))

1521 
	`accouÁ_·ge_»dœty
(
·ges
[
i
]);

1522 
	`£t_·ge_ex‹Á_m­³d
(
·ges
[
i
]);

1523 
	`WARN_ON
(!
	`PageLocked
(
·ges
[
i
]));

1526  
»t
;

1527 
	}
}

1529 
nošlše
 
	$check_ÿn_nocow
(
bŒfs_šode
 *
šode
, 
loff_t
 
pos
,

1530 
size_t
 *
wr™e_by‹s
)

1532 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1533 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1534 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1535 
u64
 
lock¡¬t
, 
lock’d
;

1536 
u64
 
num_by‹s
;

1537 
»t
;

1539 
»t
 = 
	`bŒfs_¡¬t_wr™e_no_¢­shÙtšg
(
roÙ
);

1540 ià(!
»t
)

1541  -
ENOSPC
;

1543 
lock¡¬t
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

1544 
lock’d
 = 
	`round_up
(
pos
 + *
wr™e_by‹s
,

1545 
fs_šfo
->
£ùÜsize
) - 1;

1548 
	`lock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
);

1549 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
lock¡¬t
,

1550 
lock’d
 - 
lock¡¬t
 + 1);

1551 ià(!
Üd”ed
) {

1554 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
);

1555 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(&
šode
->
vfs_šode
, 
Üd”ed
, 1);

1556 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1559 
num_by‹s
 = 
lock’d
 - 
lock¡¬t
 + 1;

1560 
»t
 = 
	`ÿn_nocow_ex‹Á
(&
šode
->
vfs_šode
, 
lock¡¬t
, &
num_by‹s
,

1561 
NULL
, NULL, NULL);

1562 ià(
»t
 <= 0) {

1563 
»t
 = 0;

1564 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1566 *
wr™e_by‹s
 = 
	`mš_t
(
size_t
, *write_bytes ,

1567 
num_by‹s
 - 
pos
 + 
lock¡¬t
);

1570 
	`uÆock_ex‹Á
(&
šode
->
io_Œ“
, 
lock¡¬t
, 
lock’d
);

1572  
»t
;

1573 
	}
}

1575 
nošlše
 
ssize_t
 
	$__bŒfs_bufã»d_wr™e
(
fže
 *file,

1576 
iov_™”
 *
i
,

1577 
loff_t
 
pos
)

1579 
šode
 *šodð
	`fže_šode
(
fže
);

1580 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1581 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1582 
·ge
 **
·ges
 = 
NULL
;

1583 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1584 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

1585 
u64
 
»Ëa£_by‹s
 = 0;

1586 
u64
 
lock¡¬t
;

1587 
u64
 
lock’d
;

1588 
size_t
 
num_wr™‹n
 = 0;

1589 
Ä±rs
;

1590 
»t
 = 0;

1591 
boÞ
 
Úly_»Ëa£_m‘ad©a
 = 
çl£
;

1592 
boÞ
 
fÜû_·ge_u±od©e
 = 
çl£
;

1593 
boÞ
 
Ãed_uÆock
;

1595 
Ä±rs
 = 
	`mš
(
	`DIV_ROUND_UP
(
	`iov_™”_couÁ
(
i
), 
PAGE_SIZE
),

1596 
PAGE_SIZE
 / ((
·ge
 *)));

1597 
Ä±rs
 = 
	`mš
Ò½Œs, 
cu¼’t
->
Ä_dœt›d_·u£
 - cu¼’t->
Ä_dœt›d
);

1598 
Ä±rs
 = 
	`max
(nrptrs, 8);

1599 
·ges
 = 
	`km®loc_¬¿y
(
Ä±rs
, (
·ge
 *), 
GFP_KERNEL
);

1600 ià(!
·ges
)

1601  -
ENOMEM
;

1603 
	`iov_™”_couÁ
(
i
) > 0) {

1604 
size_t
 
off£t
 = 
pos
 & (
PAGE_SIZE
 - 1);

1605 
size_t
 
£ùÜ_off£t
;

1606 
size_t
 
wr™e_by‹s
 = 
	`mš
(
	`iov_™”_couÁ
(
i
),

1607 
Ä±rs
 * (
size_t
)
PAGE_SIZE
 -

1608 
off£t
);

1609 
size_t
 
num_·ges
 = 
	`DIV_ROUND_UP
(
wr™e_by‹s
 + 
off£t
,

1610 
PAGE_SIZE
);

1611 
size_t
 
»£rve_by‹s
;

1612 
size_t
 
dœty_·ges
;

1613 
size_t
 
cÝ›d
;

1614 
size_t
 
dœty_£ùÜs
;

1615 
size_t
 
num_£ùÜs
;

1617 
	`WARN_ON
(
num_·ges
 > 
Ä±rs
);

1623 ià(
	`uÆik–y
(
	`iov_™”_çuÉ_š_»adabË
(
i
, 
wr™e_by‹s
))) {

1624 
»t
 = -
EFAULT
;

1628 
£ùÜ_off£t
 = 
pos
 & (
fs_šfo
->
£ùÜsize
 - 1);

1629 
»£rve_by‹s
 = 
	`round_up
(
wr™e_by‹s
 + 
£ùÜ_off£t
,

1630 
fs_šfo
->
£ùÜsize
);

1632 
	`ex‹Á_chªge£t_»Ëa£
(
d©a_»£rved
);

1633 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
šode
, &
d©a_»£rved
, 
pos
,

1634 
wr™e_by‹s
);

1635 ià(
»t
 < 0) {

1636 ià((
	`BTRFS_I
(
šode
)->
æags
 & (
BTRFS_INODE_NODATACOW
 |

1637 
BTRFS_INODE_PREALLOC
)) &&

1638 
	`check_ÿn_nocow
(
	`BTRFS_I
(
šode
), 
pos
,

1639 &
wr™e_by‹s
) > 0) {

1644 
Úly_»Ëa£_m‘ad©a
 = 
Œue
;

1649 
num_·ges
 = 
	`DIV_ROUND_UP
(
wr™e_by‹s
 + 
off£t
,

1650 
PAGE_SIZE
);

1651 
»£rve_by‹s
 = 
	`round_up
(
wr™e_by‹s
 +

1652 
£ùÜ_off£t
,

1653 
fs_šfo
->
£ùÜsize
);

1659 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
),

1660 
»£rve_by‹s
);

1661 ià(
»t
) {

1662 ià(!
Úly_»Ëa£_m‘ad©a
)

1663 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
,

1664 
d©a_»£rved
, 
pos
,

1665 
wr™e_by‹s
);

1667 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1671 
»Ëa£_by‹s
 = 
»£rve_by‹s
;

1672 
Ãed_uÆock
 = 
çl£
;

1673 
agaš
:

1679 
»t
 = 
	`´•¬e_·ges
(
šode
, 
·ges
, 
num_·ges
,

1680 
pos
, 
wr™e_by‹s
,

1681 
fÜû_·ge_u±od©e
);

1682 ià(
»t
)

1685 
»t
 = 
	`lock_ªd_þ—nup_ex‹Á_if_Ãed
(
	`BTRFS_I
(
šode
), 
·ges
,

1686 
num_·ges
, 
pos
, 
wr™e_by‹s
, &
lock¡¬t
,

1687 &
lock’d
, &
ÿched_¡©e
);

1688 ià(
»t
 < 0) {

1689 ià(
»t
 =ð-
EAGAIN
)

1690 
agaš
;

1692 } ià(
»t
 > 0) {

1693 
Ãed_uÆock
 = 
Œue
;

1694 
»t
 = 0;

1697 
cÝ›d
 = 
	`bŒfs_cÝy_äom_u£r
(
pos
, 
wr™e_by‹s
, 
·ges
, 
i
);

1699 
num_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
»£rve_by‹s
);

1700 
dœty_£ùÜs
 = 
	`round_up
(
cÝ›d
 + 
£ùÜ_off£t
,

1701 
fs_šfo
->
£ùÜsize
);

1702 
dœty_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, dirty_sectors);

1708 ià(
cÝ›d
 < 
wr™e_by‹s
)

1709 
Ä±rs
 = 1;

1711 ià(
cÝ›d
 == 0) {

1712 
fÜû_·ge_u±od©e
 = 
Œue
;

1713 
dœty_£ùÜs
 = 0;

1714 
dœty_·ges
 = 0;

1716 
fÜû_·ge_u±od©e
 = 
çl£
;

1717 
dœty_·ges
 = 
	`DIV_ROUND_UP
(
cÝ›d
 + 
off£t
,

1718 
PAGE_SIZE
);

1729 ià(
num_£ùÜs
 > 
dœty_£ùÜs
) {

1731 
»Ëa£_by‹s
 -ð
dœty_£ùÜs
 <<

1732 
fs_šfo
->
sb
->
s_blocksize_b™s
;

1733 ià(
cÝ›d
 > 0) {

1734 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1735 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1736 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1738 ià(
Úly_»Ëa£_m‘ad©a
) {

1739 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

1740 
»Ëa£_by‹s
);

1742 
u64
 
__pos
;

1744 
__pos
 = 
	`round_down
(
pos
,

1745 
fs_šfo
->
£ùÜsize
) +

1746 (
dœty_·ges
 << 
PAGE_SHIFT
);

1747 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
,

1748 
d©a_»£rved
, 
__pos
,

1749 
»Ëa£_by‹s
);

1753 
»Ëa£_by‹s
 = 
	`round_up
(
cÝ›d
 + 
£ùÜ_off£t
,

1754 
fs_šfo
->
£ùÜsize
);

1756 ià(
cÝ›d
 > 0)

1757 
»t
 = 
	`bŒfs_dœty_·ges
(
šode
, 
·ges
, 
dœty_·ges
,

1758 
pos
, 
cÝ›d
, 
NULL
);

1759 ià(
Ãed_uÆock
)

1760 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1761 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
,

1762 
GFP_NOFS
);

1763 ià(
»t
) {

1764 
	`bŒfs_drÝ_·ges
(
·ges
, 
num_·ges
);

1768 
»Ëa£_by‹s
 = 0;

1769 ià(
Úly_»Ëa£_m‘ad©a
)

1770 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1772 ià(
Úly_»Ëa£_m‘ad©a
 && 
cÝ›d
 > 0) {

1773 
lock¡¬t
 = 
	`round_down
(
pos
,

1774 
fs_šfo
->
£ùÜsize
);

1775 
lock’d
 = 
	`round_up
(
pos
 + 
cÝ›d
,

1776 
fs_šfo
->
£ùÜsize
) - 1;

1778 
	`£t_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
,

1779 
lock’d
, 
EXTENT_NORESERVE
, 
NULL
,

1780 
NULL
, 
GFP_NOFS
);

1781 
Úly_»Ëa£_m‘ad©a
 = 
çl£
;

1784 
	`bŒfs_drÝ_·ges
(
·ges
, 
num_·ges
);

1786 
	`cÚd_»sched
();

1788 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
šode
->
i_m­pšg
);

1789 ià(
dœty_·ges
 < (
fs_šfo
->
nodesize
 >> 
PAGE_SHIFT
) + 1)

1790 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

1792 
pos
 +ð
cÝ›d
;

1793 
num_wr™‹n
 +ð
cÝ›d
;

1796 
	`kä“
(
·ges
);

1798 ià(
»Ëa£_by‹s
) {

1799 ià(
Úly_»Ëa£_m‘ad©a
) {

1800 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1801 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

1802 
»Ëa£_by‹s
);

1804 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

1805 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
),

1806 
»Ëa£_by‹s
);

1810 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

1811  
num_wr™‹n
 ?‚um_wr™‹À: 
»t
;

1812 
	}
}

1814 
ssize_t
 
	$__bŒfs_dœeù_wr™e
(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)

1816 
fže
 *fžð
iocb
->
ki_fžp
;

1817 
šode
 *šodð
	`fže_šode
(
fže
);

1818 
loff_t
 
pos
 = 
iocb
->
ki_pos
;

1819 
ssize_t
 
wr™‹n
;

1820 
ssize_t
 
wr™‹n_bufã»d
;

1821 
loff_t
 
’dby‹
;

1822 
”r
;

1824 
wr™‹n
 = 
	`g’”ic_fže_dœeù_wr™e
(
iocb
, 
äom
);

1826 ià(
wr™‹n
 < 0 || !
	`iov_™”_couÁ
(
äom
))

1827  
wr™‹n
;

1829 
pos
 +ð
wr™‹n
;

1830 
wr™‹n_bufã»d
 = 
	`__bŒfs_bufã»d_wr™e
(
fže
, 
äom
, 
pos
);

1831 ià(
wr™‹n_bufã»d
 < 0) {

1832 
”r
 = 
wr™‹n_bufã»d
;

1833 
out
;

1839 
’dby‹
 = 
pos
 + 
wr™‹n_bufã»d
 - 1;

1840 
”r
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 
pos
, 
’dby‹
);

1841 ià(
”r
)

1842 
out
;

1843 
”r
 = 
	`fžem­_fd©awa™_¿nge
(
šode
->
i_m­pšg
, 
pos
, 
’dby‹
);

1844 ià(
”r
)

1845 
out
;

1846 
wr™‹n
 +ð
wr™‹n_bufã»d
;

1847 
iocb
->
ki_pos
 = 
pos
 + 
wr™‹n_bufã»d
;

1848 
	`šv®id©e_m­pšg_·ges
(
fže
->
f_m­pšg
, 
pos
 >> 
PAGE_SHIFT
,

1849 
’dby‹
 >> 
PAGE_SHIFT
);

1850 
out
:

1851  
wr™‹n
 ? wr™‹À: 
”r
;

1852 
	}
}

1854 
	$upd©e_time_fÜ_wr™e
(
šode
 *inode)

1856 
time¥ec
 
now
;

1858 ià(
	`IS_NOCMTIME
(
šode
))

1861 
now
 = 
	`cu¼’t_time
(
šode
);

1862 ià(!
	`time¥ec_equ®
(&
šode
->
i_mtime
, &
now
))

1863 
šode
->
i_mtime
 = 
now
;

1865 ià(!
	`time¥ec_equ®
(&
šode
->
i_ùime
, &
now
))

1866 
šode
->
i_ùime
 = 
now
;

1868 ià(
	`IS_I_VERSION
(
šode
))

1869 
	`šode_šc_iv”siÚ
(
šode
);

1870 
	}
}

1872 
ssize_t
 
	$bŒfs_fže_wr™e_™”
(
kiocb
 *
iocb
,

1873 
iov_™”
 *
äom
)

1875 
fže
 *fžð
iocb
->
ki_fžp
;

1876 
šode
 *šodð
	`fže_šode
(
fže
);

1877 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1878 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1879 
u64
 
¡¬t_pos
;

1880 
u64
 
’d_pos
;

1881 
ssize_t
 
num_wr™‹n
 = 0;

1882 
boÞ
 
sync
 = (
fže
->
f_æags
 & 
O_DSYNC
è|| 
	`IS_SYNC
(fže->
f_m­pšg
->
ho¡
);

1883 
ssize_t
 
”r
;

1884 
loff_t
 
pos
;

1885 
size_t
 
couÁ
 = 
	`iov_™”_couÁ
(
äom
);

1886 
loff_t
 
Þdsize
;

1887 
þ—n_·ge
 = 0;

1889 ià(!(
iocb
->
ki_æags
 & 
IOCB_DIRECT
) &&

1890 (
iocb
->
ki_æags
 & 
IOCB_NOWAIT
))

1891  -
EOPNOTSUPP
;

1893 ià(!
	`šode_Œylock
(
šode
)) {

1894 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
)

1895  -
EAGAIN
;

1896 
	`šode_lock
(
šode
);

1899 
”r
 = 
	`g’”ic_wr™e_checks
(
iocb
, 
äom
);

1900 ià(
”r
 <= 0) {

1901 
	`šode_uÆock
(
šode
);

1902  
”r
;

1905 
pos
 = 
iocb
->
ki_pos
;

1906 ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

1911 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & (
BTRFS_INODE_NODATACOW
 |

1912 
BTRFS_INODE_PREALLOC
)) ||

1913 
	`check_ÿn_nocow
(
	`BTRFS_I
(
šode
), 
pos
, &
couÁ
) <= 0) {

1914 
	`šode_uÆock
(
šode
);

1915  -
EAGAIN
;

1919 
cu¼’t
->
backšg_dev_šfo
 = 
	`šode_to_bdi
(
šode
);

1920 
”r
 = 
	`fže_»move_´ivs
(
fže
);

1921 ià(
”r
) {

1922 
	`šode_uÆock
(
šode
);

1923 
out
;

1932 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

1933 
	`šode_uÆock
(
šode
);

1934 
”r
 = -
EROFS
;

1935 
out
;

1944 
	`upd©e_time_fÜ_wr™e
(
šode
);

1946 
¡¬t_pos
 = 
	`round_down
(
pos
, 
fs_šfo
->
£ùÜsize
);

1947 
Þdsize
 = 
	`i_size_»ad
(
šode
);

1948 ià(
¡¬t_pos
 > 
Þdsize
) {

1950 
’d_pos
 = 
	`round_up
(
pos
 + 
couÁ
,

1951 
fs_šfo
->
£ùÜsize
);

1952 
”r
 = 
	`bŒfs_cÚt_ex·nd
(
šode
, 
Þdsize
, 
’d_pos
);

1953 ià(
”r
) {

1954 
	`šode_uÆock
(
šode
);

1955 
out
;

1957 ià(
¡¬t_pos
 > 
	`round_up
(
Þdsize
, 
fs_šfo
->
£ùÜsize
))

1958 
þ—n_·ge
 = 1;

1961 ià(
sync
)

1962 
	`©omic_šc
(&
	`BTRFS_I
(
šode
)->
sync_wr™”s
);

1964 ià(
iocb
->
ki_æags
 & 
IOCB_DIRECT
) {

1965 
num_wr™‹n
 = 
	`__bŒfs_dœeù_wr™e
(
iocb
, 
äom
);

1967 
num_wr™‹n
 = 
	`__bŒfs_bufã»d_wr™e
(
fže
, 
äom
, 
pos
);

1968 ià(
num_wr™‹n
 > 0)

1969 
iocb
->
ki_pos
 = 
pos
 + 
num_wr™‹n
;

1970 ià(
þ—n_·ge
)

1971 
	`·geÿche_isize_ex‹nded
(
šode
, 
Þdsize
,

1972 
	`i_size_»ad
(
šode
));

1975 
	`šode_uÆock
(
šode
);

1982 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1983 
	`BTRFS_I
(
šode
)->
Ï¡_sub_Œªs
 = 
roÙ
->
log_Œªsid
;

1984 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1985 ià(
num_wr™‹n
 > 0)

1986 
num_wr™‹n
 = 
	`g’”ic_wr™e_sync
(
iocb
,‚um_written);

1988 ià(
sync
)

1989 
	`©omic_dec
(&
	`BTRFS_I
(
šode
)->
sync_wr™”s
);

1990 
out
:

1991 
cu¼’t
->
backšg_dev_šfo
 = 
NULL
;

1992  
num_wr™‹n
 ?‚um_wr™‹À: 
”r
;

1993 
	}
}

1995 
	$bŒfs_»Ëa£_fže
(
šode
 *šode, 
fže
 *
fžp
)

1997 
bŒfs_fže_´iv©e
 *
´iv©e
 = 
fžp
->
´iv©e_d©a
;

1999 ià(
´iv©e
 &&…riv©e->
Œªs
)

2000 
	`bŒfs_ioùl_Œªs_’d
(
fžp
);

2001 ià(
´iv©e
 &&…riv©e->
fžldœ_buf
)

2002 
	`kä“
(
´iv©e
->
fžldœ_buf
);

2003 
	`kä“
(
´iv©e
);

2004 
fžp
->
´iv©e_d©a
 = 
NULL
;

2012 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_INODE_ORDERED_DATA_CLOSE
,

2013 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

2014 
	`fžem­_æush
(
šode
->
i_m­pšg
);

2016 
	}
}

2018 
	$¡¬t_Üd”ed_Ýs
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
)

2020 
»t
;

2022 
	`©omic_šc
(&
	`BTRFS_I
(
šode
)->
sync_wr™”s
);

2023 
»t
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 
¡¬t
, 
’d
);

2024 
	`©omic_dec
(&
	`BTRFS_I
(
šode
)->
sync_wr™”s
);

2026  
»t
;

2027 
	}
}

2040 
	$bŒfs_sync_fže
(
fže
 *fže, 
loff_t
 
¡¬t
,†off_ˆ
’d
, 
d©async
)

2042 
d’Œy
 *d’Œy = 
	`fže_d’Œy
(
fže
);

2043 
šode
 *šodð
	`d_šode
(
d’Œy
);

2044 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2045 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2046 
bŒfs_Œªs_hªdË
 *
Œªs
;

2047 
bŒfs_log_ùx
 
ùx
;

2048 
»t
 = 0, 
”r
;

2049 
boÞ
 
fuÎ_sync
 = 0;

2050 
u64
 
Ën
;

2056 
Ën
 = (
u64
)
’d
 - (u64)
¡¬t
 + 1;

2057 
	`Œaû_bŒfs_sync_fže
(
fže
, 
d©async
);

2065 
»t
 = 
	`¡¬t_Üd”ed_Ýs
(
šode
, 
¡¬t
, 
’d
);

2066 ià(
»t
)

2067 
out
;

2069 
	`šode_lock
(
šode
);

2070 
	`©omic_šc
(&
roÙ
->
log_b©ch
);

2071 
fuÎ_sync
 = 
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

2072 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

2077 ià(
fuÎ_sync
) {

2084 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
Ën
);

2118 
»t
 = 
	`¡¬t_Üd”ed_Ýs
(
šode
, 
¡¬t
, 
’d
);

2120 ià(
»t
) {

2121 
	`šode_uÆock
(
šode
);

2122 
out
;

2124 
	`©omic_šc
(&
roÙ
->
log_b©ch
);

2154 
	`smp_mb
();

2155 ià(
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
šode
), 
fs_šfo
->
g’”©iÚ
) ||

2156 (
fuÎ_sync
 && 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 <=

2157 
fs_šfo
->
Ï¡_Œªs_comm™‹d
) ||

2158 (!
	`bŒfs_have_Üd”ed_ex‹Ás_š_¿nge
(
šode
, 
¡¬t
, 
Ën
) &&

2159 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs


2160 <ð
fs_šfo
->
Ï¡_Œªs_comm™‹d
)) {

2166 
	`þ—r_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

2167 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

2175 
»t
 = 
	`fžem­_check_wb_”r
(
šode
->
i_m­pšg
, 
fže
->
f_wb_”r
);

2176 
	`šode_uÆock
(
šode
);

2177 
out
;

2183 ià(
fže
->
´iv©e_d©a
)

2184 
	`bŒfs_ioùl_Œªs_’d
(
fže
);

2197 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

2198 ià(
	`IS_ERR
(
Œªs
)) {

2199 
»t
 = 
	`PTR_ERR
(
Œªs
);

2200 
	`šode_uÆock
(
šode
);

2201 
out
;

2203 
Œªs
->
sync
 = 
Œue
;

2205 
	`bŒfs_š™_log_ùx
(&
ùx
, 
šode
);

2207 
»t
 = 
	`bŒfs_log_d’Œy_§ã
(
Œªs
, 
roÙ
, 
d’Œy
, 
¡¬t
, 
’d
, &
ùx
);

2208 ià(
»t
 < 0) {

2210 
»t
 = 1;

2223 
	`šode_uÆock
(
šode
);

2238 ià(
ùx
.
io_”r
) {

2239 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2240 
»t
 = 
ùx
.
io_”r
;

2241 
out
;

2244 ià(
»t
 !ð
BTRFS_NO_LOG_SYNC
) {

2245 ià(!
»t
) {

2246 
»t
 = 
	`bŒfs_sync_log
(
Œªs
, 
roÙ
, &
ùx
);

2247 ià(!
»t
) {

2248 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2249 
out
;

2252 ià(!
fuÎ_sync
) {

2253 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
¡¬t
, 
Ën
);

2254 ià(
»t
) {

2255 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2256 
out
;

2259 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2261 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2263 
out
:

2264 
”r
 = 
	`fže_check_ªd_advªû_wb_”r
(
fže
);

2265 ià(!
»t
)

2266 
»t
 = 
”r
;

2267  
»t
 > 0 ? -
EIO
 :„et;

2268 
	}
}

2270 cÚ¡ 
vm_Ý”©iÚs_¡ruù
 
	gbŒfs_fže_vm_Ýs
 = {

2271 .
çuÉ
 = 
fžem­_çuÉ
,

2272 .
	gm­_·ges
 = 
fžem­_m­_·ges
,

2273 .
	g·ge_mkwr™e
 = 
bŒfs_·ge_mkwr™e
,

2276 
	$bŒfs_fže_mm­
(
fže
 *
fžp
, 
vm_¬—_¡ruù
 *
vma
)

2278 
add»ss_¥aû
 *
m­pšg
 = 
fžp
->
f_m­pšg
;

2280 ià(!
m­pšg
->
a_Ýs
->
»ad·ge
)

2281  -
ENOEXEC
;

2283 
	`fže_acûs£d
(
fžp
);

2284 
vma
->
vm_Ýs
 = &
bŒfs_fže_vm_Ýs
;

2287 
	}
}

2289 
	$hÞe_m”g—bË
(
bŒfs_šode
 *
šode
, 
ex‹Á_bufãr
 *
Ëaf
,

2290 
¦Ù
, 
u64
 
¡¬t
, u64 
’d
)

2292 
bŒfs_fže_ex‹Á_™em
 *
fi
;

2293 
bŒfs_key
 
key
;

2295 ià(
¦Ù
 < 0 || slÙ >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

2298 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

2299 ià(
key
.
objeùid
 !ð
	`bŒfs_šo
(
šode
) ||

2300 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

2303 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

2305 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
è!ð
BTRFS_FILE_EXTENT_REG
)

2308 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
))

2311 ià(
key
.
off£t
 =ð
’d
)

2313 ià(
key
.
off£t
 + 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
è=ð
¡¬t
)

2316 
	}
}

2318 
	$fžl_hÞes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2319 
bŒfs_šode
 *
šode
,

2320 
bŒfs_·th
 *
·th
, 
u64
 
off£t
, u64 
’d
)

2322 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

2323 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

2324 
ex‹Á_bufãr
 *
Ëaf
;

2325 
bŒfs_fže_ex‹Á_™em
 *
fi
;

2326 
ex‹Á_m­
 *
hÞe_em
;

2327 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

2328 
bŒfs_key
 
key
;

2329 
»t
;

2331 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))

2332 
out
;

2334 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

2335 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2336 
key
.
off£t
 = offset;

2338 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

2339 ià(
»t
 <= 0) {

2344 ià(
»t
 == 0)

2345 
»t
 = -
EINVAL
;

2346  
»t
;

2349 
Ëaf
 = 
·th
->
nodes
[0];

2350 ià(
	`hÞe_m”g—bË
(
šode
, 
Ëaf
, 
·th
->
¦Ùs
[0] - 1, 
off£t
, 
’d
)) {

2351 
u64
 
num_by‹s
;

2353 
·th
->
¦Ùs
[0]--;

2354 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2355 
bŒfs_fže_ex‹Á_™em
);

2356 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
) +

2357 
’d
 - 
off£t
;

2358 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2359 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2360 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 0);

2361 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2362 
out
;

2365 ià(
	`hÞe_m”g—bË
(
šode
, 
Ëaf
, 
·th
->
¦Ùs
[0], 
off£t
, 
’d
)) {

2366 
u64
 
num_by‹s
;

2368 
key
.
off£t
 = offset;

2369 
	`bŒfs_£t_™em_key_§ã
(
fs_šfo
, 
·th
, &
key
);

2370 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2371 
bŒfs_fže_ex‹Á_™em
);

2372 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
è+ 
’d
 -

2373 
off£t
;

2374 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2375 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2376 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 0);

2377 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2378 
out
;

2380 
	`bŒfs_»Ëa£_·th
(
·th
);

2382 
»t
 = 
	`bŒfs_š£¹_fže_ex‹Á
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
šode
),

2383 
off£t
, 0, 0, 
’d
 - offset, 0,ƒnd - offset, 0, 0, 0);

2384 ià(
»t
)

2385  
»t
;

2387 
out
:

2388 
	`bŒfs_»Ëa£_·th
(
·th
);

2390 
hÞe_em
 = 
	`®loc_ex‹Á_m­
();

2391 ià(!
hÞe_em
) {

2392 
	`bŒfs_drÝ_ex‹Á_ÿche
(
šode
, 
off£t
, 
’d
 - 1, 0);

2393 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
šode
->
ruÁime_æags
);

2395 
hÞe_em
->
¡¬t
 = 
off£t
;

2396 
hÞe_em
->
Ën
 = 
’d
 - 
off£t
;

2397 
hÞe_em
->
¿m_by‹s
 = hÞe_em->
Ën
;

2398 
hÞe_em
->
Üig_¡¬t
 = 
off£t
;

2400 
hÞe_em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

2401 
hÞe_em
->
block_Ën
 = 0;

2402 
hÞe_em
->
Üig_block_Ën
 = 0;

2403 
hÞe_em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

2404 
hÞe_em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

2405 
hÞe_em
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

2408 
	`bŒfs_drÝ_ex‹Á_ÿche
(
šode
, 
off£t
, 
’d
 - 1, 0);

2409 
	`wr™e_lock
(&
em_Œ“
->
lock
);

2410 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
hÞe_em
, 1);

2411 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

2412 } 
»t
 =ð-
EEXIST
);

2413 
	`ä“_ex‹Á_m­
(
hÞe_em
);

2414 ià(
»t
)

2415 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

2416 &
šode
->
ruÁime_æags
);

2420 
	}
}

2428 
	$fšd_fœ¡_nÚ_hÞe
(
šode
 *šode, 
u64
 *
¡¬t
, u64 *
Ën
)

2430 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2431 
ex‹Á_m­
 *
em
;

2432 
»t
 = 0;

2434 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0,

2435 
	`round_down
(*
¡¬t
, 
fs_šfo
->
£ùÜsize
),

2436 
	`round_up
(*
Ën
, 
fs_šfo
->
£ùÜsize
), 0);

2437 ià(
	`IS_ERR
(
em
))

2438  
	`PTR_ERR
(
em
);

2441 ià(
em
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
) {

2442 
»t
 = 1;

2443 *
Ën
 = 
em
->
¡¬t
 +ƒm->len > *start + *len ?

2444 0 : *
¡¬t
 + *
Ën
 - 
em
->start -ƒm->len;

2445 *
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

2447 
	`ä“_ex‹Á_m­
(
em
);

2448  
»t
;

2449 
	}
}

2451 
	$bŒfs_punch_hÞe
(
šode
 *šode, 
loff_t
 
off£t
,†off_ˆ
Ën
)

2453 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2454 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2455 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2456 
bŒfs_·th
 *
·th
;

2457 
bŒfs_block_rsv
 *
rsv
;

2458 
bŒfs_Œªs_hªdË
 *
Œªs
;

2459 
u64
 
lock¡¬t
;

2460 
u64
 
lock’d
;

2461 
u64
 
ž_¡¬t
;

2462 
u64
 
ž_Ën
;

2463 
u64
 
Üig_¡¬t
 = 
off£t
;

2464 
u64
 
cur_off£t
;

2465 
u64
 
mš_size
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

2466 
u64
 
drÝ_’d
;

2467 
»t
 = 0;

2468 
”r
 = 0;

2469 
rsv_couÁ
;

2470 
boÞ
 
§me_block
;

2471 
boÞ
 
no_hÞes
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
);

2472 
u64
 
šo_size
;

2473 
boÞ
 
Œunÿ‹d_block
 = 
çl£
;

2474 
boÞ
 
upd©ed_šode
 = 
çl£
;

2476 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
off£t
, 
Ën
);

2477 ià(
»t
)

2478  
»t
;

2480 
	`šode_lock
(
šode
);

2481 
šo_size
 = 
	`round_up
(
šode
->
i_size
, 
fs_šfo
->
£ùÜsize
);

2482 
»t
 = 
	`fšd_fœ¡_nÚ_hÞe
(
šode
, &
off£t
, &
Ën
);

2483 ià(
»t
 < 0)

2484 
out_Úly_mu‹x
;

2485 ià(
»t
 && !
Ën
) {

2487 
»t
 = 0;

2488 
out_Úly_mu‹x
;

2491 
lock¡¬t
 = 
	`round_up
(
off£t
, 
	`bŒfs_šode_£ùÜsize
(
šode
));

2492 
lock’d
 = 
	`round_down
(
off£t
 + 
Ën
,

2493 
	`bŒfs_šode_£ùÜsize
(
šode
)) - 1;

2494 
§me_block
 = (
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
))

2495 =ð(
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
 + 
Ën
 - 1));

2504 ià(
§me_block
 && 
Ën
 < 
fs_šfo
->
£ùÜsize
) {

2505 ià(
off£t
 < 
šo_size
) {

2506 
Œunÿ‹d_block
 = 
Œue
;

2507 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
šode
, 
off£t
, 
Ën
, 0);

2509 
»t
 = 0;

2511 
out_Úly_mu‹x
;

2515 ià(
off£t
 < 
šo_size
) {

2516 
Œunÿ‹d_block
 = 
Œue
;

2517 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
šode
, 
off£t
, 0, 0);

2518 ià(
»t
) {

2519 
	`šode_uÆock
(
šode
);

2520  
»t
;

2528 ià(
off£t
 =ð
Üig_¡¬t
) {

2530 
Ën
 = 
off£t
 +†’ - 
lock¡¬t
;

2531 
off£t
 = 
lock¡¬t
;

2532 
»t
 = 
	`fšd_fœ¡_nÚ_hÞe
(
šode
, &
off£t
, &
Ën
);

2533 ià(
»t
 < 0)

2534 
out_Úly_mu‹x
;

2535 ià(
»t
 && !
Ën
) {

2536 
»t
 = 0;

2537 
out_Úly_mu‹x
;

2539 
lock¡¬t
 = 
off£t
;

2543 
ž_¡¬t
 = 
lock’d
 + 1;

2544 
ž_Ën
 = 
off£t
 + 
Ën
 - 
ž_¡¬t
;

2545 ià(
ž_Ën
) {

2546 
»t
 = 
	`fšd_fœ¡_nÚ_hÞe
(
šode
, &
ž_¡¬t
, &
ž_Ën
);

2547 ià(
	`uÆik–y
(
»t
 < 0))

2548 
out_Úly_mu‹x
;

2549 ià(!
»t
) {

2551 ià(
ž_¡¬t
 + 
ž_Ën
 < 
šo_size
) {

2552 
Œunÿ‹d_block
 = 
Œue
;

2553 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
šode
,

2554 
ž_¡¬t
 + 
ž_Ën
,

2556 ià(
»t
)

2557 
out_Úly_mu‹x
;

2562 ià(
lock’d
 < 
lock¡¬t
) {

2563 
»t
 = 0;

2564 
out_Úly_mu‹x
;

2568 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2570 
	`Œunÿ‹_·geÿche_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
);

2572 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

2573 &
ÿched_¡©e
);

2574 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
, 
lock’d
);

2581 ià((!
Üd”ed
 ||

2582 (
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 <ð
lock¡¬t
 ||

2583 
Üd”ed
->
fže_off£t
 > 
lock’d
)) &&

2584 !
	`bŒfs_·ge_exi¡s_š_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
)) {

2585 ià(
Üd”ed
)

2586 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2589 ià(
Üd”ed
)

2590 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2591 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
,

2592 
lock’d
, &
ÿched_¡©e
, 
GFP_NOFS
);

2593 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
lock¡¬t
,

2594 
lock’d
 - 
lock¡¬t
 + 1);

2595 ià(
»t
) {

2596 
	`šode_uÆock
(
šode
);

2597  
»t
;

2601 
·th
 = 
	`bŒfs_®loc_·th
();

2602 ià(!
·th
) {

2603 
»t
 = -
ENOMEM
;

2604 
out
;

2607 
rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
, 
BTRFS_BLOCK_RSV_TEMP
);

2608 ià(!
rsv
) {

2609 
»t
 = -
ENOMEM
;

2610 
out_ä“
;

2612 
rsv
->
size
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

2613 
rsv
->
çžç¡
 = 1;

2620 
rsv_couÁ
 = 
no_hÞes
 ? 2 : 3;

2621 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
rsv_couÁ
);

2622 ià(
	`IS_ERR
(
Œªs
)) {

2623 
”r
 = 
	`PTR_ERR
(
Œªs
);

2624 
out_ä“
;

2627 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
, 
rsv
,

2628 
mš_size
, 0);

2629 
	`BUG_ON
(
»t
);

2630 
Œªs
->
block_rsv
 = 
rsv
;

2632 
cur_off£t
 = 
lock¡¬t
;

2633 
Ën
 = 
lock’d
 - 
cur_off£t
;

2634 
cur_off£t
 < 
lock’d
) {

2635 
»t
 = 
	`__bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
·th
,

2636 
cur_off£t
, 
lock’d
 + 1,

2637 &
drÝ_’d
, 1, 0, 0, 
NULL
);

2638 ià(
»t
 !ð-
ENOSPC
)

2641 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

2643 ià(
cur_off£t
 < 
drÝ_’d
 && cur_off£ˆ< 
šo_size
) {

2644 
»t
 = 
	`fžl_hÞes
(
Œªs
, 
	`BTRFS_I
(
šode
), 
·th
,

2645 
cur_off£t
, 
drÝ_’d
);

2646 ià(
»t
) {

2653 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2654 
”r
 = 
»t
;

2659 
cur_off£t
 = 
drÝ_’d
;

2661 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

2662 ià(
»t
) {

2663 
”r
 = 
»t
;

2667 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2668 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

2670 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
rsv_couÁ
);

2671 ià(
	`IS_ERR
(
Œªs
)) {

2672 
»t
 = 
	`PTR_ERR
(
Œªs
);

2673 
Œªs
 = 
NULL
;

2677 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
,

2678 
rsv
, 
mš_size
, 0);

2679 
	`BUG_ON
(
»t
);

2680 
Œªs
->
block_rsv
 = 
rsv
;

2682 
»t
 = 
	`fšd_fœ¡_nÚ_hÞe
(
šode
, &
cur_off£t
, &
Ën
);

2683 ià(
	`uÆik–y
(
»t
 < 0))

2685 ià(
»t
 && !
Ën
) {

2686 
»t
 = 0;

2691 ià(
»t
) {

2692 
”r
 = 
»t
;

2693 
out_Œªs
;

2696 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

2708 ià(
drÝ_’d
 <ð
lock’d
)

2709 
drÝ_’d
 = 
lock’d
 + 1;

2715 ià(
cur_off£t
 < 
šo_size
 && cur_off£ˆ< 
drÝ_’d
) {

2716 
»t
 = 
	`fžl_hÞes
(
Œªs
, 
	`BTRFS_I
(
šode
), 
·th
,

2717 
cur_off£t
, 
drÝ_’d
);

2718 ià(
»t
) {

2720 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2721 
”r
 = 
»t
;

2722 
out_Œªs
;

2726 
out_Œªs
:

2727 ià(!
Œªs
)

2728 
out_ä“
;

2730 
	`šode_šc_iv”siÚ
(
šode
);

2731 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

2733 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

2734 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

2735 
upd©ed_šode
 = 
Œue
;

2736 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2737 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

2738 
out_ä“
:

2739 
	`bŒfs_ä“_·th
(
·th
);

2740 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

2741 
out
:

2742 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

2743 &
ÿched_¡©e
, 
GFP_NOFS
);

2744 
out_Úly_mu‹x
:

2745 ià(!
upd©ed_šode
 && 
Œunÿ‹d_block
 && !
»t
 && !
”r
) {

2753 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

2754 ià(
	`IS_ERR
(
Œªs
)) {

2755 
”r
 = 
	`PTR_ERR
(
Œªs
);

2757 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

2758 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2761 
	`šode_uÆock
(
šode
);

2762 ià(
»t
 && !
”r
)

2763 
”r
 = 
»t
;

2764  
”r
;

2765 
	}
}

2768 
	sçÎoc_¿nge
 {

2769 
li¡_h—d
 
	mli¡
;

2770 
u64
 
	m¡¬t
;

2771 
u64
 
	mËn
;

2780 
	$add_çÎoc_¿nge
(
li¡_h—d
 *
h—d
, 
u64
 
¡¬t
, u64 
Ën
)

2782 
çÎoc_¿nge
 *
´ev
 = 
NULL
;

2783 
çÎoc_¿nge
 *
¿nge
 = 
NULL
;

2785 ià(
	`li¡_em±y
(
h—d
))

2786 
š£¹
;

2792 
´ev
 = 
	`li¡_’Œy
(
h—d
->´ev, 
çÎoc_¿nge
, 
li¡
);

2793 ià(
´ev
->
¡¬t
 +…»v->
Ën
 == start) {

2794 
´ev
->
Ën
 +=†en;

2797 
š£¹
:

2798 
¿nge
 = 
	`km®loc
((*¿nge), 
GFP_KERNEL
);

2799 ià(!
¿nge
)

2800  -
ENOMEM
;

2801 
¿nge
->
¡¬t
 = start;

2802 
¿nge
->
Ën
 =†en;

2803 
	`li¡_add_ž
(&
¿nge
->
li¡
, 
h—d
);

2805 
	}
}

2807 
	$bŒfs_çÎoÿ‹
(
fže
 *fže, 
mode
,

2808 
loff_t
 
off£t
,†off_ˆ
Ën
)

2810 
šode
 *šodð
	`fže_šode
(
fže
);

2811 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2812 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

2813 
çÎoc_¿nge
 *
¿nge
;

2814 
çÎoc_¿nge
 *
tmp
;

2815 
li¡_h—d
 
»£rve_li¡
;

2816 
u64
 
cur_off£t
;

2817 
u64
 
Ï¡_by‹
;

2818 
u64
 
®loc_¡¬t
;

2819 
u64
 
®loc_’d
;

2820 
u64
 
®loc_hšt
 = 0;

2821 
u64
 
locked_’d
;

2822 
u64
 
aùu®_’d
 = 0;

2823 
ex‹Á_m­
 *
em
;

2824 
blocksize
 = 
	`bŒfs_šode_£ùÜsize
(
šode
);

2825 
»t
;

2827 
®loc_¡¬t
 = 
	`round_down
(
off£t
, 
blocksize
);

2828 
®loc_’d
 = 
	`round_up
(
off£t
 + 
Ën
, 
blocksize
);

2829 
cur_off£t
 = 
®loc_¡¬t
;

2832 ià(
mode
 & ~(
FALLOC_FL_KEEP_SIZE
 | 
FALLOC_FL_PUNCH_HOLE
))

2833  -
EOPNOTSUPP
;

2835 ià(
mode
 & 
FALLOC_FL_PUNCH_HOLE
)

2836  
	`bŒfs_punch_hÞe
(
šode
, 
off£t
, 
Ën
);

2843 
»t
 = 
	`bŒfs_®loc_d©a_chunk_Údemªd
(
	`BTRFS_I
(
šode
),

2844 
®loc_’d
 - 
®loc_¡¬t
);

2845 ià(
»t
 < 0)

2846  
»t
;

2848 
	`šode_lock
(
šode
);

2850 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
è&& 
off£t
 + 
Ën
 > 
šode
->
i_size
) {

2851 
»t
 = 
	`šode_Ãwsize_ok
(
šode
, 
off£t
 + 
Ën
);

2852 ià(
»t
)

2853 
out
;

2863 ià(
®loc_¡¬t
 > 
šode
->
i_size
) {

2864 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
šode
, 
	`i_size_»ad
(inode),

2865 
®loc_¡¬t
);

2866 ià(
»t
)

2867 
out
;

2868 } ià(
off£t
 + 
Ën
 > 
šode
->
i_size
) {

2874 
»t
 = 
	`bŒfs_Œunÿ‹_block
(
šode
, inode->
i_size
, 0, 0);

2875 ià(
»t
)

2876 
out
;

2883 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
®loc_¡¬t
,

2884 
®loc_’d
 - 
®loc_¡¬t
);

2885 ià(
»t
)

2886 
out
;

2888 
locked_’d
 = 
®loc_’d
 - 1;

2890 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2895 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
®loc_¡¬t
,

2896 
locked_’d
, &
ÿched_¡©e
);

2897 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
,

2898 
®loc_’d
 - 1);

2899 ià(
Üd”ed
 &&

2900 
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 > 
®loc_¡¬t
 &&

2901 
Üd”ed
->
fže_off£t
 < 
®loc_’d
) {

2902 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2903 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

2904 
®loc_¡¬t
, 
locked_’d
,

2905 &
ÿched_¡©e
, 
GFP_KERNEL
);

2910 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
®loc_¡¬t
,

2911 
®loc_’d
 - 
®loc_¡¬t
);

2912 ià(
»t
)

2913 
out
;

2915 ià(
Üd”ed
)

2916 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2922 
	`INIT_LIST_HEAD
(&
»£rve_li¡
);

2924 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
cur_off£t
,

2925 
®loc_’d
 - 
cur_off£t
, 0);

2926 ià(
	`IS_ERR
(
em
)) {

2927 
»t
 = 
	`PTR_ERR
(
em
);

2930 
Ï¡_by‹
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
), 
®loc_’d
);

2931 
aùu®_’d
 = 
	`mš_t
(
u64
, 
	`ex‹Á_m­_’d
(
em
), 
off£t
 + 
Ën
);

2932 
Ï¡_by‹
 = 
	`ALIGN
Öa¡_by‹, 
blocksize
);

2933 ià(
em
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
 ||

2934 (
cur_off£t
 >ð
šode
->
i_size
 &&

2935 !
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))) {

2936 
»t
 = 
	`add_çÎoc_¿nge
(&
»£rve_li¡
, 
cur_off£t
,

2937 
Ï¡_by‹
 - 
cur_off£t
);

2938 ià(
»t
 < 0) {

2939 
	`ä“_ex‹Á_m­
(
em
);

2942 
»t
 = 
	`bŒfs_qgroup_»£rve_d©a
(
šode
, &
d©a_»£rved
,

2943 
cur_off£t
, 
Ï¡_by‹
 - cur_offset);

2944 ià(
»t
 < 0) {

2945 
	`ä“_ex‹Á_m­
(
em
);

2954 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
d©a_»£rved
,

2955 
cur_off£t
, 
Ï¡_by‹
 - cur_offset);

2957 
	`ä“_ex‹Á_m­
(
em
);

2958 
cur_off£t
 = 
Ï¡_by‹
;

2959 ià(
cur_off£t
 >ð
®loc_’d
)

2967 
	`li¡_fÜ_—ch_’Œy_§ã
(
¿nge
, 
tmp
, &
»£rve_li¡
, 
li¡
) {

2968 ià(!
»t
)

2969 
»t
 = 
	`bŒfs_´—Îoc_fže_¿nge
(
šode
, 
mode
,

2970 
¿nge
->
¡¬t
,

2971 
¿nge
->
Ën
, 
	`i_blocksize
(
šode
),

2972 
off£t
 + 
Ën
, &
®loc_hšt
);

2974 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
,

2975 
d©a_»£rved
, 
¿nge
->
¡¬t
,

2976 
¿nge
->
Ën
);

2977 
	`li¡_d–
(&
¿nge
->
li¡
);

2978 
	`kä“
(
¿nge
);

2980 ià(
»t
 < 0)

2981 
out_uÆock
;

2983 ià(
aùu®_’d
 > 
šode
->
i_size
 &&

2984 !(
mode
 & 
FALLOC_FL_KEEP_SIZE
)) {

2985 
bŒfs_Œªs_hªdË
 *
Œªs
;

2986 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2993 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

2994 ià(
	`IS_ERR
(
Œªs
)) {

2995 
»t
 = 
	`PTR_ERR
(
Œªs
);

2997 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

2998 
	`i_size_wr™e
(
šode
, 
aùu®_’d
);

2999 
	`bŒfs_Üd”ed_upd©e_i_size
(
šode
, 
aùu®_’d
, 
NULL
);

3000 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

3001 ià(
»t
)

3002 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3004 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3007 
out_uÆock
:

3008 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
®loc_¡¬t
, 
locked_’d
,

3009 &
ÿched_¡©e
, 
GFP_KERNEL
);

3010 
out
:

3011 
	`šode_uÆock
(
šode
);

3013 ià(
»t
 != 0)

3014 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
d©a_»£rved
,

3015 
®loc_¡¬t
, 
®loc_’d
 - 
cur_off£t
);

3016 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

3017  
»t
;

3018 
	}
}

3020 
	$fšd_desœed_ex‹Á
(
šode
 *šode, 
loff_t
 *
off£t
, 
wh’û
)

3022 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3023 
ex‹Á_m­
 *
em
 = 
NULL
;

3024 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

3025 
u64
 
lock¡¬t
;

3026 
u64
 
lock’d
;

3027 
u64
 
¡¬t
;

3028 
u64
 
Ën
;

3029 
»t
 = 0;

3031 ià(
šode
->
i_size
 == 0)

3032  -
ENXIO
;

3038 
¡¬t
 = 
	`max_t
(
loff_t
, 0, *
off£t
);

3040 
lock¡¬t
 = 
	`round_down
(
¡¬t
, 
fs_šfo
->
£ùÜsize
);

3041 
lock’d
 = 
	`round_up
(
	`i_size_»ad
(
šode
),

3042 
fs_šfo
->
£ùÜsize
);

3043 ià(
lock’d
 <ð
lock¡¬t
)

3044 
lock’d
 = 
lock¡¬t
 + 
fs_šfo
->
£ùÜsize
;

3045 
lock’d
--;

3046 
Ën
 = 
lock’d
 - 
lock¡¬t
 + 1;

3048 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

3049 &
ÿched_¡©e
);

3051 
¡¬t
 < 
šode
->
i_size
) {

3052 
em
 = 
	`bŒfs_g‘_ex‹Á_f›m­
(
	`BTRFS_I
(
šode
), 
NULL
, 0,

3053 
¡¬t
, 
Ën
, 0);

3054 ià(
	`IS_ERR
(
em
)) {

3055 
»t
 = 
	`PTR_ERR
(
em
);

3056 
em
 = 
NULL
;

3060 ià(
wh’û
 =ð
SEEK_HOLE
 &&

3061 (
em
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
 ||

3062 
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)))

3064 ià(
wh’û
 =ð
SEEK_DATA
 &&

3065 (
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
 &&

3066 !
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)))

3069 
¡¬t
 = 
em
->¡¬ˆ+ƒm->
Ën
;

3070 
	`ä“_ex‹Á_m­
(
em
);

3071 
em
 = 
NULL
;

3072 
	`cÚd_»sched
();

3074 
	`ä“_ex‹Á_m­
(
em
);

3075 ià(!
»t
) {

3076 ià(
wh’û
 =ð
SEEK_DATA
 && 
¡¬t
 >ð
šode
->
i_size
)

3077 
»t
 = -
ENXIO
;

3079 *
off£t
 = 
	`mš_t
(
loff_t
, 
¡¬t
, 
šode
->
i_size
);

3081 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

3082 &
ÿched_¡©e
, 
GFP_NOFS
);

3083  
»t
;

3084 
	}
}

3086 
loff_t
 
	$bŒfs_fže_Î£ek
(
fže
 *fže, 
loff_t
 
off£t
, 
wh’û
)

3088 
šode
 *šodð
fže
->
f_m­pšg
->
ho¡
;

3089 
»t
;

3091 
	`šode_lock
(
šode
);

3092 
wh’û
) {

3093 
SEEK_END
:

3094 
SEEK_CUR
:

3095 
off£t
 = 
	`g’”ic_fže_Î£ek
(
fže
, off£t, 
wh’û
);

3096 
out
;

3097 
SEEK_DATA
:

3098 
SEEK_HOLE
:

3099 ià(
off£t
 >ð
	`i_size_»ad
(
šode
)) {

3100 
	`šode_uÆock
(
šode
);

3101  -
ENXIO
;

3104 
»t
 = 
	`fšd_desœed_ex‹Á
(
šode
, &
off£t
, 
wh’û
);

3105 ià(
»t
) {

3106 
	`šode_uÆock
(
šode
);

3107  
»t
;

3111 
off£t
 = 
	`vfs_£os
(
fže
, off£t, 
šode
->
i_sb
->
s_maxby‹s
);

3112 
out
:

3113 
	`šode_uÆock
(
šode
);

3114  
off£t
;

3115 
	}
}

3117 
	$bŒfs_fže_Ý’
(
šode
 *šode, 
fže
 *
fžp
)

3119 
fžp
->
f_mode
 |ð
FMODE_NOWAIT
;

3120  
	`g’”ic_fže_Ý’
(
šode
, 
fžp
);

3121 
	}
}

3123 cÚ¡ 
fže_Ý”©iÚs
 
	gbŒfs_fže_Ý”©iÚs
 = {

3124 .
Î£ek
 = 
bŒfs_fže_Î£ek
,

3125 .
	g»ad_™”
 = 
g’”ic_fže_»ad_™”
,

3126 .
	g¥liû_»ad
 = 
g’”ic_fže_¥liû_»ad
,

3127 .
	gwr™e_™”
 = 
bŒfs_fže_wr™e_™”
,

3128 .
	gmm­
 = 
bŒfs_fže_mm­
,

3129 .
	gÝ’
 = 
bŒfs_fže_Ý’
,

3130 .
	g»Ëa£
 = 
bŒfs_»Ëa£_fže
,

3131 .
	gfsync
 = 
bŒfs_sync_fže
,

3132 .
	gçÎoÿ‹
 = 
bŒfs_çÎoÿ‹
,

3133 .
	guÆocked_ioùl
 = 
bŒfs_ioùl
,

3134 #ifdeà
CONFIG_COMPAT


3135 .
	gcom·t_ioùl
 = 
bŒfs_com·t_ioùl
,

3137 .
	gþÚe_fže_¿nge
 = 
bŒfs_þÚe_fže_¿nge
,

3138 .
	gdedu³_fže_¿nge
 = 
bŒfs_dedu³_fže_¿nge
,

3141 
	$bŒfs_auto_deäag_ex™
()

3143 
	`kmem_ÿche_de¡roy
(
bŒfs_šode_deäag_ÿch•
);

3144 
	}
}

3146 
	$bŒfs_auto_deäag_š™
()

3148 
bŒfs_šode_deäag_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_inode_defrag",

3149 (
šode_deäag
), 0,

3150 
SLAB_MEM_SPREAD
,

3151 
NULL
);

3152 ià(!
bŒfs_šode_deäag_ÿch•
)

3153  -
ENOMEM
;

3156 
	}
}

3158 
	$bŒfs_fd©awr™e_¿nge
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
)

3160 
»t
;

3176 
»t
 = 
	`fžem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

3177 ià(!
»t
 && 
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

3178 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

3179 
»t
 = 
	`fžem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

3181  
»t
;

3182 
	}
}

	@free-space-cache.c

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/sched.h
>

21 
	~<lšux/sched/sigÇl.h
>

22 
	~<lšux/¦ab.h
>

23 
	~<lšux/m©h64.h
>

24 
	~<lšux/¿‹lim™.h
>

25 
	~"ù»e.h
"

26 
	~"ä“-¥aû-ÿche.h
"

27 
	~"Œª§ùiÚ.h
"

28 
	~"disk-io.h
"

29 
	~"ex‹Á_io.h
"

30 
	~"šode-m­.h
"

31 
	~"vÞumes.h
"

33 
	#BITS_PER_BITMAP
 (
PAGE_SIZE
 * 8UL)

	)

34 
	#MAX_CACHE_BYTES_PER_GIG
 
SZ_32K


	)

36 
	sbŒfs_Œim_¿nge
 {

37 
u64
 
	m¡¬t
;

38 
u64
 
	mby‹s
;

39 
li¡_h—d
 
	mli¡
;

42 
lšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

43 
bŒfs_ä“_¥aû
 *
šfo
);

44 
uÆšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

45 
bŒfs_ä“_¥aû
 *
šfo
);

46 
bŒfs_wa™_ÿche_io_roÙ
(
bŒfs_roÙ
 *
roÙ
,

47 
bŒfs_Œªs_hªdË
 *
Œªs
,

48 
bŒfs_io_ùl
 *
io_ùl
,

49 
bŒfs_·th
 *
·th
);

51 
šode
 *
	$__lookup_ä“_¥aû_šode
(
bŒfs_roÙ
 *
roÙ
,

52 
bŒfs_·th
 *
·th
,

53 
u64
 
off£t
)

55 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

56 
bŒfs_key
 
key
;

57 
bŒfs_key
 
loÿtiÚ
;

58 
bŒfs_disk_key
 
disk_key
;

59 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

60 
ex‹Á_bufãr
 *
Ëaf
;

61 
šode
 *šodð
NULL
;

62 
»t
;

64 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

65 
key
.
off£t
 = offset;

66 
key
.
ty³
 = 0;

68 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

69 ià(
»t
 < 0)

70  
	`ERR_PTR
(
»t
);

71 ià(
»t
 > 0) {

72 
	`bŒfs_»Ëa£_·th
(
·th
);

73  
	`ERR_PTR
(-
ENOENT
);

76 
Ëaf
 = 
·th
->
nodes
[0];

77 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

78 
bŒfs_ä“_¥aû_h—d”
);

79 
	`bŒfs_ä“_¥aû_key
(
Ëaf
, 
h—d”
, &
disk_key
);

80 
	`bŒfs_disk_key_to_ýu
(&
loÿtiÚ
, &
disk_key
);

81 
	`bŒfs_»Ëa£_·th
(
·th
);

83 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
loÿtiÚ
, 
roÙ
, 
NULL
);

84 ià(
	`IS_ERR
(
šode
))

85  
šode
;

86 ià(
	`is_bad_šode
(
šode
)) {

87 
	`ut
(
šode
);

88  
	`ERR_PTR
(-
ENOENT
);

91 
	`m­pšg_£t_gå_mask
(
šode
->
i_m­pšg
,

92 
	`m­pšg_gå_cÚ¡¿št
(
šode
->
i_m­pšg
,

93 ~(
__GFP_FS
 | 
__GFP_HIGHMEM
)));

95  
šode
;

96 
	}
}

98 
šode
 *
	$lookup_ä“_¥aû_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

99 
bŒfs_block_group_ÿche


100 *
block_group
, 
bŒfs_·th
 *
·th
)

102 
šode
 *šodð
NULL
;

103 
u32
 
æags
 = 
BTRFS_INODE_NODATASUM
 | 
BTRFS_INODE_NODATACOW
;

105 
	`¥š_lock
(&
block_group
->
lock
);

106 ià(
block_group
->
šode
)

107 
šode
 = 
	`ig¿b
(
block_group
->inode);

108 
	`¥š_uÆock
(&
block_group
->
lock
);

109 ià(
šode
)

110  
šode
;

112 
šode
 = 
	`__lookup_ä“_¥aû_šode
(
fs_šfo
->
Œ“_roÙ
, 
·th
,

113 
block_group
->
key
.
objeùid
);

114 ià(
	`IS_ERR
(
šode
))

115  
šode
;

117 
	`¥š_lock
(&
block_group
->
lock
);

118 ià(!((
	`BTRFS_I
(
šode
)->
æags
 & flags) == flags)) {

119 
	`bŒfs_šfo
(
fs_šfo
, "Old style space inode found, converting.");

120 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NODATASUM
 |

121 
BTRFS_INODE_NODATACOW
;

122 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

125 ià(!
block_group
->
œef
) {

126 
block_group
->
šode
 = 
	`ig¿b
(inode);

127 
block_group
->
œef
 = 1;

129 
	`¥š_uÆock
(&
block_group
->
lock
);

131  
šode
;

132 
	}
}

134 
	$__ü—‹_ä“_¥aû_šode
(
bŒfs_roÙ
 *
roÙ
,

135 
bŒfs_Œªs_hªdË
 *
Œªs
,

136 
bŒfs_·th
 *
·th
,

137 
u64
 
šo
, u64 
off£t
)

139 
bŒfs_key
 
key
;

140 
bŒfs_disk_key
 
disk_key
;

141 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

142 
bŒfs_šode_™em
 *
šode_™em
;

143 
ex‹Á_bufãr
 *
Ëaf
;

144 
u64
 
æags
 = 
BTRFS_INODE_NOCOMPRESS
 | 
BTRFS_INODE_PREALLOC
;

145 
»t
;

147 
»t
 = 
	`bŒfs_š£¹_em±y_šode
(
Œªs
, 
roÙ
, 
·th
, 
šo
);

148 ià(
»t
)

149  
»t
;

152 ià(
šo
 !ð
BTRFS_FREE_INO_OBJECTID
)

153 
æags
 |ð
BTRFS_INODE_NODATASUM
 | 
BTRFS_INODE_NODATACOW
;

155 
Ëaf
 = 
·th
->
nodes
[0];

156 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

157 
bŒfs_šode_™em
);

158 
	`bŒfs_™em_key
(
Ëaf
, &
disk_key
, 
·th
->
¦Ùs
[0]);

159 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
šode_™em
,

160 (*
šode_™em
));

161 
	`bŒfs_£t_šode_g’”©iÚ
(
Ëaf
, 
šode_™em
, 
Œªs
->
Œªsid
);

162 
	`bŒfs_£t_šode_size
(
Ëaf
, 
šode_™em
, 0);

163 
	`bŒfs_£t_šode_nby‹s
(
Ëaf
, 
šode_™em
, 0);

164 
	`bŒfs_£t_šode_uid
(
Ëaf
, 
šode_™em
, 0);

165 
	`bŒfs_£t_šode_gid
(
Ëaf
, 
šode_™em
, 0);

166 
	`bŒfs_£t_šode_mode
(
Ëaf
, 
šode_™em
, 
S_IFREG
 | 0600);

167 
	`bŒfs_£t_šode_æags
(
Ëaf
, 
šode_™em
, 
æags
);

168 
	`bŒfs_£t_šode_Æšk
(
Ëaf
, 
šode_™em
, 1);

169 
	`bŒfs_£t_šode_Œªsid
(
Ëaf
, 
šode_™em
, 
Œªs
->
Œªsid
);

170 
	`bŒfs_£t_šode_block_group
(
Ëaf
, 
šode_™em
, 
off£t
);

171 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

172 
	`bŒfs_»Ëa£_·th
(
·th
);

174 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

175 
key
.
off£t
 = offset;

176 
key
.
ty³
 = 0;

177 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

178 (
bŒfs_ä“_¥aû_h—d”
));

179 ià(
»t
 < 0) {

180 
	`bŒfs_»Ëa£_·th
(
·th
);

181  
»t
;

184 
Ëaf
 = 
·th
->
nodes
[0];

185 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

186 
bŒfs_ä“_¥aû_h—d”
);

187 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
h—d”
, (*header));

188 
	`bŒfs_£t_ä“_¥aû_key
(
Ëaf
, 
h—d”
, &
disk_key
);

189 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

190 
	`bŒfs_»Ëa£_·th
(
·th
);

193 
	}
}

195 
	$ü—‹_ä“_¥aû_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

196 
bŒfs_Œªs_hªdË
 *
Œªs
,

197 
bŒfs_block_group_ÿche
 *
block_group
,

198 
bŒfs_·th
 *
·th
)

200 
»t
;

201 
u64
 
šo
;

203 
»t
 = 
	`bŒfs_fšd_ä“_objeùid
(
fs_šfo
->
Œ“_roÙ
, &
šo
);

204 ià(
»t
 < 0)

205  
»t
;

207  
	`__ü—‹_ä“_¥aû_šode
(
fs_šfo
->
Œ“_roÙ
, 
Œªs
, 
·th
, 
šo
,

208 
block_group
->
key
.
objeùid
);

209 
	}
}

211 
	$bŒfs_check_Œunc_ÿche_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

212 
bŒfs_block_rsv
 *
rsv
)

214 
u64
 
Ãeded_by‹s
;

215 
»t
;

218 
Ãeded_by‹s
 = 
	`bŒfs_ÿlc_Œunc_m‘ad©a_size
(
fs_šfo
, 1) +

219 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

221 
	`¥š_lock
(&
rsv
->
lock
);

222 ià(
rsv
->
»£rved
 < 
Ãeded_by‹s
)

223 
»t
 = -
ENOSPC
;

225 
»t
 = 0;

226 
	`¥š_uÆock
(&
rsv
->
lock
);

227  
»t
;

228 
	}
}

230 
	$bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

231 
bŒfs_block_group_ÿche
 *
block_group
,

232 
šode
 *inode)

234 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

235 
»t
 = 0;

236 
boÞ
 
locked
 = 
çl£
;

238 ià(
block_group
) {

239 
bŒfs_·th
 *
·th
 = 
	`bŒfs_®loc_·th
();

241 ià(!
·th
) {

242 
»t
 = -
ENOMEM
;

243 
çž
;

245 
locked
 = 
Œue
;

246 
	`mu‹x_lock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

247 ià(!
	`li¡_em±y
(&
block_group
->
io_li¡
)) {

248 
	`li¡_d–_š™
(&
block_group
->
io_li¡
);

250 
	`bŒfs_wa™_ÿche_io
(
Œªs
, 
block_group
, 
·th
);

251 
	`bŒfs_put_block_group
(
block_group
);

258 
	`¥š_lock
(&
block_group
->
lock
);

259 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

260 
	`¥š_uÆock
(&
block_group
->
lock
);

261 
	`bŒfs_ä“_·th
(
·th
);

264 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

265 
	`Œunÿ‹_·geÿche
(
šode
, 0);

273 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
, 
šode
,

274 0, 
BTRFS_EXTENT_DATA_KEY
);

275 ià(
»t
)

276 
çž
;

278 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

280 
çž
:

281 ià(
locked
)

282 
	`mu‹x_uÆock
(&
Œªs
->
Œª§ùiÚ
->
ÿche_wr™e_mu‹x
);

283 ià(
»t
)

284 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

286  
»t
;

287 
	}
}

289 
	$»adah—d_ÿche
(
šode
 *inode)

291 
fže_¿_¡©e
 *
¿
;

292 
Ï¡_šdex
;

294 
¿
 = 
	`kz®loc
((*¿), 
GFP_NOFS
);

295 ià(!
¿
)

298 
	`fže_¿_¡©e_š™
(
¿
, 
šode
->
i_m­pšg
);

299 
Ï¡_šdex
 = (
	`i_size_»ad
(
šode
è- 1è>> 
PAGE_SHIFT
;

301 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, 
¿
, 
NULL
, 0, 
Ï¡_šdex
);

303 
	`kä“
(
¿
);

304 
	}
}

306 
	$io_ùl_š™
(
bŒfs_io_ùl
 *
io_ùl
, 
šode
 *inode,

307 
wr™e
)

309 
num_·ges
;

310 
check_ücs
 = 0;

312 
num_·ges
 = 
	`DIV_ROUND_UP
(
	`i_size_»ad
(
šode
), 
PAGE_SIZE
);

314 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ð
BTRFS_FREE_INO_OBJECTID
)

315 
check_ücs
 = 1;

318 ià(
wr™e
 && 
check_ücs
 &&

319 (
num_·ges
 * (
u32
)è>ð
PAGE_SIZE
)

320  -
ENOSPC
;

322 
	`mem£t
(
io_ùl
, 0, (
bŒfs_io_ùl
));

324 
io_ùl
->
·ges
 = 
	`kÿÎoc
(
num_·ges
, (
·ge
 *), 
GFP_NOFS
);

325 ià(!
io_ùl
->
·ges
)

326  -
ENOMEM
;

328 
io_ùl
->
num_·ges
 =‚um_pages;

329 
io_ùl
->
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

330 
io_ùl
->
check_ücs
 = check_crcs;

331 
io_ùl
->
šode
 = inode;

334 
	}
}

336 
	$io_ùl_ä“
(
bŒfs_io_ùl
 *
io_ùl
)

338 
	`kä“
(
io_ùl
->
·ges
);

339 
io_ùl
->
·ges
 = 
NULL
;

340 
	}
}

342 
	$io_ùl_unm­_·ge
(
bŒfs_io_ùl
 *
io_ùl
)

344 ià(
io_ùl
->
cur
) {

345 
io_ùl
->
cur
 = 
NULL
;

346 
io_ùl
->
Üig
 = 
NULL
;

348 
	}
}

350 
	$io_ùl_m­_·ge
(
bŒfs_io_ùl
 *
io_ùl
, 
þ—r
)

352 
	`ASSERT
(
io_ùl
->
šdex
 < io_ùl->
num_·ges
);

353 
io_ùl
->
·ge
 = io_ùl->
·ges
[io_ùl->
šdex
++];

354 
io_ùl
->
cur
 = 
	`·ge_add»ss
(io_ùl->
·ge
);

355 
io_ùl
->
Üig
 = io_ùl->
cur
;

356 
io_ùl
->
size
 = 
PAGE_SIZE
;

357 ià(
þ—r
)

358 
	`þ—r_·ge
(
io_ùl
->
cur
);

359 
	}
}

361 
	$io_ùl_drÝ_·ges
(
bŒfs_io_ùl
 *
io_ùl
)

363 
i
;

365 
	`io_ùl_unm­_·ge
(
io_ùl
);

367 
i
 = 0; i < 
io_ùl
->
num_·ges
; i++) {

368 ià(
io_ùl
->
·ges
[
i
]) {

369 
	`CË¬PageChecked
(
io_ùl
->
·ges
[
i
]);

370 
	`uÆock_·ge
(
io_ùl
->
·ges
[
i
]);

371 
	`put_·ge
(
io_ùl
->
·ges
[
i
]);

374 
	}
}

376 
	$io_ùl_´•¬e_·ges
(
bŒfs_io_ùl
 *
io_ùl
, 
šode
 *inode,

377 
u±od©e
)

379 
·ge
 *page;

380 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

381 
i
;

383 
i
 = 0; i < 
io_ùl
->
num_·ges
; i++) {

384 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
i
, 
mask
);

385 ià(!
·ge
) {

386 
	`io_ùl_drÝ_·ges
(
io_ùl
);

387  -
ENOMEM
;

389 
io_ùl
->
·ges
[
i
] = 
·ge
;

390 ià(
u±od©e
 && !
	`PageU±od©e
(
·ge
)) {

391 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

392 
	`lock_·ge
(
·ge
);

393 ià(!
	`PageU±od©e
(
·ge
)) {

394 
	`bŒfs_”r
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

396 
	`io_ùl_drÝ_·ges
(
io_ùl
);

397  -
EIO
;

402 
i
 = 0; i < 
io_ùl
->
num_·ges
; i++) {

403 
	`þ—r_·ge_dœty_fÜ_io
(
io_ùl
->
·ges
[
i
]);

404 
	`£t_·ge_ex‹Á_m­³d
(
io_ùl
->
·ges
[
i
]);

408 
	}
}

410 
	$io_ùl_£t_g’”©iÚ
(
bŒfs_io_ùl
 *
io_ùl
, 
u64
 
g’”©iÚ
)

412 
__Ë64
 *
v®
;

414 
	`io_ùl_m­_·ge
(
io_ùl
, 1);

420 ià(
io_ùl
->
check_ücs
) {

421 
io_ùl
->
cur
 +ð((
u32
è* io_ùl->
num_·ges
);

422 
io_ùl
->
size
 -ð(
u64
è+ ((
u32
è* io_ùl->
num_·ges
);

424 
io_ùl
->
cur
 +ð(
u64
);

425 
io_ùl
->
size
 -ð(
u64
) * 2;

428 
v®
 = 
io_ùl
->
cur
;

429 *
v®
 = 
	`ýu_to_Ë64
(
g’”©iÚ
);

430 
io_ùl
->
cur
 +ð(
u64
);

431 
	}
}

433 
	$io_ùl_check_g’”©iÚ
(
bŒfs_io_ùl
 *
io_ùl
, 
u64
 
g’”©iÚ
)

435 
__Ë64
 *
g’
;

441 ià(
io_ùl
->
check_ücs
) {

442 
io_ùl
->
cur
 +ð(
u32
è* io_ùl->
num_·ges
;

443 
io_ùl
->
size
 -ð(
u64
) +

444 ((
u32
è* 
io_ùl
->
num_·ges
);

446 
io_ùl
->
cur
 +ð(
u64
);

447 
io_ùl
->
size
 -ð(
u64
) * 2;

450 
g’
 = 
io_ùl
->
cur
;

451 ià(
	`Ë64_to_ýu
(*
g’
è!ð
g’”©iÚ
) {

452 
	`bŒfs_”r_¾
(
io_ùl
->
fs_šfo
,

454 *
g’
, 
g’”©iÚ
);

455 
	`io_ùl_unm­_·ge
(
io_ùl
);

456  -
EIO
;

458 
io_ùl
->
cur
 +ð(
u64
);

460 
	}
}

462 
	$io_ùl_£t_üc
(
bŒfs_io_ùl
 *
io_ùl
, 
šdex
)

464 
u32
 *
tmp
;

465 
u32
 
üc
 = ~(u32)0;

466 
off£t
 = 0;

468 ià(!
io_ùl
->
check_ücs
) {

469 
	`io_ùl_unm­_·ge
(
io_ùl
);

473 ià(
šdex
 == 0)

474 
off£t
 = (
u32
è* 
io_ùl
->
num_·ges
;

476 
üc
 = 
	`bŒfs_csum_d©a
(
io_ùl
->
Üig
 + 
off£t
, crc,

477 
PAGE_SIZE
 - 
off£t
);

478 
	`bŒfs_csum_fš®
(
üc
, (
u8
 *)&crc);

479 
	`io_ùl_unm­_·ge
(
io_ùl
);

480 
tmp
 = 
	`·ge_add»ss
(
io_ùl
->
·ges
[0]);

481 
tmp
 +ð
šdex
;

482 *
tmp
 = 
üc
;

483 
	}
}

485 
	$io_ùl_check_üc
(
bŒfs_io_ùl
 *
io_ùl
, 
šdex
)

487 
u32
 *
tmp
, 
v®
;

488 
u32
 
üc
 = ~(u32)0;

489 
off£t
 = 0;

491 ià(!
io_ùl
->
check_ücs
) {

492 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

496 ià(
šdex
 == 0)

497 
off£t
 = (
u32
è* 
io_ùl
->
num_·ges
;

499 
tmp
 = 
	`·ge_add»ss
(
io_ùl
->
·ges
[0]);

500 
tmp
 +ð
šdex
;

501 
v®
 = *
tmp
;

503 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

504 
üc
 = 
	`bŒfs_csum_d©a
(
io_ùl
->
Üig
 + 
off£t
, crc,

505 
PAGE_SIZE
 - 
off£t
);

506 
	`bŒfs_csum_fš®
(
üc
, (
u8
 *)&crc);

507 ià(
v®
 !ð
üc
) {

508 
	`bŒfs_”r_¾
(
io_ùl
->
fs_šfo
,

510 
	`io_ùl_unm­_·ge
(
io_ùl
);

511  -
EIO
;

515 
	}
}

517 
	$io_ùl_add_’Œy
(
bŒfs_io_ùl
 *
io_ùl
, 
u64
 
off£t
, u64 
by‹s
,

518 *
b™m­
)

520 
bŒfs_ä“_¥aû_’Œy
 *
’Œy
;

522 ià(!
io_ùl
->
cur
)

523  -
ENOSPC
;

525 
’Œy
 = 
io_ùl
->
cur
;

526 
’Œy
->
off£t
 = 
	`ýu_to_Ë64
(offset);

527 
’Œy
->
by‹s
 = 
	`ýu_to_Ë64
(bytes);

528 
’Œy
->
ty³
 = (
b™m­
è? 
BTRFS_FREE_SPACE_BITMAP
 :

529 
BTRFS_FREE_SPACE_EXTENT
;

530 
io_ùl
->
cur
 +ð(
bŒfs_ä“_¥aû_’Œy
);

531 
io_ùl
->
size
 -ð(
bŒfs_ä“_¥aû_’Œy
);

533 ià(
io_ùl
->
size
 >ð(
bŒfs_ä“_¥aû_’Œy
))

536 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

539 ià(
io_ùl
->
šdex
 >ðio_ùl->
num_·ges
)

543 
	`io_ùl_m­_·ge
(
io_ùl
, 1);

545 
	}
}

547 
	$io_ùl_add_b™m­
(
bŒfs_io_ùl
 *
io_ùl
, *
b™m­
)

549 ià(!
io_ùl
->
cur
)

550  -
ENOSPC
;

556 ià(
io_ùl
->
cur
 !ðio_ùl->
Üig
) {

557 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

558 ià(
io_ùl
->
šdex
 >ðio_ùl->
num_·ges
)

559  -
ENOSPC
;

560 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

563 
	`memýy
(
io_ùl
->
cur
, 
b™m­
, 
PAGE_SIZE
);

564 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

565 ià(
io_ùl
->
šdex
 < io_ùl->
num_·ges
)

566 
	`io_ùl_m­_·ge
(
io_ùl
, 0);

568 
	}
}

570 
	$io_ùl_z”o_»maššg_·ges
(
bŒfs_io_ùl
 *
io_ùl
)

576 ià(
io_ùl
->
cur
 !ðio_ùl->
Üig
)

577 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

579 
	`io_ùl_unm­_·ge
(
io_ùl
);

581 
io_ùl
->
šdex
 < io_ùl->
num_·ges
) {

582 
	`io_ùl_m­_·ge
(
io_ùl
, 1);

583 
	`io_ùl_£t_üc
(
io_ùl
, io_ùl->
šdex
 - 1);

585 
	}
}

587 
	$io_ùl_»ad_’Œy
(
bŒfs_io_ùl
 *
io_ùl
,

588 
bŒfs_ä“_¥aû
 *
’Œy
, 
u8
 *
ty³
)

590 
bŒfs_ä“_¥aû_’Œy
 *
e
;

591 
»t
;

593 ià(!
io_ùl
->
cur
) {

594 
»t
 = 
	`io_ùl_check_üc
(
io_ùl
, io_ùl->
šdex
);

595 ià(
»t
)

596  
»t
;

599 
e
 = 
io_ùl
->
cur
;

600 
’Œy
->
off£t
 = 
	`Ë64_to_ýu
(
e
->offset);

601 
’Œy
->
by‹s
 = 
	`Ë64_to_ýu
(
e
->bytes);

602 *
ty³
 = 
e
->type;

603 
io_ùl
->
cur
 +ð(
bŒfs_ä“_¥aû_’Œy
);

604 
io_ùl
->
size
 -ð(
bŒfs_ä“_¥aû_’Œy
);

606 ià(
io_ùl
->
size
 >ð(
bŒfs_ä“_¥aû_’Œy
))

609 
	`io_ùl_unm­_·ge
(
io_ùl
);

612 
	}
}

614 
	$io_ùl_»ad_b™m­
(
bŒfs_io_ùl
 *
io_ùl
,

615 
bŒfs_ä“_¥aû
 *
’Œy
)

617 
»t
;

619 
»t
 = 
	`io_ùl_check_üc
(
io_ùl
, io_ùl->
šdex
);

620 ià(
»t
)

621  
»t
;

623 
	`memýy
(
’Œy
->
b™m­
, 
io_ùl
->
cur
, 
PAGE_SIZE
);

624 
	`io_ùl_unm­_·ge
(
io_ùl
);

627 
	}
}

638 
	$m”ge_¥aû_Œ“
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

640 
bŒfs_ä“_¥aû
 *
e
, *
´ev
 = 
NULL
;

641 
rb_node
 *
n
;

643 
agaš
:

644 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

645 
n
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
);‚;‚ = 
	`rb_Ãxt
(n)) {

646 
e
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

647 ià(!
´ev
)

648 
Ãxt
;

649 ià(
e
->
b™m­
 || 
´ev
->bitmap)

650 
Ãxt
;

651 ià(
´ev
->
off£t
 +…»v->
by‹s
 =ð
e
->offset) {

652 
	`uÆšk_ä“_¥aû
(
ùl
, 
´ev
);

653 
	`uÆšk_ä“_¥aû
(
ùl
, 
e
);

654 
´ev
->
by‹s
 +ð
e
->bytes;

655 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

656 
	`lšk_ä“_¥aû
(
ùl
, 
´ev
);

657 
´ev
 = 
NULL
;

658 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

659 
agaš
;

661 
Ãxt
:

662 
´ev
 = 
e
;

664 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

665 
	}
}

667 
	$__lßd_ä“_¥aû_ÿche
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

668 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

669 
bŒfs_·th
 *
·th
, 
u64
 
off£t
)

671 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

672 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

673 
ex‹Á_bufãr
 *
Ëaf
;

674 
bŒfs_io_ùl
 
io_ùl
;

675 
bŒfs_key
 
key
;

676 
bŒfs_ä“_¥aû
 *
e
, *
n
;

677 
	`LIST_HEAD
(
b™m­s
);

678 
u64
 
num_’Œ›s
;

679 
u64
 
num_b™m­s
;

680 
u64
 
g’”©iÚ
;

681 
u8
 
ty³
;

682 
»t
 = 0;

685 ià(!
	`i_size_»ad
(
šode
))

688 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

689 
key
.
off£t
 = offset;

690 
key
.
ty³
 = 0;

692 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

693 ià(
»t
 < 0)

695 ià(
»t
 > 0) {

696 
	`bŒfs_»Ëa£_·th
(
·th
);

700 
»t
 = -1;

702 
Ëaf
 = 
·th
->
nodes
[0];

703 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

704 
bŒfs_ä“_¥aû_h—d”
);

705 
num_’Œ›s
 = 
	`bŒfs_ä“_¥aû_’Œ›s
(
Ëaf
, 
h—d”
);

706 
num_b™m­s
 = 
	`bŒfs_ä“_¥aû_b™m­s
(
Ëaf
, 
h—d”
);

707 
g’”©iÚ
 = 
	`bŒfs_ä“_¥aû_g’”©iÚ
(
Ëaf
, 
h—d”
);

708 
	`bŒfs_»Ëa£_·th
(
·th
);

710 ià(!
	`BTRFS_I
(
šode
)->
g’”©iÚ
) {

711 
	`bŒfs_šfo
(
fs_šfo
,

713 
off£t
);

717 ià(
	`BTRFS_I
(
šode
)->
g’”©iÚ
 != generation) {

718 
	`bŒfs_”r
(
fs_šfo
,

720 
	`BTRFS_I
(
šode
)->
g’”©iÚ
, generation);

724 ià(!
num_’Œ›s
)

727 
»t
 = 
	`io_ùl_š™
(&
io_ùl
, 
šode
, 0);

728 ià(
»t
)

729  
»t
;

731 
	`»adah—d_ÿche
(
šode
);

733 
»t
 = 
	`io_ùl_´•¬e_·ges
(&
io_ùl
, 
šode
, 1);

734 ià(
»t
)

735 
out
;

737 
»t
 = 
	`io_ùl_check_üc
(&
io_ùl
, 0);

738 ià(
»t
)

739 
ä“_ÿche
;

741 
»t
 = 
	`io_ùl_check_g’”©iÚ
(&
io_ùl
, 
g’”©iÚ
);

742 ià(
»t
)

743 
ä“_ÿche
;

745 
num_’Œ›s
) {

746 
e
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
,

747 
GFP_NOFS
);

748 ià(!
e
)

749 
ä“_ÿche
;

751 
»t
 = 
	`io_ùl_»ad_’Œy
(&
io_ùl
, 
e
, &
ty³
);

752 ià(
»t
) {

753 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

754 
ä“_ÿche
;

757 ià(!
e
->
by‹s
) {

758 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

759 
ä“_ÿche
;

762 ià(
ty³
 =ð
BTRFS_FREE_SPACE_EXTENT
) {

763 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

764 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
e
);

765 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

766 ià(
»t
) {

767 
	`bŒfs_”r
(
fs_šfo
,

769 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

770 
ä“_ÿche
;

773 
	`ASSERT
(
num_b™m­s
);

774 
num_b™m­s
--;

775 
e
->
b™m­
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_NOFS
);

776 ià(!
e
->
b™m­
) {

777 
	`kmem_ÿche_ä“
(

778 
bŒfs_ä“_¥aû_ÿch•
, 
e
);

779 
ä“_ÿche
;

781 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

782 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
e
);

783 
ùl
->
tÙ®_b™m­s
++;

784 
ùl
->
Ý
->
	`»ÿlc_th»shÞds
(ctl);

785 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

786 ià(
»t
) {

787 
	`bŒfs_”r
(
fs_šfo
,

789 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
e
);

790 
ä“_ÿche
;

792 
	`li¡_add_ž
(&
e
->
li¡
, &
b™m­s
);

795 
num_’Œ›s
--;

798 
	`io_ùl_unm­_·ge
(&
io_ùl
);

804 
	`li¡_fÜ_—ch_’Œy_§ã
(
e
, 
n
, &
b™m­s
, 
li¡
) {

805 
	`li¡_d–_š™
(&
e
->
li¡
);

806 
»t
 = 
	`io_ùl_»ad_b™m­
(&
io_ùl
, 
e
);

807 ià(
»t
)

808 
ä“_ÿche
;

811 
	`io_ùl_drÝ_·ges
(&
io_ùl
);

812 
	`m”ge_¥aû_Œ“
(
ùl
);

813 
»t
 = 1;

814 
out
:

815 
	`io_ùl_ä“
(&
io_ùl
);

816  
»t
;

817 
ä“_ÿche
:

818 
	`io_ùl_drÝ_·ges
(&
io_ùl
);

819 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ùl
);

820 
out
;

821 
	}
}

823 
	$lßd_ä“_¥aû_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

824 
bŒfs_block_group_ÿche
 *
block_group
)

826 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

827 
šode
 *inode;

828 
bŒfs_·th
 *
·th
;

829 
»t
 = 0;

830 
boÞ
 
m©ched
;

831 
u64
 
u£d
 = 
	`bŒfs_block_group_u£d
(&
block_group
->
™em
);

837 
	`¥š_lock
(&
block_group
->
lock
);

838 ià(
block_group
->
disk_ÿche_¡©e
 !ð
BTRFS_DC_WRITTEN
) {

839 
	`¥š_uÆock
(&
block_group
->
lock
);

842 
	`¥š_uÆock
(&
block_group
->
lock
);

844 
·th
 = 
	`bŒfs_®loc_·th
();

845 ià(!
·th
)

847 
·th
->
£¬ch_comm™_roÙ
 = 1;

848 
·th
->
sk_lockšg
 = 1;

850 
šode
 = 
	`lookup_ä“_¥aû_šode
(
fs_šfo
, 
block_group
, 
·th
);

851 ià(
	`IS_ERR
(
šode
)) {

852 
	`bŒfs_ä“_·th
(
·th
);

857 
	`¥š_lock
(&
block_group
->
lock
);

858 ià(
block_group
->
disk_ÿche_¡©e
 !ð
BTRFS_DC_WRITTEN
) {

859 
	`¥š_uÆock
(&
block_group
->
lock
);

860 
	`bŒfs_ä“_·th
(
·th
);

861 
out
;

863 
	`¥š_uÆock
(&
block_group
->
lock
);

865 
»t
 = 
	`__lßd_ä“_¥aû_ÿche
(
fs_šfo
->
Œ“_roÙ
, 
šode
, 
ùl
,

866 
·th
, 
block_group
->
key
.
objeùid
);

867 
	`bŒfs_ä“_·th
(
·th
);

868 ià(
»t
 <= 0)

869 
out
;

871 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

872 
m©ched
 = (
ùl
->
ä“_¥aû
 =ð(
block_group
->
key
.
off£t
 - 
u£d
 -

873 
block_group
->
by‹s_su³r
));

874 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

876 ià(!
m©ched
) {

877 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ùl
);

878 
	`bŒfs_w¬n
(
fs_šfo
,

880 
block_group
->
key
.
objeùid
);

881 
»t
 = -1;

883 
out
:

884 ià(
»t
 < 0) {

886 
	`¥š_lock
(&
block_group
->
lock
);

887 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_CLEAR
;

888 
	`¥š_uÆock
(&
block_group
->
lock
);

889 
»t
 = 0;

891 
	`bŒfs_w¬n
(
fs_šfo
,

893 
block_group
->
key
.
objeùid
);

896 
	`ut
(
šode
);

897  
»t
;

898 
	}
}

900 
nošlše_fÜ_¡ack


901 
	$wr™e_ÿche_ex‹Á_’Œ›s
(
bŒfs_io_ùl
 *
io_ùl
,

902 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

903 
bŒfs_block_group_ÿche
 *
block_group
,

904 *
’Œ›s
, *
b™m­s
,

905 
li¡_h—d
 *
b™m­_li¡
)

907 
»t
;

908 
bŒfs_ä“_þu¡”
 *
þu¡”
 = 
NULL
;

909 
bŒfs_ä“_þu¡”
 *
þu¡”_locked
 = 
NULL
;

910 
rb_node
 *
node
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
);

911 
bŒfs_Œim_¿nge
 *
Œim_’Œy
;

914 ià(
block_group
 && !
	`li¡_em±y
(&block_group->
þu¡”_li¡
)) {

915 
þu¡”
 = 
	`li¡_’Œy
(
block_group
->
þu¡”_li¡
.
Ãxt
,

916 
bŒfs_ä“_þu¡”
,

917 
block_group_li¡
);

920 ià(!
node
 && 
þu¡”
) {

921 
þu¡”_locked
 = 
þu¡”
;

922 
	`¥š_lock
(&
þu¡”_locked
->
lock
);

923 
node
 = 
	`rb_fœ¡
(&
þu¡”
->
roÙ
);

924 
þu¡”
 = 
NULL
;

928 
node
) {

929 
bŒfs_ä“_¥aû
 *
e
;

931 
e
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

932 *
’Œ›s
 += 1;

934 
»t
 = 
	`io_ùl_add_’Œy
(
io_ùl
, 
e
->
off£t
,ƒ->
by‹s
,

935 
e
->
b™m­
);

936 ià(
»t
)

937 
çž
;

939 ià(
e
->
b™m­
) {

940 
	`li¡_add_ž
(&
e
->
li¡
, 
b™m­_li¡
);

941 *
b™m­s
 += 1;

943 
node
 = 
	`rb_Ãxt
(node);

944 ià(!
node
 && 
þu¡”
) {

945 
node
 = 
	`rb_fœ¡
(&
þu¡”
->
roÙ
);

946 
þu¡”_locked
 = 
þu¡”
;

947 
	`¥š_lock
(&
þu¡”_locked
->
lock
);

948 
þu¡”
 = 
NULL
;

951 ià(
þu¡”_locked
) {

952 
	`¥š_uÆock
(&
þu¡”_locked
->
lock
);

953 
þu¡”_locked
 = 
NULL
;

962 
	`li¡_fÜ_—ch_’Œy
(
Œim_’Œy
, &
ùl
->
Œimmšg_¿nges
, 
li¡
) {

963 
»t
 = 
	`io_ùl_add_’Œy
(
io_ùl
, 
Œim_’Œy
->
¡¬t
,

964 
Œim_’Œy
->
by‹s
, 
NULL
);

965 ià(
»t
)

966 
çž
;

967 *
’Œ›s
 += 1;

971 
çž
:

972 ià(
þu¡”_locked
)

973 
	`¥š_uÆock
(&
þu¡”_locked
->
lock
);

974  -
ENOSPC
;

975 
	}
}

977 
nošlše_fÜ_¡ack
 

978 
	$upd©e_ÿche_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

979 
bŒfs_roÙ
 *
roÙ
,

980 
šode
 *inode,

981 
bŒfs_·th
 *
·th
, 
u64
 
off£t
,

982 
’Œ›s
, 
b™m­s
)

984 
bŒfs_key
 
key
;

985 
bŒfs_ä“_¥aû_h—d”
 *
h—d”
;

986 
ex‹Á_bufãr
 *
Ëaf
;

987 
»t
;

989 
key
.
objeùid
 = 
BTRFS_FREE_SPACE_OBJECTID
;

990 
key
.
off£t
 = offset;

991 
key
.
ty³
 = 0;

993 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

994 ià(
»t
 < 0) {

995 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, inode->
i_size
 - 1,

996 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
, 0, 0, 
NULL
,

997 
GFP_NOFS
);

998 
çž
;

1000 
Ëaf
 = 
·th
->
nodes
[0];

1001 ià(
»t
 > 0) {

1002 
bŒfs_key
 
found_key
;

1003 
	`ASSERT
(
·th
->
¦Ùs
[0]);

1004 
·th
->
¦Ùs
[0]--;

1005 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1006 ià(
found_key
.
objeùid
 !ð
BTRFS_FREE_SPACE_OBJECTID
 ||

1007 
found_key
.
off£t
 != offset) {

1008 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0,

1009 
šode
->
i_size
 - 1,

1010 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
, 0, 0,

1011 
NULL
, 
GFP_NOFS
);

1012 
	`bŒfs_»Ëa£_·th
(
·th
);

1013 
çž
;

1017 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

1018 
h—d”
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1019 
bŒfs_ä“_¥aû_h—d”
);

1020 
	`bŒfs_£t_ä“_¥aû_’Œ›s
(
Ëaf
, 
h—d”
, 
’Œ›s
);

1021 
	`bŒfs_£t_ä“_¥aû_b™m­s
(
Ëaf
, 
h—d”
, 
b™m­s
);

1022 
	`bŒfs_£t_ä“_¥aû_g’”©iÚ
(
Ëaf
, 
h—d”
, 
Œªs
->
Œªsid
);

1023 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1024 
	`bŒfs_»Ëa£_·th
(
·th
);

1028 
çž
:

1030 
	}
}

1032 
nošlše_fÜ_¡ack
 

1033 
	$wr™e_pšÃd_ex‹Á_’Œ›s
(
bŒfs_fs_šfo
 *
fs_šfo
,

1034 
bŒfs_block_group_ÿche
 *
block_group
,

1035 
bŒfs_io_ùl
 *
io_ùl
,

1036 *
’Œ›s
)

1038 
u64
 
¡¬t
, 
ex‹Á_¡¬t
, 
ex‹Á_’d
, 
Ën
;

1039 
ex‹Á_io_Œ“
 *
uÅš
 = 
NULL
;

1040 
»t
;

1042 ià(!
block_group
)

1052 
uÅš
 = 
fs_šfo
->
pšÃd_ex‹Ás
;

1054 
¡¬t
 = 
block_group
->
key
.
objeùid
;

1056 
¡¬t
 < 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
) {

1057 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(
uÅš
, 
¡¬t
,

1058 &
ex‹Á_¡¬t
, &
ex‹Á_’d
,

1059 
EXTENT_DIRTY
, 
NULL
);

1060 ià(
»t
)

1064 ià(
ex‹Á_¡¬t
 >ð
block_group
->
key
.
objeùid
 +

1065 
block_group
->
key
.
off£t
)

1068 
ex‹Á_¡¬t
 = 
	`max
Óx‹Á_¡¬t, 
¡¬t
);

1069 
ex‹Á_’d
 = 
	`mš
(
block_group
->
key
.
objeùid
 +

1070 
block_group
->
key
.
off£t
, 
ex‹Á_’d
 + 1);

1071 
Ën
 = 
ex‹Á_’d
 - 
ex‹Á_¡¬t
;

1073 *
’Œ›s
 += 1;

1074 
»t
 = 
	`io_ùl_add_’Œy
(
io_ùl
, 
ex‹Á_¡¬t
, 
Ën
, 
NULL
);

1075 ià(
»t
)

1076  -
ENOSPC
;

1078 
¡¬t
 = 
ex‹Á_’d
;

1082 
	}
}

1084 
nošlše_fÜ_¡ack
 

1085 
	$wr™e_b™m­_’Œ›s
(
bŒfs_io_ùl
 *
io_ùl
, 
li¡_h—d
 *
b™m­_li¡
)

1087 
bŒfs_ä“_¥aû
 *
’Œy
, *
Ãxt
;

1088 
»t
;

1091 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, 
b™m­_li¡
, 
li¡
) {

1092 
»t
 = 
	`io_ùl_add_b™m­
(
io_ùl
, 
’Œy
->
b™m­
);

1093 ià(
»t
)

1094  -
ENOSPC
;

1095 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

1099 
	}
}

1101 
	$æush_dœty_ÿche
(
šode
 *inode)

1103 
»t
;

1105 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, (
u64
)-1);

1106 ià(
»t
)

1107 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, inode->
i_size
 - 1,

1108 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
, 0, 0, 
NULL
,

1109 
GFP_NOFS
);

1111  
»t
;

1112 
	}
}

1114 
nošlše_fÜ_¡ack


1115 
	$þ—nup_b™m­_li¡
(
li¡_h—d
 *
b™m­_li¡
)

1117 
bŒfs_ä“_¥aû
 *
’Œy
, *
Ãxt
;

1119 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
Ãxt
, 
b™m­_li¡
, 
li¡
)

1120 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

1121 
	}
}

1123 
nošlše_fÜ_¡ack


1124 
	$þ—nup_wr™e_ÿche_’o¥c
(
šode
 *inode,

1125 
bŒfs_io_ùl
 *
io_ùl
,

1126 
ex‹Á_¡©e
 **
ÿched_¡©e
)

1128 
	`io_ùl_drÝ_·ges
(
io_ùl
);

1129 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0,

1130 
	`i_size_»ad
(
šode
è- 1, 
ÿched_¡©e
,

1131 
GFP_NOFS
);

1132 
	}
}

1134 
	$__bŒfs_wa™_ÿche_io
(
bŒfs_roÙ
 *
roÙ
,

1135 
bŒfs_Œªs_hªdË
 *
Œªs
,

1136 
bŒfs_block_group_ÿche
 *
block_group
,

1137 
bŒfs_io_ùl
 *
io_ùl
,

1138 
bŒfs_·th
 *
·th
, 
u64
 
off£t
)

1140 
»t
;

1141 
šode
 *šodð
io_ùl
->inode;

1142 
bŒfs_fs_šfo
 *
fs_šfo
;

1144 ià(!
šode
)

1147 
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1150 
»t
 = 
	`æush_dœty_ÿche
(
šode
);

1151 ià(
»t
)

1152 
out
;

1155 
»t
 = 
	`upd©e_ÿche_™em
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
off£t
,

1156 
io_ùl
->
’Œ›s
, io_ùl->
b™m­s
);

1157 
out
:

1158 
	`io_ùl_ä“
(
io_ùl
);

1159 ià(
»t
) {

1160 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

1161 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

1162 ià(
block_group
) {

1163 #ifdeà
DEBUG


1164 
	`bŒfs_”r
(
fs_šfo
,

1166 
block_group
->
key
.
objeùid
);

1170 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

1172 ià(
block_group
) {

1174 
	`¥š_lock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1177 
	`¥š_lock
(&
block_group
->
lock
);

1184 ià(!
»t
 && 
	`li¡_em±y
(&
block_group
->
dœty_li¡
))

1185 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_WRITTEN
;

1186 ià(
»t
)

1187 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

1189 
	`¥š_uÆock
(&
block_group
->
lock
);

1190 
	`¥š_uÆock
(&
Œªs
->
Œª§ùiÚ
->
dœty_bgs_lock
);

1191 
io_ùl
->
šode
 = 
NULL
;

1192 
	`ut
(
šode
);

1195  
»t
;

1197 
	}
}

1199 
	$bŒfs_wa™_ÿche_io_roÙ
(
bŒfs_roÙ
 *
roÙ
,

1200 
bŒfs_Œªs_hªdË
 *
Œªs
,

1201 
bŒfs_io_ùl
 *
io_ùl
,

1202 
bŒfs_·th
 *
·th
)

1204  
	`__bŒfs_wa™_ÿche_io
(
roÙ
, 
Œªs
, 
NULL
, 
io_ùl
, 
·th
, 0);

1205 
	}
}

1207 
	$bŒfs_wa™_ÿche_io
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1208 
bŒfs_block_group_ÿche
 *
block_group
,

1209 
bŒfs_·th
 *
·th
)

1211  
	`__bŒfs_wa™_ÿche_io
(
block_group
->
fs_šfo
->
Œ“_roÙ
, 
Œªs
,

1212 
block_group
, &block_group->
io_ùl
,

1213 
·th
, 
block_group
->
key
.
objeùid
);

1214 
	}
}

1227 
	$__bŒfs_wr™e_out_ÿche
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

1228 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1229 
bŒfs_block_group_ÿche
 *
block_group
,

1230 
bŒfs_io_ùl
 *
io_ùl
,

1231 
bŒfs_Œªs_hªdË
 *
Œªs
)

1233 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1234 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1235 
	`LIST_HEAD
(
b™m­_li¡
);

1236 
’Œ›s
 = 0;

1237 
b™m­s
 = 0;

1238 
»t
;

1239 
mu¡_ut
 = 0;

1241 ià(!
	`i_size_»ad
(
šode
))

1242  -
EIO
;

1244 
	`WARN_ON
(
io_ùl
->
·ges
);

1245 
»t
 = 
	`io_ùl_š™
(
io_ùl
, 
šode
, 1);

1246 ià(
»t
)

1247  
»t
;

1249 ià(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)) {

1250 
	`down_wr™e
(&
block_group
->
d©a_rw£m
);

1251 
	`¥š_lock
(&
block_group
->
lock
);

1252 ià(
block_group
->
d–®loc_by‹s
) {

1253 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_WRITTEN
;

1254 
	`¥š_uÆock
(&
block_group
->
lock
);

1255 
	`up_wr™e
(&
block_group
->
d©a_rw£m
);

1256 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

1257 
»t
 = 0;

1258 
mu¡_ut
 = 1;

1259 
out
;

1261 
	`¥š_uÆock
(&
block_group
->
lock
);

1265 
»t
 = 
	`io_ùl_´•¬e_·ges
(
io_ùl
, 
šode
, 0);

1266 ià(
»t
)

1267 
out
;

1269 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, 
	`i_size_»ad
(inode) - 1,

1270 &
ÿched_¡©e
);

1272 
	`io_ùl_£t_g’”©iÚ
(
io_ùl
, 
Œªs
->
Œªsid
);

1274 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

1276 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

1277 
»t
 = 
	`wr™e_ÿche_ex‹Á_’Œ›s
(
io_ùl
, 
ùl
,

1278 
block_group
, &
’Œ›s
, &
b™m­s
,

1279 &
b™m­_li¡
);

1280 ià(
»t
)

1281 
out_no¥c_locked
;

1291 
»t
 = 
	`wr™e_pšÃd_ex‹Á_’Œ›s
(
fs_šfo
, 
block_group
,

1292 
io_ùl
, &
’Œ›s
);

1293 ià(
»t
)

1294 
out_no¥c_locked
;

1301 
»t
 = 
	`wr™e_b™m­_’Œ›s
(
io_ùl
, &
b™m­_li¡
);

1302 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

1303 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

1304 ià(
»t
)

1305 
out_no¥c
;

1308 
	`io_ùl_z”o_»maššg_·ges
(
io_ùl
);

1311 
»t
 = 
	`bŒfs_dœty_·ges
(
šode
, 
io_ùl
->
·ges
, io_ùl->
num_·ges
, 0,

1312 
	`i_size_»ad
(
šode
), &
ÿched_¡©e
);

1313 ià(
»t
)

1314 
out_no¥c
;

1316 ià(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

1317 
	`up_wr™e
(&
block_group
->
d©a_rw£m
);

1322 
	`io_ùl_drÝ_·ges
(
io_ùl
);

1324 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0,

1325 
	`i_size_»ad
(
šode
è- 1, &
ÿched_¡©e
, 
GFP_NOFS
);

1332 
io_ùl
->
’Œ›s
 =ƒntries;

1333 
io_ùl
->
b™m­s
 = bitmaps;

1335 
»t
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 0, (
u64
)-1);

1336 ià(
»t
)

1337 
out
;

1341 
out
:

1342 
io_ùl
->
šode
 = 
NULL
;

1343 
	`io_ùl_ä“
(
io_ùl
);

1344 ià(
»t
) {

1345 
	`šv®id©e_šode_·ges2
(
šode
->
i_m­pšg
);

1346 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

1348 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

1349 ià(
mu¡_ut
)

1350 
	`ut
(
šode
);

1351  
»t
;

1353 
out_no¥c_locked
:

1354 
	`þ—nup_b™m­_li¡
(&
b™m­_li¡
);

1355 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

1356 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

1358 
out_no¥c
:

1359 
	`þ—nup_wr™e_ÿche_’o¥c
(
šode
, 
io_ùl
, &
ÿched_¡©e
);

1361 ià(
block_group
 && (block_group->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
))

1362 
	`up_wr™e
(&
block_group
->
d©a_rw£m
);

1364 
out
;

1365 
	}
}

1367 
	$bŒfs_wr™e_out_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

1368 
bŒfs_Œªs_hªdË
 *
Œªs
,

1369 
bŒfs_block_group_ÿche
 *
block_group
,

1370 
bŒfs_·th
 *
·th
)

1372 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

1373 
šode
 *inode;

1374 
»t
 = 0;

1376 
	`¥š_lock
(&
block_group
->
lock
);

1377 ià(
block_group
->
disk_ÿche_¡©e
 < 
BTRFS_DC_SETUP
) {

1378 
	`¥š_uÆock
(&
block_group
->
lock
);

1381 
	`¥š_uÆock
(&
block_group
->
lock
);

1383 
šode
 = 
	`lookup_ä“_¥aû_šode
(
fs_šfo
, 
block_group
, 
·th
);

1384 ià(
	`IS_ERR
(
šode
))

1387 
»t
 = 
	`__bŒfs_wr™e_out_ÿche
(
fs_šfo
->
Œ“_roÙ
, 
šode
, 
ùl
,

1388 
block_group
, &block_group->
io_ùl
, 
Œªs
);

1389 ià(
»t
) {

1390 #ifdeà
DEBUG


1391 
	`bŒfs_”r
(
fs_šfo
,

1393 
block_group
->
key
.
objeùid
);

1395 
	`¥š_lock
(&
block_group
->
lock
);

1396 
block_group
->
disk_ÿche_¡©e
 = 
BTRFS_DC_ERROR
;

1397 
	`¥š_uÆock
(&
block_group
->
lock
);

1399 
block_group
->
io_ùl
.
šode
 = 
NULL
;

1400 
	`ut
(
šode
);

1408  
»t
;

1409 
	}
}

1411 
šlše
 
	$off£t_to_b™
(
u64
 
b™m­_¡¬t
, 
u32
 
un™
,

1412 
u64
 
off£t
)

1414 
	`ASSERT
(
off£t
 >ð
b™m­_¡¬t
);

1415 
off£t
 -ð
b™m­_¡¬t
;

1416  ()(
	`div_u64
(
off£t
, 
un™
));

1417 
	}
}

1419 
šlše
 
	$by‹s_to_b™s
(
u64
 
by‹s
, 
u32
 
un™
)

1421  ()(
	`div_u64
(
by‹s
, 
un™
));

1422 
	}
}

1424 
šlše
 
u64
 
	$off£t_to_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1425 
u64
 
off£t
)

1427 
u64
 
b™m­_¡¬t
;

1428 
u64
 
by‹s_³r_b™m­
;

1430 
by‹s_³r_b™m­
 = 
BITS_PER_BITMAP
 * 
ùl
->
un™
;

1431 
b™m­_¡¬t
 = 
off£t
 - 
ùl
->
¡¬t
;

1432 
b™m­_¡¬t
 = 
	`div64_u64
(b™m­_¡¬t, 
by‹s_³r_b™m­
);

1433 
b™m­_¡¬t
 *ð
by‹s_³r_b™m­
;

1434 
b™m­_¡¬t
 +ð
ùl
->
¡¬t
;

1436  
b™m­_¡¬t
;

1437 
	}
}

1439 
	$Œ“_š£¹_off£t
(
rb_roÙ
 *
roÙ
, 
u64
 
off£t
,

1440 
rb_node
 *
node
, 
b™m­
)

1442 
rb_node
 **
p
 = &
roÙ
->rb_node;

1443 
rb_node
 *
·»Á
 = 
NULL
;

1444 
bŒfs_ä“_¥aû
 *
šfo
;

1446 *
p
) {

1447 
·»Á
 = *
p
;

1448 
šfo
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1450 ià(
off£t
 < 
šfo
->offset) {

1451 
p
 = &(*p)->
rb_Ëá
;

1452 } ià(
off£t
 > 
šfo
->offset) {

1453 
p
 = &(*p)->
rb_right
;

1468 ià(
b™m­
) {

1469 ià(
šfo
->
b™m­
) {

1470 
	`WARN_ON_ONCE
(1);

1471  -
EEXIST
;

1473 
p
 = &(*p)->
rb_right
;

1475 ià(!
šfo
->
b™m­
) {

1476 
	`WARN_ON_ONCE
(1);

1477  -
EEXIST
;

1479 
p
 = &(*p)->
rb_Ëá
;

1484 
	`rb_lšk_node
(
node
, 
·»Á
, 
p
);

1485 
	`rb_š£¹_cÞÜ
(
node
, 
roÙ
);

1488 
	}
}

1497 
bŒfs_ä“_¥aû
 *

1498 
	$Œ“_£¬ch_off£t
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1499 
u64
 
off£t
, 
b™m­_Úly
, 
fuzzy
)

1501 
rb_node
 *
n
 = 
ùl
->
ä“_¥aû_off£t
.rb_node;

1502 
bŒfs_ä“_¥aû
 *
’Œy
, *
´ev
 = 
NULL
;

1506 ià(!
n
) {

1507 
’Œy
 = 
NULL
;

1511 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1512 
´ev
 = 
’Œy
;

1514 ià(
off£t
 < 
’Œy
->offset)

1515 
n
 =‚->
rb_Ëá
;

1516 ià(
off£t
 > 
’Œy
->offset)

1517 
n
 =‚->
rb_right
;

1522 ià(
b™m­_Úly
) {

1523 ià(!
’Œy
)

1524  
NULL
;

1525 ià(
’Œy
->
b™m­
)

1526  
’Œy
;

1532 
n
 = 
	`rb_Ãxt
(n);

1533 ià(!
n
)

1534  
NULL
;

1535 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1536 ià(
’Œy
->
off£t
 != offset)

1537  
NULL
;

1539 
	`WARN_ON
(!
’Œy
->
b™m­
);

1540  
’Œy
;

1541 } ià(
’Œy
) {

1542 ià(
’Œy
->
b™m­
) {

1547 
n
 = 
	`rb_´ev
(&
’Œy
->
off£t_šdex
);

1548 ià(
n
) {

1549 
´ev
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

1550 
off£t_šdex
);

1551 ià(!
´ev
->
b™m­
 &&

1552 
´ev
->
off£t
 +…»v->
by‹s
 > offset)

1553 
’Œy
 = 
´ev
;

1556  
’Œy
;

1559 ià(!
´ev
)

1560  
NULL
;

1563 
’Œy
 = 
´ev
;

1564 ià(
’Œy
->
off£t
 > offset) {

1565 
n
 = 
	`rb_´ev
(&
’Œy
->
off£t_šdex
);

1566 ià(
n
) {

1567 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

1568 
off£t_šdex
);

1569 
	`ASSERT
(
’Œy
->
off£t
 <= offset);

1571 ià(
fuzzy
)

1572  
’Œy
;

1574  
NULL
;

1578 ià(
’Œy
->
b™m­
) {

1579 
n
 = 
	`rb_´ev
(&
’Œy
->
off£t_šdex
);

1580 ià(
n
) {

1581 
´ev
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

1582 
off£t_šdex
);

1583 ià(!
´ev
->
b™m­
 &&

1584 
´ev
->
off£t
 +…»v->
by‹s
 > offset)

1585  
´ev
;

1587 ià(
’Œy
->
off£t
 + 
BITS_PER_BITMAP
 * 
ùl
->
un™
 > offset)

1588  
’Œy
;

1589 } ià(
’Œy
->
off£t
 +ƒÁry->
by‹s
 > offset)

1590  
’Œy
;

1592 ià(!
fuzzy
)

1593  
NULL
;

1596 ià(
’Œy
->
b™m­
) {

1597 ià(
’Œy
->
off£t
 + 
BITS_PER_BITMAP
 *

1598 
ùl
->
un™
 > 
off£t
)

1601 ià(
’Œy
->
off£t
 +ƒÁry->
by‹s
 > offset)

1605 
n
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

1606 ià(!
n
)

1607  
NULL
;

1608 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1610  
’Œy
;

1611 
	}
}

1613 
šlše
 

1614 
	$__uÆšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1615 
bŒfs_ä“_¥aû
 *
šfo
)

1617 
	`rb_”a£
(&
šfo
->
off£t_šdex
, &
ùl
->
ä“_¥aû_off£t
);

1618 
ùl
->
ä“_ex‹Ás
--;

1619 
	}
}

1621 
	$uÆšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1622 
bŒfs_ä“_¥aû
 *
šfo
)

1624 
	`__uÆšk_ä“_¥aû
(
ùl
, 
šfo
);

1625 
ùl
->
ä“_¥aû
 -ð
šfo
->
by‹s
;

1626 
	}
}

1628 
	$lšk_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1629 
bŒfs_ä“_¥aû
 *
šfo
)

1631 
»t
 = 0;

1633 
	`ASSERT
(
šfo
->
by‹s
 || info->
b™m­
);

1634 
»t
 = 
	`Œ“_š£¹_off£t
(&
ùl
->
ä“_¥aû_off£t
, 
šfo
->
off£t
,

1635 &
šfo
->
off£t_šdex
, (šfo->
b™m­
 !ð
NULL
));

1636 ià(
»t
)

1637  
»t
;

1639 
ùl
->
ä“_¥aû
 +ð
šfo
->
by‹s
;

1640 
ùl
->
ä“_ex‹Ás
++;

1641  
»t
;

1642 
	}
}

1644 
	$»ÿlcuÏ‹_th»shÞds
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

1646 
bŒfs_block_group_ÿche
 *
block_group
 = 
ùl
->
´iv©e
;

1647 
u64
 
max_by‹s
;

1648 
u64
 
b™m­_by‹s
;

1649 
u64
 
ex‹Á_by‹s
;

1650 
u64
 
size
 = 
block_group
->
key
.
off£t
;

1651 
u64
 
by‹s_³r_bg
 = 
BITS_PER_BITMAP
 * 
ùl
->
un™
;

1652 
u64
 
max_b™m­s
 = 
	`div64_u64
(
size
 + 
by‹s_³r_bg
 - 1, bytes_per_bg);

1654 
max_b™m­s
 = 
	`max_t
(
u64
, max_bitmaps, 1);

1656 
	`ASSERT
(
ùl
->
tÙ®_b™m­s
 <ð
max_b™m­s
);

1663 ià(
size
 < 
SZ_1G
)

1664 
max_by‹s
 = 
MAX_CACHE_BYTES_PER_GIG
;

1666 
max_by‹s
 = 
MAX_CACHE_BYTES_PER_GIG
 * 
	`div_u64
(
size
, 
SZ_1G
);

1673 
b™m­_by‹s
 = (
ùl
->
tÙ®_b™m­s
 + 1è* cŽ->
un™
;

1675 ià(
b™m­_by‹s
 >ð
max_by‹s
) {

1676 
ùl
->
ex‹Ás_th»sh
 = 0;

1684 
ex‹Á_by‹s
 = 
max_by‹s
 - 
b™m­_by‹s
;

1685 
ex‹Á_by‹s
 = 
	`mš_t
(
u64
,ƒx‹Á_by‹s, 
max_by‹s
 >> 1);

1687 
ùl
->
ex‹Ás_th»sh
 =

1688 
	`div_u64
(
ex‹Á_by‹s
, (
bŒfs_ä“_¥aû
));

1689 
	}
}

1691 
šlše
 
	$__b™m­_þ—r_b™s
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1692 
bŒfs_ä“_¥aû
 *
šfo
,

1693 
u64
 
off£t
, u64 
by‹s
)

1695 
¡¬t
, 
couÁ
;

1697 
¡¬t
 = 
	`off£t_to_b™
(
šfo
->
off£t
, 
ùl
->
un™
, offset);

1698 
couÁ
 = 
	`by‹s_to_b™s
(
by‹s
, 
ùl
->
un™
);

1699 
	`ASSERT
(
¡¬t
 + 
couÁ
 <ð
BITS_PER_BITMAP
);

1701 
	`b™m­_þ—r
(
šfo
->
b™m­
, 
¡¬t
, 
couÁ
);

1703 
šfo
->
by‹s
 -= bytes;

1704 
	}
}

1706 
	$b™m­_þ—r_b™s
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1707 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
,

1708 
u64
 
by‹s
)

1710 
	`__b™m­_þ—r_b™s
(
ùl
, 
šfo
, 
off£t
, 
by‹s
);

1711 
ùl
->
ä“_¥aû
 -ð
by‹s
;

1712 
	}
}

1714 
	$b™m­_£t_b™s
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1715 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
,

1716 
u64
 
by‹s
)

1718 
¡¬t
, 
couÁ
;

1720 
¡¬t
 = 
	`off£t_to_b™
(
šfo
->
off£t
, 
ùl
->
un™
, offset);

1721 
couÁ
 = 
	`by‹s_to_b™s
(
by‹s
, 
ùl
->
un™
);

1722 
	`ASSERT
(
¡¬t
 + 
couÁ
 <ð
BITS_PER_BITMAP
);

1724 
	`b™m­_£t
(
šfo
->
b™m­
, 
¡¬t
, 
couÁ
);

1726 
šfo
->
by‹s
 += bytes;

1727 
ùl
->
ä“_¥aû
 +ð
by‹s
;

1728 
	}
}

1734 
	$£¬ch_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1735 
bŒfs_ä“_¥aû
 *
b™m­_šfo
, 
u64
 *
off£t
,

1736 
u64
 *
by‹s
, 
boÞ
 
fÜ_®loc
)

1738 
found_b™s
 = 0;

1739 
max_b™s
 = 0;

1740 
b™s
, 
i
;

1741 
Ãxt_z”o
;

1742 
ex‹Á_b™s
;

1748 ià(
fÜ_®loc
 &&

1749 
b™m­_šfo
->
max_ex‹Á_size
 &&

1750 
b™m­_šfo
->
max_ex‹Á_size
 < *
by‹s
) {

1751 *
by‹s
 = 
b™m­_šfo
->
max_ex‹Á_size
;

1755 
i
 = 
	`off£t_to_b™
(
b™m­_šfo
->
off£t
, 
ùl
->
un™
,

1756 
	`max_t
(
u64
, *
off£t
, 
b™m­_šfo
->offset));

1757 
b™s
 = 
	`by‹s_to_b™s
(*
by‹s
, 
ùl
->
un™
);

1759 
	`fÜ_—ch_£t_b™_äom
(
i
, 
b™m­_šfo
->
b™m­
, 
BITS_PER_BITMAP
) {

1760 ià(
fÜ_®loc
 && 
b™s
 == 1) {

1761 
found_b™s
 = 1;

1764 
Ãxt_z”o
 = 
	`fšd_Ãxt_z”o_b™
(
b™m­_šfo
->
b™m­
,

1765 
BITS_PER_BITMAP
, 
i
);

1766 
ex‹Á_b™s
 = 
Ãxt_z”o
 - 
i
;

1767 ià(
ex‹Á_b™s
 >ð
b™s
) {

1768 
found_b™s
 = 
ex‹Á_b™s
;

1770 } ià(
ex‹Á_b™s
 > 
max_b™s
) {

1771 
max_b™s
 = 
ex‹Á_b™s
;

1773 
i
 = 
Ãxt_z”o
;

1776 ià(
found_b™s
) {

1777 *
off£t
 = (
u64
)(
i
 * 
ùl
->
un™
è+ 
b™m­_šfo
->offset;

1778 *
by‹s
 = (
u64
)(
found_b™s
è* 
ùl
->
un™
;

1782 *
by‹s
 = (
u64
)(
max_b™s
è* 
ùl
->
un™
;

1783 
b™m­_šfo
->
max_ex‹Á_size
 = *
by‹s
;

1785 
	}
}

1788 
bŒfs_ä“_¥aû
 *

1789 
	$fšd_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
, 
u64
 *
off£t
, u64 *
by‹s
,

1790 
®ign
, 
u64
 *
max_ex‹Á_size
)

1792 
bŒfs_ä“_¥aû
 *
’Œy
;

1793 
rb_node
 *
node
;

1794 
u64
 
tmp
;

1795 
u64
 
®ign_off
;

1796 
»t
;

1798 ià(!
ùl
->
ä“_¥aû_off£t
.
rb_node
)

1799 
out
;

1801 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, *
off£t
), 0, 1);

1802 ià(!
’Œy
)

1803 
out
;

1805 
node
 = &
’Œy
->
off£t_šdex
;‚ode;‚odð
	`rb_Ãxt
(node)) {

1806 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

1807 ià(
’Œy
->
by‹s
 < *bytes) {

1808 ià(
’Œy
->
by‹s
 > *
max_ex‹Á_size
)

1809 *
max_ex‹Á_size
 = 
’Œy
->
by‹s
;

1816 ià(*
by‹s
 >ð
®ign
) {

1817 
tmp
 = 
’Œy
->
off£t
 - 
ùl
->
¡¬t
 + 
®ign
 - 1;

1818 
tmp
 = 
	`div64_u64
Ñmp, 
®ign
);

1819 
tmp
 =m°* 
®ign
 + 
ùl
->
¡¬t
;

1820 
®ign_off
 = 
tmp
 - 
’Œy
->
off£t
;

1822 
®ign_off
 = 0;

1823 
tmp
 = 
’Œy
->
off£t
;

1826 ià(
’Œy
->
by‹s
 < *by‹ + 
®ign_off
) {

1827 ià(
’Œy
->
by‹s
 > *
max_ex‹Á_size
)

1828 *
max_ex‹Á_size
 = 
’Œy
->
by‹s
;

1832 ià(
’Œy
->
b™m­
) {

1833 
u64
 
size
 = *
by‹s
;

1835 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
tmp
, &
size
, 
Œue
);

1836 ià(!
»t
) {

1837 *
off£t
 = 
tmp
;

1838 *
by‹s
 = 
size
;

1839  
’Œy
;

1840 } ià(
size
 > *
max_ex‹Á_size
) {

1841 *
max_ex‹Á_size
 = 
size
;

1846 *
off£t
 = 
tmp
;

1847 *
by‹s
 = 
’Œy
->by‹ - 
®ign_off
;

1848  
’Œy
;

1850 
out
:

1851  
NULL
;

1852 
	}
}

1854 
	$add_Ãw_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1855 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
)

1857 
šfo
->
off£t
 = 
	`off£t_to_b™m­
(
ùl
, offset);

1858 
šfo
->
by‹s
 = 0;

1859 
	`INIT_LIST_HEAD
(&
šfo
->
li¡
);

1860 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

1861 
ùl
->
tÙ®_b™m­s
++;

1863 
ùl
->
Ý
->
	`»ÿlc_th»shÞds
(ctl);

1864 
	}
}

1866 
	$ä“_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1867 
bŒfs_ä“_¥aû
 *
b™m­_šfo
)

1869 
	`uÆšk_ä“_¥aû
(
ùl
, 
b™m­_šfo
);

1870 
	`kä“
(
b™m­_šfo
->
b™m­
);

1871 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
b™m­_šfo
);

1872 
ùl
->
tÙ®_b™m­s
--;

1873 
ùl
->
Ý
->
	`»ÿlc_th»shÞds
(ctl);

1874 
	}
}

1876 
nošlše
 
	$»move_äom_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1877 
bŒfs_ä“_¥aû
 *
b™m­_šfo
,

1878 
u64
 *
off£t
, u64 *
by‹s
)

1880 
u64
 
’d
;

1881 
u64
 
£¬ch_¡¬t
, 
£¬ch_by‹s
;

1882 
»t
;

1884 
agaš
:

1885 
’d
 = 
b™m­_šfo
->
off£t
 + (
u64
)(
BITS_PER_BITMAP
 * 
ùl
->
un™
) - 1;

1893 
£¬ch_¡¬t
 = *
off£t
;

1894 
£¬ch_by‹s
 = 
ùl
->
un™
;

1895 
£¬ch_by‹s
 = 
	`mš
(£¬ch_by‹s, 
’d
 - 
£¬ch_¡¬t
 + 1);

1896 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
b™m­_šfo
, &
£¬ch_¡¬t
, &
£¬ch_by‹s
,

1897 
çl£
);

1898 ià(
»t
 < 0 || 
£¬ch_¡¬t
 !ð*
off£t
)

1899  -
EINVAL
;

1902 
£¬ch_by‹s
 = 
	`mš
(£¬ch_by‹s, *
by‹s
);

1905 
£¬ch_by‹s
 = 
	`mš
(£¬ch_by‹s, 
’d
 - 
£¬ch_¡¬t
 + 1);

1907 
	`b™m­_þ—r_b™s
(
ùl
, 
b™m­_šfo
, 
£¬ch_¡¬t
, 
£¬ch_by‹s
);

1908 *
off£t
 +ð
£¬ch_by‹s
;

1909 *
by‹s
 -ð
£¬ch_by‹s
;

1911 ià(*
by‹s
) {

1912 
rb_node
 *
Ãxt
 = 
	`rb_Ãxt
(&
b™m­_šfo
->
off£t_šdex
);

1913 ià(!
b™m­_šfo
->
by‹s
)

1914 
	`ä“_b™m­
(
ùl
, 
b™m­_šfo
);

1920 ià(!
Ãxt
)

1921  -
EINVAL
;

1923 
b™m­_šfo
 = 
	`rb_’Œy
(
Ãxt
, 
bŒfs_ä“_¥aû
,

1924 
off£t_šdex
);

1930 ià(!
b™m­_šfo
->
b™m­
)

1931  -
EAGAIN
;

1939 
£¬ch_¡¬t
 = *
off£t
;

1940 
£¬ch_by‹s
 = 
ùl
->
un™
;

1941 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
b™m­_šfo
, &
£¬ch_¡¬t
,

1942 &
£¬ch_by‹s
, 
çl£
);

1943 ià(
»t
 < 0 || 
£¬ch_¡¬t
 !ð*
off£t
)

1944  -
EAGAIN
;

1946 
agaš
;

1947 } ià(!
b™m­_šfo
->
by‹s
)

1948 
	`ä“_b™m­
(
ùl
, 
b™m­_šfo
);

1951 
	}
}

1953 
u64
 
	$add_by‹s_to_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1954 
bŒfs_ä“_¥aû
 *
šfo
, 
u64
 
off£t
,

1955 
u64
 
by‹s
)

1957 
u64
 
by‹s_to_£t
 = 0;

1958 
u64
 
’d
;

1960 
’d
 = 
šfo
->
off£t
 + (
u64
)(
BITS_PER_BITMAP
 * 
ùl
->
un™
);

1962 
by‹s_to_£t
 = 
	`mš
(
’d
 - 
off£t
, 
by‹s
);

1964 
	`b™m­_£t_b™s
(
ùl
, 
šfo
, 
off£t
, 
by‹s_to_£t
);

1970 
šfo
->
max_ex‹Á_size
 = 0;

1972  
by‹s_to_£t
;

1974 
	}
}

1976 
boÞ
 
	$u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

1977 
bŒfs_ä“_¥aû
 *
šfo
)

1979 
bŒfs_block_group_ÿche
 *
block_group
 = 
ùl
->
´iv©e
;

1980 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

1981 
boÞ
 
fÜûd
 = 
çl£
;

1983 #ifdeà
CONFIG_BTRFS_DEBUG


1984 ià(
	`bŒfs_should_äagm’t_ä“_¥aû
(
block_group
))

1985 
fÜûd
 = 
Œue
;

1992 ià(!
fÜûd
 && 
ùl
->
ä“_ex‹Ás
 < cŽ->
ex‹Ás_th»sh
) {

2000 ià(
šfo
->
by‹s
 <ð
fs_šfo
->
£ùÜsize
 * 4) {

2001 ià(
ùl
->
ä“_ex‹Ás
 * 2 <ðùl->
ex‹Ás_th»sh
)

2002  
çl£
;

2004  
çl£
;

2016 ià(((
BITS_PER_BITMAP
 * 
ùl
->
un™
è>> 1è> 
block_group
->
key
.
off£t
)

2017  
çl£
;

2019  
Œue
;

2020 
	}
}

2022 cÚ¡ 
bŒfs_ä“_¥aû_Ý
 
	gä“_¥aû_Ý
 = {

2023 .
»ÿlc_th»shÞds
 = 
»ÿlcuÏ‹_th»shÞds
,

2024 .
	gu£_b™m­
 = 
u£_b™m­
,

2027 
	$š£¹_što_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2028 
bŒfs_ä“_¥aû
 *
šfo
)

2030 
bŒfs_ä“_¥aû
 *
b™m­_šfo
;

2031 
bŒfs_block_group_ÿche
 *
block_group
 = 
NULL
;

2032 
added
 = 0;

2033 
u64
 
by‹s
, 
off£t
, 
by‹s_added
;

2034 
»t
;

2036 
by‹s
 = 
šfo
->bytes;

2037 
off£t
 = 
šfo
->offset;

2039 ià(!
ùl
->
Ý
->
	`u£_b™m­
(ùl, 
šfo
))

2042 ià(
ùl
->
Ý
 =ð&
ä“_¥aû_Ý
)

2043 
block_group
 = 
ùl
->
´iv©e
;

2044 
agaš
:

2050 ià(
block_group
 && !
	`li¡_em±y
(&block_group->
þu¡”_li¡
)) {

2051 
bŒfs_ä“_þu¡”
 *
þu¡”
;

2052 
rb_node
 *
node
;

2053 
bŒfs_ä“_¥aû
 *
’Œy
;

2055 
þu¡”
 = 
	`li¡_’Œy
(
block_group
->
þu¡”_li¡
.
Ãxt
,

2056 
bŒfs_ä“_þu¡”
,

2057 
block_group_li¡
);

2058 
	`¥š_lock
(&
þu¡”
->
lock
);

2059 
node
 = 
	`rb_fœ¡
(&
þu¡”
->
roÙ
);

2060 ià(!
node
) {

2061 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2062 
no_þu¡”_b™m­
;

2065 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2066 ià(!
’Œy
->
b™m­
) {

2067 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2068 
no_þu¡”_b™m­
;

2071 ià(
’Œy
->
off£t
 =ð
	`off£t_to_b™m­
(
ùl
, offset)) {

2072 
by‹s_added
 = 
	`add_by‹s_to_b™m­
(
ùl
, 
’Œy
,

2073 
off£t
, 
by‹s
);

2074 
by‹s
 -ð
by‹s_added
;

2075 
off£t
 +ð
by‹s_added
;

2077 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2078 ià(!
by‹s
) {

2079 
»t
 = 1;

2080 
out
;

2084 
no_þu¡”_b™m­
:

2085 
b™m­_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

2087 ià(!
b™m­_šfo
) {

2088 
	`ASSERT
(
added
 == 0);

2089 
Ãw_b™m­
;

2092 
by‹s_added
 = 
	`add_by‹s_to_b™m­
(
ùl
, 
b™m­_šfo
, 
off£t
, 
by‹s
);

2093 
by‹s
 -ð
by‹s_added
;

2094 
off£t
 +ð
by‹s_added
;

2095 
added
 = 0;

2097 ià(!
by‹s
) {

2098 
»t
 = 1;

2099 
out
;

2101 
agaš
;

2103 
Ãw_b™m­
:

2104 ià(
šfo
 && info->
b™m­
) {

2105 
	`add_Ãw_b™m­
(
ùl
, 
šfo
, 
off£t
);

2106 
added
 = 1;

2107 
šfo
 = 
NULL
;

2108 
agaš
;

2110 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2113 ià(!
šfo
) {

2114 
šfo
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
,

2115 
GFP_NOFS
);

2116 ià(!
šfo
) {

2117 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2118 
»t
 = -
ENOMEM
;

2119 
out
;

2124 
šfo
->
b™m­
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_NOFS
);

2125 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2126 ià(!
šfo
->
b™m­
) {

2127 
»t
 = -
ENOMEM
;

2128 
out
;

2130 
agaš
;

2133 
out
:

2134 ià(
šfo
) {

2135 ià(
šfo
->
b™m­
)

2136 
	`kä“
(
šfo
->
b™m­
);

2137 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2140  
»t
;

2141 
	}
}

2143 
boÞ
 
	$Œy_m”ge_ä“_¥aû
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2144 
bŒfs_ä“_¥aû
 *
šfo
, 
boÞ
 
upd©e_¡©
)

2146 
bŒfs_ä“_¥aû
 *
Ëá_šfo
;

2147 
bŒfs_ä“_¥aû
 *
right_šfo
;

2148 
boÞ
 
m”ged
 = 
çl£
;

2149 
u64
 
off£t
 = 
šfo
->offset;

2150 
u64
 
by‹s
 = 
šfo
->bytes;

2157 
right_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
 + 
by‹s
, 0, 0);

2158 ià(
right_šfo
 && 
	`rb_´ev
(&right_šfo->
off£t_šdex
))

2159 
Ëá_šfo
 = 
	`rb_’Œy
(
	`rb_´ev
(&
right_šfo
->
off£t_šdex
),

2160 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2162 
Ëá_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
 - 1, 0, 0);

2164 ià(
right_šfo
 && !right_šfo->
b™m­
) {

2165 ià(
upd©e_¡©
)

2166 
	`uÆšk_ä“_¥aû
(
ùl
, 
right_šfo
);

2168 
	`__uÆšk_ä“_¥aû
(
ùl
, 
right_šfo
);

2169 
šfo
->
by‹s
 +ð
right_šfo
->bytes;

2170 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
right_šfo
);

2171 
m”ged
 = 
Œue
;

2174 ià(
Ëá_šfo
 && !Ëá_šfo->
b™m­
 &&

2175 
Ëá_šfo
->
off£t
 +†eá_šfo->
by‹s
 == offset) {

2176 ià(
upd©e_¡©
)

2177 
	`uÆšk_ä“_¥aû
(
ùl
, 
Ëá_šfo
);

2179 
	`__uÆšk_ä“_¥aû
(
ùl
, 
Ëá_šfo
);

2180 
šfo
->
off£t
 = 
Ëá_šfo
->offset;

2181 
šfo
->
by‹s
 +ð
Ëá_šfo
->bytes;

2182 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
Ëá_šfo
);

2183 
m”ged
 = 
Œue
;

2186  
m”ged
;

2187 
	}
}

2189 
boÞ
 
	$¡—l_äom_b™m­_to_’d
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2190 
bŒfs_ä“_¥aû
 *
šfo
,

2191 
boÞ
 
upd©e_¡©
)

2193 
bŒfs_ä“_¥aû
 *
b™m­
;

2194 
i
;

2195 
j
;

2196 cÚ¡ 
u64
 
’d
 = 
šfo
->
off£t
 + info->
by‹s
;

2197 cÚ¡ 
u64
 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
’d
);

2198 
u64
 
by‹s
;

2200 
b™m­
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
b™m­_off£t
, 1, 0);

2201 ià(!
b™m­
)

2202  
çl£
;

2204 
i
 = 
	`off£t_to_b™
(
b™m­
->
off£t
, 
ùl
->
un™
, 
’d
);

2205 
j
 = 
	`fšd_Ãxt_z”o_b™
(
b™m­
->b™m­, 
BITS_PER_BITMAP
, 
i
);

2206 ià(
j
 =ð
i
)

2207  
çl£
;

2208 
by‹s
 = (
j
 - 
i
è* 
ùl
->
un™
;

2209 
šfo
->
by‹s
 += bytes;

2211 ià(
upd©e_¡©
)

2212 
	`b™m­_þ—r_b™s
(
ùl
, 
b™m­
, 
’d
, 
by‹s
);

2214 
	`__b™m­_þ—r_b™s
(
ùl
, 
b™m­
, 
’d
, 
by‹s
);

2216 ià(!
b™m­
->
by‹s
)

2217 
	`ä“_b™m­
(
ùl
, 
b™m­
);

2219  
Œue
;

2220 
	}
}

2222 
boÞ
 
	$¡—l_äom_b™m­_to_äÚt
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2223 
bŒfs_ä“_¥aû
 *
šfo
,

2224 
boÞ
 
upd©e_¡©
)

2226 
bŒfs_ä“_¥aû
 *
b™m­
;

2227 
u64
 
b™m­_off£t
;

2228 
i
;

2229 
j
;

2230 
´ev_j
;

2231 
u64
 
by‹s
;

2233 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
šfo
->
off£t
);

2235 ià(
b™m­_off£t
 =ð
šfo
->
off£t
) {

2236 ià(
šfo
->
off£t
 == 0)

2237  
çl£
;

2238 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
šfo
->
off£t
 - 1);

2241 
b™m­
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
b™m­_off£t
, 1, 0);

2242 ià(!
b™m­
)

2243  
çl£
;

2245 
i
 = 
	`off£t_to_b™
(
b™m­
->
off£t
, 
ùl
->
un™
, 
šfo
->offset) - 1;

2246 
j
 = 0;

2247 
´ev_j
 = ()-1;

2248 
	`fÜ_—ch_þ—r_b™_äom
(
j
, 
b™m­
->b™m­, 
BITS_PER_BITMAP
) {

2249 ià(
j
 > 
i
)

2251 
´ev_j
 = 
j
;

2253 ià(
´ev_j
 =ð
i
)

2254  
çl£
;

2256 ià(
´ev_j
 == ()-1)

2257 
by‹s
 = (
i
 + 1è* 
ùl
->
un™
;

2259 
by‹s
 = (
i
 - 
´ev_j
è* 
ùl
->
un™
;

2261 
šfo
->
off£t
 -ð
by‹s
;

2262 
šfo
->
by‹s
 += bytes;

2264 ià(
upd©e_¡©
)

2265 
	`b™m­_þ—r_b™s
(
ùl
, 
b™m­
, 
šfo
->
off£t
, 
by‹s
);

2267 
	`__b™m­_þ—r_b™s
(
ùl
, 
b™m­
, 
šfo
->
off£t
, 
by‹s
);

2269 ià(!
b™m­
->
by‹s
)

2270 
	`ä“_b™m­
(
ùl
, 
b™m­
);

2272  
Œue
;

2273 
	}
}

2286 
	$¡—l_äom_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2287 
bŒfs_ä“_¥aû
 *
šfo
,

2288 
boÞ
 
upd©e_¡©
)

2294 
	`ASSERT
(!
šfo
->
b™m­
);

2295 
	`ASSERT
(
	`RB_EMPTY_NODE
(&
šfo
->
off£t_šdex
));

2297 ià(
ùl
->
tÙ®_b™m­s
 > 0) {

2298 
boÞ
 
¡Þe_’d
;

2299 
boÞ
 
¡Þe_äÚt
 = 
çl£
;

2301 
¡Þe_’d
 = 
	`¡—l_äom_b™m­_to_’d
(
ùl
, 
šfo
, 
upd©e_¡©
);

2302 ià(
ùl
->
tÙ®_b™m­s
 > 0)

2303 
¡Þe_äÚt
 = 
	`¡—l_äom_b™m­_to_äÚt
(
ùl
, 
šfo
,

2304 
upd©e_¡©
);

2306 ià(
¡Þe_’d
 || 
¡Þe_äÚt
)

2307 
	`Œy_m”ge_ä“_¥aû
(
ùl
, 
šfo
, 
upd©e_¡©
);

2309 
	}
}

2311 
	$__bŒfs_add_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

2312 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

2313 
u64
 
off£t
, u64 
by‹s
)

2315 
bŒfs_ä“_¥aû
 *
šfo
;

2316 
»t
 = 0;

2318 
šfo
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
, 
GFP_NOFS
);

2319 ià(!
šfo
)

2320  -
ENOMEM
;

2322 
šfo
->
off£t
 = offset;

2323 
šfo
->
by‹s
 = bytes;

2324 
	`RB_CLEAR_NODE
(&
šfo
->
off£t_šdex
);

2326 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2328 ià(
	`Œy_m”ge_ä“_¥aû
(
ùl
, 
šfo
, 
Œue
))

2329 
lšk
;

2336 
»t
 = 
	`š£¹_što_b™m­
(
ùl
, 
šfo
);

2337 ià(
»t
 < 0) {

2338 
out
;

2339 } ià(
»t
) {

2340 
»t
 = 0;

2341 
out
;

2343 
lšk
:

2350 
	`¡—l_äom_b™m­
(
ùl
, 
šfo
, 
Œue
);

2352 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2353 ià(
»t
)

2354 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2355 
out
:

2356 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2358 ià(
»t
) {

2359 
	`bŒfs_ü™
(
fs_šfo
, "uÇbËØadd f»¥aû :%d", 
»t
);

2360 
	`ASSERT
(
»t
 !ð-
EEXIST
);

2363  
»t
;

2364 
	}
}

2366 
	$bŒfs_»move_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

2367 
u64
 
off£t
, u64 
by‹s
)

2369 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2370 
bŒfs_ä“_¥aû
 *
šfo
;

2371 
»t
;

2372 
boÞ
 
»_£¬ch
 = 
çl£
;

2374 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2376 
agaš
:

2377 
»t
 = 0;

2378 ià(!
by‹s
)

2379 
out_lock
;

2381 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 0, 0);

2382 ià(!
šfo
) {

2387 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

2389 ià(!
šfo
) {

2395 
	`WARN_ON
(
»_£¬ch
);

2396 
out_lock
;

2400 
»_£¬ch
 = 
çl£
;

2401 ià(!
šfo
->
b™m­
) {

2402 
	`uÆšk_ä“_¥aû
(
ùl
, 
šfo
);

2403 ià(
off£t
 =ð
šfo
->offset) {

2404 
u64
 
to_ä“
 = 
	`mš
(
by‹s
, 
šfo
->bytes);

2406 
šfo
->
by‹s
 -ð
to_ä“
;

2407 
šfo
->
off£t
 +ð
to_ä“
;

2408 ià(
šfo
->
by‹s
) {

2409 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2410 
	`WARN_ON
(
»t
);

2412 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2415 
off£t
 +ð
to_ä“
;

2416 
by‹s
 -ð
to_ä“
;

2417 
agaš
;

2419 
u64
 
Þd_’d
 = 
šfo
->
by‹s
 + info->
off£t
;

2421 
šfo
->
by‹s
 = 
off£t
 - info->offset;

2422 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

2423 
	`WARN_ON
(
»t
);

2424 ià(
»t
)

2425 
out_lock
;

2428 ià(
Þd_’d
 < 
off£t
 + 
by‹s
) {

2429 
by‹s
 -ð
Þd_’d
 - 
off£t
;

2430 
off£t
 = 
Þd_’d
;

2431 
agaš
;

2432 } ià(
Þd_’d
 =ð
off£t
 + 
by‹s
) {

2434 
out_lock
;

2436 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2438 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
off£t
 + 
by‹s
,

2439 
Þd_’d
 - (
off£t
 + 
by‹s
));

2440 
	`WARN_ON
(
»t
);

2441 
out
;

2445 
»t
 = 
	`»move_äom_b™m­
(
ùl
, 
šfo
, &
off£t
, &
by‹s
);

2446 ià(
»t
 =ð-
EAGAIN
) {

2447 
»_£¬ch
 = 
Œue
;

2448 
agaš
;

2450 
out_lock
:

2451 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2452 
out
:

2453  
»t
;

2454 
	}
}

2456 
	$bŒfs_dump_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

2457 
u64
 
by‹s
)

2459 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2460 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2461 
bŒfs_ä“_¥aû
 *
šfo
;

2462 
rb_node
 *
n
;

2463 
couÁ
 = 0;

2465 
n
 = 
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
);‚;‚ = 
	`rb_Ãxt
(n)) {

2466 
šfo
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2467 ià(
šfo
->
by‹s
 >ðby‹ && !
block_group
->
ro
)

2468 
couÁ
++;

2469 
	`bŒfs_ü™
(
fs_šfo
, "entry offset %llu, bytes %llu, bitmap %s",

2470 
šfo
->
off£t
, info->
by‹s
,

2471 (
šfo
->
b™m­
) ? "yes" : "no");

2473 
	`bŒfs_šfo
(
fs_šfo
, "block group has cluster?: %s",

2474 
	`li¡_em±y
(&
block_group
->
þu¡”_li¡
) ? "no" : "yes");

2475 
	`bŒfs_šfo
(
fs_šfo
,

2476 "%d block oàä“ s·û‡ˆÜ bigg”hª by‹ is", 
couÁ
);

2477 
	}
}

2479 
	$bŒfs_š™_ä“_¥aû_ùl
(
bŒfs_block_group_ÿche
 *
block_group
)

2481 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

2482 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2484 
	`¥š_lock_š™
(&
ùl
->
Œ“_lock
);

2485 
ùl
->
un™
 = 
fs_šfo
->
£ùÜsize
;

2486 
ùl
->
¡¬t
 = 
block_group
->
key
.
objeùid
;

2487 
ùl
->
´iv©e
 = 
block_group
;

2488 
ùl
->
Ý
 = &
ä“_¥aû_Ý
;

2489 
	`INIT_LIST_HEAD
(&
ùl
->
Œimmšg_¿nges
);

2490 
	`mu‹x_š™
(&
ùl
->
ÿche_wr™eout_mu‹x
);

2497 
ùl
->
ex‹Ás_th»sh
 = (
SZ_32K
 / 2è/ (
bŒfs_ä“_¥aû
);

2498 
	}
}

2507 
	$__bŒfs_»tuº_þu¡”_to_ä“_¥aû
(

2508 
bŒfs_block_group_ÿche
 *
block_group
,

2509 
bŒfs_ä“_þu¡”
 *
þu¡”
)

2511 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2512 
bŒfs_ä“_¥aû
 *
’Œy
;

2513 
rb_node
 *
node
;

2515 
	`¥š_lock
(&
þu¡”
->
lock
);

2516 ià(
þu¡”
->
block_group
 != block_group)

2517 
out
;

2519 
þu¡”
->
block_group
 = 
NULL
;

2520 
þu¡”
->
wšdow_¡¬t
 = 0;

2521 
	`li¡_d–_š™
(&
þu¡”
->
block_group_li¡
);

2523 
node
 = 
	`rb_fœ¡
(&
þu¡”
->
roÙ
);

2524 
node
) {

2525 
boÞ
 
b™m­
;

2527 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2528 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

2529 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
þu¡”
->
roÙ
);

2530 
	`RB_CLEAR_NODE
(&
’Œy
->
off£t_šdex
);

2532 
b™m­
 = (
’Œy
->b™m­ !ð
NULL
);

2533 ià(!
b™m­
) {

2534 
	`Œy_m”ge_ä“_¥aû
(
ùl
, 
’Œy
, 
çl£
);

2535 
	`¡—l_äom_b™m­
(
ùl
, 
’Œy
, 
çl£
);

2537 
	`Œ“_š£¹_off£t
(&
ùl
->
ä“_¥aû_off£t
,

2538 
’Œy
->
off£t
, &’Œy->
off£t_šdex
, 
b™m­
);

2540 
þu¡”
->
roÙ
 = 
RB_ROOT
;

2542 
out
:

2543 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2544 
	`bŒfs_put_block_group
(
block_group
);

2546 
	}
}

2548 
	$__bŒfs_»move_ä“_¥aû_ÿche_locked
(

2549 
bŒfs_ä“_¥aû_ùl
 *
ùl
)

2551 
bŒfs_ä“_¥aû
 *
šfo
;

2552 
rb_node
 *
node
;

2554 (
node
 = 
	`rb_Ï¡
(&
ùl
->
ä“_¥aû_off£t
)è!ð
NULL
) {

2555 
šfo
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2556 ià(!
šfo
->
b™m­
) {

2557 
	`uÆšk_ä“_¥aû
(
ùl
, 
šfo
);

2558 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

2560 
	`ä“_b™m­
(
ùl
, 
šfo
);

2563 
	`cÚd_»sched_lock
(&
ùl
->
Œ“_lock
);

2565 
	}
}

2567 
	$__bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

2569 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2570 
	`__bŒfs_»move_ä“_¥aû_ÿche_locked
(
ùl
);

2571 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2572 
	}
}

2574 
	$bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_block_group_ÿche
 *
block_group
)

2576 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2577 
bŒfs_ä“_þu¡”
 *
þu¡”
;

2578 
li¡_h—d
 *
h—d
;

2580 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2581 (
h—d
 = 
block_group
->
þu¡”_li¡
.
Ãxt
) !=

2582 &
block_group
->
þu¡”_li¡
) {

2583 
þu¡”
 = 
	`li¡_’Œy
(
h—d
, 
bŒfs_ä“_þu¡”
,

2584 
block_group_li¡
);

2586 
	`WARN_ON
(
þu¡”
->
block_group
 != block_group);

2587 
	`__bŒfs_»tuº_þu¡”_to_ä“_¥aû
(
block_group
, 
þu¡”
);

2589 
	`cÚd_»sched_lock
(&
ùl
->
Œ“_lock
);

2591 
	`__bŒfs_»move_ä“_¥aû_ÿche_locked
(
ùl
);

2592 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2594 
	}
}

2596 
u64
 
	$bŒfs_fšd_¥aû_fÜ_®loc
(
bŒfs_block_group_ÿche
 *
block_group
,

2597 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
,

2598 
u64
 *
max_ex‹Á_size
)

2600 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2601 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

2602 
u64
 
by‹s_£¬ch
 = 
by‹s
 + 
em±y_size
;

2603 
u64
 
»t
 = 0;

2604 
u64
 
®ign_g­
 = 0;

2605 
u64
 
®ign_g­_Ën
 = 0;

2607 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2608 
’Œy
 = 
	`fšd_ä“_¥aû
(
ùl
, &
off£t
, &
by‹s_£¬ch
,

2609 
block_group
->
fuÎ_¡re_Ën
, 
max_ex‹Á_size
);

2610 ià(!
’Œy
)

2611 
out
;

2613 
»t
 = 
off£t
;

2614 ià(
’Œy
->
b™m­
) {

2615 
	`b™m­_þ—r_b™s
(
ùl
, 
’Œy
, 
off£t
, 
by‹s
);

2616 ià(!
’Œy
->
by‹s
)

2617 
	`ä“_b™m­
(
ùl
, 
’Œy
);

2619 
	`uÆšk_ä“_¥aû
(
ùl
, 
’Œy
);

2620 
®ign_g­_Ën
 = 
off£t
 - 
’Œy
->offset;

2621 
®ign_g­
 = 
’Œy
->
off£t
;

2623 
’Œy
->
off£t
 = off£ˆ+ 
by‹s
;

2624 
	`WARN_ON
(
’Œy
->
by‹s
 < by‹ + 
®ign_g­_Ën
);

2626 
’Œy
->
by‹s
 -ðby‹ + 
®ign_g­_Ën
;

2627 ià(!
’Œy
->
by‹s
)

2628 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

2630 
	`lšk_ä“_¥aû
(
ùl
, 
’Œy
);

2632 
out
:

2633 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2635 ià(
®ign_g­_Ën
)

2636 
	`__bŒfs_add_ä“_¥aû
(
block_group
->
fs_šfo
, 
ùl
,

2637 
®ign_g­
, 
®ign_g­_Ën
);

2638  
»t
;

2639 
	}
}

2649 
	$bŒfs_»tuº_þu¡”_to_ä“_¥aû
(

2650 
bŒfs_block_group_ÿche
 *
block_group
,

2651 
bŒfs_ä“_þu¡”
 *
þu¡”
)

2653 
bŒfs_ä“_¥aû_ùl
 *
ùl
;

2654 
»t
;

2657 
	`¥š_lock
(&
þu¡”
->
lock
);

2658 ià(!
block_group
) {

2659 
block_group
 = 
þu¡”
->block_group;

2660 ià(!
block_group
) {

2661 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2664 } ià(
þu¡”
->
block_group
 != block_group) {

2666 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2669 
	`©omic_šc
(&
block_group
->
couÁ
);

2670 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2672 
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2675 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2676 
»t
 = 
	`__bŒfs_»tuº_þu¡”_to_ä“_¥aû
(
block_group
, 
þu¡”
);

2677 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2680 
	`bŒfs_put_block_group
(
block_group
);

2681  
»t
;

2682 
	}
}

2684 
u64
 
	$bŒfs_®loc_äom_b™m­
(
bŒfs_block_group_ÿche
 *
block_group
,

2685 
bŒfs_ä“_þu¡”
 *
þu¡”
,

2686 
bŒfs_ä“_¥aû
 *
’Œy
,

2687 
u64
 
by‹s
, u64 
mš_¡¬t
,

2688 
u64
 *
max_ex‹Á_size
)

2690 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2691 
”r
;

2692 
u64
 
£¬ch_¡¬t
 = 
þu¡”
->
wšdow_¡¬t
;

2693 
u64
 
£¬ch_by‹s
 = 
by‹s
;

2694 
u64
 
»t
 = 0;

2696 
£¬ch_¡¬t
 = 
mš_¡¬t
;

2697 
£¬ch_by‹s
 = 
by‹s
;

2699 
”r
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
£¬ch_¡¬t
, &
£¬ch_by‹s
, 
Œue
);

2700 ià(
”r
) {

2701 ià(
£¬ch_by‹s
 > *
max_ex‹Á_size
)

2702 *
max_ex‹Á_size
 = 
£¬ch_by‹s
;

2706 
»t
 = 
£¬ch_¡¬t
;

2707 
	`__b™m­_þ—r_b™s
(
ùl
, 
’Œy
, 
»t
, 
by‹s
);

2709  
»t
;

2710 
	}
}

2717 
u64
 
	$bŒfs_®loc_äom_þu¡”
(
bŒfs_block_group_ÿche
 *
block_group
,

2718 
bŒfs_ä“_þu¡”
 *
þu¡”
, 
u64
 
by‹s
,

2719 
u64
 
mš_¡¬t
, u64 *
max_ex‹Á_size
)

2721 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2722 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

2723 
rb_node
 *
node
;

2724 
u64
 
»t
 = 0;

2726 
	`¥š_lock
(&
þu¡”
->
lock
);

2727 ià(
by‹s
 > 
þu¡”
->
max_size
)

2728 
out
;

2730 ià(
þu¡”
->
block_group
 != block_group)

2731 
out
;

2733 
node
 = 
	`rb_fœ¡
(&
þu¡”
->
roÙ
);

2734 ià(!
node
)

2735 
out
;

2737 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2739 ià(
’Œy
->
by‹s
 < by‹ &&ƒÁry->by‹ > *
max_ex‹Á_size
)

2740 *
max_ex‹Á_size
 = 
’Œy
->
by‹s
;

2742 ià(
’Œy
->
by‹s
 < bytes ||

2743 (!
’Œy
->
b™m­
 &&ƒÁry->
off£t
 < 
mš_¡¬t
)) {

2744 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

2745 ià(!
node
)

2747 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

2748 
off£t_šdex
);

2752 ià(
’Œy
->
b™m­
) {

2753 
»t
 = 
	`bŒfs_®loc_äom_b™m­
(
block_group
,

2754 
þu¡”
, 
’Œy
, 
by‹s
,

2755 
þu¡”
->
wšdow_¡¬t
,

2756 
max_ex‹Á_size
);

2757 ià(
»t
 == 0) {

2758 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

2759 ià(!
node
)

2761 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

2762 
off£t_šdex
);

2765 
þu¡”
->
wšdow_¡¬t
 +ð
by‹s
;

2767 
»t
 = 
’Œy
->
off£t
;

2769 
’Œy
->
off£t
 +ð
by‹s
;

2770 
’Œy
->
by‹s
 -= bytes;

2773 ià(
’Œy
->
by‹s
 == 0)

2774 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
þu¡”
->
roÙ
);

2777 
out
:

2778 
	`¥š_uÆock
(&
þu¡”
->
lock
);

2780 ià(!
»t
)

2783 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

2785 
ùl
->
ä“_¥aû
 -ð
by‹s
;

2786 ià(
’Œy
->
by‹s
 == 0) {

2787 
ùl
->
ä“_ex‹Ás
--;

2788 ià(
’Œy
->
b™m­
) {

2789 
	`kä“
(
’Œy
->
b™m­
);

2790 
ùl
->
tÙ®_b™m­s
--;

2791 
ùl
->
Ý
->
	`»ÿlc_th»shÞds
(ctl);

2793 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

2796 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

2798  
»t
;

2799 
	}
}

2801 
	$bŒfs_b™m­_þu¡”
(
bŒfs_block_group_ÿche
 *
block_group
,

2802 
bŒfs_ä“_¥aû
 *
’Œy
,

2803 
bŒfs_ä“_þu¡”
 *
þu¡”
,

2804 
u64
 
off£t
, u64 
by‹s
,

2805 
u64
 
cÚt1_by‹s
, u64 
mš_by‹s
)

2807 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2808 
Ãxt_z”o
;

2809 
i
;

2810 
wªt_b™s
;

2811 
mš_b™s
;

2812 
found_b™s
;

2813 
max_b™s
 = 0;

2814 
¡¬t
 = 0;

2815 
tÙ®_found
 = 0;

2816 
»t
;

2818 
i
 = 
	`off£t_to_b™
(
’Œy
->
off£t
, 
ùl
->
un™
,

2819 
	`max_t
(
u64
, 
off£t
, 
’Œy
->offset));

2820 
wªt_b™s
 = 
	`by‹s_to_b™s
(
by‹s
, 
ùl
->
un™
);

2821 
mš_b™s
 = 
	`by‹s_to_b™s
(
mš_by‹s
, 
ùl
->
un™
);

2827 ià(
’Œy
->
max_ex‹Á_size
 &&

2828 
’Œy
->
max_ex‹Á_size
 < 
cÚt1_by‹s
)

2829  -
ENOSPC
;

2830 
agaš
:

2831 
found_b™s
 = 0;

2832 
	`fÜ_—ch_£t_b™_äom
(
i
, 
’Œy
->
b™m­
, 
BITS_PER_BITMAP
) {

2833 
Ãxt_z”o
 = 
	`fšd_Ãxt_z”o_b™
(
’Œy
->
b™m­
,

2834 
BITS_PER_BITMAP
, 
i
);

2835 ià(
Ãxt_z”o
 - 
i
 >ð
mš_b™s
) {

2836 
found_b™s
 = 
Ãxt_z”o
 - 
i
;

2837 ià(
found_b™s
 > 
max_b™s
)

2838 
max_b™s
 = 
found_b™s
;

2841 ià(
Ãxt_z”o
 - 
i
 > 
max_b™s
)

2842 
max_b™s
 = 
Ãxt_z”o
 - 
i
;

2843 
i
 = 
Ãxt_z”o
;

2846 ià(!
found_b™s
) {

2847 
’Œy
->
max_ex‹Á_size
 = (
u64
)
max_b™s
 * 
ùl
->
un™
;

2848  -
ENOSPC
;

2851 ià(!
tÙ®_found
) {

2852 
¡¬t
 = 
i
;

2853 
þu¡”
->
max_size
 = 0;

2856 
tÙ®_found
 +ð
found_b™s
;

2858 ià(
þu¡”
->
max_size
 < 
found_b™s
 * 
ùl
->
un™
)

2859 
þu¡”
->
max_size
 = 
found_b™s
 * 
ùl
->
un™
;

2861 ià(
tÙ®_found
 < 
wªt_b™s
 || 
þu¡”
->
max_size
 < 
cÚt1_by‹s
) {

2862 
i
 = 
Ãxt_z”o
 + 1;

2863 
agaš
;

2866 
þu¡”
->
wšdow_¡¬t
 = 
¡¬t
 * 
ùl
->
un™
 + 
’Œy
->
off£t
;

2867 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
ùl
->
ä“_¥aû_off£t
);

2868 
»t
 = 
	`Œ“_š£¹_off£t
(&
þu¡”
->
roÙ
, 
’Œy
->
off£t
,

2869 &
’Œy
->
off£t_šdex
, 1);

2870 
	`ASSERT
(!
»t
);

2872 
	`Œaû_bŒfs_£tup_þu¡”
(
block_group
, 
þu¡”
,

2873 
tÙ®_found
 * 
ùl
->
un™
, 1);

2875 
	}
}

2882 
nošlše
 

2883 
	$£tup_þu¡”_no_b™m­
(
bŒfs_block_group_ÿche
 *
block_group
,

2884 
bŒfs_ä“_þu¡”
 *
þu¡”
,

2885 
li¡_h—d
 *
b™m­s
, 
u64
 
off£t
, u64 
by‹s
,

2886 
u64
 
cÚt1_by‹s
, u64 
mš_by‹s
)

2888 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2889 
bŒfs_ä“_¥aû
 *
fœ¡
 = 
NULL
;

2890 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

2891 
bŒfs_ä“_¥aû
 *
Ï¡
;

2892 
rb_node
 *
node
;

2893 
u64
 
wšdow_ä“
;

2894 
u64
 
max_ex‹Á
;

2895 
u64
 
tÙ®_size
 = 0;

2897 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 0, 1);

2898 ià(!
’Œy
)

2899  -
ENOSPC
;

2905 
’Œy
->
b™m­
 ||ƒÁry->
by‹s
 < 
mš_by‹s
) {

2906 ià(
’Œy
->
b™m­
 && 
	`li¡_em±y
(&’Œy->
li¡
))

2907 
	`li¡_add_ž
(&
’Œy
->
li¡
, 
b™m­s
);

2908 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

2909 ià(!
node
)

2910  -
ENOSPC
;

2911 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2914 
wšdow_ä“
 = 
’Œy
->
by‹s
;

2915 
max_ex‹Á
 = 
’Œy
->
by‹s
;

2916 
fœ¡
 = 
’Œy
;

2917 
Ï¡
 = 
’Œy
;

2919 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);‚ode;

2920 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
)) {

2921 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2923 ià(
’Œy
->
b™m­
) {

2924 ià(
	`li¡_em±y
(&
’Œy
->
li¡
))

2925 
	`li¡_add_ž
(&
’Œy
->
li¡
, 
b™m­s
);

2929 ià(
’Œy
->
by‹s
 < 
mš_by‹s
)

2932 
Ï¡
 = 
’Œy
;

2933 
wšdow_ä“
 +ð
’Œy
->
by‹s
;

2934 ià(
’Œy
->
by‹s
 > 
max_ex‹Á
)

2935 
max_ex‹Á
 = 
’Œy
->
by‹s
;

2938 ià(
wšdow_ä“
 < 
by‹s
 || 
max_ex‹Á
 < 
cÚt1_by‹s
)

2939  -
ENOSPC
;

2941 
þu¡”
->
wšdow_¡¬t
 = 
fœ¡
->
off£t
;

2943 
node
 = &
fœ¡
->
off£t_šdex
;

2950 
»t
;

2952 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

2953 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

2954 ià(
’Œy
->
b™m­
 ||ƒÁry->
by‹s
 < 
mš_by‹s
)

2957 
	`rb_”a£
(&
’Œy
->
off£t_šdex
, &
ùl
->
ä“_¥aû_off£t
);

2958 
»t
 = 
	`Œ“_š£¹_off£t
(&
þu¡”
->
roÙ
, 
’Œy
->
off£t
,

2959 &
’Œy
->
off£t_šdex
, 0);

2960 
tÙ®_size
 +ð
’Œy
->
by‹s
;

2961 
	`ASSERT
(!
»t
);

2962 } 
node
 && 
’Œy
 !ð
Ï¡
);

2964 
þu¡”
->
max_size
 = 
max_ex‹Á
;

2965 
	`Œaû_bŒfs_£tup_þu¡”
(
block_group
, 
þu¡”
, 
tÙ®_size
, 0);

2967 
	}
}

2973 
nošlše
 

2974 
	$£tup_þu¡”_b™m­
(
bŒfs_block_group_ÿche
 *
block_group
,

2975 
bŒfs_ä“_þu¡”
 *
þu¡”
,

2976 
li¡_h—d
 *
b™m­s
, 
u64
 
off£t
, u64 
by‹s
,

2977 
u64
 
cÚt1_by‹s
, u64 
mš_by‹s
)

2979 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

2980 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

2981 
»t
 = -
ENOSPC
;

2982 
u64
 
b™m­_off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
off£t
);

2984 ià(
ùl
->
tÙ®_b™m­s
 == 0)

2985  -
ENOSPC
;

2991 ià(!
	`li¡_em±y
(
b™m­s
))

2992 
’Œy
 = 
	`li¡_fœ¡_’Œy
(
b™m­s
, 
bŒfs_ä“_¥aû
, 
li¡
);

2994 ià(!
’Œy
 ||ƒÁry->
off£t
 !ð
b™m­_off£t
) {

2995 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
b™m­_off£t
, 1, 0);

2996 ià(
’Œy
 && 
	`li¡_em±y
(&’Œy->
li¡
))

2997 
	`li¡_add
(&
’Œy
->
li¡
, 
b™m­s
);

3000 
	`li¡_fÜ_—ch_’Œy
(
’Œy
, 
b™m­s
, 
li¡
) {

3001 ià(
’Œy
->
by‹s
 < bytes)

3003 
»t
 = 
	`bŒfs_b™m­_þu¡”
(
block_group
, 
’Œy
, 
þu¡”
, 
off£t
,

3004 
by‹s
, 
cÚt1_by‹s
, 
mš_by‹s
);

3005 ià(!
»t
)

3013  -
ENOSPC
;

3014 
	}
}

3024 
	$bŒfs_fšd_¥aû_þu¡”
(
bŒfs_fs_šfo
 *
fs_šfo
,

3025 
bŒfs_block_group_ÿche
 *
block_group
,

3026 
bŒfs_ä“_þu¡”
 *
þu¡”
,

3027 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
)

3029 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3030 
bŒfs_ä“_¥aû
 *
’Œy
, *
tmp
;

3031 
	`LIST_HEAD
(
b™m­s
);

3032 
u64
 
mš_by‹s
;

3033 
u64
 
cÚt1_by‹s
;

3034 
»t
;

3042 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SSD_SPREAD
)) {

3043 
cÚt1_by‹s
 = 
mš_by‹s
 = 
by‹s
 + 
em±y_size
;

3044 } ià(
block_group
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

3045 
cÚt1_by‹s
 = 
by‹s
;

3046 
mš_by‹s
 = 
fs_šfo
->
£ùÜsize
;

3048 
cÚt1_by‹s
 = 
	`max
(
by‹s
, (by‹ + 
em±y_size
) >> 2);

3049 
mš_by‹s
 = 
fs_šfo
->
£ùÜsize
;

3052 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3058 ià(
ùl
->
ä“_¥aû
 < 
by‹s
) {

3059 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3060  -
ENOSPC
;

3063 
	`¥š_lock
(&
þu¡”
->
lock
);

3066 ià(
þu¡”
->
block_group
) {

3067 
»t
 = 0;

3068 
out
;

3071 
	`Œaû_bŒfs_fšd_þu¡”
(
block_group
, 
off£t
, 
by‹s
, 
em±y_size
,

3072 
mš_by‹s
);

3074 
»t
 = 
	`£tup_þu¡”_no_b™m­
(
block_group
, 
þu¡”
, &
b™m­s
, 
off£t
,

3075 
by‹s
 + 
em±y_size
,

3076 
cÚt1_by‹s
, 
mš_by‹s
);

3077 ià(
»t
)

3078 
»t
 = 
	`£tup_þu¡”_b™m­
(
block_group
, 
þu¡”
, &
b™m­s
,

3079 
off£t
, 
by‹s
 + 
em±y_size
,

3080 
cÚt1_by‹s
, 
mš_by‹s
);

3083 
	`li¡_fÜ_—ch_’Œy_§ã
(
’Œy
, 
tmp
, &
b™m­s
, 
li¡
)

3084 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

3086 ià(!
»t
) {

3087 
	`©omic_šc
(&
block_group
->
couÁ
);

3088 
	`li¡_add_ž
(&
þu¡”
->
block_group_li¡
,

3089 &
block_group
->
þu¡”_li¡
);

3090 
þu¡”
->
block_group
 = block_group;

3092 
	`Œaû_bŒfs_çžed_þu¡”_£tup
(
block_group
);

3094 
out
:

3095 
	`¥š_uÆock
(&
þu¡”
->
lock
);

3096 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3098  
»t
;

3099 
	}
}

3104 
	$bŒfs_š™_ä“_þu¡”
(
bŒfs_ä“_þu¡”
 *
þu¡”
)

3106 
	`¥š_lock_š™
(&
þu¡”
->
lock
);

3107 
	`¥š_lock_š™
(&
þu¡”
->
»fžl_lock
);

3108 
þu¡”
->
roÙ
 = 
RB_ROOT
;

3109 
þu¡”
->
max_size
 = 0;

3110 
þu¡”
->
äagm’‹d
 = 
çl£
;

3111 
	`INIT_LIST_HEAD
(&
þu¡”
->
block_group_li¡
);

3112 
þu¡”
->
block_group
 = 
NULL
;

3113 
	}
}

3115 
	$do_Œimmšg
(
bŒfs_block_group_ÿche
 *
block_group
,

3116 
u64
 *
tÙ®_Œimmed
, u64 
¡¬t
, u64 
by‹s
,

3117 
u64
 
»£rved_¡¬t
, u64 
»£rved_by‹s
,

3118 
bŒfs_Œim_¿nge
 *
Œim_’Œy
)

3120 
bŒfs_¥aû_šfo
 *
¥aû_šfo
 = 
block_group
->space_info;

3121 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3122 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3123 
»t
;

3124 
upd©e
 = 0;

3125 
u64
 
Œimmed
 = 0;

3127 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3128 
	`¥š_lock
(&
block_group
->
lock
);

3129 ià(!
block_group
->
ro
) {

3130 
block_group
->
»£rved
 +ð
»£rved_by‹s
;

3131 
¥aû_šfo
->
by‹s_»£rved
 +ð
»£rved_by‹s
;

3132 
upd©e
 = 1;

3134 
	`¥š_uÆock
(&
block_group
->
lock
);

3135 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3137 
»t
 = 
	`bŒfs_disÿrd_ex‹Á
(
fs_šfo
, 
¡¬t
, 
by‹s
, &
Œimmed
);

3138 ià(!
»t
)

3139 *
tÙ®_Œimmed
 +ð
Œimmed
;

3141 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3142 
	`bŒfs_add_ä“_¥aû
(
block_group
, 
»£rved_¡¬t
, 
»£rved_by‹s
);

3143 
	`li¡_d–
(&
Œim_’Œy
->
li¡
);

3144 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3146 ià(
upd©e
) {

3147 
	`¥š_lock
(&
¥aû_šfo
->
lock
);

3148 
	`¥š_lock
(&
block_group
->
lock
);

3149 ià(
block_group
->
ro
)

3150 
¥aû_šfo
->
by‹s_»adÚly
 +ð
»£rved_by‹s
;

3151 
block_group
->
»£rved
 -ð
»£rved_by‹s
;

3152 
¥aû_šfo
->
by‹s_»£rved
 -ð
»£rved_by‹s
;

3153 
	`¥š_uÆock
(&
¥aû_šfo
->
lock
);

3154 
	`¥š_uÆock
(&
block_group
->
lock
);

3157  
»t
;

3158 
	}
}

3160 
	$Œim_no_b™m­
(
bŒfs_block_group_ÿche
 *
block_group
,

3161 
u64
 *
tÙ®_Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
)

3163 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3164 
bŒfs_ä“_¥aû
 *
’Œy
;

3165 
rb_node
 *
node
;

3166 
»t
 = 0;

3167 
u64
 
ex‹Á_¡¬t
;

3168 
u64
 
ex‹Á_by‹s
;

3169 
u64
 
by‹s
;

3171 
¡¬t
 < 
’d
) {

3172 
bŒfs_Œim_¿nge
 
Œim_’Œy
;

3174 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3175 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3177 ià(
ùl
->
ä“_¥aû
 < 
mšËn
) {

3178 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3179 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3183 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
¡¬t
, 0, 1);

3184 ià(!
’Œy
) {

3185 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3186 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3191 
’Œy
->
b™m­
) {

3192 
node
 = 
	`rb_Ãxt
(&
’Œy
->
off£t_šdex
);

3193 ià(!
node
) {

3194 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3195 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3196 
out
;

3198 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_ä“_¥aû
,

3199 
off£t_šdex
);

3202 ià(
’Œy
->
off£t
 >ð
’d
) {

3203 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3204 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3208 
ex‹Á_¡¬t
 = 
’Œy
->
off£t
;

3209 
ex‹Á_by‹s
 = 
’Œy
->
by‹s
;

3210 
¡¬t
 = 
	`max
(¡¬t, 
ex‹Á_¡¬t
);

3211 
by‹s
 = 
	`mš
(
ex‹Á_¡¬t
 + 
ex‹Á_by‹s
, 
’d
è- 
¡¬t
;

3212 ià(
by‹s
 < 
mšËn
) {

3213 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3214 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3215 
Ãxt
;

3218 
	`uÆšk_ä“_¥aû
(
ùl
, 
’Œy
);

3219 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

3221 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3222 
Œim_’Œy
.
¡¬t
 = 
ex‹Á_¡¬t
;

3223 
Œim_’Œy
.
by‹s
 = 
ex‹Á_by‹s
;

3224 
	`li¡_add_ž
(&
Œim_’Œy
.
li¡
, &
ùl
->
Œimmšg_¿nges
);

3225 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3227 
»t
 = 
	`do_Œimmšg
(
block_group
, 
tÙ®_Œimmed
, 
¡¬t
, 
by‹s
,

3228 
ex‹Á_¡¬t
, 
ex‹Á_by‹s
, &
Œim_’Œy
);

3229 ià(
»t
)

3231 
Ãxt
:

3232 
¡¬t
 +ð
by‹s
;

3234 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3235 
»t
 = -
ERESTARTSYS
;

3239 
	`cÚd_»sched
();

3241 
out
:

3242  
»t
;

3243 
	}
}

3245 
	$Œim_b™m­s
(
bŒfs_block_group_ÿche
 *
block_group
,

3246 
u64
 *
tÙ®_Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
)

3248 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
block_group
->
ä“_¥aû_ùl
;

3249 
bŒfs_ä“_¥aû
 *
’Œy
;

3250 
»t
 = 0;

3251 
»t2
;

3252 
u64
 
by‹s
;

3253 
u64
 
off£t
 = 
	`off£t_to_b™m­
(
ùl
, 
¡¬t
);

3255 
off£t
 < 
’d
) {

3256 
boÞ
 
Ãxt_b™m­
 = 
çl£
;

3257 
bŒfs_Œim_¿nge
 
Œim_’Œy
;

3259 
	`mu‹x_lock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3260 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3262 ià(
ùl
->
ä“_¥aû
 < 
mšËn
) {

3263 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3264 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3268 
’Œy
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 1, 0);

3269 ià(!
’Œy
) {

3270 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3271 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3272 
Ãxt_b™m­
 = 
Œue
;

3273 
Ãxt
;

3276 
by‹s
 = 
mšËn
;

3277 
»t2
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
¡¬t
, &
by‹s
, 
çl£
);

3278 ià(
»t2
 || 
¡¬t
 >ð
’d
) {

3279 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3280 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3281 
Ãxt_b™m­
 = 
Œue
;

3282 
Ãxt
;

3285 
by‹s
 = 
	`mš
(by‹s, 
’d
 - 
¡¬t
);

3286 ià(
by‹s
 < 
mšËn
) {

3287 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3288 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3289 
Ãxt
;

3292 
	`b™m­_þ—r_b™s
(
ùl
, 
’Œy
, 
¡¬t
, 
by‹s
);

3293 ià(
’Œy
->
by‹s
 == 0)

3294 
	`ä“_b™m­
(
ùl
, 
’Œy
);

3296 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3297 
Œim_’Œy
.
¡¬t
 = start;

3298 
Œim_’Œy
.
by‹s
 = bytes;

3299 
	`li¡_add_ž
(&
Œim_’Œy
.
li¡
, &
ùl
->
Œimmšg_¿nges
);

3300 
	`mu‹x_uÆock
(&
ùl
->
ÿche_wr™eout_mu‹x
);

3302 
»t
 = 
	`do_Œimmšg
(
block_group
, 
tÙ®_Œimmed
, 
¡¬t
, 
by‹s
,

3303 
¡¬t
, 
by‹s
, &
Œim_’Œy
);

3304 ià(
»t
)

3306 
Ãxt
:

3307 ià(
Ãxt_b™m­
) {

3308 
off£t
 +ð
BITS_PER_BITMAP
 * 
ùl
->
un™
;

3310 
¡¬t
 +ð
by‹s
;

3311 ià(
¡¬t
 >ð
off£t
 + 
BITS_PER_BITMAP
 * 
ùl
->
un™
)

3312 
off£t
 +ð
BITS_PER_BITMAP
 * 
ùl
->
un™
;

3315 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3316 
»t
 = -
ERESTARTSYS
;

3320 
	`cÚd_»sched
();

3323  
»t
;

3324 
	}
}

3326 
	$bŒfs_g‘_block_group_Œimmšg
(
bŒfs_block_group_ÿche
 *
ÿche
)

3328 
	`©omic_šc
(&
ÿche
->
Œimmšg
);

3329 
	}
}

3331 
	$bŒfs_put_block_group_Œimmšg
(
bŒfs_block_group_ÿche
 *
block_group
)

3333 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

3334 
ex‹Á_m­_Œ“
 *
em_Œ“
;

3335 
ex‹Á_m­
 *
em
;

3336 
boÞ
 
þ—nup
;

3338 
	`¥š_lock
(&
block_group
->
lock
);

3339 
þ—nup
 = (
	`©omic_dec_ªd_‹¡
(&
block_group
->
Œimmšg
) &&

3340 
block_group
->
»moved
);

3341 
	`¥š_uÆock
(&
block_group
->
lock
);

3343 ià(
þ—nup
) {

3344 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

3345 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

3346 
	`wr™e_lock
(&
em_Œ“
->
lock
);

3347 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
block_group
->
key
.
objeùid
,

3349 
	`BUG_ON
(!
em
);

3354 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

3355 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

3356 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

3359 
	`ä“_ex‹Á_m­
(
em
);

3360 
	`ä“_ex‹Á_m­
(
em
);

3366 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
block_group
->
ä“_¥aû_ùl
);

3368 
	}
}

3370 
	$bŒfs_Œim_block_group
(
bŒfs_block_group_ÿche
 *
block_group
,

3371 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
)

3373 
»t
;

3375 *
Œimmed
 = 0;

3377 
	`¥š_lock
(&
block_group
->
lock
);

3378 ià(
block_group
->
»moved
) {

3379 
	`¥š_uÆock
(&
block_group
->
lock
);

3382 
	`bŒfs_g‘_block_group_Œimmšg
(
block_group
);

3383 
	`¥š_uÆock
(&
block_group
->
lock
);

3385 
»t
 = 
	`Œim_no_b™m­
(
block_group
, 
Œimmed
, 
¡¬t
, 
’d
, 
mšËn
);

3386 ià(
»t
)

3387 
out
;

3389 
»t
 = 
	`Œim_b™m­s
(
block_group
, 
Œimmed
, 
¡¬t
, 
’d
, 
mšËn
);

3390 
out
:

3391 
	`bŒfs_put_block_group_Œimmšg
(
block_group
);

3392  
»t
;

3393 
	}
}

3402 
u64
 
	$bŒfs_fšd_šo_fÜ_®loc
(
bŒfs_roÙ
 *
fs_roÙ
)

3404 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
fs_roÙ
->
ä“_šo_ùl
;

3405 
bŒfs_ä“_¥aû
 *
’Œy
 = 
NULL
;

3406 
u64
 
šo
 = 0;

3408 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3410 ià(
	`RB_EMPTY_ROOT
(&
ùl
->
ä“_¥aû_off£t
))

3411 
out
;

3413 
’Œy
 = 
	`rb_’Œy
(
	`rb_fœ¡
(&
ùl
->
ä“_¥aû_off£t
),

3414 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

3416 ià(!
’Œy
->
b™m­
) {

3417 
šo
 = 
’Œy
->
off£t
;

3419 
	`uÆšk_ä“_¥aû
(
ùl
, 
’Œy
);

3420 
’Œy
->
off£t
++;

3421 
’Œy
->
by‹s
--;

3422 ià(!
’Œy
->
by‹s
)

3423 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
’Œy
);

3425 
	`lšk_ä“_¥aû
(
ùl
, 
’Œy
);

3427 
u64
 
off£t
 = 0;

3428 
u64
 
couÁ
 = 1;

3429 
»t
;

3431 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
’Œy
, &
off£t
, &
couÁ
, 
Œue
);

3433 
	`ASSERT
(!
»t
);

3435 
šo
 = 
off£t
;

3436 
	`b™m­_þ—r_b™s
(
ùl
, 
’Œy
, 
off£t
, 1);

3437 ià(
’Œy
->
by‹s
 == 0)

3438 
	`ä“_b™m­
(
ùl
, 
’Œy
);

3440 
out
:

3441 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3443  
šo
;

3444 
	}
}

3446 
šode
 *
	$lookup_ä“_šo_šode
(
bŒfs_roÙ
 *
roÙ
,

3447 
bŒfs_·th
 *
·th
)

3449 
šode
 *šodð
NULL
;

3451 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

3452 ià(
roÙ
->
šo_ÿche_šode
)

3453 
šode
 = 
	`ig¿b
(
roÙ
->
šo_ÿche_šode
);

3454 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

3455 ià(
šode
)

3456  
šode
;

3458 
šode
 = 
	`__lookup_ä“_¥aû_šode
(
roÙ
, 
·th
, 0);

3459 ià(
	`IS_ERR
(
šode
))

3460  
šode
;

3462 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

3463 ià(!
	`bŒfs_fs_þosšg
(
roÙ
->
fs_šfo
))

3464 
roÙ
->
šo_ÿche_šode
 = 
	`ig¿b
(
šode
);

3465 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

3467  
šode
;

3468 
	}
}

3470 
	$ü—‹_ä“_šo_šode
(
bŒfs_roÙ
 *
roÙ
,

3471 
bŒfs_Œªs_hªdË
 *
Œªs
,

3472 
bŒfs_·th
 *
·th
)

3474  
	`__ü—‹_ä“_¥aû_šode
(
roÙ
, 
Œªs
, 
·th
,

3475 
BTRFS_FREE_INO_OBJECTID
, 0);

3476 
	}
}

3478 
	$lßd_ä“_šo_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_roÙ
 *
roÙ
)

3480 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

3481 
bŒfs_·th
 *
·th
;

3482 
šode
 *inode;

3483 
»t
 = 0;

3484 
u64
 
roÙ_g’
 = 
	`bŒfs_roÙ_g’”©iÚ
(&
roÙ
->
roÙ_™em
);

3486 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
INODE_MAP_CACHE
))

3493 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
))

3496 
·th
 = 
	`bŒfs_®loc_·th
();

3497 ià(!
·th
)

3500 
šode
 = 
	`lookup_ä“_šo_šode
(
roÙ
, 
·th
);

3501 ià(
	`IS_ERR
(
šode
))

3502 
out
;

3504 ià(
roÙ_g’
 !ð
	`BTRFS_I
(
šode
)->
g’”©iÚ
)

3505 
out_put
;

3507 
»t
 = 
	`__lßd_ä“_¥aû_ÿche
(
roÙ
, 
šode
, 
ùl
, 
·th
, 0);

3509 ià(
»t
 < 0)

3510 
	`bŒfs_”r
(
fs_šfo
,

3512 
roÙ
->
roÙ_key
.
objeùid
);

3513 
out_put
:

3514 
	`ut
(
šode
);

3515 
out
:

3516 
	`bŒfs_ä“_·th
(
·th
);

3517  
»t
;

3518 
	}
}

3520 
	$bŒfs_wr™e_out_šo_ÿche
(
bŒfs_roÙ
 *
roÙ
,

3521 
bŒfs_Œªs_hªdË
 *
Œªs
,

3522 
bŒfs_·th
 *
·th
,

3523 
šode
 *inode)

3525 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3526 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

3527 
»t
;

3528 
bŒfs_io_ùl
 
io_ùl
;

3529 
boÞ
 
»Ëa£_m‘ad©a
 = 
Œue
;

3531 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
INODE_MAP_CACHE
))

3534 
	`mem£t
(&
io_ùl
, 0, (io_ctl));

3535 
»t
 = 
	`__bŒfs_wr™e_out_ÿche
(
roÙ
, 
šode
, 
ùl
, 
NULL
, &
io_ùl
, 
Œªs
);

3536 ià(!
»t
) {

3543 
»Ëa£_m‘ad©a
 = 
çl£
;

3544 
»t
 = 
	`bŒfs_wa™_ÿche_io_roÙ
(
roÙ
, 
Œªs
, &
io_ùl
, 
·th
);

3547 ià(
»t
) {

3548 ià(
»Ëa£_m‘ad©a
)

3549 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

3550 
šode
->
i_size
);

3551 #ifdeà
DEBUG


3552 
	`bŒfs_”r
(
fs_šfo
,

3554 
roÙ
->
roÙ_key
.
objeùid
);

3558  
»t
;

3559 
	}
}

3561 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


3568 
	$‹¡_add_ä“_¥aû_’Œy
(
bŒfs_block_group_ÿche
 *
ÿche
,

3569 
u64
 
off£t
, u64 
by‹s
, 
boÞ
 
b™m­
)

3571 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
ÿche
->
ä“_¥aû_ùl
;

3572 
bŒfs_ä“_¥aû
 *
šfo
 = 
NULL
, *
b™m­_šfo
;

3573 *
m­
 = 
NULL
;

3574 
u64
 
by‹s_added
;

3575 
»t
;

3577 
agaš
:

3578 ià(!
šfo
) {

3579 
šfo
 = 
	`kmem_ÿche_z®loc
(
bŒfs_ä“_¥aû_ÿch•
, 
GFP_NOFS
);

3580 ià(!
šfo
)

3581  -
ENOMEM
;

3584 ià(!
b™m­
) {

3585 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3586 
šfo
->
off£t
 = offset;

3587 
šfo
->
by‹s
 = bytes;

3588 
šfo
->
max_ex‹Á_size
 = 0;

3589 
»t
 = 
	`lšk_ä“_¥aû
(
ùl
, 
šfo
);

3590 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3591 ià(
»t
)

3592 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

3593  
»t
;

3596 ià(!
m­
) {

3597 
m­
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_NOFS
);

3598 ià(!
m­
) {

3599 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

3600  -
ENOMEM
;

3604 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3605 
b™m­_šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

3607 ià(!
b™m­_šfo
) {

3608 
šfo
->
b™m­
 = 
m­
;

3609 
m­
 = 
NULL
;

3610 
	`add_Ãw_b™m­
(
ùl
, 
šfo
, 
off£t
);

3611 
b™m­_šfo
 = 
šfo
;

3612 
šfo
 = 
NULL
;

3615 
by‹s_added
 = 
	`add_by‹s_to_b™m­
(
ùl
, 
b™m­_šfo
, 
off£t
, 
by‹s
);

3617 
by‹s
 -ð
by‹s_added
;

3618 
off£t
 +ð
by‹s_added
;

3619 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3621 ià(
by‹s
)

3622 
agaš
;

3624 ià(
šfo
)

3625 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

3626 ià(
m­
)

3627 
	`kä“
(
m­
);

3629 
	}
}

3636 
	$‹¡_check_exi¡s
(
bŒfs_block_group_ÿche
 *
ÿche
,

3637 
u64
 
off£t
, u64 
by‹s
)

3639 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
ÿche
->
ä“_¥aû_ùl
;

3640 
bŒfs_ä“_¥aû
 *
šfo
;

3641 
»t
 = 0;

3643 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

3644 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
off£t
, 0, 0);

3645 ià(!
šfo
) {

3646 
šfo
 = 
	`Œ“_£¬ch_off£t
(
ùl
, 
	`off£t_to_b™m­
(ùl, 
off£t
),

3648 ià(!
šfo
)

3649 
out
;

3652 
have_šfo
:

3653 ià(
šfo
->
b™m­
) {

3654 
u64
 
b™_off
, 
b™_by‹s
;

3655 
rb_node
 *
n
;

3656 
bŒfs_ä“_¥aû
 *
tmp
;

3658 
b™_off
 = 
off£t
;

3659 
b™_by‹s
 = 
ùl
->
un™
;

3660 
»t
 = 
	`£¬ch_b™m­
(
ùl
, 
šfo
, &
b™_off
, &
b™_by‹s
, 
çl£
);

3661 ià(!
»t
) {

3662 ià(
b™_off
 =ð
off£t
) {

3663 
»t
 = 1;

3664 
out
;

3665 } ià(
b™_off
 > 
off£t
 &&

3666 
off£t
 + 
by‹s
 > 
b™_off
) {

3667 
»t
 = 1;

3668 
out
;

3672 
n
 = 
	`rb_´ev
(&
šfo
->
off£t_šdex
);

3673 
n
) {

3674 
tmp
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

3675 
off£t_šdex
);

3676 ià(
tmp
->
off£t
 +mp->
by‹s
 < offset)

3678 ià(
off£t
 + 
by‹s
 < 
tmp
->offset) {

3679 
n
 = 
	`rb_´ev
(&
tmp
->
off£t_šdex
);

3682 
šfo
 = 
tmp
;

3683 
have_šfo
;

3686 
n
 = 
	`rb_Ãxt
(&
šfo
->
off£t_šdex
);

3687 
n
) {

3688 
tmp
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
,

3689 
off£t_šdex
);

3690 ià(
off£t
 + 
by‹s
 < 
tmp
->offset)

3692 ià(
tmp
->
off£t
 +mp->
by‹s
 < offset) {

3693 
n
 = 
	`rb_Ãxt
(&
tmp
->
off£t_šdex
);

3696 
šfo
 = 
tmp
;

3697 
have_šfo
;

3700 
»t
 = 0;

3701 
out
;

3704 ià(
šfo
->
off£t
 == offset) {

3705 
»t
 = 1;

3706 
out
;

3709 ià(
off£t
 > 
šfo
->off£ˆ&& off£ˆ< info->off£ˆ+ info->
by‹s
)

3710 
»t
 = 1;

3711 
out
:

3712 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

3713  
»t
;

3714 
	}
}

	@free-space-cache.h

19 #iâdeà
__BTRFS_FREE_SPACE_CACHE


20 
	#__BTRFS_FREE_SPACE_CACHE


	)

22 
	sbŒfs_ä“_¥aû
 {

23 
rb_node
 
	moff£t_šdex
;

24 
u64
 
	moff£t
;

25 
u64
 
	mby‹s
;

26 
u64
 
	mmax_ex‹Á_size
;

27 *
	mb™m­
;

28 
li¡_h—d
 
	mli¡
;

31 
	sbŒfs_ä“_¥aû_ùl
 {

32 
¥šlock_t
 
	mŒ“_lock
;

33 
rb_roÙ
 
	mä“_¥aû_off£t
;

34 
u64
 
	mä“_¥aû
;

35 
	mex‹Ás_th»sh
;

36 
	mä“_ex‹Ás
;

37 
	mtÙ®_b™m­s
;

38 
	mun™
;

39 
u64
 
	m¡¬t
;

40 cÚ¡ 
bŒfs_ä“_¥aû_Ý
 *
	mÝ
;

41 *
	m´iv©e
;

42 
mu‹x
 
	mÿche_wr™eout_mu‹x
;

43 
li¡_h—d
 
	mŒimmšg_¿nges
;

46 
	sbŒfs_ä“_¥aû_Ý
 {

47 (*
	m»ÿlc_th»shÞds
)(
bŒfs_ä“_¥aû_ùl
 *
	mùl
);

48 
boÞ
 (*
u£_b™m­
)(
bŒfs_ä“_¥aû_ùl
 *
	mùl
,

49 
bŒfs_ä“_¥aû
 *
	mšfo
);

52 
	gbŒfs_io_ùl
;

54 
šode
 *
lookup_ä“_¥aû_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

55 
bŒfs_block_group_ÿche


56 *
block_group
, 
bŒfs_·th
 *
·th
);

57 
ü—‹_ä“_¥aû_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

58 
bŒfs_Œªs_hªdË
 *
Œªs
,

59 
bŒfs_block_group_ÿche
 *
block_group
,

60 
bŒfs_·th
 *
·th
);

62 
bŒfs_check_Œunc_ÿche_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

63 
bŒfs_block_rsv
 *
rsv
);

64 
bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

65 
bŒfs_block_group_ÿche
 *
block_group
,

66 
šode
 *inode);

67 
lßd_ä“_¥aû_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

68 
bŒfs_block_group_ÿche
 *
block_group
);

69 
bŒfs_wa™_ÿche_io
(
bŒfs_Œªs_hªdË
 *
Œªs
,

70 
bŒfs_block_group_ÿche
 *
block_group
,

71 
bŒfs_·th
 *
·th
);

72 
bŒfs_wr™e_out_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

73 
bŒfs_Œªs_hªdË
 *
Œªs
,

74 
bŒfs_block_group_ÿche
 *
block_group
,

75 
bŒfs_·th
 *
·th
);

76 
šode
 *
lookup_ä“_šo_šode
(
bŒfs_roÙ
 *
roÙ
,

77 
bŒfs_·th
 *
·th
);

78 
ü—‹_ä“_šo_šode
(
bŒfs_roÙ
 *
roÙ
,

79 
bŒfs_Œªs_hªdË
 *
Œªs
,

80 
bŒfs_·th
 *
·th
);

81 
lßd_ä“_šo_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

82 
bŒfs_roÙ
 *
roÙ
);

83 
bŒfs_wr™e_out_šo_ÿche
(
bŒfs_roÙ
 *
roÙ
,

84 
bŒfs_Œªs_hªdË
 *
Œªs
,

85 
bŒfs_·th
 *
·th
,

86 
šode
 *inode);

88 
bŒfs_š™_ä“_¥aû_ùl
(
bŒfs_block_group_ÿche
 *
block_group
);

89 
__bŒfs_add_ä“_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

90 
bŒfs_ä“_¥aû_ùl
 *
ùl
,

91 
u64
 
by‹Ä
, u64 
size
);

92 
šlše
 

93 
	$bŒfs_add_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

94 
u64
 
by‹Ä
, u64 
size
)

96  
	`__bŒfs_add_ä“_¥aû
(
block_group
->
fs_šfo
,

97 
block_group
->
ä“_¥aû_ùl
,

98 
by‹Ä
, 
size
);

99 
	}
}

100 
bŒfs_»move_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

101 
u64
 
by‹Ä
, u64 
size
);

102 
__bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_ä“_¥aû_ùl
 *
ùl
);

103 
bŒfs_»move_ä“_¥aû_ÿche
(
bŒfs_block_group_ÿche


104 *
block_group
);

105 
u64
 
bŒfs_fšd_¥aû_fÜ_®loc
(
bŒfs_block_group_ÿche
 *
block_group
,

106 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
,

107 
u64
 *
max_ex‹Á_size
);

108 
u64
 
bŒfs_fšd_šo_fÜ_®loc
(
bŒfs_roÙ
 *
fs_roÙ
);

109 
bŒfs_dump_ä“_¥aû
(
bŒfs_block_group_ÿche
 *
block_group
,

110 
u64
 
by‹s
);

111 
bŒfs_fšd_¥aû_þu¡”
(
bŒfs_fs_šfo
 *
fs_šfo
,

112 
bŒfs_block_group_ÿche
 *
block_group
,

113 
bŒfs_ä“_þu¡”
 *
þu¡”
,

114 
u64
 
off£t
, u64 
by‹s
, u64 
em±y_size
);

115 
bŒfs_š™_ä“_þu¡”
(
bŒfs_ä“_þu¡”
 *
þu¡”
);

116 
u64
 
bŒfs_®loc_äom_þu¡”
(
bŒfs_block_group_ÿche
 *
block_group
,

117 
bŒfs_ä“_þu¡”
 *
þu¡”
, 
u64
 
by‹s
,

118 
u64
 
mš_¡¬t
, u64 *
max_ex‹Á_size
);

119 
bŒfs_»tuº_þu¡”_to_ä“_¥aû
(

120 
bŒfs_block_group_ÿche
 *
block_group
,

121 
bŒfs_ä“_þu¡”
 *
þu¡”
);

122 
bŒfs_Œim_block_group
(
bŒfs_block_group_ÿche
 *
block_group
,

123 
u64
 *
Œimmed
, u64 
¡¬t
, u64 
’d
, u64 
mšËn
);

126 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


127 
‹¡_add_ä“_¥aû_’Œy
(
bŒfs_block_group_ÿche
 *
ÿche
,

128 
u64
 
off£t
, u64 
by‹s
, 
boÞ
 
b™m­
);

129 
‹¡_check_exi¡s
(
bŒfs_block_group_ÿche
 *
ÿche
,

130 
u64
 
off£t
, u64 
by‹s
);

	@free-space-tree.c

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/sched/mm.h
>

21 
	~"ù»e.h
"

22 
	~"disk-io.h
"

23 
	~"lockšg.h
"

24 
	~"ä“-¥aû-Œ“.h
"

25 
	~"Œª§ùiÚ.h
"

27 
__add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

28 
bŒfs_fs_šfo
 *
fs_šfo
,

29 
bŒfs_block_group_ÿche
 *
block_group
,

30 
bŒfs_·th
 *
·th
);

32 
	$£t_ä“_¥aû_Œ“_th»shÞds
(
bŒfs_block_group_ÿche
 *
ÿche
)

34 
u32
 
b™m­_¿nge
;

35 
size_t
 
b™m­_size
;

36 
u64
 
num_b™m­s
, 
tÙ®_b™m­_size
;

42 
b™m­_¿nge
 = 
ÿche
->
fs_šfo
->
£ùÜsize
 * 
BTRFS_FREE_SPACE_BITMAP_BITS
;

43 
num_b™m­s
 = 
	`div_u64
(
ÿche
->
key
.
off£t
 + 
b™m­_¿nge
 - 1,

44 
b™m­_¿nge
);

45 
b™m­_size
 = (
bŒfs_™em
è+ 
BTRFS_FREE_SPACE_BITMAP_SIZE
;

46 
tÙ®_b™m­_size
 = 
num_b™m­s
 * 
b™m­_size
;

47 
ÿche
->
b™m­_high_th»sh
 = 
	`div_u64
(
tÙ®_b™m­_size
,

48 (
bŒfs_™em
));

54 ià(
ÿche
->
b™m­_high_th»sh
 > 100)

55 
ÿche
->
b™m­_low_th»sh
 = cache->
b™m­_high_th»sh
 - 100;

57 
ÿche
->
b™m­_low_th»sh
 = 0;

58 
	}
}

60 
	$add_Ãw_ä“_¥aû_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

61 
bŒfs_fs_šfo
 *
fs_šfo
,

62 
bŒfs_block_group_ÿche
 *
block_group
,

63 
bŒfs_·th
 *
·th
)

65 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

66 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

67 
bŒfs_key
 
key
;

68 
ex‹Á_bufãr
 *
Ëaf
;

69 
»t
;

71 
key
.
objeùid
 = 
block_group
->key.objectid;

72 
key
.
ty³
 = 
BTRFS_FREE_SPACE_INFO_KEY
;

73 
key
.
off£t
 = 
block_group
->key.offset;

75 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, (*
šfo
));

76 ià(
»t
)

77 
out
;

79 
Ëaf
 = 
·th
->
nodes
[0];

80 
šfo
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

81 
bŒfs_ä“_¥aû_šfo
);

82 
	`bŒfs_£t_ä“_¥aû_ex‹Á_couÁ
(
Ëaf
, 
šfo
, 0);

83 
	`bŒfs_£t_ä“_¥aû_æags
(
Ëaf
, 
šfo
, 0);

84 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

86 
»t
 = 0;

87 
out
:

88 
	`bŒfs_»Ëa£_·th
(
·th
);

89  
»t
;

90 
	}
}

92 
bŒfs_ä“_¥aû_šfo
 *

93 
	$£¬ch_ä“_¥aû_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

94 
bŒfs_fs_šfo
 *
fs_šfo
,

95 
bŒfs_block_group_ÿche
 *
block_group
,

96 
bŒfs_·th
 *
·th
, 
cow
)

98 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

99 
bŒfs_key
 
key
;

100 
»t
;

102 
key
.
objeùid
 = 
block_group
->key.objectid;

103 
key
.
ty³
 = 
BTRFS_FREE_SPACE_INFO_KEY
;

104 
key
.
off£t
 = 
block_group
->key.offset;

106 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 
cow
);

107 ià(
»t
 < 0)

108  
	`ERR_PTR
(
»t
);

109 ià(
»t
 != 0) {

110 
	`bŒfs_w¬n
(
fs_šfo
, "missing free space info for %llu",

111 
block_group
->
key
.
objeùid
);

112 
	`ASSERT
(0);

113  
	`ERR_PTR
(-
ENOENT
);

116  
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

117 
bŒfs_ä“_¥aû_šfo
);

118 
	}
}

124 
	$bŒfs_£¬ch_´ev_¦Ù
(
bŒfs_Œªs_hªdË
 *
Œªs
,

125 
bŒfs_roÙ
 *
roÙ
,

126 
bŒfs_key
 *
key
, 
bŒfs_·th
 *
p
,

127 
šs_Ën
, 
cow
)

129 
»t
;

131 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
p
, 
šs_Ën
, 
cow
);

132 ià(
»t
 < 0)

133  
»t
;

135 ià(
»t
 == 0) {

136 
	`ASSERT
(0);

137  -
EIO
;

140 ià(
p
->
¦Ùs
[0] == 0) {

141 
	`ASSERT
(0);

142  -
EIO
;

144 
p
->
¦Ùs
[0]--;

147 
	}
}

149 
šlše
 
u32
 
	$ä“_¥aû_b™m­_size
(
u64
 
size
, 
u32
 
£ùÜsize
)

151  
	`DIV_ROUND_UP
((
u32
)
	`div_u64
(
size
, 
£ùÜsize
), 
BITS_PER_BYTE
);

152 
	}
}

154 
u8
 *
	$®loc_b™m­
(
u32
 
b™m­_size
)

156 
u8
 *
»t
;

157 
nofs_æag
;

167 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

168 
»t
 = 
	`kvz®loc
(
b™m­_size
, 
GFP_KERNEL
);

169 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

170  
»t
;

171 
	}
}

173 
	$cÚv”t_ä“_¥aû_to_b™m­s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

174 
bŒfs_fs_šfo
 *
fs_šfo
,

175 
bŒfs_block_group_ÿche
 *
block_group
,

176 
bŒfs_·th
 *
·th
)

178 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

179 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

180 
bŒfs_key
 
key
, 
found_key
;

181 
ex‹Á_bufãr
 *
Ëaf
;

182 
u8
 *
b™m­
, *
b™m­_cursÜ
;

183 
u64
 
¡¬t
, 
’d
;

184 
u64
 
b™m­_¿nge
, 
i
;

185 
u32
 
b™m­_size
, 
æags
, 
ex³ùed_ex‹Á_couÁ
;

186 
u32
 
ex‹Á_couÁ
 = 0;

187 
dÚe
 = 0, 
Ä
;

188 
»t
;

190 
b™m­_size
 = 
	`ä“_¥aû_b™m­_size
(
block_group
->
key
.
off£t
,

191 
fs_šfo
->
£ùÜsize
);

192 
b™m­
 = 
	`®loc_b™m­
(
b™m­_size
);

193 ià(!
b™m­
) {

194 
»t
 = -
ENOMEM
;

195 
out
;

198 
¡¬t
 = 
block_group
->
key
.
objeùid
;

199 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

201 
key
.
objeùid
 = 
’d
 - 1;

202 
key
.
ty³
 = (
u8
)-1;

203 
key
.
off£t
 = (
u64
)-1;

205 !
dÚe
) {

206 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

207 ià(
»t
)

208 
out
;

210 
Ëaf
 = 
·th
->
nodes
[0];

211 
Ä
 = 0;

212 
·th
->
¦Ùs
[0]++;

213 
·th
->
¦Ùs
[0] > 0) {

214 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0] - 1);

216 ià(
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
) {

217 
	`ASSERT
(
found_key
.
objeùid
 =ð
block_group
->
key
.objectid);

218 
	`ASSERT
(
found_key
.
off£t
 =ð
block_group
->
key
.offset);

219 
dÚe
 = 1;

221 } ià(
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_EXTENT_KEY
) {

222 
u64
 
fœ¡
, 
Ï¡
;

224 
	`ASSERT
(
found_key
.
objeùid
 >ð
¡¬t
);

225 
	`ASSERT
(
found_key
.
objeùid
 < 
’d
);

226 
	`ASSERT
(
found_key
.
objeùid
 + found_key.
off£t
 <ð
’d
);

228 
fœ¡
 = 
	`div_u64
(
found_key
.
objeùid
 - 
¡¬t
,

229 
fs_šfo
->
£ùÜsize
);

230 
Ï¡
 = 
	`div_u64
(
found_key
.
objeùid
 + found_key.
off£t
 - 
¡¬t
,

231 
fs_šfo
->
£ùÜsize
);

232 
	`Ë_b™m­_£t
(
b™m­
, 
fœ¡
, 
Ï¡
 - first);

234 
ex‹Á_couÁ
++;

235 
Ä
++;

236 
·th
->
¦Ùs
[0]--;

238 
	`ASSERT
(0);

242 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
Ä
);

243 ià(
»t
)

244 
out
;

245 
	`bŒfs_»Ëa£_·th
(
·th
);

248 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
, 1);

249 ià(
	`IS_ERR
(
šfo
)) {

250 
»t
 = 
	`PTR_ERR
(
šfo
);

251 
out
;

253 
Ëaf
 = 
·th
->
nodes
[0];

254 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
Ëaf
, 
šfo
);

255 
æags
 |ð
BTRFS_FREE_SPACE_USING_BITMAPS
;

256 
	`bŒfs_£t_ä“_¥aû_æags
(
Ëaf
, 
šfo
, 
æags
);

257 
ex³ùed_ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
Ëaf
, 
šfo
);

258 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

259 
	`bŒfs_»Ëa£_·th
(
·th
);

261 ià(
ex‹Á_couÁ
 !ð
ex³ùed_ex‹Á_couÁ
) {

262 
	`bŒfs_”r
(
fs_šfo
,

264 
block_group
->
key
.
objeùid
, 
ex‹Á_couÁ
,

265 
ex³ùed_ex‹Á_couÁ
);

266 
	`ASSERT
(0);

267 
»t
 = -
EIO
;

268 
out
;

271 
b™m­_cursÜ
 = 
b™m­
;

272 
b™m­_¿nge
 = 
fs_šfo
->
£ùÜsize
 * 
BTRFS_FREE_SPACE_BITMAP_BITS
;

273 
i
 = 
¡¬t
;

274 
i
 < 
’d
) {

275 
±r
;

276 
u64
 
ex‹Á_size
;

277 
u32
 
d©a_size
;

279 
ex‹Á_size
 = 
	`mš
(
’d
 - 
i
, 
b™m­_¿nge
);

280 
d©a_size
 = 
	`ä“_¥aû_b™m­_size
(
ex‹Á_size
,

281 
fs_šfo
->
£ùÜsize
);

283 
key
.
objeùid
 = 
i
;

284 
key
.
ty³
 = 
BTRFS_FREE_SPACE_BITMAP_KEY
;

285 
key
.
off£t
 = 
ex‹Á_size
;

287 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

288 
d©a_size
);

289 ià(
»t
)

290 
out
;

292 
Ëaf
 = 
·th
->
nodes
[0];

293 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

294 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
b™m­_cursÜ
, 
±r
,

295 
d©a_size
);

296 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

297 
	`bŒfs_»Ëa£_·th
(
·th
);

299 
i
 +ð
ex‹Á_size
;

300 
b™m­_cursÜ
 +ð
d©a_size
;

303 
»t
 = 0;

304 
out
:

305 
	`kvä“
(
b™m­
);

306 ià(
»t
)

307 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

308  
»t
;

309 
	}
}

311 
	$cÚv”t_ä“_¥aû_to_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

312 
bŒfs_fs_šfo
 *
fs_šfo
,

313 
bŒfs_block_group_ÿche
 *
block_group
,

314 
bŒfs_·th
 *
·th
)

316 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

317 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

318 
bŒfs_key
 
key
, 
found_key
;

319 
ex‹Á_bufãr
 *
Ëaf
;

320 
u8
 *
b™m­
;

321 
u64
 
¡¬t
, 
’d
;

323 
u64
 
ex‹Á_¡¬t
 = 0;

324 
u64
 
off£t
;

325 
u32
 
b™m­_size
, 
æags
, 
ex³ùed_ex‹Á_couÁ
;

326 
´ev_b™
 = 0, 
b™
, 
b™Ä
;

327 
u32
 
ex‹Á_couÁ
 = 0;

328 
dÚe
 = 0, 
Ä
;

329 
»t
;

331 
b™m­_size
 = 
	`ä“_¥aû_b™m­_size
(
block_group
->
key
.
off£t
,

332 
fs_šfo
->
£ùÜsize
);

333 
b™m­
 = 
	`®loc_b™m­
(
b™m­_size
);

334 ià(!
b™m­
) {

335 
»t
 = -
ENOMEM
;

336 
out
;

339 
¡¬t
 = 
block_group
->
key
.
objeùid
;

340 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

342 
key
.
objeùid
 = 
’d
 - 1;

343 
key
.
ty³
 = (
u8
)-1;

344 
key
.
off£t
 = (
u64
)-1;

346 !
dÚe
) {

347 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

348 ià(
»t
)

349 
out
;

351 
Ëaf
 = 
·th
->
nodes
[0];

352 
Ä
 = 0;

353 
·th
->
¦Ùs
[0]++;

354 
·th
->
¦Ùs
[0] > 0) {

355 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0] - 1);

357 ià(
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
) {

358 
	`ASSERT
(
found_key
.
objeùid
 =ð
block_group
->
key
.objectid);

359 
	`ASSERT
(
found_key
.
off£t
 =ð
block_group
->
key
.offset);

360 
dÚe
 = 1;

362 } ià(
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_BITMAP_KEY
) {

363 
±r
;

364 
u8
 *
b™m­_cursÜ
;

365 
u32
 
b™m­_pos
, 
d©a_size
;

367 
	`ASSERT
(
found_key
.
objeùid
 >ð
¡¬t
);

368 
	`ASSERT
(
found_key
.
objeùid
 < 
’d
);

369 
	`ASSERT
(
found_key
.
objeùid
 + found_key.
off£t
 <ð
’d
);

371 
b™m­_pos
 = 
	`div_u64
(
found_key
.
objeùid
 - 
¡¬t
,

372 
fs_šfo
->
£ùÜsize
 *

373 
BITS_PER_BYTE
);

374 
b™m­_cursÜ
 = 
b™m­
 + 
b™m­_pos
;

375 
d©a_size
 = 
	`ä“_¥aû_b™m­_size
(
found_key
.
off£t
,

376 
fs_šfo
->
£ùÜsize
);

378 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0] - 1);

379 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
b™m­_cursÜ
, 
±r
,

380 
d©a_size
);

382 
Ä
++;

383 
·th
->
¦Ùs
[0]--;

385 
	`ASSERT
(0);

389 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
Ä
);

390 ià(
»t
)

391 
out
;

392 
	`bŒfs_»Ëa£_·th
(
·th
);

395 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
, 1);

396 ià(
	`IS_ERR
(
šfo
)) {

397 
»t
 = 
	`PTR_ERR
(
šfo
);

398 
out
;

400 
Ëaf
 = 
·th
->
nodes
[0];

401 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
Ëaf
, 
šfo
);

402 
æags
 &ð~
BTRFS_FREE_SPACE_USING_BITMAPS
;

403 
	`bŒfs_£t_ä“_¥aû_æags
(
Ëaf
, 
šfo
, 
æags
);

404 
ex³ùed_ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
Ëaf
, 
šfo
);

405 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

406 
	`bŒfs_»Ëa£_·th
(
·th
);

408 
off£t
 = 
¡¬t
;

409 
b™Ä
 = 0;

410 
off£t
 < 
’d
) {

411 
b™
 = !!
	`Ë_‹¡_b™
(
b™Ä
, 
b™m­
);

412 ià(
´ev_b™
 =ð0 && 
b™
 == 1) {

413 
ex‹Á_¡¬t
 = 
off£t
;

414 } ià(
´ev_b™
 =ð1 && 
b™
 == 0) {

415 
key
.
objeùid
 = 
ex‹Á_¡¬t
;

416 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

417 
key
.
off£t
 = off£ˆ- 
ex‹Á_¡¬t
;

419 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

420 ià(
»t
)

421 
out
;

422 
	`bŒfs_»Ëa£_·th
(
·th
);

424 
ex‹Á_couÁ
++;

426 
´ev_b™
 = 
b™
;

427 
off£t
 +ð
fs_šfo
->
£ùÜsize
;

428 
b™Ä
++;

430 ià(
´ev_b™
 == 1) {

431 
key
.
objeùid
 = 
ex‹Á_¡¬t
;

432 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

433 
key
.
off£t
 = 
’d
 - 
ex‹Á_¡¬t
;

435 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

436 ià(
»t
)

437 
out
;

438 
	`bŒfs_»Ëa£_·th
(
·th
);

440 
ex‹Á_couÁ
++;

443 ià(
ex‹Á_couÁ
 !ð
ex³ùed_ex‹Á_couÁ
) {

444 
	`bŒfs_”r
(
fs_šfo
,

446 
block_group
->
key
.
objeùid
, 
ex‹Á_couÁ
,

447 
ex³ùed_ex‹Á_couÁ
);

448 
	`ASSERT
(0);

449 
»t
 = -
EIO
;

450 
out
;

453 
»t
 = 0;

454 
out
:

455 
	`kvä“
(
b™m­
);

456 ià(
»t
)

457 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

458  
»t
;

459 
	}
}

461 
	$upd©e_ä“_¥aû_ex‹Á_couÁ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

462 
bŒfs_fs_šfo
 *
fs_šfo
,

463 
bŒfs_block_group_ÿche
 *
block_group
,

464 
bŒfs_·th
 *
·th
,

465 
Ãw_ex‹Ás
)

467 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

468 
u32
 
æags
;

469 
u32
 
ex‹Á_couÁ
;

470 
»t
 = 0;

472 ià(
Ãw_ex‹Ás
 == 0)

475 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
, 1);

476 ià(
	`IS_ERR
(
šfo
)) {

477 
»t
 = 
	`PTR_ERR
(
šfo
);

478 
out
;

480 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

481 
ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
);

483 
ex‹Á_couÁ
 +ð
Ãw_ex‹Ás
;

484 
	`bŒfs_£t_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
, 
ex‹Á_couÁ
);

485 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

486 
	`bŒfs_»Ëa£_·th
(
·th
);

488 ià(!(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) &&

489 
ex‹Á_couÁ
 > 
block_group
->
b™m­_high_th»sh
) {

490 
»t
 = 
	`cÚv”t_ä“_¥aû_to_b™m­s
(
Œªs
, 
fs_šfo
, 
block_group
,

491 
·th
);

492 } ià((
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) &&

493 
ex‹Á_couÁ
 < 
block_group
->
b™m­_low_th»sh
) {

494 
»t
 = 
	`cÚv”t_ä“_¥aû_to_ex‹Ás
(
Œªs
, 
fs_šfo
, 
block_group
,

495 
·th
);

498 
out
:

499  
»t
;

500 
	}
}

502 
	$ä“_¥aû_‹¡_b™
(
bŒfs_block_group_ÿche
 *
block_group
,

503 
bŒfs_·th
 *
·th
, 
u64
 
off£t
)

505 
ex‹Á_bufãr
 *
Ëaf
;

506 
bŒfs_key
 
key
;

507 
u64
 
found_¡¬t
, 
found_’d
;

508 
±r
, 
i
;

510 
Ëaf
 = 
·th
->
nodes
[0];

511 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

512 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_BITMAP_KEY
);

514 
found_¡¬t
 = 
key
.
objeùid
;

515 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

516 
	`ASSERT
(
off£t
 >ð
found_¡¬t
 && off£ˆ< 
found_’d
);

518 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

519 
i
 = 
	`div_u64
(
off£t
 - 
found_¡¬t
,

520 
block_group
->
fs_šfo
->
£ùÜsize
);

521  !!
	`ex‹Á_bufãr_‹¡_b™
(
Ëaf
, 
±r
, 
i
);

522 
	}
}

524 
	$ä“_¥aû_£t_b™s
(
bŒfs_block_group_ÿche
 *
block_group
,

525 
bŒfs_·th
 *
·th
, 
u64
 *
¡¬t
, u64 *
size
,

526 
b™
)

528 
bŒfs_fs_šfo
 *
fs_šfo
 = 
block_group
->fs_info;

529 
ex‹Á_bufãr
 *
Ëaf
;

530 
bŒfs_key
 
key
;

531 
u64
 
’d
 = *
¡¬t
 + *
size
;

532 
u64
 
found_¡¬t
, 
found_’d
;

533 
±r
, 
fœ¡
, 
Ï¡
;

535 
Ëaf
 = 
·th
->
nodes
[0];

536 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

537 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_BITMAP_KEY
);

539 
found_¡¬t
 = 
key
.
objeùid
;

540 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

541 
	`ASSERT
(*
¡¬t
 >ð
found_¡¬t
 && *¡¬ˆ< 
found_’d
);

542 
	`ASSERT
(
’d
 > 
found_¡¬t
);

544 ià(
’d
 > 
found_’d
)

545 
’d
 = 
found_’d
;

547 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

548 
fœ¡
 = 
	`div_u64
(*
¡¬t
 - 
found_¡¬t
, 
fs_šfo
->
£ùÜsize
);

549 
Ï¡
 = 
	`div_u64
(
’d
 - 
found_¡¬t
, 
fs_šfo
->
£ùÜsize
);

550 ià(
b™
)

551 
	`ex‹Á_bufãr_b™m­_£t
(
Ëaf
, 
±r
, 
fœ¡
, 
Ï¡
 - first);

553 
	`ex‹Á_bufãr_b™m­_þ—r
(
Ëaf
, 
±r
, 
fœ¡
, 
Ï¡
 - first);

554 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

556 *
size
 -ð
’d
 - *
¡¬t
;

557 *
¡¬t
 = 
’d
;

558 
	}
}

566 
	$ä“_¥aû_Ãxt_b™m­
(
bŒfs_Œªs_hªdË
 *
Œªs
,

567 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
p
)

569 
bŒfs_key
 
key
;

571 ià(
p
->
¦Ùs
[0] + 1 < 
	`bŒfs_h—d”_Ä™ems
Õ->
nodes
[0])) {

572 
p
->
¦Ùs
[0]++;

576 
	`bŒfs_™em_key_to_ýu
(
p
->
nodes
[0], &
key
,…->
¦Ùs
[0]);

577 
	`bŒfs_»Ëa£_·th
(
p
);

579 
key
.
objeùid
 +ðkey.
off£t
;

580 
key
.
ty³
 = (
u8
)-1;

581 
key
.
off£t
 = (
u64
)-1;

583  
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
p
, 0, 1);

584 
	}
}

591 
	$modify_ä“_¥aû_b™m­
(
bŒfs_Œªs_hªdË
 *
Œªs
,

592 
bŒfs_fs_šfo
 *
fs_šfo
,

593 
bŒfs_block_group_ÿche
 *
block_group
,

594 
bŒfs_·th
 *
·th
,

595 
u64
 
¡¬t
, u64 
size
, 
»move
)

597 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

598 
bŒfs_key
 
key
;

599 
u64
 
’d
 = 
¡¬t
 + 
size
;

600 
u64
 
cur_¡¬t
, 
cur_size
;

601 
´ev_b™
, 
Ãxt_b™
;

602 
Ãw_ex‹Ás
;

603 
»t
;

609 ià(
¡¬t
 > 
block_group
->
key
.
objeùid
) {

610 
u64
 
´ev_block
 = 
¡¬t
 - 
block_group
->
fs_šfo
->
£ùÜsize
;

612 
key
.
objeùid
 = 
´ev_block
;

613 
key
.
ty³
 = (
u8
)-1;

614 
key
.
off£t
 = (
u64
)-1;

616 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

617 ià(
»t
)

618 
out
;

620 
´ev_b™
 = 
	`ä“_¥aû_‹¡_b™
(
block_group
, 
·th
, 
´ev_block
);

623 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

624 ià(
¡¬t
 >ð
key
.
objeùid
 + key.
off£t
) {

625 
»t
 = 
	`ä“_¥aû_Ãxt_b™m­
(
Œªs
, 
roÙ
, 
·th
);

626 ià(
»t
)

627 
out
;

630 
key
.
objeùid
 = 
¡¬t
;

631 
key
.
ty³
 = (
u8
)-1;

632 
key
.
off£t
 = (
u64
)-1;

634 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

635 ià(
»t
)

636 
out
;

638 
´ev_b™
 = -1;

645 
cur_¡¬t
 = 
¡¬t
;

646 
cur_size
 = 
size
;

648 
	`ä“_¥aû_£t_b™s
(
block_group
, 
·th
, &
cur_¡¬t
, &
cur_size
,

649 !
»move
);

650 ià(
cur_size
 == 0)

652 
»t
 = 
	`ä“_¥aû_Ãxt_b™m­
(
Œªs
, 
roÙ
, 
·th
);

653 ià(
»t
)

654 
out
;

661 ià(
’d
 < 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
) {

663 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

664 ià(
’d
 >ð
key
.
objeùid
 + key.
off£t
) {

665 
»t
 = 
	`ä“_¥aû_Ãxt_b™m­
(
Œªs
, 
roÙ
, 
·th
);

666 ià(
»t
)

667 
out
;

670 
Ãxt_b™
 = 
	`ä“_¥aû_‹¡_b™
(
block_group
, 
·th
, 
’d
);

672 
Ãxt_b™
 = -1;

675 ià(
»move
) {

676 
Ãw_ex‹Ás
 = -1;

677 ià(
´ev_b™
 == 1) {

679 
Ãw_ex‹Ás
++;

681 ià(
Ãxt_b™
 == 1) {

683 
Ãw_ex‹Ás
++;

686 
Ãw_ex‹Ás
 = 1;

687 ià(
´ev_b™
 == 1) {

689 
Ãw_ex‹Ás
--;

691 ià(
Ãxt_b™
 == 1) {

693 
Ãw_ex‹Ás
--;

697 
	`bŒfs_»Ëa£_·th
(
·th
);

698 
»t
 = 
	`upd©e_ä“_¥aû_ex‹Á_couÁ
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
,

699 
Ãw_ex‹Ás
);

701 
out
:

702  
»t
;

703 
	}
}

705 
	$»move_ä“_¥aû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

706 
bŒfs_fs_šfo
 *
fs_šfo
,

707 
bŒfs_block_group_ÿche
 *
block_group
,

708 
bŒfs_·th
 *
·th
,

709 
u64
 
¡¬t
, u64 
size
)

711 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

712 
bŒfs_key
 
key
;

713 
u64
 
found_¡¬t
, 
found_’d
;

714 
u64
 
’d
 = 
¡¬t
 + 
size
;

715 
Ãw_ex‹Ás
 = -1;

716 
»t
;

718 
key
.
objeùid
 = 
¡¬t
;

719 
key
.
ty³
 = (
u8
)-1;

720 
key
.
off£t
 = (
u64
)-1;

722 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

723 ià(
»t
)

724 
out
;

726 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

728 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_EXTENT_KEY
);

730 
found_¡¬t
 = 
key
.
objeùid
;

731 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

732 
	`ASSERT
(
¡¬t
 >ð
found_¡¬t
 && 
’d
 <ð
found_’d
);

754 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

755 ià(
»t
)

756 
out
;

759 ià(
¡¬t
 > 
found_¡¬t
) {

760 
key
.
objeùid
 = 
found_¡¬t
;

761 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

762 
key
.
off£t
 = 
¡¬t
 - 
found_¡¬t
;

764 
	`bŒfs_»Ëa£_·th
(
·th
);

765 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

766 ià(
»t
)

767 
out
;

768 
Ãw_ex‹Ás
++;

772 ià(
’d
 < 
found_’d
) {

773 
key
.
objeùid
 = 
’d
;

774 
key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

775 
key
.
off£t
 = 
found_’d
 - 
’d
;

777 
	`bŒfs_»Ëa£_·th
(
·th
);

778 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

779 ià(
»t
)

780 
out
;

781 
Ãw_ex‹Ás
++;

784 
	`bŒfs_»Ëa£_·th
(
·th
);

785 
»t
 = 
	`upd©e_ä“_¥aû_ex‹Á_couÁ
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
,

786 
Ãw_ex‹Ás
);

788 
out
:

789  
»t
;

790 
	}
}

792 
	$__»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

793 
bŒfs_fs_šfo
 *
fs_šfo
,

794 
bŒfs_block_group_ÿche
 *
block_group
,

795 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
)

797 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

798 
u32
 
æags
;

799 
»t
;

801 ià(
block_group
->
Ãeds_ä“_¥aû
) {

802 
»t
 = 
	`__add_block_group_ä“_¥aû
(
Œªs
, 
fs_šfo
, 
block_group
,

803 
·th
);

804 ià(
»t
)

805  
»t
;

808 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
NULL
, 
fs_šfo
, 
block_group
, 
·th
, 0);

809 ià(
	`IS_ERR
(
šfo
))

810  
	`PTR_ERR
(
šfo
);

811 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

812 
	`bŒfs_»Ëa£_·th
(
·th
);

814 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

815  
	`modify_ä“_¥aû_b™m­
(
Œªs
, 
fs_šfo
, 
block_group
,

816 
·th
, 
¡¬t
, 
size
, 1);

818  
	`»move_ä“_¥aû_ex‹Á
(
Œªs
, 
fs_šfo
, 
block_group
,

819 
·th
, 
¡¬t
, 
size
);

821 
	}
}

823 
	$»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

824 
bŒfs_fs_šfo
 *
fs_šfo
,

825 
u64
 
¡¬t
, u64 
size
)

827 
bŒfs_block_group_ÿche
 *
block_group
;

828 
bŒfs_·th
 *
·th
;

829 
»t
;

831 ià(!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

834 
·th
 = 
	`bŒfs_®loc_·th
();

835 ià(!
·th
) {

836 
»t
 = -
ENOMEM
;

837 
out
;

840 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

841 ià(!
block_group
) {

842 
	`ASSERT
(0);

843 
»t
 = -
ENOENT
;

844 
out
;

847 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

848 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
,

849 
¡¬t
, 
size
);

850 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

852 
	`bŒfs_put_block_group
(
block_group
);

853 
out
:

854 
	`bŒfs_ä“_·th
(
·th
);

855 ià(
»t
)

856 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

857  
»t
;

858 
	}
}

860 
	$add_ä“_¥aû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

861 
bŒfs_fs_šfo
 *
fs_šfo
,

862 
bŒfs_block_group_ÿche
 *
block_group
,

863 
bŒfs_·th
 *
·th
,

864 
u64
 
¡¬t
, u64 
size
)

866 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

867 
bŒfs_key
 
key
, 
Ãw_key
;

868 
u64
 
found_¡¬t
, 
found_’d
;

869 
u64
 
’d
 = 
¡¬t
 + 
size
;

870 
Ãw_ex‹Ás
 = 1;

871 
»t
;

891 
Ãw_key
.
objeùid
 = 
¡¬t
;

892 
Ãw_key
.
ty³
 = 
BTRFS_FREE_SPACE_EXTENT_KEY
;

893 
Ãw_key
.
off£t
 = 
size
;

896 ià(
¡¬t
 =ð
block_group
->
key
.
objeùid
)

897 
right
;

898 
key
.
objeùid
 = 
¡¬t
 - 1;

899 
key
.
ty³
 = (
u8
)-1;

900 
key
.
off£t
 = (
u64
)-1;

902 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

903 ià(
»t
)

904 
out
;

906 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

908 ià(
key
.
ty³
 !ð
BTRFS_FREE_SPACE_EXTENT_KEY
) {

909 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
);

910 
	`bŒfs_»Ëa£_·th
(
·th
);

911 
right
;

914 
found_¡¬t
 = 
key
.
objeùid
;

915 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

916 
	`ASSERT
(
found_¡¬t
 >ð
block_group
->
key
.
objeùid
 &&

917 
found_’d
 > 
block_group
->
key
.
objeùid
);

918 
	`ASSERT
(
found_¡¬t
 < 
¡¬t
 && 
found_’d
 <= start);

924 ià(
found_’d
 =ð
¡¬t
) {

925 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

926 ià(
»t
)

927 
out
;

928 
Ãw_key
.
objeùid
 = 
found_¡¬t
;

929 
Ãw_key
.
off£t
 +ð
key
.offset;

930 
Ãw_ex‹Ás
--;

932 
	`bŒfs_»Ëa£_·th
(
·th
);

934 
right
:

936 ià(
’d
 =ð
block_group
->
key
.
objeùid
 + block_group->key.
off£t
)

937 
š£¹
;

938 
key
.
objeùid
 = 
’d
;

939 
key
.
ty³
 = (
u8
)-1;

940 
key
.
off£t
 = (
u64
)-1;

942 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

943 ià(
»t
)

944 
out
;

946 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

948 ià(
key
.
ty³
 !ð
BTRFS_FREE_SPACE_EXTENT_KEY
) {

949 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
);

950 
	`bŒfs_»Ëa£_·th
(
·th
);

951 
š£¹
;

954 
found_¡¬t
 = 
key
.
objeùid
;

955 
found_’d
 = 
key
.
objeùid
 + key.
off£t
;

956 
	`ASSERT
(
found_¡¬t
 >ð
block_group
->
key
.
objeùid
 &&

957 
found_’d
 > 
block_group
->
key
.
objeùid
);

958 
	`ASSERT
((
found_¡¬t
 < 
¡¬t
 && 
found_’d
 <= start) ||

959 (
found_¡¬t
 >ð
’d
 && 
found_’d
 >ƒnd));

965 ià(
found_¡¬t
 =ð
’d
) {

966 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

967 ià(
»t
)

968 
out
;

969 
Ãw_key
.
off£t
 +ð
key
.offset;

970 
Ãw_ex‹Ás
--;

972 
	`bŒfs_»Ëa£_·th
(
·th
);

974 
š£¹
:

976 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
Ãw_key
, 0);

977 ià(
»t
)

978 
out
;

980 
	`bŒfs_»Ëa£_·th
(
·th
);

981 
»t
 = 
	`upd©e_ä“_¥aû_ex‹Á_couÁ
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
,

982 
Ãw_ex‹Ás
);

984 
out
:

985  
»t
;

986 
	}
}

988 
	$__add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

989 
bŒfs_fs_šfo
 *
fs_šfo
,

990 
bŒfs_block_group_ÿche
 *
block_group
,

991 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
)

993 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

994 
u32
 
æags
;

995 
»t
;

997 ià(
block_group
->
Ãeds_ä“_¥aû
) {

998 
»t
 = 
	`__add_block_group_ä“_¥aû
(
Œªs
, 
fs_šfo
, 
block_group
,

999 
·th
);

1000 ià(
»t
)

1001  
»t
;

1004 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
NULL
, 
fs_šfo
, 
block_group
, 
·th
, 0);

1005 ià(
	`IS_ERR
(
šfo
))

1006  
	`PTR_ERR
(
šfo
);

1007 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

1008 
	`bŒfs_»Ëa£_·th
(
·th
);

1010 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

1011  
	`modify_ä“_¥aû_b™m­
(
Œªs
, 
fs_šfo
, 
block_group
,

1012 
·th
, 
¡¬t
, 
size
, 0);

1014  
	`add_ä“_¥aû_ex‹Á
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
,

1015 
¡¬t
, 
size
);

1017 
	}
}

1019 
	$add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1020 
bŒfs_fs_šfo
 *
fs_šfo
,

1021 
u64
 
¡¬t
, u64 
size
)

1023 
bŒfs_block_group_ÿche
 *
block_group
;

1024 
bŒfs_·th
 *
·th
;

1025 
»t
;

1027 ià(!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

1030 
·th
 = 
	`bŒfs_®loc_·th
();

1031 ià(!
·th
) {

1032 
»t
 = -
ENOMEM
;

1033 
out
;

1036 
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

1037 ià(!
block_group
) {

1038 
	`ASSERT
(0);

1039 
»t
 = -
ENOENT
;

1040 
out
;

1043 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

1044 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
, 
¡¬t
,

1045 
size
);

1046 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

1048 
	`bŒfs_put_block_group
(
block_group
);

1049 
out
:

1050 
	`bŒfs_ä“_·th
(
·th
);

1051 ià(
»t
)

1052 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1053  
»t
;

1054 
	}
}

1061 
	$pÝuÏ‹_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1062 
bŒfs_fs_šfo
 *
fs_šfo
,

1063 
bŒfs_block_group_ÿche
 *
block_group
)

1065 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

1066 
bŒfs_·th
 *
·th
, *
·th2
;

1067 
bŒfs_key
 
key
;

1068 
u64
 
¡¬t
, 
’d
;

1069 
»t
;

1071 
·th
 = 
	`bŒfs_®loc_·th
();

1072 ià(!
·th
)

1073  -
ENOMEM
;

1074 
·th
->
»ada
 = 1;

1076 
·th2
 = 
	`bŒfs_®loc_·th
();

1077 ià(!
·th2
) {

1078 
	`bŒfs_ä“_·th
(
·th
);

1079  -
ENOMEM
;

1082 
»t
 = 
	`add_Ãw_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th2
);

1083 ià(
»t
)

1084 
out
;

1086 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

1095 
key
.
objeùid
 = 
block_group
->key.objectid;

1096 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

1097 
key
.
off£t
 = 0;

1099 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
ex‹Á_roÙ
, &
key
, 
·th
, 1, 0);

1100 ià(
»t
 < 0)

1101 
out_locked
;

1102 
	`ASSERT
(
»t
 == 0);

1104 
¡¬t
 = 
block_group
->
key
.
objeùid
;

1105 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

1107 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1109 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 ||

1110 
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
) {

1111 ià(
key
.
objeùid
 >ð
’d
)

1114 ià(
¡¬t
 < 
key
.
objeùid
) {

1115 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
,

1116 
block_group
,

1117 
·th2
, 
¡¬t
,

1118 
key
.
objeùid
 -

1119 
¡¬t
);

1120 ià(
»t
)

1121 
out_locked
;

1123 
¡¬t
 = 
key
.
objeùid
;

1124 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

1125 
¡¬t
 +ð
fs_šfo
->
nodesize
;

1127 
¡¬t
 +ð
key
.
off£t
;

1128 } ià(
key
.
ty³
 =ð
BTRFS_BLOCK_GROUP_ITEM_KEY
) {

1129 ià(
key
.
objeùid
 !ð
block_group
->key.objectid)

1133 
»t
 = 
	`bŒfs_Ãxt_™em
(
ex‹Á_roÙ
, 
·th
);

1134 ià(
»t
 < 0)

1135 
out_locked
;

1136 ià(
»t
)

1139 ià(
¡¬t
 < 
’d
) {

1140 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
block_group
,

1141 
·th2
, 
¡¬t
, 
’d
 - start);

1142 ià(
»t
)

1143 
out_locked
;

1146 
»t
 = 0;

1147 
out_locked
:

1148 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

1149 
out
:

1150 
	`bŒfs_ä“_·th
(
·th2
);

1151 
	`bŒfs_ä“_·th
(
·th
);

1152  
»t
;

1153 
	}
}

1155 
	$bŒfs_ü—‹_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

1157 
bŒfs_Œªs_hªdË
 *
Œªs
;

1158 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1159 
bŒfs_roÙ
 *
ä“_¥aû_roÙ
;

1160 
bŒfs_block_group_ÿche
 *
block_group
;

1161 
rb_node
 *
node
;

1162 
»t
;

1164 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

1165 ià(
	`IS_ERR
(
Œªs
))

1166  
	`PTR_ERR
(
Œªs
);

1168 
	`£t_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1169 
ä“_¥aû_roÙ
 = 
	`bŒfs_ü—‹_Œ“
(
Œªs
, 
fs_šfo
,

1170 
BTRFS_FREE_SPACE_TREE_OBJECTID
);

1171 ià(
	`IS_ERR
(
ä“_¥aû_roÙ
)) {

1172 
»t
 = 
	`PTR_ERR
(
ä“_¥aû_roÙ
);

1173 
abÜt
;

1175 
fs_šfo
->
ä“_¥aû_roÙ
 = free_space_root;

1177 
node
 = 
	`rb_fœ¡
(&
fs_šfo
->
block_group_ÿche_Œ“
);

1178 
node
) {

1179 
block_group
 = 
	`rb_’Œy
(
node
, 
bŒfs_block_group_ÿche
,

1180 
ÿche_node
);

1181 
»t
 = 
	`pÝuÏ‹_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
block_group
);

1182 ià(
»t
)

1183 
abÜt
;

1184 
node
 = 
	`rb_Ãxt
(node);

1187 
	`bŒfs_£t_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
);

1188 
	`bŒfs_£t_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
);

1189 
	`þ—r_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1191  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1193 
abÜt
:

1194 
	`þ—r_b™
(
BTRFS_FS_CREATING_FREE_SPACE_TREE
, &
fs_šfo
->
æags
);

1195 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1196 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1197  
»t
;

1198 
	}
}

1200 
	$þ—r_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1201 
bŒfs_roÙ
 *
roÙ
)

1203 
bŒfs_·th
 *
·th
;

1204 
bŒfs_key
 
key
;

1205 
Ä
;

1206 
»t
;

1208 
·th
 = 
	`bŒfs_®loc_·th
();

1209 ià(!
·th
)

1210  -
ENOMEM
;

1212 
·th
->
Ëave_¥šnšg
 = 1;

1214 
key
.
objeùid
 = 0;

1215 
key
.
ty³
 = 0;

1216 
key
.
off£t
 = 0;

1219 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1220 ià(
»t
 < 0)

1221 
out
;

1223 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

1224 ià(!
Ä
)

1227 
·th
->
¦Ùs
[0] = 0;

1228 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 0, 
Ä
);

1229 ià(
»t
)

1230 
out
;

1232 
	`bŒfs_»Ëa£_·th
(
·th
);

1235 
»t
 = 0;

1236 
out
:

1237 
	`bŒfs_ä“_·th
(
·th
);

1238  
»t
;

1239 
	}
}

1241 
	$bŒfs_þ—r_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

1243 
bŒfs_Œªs_hªdË
 *
Œªs
;

1244 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1245 
bŒfs_roÙ
 *
ä“_¥aû_roÙ
 = 
fs_šfo
->free_space_root;

1246 
»t
;

1248 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 0);

1249 ià(
	`IS_ERR
(
Œªs
))

1250  
	`PTR_ERR
(
Œªs
);

1252 
	`bŒfs_þ—r_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
);

1253 
	`bŒfs_þ—r_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE_VALID
);

1254 
fs_šfo
->
ä“_¥aû_roÙ
 = 
NULL
;

1256 
»t
 = 
	`þ—r_ä“_¥aû_Œ“
(
Œªs
, 
ä“_¥aû_roÙ
);

1257 ià(
»t
)

1258 
abÜt
;

1260 
»t
 = 
	`bŒfs_d–_roÙ
(
Œªs
, 
fs_šfo
, &
ä“_¥aû_roÙ
->
roÙ_key
);

1261 ià(
»t
)

1262 
abÜt
;

1264 
	`li¡_d–
(&
ä“_¥aû_roÙ
->
dœty_li¡
);

1266 
	`bŒfs_Œ“_lock
(
ä“_¥aû_roÙ
->
node
);

1267 
	`þ—n_Œ“_block
(
fs_šfo
, 
ä“_¥aû_roÙ
->
node
);

1268 
	`bŒfs_Œ“_uÆock
(
ä“_¥aû_roÙ
->
node
);

1269 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
ä“_¥aû_roÙ
, f»e_¥aû_roÙ->
node
,

1272 
	`ä“_ex‹Á_bufãr
(
ä“_¥aû_roÙ
->
node
);

1273 
	`ä“_ex‹Á_bufãr
(
ä“_¥aû_roÙ
->
comm™_roÙ
);

1274 
	`kä“
(
ä“_¥aû_roÙ
);

1276  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1278 
abÜt
:

1279 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1280 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1281  
»t
;

1282 
	}
}

1284 
	$__add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1285 
bŒfs_fs_šfo
 *
fs_šfo
,

1286 
bŒfs_block_group_ÿche
 *
block_group
,

1287 
bŒfs_·th
 *
·th
)

1289 
u64
 
¡¬t
, 
’d
;

1290 
»t
;

1292 
¡¬t
 = 
block_group
->
key
.
objeùid
;

1293 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

1295 
block_group
->
Ãeds_ä“_¥aû
 = 0;

1297 
»t
 = 
	`add_Ãw_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
);

1298 ià(
»t
)

1299  
»t
;

1301  
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
,

1302 
block_group
->
key
.
objeùid
,

1303 
block_group
->
key
.
off£t
);

1304 
	}
}

1306 
	$add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1307 
bŒfs_fs_šfo
 *
fs_šfo
,

1308 
bŒfs_block_group_ÿche
 *
block_group
)

1310 
bŒfs_·th
 *
·th
 = 
NULL
;

1311 
»t
 = 0;

1313 ià(!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

1316 
	`mu‹x_lock
(&
block_group
->
ä“_¥aû_lock
);

1317 ià(!
block_group
->
Ãeds_ä“_¥aû
)

1318 
out
;

1320 
·th
 = 
	`bŒfs_®loc_·th
();

1321 ià(!
·th
) {

1322 
»t
 = -
ENOMEM
;

1323 
out
;

1326 
»t
 = 
	`__add_block_group_ä“_¥aû
(
Œªs
, 
fs_šfo
, 
block_group
, 
·th
);

1328 
out
:

1329 
	`bŒfs_ä“_·th
(
·th
);

1330 
	`mu‹x_uÆock
(&
block_group
->
ä“_¥aû_lock
);

1331 ià(
»t
)

1332 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1333  
»t
;

1334 
	}
}

1336 
	$»move_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1337 
bŒfs_fs_šfo
 *
fs_šfo
,

1338 
bŒfs_block_group_ÿche
 *
block_group
)

1340 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

1341 
bŒfs_·th
 *
·th
;

1342 
bŒfs_key
 
key
, 
found_key
;

1343 
ex‹Á_bufãr
 *
Ëaf
;

1344 
u64
 
¡¬t
, 
’d
;

1345 
dÚe
 = 0, 
Ä
;

1346 
»t
;

1348 ià(!
	`bŒfs_fs_com·t_ro
(
fs_šfo
, 
FREE_SPACE_TREE
))

1351 ià(
block_group
->
Ãeds_ä“_¥aû
) {

1356 
·th
 = 
	`bŒfs_®loc_·th
();

1357 ià(!
·th
) {

1358 
»t
 = -
ENOMEM
;

1359 
out
;

1362 
¡¬t
 = 
block_group
->
key
.
objeùid
;

1363 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

1365 
key
.
objeùid
 = 
’d
 - 1;

1366 
key
.
ty³
 = (
u8
)-1;

1367 
key
.
off£t
 = (
u64
)-1;

1369 !
dÚe
) {

1370 
»t
 = 
	`bŒfs_£¬ch_´ev_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1371 ià(
»t
)

1372 
out
;

1374 
Ëaf
 = 
·th
->
nodes
[0];

1375 
Ä
 = 0;

1376 
·th
->
¦Ùs
[0]++;

1377 
·th
->
¦Ùs
[0] > 0) {

1378 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0] - 1);

1380 ià(
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
) {

1381 
	`ASSERT
(
found_key
.
objeùid
 =ð
block_group
->
key
.objectid);

1382 
	`ASSERT
(
found_key
.
off£t
 =ð
block_group
->
key
.offset);

1383 
dÚe
 = 1;

1384 
Ä
++;

1385 
·th
->
¦Ùs
[0]--;

1387 } ià(
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_EXTENT_KEY
 ||

1388 
found_key
.
ty³
 =ð
BTRFS_FREE_SPACE_BITMAP_KEY
) {

1389 
	`ASSERT
(
found_key
.
objeùid
 >ð
¡¬t
);

1390 
	`ASSERT
(
found_key
.
objeùid
 < 
’d
);

1391 
	`ASSERT
(
found_key
.
objeùid
 + found_key.
off£t
 <ð
’d
);

1392 
Ä
++;

1393 
·th
->
¦Ùs
[0]--;

1395 
	`ASSERT
(0);

1399 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,…©h->
¦Ùs
[0], 
Ä
);

1400 ià(
»t
)

1401 
out
;

1402 
	`bŒfs_»Ëa£_·th
(
·th
);

1405 
»t
 = 0;

1406 
out
:

1407 
	`bŒfs_ä“_·th
(
·th
);

1408 ià(
»t
)

1409 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1410  
»t
;

1411 
	}
}

1413 
	$lßd_ä“_¥aû_b™m­s
(
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
,

1414 
bŒfs_·th
 *
·th
,

1415 
u32
 
ex³ùed_ex‹Á_couÁ
)

1417 
bŒfs_block_group_ÿche
 *
block_group
;

1418 
bŒfs_fs_šfo
 *
fs_šfo
;

1419 
bŒfs_roÙ
 *
roÙ
;

1420 
bŒfs_key
 
key
;

1421 
´ev_b™
 = 0, 
b™
;

1423 
u64
 
ex‹Á_¡¬t
 = 0;

1424 
u64
 
’d
, 
off£t
;

1425 
u64
 
tÙ®_found
 = 0;

1426 
u32
 
ex‹Á_couÁ
 = 0;

1427 
»t
;

1429 
block_group
 = 
ÿchšg_ùl
->block_group;

1430 
fs_šfo
 = 
block_group
->fs_info;

1431 
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

1433 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

1436 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

1437 ià(
»t
 < 0)

1438 
out
;

1439 ià(
»t
)

1442 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1444 ià(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
)

1447 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_BITMAP_KEY
);

1448 
	`ASSERT
(
key
.
objeùid
 < 
’d
 && key.objeùid + key.
off£t
 <=ƒnd);

1450 
ÿchšg_ùl
->
´og»ss
 = 
key
.
objeùid
;

1452 
off£t
 = 
key
.
objeùid
;

1453 
off£t
 < 
key
.
objeùid
 + key.offset) {

1454 
b™
 = 
	`ä“_¥aû_‹¡_b™
(
block_group
, 
·th
, 
off£t
);

1455 ià(
´ev_b™
 =ð0 && 
b™
 == 1) {

1456 
ex‹Á_¡¬t
 = 
off£t
;

1457 } ià(
´ev_b™
 =ð1 && 
b™
 == 0) {

1458 
tÙ®_found
 +ð
	`add_Ãw_ä“_¥aû
(
block_group
,

1459 
fs_šfo
,

1460 
ex‹Á_¡¬t
,

1461 
off£t
);

1462 ià(
tÙ®_found
 > 
CACHING_CTL_WAKE_UP
) {

1463 
tÙ®_found
 = 0;

1464 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

1466 
ex‹Á_couÁ
++;

1468 
´ev_b™
 = 
b™
;

1469 
off£t
 +ð
fs_šfo
->
£ùÜsize
;

1472 ià(
´ev_b™
 == 1) {

1473 
tÙ®_found
 +ð
	`add_Ãw_ä“_¥aû
(
block_group
, 
fs_šfo
,

1474 
ex‹Á_¡¬t
, 
’d
);

1475 
ex‹Á_couÁ
++;

1478 ià(
ex‹Á_couÁ
 !ð
ex³ùed_ex‹Á_couÁ
) {

1479 
	`bŒfs_”r
(
fs_šfo
,

1481 
block_group
->
key
.
objeùid
, 
ex‹Á_couÁ
,

1482 
ex³ùed_ex‹Á_couÁ
);

1483 
	`ASSERT
(0);

1484 
»t
 = -
EIO
;

1485 
out
;

1488 
ÿchšg_ùl
->
´og»ss
 = (
u64
)-1;

1490 
»t
 = 0;

1491 
out
:

1492  
»t
;

1493 
	}
}

1495 
	$lßd_ä“_¥aû_ex‹Ás
(
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
,

1496 
bŒfs_·th
 *
·th
,

1497 
u32
 
ex³ùed_ex‹Á_couÁ
)

1499 
bŒfs_block_group_ÿche
 *
block_group
;

1500 
bŒfs_fs_šfo
 *
fs_šfo
;

1501 
bŒfs_roÙ
 *
roÙ
;

1502 
bŒfs_key
 
key
;

1503 
u64
 
’d
;

1504 
u64
 
tÙ®_found
 = 0;

1505 
u32
 
ex‹Á_couÁ
 = 0;

1506 
»t
;

1508 
block_group
 = 
ÿchšg_ùl
->block_group;

1509 
fs_šfo
 = 
block_group
->fs_info;

1510 
roÙ
 = 
fs_šfo
->
ä“_¥aû_roÙ
;

1512 
’d
 = 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
;

1515 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

1516 ià(
»t
 < 0)

1517 
out
;

1518 ià(
»t
)

1521 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1523 ià(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_INFO_KEY
)

1526 
	`ASSERT
(
key
.
ty³
 =ð
BTRFS_FREE_SPACE_EXTENT_KEY
);

1527 
	`ASSERT
(
key
.
objeùid
 < 
’d
 && key.objeùid + key.
off£t
 <=ƒnd);

1529 
ÿchšg_ùl
->
´og»ss
 = 
key
.
objeùid
;

1531 
tÙ®_found
 +ð
	`add_Ãw_ä“_¥aû
(
block_group
, 
fs_šfo
,

1532 
key
.
objeùid
,

1533 
key
.
objeùid
 + key.
off£t
);

1534 ià(
tÙ®_found
 > 
CACHING_CTL_WAKE_UP
) {

1535 
tÙ®_found
 = 0;

1536 
	`wake_up
(&
ÿchšg_ùl
->
wa™
);

1538 
ex‹Á_couÁ
++;

1541 ià(
ex‹Á_couÁ
 !ð
ex³ùed_ex‹Á_couÁ
) {

1542 
	`bŒfs_”r
(
fs_šfo
,

1544 
block_group
->
key
.
objeùid
, 
ex‹Á_couÁ
,

1545 
ex³ùed_ex‹Á_couÁ
);

1546 
	`ASSERT
(0);

1547 
»t
 = -
EIO
;

1548 
out
;

1551 
ÿchšg_ùl
->
´og»ss
 = (
u64
)-1;

1553 
»t
 = 0;

1554 
out
:

1555  
»t
;

1556 
	}
}

1558 
	$lßd_ä“_¥aû_Œ“
(
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
)

1560 
bŒfs_block_group_ÿche
 *
block_group
;

1561 
bŒfs_fs_šfo
 *
fs_šfo
;

1562 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

1563 
bŒfs_·th
 *
·th
;

1564 
u32
 
ex‹Á_couÁ
, 
æags
;

1565 
»t
;

1567 
block_group
 = 
ÿchšg_ùl
->block_group;

1568 
fs_šfo
 = 
block_group
->fs_info;

1570 
·th
 = 
	`bŒfs_®loc_·th
();

1571 ià(!
·th
)

1572  -
ENOMEM
;

1578 
·th
->
sk_lockšg
 = 1;

1579 
·th
->
£¬ch_comm™_roÙ
 = 1;

1580 
·th
->
»ada
 = 1;

1582 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
NULL
, 
fs_šfo
, 
block_group
, 
·th
, 0);

1583 ià(
	`IS_ERR
(
šfo
)) {

1584 
»t
 = 
	`PTR_ERR
(
šfo
);

1585 
out
;

1587 
ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
);

1588 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

1595 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
)

1596 
»t
 = 
	`lßd_ä“_¥aû_b™m­s
(
ÿchšg_ùl
, 
·th
, 
ex‹Á_couÁ
);

1598 
»t
 = 
	`lßd_ä“_¥aû_ex‹Ás
(
ÿchšg_ùl
, 
·th
, 
ex‹Á_couÁ
);

1600 
out
:

1601 
	`bŒfs_ä“_·th
(
·th
);

1602  
»t
;

1603 
	}
}

	@free-space-tree.h

19 #iâdeà
__BTRFS_FREE_SPACE_TREE


20 
	#__BTRFS_FREE_SPACE_TREE


	)

27 
	#BTRFS_FREE_SPACE_BITMAP_SIZE
 256

	)

28 
	#BTRFS_FREE_SPACE_BITMAP_BITS
 (
BTRFS_FREE_SPACE_BITMAP_SIZE
 * 
BITS_PER_BYTE
)

	)

30 
£t_ä“_¥aû_Œ“_th»shÞds
(
bŒfs_block_group_ÿche
 *
block_group
);

31 
bŒfs_ü—‹_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

32 
bŒfs_þ—r_ä“_¥aû_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

33 
lßd_ä“_¥aû_Œ“
(
bŒfs_ÿchšg_cÚŒÞ
 *
ÿchšg_ùl
);

34 
add_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

35 
bŒfs_fs_šfo
 *
fs_šfo
,

36 
bŒfs_block_group_ÿche
 *
block_group
);

37 
»move_block_group_ä“_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

38 
bŒfs_fs_šfo
 *
fs_šfo
,

39 
bŒfs_block_group_ÿche
 *
block_group
);

40 
add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

41 
bŒfs_fs_šfo
 *
fs_šfo
,

42 
u64
 
¡¬t
, u64 
size
);

43 
»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

44 
bŒfs_fs_šfo
 *
fs_šfo
,

45 
u64
 
¡¬t
, u64 
size
);

47 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


48 
bŒfs_ä“_¥aû_šfo
 *

49 
£¬ch_ä“_¥aû_šfo
(
bŒfs_Œªs_hªdË
 *
Œªs
,

50 
bŒfs_fs_šfo
 *
fs_šfo
,

51 
bŒfs_block_group_ÿche
 *
block_group
,

52 
bŒfs_·th
 *
·th
, 
cow
);

53 
__add_to_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

54 
bŒfs_fs_šfo
 *
fs_šfo
,

55 
bŒfs_block_group_ÿche
 *
block_group
,

56 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
);

57 
__»move_äom_ä“_¥aû_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

58 
bŒfs_fs_šfo
 *
fs_šfo
,

59 
bŒfs_block_group_ÿche
 *
block_group
,

60 
bŒfs_·th
 *
·th
, 
u64
 
¡¬t
, u64 
size
);

61 
cÚv”t_ä“_¥aû_to_b™m­s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

62 
bŒfs_fs_šfo
 *
fs_šfo
,

63 
bŒfs_block_group_ÿche
 *
block_group
,

64 
bŒfs_·th
 *
·th
);

65 
cÚv”t_ä“_¥aû_to_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

66 
bŒfs_fs_šfo
 *
fs_šfo
,

67 
bŒfs_block_group_ÿche
 *
block_group
,

68 
bŒfs_·th
 *
·th
);

69 
ä“_¥aû_‹¡_b™
(
bŒfs_block_group_ÿche
 *
block_group
,

70 
bŒfs_·th
 *
·th
, 
u64
 
off£t
);

	@hash.c

14 
	~<üy±o/hash.h
>

15 
	~<lšux/”r.h
>

16 
	~"hash.h
"

18 
üy±o_shash
 *
	gtfm
;

20 
__š™
 
	$bŒfs_hash_š™
()

22 
tfm
 = 
	`üy±o_®loc_shash
("crc32c", 0, 0);

24  
	`PTR_ERR_OR_ZERO
(
tfm
);

25 
	}
}

27 cÚ¡ * 
	$bŒfs_üc32c_im¶
()

29  
	`üy±o_tfm_®g_driv”_Çme
(
	`üy±o_shash_tfm
(
tfm
));

30 
	}
}

32 
	$bŒfs_hash_ex™
()

34 
	`üy±o_ä“_shash
(
tfm
);

35 
	}
}

37 
u32
 
	$bŒfs_üc32c
(
u32
 
üc
, cÚ¡ *
add»ss
, 
Ëngth
)

39 
	`SHASH_DESC_ON_STACK
(
shash
, 
tfm
);

40 
u32
 *
ùx
 = (u32 *)
	`shash_desc_ùx
(
shash
);

41 
u32
 
»tv®
;

42 
”r
;

44 
shash
->
tfm
 =fm;

45 
shash
->
æags
 = 0;

46 *
ùx
 = 
üc
;

48 
”r
 = 
	`üy±o_shash_upd©e
(
shash
, 
add»ss
, 
Ëngth
);

49 
	`BUG_ON
(
”r
);

51 
»tv®
 = *
ùx
;

52 
	`b¬r›r_d©a
(
ùx
);

53  
»tv®
;

54 
	}
}

	@hash.h

19 #iâdeà
__HASH__


20 
	#__HASH__


	)

22 
__š™
 
bŒfs_hash_š™
();

24 
bŒfs_hash_ex™
();

25 cÚ¡ * 
bŒfs_üc32c_im¶
();

27 
u32
 
bŒfs_üc32c
(u32 
üc
, cÚ¡ *
add»ss
, 
Ëngth
);

29 
šlše
 
u64
 
	$bŒfs_Çme_hash
(cÚ¡ *
Çme
, 
Ën
)

31  
	`bŒfs_üc32c
((
u32
)~1, 
Çme
, 
Ën
);

32 
	}
}

37 
šlše
 
u64
 
	$bŒfs_exŒef_hash
(
u64
 
·»Á_objeùid
, cÚ¡ *
Çme
,

38 
Ën
)

40  (
u64
è
	`bŒfs_üc32c
(
·»Á_objeùid
, 
Çme
, 
Ën
);

41 
	}
}

	@inode-item.c

19 
	~"ù»e.h
"

20 
	~"disk-io.h
"

21 
	~"hash.h
"

22 
	~"Œª§ùiÚ.h
"

23 
	~"´št-Œ“.h
"

25 
	$fšd_Çme_š_back»f
(
bŒfs_·th
 *
·th
, cÚ¡ *
Çme
,

26 
Çme_Ën
, 
bŒfs_šode_»f
 **
»f_»t
)

28 
ex‹Á_bufãr
 *
Ëaf
;

29 
bŒfs_šode_»f
 *
»f
;

30 
±r
;

31 
Çme_±r
;

32 
u32
 
™em_size
;

33 
u32
 
cur_off£t
 = 0;

34 
Ën
;

36 
Ëaf
 = 
·th
->
nodes
[0];

37 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

38 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

39 
cur_off£t
 < 
™em_size
) {

40 
»f
 = (
bŒfs_šode_»f
 *)(
±r
 + 
cur_off£t
);

41 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
, 
»f
);

42 
Çme_±r
 = ()(
»f
 + 1);

43 
cur_off£t
 +ð
Ën
 + (*
»f
);

44 ià(
Ën
 !ð
Çme_Ën
)

46 ià(
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
) == 0) {

47 *
»f_»t
 = 
»f
;

52 
	}
}

54 
	$bŒfs_fšd_Çme_š_ext_back»f
(
bŒfs_·th
 *
·th
, 
u64
 
»f_objeùid
,

55 cÚ¡ *
Çme
, 
Çme_Ën
,

56 
bŒfs_šode_exŒef
 **
exŒef_»t
)

58 
ex‹Á_bufãr
 *
Ëaf
;

59 
bŒfs_šode_exŒef
 *
exŒef
;

60 
±r
;

61 
Çme_±r
;

62 
u32
 
™em_size
;

63 
u32
 
cur_off£t
 = 0;

64 
»f_Çme_Ën
;

66 
Ëaf
 = 
·th
->
nodes
[0];

67 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

68 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

76 
cur_off£t
 < 
™em_size
) {

77 
exŒef
 = (
bŒfs_šode_exŒef
 *è(
±r
 + 
cur_off£t
);

78 
Çme_±r
 = ()(&
exŒef
->
Çme
);

79 
»f_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

81 ià(
»f_Çme_Ën
 =ð
Çme_Ën
 &&

82 
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
, 
exŒef
è=ð
»f_objeùid
 &&

83 (
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
Çme_±r
, 
Çme_Ën
) == 0)) {

84 ià(
exŒef_»t
)

85 *
exŒef_»t
 = 
exŒef
;

89 
cur_off£t
 +ð
»f_Çme_Ën
 + (*
exŒef
);

92 
	}
}

95 
bŒfs_šode_exŒef
 *

96 
	$bŒfs_lookup_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

97 
bŒfs_roÙ
 *
roÙ
,

98 
bŒfs_·th
 *
·th
,

99 cÚ¡ *
Çme
, 
Çme_Ën
,

100 
u64
 
šode_objeùid
, u64 
»f_objeùid
, 
šs_Ën
,

101 
cow
)

103 
»t
;

104 
bŒfs_key
 
key
;

105 
bŒfs_šode_exŒef
 *
exŒef
;

107 
key
.
objeùid
 = 
šode_objeùid
;

108 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

109 
key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
»f_objeùid
, 
Çme
, 
Çme_Ën
);

111 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 
šs_Ën
, 
cow
);

112 ià(
»t
 < 0)

113  
	`ERR_PTR
(
»t
);

114 ià(
»t
 > 0)

115  
NULL
;

116 ià(!
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
, 
»f_objeùid
, 
Çme
, 
Çme_Ën
, &
exŒef
))

117  
NULL
;

118  
exŒef
;

119 
	}
}

121 
	$bŒfs_d–_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

122 
bŒfs_roÙ
 *
roÙ
,

123 cÚ¡ *
Çme
, 
Çme_Ën
,

124 
u64
 
šode_objeùid
, u64 
»f_objeùid
,

125 
u64
 *
šdex
)

127 
bŒfs_·th
 *
·th
;

128 
bŒfs_key
 
key
;

129 
bŒfs_šode_exŒef
 *
exŒef
;

130 
ex‹Á_bufãr
 *
Ëaf
;

131 
»t
;

132 
d–_Ën
 = 
Çme_Ën
 + (*
exŒef
);

133 
±r
;

134 
™em_¡¬t
;

135 
u32
 
™em_size
;

137 
key
.
objeùid
 = 
šode_objeùid
;

138 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

139 
key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
»f_objeùid
, 
Çme
, 
Çme_Ën
);

141 
·th
 = 
	`bŒfs_®loc_·th
();

142 ià(!
·th
)

143  -
ENOMEM
;

145 
·th
->
Ëave_¥šnšg
 = 1;

147 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

148 ià(
»t
 > 0)

149 
»t
 = -
ENOENT
;

150 ià(
»t
 < 0)

151 
out
;

158 ià(!
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
, 
»f_objeùid
,

159 
Çme
, 
Çme_Ën
, &
exŒef
)) {

160 
	`bŒfs_hªdË_fs_”rÜ
(
roÙ
->
fs_šfo
, -
ENOENT
, 
NULL
);

161 
»t
 = -
EROFS
;

162 
out
;

165 
Ëaf
 = 
·th
->
nodes
[0];

166 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

167 ià(
šdex
)

168 *
šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
Ëaf
, 
exŒef
);

170 ià(
d–_Ën
 =ð
™em_size
) {

175 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

176 
out
;

179 
±r
 = ()
exŒef
;

180 
™em_¡¬t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

182 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
d–_Ën
,

183 
™em_size
 - (
±r
 + 
d–_Ën
 - 
™em_¡¬t
));

185 
	`bŒfs_Œunÿ‹_™em
(
roÙ
->
fs_šfo
, 
·th
, 
™em_size
 - 
d–_Ën
, 1);

187 
out
:

188 
	`bŒfs_ä“_·th
(
·th
);

190  
»t
;

191 
	}
}

193 
	$bŒfs_d–_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

194 
bŒfs_roÙ
 *
roÙ
,

195 cÚ¡ *
Çme
, 
Çme_Ën
,

196 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 *
šdex
)

198 
bŒfs_·th
 *
·th
;

199 
bŒfs_key
 
key
;

200 
bŒfs_šode_»f
 *
»f
;

201 
ex‹Á_bufãr
 *
Ëaf
;

202 
±r
;

203 
™em_¡¬t
;

204 
u32
 
™em_size
;

205 
u32
 
sub_™em_Ën
;

206 
»t
;

207 
£¬ch_ext_»fs
 = 0;

208 
d–_Ën
 = 
Çme_Ën
 + (*
»f
);

210 
key
.
objeùid
 = 
šode_objeùid
;

211 
key
.
off£t
 = 
»f_objeùid
;

212 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

214 
·th
 = 
	`bŒfs_®loc_·th
();

215 ià(!
·th
)

216  -
ENOMEM
;

218 
·th
->
Ëave_¥šnšg
 = 1;

220 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

221 ià(
»t
 > 0) {

222 
»t
 = -
ENOENT
;

223 
£¬ch_ext_»fs
 = 1;

224 
out
;

225 } ià(
»t
 < 0) {

226 
out
;

228 ià(!
	`fšd_Çme_š_back»f
(
·th
, 
Çme
, 
Çme_Ën
, &
»f
)) {

229 
»t
 = -
ENOENT
;

230 
£¬ch_ext_»fs
 = 1;

231 
out
;

233 
Ëaf
 = 
·th
->
nodes
[0];

234 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

236 ià(
šdex
)

237 *
šdex
 = 
	`bŒfs_šode_»f_šdex
(
Ëaf
, 
»f
);

239 ià(
d–_Ën
 =ð
™em_size
) {

240 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

241 
out
;

243 
±r
 = ()
»f
;

244 
sub_™em_Ën
 = 
Çme_Ën
 + (*
»f
);

245 
™em_¡¬t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

246 
	`memmove_ex‹Á_bufãr
(
Ëaf
, 
±r
,…Œ + 
sub_™em_Ën
,

247 
™em_size
 - (
±r
 + 
sub_™em_Ën
 - 
™em_¡¬t
));

248 
	`bŒfs_Œunÿ‹_™em
(
roÙ
->
fs_šfo
, 
·th
, 
™em_size
 - 
sub_™em_Ën
, 1);

249 
out
:

250 
	`bŒfs_ä“_·th
(
·th
);

252 ià(
£¬ch_ext_»fs
) {

258  
	`bŒfs_d–_šode_exŒef
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
,

259 
šode_objeùid
, 
»f_objeùid
, 
šdex
);

262  
»t
;

263 
	}
}

270 
	$bŒfs_š£¹_šode_exŒef
(
bŒfs_Œªs_hªdË
 *
Œªs
,

271 
bŒfs_roÙ
 *
roÙ
,

272 cÚ¡ *
Çme
, 
Çme_Ën
,

273 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 
šdex
)

275 
bŒfs_šode_exŒef
 *
exŒef
;

276 
»t
;

277 
šs_Ën
 = 
Çme_Ën
 + (*
exŒef
);

278 
±r
;

279 
bŒfs_·th
 *
·th
;

280 
bŒfs_key
 
key
;

281 
ex‹Á_bufãr
 *
Ëaf
;

282 
bŒfs_™em
 *
™em
;

284 
key
.
objeùid
 = 
šode_objeùid
;

285 
key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

286 
key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
»f_objeùid
, 
Çme
, 
Çme_Ën
);

288 
·th
 = 
	`bŒfs_®loc_·th
();

289 ià(!
·th
)

290  -
ENOMEM
;

292 
·th
->
Ëave_¥šnšg
 = 1;

293 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

294 
šs_Ën
);

295 ià(
»t
 =ð-
EEXIST
) {

296 ià(
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
, 
»f_objeùid
,

297 
Çme
, 
Çme_Ën
, 
NULL
))

298 
out
;

300 
	`bŒfs_ex‹nd_™em
(
roÙ
->
fs_šfo
, 
·th
, 
šs_Ën
);

301 
»t
 = 0;

303 ià(
»t
 < 0)

304 
out
;

306 
Ëaf
 = 
·th
->
nodes
[0];

307 
™em
 = 
	`bŒfs_™em_Ä
(
·th
->
¦Ùs
[0]);

308 
±r
 = ()
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], );

309 
±r
 +ð
	`bŒfs_™em_size
(
Ëaf
, 
™em
è- 
šs_Ën
;

310 
exŒef
 = (
bŒfs_šode_exŒef
 *)
±r
;

312 
	`bŒfs_£t_šode_exŒef_Çme_Ën
(
·th
->
nodes
[0], 
exŒef
, 
Çme_Ën
);

313 
	`bŒfs_£t_šode_exŒef_šdex
(
·th
->
nodes
[0], 
exŒef
, 
šdex
);

314 
	`bŒfs_£t_šode_exŒef_·»Á
(
·th
->
nodes
[0], 
exŒef
, 
»f_objeùid
);

316 
±r
 = ()&
exŒef
->
Çme
;

317 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
, 
±r
, 
Çme_Ën
);

318 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

320 
out
:

321 
	`bŒfs_ä“_·th
(
·th
);

322  
»t
;

323 
	}
}

326 
	$bŒfs_š£¹_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

327 
bŒfs_roÙ
 *
roÙ
,

328 cÚ¡ *
Çme
, 
Çme_Ën
,

329 
u64
 
šode_objeùid
, u64 
»f_objeùid
, u64 
šdex
)

331 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

332 
bŒfs_·th
 *
·th
;

333 
bŒfs_key
 
key
;

334 
bŒfs_šode_»f
 *
»f
;

335 
±r
;

336 
»t
;

337 
šs_Ën
 = 
Çme_Ën
 + (*
»f
);

339 
key
.
objeùid
 = 
šode_objeùid
;

340 
key
.
off£t
 = 
»f_objeùid
;

341 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

343 
·th
 = 
	`bŒfs_®loc_·th
();

344 ià(!
·th
)

345  -
ENOMEM
;

347 
·th
->
Ëave_¥šnšg
 = 1;

348 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 1;

349 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

350 
šs_Ën
);

351 ià(
»t
 =ð-
EEXIST
) {

352 
u32
 
Þd_size
;

354 ià(
	`fšd_Çme_š_back»f
(
·th
, 
Çme
, 
Çme_Ën
, &
»f
))

355 
out
;

357 
Þd_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

358 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, 
šs_Ën
);

359 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

360 
bŒfs_šode_»f
);

361 
»f
 = (
bŒfs_šode_»f
 *)((ìeà+ 
Þd_size
);

362 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 
Çme_Ën
);

363 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, 
šdex
);

364 
±r
 = ()(
»f
 + 1);

365 
»t
 = 0;

366 } ià(
»t
 < 0) {

367 ià(
»t
 =ð-
EOVERFLOW
) {

368 ià(
	`fšd_Çme_š_back»f
(
·th
, 
Çme
, 
Çme_Ën
, &
»f
))

369 
»t
 = -
EEXIST
;

371 
»t
 = -
EMLINK
;

373 
out
;

375 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

376 
bŒfs_šode_»f
);

377 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 
Çme_Ën
);

378 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, 
šdex
);

379 
±r
 = ()(
»f
 + 1);

381 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
, 
±r
, 
Çme_Ën
);

382 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

384 
out
:

385 
	`bŒfs_ä“_·th
(
·th
);

387 ià(
»t
 =ð-
EMLINK
) {

388 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

391 ià(
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
)

392 & 
BTRFS_FEATURE_INCOMPAT_EXTENDED_IREF
)

393 
»t
 = 
	`bŒfs_š£¹_šode_exŒef
(
Œªs
, 
roÙ
, 
Çme
,

394 
Çme_Ën
,

395 
šode_objeùid
,

396 
»f_objeùid
, 
šdex
);

399  
»t
;

400 
	}
}

402 
	$bŒfs_š£¹_em±y_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

403 
bŒfs_roÙ
 *
roÙ
,

404 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
)

406 
bŒfs_key
 
key
;

407 
»t
;

408 
key
.
objeùid
 = objectid;

409 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

410 
key
.
off£t
 = 0;

412 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

413 (
bŒfs_šode_™em
));

414  
»t
;

415 
	}
}

417 
	$bŒfs_lookup_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


418 *
roÙ
, 
bŒfs_·th
 *
·th
,

419 
bŒfs_key
 *
loÿtiÚ
, 
mod
)

421 
šs_Ën
 = 
mod
 < 0 ? -1 : 0;

422 
cow
 = 
mod
 != 0;

423 
»t
;

424 
¦Ù
;

425 
ex‹Á_bufãr
 *
Ëaf
;

426 
bŒfs_key
 
found_key
;

428 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
loÿtiÚ
, 
·th
, 
šs_Ën
, 
cow
);

429 ià(
»t
 > 0 && 
loÿtiÚ
->
ty³
 =ð
BTRFS_ROOT_ITEM_KEY
 &&

430 
loÿtiÚ
->
off£t
 =ð(
u64
)-1 && 
·th
->
¦Ùs
[0] != 0) {

431 
¦Ù
 = 
·th
->
¦Ùs
[0] - 1;

432 
Ëaf
 = 
·th
->
nodes
[0];

433 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

434 ià(
found_key
.
objeùid
 =ð
loÿtiÚ
->objectid &&

435 
found_key
.
ty³
 =ð
loÿtiÚ
->type) {

436 
·th
->
¦Ùs
[0]--;

440  
»t
;

441 
	}
}

	@inode-map.c

19 
	~<lšux/d–ay.h
>

20 
	~<lšux/kth»ad.h
>

21 
	~<lšux/·gem­.h
>

23 
	~"ù»e.h
"

24 
	~"disk-io.h
"

25 
	~"ä“-¥aû-ÿche.h
"

26 
	~"šode-m­.h
"

27 
	~"Œª§ùiÚ.h
"

29 
	$ÿchšg_kth»ad
(*
d©a
)

31 
bŒfs_roÙ
 *
roÙ
 = 
d©a
;

32 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

33 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

34 
bŒfs_key
 
key
;

35 
bŒfs_·th
 *
·th
;

36 
ex‹Á_bufãr
 *
Ëaf
;

37 
u64
 
Ï¡
 = (u64)-1;

38 
¦Ù
;

39 
»t
;

41 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
INODE_MAP_CACHE
))

44 
·th
 = 
	`bŒfs_®loc_·th
();

45 ià(!
·th
)

46  -
ENOMEM
;

49 
·th
->
sk_lockšg
 = 1;

50 
·th
->
£¬ch_comm™_roÙ
 = 1;

51 
·th
->
»ada
 = 
READA_FORWARD
;

53 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

54 
key
.
off£t
 = 0;

55 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

56 
agaš
:

58 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

60 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

61 ià(
»t
 < 0)

62 
out
;

65 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
))

66 
out
;

68 
Ëaf
 = 
·th
->
nodes
[0];

69 
¦Ù
 = 
·th
->
¦Ùs
[0];

70 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

71 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

72 ià(
»t
 < 0)

73 
out
;

74 ià(
»t
 > 0)

77 ià(
	`Ãed_»sched
() ||

78 
	`bŒfs_Œª§ùiÚ_š_comm™
(
fs_šfo
)) {

79 
Ëaf
 = 
·th
->
nodes
[0];

81 ià(
	`WARN_ON
(
	`bŒfs_h—d”_Ä™ems
(
Ëaf
) == 0))

88 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 0);

89 
	`bŒfs_»Ëa£_·th
(
·th
);

90 
roÙ
->
šo_ÿche_´og»ss
 = 
Ï¡
;

91 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

92 
	`scheduË_timeout
(1);

93 
agaš
;

98 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

100 ià(
key
.
ty³
 !ð
BTRFS_INODE_ITEM_KEY
)

101 
Ãxt
;

103 ià(
key
.
objeùid
 >ð
roÙ
->
highe¡_objeùid
)

106 ià(
Ï¡
 !ð(
u64
)-1 &&†a¡ + 1 !ð
key
.
objeùid
) {

107 
	`__bŒfs_add_ä“_¥aû
(
fs_šfo
, 
ùl
, 
Ï¡
 + 1,

108 
key
.
objeùid
 - 
Ï¡
 - 1);

109 
	`wake_up
(&
roÙ
->
šo_ÿche_wa™
);

112 
Ï¡
 = 
key
.
objeùid
;

113 
Ãxt
:

114 
·th
->
¦Ùs
[0]++;

117 ià(
Ï¡
 < 
roÙ
->
highe¡_objeùid
 - 1) {

118 
	`__bŒfs_add_ä“_¥aû
(
fs_šfo
, 
ùl
, 
Ï¡
 + 1,

119 
roÙ
->
highe¡_objeùid
 - 
Ï¡
 - 1);

122 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

123 
roÙ
->
šo_ÿche_¡©e
 = 
BTRFS_CACHE_FINISHED
;

124 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

126 
roÙ
->
šo_ÿche_´og»ss
 = (
u64
)-1;

127 
	`bŒfs_uÅš_ä“_šo
(
roÙ
);

128 
out
:

129 
	`wake_up
(&
roÙ
->
šo_ÿche_wa™
);

130 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

132 
	`bŒfs_ä“_·th
(
·th
);

134  
»t
;

135 
	}
}

137 
	$¡¬t_ÿchšg
(
bŒfs_roÙ
 *
roÙ
)

139 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

140 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

141 
sk_¡ruù
 *
tsk
;

142 
»t
;

143 
u64
 
objeùid
;

145 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
INODE_MAP_CACHE
))

148 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

149 ià(
roÙ
->
šo_ÿche_¡©e
 !ð
BTRFS_CACHE_NO
) {

150 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

154 
roÙ
->
šo_ÿche_¡©e
 = 
BTRFS_CACHE_STARTED
;

155 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

157 
»t
 = 
	`lßd_ä“_šo_ÿche
(
fs_šfo
, 
roÙ
);

158 ià(
»t
 == 1) {

159 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

160 
roÙ
->
šo_ÿche_¡©e
 = 
BTRFS_CACHE_FINISHED
;

161 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

172 
»t
 = 
	`bŒfs_fšd_ä“_objeùid
(
roÙ
, &
objeùid
);

173 ià(!
»t
 && 
objeùid
 <ð
BTRFS_LAST_FREE_OBJECTID
) {

174 
	`__bŒfs_add_ä“_¥aû
(
fs_šfo
, 
ùl
, 
objeùid
,

175 
BTRFS_LAST_FREE_OBJECTID
 - 
objeùid
 + 1);

178 
tsk
 = 
	`kth»ad_run
(
ÿchšg_kth»ad
, 
roÙ
, "btrfs-ino-cache-%llu",

179 
roÙ
->
roÙ_key
.
objeùid
);

180 ià(
	`IS_ERR
(
tsk
)) {

181 
	`bŒfs_w¬n
(
fs_šfo
, "failedo start inode cachingask");

182 
	`bŒfs_þ—r_³ndšg_ªd_šfo
(
fs_šfo
, 
INODE_MAP_CACHE
,

185 
	}
}

187 
	$bŒfs_fšd_ä“_šo
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
)

189 ià(!
	`bŒfs_‹¡_Ýt
(
roÙ
->
fs_šfo
, 
INODE_MAP_CACHE
))

190  
	`bŒfs_fšd_ä“_objeùid
(
roÙ
, 
objeùid
);

192 
agaš
:

193 *
objeùid
 = 
	`bŒfs_fšd_šo_fÜ_®loc
(
roÙ
);

195 ià(*
objeùid
 != 0)

198 
	`¡¬t_ÿchšg
(
roÙ
);

200 
	`wa™_ev’t
(
roÙ
->
šo_ÿche_wa™
,

201 
roÙ
->
šo_ÿche_¡©e
 =ð
BTRFS_CACHE_FINISHED
 ||

202 
roÙ
->
ä“_šo_ùl
->
ä“_¥aû
 > 0);

204 ià(
roÙ
->
šo_ÿche_¡©e
 =ð
BTRFS_CACHE_FINISHED
 &&

205 
roÙ
->
ä“_šo_ùl
->
ä“_¥aû
 == 0)

206  -
ENOSPC
;

208 
agaš
;

209 
	}
}

211 
	$bŒfs_»tuº_šo
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

213 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

214 
bŒfs_ä“_¥aû_ùl
 *
pšÃd
 = 
roÙ
->
ä“_šo_pšÃd
;

216 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
INODE_MAP_CACHE
))

218 
agaš
:

219 ià(
roÙ
->
šo_ÿche_¡©e
 =ð
BTRFS_CACHE_FINISHED
) {

220 
	`__bŒfs_add_ä“_¥aû
(
fs_šfo
, 
pšÃd
, 
objeùid
, 1);

222 
	`down_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

223 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

224 ià(
roÙ
->
šo_ÿche_¡©e
 =ð
BTRFS_CACHE_FINISHED
) {

225 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

226 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

227 
agaš
;

229 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

231 
	`¡¬t_ÿchšg
(
roÙ
);

233 
	`__bŒfs_add_ä“_¥aû
(
fs_šfo
, 
pšÃd
, 
objeùid
, 1);

235 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

237 
	}
}

247 
	$bŒfs_uÅš_ä“_šo
(
bŒfs_roÙ
 *
roÙ
)

249 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

250 
rb_roÙ
 *
rbroÙ
 = &
roÙ
->
ä“_šo_pšÃd
->
ä“_¥aû_off£t
;

251 
¥šlock_t
 *
rbroÙ_lock
 = &
roÙ
->
ä“_šo_pšÃd
->
Œ“_lock
;

252 
bŒfs_ä“_¥aû
 *
šfo
;

253 
rb_node
 *
n
;

254 
u64
 
couÁ
;

256 ià(!
	`bŒfs_‹¡_Ýt
(
roÙ
->
fs_šfo
, 
INODE_MAP_CACHE
))

260 
boÞ
 
add_to_ùl
 = 
Œue
;

262 
	`¥š_lock
(
rbroÙ_lock
);

263 
n
 = 
	`rb_fœ¡
(
rbroÙ
);

264 ià(!
n
) {

265 
	`¥š_uÆock
(
rbroÙ_lock
);

269 
šfo
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

270 
	`BUG_ON
(
šfo
->
b™m­
);

272 ià(
šfo
->
off£t
 > 
roÙ
->
šo_ÿche_´og»ss
)

273 
add_to_ùl
 = 
çl£
;

274 ià(
šfo
->
off£t
 + info->
by‹s
 > 
roÙ
->
šo_ÿche_´og»ss
)

275 
couÁ
 = 
roÙ
->
šo_ÿche_´og»ss
 - 
šfo
->
off£t
 + 1;

277 
couÁ
 = 
šfo
->
by‹s
;

279 
	`rb_”a£
(&
šfo
->
off£t_šdex
, 
rbroÙ
);

280 
	`¥š_uÆock
(
rbroÙ_lock
);

281 ià(
add_to_ùl
)

282 
	`__bŒfs_add_ä“_¥aû
(
roÙ
->
fs_šfo
, 
ùl
,

283 
šfo
->
off£t
, 
couÁ
);

284 
	`kmem_ÿche_ä“
(
bŒfs_ä“_¥aû_ÿch•
, 
šfo
);

286 
	}
}

288 
	#INIT_THRESHOLD
 ((
SZ_32K
 / 2è/ (
bŒfs_ä“_¥aû
))

	)

289 
	#INODES_PER_BITMAP
 (
PAGE_SIZE
 * 8)

	)

295 
	$»ÿlcuÏ‹_th»shÞds
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

297 
bŒfs_ä“_¥aû
 *
šfo
;

298 
rb_node
 *
n
;

299 
max_šo
;

300 
max_b™m­s
;

302 
n
 = 
	`rb_Ï¡
(&
ùl
->
ä“_¥aû_off£t
);

303 ià(!
n
) {

304 
ùl
->
ex‹Ás_th»sh
 = 
INIT_THRESHOLD
;

307 
šfo
 = 
	`rb_’Œy
(
n
, 
bŒfs_ä“_¥aû
, 
off£t_šdex
);

314 
max_šo
 = 
šfo
->
by‹s
 - 1;

316 
max_b™m­s
 = 
	`ALIGN
(
max_šo
, 
INODES_PER_BITMAP
) / INODES_PER_BITMAP;

317 ià(
max_b™m­s
 <ð
ùl
->
tÙ®_b™m­s
) {

318 
ùl
->
ex‹Ás_th»sh
 = 0;

322 
ùl
->
ex‹Ás_th»sh
 = (
max_b™m­s
 - cŽ->
tÙ®_b™m­s
) *

323 
PAGE_SIZE
 / (*
šfo
);

324 
	}
}

330 
boÞ
 
	$u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

331 
bŒfs_ä“_¥aû
 *
šfo
)

333 ià(
ùl
->
ä“_ex‹Ás
 < cŽ->
ex‹Ás_th»sh
 ||

334 
šfo
->
by‹s
 > 
INODES_PER_BITMAP
 / 10)

335  
çl£
;

337  
Œue
;

338 
	}
}

340 cÚ¡ 
bŒfs_ä“_¥aû_Ý
 
	gä“_šo_Ý
 = {

341 .
»ÿlc_th»shÞds
 = 
»ÿlcuÏ‹_th»shÞds
,

342 .
	gu£_b™m­
 = 
u£_b™m­
,

345 
	$pšÃd_»ÿlc_th»shÞds
(
bŒfs_ä“_¥aû_ùl
 *
ùl
)

347 
	}
}

349 
boÞ
 
	$pšÃd_u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

350 
bŒfs_ä“_¥aû
 *
šfo
)

359  
çl£
;

360 
	}
}

362 cÚ¡ 
bŒfs_ä“_¥aû_Ý
 
	gpšÃd_ä“_šo_Ý
 = {

363 .
»ÿlc_th»shÞds
 = 
pšÃd_»ÿlc_th»shÞds
,

364 .
	gu£_b™m­
 = 
pšÃd_u£_b™m­
,

367 
	$bŒfs_š™_ä“_šo_ùl
(
bŒfs_roÙ
 *
roÙ
)

369 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

370 
bŒfs_ä“_¥aû_ùl
 *
pšÃd
 = 
roÙ
->
ä“_šo_pšÃd
;

372 
	`¥š_lock_š™
(&
ùl
->
Œ“_lock
);

373 
ùl
->
un™
 = 1;

374 
ùl
->
¡¬t
 = 0;

375 
ùl
->
´iv©e
 = 
NULL
;

376 
ùl
->
Ý
 = &
ä“_šo_Ý
;

377 
	`INIT_LIST_HEAD
(&
ùl
->
Œimmšg_¿nges
);

378 
	`mu‹x_š™
(&
ùl
->
ÿche_wr™eout_mu‹x
);

385 
ùl
->
ex‹Ás_th»sh
 = 
INIT_THRESHOLD
;

387 
	`¥š_lock_š™
(&
pšÃd
->
Œ“_lock
);

388 
pšÃd
->
un™
 = 1;

389 
pšÃd
->
¡¬t
 = 0;

390 
pšÃd
->
´iv©e
 = 
NULL
;

391 
pšÃd
->
ex‹Ás_th»sh
 = 0;

392 
pšÃd
->
Ý
 = &
pšÃd_ä“_šo_Ý
;

393 
	}
}

395 
	$bŒfs_§ve_šo_ÿche
(
bŒfs_roÙ
 *
roÙ
,

396 
bŒfs_Œªs_hªdË
 *
Œªs
)

398 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

399 
bŒfs_ä“_¥aû_ùl
 *
ùl
 = 
roÙ
->
ä“_šo_ùl
;

400 
bŒfs_·th
 *
·th
;

401 
šode
 *inode;

402 
bŒfs_block_rsv
 *
rsv
;

403 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

404 
u64
 
num_by‹s
;

405 
u64
 
®loc_hšt
 = 0;

406 
»t
;

407 
´—Îoc
;

408 
boÞ
 
»Œy
 = 
çl£
;

411 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_FS_TREE_OBJECTID
 &&

412 (
roÙ
->
roÙ_key
.
objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
 ||

413 
roÙ
->
roÙ_key
.
objeùid
 > 
BTRFS_LAST_FREE_OBJECTID
))

417 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

420 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
INODE_MAP_CACHE
))

423 
·th
 = 
	`bŒfs_®loc_·th
();

424 ià(!
·th
)

425  -
ENOMEM
;

427 
rsv
 = 
Œªs
->
block_rsv
;

428 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

430 
num_by‹s
 = 
Œªs
->
by‹s_»£rved
;

438 
Œªs
->
by‹s_»£rved
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 10);

439 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, 
Œªs
->
block_rsv
,

440 
Œªs
->
by‹s_»£rved
,

441 
BTRFS_RESERVE_NO_FLUSH
);

442 ià(
»t
)

443 
out
;

444 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "šo_ÿche", 
Œªs
->
Œªsid
,

445 
Œªs
->
by‹s_»£rved
, 1);

446 
agaš
:

447 
šode
 = 
	`lookup_ä“_šo_šode
(
roÙ
, 
·th
);

448 ià(
	`IS_ERR
(
šode
è&& (
	`PTR_ERR
(šodeè!ð-
ENOENT
 || 
»Œy
)) {

449 
»t
 = 
	`PTR_ERR
(
šode
);

450 
out_»Ëa£
;

453 ià(
	`IS_ERR
(
šode
)) {

454 
	`BUG_ON
(
»Œy
);

455 
»Œy
 = 
Œue
;

457 
»t
 = 
	`ü—‹_ä“_šo_šode
(
roÙ
, 
Œªs
, 
·th
);

458 ià(
»t
)

459 
out_»Ëa£
;

460 
agaš
;

463 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 0;

464 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

465 ià(
»t
) {

466 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

467 
out_put
;

470 ià(
	`i_size_»ad
(
šode
) > 0) {

471 
»t
 = 
	`bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
Œªs
, 
NULL
, 
šode
);

472 ià(
»t
) {

473 ià(
»t
 !ð-
ENOSPC
)

474 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

475 
out_put
;

479 
	`¥š_lock
(&
roÙ
->
šo_ÿche_lock
);

480 ià(
roÙ
->
šo_ÿche_¡©e
 !ð
BTRFS_CACHE_FINISHED
) {

481 
»t
 = -1;

482 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

483 
out_put
;

485 
	`¥š_uÆock
(&
roÙ
->
šo_ÿche_lock
);

487 
	`¥š_lock
(&
ùl
->
Œ“_lock
);

488 
´—Îoc
 = (
bŒfs_ä“_¥aû
è* 
ùl
->
ä“_ex‹Ás
;

489 
´—Îoc
 = 
	`ALIGN
Õ»®loc, 
PAGE_SIZE
);

490 
´—Îoc
 +ð
ùl
->
tÙ®_b™m­s
 * 
PAGE_SIZE
;

491 
	`¥š_uÆock
(&
ùl
->
Œ“_lock
);

494 
´—Îoc
 +ð8 * 
PAGE_SIZE
;

496 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
, 0, 
´—Îoc
);

497 ià(
»t
)

498 
out_put
;

500 
»t
 = 
	`bŒfs_´—Îoc_fže_¿nge_Œªs
(
šode
, 
Œªs
, 0, 0, 
´—Îoc
,

501 
´—Îoc
,…»®loc, &
®loc_hšt
);

502 ià(
»t
) {

503 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
), 
´—Îoc
);

504 
out_put
;

507 
»t
 = 
	`bŒfs_wr™e_out_šo_ÿche
(
roÙ
, 
Œªs
, 
·th
, 
šode
);

508 
out_put
:

509 
	`ut
(
šode
);

510 
out_»Ëa£
:

511 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "šo_ÿche", 
Œªs
->
Œªsid
,

512 
Œªs
->
by‹s_»£rved
, 0);

513 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
Œªs
->
block_rsv
,

514 
Œªs
->
by‹s_»£rved
);

515 
out
:

516 
Œªs
->
block_rsv
 = 
rsv
;

517 
Œªs
->
by‹s_»£rved
 = 
num_by‹s
;

519 
	`bŒfs_ä“_·th
(
·th
);

520 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

521  
»t
;

522 
	}
}

524 
	$bŒfs_fšd_highe¡_objeùid
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
)

526 
bŒfs_·th
 *
·th
;

527 
»t
;

528 
ex‹Á_bufãr
 *
l
;

529 
bŒfs_key
 
£¬ch_key
;

530 
bŒfs_key
 
found_key
;

531 
¦Ù
;

533 
·th
 = 
	`bŒfs_®loc_·th
();

534 ià(!
·th
)

535  -
ENOMEM
;

537 
£¬ch_key
.
objeùid
 = 
BTRFS_LAST_FREE_OBJECTID
;

538 
£¬ch_key
.
ty³
 = -1;

539 
£¬ch_key
.
off£t
 = (
u64
)-1;

540 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

541 ià(
»t
 < 0)

542 
”rÜ
;

543 
	`BUG_ON
(
»t
 == 0);

544 ià(
·th
->
¦Ùs
[0] > 0) {

545 
¦Ù
 = 
·th
->
¦Ùs
[0] - 1;

546 
l
 = 
·th
->
nodes
[0];

547 
	`bŒfs_™em_key_to_ýu
(
l
, &
found_key
, 
¦Ù
);

548 *
objeùid
 = 
	`max_t
(
u64
, 
found_key
.objectid,

549 
BTRFS_FIRST_FREE_OBJECTID
 - 1);

551 *
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
 - 1;

553 
»t
 = 0;

554 
”rÜ
:

555 
	`bŒfs_ä“_·th
(
·th
);

556  
»t
;

557 
	}
}

559 
	$bŒfs_fšd_ä“_objeùid
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
)

561 
»t
;

562 
	`mu‹x_lock
(&
roÙ
->
objeùid_mu‹x
);

564 ià(
	`uÆik–y
(
roÙ
->
highe¡_objeùid
 >ð
BTRFS_LAST_FREE_OBJECTID
)) {

565 
	`bŒfs_w¬n
(
roÙ
->
fs_šfo
,

567 
roÙ
->
roÙ_key
.
objeùid
);

568 
»t
 = -
ENOSPC
;

569 
out
;

572 *
objeùid
 = ++
roÙ
->
highe¡_objeùid
;

573 
»t
 = 0;

574 
out
:

575 
	`mu‹x_uÆock
(&
roÙ
->
objeùid_mu‹x
);

576  
»t
;

577 
	}
}

	@inode-map.h

2 #iâdeà
__BTRFS_INODE_MAP


3 
	#__BTRFS_INODE_MAP


	)

5 
bŒfs_š™_ä“_šo_ùl
(
bŒfs_roÙ
 *
roÙ
);

6 
bŒfs_uÅš_ä“_šo
(
bŒfs_roÙ
 *
roÙ
);

7 
bŒfs_»tuº_šo
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
);

8 
bŒfs_fšd_ä“_šo
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
);

9 
bŒfs_§ve_šo_ÿche
(
bŒfs_roÙ
 *
roÙ
,

10 
bŒfs_Œªs_hªdË
 *
Œªs
);

12 
bŒfs_fšd_ä“_objeùid
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
);

13 
bŒfs_fšd_highe¡_objeùid
(
bŒfs_roÙ
 *
roÙ
, 
u64
 *
objeùid
);

	@inode.c

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/bio.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/fže.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/·gem­.h
>

25 
	~<lšux/highmem.h
>

26 
	~<lšux/time.h
>

27 
	~<lšux/š™.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/backšg-dev.h
>

30 
	~<lšux/m·ge.h
>

31 
	~<lšux/sw­.h
>

32 
	~<lšux/wr™eback.h
>

33 
	~<lšux/com·t.h
>

34 
	~<lšux/b™_¥šlock.h
>

35 
	~<lšux/x©Œ.h
>

36 
	~<lšux/posix_aþ.h
>

37 
	~<lšux/çÎoc.h
>

38 
	~<lšux/¦ab.h
>

39 
	~<lšux/¿‹lim™.h
>

40 
	~<lšux/mouÁ.h
>

41 
	~<lšux/bŒfs.h
>

42 
	~<lšux/blkdev.h
>

43 
	~<lšux/posix_aþ_x©Œ.h
>

44 
	~<lšux/uio.h
>

45 
	~"ù»e.h
"

46 
	~"disk-io.h
"

47 
	~"Œª§ùiÚ.h
"

48 
	~"bŒfs_šode.h
"

49 
	~"´št-Œ“.h
"

50 
	~"Üd”ed-d©a.h
"

51 
	~"x©Œ.h
"

52 
	~"Œ“-log.h
"

53 
	~"vÞumes.h
"

54 
	~"com´essiÚ.h
"

55 
	~"lockšg.h
"

56 
	~"ä“-¥aû-ÿche.h
"

57 
	~"šode-m­.h
"

58 
	~"back»f.h
"

59 
	~"hash.h
"

60 
	~"´Ýs.h
"

61 
	~"qgroup.h
"

62 
	~"dedu³.h
"

64 
	sbŒfs_ig‘_¬gs
 {

65 
bŒfs_key
 *
	mloÿtiÚ
;

66 
bŒfs_roÙ
 *
	mroÙ
;

69 
	sbŒfs_dio_d©a
 {

70 
u64
 
	mout¡ªdšg_ex‹Ás
;

71 
u64
 
	m»£rve
;

72 
u64
 
	munsubm™‹d_Û_¿nge_¡¬t
;

73 
u64
 
	munsubm™‹d_Û_¿nge_’d
;

74 
	mov”wr™e
;

77 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_dœ_šode_Ý”©iÚs
;

78 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_symlšk_šode_Ý”©iÚs
;

79 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_dœ_ro_šode_Ý”©iÚs
;

80 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_¥ecŸl_šode_Ý”©iÚs
;

81 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_fže_šode_Ý”©iÚs
;

82 cÚ¡ 
add»ss_¥aû_Ý”©iÚs
 
	gbŒfs_aÝs
;

83 cÚ¡ 
add»ss_¥aû_Ý”©iÚs
 
	gbŒfs_symlšk_aÝs
;

84 cÚ¡ 
fže_Ý”©iÚs
 
	gbŒfs_dœ_fže_Ý”©iÚs
;

85 cÚ¡ 
ex‹Á_io_Ýs
 
	gbŒfs_ex‹Á_io_Ýs
;

87 
kmem_ÿche
 *
	gbŒfs_šode_ÿch•
;

88 
kmem_ÿche
 *
	gbŒfs_Œªs_hªdË_ÿch•
;

89 
kmem_ÿche
 *
	gbŒfs_·th_ÿch•
;

90 
kmem_ÿche
 *
	gbŒfs_ä“_¥aû_ÿch•
;

92 
	#S_SHIFT
 12

	)

93 cÚ¡ 
	gbŒfs_ty³_by_mode
[
S_IFMT
 >> 
S_SHIFT
] = {

94 [
S_IFREG
 >> 
S_SHIFT
] = 
BTRFS_FT_REG_FILE
,

95 [
S_IFDIR
 >> 
S_SHIFT
] = 
BTRFS_FT_DIR
,

96 [
S_IFCHR
 >> 
S_SHIFT
] = 
BTRFS_FT_CHRDEV
,

97 [
S_IFBLK
 >> 
S_SHIFT
] = 
BTRFS_FT_BLKDEV
,

98 [
S_IFIFO
 >> 
S_SHIFT
] = 
BTRFS_FT_FIFO
,

99 [
S_IFSOCK
 >> 
S_SHIFT
] = 
BTRFS_FT_SOCK
,

100 [
S_IFLNK
 >> 
S_SHIFT
] = 
BTRFS_FT_SYMLINK
,

103 
bŒfs_£tsize
(
šode
 *šode, 
Ÿ‰r
 *
©Œ
);

104 
bŒfs_Œunÿ‹
(
šode
 *inode);

105 
bŒfs_fšish_Üd”ed_io
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
);

106 
nošlše
 
cow_fže_¿nge
(
šode
 *inode,

107 
·ge
 *
locked_·ge
,

108 
u64
 
¡¬t
, u64 
’d
, u64 
d–®loc_’d
,

109 *
·ge_¡¬‹d
, *
Ä_wr™‹n
,

110 
uÆock
, 
bŒfs_dedu³_hash
 *
hash
);

111 
ex‹Á_m­
 *
ü—‹_io_em
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
,

112 
u64
 
Üig_¡¬t
, u64 
block_¡¬t
,

113 
u64
 
block_Ën
, u64 
Üig_block_Ën
,

114 
u64
 
¿m_by‹s
, 
com´ess_ty³
,

115 
ty³
);

117 
__’dio_wr™e_upd©e_Üd”ed
(
šode
 *inode,

118 cÚ¡ 
u64
 
off£t
, cÚ¡ u64 
by‹s
,

119 cÚ¡ 
boÞ
 
u±od©e
);

134 
šlše
 
	$bŒfs_þ—nup_Üd”ed_ex‹Ás
(
šode
 *inode,

135 cÚ¡ 
u64
 
off£t
,

136 cÚ¡ 
u64
 
by‹s
)

138 
šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

139 
’d_šdex
 = (
off£t
 + 
by‹s
 - 1è>> 
PAGE_SHIFT
;

140 
·ge
 *page;

142 
šdex
 <ð
’d_šdex
) {

143 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

144 
šdex
++;

145 ià(!
·ge
)

147 
	`CË¬PagePriv©e2
(
·ge
);

148 
	`put_·ge
(
·ge
);

150  
	`__’dio_wr™e_upd©e_Üd”ed
(
šode
, 
off£t
 + 
PAGE_SIZE
,

151 
by‹s
 - 
PAGE_SIZE
, 
çl£
);

152 
	}
}

154 
bŒfs_dœty_šode
(
šode
 *inode);

156 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


157 
	$bŒfs_‹¡_šode_£t_Ýs
(
šode
 *inode)

159 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Ýs
 = &
bŒfs_ex‹Á_io_Ýs
;

160 
	}
}

163 
	$bŒfs_š™_šode_£cur™y
(
bŒfs_Œªs_hªdË
 *
Œªs
,

164 
šode
 *šode, šod*
dœ
,

165 cÚ¡ 
q¡r
 *qstr)

167 
”r
;

169 
”r
 = 
	`bŒfs_š™_aþ
(
Œªs
, 
šode
, 
dœ
);

170 ià(!
”r
)

171 
”r
 = 
	`bŒfs_x©Œ_£cur™y_š™
(
Œªs
, 
šode
, 
dœ
, 
q¡r
);

172  
”r
;

173 
	}
}

180 
	$š£¹_šlše_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

181 
bŒfs_·th
 *
·th
, 
ex‹Á_š£¹ed
,

182 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

183 
u64
 
¡¬t
, 
size_t
 
size
, size_ˆ
com´es£d_size
,

184 
com´ess_ty³
,

185 
·ge
 **
com´es£d_·ges
)

187 
ex‹Á_bufãr
 *
Ëaf
;

188 
·ge
 *·gð
NULL
;

189 *
kaddr
;

190 
±r
;

191 
bŒfs_fže_ex‹Á_™em
 *
ei
;

192 
»t
;

193 
size_t
 
cur_size
 = 
size
;

194 
off£t
;

196 ià(
com´es£d_size
 && 
com´es£d_·ges
)

197 
cur_size
 = 
com´es£d_size
;

199 
	`šode_add_by‹s
(
šode
, 
size
);

201 ià(!
ex‹Á_š£¹ed
) {

202 
bŒfs_key
 
key
;

203 
size_t
 
d©asize
;

205 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

206 
key
.
off£t
 = 
¡¬t
;

207 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

209 
d©asize
 = 
	`bŒfs_fže_ex‹Á_ÿlc_šlše_size
(
cur_size
);

210 
·th
->
Ëave_¥šnšg
 = 1;

211 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

212 
d©asize
);

213 ià(
»t
)

214 
çž
;

216 
Ëaf
 = 
·th
->
nodes
[0];

217 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

218 
bŒfs_fže_ex‹Á_™em
);

219 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
, 
Œªs
->
Œªsid
);

220 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
ei
, 
BTRFS_FILE_EXTENT_INLINE
);

221 
	`bŒfs_£t_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
ei
, 0);

222 
	`bŒfs_£t_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
ei
, 0);

223 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
, 
size
);

224 
±r
 = 
	`bŒfs_fže_ex‹Á_šlše_¡¬t
(
ei
);

226 ià(
com´ess_ty³
 !ð
BTRFS_COMPRESS_NONE
) {

227 
·ge
 *
ýage
;

228 
i
 = 0;

229 
com´es£d_size
 > 0) {

230 
ýage
 = 
com´es£d_·ges
[
i
];

231 
cur_size
 = 
	`mš_t
(, 
com´es£d_size
,

232 
PAGE_SIZE
);

234 
kaddr
 = 
	`km­_©omic
(
ýage
);

235 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
kaddr
, 
±r
, 
cur_size
);

236 
	`kunm­_©omic
(
kaddr
);

238 
i
++;

239 
±r
 +ð
cur_size
;

240 
com´es£d_size
 -ð
cur_size
;

242 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
,

243 
com´ess_ty³
);

245 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
,

246 
¡¬t
 >> 
PAGE_SHIFT
);

247 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
, 0);

248 
kaddr
 = 
	`km­_©omic
(
·ge
);

249 
off£t
 = 
¡¬t
 & (
PAGE_SIZE
 - 1);

250 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
kaddr
 + 
off£t
, 
±r
, 
size
);

251 
	`kunm­_©omic
(
kaddr
);

252 
	`put_·ge
(
·ge
);

254 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

255 
	`bŒfs_»Ëa£_·th
(
·th
);

266 
	`BTRFS_I
(
šode
)->
disk_i_size
 = inode->
i_size
;

267 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

269 
çž
:

270  
»t
;

271 
	}
}

279 
nošlše
 
	$cow_fže_¿nge_šlše
(
bŒfs_roÙ
 *
roÙ
,

280 
šode
 *šode, 
u64
 
¡¬t
,

281 
u64
 
’d
, 
size_t
 
com´es£d_size
,

282 
com´ess_ty³
,

283 
·ge
 **
com´es£d_·ges
)

285 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

286 
bŒfs_Œªs_hªdË
 *
Œªs
;

287 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

288 
u64
 
aùu®_’d
 = 
	`mš
(
’d
 + 1, 
isize
);

289 
u64
 
šlše_Ën
 = 
aùu®_’d
 - 
¡¬t
;

290 
u64
 
®igÃd_’d
 = 
	`ALIGN
(
’d
, 
fs_šfo
->
£ùÜsize
);

291 
u64
 
d©a_Ën
 = 
šlše_Ën
;

292 
»t
;

293 
bŒfs_·th
 *
·th
;

294 
ex‹Á_š£¹ed
 = 0;

295 
u32
 
ex‹Á_™em_size
;

297 ià(
com´es£d_size
)

298 
d©a_Ën
 = 
com´es£d_size
;

300 ià(
¡¬t
 > 0 ||

301 
aùu®_’d
 > 
fs_šfo
->
£ùÜsize
 ||

302 
d©a_Ën
 > 
	`BTRFS_MAX_INLINE_DATA_SIZE
(
fs_šfo
) ||

303 (!
com´es£d_size
 &&

304 (
aùu®_’d
 & (
fs_šfo
->
£ùÜsize
 - 1)) == 0) ||

305 
’d
 + 1 < 
isize
 ||

306 
d©a_Ën
 > 
fs_šfo
->
max_šlše
) {

310 
·th
 = 
	`bŒfs_®loc_·th
();

311 ià(!
·th
)

312  -
ENOMEM
;

314 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

315 ià(
	`IS_ERR
(
Œªs
)) {

316 
	`bŒfs_ä“_·th
(
·th
);

317  
	`PTR_ERR
(
Œªs
);

319 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–®loc_block_rsv
;

321 ià(
com´es£d_size
 && 
com´es£d_·ges
)

322 
ex‹Á_™em_size
 = 
	`bŒfs_fže_ex‹Á_ÿlc_šlše_size
(

323 
com´es£d_size
);

325 
ex‹Á_™em_size
 = 
	`bŒfs_fže_ex‹Á_ÿlc_šlše_size
(

326 
šlše_Ën
);

328 
»t
 = 
	`__bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
·th
,

329 
¡¬t
, 
®igÃd_’d
, 
NULL
,

330 1, 1, 
ex‹Á_™em_size
, &
ex‹Á_š£¹ed
);

331 ià(
»t
) {

332 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

333 
out
;

336 ià(
isize
 > 
aùu®_’d
)

337 
šlše_Ën
 = 
	`mš_t
(
u64
, 
isize
, 
aùu®_’d
);

338 
»t
 = 
	`š£¹_šlše_ex‹Á
(
Œªs
, 
·th
, 
ex‹Á_š£¹ed
,

339 
roÙ
, 
šode
, 
¡¬t
,

340 
šlše_Ën
, 
com´es£d_size
,

341 
com´ess_ty³
, 
com´es£d_·ges
);

342 ià(
»t
 &&„‘ !ð-
ENOSPC
) {

343 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

344 
out
;

345 } ià(
»t
 =ð-
ENOSPC
) {

346 
»t
 = 1;

347 
out
;

350 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

351 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
), 
’d
 + 1 - 
¡¬t
);

352 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
®igÃd_’d
 - 1, 0);

353 
out
:

360 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
NULL
, 0, 
PAGE_SIZE
);

361 
	`bŒfs_ä“_·th
(
·th
);

362 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

363  
»t
;

364 
	}
}

366 
	sasync_ex‹Á
 {

367 
u64
 
	m¡¬t
;

368 
u64
 
	m¿m_size
;

369 
u64
 
	mcom´es£d_size
;

370 
·ge
 **
	m·ges
;

371 
	mÄ_·ges
;

372 
	mcom´ess_ty³
;

373 
li¡_h—d
 
	mli¡
;

376 
	sasync_cow
 {

377 
šode
 *
	mšode
;

378 
bŒfs_roÙ
 *
	mroÙ
;

379 
·ge
 *
	mlocked_·ge
;

380 
u64
 
	m¡¬t
;

381 
u64
 
	m’d
;

382 
li¡_h—d
 
	mex‹Ás
;

383 
bŒfs_wÜk
 
	mwÜk
;

386 
nošlše
 
	$add_async_ex‹Á
(
async_cow
 *
cow
,

387 
u64
 
¡¬t
, u64 
¿m_size
,

388 
u64
 
com´es£d_size
,

389 
·ge
 **
·ges
,

390 
Ä_·ges
,

391 
com´ess_ty³
)

393 
async_ex‹Á
 *async_extent;

395 
async_ex‹Á
 = 
	`km®loc
((*async_ex‹Á), 
GFP_NOFS
);

396 
	`BUG_ON
(!
async_ex‹Á
);

397 
async_ex‹Á
->
¡¬t
 = start;

398 
async_ex‹Á
->
¿m_size
 =„am_size;

399 
async_ex‹Á
->
com´es£d_size
 = compressed_size;

400 
async_ex‹Á
->
·ges
 =…ages;

401 
async_ex‹Á
->
Ä_·ges
 =‚r_pages;

402 
async_ex‹Á
->
com´ess_ty³
 = compress_type;

403 
	`li¡_add_ž
(&
async_ex‹Á
->
li¡
, &
cow
->
ex‹Ás
);

405 
	}
}

407 
šlše
 
	$šode_Ãed_com´ess
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

409 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

412 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FORCE_COMPRESS
))

415 ià(
	`BTRFS_I
(
šode
)->
deäag_com´ess
)

418 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NOCOMPRESS
)

420 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
COMPRESS
) ||

421 
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_COMPRESS
 ||

422 
	`BTRFS_I
(
šode
)->
´Ý_com´ess
)

423  
	`bŒfs_com´ess_heuri¡ic
(
šode
, 
¡¬t
, 
’d
);

425 
	}
}

427 
šlše
 
	$šode_should_deäag
(
bŒfs_šode
 *
šode
,

428 
u64
 
¡¬t
, u64 
’d
, u64 
num_by‹s
, u64 
sm®l_wr™e
)

431 ià(
num_by‹s
 < 
sm®l_wr™e
 &&

432 (
¡¬t
 > 0 || 
’d
 + 1 < 
šode
->
disk_i_size
))

433 
	`bŒfs_add_šode_deäag
(
NULL
, 
šode
);

434 
	}
}

453 
nošlše
 
	$com´ess_fže_¿nge
(
šode
 *inode,

454 
·ge
 *
locked_·ge
,

455 
u64
 
¡¬t
, u64 
’d
,

456 
async_cow
 *async_cow,

457 *
num_added
)

459 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

460 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

461 
u64
 
num_by‹s
;

462 
u64
 
blocksize
 = 
fs_šfo
->
£ùÜsize
;

463 
u64
 
aùu®_’d
;

464 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

465 
»t
 = 0;

466 
·ge
 **
·ges
 = 
NULL
;

467 
Ä_·ges
;

468 
tÙ®_com´es£d
 = 0;

469 
tÙ®_š
 = 0;

470 
i
;

471 
wžl_com´ess
;

472 
com´ess_ty³
 = 
fs_šfo
->compress_type;

473 
»dœty
 = 0;

475 
	`šode_should_deäag
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
,ƒnd - start + 1,

476 
SZ_16K
);

478 
aùu®_’d
 = 
	`mš_t
(
u64
, 
isize
, 
’d
 + 1);

479 
agaš
:

480 
wžl_com´ess
 = 0;

481 
Ä_·ges
 = (
’d
 >> 
PAGE_SHIFT
è- (
¡¬t
 >> PAGE_SHIFT) + 1;

482 
	`BUILD_BUG_ON
((
BTRFS_MAX_COMPRESSED
 % 
PAGE_SIZE
) != 0);

483 
Ä_·ges
 = 
	`mš_t
(,‚r_pages,

484 
BTRFS_MAX_COMPRESSED
 / 
PAGE_SIZE
);

496 ià(
aùu®_’d
 <ð
¡¬t
)

497 
þ—nup_ªd_baž_uncom´es£d
;

499 
tÙ®_com´es£d
 = 
aùu®_’d
 - 
¡¬t
;

505 ià(
tÙ®_com´es£d
 <ð
blocksize
 &&

506 (
¡¬t
 > 0 || 
’d
 + 1 < 
	`BTRFS_I
(
šode
)->
disk_i_size
))

507 
þ—nup_ªd_baž_uncom´es£d
;

509 
tÙ®_com´es£d
 = 
	`mš_t
(,otal_compressed,

510 
BTRFS_MAX_UNCOMPRESSED
);

511 
num_by‹s
 = 
	`ALIGN
(
’d
 - 
¡¬t
 + 1, 
blocksize
);

512 
num_by‹s
 = 
	`max
(
blocksize
,‚um_bytes);

513 
tÙ®_š
 = 0;

514 
»t
 = 0;

521 ià(
	`šode_Ãed_com´ess
(
šode
, 
¡¬t
, 
’d
)) {

522 
	`WARN_ON
(
·ges
);

523 
·ges
 = 
	`kÿÎoc
(
Ä_·ges
, (
·ge
 *), 
GFP_NOFS
);

524 ià(!
·ges
) {

526 
cÚt
;

529 ià(
	`BTRFS_I
(
šode
)->
deäag_com´ess
)

530 
com´ess_ty³
 = 
	`BTRFS_I
(
šode
)->
deäag_com´ess
;

531 ià(
	`BTRFS_I
(
šode
)->
´Ý_com´ess
)

532 
com´ess_ty³
 = 
	`BTRFS_I
(
šode
)->
´Ý_com´ess
;

543 
	`ex‹Á_¿nge_þ—r_dœty_fÜ_io
(
šode
, 
¡¬t
, 
’d
);

544 
»dœty
 = 1;

545 
»t
 = 
	`bŒfs_com´ess_·ges
(
com´ess_ty³
,

546 
šode
->
i_m­pšg
, 
¡¬t
,

547 
·ges
,

548 &
Ä_·ges
,

549 &
tÙ®_š
,

550 &
tÙ®_com´es£d
);

552 ià(!
»t
) {

553 
off£t
 = 
tÙ®_com´es£d
 &

554 (
PAGE_SIZE
 - 1);

555 
·ge
 *·gð
·ges
[
Ä_·ges
 - 1];

556 *
kaddr
;

561 ià(
off£t
) {

562 
kaddr
 = 
	`km­_©omic
(
·ge
);

563 
	`mem£t
(
kaddr
 + 
off£t
, 0,

564 
PAGE_SIZE
 - 
off£t
);

565 
	`kunm­_©omic
(
kaddr
);

567 
wžl_com´ess
 = 1;

570 
cÚt
:

571 ià(
¡¬t
 == 0) {

573 ià(
»t
 || 
tÙ®_š
 < (
aùu®_’d
 - 
¡¬t
)) {

577 
»t
 = 
	`cow_fže_¿nge_šlše
(
roÙ
, 
šode
, 
¡¬t
, 
’d
,

578 0, 
BTRFS_COMPRESS_NONE
, 
NULL
);

581 
»t
 = 
	`cow_fže_¿nge_šlše
(
roÙ
, 
šode
, 
¡¬t
, 
’d
,

582 
tÙ®_com´es£d
,

583 
com´ess_ty³
, 
·ges
);

585 ià(
»t
 <= 0) {

586 
þ—r_æags
 = 
EXTENT_DELALLOC
 |

587 
EXTENT_DELALLOC_NEW
 | 
EXTENT_DEFRAG
;

588 
·ge_”rÜ_Ý
;

590 
þ—r_æags
 |ð(
»t
 < 0è? 
EXTENT_DO_ACCOUNTING
 : 0;

591 
·ge_”rÜ_Ý
 = 
»t
 < 0 ? 
PAGE_SET_ERROR
 : 0;

598 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,ƒnd,

599 
NULL
, 
þ—r_æags
,

600 
PAGE_UNLOCK
 |

601 
PAGE_CLEAR_DIRTY
 |

602 
PAGE_SET_WRITEBACK
 |

603 
·ge_”rÜ_Ý
 |

604 
PAGE_END_WRITEBACK
);

605 ià(
»t
 == 0)

606 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
,

607 
¡¬t
,

608 
’d
 - 
¡¬t
 + 1);

609 
ä“_·ges_out
;

613 ià(
wžl_com´ess
) {

619 
tÙ®_com´es£d
 = 
	`ALIGN
ÑÙ®_com´es£d, 
blocksize
);

626 
tÙ®_š
 = 
	`ALIGN
ÑÙ®_š, 
PAGE_SIZE
);

627 ià(
tÙ®_com´es£d
 + 
blocksize
 <ð
tÙ®_š
) {

628 
num_by‹s
 = 
tÙ®_š
;

629 *
num_added
 += 1;

636 
	`add_async_ex‹Á
(
async_cow
, 
¡¬t
, 
num_by‹s
,

637 
tÙ®_com´es£d
, 
·ges
, 
Ä_·ges
,

638 
com´ess_ty³
);

640 ià(
¡¬t
 + 
num_by‹s
 < 
’d
) {

641 
¡¬t
 +ð
num_by‹s
;

642 
·ges
 = 
NULL
;

643 
	`cÚd_»sched
();

644 
agaš
;

649 ià(
·ges
) {

654 
i
 = 0; i < 
Ä_·ges
; i++) {

655 
	`WARN_ON
(
·ges
[
i
]->
m­pšg
);

656 
	`put_·ge
(
·ges
[
i
]);

658 
	`kä“
(
·ges
);

659 
·ges
 = 
NULL
;

660 
tÙ®_com´es£d
 = 0;

661 
Ä_·ges
 = 0;

664 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FORCE_COMPRESS
) &&

665 !(
	`BTRFS_I
(
šode
)->
´Ý_com´ess
)) {

666 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NOCOMPRESS
;

669 
þ—nup_ªd_baž_uncom´es£d
:

676 ià(
	`·ge_off£t
(
locked_·ge
è>ð
¡¬t
 &&

677 
	`·ge_off£t
(
locked_·ge
è<ð
’d
)

678 
	`__£t_·ge_dœty_nobufãrs
(
locked_·ge
);

681 ià(
»dœty
)

682 
	`ex‹Á_¿nge_»dœty_fÜ_io
(
šode
, 
¡¬t
, 
’d
);

683 
	`add_async_ex‹Á
(
async_cow
, 
¡¬t
, 
’d
 - s¹ + 1, 0, 
NULL
, 0,

684 
BTRFS_COMPRESS_NONE
);

685 *
num_added
 += 1;

689 
ä“_·ges_out
:

690 
i
 = 0; i < 
Ä_·ges
; i++) {

691 
	`WARN_ON
(
·ges
[
i
]->
m­pšg
);

692 
	`put_·ge
(
·ges
[
i
]);

694 
	`kä“
(
·ges
);

695 
	}
}

697 
	$ä“_async_ex‹Á_·ges
(
async_ex‹Á
 *async_extent)

699 
i
;

701 ià(!
async_ex‹Á
->
·ges
)

704 
i
 = 0; i < 
async_ex‹Á
->
Ä_·ges
; i++) {

705 
	`WARN_ON
(
async_ex‹Á
->
·ges
[
i
]->
m­pšg
);

706 
	`put_·ge
(
async_ex‹Á
->
·ges
[
i
]);

708 
	`kä“
(
async_ex‹Á
->
·ges
);

709 
async_ex‹Á
->
Ä_·ges
 = 0;

710 
async_ex‹Á
->
·ges
 = 
NULL
;

711 
	}
}

719 
nošlše
 
	$subm™_com´es£d_ex‹Ás
(
šode
 *inode,

720 
async_cow
 *async_cow)

722 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

723 
async_ex‹Á
 *async_extent;

724 
u64
 
®loc_hšt
 = 0;

725 
bŒfs_key
 
šs
;

726 
ex‹Á_m­
 *
em
;

727 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

728 
ex‹Á_io_Œ“
 *
io_Œ“
;

729 
»t
 = 0;

731 
agaš
:

732 !
	`li¡_em±y
(&
async_cow
->
ex‹Ás
)) {

733 
async_ex‹Á
 = 
	`li¡_’Œy
(
async_cow
->
ex‹Ás
.
Ãxt
,

734 
async_ex‹Á
, 
li¡
);

735 
	`li¡_d–
(&
async_ex‹Á
->
li¡
);

737 
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

739 
»Œy
:

741 ià(!
async_ex‹Á
->
·ges
) {

742 
·ge_¡¬‹d
 = 0;

743 
Ä_wr™‹n
 = 0;

745 
	`lock_ex‹Á
(
io_Œ“
, 
async_ex‹Á
->
¡¬t
,

746 
async_ex‹Á
->
¡¬t
 +

747 
async_ex‹Á
->
¿m_size
 - 1);

750 
»t
 = 
	`cow_fže_¿nge
(
šode
, 
async_cow
->
locked_·ge
,

751 
async_ex‹Á
->
¡¬t
,

752 
async_ex‹Á
->
¡¬t
 +

753 
async_ex‹Á
->
¿m_size
 - 1,

754 
async_ex‹Á
->
¡¬t
 +

755 
async_ex‹Á
->
¿m_size
 - 1,

756 &
·ge_¡¬‹d
, &
Ä_wr™‹n
, 0,

757 
NULL
);

767 ià(!
·ge_¡¬‹d
 && !
»t
)

768 
	`ex‹Á_wr™e_locked_¿nge
(
io_Œ“
,

769 
šode
, 
async_ex‹Á
->
¡¬t
,

770 
async_ex‹Á
->
¡¬t
 +

771 
async_ex‹Á
->
¿m_size
 - 1,

772 
bŒfs_g‘_ex‹Á
,

773 
WB_SYNC_ALL
);

774 ià(
»t
)

775 
	`uÆock_·ge
(
async_cow
->
locked_·ge
);

776 
	`kä“
(
async_ex‹Á
);

777 
	`cÚd_»sched
();

781 
	`lock_ex‹Á
(
io_Œ“
, 
async_ex‹Á
->
¡¬t
,

782 
async_ex‹Á
->
¡¬t
 +‡sync_ex‹Á->
¿m_size
 - 1);

784 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
async_ex‹Á
->
¿m_size
,

785 
async_ex‹Á
->
com´es£d_size
,

786 
async_ex‹Á
->
com´es£d_size
,

787 0, 
®loc_hšt
, &
šs
, 1, 1);

788 ià(
»t
) {

789 
	`ä“_async_ex‹Á_·ges
(
async_ex‹Á
);

791 ià(
»t
 =ð-
ENOSPC
) {

792 
	`uÆock_ex‹Á
(
io_Œ“
, 
async_ex‹Á
->
¡¬t
,

793 
async_ex‹Á
->
¡¬t
 +

794 
async_ex‹Á
->
¿m_size
 - 1);

802 
	`ex‹Á_¿nge_»dœty_fÜ_io
(
šode
,

803 
async_ex‹Á
->
¡¬t
,

804 
async_ex‹Á
->
¡¬t
 +

805 
async_ex‹Á
->
¿m_size
 - 1);

807 
»Œy
;

809 
out_ä“
;

815 
em
 = 
	`ü—‹_io_em
(
šode
, 
async_ex‹Á
->
¡¬t
,

816 
async_ex‹Á
->
¿m_size
,

817 
async_ex‹Á
->
¡¬t
,

818 
šs
.
objeùid
,

819 
šs
.
off£t
,

820 
šs
.
off£t
,

821 
async_ex‹Á
->
¿m_size
,

822 
async_ex‹Á
->
com´ess_ty³
,

823 
BTRFS_ORDERED_COMPRESSED
);

824 ià(
	`IS_ERR
(
em
))

826 
out_ä“_»£rve
;

827 
	`ä“_ex‹Á_m­
(
em
);

829 
»t
 = 
	`bŒfs_add_Üd”ed_ex‹Á_com´ess
(
šode
,

830 
async_ex‹Á
->
¡¬t
,

831 
šs
.
objeùid
,

832 
async_ex‹Á
->
¿m_size
,

833 
šs
.
off£t
,

834 
BTRFS_ORDERED_COMPRESSED
,

835 
async_ex‹Á
->
com´ess_ty³
);

836 ià(
»t
) {

837 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
),

838 
async_ex‹Á
->
¡¬t
,

839 
async_ex‹Á
->
¡¬t
 +

840 
async_ex‹Á
->
¿m_size
 - 1, 0);

841 
out_ä“_»£rve
;

843 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

848 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
async_ex‹Á
->
¡¬t
,

849 
async_ex‹Á
->
¡¬t
 +

850 
async_ex‹Á
->
¿m_size
 - 1,

851 
async_ex‹Á
->
¡¬t
 +

852 
async_ex‹Á
->
¿m_size
 - 1,

853 
NULL
, 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
,

854 
PAGE_UNLOCK
 | 
PAGE_CLEAR_DIRTY
 |

855 
PAGE_SET_WRITEBACK
);

856 ià(
	`bŒfs_subm™_com´es£d_wr™e
(
šode
,

857 
async_ex‹Á
->
¡¬t
,

858 
async_ex‹Á
->
¿m_size
,

859 
šs
.
objeùid
,

860 
šs
.
off£t
, 
async_ex‹Á
->
·ges
,

861 
async_ex‹Á
->
Ä_·ges
)) {

862 
ex‹Á_io_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

863 
·ge
 *
p
 = 
async_ex‹Á
->
·ges
[0];

864 cÚ¡ 
u64
 
¡¬t
 = 
async_ex‹Á
->start;

865 cÚ¡ 
u64
 
’d
 = 
¡¬t
 + 
async_ex‹Á
->
¿m_size
 - 1;

867 
p
->
m­pšg
 = 
šode
->
i_m­pšg
;

868 
Œ“
->
Ýs
->
	`wr™•age_’d_io_hook
(
p
, 
¡¬t
, 
’d
,

869 
NULL
, 0);

870 
p
->
m­pšg
 = 
NULL
;

871 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,ƒnd,

872 
NULL
, 0,

873 
PAGE_END_WRITEBACK
 |

874 
PAGE_SET_ERROR
);

875 
	`ä“_async_ex‹Á_·ges
(
async_ex‹Á
);

877 
®loc_hšt
 = 
šs
.
objeùid
 + ins.
off£t
;

878 
	`kä“
(
async_ex‹Á
);

879 
	`cÚd_»sched
();

882 
out_ä“_»£rve
:

883 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

884 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 1);

885 
out_ä“
:

886 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
async_ex‹Á
->
¡¬t
,

887 
async_ex‹Á
->
¡¬t
 +

888 
async_ex‹Á
->
¿m_size
 - 1,

889 
async_ex‹Á
->
¡¬t
 +

890 
async_ex‹Á
->
¿m_size
 - 1,

891 
NULL
, 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

892 
EXTENT_DELALLOC_NEW
 |

893 
EXTENT_DEFRAG
 | 
EXTENT_DO_ACCOUNTING
,

894 
PAGE_UNLOCK
 | 
PAGE_CLEAR_DIRTY
 |

895 
PAGE_SET_WRITEBACK
 | 
PAGE_END_WRITEBACK
 |

896 
PAGE_SET_ERROR
);

897 
	`ä“_async_ex‹Á_·ges
(
async_ex‹Á
);

898 
	`kä“
(
async_ex‹Á
);

899 
agaš
;

900 
	}
}

902 
u64
 
	$g‘_ex‹Á_®loÿtiÚ_hšt
(
šode
 *šode, 
u64
 
¡¬t
,

903 
u64
 
num_by‹s
)

905 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

906 
ex‹Á_m­
 *
em
;

907 
u64
 
®loc_hšt
 = 0;

909 
	`»ad_lock
(&
em_Œ“
->
lock
);

910 
em
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
num_by‹s
);

911 ià(
em
) {

917 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

918 
	`ä“_ex‹Á_m­
(
em
);

919 
em
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 0, 0);

920 ià(
em
 &&ƒm->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
)

921 
®loc_hšt
 = 
em
->
block_¡¬t
;

922 ià(
em
)

923 
	`ä“_ex‹Á_m­
(
em
);

925 
®loc_hšt
 = 
em
->
block_¡¬t
;

926 
	`ä“_ex‹Á_m­
(
em
);

929 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

931  
®loc_hšt
;

932 
	}
}

947 
nošlše
 
	$cow_fže_¿nge
(
šode
 *inode,

948 
·ge
 *
locked_·ge
,

949 
u64
 
¡¬t
, u64 
’d
, u64 
d–®loc_’d
,

950 *
·ge_¡¬‹d
, *
Ä_wr™‹n
,

951 
uÆock
, 
bŒfs_dedu³_hash
 *
hash
)

953 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

954 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

955 
u64
 
®loc_hšt
 = 0;

956 
u64
 
num_by‹s
;

957 
¿m_size
;

958 
u64
 
disk_num_by‹s
;

959 
u64
 
cur_®loc_size
 = 0;

960 
u64
 
blocksize
 = 
fs_šfo
->
£ùÜsize
;

961 
bŒfs_key
 
šs
;

962 
ex‹Á_m­
 *
em
;

963 
þ—r_b™s
;

964 
·ge_Ýs
;

965 
boÞ
 
ex‹Á_»£rved
 = 
çl£
;

966 
»t
 = 0;

968 ià(
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))) {

969 
	`WARN_ON_ONCE
(1);

970 
»t
 = -
EINVAL
;

971 
out_uÆock
;

974 
num_by‹s
 = 
	`ALIGN
(
’d
 - 
¡¬t
 + 1, 
blocksize
);

975 
num_by‹s
 = 
	`max
(
blocksize
,‚um_bytes);

976 
disk_num_by‹s
 = 
num_by‹s
;

978 
	`šode_should_deäag
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 
num_by‹s
, 
SZ_64K
);

980 ià(
¡¬t
 == 0) {

982 
»t
 = 
	`cow_fže_¿nge_šlše
(
roÙ
, 
šode
, 
¡¬t
, 
’d
, 0,

983 
BTRFS_COMPRESS_NONE
, 
NULL
);

984 ià(
»t
 == 0) {

985 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,

986 
d–®loc_’d
, 
NULL
,

987 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

988 
EXTENT_DELALLOC_NEW
 |

989 
EXTENT_DEFRAG
, 
PAGE_UNLOCK
 |

990 
PAGE_CLEAR_DIRTY
 | 
PAGE_SET_WRITEBACK
 |

991 
PAGE_END_WRITEBACK
);

992 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
, 
¡¬t
,

993 
’d
 - 
¡¬t
 + 1);

994 *
Ä_wr™‹n
 = *nr_written +

995 (
’d
 - 
¡¬t
 + 
PAGE_SIZE
) / PAGE_SIZE;

996 *
·ge_¡¬‹d
 = 1;

997 
out
;

998 } ià(
»t
 < 0) {

999 
out_uÆock
;

1003 
	`BUG_ON
(
disk_num_by‹s
 >

1004 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
));

1006 
®loc_hšt
 = 
	`g‘_ex‹Á_®loÿtiÚ_hšt
(
šode
, 
¡¬t
, 
num_by‹s
);

1007 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
,

1008 
¡¬t
 + 
num_by‹s
 - 1, 0);

1010 
disk_num_by‹s
 > 0) {

1011 
cur_®loc_size
 = 
disk_num_by‹s
;

1012 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
cur_®loc_size
, cur_alloc_size,

1013 
fs_šfo
->
£ùÜsize
, 0, 
®loc_hšt
,

1014 &
šs
, 1, 1);

1015 ià(
»t
 < 0)

1016 
out_uÆock
;

1017 
cur_®loc_size
 = 
šs
.
off£t
;

1018 
ex‹Á_»£rved
 = 
Œue
;

1020 
¿m_size
 = 
šs
.
off£t
;

1021 
em
 = 
	`ü—‹_io_em
(
šode
, 
¡¬t
, 
šs
.
off£t
,

1022 
¡¬t
,

1023 
šs
.
objeùid
,

1024 
šs
.
off£t
,

1025 
šs
.
off£t
,

1026 
¿m_size
,

1027 
BTRFS_COMPRESS_NONE
,

1028 
BTRFS_ORDERED_REGULAR
 );

1029 ià(
	`IS_ERR
(
em
))

1030 
out_»£rve
;

1031 
	`ä“_ex‹Á_m­
(
em
);

1033 
»t
 = 
	`bŒfs_add_Üd”ed_ex‹Á
(
šode
, 
¡¬t
, 
šs
.
objeùid
,

1034 
¿m_size
, 
cur_®loc_size
, 0);

1035 ià(
»t
)

1036 
out_drÝ_ex‹Á_ÿche
;

1038 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

1039 
BTRFS_DATA_RELOC_TREE_OBJECTID
) {

1040 
»t
 = 
	`bŒfs_»loc_þÚe_csums
(
šode
, 
¡¬t
,

1041 
cur_®loc_size
);

1053 ià(
»t
)

1054 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
,

1055 
¡¬t
 + 
¿m_size
 - 1, 0);

1058 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

1067 
·ge_Ýs
 = 
uÆock
 ? 
PAGE_UNLOCK
 : 0;

1068 
·ge_Ýs
 |ð
PAGE_SET_PRIVATE2
;

1070 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
,

1071 
¡¬t
 + 
¿m_size
 - 1,

1072 
d–®loc_’d
, 
locked_·ge
,

1073 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
,

1074 
·ge_Ýs
);

1075 ià(
disk_num_by‹s
 < 
cur_®loc_size
)

1076 
disk_num_by‹s
 = 0;

1078 
disk_num_by‹s
 -ð
cur_®loc_size
;

1079 
num_by‹s
 -ð
cur_®loc_size
;

1080 
®loc_hšt
 = 
šs
.
objeùid
 + ins.
off£t
;

1081 
¡¬t
 +ð
cur_®loc_size
;

1082 
ex‹Á_»£rved
 = 
çl£
;

1089 ià(
»t
)

1090 
out_uÆock
;

1092 
out
:

1093  
»t
;

1095 
out_drÝ_ex‹Á_ÿche
:

1096 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
, s¹ + 
¿m_size
 - 1, 0);

1097 
out_»£rve
:

1098 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

1099 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
, ins.
off£t
, 1);

1100 
out_uÆock
:

1101 
þ—r_b™s
 = 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

1102 
EXTENT_DEFRAG
 | 
EXTENT_CLEAR_META_RESV
;

1103 
·ge_Ýs
 = 
PAGE_UNLOCK
 | 
PAGE_CLEAR_DIRTY
 | 
PAGE_SET_WRITEBACK
 |

1104 
PAGE_END_WRITEBACK
;

1115 ià(
ex‹Á_»£rved
) {

1116 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
,

1117 
¡¬t
 + 
cur_®loc_size
,

1118 
¡¬t
 + 
cur_®loc_size
,

1119 
locked_·ge
,

1120 
þ—r_b™s
,

1121 
·ge_Ýs
);

1122 
¡¬t
 +ð
cur_®loc_size
;

1123 ià(
¡¬t
 >ð
’d
)

1124 
out
;

1126 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
, 
d–®loc_’d
,

1127 
locked_·ge
,

1128 
þ—r_b™s
 | 
EXTENT_CLEAR_DATA_RESV
,

1129 
·ge_Ýs
);

1130 
out
;

1131 
	}
}

1136 
nošlše
 
	$async_cow_¡¬t
(
bŒfs_wÜk
 *
wÜk
)

1138 
async_cow
 *async_cow;

1139 
num_added
 = 0;

1140 
async_cow
 = 
	`cÚš”_of
(
wÜk
, async_cow, work);

1142 
	`com´ess_fže_¿nge
(
async_cow
->
šode
,‡sync_cow->
locked_·ge
,

1143 
async_cow
->
¡¬t
,‡sync_cow->
’d
,‡sync_cow,

1144 &
num_added
);

1145 ià(
num_added
 == 0) {

1146 
	`bŒfs_add_d–ayed_ut
(
async_cow
->
šode
);

1147 
async_cow
->
šode
 = 
NULL
;

1149 
	}
}

1154 
nošlše
 
	$async_cow_subm™
(
bŒfs_wÜk
 *
wÜk
)

1156 
bŒfs_fs_šfo
 *
fs_šfo
;

1157 
async_cow
 *async_cow;

1158 
bŒfs_roÙ
 *
roÙ
;

1159 
Ä_·ges
;

1161 
async_cow
 = 
	`cÚš”_of
(
wÜk
, async_cow, work);

1163 
roÙ
 = 
async_cow
->root;

1164 
fs_šfo
 = 
roÙ
->fs_info;

1165 
Ä_·ges
 = (
async_cow
->
’d
 -‡sync_cow->
¡¬t
 + 
PAGE_SIZE
) >>

1166 
PAGE_SHIFT
;

1171 ià(
	`©omic_sub_»tuº
(
Ä_·ges
, &
fs_šfo
->
async_d–®loc_·ges
) <

1172 5 * 
SZ_1M
 &&

1173 
	`wa™queue_aùive
(&
fs_šfo
->
async_subm™_wa™
))

1174 
	`wake_up
(&
fs_šfo
->
async_subm™_wa™
);

1176 ià(
async_cow
->
šode
)

1177 
	`subm™_com´es£d_ex‹Ás
(
async_cow
->
šode
,‡sync_cow);

1178 
	}
}

1180 
nošlše
 
	$async_cow_ä“
(
bŒfs_wÜk
 *
wÜk
)

1182 
async_cow
 *async_cow;

1183 
async_cow
 = 
	`cÚš”_of
(
wÜk
, async_cow, work);

1184 ià(
async_cow
->
šode
)

1185 
	`bŒfs_add_d–ayed_ut
(
async_cow
->
šode
);

1186 
	`kä“
(
async_cow
);

1187 
	}
}

1189 
	$cow_fže_¿nge_async
(
šode
 *šode, 
·ge
 *
locked_·ge
,

1190 
u64
 
¡¬t
, u64 
’d
, *
·ge_¡¬‹d
,

1191 *
Ä_wr™‹n
)

1193 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1194 
async_cow
 *async_cow;

1195 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1196 
Ä_·ges
;

1197 
u64
 
cur_’d
;

1199 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
, 
EXTENT_LOCKED
,

1200 1, 0, 
NULL
, 
GFP_NOFS
);

1201 
¡¬t
 < 
’d
) {

1202 
async_cow
 = 
	`km®loc
((*async_cow), 
GFP_NOFS
);

1203 
	`BUG_ON
(!
async_cow
);

1204 
async_cow
->
šode
 = 
	`ig¿b
(inode);

1205 
async_cow
->
roÙ
 =„oot;

1206 
async_cow
->
locked_·ge
 =†ocked_page;

1207 
async_cow
->
¡¬t
 = start;

1209 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NOCOMPRESS
 &&

1210 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FORCE_COMPRESS
))

1211 
cur_’d
 = 
’d
;

1213 
cur_’d
 = 
	`mš
(
’d
, 
¡¬t
 + 
SZ_512K
 - 1);

1215 
async_cow
->
’d
 = 
cur_’d
;

1216 
	`INIT_LIST_HEAD
(&
async_cow
->
ex‹Ás
);

1218 
	`bŒfs_š™_wÜk
(&
async_cow
->
wÜk
,

1219 
bŒfs_d–®loc_h–³r
,

1220 
async_cow_¡¬t
, 
async_cow_subm™
,

1221 
async_cow_ä“
);

1223 
Ä_·ges
 = (
cur_’d
 - 
¡¬t
 + 
PAGE_SIZE
) >>

1224 
PAGE_SHIFT
;

1225 
	`©omic_add
(
Ä_·ges
, &
fs_šfo
->
async_d–®loc_·ges
);

1227 
	`bŒfs_queue_wÜk
(
fs_šfo
->
d–®loc_wÜk”s
, &
async_cow
->
wÜk
);

1229 
	`©omic_»ad
(&
fs_šfo
->
async_subm™_d¿ššg
) &&

1230 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
)) {

1231 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

1232 (
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
) ==

1236 *
Ä_wr™‹n
 +ð
Ä_·ges
;

1237 
¡¬t
 = 
cur_’d
 + 1;

1239 *
·ge_¡¬‹d
 = 1;

1241 
	}
}

1243 
nošlše
 
	$csum_exi¡_š_¿nge
(
bŒfs_fs_šfo
 *
fs_šfo
,

1244 
u64
 
by‹Ä
, u64 
num_by‹s
)

1246 
»t
;

1247 
bŒfs_Üd”ed_sum
 *
sums
;

1248 
	`LIST_HEAD
(
li¡
);

1250 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(
fs_šfo
->
csum_roÙ
, 
by‹Ä
,

1251 
by‹Ä
 + 
num_by‹s
 - 1, &
li¡
, 0);

1252 ià(
»t
 =ð0 && 
	`li¡_em±y
(&
li¡
))

1255 !
	`li¡_em±y
(&
li¡
)) {

1256 
sums
 = 
	`li¡_’Œy
(
li¡
.
Ãxt
, 
bŒfs_Üd”ed_sum
,†ist);

1257 
	`li¡_d–
(&
sums
->
li¡
);

1258 
	`kä“
(
sums
);

1261 
	}
}

1270 
nošlše
 
	$run_d–®loc_nocow
(
šode
 *inode,

1271 
·ge
 *
locked_·ge
,

1272 
u64
 
¡¬t
, u64 
’d
, *
·ge_¡¬‹d
, 
fÜû
,

1273 *
Ä_wr™‹n
)

1275 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1276 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1277 
ex‹Á_bufãr
 *
Ëaf
;

1278 
bŒfs_·th
 *
·th
;

1279 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1280 
bŒfs_key
 
found_key
;

1281 
ex‹Á_m­
 *
em
;

1282 
u64
 
cow_¡¬t
;

1283 
u64
 
cur_off£t
;

1284 
u64
 
ex‹Á_’d
;

1285 
u64
 
ex‹Á_off£t
;

1286 
u64
 
disk_by‹Ä
;

1287 
u64
 
num_by‹s
;

1288 
u64
 
disk_num_by‹s
;

1289 
u64
 
¿m_by‹s
;

1290 
ex‹Á_ty³
;

1291 
»t
, 
”r
;

1292 
ty³
;

1293 
nocow
;

1294 
check_´ev
 = 1;

1295 
boÞ
 
nÞock
;

1296 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

1298 
·th
 = 
	`bŒfs_®loc_·th
();

1299 ià(!
·th
) {

1300 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
¡¬t
, 
’d
,ƒnd,

1301 
locked_·ge
,

1302 
EXTENT_LOCKED
 | 
EXTENT_DELALLOC
 |

1303 
EXTENT_DO_ACCOUNTING
 |

1304 
EXTENT_DEFRAG
, 
PAGE_UNLOCK
 |

1305 
PAGE_CLEAR_DIRTY
 |

1306 
PAGE_SET_WRITEBACK
 |

1307 
PAGE_END_WRITEBACK
);

1308  -
ENOMEM
;

1311 
nÞock
 = 
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
));

1313 
cow_¡¬t
 = (
u64
)-1;

1314 
cur_off£t
 = 
¡¬t
;

1316 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
NULL
, 
roÙ
, 
·th
, 
šo
,

1317 
cur_off£t
, 0);

1318 ià(
»t
 < 0)

1319 
”rÜ
;

1320 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0 && 
check_´ev
) {

1321 
Ëaf
 = 
·th
->
nodes
[0];

1322 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
,

1323 
·th
->
¦Ùs
[0] - 1);

1324 ià(
found_key
.
objeùid
 =ð
šo
 &&

1325 
found_key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
)

1326 
·th
->
¦Ùs
[0]--;

1328 
check_´ev
 = 0;

1329 
Ãxt_¦Ù
:

1330 
Ëaf
 = 
·th
->
nodes
[0];

1331 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

1332 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1333 ià(
»t
 < 0)

1334 
”rÜ
;

1335 ià(
»t
 > 0)

1337 
Ëaf
 = 
·th
->
nodes
[0];

1340 
nocow
 = 0;

1341 
disk_by‹Ä
 = 0;

1342 
num_by‹s
 = 0;

1343 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1345 ià(
found_key
.
objeùid
 > 
šo
)

1347 ià(
	`WARN_ON_ONCE
(
found_key
.
objeùid
 < 
šo
) ||

1348 
found_key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
) {

1349 
·th
->
¦Ùs
[0]++;

1350 
Ãxt_¦Ù
;

1352 ià(
found_key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 ||

1353 
found_key
.
off£t
 > 
’d
)

1356 ià(
found_key
.
off£t
 > 
cur_off£t
) {

1357 
ex‹Á_’d
 = 
found_key
.
off£t
;

1358 
ex‹Á_ty³
 = 0;

1359 
out_check
;

1362 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1363 
bŒfs_fže_ex‹Á_™em
);

1364 
ex‹Á_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
);

1366 
¿m_by‹s
 = 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

1367 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

1368 
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

1369 
disk_by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1370 
ex‹Á_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

1371 
ex‹Á_’d
 = 
found_key
.
off£t
 +

1372 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

1373 
disk_num_by‹s
 =

1374 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

1375 ià(
ex‹Á_’d
 <ð
¡¬t
) {

1376 
·th
->
¦Ùs
[0]++;

1377 
Ãxt_¦Ù
;

1379 ià(
disk_by‹Ä
 == 0)

1380 
out_check
;

1381 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

1382 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

1383 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
))

1384 
out_check
;

1385 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 && !
fÜû
)

1386 
out_check
;

1387 ià(
	`bŒfs_ex‹Á_»adÚly
(
fs_šfo
, 
disk_by‹Ä
))

1388 
out_check
;

1389 ià(
	`bŒfs_üoss_»f_exi¡
(
roÙ
, 
šo
,

1390 
found_key
.
off£t
 -

1391 
ex‹Á_off£t
, 
disk_by‹Ä
))

1392 
out_check
;

1393 
disk_by‹Ä
 +ð
ex‹Á_off£t
;

1394 
disk_by‹Ä
 +ð
cur_off£t
 - 
found_key
.
off£t
;

1395 
num_by‹s
 = 
	`mš
(
’d
 + 1, 
ex‹Á_’d
è- 
cur_off£t
;

1400 ià(!
nÞock
) {

1401 
”r
 = 
	`bŒfs_¡¬t_wr™e_no_¢­shÙtšg
(
roÙ
);

1402 ià(!
”r
)

1403 
out_check
;

1410 ià(
	`csum_exi¡_š_¿nge
(
fs_šfo
, 
disk_by‹Ä
,

1411 
num_by‹s
)) {

1412 ià(!
nÞock
)

1413 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1414 
out_check
;

1416 ià(!
	`bŒfs_šc_nocow_wr™”s
(
fs_šfo
, 
disk_by‹Ä
)) {

1417 ià(!
nÞock
)

1418 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1419 
out_check
;

1421 
nocow
 = 1;

1422 } ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

1423 
ex‹Á_’d
 = 
found_key
.
off£t
 +

1424 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
,

1425 
·th
->
¦Ùs
[0], 
fi
);

1426 
ex‹Á_’d
 = 
	`ALIGN
(extent_end,

1427 
fs_šfo
->
£ùÜsize
);

1429 
	`BUG_ON
(1);

1431 
out_check
:

1432 ià(
ex‹Á_’d
 <ð
¡¬t
) {

1433 
·th
->
¦Ùs
[0]++;

1434 ià(!
nÞock
 && 
nocow
)

1435 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1436 ià(
nocow
)

1437 
	`bŒfs_dec_nocow_wr™”s
(
fs_šfo
, 
disk_by‹Ä
);

1438 
Ãxt_¦Ù
;

1440 ià(!
nocow
) {

1441 ià(
cow_¡¬t
 =ð(
u64
)-1)

1442 
cow_¡¬t
 = 
cur_off£t
;

1443 
cur_off£t
 = 
ex‹Á_’d
;

1444 ià(
cur_off£t
 > 
’d
)

1446 
·th
->
¦Ùs
[0]++;

1447 
Ãxt_¦Ù
;

1450 
	`bŒfs_»Ëa£_·th
(
·th
);

1451 ià(
cow_¡¬t
 !ð(
u64
)-1) {

1452 
»t
 = 
	`cow_fže_¿nge
(
šode
, 
locked_·ge
,

1453 
cow_¡¬t
, 
found_key
.
off£t
 - 1,

1454 
’d
, 
·ge_¡¬‹d
, 
Ä_wr™‹n
, 1,

1455 
NULL
);

1456 ià(
»t
) {

1457 ià(!
nÞock
 && 
nocow
)

1458 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1459 ià(
nocow
)

1460 
	`bŒfs_dec_nocow_wr™”s
(
fs_šfo
,

1461 
disk_by‹Ä
);

1462 
”rÜ
;

1464 
cow_¡¬t
 = (
u64
)-1;

1467 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

1468 
u64
 
Üig_¡¬t
 = 
found_key
.
off£t
 - 
ex‹Á_off£t
;

1470 
em
 = 
	`ü—‹_io_em
(
šode
, 
cur_off£t
, 
num_by‹s
,

1471 
Üig_¡¬t
,

1472 
disk_by‹Ä
,

1473 
num_by‹s
,

1474 
disk_num_by‹s
,

1475 
¿m_by‹s
, 
BTRFS_COMPRESS_NONE
,

1476 
BTRFS_ORDERED_PREALLOC
);

1477 ià(
	`IS_ERR
(
em
)) {

1478 ià(!
nÞock
 && 
nocow
)

1479 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1480 ià(
nocow
)

1481 
	`bŒfs_dec_nocow_wr™”s
(
fs_šfo
,

1482 
disk_by‹Ä
);

1483 
»t
 = 
	`PTR_ERR
(
em
);

1484 
”rÜ
;

1486 
	`ä“_ex‹Á_m­
(
em
);

1489 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

1490 
ty³
 = 
BTRFS_ORDERED_PREALLOC
;

1492 
ty³
 = 
BTRFS_ORDERED_NOCOW
;

1495 
»t
 = 
	`bŒfs_add_Üd”ed_ex‹Á
(
šode
, 
cur_off£t
, 
disk_by‹Ä
,

1496 
num_by‹s
,‚um_by‹s, 
ty³
);

1497 ià(
nocow
)

1498 
	`bŒfs_dec_nocow_wr™”s
(
fs_šfo
, 
disk_by‹Ä
);

1499 
	`BUG_ON
(
»t
);

1501 ià(
roÙ
->
roÙ_key
.
objeùid
 ==

1502 
BTRFS_DATA_RELOC_TREE_OBJECTID
)

1508 
»t
 = 
	`bŒfs_»loc_þÚe_csums
(
šode
, 
cur_off£t
,

1509 
num_by‹s
);

1511 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
cur_off£t
,

1512 
cur_off£t
 + 
num_by‹s
 - 1, 
’d
,

1513 
locked_·ge
, 
EXTENT_LOCKED
 |

1514 
EXTENT_DELALLOC
 |

1515 
EXTENT_CLEAR_DATA_RESV
,

1516 
PAGE_UNLOCK
 | 
PAGE_SET_PRIVATE2
);

1518 ià(!
nÞock
 && 
nocow
)

1519 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

1520 
cur_off£t
 = 
ex‹Á_’d
;

1527 ià(
»t
)

1528 
”rÜ
;

1529 ià(
cur_off£t
 > 
’d
)

1532 
	`bŒfs_»Ëa£_·th
(
·th
);

1534 ià(
cur_off£t
 <ð
’d
 && 
cow_¡¬t
 =ð(
u64
)-1) {

1535 
cow_¡¬t
 = 
cur_off£t
;

1536 
cur_off£t
 = 
’d
;

1539 ià(
cow_¡¬t
 !ð(
u64
)-1) {

1540 
»t
 = 
	`cow_fže_¿nge
(
šode
, 
locked_·ge
, 
cow_¡¬t
, 
’d
,ƒnd,

1541 
·ge_¡¬‹d
, 
Ä_wr™‹n
, 1, 
NULL
);

1542 ià(
»t
)

1543 
”rÜ
;

1546 
”rÜ
:

1547 ià(
»t
 && 
cur_off£t
 < 
’d
)

1548 
	`ex‹Á_þ—r_uÆock_d–®loc
(
šode
, 
cur_off£t
, 
’d
,ƒnd,

1549 
locked_·ge
, 
EXTENT_LOCKED
 |

1550 
EXTENT_DELALLOC
 | 
EXTENT_DEFRAG
 |

1551 
EXTENT_DO_ACCOUNTING
, 
PAGE_UNLOCK
 |

1552 
PAGE_CLEAR_DIRTY
 |

1553 
PAGE_SET_WRITEBACK
 |

1554 
PAGE_END_WRITEBACK
);

1555 
	`bŒfs_ä“_·th
(
·th
);

1556  
»t
;

1557 
	}
}

1559 
šlše
 
	$Ãed_fÜû_cow
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
)

1562 ià(!(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
) &&

1563 !(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_PREALLOC
))

1571 ià(
	`BTRFS_I
(
šode
)->
deäag_by‹s
 &&

1572 
	`‹¡_¿nge_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
,

1573 
EXTENT_DEFRAG
, 0, 
NULL
))

1577 
	}
}

1582 
	$run_d–®loc_¿nge
(*
´iv©e_d©a
, 
·ge
 *
locked_·ge
,

1583 
u64
 
¡¬t
, u64 
’d
, *
·ge_¡¬‹d
,

1584 *
Ä_wr™‹n
)

1586 
šode
 *šodð
´iv©e_d©a
;

1587 
»t
;

1588 
fÜû_cow
 = 
	`Ãed_fÜû_cow
(
šode
, 
¡¬t
, 
’d
);

1590 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
 && !
fÜû_cow
) {

1591 
»t
 = 
	`run_d–®loc_nocow
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
,

1592 
·ge_¡¬‹d
, 1, 
Ä_wr™‹n
);

1593 } ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_PREALLOC
 && !
fÜû_cow
) {

1594 
»t
 = 
	`run_d–®loc_nocow
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
,

1595 
·ge_¡¬‹d
, 0, 
Ä_wr™‹n
);

1596 } ià(!
	`šode_Ãed_com´ess
(
šode
, 
¡¬t
, 
’d
)) {

1597 
»t
 = 
	`cow_fže_¿nge
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
,ƒnd,

1598 
·ge_¡¬‹d
, 
Ä_wr™‹n
, 1, 
NULL
);

1600 
	`£t_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

1601 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

1602 
»t
 = 
	`cow_fže_¿nge_async
(
šode
, 
locked_·ge
, 
¡¬t
, 
’d
,

1603 
·ge_¡¬‹d
, 
Ä_wr™‹n
);

1605 ià(
»t
)

1606 
	`bŒfs_þ—nup_Üd”ed_ex‹Ás
(
šode
, 
¡¬t
, 
’d
 - start + 1);

1607  
»t
;

1608 
	}
}

1610 
	$bŒfs_¥l™_ex‹Á_hook
(*
´iv©e_d©a
,

1611 
ex‹Á_¡©e
 *
Üig
, 
u64
 
¥l™
)

1613 
šode
 *šodð
´iv©e_d©a
;

1614 
u64
 
size
;

1617 ià(!(
Üig
->
¡©e
 & 
EXTENT_DELALLOC
))

1620 
size
 = 
Üig
->
’d
 - orig->
¡¬t
 + 1;

1621 ià(
size
 > 
BTRFS_MAX_EXTENT_SIZE
) {

1622 
u32
 
num_ex‹Ás
;

1623 
u64
 
Ãw_size
;

1629 
Ãw_size
 = 
Üig
->
’d
 - 
¥l™
 + 1;

1630 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
Ãw_size
);

1631 
Ãw_size
 = 
¥l™
 - 
Üig
->
¡¬t
;

1632 
num_ex‹Ás
 +ð
	`couÁ_max_ex‹Ás
(
Ãw_size
);

1633 ià(
	`couÁ_max_ex‹Ás
(
size
è>ð
num_ex‹Ás
)

1637 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1638 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1639 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1640 
	}
}

1648 
	$bŒfs_m”ge_ex‹Á_hook
(*
´iv©e_d©a
,

1649 
ex‹Á_¡©e
 *
Ãw
,

1650 
ex‹Á_¡©e
 *
Ùh”
)

1652 
šode
 *šodð
´iv©e_d©a
;

1653 
u64
 
Ãw_size
, 
Þd_size
;

1654 
u32
 
num_ex‹Ás
;

1657 ià(!(
Ùh”
->
¡©e
 & 
EXTENT_DELALLOC
))

1660 ià(
Ãw
->
¡¬t
 > 
Ùh”
->start)

1661 
Ãw_size
 = 
Ãw
->
’d
 - 
Ùh”
->
¡¬t
 + 1;

1663 
Ãw_size
 = 
Ùh”
->
’d
 - 
Ãw
->
¡¬t
 + 1;

1666 ià(
Ãw_size
 <ð
BTRFS_MAX_EXTENT_SIZE
) {

1667 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1668 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
--;

1669 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1691 
Þd_size
 = 
Ùh”
->
’d
 - oth”->
¡¬t
 + 1;

1692 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
Þd_size
);

1693 
Þd_size
 = 
Ãw
->
’d
 -‚ew->
¡¬t
 + 1;

1694 
num_ex‹Ás
 +ð
	`couÁ_max_ex‹Ás
(
Þd_size
);

1695 ià(
	`couÁ_max_ex‹Ás
(
Ãw_size
è>ð
num_ex‹Ás
)

1698 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1699 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
--;

1700 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1701 
	}
}

1703 
	$bŒfs_add_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
,

1704 
šode
 *inode)

1706 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1708 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

1709 ià(
	`li¡_em±y
(&
	`BTRFS_I
(
šode
)->
d–®loc_šodes
)) {

1710 
	`li¡_add_ž
(&
	`BTRFS_I
(
šode
)->
d–®loc_šodes
,

1711 &
roÙ
->
d–®loc_šodes
);

1712 
	`£t_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

1713 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

1714 
roÙ
->
Ä_d–®loc_šodes
++;

1715 ià(
roÙ
->
Ä_d–®loc_šodes
 == 1) {

1716 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

1717 
	`BUG_ON
(!
	`li¡_em±y
(&
roÙ
->
d–®loc_roÙ
));

1718 
	`li¡_add_ž
(&
roÙ
->
d–®loc_roÙ
,

1719 &
fs_šfo
->
d–®loc_roÙs
);

1720 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

1723 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

1724 
	}
}

1726 
	$bŒfs_d–_d–®loc_šode
(
bŒfs_roÙ
 *
roÙ
,

1727 
bŒfs_šode
 *
šode
)

1729 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1731 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

1732 ià(!
	`li¡_em±y
(&
šode
->
d–®loc_šodes
)) {

1733 
	`li¡_d–_š™
(&
šode
->
d–®loc_šodes
);

1734 
	`þ—r_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

1735 &
šode
->
ruÁime_æags
);

1736 
roÙ
->
Ä_d–®loc_šodes
--;

1737 ià(!
roÙ
->
Ä_d–®loc_šodes
) {

1738 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

1739 
	`BUG_ON
(
	`li¡_em±y
(&
roÙ
->
d–®loc_roÙ
));

1740 
	`li¡_d–_š™
(&
roÙ
->
d–®loc_roÙ
);

1741 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

1744 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

1745 
	}
}

1752 
	$bŒfs_£t_b™_hook
(*
´iv©e_d©a
,

1753 
ex‹Á_¡©e
 *
¡©e
, *
b™s
)

1755 
šode
 *šodð
´iv©e_d©a
;

1757 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1759 ià((*
b™s
 & 
EXTENT_DEFRAG
è&& !(*b™ & 
EXTENT_DELALLOC
))

1760 
	`WARN_ON
(1);

1766 ià(!(
¡©e
->¡©& 
EXTENT_DELALLOC
è&& (*
b™s
 & EXTENT_DELALLOC)) {

1767 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1768 
u64
 
Ën
 = 
¡©e
->
’d
 + 1 - s‹->
¡¬t
;

1769 
boÞ
 
do_li¡
 = !
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
));

1771 ià(*
b™s
 & 
EXTENT_FIRST_DELALLOC
) {

1772 *
b™s
 &ð~
EXTENT_FIRST_DELALLOC
;

1774 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1775 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1776 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1780 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

1783 
	`³rýu_couÁ”_add_b©ch
(&
fs_šfo
->
d–®loc_by‹s
, 
Ën
,

1784 
fs_šfo
->
d–®loc_b©ch
);

1785 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1786 
	`BTRFS_I
(
šode
)->
d–®loc_by‹s
 +ð
Ën
;

1787 ià(*
b™s
 & 
EXTENT_DEFRAG
)

1788 
	`BTRFS_I
(
šode
)->
deäag_by‹s
 +ð
Ën
;

1789 ià(
do_li¡
 && !
	`‹¡_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

1790 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

1791 
	`bŒfs_add_d–®loc_šodes
(
roÙ
, 
šode
);

1792 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1795 ià(!(
¡©e
->¡©& 
EXTENT_DELALLOC_NEW
) &&

1796 (*
b™s
 & 
EXTENT_DELALLOC_NEW
)) {

1797 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1798 
	`BTRFS_I
(
šode
)->
Ãw_d–®loc_by‹s
 +ð
¡©e
->
’d
 + 1 -

1799 
¡©e
->
¡¬t
;

1800 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1802 
	}
}

1807 
	$bŒfs_þ—r_b™_hook
(*
´iv©e_d©a
,

1808 
ex‹Á_¡©e
 *
¡©e
,

1809 *
b™s
)

1811 
bŒfs_šode
 *
šode
 = 
	`BTRFS_I
((šod*)
´iv©e_d©a
);

1812 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

1813 
u64
 
Ën
 = 
¡©e
->
’d
 + 1 - s‹->
¡¬t
;

1814 
u32
 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
Ën
);

1816 ià((
¡©e
->¡©& 
EXTENT_DEFRAG
è&& (*
b™s
 & EXTENT_DEFRAG)) {

1817 
	`¥š_lock
(&
šode
->
lock
);

1818 
šode
->
deäag_by‹s
 -ð
Ën
;

1819 
	`¥š_uÆock
(&
šode
->
lock
);

1827 ià((
¡©e
->¡©& 
EXTENT_DELALLOC
è&& (*
b™s
 & EXTENT_DELALLOC)) {

1828 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

1829 
boÞ
 
do_li¡
 = !
	`bŒfs_is_ä“_¥aû_šode
(
šode
);

1831 ià(*
b™s
 & 
EXTENT_FIRST_DELALLOC
) {

1832 *
b™s
 &ð~
EXTENT_FIRST_DELALLOC
;

1833 } ià(!(*
b™s
 & 
EXTENT_CLEAR_META_RESV
)) {

1834 
	`¥š_lock
(&
šode
->
lock
);

1835 
šode
->
out¡ªdšg_ex‹Ás
 -ð
num_ex‹Ás
;

1836 
	`¥š_uÆock
(&
šode
->
lock
);

1844 ià(*
b™s
 & 
EXTENT_CLEAR_META_RESV
 &&

1845 
roÙ
 !ð
fs_šfo
->
Œ“_roÙ
)

1846 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
šode
, 
Ën
);

1849 ià(
	`bŒfs_is_‹¡šg
(
fs_šfo
))

1852 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_DATA_RELOC_TREE_OBJECTID
 &&

1853 
do_li¡
 && !(
¡©e
->¡©& 
EXTENT_NORESERVE
) &&

1854 (*
b™s
 & 
EXTENT_CLEAR_DATA_RESV
))

1855 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(

1856 &
šode
->
vfs_šode
,

1857 
¡©e
->
¡¬t
, 
Ën
);

1859 
	`³rýu_couÁ”_add_b©ch
(&
fs_šfo
->
d–®loc_by‹s
, -
Ën
,

1860 
fs_šfo
->
d–®loc_b©ch
);

1861 
	`¥š_lock
(&
šode
->
lock
);

1862 
šode
->
d–®loc_by‹s
 -ð
Ën
;

1863 ià(
do_li¡
 && 
šode
->
d–®loc_by‹s
 == 0 &&

1864 
	`‹¡_b™
(
BTRFS_INODE_IN_DELALLOC_LIST
,

1865 &
šode
->
ruÁime_æags
))

1866 
	`bŒfs_d–_d–®loc_šode
(
roÙ
, 
šode
);

1867 
	`¥š_uÆock
(&
šode
->
lock
);

1870 ià((
¡©e
->¡©& 
EXTENT_DELALLOC_NEW
) &&

1871 (*
b™s
 & 
EXTENT_DELALLOC_NEW
)) {

1872 
	`¥š_lock
(&
šode
->
lock
);

1873 
	`ASSERT
(
šode
->
Ãw_d–®loc_by‹s
 >ð
Ën
);

1874 
šode
->
Ãw_d–®loc_by‹s
 -ð
Ën
;

1875 
	`¥š_uÆock
(&
šode
->
lock
);

1877 
	}
}

1887 
	$bŒfs_m”ge_bio_hook
(
·ge
 *·ge, 
off£t
,

1888 
size_t
 
size
, 
bio
 *bio,

1889 
bio_æags
)

1891 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

1892 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1893 
u64
 
logiÿl
 = (u64)
bio
->
bi_™”
.
bi_£ùÜ
 << 9;

1894 
u64
 
Ëngth
 = 0;

1895 
u64
 
m­_Ëngth
;

1896 
»t
;

1898 ià(
bio_æags
 & 
EXTENT_BIO_COMPRESSED
)

1901 
Ëngth
 = 
bio
->
bi_™”
.
bi_size
;

1902 
m­_Ëngth
 = 
Ëngth
;

1903 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
	`bŒfs_Ý
(
bio
), 
logiÿl
, &
m­_Ëngth
,

1904 
NULL
, 0);

1905 ià(
»t
 < 0)

1906  
»t
;

1907 ià(
m­_Ëngth
 < 
Ëngth
 + 
size
)

1910 
	}
}

1920 
blk_¡©us_t
 
	$__bŒfs_subm™_bio_¡¬t
(*
´iv©e_d©a
, 
bio
 *bio,

1921 
mœrÜ_num
, 
bio_æags
,

1922 
u64
 
bio_off£t
)

1924 
šode
 *šodð
´iv©e_d©a
;

1925 
blk_¡©us_t
 
»t
 = 0;

1927 
»t
 = 
	`bŒfs_csum_Úe_bio
(
šode
, 
bio
, 0, 0);

1928 
	`BUG_ON
(
»t
);

1930 
	}
}

1940 
blk_¡©us_t
 
	$__bŒfs_subm™_bio_dÚe
(*
´iv©e_d©a
, 
bio
 *bio,

1941 
mœrÜ_num
, 
bio_æags
,

1942 
u64
 
bio_off£t
)

1944 
šode
 *šodð
´iv©e_d©a
;

1945 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1946 
blk_¡©us_t
 
»t
;

1948 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 1);

1949 ià(
»t
) {

1950 
bio
->
bi_¡©us
 = 
»t
;

1951 
	`bio_’dio
(
bio
);

1953  
»t
;

1954 
	}
}

1960 
blk_¡©us_t
 
	$bŒfs_subm™_bio_hook
(*
´iv©e_d©a
, 
bio
 *bio,

1961 
mœrÜ_num
, 
bio_æags
,

1962 
u64
 
bio_off£t
)

1964 
šode
 *šodð
´iv©e_d©a
;

1965 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1966 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1967 
bŒfs_wq_’dio_ty³
 
m‘ad©a
 = 
BTRFS_WQ_ENDIO_DATA
;

1968 
blk_¡©us_t
 
»t
 = 0;

1969 
sk_sum
;

1970 
async
 = !
	`©omic_»ad
(&
	`BTRFS_I
(
šode
)->
sync_wr™”s
);

1972 
sk_sum
 = 
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
;

1974 ià(
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
)))

1975 
m‘ad©a
 = 
BTRFS_WQ_ENDIO_FREE_SPACE
;

1977 ià(
	`bio_Ý
(
bio
è!ð
REQ_OP_WRITE
) {

1978 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
bio
, 
m‘ad©a
);

1979 ià(
»t
)

1980 
out
;

1982 ià(
bio_æags
 & 
EXTENT_BIO_COMPRESSED
) {

1983 
»t
 = 
	`bŒfs_subm™_com´es£d_»ad
(
šode
, 
bio
,

1984 
mœrÜ_num
,

1985 
bio_æags
);

1986 
out
;

1987 } ià(!
sk_sum
) {

1988 
»t
 = 
	`bŒfs_lookup_bio_sums
(
šode
, 
bio
, 
NULL
);

1989 ià(
»t
)

1990 
out
;

1992 
m­™
;

1993 } ià(
async
 && !
sk_sum
) {

1995 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_DATA_RELOC_TREE_OBJECTID
)

1996 
m­™
;

1998 
»t
 = 
	`bŒfs_wq_subm™_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 
bio_æags
,

1999 
bio_off£t
, 
šode
,

2000 
__bŒfs_subm™_bio_¡¬t
,

2001 
__bŒfs_subm™_bio_dÚe
);

2002 
out
;

2003 } ià(!
sk_sum
) {

2004 
»t
 = 
	`bŒfs_csum_Úe_bio
(
šode
, 
bio
, 0, 0);

2005 ià(
»t
)

2006 
out
;

2009 
m­™
:

2010 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 0);

2012 
out
:

2013 ià(
»t
) {

2014 
bio
->
bi_¡©us
 = 
»t
;

2015 
	`bio_’dio
(
bio
);

2017  
»t
;

2018 
	}
}

2024 
nošlše
 
	$add_³ndšg_csums
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2025 
šode
 *šode, 
li¡_h—d
 *
li¡
)

2027 
bŒfs_Üd”ed_sum
 *
sum
;

2029 
	`li¡_fÜ_—ch_’Œy
(
sum
, 
li¡
,†ist) {

2030 
Œªs
->
addšg_csums
 = 1;

2031 
	`bŒfs_csum_fže_blocks
(
Œªs
,

2032 
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
->
csum_roÙ
, 
sum
);

2033 
Œªs
->
addšg_csums
 = 0;

2036 
	}
}

2038 
	$bŒfs_£t_ex‹Á_d–®loc
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

2039 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
dedu³
)

2041 
	`WARN_ON
((
’d
 & (
PAGE_SIZE
 - 1)) == 0);

2042  
	`£t_ex‹Á_d–®loc
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
,

2043 
ÿched_¡©e
);

2044 
	}
}

2047 
	sbŒfs_wr™•age_fixup
 {

2048 
·ge
 *
	m·ge
;

2049 
bŒfs_wÜk
 
	mwÜk
;

2052 
	$bŒfs_wr™•age_fixup_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

2054 
bŒfs_wr™•age_fixup
 *
fixup
;

2055 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2056 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2057 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

2058 
·ge
 *page;

2059 
šode
 *inode;

2060 
u64
 
·ge_¡¬t
;

2061 
u64
 
·ge_’d
;

2062 
»t
;

2064 
fixup
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_wr™•age_fixup
, work);

2065 
·ge
 = 
fixup
->page;

2066 
agaš
:

2067 
	`lock_·ge
(
·ge
);

2068 ià(!
·ge
->
m­pšg
 || !
	`PageDœty
Õageè|| !
	`PageChecked
(page)) {

2069 
	`CË¬PageChecked
(
·ge
);

2070 
out_·ge
;

2073 
šode
 = 
·ge
->
m­pšg
->
ho¡
;

2074 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

2075 
·ge_’d
 = 
	`·ge_off£t
(
·ge
è+ 
PAGE_SIZE
 - 1;

2077 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

2078 &
ÿched_¡©e
);

2081 ià(
	`PagePriv©e2
(
·ge
))

2082 
out
;

2084 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
·ge_¡¬t
,

2085 
PAGE_SIZE
);

2086 ià(
Üd”ed
) {

2087 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
,

2088 
·ge_’d
, &
ÿched_¡©e
, 
GFP_NOFS
);

2089 
	`uÆock_·ge
(
·ge
);

2090 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

2091 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2092 
agaš
;

2095 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
, 
·ge_¡¬t
,

2096 
PAGE_SIZE
);

2097 ià(
»t
) {

2098 
	`m­pšg_£t_”rÜ
(
·ge
->
m­pšg
, 
»t
);

2099 
	`’d_ex‹Á_wr™•age
(
·ge
, 
»t
, 
·ge_¡¬t
, 
·ge_’d
);

2100 
	`CË¬PageChecked
(
·ge
);

2101 
out
;

2104 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
,

2106 
	`CË¬PageChecked
(
·ge
);

2107 
	`£t_·ge_dœty
(
·ge
);

2108 
out
:

2109 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

2110 &
ÿched_¡©e
, 
GFP_NOFS
);

2111 
out_·ge
:

2112 
	`uÆock_·ge
(
·ge
);

2113 
	`put_·ge
(
·ge
);

2114 
	`kä“
(
fixup
);

2115 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

2116 
	}
}

2129 
	$bŒfs_wr™•age_¡¬t_hook
(
·ge
 *·ge, 
u64
 
¡¬t
, u64 
’d
)

2131 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

2132 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2133 
bŒfs_wr™•age_fixup
 *
fixup
;

2136 ià(
	`Te¡CË¬PagePriv©e2
(
·ge
))

2139 ià(
	`PageChecked
(
·ge
))

2140  -
EAGAIN
;

2142 
fixup
 = 
	`kz®loc
((*fixup), 
GFP_NOFS
);

2143 ià(!
fixup
)

2144  -
EAGAIN
;

2146 
	`S‘PageChecked
(
·ge
);

2147 
	`g‘_·ge
(
·ge
);

2148 
	`bŒfs_š™_wÜk
(&
fixup
->
wÜk
, 
bŒfs_fixup_h–³r
,

2149 
bŒfs_wr™•age_fixup_wÜk”
, 
NULL
, NULL);

2150 
fixup
->
·ge
 =…age;

2151 
	`bŒfs_queue_wÜk
(
fs_šfo
->
fixup_wÜk”s
, &
fixup
->
wÜk
);

2152  -
EBUSY
;

2153 
	}
}

2155 
	$š£¹_»£rved_fže_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2156 
šode
 *šode, 
u64
 
fže_pos
,

2157 
u64
 
disk_by‹Ä
, u64 
disk_num_by‹s
,

2158 
u64
 
num_by‹s
, u64 
¿m_by‹s
,

2159 
u8
 
com´essiÚ
, u8 
’üy±iÚ
,

2160 
u16
 
Ùh”_’codšg
, 
ex‹Á_ty³
)

2162 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2163 
bŒfs_fže_ex‹Á_™em
 *
fi
;

2164 
bŒfs_·th
 *
·th
;

2165 
ex‹Á_bufãr
 *
Ëaf
;

2166 
bŒfs_key
 
šs
;

2167 
u64
 
qg_»Ëa£d
;

2168 
ex‹Á_š£¹ed
 = 0;

2169 
»t
;

2171 
·th
 = 
	`bŒfs_®loc_·th
();

2172 ià(!
·th
)

2173  -
ENOMEM
;

2184 
»t
 = 
	`__bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
fže_pos
,

2185 
fže_pos
 + 
num_by‹s
, 
NULL
, 0,

2186 1, (*
fi
), &
ex‹Á_š£¹ed
);

2187 ià(
»t
)

2188 
out
;

2190 ià(!
ex‹Á_š£¹ed
) {

2191 
šs
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

2192 
šs
.
off£t
 = 
fže_pos
;

2193 
šs
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2195 
·th
->
Ëave_¥šnšg
 = 1;

2196 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
šs
,

2197 (*
fi
));

2198 ià(
»t
)

2199 
out
;

2201 
Ëaf
 = 
·th
->
nodes
[0];

2202 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2203 
bŒfs_fže_ex‹Á_™em
);

2204 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
);

2205 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
fi
, 
ex‹Á_ty³
);

2206 
	`bŒfs_£t_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
, 
disk_by‹Ä
);

2207 
	`bŒfs_£t_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
, 
disk_num_by‹s
);

2208 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 0);

2209 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
num_by‹s
);

2210 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
¿m_by‹s
);

2211 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
, 
com´essiÚ
);

2212 
	`bŒfs_£t_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
, 
’üy±iÚ
);

2213 
	`bŒfs_£t_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
, 
Ùh”_’codšg
);

2215 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2216 
	`bŒfs_»Ëa£_·th
(
·th
);

2218 
	`šode_add_by‹s
(
šode
, 
num_by‹s
);

2220 
šs
.
objeùid
 = 
disk_by‹Ä
;

2221 
šs
.
off£t
 = 
disk_num_by‹s
;

2222 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

2228 
»t
 = 
	`bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
fže_pos
, 
¿m_by‹s
);

2229 ià(
»t
 < 0)

2230 
out
;

2231 
qg_»Ëa£d
 = 
»t
;

2232 
»t
 = 
	`bŒfs_®loc_»£rved_fže_ex‹Á
(
Œªs
, 
roÙ
->
roÙ_key
.
objeùid
,

2233 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
fže_pos
, 
qg_»Ëa£d
, &
šs
);

2234 
out
:

2235 
	`bŒfs_ä“_·th
(
·th
);

2237  
»t
;

2238 
	}
}

2241 
	s§_deäag_ex‹Á_back»f
 {

2242 
rb_node
 
	mnode
;

2243 
Þd_§_deäag_ex‹Á
 *
	mÞd
;

2244 
u64
 
	mroÙ_id
;

2245 
u64
 
	mšum
;

2246 
u64
 
	mfže_pos
;

2247 
u64
 
	mex‹Á_off£t
;

2248 
u64
 
	mnum_by‹s
;

2249 
u64
 
	mg’”©iÚ
;

2252 
	sÞd_§_deäag_ex‹Á
 {

2253 
li¡_h—d
 
	mli¡
;

2254 
Ãw_§_deäag_ex‹Á
 *
	mÃw
;

2256 
u64
 
	mex‹Á_off£t
;

2257 
u64
 
	mby‹Ä
;

2258 
u64
 
	moff£t
;

2259 
u64
 
	mËn
;

2260 
	mcouÁ
;

2263 
	sÃw_§_deäag_ex‹Á
 {

2264 
rb_roÙ
 
	mroÙ
;

2265 
li¡_h—d
 
	mh—d
;

2266 
bŒfs_·th
 *
	m·th
;

2267 
šode
 *
	mšode
;

2268 
u64
 
	mfže_pos
;

2269 
u64
 
	mËn
;

2270 
u64
 
	mby‹Ä
;

2271 
u64
 
	mdisk_Ën
;

2272 
u8
 
	mcom´ess_ty³
;

2275 
	$back»f_comp
(
§_deäag_ex‹Á_back»f
 *
b1
,

2276 
§_deäag_ex‹Á_back»f
 *
b2
)

2278 ià(
b1
->
roÙ_id
 < 
b2
->root_id)

2280 ià(
b1
->
roÙ_id
 > 
b2
->root_id)

2283 ià(
b1
->
šum
 < 
b2
->inum)

2285 ià(
b1
->
šum
 > 
b2
->inum)

2288 ià(
b1
->
fže_pos
 < 
b2
->file_pos)

2290 ià(
b1
->
fže_pos
 > 
b2
->file_pos)

2306 
	}
}

2308 
	$back»f_š£¹
(
rb_roÙ
 *
roÙ
,

2309 
§_deäag_ex‹Á_back»f
 *
back»f
)

2311 
rb_node
 **
p
 = &
roÙ
->rb_node;

2312 
rb_node
 *
·»Á
 = 
NULL
;

2313 
§_deäag_ex‹Á_back»f
 *
’Œy
;

2314 
»t
;

2316 *
p
) {

2317 
·»Á
 = *
p
;

2318 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
§_deäag_ex‹Á_back»f
, 
node
);

2320 
»t
 = 
	`back»f_comp
(
back»f
, 
’Œy
);

2321 ià(
»t
 < 0)

2322 
p
 = &(*p)->
rb_Ëá
;

2324 
p
 = &(*p)->
rb_right
;

2327 
	`rb_lšk_node
(&
back»f
->
node
, 
·»Á
, 
p
);

2328 
	`rb_š£¹_cÞÜ
(&
back»f
->
node
, 
roÙ
);

2329 
	}
}

2334 
nošlše
 
	$»cÜd_Úe_back»f
(
u64
 
šum
, u64 
off£t
, u64 
roÙ_id
,

2335 *
ùx
)

2337 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

2338 
Þd_§_deäag_ex‹Á
 *
Þd
 = 
ùx
;

2339 
Ãw_§_deäag_ex‹Á
 *
Ãw
 = 
Þd
->new;

2340 
bŒfs_·th
 *
·th
 = 
Ãw
->path;

2341 
bŒfs_key
 
key
;

2342 
bŒfs_roÙ
 *
roÙ
;

2343 
§_deäag_ex‹Á_back»f
 *
back»f
;

2344 
ex‹Á_bufãr
 *
Ëaf
;

2345 
šode
 *šodð
Ãw
->inode;

2346 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2347 
¦Ù
;

2348 
»t
;

2349 
u64
 
ex‹Á_off£t
;

2350 
u64
 
num_by‹s
;

2352 ià(
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.
objeùid
 =ð
roÙ_id
 &&

2353 
šum
 =ð
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)))

2356 
key
.
objeùid
 = 
roÙ_id
;

2357 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2358 
key
.
off£t
 = (
u64
)-1;

2360 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

2361 ià(
	`IS_ERR
(
roÙ
)) {

2362 ià(
	`PTR_ERR
(
roÙ
è=ð-
ENOENT
)

2364 
	`WARN_ON
(1);

2365 
	`bŒfs_debug
(
fs_šfo
, "inum=%llu, offset=%llu,„oot_id=%llu",

2366 
šum
, 
off£t
, 
roÙ_id
);

2367  
	`PTR_ERR
(
roÙ
);

2370 
key
.
objeùid
 = 
šum
;

2371 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2372 ià(
off£t
 > (
u64
)-1 << 32)

2373 
key
.
off£t
 = 0;

2375 
key
.
off£t
 = offset;

2377 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2378 ià(
	`WARN_ON
(
»t
 < 0))

2379  
»t
;

2380 
»t
 = 0;

2383 
	`cÚd_»sched
();

2385 
Ëaf
 = 
·th
->
nodes
[0];

2386 
¦Ù
 = 
·th
->
¦Ùs
[0];

2388 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

2389 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2390 ià(
»t
 < 0) {

2391 
out
;

2392 } ià(
»t
 > 0) {

2393 
»t
 = 0;

2394 
out
;

2399 
·th
->
¦Ùs
[0]++;

2401 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

2403 ià(
key
.
objeùid
 > 
šum
)

2404 
out
;

2406 ià(
key
.
objeùid
 < 
šum
 || key.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

2409 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

2410 
bŒfs_fže_ex‹Á_™em
);

2412 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ex‹Á
è!ð
Þd
->
by‹Ä
)

2420 ià(
key
.
off£t
 != offset)

2423 
ex‹Á_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
ex‹Á
);

2424 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
);

2426 ià(
ex‹Á_off£t
 >ð
Þd
->ex‹Á_off£ˆ+ old->
off£t
 +

2427 
Þd
->
Ën
 || 
ex‹Á_off£t
 + 
num_by‹s
 <=

2428 
Þd
->
ex‹Á_off£t
 + old->
off£t
)

2433 
back»f
 = 
	`km®loc
((*back»f), 
GFP_NOFS
);

2434 ià(!
back»f
) {

2435 
»t
 = -
ENOENT
;

2436 
out
;

2439 
back»f
->
roÙ_id
 =„oot_id;

2440 
back»f
->
šum
 = inum;

2441 
back»f
->
fže_pos
 = 
off£t
;

2442 
back»f
->
num_by‹s
 =‚um_bytes;

2443 
back»f
->
ex‹Á_off£t
 =ƒxtent_offset;

2444 
back»f
->
g’”©iÚ
 = 
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
ex‹Á
);

2445 
back»f
->
Þd
 = old;

2446 
	`back»f_š£¹
(&
Ãw
->
roÙ
, 
back»f
);

2447 
Þd
->
couÁ
++;

2448 
out
:

2449 
	`bŒfs_»Ëa£_·th
(
·th
);

2450 
	`WARN_ON
(
»t
);

2451  
»t
;

2452 
	}
}

2454 
nošlše
 
boÞ
 
	$»cÜd_ex‹Á_back»fs
(
bŒfs_·th
 *
·th
,

2455 
Ãw_§_deäag_ex‹Á
 *
Ãw
)

2457 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Ãw
->
šode
->
i_sb
);

2458 
Þd_§_deäag_ex‹Á
 *
Þd
, *
tmp
;

2459 
»t
;

2461 
Ãw
->
·th
 =…ath;

2463 
	`li¡_fÜ_—ch_’Œy_§ã
(
Þd
, 
tmp
, &
Ãw
->
h—d
, 
li¡
) {

2464 
»t
 = 
	`™”©e_šodes_äom_logiÿl
(
Þd
->
by‹Ä
 +

2465 
Þd
->
ex‹Á_off£t
, 
fs_šfo
,

2466 
·th
, 
»cÜd_Úe_back»f
,

2467 
Þd
);

2468 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

2469  
çl£
;

2472 ià(!
Þd
->
couÁ
) {

2473 
	`li¡_d–
(&
Þd
->
li¡
);

2474 
	`kä“
(
Þd
);

2478 ià(
	`li¡_em±y
(&
Ãw
->
h—d
))

2479  
çl£
;

2481  
Œue
;

2482 
	}
}

2484 
	$»lšk_is_m”gabË
(
ex‹Á_bufãr
 *
Ëaf
,

2485 
bŒfs_fže_ex‹Á_™em
 *
fi
,

2486 
Ãw_§_deäag_ex‹Á
 *
Ãw
)

2488 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
è!ð
Ãw
->
by‹Ä
)

2491 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
è!ð
BTRFS_FILE_EXTENT_REG
)

2494 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
è!ð
Ãw
->
com´ess_ty³
)

2497 ià(
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

2498 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
))

2502 
	}
}

2507 
nošlše
 
	$»lšk_ex‹Á_back»f
(
bŒfs_·th
 *
·th
,

2508 
§_deäag_ex‹Á_back»f
 *
´ev
,

2509 
§_deäag_ex‹Á_back»f
 *
back»f
)

2511 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

2512 
bŒfs_fže_ex‹Á_™em
 *
™em
;

2513 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2514 
bŒfs_Œªs_hªdË
 *
Œªs
;

2515 
bŒfs_roÙ
 *
roÙ
;

2516 
bŒfs_key
 
key
;

2517 
ex‹Á_bufãr
 *
Ëaf
;

2518 
Þd_§_deäag_ex‹Á
 *
Þd
 = 
back»f
->old;

2519 
Ãw_§_deäag_ex‹Á
 *
Ãw
 = 
Þd
->new;

2520 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Ãw
->
šode
->
i_sb
);

2521 
šode
 *inode;

2522 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

2523 
»t
 = 0;

2524 
u64
 
¡¬t
;

2525 
u64
 
Ën
;

2526 
u64
 
lock_¡¬t
;

2527 
u64
 
lock_’d
;

2528 
boÞ
 
m”ge
 = 
çl£
;

2529 
šdex
;

2531 ià(
´ev
 &&…»v->
roÙ_id
 =ð
back»f
->root_id &&

2532 
´ev
->
šum
 =ð
back»f
->inum &&

2533 
´ev
->
fže_pos
 +…»v->
num_by‹s
 =ð
back»f
->file_pos)

2534 
m”ge
 = 
Œue
;

2537 
key
.
objeùid
 = 
back»f
->
roÙ_id
;

2538 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2539 
key
.
off£t
 = (
u64
)-1;

2541 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

2543 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

2544 ià(
	`IS_ERR
(
roÙ
)) {

2545 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

2546 ià(
	`PTR_ERR
(
roÙ
è=ð-
ENOENT
)

2548  
	`PTR_ERR
(
roÙ
);

2551 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
)) {

2552 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

2557 
key
.
objeùid
 = 
back»f
->
šum
;

2558 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

2559 
key
.
off£t
 = 0;

2561 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
roÙ
, 
NULL
);

2562 ià(
	`IS_ERR
(
šode
)) {

2563 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

2567 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

2570 
lock_¡¬t
 = 
back»f
->
fže_pos
;

2571 
lock_’d
 = 
back»f
->
fže_pos
 + back»f->
num_by‹s
 - 1;

2572 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock_¡¬t
, 
lock_’d
,

2573 &
ÿched
);

2575 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
, 
lock_’d
);

2576 ià(
Üd”ed
) {

2577 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2578 
out_uÆock
;

2581 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

2582 ià(
	`IS_ERR
(
Œªs
)) {

2583 
»t
 = 
	`PTR_ERR
(
Œªs
);

2584 
out_uÆock
;

2587 
key
.
objeùid
 = 
back»f
->
šum
;

2588 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2589 
key
.
off£t
 = 
back»f
->
fže_pos
;

2591 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2592 ià(
»t
 < 0) {

2593 
out_ä“_·th
;

2594 } ià(
»t
 > 0) {

2595 
»t
 = 0;

2596 
out_ä“_·th
;

2599 
ex‹Á
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2600 
bŒfs_fže_ex‹Á_™em
);

2602 ià(
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
·th
->
nodes
[0], 
ex‹Á
) !=

2603 
back»f
->
g’”©iÚ
)

2604 
out_ä“_·th
;

2606 
	`bŒfs_»Ëa£_·th
(
·th
);

2608 
¡¬t
 = 
back»f
->
fže_pos
;

2609 ià(
back»f
->
ex‹Á_off£t
 < 
Þd
->ex‹Á_off£ˆ+ old->
off£t
)

2610 
¡¬t
 +ð
Þd
->
ex‹Á_off£t
 + old->
off£t
 -

2611 
back»f
->
ex‹Á_off£t
;

2613 
Ën
 = 
	`mš
(
back»f
->
ex‹Á_off£t
 + back»f->
num_by‹s
,

2614 
Þd
->
ex‹Á_off£t
 + old->
off£t
 + old->
Ën
);

2615 
Ën
 -ð
	`max
(
back»f
->
ex‹Á_off£t
, 
Þd
->ex‹Á_off£ˆ+ old->
off£t
);

2617 
»t
 = 
	`bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
¡¬t
,

2618 
¡¬t
 + 
Ën
, 1);

2619 ià(
»t
)

2620 
out_ä“_·th
;

2621 
agaš
:

2622 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

2623 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2624 
key
.
off£t
 = 
¡¬t
;

2626 
·th
->
Ëave_¥šnšg
 = 1;

2627 ià(
m”ge
) {

2628 
bŒfs_fže_ex‹Á_™em
 *
fi
;

2629 
u64
 
ex‹Á_Ën
;

2630 
bŒfs_key
 
found_key
;

2632 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

2633 ià(
»t
 < 0)

2634 
out_ä“_·th
;

2636 
·th
->
¦Ùs
[0]--;

2637 
Ëaf
 = 
·th
->
nodes
[0];

2638 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

2640 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2641 
bŒfs_fže_ex‹Á_™em
);

2642 
ex‹Á_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

2644 ià(
ex‹Á_Ën
 + 
found_key
.
off£t
 =ð
¡¬t
 &&

2645 
	`»lšk_is_m”gabË
(
Ëaf
, 
fi
, 
Ãw
)) {

2646 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

2647 
ex‹Á_Ën
 + 
Ën
);

2648 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2649 
	`šode_add_by‹s
(
šode
, 
Ën
);

2651 
»t
 = 1;

2652 
out_ä“_·th
;

2654 
m”ge
 = 
çl£
;

2655 
	`bŒfs_»Ëa£_·th
(
·th
);

2656 
agaš
;

2660 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

2661 (*
ex‹Á
));

2662 ià(
»t
) {

2663 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2664 
out_ä“_·th
;

2667 
Ëaf
 = 
·th
->
nodes
[0];

2668 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2669 
bŒfs_fže_ex‹Á_™em
);

2670 
	`bŒfs_£t_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
™em
, 
Ãw
->
by‹Ä
);

2671 
	`bŒfs_£t_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
™em
, 
Ãw
->
disk_Ën
);

2672 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
™em
, 
¡¬t
 - 
Ãw
->
fže_pos
);

2673 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
™em
, 
Ën
);

2674 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
™em
, 
Ãw
->
Ën
);

2675 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
™em
, 
Œªs
->
Œªsid
);

2676 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
™em
, 
BTRFS_FILE_EXTENT_REG
);

2677 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
, 
Ãw
->
com´ess_ty³
);

2678 
	`bŒfs_£t_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
™em
, 0);

2679 
	`bŒfs_£t_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
™em
, 0);

2681 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2682 
	`šode_add_by‹s
(
šode
, 
Ën
);

2683 
	`bŒfs_»Ëa£_·th
(
·th
);

2685 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
Ãw
->
by‹Ä
,

2686 
Ãw
->
disk_Ën
, 0,

2687 
back»f
->
roÙ_id
, back»f->
šum
,

2688 
Ãw
->
fže_pos
);

2689 ià(
»t
) {

2690 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2691 
out_ä“_·th
;

2694 
»t
 = 1;

2695 
out_ä“_·th
:

2696 
	`bŒfs_»Ëa£_·th
(
·th
);

2697 
·th
->
Ëave_¥šnšg
 = 0;

2698 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2699 
out_uÆock
:

2700 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock_¡¬t
, 
lock_’d
,

2701 &
ÿched
, 
GFP_NOFS
);

2702 
	`ut
(
šode
);

2703  
»t
;

2704 
	}
}

2706 
	$ä“_§_deäag_ex‹Á
(
Ãw_§_deäag_ex‹Á
 *
Ãw
)

2708 
Þd_§_deäag_ex‹Á
 *
Þd
, *
tmp
;

2710 ià(!
Ãw
)

2713 
	`li¡_fÜ_—ch_’Œy_§ã
(
Þd
, 
tmp
, &
Ãw
->
h—d
, 
li¡
) {

2714 
	`kä“
(
Þd
);

2716 
	`kä“
(
Ãw
);

2717 
	}
}

2719 
	$»lšk_fže_ex‹Ás
(
Ãw_§_deäag_ex‹Á
 *
Ãw
)

2721 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Ãw
->
šode
->
i_sb
);

2722 
bŒfs_·th
 *
·th
;

2723 
§_deäag_ex‹Á_back»f
 *
back»f
;

2724 
§_deäag_ex‹Á_back»f
 *
´ev
 = 
NULL
;

2725 
šode
 *inode;

2726 
bŒfs_roÙ
 *
roÙ
;

2727 
rb_node
 *
node
;

2728 
»t
;

2730 
šode
 = 
Ãw
->inode;

2731 
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2733 
·th
 = 
	`bŒfs_®loc_·th
();

2734 ià(!
·th
)

2737 ià(!
	`»cÜd_ex‹Á_back»fs
(
·th
, 
Ãw
)) {

2738 
	`bŒfs_ä“_·th
(
·th
);

2739 
out
;

2741 
	`bŒfs_»Ëa£_·th
(
·th
);

2744 
node
 = 
	`rb_fœ¡
(&
Ãw
->
roÙ
);

2745 ià(!
node
)

2747 
	`rb_”a£
(
node
, &
Ãw
->
roÙ
);

2749 
back»f
 = 
	`rb_’Œy
(
node
, 
§_deäag_ex‹Á_back»f
,‚ode);

2751 
»t
 = 
	`»lšk_ex‹Á_back»f
(
·th
, 
´ev
, 
back»f
);

2752 
	`WARN_ON
(
»t
 < 0);

2754 
	`kä“
(
´ev
);

2756 ià(
»t
 == 1)

2757 
´ev
 = 
back»f
;

2759 
´ev
 = 
NULL
;

2760 
	`cÚd_»sched
();

2762 
	`kä“
(
´ev
);

2764 
	`bŒfs_ä“_·th
(
·th
);

2765 
out
:

2766 
	`ä“_§_deäag_ex‹Á
(
Ãw
);

2768 
	`©omic_dec
(&
fs_šfo
->
deäag_ruÂšg
);

2769 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

2770 
	}
}

2772 
Ãw_§_deäag_ex‹Á
 *

2773 
	$»cÜd_Þd_fže_ex‹Ás
(
šode
 *inode,

2774 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

2776 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2777 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2778 
bŒfs_·th
 *
·th
;

2779 
bŒfs_key
 
key
;

2780 
Þd_§_deäag_ex‹Á
 *
Þd
;

2781 
Ãw_§_deäag_ex‹Á
 *
Ãw
;

2782 
»t
;

2784 
Ãw
 = 
	`km®loc
((*Ãw), 
GFP_NOFS
);

2785 ià(!
Ãw
)

2786  
NULL
;

2788 
Ãw
->
šode
 = inode;

2789 
Ãw
->
fže_pos
 = 
Üd”ed
->
fže_off£t
;

2790 
Ãw
->
Ën
 = 
Üd”ed
->len;

2791 
Ãw
->
by‹Ä
 = 
Üd”ed
->
¡¬t
;

2792 
Ãw
->
disk_Ën
 = 
Üd”ed
->disk_len;

2793 
Ãw
->
com´ess_ty³
 = 
Üd”ed
->compress_type;

2794 
Ãw
->
roÙ
 = 
RB_ROOT
;

2795 
	`INIT_LIST_HEAD
(&
Ãw
->
h—d
);

2797 
·th
 = 
	`bŒfs_®loc_·th
();

2798 ià(!
·th
)

2799 
out_kä“
;

2801 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

2802 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

2803 
key
.
off£t
 = 
Ãw
->
fže_pos
;

2805 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2806 ià(
»t
 < 0)

2807 
out_ä“_·th
;

2808 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0)

2809 
·th
->
¦Ùs
[0]--;

2813 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

2814 
ex‹Á_bufãr
 *
l
;

2815 
¦Ù
;

2816 
u64
 
num_by‹s
;

2817 
u64
 
off£t
;

2818 
u64
 
’d
;

2819 
u64
 
disk_by‹Ä
;

2820 
u64
 
ex‹Á_off£t
;

2822 
l
 = 
·th
->
nodes
[0];

2823 
¦Ù
 = 
·th
->
¦Ùs
[0];

2825 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
l
)) {

2826 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2827 ià(
»t
 < 0)

2828 
out_ä“_·th
;

2829 ià(
»t
 > 0)

2834 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
¦Ù
);

2836 ià(
key
.
objeùid
 !ð
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)))

2838 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

2840 ià(
key
.
off£t
 >ð
Ãw
->
fže_pos
 +‚ew->
Ën
)

2843 
ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

2845 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
l
, 
ex‹Á
);

2846 ià(
key
.
off£t
 + 
num_by‹s
 < 
Ãw
->
fže_pos
)

2847 
Ãxt
;

2849 
disk_by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
l
, 
ex‹Á
);

2850 ià(!
disk_by‹Ä
)

2851 
Ãxt
;

2853 
ex‹Á_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
l
, 
ex‹Á
);

2855 
Þd
 = 
	`km®loc
((*Þd), 
GFP_NOFS
);

2856 ià(!
Þd
)

2857 
out_ä“_·th
;

2859 
off£t
 = 
	`max
(
Ãw
->
fže_pos
, 
key
.offset);

2860 
’d
 = 
	`mš
(
Ãw
->
fže_pos
 +‚ew->
Ën
, 
key
.
off£t
 + 
num_by‹s
);

2862 
Þd
->
by‹Ä
 = 
disk_by‹Ä
;

2863 
Þd
->
ex‹Á_off£t
 =ƒxtent_offset;

2864 
Þd
->
off£t
 = off£ˆ- 
key
.offset;

2865 
Þd
->
Ën
 = 
’d
 - 
off£t
;

2866 
Þd
->
Ãw
 =‚ew;

2867 
Þd
->
couÁ
 = 0;

2868 
	`li¡_add_ž
(&
Þd
->
li¡
, &
Ãw
->
h—d
);

2869 
Ãxt
:

2870 
·th
->
¦Ùs
[0]++;

2871 
	`cÚd_»sched
();

2874 
	`bŒfs_ä“_·th
(
·th
);

2875 
	`©omic_šc
(&
fs_šfo
->
deäag_ruÂšg
);

2877  
Ãw
;

2879 
out_ä“_·th
:

2880 
	`bŒfs_ä“_·th
(
·th
);

2881 
out_kä“
:

2882 
	`ä“_§_deäag_ex‹Á
(
Ãw
);

2883  
NULL
;

2884 
	}
}

2886 
	$bŒfs_»Ëa£_d–®loc_by‹s
(
bŒfs_fs_šfo
 *
fs_šfo
,

2887 
u64
 
¡¬t
, u64 
Ën
)

2889 
bŒfs_block_group_ÿche
 *
ÿche
;

2891 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
¡¬t
);

2892 
	`ASSERT
(
ÿche
);

2894 
	`¥š_lock
(&
ÿche
->
lock
);

2895 
ÿche
->
d–®loc_by‹s
 -ð
Ën
;

2896 
	`¥š_uÆock
(&
ÿche
->
lock
);

2898 
	`bŒfs_put_block_group
(
ÿche
);

2899 
	}
}

2905 
	$bŒfs_fšish_Üd”ed_io
(
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
)

2907 
šode
 *šodð
Üd”ed_ex‹Á
->inode;

2908 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2909 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2910 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

2911 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

2912 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

2913 
Ãw_§_deäag_ex‹Á
 *
Ãw
 = 
NULL
;

2914 
com´ess_ty³
 = 0;

2915 
»t
 = 0;

2916 
u64
 
logiÿl_Ën
 = 
Üd”ed_ex‹Á
->
Ën
;

2917 
boÞ
 
nÞock
;

2918 
boÞ
 
Œunÿ‹d
 = 
çl£
;

2919 
boÞ
 
¿nge_locked
 = 
çl£
;

2920 
boÞ
 
þ—r_Ãw_d–®loc_by‹s
 = 
çl£
;

2922 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed_ex‹Á
->
æags
) &&

2923 !
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed_ex‹Á
->
æags
) &&

2924 !
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Üd”ed_ex‹Á
->
æags
))

2925 
þ—r_Ãw_d–®loc_by‹s
 = 
Œue
;

2927 
nÞock
 = 
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
));

2929 ià(
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed_ex‹Á
->
æags
)) {

2930 
»t
 = -
EIO
;

2931 
out
;

2934 
	`bŒfs_ä“_io_çžu»_»cÜd
(
	`BTRFS_I
(
šode
),

2935 
Üd”ed_ex‹Á
->
fže_off£t
,

2936 
Üd”ed_ex‹Á
->
fže_off£t
 +

2937 
Üd”ed_ex‹Á
->
Ën
 - 1);

2939 ià(
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed_ex‹Á
->
æags
)) {

2940 
Œunÿ‹d
 = 
Œue
;

2941 
logiÿl_Ën
 = 
Üd”ed_ex‹Á
->
Œunÿ‹d_Ën
;

2943 ià(!
logiÿl_Ën
)

2944 
out
;

2947 ià(
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed_ex‹Á
->
æags
)) {

2948 
	`BUG_ON
(!
	`li¡_em±y
(&
Üd”ed_ex‹Á
->
li¡
));

2955 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
NULL
, 
Üd”ed_ex‹Á
->
fže_off£t
,

2956 
Üd”ed_ex‹Á
->
Ën
);

2957 
	`bŒfs_Üd”ed_upd©e_i_size
(
šode
, 0, 
Üd”ed_ex‹Á
);

2958 ià(
nÞock
)

2959 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_nÞock
(
roÙ
);

2961 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

2962 ià(
	`IS_ERR
(
Œªs
)) {

2963 
»t
 = 
	`PTR_ERR
(
Œªs
);

2964 
Œªs
 = 
NULL
;

2965 
out
;

2967 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–®loc_block_rsv
;

2968 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
roÙ
, 
šode
);

2969 ià(
»t
)

2970 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2971 
out
;

2974 
¿nge_locked
 = 
Œue
;

2975 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
Üd”ed_ex‹Á
->
fže_off£t
,

2976 
Üd”ed_ex‹Á
->
fže_off£t
 + ord”ed_ex‹Á->
Ën
 - 1,

2977 &
ÿched_¡©e
);

2979 
»t
 = 
	`‹¡_¿nge_b™
(
io_Œ“
, 
Üd”ed_ex‹Á
->
fže_off£t
,

2980 
Üd”ed_ex‹Á
->
fže_off£t
 + ord”ed_ex‹Á->
Ën
 - 1,

2981 
EXTENT_DEFRAG
, 0, 
ÿched_¡©e
);

2982 ià(
»t
) {

2983 
u64
 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
);

2984 ià(0 && 
Ï¡_¢­shÙ
 >ð
	`BTRFS_I
(
šode
)->
g’”©iÚ
)

2986 
Ãw
 = 
	`»cÜd_Þd_fže_ex‹Ás
(
šode
, 
Üd”ed_ex‹Á
);

2988 
	`þ—r_ex‹Á_b™
(
io_Œ“
, 
Üd”ed_ex‹Á
->
fže_off£t
,

2989 
Üd”ed_ex‹Á
->
fže_off£t
 + ord”ed_ex‹Á->
Ën
 - 1,

2990 
EXTENT_DEFRAG
, 0, 0, &
ÿched_¡©e
, 
GFP_NOFS
);

2993 ià(
nÞock
)

2994 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_nÞock
(
roÙ
);

2996 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

2997 ià(
	`IS_ERR
(
Œªs
)) {

2998 
»t
 = 
	`PTR_ERR
(
Œªs
);

2999 
Œªs
 = 
NULL
;

3000 
out
;

3003 
Œªs
->
block_rsv
 = &
fs_šfo
->
d–®loc_block_rsv
;

3005 ià(
	`‹¡_b™
(
BTRFS_ORDERED_COMPRESSED
, &
Üd”ed_ex‹Á
->
æags
))

3006 
com´ess_ty³
 = 
Üd”ed_ex‹Á
->compress_type;

3007 ià(
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed_ex‹Á
->
æags
)) {

3008 
	`BUG_ON
(
com´ess_ty³
);

3009 
»t
 = 
	`bŒfs_m¬k_ex‹Á_wr™‹n
(
Œªs
, 
	`BTRFS_I
(
šode
),

3010 
Üd”ed_ex‹Á
->
fže_off£t
,

3011 
Üd”ed_ex‹Á
->
fže_off£t
 +

3012 
logiÿl_Ën
);

3014 
	`BUG_ON
(
roÙ
 =ð
fs_šfo
->
Œ“_roÙ
);

3015 
»t
 = 
	`š£¹_»£rved_fže_ex‹Á
(
Œªs
, 
šode
,

3016 
Üd”ed_ex‹Á
->
fže_off£t
,

3017 
Üd”ed_ex‹Á
->
¡¬t
,

3018 
Üd”ed_ex‹Á
->
disk_Ën
,

3019 
logiÿl_Ën
,†ogical_len,

3020 
com´ess_ty³
, 0, 0,

3021 
BTRFS_FILE_EXTENT_REG
);

3022 ià(!
»t
)

3023 
	`bŒfs_»Ëa£_d–®loc_by‹s
(
fs_šfo
,

3024 
Üd”ed_ex‹Á
->
¡¬t
,

3025 
Üd”ed_ex‹Á
->
disk_Ën
);

3027 
	`uÅš_ex‹Á_ÿche
(&
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
,

3028 
Üd”ed_ex‹Á
->
fže_off£t
, ord”ed_ex‹Á->
Ën
,

3029 
Œªs
->
Œªsid
);

3030 ià(
»t
 < 0) {

3031 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3032 
out
;

3035 
	`add_³ndšg_csums
(
Œªs
, 
šode
, &
Üd”ed_ex‹Á
->
li¡
);

3037 
	`bŒfs_Üd”ed_upd©e_i_size
(
šode
, 0, 
Üd”ed_ex‹Á
);

3038 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
roÙ
, 
šode
);

3039 ià(
»t
) {

3040 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3041 
out
;

3043 
»t
 = 0;

3044 
out
:

3045 ià(
¿nge_locked
 || 
þ—r_Ãw_d–®loc_by‹s
) {

3046 
þ—r_b™s
 = 0;

3048 ià(
¿nge_locked
)

3049 
þ—r_b™s
 |ð
EXTENT_LOCKED
;

3050 ià(
þ—r_Ãw_d–®loc_by‹s
)

3051 
þ—r_b™s
 |ð
EXTENT_DELALLOC_NEW
;

3052 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

3053 
Üd”ed_ex‹Á
->
fže_off£t
,

3054 
Üd”ed_ex‹Á
->
fže_off£t
 +

3055 
Üd”ed_ex‹Á
->
Ën
 - 1,

3056 
þ—r_b™s
,

3057 (
þ—r_b™s
 & 
EXTENT_LOCKED
) ? 1 : 0,

3058 0, &
ÿched_¡©e
, 
GFP_NOFS
);

3061 ià(
roÙ
 !ð
fs_šfo
->
Œ“_roÙ
)

3062 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

3063 
Üd”ed_ex‹Á
->
Ën
);

3064 ià(
Œªs
)

3065 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3067 ià(
»t
 || 
Œunÿ‹d
) {

3068 
u64
 
¡¬t
, 
’d
;

3070 ià(
Œunÿ‹d
)

3071 
¡¬t
 = 
Üd”ed_ex‹Á
->
fže_off£t
 + 
logiÿl_Ën
;

3073 
¡¬t
 = 
Üd”ed_ex‹Á
->
fže_off£t
;

3074 
’d
 = 
Üd”ed_ex‹Á
->
fže_off£t
 + ord”ed_ex‹Á->
Ën
 - 1;

3075 
	`þ—r_ex‹Á_u±od©e
(
io_Œ“
, 
¡¬t
, 
’d
, 
NULL
, 
GFP_NOFS
);

3078 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 0);

3086 ià((
»t
 || !
logiÿl_Ën
) &&

3087 !
	`‹¡_b™
(
BTRFS_ORDERED_NOCOW
, &
Üd”ed_ex‹Á
->
æags
) &&

3088 !
	`‹¡_b™
(
BTRFS_ORDERED_PREALLOC
, &
Üd”ed_ex‹Á
->
æags
))

3089 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
,

3090 
Üd”ed_ex‹Á
->
¡¬t
,

3091 
Üd”ed_ex‹Á
->
disk_Ën
, 1);

3099 
	`bŒfs_»move_Üd”ed_ex‹Á
(
šode
, 
Üd”ed_ex‹Á
);

3102 ià(
Ãw
) {

3103 ià(
»t
) {

3104 
	`ä“_§_deäag_ex‹Á
(
Ãw
);

3105 
	`©omic_dec
(&
fs_šfo
->
deäag_ruÂšg
);

3107 
	`»lšk_fže_ex‹Ás
(
Ãw
);

3112 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed_ex‹Á
);

3114 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed_ex‹Á
);

3116  
»t
;

3117 
	}
}

3119 
	$fšish_Üd”ed_â
(
bŒfs_wÜk
 *
wÜk
)

3121 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
;

3122 
Üd”ed_ex‹Á
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_Üd”ed_ex‹Á
, work);

3123 
	`bŒfs_fšish_Üd”ed_io
(
Üd”ed_ex‹Á
);

3124 
	}
}

3126 
	$bŒfs_wr™•age_’d_io_hook
(
·ge
 *·ge, 
u64
 
¡¬t
, u64 
’d
,

3127 
ex‹Á_¡©e
 *
¡©e
, 
u±od©e
)

3129 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

3130 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3131 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed_ex‹Á
 = 
NULL
;

3132 
bŒfs_wÜkqueue
 *
wq
;

3133 
bŒfs_wÜk_func_t
 
func
;

3135 
	`Œaû_bŒfs_wr™•age_’d_io_hook
(
·ge
, 
¡¬t
, 
’d
, 
u±od©e
);

3137 
	`CË¬PagePriv©e2
(
·ge
);

3138 ià(!
	`bŒfs_dec_‹¡_Üd”ed_³ndšg
(
šode
, &
Üd”ed_ex‹Á
, 
¡¬t
,

3139 
’d
 - 
¡¬t
 + 1, 
u±od©e
))

3142 ià(
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))) {

3143 
wq
 = 
fs_šfo
->
’dio_ä“¥aû_wÜk”
;

3144 
func
 = 
bŒfs_ä“¥aû_wr™e_h–³r
;

3146 
wq
 = 
fs_šfo
->
’dio_wr™e_wÜk”s
;

3147 
func
 = 
bŒfs_’dio_wr™e_h–³r
;

3150 
	`bŒfs_š™_wÜk
(&
Üd”ed_ex‹Á
->
wÜk
, 
func
, 
fšish_Üd”ed_â
, 
NULL
,

3151 
NULL
);

3152 
	`bŒfs_queue_wÜk
(
wq
, &
Üd”ed_ex‹Á
->
wÜk
);

3153 
	}
}

3155 
	$__»ad·ge_’dio_check
(
šode
 *inode,

3156 
bŒfs_io_bio
 *
io_bio
,

3157 
icsum
, 
·ge
 *page,

3158 
pgoff
, 
u64
 
¡¬t
, 
size_t
 
Ën
)

3160 *
kaddr
;

3161 
u32
 
csum_ex³ùed
;

3162 
u32
 
csum
 = ~(u32)0;

3164 
csum_ex³ùed
 = *(((
u32
 *)
io_bio
->
csum
è+ 
icsum
);

3166 
kaddr
 = 
	`km­_©omic
(
·ge
);

3167 
csum
 = 
	`bŒfs_csum_d©a
(
kaddr
 + 
pgoff
, csum, 
Ën
);

3168 
	`bŒfs_csum_fš®
(
csum
, (
u8
 *)&csum);

3169 ià(
csum
 !ð
csum_ex³ùed
)

3170 
z”o™
;

3172 
	`kunm­_©omic
(
kaddr
);

3174 
z”o™
:

3175 
	`bŒfs_´št_d©a_csum_”rÜ
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
csum
, 
csum_ex³ùed
,

3176 
io_bio
->
mœrÜ_num
);

3177 
	`mem£t
(
kaddr
 + 
pgoff
, 1, 
Ën
);

3178 
	`æush_dÿche_·ge
(
·ge
);

3179 
	`kunm­_©omic
(
kaddr
);

3180  -
EIO
;

3181 
	}
}

3188 
	$bŒfs_»ad·ge_’d_io_hook
(
bŒfs_io_bio
 *
io_bio
,

3189 
u64
 
phy_off£t
, 
·ge
 *page,

3190 
u64
 
¡¬t
, u64 
’d
, 
mœrÜ
)

3192 
size_t
 
off£t
 = 
¡¬t
 - 
	`·ge_off£t
(
·ge
);

3193 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

3194 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

3195 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3197 ià(
	`PageChecked
(
·ge
)) {

3198 
	`CË¬PageChecked
(
·ge
);

3202 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
)

3205 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_DATA_RELOC_TREE_OBJECTID
 &&

3206 
	`‹¡_¿nge_b™
(
io_Œ“
, 
¡¬t
, 
’d
, 
EXTENT_NODATASUM
, 1, 
NULL
)) {

3207 
	`þ—r_ex‹Á_b™s
(
io_Œ“
, 
¡¬t
, 
’d
, 
EXTENT_NODATASUM
);

3211 
phy_off£t
 >>ð
šode
->
i_sb
->
s_blocksize_b™s
;

3212  
	`__»ad·ge_’dio_check
(
šode
, 
io_bio
, 
phy_off£t
, 
·ge
, 
off£t
,

3213 
¡¬t
, (
size_t
)(
’d
 - start + 1));

3214 
	}
}

3216 
	$bŒfs_add_d–ayed_ut
(
šode
 *inode)

3218 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3219 
bŒfs_šode
 *
bšode
 = 
	`BTRFS_I
(
šode
);

3221 ià(
	`©omic_add_uÆess
(&
šode
->
i_couÁ
, -1, 1))

3224 
	`¥š_lock
(&
fs_šfo
->
d–ayed_ut_lock
);

3225 ià(
bšode
->
d–ayed_ut_couÁ
 == 0) {

3226 
	`ASSERT
(
	`li¡_em±y
(&
bšode
->
d–ayed_ut
));

3227 
	`li¡_add_ž
(&
bšode
->
d–ayed_ut
, &
fs_šfo
->
d–ayed_uts
);

3229 
bšode
->
d–ayed_ut_couÁ
++;

3231 
	`¥š_uÆock
(&
fs_šfo
->
d–ayed_ut_lock
);

3232 
	}
}

3234 
	$bŒfs_run_d–ayed_uts
(
bŒfs_fs_šfo
 *
fs_šfo
)

3237 
	`¥š_lock
(&
fs_šfo
->
d–ayed_ut_lock
);

3238 !
	`li¡_em±y
(&
fs_šfo
->
d–ayed_uts
)) {

3239 
bŒfs_šode
 *
šode
;

3241 
šode
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
d–ayed_uts
,

3242 
bŒfs_šode
, 
d–ayed_ut
);

3243 ià(
šode
->
d–ayed_ut_couÁ
) {

3244 
šode
->
d–ayed_ut_couÁ
--;

3245 
	`li¡_move_ž
(&
šode
->
d–ayed_ut
,

3246 &
fs_šfo
->
d–ayed_uts
);

3248 
	`li¡_d–_š™
(&
šode
->
d–ayed_ut
);

3250 
	`¥š_uÆock
(&
fs_šfo
->
d–ayed_ut_lock
);

3251 
	`ut
(&
šode
->
vfs_šode
);

3252 
	`¥š_lock
(&
fs_šfo
->
d–ayed_ut_lock
);

3254 
	`¥š_uÆock
(&
fs_šfo
->
d–ayed_ut_lock
);

3255 
	}
}

3262 
	$bŒfs_Üphª_comm™_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3263 
bŒfs_roÙ
 *
roÙ
)

3265 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3266 
bŒfs_block_rsv
 *
block_rsv
;

3267 
»t
;

3269 ià(
	`©omic_»ad
(&
roÙ
->
Üphª_šodes
) ||

3270 
roÙ
->
Üphª_þ—nup_¡©e
 !ð
ORPHAN_CLEANUP_DONE
)

3273 
	`¥š_lock
(&
roÙ
->
Üphª_lock
);

3274 ià(
	`©omic_»ad
(&
roÙ
->
Üphª_šodes
)) {

3275 
	`¥š_uÆock
(&
roÙ
->
Üphª_lock
);

3279 ià(
roÙ
->
Üphª_þ—nup_¡©e
 !ð
ORPHAN_CLEANUP_DONE
) {

3280 
	`¥š_uÆock
(&
roÙ
->
Üphª_lock
);

3284 
block_rsv
 = 
roÙ
->
Üphª_block_rsv
;

3285 
roÙ
->
Üphª_block_rsv
 = 
NULL
;

3286 
	`¥š_uÆock
(&
roÙ
->
Üphª_lock
);

3288 ià(
	`‹¡_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
) &&

3289 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) > 0) {

3290 
»t
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

3291 
roÙ
->
roÙ_key
.
objeùid
);

3292 ià(
»t
)

3293 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3295 
	`þ—r_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
,

3296 &
roÙ
->
¡©e
);

3299 ià(
block_rsv
) {

3300 
	`WARN_ON
(
block_rsv
->
size
 > 0);

3301 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
block_rsv
);

3303 
	}
}

3312 
	$bŒfs_Üphª_add
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3313 
bŒfs_šode
 *
šode
)

3315 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

3316 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3317 
bŒfs_block_rsv
 *
block_rsv
 = 
NULL
;

3318 
»£rve
 = 0;

3319 
š£¹
 = 0;

3320 
»t
;

3322 ià(!
roÙ
->
Üphª_block_rsv
) {

3323 
block_rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
,

3324 
BTRFS_BLOCK_RSV_TEMP
);

3325 ià(!
block_rsv
)

3326  -
ENOMEM
;

3329 
	`¥š_lock
(&
roÙ
->
Üphª_lock
);

3330 ià(!
roÙ
->
Üphª_block_rsv
) {

3331 
roÙ
->
Üphª_block_rsv
 = 
block_rsv
;

3332 } ià(
block_rsv
) {

3333 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
block_rsv
);

3334 
block_rsv
 = 
NULL
;

3337 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

3338 &
šode
->
ruÁime_æags
)) {

3345 ià(!
	`xchg
(&
roÙ
->
Üphª_™em_š£¹ed
, 1))

3346 
š£¹
 = 2;

3348 
š£¹
 = 1;

3350 
š£¹
 = 1;

3351 
	`©omic_šc
(&
roÙ
->
Üphª_šodes
);

3354 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_INODE_ORPHAN_META_RESERVED
,

3355 &
šode
->
ruÁime_æags
))

3356 
»£rve
 = 1;

3357 
	`¥š_uÆock
(&
roÙ
->
Üphª_lock
);

3360 ià(
»£rve
) {

3361 
»t
 = 
	`bŒfs_Üphª_»£rve_m‘ad©a
(
Œªs
, 
šode
);

3362 
	`ASSERT
(!
»t
);

3363 ià(
»t
) {

3364 
	`©omic_dec
(&
roÙ
->
Üphª_šodes
);

3365 
	`þ—r_b™
(
BTRFS_INODE_ORPHAN_META_RESERVED
,

3366 &
šode
->
ruÁime_æags
);

3367 ià(
š£¹
)

3368 
	`þ—r_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

3369 &
šode
->
ruÁime_æags
);

3370  
»t
;

3375 ià(
š£¹
 >= 1) {

3376 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
šode
));

3377 ià(
»t
) {

3378 
	`©omic_dec
(&
roÙ
->
Üphª_šodes
);

3379 ià(
»£rve
) {

3380 
	`þ—r_b™
(
BTRFS_INODE_ORPHAN_META_RESERVED
,

3381 &
šode
->
ruÁime_æags
);

3382 
	`bŒfs_Üphª_»Ëa£_m‘ad©a
(
šode
);

3384 ià(
»t
 !ð-
EEXIST
) {

3385 
	`þ—r_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

3386 &
šode
->
ruÁime_æags
);

3387 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3388  
»t
;

3391 
»t
 = 0;

3395 ià(
š£¹
 >= 2) {

3396 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

3397 
roÙ
->
roÙ_key
.
objeùid
);

3398 ià(
»t
 &&„‘ !ð-
EEXIST
) {

3399 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3400  
»t
;

3404 
	}
}

3410 
	$bŒfs_Üphª_d–
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3411 
bŒfs_šode
 *
šode
)

3413 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

3414 
d–‘e_™em
 = 0;

3415 
»Ëa£_rsv
 = 0;

3416 
»t
 = 0;

3418 
	`¥š_lock
(&
roÙ
->
Üphª_lock
);

3419 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

3420 &
šode
->
ruÁime_æags
))

3421 
d–‘e_™em
 = 1;

3423 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_INODE_ORPHAN_META_RESERVED
,

3424 &
šode
->
ruÁime_æags
))

3425 
»Ëa£_rsv
 = 1;

3426 
	`¥š_uÆock
(&
roÙ
->
Üphª_lock
);

3428 ià(
d–‘e_™em
) {

3429 
	`©omic_dec
(&
roÙ
->
Üphª_šodes
);

3430 ià(
Œªs
)

3431 
»t
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
roÙ
,

3432 
	`bŒfs_šo
(
šode
));

3435 ià(
»Ëa£_rsv
)

3436 
	`bŒfs_Üphª_»Ëa£_m‘ad©a
(
šode
);

3438  
»t
;

3439 
	}
}

3445 
	$bŒfs_Üphª_þ—nup
(
bŒfs_roÙ
 *
roÙ
)

3447 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3448 
bŒfs_·th
 *
·th
;

3449 
ex‹Á_bufãr
 *
Ëaf
;

3450 
bŒfs_key
 
key
, 
found_key
;

3451 
bŒfs_Œªs_hªdË
 *
Œªs
;

3452 
šode
 *inode;

3453 
u64
 
Ï¡_objeùid
 = 0;

3454 
»t
 = 0, 
Ä_uÆšk
 = 0, 
Ä_Œunÿ‹
 = 0;

3456 ià(
	`cmpxchg
(&
roÙ
->
Üphª_þ—nup_¡©e
, 0, 
ORPHAN_CLEANUP_STARTED
))

3459 
·th
 = 
	`bŒfs_®loc_·th
();

3460 ià(!
·th
) {

3461 
»t
 = -
ENOMEM
;

3462 
out
;

3464 
·th
->
»ada
 = 
READA_BACK
;

3466 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

3467 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

3468 
key
.
off£t
 = (
u64
)-1;

3471 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3472 ià(
»t
 < 0)

3473 
out
;

3480 ià(
»t
 > 0) {

3481 
»t
 = 0;

3482 ià(
·th
->
¦Ùs
[0] == 0)

3484 
·th
->
¦Ùs
[0]--;

3488 
Ëaf
 = 
·th
->
nodes
[0];

3489 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

3492 ià(
found_key
.
objeùid
 !ð
BTRFS_ORPHAN_OBJECTID
)

3494 ià(
found_key
.
ty³
 !ð
BTRFS_ORPHAN_ITEM_KEY
)

3498 
	`bŒfs_»Ëa£_·th
(
·th
);

3506 ià(
found_key
.
off£t
 =ð
Ï¡_objeùid
) {

3507 
	`bŒfs_”r
(
fs_šfo
,

3509 
»t
 = -
EINVAL
;

3510 
out
;

3513 
Ï¡_objeùid
 = 
found_key
.
off£t
;

3515 
found_key
.
objeùid
 = found_key.
off£t
;

3516 
found_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

3517 
found_key
.
off£t
 = 0;

3518 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
found_key
, 
roÙ
, 
NULL
);

3519 
»t
 = 
	`PTR_ERR_OR_ZERO
(
šode
);

3520 ià(
»t
 &&„‘ !ð-
ENOENT
)

3521 
out
;

3523 ià(
»t
 =ð-
ENOENT
 && 
roÙ
 =ð
fs_šfo
->
Œ“_roÙ
) {

3524 
bŒfs_roÙ
 *
d—d_roÙ
;

3525 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3526 
is_d—d_roÙ
 = 0;

3539 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

3540 
	`li¡_fÜ_—ch_’Œy
(
d—d_roÙ
, &
fs_šfo
->
d—d_roÙs
,

3541 
roÙ_li¡
) {

3542 ià(
d—d_roÙ
->
roÙ_key
.
objeùid
 ==

3543 
found_key
.
objeùid
) {

3544 
is_d—d_roÙ
 = 1;

3548 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

3549 ià(
is_d—d_roÙ
) {

3551 
key
.
off£t
 = 
found_key
.
objeùid
 - 1;

3559 ià(
»t
 =ð-
ENOENT
) {

3560 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

3561 ià(
	`IS_ERR
(
Œªs
)) {

3562 
»t
 = 
	`PTR_ERR
(
Œªs
);

3563 
out
;

3565 
	`bŒfs_debug
(
fs_šfo
, "auto deleting %Lu",

3566 
found_key
.
objeùid
);

3567 
»t
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
roÙ
,

3568 
found_key
.
objeùid
);

3569 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3570 ià(
»t
)

3571 
out
;

3579 
	`£t_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

3580 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

3581 
	`©omic_šc
(&
roÙ
->
Üphª_šodes
);

3584 ià(
šode
->
i_Æšk
) {

3585 ià(
	`WARN_ON
(!
	`S_ISREG
(
šode
->
i_mode
))) {

3586 
	`ut
(
šode
);

3589 
Ä_Œunÿ‹
++;

3592 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

3593 ià(
	`IS_ERR
(
Œªs
)) {

3594 
	`ut
(
šode
);

3595 
»t
 = 
	`PTR_ERR
(
Œªs
);

3596 
out
;

3598 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

3599 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3600 ià(
»t
) {

3601 
	`ut
(
šode
);

3602 
out
;

3605 
»t
 = 
	`bŒfs_Œunÿ‹
(
šode
);

3606 ià(
»t
)

3607 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

3609 
Ä_uÆšk
++;

3613 
	`ut
(
šode
);

3614 ià(
»t
)

3615 
out
;

3618 
	`bŒfs_»Ëa£_·th
(
·th
);

3620 
roÙ
->
Üphª_þ—nup_¡©e
 = 
ORPHAN_CLEANUP_DONE
;

3622 ià(
roÙ
->
Üphª_block_rsv
)

3623 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
roÙ
->
Üphª_block_rsv
,

3624 (
u64
)-1);

3626 ià(
roÙ
->
Üphª_block_rsv
 ||

3627 
	`‹¡_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
)) {

3628 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3629 ià(!
	`IS_ERR
(
Œªs
))

3630 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3633 ià(
Ä_uÆšk
)

3634 
	`bŒfs_debug
(
fs_šfo
, "uÆšked %d o½hªs", 
Ä_uÆšk
);

3635 ià(
Ä_Œunÿ‹
)

3636 
	`bŒfs_debug
(
fs_šfo
, "Œunÿ‹d %d o½hªs", 
Ä_Œunÿ‹
);

3638 
out
:

3639 ià(
»t
)

3640 
	`bŒfs_”r
(
fs_šfo
, "could‚Ù dØÜphª cËªu°%d", 
»t
);

3641 
	`bŒfs_ä“_·th
(
·th
);

3642  
»t
;

3643 
	}
}

3651 
nošlše
 
	$aþs_aá”_šode_™em
(
ex‹Á_bufãr
 *
Ëaf
,

3652 
¦Ù
, 
u64
 
objeùid
,

3653 *
fœ¡_x©Œ_¦Ù
)

3655 
u32
 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

3656 
bŒfs_key
 
found_key
;

3657 
u64
 
x©Œ_acûss
 = 0;

3658 
u64
 
x©Œ_deçuÉ
 = 0;

3659 
sÿÂed
 = 0;

3661 ià(!
x©Œ_acûss
) {

3662 
x©Œ_acûss
 = 
	`bŒfs_Çme_hash
(
XATTR_NAME_POSIX_ACL_ACCESS
,

3663 
	`¡¾’
(
XATTR_NAME_POSIX_ACL_ACCESS
));

3664 
x©Œ_deçuÉ
 = 
	`bŒfs_Çme_hash
(
XATTR_NAME_POSIX_ACL_DEFAULT
,

3665 
	`¡¾’
(
XATTR_NAME_POSIX_ACL_DEFAULT
));

3668 
¦Ù
++;

3669 *
fœ¡_x©Œ_¦Ù
 = -1;

3670 
¦Ù
 < 
Ä™ems
) {

3671 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

3674 ià(
found_key
.
objeùid
 != objectid)

3678 ià(
found_key
.
ty³
 =ð
BTRFS_XATTR_ITEM_KEY
) {

3679 ià(*
fœ¡_x©Œ_¦Ù
 == -1)

3680 *
fœ¡_x©Œ_¦Ù
 = 
¦Ù
;

3681 ià(
found_key
.
off£t
 =ð
x©Œ_acûss
 ||

3682 
found_key
.
off£t
 =ð
x©Œ_deçuÉ
)

3690 ià(
found_key
.
ty³
 > 
BTRFS_XATTR_ITEM_KEY
)

3693 
¦Ù
++;

3694 
sÿÂed
++;

3702 ià(
sÿÂed
 >= 8)

3709 ià(*
fœ¡_x©Œ_¦Ù
 == -1)

3710 *
fœ¡_x©Œ_¦Ù
 = 
¦Ù
;

3712 
	}
}

3717 
	$bŒfs_»ad_locked_šode
(
šode
 *inode)

3719 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3720 
bŒfs_·th
 *
·th
;

3721 
ex‹Á_bufãr
 *
Ëaf
;

3722 
bŒfs_šode_™em
 *
šode_™em
;

3723 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3724 
bŒfs_key
 
loÿtiÚ
;

3725 
±r
;

3726 
maybe_aþs
;

3727 
u32
 
rdev
;

3728 
»t
;

3729 
boÞ
 
fžËd
 = 
çl£
;

3730 
fœ¡_x©Œ_¦Ù
;

3732 
»t
 = 
	`bŒfs_fžl_šode
(
šode
, &
rdev
);

3733 ià(!
»t
)

3734 
fžËd
 = 
Œue
;

3736 
·th
 = 
	`bŒfs_®loc_·th
();

3737 ià(!
·th
) {

3738 
»t
 = -
ENOMEM
;

3739 
make_bad
;

3742 
	`memýy
(&
loÿtiÚ
, &
	`BTRFS_I
(
šode
)->location, (location));

3744 
»t
 = 
	`bŒfs_lookup_šode
(
NULL
, 
roÙ
, 
·th
, &
loÿtiÚ
, 0);

3745 ià(
»t
) {

3746 ià(
»t
 > 0)

3747 
»t
 = -
ENOENT
;

3748 
make_bad
;

3751 
Ëaf
 = 
·th
->
nodes
[0];

3753 ià(
fžËd
)

3754 
ÿche_šdex
;

3756 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3757 
bŒfs_šode_™em
);

3758 
šode
->
i_mode
 = 
	`bŒfs_šode_mode
(
Ëaf
, 
šode_™em
);

3759 
	`£t_Æšk
(
šode
, 
	`bŒfs_šode_Æšk
(
Ëaf
, 
šode_™em
));

3760 
	`i_uid_wr™e
(
šode
, 
	`bŒfs_šode_uid
(
Ëaf
, 
šode_™em
));

3761 
	`i_gid_wr™e
(
šode
, 
	`bŒfs_šode_gid
(
Ëaf
, 
šode_™em
));

3762 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
	`bŒfs_šode_size
(
Ëaf
, 
šode_™em
));

3764 
šode
->
i_©ime
.
tv_£c
 = 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
©ime
);

3765 
šode
->
i_©ime
.
tv_n£c
 = 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
©ime
);

3767 
šode
->
i_mtime
.
tv_£c
 = 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
mtime
);

3768 
šode
->
i_mtime
.
tv_n£c
 = 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
mtime
);

3770 
šode
->
i_ùime
.
tv_£c
 = 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
ùime
);

3771 
šode
->
i_ùime
.
tv_n£c
 = 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
ùime
);

3773 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
 =

3774 
	`bŒfs_time¥ec_£c
(
Ëaf
, &
šode_™em
->
Ùime
);

3775 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
 =

3776 
	`bŒfs_time¥ec_n£c
(
Ëaf
, &
šode_™em
->
Ùime
);

3778 
	`šode_£t_by‹s
(
šode
, 
	`bŒfs_šode_nby‹s
(
Ëaf
, 
šode_™em
));

3779 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
	`bŒfs_šode_g’”©iÚ
(
Ëaf
, 
šode_™em
);

3780 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
	`bŒfs_šode_Œªsid
(
Ëaf
, 
šode_™em
);

3782 
šode
->
i_v”siÚ
 = 
	`bŒfs_šode_£qu’û
(
Ëaf
, 
šode_™em
);

3783 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

3784 
šode
->
i_rdev
 = 0;

3785 
rdev
 = 
	`bŒfs_šode_rdev
(
Ëaf
, 
šode_™em
);

3787 
	`BTRFS_I
(
šode
)->
šdex_út
 = (
u64
)-1;

3788 
	`BTRFS_I
(
šode
)->
æags
 = 
	`bŒfs_šode_æags
(
Ëaf
, 
šode_™em
);

3790 
ÿche_šdex
:

3800 ià(
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 =ð
fs_šfo
->
g’”©iÚ
)

3801 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

3802 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

3831 
	`BTRFS_I
(
šode
)->
Ï¡_uÆšk_Œªs
 = BTRFS_I(šode)->
Ï¡_Œªs
;

3833 
·th
->
¦Ùs
[0]++;

3834 ià(
šode
->
i_Æšk
 != 1 ||

3835 
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
))

3836 
ÿche_aþ
;

3838 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
loÿtiÚ
, 
·th
->
¦Ùs
[0]);

3839 ià(
loÿtiÚ
.
objeùid
 !ð
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)))

3840 
ÿche_aþ
;

3842 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

3843 ià(
loÿtiÚ
.
ty³
 =ð
BTRFS_INODE_REF_KEY
) {

3844 
bŒfs_šode_»f
 *
»f
;

3846 
»f
 = (
bŒfs_šode_»f
 *)
±r
;

3847 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = 
	`bŒfs_šode_»f_šdex
(
Ëaf
, 
»f
);

3848 } ià(
loÿtiÚ
.
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) {

3849 
bŒfs_šode_exŒef
 *
exŒef
;

3851 
exŒef
 = (
bŒfs_šode_exŒef
 *)
±r
;

3852 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
Ëaf
,

3853 
exŒef
);

3855 
ÿche_aþ
:

3860 
maybe_aþs
 = 
	`aþs_aá”_šode_™em
(
Ëaf
, 
·th
->
¦Ùs
[0],

3861 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), &
fœ¡_x©Œ_¦Ù
);

3862 ià(
fœ¡_x©Œ_¦Ù
 != -1) {

3863 
·th
->
¦Ùs
[0] = 
fœ¡_x©Œ_¦Ù
;

3864 
»t
 = 
	`bŒfs_lßd_šode_´Ýs
(
šode
, 
·th
);

3865 ià(
»t
)

3866 
	`bŒfs_”r
(
fs_šfo
,

3868 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

3869 
roÙ
->
roÙ_key
.
objeùid
, 
»t
);

3871 
	`bŒfs_ä“_·th
(
·th
);

3873 ià(!
maybe_aþs
)

3874 
	`ÿche_no_aþ
(
šode
);

3876 
šode
->
i_mode
 & 
S_IFMT
) {

3877 
S_IFREG
:

3878 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒfs_aÝs
;

3879 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Ýs
 = &
bŒfs_ex‹Á_io_Ýs
;

3880 
šode
->
i_fÝ
 = &
bŒfs_fže_Ý”©iÚs
;

3881 
šode
->
i_Ý
 = &
bŒfs_fže_šode_Ý”©iÚs
;

3883 
S_IFDIR
:

3884 
šode
->
i_fÝ
 = &
bŒfs_dœ_fže_Ý”©iÚs
;

3885 
šode
->
i_Ý
 = &
bŒfs_dœ_šode_Ý”©iÚs
;

3887 
S_IFLNK
:

3888 
šode
->
i_Ý
 = &
bŒfs_symlšk_šode_Ý”©iÚs
;

3889 
	`šode_nohighmem
(
šode
);

3890 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒfs_symlšk_aÝs
;

3893 
šode
->
i_Ý
 = &
bŒfs_¥ecŸl_šode_Ý”©iÚs
;

3894 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

3898 
	`bŒfs_upd©e_iæags
(
šode
);

3901 
make_bad
:

3902 
	`bŒfs_ä“_·th
(
·th
);

3903 
	`make_bad_šode
(
šode
);

3904  
»t
;

3905 
	}
}

3910 
	$fžl_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3911 
ex‹Á_bufãr
 *
Ëaf
,

3912 
bŒfs_šode_™em
 *
™em
,

3913 
šode
 *inode)

3915 
bŒfs_m­_tok’
 
tok’
;

3917 
	`bŒfs_š™_m­_tok’
(&
tok’
);

3919 
	`bŒfs_£t_tok’_šode_uid
(
Ëaf
, 
™em
, 
	`i_uid_»ad
(
šode
), &
tok’
);

3920 
	`bŒfs_£t_tok’_šode_gid
(
Ëaf
, 
™em
, 
	`i_gid_»ad
(
šode
), &
tok’
);

3921 
	`bŒfs_£t_tok’_šode_size
(
Ëaf
, 
™em
, 
	`BTRFS_I
(
šode
)->
disk_i_size
,

3922 &
tok’
);

3923 
	`bŒfs_£t_tok’_šode_mode
(
Ëaf
, 
™em
, 
šode
->
i_mode
, &
tok’
);

3924 
	`bŒfs_£t_tok’_šode_Æšk
(
Ëaf
, 
™em
, 
šode
->
i_Æšk
, &
tok’
);

3926 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
©ime
,

3927 
šode
->
i_©ime
.
tv_£c
, &
tok’
);

3928 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
©ime
,

3929 
šode
->
i_©ime
.
tv_n£c
, &
tok’
);

3931 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
mtime
,

3932 
šode
->
i_mtime
.
tv_£c
, &
tok’
);

3933 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
mtime
,

3934 
šode
->
i_mtime
.
tv_n£c
, &
tok’
);

3936 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
ùime
,

3937 
šode
->
i_ùime
.
tv_£c
, &
tok’
);

3938 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
ùime
,

3939 
šode
->
i_ùime
.
tv_n£c
, &
tok’
);

3941 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
Ùime
,

3942 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_£c
, &
tok’
);

3943 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
Ùime
,

3944 
	`BTRFS_I
(
šode
)->
i_Ùime
.
tv_n£c
, &
tok’
);

3946 
	`bŒfs_£t_tok’_šode_nby‹s
(
Ëaf
, 
™em
, 
	`šode_g‘_by‹s
(
šode
),

3947 &
tok’
);

3948 
	`bŒfs_£t_tok’_šode_g’”©iÚ
(
Ëaf
, 
™em
, 
	`BTRFS_I
(
šode
)->
g’”©iÚ
,

3949 &
tok’
);

3950 
	`bŒfs_£t_tok’_šode_£qu’û
(
Ëaf
, 
™em
, 
šode
->
i_v”siÚ
, &
tok’
);

3951 
	`bŒfs_£t_tok’_šode_Œªsid
(
Ëaf
, 
™em
, 
Œªs
->
Œªsid
, &
tok’
);

3952 
	`bŒfs_£t_tok’_šode_rdev
(
Ëaf
, 
™em
, 
šode
->
i_rdev
, &
tok’
);

3953 
	`bŒfs_£t_tok’_šode_æags
(
Ëaf
, 
™em
, 
	`BTRFS_I
(
šode
)->
æags
, &
tok’
);

3954 
	`bŒfs_£t_tok’_šode_block_group
(
Ëaf
, 
™em
, 0, &
tok’
);

3955 
	}
}

3960 
nošlše
 
	$bŒfs_upd©e_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3961 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode)

3963 
bŒfs_šode_™em
 *
šode_™em
;

3964 
bŒfs_·th
 *
·th
;

3965 
ex‹Á_bufãr
 *
Ëaf
;

3966 
»t
;

3968 
·th
 = 
	`bŒfs_®loc_·th
();

3969 ià(!
·th
)

3970  -
ENOMEM
;

3972 
·th
->
Ëave_¥šnšg
 = 1;

3973 
»t
 = 
	`bŒfs_lookup_šode
(
Œªs
, 
roÙ
, 
·th
, &
	`BTRFS_I
(
šode
)->
loÿtiÚ
,

3975 ià(
»t
) {

3976 ià(
»t
 > 0)

3977 
»t
 = -
ENOENT
;

3978 
çžed
;

3981 
Ëaf
 = 
·th
->
nodes
[0];

3982 
šode_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3983 
bŒfs_šode_™em
);

3985 
	`fžl_šode_™em
(
Œªs
, 
Ëaf
, 
šode_™em
, 
šode
);

3986 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

3987 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
šode
);

3988 
»t
 = 0;

3989 
çžed
:

3990 
	`bŒfs_ä“_·th
(
·th
);

3991  
»t
;

3992 
	}
}

3997 
nošlše
 
	$bŒfs_upd©e_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3998 
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode)

4000 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4001 
»t
;

4010 ià(!
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))

4011 && 
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_DATA_RELOC_TREE_OBJECTID


4012 && !
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
)) {

4013 
	`bŒfs_upd©e_roÙ_times
(
Œªs
, 
roÙ
);

4015 
»t
 = 
	`bŒfs_d–ayed_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

4016 ià(!
»t
)

4017 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
šode
);

4018  
»t
;

4021  
	`bŒfs_upd©e_šode_™em
(
Œªs
, 
roÙ
, 
šode
);

4022 
	}
}

4024 
nošlše
 
	$bŒfs_upd©e_šode_çÎback
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4025 
bŒfs_roÙ
 *
roÙ
,

4026 
šode
 *inode)

4028 
»t
;

4030 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

4031 ià(
»t
 =ð-
ENOSPC
)

4032  
	`bŒfs_upd©e_šode_™em
(
Œªs
, 
roÙ
, 
šode
);

4033  
»t
;

4034 
	}
}

4041 
	$__bŒfs_uÆšk_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4042 
bŒfs_roÙ
 *
roÙ
,

4043 
bŒfs_šode
 *
dœ
,

4044 
bŒfs_šode
 *
šode
,

4045 cÚ¡ *
Çme
, 
Çme_Ën
)

4047 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4048 
bŒfs_·th
 *
·th
;

4049 
»t
 = 0;

4050 
ex‹Á_bufãr
 *
Ëaf
;

4051 
bŒfs_dœ_™em
 *
di
;

4052 
bŒfs_key
 
key
;

4053 
u64
 
šdex
;

4054 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4055 
u64
 
dœ_šo
 = 
	`bŒfs_šo
(
dœ
);

4057 
·th
 = 
	`bŒfs_®loc_·th
();

4058 ià(!
·th
) {

4059 
»t
 = -
ENOMEM
;

4060 
out
;

4063 
·th
->
Ëave_¥šnšg
 = 1;

4064 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
dœ_šo
,

4065 
Çme
, 
Çme_Ën
, -1);

4066 ià(
	`IS_ERR
(
di
)) {

4067 
»t
 = 
	`PTR_ERR
(
di
);

4068 
”r
;

4070 ià(!
di
) {

4071 
»t
 = -
ENOENT
;

4072 
”r
;

4074 
Ëaf
 = 
·th
->
nodes
[0];

4075 
	`bŒfs_dœ_™em_key_to_ýu
(
Ëaf
, 
di
, &
key
);

4076 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

4077 ià(
»t
)

4078 
”r
;

4079 
	`bŒfs_»Ëa£_·th
(
·th
);

4091 ià(
šode
->
dœ_šdex
) {

4092 
»t
 = 
	`bŒfs_d–ayed_d–‘e_šode_»f
(
šode
);

4093 ià(!
»t
) {

4094 
šdex
 = 
šode
->
dœ_šdex
;

4095 
sk_back»f
;

4099 
»t
 = 
	`bŒfs_d–_šode_»f
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
, 
šo
,

4100 
dœ_šo
, &
šdex
);

4101 ià(
»t
) {

4102 
	`bŒfs_šfo
(
fs_šfo
,

4104 
Çme_Ën
, 
Çme
, 
šo
, 
dœ_šo
);

4105 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4106 
”r
;

4108 
sk_back»f
:

4109 
»t
 = 
	`bŒfs_d–‘e_d–ayed_dœ_šdex
(
Œªs
, 
fs_šfo
, 
dœ
, 
šdex
);

4110 ià(
»t
) {

4111 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4112 
”r
;

4115 
»t
 = 
	`bŒfs_d–_šode_»f_š_log
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
, 
šode
,

4116 
dœ_šo
);

4117 ià(
»t
 !ð0 &&„‘ !ð-
ENOENT
) {

4118 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4119 
”r
;

4122 
»t
 = 
	`bŒfs_d–_dœ_’Œ›s_š_log
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
, 
dœ
,

4123 
šdex
);

4124 ià(
»t
 =ð-
ENOENT
)

4125 
»t
 = 0;

4126 ià(
»t
)

4127 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4128 
”r
:

4129 
	`bŒfs_ä“_·th
(
·th
);

4130 ià(
»t
)

4131 
out
;

4133 
	`bŒfs_i_size_wr™e
(
dœ
, dœ->
vfs_šode
.
i_size
 - 
Çme_Ën
 * 2);

4134 
	`šode_šc_iv”siÚ
(&
šode
->
vfs_šode
);

4135 
	`šode_šc_iv”siÚ
(&
dœ
->
vfs_šode
);

4136 
šode
->
vfs_šode
.
i_ùime
 = 
dœ
->vfs_šode.
i_mtime
 =

4137 
dœ
->
vfs_šode
.
i_ùime
 = 
	`cu¼’t_time
(&
šode
->vfs_inode);

4138 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, &
dœ
->
vfs_šode
);

4139 
out
:

4140  
»t
;

4141 
	}
}

4143 
	$bŒfs_uÆšk_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4144 
bŒfs_roÙ
 *
roÙ
,

4145 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

4146 cÚ¡ *
Çme
, 
Çme_Ën
)

4148 
»t
;

4149 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
dœ
, 
šode
, 
Çme
, 
Çme_Ën
);

4150 ià(!
»t
) {

4151 
	`drÝ_Æšk
(&
šode
->
vfs_šode
);

4152 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, &
šode
->
vfs_šode
);

4154  
»t
;

4155 
	}
}

4165 
bŒfs_Œªs_hªdË
 *
	$__uÆšk_¡¬t_Œªs
(
šode
 *
dœ
)

4167 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

4176  
	`bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(
roÙ
, 5, 5);

4177 
	}
}

4179 
	$bŒfs_uÆšk
(
šode
 *
dœ
, 
d’Œy
 *dentry)

4181 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

4182 
bŒfs_Œªs_hªdË
 *
Œªs
;

4183 
šode
 *šodð
	`d_šode
(
d’Œy
);

4184 
»t
;

4186 
Œªs
 = 
	`__uÆšk_¡¬t_Œªs
(
dœ
);

4187 ià(
	`IS_ERR
(
Œªs
))

4188  
	`PTR_ERR
(
Œªs
);

4190 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
	`d_šode
(
d’Œy
)),

4193 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
dœ
),

4194 
	`BTRFS_I
(
	`d_šode
(
d’Œy
)), d’Œy->
d_Çme
.
Çme
,

4195 
d’Œy
->
d_Çme
.
Ën
);

4196 ià(
»t
)

4197 
out
;

4199 ià(
šode
->
i_Æšk
 == 0) {

4200 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

4201 ià(
»t
)

4202 
out
;

4205 
out
:

4206 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4207 
	`bŒfs_bŒ“_b®ªû_dœty
(
roÙ
->
fs_šfo
);

4208  
»t
;

4209 
	}
}

4211 
	$bŒfs_uÆšk_subvÞ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4212 
bŒfs_roÙ
 *
roÙ
,

4213 
šode
 *
dœ
, 
u64
 
objeùid
,

4214 cÚ¡ *
Çme
, 
Çme_Ën
)

4216 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4217 
bŒfs_·th
 *
·th
;

4218 
ex‹Á_bufãr
 *
Ëaf
;

4219 
bŒfs_dœ_™em
 *
di
;

4220 
bŒfs_key
 
key
;

4221 
u64
 
šdex
;

4222 
»t
;

4223 
u64
 
dœ_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
));

4225 
·th
 = 
	`bŒfs_®loc_·th
();

4226 ià(!
·th
)

4227  -
ENOMEM
;

4229 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
dœ_šo
,

4230 
Çme
, 
Çme_Ën
, -1);

4231 ià(
	`IS_ERR_OR_NULL
(
di
)) {

4232 ià(!
di
)

4233 
»t
 = -
ENOENT
;

4235 
»t
 = 
	`PTR_ERR
(
di
);

4236 
out
;

4239 
Ëaf
 = 
·th
->
nodes
[0];

4240 
	`bŒfs_dœ_™em_key_to_ýu
(
Ëaf
, 
di
, &
key
);

4241 
	`WARN_ON
(
key
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
 || key.
objeùid
 != objectid);

4242 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

4243 ià(
»t
) {

4244 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4245 
out
;

4247 
	`bŒfs_»Ëa£_·th
(
·th
);

4249 
»t
 = 
	`bŒfs_d–_roÙ_»f
(
Œªs
, 
fs_šfo
, 
objeùid
,

4250 
roÙ
->
roÙ_key
.
objeùid
, 
dœ_šo
,

4251 &
šdex
, 
Çme
, 
Çme_Ën
);

4252 ià(
»t
 < 0) {

4253 ià(
»t
 !ð-
ENOENT
) {

4254 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4255 
out
;

4257 
di
 = 
	`bŒfs_£¬ch_dœ_šdex_™em
(
roÙ
, 
·th
, 
dœ_šo
,

4258 
Çme
, 
Çme_Ën
);

4259 ià(
	`IS_ERR_OR_NULL
(
di
)) {

4260 ià(!
di
)

4261 
»t
 = -
ENOENT
;

4263 
»t
 = 
	`PTR_ERR
(
di
);

4264 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4265 
out
;

4268 
Ëaf
 = 
·th
->
nodes
[0];

4269 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

4270 
	`bŒfs_»Ëa£_·th
(
·th
);

4271 
šdex
 = 
key
.
off£t
;

4273 
	`bŒfs_»Ëa£_·th
(
·th
);

4275 
»t
 = 
	`bŒfs_d–‘e_d–ayed_dœ_šdex
(
Œªs
, 
fs_šfo
, 
	`BTRFS_I
(
dœ
), 
šdex
);

4276 ià(
»t
) {

4277 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4278 
out
;

4281 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
dœ
), dœ->
i_size
 - 
Çme_Ën
 * 2);

4282 
	`šode_šc_iv”siÚ
(
dœ
);

4283 
dœ
->
i_mtime
 = dœ->
i_ùime
 = 
	`cu¼’t_time
(dir);

4284 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
roÙ
, 
dœ
);

4285 ià(
»t
)

4286 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4287 
out
:

4288 
	`bŒfs_ä“_·th
(
·th
);

4289  
»t
;

4290 
	}
}

4292 
	$bŒfs_rmdœ
(
šode
 *
dœ
, 
d’Œy
 *dentry)

4294 
šode
 *šodð
	`d_šode
(
d’Œy
);

4295 
”r
 = 0;

4296 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

4297 
bŒfs_Œªs_hªdË
 *
Œªs
;

4298 
u64
 
Ï¡_uÆšk_Œªs
;

4300 ià(
šode
->
i_size
 > 
BTRFS_EMPTY_DIR_SIZE
)

4301  -
ENOTEMPTY
;

4302 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è=ð
BTRFS_FIRST_FREE_OBJECTID
)

4303  -
EPERM
;

4305 
Œªs
 = 
	`__uÆšk_¡¬t_Œªs
(
dœ
);

4306 ià(
	`IS_ERR
(
Œªs
))

4307  
	`PTR_ERR
(
Œªs
);

4309 ià(
	`uÆik–y
(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è=ð
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)) {

4310 
”r
 = 
	`bŒfs_uÆšk_subvÞ
(
Œªs
, 
roÙ
, 
dœ
,

4311 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
,

4312 
d’Œy
->
d_Çme
.
Çme
,

4313 
d’Œy
->
d_Çme
.
Ën
);

4314 
out
;

4317 
”r
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

4318 ià(
”r
)

4319 
out
;

4321 
Ï¡_uÆšk_Œªs
 = 
	`BTRFS_I
(
šode
)->last_unlink_trans;

4324 
”r
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
dœ
),

4325 
	`BTRFS_I
(
	`d_šode
(
d’Œy
)), d’Œy->
d_Çme
.
Çme
,

4326 
d’Œy
->
d_Çme
.
Ën
);

4327 ià(!
”r
) {

4328 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

4340 ià(
Ï¡_uÆšk_Œªs
 >ð
Œªs
->
Œªsid
)

4341 
	`BTRFS_I
(
dœ
)->
Ï¡_uÆšk_Œªs
 =†ast_unlink_trans;

4343 
out
:

4344 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4345 
	`bŒfs_bŒ“_b®ªû_dœty
(
roÙ
->
fs_šfo
);

4347  
”r
;

4348 
	}
}

4350 
	$Œunÿ‹_¥aû_check
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4351 
bŒfs_roÙ
 *
roÙ
,

4352 
u64
 
by‹s_d–‘ed
)

4354 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4355 
»t
;

4361 
by‹s_d–‘ed
 = 
	`bŒfs_csum_by‹s_to_Ëaves
(
fs_šfo
, bytes_deleted);

4362 
by‹s_d–‘ed
 *ð
fs_šfo
->
nodesize
;

4363 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, &
fs_šfo
->
Œªs_block_rsv
,

4364 
by‹s_d–‘ed
, 
BTRFS_RESERVE_NO_FLUSH
);

4365 ià(!
»t
) {

4366 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

4367 
Œªs
->
Œªsid
,

4368 
by‹s_d–‘ed
, 1);

4369 
Œªs
->
by‹s_»£rved
 +ð
by‹s_d–‘ed
;

4371  
»t
;

4373 
	}
}

4375 
	$Œunÿ‹_šlše_ex‹Á
(
šode
 *inode,

4376 
bŒfs_·th
 *
·th
,

4377 
bŒfs_key
 *
found_key
,

4378 cÚ¡ 
u64
 
™em_’d
,

4379 cÚ¡ 
u64
 
Ãw_size
)

4381 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

4382 
¦Ù
 = 
·th
->
¦Ùs
[0];

4383 
bŒfs_fže_ex‹Á_™em
 *
fi
;

4384 
u32
 
size
 = (u32)(
Ãw_size
 - 
found_key
->
off£t
);

4385 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4387 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

4389 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
è!ð
BTRFS_COMPRESS_NONE
) {

4390 
loff_t
 
off£t
 = 
Ãw_size
;

4391 
loff_t
 
·ge_’d
 = 
	`ALIGN
(
off£t
, 
PAGE_SIZE
);

4402 
	`bŒfs_»Ëa£_·th
(
·th
);

4403  
	`bŒfs_Œunÿ‹_block
(
šode
, 
off£t
, 
·ge_’d
 - offset,

4407 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
size
);

4408 
size
 = 
	`bŒfs_fže_ex‹Á_ÿlc_šlše_size
(size);

4409 
	`bŒfs_Œunÿ‹_™em
(
roÙ
->
fs_šfo
, 
·th
, 
size
, 1);

4411 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

4412 
	`šode_sub_by‹s
(
šode
, 
™em_’d
 + 1 - 
Ãw_size
);

4415 
	}
}

4428 
	$bŒfs_Œunÿ‹_šode_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4429 
bŒfs_roÙ
 *
roÙ
,

4430 
šode
 *inode,

4431 
u64
 
Ãw_size
, 
u32
 
mš_ty³
)

4433 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4434 
bŒfs_·th
 *
·th
;

4435 
ex‹Á_bufãr
 *
Ëaf
;

4436 
bŒfs_fže_ex‹Á_™em
 *
fi
;

4437 
bŒfs_key
 
key
;

4438 
bŒfs_key
 
found_key
;

4439 
u64
 
ex‹Á_¡¬t
 = 0;

4440 
u64
 
ex‹Á_num_by‹s
 = 0;

4441 
u64
 
ex‹Á_off£t
 = 0;

4442 
u64
 
™em_’d
 = 0;

4443 
u64
 
Ï¡_size
 = 
Ãw_size
;

4444 
u32
 
found_ty³
 = (
u8
)-1;

4445 
found_ex‹Á
;

4446 
d–_™em
;

4447 
³ndšg_d–_Ä
 = 0;

4448 
³ndšg_d–_¦Ù
 = 0;

4449 
ex‹Á_ty³
 = -1;

4450 
»t
;

4451 
”r
 = 0;

4452 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

4453 
u64
 
by‹s_d–‘ed
 = 0;

4454 
boÞ
 
be_niû
 = 0;

4455 
boÞ
 
should_thrÙŽe
 = 0;

4456 
boÞ
 
should_’d
 = 0;

4458 
	`BUG_ON
(
Ãw_size
 > 0 && 
mš_ty³
 !ð
BTRFS_EXTENT_DATA_KEY
);

4464 ià(!
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
)) &&

4465 
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

4466 
be_niû
 = 1;

4468 
·th
 = 
	`bŒfs_®loc_·th
();

4469 ià(!
·th
)

4470  -
ENOMEM
;

4471 
·th
->
»ada
 = 
READA_BACK
;

4478 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) ||

4479 
roÙ
 =ð
fs_šfo
->
Œ“_roÙ
)

4480 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
	`ALIGN
(
Ãw_size
,

4481 
fs_šfo
->
£ùÜsize
),

4482 (
u64
)-1, 0);

4490 ià(
mš_ty³
 =ð0 && 
roÙ
 =ð
	`BTRFS_I
(
šode
)->root)

4491 
	`bŒfs_kžl_d–ayed_šode_™ems
(
	`BTRFS_I
(
šode
));

4493 
key
.
objeùid
 = 
šo
;

4494 
key
.
off£t
 = (
u64
)-1;

4495 
key
.
ty³
 = (
u8
)-1;

4497 
£¬ch_agaš
:

4503 ià(
be_niû
 && 
by‹s_d–‘ed
 > 
SZ_32M
) {

4504 ià(
	`bŒfs_should_’d_Œª§ùiÚ
(
Œªs
)) {

4505 
”r
 = -
EAGAIN
;

4506 
”rÜ
;

4511 
·th
->
Ëave_¥šnšg
 = 1;

4512 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

4513 ià(
»t
 < 0) {

4514 
”r
 = 
»t
;

4515 
out
;

4518 ià(
»t
 > 0) {

4522 ià(
·th
->
¦Ùs
[0] == 0)

4523 
out
;

4524 
·th
->
¦Ùs
[0]--;

4528 
fi
 = 
NULL
;

4529 
Ëaf
 = 
·th
->
nodes
[0];

4530 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

4531 
found_ty³
 = 
found_key
.
ty³
;

4533 ià(
found_key
.
objeùid
 !ð
šo
)

4536 ià(
found_ty³
 < 
mš_ty³
)

4539 
™em_’d
 = 
found_key
.
off£t
;

4540 ià(
found_ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

4541 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4542 
bŒfs_fže_ex‹Á_™em
);

4543 
ex‹Á_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
);

4544 ià(
ex‹Á_ty³
 !ð
BTRFS_FILE_EXTENT_INLINE
) {

4545 
™em_’d
 +=

4546 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

4548 
	`Œaû_bŒfs_Œunÿ‹_show_fi_»guÏr
(

4549 
	`BTRFS_I
(
šode
), 
Ëaf
, 
fi
,

4550 
found_key
.
off£t
);

4551 } ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

4552 
™em_’d
 +ð
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
,

4553 
·th
->
¦Ùs
[0], 
fi
);

4555 
	`Œaû_bŒfs_Œunÿ‹_show_fi_šlše
(

4556 
	`BTRFS_I
(
šode
), 
Ëaf
, 
fi
, 
·th
->
¦Ùs
[0],

4557 
found_key
.
off£t
);

4559 
™em_’d
--;

4561 ià(
found_ty³
 > 
mš_ty³
) {

4562 
d–_™em
 = 1;

4564 ià(
™em_’d
 < 
Ãw_size
)

4566 ià(
found_key
.
off£t
 >ð
Ãw_size
)

4567 
d–_™em
 = 1;

4569 
d–_™em
 = 0;

4571 
found_ex‹Á
 = 0;

4573 ià(
found_ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

4574 
d–‘e
;

4576 ià(
d–_™em
)

4577 
Ï¡_size
 = 
found_key
.
off£t
;

4579 
Ï¡_size
 = 
Ãw_size
;

4581 ià(
ex‹Á_ty³
 !ð
BTRFS_FILE_EXTENT_INLINE
) {

4582 
u64
 
num_dec
;

4583 
ex‹Á_¡¬t
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

4584 ià(!
d–_™em
) {

4585 
u64
 
Üig_num_by‹s
 =

4586 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

4587 
ex‹Á_num_by‹s
 = 
	`ALIGN
(
Ãw_size
 -

4588 
found_key
.
off£t
,

4589 
fs_šfo
->
£ùÜsize
);

4590 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
,

4591 
ex‹Á_num_by‹s
);

4592 
num_dec
 = (
Üig_num_by‹s
 -

4593 
ex‹Á_num_by‹s
);

4594 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
,

4595 &
roÙ
->
¡©e
) &&

4596 
ex‹Á_¡¬t
 != 0)

4597 
	`šode_sub_by‹s
(
šode
, 
num_dec
);

4598 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4600 
ex‹Á_num_by‹s
 =

4601 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
,

4602 
fi
);

4603 
ex‹Á_off£t
 = 
found_key
.
off£t
 -

4604 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

4607 
num_dec
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

4608 ià(
ex‹Á_¡¬t
 != 0) {

4609 
found_ex‹Á
 = 1;

4610 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
,

4611 &
roÙ
->
¡©e
))

4612 
	`šode_sub_by‹s
(
šode
, 
num_dec
);

4615 } ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

4620 ià(!
d–_™em
 &&

4621 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) == 0 &&

4622 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
) == 0) {

4629 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) !=

4630 
BTRFS_COMPRESS_NONE
 && 
³ndšg_d–_Ä
) {

4631 
”r
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,

4632 
³ndšg_d–_¦Ù
,

4633 
³ndšg_d–_Ä
);

4634 ià(
”r
) {

4635 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
,

4636 
”r
);

4637 
”rÜ
;

4639 
³ndšg_d–_Ä
 = 0;

4642 
”r
 = 
	`Œunÿ‹_šlše_ex‹Á
(
šode
, 
·th
,

4643 &
found_key
,

4644 
™em_’d
,

4645 
Ãw_size
);

4646 ià(
”r
) {

4647 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

4648 
”rÜ
;

4650 } ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
,

4651 &
roÙ
->
¡©e
)) {

4652 
	`šode_sub_by‹s
(
šode
, 
™em_’d
 + 1 - 
Ãw_size
);

4655 
d–‘e
:

4656 ià(
d–_™em
) {

4657 ià(!
³ndšg_d–_Ä
) {

4659 
³ndšg_d–_¦Ù
 = 
·th
->
¦Ùs
[0];

4660 
³ndšg_d–_Ä
 = 1;

4661 } ià(
³ndšg_d–_Ä
 &&

4662 
·th
->
¦Ùs
[0] + 1 =ð
³ndšg_d–_¦Ù
) {

4664 
³ndšg_d–_Ä
++;

4665 
³ndšg_d–_¦Ù
 = 
·th
->
¦Ùs
[0];

4667 
	`BUG
();

4672 
should_thrÙŽe
 = 0;

4674 ià(
found_ex‹Á
 &&

4675 (
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) ||

4676 
roÙ
 =ð
fs_šfo
->
Œ“_roÙ
)) {

4677 
	`bŒfs_£t_·th_blockšg
(
·th
);

4678 
by‹s_d–‘ed
 +ð
ex‹Á_num_by‹s
;

4679 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
ex‹Á_¡¬t
,

4680 
ex‹Á_num_by‹s
, 0,

4681 
	`bŒfs_h—d”_owÃr
(
Ëaf
),

4682 
šo
, 
ex‹Á_off£t
);

4683 
	`BUG_ON
(
»t
);

4684 ià(
	`bŒfs_should_thrÙŽe_d–ayed_»fs
(
Œªs
, 
fs_šfo
))

4685 
	`bŒfs_async_run_d–ayed_»fs
(
fs_šfo
,

4686 
Œªs
->
d–ayed_»f_upd©es
 * 2,

4687 
Œªs
->
Œªsid
, 0);

4688 ià(
be_niû
) {

4689 ià(
	`Œunÿ‹_¥aû_check
(
Œªs
, 
roÙ
,

4690 
ex‹Á_num_by‹s
)) {

4691 
should_’d
 = 1;

4693 ià(
	`bŒfs_should_thrÙŽe_d–ayed_»fs
(
Œªs
,

4694 
fs_šfo
))

4695 
should_thrÙŽe
 = 1;

4699 ià(
found_ty³
 =ð
BTRFS_INODE_ITEM_KEY
)

4702 ià(
·th
->
¦Ùs
[0] == 0 ||

4703 
·th
->
¦Ùs
[0] !ð
³ndšg_d–_¦Ù
 ||

4704 
should_thrÙŽe
 || 
should_’d
) {

4705 ià(
³ndšg_d–_Ä
) {

4706 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
,

4707 
³ndšg_d–_¦Ù
,

4708 
³ndšg_d–_Ä
);

4709 ià(
»t
) {

4710 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4711 
”rÜ
;

4713 
³ndšg_d–_Ä
 = 0;

4715 
	`bŒfs_»Ëa£_·th
(
·th
);

4716 ià(
should_thrÙŽe
) {

4717 
upd©es
 = 
Œªs
->
d–ayed_»f_upd©es
;

4718 ià(
upd©es
) {

4719 
Œªs
->
d–ayed_»f_upd©es
 = 0;

4720 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
,

4721 
fs_šfo
,

4722 
upd©es
 * 2);

4723 ià(
»t
 && !
”r
)

4724 
”r
 = 
»t
;

4731 ià(
should_’d
) {

4732 
”r
 = -
EAGAIN
;

4733 
”rÜ
;

4735 
£¬ch_agaš
;

4737 
·th
->
¦Ùs
[0]--;

4740 
out
:

4741 ià(
³ndšg_d–_Ä
) {

4742 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 
³ndšg_d–_¦Ù
,

4743 
³ndšg_d–_Ä
);

4744 ià(
»t
)

4745 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4747 
”rÜ
:

4748 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
) {

4749 
	`ASSERT
(
Ï¡_size
 >ð
Ãw_size
);

4750 ià(!
”r
 && 
Ï¡_size
 > 
Ãw_size
)

4751 
Ï¡_size
 = 
Ãw_size
;

4752 
	`bŒfs_Üd”ed_upd©e_i_size
(
šode
, 
Ï¡_size
, 
NULL
);

4755 
	`bŒfs_ä“_·th
(
·th
);

4757 ià(
be_niû
 && 
by‹s_d–‘ed
 > 
SZ_32M
) {

4758 
upd©es
 = 
Œªs
->
d–ayed_»f_upd©es
;

4759 ià(
upd©es
) {

4760 
Œªs
->
d–ayed_»f_upd©es
 = 0;

4761 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
,

4762 
upd©es
 * 2);

4763 ià(
»t
 && !
”r
)

4764 
”r
 = 
»t
;

4767  
”r
;

4768 
	}
}

4781 
	$bŒfs_Œunÿ‹_block
(
šode
 *šode, 
loff_t
 
äom
,†off_ˆ
Ën
,

4782 
äÚt
)

4784 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4785 
add»ss_¥aû
 *
m­pšg
 = 
šode
->
i_m­pšg
;

4786 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

4787 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4788 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4789 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

4790 *
kaddr
;

4791 
u32
 
blocksize
 = 
fs_šfo
->
£ùÜsize
;

4792 
pgoff_t
 
šdex
 = 
äom
 >> 
PAGE_SHIFT
;

4793 
off£t
 = 
äom
 & (
blocksize
 - 1);

4794 
·ge
 *page;

4795 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
m­pšg
);

4796 
»t
 = 0;

4797 
u64
 
block_¡¬t
;

4798 
u64
 
block_’d
;

4800 ià((
off£t
 & (
blocksize
 - 1)) == 0 &&

4801 (!
Ën
 || (Ö’ & (
blocksize
 - 1)) == 0)))

4802 
out
;

4804 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
,

4805 
	`round_down
(
äom
, 
blocksize
), blocksize);

4806 ià(
»t
)

4807 
out
;

4809 
agaš
:

4810 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
m­pšg
, 
šdex
, 
mask
);

4811 ià(!
·ge
) {

4812 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

4813 
	`round_down
(
äom
, 
blocksize
),

4814 
blocksize
);

4815 
»t
 = -
ENOMEM
;

4816 
out
;

4819 
block_¡¬t
 = 
	`round_down
(
äom
, 
blocksize
);

4820 
block_’d
 = 
block_¡¬t
 + 
blocksize
 - 1;

4822 ià(!
	`PageU±od©e
(
·ge
)) {

4823 
»t
 = 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

4824 
	`lock_·ge
(
·ge
);

4825 ià(
·ge
->
m­pšg
 != mapping) {

4826 
	`uÆock_·ge
(
·ge
);

4827 
	`put_·ge
(
·ge
);

4828 
agaš
;

4830 ià(!
	`PageU±od©e
(
·ge
)) {

4831 
»t
 = -
EIO
;

4832 
out_uÆock
;

4835 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

4837 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
block_¡¬t
, 
block_’d
, &
ÿched_¡©e
);

4838 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

4840 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
, 
block_¡¬t
);

4841 ià(
Üd”ed
) {

4842 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
block_¡¬t
, 
block_’d
,

4843 &
ÿched_¡©e
, 
GFP_NOFS
);

4844 
	`uÆock_·ge
(
·ge
);

4845 
	`put_·ge
(
·ge
);

4846 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

4847 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

4848 
agaš
;

4851 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
block_¡¬t
, 
block_’d
,

4852 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

4853 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

4854 0, 0, &
ÿched_¡©e
, 
GFP_NOFS
);

4856 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
block_¡¬t
, 
block_’d
,

4857 &
ÿched_¡©e
, 0);

4858 ià(
»t
) {

4859 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
block_¡¬t
, 
block_’d
,

4860 &
ÿched_¡©e
, 
GFP_NOFS
);

4861 
out_uÆock
;

4864 ià(
off£t
 !ð
blocksize
) {

4865 ià(!
Ën
)

4866 
Ën
 = 
blocksize
 - 
off£t
;

4867 
kaddr
 = 
	`km­
(
·ge
);

4868 ià(
äÚt
)

4869 
	`mem£t
(
kaddr
 + (
block_¡¬t
 - 
	`·ge_off£t
(
·ge
)),

4870 0, 
off£t
);

4872 
	`mem£t
(
kaddr
 + (
block_¡¬t
 - 
	`·ge_off£t
(
·ge
)è+ 
off£t
,

4873 0, 
Ën
);

4874 
	`æush_dÿche_·ge
(
·ge
);

4875 
	`kunm­
(
·ge
);

4877 
	`CË¬PageChecked
(
·ge
);

4878 
	`£t_·ge_dœty
(
·ge
);

4879 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
block_¡¬t
, 
block_’d
, &
ÿched_¡©e
,

4880 
GFP_NOFS
);

4882 
out_uÆock
:

4883 ià(
»t
)

4884 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
, 
block_¡¬t
,

4885 
blocksize
);

4886 
	`uÆock_·ge
(
·ge
);

4887 
	`put_·ge
(
·ge
);

4888 
out
:

4889 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

4890  
»t
;

4891 
	}
}

4893 
	$maybe_š£¹_hÞe
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *inode,

4894 
u64
 
off£t
, u64 
Ën
)

4896 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4897 
bŒfs_Œªs_hªdË
 *
Œªs
;

4898 
»t
;

4904 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
)) {

4905 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
fs_šfo
->
g’”©iÚ
;

4906 
	`BTRFS_I
(
šode
)->
Ï¡_sub_Œªs
 = 
roÙ
->
log_Œªsid
;

4907 
	`BTRFS_I
(
šode
)->
Ï¡_log_comm™
 = 
roÙ
->last_log_commit;

4916 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

4917 ià(
	`IS_ERR
(
Œªs
))

4918  
	`PTR_ERR
(
Œªs
);

4920 
»t
 = 
	`bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
off£t
, off£ˆ+ 
Ën
, 1);

4921 ià(
»t
) {

4922 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4923 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4924  
»t
;

4927 
»t
 = 
	`bŒfs_š£¹_fže_ex‹Á
(
Œªs
, 
roÙ
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

4928 
off£t
, 0, 0, 
Ën
, 0,†en, 0, 0, 0);

4929 ià(
»t
)

4930 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4932 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

4933 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4934  
»t
;

4935 
	}
}

4943 
	$bŒfs_cÚt_ex·nd
(
šode
 *šode, 
loff_t
 
Þdsize
,†off_ˆ
size
)

4945 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4946 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4947 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

4948 
ex‹Á_m­
 *
em
 = 
NULL
;

4949 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4950 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

4951 
u64
 
hÞe_¡¬t
 = 
	`ALIGN
(
Þdsize
, 
fs_šfo
->
£ùÜsize
);

4952 
u64
 
block_’d
 = 
	`ALIGN
(
size
, 
fs_šfo
->
£ùÜsize
);

4953 
u64
 
Ï¡_by‹
;

4954 
u64
 
cur_off£t
;

4955 
u64
 
hÞe_size
;

4956 
”r
 = 0;

4963 
”r
 = 
	`bŒfs_Œunÿ‹_block
(
šode
, 
Þdsize
, 0, 0);

4964 ià(
”r
)

4965  
”r
;

4967 ià(
size
 <ð
hÞe_¡¬t
)

4971 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4973 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
hÞe_¡¬t
, 
block_’d
 - 1,

4974 &
ÿched_¡©e
);

4975 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
hÞe_¡¬t
,

4976 
block_’d
 - 
hÞe_¡¬t
);

4977 ià(!
Üd”ed
)

4979 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
hÞe_¡¬t
, 
block_’d
 - 1,

4980 &
ÿched_¡©e
, 
GFP_NOFS
);

4981 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

4982 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

4985 
cur_off£t
 = 
hÞe_¡¬t
;

4987 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
cur_off£t
,

4988 
block_’d
 - 
cur_off£t
, 0);

4989 ià(
	`IS_ERR
(
em
)) {

4990 
”r
 = 
	`PTR_ERR
(
em
);

4991 
em
 = 
NULL
;

4994 
Ï¡_by‹
 = 
	`mš
(
	`ex‹Á_m­_’d
(
em
), 
block_’d
);

4995 
Ï¡_by‹
 = 
	`ALIGN
Öa¡_by‹, 
fs_šfo
->
£ùÜsize
);

4996 ià(!
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
)) {

4997 
ex‹Á_m­
 *
hÞe_em
;

4998 
hÞe_size
 = 
Ï¡_by‹
 - 
cur_off£t
;

5000 
”r
 = 
	`maybe_š£¹_hÞe
(
roÙ
, 
šode
, 
cur_off£t
,

5001 
hÞe_size
);

5002 ià(
”r
)

5004 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
cur_off£t
,

5005 
cur_off£t
 + 
hÞe_size
 - 1, 0);

5006 
hÞe_em
 = 
	`®loc_ex‹Á_m­
();

5007 ià(!
hÞe_em
) {

5008 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

5009 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

5010 
Ãxt
;

5012 
hÞe_em
->
¡¬t
 = 
cur_off£t
;

5013 
hÞe_em
->
Ën
 = 
hÞe_size
;

5014 
hÞe_em
->
Üig_¡¬t
 = 
cur_off£t
;

5016 
hÞe_em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

5017 
hÞe_em
->
block_Ën
 = 0;

5018 
hÞe_em
->
Üig_block_Ën
 = 0;

5019 
hÞe_em
->
¿m_by‹s
 = 
hÞe_size
;

5020 
hÞe_em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

5021 
hÞe_em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

5022 
hÞe_em
->
g’”©iÚ
 = 
fs_šfo
->generation;

5025 
	`wr™e_lock
(&
em_Œ“
->
lock
);

5026 
”r
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
hÞe_em
, 1);

5027 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

5028 ià(
”r
 !ð-
EEXIST
)

5030 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
),

5031 
cur_off£t
,

5032 
cur_off£t
 +

5033 
hÞe_size
 - 1, 0);

5035 
	`ä“_ex‹Á_m­
(
hÞe_em
);

5037 
Ãxt
:

5038 
	`ä“_ex‹Á_m­
(
em
);

5039 
em
 = 
NULL
;

5040 
cur_off£t
 = 
Ï¡_by‹
;

5041 ià(
cur_off£t
 >ð
block_’d
)

5044 
	`ä“_ex‹Á_m­
(
em
);

5045 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
hÞe_¡¬t
, 
block_’d
 - 1, &
ÿched_¡©e
,

5046 
GFP_NOFS
);

5047  
”r
;

5048 
	}
}

5050 
	$bŒfs_£tsize
(
šode
 *šode, 
Ÿ‰r
 *
©Œ
)

5052 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5053 
bŒfs_Œªs_hªdË
 *
Œªs
;

5054 
loff_t
 
Þdsize
 = 
	`i_size_»ad
(
šode
);

5055 
loff_t
 
Ãwsize
 = 
©Œ
->
Ÿ_size
;

5056 
mask
 = 
©Œ
->
Ÿ_v®id
;

5057 
»t
;

5065 ià(
Ãwsize
 !ð
Þdsize
) {

5066 
	`šode_šc_iv”siÚ
(
šode
);

5067 ià(!(
mask
 & (
ATTR_CTIME
 | 
ATTR_MTIME
)))

5068 
šode
->
i_ùime
 = inode->
i_mtime
 =

5069 
	`cu¼’t_time
(
šode
);

5072 ià(
Ãwsize
 > 
Þdsize
) {

5080 
	`bŒfs_wa™_fÜ_¢­shÙ_ü—tiÚ
(
roÙ
);

5081 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
šode
, 
Þdsize
, 
Ãwsize
);

5082 ià(
»t
) {

5083 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

5084  
»t
;

5087 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

5088 ià(
	`IS_ERR
(
Œªs
)) {

5089 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

5090  
	`PTR_ERR
(
Œªs
);

5093 
	`i_size_wr™e
(
šode
, 
Ãwsize
);

5094 
	`bŒfs_Üd”ed_upd©e_i_size
(
šode
, 
	`i_size_»ad
(šode), 
NULL
);

5095 
	`·geÿche_isize_ex‹nded
(
šode
, 
Þdsize
, 
Ãwsize
);

5096 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

5097 
	`bŒfs_’d_wr™e_no_¢­shÙtšg
(
roÙ
);

5098 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5106 ià(
Ãwsize
 == 0)

5107 
	`£t_b™
(
BTRFS_INODE_ORDERED_DATA_CLOSE
,

5108 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

5114 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

5115 ià(
	`IS_ERR
(
Œªs
))

5116  
	`PTR_ERR
(
Œªs
);

5128 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

5129 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5130 ià(
»t
)

5131  
»t
;

5134 
	`Œunÿ‹_£tsize
(
šode
, 
Ãwsize
);

5137 
	`bŒfs_šode_block_uÆocked_dio
(
	`BTRFS_I
(
šode
));

5138 
	`šode_dio_wa™
(
šode
);

5139 
	`bŒfs_šode_»sume_uÆocked_dio
(
	`BTRFS_I
(
šode
));

5141 
»t
 = 
	`bŒfs_Œunÿ‹
(
šode
);

5142 ià(
»t
 && 
šode
->
i_Æšk
) {

5143 
”r
;

5146 
”r
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, (
u64
)-1);

5147 ià(
”r
) {

5148 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5149  
”r
;

5158 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

5159 ià(
	`IS_ERR
(
Œªs
)) {

5160 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5161  
»t
;

5163 
	`i_size_wr™e
(
šode
, 
	`BTRFS_I
(šode)->
disk_i_size
);

5164 
”r
 = 
	`bŒfs_Üphª_d–
(
Œªs
, 
	`BTRFS_I
(
šode
));

5165 ià(
”r
)

5166 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

5167 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5171  
»t
;

5172 
	}
}

5174 
	$bŒfs_£‰r
(
d’Œy
 *d’Œy, 
Ÿ‰r
 *
©Œ
)

5176 
šode
 *šodð
	`d_šode
(
d’Œy
);

5177 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5178 
”r
;

5180 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

5181  -
EROFS
;

5183 
”r
 = 
	`£‰r_´•¬e
(
d’Œy
, 
©Œ
);

5184 ià(
”r
)

5185  
”r
;

5187 ià(
	`S_ISREG
(
šode
->
i_mode
è&& (
©Œ
->
Ÿ_v®id
 & 
ATTR_SIZE
)) {

5188 
”r
 = 
	`bŒfs_£tsize
(
šode
, 
©Œ
);

5189 ià(
”r
)

5190  
”r
;

5193 ià(
©Œ
->
Ÿ_v®id
) {

5194 
	`£‰r_cÝy
(
šode
, 
©Œ
);

5195 
	`šode_šc_iv”siÚ
(
šode
);

5196 
”r
 = 
	`bŒfs_dœty_šode
(
šode
);

5198 ià(!
”r
 && 
©Œ
->
Ÿ_v®id
 & 
ATTR_MODE
)

5199 
”r
 = 
	`posix_aþ_chmod
(
šode
, inode->
i_mode
);

5202  
”r
;

5203 
	}
}

5217 
	$eviù_šode_Œunÿ‹_·ges
(
šode
 *inode)

5219 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

5220 
ex‹Á_m­_Œ“
 *
m­_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

5221 
rb_node
 *
node
;

5223 
	`ASSERT
(
šode
->
i_¡©e
 & 
I_FREEING
);

5224 
	`Œunÿ‹_šode_·ges_fš®
(&
šode
->
i_d©a
);

5226 
	`wr™e_lock
(&
m­_Œ“
->
lock
);

5227 !
	`RB_EMPTY_ROOT
(&
m­_Œ“
->
m­
)) {

5228 
ex‹Á_m­
 *
em
;

5230 
node
 = 
	`rb_fœ¡
(&
m­_Œ“
->
m­
);

5231 
em
 = 
	`rb_’Œy
(
node
, 
ex‹Á_m­
, 
rb_node
);

5232 
	`þ—r_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

5233 
	`þ—r_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
);

5234 
	`»move_ex‹Á_m­pšg
(
m­_Œ“
, 
em
);

5235 
	`ä“_ex‹Á_m­
(
em
);

5236 ià(
	`Ãed_»sched
()) {

5237 
	`wr™e_uÆock
(&
m­_Œ“
->
lock
);

5238 
	`cÚd_»sched
();

5239 
	`wr™e_lock
(&
m­_Œ“
->
lock
);

5242 
	`wr™e_uÆock
(&
m­_Œ“
->
lock
);

5260 
	`¥š_lock
(&
io_Œ“
->
lock
);

5261 !
	`RB_EMPTY_ROOT
(&
io_Œ“
->
¡©e
)) {

5262 
ex‹Á_¡©e
 *
¡©e
;

5263 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

5264 
u64
 
¡¬t
;

5265 
u64
 
’d
;

5267 
node
 = 
	`rb_fœ¡
(&
io_Œ“
->
¡©e
);

5268 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

5269 
¡¬t
 = 
¡©e
->start;

5270 
’d
 = 
¡©e
->end;

5271 
	`¥š_uÆock
(&
io_Œ“
->
lock
);

5273 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched_¡©e
);

5283 ià(
¡©e
->¡©& 
EXTENT_DELALLOC
)

5284 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
NULL
, 
¡¬t
, 
’d
 - start + 1);

5286 
	`þ—r_ex‹Á_b™
(
io_Œ“
, 
¡¬t
, 
’d
,

5287 
EXTENT_LOCKED
 | 
EXTENT_DIRTY
 |

5288 
EXTENT_DELALLOC
 | 
EXTENT_DO_ACCOUNTING
 |

5289 
EXTENT_DEFRAG
, 1, 1,

5290 &
ÿched_¡©e
, 
GFP_NOFS
);

5292 
	`cÚd_»sched
();

5293 
	`¥š_lock
(&
io_Œ“
->
lock
);

5295 
	`¥š_uÆock
(&
io_Œ“
->
lock
);

5296 
	}
}

5298 
	$bŒfs_eviù_šode
(
šode
 *inode)

5300 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5301 
bŒfs_Œªs_hªdË
 *
Œªs
;

5302 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5303 
bŒfs_block_rsv
 *
rsv
, *
glob®_rsv
;

5304 
¡—l_äom_glob®
 = 0;

5305 
u64
 
mš_size
;

5306 
»t
;

5308 
	`Œaû_bŒfs_šode_eviù
(
šode
);

5310 ià(!
roÙ
) {

5311 
	`kmem_ÿche_ä“
(
bŒfs_šode_ÿch•
, 
	`BTRFS_I
(
šode
));

5315 
mš_size
 = 
	`bŒfs_ÿlc_Œunc_m‘ad©a_size
(
fs_šfo
, 1);

5317 
	`eviù_šode_Œunÿ‹_·ges
(
šode
);

5319 ià(
šode
->
i_Æšk
 &&

5320 ((
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) != 0 &&

5321 
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_ROOT_TREE_OBJECTID
) ||

5322 
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))))

5323 
no_d–‘e
;

5325 ià(
	`is_bad_šode
(
šode
)) {

5326 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5327 
no_d–‘e
;

5330 ià(!
	`¥ecŸl_fže
(
šode
->
i_mode
))

5331 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 0, (
u64
)-1);

5333 
	`bŒfs_ä“_io_çžu»_»cÜd
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1);

5335 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
)) {

5336 
	`BUG_ON
(
	`‹¡_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

5337 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
));

5338 
no_d–‘e
;

5341 ià(
šode
->
i_Æšk
 > 0) {

5342 
	`BUG_ON
(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) != 0 &&

5343 
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_ROOT_TREE_OBJECTID
);

5344 
no_d–‘e
;

5347 
»t
 = 
	`bŒfs_comm™_šode_d–ayed_šode
(
	`BTRFS_I
(
šode
));

5348 ià(
»t
) {

5349 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5350 
no_d–‘e
;

5353 
rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
, 
BTRFS_BLOCK_RSV_TEMP
);

5354 ià(!
rsv
) {

5355 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5356 
no_d–‘e
;

5358 
rsv
->
size
 = 
mš_size
;

5359 
rsv
->
çžç¡
 = 1;

5360 
glob®_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

5362 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

5371 
»t
 = 
	`bŒfs_block_rsv_»fžl
(
roÙ
, 
rsv
, 
mš_size
,

5372 
BTRFS_RESERVE_FLUSH_LIMIT
);

5379 ià(
»t
)

5380 
¡—l_äom_glob®
++;

5382 
¡—l_äom_glob®
 = 0;

5383 
»t
 = 0;

5393 ià(
¡—l_äom_glob®
 > 2) {

5394 
	`bŒfs_w¬n
(
fs_šfo
,

5396 
»t
);

5397 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5398 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

5399 
no_d–‘e
;

5402 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

5403 ià(
	`IS_ERR
(
Œªs
)) {

5404 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5405 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

5406 
no_d–‘e
;

5414 ià(
¡—l_äom_glob®
) {

5415 ià(!
	`bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
Œªs
, 
fs_šfo
))

5416 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(
glob®_rsv
, 
rsv
,

5417 
mš_size
, 0);

5419 
»t
 = -
ENOSPC
;

5427 ià(
»t
) {

5428 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5429 ià(
»t
) {

5430 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5431 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

5432 
no_d–‘e
;

5436 
¡—l_äom_glob®
 = 0;

5439 
Œªs
->
block_rsv
 = 
rsv
;

5441 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
, 
šode
, 0, 0);

5442 ià(
»t
 !ð-
ENOSPC
 &&„‘ !ð-
EAGAIN
)

5445 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

5446 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5447 
Œªs
 = 
NULL
;

5448 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

5451 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

5457 ià(
»t
 == 0) {

5458 
Œªs
->
block_rsv
 = 
roÙ
->
Üphª_block_rsv
;

5459 
	`bŒfs_Üphª_d–
(
Œªs
, 
	`BTRFS_I
(
šode
));

5461 
	`bŒfs_Üphª_d–
(
NULL
, 
	`BTRFS_I
(
šode
));

5464 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

5465 ià(!(
roÙ
 =ð
fs_šfo
->
Œ“_roÙ
 ||

5466 
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
))

5467 
	`bŒfs_»tuº_šo
(
roÙ
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)));

5469 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5470 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

5471 
no_d–‘e
:

5472 
	`bŒfs_»move_d–ayed_node
(
	`BTRFS_I
(
šode
));

5473 
	`þ—r_šode
(
šode
);

5474 
	}
}

5480 
	$bŒfs_šode_by_Çme
(
šode
 *
dœ
, 
d’Œy
 *dentry,

5481 
bŒfs_key
 *
loÿtiÚ
)

5483 cÚ¡ *
Çme
 = 
d’Œy
->
d_Çme
.name;

5484 
Çm–’
 = 
d’Œy
->
d_Çme
.
Ën
;

5485 
bŒfs_dœ_™em
 *
di
;

5486 
bŒfs_·th
 *
·th
;

5487 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

5488 
»t
 = 0;

5490 
·th
 = 
	`bŒfs_®loc_·th
();

5491 ià(!
·th
)

5492  -
ENOMEM
;

5494 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)),

5495 
Çme
, 
Çm–’
, 0);

5496 ià(
	`IS_ERR
(
di
))

5497 
»t
 = 
	`PTR_ERR
(
di
);

5499 ià(
	`IS_ERR_OR_NULL
(
di
))

5500 
out_”r
;

5502 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, 
loÿtiÚ
);

5503 
out
:

5504 
	`bŒfs_ä“_·th
(
·th
);

5505  
»t
;

5506 
out_”r
:

5507 
loÿtiÚ
->
objeùid
 = 0;

5508 
out
;

5509 
	}
}

5516 
	$fixup_Œ“_roÙ_loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

5517 
šode
 *
dœ
,

5518 
d’Œy
 *dentry,

5519 
bŒfs_key
 *
loÿtiÚ
,

5520 
bŒfs_roÙ
 **
sub_roÙ
)

5522 
bŒfs_·th
 *
·th
;

5523 
bŒfs_roÙ
 *
Ãw_roÙ
;

5524 
bŒfs_roÙ_»f
 *
»f
;

5525 
ex‹Á_bufãr
 *
Ëaf
;

5526 
bŒfs_key
 
key
;

5527 
»t
;

5528 
”r
 = 0;

5530 
·th
 = 
	`bŒfs_®loc_·th
();

5531 ià(!
·th
) {

5532 
”r
 = -
ENOMEM
;

5533 
out
;

5536 
”r
 = -
ENOENT
;

5537 
key
.
objeùid
 = 
	`BTRFS_I
(
dœ
)->
roÙ
->
roÙ_key
.objectid;

5538 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

5539 
key
.
off£t
 = 
loÿtiÚ
->
objeùid
;

5541 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

5542 ià(
»t
) {

5543 ià(
»t
 < 0)

5544 
”r
 = 
»t
;

5545 
out
;

5548 
Ëaf
 = 
·th
->
nodes
[0];

5549 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_roÙ_»f
);

5550 ià(
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
»f
è!ð
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)) ||

5551 
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
è!ð
d’Œy
->
d_Çme
.
Ën
)

5552 
out
;

5554 
»t
 = 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
d’Œy
->
d_Çme
.
Çme
,

5555 ()(
»f
 + 1),

5556 
d’Œy
->
d_Çme
.
Ën
);

5557 ià(
»t
)

5558 
out
;

5560 
	`bŒfs_»Ëa£_·th
(
·th
);

5562 
Ãw_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, 
loÿtiÚ
);

5563 ià(
	`IS_ERR
(
Ãw_roÙ
)) {

5564 
”r
 = 
	`PTR_ERR
(
Ãw_roÙ
);

5565 
out
;

5568 *
sub_roÙ
 = 
Ãw_roÙ
;

5569 
loÿtiÚ
->
objeùid
 = 
	`bŒfs_roÙ_dœid
(&
Ãw_roÙ
->
roÙ_™em
);

5570 
loÿtiÚ
->
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

5571 
loÿtiÚ
->
off£t
 = 0;

5572 
”r
 = 0;

5573 
out
:

5574 
	`bŒfs_ä“_·th
(
·th
);

5575  
”r
;

5576 
	}
}

5578 
	$šode_Œ“_add
(
šode
 *inode)

5580 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5581 
bŒfs_šode
 *
’Œy
;

5582 
rb_node
 **
p
;

5583 
rb_node
 *
·»Á
;

5584 
rb_node
 *
Ãw
 = &
	`BTRFS_I
(
šode
)->rb_node;

5585 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

5587 ià(
	`šode_unhashed
(
šode
))

5589 
·»Á
 = 
NULL
;

5590 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5591 
p
 = &
roÙ
->
šode_Œ“
.
rb_node
;

5592 *
p
) {

5593 
·»Á
 = *
p
;

5594 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_šode
, 
rb_node
);

5596 ià(
šo
 < 
	`bŒfs_šo
(
	`BTRFS_I
(&
’Œy
->
vfs_šode
)))

5597 
p
 = &
·»Á
->
rb_Ëá
;

5598 ià(
šo
 > 
	`bŒfs_šo
(
	`BTRFS_I
(&
’Œy
->
vfs_šode
)))

5599 
p
 = &
·»Á
->
rb_right
;

5601 
	`WARN_ON
(!(
’Œy
->
vfs_šode
.
i_¡©e
 &

5602 (
I_WILL_FREE
 | 
I_FREEING
)));

5603 
	`rb_»¶aû_node
(
·»Á
, 
Ãw
, &
roÙ
->
šode_Œ“
);

5604 
	`RB_CLEAR_NODE
(
·»Á
);

5605 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5609 
	`rb_lšk_node
(
Ãw
, 
·»Á
, 
p
);

5610 
	`rb_š£¹_cÞÜ
(
Ãw
, &
roÙ
->
šode_Œ“
);

5611 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5612 
	}
}

5614 
	$šode_Œ“_d–
(
šode
 *inode)

5616 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5617 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5618 
em±y
 = 0;

5620 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5621 ià(!
	`RB_EMPTY_NODE
(&
	`BTRFS_I
(
šode
)->
rb_node
)) {

5622 
	`rb_”a£
(&
	`BTRFS_I
(
šode
)->
rb_node
, &
roÙ
->
šode_Œ“
);

5623 
	`RB_CLEAR_NODE
(&
	`BTRFS_I
(
šode
)->
rb_node
);

5624 
em±y
 = 
	`RB_EMPTY_ROOT
(&
roÙ
->
šode_Œ“
);

5626 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5628 ià(
em±y
 && 
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0) {

5629 
	`synchrÚize_¤cu
(&
fs_šfo
->
subvÞ_¤cu
);

5630 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5631 
em±y
 = 
	`RB_EMPTY_ROOT
(&
roÙ
->
šode_Œ“
);

5632 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5633 ià(
em±y
)

5634 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

5636 
	}
}

5638 
	$bŒfs_šv®id©e_šodes
(
bŒfs_roÙ
 *
roÙ
)

5640 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5641 
rb_node
 *
node
;

5642 
rb_node
 *
´ev
;

5643 
bŒfs_šode
 *
’Œy
;

5644 
šode
 *inode;

5645 
u64
 
objeùid
 = 0;

5647 ià(!
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
))

5648 
	`WARN_ON
(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) != 0);

5650 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5651 
agaš
:

5652 
node
 = 
roÙ
->
šode_Œ“
.
rb_node
;

5653 
´ev
 = 
NULL
;

5654 
node
) {

5655 
´ev
 = 
node
;

5656 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

5658 ià(
objeùid
 < 
	`bŒfs_šo
(
	`BTRFS_I
(&
’Œy
->
vfs_šode
)))

5659 
node
 =‚ode->
rb_Ëá
;

5660 ià(
objeùid
 > 
	`bŒfs_šo
(
	`BTRFS_I
(&
’Œy
->
vfs_šode
)))

5661 
node
 =‚ode->
rb_right
;

5665 ià(!
node
) {

5666 
´ev
) {

5667 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_šode
, 
rb_node
);

5668 ià(
objeùid
 <ð
	`bŒfs_šo
(
	`BTRFS_I
(&
’Œy
->
vfs_šode
))) {

5669 
node
 = 
´ev
;

5672 
´ev
 = 
	`rb_Ãxt
(prev);

5675 
node
) {

5676 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

5677 
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(&
’Œy
->
vfs_šode
)) + 1;

5678 
šode
 = 
	`ig¿b
(&
’Œy
->
vfs_šode
);

5679 ià(
šode
) {

5680 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5681 ià(
	`©omic_»ad
(&
šode
->
i_couÁ
) > 1)

5682 
	`d_´uÃ_®Ÿ£s
(
šode
);

5688 
	`ut
(
šode
);

5689 
	`cÚd_»sched
();

5690 
	`¥š_lock
(&
roÙ
->
šode_lock
);

5691 
agaš
;

5694 ià(
	`cÚd_»sched_lock
(&
roÙ
->
šode_lock
))

5695 
agaš
;

5697 
node
 = 
	`rb_Ãxt
(node);

5699 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

5700 
	}
}

5702 
	$bŒfs_š™_locked_šode
(
šode
 *šode, *
p
)

5704 
bŒfs_ig‘_¬gs
 *
¬gs
 = 
p
;

5705 
šode
->
i_šo
 = 
¬gs
->
loÿtiÚ
->
objeùid
;

5706 
	`memýy
(&
	`BTRFS_I
(
šode
)->
loÿtiÚ
, 
¬gs
->location,

5707 (*
¬gs
->
loÿtiÚ
));

5708 
	`BTRFS_I
(
šode
)->
roÙ
 = 
¬gs
->root;

5710 
	}
}

5712 
	$bŒfs_fšd_aùÜ
(
šode
 *šode, *
Ýaque
)

5714 
bŒfs_ig‘_¬gs
 *
¬gs
 = 
Ýaque
;

5715  
¬gs
->
loÿtiÚ
->
objeùid
 =ð
	`BTRFS_I
(
šode
)->location.objectid &&

5716 
¬gs
->
roÙ
 =ð
	`BTRFS_I
(
šode
)->root;

5717 
	}
}

5719 
šode
 *
	$bŒfs_ig‘_locked
(
su³r_block
 *
s
,

5720 
bŒfs_key
 *
loÿtiÚ
,

5721 
bŒfs_roÙ
 *
roÙ
)

5723 
šode
 *inode;

5724 
bŒfs_ig‘_¬gs
 
¬gs
;

5725 
hashv®
 = 
	`bŒfs_šode_hash
(
loÿtiÚ
->
objeùid
, 
roÙ
);

5727 
¬gs
.
loÿtiÚ
 =†ocation;

5728 
¬gs
.
roÙ
 =„oot;

5730 
šode
 = 
	`ig‘5_locked
(
s
, 
hashv®
, 
bŒfs_fšd_aùÜ
,

5731 
bŒfs_š™_locked_šode
,

5732 (*)&
¬gs
);

5733  
šode
;

5734 
	}
}

5739 
šode
 *
	$bŒfs_ig‘
(
su³r_block
 *
s
, 
bŒfs_key
 *
loÿtiÚ
,

5740 
bŒfs_roÙ
 *
roÙ
, *
Ãw
)

5742 
šode
 *inode;

5744 
šode
 = 
	`bŒfs_ig‘_locked
(
s
, 
loÿtiÚ
, 
roÙ
);

5745 ià(!
šode
)

5746  
	`ERR_PTR
(-
ENOMEM
);

5748 ià(
šode
->
i_¡©e
 & 
I_NEW
) {

5749 
»t
;

5751 
»t
 = 
	`bŒfs_»ad_locked_šode
(
šode
);

5752 ià(!
	`is_bad_šode
(
šode
)) {

5753 
	`šode_Œ“_add
(
šode
);

5754 
	`uÆock_Ãw_šode
(
šode
);

5755 ià(
Ãw
)

5756 *
Ãw
 = 1;

5758 
	`uÆock_Ãw_šode
(
šode
);

5759 
	`ut
(
šode
);

5760 
	`ASSERT
(
»t
 < 0);

5761 
šode
 = 
	`ERR_PTR
(
»t
 < 0 ?„‘ : -
ESTALE
);

5765  
šode
;

5766 
	}
}

5768 
šode
 *
	$Ãw_sim¶e_dœ
(
su³r_block
 *
s
,

5769 
bŒfs_key
 *
key
,

5770 
bŒfs_roÙ
 *
roÙ
)

5772 
šode
 *šodð
	`Ãw_šode
(
s
);

5774 ià(!
šode
)

5775  
	`ERR_PTR
(-
ENOMEM
);

5777 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

5778 
	`memýy
(&
	`BTRFS_I
(
šode
)->
loÿtiÚ
, 
key
, (*key));

5779 
	`£t_b™
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

5781 
šode
->
i_šo
 = 
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
;

5782 
šode
->
i_Ý
 = &
bŒfs_dœ_ro_šode_Ý”©iÚs
;

5783 
šode
->
i_Ýæags
 &ð~
IOP_XATTR
;

5784 
šode
->
i_fÝ
 = &
sim¶e_dœ_Ý”©iÚs
;

5785 
šode
->
i_mode
 = 
S_IFDIR
 | 
S_IRUGO
 | 
S_IWUSR
 | 
S_IXUGO
;

5786 
šode
->
i_mtime
 = 
	`cu¼’t_time
(inode);

5787 
šode
->
i_©ime
 = inode->
i_mtime
;

5788 
šode
->
i_ùime
 = inode->
i_mtime
;

5789 
	`BTRFS_I
(
šode
)->
i_Ùime
 = inode->
i_mtime
;

5791  
šode
;

5792 
	}
}

5794 
šode
 *
	$bŒfs_lookup_d’Œy
(
šode
 *
dœ
, 
d’Œy
 *dentry)

5796 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

5797 
šode
 *inode;

5798 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

5799 
bŒfs_roÙ
 *
sub_roÙ
 = 
roÙ
;

5800 
bŒfs_key
 
loÿtiÚ
;

5801 
šdex
;

5802 
»t
 = 0;

5804 ià(
d’Œy
->
d_Çme
.
Ën
 > 
BTRFS_NAME_LEN
)

5805  
	`ERR_PTR
(-
ENAMETOOLONG
);

5807 
»t
 = 
	`bŒfs_šode_by_Çme
(
dœ
, 
d’Œy
, &
loÿtiÚ
);

5808 ià(
»t
 < 0)

5809  
	`ERR_PTR
(
»t
);

5811 ià(
loÿtiÚ
.
objeùid
 == 0)

5812  
	`ERR_PTR
(-
ENOENT
);

5814 ià(
loÿtiÚ
.
ty³
 =ð
BTRFS_INODE_ITEM_KEY
) {

5815 
šode
 = 
	`bŒfs_ig‘
(
dœ
->
i_sb
, &
loÿtiÚ
, 
roÙ
, 
NULL
);

5816  
šode
;

5819 
	`BUG_ON
(
loÿtiÚ
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
);

5821 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

5822 
»t
 = 
	`fixup_Œ“_roÙ_loÿtiÚ
(
fs_šfo
, 
dœ
, 
d’Œy
,

5823 &
loÿtiÚ
, &
sub_roÙ
);

5824 ià(
»t
 < 0) {

5825 ià(
»t
 !ð-
ENOENT
)

5826 
šode
 = 
	`ERR_PTR
(
»t
);

5828 
šode
 = 
	`Ãw_sim¶e_dœ
(
dœ
->
i_sb
, &
loÿtiÚ
, 
sub_roÙ
);

5830 
šode
 = 
	`bŒfs_ig‘
(
dœ
->
i_sb
, &
loÿtiÚ
, 
sub_roÙ
, 
NULL
);

5832 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

5834 ià(!
	`IS_ERR
(
šode
è&& 
roÙ
 !ð
sub_roÙ
) {

5835 
	`down_»ad
(&
fs_šfo
->
þ—nup_wÜk_£m
);

5836 ià(!
	`sb_rdÚly
(
šode
->
i_sb
))

5837 
»t
 = 
	`bŒfs_Üphª_þ—nup
(
sub_roÙ
);

5838 
	`up_»ad
(&
fs_šfo
->
þ—nup_wÜk_£m
);

5839 ià(
»t
) {

5840 
	`ut
(
šode
);

5841 
šode
 = 
	`ERR_PTR
(
»t
);

5845  
šode
;

5846 
	}
}

5848 
	$bŒfs_d’Œy_d–‘e
(cÚ¡ 
d’Œy
 *dentry)

5850 
bŒfs_roÙ
 *
roÙ
;

5851 
šode
 *šodð
	`d_šode
(
d’Œy
);

5853 ià(!
šode
 && !
	`IS_ROOT
(
d’Œy
))

5854 
šode
 = 
	`d_šode
(
d’Œy
->
d_·»Á
);

5856 ià(
šode
) {

5857 
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5858 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

5861 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è=ð
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)

5865 
	}
}

5867 
	$bŒfs_d’Œy_»Ëa£
(
d’Œy
 *dentry)

5869 
	`kä“
(
d’Œy
->
d_fsd©a
);

5870 
	}
}

5872 
d’Œy
 *
	$bŒfs_lookup
(
šode
 *
dœ
, 
d’Œy
 *dentry,

5873 
æags
)

5875 
šode
 *inode;

5877 
šode
 = 
	`bŒfs_lookup_d’Œy
(
dœ
, 
d’Œy
);

5878 ià(
	`IS_ERR
(
šode
)) {

5879 ià(
	`PTR_ERR
(
šode
è=ð-
ENOENT
)

5880 
šode
 = 
NULL
;

5882  
	`ERR_CAST
(
šode
);

5885  
	`d_¥liû_®Ÿs
(
šode
, 
d’Œy
);

5886 
	}
}

5888 
	gbŒfs_fž‘y³_bË
[] = {

5889 
DT_UNKNOWN
, 
DT_REG
, 
DT_DIR
, 
DT_CHR
, 
DT_BLK
, 
DT_FIFO
, 
DT_SOCK
, 
DT_LNK


5901 
	$bŒfs_Ý’dœ
(
šode
 *šode, 
fže
 *file)

5903 
bŒfs_fže_´iv©e
 *
´iv©e
;

5905 
´iv©e
 = 
	`kz®loc
((
bŒfs_fže_´iv©e
), 
GFP_KERNEL
);

5906 ià(!
´iv©e
)

5907  -
ENOMEM
;

5908 
´iv©e
->
fžldœ_buf
 = 
	`kz®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

5909 ià(!
´iv©e
->
fžldœ_buf
) {

5910 
	`kä“
(
´iv©e
);

5911  -
ENOMEM
;

5913 
fže
->
´iv©e_d©a
 = 
´iv©e
;

5915 
	}
}

5917 
	sdœ_’Œy
 {

5918 
u64
 
	mšo
;

5919 
u64
 
	moff£t
;

5920 
	mty³
;

5921 
	mÇme_Ën
;

5924 
	$bŒfs_fžldœ
(*
addr
, 
’Œ›s
, 
dœ_cÚ‹xt
 *
ùx
)

5926 
’Œ›s
--) {

5927 
dœ_’Œy
 *
’Œy
 = 
addr
;

5928 *
Çme
 = (*)(
’Œy
 + 1);

5930 
ùx
->
pos
 = 
’Œy
->
off£t
;

5931 ià(!
	`dœ_em™
(
ùx
, 
Çme
, 
’Œy
->
Çme_Ën
,ƒÁry->
šo
,

5932 
’Œy
->
ty³
))

5934 
addr
 +ð(
dœ_’Œy
è+ 
’Œy
->
Çme_Ën
;

5935 
ùx
->
pos
++;

5938 
	}
}

5940 
	$bŒfs_»®_»addœ
(
fže
 *fže, 
dœ_cÚ‹xt
 *
ùx
)

5942 
šode
 *šodð
	`fže_šode
(
fže
);

5943 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5944 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5945 
bŒfs_fže_´iv©e
 *
´iv©e
 = 
fže
->
´iv©e_d©a
;

5946 
bŒfs_dœ_™em
 *
di
;

5947 
bŒfs_key
 
key
;

5948 
bŒfs_key
 
found_key
;

5949 
bŒfs_·th
 *
·th
;

5950 *
addr
;

5951 
li¡_h—d
 
šs_li¡
;

5952 
li¡_h—d
 
d–_li¡
;

5953 
»t
;

5954 
ex‹Á_bufãr
 *
Ëaf
;

5955 
¦Ù
;

5956 *
Çme_±r
;

5957 
Çme_Ën
;

5958 
’Œ›s
 = 0;

5959 
tÙ®_Ën
 = 0;

5960 
boÞ
 
put
 = 
çl£
;

5961 
bŒfs_key
 
loÿtiÚ
;

5963 ià(!
	`dœ_em™_dÙs
(
fže
, 
ùx
))

5966 
·th
 = 
	`bŒfs_®loc_·th
();

5967 ià(!
·th
)

5968  -
ENOMEM
;

5970 
addr
 = 
´iv©e
->
fžldœ_buf
;

5971 
·th
->
»ada
 = 
READA_FORWARD
;

5973 
	`INIT_LIST_HEAD
(&
šs_li¡
);

5974 
	`INIT_LIST_HEAD
(&
d–_li¡
);

5975 
put
 = 
	`bŒfs_»addœ_g‘_d–ayed_™ems
(
šode
, &
šs_li¡
, &
d–_li¡
);

5977 
agaš
:

5978 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

5979 
key
.
off£t
 = 
ùx
->
pos
;

5980 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

5982 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5983 ià(
»t
 < 0)

5984 
”r
;

5987 
dœ_’Œy
 *
’Œy
;

5989 
Ëaf
 = 
·th
->
nodes
[0];

5990 
¦Ù
 = 
·th
->
¦Ùs
[0];

5991 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

5992 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

5993 ià(
»t
 < 0)

5994 
”r
;

5995 ià(
»t
 > 0)

6000 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

6002 ià(
found_key
.
objeùid
 !ð
key
.objectid)

6004 ià(
found_key
.
ty³
 !ð
BTRFS_DIR_INDEX_KEY
)

6006 ià(
found_key
.
off£t
 < 
ùx
->
pos
)

6007 
Ãxt
;

6008 ià(
	`bŒfs_should_d–‘e_dœ_šdex
(&
d–_li¡
, 
found_key
.
off£t
))

6009 
Ãxt
;

6010 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dœ_™em
);

6011 ià(
	`v”ify_dœ_™em
(
fs_šfo
, 
Ëaf
, 
¦Ù
, 
di
))

6012 
Ãxt
;

6014 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

6015 ià((
tÙ®_Ën
 + (
dœ_’Œy
è+ 
Çme_Ën
) >=

6016 
PAGE_SIZE
) {

6017 
	`bŒfs_»Ëa£_·th
(
·th
);

6018 
»t
 = 
	`bŒfs_fžldœ
(
´iv©e
->
fžldœ_buf
, 
’Œ›s
, 
ùx
);

6019 ià(
»t
)

6020 
nÝos
;

6021 
addr
 = 
´iv©e
->
fžldœ_buf
;

6022 
’Œ›s
 = 0;

6023 
tÙ®_Ën
 = 0;

6024 
agaš
;

6027 
’Œy
 = 
addr
;

6028 
’Œy
->
Çme_Ën
 =‚ame_len;

6029 
Çme_±r
 = (*)(
’Œy
 + 1);

6030 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme_±r
, ()(
di
 + 1),

6031 
Çme_Ën
);

6032 
’Œy
->
ty³
 = 
bŒfs_fž‘y³_bË
[
	`bŒfs_dœ_ty³
(
Ëaf
, 
di
)];

6033 
	`bŒfs_dœ_™em_key_to_ýu
(
Ëaf
, 
di
, &
loÿtiÚ
);

6034 
’Œy
->
šo
 = 
loÿtiÚ
.
objeùid
;

6035 
’Œy
->
off£t
 = 
found_key
.offset;

6036 
’Œ›s
++;

6037 
addr
 +ð(
dœ_’Œy
è+ 
Çme_Ën
;

6038 
tÙ®_Ën
 +ð(
dœ_’Œy
è+ 
Çme_Ën
;

6039 
Ãxt
:

6040 
·th
->
¦Ùs
[0]++;

6042 
	`bŒfs_»Ëa£_·th
(
·th
);

6044 
»t
 = 
	`bŒfs_fžldœ
(
´iv©e
->
fžldœ_buf
, 
’Œ›s
, 
ùx
);

6045 ià(
»t
)

6046 
nÝos
;

6048 
»t
 = 
	`bŒfs_»addœ_d–ayed_dœ_šdex
(
ùx
, &
šs_li¡
);

6049 ià(
»t
)

6050 
nÝos
;

6069 ià(
ùx
->
pos
 >ð
INT_MAX
)

6070 
ùx
->
pos
 = 
LLONG_MAX
;

6072 
ùx
->
pos
 = 
INT_MAX
;

6073 
nÝos
:

6074 
»t
 = 0;

6075 
”r
:

6076 ià(
put
)

6077 
	`bŒfs_»addœ_put_d–ayed_™ems
(
šode
, &
šs_li¡
, &
d–_li¡
);

6078 
	`bŒfs_ä“_·th
(
·th
);

6079  
»t
;

6080 
	}
}

6082 
	$bŒfs_wr™e_šode
(
šode
 *šode, 
wr™eback_cÚŒÞ
 *
wbc
)

6084 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6085 
bŒfs_Œªs_hªdË
 *
Œªs
;

6086 
»t
 = 0;

6087 
boÞ
 
nÞock
 = 
çl£
;

6089 ià(
	`‹¡_b™
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

6092 ià(
	`bŒfs_fs_þosšg
(
roÙ
->
fs_šfo
) &&

6093 
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
)))

6094 
nÞock
 = 
Œue
;

6096 ià(
wbc
->
sync_mode
 =ð
WB_SYNC_ALL
) {

6097 ià(
nÞock
)

6098 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ_nÞock
(
roÙ
);

6100 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

6101 ià(
	`IS_ERR
(
Œªs
))

6102  
	`PTR_ERR
(
Œªs
);

6103 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

6105  
»t
;

6106 
	}
}

6114 
	$bŒfs_dœty_šode
(
šode
 *inode)

6116 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

6117 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6118 
bŒfs_Œªs_hªdË
 *
Œªs
;

6119 
»t
;

6121 ià(
	`‹¡_b™
(
BTRFS_INODE_DUMMY
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

6124 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

6125 ià(
	`IS_ERR
(
Œªs
))

6126  
	`PTR_ERR
(
Œªs
);

6128 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6129 ià(
»t
 &&„‘ =ð-
ENOSPC
) {

6131 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6132 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

6133 ià(
	`IS_ERR
(
Œªs
))

6134  
	`PTR_ERR
(
Œªs
);

6136 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6138 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6139 ià(
	`BTRFS_I
(
šode
)->
d–ayed_node
)

6140 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

6142  
»t
;

6143 
	}
}

6149 
	$bŒfs_upd©e_time
(
šode
 *šode, 
time¥ec
 *
now
,

6150 
æags
)

6152 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6154 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

6155  -
EROFS
;

6157 ià(
æags
 & 
S_VERSION
)

6158 
	`šode_šc_iv”siÚ
(
šode
);

6159 ià(
æags
 & 
S_CTIME
)

6160 
šode
->
i_ùime
 = *
now
;

6161 ià(
æags
 & 
S_MTIME
)

6162 
šode
->
i_mtime
 = *
now
;

6163 ià(
æags
 & 
S_ATIME
)

6164 
šode
->
i_©ime
 = *
now
;

6165  
	`bŒfs_dœty_šode
(
šode
);

6166 
	}
}

6173 
	$bŒfs_£t_šode_šdex_couÁ
(
bŒfs_šode
 *
šode
)

6175 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6176 
bŒfs_key
 
key
, 
found_key
;

6177 
bŒfs_·th
 *
·th
;

6178 
ex‹Á_bufãr
 *
Ëaf
;

6179 
»t
;

6181 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

6182 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

6183 
key
.
off£t
 = (
u64
)-1;

6185 
·th
 = 
	`bŒfs_®loc_·th
();

6186 ià(!
·th
)

6187  -
ENOMEM
;

6189 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

6190 ià(
»t
 < 0)

6191 
out
;

6193 ià(
»t
 == 0)

6194 
out
;

6195 
»t
 = 0;

6203 ià(
·th
->
¦Ùs
[0] == 0) {

6204 
šode
->
šdex_út
 = 2;

6205 
out
;

6208 
·th
->
¦Ùs
[0]--;

6210 
Ëaf
 = 
·th
->
nodes
[0];

6211 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

6213 ià(
found_key
.
objeùid
 !ð
	`bŒfs_šo
(
šode
) ||

6214 
found_key
.
ty³
 !ð
BTRFS_DIR_INDEX_KEY
) {

6215 
šode
->
šdex_út
 = 2;

6216 
out
;

6219 
šode
->
šdex_út
 = 
found_key
.
off£t
 + 1;

6220 
out
:

6221 
	`bŒfs_ä“_·th
(
·th
);

6222  
»t
;

6223 
	}
}

6229 
	$bŒfs_£t_šode_šdex
(
bŒfs_šode
 *
dœ
, 
u64
 *
šdex
)

6231 
»t
 = 0;

6233 ià(
dœ
->
šdex_út
 =ð(
u64
)-1) {

6234 
»t
 = 
	`bŒfs_šode_d–ayed_dœ_šdex_couÁ
(
dœ
);

6235 ià(
»t
) {

6236 
»t
 = 
	`bŒfs_£t_šode_šdex_couÁ
(
dœ
);

6237 ià(
»t
)

6238  
»t
;

6242 *
šdex
 = 
dœ
->
šdex_út
;

6243 
dœ
->
šdex_út
++;

6245  
»t
;

6246 
	}
}

6248 
	$bŒfs_š£¹_šode_locked
(
šode
 *inode)

6250 
bŒfs_ig‘_¬gs
 
¬gs
;

6251 
¬gs
.
loÿtiÚ
 = &
	`BTRFS_I
(
šode
)->location;

6252 
¬gs
.
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

6254  
	`š£¹_šode_locked4
(
šode
,

6255 
	`bŒfs_šode_hash
(
šode
->
i_šo
, 
	`BTRFS_I
(šode)->
roÙ
),

6256 
bŒfs_fšd_aùÜ
, &
¬gs
);

6257 
	}
}

6264 
	$bŒfs_šh”™_iæags
(
šode
 *šode, šod*
dœ
)

6266 
æags
;

6268 ià(!
dœ
)

6271 
æags
 = 
	`BTRFS_I
(
dœ
)->flags;

6273 ià(
æags
 & 
BTRFS_INODE_NOCOMPRESS
) {

6274 
	`BTRFS_I
(
šode
)->
æags
 &ð~
BTRFS_INODE_COMPRESS
;

6275 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NOCOMPRESS
;

6276 } ià(
æags
 & 
BTRFS_INODE_COMPRESS
) {

6277 
	`BTRFS_I
(
šode
)->
æags
 &ð~
BTRFS_INODE_NOCOMPRESS
;

6278 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_COMPRESS
;

6281 ià(
æags
 & 
BTRFS_INODE_NODATACOW
) {

6282 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NODATACOW
;

6283 ià(
	`S_ISREG
(
šode
->
i_mode
))

6284 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NODATASUM
;

6287 
	`bŒfs_upd©e_iæags
(
šode
);

6288 
	}
}

6290 
šode
 *
	$bŒfs_Ãw_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6291 
bŒfs_roÙ
 *
roÙ
,

6292 
šode
 *
dœ
,

6293 cÚ¡ *
Çme
, 
Çme_Ën
,

6294 
u64
 
»f_objeùid
, u64 
objeùid
,

6295 
umode_t
 
mode
, 
u64
 *
šdex
)

6297 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

6298 
šode
 *inode;

6299 
bŒfs_šode_™em
 *
šode_™em
;

6300 
bŒfs_key
 *
loÿtiÚ
;

6301 
bŒfs_·th
 *
·th
;

6302 
bŒfs_šode_»f
 *
»f
;

6303 
bŒfs_key
 
key
[2];

6304 
u32
 
sizes
[2];

6305 
n™ems
 = 
Çme
 ? 2 : 1;

6306 
±r
;

6307 
»t
;

6309 
·th
 = 
	`bŒfs_®loc_·th
();

6310 ià(!
·th
)

6311  
	`ERR_PTR
(-
ENOMEM
);

6313 
šode
 = 
	`Ãw_šode
(
fs_šfo
->
sb
);

6314 ià(!
šode
) {

6315 
	`bŒfs_ä“_·th
(
·th
);

6316  
	`ERR_PTR
(-
ENOMEM
);

6323 ià(!
Çme
)

6324 
	`£t_Æšk
(
šode
, 0);

6330 
šode
->
i_šo
 = 
objeùid
;

6332 ià(
dœ
 && 
Çme
) {

6333 
	`Œaû_bŒfs_šode_»que¡
(
dœ
);

6335 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
dœ
), 
šdex
);

6336 ià(
»t
) {

6337 
	`bŒfs_ä“_·th
(
·th
);

6338 
	`ut
(
šode
);

6339  
	`ERR_PTR
(
»t
);

6341 } ià(
dœ
) {

6342 *
šdex
 = 0;

6349 
	`BTRFS_I
(
šode
)->
šdex_út
 = 2;

6350 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = *
šdex
;

6351 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

6352 
	`BTRFS_I
(
šode
)->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

6353 
šode
->
i_g’”©iÚ
 = 
	`BTRFS_I
(šode)->
g’”©iÚ
;

6361 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

6363 
key
[0].
objeùid
 = objectid;

6364 
key
[0].
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6365 
key
[0].
off£t
 = 0;

6367 
sizes
[0] = (
bŒfs_šode_™em
);

6369 ià(
Çme
) {

6376 
key
[1].
objeùid
 = objectid;

6377 
key
[1].
ty³
 = 
BTRFS_INODE_REF_KEY
;

6378 
key
[1].
off£t
 = 
»f_objeùid
;

6380 
sizes
[1] = 
Çme_Ën
 + (*
»f
);

6383 
loÿtiÚ
 = &
	`BTRFS_I
(
šode
)->location;

6384 
loÿtiÚ
->
objeùid
 = objectid;

6385 
loÿtiÚ
->
off£t
 = 0;

6386 
loÿtiÚ
->
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6388 
»t
 = 
	`bŒfs_š£¹_šode_locked
(
šode
);

6389 ià(
»t
 < 0)

6390 
çž
;

6392 
·th
->
Ëave_¥šnšg
 = 1;

6393 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
roÙ
, 
·th
, 
key
, 
sizes
, 
n™ems
);

6394 ià(
»t
 != 0)

6395 
çž_uÆock
;

6397 
	`šode_š™_owÃr
(
šode
, 
dœ
, 
mode
);

6398 
	`šode_£t_by‹s
(
šode
, 0);

6400 
šode
->
i_mtime
 = 
	`cu¼’t_time
(inode);

6401 
šode
->
i_©ime
 = inode->
i_mtime
;

6402 
šode
->
i_ùime
 = inode->
i_mtime
;

6403 
	`BTRFS_I
(
šode
)->
i_Ùime
 = inode->
i_mtime
;

6405 
šode_™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

6406 
bŒfs_šode_™em
);

6407 
	`memz”o_ex‹Á_bufãr
(
·th
->
nodes
[0], ()
šode_™em
,

6408 (*
šode_™em
));

6409 
	`fžl_šode_™em
(
Œªs
, 
·th
->
nodes
[0], 
šode_™em
, 
šode
);

6411 ià(
Çme
) {

6412 
»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0] + 1,

6413 
bŒfs_šode_»f
);

6414 
	`bŒfs_£t_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
, 
Çme_Ën
);

6415 
	`bŒfs_£t_šode_»f_šdex
(
·th
->
nodes
[0], 
»f
, *
šdex
);

6416 
±r
 = ()(
»f
 + 1);

6417 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
, 
±r
, 
Çme_Ën
);

6420 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

6421 
	`bŒfs_ä“_·th
(
·th
);

6423 
	`bŒfs_šh”™_iæags
(
šode
, 
dœ
);

6425 ià(
	`S_ISREG
(
mode
)) {

6426 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
NODATASUM
))

6427 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NODATASUM
;

6428 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
NODATACOW
))

6429 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NODATACOW
 |

6430 
BTRFS_INODE_NODATASUM
;

6433 
	`šode_Œ“_add
(
šode
);

6435 
	`Œaû_bŒfs_šode_Ãw
(
šode
);

6436 
	`bŒfs_£t_šode_Ï¡_Œªs
(
Œªs
, 
šode
);

6438 
	`bŒfs_upd©e_roÙ_times
(
Œªs
, 
roÙ
);

6440 
»t
 = 
	`bŒfs_šode_šh”™_´Ýs
(
Œªs
, 
šode
, 
dœ
);

6441 ià(
»t
)

6442 
	`bŒfs_”r
(
fs_šfo
,

6444 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
roÙ
->
roÙ_key
.
objeùid
, 
»t
);

6446  
šode
;

6448 
çž_uÆock
:

6449 
	`uÆock_Ãw_šode
(
šode
);

6450 
çž
:

6451 ià(
dœ
 && 
Çme
)

6452 
	`BTRFS_I
(
dœ
)->
šdex_út
--;

6453 
	`bŒfs_ä“_·th
(
·th
);

6454 
	`ut
(
šode
);

6455  
	`ERR_PTR
(
»t
);

6456 
	}
}

6458 
šlše
 
u8
 
	$bŒfs_šode_ty³
(
šode
 *inode)

6460  
bŒfs_ty³_by_mode
[(
šode
->
i_mode
 & 
S_IFMT
è>> 
S_SHIFT
];

6461 
	}
}

6469 
	$bŒfs_add_lšk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6470 
bŒfs_šode
 *
·»Á_šode
, bŒfs_šod*
šode
,

6471 cÚ¡ *
Çme
, 
Çme_Ën
, 
add_back»f
, 
u64
 
šdex
)

6473 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

6474 
»t
 = 0;

6475 
bŒfs_key
 
key
;

6476 
bŒfs_roÙ
 *
roÙ
 = 
·»Á_šode
->root;

6477 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

6478 
u64
 
·»Á_šo
 = 
	`bŒfs_šo
(
·»Á_šode
);

6480 ià(
	`uÆik–y
(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)) {

6481 
	`memýy
(&
key
, &
šode
->
roÙ
->
roÙ_key
, (key));

6483 
key
.
objeùid
 = 
šo
;

6484 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6485 
key
.
off£t
 = 0;

6488 ià(
	`uÆik–y
(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)) {

6489 
»t
 = 
	`bŒfs_add_roÙ_»f
(
Œªs
, 
fs_šfo
, 
key
.
objeùid
,

6490 
roÙ
->
roÙ_key
.
objeùid
, 
·»Á_šo
,

6491 
šdex
, 
Çme
, 
Çme_Ën
);

6492 } ià(
add_back»f
) {

6493 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
, 
šo
,

6494 
·»Á_šo
, 
šdex
);

6498 ià(
»t
)

6499  
»t
;

6501 
»t
 = 
	`bŒfs_š£¹_dœ_™em
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
,

6502 
·»Á_šode
, &
key
,

6503 
	`bŒfs_šode_ty³
(&
šode
->
vfs_šode
), 
šdex
);

6504 ià(
»t
 =ð-
EEXIST
 ||„‘ =ð-
EOVERFLOW
)

6505 
çž_dœ_™em
;

6506 ià(
»t
) {

6507 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6508  
»t
;

6511 
	`bŒfs_i_size_wr™e
(
·»Á_šode
,…¬’t_šode->
vfs_šode
.
i_size
 +

6512 
Çme_Ën
 * 2);

6513 
	`šode_šc_iv”siÚ
(&
·»Á_šode
->
vfs_šode
);

6514 
·»Á_šode
->
vfs_šode
.
i_mtime
 =…¬’t_šode->vfs_šode.
i_ùime
 =

6515 
	`cu¼’t_time
(&
·»Á_šode
->
vfs_šode
);

6516 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, &
·»Á_šode
->
vfs_šode
);

6517 ià(
»t
)

6518 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

6519  
»t
;

6521 
çž_dœ_™em
:

6522 ià(
	`uÆik–y
(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)) {

6523 
u64
 
loÿl_šdex
;

6524 
”r
;

6525 
”r
 = 
	`bŒfs_d–_roÙ_»f
(
Œªs
, 
fs_šfo
, 
key
.
objeùid
,

6526 
roÙ
->
roÙ_key
.
objeùid
, 
·»Á_šo
,

6527 &
loÿl_šdex
, 
Çme
, 
Çme_Ën
);

6529 } ià(
add_back»f
) {

6530 
u64
 
loÿl_šdex
;

6531 
”r
;

6533 
”r
 = 
	`bŒfs_d–_šode_»f
(
Œªs
, 
roÙ
, 
Çme
, 
Çme_Ën
,

6534 
šo
, 
·»Á_šo
, &
loÿl_šdex
);

6536  
»t
;

6537 
	}
}

6539 
	$bŒfs_add_nÚdœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6540 
bŒfs_šode
 *
dœ
, 
d’Œy
 *dentry,

6541 
bŒfs_šode
 *
šode
, 
back»f
, 
u64
 
šdex
)

6543 
”r
 = 
	`bŒfs_add_lšk
(
Œªs
, 
dœ
, 
šode
,

6544 
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
,

6545 
back»f
, 
šdex
);

6546 ià(
”r
 > 0)

6547 
”r
 = -
EEXIST
;

6548  
”r
;

6549 
	}
}

6551 
	$bŒfs_mknod
(
šode
 *
dœ
, 
d’Œy
 *dentry,

6552 
umode_t
 
mode
, 
dev_t
 
rdev
)

6554 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

6555 
bŒfs_Œªs_hªdË
 *
Œªs
;

6556 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

6557 
šode
 *šodð
NULL
;

6558 
”r
;

6559 
drÝ_šode
 = 0;

6560 
u64
 
objeùid
;

6561 
u64
 
šdex
 = 0;

6568 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 5);

6569 ià(
	`IS_ERR
(
Œªs
))

6570  
	`PTR_ERR
(
Œªs
);

6572 
”r
 = 
	`bŒfs_fšd_ä“_šo
(
roÙ
, &
objeùid
);

6573 ià(
”r
)

6574 
out_uÆock
;

6576 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
roÙ
, 
dœ
, 
d’Œy
->
d_Çme
.
Çme
,

6577 
d’Œy
->
d_Çme
.
Ën
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)), 
objeùid
,

6578 
mode
, &
šdex
);

6579 ià(
	`IS_ERR
(
šode
)) {

6580 
”r
 = 
	`PTR_ERR
(
šode
);

6581 
out_uÆock
;

6590 
šode
->
i_Ý
 = &
bŒfs_¥ecŸl_šode_Ý”©iÚs
;

6591 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
, 
rdev
);

6593 
”r
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
šode
, 
dœ
, &
d’Œy
->
d_Çme
);

6594 ià(
”r
)

6595 
out_uÆock_šode
;

6597 
”r
 = 
	`bŒfs_add_nÚdœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
d’Œy
, BTRFS_I(
šode
),

6598 0, 
šdex
);

6599 ià(
”r
) {

6600 
out_uÆock_šode
;

6602 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6603 
	`uÆock_Ãw_šode
(
šode
);

6604 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

6607 
out_uÆock
:

6608 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6609 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

6610 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

6611 ià(
drÝ_šode
) {

6612 
	`šode_dec_lšk_couÁ
(
šode
);

6613 
	`ut
(
šode
);

6615  
”r
;

6617 
out_uÆock_šode
:

6618 
drÝ_šode
 = 1;

6619 
	`uÆock_Ãw_šode
(
šode
);

6620 
out_uÆock
;

6622 
	}
}

6624 
	$bŒfs_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *dentry,

6625 
umode_t
 
mode
, 
boÞ
 
exþ
)

6627 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

6628 
bŒfs_Œªs_hªdË
 *
Œªs
;

6629 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

6630 
šode
 *šodð
NULL
;

6631 
drÝ_šode_Ú_”r
 = 0;

6632 
”r
;

6633 
u64
 
objeùid
;

6634 
u64
 
šdex
 = 0;

6641 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 5);

6642 ià(
	`IS_ERR
(
Œªs
))

6643  
	`PTR_ERR
(
Œªs
);

6645 
”r
 = 
	`bŒfs_fšd_ä“_šo
(
roÙ
, &
objeùid
);

6646 ià(
”r
)

6647 
out_uÆock
;

6649 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
roÙ
, 
dœ
, 
d’Œy
->
d_Çme
.
Çme
,

6650 
d’Œy
->
d_Çme
.
Ën
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)), 
objeùid
,

6651 
mode
, &
šdex
);

6652 ià(
	`IS_ERR
(
šode
)) {

6653 
”r
 = 
	`PTR_ERR
(
šode
);

6654 
out_uÆock
;

6656 
drÝ_šode_Ú_”r
 = 1;

6663 
šode
->
i_fÝ
 = &
bŒfs_fže_Ý”©iÚs
;

6664 
šode
->
i_Ý
 = &
bŒfs_fže_šode_Ý”©iÚs
;

6665 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒfs_aÝs
;

6667 
”r
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
šode
, 
dœ
, &
d’Œy
->
d_Çme
);

6668 ià(
”r
)

6669 
out_uÆock_šode
;

6671 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6672 ià(
”r
)

6673 
out_uÆock_šode
;

6675 
”r
 = 
	`bŒfs_add_nÚdœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
d’Œy
, BTRFS_I(
šode
),

6676 0, 
šdex
);

6677 ià(
”r
)

6678 
out_uÆock_šode
;

6680 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Ýs
 = &
bŒfs_ex‹Á_io_Ýs
;

6681 
	`uÆock_Ãw_šode
(
šode
);

6682 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

6684 
out_uÆock
:

6685 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6686 ià(
”r
 && 
drÝ_šode_Ú_”r
) {

6687 
	`šode_dec_lšk_couÁ
(
šode
);

6688 
	`ut
(
šode
);

6690 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

6691 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

6692  
”r
;

6694 
out_uÆock_šode
:

6695 
	`uÆock_Ãw_šode
(
šode
);

6696 
out_uÆock
;

6698 
	}
}

6700 
	$bŒfs_lšk
(
d’Œy
 *
Þd_d’Œy
, 
šode
 *
dœ
,

6701 
d’Œy
 *dentry)

6703 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

6704 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

6705 
šode
 *šodð
	`d_šode
(
Þd_d’Œy
);

6706 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

6707 
u64
 
šdex
;

6708 
”r
;

6709 
drÝ_šode
 = 0;

6712 ià(
roÙ
->
objeùid
 !ð
	`BTRFS_I
(
šode
)->root->objectid)

6713  -
EXDEV
;

6715 ià(
šode
->
i_Æšk
 >ð
BTRFS_LINK_MAX
)

6716  -
EMLINK
;

6718 
”r
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
dœ
), &
šdex
);

6719 ià(
”r
)

6720 
çž
;

6727 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 5);

6728 ià(
	`IS_ERR
(
Œªs
)) {

6729 
”r
 = 
	`PTR_ERR
(
Œªs
);

6730 
Œªs
 = 
NULL
;

6731 
çž
;

6735 
	`BTRFS_I
(
šode
)->
dœ_šdex
 = 0ULL;

6736 
	`šc_Æšk
(
šode
);

6737 
	`šode_šc_iv”siÚ
(
šode
);

6738 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

6739 
	`ihÞd
(
šode
);

6740 
	`£t_b™
(
BTRFS_INODE_COPY_EVERYTHING
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

6742 
”r
 = 
	`bŒfs_add_nÚdœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
d’Œy
, BTRFS_I(
šode
),

6743 1, 
šdex
);

6745 ià(
”r
) {

6746 
drÝ_šode
 = 1;

6748 
d’Œy
 *
·»Á
 = d’Œy->
d_·»Á
;

6749 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6750 ià(
”r
)

6751 
çž
;

6752 ià(
šode
->
i_Æšk
 == 1) {

6757 
”r
 = 
	`bŒfs_Üphª_d–
(
Œªs
, 
	`BTRFS_I
(
šode
));

6758 ià(
”r
)

6759 
çž
;

6761 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

6762 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
	`BTRFS_I
(
šode
), 
NULL
, 
·»Á
);

6765 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

6766 
çž
:

6767 ià(
Œªs
)

6768 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6769 ià(
drÝ_šode
) {

6770 
	`šode_dec_lšk_couÁ
(
šode
);

6771 
	`ut
(
šode
);

6773 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

6774  
”r
;

6775 
	}
}

6777 
	$bŒfs_mkdœ
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

6779 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

6780 
šode
 *šodð
NULL
;

6781 
bŒfs_Œªs_hªdË
 *
Œªs
;

6782 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

6783 
”r
 = 0;

6784 
drÝ_Ú_”r
 = 0;

6785 
u64
 
objeùid
 = 0;

6786 
u64
 
šdex
 = 0;

6793 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 5);

6794 ià(
	`IS_ERR
(
Œªs
))

6795  
	`PTR_ERR
(
Œªs
);

6797 
”r
 = 
	`bŒfs_fšd_ä“_šo
(
roÙ
, &
objeùid
);

6798 ià(
”r
)

6799 
out_çž
;

6801 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
roÙ
, 
dœ
, 
d’Œy
->
d_Çme
.
Çme
,

6802 
d’Œy
->
d_Çme
.
Ën
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)), 
objeùid
,

6803 
S_IFDIR
 | 
mode
, &
šdex
);

6804 ià(
	`IS_ERR
(
šode
)) {

6805 
”r
 = 
	`PTR_ERR
(
šode
);

6806 
out_çž
;

6809 
drÝ_Ú_”r
 = 1;

6811 
šode
->
i_Ý
 = &
bŒfs_dœ_šode_Ý”©iÚs
;

6812 
šode
->
i_fÝ
 = &
bŒfs_dœ_fže_Ý”©iÚs
;

6814 
”r
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
šode
, 
dœ
, &
d’Œy
->
d_Çme
);

6815 ià(
”r
)

6816 
out_çž_šode
;

6818 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

6819 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

6820 ià(
”r
)

6821 
out_çž_šode
;

6823 
”r
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
),

6824 
d’Œy
->
d_Çme
.
Çme
,

6825 
d’Œy
->
d_Çme
.
Ën
, 0, 
šdex
);

6826 ià(
”r
)

6827 
out_çž_šode
;

6829 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

6834 
	`uÆock_Ãw_šode
(
šode
);

6835 
drÝ_Ú_”r
 = 0;

6837 
out_çž
:

6838 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6839 ià(
drÝ_Ú_”r
) {

6840 
	`šode_dec_lšk_couÁ
(
šode
);

6841 
	`ut
(
šode
);

6843 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

6844 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

6845  
”r
;

6847 
out_çž_šode
:

6848 
	`uÆock_Ãw_šode
(
šode
);

6849 
out_çž
;

6850 
	}
}

6853 
ex‹Á_m­
 *
	$Ãxt_ex‹Á_m­
(
ex‹Á_m­
 *
em
)

6855 
rb_node
 *
Ãxt
;

6857 
Ãxt
 = 
	`rb_Ãxt
(&
em
->
rb_node
);

6858 ià(!
Ãxt
)

6859  
NULL
;

6860  
	`cÚš”_of
(
Ãxt
, 
ex‹Á_m­
, 
rb_node
);

6861 
	}
}

6863 
ex‹Á_m­
 *
	$´ev_ex‹Á_m­
(
ex‹Á_m­
 *
em
)

6865 
rb_node
 *
´ev
;

6867 
´ev
 = 
	`rb_´ev
(&
em
->
rb_node
);

6868 ià(!
´ev
)

6869  
NULL
;

6870  
	`cÚš”_of
(
´ev
, 
ex‹Á_m­
, 
rb_node
);

6871 
	}
}

6878 
	$m”ge_ex‹Á_m­pšg
(
ex‹Á_m­_Œ“
 *
em_Œ“
,

6879 
ex‹Á_m­
 *
exi¡šg
,

6880 
ex‹Á_m­
 *
em
,

6881 
u64
 
m­_¡¬t
)

6883 
ex‹Á_m­
 *
´ev
;

6884 
ex‹Á_m­
 *
Ãxt
;

6885 
u64
 
¡¬t
;

6886 
u64
 
’d
;

6887 
u64
 
¡¬t_diff
;

6889 
	`BUG_ON
(
m­_¡¬t
 < 
em
->
¡¬t
 || m­_¡¬ˆ>ð
	`ex‹Á_m­_’d
(em));

6891 ià(
exi¡šg
->
¡¬t
 > 
m­_¡¬t
) {

6892 
Ãxt
 = 
exi¡šg
;

6893 
´ev
 = 
	`´ev_ex‹Á_m­
(
Ãxt
);

6895 
´ev
 = 
exi¡šg
;

6896 
Ãxt
 = 
	`Ãxt_ex‹Á_m­
(
´ev
);

6899 
¡¬t
 = 
´ev
 ? 
	`ex‹Á_m­_’d
Õ»vè: 
em
->start;

6900 
¡¬t
 = 
	`max_t
(
u64
, s¹, 
em
->start);

6901 
’d
 = 
Ãxt
 ?‚ext->
¡¬t
 : 
	`ex‹Á_m­_’d
(
em
);

6902 
’d
 = 
	`mš_t
(
u64
,ƒnd, 
	`ex‹Á_m­_’d
(
em
));

6903 
¡¬t_diff
 = 
¡¬t
 - 
em
->start;

6904 
em
->
¡¬t
 = start;

6905 
em
->
Ën
 = 
’d
 - 
¡¬t
;

6906 ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
 &&

6907 !
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
)) {

6908 
em
->
block_¡¬t
 +ð
¡¬t_diff
;

6909 
em
->
block_Ën
 -ð
¡¬t_diff
;

6911  
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

6912 
	}
}

6914 
nošlše
 
	$uncom´ess_šlše
(
bŒfs_·th
 *
·th
,

6915 
·ge
 *page,

6916 
size_t
 
pg_off£t
, 
u64
 
ex‹Á_off£t
,

6917 
bŒfs_fže_ex‹Á_™em
 *
™em
)

6919 
»t
;

6920 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

6921 *
tmp
;

6922 
size_t
 
max_size
;

6923 
šlše_size
;

6924 
±r
;

6925 
com´ess_ty³
;

6927 
	`WARN_ON
(
pg_off£t
 != 0);

6928 
com´ess_ty³
 = 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
);

6929 
max_size
 = 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
™em
);

6930 
šlše_size
 = 
	`bŒfs_fže_ex‹Á_šlše_™em_Ën
(
Ëaf
,

6931 
	`bŒfs_™em_Ä
(
·th
->
¦Ùs
[0]));

6932 
tmp
 = 
	`km®loc
(
šlše_size
, 
GFP_NOFS
);

6933 ià(!
tmp
)

6934  -
ENOMEM
;

6935 
±r
 = 
	`bŒfs_fže_ex‹Á_šlše_¡¬t
(
™em
);

6937 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
tmp
, 
±r
, 
šlše_size
);

6939 
max_size
 = 
	`mš_t
(, 
PAGE_SIZE
, max_size);

6940 
»t
 = 
	`bŒfs_decom´ess
(
com´ess_ty³
, 
tmp
, 
·ge
,

6941 
ex‹Á_off£t
, 
šlše_size
, 
max_size
);

6951 ià(
max_size
 + 
pg_off£t
 < 
PAGE_SIZE
) {

6952 *
m­
 = 
	`km­
(
·ge
);

6953 
	`mem£t
(
m­
 + 
pg_off£t
 + 
max_size
, 0, 
PAGE_SIZE
 - max_size -…g_offset);

6954 
	`kunm­
(
·ge
);

6956 
	`kä“
(
tmp
);

6957  
»t
;

6958 
	}
}

6968 
ex‹Á_m­
 *
	$bŒfs_g‘_ex‹Á
(
bŒfs_šode
 *
šode
,

6969 
·ge
 *page,

6970 
size_t
 
pg_off£t
, 
u64
 
¡¬t
, u64 
Ën
,

6971 
ü—‹
)

6973 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

6974 
»t
;

6975 
”r
 = 0;

6976 
u64
 
ex‹Á_¡¬t
 = 0;

6977 
u64
 
ex‹Á_’d
 = 0;

6978 
u64
 
objeùid
 = 
	`bŒfs_šo
(
šode
);

6979 
u32
 
found_ty³
;

6980 
bŒfs_·th
 *
·th
 = 
NULL
;

6981 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

6982 
bŒfs_fže_ex‹Á_™em
 *
™em
;

6983 
ex‹Á_bufãr
 *
Ëaf
;

6984 
bŒfs_key
 
found_key
;

6985 
ex‹Á_m­
 *
em
 = 
NULL
;

6986 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

6987 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
šode
->io_tree;

6988 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

6989 cÚ¡ 
boÞ
 
Ãw_šlše
 = !
·ge
 || 
ü—‹
;

6991 
agaš
:

6992 
	`»ad_lock
(&
em_Œ“
->
lock
);

6993 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

6994 ià(
em
)

6995 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

6996 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

6998 ià(
em
) {

6999 ià(
em
->
¡¬t
 > s¹ ||ƒm->¡¬ˆ+ƒm->
Ën
 <= start)

7000 
	`ä“_ex‹Á_m­
(
em
);

7001 ià(
em
->
block_¡¬t
 =ð
EXTENT_MAP_INLINE
 && 
·ge
)

7002 
	`ä“_ex‹Á_m­
(
em
);

7004 
out
;

7006 
em
 = 
	`®loc_ex‹Á_m­
();

7007 ià(!
em
) {

7008 
”r
 = -
ENOMEM
;

7009 
out
;

7011 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

7012 
em
->
¡¬t
 = 
EXTENT_MAP_HOLE
;

7013 
em
->
Üig_¡¬t
 = 
EXTENT_MAP_HOLE
;

7014 
em
->
Ën
 = (
u64
)-1;

7015 
em
->
block_Ën
 = (
u64
)-1;

7017 ià(!
·th
) {

7018 
·th
 = 
	`bŒfs_®loc_·th
();

7019 ià(!
·th
) {

7020 
”r
 = -
ENOMEM
;

7021 
out
;

7027 
·th
->
»ada
 = 
READA_FORWARD
;

7030 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
Œªs
, 
roÙ
, 
·th
,

7031 
objeùid
, 
¡¬t
, 
Œªs
 !ð
NULL
);

7032 ià(
»t
 < 0) {

7033 
”r
 = 
»t
;

7034 
out
;

7037 ià(
»t
 != 0) {

7038 ià(
·th
->
¦Ùs
[0] == 0)

7039 
nÙ_found
;

7040 
·th
->
¦Ùs
[0]--;

7043 
Ëaf
 = 
·th
->
nodes
[0];

7044 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

7045 
bŒfs_fže_ex‹Á_™em
);

7047 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

7048 
found_ty³
 = 
found_key
.
ty³
;

7049 ià(
found_key
.
objeùid
 != objectid ||

7050 
found_ty³
 !ð
BTRFS_EXTENT_DATA_KEY
) {

7057 
ex‹Á_’d
 = 
¡¬t
;

7058 
Ãxt
;

7061 
found_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
™em
);

7062 
ex‹Á_¡¬t
 = 
found_key
.
off£t
;

7063 ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

7064 
found_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

7065 
ex‹Á_’d
 = 
ex‹Á_¡¬t
 +

7066 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
™em
);

7068 
	`Œaû_bŒfs_g‘_ex‹Á_show_fi_»guÏr
(
šode
, 
Ëaf
, 
™em
,

7069 
ex‹Á_¡¬t
);

7070 } ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

7071 
size_t
 
size
;

7072 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
, 
·th
->
¦Ùs
[0], 
™em
);

7073 
ex‹Á_’d
 = 
	`ALIGN
(
ex‹Á_¡¬t
 + 
size
,

7074 
fs_šfo
->
£ùÜsize
);

7076 
	`Œaû_bŒfs_g‘_ex‹Á_show_fi_šlše
(
šode
, 
Ëaf
, 
™em
,

7077 
·th
->
¦Ùs
[0],

7078 
ex‹Á_¡¬t
);

7080 
Ãxt
:

7081 ià(
¡¬t
 >ð
ex‹Á_’d
) {

7082 
·th
->
¦Ùs
[0]++;

7083 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

7084 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

7085 ià(
»t
 < 0) {

7086 
”r
 = 
»t
;

7087 
out
;

7089 ià(
»t
 > 0)

7090 
nÙ_found
;

7091 
Ëaf
 = 
·th
->
nodes
[0];

7093 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

7094 ià(
found_key
.
objeùid
 != objectid ||

7095 
found_key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

7096 
nÙ_found
;

7097 ià(
¡¬t
 + 
Ën
 <ð
found_key
.
off£t
)

7098 
nÙ_found
;

7099 ià(
¡¬t
 > 
found_key
.
off£t
)

7100 
Ãxt
;

7101 
em
->
¡¬t
 = start;

7102 
em
->
Üig_¡¬t
 = 
¡¬t
;

7103 
em
->
Ën
 = 
found_key
.
off£t
 - 
¡¬t
;

7104 
nÙ_found_em
;

7107 
	`bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
šode
, 
·th
, 
™em
,

7108 
Ãw_šlše
, 
em
);

7110 ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

7111 
found_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

7112 
š£¹
;

7113 } ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

7114 
±r
;

7115 *
m­
;

7116 
size_t
 
size
;

7117 
size_t
 
ex‹Á_off£t
;

7118 
size_t
 
cÝy_size
;

7120 ià(
Ãw_šlše
)

7121 
out
;

7123 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
, 
·th
->
¦Ùs
[0], 
™em
);

7124 
ex‹Á_off£t
 = 
	`·ge_off£t
(
·ge
è+ 
pg_off£t
 - 
ex‹Á_¡¬t
;

7125 
cÝy_size
 = 
	`mš_t
(
u64
, 
PAGE_SIZE
 - 
pg_off£t
,

7126 
size
 - 
ex‹Á_off£t
);

7127 
em
->
¡¬t
 = 
ex‹Á_¡¬t
 + 
ex‹Á_off£t
;

7128 
em
->
Ën
 = 
	`ALIGN
(
cÝy_size
, 
fs_šfo
->
£ùÜsize
);

7129 
em
->
Üig_block_Ën
 =ƒm->
Ën
;

7130 
em
->
Üig_¡¬t
 =ƒm->
¡¬t
;

7131 
±r
 = 
	`bŒfs_fže_ex‹Á_šlše_¡¬t
(
™em
è+ 
ex‹Á_off£t
;

7132 ià(
ü—‹
 =ð0 && !
	`PageU±od©e
(
·ge
)) {

7133 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
™em
) !=

7134 
BTRFS_COMPRESS_NONE
) {

7135 
»t
 = 
	`uncom´ess_šlše
(
·th
, 
·ge
, 
pg_off£t
,

7136 
ex‹Á_off£t
, 
™em
);

7137 ià(
»t
) {

7138 
”r
 = 
»t
;

7139 
out
;

7142 
m­
 = 
	`km­
(
·ge
);

7143 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
m­
 + 
pg_off£t
, 
±r
,

7144 
cÝy_size
);

7145 ià(
pg_off£t
 + 
cÝy_size
 < 
PAGE_SIZE
) {

7146 
	`mem£t
(
m­
 + 
pg_off£t
 + 
cÝy_size
, 0,

7147 
PAGE_SIZE
 - 
pg_off£t
 -

7148 
cÝy_size
);

7150 
	`kunm­
(
·ge
);

7152 
	`æush_dÿche_·ge
(
·ge
);

7153 } ià(
ü—‹
 && 
	`PageU±od©e
(
·ge
)) {

7154 
	`BUG
();

7155 ià(!
Œªs
) {

7156 
	`kunm­
(
·ge
);

7157 
	`ä“_ex‹Á_m­
(
em
);

7158 
em
 = 
NULL
;

7160 
	`bŒfs_»Ëa£_·th
(
·th
);

7161 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

7163 ià(
	`IS_ERR
(
Œªs
))

7164  
	`ERR_CAST
(
Œªs
);

7165 
agaš
;

7167 
m­
 = 
	`km­
(
·ge
);

7168 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
m­
 + 
pg_off£t
, 
±r
,

7169 
cÝy_size
);

7170 
	`kunm­
(
·ge
);

7171 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

7173 
	`£t_ex‹Á_u±od©e
(
io_Œ“
, 
em
->
¡¬t
,

7174 
	`ex‹Á_m­_’d
(
em
è- 1, 
NULL
, 
GFP_NOFS
);

7175 
š£¹
;

7177 
nÙ_found
:

7178 
em
->
¡¬t
 = start;

7179 
em
->
Üig_¡¬t
 = 
¡¬t
;

7180 
em
->
Ën
 =†en;

7181 
nÙ_found_em
:

7182 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

7183 
	`£t_b™
(
EXTENT_FLAG_VACANCY
, &
em
->
æags
);

7184 
š£¹
:

7185 
	`bŒfs_»Ëa£_·th
(
·th
);

7186 ià(
em
->
¡¬t
 > s¹ || 
	`ex‹Á_m­_’d
(em) <= start) {

7187 
	`bŒfs_”r
(
fs_šfo
,

7189 
em
->
¡¬t
,ƒm->
Ën
, start,†en);

7190 
”r
 = -
EIO
;

7191 
out
;

7194 
”r
 = 0;

7195 
	`wr™e_lock
(&
em_Œ“
->
lock
);

7196 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

7201 ià(
»t
 =ð-
EEXIST
) {

7202 
ex‹Á_m­
 *
exi¡šg
;

7204 
»t
 = 0;

7206 
exi¡šg
 = 
	`£¬ch_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

7211 ià(
exi¡šg
->
¡¬t
 =ð
em
->start &&

7212 
	`ex‹Á_m­_’d
(
exi¡šg
è>ðex‹Á_m­_’d(
em
) &&

7213 
em
->
block_¡¬t
 =ð
exi¡šg
->block_start) {

7218 
	`ä“_ex‹Á_m­
(
em
);

7219 
em
 = 
exi¡šg
;

7220 
”r
 = 0;

7222 } ià(
¡¬t
 >ð
	`ex‹Á_m­_’d
(
exi¡šg
) ||

7223 
¡¬t
 <ð
exi¡šg
->start) {

7228 
”r
 = 
	`m”ge_ex‹Á_m­pšg
(
em_Œ“
, 
exi¡šg
,

7229 
em
, 
¡¬t
);

7230 
	`ä“_ex‹Á_m­
(
exi¡šg
);

7231 ià(
”r
) {

7232 
	`ä“_ex‹Á_m­
(
em
);

7233 
em
 = 
NULL
;

7236 
	`ä“_ex‹Á_m­
(
em
);

7237 
em
 = 
exi¡šg
;

7238 
”r
 = 0;

7241 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

7242 
out
:

7244 
	`Œaû_bŒfs_g‘_ex‹Á
(
roÙ
, 
šode
, 
em
);

7246 
	`bŒfs_ä“_·th
(
·th
);

7247 ià(
Œªs
) {

7248 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

7249 ià(!
”r
)

7250 
”r
 = 
»t
;

7252 ià(
”r
) {

7253 
	`ä“_ex‹Á_m­
(
em
);

7254  
	`ERR_PTR
(
”r
);

7256 
	`BUG_ON
(!
em
);

7257  
em
;

7258 
	}
}

7260 
ex‹Á_m­
 *
	$bŒfs_g‘_ex‹Á_f›m­
(
bŒfs_šode
 *
šode
,

7261 
·ge
 *page,

7262 
size_t
 
pg_off£t
, 
u64
 
¡¬t
, u64 
Ën
,

7263 
ü—‹
)

7265 
ex‹Á_m­
 *
em
;

7266 
ex‹Á_m­
 *
hÞe_em
 = 
NULL
;

7267 
u64
 
¿nge_¡¬t
 = 
¡¬t
;

7268 
u64
 
’d
;

7269 
u64
 
found
;

7270 
u64
 
found_’d
;

7271 
”r
 = 0;

7273 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
·ge
, 
pg_off£t
, 
¡¬t
, 
Ën
, 
ü—‹
);

7274 ià(
	`IS_ERR
(
em
))

7275  
em
;

7282 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
 &&

7283 !
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

7284  
em
;

7286 
hÞe_em
 = 
em
;

7289 
’d
 = 
¡¬t
 + 
Ën
;

7290 ià(
’d
 < 
¡¬t
)

7291 
’d
 = (
u64
)-1;

7293 
’d
 -= 1;

7295 
em
 = 
NULL
;

7298 
found
 = 
	`couÁ_¿nge_b™s
(&
šode
->
io_Œ“
, &
¿nge_¡¬t
,

7299 
’d
, 
Ën
, 
EXTENT_DELALLOC
, 1);

7300 
found_’d
 = 
¿nge_¡¬t
 + 
found
;

7301 ià(
found_’d
 < 
¿nge_¡¬t
)

7302 
found_’d
 = (
u64
)-1;

7308 ià(
¿nge_¡¬t
 > 
’d
 || 
found_’d
 <ð
¡¬t
) {

7309 
em
 = 
hÞe_em
;

7310 
hÞe_em
 = 
NULL
;

7311 
out
;

7317 
¿nge_¡¬t
 = 
	`max
(
¡¬t
,„ange_start);

7318 
found
 = 
found_’d
 - 
¿nge_¡¬t
;

7320 ià(
found
 > 0) {

7321 
u64
 
hÞe_¡¬t
 = 
¡¬t
;

7322 
u64
 
hÞe_Ën
 = 
Ën
;

7324 
em
 = 
	`®loc_ex‹Á_m­
();

7325 ià(!
em
) {

7326 
”r
 = -
ENOMEM
;

7327 
out
;

7337 ià(
hÞe_em
) {

7338 
u64
 
ÿlc_’d
 = 
	`ex‹Á_m­_’d
(
hÞe_em
);

7340 ià(
ÿlc_’d
 <ð
¡¬t
 || (
hÞe_em
->¡¬ˆ> 
’d
)) {

7341 
	`ä“_ex‹Á_m­
(
hÞe_em
);

7342 
hÞe_em
 = 
NULL
;

7344 
hÞe_¡¬t
 = 
	`max
(
hÞe_em
->
¡¬t
, start);

7345 
hÞe_Ën
 = 
ÿlc_’d
 - 
hÞe_¡¬t
;

7348 
em
->
bdev
 = 
NULL
;

7349 ià(
hÞe_em
 && 
¿nge_¡¬t
 > 
hÞe_¡¬t
) {

7354 
em
->
Ën
 = 
	`mš
(
hÞe_Ën
,

7355 
¿nge_¡¬t
 - 
hÞe_¡¬t
);

7356 
em
->
¡¬t
 = 
hÞe_¡¬t
;

7357 
em
->
Üig_¡¬t
 = 
hÞe_¡¬t
;

7362 
em
->
block_¡¬t
 = 
hÞe_em
->block_start;

7363 
em
->
block_Ën
 = 
hÞe_Ën
;

7364 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
hÞe_em
->
æags
))

7365 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
);

7367 
em
->
¡¬t
 = 
¿nge_¡¬t
;

7368 
em
->
Ën
 = 
found
;

7369 
em
->
Üig_¡¬t
 = 
¿nge_¡¬t
;

7370 
em
->
block_¡¬t
 = 
EXTENT_MAP_DELALLOC
;

7371 
em
->
block_Ën
 = 
found
;

7373 } ià(
hÞe_em
) {

7374  
hÞe_em
;

7376 
out
:

7378 
	`ä“_ex‹Á_m­
(
hÞe_em
);

7379 ià(
”r
) {

7380 
	`ä“_ex‹Á_m­
(
em
);

7381  
	`ERR_PTR
(
”r
);

7383  
em
;

7384 
	}
}

7386 
ex‹Á_m­
 *
	$bŒfs_ü—‹_dio_ex‹Á
(
šode
 *inode,

7387 cÚ¡ 
u64
 
¡¬t
,

7388 cÚ¡ 
u64
 
Ën
,

7389 cÚ¡ 
u64
 
Üig_¡¬t
,

7390 cÚ¡ 
u64
 
block_¡¬t
,

7391 cÚ¡ 
u64
 
block_Ën
,

7392 cÚ¡ 
u64
 
Üig_block_Ën
,

7393 cÚ¡ 
u64
 
¿m_by‹s
,

7394 cÚ¡ 
ty³
)

7396 
ex‹Á_m­
 *
em
 = 
NULL
;

7397 
»t
;

7399 ià(
ty³
 !ð
BTRFS_ORDERED_NOCOW
) {

7400 
em
 = 
	`ü—‹_io_em
(
šode
, 
¡¬t
, 
Ën
, 
Üig_¡¬t
,

7401 
block_¡¬t
, 
block_Ën
, 
Üig_block_Ën
,

7402 
¿m_by‹s
,

7403 
BTRFS_COMPRESS_NONE
,

7404 
ty³
);

7405 ià(
	`IS_ERR
(
em
))

7406 
out
;

7408 
»t
 = 
	`bŒfs_add_Üd”ed_ex‹Á_dio
(
šode
, 
¡¬t
, 
block_¡¬t
,

7409 
Ën
, 
block_Ën
, 
ty³
);

7410 ià(
»t
) {

7411 ià(
em
) {

7412 
	`ä“_ex‹Á_m­
(
em
);

7413 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
,

7414 
¡¬t
 + 
Ën
 - 1, 0);

7416 
em
 = 
	`ERR_PTR
(
»t
);

7418 
out
:

7420  
em
;

7421 
	}
}

7423 
ex‹Á_m­
 *
	$bŒfs_Ãw_ex‹Á_dœeù
(
šode
 *inode,

7424 
u64
 
¡¬t
, u64 
Ën
)

7426 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

7427 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

7428 
ex‹Á_m­
 *
em
;

7429 
bŒfs_key
 
šs
;

7430 
u64
 
®loc_hšt
;

7431 
»t
;

7433 
®loc_hšt
 = 
	`g‘_ex‹Á_®loÿtiÚ_hšt
(
šode
, 
¡¬t
, 
Ën
);

7434 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
Ën
,†’, 
fs_šfo
->
£ùÜsize
,

7435 0, 
®loc_hšt
, &
šs
, 1, 1);

7436 ià(
»t
)

7437  
	`ERR_PTR
(
»t
);

7439 
em
 = 
	`bŒfs_ü—‹_dio_ex‹Á
(
šode
, 
¡¬t
, 
šs
.
off£t
, start,

7440 
šs
.
objeùid
, ins.
off£t
, ins.offset,

7441 
šs
.
off£t
, 
BTRFS_ORDERED_REGULAR
);

7442 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

7443 ià(
	`IS_ERR
(
em
))

7444 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
,

7445 
šs
.
off£t
, 1);

7447  
em
;

7448 
	}
}

7454 
nošlše
 
	$ÿn_nocow_ex‹Á
(
šode
 *šode, 
u64
 
off£t
, u64 *
Ën
,

7455 
u64
 *
Üig_¡¬t
, u64 *
Üig_block_Ën
,

7456 
u64
 *
¿m_by‹s
)

7458 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

7459 
bŒfs_·th
 *
·th
;

7460 
»t
;

7461 
ex‹Á_bufãr
 *
Ëaf
;

7462 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

7463 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

7464 
bŒfs_fže_ex‹Á_™em
 *
fi
;

7465 
bŒfs_key
 
key
;

7466 
u64
 
disk_by‹Ä
;

7467 
u64
 
back»f_off£t
;

7468 
u64
 
ex‹Á_’d
;

7469 
u64
 
num_by‹s
;

7470 
¦Ù
;

7471 
found_ty³
;

7472 
boÞ
 
nocow
 = (
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
);

7474 
·th
 = 
	`bŒfs_®loc_·th
();

7475 ià(!
·th
)

7476  -
ENOMEM
;

7478 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
NULL
, 
roÙ
, 
·th
,

7479 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
off£t
, 0);

7480 ià(
»t
 < 0)

7481 
out
;

7483 
¦Ù
 = 
·th
->
¦Ùs
[0];

7484 ià(
»t
 == 1) {

7485 ià(
¦Ù
 == 0) {

7487 
»t
 = 0;

7488 
out
;

7490 
¦Ù
--;

7492 
»t
 = 0;

7493 
Ëaf
 = 
·th
->
nodes
[0];

7494 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

7495 ià(
key
.
objeùid
 !ð
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)) ||

7496 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
) {

7498 
out
;

7501 ià(
key
.
off£t
 > offset) {

7503 
out
;

7506 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

7507 
found_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
);

7508 ià(
found_ty³
 !ð
BTRFS_FILE_EXTENT_REG
 &&

7509 
found_ty³
 !ð
BTRFS_FILE_EXTENT_PREALLOC
) {

7511 
out
;

7514 ià(!
nocow
 && 
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
)

7515 
out
;

7517 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

7518 ià(
ex‹Á_’d
 <ð
off£t
)

7519 
out
;

7521 
disk_by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

7522 ià(
disk_by‹Ä
 == 0)

7523 
out
;

7525 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

7526 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

7527 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
))

7528 
out
;

7530 
back»f_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

7532 ià(
Üig_¡¬t
) {

7533 *
Üig_¡¬t
 = 
key
.
off£t
 - 
back»f_off£t
;

7534 *
Üig_block_Ën
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

7535 *
¿m_by‹s
 = 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
);

7538 ià(
	`bŒfs_ex‹Á_»adÚly
(
fs_šfo
, 
disk_by‹Ä
))

7539 
out
;

7541 
num_by‹s
 = 
	`mš
(
off£t
 + *
Ën
, 
ex‹Á_’d
) - offset;

7542 ià(!
nocow
 && 
found_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

7543 
u64
 
¿nge_’d
;

7545 
¿nge_’d
 = 
	`round_up
(
off£t
 + 
num_by‹s
,

7546 
roÙ
->
fs_šfo
->
£ùÜsize
) - 1;

7547 
»t
 = 
	`‹¡_¿nge_b™
(
io_Œ“
, 
off£t
, 
¿nge_’d
,

7548 
EXTENT_DELALLOC
, 0, 
NULL
);

7549 ià(
»t
) {

7550 
»t
 = -
EAGAIN
;

7551 
out
;

7555 
	`bŒfs_»Ëa£_·th
(
·th
);

7562 
»t
 = 
	`bŒfs_üoss_»f_exi¡
(
roÙ
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

7563 
key
.
off£t
 - 
back»f_off£t
, 
disk_by‹Ä
);

7564 ià(
»t
) {

7565 
»t
 = 0;

7566 
out
;

7575 
disk_by‹Ä
 +ð
back»f_off£t
;

7576 
disk_by‹Ä
 +ð
off£t
 - 
key
.offset;

7577 ià(
	`csum_exi¡_š_¿nge
(
fs_šfo
, 
disk_by‹Ä
, 
num_by‹s
))

7578 
out
;

7583 *
Ën
 = 
num_by‹s
;

7584 
»t
 = 1;

7585 
out
:

7586 
	`bŒfs_ä“_·th
(
·th
);

7587  
»t
;

7588 
	}
}

7590 
boÞ
 
	$bŒfs_·ge_exi¡s_š_¿nge
(
šode
 *šode, 
loff_t
 
¡¬t
,†off_ˆ
’d
)

7592 
¿dix_Œ“_roÙ
 *
roÙ
 = &
šode
->
i_m­pšg
->
·ge_Œ“
;

7593 
boÞ
 
found
 = 
çl£
;

7594 **
·g•
 = 
NULL
;

7595 
·ge
 *·gð
NULL
;

7596 
¡¬t_idx
;

7597 
’d_idx
;

7599 
¡¬t_idx
 = 
¡¬t
 >> 
PAGE_SHIFT
;

7604 
’d_idx
 = 
’d
 >> 
PAGE_SHIFT
;

7606 
	`rcu_»ad_lock
();

7614 
·ge
 =ð
NULL
 &&

7615 
	`¿dix_Œ“_gªg_lookup_¦Ù
(
roÙ
, &
·g•
, 
NULL
, 
¡¬t_idx
, 1)) {

7616 
·ge
 = 
	`¿dix_Œ“_d”ef_¦Ù
(
·g•
);

7617 ià(
	`uÆik–y
(!
·ge
))

7620 ià(
	`¿dix_Œ“_exû±iÚ
(
·ge
)) {

7621 ià(
	`¿dix_Œ“_d”ef_»Œy
(
·ge
)) {

7622 
·ge
 = 
NULL
;

7630 
·ge
 = 
NULL
;

7634 ià(!
	`·ge_ÿche_g‘_¥ecuÏtive
(
·ge
)) {

7635 
·ge
 = 
NULL
;

7644 ià(
	`uÆik–y
(
·ge
 !ð*
·g•
)) {

7645 
	`put_·ge
(
·ge
);

7646 
·ge
 = 
NULL
;

7650 ià(
·ge
) {

7651 ià(
·ge
->
šdex
 <ð
’d_idx
)

7652 
found
 = 
Œue
;

7653 
	`put_·ge
(
·ge
);

7656 
	`rcu_»ad_uÆock
();

7657  
found
;

7658 
	}
}

7660 
	$lock_ex‹Á_dœeù
(
šode
 *šode, 
u64
 
lock¡¬t
, u64 
lock’d
,

7661 
ex‹Á_¡©e
 **
ÿched_¡©e
, 
wr™šg
)

7663 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

7664 
»t
 = 0;

7667 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

7668 
ÿched_¡©e
);

7674 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
lock¡¬t
,

7675 
lock’d
 - 
lock¡¬t
 + 1);

7684 ià(!
Üd”ed
 &&

7685 (!
wr™šg
 ||

7686 !
	`bŒfs_·ge_exi¡s_š_¿nge
(
šode
, 
lock¡¬t
, 
lock’d
)))

7689 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

7690 
ÿched_¡©e
, 
GFP_NOFS
);

7692 ià(
Üd”ed
) {

7708 ià(
wr™šg
 ||

7709 
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Üd”ed
->
æags
))

7710 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

7712 
»t
 = -
ENOTBLK
;

7713 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

7728 
»t
 = -
ENOTBLK
;

7731 ià(
»t
)

7734 
	`cÚd_»sched
();

7737  
»t
;

7738 
	}
}

7741 
ex‹Á_m­
 *
	$ü—‹_io_em
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
,

7742 
u64
 
Üig_¡¬t
, u64 
block_¡¬t
,

7743 
u64
 
block_Ën
, u64 
Üig_block_Ën
,

7744 
u64
 
¿m_by‹s
, 
com´ess_ty³
,

7745 
ty³
)

7747 
ex‹Á_m­_Œ“
 *
em_Œ“
;

7748 
ex‹Á_m­
 *
em
;

7749 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

7750 
»t
;

7752 
	`ASSERT
(
ty³
 =ð
BTRFS_ORDERED_PREALLOC
 ||

7753 
ty³
 =ð
BTRFS_ORDERED_COMPRESSED
 ||

7754 
ty³
 =ð
BTRFS_ORDERED_NOCOW
 ||

7755 
ty³
 =ð
BTRFS_ORDERED_REGULAR
);

7757 
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

7758 
em
 = 
	`®loc_ex‹Á_m­
();

7759 ià(!
em
)

7760  
	`ERR_PTR
(-
ENOMEM
);

7762 
em
->
¡¬t
 = start;

7763 
em
->
Üig_¡¬t
 = orig_start;

7764 
em
->
Ën
 =†en;

7765 
em
->
block_Ën
 = block_len;

7766 
em
->
block_¡¬t
 = block_start;

7767 
em
->
bdev
 = 
roÙ
->
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

7768 
em
->
Üig_block_Ën
 = orig_block_len;

7769 
em
->
¿m_by‹s
 =„am_bytes;

7770 
em
->
g’”©iÚ
 = -1;

7771 
	`£t_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

7772 ià(
ty³
 =ð
BTRFS_ORDERED_PREALLOC
) {

7773 
	`£t_b™
(
EXTENT_FLAG_FILLING
, &
em
->
æags
);

7774 } ià(
ty³
 =ð
BTRFS_ORDERED_COMPRESSED
) {

7775 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
);

7776 
em
->
com´ess_ty³
 = compress_type;

7780 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
em
->
¡¬t
,

7781 
em
->
¡¬t
 +ƒm->
Ën
 - 1, 0);

7782 
	`wr™e_lock
(&
em_Œ“
->
lock
);

7783 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 1);

7784 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

7789 } 
»t
 =ð-
EEXIST
);

7791 ià(
»t
) {

7792 
	`ä“_ex‹Á_m­
(
em
);

7793  
	`ERR_PTR
(
»t
);

7797  
em
;

7798 
	}
}

7800 
	$adju¡_dio_out¡ªdšg_ex‹Ás
(
šode
 *inode,

7801 
bŒfs_dio_d©a
 *
dio_d©a
,

7802 cÚ¡ 
u64
 
Ën
)

7804 
num_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
Ën
);

7811 ià(
dio_d©a
->
out¡ªdšg_ex‹Ás
 >ð
num_ex‹Ás
) {

7812 
dio_d©a
->
out¡ªdšg_ex‹Ás
 -ð
num_ex‹Ás
;

7819 
u64
 
num_Ãeded
 = 
num_ex‹Ás
 - 
dio_d©a
->
out¡ªdšg_ex‹Ás
;

7821 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

7822 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 +ð
num_Ãeded
;

7823 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

7825 
	}
}

7827 
	$bŒfs_g‘_blocks_dœeù
(
šode
 *šode, 
£ùÜ_t
 
iblock
,

7828 
bufãr_h—d
 *
bh_»suÉ
, 
ü—‹
)

7830 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

7831 
ex‹Á_m­
 *
em
;

7832 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

7833 
bŒfs_dio_d©a
 *
dio_d©a
 = 
NULL
;

7834 
u64
 
¡¬t
 = 
iblock
 << 
šode
->
i_blkb™s
;

7835 
u64
 
lock¡¬t
, 
lock’d
;

7836 
u64
 
Ën
 = 
bh_»suÉ
->
b_size
;

7837 
uÆock_b™s
 = 
EXTENT_LOCKED
;

7838 
»t
 = 0;

7840 ià(
ü—‹
)

7841 
uÆock_b™s
 |ð
EXTENT_DIRTY
;

7843 
Ën
 = 
	`mš_t
(
u64
,†’, 
fs_šfo
->
£ùÜsize
);

7845 
lock¡¬t
 = 
¡¬t
;

7846 
lock’d
 = 
¡¬t
 + 
Ën
 - 1;

7848 ià(
cu¼’t
->
jouº®_šfo
) {

7854 
dio_d©a
 = 
cu¼’t
->
jouº®_šfo
;

7855 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

7862 ià(
	`lock_ex‹Á_dœeù
(
šode
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
,

7863 
ü—‹
)) {

7864 
»t
 = -
ENOTBLK
;

7865 
”r
;

7868 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
¡¬t
, 
Ën
, 0);

7869 ià(
	`IS_ERR
(
em
)) {

7870 
»t
 = 
	`PTR_ERR
(
em
);

7871 
uÆock_”r
;

7888 ià(
	`‹¡_b™
(
EXTENT_FLAG_COMPRESSED
, &
em
->
æags
) ||

7889 
em
->
block_¡¬t
 =ð
EXTENT_MAP_INLINE
) {

7890 
	`ä“_ex‹Á_m­
(
em
);

7891 
»t
 = -
ENOTBLK
;

7892 
uÆock_”r
;

7896 ià(!
ü—‹
 && (
em
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
 ||

7897 
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))) {

7898 
	`ä“_ex‹Á_m­
(
em
);

7899 
uÆock_”r
;

7911 ià(!
ü—‹
) {

7912 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

7913 
lock¡¬t
 = 
¡¬t
 + 
Ën
;

7914 
uÆock
;

7917 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
) ||

7918 ((
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATACOW
) &&

7919 
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
)) {

7920 
ty³
;

7921 
u64
 
block_¡¬t
, 
Üig_¡¬t
, 
Üig_block_Ën
, 
¿m_by‹s
;

7923 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

7924 
ty³
 = 
BTRFS_ORDERED_PREALLOC
;

7926 
ty³
 = 
BTRFS_ORDERED_NOCOW
;

7927 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

7928 
block_¡¬t
 = 
em
->block_¡¬ˆ+ (
¡¬t
 -ƒm->start);

7930 ià(
	`ÿn_nocow_ex‹Á
(
šode
, 
¡¬t
, &
Ën
, &
Üig_¡¬t
,

7931 &
Üig_block_Ën
, &
¿m_by‹s
) == 1 &&

7932 
	`bŒfs_šc_nocow_wr™”s
(
fs_šfo
, 
block_¡¬t
)) {

7933 
ex‹Á_m­
 *
em2
;

7935 
em2
 = 
	`bŒfs_ü—‹_dio_ex‹Á
(
šode
, 
¡¬t
, 
Ën
,

7936 
Üig_¡¬t
, 
block_¡¬t
,

7937 
Ën
, 
Üig_block_Ën
,

7938 
¿m_by‹s
, 
ty³
);

7939 
	`bŒfs_dec_nocow_wr™”s
(
fs_šfo
, 
block_¡¬t
);

7940 ià(
ty³
 =ð
BTRFS_ORDERED_PREALLOC
) {

7941 
	`ä“_ex‹Á_m­
(
em
);

7942 
em
 = 
em2
;

7944 ià(
em2
 && 
	`IS_ERR
(em2)) {

7945 
»t
 = 
	`PTR_ERR
(
em2
);

7946 
uÆock_”r
;

7953 
	`bŒfs_ä“_»£rved_d©a_¥aû_noquÙa
(
šode
,

7954 
¡¬t
, 
Ën
);

7955 
uÆock
;

7963 
Ën
 = 
bh_»suÉ
->
b_size
;

7964 
	`ä“_ex‹Á_m­
(
em
);

7965 
em
 = 
	`bŒfs_Ãw_ex‹Á_dœeù
(
šode
, 
¡¬t
, 
Ën
);

7966 ià(
	`IS_ERR
(
em
)) {

7967 
»t
 = 
	`PTR_ERR
(
em
);

7968 
uÆock_”r
;

7970 
Ën
 = 
	`mš
Ö’, 
em
->ËÀ- (
¡¬t
 -ƒm->start));

7971 
uÆock
:

7972 
bh_»suÉ
->
b_blockÄ
 = (
em
->
block_¡¬t
 + (
¡¬t
 -ƒm->start)) >>

7973 
šode
->
i_blkb™s
;

7974 
bh_»suÉ
->
b_size
 = 
Ën
;

7975 
bh_»suÉ
->
b_bdev
 = 
em
->
bdev
;

7976 
	`£t_bufãr_m­³d
(
bh_»suÉ
);

7977 ià(
ü—‹
) {

7978 ià(!
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

7979 
	`£t_bufãr_Ãw
(
bh_»suÉ
);

7985 ià(!
dio_d©a
->
ov”wr™e
 && 
¡¬t
 + 
Ën
 > 
	`i_size_»ad
(
šode
))

7986 
	`i_size_wr™e
(
šode
, 
¡¬t
 + 
Ën
);

7988 
	`adju¡_dio_out¡ªdšg_ex‹Ás
(
šode
, 
dio_d©a
, 
Ën
);

7989 
	`WARN_ON
(
dio_d©a
->
»£rve
 < 
Ën
);

7990 
dio_d©a
->
»£rve
 -ð
Ën
;

7991 
dio_d©a
->
unsubm™‹d_Û_¿nge_’d
 = 
¡¬t
 + 
Ën
;

7992 
cu¼’t
->
jouº®_šfo
 = 
dio_d©a
;

8000 ià(
lock¡¬t
 < 
lock’d
) {

8001 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
,

8002 
lock’d
, 
uÆock_b™s
, 1, 0,

8003 &
ÿched_¡©e
, 
GFP_NOFS
);

8005 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

8008 
	`ä“_ex‹Á_m­
(
em
);

8012 
uÆock_”r
:

8013 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
lock¡¬t
, 
lock’d
,

8014 
uÆock_b™s
, 1, 0, &
ÿched_¡©e
, 
GFP_NOFS
);

8015 
”r
:

8016 ià(
dio_d©a
)

8017 
cu¼’t
->
jouº®_šfo
 = 
dio_d©a
;

8023 ià(
ü—‹
 && 
dio_d©a
)

8024 
	`adju¡_dio_out¡ªdšg_ex‹Ás
(
šode
, 
dio_d©a
, 
Ën
);

8026  
»t
;

8027 
	}
}

8029 
šlše
 
blk_¡©us_t
 
	$subm™_dio_»·œ_bio
(
šode
 *inode,

8030 
bio
 *bio,

8031 
mœrÜ_num
)

8033 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8034 
blk_¡©us_t
 
»t
;

8036 
	`BUG_ON
(
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
);

8038 
	`bio_g‘
(
bio
);

8040 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
bio
, 
BTRFS_WQ_ENDIO_DIO_REPAIR
);

8041 ià(
»t
)

8042 
”r
;

8044 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 
mœrÜ_num
, 0);

8045 
”r
:

8046 
	`bio_put
(
bio
);

8047  
»t
;

8048 
	}
}

8050 
	$bŒfs_check_dio_»·œabË
(
šode
 *inode,

8051 
bio
 *
çžed_bio
,

8052 
io_çžu»_»cÜd
 *
çž»c
,

8053 
çžed_mœrÜ
)

8055 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8056 
num_cÝ›s
;

8058 
num_cÝ›s
 = 
	`bŒfs_num_cÝ›s
(
fs_šfo
, 
çž»c
->
logiÿl
, faž»c->
Ën
);

8059 ià(
num_cÝ›s
 == 1) {

8065 
	`bŒfs_debug
(
fs_šfo
,

8067 
num_cÝ›s
, 
çž»c
->
this_mœrÜ
, 
çžed_mœrÜ
);

8071 
çž»c
->
çžed_mœrÜ
 = failed_mirror;

8072 
çž»c
->
this_mœrÜ
++;

8073 ià(
çž»c
->
this_mœrÜ
 =ð
çžed_mœrÜ
)

8074 
çž»c
->
this_mœrÜ
++;

8076 ià(
çž»c
->
this_mœrÜ
 > 
num_cÝ›s
) {

8077 
	`bŒfs_debug
(
fs_šfo
,

8079 
num_cÝ›s
, 
çž»c
->
this_mœrÜ
, 
çžed_mœrÜ
);

8084 
	}
}

8086 
blk_¡©us_t
 
	$dio_»ad_”rÜ
(
šode
 *šode, 
bio
 *
çžed_bio
,

8087 
·ge
 *·ge, 
pgoff
,

8088 
u64
 
¡¬t
, u64 
’d
, 
çžed_mœrÜ
,

8089 
bio_’d_io_t
 *
»·œ_’dio
, *
»·œ_¬g
)

8091 
io_çžu»_»cÜd
 *
çž»c
;

8092 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

8093 
ex‹Á_io_Œ“
 *
çžu»_Œ“
 = &
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
;

8094 
bio
 *bio;

8095 
i£ùÜ
;

8096 
»ad_mode
 = 0;

8097 
£gs
;

8098 
»t
;

8099 
blk_¡©us_t
 
¡©us
;

8101 
	`BUG_ON
(
	`bio_Ý
(
çžed_bio
è=ð
REQ_OP_WRITE
);

8103 
»t
 = 
	`bŒfs_g‘_io_çžu»_»cÜd
(
šode
, 
¡¬t
, 
’d
, &
çž»c
);

8104 ià(
»t
)

8105  
	`”ºo_to_blk_¡©us
(
»t
);

8107 
»t
 = 
	`bŒfs_check_dio_»·œabË
(
šode
, 
çžed_bio
, 
çž»c
,

8108 
çžed_mœrÜ
);

8109 ià(!
»t
) {

8110 
	`ä“_io_çžu»
(
çžu»_Œ“
, 
io_Œ“
, 
çž»c
);

8111  
BLK_STS_IOERR
;

8114 
£gs
 = 
	`bio_£gm’ts
(
çžed_bio
);

8115 ià(
£gs
 > 1 ||

8116 (
çžed_bio
->
bi_io_vec
->
bv_Ën
 > 
	`bŒfs_šode_£ùÜsize
(
šode
)))

8117 
»ad_mode
 |ð
REQ_FAILFAST_DEV
;

8119 
i£ùÜ
 = 
¡¬t
 - 
	`bŒfs_io_bio
(
çžed_bio
)->
logiÿl
;

8120 
i£ùÜ
 >>ð
šode
->
i_sb
->
s_blocksize_b™s
;

8121 
bio
 = 
	`bŒfs_ü—‹_»·œ_bio
(
šode
, 
çžed_bio
, 
çž»c
, 
·ge
,

8122 
pgoff
, 
i£ùÜ
, 
»·œ_’dio
, 
»·œ_¬g
);

8123 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 
»ad_mode
);

8125 
	`bŒfs_debug
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

8127 
»ad_mode
, 
çž»c
->
this_mœrÜ
, faž»c->
š_v®id©iÚ
);

8129 
¡©us
 = 
	`subm™_dio_»·œ_bio
(
šode
, 
bio
, 
çž»c
->
this_mœrÜ
);

8130 ià(
¡©us
) {

8131 
	`ä“_io_çžu»
(
çžu»_Œ“
, 
io_Œ“
, 
çž»c
);

8132 
	`bio_put
(
bio
);

8135  
¡©us
;

8136 
	}
}

8138 
	sbŒfs_»Œy_com¶‘e
 {

8139 
com¶‘iÚ
 
	mdÚe
;

8140 
šode
 *
	mšode
;

8141 
u64
 
	m¡¬t
;

8142 
	mu±od©e
;

8145 
	$bŒfs_»Œy_’dio_nocsum
(
bio
 *bio)

8147 
bŒfs_»Œy_com¶‘e
 *
dÚe
 = 
bio
->
bi_´iv©e
;

8148 
šode
 *šodð
dÚe
->inode;

8149 
bio_vec
 *
bvec
;

8150 
ex‹Á_io_Œ“
 *
io_Œ“
, *
çžu»_Œ“
;

8151 
i
;

8153 ià(
bio
->
bi_¡©us
)

8154 
’d
;

8156 
	`ASSERT
(
bio
->
bi_vút
 == 1);

8157 
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

8158 
çžu»_Œ“
 = &
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
;

8159 
	`ASSERT
(
bio
->
bi_io_vec
->
bv_Ën
 =ð
	`bŒfs_šode_£ùÜsize
(
šode
));

8161 
dÚe
->
u±od©e
 = 1;

8162 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

8163 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
)

8164 
	`þ—n_io_çžu»
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
, 
çžu»_Œ“
,

8165 
io_Œ“
, 
dÚe
->
¡¬t
, 
bvec
->
bv_·ge
,

8166 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 0);

8167 
’d
:

8168 
	`com¶‘e
(&
dÚe
->done);

8169 
	`bio_put
(
bio
);

8170 
	}
}

8172 
blk_¡©us_t
 
	$__bŒfs_cÜ»ù_d©a_nocsum
(
šode
 *inode,

8173 
bŒfs_io_bio
 *
io_bio
)

8175 
bŒfs_fs_šfo
 *
fs_šfo
;

8176 
bio_vec
 
bvec
;

8177 
bvec_™”
 
™”
;

8178 
bŒfs_»Œy_com¶‘e
 
dÚe
;

8179 
u64
 
¡¬t
;

8180 
pgoff
;

8181 
u32
 
£ùÜsize
;

8182 
Ä_£ùÜs
;

8183 
blk_¡©us_t
 
»t
;

8184 
blk_¡©us_t
 
”r
 = 
BLK_STS_OK
;

8186 
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

8187 
£ùÜsize
 = 
fs_šfo
->sectorsize;

8189 
¡¬t
 = 
io_bio
->
logiÿl
;

8190 
dÚe
.
šode
 = inode;

8191 
io_bio
->
bio
.
bi_™”
 = io_bio->
™”
;

8193 
	`bio_fÜ_—ch_£gm’t
(
bvec
, &
io_bio
->
bio
, 
™”
) {

8194 
Ä_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
bvec
.
bv_Ën
);

8195 
pgoff
 = 
bvec
.
bv_off£t
;

8197 
Ãxt_block_Ü_Œy_agaš
:

8198 
dÚe
.
u±od©e
 = 0;

8199 
dÚe
.
¡¬t
 = start;

8200 
	`š™_com¶‘iÚ
(&
dÚe
.done);

8202 
»t
 = 
	`dio_»ad_”rÜ
(
šode
, &
io_bio
->
bio
, 
bvec
.
bv_·ge
,

8203 
pgoff
, 
¡¬t
, s¹ + 
£ùÜsize
 - 1,

8204 
io_bio
->
mœrÜ_num
,

8205 
bŒfs_»Œy_’dio_nocsum
, &
dÚe
);

8206 ià(
»t
) {

8207 
”r
 = 
»t
;

8208 
Ãxt
;

8211 
	`wa™_fÜ_com¶‘iÚ_io
(&
dÚe
.done);

8213 ià(!
dÚe
.
u±od©e
) {

8215 
Ãxt_block_Ü_Œy_agaš
;

8218 
Ãxt
:

8219 
¡¬t
 +ð
£ùÜsize
;

8221 
Ä_£ùÜs
--;

8222 ià(
Ä_£ùÜs
) {

8223 
pgoff
 +ð
£ùÜsize
;

8224 
	`ASSERT
(
pgoff
 < 
PAGE_SIZE
);

8225 
Ãxt_block_Ü_Œy_agaš
;

8229  
”r
;

8230 
	}
}

8232 
	$bŒfs_»Œy_’dio
(
bio
 *bio)

8234 
bŒfs_»Œy_com¶‘e
 *
dÚe
 = 
bio
->
bi_´iv©e
;

8235 
bŒfs_io_bio
 *
io_bio
 = 
	`bŒfs_io_bio
(
bio
);

8236 
ex‹Á_io_Œ“
 *
io_Œ“
, *
çžu»_Œ“
;

8237 
šode
 *šodð
dÚe
->inode;

8238 
bio_vec
 *
bvec
;

8239 
u±od©e
;

8240 
»t
;

8241 
i
;

8243 ià(
bio
->
bi_¡©us
)

8244 
’d
;

8246 
u±od©e
 = 1;

8248 
	`ASSERT
(
bio
->
bi_vút
 == 1);

8249 
	`ASSERT
(
bio
->
bi_io_vec
->
bv_Ën
 =ð
	`bŒfs_šode_£ùÜsize
(
dÚe
->
šode
));

8251 
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

8252 
çžu»_Œ“
 = &
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
;

8254 
	`ASSERT
(!
	`bio_æagged
(
bio
, 
BIO_CLONED
));

8255 
	`bio_fÜ_—ch_£gm’t_®l
(
bvec
, 
bio
, 
i
) {

8256 
»t
 = 
	`__»ad·ge_’dio_check
(
šode
, 
io_bio
, 
i
, 
bvec
->
bv_·ge
,

8257 
bvec
->
bv_off£t
, 
dÚe
->
¡¬t
,

8258 
bvec
->
bv_Ën
);

8259 ià(!
»t
)

8260 
	`þ—n_io_çžu»
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

8261 
çžu»_Œ“
, 
io_Œ“
, 
dÚe
->
¡¬t
,

8262 
bvec
->
bv_·ge
,

8263 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

8264 
bvec
->
bv_off£t
);

8266 
u±od©e
 = 0;

8269 
dÚe
->
u±od©e
 = uptodate;

8270 
’d
:

8271 
	`com¶‘e
(&
dÚe
->done);

8272 
	`bio_put
(
bio
);

8273 
	}
}

8275 
blk_¡©us_t
 
	$__bŒfs_subio_’dio_»ad
(
šode
 *inode,

8276 
bŒfs_io_bio
 *
io_bio
, 
blk_¡©us_t
 
”r
)

8278 
bŒfs_fs_šfo
 *
fs_šfo
;

8279 
bio_vec
 
bvec
;

8280 
bvec_™”
 
™”
;

8281 
bŒfs_»Œy_com¶‘e
 
dÚe
;

8282 
u64
 
¡¬t
;

8283 
u64
 
off£t
 = 0;

8284 
u32
 
£ùÜsize
;

8285 
Ä_£ùÜs
;

8286 
pgoff
;

8287 
csum_pos
;

8288 
boÞ
 
u±od©e
 = (
”r
 == 0);

8289 
»t
;

8290 
blk_¡©us_t
 
¡©us
;

8292 
fs_šfo
 = 
	`BTRFS_I
(
šode
)->
roÙ
->fs_info;

8293 
£ùÜsize
 = 
fs_šfo
->sectorsize;

8295 
”r
 = 
BLK_STS_OK
;

8296 
¡¬t
 = 
io_bio
->
logiÿl
;

8297 
dÚe
.
šode
 = inode;

8298 
io_bio
->
bio
.
bi_™”
 = io_bio->
™”
;

8300 
	`bio_fÜ_—ch_£gm’t
(
bvec
, &
io_bio
->
bio
, 
™”
) {

8301 
Ä_£ùÜs
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
bvec
.
bv_Ën
);

8303 
pgoff
 = 
bvec
.
bv_off£t
;

8304 
Ãxt_block
:

8305 ià(
u±od©e
) {

8306 
csum_pos
 = 
	`BTRFS_BYTES_TO_BLKS
(
fs_šfo
, 
off£t
);

8307 
»t
 = 
	`__»ad·ge_’dio_check
(
šode
, 
io_bio
, 
csum_pos
,

8308 
bvec
.
bv_·ge
, 
pgoff
, 
¡¬t
, 
£ùÜsize
);

8309 ià(
	`lik–y
(!
»t
))

8310 
Ãxt
;

8312 
Œy_agaš
:

8313 
dÚe
.
u±od©e
 = 0;

8314 
dÚe
.
¡¬t
 = start;

8315 
	`š™_com¶‘iÚ
(&
dÚe
.done);

8317 
¡©us
 = 
	`dio_»ad_”rÜ
(
šode
, &
io_bio
->
bio
, 
bvec
.
bv_·ge
,

8318 
pgoff
, 
¡¬t
, s¹ + 
£ùÜsize
 - 1,

8319 
io_bio
->
mœrÜ_num
, 
bŒfs_»Œy_’dio
,

8320 &
dÚe
);

8321 ià(
¡©us
) {

8322 
”r
 = 
¡©us
;

8323 
Ãxt
;

8326 
	`wa™_fÜ_com¶‘iÚ_io
(&
dÚe
.done);

8328 ià(!
dÚe
.
u±od©e
) {

8330 
Œy_agaš
;

8332 
Ãxt
:

8333 
off£t
 +ð
£ùÜsize
;

8334 
¡¬t
 +ð
£ùÜsize
;

8336 
	`ASSERT
(
Ä_£ùÜs
);

8338 
Ä_£ùÜs
--;

8339 ià(
Ä_£ùÜs
) {

8340 
pgoff
 +ð
£ùÜsize
;

8341 
	`ASSERT
(
pgoff
 < 
PAGE_SIZE
);

8342 
Ãxt_block
;

8346  
”r
;

8347 
	}
}

8349 
blk_¡©us_t
 
	$bŒfs_subio_’dio_»ad
(
šode
 *inode,

8350 
bŒfs_io_bio
 *
io_bio
, 
blk_¡©us_t
 
”r
)

8352 
boÞ
 
sk_csum
 = 
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
;

8354 ià(
sk_csum
) {

8355 ià(
	`uÆik–y
(
”r
))

8356  
	`__bŒfs_cÜ»ù_d©a_nocsum
(
šode
, 
io_bio
);

8358  
BLK_STS_OK
;

8360  
	`__bŒfs_subio_’dio_»ad
(
šode
, 
io_bio
, 
”r
);

8362 
	}
}

8364 
	$bŒfs_’dio_dœeù_»ad
(
bio
 *bio)

8366 
bŒfs_dio_´iv©e
 *
d
 = 
bio
->
bi_´iv©e
;

8367 
šode
 *šodð
d
->inode;

8368 
bio
 *
dio_bio
;

8369 
bŒfs_io_bio
 *
io_bio
 = 
	`bŒfs_io_bio
(
bio
);

8370 
blk_¡©us_t
 
”r
 = 
bio
->
bi_¡©us
;

8372 ià(
d
->
æags
 & 
BTRFS_DIO_ORIG_BIO_SUBMITTED
)

8373 
”r
 = 
	`bŒfs_subio_’dio_»ad
(
šode
, 
io_bio
,ƒrr);

8375 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
d
->
logiÿl_off£t
,

8376 
d
->
logiÿl_off£t
 + d->
by‹s
 - 1);

8377 
dio_bio
 = 
d
->dio_bio;

8379 
	`kä“
(
d
);

8381 
dio_bio
->
bi_¡©us
 = 
”r
;

8382 
	`dio_’d_io
(
dio_bio
);

8384 ià(
io_bio
->
’d_io
)

8385 
io_bio
->
	`’d_io
(io_bio, 
	`blk_¡©us_to_”ºo
(
”r
));

8386 
	`bio_put
(
bio
);

8387 
	}
}

8389 
	$__’dio_wr™e_upd©e_Üd”ed
(
šode
 *inode,

8390 cÚ¡ 
u64
 
off£t
, cÚ¡ u64 
by‹s
,

8391 cÚ¡ 
boÞ
 
u±od©e
)

8393 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8394 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
 = 
NULL
;

8395 
bŒfs_wÜkqueue
 *
wq
;

8396 
bŒfs_wÜk_func_t
 
func
;

8397 
u64
 
Üd”ed_off£t
 = 
off£t
;

8398 
u64
 
Üd”ed_by‹s
 = 
by‹s
;

8399 
u64
 
Ï¡_off£t
;

8400 
»t
;

8402 ià(
	`bŒfs_is_ä“_¥aû_šode
(
	`BTRFS_I
(
šode
))) {

8403 
wq
 = 
fs_šfo
->
’dio_ä“¥aû_wÜk”
;

8404 
func
 = 
bŒfs_ä“¥aû_wr™e_h–³r
;

8406 
wq
 = 
fs_šfo
->
’dio_wr™e_wÜk”s
;

8407 
func
 = 
bŒfs_’dio_wr™e_h–³r
;

8410 
agaš
:

8411 
Ï¡_off£t
 = 
Üd”ed_off£t
;

8412 
»t
 = 
	`bŒfs_dec_‹¡_fœ¡_Üd”ed_³ndšg
(
šode
, &
Üd”ed
,

8413 &
Üd”ed_off£t
,

8414 
Üd”ed_by‹s
,

8415 
u±od©e
);

8416 ià(!
»t
)

8417 
out_‹¡
;

8419 
	`bŒfs_š™_wÜk
(&
Üd”ed
->
wÜk
, 
func
, 
fšish_Üd”ed_â
, 
NULL
, NULL);

8420 
	`bŒfs_queue_wÜk
(
wq
, &
Üd”ed
->
wÜk
);

8421 
out_‹¡
:

8426 ià(
Üd”ed_off£t
 =ð
Ï¡_off£t
)

8432 ià(
Üd”ed_off£t
 < 
off£t
 + 
by‹s
) {

8433 
Üd”ed_by‹s
 = 
off£t
 + 
by‹s
 - 
Üd”ed_off£t
;

8434 
Üd”ed
 = 
NULL
;

8435 
agaš
;

8437 
	}
}

8439 
	$bŒfs_’dio_dœeù_wr™e
(
bio
 *bio)

8441 
bŒfs_dio_´iv©e
 *
d
 = 
bio
->
bi_´iv©e
;

8442 
bio
 *
dio_bio
 = 
d
->dio_bio;

8444 
	`__’dio_wr™e_upd©e_Üd”ed
(
d
->
šode
, d->
logiÿl_off£t
,

8445 
d
->
by‹s
, !
bio
->
bi_¡©us
);

8447 
	`kä“
(
d
);

8449 
dio_bio
->
bi_¡©us
 = 
bio
->bi_status;

8450 
	`dio_’d_io
(
dio_bio
);

8451 
	`bio_put
(
bio
);

8452 
	}
}

8454 
blk_¡©us_t
 
	$__bŒfs_subm™_bio_¡¬t_dœeù_io
(*
´iv©e_d©a
,

8455 
bio
 *bio, 
mœrÜ_num
,

8456 
bio_æags
, 
u64
 
off£t
)

8458 
šode
 *šodð
´iv©e_d©a
;

8459 
blk_¡©us_t
 
»t
;

8460 
»t
 = 
	`bŒfs_csum_Úe_bio
(
šode
, 
bio
, 
off£t
, 1);

8461 
	`BUG_ON
(
»t
);

8463 
	}
}

8465 
	$bŒfs_’d_dio_bio
(
bio
 *bio)

8467 
bŒfs_dio_´iv©e
 *
d
 = 
bio
->
bi_´iv©e
;

8468 
blk_¡©us_t
 
”r
 = 
bio
->
bi_¡©us
;

8470 ià(
”r
)

8471 
	`bŒfs_w¬n
(
	`BTRFS_I
(
d
->
šode
)->
roÙ
->
fs_šfo
,

8473 
	`bŒfs_šo
(
	`BTRFS_I
(
d
->
šode
)), 
	`bio_Ý
(
bio
),

8474 
bio
->
bi_Ýf
,

8475 ()
bio
->
bi_™”
.
bi_£ùÜ
,

8476 
bio
->
bi_™”
.
bi_size
, 
”r
);

8478 ià(
d
->
subio_’dio
)

8479 
”r
 = 
d
->
	`subio_’dio
(d->
šode
, 
	`bŒfs_io_bio
(
bio
),ƒrr);

8481 ià(
”r
) {

8482 
d
->
”rÜs
 = 1;

8488 
	`smp_mb__befÜe_©omic
();

8492 ià(!
	`©omic_dec_ªd_‹¡
(&
d
->
³ndšg_bios
))

8493 
out
;

8495 ià(
d
->
”rÜs
) {

8496 
	`bio_io_”rÜ
(
d
->
Üig_bio
);

8498 
d
->
dio_bio
->
bi_¡©us
 = 0;

8499 
	`bio_’dio
(
d
->
Üig_bio
);

8501 
out
:

8502 
	`bio_put
(
bio
);

8503 
	}
}

8505 
šlše
 
blk_¡©us_t
 
	$bŒfs_lookup_ªd_bšd_dio_csum
(
šode
 *inode,

8506 
bŒfs_dio_´iv©e
 *
d
,

8507 
bio
 *bio,

8508 
u64
 
fže_off£t
)

8510 
bŒfs_io_bio
 *
io_bio
 = 
	`bŒfs_io_bio
(
bio
);

8511 
bŒfs_io_bio
 *
Üig_io_bio
 = 
	`bŒfs_io_bio
(
d
->
Üig_bio
);

8512 
blk_¡©us_t
 
»t
;

8519 ià(
d
->
logiÿl_off£t
 =ð
fže_off£t
) {

8520 
»t
 = 
	`bŒfs_lookup_bio_sums_dio
(
šode
, 
d
->
Üig_bio
,

8521 
fže_off£t
);

8522 ià(
»t
)

8523  
»t
;

8526 ià(
bio
 =ð
d
->
Üig_bio
)

8529 
fže_off£t
 -ð
d
->
logiÿl_off£t
;

8530 
fže_off£t
 >>ð
šode
->
i_sb
->
s_blocksize_b™s
;

8531 
io_bio
->
csum
 = (
u8
 *)(((
u32
 *)
Üig_io_bio
->csumè+ 
fže_off£t
);

8534 
	}
}

8536 
šlše
 
blk_¡©us_t


8537 
	$__bŒfs_subm™_dio_bio
(
bio
 *bio, 
šode
 *šode, 
u64
 
fže_off£t
,

8538 
async_subm™
)

8540 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8541 
bŒfs_dio_´iv©e
 *
d
 = 
bio
->
bi_´iv©e
;

8542 
boÞ
 
wr™e
 = 
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
;

8543 
blk_¡©us_t
 
»t
;

8545 ià(
async_subm™
)

8546 
async_subm™
 = !
	`©omic_»ad
(&
	`BTRFS_I
(
šode
)->
sync_wr™”s
);

8548 
	`bio_g‘
(
bio
);

8550 ià(!
wr™e
) {

8551 
»t
 = 
	`bŒfs_bio_wq_’d_io
(
fs_šfo
, 
bio
, 
BTRFS_WQ_ENDIO_DATA
);

8552 ià(
»t
)

8553 
”r
;

8556 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
)

8557 
m­
;

8559 ià(
wr™e
 && 
async_subm™
) {

8560 
»t
 = 
	`bŒfs_wq_subm™_bio
(
fs_šfo
, 
bio
, 0, 0,

8561 
fže_off£t
, 
šode
,

8562 
__bŒfs_subm™_bio_¡¬t_dœeù_io
,

8563 
__bŒfs_subm™_bio_dÚe
);

8564 
”r
;

8565 } ià(
wr™e
) {

8570 
»t
 = 
	`bŒfs_csum_Úe_bio
(
šode
, 
bio
, 
fže_off£t
, 1);

8571 ià(
»t
)

8572 
”r
;

8574 
»t
 = 
	`bŒfs_lookup_ªd_bšd_dio_csum
(
šode
, 
d
, 
bio
,

8575 
fže_off£t
);

8576 ià(
»t
)

8577 
”r
;

8579 
m­
:

8580 
»t
 = 
	`bŒfs_m­_bio
(
fs_šfo
, 
bio
, 0, 
async_subm™
);

8581 
”r
:

8582 
	`bio_put
(
bio
);

8583  
»t
;

8584 
	}
}

8586 
	$bŒfs_subm™_dœeù_hook
(
bŒfs_dio_´iv©e
 *
d
)

8588 
šode
 *šodð
d
->inode;

8589 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8590 
bio
 *bio;

8591 
bio
 *
Üig_bio
 = 
d
->orig_bio;

8592 
u64
 
¡¬t_£ùÜ
 = 
Üig_bio
->
bi_™”
.
bi_£ùÜ
;

8593 
u64
 
fže_off£t
 = 
d
->
logiÿl_off£t
;

8594 
u64
 
m­_Ëngth
;

8595 
async_subm™
 = 0;

8596 
u64
 
subm™_Ën
;

8597 
þÚe_off£t
 = 0;

8598 
þÚe_Ën
;

8599 
»t
;

8600 
blk_¡©us_t
 
¡©us
;

8602 
m­_Ëngth
 = 
Üig_bio
->
bi_™”
.
bi_size
;

8603 
subm™_Ën
 = 
m­_Ëngth
;

8604 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
	`bŒfs_Ý
(
Üig_bio
), 
¡¬t_£ùÜ
 << 9,

8605 &
m­_Ëngth
, 
NULL
, 0);

8606 ià(
»t
)

8607  -
EIO
;

8609 ià(
m­_Ëngth
 >ð
subm™_Ën
) {

8610 
bio
 = 
Üig_bio
;

8611 
d
->
æags
 |ð
BTRFS_DIO_ORIG_BIO_SUBMITTED
;

8612 
subm™
;

8616 ià(
	`bŒfs_d©a_®loc_´ofže
(
fs_šfo
è& 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

8617 
async_subm™
 = 0;

8619 
async_subm™
 = 1;

8622 
	`ASSERT
(
m­_Ëngth
 <ð
INT_MAX
);

8623 
	`©omic_šc
(&
d
->
³ndšg_bios
);

8625 
þÚe_Ën
 = 
	`mš_t
(, 
subm™_Ën
, 
m­_Ëngth
);

8631 
bio
 = 
	`bŒfs_bio_þÚe_·¹Ÿl
(
Üig_bio
, 
þÚe_off£t
,

8632 
þÚe_Ën
);

8633 
bio
->
bi_´iv©e
 = 
d
;

8634 
bio
->
bi_’d_io
 = 
bŒfs_’d_dio_bio
;

8635 
	`bŒfs_io_bio
(
bio
)->
logiÿl
 = 
fže_off£t
;

8637 
	`ASSERT
(
subm™_Ën
 >ð
þÚe_Ën
);

8638 
subm™_Ën
 -ð
þÚe_Ën
;

8639 ià(
subm™_Ën
 == 0)

8648 
	`©omic_šc
(&
d
->
³ndšg_bios
);

8650 
¡©us
 = 
	`__bŒfs_subm™_dio_bio
(
bio
, 
šode
, 
fže_off£t
,

8651 
async_subm™
);

8652 ià(
¡©us
) {

8653 
	`bio_put
(
bio
);

8654 
	`©omic_dec
(&
d
->
³ndšg_bios
);

8655 
out_”r
;

8658 
þÚe_off£t
 +ð
þÚe_Ën
;

8659 
¡¬t_£ùÜ
 +ð
þÚe_Ën
 >> 9;

8660 
fže_off£t
 +ð
þÚe_Ën
;

8662 
m­_Ëngth
 = 
subm™_Ën
;

8663 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
	`bŒfs_Ý
(
Üig_bio
),

8664 
¡¬t_£ùÜ
 << 9, &
m­_Ëngth
, 
NULL
, 0);

8665 ià(
»t
)

8666 
out_”r
;

8667 } 
subm™_Ën
 > 0);

8669 
subm™
:

8670 
¡©us
 = 
	`__bŒfs_subm™_dio_bio
(
bio
, 
šode
, 
fže_off£t
, 
async_subm™
);

8671 ià(!
¡©us
)

8674 
	`bio_put
(
bio
);

8675 
out_”r
:

8676 
d
->
”rÜs
 = 1;

8681 
	`smp_mb__befÜe_©omic
();

8682 ià(
	`©omic_dec_ªd_‹¡
(&
d
->
³ndšg_bios
))

8683 
	`bio_io_”rÜ
(
d
->
Üig_bio
);

8687 
	}
}

8689 
	$bŒfs_subm™_dœeù
(
bio
 *
dio_bio
, 
šode
 *inode,

8690 
loff_t
 
fže_off£t
)

8692 
bŒfs_dio_´iv©e
 *
d
 = 
NULL
;

8693 
bio
 *biØð
NULL
;

8694 
bŒfs_io_bio
 *
io_bio
;

8695 
boÞ
 
wr™e
 = (
	`bio_Ý
(
dio_bio
è=ð
REQ_OP_WRITE
);

8696 
»t
 = 0;

8698 
bio
 = 
	`bŒfs_bio_þÚe
(
dio_bio
);

8700 
d
 = 
	`kz®loc
((*d), 
GFP_NOFS
);

8701 ià(!
d
) {

8702 
»t
 = -
ENOMEM
;

8703 
ä“_Üd”ed
;

8706 
d
->
´iv©e
 = 
dio_bio
->
bi_´iv©e
;

8707 
d
->
šode
 = inode;

8708 
d
->
logiÿl_off£t
 = 
fže_off£t
;

8709 
d
->
by‹s
 = 
dio_bio
->
bi_™”
.
bi_size
;

8710 
d
->
disk_by‹Ä
 = (
u64
)
dio_bio
->
bi_™”
.
bi_£ùÜ
 << 9;

8711 
bio
->
bi_´iv©e
 = 
d
;

8712 
d
->
Üig_bio
 = 
bio
;

8713 
d
->
dio_bio
 = dio_bio;

8714 
	`©omic_£t
(&
d
->
³ndšg_bios
, 0);

8715 
io_bio
 = 
	`bŒfs_io_bio
(
bio
);

8716 
io_bio
->
logiÿl
 = 
fže_off£t
;

8718 ià(
wr™e
) {

8719 
bio
->
bi_’d_io
 = 
bŒfs_’dio_dœeù_wr™e
;

8721 
bio
->
bi_’d_io
 = 
bŒfs_’dio_dœeù_»ad
;

8722 
d
->
subio_’dio
 = 
bŒfs_subio_’dio_»ad
;

8731 ià(
wr™e
) {

8732 
bŒfs_dio_d©a
 *
dio_d©a
 = 
cu¼’t
->
jouº®_šfo
;

8734 
dio_d©a
->
unsubm™‹d_Û_¿nge_’d
 = 
d
->
logiÿl_off£t
 +

8735 
d
->
by‹s
;

8736 
dio_d©a
->
unsubm™‹d_Û_¿nge_¡¬t
 =

8737 
dio_d©a
->
unsubm™‹d_Û_¿nge_’d
;

8740 
»t
 = 
	`bŒfs_subm™_dœeù_hook
(
d
);

8741 ià(!
»t
)

8744 ià(
io_bio
->
’d_io
)

8745 
io_bio
->
	`’d_io
(io_bio, 
»t
);

8747 
ä“_Üd”ed
:

8757 ià(
bio
 && 
d
) {

8758 
	`bio_io_”rÜ
(
bio
);

8764 
d
 = 
NULL
;

8765 
bio
 = 
NULL
;

8767 ià(
wr™e
)

8768 
	`__’dio_wr™e_upd©e_Üd”ed
(
šode
,

8769 
fže_off£t
,

8770 
dio_bio
->
bi_™”
.
bi_size
,

8771 
çl£
);

8773 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
fže_off£t
,

8774 
fže_off£t
 + 
dio_bio
->
bi_™”
.
bi_size
 - 1);

8776 
dio_bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

8781 
	`dio_’d_io
(
dio_bio
);

8783 ià(
bio
)

8784 
	`bio_put
(
bio
);

8785 
	`kä“
(
d
);

8786 
	}
}

8788 
ssize_t
 
	$check_dœeù_IO
(
bŒfs_fs_šfo
 *
fs_šfo
,

8789 
kiocb
 *
iocb
,

8790 cÚ¡ 
iov_™”
 *
™”
, 
loff_t
 
off£t
)

8792 
£g
;

8793 
i
;

8794 
blocksize_mask
 = 
fs_šfo
->
£ùÜsize
 - 1;

8795 
ssize_t
 
»tv®
 = -
EINVAL
;

8797 ià(
off£t
 & 
blocksize_mask
)

8798 
out
;

8800 ià(
	`iov_™”_®ignm’t
(
™”
è& 
blocksize_mask
)

8801 
out
;

8804 ià(
	`iov_™”_rw
(
™”
è!ð
READ
 || !
	`™”_is_iovec
(iter))

8811 
£g
 = 0; seg < 
™”
->
Ä_£gs
; seg++) {

8812 
i
 = 
£g
 + 1; i < 
™”
->
Ä_£gs
; i++) {

8813 ià(
™”
->
iov
[
£g
].
iov_ba£
 =ð™”->iov[
i
].iov_base)

8814 
out
;

8817 
»tv®
 = 0;

8818 
out
:

8819  
»tv®
;

8820 
	}
}

8822 
ssize_t
 
	$bŒfs_dœeù_IO
(
kiocb
 *
iocb
, 
iov_™”
 *
™”
)

8824 
fže
 *fžð
iocb
->
ki_fžp
;

8825 
šode
 *šodð
fže
->
f_m­pšg
->
ho¡
;

8826 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

8827 
bŒfs_dio_d©a
 
dio_d©a
 = { 0 };

8828 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

8829 
loff_t
 
off£t
 = 
iocb
->
ki_pos
;

8830 
size_t
 
couÁ
 = 0;

8831 
æags
 = 0;

8832 
boÞ
 
wakeup
 = 
Œue
;

8833 
boÞ
 
»lock
 = 
çl£
;

8834 
ssize_t
 
»t
;

8836 ià(
	`check_dœeù_IO
(
fs_šfo
, 
iocb
, 
™”
, 
off£t
))

8839 
	`šode_dio_begš
(
šode
);

8847 
couÁ
 = 
	`iov_™”_couÁ
(
™”
);

8848 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

8849 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

8850 
	`fžem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
off£t
,

8851 
off£t
 + 
couÁ
 - 1);

8853 ià(
	`iov_™”_rw
(
™”
è=ð
WRITE
) {

8859 ià(
off£t
 + 
couÁ
 <ð
šode
->
i_size
) {

8860 
dio_d©a
.
ov”wr™e
 = 1;

8861 
	`šode_uÆock
(
šode
);

8862 
»lock
 = 
Œue
;

8863 } ià(
iocb
->
ki_æags
 & 
IOCB_NOWAIT
) {

8864 
»t
 = -
EAGAIN
;

8865 
out
;

8867 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
,

8868 
off£t
, 
couÁ
);

8869 ià(
»t
)

8870 
out
;

8871 
dio_d©a
.
out¡ªdšg_ex‹Ás
 = 
	`couÁ_max_ex‹Ás
(
couÁ
);

8878 
dio_d©a
.
»£rve
 = 
	`round_up
(
couÁ
,

8879 
fs_šfo
->
£ùÜsize
);

8880 
dio_d©a
.
unsubm™‹d_Û_¿nge_¡¬t
 = (
u64
)
off£t
;

8881 
dio_d©a
.
unsubm™‹d_Û_¿nge_’d
 = (
u64
)
off£t
;

8882 
cu¼’t
->
jouº®_šfo
 = &
dio_d©a
;

8883 
	`down_»ad
(&
	`BTRFS_I
(
šode
)->
dio_£m
);

8884 } ià(
	`‹¡_b™
(
BTRFS_INODE_READDIO_NEED_LOCK
,

8885 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
)) {

8886 
	`šode_dio_’d
(
šode
);

8887 
æags
 = 
DIO_LOCKING
 | 
DIO_SKIP_HOLES
;

8888 
wakeup
 = 
çl£
;

8891 
»t
 = 
	`__blockdev_dœeù_IO
(
iocb
, 
šode
,

8892 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
,

8893 
™”
, 
bŒfs_g‘_blocks_dœeù
, 
NULL
,

8894 
bŒfs_subm™_dœeù
, 
æags
);

8895 ià(
	`iov_™”_rw
(
™”
è=ð
WRITE
) {

8896 
	`up_»ad
(&
	`BTRFS_I
(
šode
)->
dio_£m
);

8897 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

8898 ià(
»t
 < 0 &&„‘ !ð-
EIOCBQUEUED
) {

8899 ià(
dio_d©a
.
»£rve
)

8900 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

8901 
off£t
, 
dio_d©a
.
»£rve
);

8908 ià(
dio_d©a
.
unsubm™‹d_Û_¿nge_¡¬t
 <

8909 
dio_d©a
.
unsubm™‹d_Û_¿nge_’d
)

8910 
	`__’dio_wr™e_upd©e_Üd”ed
(
šode
,

8911 
dio_d©a
.
unsubm™‹d_Û_¿nge_¡¬t
,

8912 
dio_d©a
.
unsubm™‹d_Û_¿nge_’d
 -

8913 
dio_d©a
.
unsubm™‹d_Û_¿nge_¡¬t
,

8914 
çl£
);

8915 } ià(
»t
 >ð0 && (
size_t
ì‘ < 
couÁ
)

8916 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

8917 
off£t
, 
couÁ
 - (
size_t
)
»t
);

8919 
out
:

8920 ià(
wakeup
)

8921 
	`šode_dio_’d
(
šode
);

8922 ià(
»lock
)

8923 
	`šode_lock
(
šode
);

8925 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

8926  
»t
;

8927 
	}
}

8929 
	#BTRFS_FIEMAP_FLAGS
 (
FIEMAP_FLAG_SYNC
)

	)

8931 
	$bŒfs_f›m­
(
šode
 *šode, 
f›m­_ex‹Á_šfo
 *
f›šfo
,

8932 
__u64
 
¡¬t
, __u64 
Ën
)

8934 
»t
;

8936 
»t
 = 
	`f›m­_check_æags
(
f›šfo
, 
BTRFS_FIEMAP_FLAGS
);

8937 ià(
»t
)

8938  
»t
;

8940  
	`ex‹Á_f›m­
(
šode
, 
f›šfo
, 
¡¬t
, 
Ën
, 
bŒfs_g‘_ex‹Á_f›m­
);

8941 
	}
}

8943 
	$bŒfs_»ad·ge
(
fže
 *fže, 
·ge
 *page)

8945 
ex‹Á_io_Œ“
 *
Œ“
;

8946 
Œ“
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
io_Œ“
;

8947  
	`ex‹Á_»ad_fuÎ_·ge
(
Œ“
, 
·ge
, 
bŒfs_g‘_ex‹Á
, 0);

8948 
	}
}

8950 
	$bŒfs_wr™•age
(
·ge
 *·ge, 
wr™eback_cÚŒÞ
 *
wbc
)

8952 
ex‹Á_io_Œ“
 *
Œ“
;

8953 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

8954 
»t
;

8956 ià(
cu¼’t
->
æags
 & 
PF_MEMALLOC
) {

8957 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

8958 
	`uÆock_·ge
(
·ge
);

8967 ià(!
	`ig¿b
(
šode
)) {

8968 
	`»dœty_·ge_fÜ_wr™•age
(
wbc
, 
·ge
);

8969  
AOP_WRITEPAGE_ACTIVATE
;

8971 
Œ“
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
io_Œ“
;

8972 
»t
 = 
	`ex‹Á_wr™e_fuÎ_·ge
(
Œ“
, 
·ge
, 
bŒfs_g‘_ex‹Á
, 
wbc
);

8973 
	`bŒfs_add_d–ayed_ut
(
šode
);

8974  
»t
;

8975 
	}
}

8977 
	$bŒfs_wr™•ages
(
add»ss_¥aû
 *
m­pšg
,

8978 
wr™eback_cÚŒÞ
 *
wbc
)

8980 
ex‹Á_io_Œ“
 *
Œ“
;

8982 
Œ“
 = &
	`BTRFS_I
(
m­pšg
->
ho¡
)->
io_Œ“
;

8983  
	`ex‹Á_wr™•ages
(
Œ“
, 
m­pšg
, 
bŒfs_g‘_ex‹Á
, 
wbc
);

8984 
	}
}

8987 
	$bŒfs_»ad·ges
(
fže
 *fže, 
add»ss_¥aû
 *
m­pšg
,

8988 
li¡_h—d
 *
·ges
, 
Ä_·ges
)

8990 
ex‹Á_io_Œ“
 *
Œ“
;

8991 
Œ“
 = &
	`BTRFS_I
(
m­pšg
->
ho¡
)->
io_Œ“
;

8992  
	`ex‹Á_»ad·ges
(
Œ“
, 
m­pšg
, 
·ges
, 
Ä_·ges
,

8993 
bŒfs_g‘_ex‹Á
);

8994 
	}
}

8995 
	$__bŒfs_»Ëa£·ge
(
·ge
 *·ge, 
gå_t
 
gå_æags
)

8997 
ex‹Á_io_Œ“
 *
Œ“
;

8998 
ex‹Á_m­_Œ“
 *
m­
;

8999 
»t
;

9001 
Œ“
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
io_Œ“
;

9002 
m­
 = &
	`BTRFS_I
(
·ge
->
m­pšg
->
ho¡
)->
ex‹Á_Œ“
;

9003 
»t
 = 
	`Œy_»Ëa£_ex‹Á_m­pšg
(
m­
, 
Œ“
, 
·ge
, 
gå_æags
);

9004 ià(
»t
 == 1) {

9005 
	`CË¬PagePriv©e
(
·ge
);

9006 
	`£t_·ge_´iv©e
(
·ge
, 0);

9007 
	`put_·ge
(
·ge
);

9009  
»t
;

9010 
	}
}

9012 
	$bŒfs_»Ëa£·ge
(
·ge
 *·ge, 
gå_t
 
gå_æags
)

9014 ià(
	`PageWr™eback
(
·ge
è|| 
	`PageDœty
(page))

9016  
	`__bŒfs_»Ëa£·ge
(
·ge
, 
gå_æags
);

9017 
	}
}

9019 
	$bŒfs_šv®id©•age
(
·ge
 *·ge, 
off£t
,

9020 
Ëngth
)

9022 
šode
 *šodð
·ge
->
m­pšg
->
ho¡
;

9023 
ex‹Á_io_Œ“
 *
Œ“
;

9024 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

9025 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

9026 
u64
 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

9027 
u64
 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

9028 
u64
 
¡¬t
;

9029 
u64
 
’d
;

9030 
šode_eviùšg
 = 
šode
->
i_¡©e
 & 
I_FREEING
;

9039 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

9041 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

9042 ià(
off£t
) {

9043 
	`bŒfs_»Ëa£·ge
(
·ge
, 
GFP_NOFS
);

9047 ià(!
šode_eviùšg
)

9048 
	`lock_ex‹Á_b™s
(
Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

9049 
agaš
:

9050 
¡¬t
 = 
·ge_¡¬t
;

9051 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
¡¬t
,

9052 
·ge_’d
 - 
¡¬t
 + 1);

9053 ià(
Üd”ed
) {

9054 
’d
 = 
	`mš
(
·ge_’d
, 
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 - 1);

9059 ià(!
šode_eviùšg
)

9060 
	`þ—r_ex‹Á_b™
(
Œ“
, 
¡¬t
, 
’d
,

9061 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

9062 
EXTENT_DELALLOC_NEW
 |

9063 
EXTENT_LOCKED
 | 
EXTENT_DO_ACCOUNTING
 |

9064 
EXTENT_DEFRAG
, 1, 0, &
ÿched_¡©e
,

9065 
GFP_NOFS
);

9070 ià(
	`Te¡CË¬PagePriv©e2
(
·ge
)) {

9071 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

9072 
u64
 
Ãw_Ën
;

9074 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

9076 
	`¥š_lock_œq
(&
Œ“
->
lock
);

9077 
	`£t_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed
->
æags
);

9078 
Ãw_Ën
 = 
¡¬t
 - 
Üd”ed
->
fže_off£t
;

9079 ià(
Ãw_Ën
 < 
Üd”ed
->
Œunÿ‹d_Ën
)

9080 
Üd”ed
->
Œunÿ‹d_Ën
 = 
Ãw_Ën
;

9081 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

9083 ià(
	`bŒfs_dec_‹¡_Üd”ed_³ndšg
(
šode
, &
Üd”ed
,

9084 
¡¬t
,

9085 
’d
 - 
¡¬t
 + 1, 1))

9086 
	`bŒfs_fšish_Üd”ed_io
(
Üd”ed
);

9088 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

9089 ià(!
šode_eviùšg
) {

9090 
ÿched_¡©e
 = 
NULL
;

9091 
	`lock_ex‹Á_b™s
(
Œ“
, 
¡¬t
, 
’d
,

9092 &
ÿched_¡©e
);

9095 
¡¬t
 = 
’d
 + 1;

9096 ià(
¡¬t
 < 
·ge_’d
)

9097 
agaš
;

9115 ià(
	`PageDœty
(
·ge
))

9116 
	`bŒfs_qgroup_ä“_d©a
(
šode
, 
NULL
, 
·ge_¡¬t
, 
PAGE_SIZE
);

9117 ià(!
šode_eviùšg
) {

9118 
	`þ—r_ex‹Á_b™
(
Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

9119 
EXTENT_LOCKED
 | 
EXTENT_DIRTY
 |

9120 
EXTENT_DELALLOC
 | 
EXTENT_DELALLOC_NEW
 |

9121 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
, 1, 1,

9122 &
ÿched_¡©e
, 
GFP_NOFS
);

9124 
	`__bŒfs_»Ëa£·ge
(
·ge
, 
GFP_NOFS
);

9127 
	`CË¬PageChecked
(
·ge
);

9128 ià(
	`PagePriv©e
(
·ge
)) {

9129 
	`CË¬PagePriv©e
(
·ge
);

9130 
	`£t_·ge_´iv©e
(
·ge
, 0);

9131 
	`put_·ge
(
·ge
);

9133 
	}
}

9150 
	$bŒfs_·ge_mkwr™e
(
vm_çuÉ
 *
vmf
)

9152 
·ge
 *·gð
vmf
->page;

9153 
šode
 *šodð
	`fže_šode
(
vmf
->
vma
->
vm_fže
);

9154 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

9155 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

9156 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

9157 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

9158 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

9159 *
kaddr
;

9160 
z”o_¡¬t
;

9161 
loff_t
 
size
;

9162 
»t
;

9163 
»£rved
 = 0;

9164 
u64
 
»£rved_¥aû
;

9165 
u64
 
·ge_¡¬t
;

9166 
u64
 
·ge_’d
;

9167 
u64
 
’d
;

9169 
»£rved_¥aû
 = 
PAGE_SIZE
;

9171 
	`sb_¡¬t_·geçuÉ
(
šode
->
i_sb
);

9172 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

9173 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

9174 
’d
 = 
·ge_’d
;

9184 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
, 
·ge_¡¬t
,

9185 
»£rved_¥aû
);

9186 ià(!
»t
) {

9187 
»t
 = 
	`fže_upd©e_time
(
vmf
->
vma
->
vm_fže
);

9188 
»£rved
 = 1;

9190 ià(
»t
) {

9191 ià(
»t
 =ð-
ENOMEM
)

9192 
»t
 = 
VM_FAULT_OOM
;

9194 
»t
 = 
VM_FAULT_SIGBUS
;

9195 ià(
»£rved
)

9196 
out
;

9197 
out_nÜe£rve
;

9200 
»t
 = 
VM_FAULT_NOPAGE
;

9201 
agaš
:

9202 
	`lock_·ge
(
·ge
);

9203 
size
 = 
	`i_size_»ad
(
šode
);

9205 ià((
·ge
->
m­pšg
 !ð
šode
->
i_m­pšg
) ||

9206 (
·ge_¡¬t
 >ð
size
)) {

9208 
out_uÆock
;

9210 
	`wa™_Ú_·ge_wr™eback
(
·ge
);

9212 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
);

9213 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

9219 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
·ge_¡¬t
,

9220 
PAGE_SIZE
);

9221 ià(
Üd”ed
) {

9222 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

9223 &
ÿched_¡©e
, 
GFP_NOFS
);

9224 
	`uÆock_·ge
(
·ge
);

9225 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

9226 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

9227 
agaš
;

9230 ià(
·ge
->
šdex
 =ð((
size
 - 1è>> 
PAGE_SHIFT
)) {

9231 
»£rved_¥aû
 = 
	`round_up
(
size
 - 
·ge_¡¬t
,

9232 
fs_šfo
->
£ùÜsize
);

9233 ià(
»£rved_¥aû
 < 
PAGE_SIZE
) {

9234 
’d
 = 
·ge_¡¬t
 + 
»£rved_¥aû
 - 1;

9235 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

9236 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

9237 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

9238 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

9239 
·ge_¡¬t
, 
PAGE_SIZE
 - 
»£rved_¥aû
);

9250 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
, 
’d
,

9251 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

9252 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
,

9253 0, 0, &
ÿched_¡©e
, 
GFP_NOFS
);

9255 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
·ge_¡¬t
, 
’d
,

9256 &
ÿched_¡©e
, 0);

9257 ià(
»t
) {

9258 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

9259 &
ÿched_¡©e
, 
GFP_NOFS
);

9260 
»t
 = 
VM_FAULT_SIGBUS
;

9261 
out_uÆock
;

9263 
»t
 = 0;

9266 ià(
·ge_¡¬t
 + 
PAGE_SIZE
 > 
size
)

9267 
z”o_¡¬t
 = 
size
 & ~
PAGE_MASK
;

9269 
z”o_¡¬t
 = 
PAGE_SIZE
;

9271 ià(
z”o_¡¬t
 !ð
PAGE_SIZE
) {

9272 
kaddr
 = 
	`km­
(
·ge
);

9273 
	`mem£t
(
kaddr
 + 
z”o_¡¬t
, 0, 
PAGE_SIZE
 - zero_start);

9274 
	`æush_dÿche_·ge
(
·ge
);

9275 
	`kunm­
(
·ge
);

9277 
	`CË¬PageChecked
(
·ge
);

9278 
	`£t_·ge_dœty
(
·ge
);

9279 
	`S‘PageU±od©e
(
·ge
);

9281 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
fs_šfo
->
g’”©iÚ
;

9282 
	`BTRFS_I
(
šode
)->
Ï¡_sub_Œªs
 = BTRFS_I(šode)->
roÙ
->
log_Œªsid
;

9283 
	`BTRFS_I
(
šode
)->
Ï¡_log_comm™
 = BTRFS_I(šode)->
roÙ
->last_log_commit;

9285 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
, &
ÿched_¡©e
, 
GFP_NOFS
);

9287 
out_uÆock
:

9288 ià(!
»t
) {

9289 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

9290 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

9291  
VM_FAULT_LOCKED
;

9293 
	`uÆock_·ge
(
·ge
);

9294 
out
:

9295 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
, 
·ge_¡¬t
,

9296 
»£rved_¥aû
);

9297 
out_nÜe£rve
:

9298 
	`sb_’d_·geçuÉ
(
šode
->
i_sb
);

9299 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

9300  
»t
;

9301 
	}
}

9303 
	$bŒfs_Œunÿ‹
(
šode
 *inode)

9305 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

9306 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

9307 
bŒfs_block_rsv
 *
rsv
;

9308 
»t
 = 0;

9309 
”r
 = 0;

9310 
bŒfs_Œªs_hªdË
 *
Œªs
;

9311 
u64
 
mask
 = 
fs_šfo
->
£ùÜsize
 - 1;

9312 
u64
 
mš_size
 = 
	`bŒfs_ÿlc_Œunc_m‘ad©a_size
(
fs_šfo
, 1);

9314 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, inode->
i_size
 & (~
mask
),

9315 (
u64
)-1);

9316 ià(
»t
)

9317  
»t
;

9355 
rsv
 = 
	`bŒfs_®loc_block_rsv
(
fs_šfo
, 
BTRFS_BLOCK_RSV_TEMP
);

9356 ià(!
rsv
)

9357  -
ENOMEM
;

9358 
rsv
->
size
 = 
mš_size
;

9359 
rsv
->
çžç¡
 = 1;

9365 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

9366 ià(
	`IS_ERR
(
Œªs
)) {

9367 
”r
 = 
	`PTR_ERR
(
Œªs
);

9368 
out
;

9372 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
, 
rsv
,

9373 
mš_size
, 0);

9374 
	`BUG_ON
(
»t
);

9383 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

9384 
Œªs
->
block_rsv
 = 
rsv
;

9387 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
, 
roÙ
, 
šode
,

9388 
šode
->
i_size
,

9389 
BTRFS_EXTENT_DATA_KEY
);

9390 ià(
»t
 !ð-
ENOSPC
 &&„‘ !ð-
EAGAIN
) {

9391 
”r
 = 
»t
;

9395 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

9396 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

9397 ià(
»t
) {

9398 
”r
 = 
»t
;

9402 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9403 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

9405 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

9406 ià(
	`IS_ERR
(
Œªs
)) {

9407 
»t
 = 
”r
 = 
	`PTR_ERR
(
Œªs
);

9408 
Œªs
 = 
NULL
;

9412 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rsv
, -1);

9413 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
fs_šfo
->
Œªs_block_rsv
,

9414 
rsv
, 
mš_size
, 0);

9415 
	`BUG_ON
(
»t
);

9416 
Œªs
->
block_rsv
 = 
rsv
;

9419 ià(
»t
 =ð0 && 
šode
->
i_Æšk
 > 0) {

9420 
Œªs
->
block_rsv
 = 
roÙ
->
Üphª_block_rsv
;

9421 
»t
 = 
	`bŒfs_Üphª_d–
(
Œªs
, 
	`BTRFS_I
(
šode
));

9422 ià(
»t
)

9423 
”r
 = 
»t
;

9426 ià(
Œªs
) {

9427 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

9428 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

9429 ià(
»t
 && !
”r
)

9430 
”r
 = 
»t
;

9432 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9433 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

9435 
out
:

9436 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rsv
);

9438 ià(
»t
 && !
”r
)

9439 
”r
 = 
»t
;

9441  
”r
;

9442 
	}
}

9447 
	$bŒfs_ü—‹_subvÞ_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9448 
bŒfs_roÙ
 *
Ãw_roÙ
,

9449 
bŒfs_roÙ
 *
·»Á_roÙ
,

9450 
u64
 
Ãw_dœid
)

9452 
šode
 *inode;

9453 
”r
;

9454 
u64
 
šdex
 = 0;

9456 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
Ãw_roÙ
, 
NULL
, "..", 2,

9457 
Ãw_dœid
,‚ew_dirid,

9458 
S_IFDIR
 | (~
	`cu¼’t_umask
(è& 
S_IRWXUGO
),

9459 &
šdex
);

9460 ià(
	`IS_ERR
(
šode
))

9461  
	`PTR_ERR
(
šode
);

9462 
šode
->
i_Ý
 = &
bŒfs_dœ_šode_Ý”©iÚs
;

9463 
šode
->
i_fÝ
 = &
bŒfs_dœ_fže_Ý”©iÚs
;

9465 
	`£t_Æšk
(
šode
, 1);

9466 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 0);

9467 
	`uÆock_Ãw_šode
(
šode
);

9469 
”r
 = 
	`bŒfs_subvÞ_šh”™_´Ýs
(
Œªs
, 
Ãw_roÙ
, 
·»Á_roÙ
);

9470 ià(
”r
)

9471 
	`bŒfs_”r
(
Ãw_roÙ
->
fs_šfo
,

9473 
Ãw_roÙ
->
roÙ_key
.
objeùid
, 
”r
);

9475 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
Ãw_roÙ
, 
šode
);

9477 
	`ut
(
šode
);

9478  
”r
;

9479 
	}
}

9481 
šode
 *
	$bŒfs_®loc_šode
(
su³r_block
 *
sb
)

9483 
bŒfs_šode
 *
ei
;

9484 
šode
 *inode;

9486 
ei
 = 
	`kmem_ÿche_®loc
(
bŒfs_šode_ÿch•
, 
GFP_NOFS
);

9487 ià(!
ei
)

9488  
NULL
;

9490 
ei
->
roÙ
 = 
NULL
;

9491 
ei
->
g’”©iÚ
 = 0;

9492 
ei
->
Ï¡_Œªs
 = 0;

9493 
ei
->
Ï¡_sub_Œªs
 = 0;

9494 
ei
->
logged_Œªs
 = 0;

9495 
ei
->
d–®loc_by‹s
 = 0;

9496 
ei
->
Ãw_d–®loc_by‹s
 = 0;

9497 
ei
->
deäag_by‹s
 = 0;

9498 
ei
->
disk_i_size
 = 0;

9499 
ei
->
æags
 = 0;

9500 
ei
->
csum_by‹s
 = 0;

9501 
ei
->
šdex_út
 = (
u64
)-1;

9502 
ei
->
dœ_šdex
 = 0;

9503 
ei
->
Ï¡_uÆšk_Œªs
 = 0;

9504 
ei
->
Ï¡_log_comm™
 = 0;

9505 
ei
->
d–ayed_ut_couÁ
 = 0;

9507 
	`¥š_lock_š™
(&
ei
->
lock
);

9508 
ei
->
out¡ªdšg_ex‹Ás
 = 0;

9509 
ei
->
»£rved_ex‹Ás
 = 0;

9511 
ei
->
ruÁime_æags
 = 0;

9512 
ei
->
´Ý_com´ess
 = 
BTRFS_COMPRESS_NONE
;

9513 
ei
->
deäag_com´ess
 = 
BTRFS_COMPRESS_NONE
;

9515 
ei
->
d–ayed_node
 = 
NULL
;

9517 
ei
->
i_Ùime
.
tv_£c
 = 0;

9518 
ei
->
i_Ùime
.
tv_n£c
 = 0;

9520 
šode
 = &
ei
->
vfs_šode
;

9521 
	`ex‹Á_m­_Œ“_š™
(&
ei
->
ex‹Á_Œ“
);

9522 
	`ex‹Á_io_Œ“_š™
(&
ei
->
io_Œ“
, 
šode
);

9523 
	`ex‹Á_io_Œ“_š™
(&
ei
->
io_çžu»_Œ“
, 
šode
);

9524 
ei
->
io_Œ“
.
Œack_u±od©e
 = 1;

9525 
ei
->
io_çžu»_Œ“
.
Œack_u±od©e
 = 1;

9526 
	`©omic_£t
(&
ei
->
sync_wr™”s
, 0);

9527 
	`mu‹x_š™
(&
ei
->
log_mu‹x
);

9528 
	`mu‹x_š™
(&
ei
->
d–®loc_mu‹x
);

9529 
	`bŒfs_Üd”ed_šode_Œ“_š™
(&
ei
->
Üd”ed_Œ“
);

9530 
	`INIT_LIST_HEAD
(&
ei
->
d–®loc_šodes
);

9531 
	`INIT_LIST_HEAD
(&
ei
->
d–ayed_ut
);

9532 
	`RB_CLEAR_NODE
(&
ei
->
rb_node
);

9533 
	`š™_rw£m
(&
ei
->
dio_£m
);

9535  
šode
;

9536 
	}
}

9538 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


9539 
	$bŒfs_‹¡_de¡roy_šode
(
šode
 *inode)

9541 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1, 0);

9542 
	`kmem_ÿche_ä“
(
bŒfs_šode_ÿch•
, 
	`BTRFS_I
(
šode
));

9543 
	}
}

9546 
	$bŒfs_i_ÿÎback
(
rcu_h—d
 *
h—d
)

9548 
šode
 *šodð
	`cÚš”_of
(
h—d
, šode, 
i_rcu
);

9549 
	`kmem_ÿche_ä“
(
bŒfs_šode_ÿch•
, 
	`BTRFS_I
(
šode
));

9550 
	}
}

9552 
	$bŒfs_de¡roy_šode
(
šode
 *inode)

9554 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

9555 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

9556 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

9558 
	`WARN_ON
(!
	`hli¡_em±y
(&
šode
->
i_d’Œy
));

9559 
	`WARN_ON
(
šode
->
i_d©a
.
Ä·ges
);

9560 
	`WARN_ON
(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

9561 
	`WARN_ON
(
	`BTRFS_I
(
šode
)->
»£rved_ex‹Ás
);

9562 
	`WARN_ON
(
	`BTRFS_I
(
šode
)->
d–®loc_by‹s
);

9563 
	`WARN_ON
(
	`BTRFS_I
(
šode
)->
Ãw_d–®loc_by‹s
);

9564 
	`WARN_ON
(
	`BTRFS_I
(
šode
)->
csum_by‹s
);

9565 
	`WARN_ON
(
	`BTRFS_I
(
šode
)->
deäag_by‹s
);

9572 ià(!
roÙ
)

9573 
ä“
;

9575 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ORPHAN_ITEM
,

9576 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
)) {

9577 
	`bŒfs_šfo
(
fs_šfo
, "inode %llu still onhe orphan†ist",

9578 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)));

9579 
	`©omic_dec
(&
roÙ
->
Üphª_šodes
);

9583 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
, (
u64
)-1);

9584 ià(!
Üd”ed
)

9587 
	`bŒfs_”r
(
fs_šfo
,

9589 
Üd”ed
->
fže_off£t
, ord”ed->
Ën
);

9590 
	`bŒfs_»move_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
);

9591 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

9592 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

9595 
	`bŒfs_qgroup_check_»£rved_Ëak
(
šode
);

9596 
	`šode_Œ“_d–
(
šode
);

9597 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1, 0);

9598 
ä“
:

9599 
	`ÿÎ_rcu
(&
šode
->
i_rcu
, 
bŒfs_i_ÿÎback
);

9600 
	}
}

9602 
	$bŒfs_drÝ_šode
(
šode
 *inode)

9604 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

9606 ià(
roÙ
 =ð
NULL
)

9610 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

9613  
	`g’”ic_drÝ_šode
(
šode
);

9614 
	}
}

9616 
	$š™_Úû
(*
foo
)

9618 
bŒfs_šode
 *
ei
 = (bŒfs_šod*è
foo
;

9620 
	`šode_š™_Úû
(&
ei
->
vfs_šode
);

9621 
	}
}

9623 
	$bŒfs_de¡roy_ÿch•
()

9629 
	`rcu_b¬r›r
();

9630 
	`kmem_ÿche_de¡roy
(
bŒfs_šode_ÿch•
);

9631 
	`kmem_ÿche_de¡roy
(
bŒfs_Œªs_hªdË_ÿch•
);

9632 
	`kmem_ÿche_de¡roy
(
bŒfs_·th_ÿch•
);

9633 
	`kmem_ÿche_de¡roy
(
bŒfs_ä“_¥aû_ÿch•
);

9634 
	}
}

9636 
	$bŒfs_š™_ÿch•
()

9638 
bŒfs_šode_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_inode",

9639 (
bŒfs_šode
), 0,

9640 
SLAB_RECLAIM_ACCOUNT
 | 
SLAB_MEM_SPREAD
 | 
SLAB_ACCOUNT
,

9641 
š™_Úû
);

9642 ià(!
bŒfs_šode_ÿch•
)

9643 
çž
;

9645 
bŒfs_Œªs_hªdË_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_trans_handle",

9646 (
bŒfs_Œªs_hªdË
), 0,

9647 
SLAB_TEMPORARY
 | 
SLAB_MEM_SPREAD
, 
NULL
);

9648 ià(!
bŒfs_Œªs_hªdË_ÿch•
)

9649 
çž
;

9651 
bŒfs_·th_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_path",

9652 (
bŒfs_·th
), 0,

9653 
SLAB_MEM_SPREAD
, 
NULL
);

9654 ià(!
bŒfs_·th_ÿch•
)

9655 
çž
;

9657 
bŒfs_ä“_¥aû_ÿch•
 = 
	`kmem_ÿche_ü—‹
("btrfs_free_space",

9658 (
bŒfs_ä“_¥aû
), 0,

9659 
SLAB_MEM_SPREAD
, 
NULL
);

9660 ià(!
bŒfs_ä“_¥aû_ÿch•
)

9661 
çž
;

9664 
çž
:

9665 
	`bŒfs_de¡roy_ÿch•
();

9666  -
ENOMEM
;

9667 
	}
}

9669 
	$bŒfs_g‘©Œ
(cÚ¡ 
·th
 *·th, 
k¡©
 *
¡©
,

9670 
u32
 
»que¡_mask
, 
æags
)

9672 
u64
 
d–®loc_by‹s
;

9673 
šode
 *šodð
	`d_šode
(
·th
->
d’Œy
);

9674 
u32
 
blocksize
 = 
šode
->
i_sb
->
s_blocksize
;

9675 
u32
 
bi_æags
 = 
	`BTRFS_I
(
šode
)->
æags
;

9677 
¡©
->
»suÉ_mask
 |ð
STATX_BTIME
;

9678 
¡©
->
btime
.
tv_£c
 = 
	`BTRFS_I
(
šode
)->
i_Ùime
.tv_sec;

9679 
¡©
->
btime
.
tv_n£c
 = 
	`BTRFS_I
(
šode
)->
i_Ùime
.tv_nsec;

9680 ià(
bi_æags
 & 
BTRFS_INODE_APPEND
)

9681 
¡©
->
©Œibu‹s
 |ð
STATX_ATTR_APPEND
;

9682 ià(
bi_æags
 & 
BTRFS_INODE_COMPRESS
)

9683 
¡©
->
©Œibu‹s
 |ð
STATX_ATTR_COMPRESSED
;

9684 ià(
bi_æags
 & 
BTRFS_INODE_IMMUTABLE
)

9685 
¡©
->
©Œibu‹s
 |ð
STATX_ATTR_IMMUTABLE
;

9686 ià(
bi_æags
 & 
BTRFS_INODE_NODUMP
)

9687 
¡©
->
©Œibu‹s
 |ð
STATX_ATTR_NODUMP
;

9689 
¡©
->
©Œibu‹s_mask
 |ð(
STATX_ATTR_APPEND
 |

9690 
STATX_ATTR_COMPRESSED
 |

9691 
STATX_ATTR_IMMUTABLE
 |

9692 
STATX_ATTR_NODUMP
);

9694 
	`g’”ic_fžÏ‰r
(
šode
, 
¡©
);

9695 
¡©
->
dev
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
ªÚ_dev
;

9697 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

9698 
d–®loc_by‹s
 = 
	`BTRFS_I
(
šode
)->
Ãw_d–®loc_by‹s
;

9699 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

9700 
¡©
->
blocks
 = (
	`ALIGN
(
	`šode_g‘_by‹s
(
šode
), 
blocksize
) +

9701 
	`ALIGN
(
d–®loc_by‹s
, 
blocksize
)) >> 9;

9703 
	}
}

9705 
	$bŒfs_»Çme_exchªge
(
šode
 *
Þd_dœ
,

9706 
d’Œy
 *
Þd_d’Œy
,

9707 
šode
 *
Ãw_dœ
,

9708 
d’Œy
 *
Ãw_d’Œy
)

9710 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Þd_dœ
->
i_sb
);

9711 
bŒfs_Œªs_hªdË
 *
Œªs
;

9712 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
Þd_dœ
)->root;

9713 
bŒfs_roÙ
 *
de¡
 = 
	`BTRFS_I
(
Ãw_dœ
)->
roÙ
;

9714 
šode
 *
Ãw_šode
 = 
Ãw_d’Œy
->
d_šode
;

9715 
šode
 *
Þd_šode
 = 
Þd_d’Œy
->
d_šode
;

9716 
time¥ec
 
ùime
 = 
	`cu¼’t_time
(
Þd_šode
);

9717 
d’Œy
 *
·»Á
;

9718 
u64
 
Þd_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
Þd_šode
));

9719 
u64
 
Ãw_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_šode
));

9720 
u64
 
Þd_idx
 = 0;

9721 
u64
 
Ãw_idx
 = 0;

9722 
u64
 
roÙ_objeùid
;

9723 
»t
;

9724 
boÞ
 
roÙ_log_pšÃd
 = 
çl£
;

9725 
boÞ
 
de¡_log_pšÃd
 = 
çl£
;

9728 ià(
Þd_šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
 && 
roÙ
 !ð
de¡
)

9729  -
EXDEV
;

9732 ià(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

9733 
	`down_»ad
(&
fs_šfo
->
subvÞ_£m
);

9734 ià(
Ãw_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

9735 
	`down_»ad
(&
fs_šfo
->
subvÞ_£m
);

9745 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 12);

9746 ià(
	`IS_ERR
(
Œªs
)) {

9747 
»t
 = 
	`PTR_ERR
(
Œªs
);

9748 
out_nÙ¿ns
;

9755 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
Ãw_dœ
), &
Þd_idx
);

9756 ià(
»t
)

9757 
out_çž
;

9758 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
Þd_dœ
), &
Ãw_idx
);

9759 ià(
»t
)

9760 
out_çž
;

9762 
	`BTRFS_I
(
Þd_šode
)->
dœ_šdex
 = 0ULL;

9763 
	`BTRFS_I
(
Ãw_šode
)->
dœ_šdex
 = 0ULL;

9766 ià(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

9768 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

9770 
	`bŒfs_pš_log_Œªs
(
roÙ
);

9771 
roÙ_log_pšÃd
 = 
Œue
;

9772 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
de¡
,

9773 
Ãw_d’Œy
->
d_Çme
.
Çme
,

9774 
Ãw_d’Œy
->
d_Çme
.
Ën
,

9775 
Þd_šo
,

9776 
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_dœ
)),

9777 
Þd_idx
);

9778 ià(
»t
)

9779 
out_çž
;

9783 ià(
Ãw_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

9785 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

9787 
	`bŒfs_pš_log_Œªs
(
de¡
);

9788 
de¡_log_pšÃd
 = 
Œue
;

9789 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
roÙ
,

9790 
Þd_d’Œy
->
d_Çme
.
Çme
,

9791 
Þd_d’Œy
->
d_Çme
.
Ën
,

9792 
Ãw_šo
,

9793 
	`bŒfs_šo
(
	`BTRFS_I
(
Þd_dœ
)),

9794 
Ãw_idx
);

9795 ià(
»t
)

9796 
out_çž
;

9800 
	`šode_šc_iv”siÚ
(
Þd_dœ
);

9801 
	`šode_šc_iv”siÚ
(
Ãw_dœ
);

9802 
	`šode_šc_iv”siÚ
(
Þd_šode
);

9803 
	`šode_šc_iv”siÚ
(
Ãw_šode
);

9804 
Þd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 = 
ùime
;

9805 
Ãw_dœ
->
i_ùime
 =‚ew_dœ->
i_mtime
 = 
ùime
;

9806 
Þd_šode
->
i_ùime
 = 
ùime
;

9807 
Ãw_šode
->
i_ùime
 = 
ùime
;

9809 ià(
Þd_d’Œy
->
d_·»Á
 !ð
Ãw_d’Œy
->d_parent) {

9810 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
Þd_dœ
),

9811 
	`BTRFS_I
(
Þd_šode
), 1);

9812 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
),

9813 
	`BTRFS_I
(
Ãw_šode
), 1);

9817 ià(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

9818 
roÙ_objeùid
 = 
	`BTRFS_I
(
Þd_šode
)->
roÙ
->
roÙ_key
.
objeùid
;

9819 
»t
 = 
	`bŒfs_uÆšk_subvÞ
(
Œªs
, 
roÙ
, 
Þd_dœ
,

9820 
roÙ_objeùid
,

9821 
Þd_d’Œy
->
d_Çme
.
Çme
,

9822 
Þd_d’Œy
->
d_Çme
.
Ën
);

9824 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
Þd_dœ
),

9825 
	`BTRFS_I
(
Þd_d’Œy
->
d_šode
),

9826 
Þd_d’Œy
->
d_Çme
.
Çme
,

9827 
Þd_d’Œy
->
d_Çme
.
Ën
);

9828 ià(!
»t
)

9829 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
Þd_šode
);

9831 ià(
»t
) {

9832 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9833 
out_çž
;

9837 ià(
Ãw_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

9838 
roÙ_objeùid
 = 
	`BTRFS_I
(
Ãw_šode
)->
roÙ
->
roÙ_key
.
objeùid
;

9839 
»t
 = 
	`bŒfs_uÆšk_subvÞ
(
Œªs
, 
de¡
, 
Ãw_dœ
,

9840 
roÙ_objeùid
,

9841 
Ãw_d’Œy
->
d_Çme
.
Çme
,

9842 
Ãw_d’Œy
->
d_Çme
.
Ën
);

9844 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
de¡
, 
	`BTRFS_I
(
Ãw_dœ
),

9845 
	`BTRFS_I
(
Ãw_d’Œy
->
d_šode
),

9846 
Ãw_d’Œy
->
d_Çme
.
Çme
,

9847 
Ãw_d’Œy
->
d_Çme
.
Ën
);

9848 ià(!
»t
)

9849 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
de¡
, 
Ãw_šode
);

9851 ià(
»t
) {

9852 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9853 
out_çž
;

9856 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
), BTRFS_I(
Þd_šode
),

9857 
Ãw_d’Œy
->
d_Çme
.
Çme
,

9858 
Ãw_d’Œy
->
d_Çme
.
Ën
, 0, 
Þd_idx
);

9859 ià(
»t
) {

9860 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9861 
out_çž
;

9864 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
Þd_dœ
), BTRFS_I(
Ãw_šode
),

9865 
Þd_d’Œy
->
d_Çme
.
Çme
,

9866 
Þd_d’Œy
->
d_Çme
.
Ën
, 0, 
Ãw_idx
);

9867 ià(
»t
) {

9868 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

9869 
out_çž
;

9872 ià(
Þd_šode
->
i_Æšk
 == 1)

9873 
	`BTRFS_I
(
Þd_šode
)->
dœ_šdex
 = 
Þd_idx
;

9874 ià(
Ãw_šode
->
i_Æšk
 == 1)

9875 
	`BTRFS_I
(
Ãw_šode
)->
dœ_šdex
 = 
Ãw_idx
;

9877 ià(
roÙ_log_pšÃd
) {

9878 
·»Á
 = 
Ãw_d’Œy
->
d_·»Á
;

9879 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
	`BTRFS_I
(
Þd_šode
), BTRFS_I(
Þd_dœ
),

9880 
·»Á
);

9881 
	`bŒfs_’d_log_Œªs
(
roÙ
);

9882 
roÙ_log_pšÃd
 = 
çl£
;

9884 ià(
de¡_log_pšÃd
) {

9885 
·»Á
 = 
Þd_d’Œy
->
d_·»Á
;

9886 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
	`BTRFS_I
(
Ãw_šode
), BTRFS_I(
Ãw_dœ
),

9887 
·»Á
);

9888 
	`bŒfs_’d_log_Œªs
(
de¡
);

9889 
de¡_log_pšÃd
 = 
çl£
;

9891 
out_çž
:

9903 ià(
»t
 && (
roÙ_log_pšÃd
 || 
de¡_log_pšÃd
)) {

9904 ià(
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Þd_dœ
), 
fs_šfo
->
g’”©iÚ
) ||

9905 
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Ãw_dœ
), 
fs_šfo
->
g’”©iÚ
) ||

9906 
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Þd_šode
), 
fs_šfo
->
g’”©iÚ
) ||

9907 (
Ãw_šode
 &&

9908 
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Ãw_šode
), 
fs_šfo
->
g’”©iÚ
)))

9909 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

9911 ià(
roÙ_log_pšÃd
) {

9912 
	`bŒfs_’d_log_Œªs
(
roÙ
);

9913 
roÙ_log_pšÃd
 = 
çl£
;

9915 ià(
de¡_log_pšÃd
) {

9916 
	`bŒfs_’d_log_Œªs
(
de¡
);

9917 
de¡_log_pšÃd
 = 
çl£
;

9920 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

9921 
out_nÙ¿ns
:

9922 ià(
Ãw_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

9923 
	`up_»ad
(&
fs_šfo
->
subvÞ_£m
);

9924 ià(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

9925 
	`up_»ad
(&
fs_šfo
->
subvÞ_£m
);

9927  
»t
;

9928 
	}
}

9930 
	$bŒfs_wh™eout_fÜ_»Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

9931 
bŒfs_roÙ
 *
roÙ
,

9932 
šode
 *
dœ
,

9933 
d’Œy
 *dentry)

9935 
»t
;

9936 
šode
 *inode;

9937 
u64
 
objeùid
;

9938 
u64
 
šdex
;

9940 
»t
 = 
	`bŒfs_fšd_ä“_šo
(
roÙ
, &
objeùid
);

9941 ià(
»t
)

9942  
»t
;

9944 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
roÙ
, 
dœ
,

9945 
d’Œy
->
d_Çme
.
Çme
,

9946 
d’Œy
->
d_Çme
.
Ën
,

9947 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)),

9948 
objeùid
,

9949 
S_IFCHR
 | 
WHITEOUT_MODE
,

9950 &
šdex
);

9952 ià(
	`IS_ERR
(
šode
)) {

9953 
»t
 = 
	`PTR_ERR
(
šode
);

9954  
»t
;

9957 
šode
->
i_Ý
 = &
bŒfs_¥ecŸl_šode_Ý”©iÚs
;

9958 
	`š™_¥ecŸl_šode
(
šode
, inode->
i_mode
,

9959 
WHITEOUT_DEV
);

9961 
»t
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
šode
, 
dœ
,

9962 &
d’Œy
->
d_Çme
);

9963 ià(
»t
)

9964 
out
;

9966 
»t
 = 
	`bŒfs_add_nÚdœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
d’Œy
,

9967 
	`BTRFS_I
(
šode
), 0, 
šdex
);

9968 ià(
»t
)

9969 
out
;

9971 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

9972 
out
:

9973 
	`uÆock_Ãw_šode
(
šode
);

9974 ià(
»t
)

9975 
	`šode_dec_lšk_couÁ
(
šode
);

9976 
	`ut
(
šode
);

9978  
»t
;

9979 
	}
}

9981 
	$bŒfs_»Çme
(
šode
 *
Þd_dœ
, 
d’Œy
 *
Þd_d’Œy
,

9982 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

9983 
æags
)

9985 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
Þd_dœ
->
i_sb
);

9986 
bŒfs_Œªs_hªdË
 *
Œªs
;

9987 
Œªs_num_™ems
;

9988 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
Þd_dœ
)->root;

9989 
bŒfs_roÙ
 *
de¡
 = 
	`BTRFS_I
(
Ãw_dœ
)->
roÙ
;

9990 
šode
 *
Ãw_šode
 = 
	`d_šode
(
Ãw_d’Œy
);

9991 
šode
 *
Þd_šode
 = 
	`d_šode
(
Þd_d’Œy
);

9992 
u64
 
šdex
 = 0;

9993 
u64
 
roÙ_objeùid
;

9994 
»t
;

9995 
u64
 
Þd_šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
Þd_šode
));

9996 
boÞ
 
log_pšÃd
 = 
çl£
;

9998 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_dœ
)è=ð
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)

9999  -
EPERM
;

10002 ià(
Þd_šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
 && 
roÙ
 !ð
de¡
)

10003  -
EXDEV
;

10005 ià(
Þd_šo
 =ð
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
 ||

10006 (
Ãw_šode
 && 
	`bŒfs_šo
(
	`BTRFS_I
Òew_šode)è=ð
BTRFS_FIRST_FREE_OBJECTID
))

10007  -
ENOTEMPTY
;

10009 ià(
	`S_ISDIR
(
Þd_šode
->
i_mode
è&& 
Ãw_šode
 &&

10010 
Ãw_šode
->
i_size
 > 
BTRFS_EMPTY_DIR_SIZE
)

10011  -
ENOTEMPTY
;

10015 
»t
 = 
	`bŒfs_check_dœ_™em_cÞlisiÚ
(
de¡
, 
Ãw_dœ
->
i_šo
,

10016 
Ãw_d’Œy
->
d_Çme
.
Çme
,

10017 
Ãw_d’Œy
->
d_Çme
.
Ën
);

10019 ià(
»t
) {

10020 ià(
»t
 =ð-
EEXIST
) {

10023 ià(
	`WARN_ON
(!
Ãw_šode
)) {

10024  
»t
;

10028  
»t
;

10031 
»t
 = 0;

10037 ià(
Ãw_šode
 && 
	`S_ISREG
(
Þd_šode
->
i_mode
è&&‚ew_šode->
i_size
)

10038 
	`fžem­_æush
(
Þd_šode
->
i_m­pšg
);

10041 ià(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

10042 
	`down_»ad
(&
fs_šfo
->
subvÞ_£m
);

10054 
Œªs_num_™ems
 = 11;

10055 ià(
æags
 & 
RENAME_WHITEOUT
)

10056 
Œªs_num_™ems
 += 5;

10057 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 
Œªs_num_™ems
);

10058 ià(
	`IS_ERR
(
Œªs
)) {

10059 
»t
 = 
	`PTR_ERR
(
Œªs
);

10060 
out_nÙ¿ns
;

10063 ià(
de¡
 !ð
roÙ
)

10064 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
de¡
);

10066 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
Ãw_dœ
), &
šdex
);

10067 ià(
»t
)

10068 
out_çž
;

10070 
	`BTRFS_I
(
Þd_šode
)->
dœ_šdex
 = 0ULL;

10071 ià(
	`uÆik–y
(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)) {

10073 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

10075 
	`bŒfs_pš_log_Œªs
(
roÙ
);

10076 
log_pšÃd
 = 
Œue
;

10077 
»t
 = 
	`bŒfs_š£¹_šode_»f
(
Œªs
, 
de¡
,

10078 
Ãw_d’Œy
->
d_Çme
.
Çme
,

10079 
Ãw_d’Œy
->
d_Çme
.
Ën
,

10080 
Þd_šo
,

10081 
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_dœ
)), 
šdex
);

10082 ià(
»t
)

10083 
out_çž
;

10086 
	`šode_šc_iv”siÚ
(
Þd_dœ
);

10087 
	`šode_šc_iv”siÚ
(
Ãw_dœ
);

10088 
	`šode_šc_iv”siÚ
(
Þd_šode
);

10089 
Þd_dœ
->
i_ùime
 = old_dœ->
i_mtime
 =

10090 
Ãw_dœ
->
i_ùime
 =‚ew_dœ->
i_mtime
 =

10091 
Þd_šode
->
i_ùime
 = 
	`cu¼’t_time
(
Þd_dœ
);

10093 ià(
Þd_d’Œy
->
d_·»Á
 !ð
Ãw_d’Œy
->d_parent)

10094 
	`bŒfs_»cÜd_uÆšk_dœ
(
Œªs
, 
	`BTRFS_I
(
Þd_dœ
),

10095 
	`BTRFS_I
(
Þd_šode
), 1);

10097 ià(
	`uÆik–y
(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)) {

10098 
roÙ_objeùid
 = 
	`BTRFS_I
(
Þd_šode
)->
roÙ
->
roÙ_key
.
objeùid
;

10099 
»t
 = 
	`bŒfs_uÆšk_subvÞ
(
Œªs
, 
roÙ
, 
Þd_dœ
, 
roÙ_objeùid
,

10100 
Þd_d’Œy
->
d_Çme
.
Çme
,

10101 
Þd_d’Œy
->
d_Çme
.
Ën
);

10103 
»t
 = 
	`__bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
Þd_dœ
),

10104 
	`BTRFS_I
(
	`d_šode
(
Þd_d’Œy
)),

10105 
Þd_d’Œy
->
d_Çme
.
Çme
,

10106 
Þd_d’Œy
->
d_Çme
.
Ën
);

10107 ià(!
»t
)

10108 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
Þd_šode
);

10110 ià(
»t
) {

10111 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10112 
out_çž
;

10115 ià(
Ãw_šode
) {

10116 
	`šode_šc_iv”siÚ
(
Ãw_šode
);

10117 
Ãw_šode
->
i_ùime
 = 
	`cu¼’t_time
(new_inode);

10118 ià(
	`uÆik–y
(
	`bŒfs_šo
(
	`BTRFS_I
(
Ãw_šode
)) ==

10119 
BTRFS_EMPTY_SUBVOL_DIR_OBJECTID
)) {

10120 
roÙ_objeùid
 = 
	`BTRFS_I
(
Ãw_šode
)->
loÿtiÚ
.
objeùid
;

10121 
»t
 = 
	`bŒfs_uÆšk_subvÞ
(
Œªs
, 
de¡
, 
Ãw_dœ
,

10122 
roÙ_objeùid
,

10123 
Ãw_d’Œy
->
d_Çme
.
Çme
,

10124 
Ãw_d’Œy
->
d_Çme
.
Ën
);

10125 
	`BUG_ON
(
Ãw_šode
->
i_Æšk
 == 0);

10127 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
de¡
, 
	`BTRFS_I
(
Ãw_dœ
),

10128 
	`BTRFS_I
(
	`d_šode
(
Ãw_d’Œy
)),

10129 
Ãw_d’Œy
->
d_Çme
.
Çme
,

10130 
Ãw_d’Œy
->
d_Çme
.
Ën
);

10132 ià(!
»t
 && 
Ãw_šode
->
i_Æšk
 == 0)

10133 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
,

10134 
	`BTRFS_I
(
	`d_šode
(
Ãw_d’Œy
)));

10135 ià(
»t
) {

10136 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10137 
out_çž
;

10141 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
Ãw_dœ
), BTRFS_I(
Þd_šode
),

10142 
Ãw_d’Œy
->
d_Çme
.
Çme
,

10143 
Ãw_d’Œy
->
d_Çme
.
Ën
, 0, 
šdex
);

10144 ià(
»t
) {

10145 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10146 
out_çž
;

10149 ià(
Þd_šode
->
i_Æšk
 == 1)

10150 
	`BTRFS_I
(
Þd_šode
)->
dœ_šdex
 = 
šdex
;

10152 ià(
log_pšÃd
) {

10153 
d’Œy
 *
·»Á
 = 
Ãw_d’Œy
->
d_·»Á
;

10155 
	`bŒfs_log_Ãw_Çme
(
Œªs
, 
	`BTRFS_I
(
Þd_šode
), BTRFS_I(
Þd_dœ
),

10156 
·»Á
);

10157 
	`bŒfs_’d_log_Œªs
(
roÙ
);

10158 
log_pšÃd
 = 
çl£
;

10161 ià(
æags
 & 
RENAME_WHITEOUT
) {

10162 
»t
 = 
	`bŒfs_wh™eout_fÜ_»Çme
(
Œªs
, 
roÙ
, 
Þd_dœ
,

10163 
Þd_d’Œy
);

10165 ià(
»t
) {

10166 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10167 
out_çž
;

10170 
out_çž
:

10182 ià(
»t
 && 
log_pšÃd
) {

10183 ià(
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Þd_dœ
), 
fs_šfo
->
g’”©iÚ
) ||

10184 
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Ãw_dœ
), 
fs_šfo
->
g’”©iÚ
) ||

10185 
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Þd_šode
), 
fs_šfo
->
g’”©iÚ
) ||

10186 (
Ãw_šode
 &&

10187 
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
Ãw_šode
), 
fs_šfo
->
g’”©iÚ
)))

10188 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

10190 
	`bŒfs_’d_log_Œªs
(
roÙ
);

10191 
log_pšÃd
 = 
çl£
;

10193 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10194 
out_nÙ¿ns
:

10195 ià(
Þd_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

10196 
	`up_»ad
(&
fs_šfo
->
subvÞ_£m
);

10198  
»t
;

10199 
	}
}

10201 
	$bŒfs_»Çme2
(
šode
 *
Þd_dœ
, 
d’Œy
 *
Þd_d’Œy
,

10202 
šode
 *
Ãw_dœ
, 
d’Œy
 *
Ãw_d’Œy
,

10203 
æags
)

10205 ià(
æags
 & ~(
RENAME_NOREPLACE
 | 
RENAME_EXCHANGE
 | 
RENAME_WHITEOUT
))

10206  -
EINVAL
;

10208 ià(
æags
 & 
RENAME_EXCHANGE
)

10209  
	`bŒfs_»Çme_exchªge
(
Þd_dœ
, 
Þd_d’Œy
, 
Ãw_dœ
,

10210 
Ãw_d’Œy
);

10212  
	`bŒfs_»Çme
(
Þd_dœ
, 
Þd_d’Œy
, 
Ãw_dœ
, 
Ãw_d’Œy
, 
æags
);

10213 
	}
}

10215 
	$bŒfs_run_d–®loc_wÜk
(
bŒfs_wÜk
 *
wÜk
)

10217 
bŒfs_d–®loc_wÜk
 *
d–®loc_wÜk
;

10218 
šode
 *inode;

10220 
d–®loc_wÜk
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_d–®loc_wÜk
,

10221 
wÜk
);

10222 
šode
 = 
d–®loc_wÜk
->inode;

10223 
	`fžem­_æush
(
šode
->
i_m­pšg
);

10224 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

10225 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

10226 
	`fžem­_æush
(
šode
->
i_m­pšg
);

10228 ià(
d–®loc_wÜk
->
d–ay_ut
)

10229 
	`bŒfs_add_d–ayed_ut
(
šode
);

10231 
	`ut
(
šode
);

10232 
	`com¶‘e
(&
d–®loc_wÜk
->
com¶‘iÚ
);

10233 
	}
}

10235 
bŒfs_d–®loc_wÜk
 *
	$bŒfs_®loc_d–®loc_wÜk
(
šode
 *inode,

10236 
d–ay_ut
)

10238 
bŒfs_d–®loc_wÜk
 *
wÜk
;

10240 
wÜk
 = 
	`km®loc
((*wÜk), 
GFP_NOFS
);

10241 ià(!
wÜk
)

10242  
NULL
;

10244 
	`š™_com¶‘iÚ
(&
wÜk
->
com¶‘iÚ
);

10245 
	`INIT_LIST_HEAD
(&
wÜk
->
li¡
);

10246 
wÜk
->
šode
 = inode;

10247 
wÜk
->
d–ay_ut
 = delay_iput;

10248 
	`WARN_ON_ONCE
(!
šode
);

10249 
	`bŒfs_š™_wÜk
(&
wÜk
->wÜk, 
bŒfs_æush_d–®loc_h–³r
,

10250 
bŒfs_run_d–®loc_wÜk
, 
NULL
, NULL);

10252  
wÜk
;

10253 
	}
}

10255 
	$bŒfs_wa™_ªd_ä“_d–®loc_wÜk
(
bŒfs_d–®loc_wÜk
 *
wÜk
)

10257 
	`wa™_fÜ_com¶‘iÚ
(&
wÜk
->
com¶‘iÚ
);

10258 
	`kä“
(
wÜk
);

10259 
	}
}

10265 
	$__¡¬t_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
, 
d–ay_ut
,

10266 
Ä
)

10268 
bŒfs_šode
 *
bšode
;

10269 
šode
 *inode;

10270 
bŒfs_d–®loc_wÜk
 *
wÜk
, *
Ãxt
;

10271 
li¡_h—d
 
wÜks
;

10272 
li¡_h—d
 
¥liû
;

10273 
»t
 = 0;

10275 
	`INIT_LIST_HEAD
(&
wÜks
);

10276 
	`INIT_LIST_HEAD
(&
¥liû
);

10278 
	`mu‹x_lock
(&
roÙ
->
d–®loc_mu‹x
);

10279 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

10280 
	`li¡_¥liû_š™
(&
roÙ
->
d–®loc_šodes
, &
¥liû
);

10281 !
	`li¡_em±y
(&
¥liû
)) {

10282 
bšode
 = 
	`li¡_’Œy
(
¥liû
.
Ãxt
, 
bŒfs_šode
,

10283 
d–®loc_šodes
);

10285 
	`li¡_move_ž
(&
bšode
->
d–®loc_šodes
,

10286 &
roÙ
->
d–®loc_šodes
);

10287 
šode
 = 
	`ig¿b
(&
bšode
->
vfs_šode
);

10288 ià(!
šode
) {

10289 
	`cÚd_»sched_lock
(&
roÙ
->
d–®loc_lock
);

10292 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

10294 
wÜk
 = 
	`bŒfs_®loc_d–®loc_wÜk
(
šode
, 
d–ay_ut
);

10295 ià(!
wÜk
) {

10296 ià(
d–ay_ut
)

10297 
	`bŒfs_add_d–ayed_ut
(
šode
);

10299 
	`ut
(
šode
);

10300 
»t
 = -
ENOMEM
;

10301 
out
;

10303 
	`li¡_add_ž
(&
wÜk
->
li¡
, &
wÜks
);

10304 
	`bŒfs_queue_wÜk
(
roÙ
->
fs_šfo
->
æush_wÜk”s
,

10305 &
wÜk
->work);

10306 
»t
++;

10307 ià(
Ä
 !ð-1 && 
»t
 >=‚r)

10308 
out
;

10309 
	`cÚd_»sched
();

10310 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

10312 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

10314 
out
:

10315 
	`li¡_fÜ_—ch_’Œy_§ã
(
wÜk
, 
Ãxt
, &
wÜks
, 
li¡
) {

10316 
	`li¡_d–_š™
(&
wÜk
->
li¡
);

10317 
	`bŒfs_wa™_ªd_ä“_d–®loc_wÜk
(
wÜk
);

10320 ià(!
	`li¡_em±y_ÿ»ful
(&
¥liû
)) {

10321 
	`¥š_lock
(&
roÙ
->
d–®loc_lock
);

10322 
	`li¡_¥liû_ž
(&
¥liû
, &
roÙ
->
d–®loc_šodes
);

10323 
	`¥š_uÆock
(&
roÙ
->
d–®loc_lock
);

10325 
	`mu‹x_uÆock
(&
roÙ
->
d–®loc_mu‹x
);

10326  
»t
;

10327 
	}
}

10329 
	$bŒfs_¡¬t_d–®loc_šodes
(
bŒfs_roÙ
 *
roÙ
, 
d–ay_ut
)

10331 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

10332 
»t
;

10334 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
))

10335  -
EROFS
;

10337 
»t
 = 
	`__¡¬t_d–®loc_šodes
(
roÙ
, 
d–ay_ut
, -1);

10338 ià(
»t
 > 0)

10339 
»t
 = 0;

10345 
	`©omic_šc
(&
fs_šfo
->
async_subm™_d¿ššg
);

10346 
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) ||

10347 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
)) {

10348 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

10349 (
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) == 0 &&

10350 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
) == 0));

10352 
	`©omic_dec
(&
fs_šfo
->
async_subm™_d¿ššg
);

10353  
»t
;

10354 
	}
}

10356 
	$bŒfs_¡¬t_d–®loc_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
d–ay_ut
,

10357 
Ä
)

10359 
bŒfs_roÙ
 *
roÙ
;

10360 
li¡_h—d
 
¥liû
;

10361 
»t
;

10363 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
))

10364  -
EROFS
;

10366 
	`INIT_LIST_HEAD
(&
¥liû
);

10368 
	`mu‹x_lock
(&
fs_šfo
->
d–®loc_roÙ_mu‹x
);

10369 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10370 
	`li¡_¥liû_š™
(&
fs_šfo
->
d–®loc_roÙs
, &
¥liû
);

10371 !
	`li¡_em±y
(&
¥liû
è&& 
Ä
) {

10372 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

10373 
d–®loc_roÙ
);

10374 
roÙ
 = 
	`bŒfs_g¿b_fs_roÙ
(root);

10375 
	`BUG_ON
(!
roÙ
);

10376 
	`li¡_move_ž
(&
roÙ
->
d–®loc_roÙ
,

10377 &
fs_šfo
->
d–®loc_roÙs
);

10378 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10380 
»t
 = 
	`__¡¬t_d–®loc_šodes
(
roÙ
, 
d–ay_ut
, 
Ä
);

10381 
	`bŒfs_put_fs_roÙ
(
roÙ
);

10382 ià(
»t
 < 0)

10383 
out
;

10385 ià(
Ä
 != -1) {

10386 
Ä
 -ð
»t
;

10387 
	`WARN_ON
(
Ä
 < 0);

10389 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10391 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10393 
»t
 = 0;

10394 
	`©omic_šc
(&
fs_šfo
->
async_subm™_d¿ššg
);

10395 
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) ||

10396 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
)) {

10397 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

10398 (
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) == 0 &&

10399 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
) == 0));

10401 
	`©omic_dec
(&
fs_šfo
->
async_subm™_d¿ššg
);

10402 
out
:

10403 ià(!
	`li¡_em±y_ÿ»ful
(&
¥liû
)) {

10404 
	`¥š_lock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10405 
	`li¡_¥liû_ž
(&
¥liû
, &
fs_šfo
->
d–®loc_roÙs
);

10406 
	`¥š_uÆock
(&
fs_šfo
->
d–®loc_roÙ_lock
);

10408 
	`mu‹x_uÆock
(&
fs_šfo
->
d–®loc_roÙ_mu‹x
);

10409  
»t
;

10410 
	}
}

10412 
	$bŒfs_symlšk
(
šode
 *
dœ
, 
d’Œy
 *dentry,

10413 cÚ¡ *
symÇme
)

10415 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

10416 
bŒfs_Œªs_hªdË
 *
Œªs
;

10417 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

10418 
bŒfs_·th
 *
·th
;

10419 
bŒfs_key
 
key
;

10420 
šode
 *šodð
NULL
;

10421 
”r
;

10422 
drÝ_šode
 = 0;

10423 
u64
 
objeùid
;

10424 
u64
 
šdex
 = 0;

10425 
Çme_Ën
;

10426 
d©asize
;

10427 
±r
;

10428 
bŒfs_fže_ex‹Á_™em
 *
ei
;

10429 
ex‹Á_bufãr
 *
Ëaf
;

10431 
Çme_Ën
 = 
	`¡¾’
(
symÇme
);

10432 ià(
Çme_Ën
 > 
	`BTRFS_MAX_INLINE_DATA_SIZE
(
fs_šfo
))

10433  -
ENAMETOOLONG
;

10442 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 7);

10443 ià(
	`IS_ERR
(
Œªs
))

10444  
	`PTR_ERR
(
Œªs
);

10446 
”r
 = 
	`bŒfs_fšd_ä“_šo
(
roÙ
, &
objeùid
);

10447 ià(
”r
)

10448 
out_uÆock
;

10450 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
roÙ
, 
dœ
, 
d’Œy
->
d_Çme
.
Çme
,

10451 
d’Œy
->
d_Çme
.
Ën
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)),

10452 
objeùid
, 
S_IFLNK
|
S_IRWXUGO
, &
šdex
);

10453 ià(
	`IS_ERR
(
šode
)) {

10454 
”r
 = 
	`PTR_ERR
(
šode
);

10455 
out_uÆock
;

10464 
šode
->
i_fÝ
 = &
bŒfs_fže_Ý”©iÚs
;

10465 
šode
->
i_Ý
 = &
bŒfs_fže_šode_Ý”©iÚs
;

10466 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒfs_aÝs
;

10467 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Ýs
 = &
bŒfs_ex‹Á_io_Ýs
;

10469 
”r
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
šode
, 
dœ
, &
d’Œy
->
d_Çme
);

10470 ià(
”r
)

10471 
out_uÆock_šode
;

10473 
·th
 = 
	`bŒfs_®loc_·th
();

10474 ià(!
·th
) {

10475 
”r
 = -
ENOMEM
;

10476 
out_uÆock_šode
;

10478 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

10479 
key
.
off£t
 = 0;

10480 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

10481 
d©asize
 = 
	`bŒfs_fže_ex‹Á_ÿlc_šlše_size
(
Çme_Ën
);

10482 
”r
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

10483 
d©asize
);

10484 ià(
”r
) {

10485 
	`bŒfs_ä“_·th
(
·th
);

10486 
out_uÆock_šode
;

10488 
Ëaf
 = 
·th
->
nodes
[0];

10489 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

10490 
bŒfs_fže_ex‹Á_™em
);

10491 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
ei
, 
Œªs
->
Œªsid
);

10492 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
ei
,

10493 
BTRFS_FILE_EXTENT_INLINE
);

10494 
	`bŒfs_£t_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
ei
, 0);

10495 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
ei
, 0);

10496 
	`bŒfs_£t_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
ei
, 0);

10497 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
ei
, 
Çme_Ën
);

10499 
±r
 = 
	`bŒfs_fže_ex‹Á_šlše_¡¬t
(
ei
);

10500 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
symÇme
, 
±r
, 
Çme_Ën
);

10501 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

10502 
	`bŒfs_ä“_·th
(
·th
);

10504 
šode
->
i_Ý
 = &
bŒfs_symlšk_šode_Ý”©iÚs
;

10505 
	`šode_nohighmem
(
šode
);

10506 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒfs_symlšk_aÝs
;

10507 
	`šode_£t_by‹s
(
šode
, 
Çme_Ën
);

10508 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
Çme_Ën
);

10509 
”r
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

10515 ià(!
”r
)

10516 
”r
 = 
	`bŒfs_add_nÚdœ
(
Œªs
, 
	`BTRFS_I
(
dœ
), 
d’Œy
,

10517 
	`BTRFS_I
(
šode
), 0, 
šdex
);

10518 ià(
”r
) {

10519 
drÝ_šode
 = 1;

10520 
out_uÆock_šode
;

10523 
	`uÆock_Ãw_šode
(
šode
);

10524 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

10526 
out_uÆock
:

10527 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10528 ià(
drÝ_šode
) {

10529 
	`šode_dec_lšk_couÁ
(
šode
);

10530 
	`ut
(
šode
);

10532 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

10533  
”r
;

10535 
out_uÆock_šode
:

10536 
drÝ_šode
 = 1;

10537 
	`uÆock_Ãw_šode
(
šode
);

10538 
out_uÆock
;

10539 
	}
}

10541 
	$__bŒfs_´—Îoc_fže_¿nge
(
šode
 *šode, 
mode
,

10542 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

10543 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
,

10544 
bŒfs_Œªs_hªdË
 *
Œªs
)

10546 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

10547 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

10548 
ex‹Á_m­
 *
em
;

10549 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

10550 
bŒfs_key
 
šs
;

10551 
u64
 
cur_off£t
 = 
¡¬t
;

10552 
u64
 
i_size
;

10553 
u64
 
cur_by‹s
;

10554 
u64
 
Ï¡_®loc
 = (u64)-1;

10555 
»t
 = 0;

10556 
boÞ
 
own_Œªs
 = 
Œue
;

10557 
u64
 
’d
 = 
¡¬t
 + 
num_by‹s
 - 1;

10559 ià(
Œªs
)

10560 
own_Œªs
 = 
çl£
;

10561 
num_by‹s
 > 0) {

10562 ià(
own_Œªs
) {

10563 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

10564 ià(
	`IS_ERR
(
Œªs
)) {

10565 
»t
 = 
	`PTR_ERR
(
Œªs
);

10570 
cur_by‹s
 = 
	`mš_t
(
u64
, 
num_by‹s
, 
SZ_256M
);

10571 
cur_by‹s
 = 
	`max
(cur_by‹s, 
mš_size
);

10578 
cur_by‹s
 = 
	`mš
(cur_by‹s, 
Ï¡_®loc
);

10579 
»t
 = 
	`bŒfs_»£rve_ex‹Á
(
roÙ
, 
cur_by‹s
, cur_bytes,

10580 
mš_size
, 0, *
®loc_hšt
, &
šs
, 1, 0);

10581 ià(
»t
) {

10582 ià(
own_Œªs
)

10583 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10586 
	`bŒfs_dec_block_group_»£rv©iÚs
(
fs_šfo
, 
šs
.
objeùid
);

10588 
Ï¡_®loc
 = 
šs
.
off£t
;

10589 
»t
 = 
	`š£¹_»£rved_fže_ex‹Á
(
Œªs
, 
šode
,

10590 
cur_off£t
, 
šs
.
objeùid
,

10591 
šs
.
off£t
, ins.offset,

10592 
šs
.
off£t
, 0, 0, 0,

10593 
BTRFS_FILE_EXTENT_PREALLOC
);

10594 ià(
»t
) {

10595 
	`bŒfs_ä“_»£rved_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
,

10596 
šs
.
off£t
, 0);

10597 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10598 ià(
own_Œªs
)

10599 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10603 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
cur_off£t
,

10604 
cur_off£t
 + 
šs
.
off£t
 -1, 0);

10606 
em
 = 
	`®loc_ex‹Á_m­
();

10607 ià(!
em
) {

10608 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

10609 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

10610 
Ãxt
;

10613 
em
->
¡¬t
 = 
cur_off£t
;

10614 
em
->
Üig_¡¬t
 = 
cur_off£t
;

10615 
em
->
Ën
 = 
šs
.
off£t
;

10616 
em
->
block_¡¬t
 = 
šs
.
objeùid
;

10617 
em
->
block_Ën
 = 
šs
.
off£t
;

10618 
em
->
Üig_block_Ën
 = 
šs
.
off£t
;

10619 
em
->
¿m_by‹s
 = 
šs
.
off£t
;

10620 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

10621 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
);

10622 
em
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

10625 
	`wr™e_lock
(&
em_Œ“
->
lock
);

10626 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 1);

10627 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

10628 ià(
»t
 !ð-
EEXIST
)

10630 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
cur_off£t
,

10631 
cur_off£t
 + 
šs
.
off£t
 - 1,

10634 
	`ä“_ex‹Á_m­
(
em
);

10635 
Ãxt
:

10636 
num_by‹s
 -ð
šs
.
off£t
;

10637 
cur_off£t
 +ð
šs
.
off£t
;

10638 *
®loc_hšt
 = 
šs
.
objeùid
 + ins.
off£t
;

10640 
	`šode_šc_iv”siÚ
(
šode
);

10641 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

10642 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_PREALLOC
;

10643 ià(!(
mode
 & 
FALLOC_FL_KEEP_SIZE
) &&

10644 (
aùu®_Ën
 > 
šode
->
i_size
) &&

10645 (
cur_off£t
 > 
šode
->
i_size
)) {

10646 ià(
cur_off£t
 > 
aùu®_Ën
)

10647 
i_size
 = 
aùu®_Ën
;

10649 
i_size
 = 
cur_off£t
;

10650 
	`i_size_wr™e
(
šode
, 
i_size
);

10651 
	`bŒfs_Üd”ed_upd©e_i_size
(
šode
, 
i_size
, 
NULL
);

10654 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

10656 ià(
»t
) {

10657 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

10658 ià(
own_Œªs
)

10659 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10663 ià(
own_Œªs
)

10664 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10666 ià(
cur_off£t
 < 
’d
)

10667 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
NULL
, 
cur_off£t
,

10668 
’d
 - 
cur_off£t
 + 1);

10669  
»t
;

10670 
	}
}

10672 
	$bŒfs_´—Îoc_fže_¿nge
(
šode
 *šode, 
mode
,

10673 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

10674 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
)

10676  
	`__bŒfs_´—Îoc_fže_¿nge
(
šode
, 
mode
, 
¡¬t
, 
num_by‹s
,

10677 
mš_size
, 
aùu®_Ën
, 
®loc_hšt
,

10678 
NULL
);

10679 
	}
}

10681 
	$bŒfs_´—Îoc_fže_¿nge_Œªs
(
šode
 *inode,

10682 
bŒfs_Œªs_hªdË
 *
Œªs
, 
mode
,

10683 
u64
 
¡¬t
, u64 
num_by‹s
, u64 
mš_size
,

10684 
loff_t
 
aùu®_Ën
, 
u64
 *
®loc_hšt
)

10686  
	`__bŒfs_´—Îoc_fže_¿nge
(
šode
, 
mode
, 
¡¬t
, 
num_by‹s
,

10687 
mš_size
, 
aùu®_Ën
, 
®loc_hšt
, 
Œªs
);

10688 
	}
}

10690 
	$bŒfs_£t_·ge_dœty
(
·ge
 *page)

10692  
	`__£t_·ge_dœty_nobufãrs
(
·ge
);

10693 
	}
}

10695 
	$bŒfs_³rmissiÚ
(
šode
 *šode, 
mask
)

10697 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

10698 
umode_t
 
mode
 = 
šode
->
i_mode
;

10700 ià(
mask
 & 
MAY_WRITE
 &&

10701 (
	`S_ISREG
(
mode
è|| 
	`S_ISDIR
(modeè|| 
	`S_ISLNK
(mode))) {

10702 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

10703  -
EROFS
;

10704 ià(
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_READONLY
)

10705  -
EACCES
;

10707  
	`g’”ic_³rmissiÚ
(
šode
, 
mask
);

10708 
	}
}

10710 
	$bŒfs_tmpfže
(
šode
 *
dœ
, 
d’Œy
 *d’Œy, 
umode_t
 
mode
)

10712 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

10713 
bŒfs_Œªs_hªdË
 *
Œªs
;

10714 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

10715 
šode
 *šodð
NULL
;

10716 
u64
 
objeùid
;

10717 
u64
 
šdex
;

10718 
»t
 = 0;

10723 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 5);

10724 ià(
	`IS_ERR
(
Œªs
))

10725  
	`PTR_ERR
(
Œªs
);

10727 
»t
 = 
	`bŒfs_fšd_ä“_šo
(
roÙ
, &
objeùid
);

10728 ià(
»t
)

10729 
out
;

10731 
šode
 = 
	`bŒfs_Ãw_šode
(
Œªs
, 
roÙ
, 
dœ
, 
NULL
, 0,

10732 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)), 
objeùid
, 
mode
, &
šdex
);

10733 ià(
	`IS_ERR
(
šode
)) {

10734 
»t
 = 
	`PTR_ERR
(
šode
);

10735 
šode
 = 
NULL
;

10736 
out
;

10739 
šode
->
i_fÝ
 = &
bŒfs_fže_Ý”©iÚs
;

10740 
šode
->
i_Ý
 = &
bŒfs_fže_šode_Ý”©iÚs
;

10742 
šode
->
i_m­pšg
->
a_Ýs
 = &
bŒfs_aÝs
;

10743 
	`BTRFS_I
(
šode
)->
io_Œ“
.
Ýs
 = &
bŒfs_ex‹Á_io_Ýs
;

10745 
»t
 = 
	`bŒfs_š™_šode_£cur™y
(
Œªs
, 
šode
, 
dœ
, 
NULL
);

10746 ià(
»t
)

10747 
out_šode
;

10749 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

10750 ià(
»t
)

10751 
out_šode
;

10752 
»t
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

10753 ià(
»t
)

10754 
out_šode
;

10763 
	`£t_Æšk
(
šode
, 1);

10764 
	`uÆock_Ãw_šode
(
šode
);

10765 
	`d_tmpfže
(
d’Œy
, 
šode
);

10766 
	`m¬k_šode_dœty
(
šode
);

10768 
out
:

10769 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

10770 ià(
»t
)

10771 
	`ut
(
šode
);

10772 
	`bŒfs_b®ªû_d–ayed_™ems
(
fs_šfo
);

10773 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

10774  
»t
;

10776 
out_šode
:

10777 
	`uÆock_Ãw_šode
(
šode
);

10778 
out
;

10780 
	}
}

10782 
__©Œibu‹__
((const))

10783 
	$bŒfs_»ad·ge_io_çžed_hook
(
·ge
 *·ge, 
çžed_mœrÜ
)

10785  -
EAGAIN
;

10786 
	}
}

10788 
bŒfs_fs_šfo
 *
	$iÙ»e_fs_šfo
(*
´iv©e_d©a
)

10790 
šode
 *šodð
´iv©e_d©a
;

10791  
	`bŒfs_sb
(
šode
->
i_sb
);

10792 
	}
}

10794 
	$bŒfs_check_ex‹Á_io_¿nge
(*
´iv©e_d©a
, cÚ¡ *
ÿÎ”
,

10795 
u64
 
¡¬t
, u64 
’d
)

10797 
šode
 *šodð
´iv©e_d©a
;

10798 
u64
 
isize
;

10800 
isize
 = 
	`i_size_»ad
(
šode
);

10801 ià(
’d
 >ð
PAGE_SIZE
 && (’d % 2è=ð0 &&ƒnd !ð
isize
 - 1) {

10802 
	`bŒfs_debug_¾
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

10804 
ÿÎ”
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
isize
, 
¡¬t
, 
’d
);

10806 
	}
}

10808 
	$bŒfs_£t_¿nge_wr™eback
(*
´iv©e_d©a
, 
u64
 
¡¬t
, u64 
’d
)

10810 
šode
 *šodð
´iv©e_d©a
;

10811 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

10812 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

10813 
·ge
 *page;

10815 
šdex
 <ð
’d_šdex
) {

10816 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
, 
šdex
);

10817 
	`ASSERT
(
·ge
);

10818 
	`£t_·ge_wr™eback
(
·ge
);

10819 
	`put_·ge
(
·ge
);

10820 
šdex
++;

10822 
	}
}

10824 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_dœ_šode_Ý”©iÚs
 = {

10825 .
g‘©Œ
 = 
bŒfs_g‘©Œ
,

10826 .
	glookup
 = 
bŒfs_lookup
,

10827 .
	gü—‹
 = 
bŒfs_ü—‹
,

10828 .
	guÆšk
 = 
bŒfs_uÆšk
,

10829 .
	glšk
 = 
bŒfs_lšk
,

10830 .
	gmkdœ
 = 
bŒfs_mkdœ
,

10831 .
	grmdœ
 = 
bŒfs_rmdœ
,

10832 .
	g»Çme
 = 
bŒfs_»Çme2
,

10833 .
	gsymlšk
 = 
bŒfs_symlšk
,

10834 .
	g£‰r
 = 
bŒfs_£‰r
,

10835 .
	gmknod
 = 
bŒfs_mknod
,

10836 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

10837 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

10838 .
	gg‘_aþ
 = 
bŒfs_g‘_aþ
,

10839 .
	g£t_aþ
 = 
bŒfs_£t_aþ
,

10840 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

10841 .
	gtmpfže
 = 
bŒfs_tmpfže
,

10843 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_dœ_ro_šode_Ý”©iÚs
 = {

10844 .
lookup
 = 
bŒfs_lookup
,

10845 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

10846 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

10849 cÚ¡ 
fže_Ý”©iÚs
 
	gbŒfs_dœ_fže_Ý”©iÚs
 = {

10850 .
Î£ek
 = 
g’”ic_fže_Î£ek
,

10851 .
	g»ad
 = 
g’”ic_»ad_dœ
,

10852 .
	g™”©e_sh¬ed
 = 
bŒfs_»®_»addœ
,

10853 .
	gÝ’
 = 
bŒfs_Ý’dœ
,

10854 .
	guÆocked_ioùl
 = 
bŒfs_ioùl
,

10855 #ifdeà
CONFIG_COMPAT


10856 .
	gcom·t_ioùl
 = 
bŒfs_com·t_ioùl
,

10858 .
	g»Ëa£
 = 
bŒfs_»Ëa£_fže
,

10859 .
	gfsync
 = 
bŒfs_sync_fže
,

10862 cÚ¡ 
ex‹Á_io_Ýs
 
	gbŒfs_ex‹Á_io_Ýs
 = {

10864 .
subm™_bio_hook
 = 
bŒfs_subm™_bio_hook
,

10865 .
	g»ad·ge_’d_io_hook
 = 
bŒfs_»ad·ge_’d_io_hook
,

10866 .
	gm”ge_bio_hook
 = 
bŒfs_m”ge_bio_hook
,

10867 .
	g»ad·ge_io_çžed_hook
 = 
bŒfs_»ad·ge_io_çžed_hook
,

10868 .
	gŒ“_fs_šfo
 = 
iÙ»e_fs_šfo
,

10869 .
	g£t_¿nge_wr™eback
 = 
bŒfs_£t_¿nge_wr™eback
,

10872 .
	gfžl_d–®loc
 = 
run_d–®loc_¿nge
,

10873 .
	gwr™•age_’d_io_hook
 = 
bŒfs_wr™•age_’d_io_hook
,

10874 .
	gwr™•age_¡¬t_hook
 = 
bŒfs_wr™•age_¡¬t_hook
,

10875 .
	g£t_b™_hook
 = 
bŒfs_£t_b™_hook
,

10876 .
	gþ—r_b™_hook
 = 
bŒfs_þ—r_b™_hook
,

10877 .
	gm”ge_ex‹Á_hook
 = 
bŒfs_m”ge_ex‹Á_hook
,

10878 .
	g¥l™_ex‹Á_hook
 = 
bŒfs_¥l™_ex‹Á_hook
,

10879 .
	gcheck_ex‹Á_io_¿nge
 = 
bŒfs_check_ex‹Á_io_¿nge
,

10894 cÚ¡ 
add»ss_¥aû_Ý”©iÚs
 
	gbŒfs_aÝs
 = {

10895 .
»ad·ge
 = 
bŒfs_»ad·ge
,

10896 .
	gwr™•age
 = 
bŒfs_wr™•age
,

10897 .
	gwr™•ages
 = 
bŒfs_wr™•ages
,

10898 .
	g»ad·ges
 = 
bŒfs_»ad·ges
,

10899 .
	gdœeù_IO
 = 
bŒfs_dœeù_IO
,

10900 .
	gšv®id©•age
 = 
bŒfs_šv®id©•age
,

10901 .
	g»Ëa£·ge
 = 
bŒfs_»Ëa£·ge
,

10902 .
	g£t_·ge_dœty
 = 
bŒfs_£t_·ge_dœty
,

10903 .
	g”rÜ_»move_·ge
 = 
g’”ic_”rÜ_»move_·ge
,

10906 cÚ¡ 
add»ss_¥aû_Ý”©iÚs
 
	gbŒfs_symlšk_aÝs
 = {

10907 .
»ad·ge
 = 
bŒfs_»ad·ge
,

10908 .
	gwr™•age
 = 
bŒfs_wr™•age
,

10909 .
	gšv®id©•age
 = 
bŒfs_šv®id©•age
,

10910 .
	g»Ëa£·ge
 = 
bŒfs_»Ëa£·ge
,

10913 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_fže_šode_Ý”©iÚs
 = {

10914 .
g‘©Œ
 = 
bŒfs_g‘©Œ
,

10915 .
	g£‰r
 = 
bŒfs_£‰r
,

10916 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

10917 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

10918 .
	gf›m­
 = 
bŒfs_f›m­
,

10919 .
	gg‘_aþ
 = 
bŒfs_g‘_aþ
,

10920 .
	g£t_aþ
 = 
bŒfs_£t_aþ
,

10921 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

10923 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_¥ecŸl_šode_Ý”©iÚs
 = {

10924 .
g‘©Œ
 = 
bŒfs_g‘©Œ
,

10925 .
	g£‰r
 = 
bŒfs_£‰r
,

10926 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

10927 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

10928 .
	gg‘_aþ
 = 
bŒfs_g‘_aþ
,

10929 .
	g£t_aþ
 = 
bŒfs_£t_aþ
,

10930 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

10932 cÚ¡ 
šode_Ý”©iÚs
 
	gbŒfs_symlšk_šode_Ý”©iÚs
 = {

10933 .
g‘_lšk
 = 
·ge_g‘_lšk
,

10934 .
	gg‘©Œ
 = 
bŒfs_g‘©Œ
,

10935 .
	g£‰r
 = 
bŒfs_£‰r
,

10936 .
	g³rmissiÚ
 = 
bŒfs_³rmissiÚ
,

10937 .
	gli¡x©Œ
 = 
bŒfs_li¡x©Œ
,

10938 .
	gupd©e_time
 = 
bŒfs_upd©e_time
,

10941 cÚ¡ 
d’Œy_Ý”©iÚs
 
	gbŒfs_d’Œy_Ý”©iÚs
 = {

10942 .
d_d–‘e
 = 
bŒfs_d’Œy_d–‘e
,

10943 .
	gd_»Ëa£
 = 
bŒfs_d’Œy_»Ëa£
,

	@ioctl.c

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/bio.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/fže.h
>

23 
	~<lšux/fs.h
>

24 
	~<lšux/f¢Ùify.h
>

25 
	~<lšux/·gem­.h
>

26 
	~<lšux/highmem.h
>

27 
	~<lšux/time.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/¡ršg.h
>

30 
	~<lšux/backšg-dev.h
>

31 
	~<lšux/mouÁ.h
>

32 
	~<lšux/m·ge.h
>

33 
	~<lšux/Çmei.h
>

34 
	~<lšux/sw­.h
>

35 
	~<lšux/wr™eback.h
>

36 
	~<lšux/com·t.h
>

37 
	~<lšux/b™_¥šlock.h
>

38 
	~<lšux/£cur™y.h
>

39 
	~<lšux/x©Œ.h
>

40 
	~<lšux/mm.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/blkdev.h
>

43 
	~<lšux/uuid.h
>

44 
	~<lšux/bŒfs.h
>

45 
	~<lšux/uacûss.h
>

46 
	~"ù»e.h
"

47 
	~"disk-io.h
"

48 
	~"Œª§ùiÚ.h
"

49 
	~"bŒfs_šode.h
"

50 
	~"´št-Œ“.h
"

51 
	~"vÞumes.h
"

52 
	~"lockšg.h
"

53 
	~"šode-m­.h
"

54 
	~"back»f.h
"

55 
	~"rcu-¡ršg.h
"

56 
	~"£nd.h
"

57 
	~"dev-»¶aû.h
"

58 
	~"´Ýs.h
"

59 
	~"sysfs.h
"

60 
	~"qgroup.h
"

61 
	~"Œ“-log.h
"

62 
	~"com´essiÚ.h
"

64 #ifdeà
CONFIG_64BIT


70 
	sbŒfs_ioùl_time¥ec_32
 {

71 
__u64
 
	m£c
;

72 
__u32
 
	mn£c
;

73 } 
__©Œibu‹__
 ((
__·cked__
));

75 
	sbŒfs_ioùl_»ûived_subvÞ_¬gs_32
 {

76 
	muuid
[
BTRFS_UUID_SIZE
];

77 
__u64
 
	m¡¿nsid
;

78 
__u64
 
	m¹¿nsid
;

79 
bŒfs_ioùl_time¥ec_32
 
	m¡ime
;

80 
bŒfs_ioùl_time¥ec_32
 
	m¹ime
;

81 
__u64
 
	mæags
;

82 
__u64
 
	m»£rved
[16];

83 } 
__©Œibu‹__
 ((
__·cked__
));

85 
	#BTRFS_IOC_SET_RECEIVED_SUBVOL_32
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 37, \

86 
bŒfs_ioùl_»ûived_subvÞ_¬gs_32
)

	)

90 
bŒfs_þÚe
(
šode
 *
¤c
, inode *inode,

91 
u64
 
off
, u64 
Þ’
, u64 
Þ’_®igÃd
, u64 
de¡off
,

92 
no_time_upd©e
);

95 
šlše
 
__u32
 
	$bŒfs_mask_æags
(
umode_t
 
mode
, 
__u32
 
æags
)

97 ià(
	`S_ISDIR
(
mode
))

98  
æags
;

99 ià(
	`S_ISREG
(
mode
))

100  
æags
 & ~
FS_DIRSYNC_FL
;

102  
æags
 & (
FS_NODUMP_FL
 | 
FS_NOATIME_FL
);

103 
	}
}

108 
	$bŒfs_æags_to_ioùl
(
æags
)

110 
iæags
 = 0;

112 ià(
æags
 & 
BTRFS_INODE_SYNC
)

113 
iæags
 |ð
FS_SYNC_FL
;

114 ià(
æags
 & 
BTRFS_INODE_IMMUTABLE
)

115 
iæags
 |ð
FS_IMMUTABLE_FL
;

116 ià(
æags
 & 
BTRFS_INODE_APPEND
)

117 
iæags
 |ð
FS_APPEND_FL
;

118 ià(
æags
 & 
BTRFS_INODE_NODUMP
)

119 
iæags
 |ð
FS_NODUMP_FL
;

120 ià(
æags
 & 
BTRFS_INODE_NOATIME
)

121 
iæags
 |ð
FS_NOATIME_FL
;

122 ià(
æags
 & 
BTRFS_INODE_DIRSYNC
)

123 
iæags
 |ð
FS_DIRSYNC_FL
;

124 ià(
æags
 & 
BTRFS_INODE_NODATACOW
)

125 
iæags
 |ð
FS_NOCOW_FL
;

127 ià(
æags
 & 
BTRFS_INODE_NOCOMPRESS
)

128 
iæags
 |ð
FS_NOCOMP_FL
;

129 ià(
æags
 & 
BTRFS_INODE_COMPRESS
)

130 
iæags
 |ð
FS_COMPR_FL
;

132  
iæags
;

133 
	}
}

138 
	$bŒfs_upd©e_iæags
(
šode
 *inode)

140 
bŒfs_šode
 *

 = 
	`BTRFS_I
(
šode
);

141 
Ãw_æ
 = 0;

143 ià(

->
æags
 & 
BTRFS_INODE_SYNC
)

144 
Ãw_æ
 |ð
S_SYNC
;

145 ià(

->
æags
 & 
BTRFS_INODE_IMMUTABLE
)

146 
Ãw_æ
 |ð
S_IMMUTABLE
;

147 ià(

->
æags
 & 
BTRFS_INODE_APPEND
)

148 
Ãw_æ
 |ð
S_APPEND
;

149 ià(

->
æags
 & 
BTRFS_INODE_NOATIME
)

150 
Ãw_æ
 |ð
S_NOATIME
;

151 ià(

->
æags
 & 
BTRFS_INODE_DIRSYNC
)

152 
Ãw_æ
 |ð
S_DIRSYNC
;

154 
	`£t_mask_b™s
(&
šode
->
i_æags
,

155 
S_SYNC
 | 
S_APPEND
 | 
S_IMMUTABLE
 | 
S_NOATIME
 | 
S_DIRSYNC
,

156 
Ãw_æ
);

157 
	}
}

159 
	$bŒfs_ioùl_g‘æags
(
fže
 *fže, 
__u£r
 *
¬g
)

161 
bŒfs_šode
 *

 = 
	`BTRFS_I
(
	`fže_šode
(
fže
));

162 
æags
 = 
	`bŒfs_æags_to_ioùl
(

->flags);

164 ià(
	`cÝy_to_u£r
(
¬g
, &
æags
, (flags)))

165  -
EFAULT
;

167 
	}
}

169 
	$check_æags
(
æags
)

171 ià(
æags
 & ~(
FS_IMMUTABLE_FL
 | 
FS_APPEND_FL
 | \

172 
FS_NOATIME_FL
 | 
FS_NODUMP_FL
 | \

173 
FS_SYNC_FL
 | 
FS_DIRSYNC_FL
 | \

174 
FS_NOCOMP_FL
 | 
FS_COMPR_FL
 |

175 
FS_NOCOW_FL
))

176  -
EOPNOTSUPP
;

178 ià((
æags
 & 
FS_NOCOMP_FL
è&& (æag & 
FS_COMPR_FL
))

179  -
EINVAL
;

182 
	}
}

184 
	$bŒfs_ioùl_£tæags
(
fže
 *fže, 
__u£r
 *
¬g
)

186 
šode
 *šodð
	`fže_šode
(
fže
);

187 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

188 
bŒfs_šode
 *

 = 
	`BTRFS_I
(
šode
);

189 
bŒfs_roÙ
 *
roÙ
 = 

->root;

190 
bŒfs_Œªs_hªdË
 *
Œªs
;

191 
æags
, 
Þdæags
;

192 
»t
;

193 
u64
 
_Þdæags
;

194 
i_Þdæags
;

195 
umode_t
 
mode
;

197 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

198  -
EPERM
;

200 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

201  -
EROFS
;

203 ià(
	`cÝy_äom_u£r
(&
æags
, 
¬g
, (flags)))

204  -
EFAULT
;

206 
»t
 = 
	`check_æags
(
æags
);

207 ià(
»t
)

208  
»t
;

210 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

211 ià(
»t
)

212  
»t
;

214 
	`šode_lock
(
šode
);

216 
_Þdæags
 = 

->
æags
;

217 
i_Þdæags
 = 
šode
->
i_æags
;

218 
mode
 = 
šode
->
i_mode
;

220 
æags
 = 
	`bŒfs_mask_æags
(
šode
->
i_mode
, flags);

221 
Þdæags
 = 
	`bŒfs_æags_to_ioùl
(

->
æags
);

222 ià((
æags
 ^ 
Þdæags
è& (
FS_APPEND_FL
 | 
FS_IMMUTABLE_FL
)) {

223 ià(!
	`ÿ·bË
(
CAP_LINUX_IMMUTABLE
)) {

224 
»t
 = -
EPERM
;

225 
out_uÆock
;

229 ià(
æags
 & 
FS_SYNC_FL
)

230 

->
æags
 |ð
BTRFS_INODE_SYNC
;

232 

->
æags
 &ð~
BTRFS_INODE_SYNC
;

233 ià(
æags
 & 
FS_IMMUTABLE_FL
)

234 

->
æags
 |ð
BTRFS_INODE_IMMUTABLE
;

236 

->
æags
 &ð~
BTRFS_INODE_IMMUTABLE
;

237 ià(
æags
 & 
FS_APPEND_FL
)

238 

->
æags
 |ð
BTRFS_INODE_APPEND
;

240 

->
æags
 &ð~
BTRFS_INODE_APPEND
;

241 ià(
æags
 & 
FS_NODUMP_FL
)

242 

->
æags
 |ð
BTRFS_INODE_NODUMP
;

244 

->
æags
 &ð~
BTRFS_INODE_NODUMP
;

245 ià(
æags
 & 
FS_NOATIME_FL
)

246 

->
æags
 |ð
BTRFS_INODE_NOATIME
;

248 

->
æags
 &ð~
BTRFS_INODE_NOATIME
;

249 ià(
æags
 & 
FS_DIRSYNC_FL
)

250 

->
æags
 |ð
BTRFS_INODE_DIRSYNC
;

252 

->
æags
 &ð~
BTRFS_INODE_DIRSYNC
;

253 ià(
æags
 & 
FS_NOCOW_FL
) {

254 ià(
	`S_ISREG
(
mode
)) {

260 ià(
šode
->
i_size
 == 0)

261 

->
æags
 |ð
BTRFS_INODE_NODATACOW


262 | 
BTRFS_INODE_NODATASUM
;

264 

->
æags
 |ð
BTRFS_INODE_NODATACOW
;

270 ià(
	`S_ISREG
(
mode
)) {

271 ià(
šode
->
i_size
 == 0)

272 

->
æags
 &ð~(
BTRFS_INODE_NODATACOW


273 | 
BTRFS_INODE_NODATASUM
);

275 

->
æags
 &ð~
BTRFS_INODE_NODATACOW
;

284 ià(
æags
 & 
FS_NOCOMP_FL
) {

285 

->
æags
 &ð~
BTRFS_INODE_COMPRESS
;

286 

->
æags
 |ð
BTRFS_INODE_NOCOMPRESS
;

288 
»t
 = 
	`bŒfs_£t_´Ý
(
šode
, "bŒfs.com´essiÚ", 
NULL
, 0, 0);

289 ià(
»t
 &&„‘ !ð-
ENODATA
)

290 
out_drÝ
;

291 } ià(
æags
 & 
FS_COMPR_FL
) {

292 cÚ¡ *
comp
;

294 

->
æags
 |ð
BTRFS_INODE_COMPRESS
;

295 

->
æags
 &ð~
BTRFS_INODE_NOCOMPRESS
;

297 ià(
fs_šfo
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_LZO
)

298 
comp
 = "lzo";

299 ià(
fs_šfo
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_ZLIB
)

300 
comp
 = "zlib";

302 
comp
 = "zstd";

303 
»t
 = 
	`bŒfs_£t_´Ý
(
šode
, "btrfs.compression",

304 
comp
, 
	`¡¾’
(comp), 0);

305 ià(
»t
)

306 
out_drÝ
;

309 
»t
 = 
	`bŒfs_£t_´Ý
(
šode
, "bŒfs.com´essiÚ", 
NULL
, 0, 0);

310 ià(
»t
 &&„‘ !ð-
ENODATA
)

311 
out_drÝ
;

312 

->
æags
 &ð~(
BTRFS_INODE_COMPRESS
 | 
BTRFS_INODE_NOCOMPRESS
);

315 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

316 ià(
	`IS_ERR
(
Œªs
)) {

317 
»t
 = 
	`PTR_ERR
(
Œªs
);

318 
out_drÝ
;

321 
	`bŒfs_upd©e_iæags
(
šode
);

322 
	`šode_šc_iv”siÚ
(
šode
);

323 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

324 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

326 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

327 
out_drÝ
:

328 ià(
»t
) {

329 

->
æags
 = 
_Þdæags
;

330 
šode
->
i_æags
 = 
i_Þdæags
;

333 
out_uÆock
:

334 
	`šode_uÆock
(
šode
);

335 
	`mÁ_drÝ_wr™e_fže
(
fže
);

336  
»t
;

337 
	}
}

339 
	$bŒfs_ioùl_g‘v”siÚ
(
fže
 *fže, 
__u£r
 *
¬g
)

341 
šode
 *šodð
	`fže_šode
(
fže
);

343  
	`put_u£r
(
šode
->
i_g’”©iÚ
, 
¬g
);

344 
	}
}

346 
nošlše
 
	$bŒfs_ioùl_f™rim
(
fže
 *fže, 
__u£r
 *
¬g
)

348 
šode
 *šodð
	`fže_šode
(
fže
);

349 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

350 
bŒfs_deviû
 *
deviû
;

351 
»que¡_queue
 *
q
;

352 
f¡rim_¿nge
 
¿nge
;

353 
u64
 
mšËn
 = 
ULLONG_MAX
;

354 
u64
 
num_deviûs
 = 0;

355 
u64
 
tÙ®_by‹s
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
);

356 
»t
;

358 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

359  -
EPERM
;

361 
	`rcu_»ad_lock
();

362 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
fs_šfo
->
fs_deviûs
->
deviûs
,

363 
dev_li¡
) {

364 ià(!
deviû
->
bdev
)

366 
q
 = 
	`bdev_g‘_queue
(
deviû
->
bdev
);

367 ià(
	`blk_queue_disÿrd
(
q
)) {

368 
num_deviûs
++;

369 
mšËn
 = 
	`mš_t
(
u64
, 
q
->
lim™s
.
disÿrd_g¿nuÏr™y
,

370 
mšËn
);

373 
	`rcu_»ad_uÆock
();

375 ià(!
num_deviûs
)

376  -
EOPNOTSUPP
;

377 ià(
	`cÝy_äom_u£r
(&
¿nge
, 
¬g
, (range)))

378  -
EFAULT
;

379 ià(
¿nge
.
¡¬t
 > 
tÙ®_by‹s
 ||

380 
¿nge
.
Ën
 < 
fs_šfo
->
sb
->
s_blocksize
)

381  -
EINVAL
;

383 
¿nge
.
Ën
 = 
	`mš
Ôªge.Ën, 
tÙ®_by‹s
 -„ªge.
¡¬t
);

384 
¿nge
.
mšËn
 = 
	`max
(range.minlen, minlen);

385 
»t
 = 
	`bŒfs_Œim_fs
(
fs_šfo
, &
¿nge
);

386 ià(
»t
 < 0)

387  
»t
;

389 ià(
	`cÝy_to_u£r
(
¬g
, &
¿nge
, (range)))

390  -
EFAULT
;

393 
	}
}

395 
	$bŒfs_is_em±y_uuid
(
u8
 *
uuid
)

397 
i
;

399 
i
 = 0; i < 
BTRFS_UUID_SIZE
; i++) {

400 ià(
uuid
[
i
])

404 
	}
}

406 
nošlše
 
	$ü—‹_subvÞ
(
šode
 *
dœ
,

407 
d’Œy
 *dentry,

408 cÚ¡ *
Çme
, 
Çm–’
,

409 
u64
 *
async_Œªsid
,

410 
bŒfs_qgroup_šh”™
 *
šh”™
)

412 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

413 
bŒfs_Œªs_hªdË
 *
Œªs
;

414 
bŒfs_key
 
key
;

415 
bŒfs_roÙ_™em
 *
roÙ_™em
;

416 
bŒfs_šode_™em
 *
šode_™em
;

417 
ex‹Á_bufãr
 *
Ëaf
;

418 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

419 
bŒfs_roÙ
 *
Ãw_roÙ
;

420 
bŒfs_block_rsv
 
block_rsv
;

421 
time¥ec
 
cur_time
 = 
	`cu¼’t_time
(
dœ
);

422 
šode
 *inode;

423 
»t
;

424 
”r
;

425 
u64
 
objeùid
;

426 
u64
 
Ãw_dœid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

427 
u64
 
šdex
 = 0;

428 
u64
 
qgroup_»£rved
;

429 
uuid_Ë
 
Ãw_uuid
;

431 
roÙ_™em
 = 
	`kz®loc
((*roÙ_™em), 
GFP_KERNEL
);

432 ià(!
roÙ_™em
)

433  -
ENOMEM
;

435 
»t
 = 
	`bŒfs_fšd_ä“_objeùid
(
fs_šfo
->
Œ“_roÙ
, &
objeùid
);

436 ià(
»t
)

437 
çž_ä“
;

443 ià(
	`bŒfs_qgroup_Ëv–
(
objeùid
)) {

444 
»t
 = -
ENOSPC
;

445 
çž_ä“
;

448 
	`bŒfs_š™_block_rsv
(&
block_rsv
, 
BTRFS_BLOCK_RSV_TEMP
);

453 
»t
 = 
	`bŒfs_subvÞume_»£rve_m‘ad©a
(
roÙ
, &
block_rsv
,

454 8, &
qgroup_»£rved
, 
çl£
);

455 ià(
»t
)

456 
çž_ä“
;

458 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

459 ià(
	`IS_ERR
(
Œªs
)) {

460 
»t
 = 
	`PTR_ERR
(
Œªs
);

461 
	`bŒfs_subvÞume_»Ëa£_m‘ad©a
(
fs_šfo
, &
block_rsv
);

462 
çž_ä“
;

464 
Œªs
->
block_rsv
 = &block_rsv;

465 
Œªs
->
by‹s_»£rved
 = 
block_rsv
.
size
;

467 
»t
 = 
	`bŒfs_qgroup_šh”™
(
Œªs
, 
fs_šfo
, 0, 
objeùid
, 
šh”™
);

468 ià(
»t
)

469 
çž
;

471 
Ëaf
 = 
	`bŒfs_®loc_Œ“_block
(
Œªs
, 
roÙ
, 0, 
objeùid
, 
NULL
, 0, 0, 0);

472 ià(
	`IS_ERR
(
Ëaf
)) {

473 
»t
 = 
	`PTR_ERR
(
Ëaf
);

474 
çž
;

477 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, 0, (
bŒfs_h—d”
));

478 
	`bŒfs_£t_h—d”_by‹Ä
(
Ëaf
,†—f->
¡¬t
);

479 
	`bŒfs_£t_h—d”_g’”©iÚ
(
Ëaf
, 
Œªs
->
Œªsid
);

480 
	`bŒfs_£t_h—d”_back»f_»v
(
Ëaf
, 
BTRFS_MIXED_BACKREF_REV
);

481 
	`bŒfs_£t_h—d”_owÃr
(
Ëaf
, 
objeùid
);

483 
	`wr™e_ex‹Á_bufãr_fsid
(
Ëaf
, 
fs_šfo
->
fsid
);

484 
	`wr™e_ex‹Á_bufãr_chunk_Œ“_uuid
(
Ëaf
, 
fs_šfo
->
chunk_Œ“_uuid
);

485 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

487 
šode_™em
 = &
roÙ_™em
->
šode
;

488 
	`bŒfs_£t_¡ack_šode_g’”©iÚ
(
šode_™em
, 1);

489 
	`bŒfs_£t_¡ack_šode_size
(
šode_™em
, 3);

490 
	`bŒfs_£t_¡ack_šode_Æšk
(
šode_™em
, 1);

491 
	`bŒfs_£t_¡ack_šode_nby‹s
(
šode_™em
,

492 
fs_šfo
->
nodesize
);

493 
	`bŒfs_£t_¡ack_šode_mode
(
šode_™em
, 
S_IFDIR
 | 0755);

495 
	`bŒfs_£t_roÙ_æags
(
roÙ_™em
, 0);

496 
	`bŒfs_£t_roÙ_lim™
(
roÙ_™em
, 0);

497 
	`bŒfs_£t_¡ack_šode_æags
(
šode_™em
, 
BTRFS_INODE_ROOT_ITEM_INIT
);

499 
	`bŒfs_£t_roÙ_by‹Ä
(
roÙ_™em
, 
Ëaf
->
¡¬t
);

500 
	`bŒfs_£t_roÙ_g’”©iÚ
(
roÙ_™em
, 
Œªs
->
Œªsid
);

501 
	`bŒfs_£t_roÙ_Ëv–
(
roÙ_™em
, 0);

502 
	`bŒfs_£t_roÙ_»fs
(
roÙ_™em
, 1);

503 
	`bŒfs_£t_roÙ_u£d
(
roÙ_™em
, 
Ëaf
->
Ën
);

504 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(
roÙ_™em
, 0);

506 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
roÙ_™em
,

507 
	`bŒfs_roÙ_g’”©iÚ
(
roÙ_™em
));

508 
	`uuid_Ë_g’
(&
Ãw_uuid
);

509 
	`memýy
(
roÙ_™em
->
uuid
, 
Ãw_uuid
.
b
, 
BTRFS_UUID_SIZE
);

510 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
roÙ_™em
->
Ùime
, 
cur_time
.
tv_£c
);

511 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
roÙ_™em
->
Ùime
, 
cur_time
.
tv_n£c
);

512 
roÙ_™em
->
ùime
 =„oÙ_™em->
Ùime
;

513 
	`bŒfs_£t_roÙ_ù¿nsid
(
roÙ_™em
, 
Œªs
->
Œªsid
);

514 
	`bŒfs_£t_roÙ_Ù¿nsid
(
roÙ_™em
, 
Œªs
->
Œªsid
);

516 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

517 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

518 
Ëaf
 = 
NULL
;

520 
	`bŒfs_£t_roÙ_dœid
(
roÙ_™em
, 
Ãw_dœid
);

522 
key
.
objeùid
 = objectid;

523 
key
.
off£t
 = 0;

524 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

525 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
, &
key
,

526 
roÙ_™em
);

527 ià(
»t
)

528 
çž
;

530 
key
.
off£t
 = (
u64
)-1;

531 
Ãw_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

532 ià(
	`IS_ERR
(
Ãw_roÙ
)) {

533 
»t
 = 
	`PTR_ERR
(
Ãw_roÙ
);

534 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

535 
çž
;

538 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
Ãw_roÙ
);

540 
»t
 = 
	`bŒfs_ü—‹_subvÞ_roÙ
(
Œªs
, 
Ãw_roÙ
, 
roÙ
, 
Ãw_dœid
);

541 ià(
»t
) {

543 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

544 
çž
;

547 
	`mu‹x_lock
(&
Ãw_roÙ
->
objeùid_mu‹x
);

548 
Ãw_roÙ
->
highe¡_objeùid
 = 
Ãw_dœid
;

549 
	`mu‹x_uÆock
(&
Ãw_roÙ
->
objeùid_mu‹x
);

554 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
dœ
), &
šdex
);

555 ià(
»t
) {

556 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

557 
çž
;

560 
»t
 = 
	`bŒfs_š£¹_dœ_™em
(
Œªs
, 
roÙ
,

561 
Çme
, 
Çm–’
, 
	`BTRFS_I
(
dœ
), &
key
,

562 
BTRFS_FT_DIR
, 
šdex
);

563 ià(
»t
) {

564 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

565 
çž
;

568 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
dœ
), dœ->
i_size
 + 
Çm–’
 * 2);

569 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
dœ
);

570 
	`BUG_ON
(
»t
);

572 
»t
 = 
	`bŒfs_add_roÙ_»f
(
Œªs
, 
fs_šfo
,

573 
objeùid
, 
roÙ
->
roÙ_key
.objectid,

574 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)), 
šdex
, 
Çme
, 
Çm–’
);

575 
	`BUG_ON
(
»t
);

577 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
fs_šfo
, 
roÙ_™em
->
uuid
,

578 
BTRFS_UUID_KEY_SUBVOL
, 
objeùid
);

579 ià(
»t
)

580 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

582 
çž
:

583 
	`kä“
(
roÙ_™em
);

584 
Œªs
->
block_rsv
 = 
NULL
;

585 
Œªs
->
by‹s_»£rved
 = 0;

586 
	`bŒfs_subvÞume_»Ëa£_m‘ad©a
(
fs_šfo
, &
block_rsv
);

588 ià(
async_Œªsid
) {

589 *
async_Œªsid
 = 
Œªs
->
Œªsid
;

590 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ_async
(
Œªs
, 1);

591 ià(
”r
)

592 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

594 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

596 ià(
”r
 && !
»t
)

597 
»t
 = 
”r
;

599 ià(!
»t
) {

600 
šode
 = 
	`bŒfs_lookup_d’Œy
(
dœ
, 
d’Œy
);

601 ià(
	`IS_ERR
(
šode
))

602  
	`PTR_ERR
(
šode
);

603 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

605  
»t
;

607 
çž_ä“
:

608 
	`kä“
(
roÙ_™em
);

609  
»t
;

610 
	}
}

612 
	$bŒfs_wa™_fÜ_no_¢­shÙtšg_wr™es
(
bŒfs_roÙ
 *
roÙ
)

614 
s64
 
wr™”s
;

615 
	`DEFINE_WAIT
(
wa™
);

618 
	`´•¬e_to_wa™
(&
roÙ
->
subv_wr™”s
->
wa™
, &wait,

619 
TASK_UNINTERRUPTIBLE
);

621 
wr™”s
 = 
	`³rýu_couÁ”_sum
(&
roÙ
->
subv_wr™”s
->
couÁ”
);

622 ià(
wr™”s
)

623 
	`scheduË
();

625 
	`fšish_wa™
(&
roÙ
->
subv_wr™”s
->
wa™
, &wait);

626 } 
wr™”s
);

627 
	}
}

629 
	$ü—‹_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
, 
šode
 *
dœ
,

630 
d’Œy
 *dentry,

631 
u64
 *
async_Œªsid
, 
boÞ
 
»adÚly
,

632 
bŒfs_qgroup_šh”™
 *
šh”™
)

634 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

635 
šode
 *inode;

636 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg_¢­shÙ
;

637 
bŒfs_Œªs_hªdË
 *
Œªs
;

638 
»t
;

640 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

641  -
EINVAL
;

643 
³ndšg_¢­shÙ
 = 
	`kz®loc
((*³ndšg_¢­shÙ), 
GFP_KERNEL
);

644 ià(!
³ndšg_¢­shÙ
)

645  -
ENOMEM
;

647 
³ndšg_¢­shÙ
->
roÙ_™em
 = 
	`kz®loc
((
bŒfs_roÙ_™em
),

648 
GFP_KERNEL
);

649 
³ndšg_¢­shÙ
->
·th
 = 
	`bŒfs_®loc_·th
();

650 ià(!
³ndšg_¢­shÙ
->
roÙ_™em
 || !³ndšg_¢­shÙ->
·th
) {

651 
»t
 = -
ENOMEM
;

652 
ä“_³ndšg
;

655 
	`©omic_šc
(&
roÙ
->
wžl_be_¢­shÙ‹d
);

656 
	`smp_mb__aá”_©omic
();

657 
	`bŒfs_wa™_fÜ_no_¢­shÙtšg_wr™es
(
roÙ
);

659 
»t
 = 
	`bŒfs_¡¬t_d–®loc_šodes
(
roÙ
, 0);

660 ià(
»t
)

661 
dec_ªd_ä“
;

663 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
U64_MAX
, 0, (
u64
)-1);

665 
	`bŒfs_š™_block_rsv
(&
³ndšg_¢­shÙ
->
block_rsv
,

666 
BTRFS_BLOCK_RSV_TEMP
);

675 
»t
 = 
	`bŒfs_subvÞume_»£rve_m‘ad©a
(
	`BTRFS_I
(
dœ
)->
roÙ
,

676 &
³ndšg_¢­shÙ
->
block_rsv
, 8,

677 &
³ndšg_¢­shÙ
->
qgroup_»£rved
,

678 
çl£
);

679 ià(
»t
)

680 
dec_ªd_ä“
;

682 
³ndšg_¢­shÙ
->
d’Œy
 = dentry;

683 
³ndšg_¢­shÙ
->
roÙ
 =„oot;

684 
³ndšg_¢­shÙ
->
»adÚly
 =„eadonly;

685 
³ndšg_¢­shÙ
->
dœ
 = dir;

686 
³ndšg_¢­shÙ
->
šh”™
 = inherit;

688 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

689 ià(
	`IS_ERR
(
Œªs
)) {

690 
»t
 = 
	`PTR_ERR
(
Œªs
);

691 
çž
;

694 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

695 
	`li¡_add
(&
³ndšg_¢­shÙ
->
li¡
,

696 &
Œªs
->
Œª§ùiÚ
->
³ndšg_¢­shÙs
);

697 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

698 ià(
async_Œªsid
) {

699 *
async_Œªsid
 = 
Œªs
->
Œªsid
;

700 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ_async
(
Œªs
, 1);

701 ià(
»t
)

702 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

704 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

706 ià(
»t
)

707 
çž
;

709 
»t
 = 
³ndšg_¢­shÙ
->
”rÜ
;

710 ià(
»t
)

711 
çž
;

713 
»t
 = 
	`bŒfs_Üphª_þ—nup
(
³ndšg_¢­shÙ
->
¢­
);

714 ià(
»t
)

715 
çž
;

717 
šode
 = 
	`bŒfs_lookup_d’Œy
(
	`d_šode
(
d’Œy
->
d_·»Á
), dentry);

718 ià(
	`IS_ERR
(
šode
)) {

719 
»t
 = 
	`PTR_ERR
(
šode
);

720 
çž
;

723 
	`d_š¡ªtŸ‹
(
d’Œy
, 
šode
);

724 
»t
 = 0;

725 
çž
:

726 
	`bŒfs_subvÞume_»Ëa£_m‘ad©a
(
fs_šfo
, &
³ndšg_¢­shÙ
->
block_rsv
);

727 
dec_ªd_ä“
:

728 ià(
	`©omic_dec_ªd_‹¡
(&
roÙ
->
wžl_be_¢­shÙ‹d
))

729 
	`wake_up_©omic_t
(&
roÙ
->
wžl_be_¢­shÙ‹d
);

730 
ä“_³ndšg
:

731 
	`kä“
(
³ndšg_¢­shÙ
->
roÙ_™em
);

732 
	`bŒfs_ä“_·th
(
³ndšg_¢­shÙ
->
·th
);

733 
	`kä“
(
³ndšg_¢­shÙ
);

735  
»t
;

736 
	}
}

758 
	$bŒfs_may_d–‘e
(
šode
 *
dœ
, 
d’Œy
 *
viùim
, 
isdœ
)

760 
”rÜ
;

762 ià(
	`d_»®ly_is_Ãg©ive
(
viùim
))

763  -
ENOENT
;

765 
	`BUG_ON
(
	`d_šode
(
viùim
->
d_·»Á
è!ð
dœ
);

766 
	`aud™_šode_chžd
(
dœ
, 
viùim
, 
AUDIT_TYPE_CHILD_DELETE
);

768 
”rÜ
 = 
	`šode_³rmissiÚ
(
dœ
, 
MAY_WRITE
 | 
MAY_EXEC
);

769 ià(
”rÜ
)

770  
”rÜ
;

771 ià(
	`IS_APPEND
(
dœ
))

772  -
EPERM
;

773 ià(
	`check_¡icky
(
dœ
, 
	`d_šode
(
viùim
)è|| 
	`IS_APPEND
(d_inode(victim)) ||

774 
	`IS_IMMUTABLE
(
	`d_šode
(
viùim
)è|| 
	`IS_SWAPFILE
(d_inode(victim)))

775  -
EPERM
;

776 ià(
isdœ
) {

777 ià(!
	`d_is_dœ
(
viùim
))

778  -
ENOTDIR
;

779 ià(
	`IS_ROOT
(
viùim
))

780  -
EBUSY
;

781 } ià(
	`d_is_dœ
(
viùim
))

782  -
EISDIR
;

783 ià(
	`IS_DEADDIR
(
dœ
))

784  -
ENOENT
;

785 ià(
viùim
->
d_æags
 & 
DCACHE_NFSFS_RENAMED
)

786  -
EBUSY
;

788 
	}
}

791 
šlše
 
	$bŒfs_may_ü—‹
(
šode
 *
dœ
, 
d’Œy
 *
chžd
)

793 ià(
	`d_»®ly_is_pos™ive
(
chžd
))

794  -
EEXIST
;

795 ià(
	`IS_DEADDIR
(
dœ
))

796  -
ENOENT
;

797  
	`šode_³rmissiÚ
(
dœ
, 
MAY_WRITE
 | 
MAY_EXEC
);

798 
	}
}

805 
nošlše
 
	$bŒfs_mksubvÞ
(cÚ¡ 
·th
 *
·»Á
,

806 cÚ¡ *
Çme
, 
Çm–’
,

807 
bŒfs_roÙ
 *
¢­_¤c
,

808 
u64
 *
async_Œªsid
, 
boÞ
 
»adÚly
,

809 
bŒfs_qgroup_šh”™
 *
šh”™
)

811 
šode
 *
dœ
 = 
	`d_šode
(
·»Á
->
d’Œy
);

812 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
dœ
->
i_sb
);

813 
d’Œy
 *dentry;

814 
”rÜ
;

816 
”rÜ
 = 
	`down_wr™e_kžÏbË_Ã¡ed
(&
dœ
->
i_rw£m
, 
I_MUTEX_PARENT
);

817 ià(
”rÜ
 =ð-
EINTR
)

818  
”rÜ
;

820 
d’Œy
 = 
	`lookup_Úe_Ën
(
Çme
, 
·»Á
->d’Œy, 
Çm–’
);

821 
”rÜ
 = 
	`PTR_ERR
(
d’Œy
);

822 ià(
	`IS_ERR
(
d’Œy
))

823 
out_uÆock
;

825 
”rÜ
 = 
	`bŒfs_may_ü—‹
(
dœ
, 
d’Œy
);

826 ià(
”rÜ
)

827 
out_dput
;

833 
”rÜ
 = 
	`bŒfs_check_dœ_™em_cÞlisiÚ
(
	`BTRFS_I
(
dœ
)->
roÙ
,

834 
dœ
->
i_šo
, 
Çme
,

835 
Çm–’
);

836 ià(
”rÜ
)

837 
out_dput
;

839 
	`down_»ad
(&
fs_šfo
->
subvÞ_£m
);

841 ià(
	`bŒfs_roÙ_»fs
(&
	`BTRFS_I
(
dœ
)->
roÙ
->
roÙ_™em
) == 0)

842 
out_up_»ad
;

844 ià(
¢­_¤c
) {

845 
”rÜ
 = 
	`ü—‹_¢­shÙ
(
¢­_¤c
, 
dœ
, 
d’Œy
,

846 
async_Œªsid
, 
»adÚly
, 
šh”™
);

848 
”rÜ
 = 
	`ü—‹_subvÞ
(
dœ
, 
d’Œy
, 
Çme
, 
Çm–’
,

849 
async_Œªsid
, 
šh”™
);

851 ià(!
”rÜ
)

852 
	`f¢Ùify_mkdœ
(
dœ
, 
d’Œy
);

853 
out_up_»ad
:

854 
	`up_»ad
(&
fs_šfo
->
subvÞ_£m
);

855 
out_dput
:

856 
	`dput
(
d’Œy
);

857 
out_uÆock
:

858 
	`šode_uÆock
(
dœ
);

859  
”rÜ
;

860 
	}
}

869 
	$check_deäag_š_ÿche
(
šode
 *šode, 
u64
 
off£t
, 
u32
 
th»sh
)

871 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

872 
ex‹Á_m­
 *
em
 = 
NULL
;

873 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

874 
u64
 
’d
;

876 
	`»ad_lock
(&
em_Œ“
->
lock
);

877 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
off£t
, 
PAGE_SIZE
);

878 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

880 ià(
em
) {

881 
’d
 = 
	`ex‹Á_m­_’d
(
em
);

882 
	`ä“_ex‹Á_m­
(
em
);

883 ià(
’d
 - 
off£t
 > 
th»sh
)

887 
th»sh
 /= 2;

888 
’d
 = 
	`couÁ_¿nge_b™s
(
io_Œ“
, &
off£t
, off£ˆ+ 
th»sh
,

889 
th»sh
, 
EXTENT_DELALLOC
, 1);

890 ià(
’d
 >ð
th»sh
)

893 
	}
}

902 
	$fšd_Ãw_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
,

903 
šode
 *šode, 
u64
 
Ãw”_thª
,

904 
u64
 *
off
, 
u32
 
th»sh
)

906 
bŒfs_·th
 *
·th
;

907 
bŒfs_key
 
mš_key
;

908 
ex‹Á_bufãr
 *
Ëaf
;

909 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

910 
ty³
;

911 
»t
;

912 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

914 
·th
 = 
	`bŒfs_®loc_·th
();

915 ià(!
·th
)

916  -
ENOMEM
;

918 
mš_key
.
objeùid
 = 
šo
;

919 
mš_key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

920 
mš_key
.
off£t
 = *
off
;

923 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
mš_key
, 
·th
, 
Ãw”_thª
);

924 ià(
»t
 != 0)

925 
nÚe
;

926 
´oûss_¦Ù
:

927 ià(
mš_key
.
objeùid
 !ð
šo
)

928 
nÚe
;

929 ià(
mš_key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

930 
nÚe
;

932 
Ëaf
 = 
·th
->
nodes
[0];

933 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

934 
bŒfs_fže_ex‹Á_™em
);

936 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
);

937 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_REG
 &&

938 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
è< 
th»sh
 &&

939 
	`check_deäag_š_ÿche
(
šode
, 
mš_key
.
off£t
, 
th»sh
)) {

940 *
off
 = 
mš_key
.
off£t
;

941 
	`bŒfs_ä“_·th
(
·th
);

945 
·th
->
¦Ùs
[0]++;

946 ià(
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

947 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
mš_key
, 
·th
->
¦Ùs
[0]);

948 
´oûss_¦Ù
;

951 ià(
mš_key
.
off£t
 =ð(
u64
)-1)

952 
nÚe
;

954 
mš_key
.
off£t
++;

955 
	`bŒfs_»Ëa£_·th
(
·th
);

957 
nÚe
:

958 
	`bŒfs_ä“_·th
(
·th
);

959  -
ENOENT
;

960 
	}
}

962 
ex‹Á_m­
 *
	$deäag_lookup_ex‹Á
(
šode
 *šode, 
u64
 
¡¬t
)

964 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

965 
ex‹Á_io_Œ“
 *
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

966 
ex‹Á_m­
 *
em
;

967 
u64
 
Ën
 = 
PAGE_SIZE
;

973 
	`»ad_lock
(&
em_Œ“
->
lock
);

974 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
¡¬t
, 
Ën
);

975 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

977 ià(!
em
) {

978 
ex‹Á_¡©e
 *
ÿched
 = 
NULL
;

979 
u64
 
’d
 = 
¡¬t
 + 
Ën
 - 1;

982 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched
);

983 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
¡¬t
, 
Ën
, 0);

984 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
¡¬t
, 
’d
, &
ÿched
, 
GFP_NOFS
);

986 ià(
	`IS_ERR
(
em
))

987  
NULL
;

990  
em
;

991 
	}
}

993 
boÞ
 
	$deäag_check_Ãxt_ex‹Á
(
šode
 *šode, 
ex‹Á_m­
 *
em
)

995 
ex‹Á_m­
 *
Ãxt
;

996 
boÞ
 
»t
 = 
Œue
;

999 ià(
em
->
¡¬t
 +ƒm->
Ën
 >ð
	`i_size_»ad
(
šode
))

1000  
çl£
;

1002 
Ãxt
 = 
	`deäag_lookup_ex‹Á
(
šode
, 
em
->
¡¬t
 +ƒm->
Ën
);

1003 ià(!
Ãxt
 ||‚ext->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
)

1004 
»t
 = 
çl£
;

1005 ià((
em
->
block_¡¬t
 +ƒm->
block_Ën
 =ð
Ãxt
->block_start) &&

1006 (
em
->
block_Ën
 > 
SZ_128K
 && 
Ãxt
->block_len > SZ_128K))

1007 
»t
 = 
çl£
;

1009 
	`ä“_ex‹Á_m­
(
Ãxt
);

1010  
»t
;

1011 
	}
}

1013 
	$should_deäag_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, 
u32
 
th»sh
,

1014 
u64
 *
Ï¡_Ën
, u64 *
sk
, u64 *
deäag_’d
,

1015 
com´ess
)

1017 
ex‹Á_m­
 *
em
;

1018 
»t
 = 1;

1019 
boÞ
 
Ãxt_m”g—bË
 = 
Œue
;

1020 
boÞ
 
´ev_m”g—bË
 = 
Œue
;

1026 ià(
¡¬t
 < *
deäag_’d
)

1029 *
sk
 = 0;

1031 
em
 = 
	`deäag_lookup_ex‹Á
(
šode
, 
¡¬t
);

1032 ià(!
em
)

1036 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

1037 
»t
 = 0;

1038 
out
;

1041 ià(!*
deäag_’d
)

1042 
´ev_m”g—bË
 = 
çl£
;

1044 
Ãxt_m”g—bË
 = 
	`deäag_check_Ãxt_ex‹Á
(
šode
, 
em
);

1049 ià(!
com´ess
 && (*
Ï¡_Ën
 =ð0 || *Ï¡_ËÀ>ð
th»sh
) &&

1050 (
em
->
Ën
 >ð
th»sh
 || (!
Ãxt_m”g—bË
 && !
´ev_m”g—bË
)))

1051 
»t
 = 0;

1052 
out
:

1061 ià(
»t
) {

1062 *
deäag_’d
 = 
	`ex‹Á_m­_’d
(
em
);

1064 *
Ï¡_Ën
 = 0;

1065 *
sk
 = 
	`ex‹Á_m­_’d
(
em
);

1066 *
deäag_’d
 = 0;

1069 
	`ä“_ex‹Á_m­
(
em
);

1070  
»t
;

1071 
	}
}

1085 
	$þu¡”_·ges_fÜ_deäag
(
šode
 *inode,

1086 
·ge
 **
·ges
,

1087 
¡¬t_šdex
,

1088 
num_·ges
)

1090 
fže_’d
;

1091 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

1092 
u64
 
·ge_¡¬t
;

1093 
u64
 
·ge_’d
;

1094 
u64
 
·ge_út
;

1095 
»t
;

1096 
i
;

1097 
i_dÚe
;

1098 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1099 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1100 
ex‹Á_io_Œ“
 *
Œ“
;

1101 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

1102 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

1104 
fže_’d
 = (
isize
 - 1è>> 
PAGE_SHIFT
;

1105 ià(!
isize
 || 
¡¬t_šdex
 > 
fže_’d
)

1108 
·ge_út
 = 
	`mš_t
(
u64
, (u64)
num_·ges
, (u64)
fže_’d
 - 
¡¬t_šdex
 + 1);

1110 
»t
 = 
	`bŒfs_d–®loc_»£rve_¥aû
(
šode
, &
d©a_»£rved
,

1111 
¡¬t_šdex
 << 
PAGE_SHIFT
,

1112 
·ge_út
 << 
PAGE_SHIFT
);

1113 ià(
»t
)

1114  
»t
;

1115 
i_dÚe
 = 0;

1116 
Œ“
 = &
	`BTRFS_I
(
šode
)->
io_Œ“
;

1119 
i
 = 0; i < 
·ge_út
; i++) {

1120 
·ge
 *page;

1121 
agaš
:

1122 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
,

1123 
¡¬t_šdex
 + 
i
, 
mask
);

1124 ià(!
·ge
)

1127 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

1128 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

1130 
	`lock_ex‹Á_b™s
(
Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

1131 &
ÿched_¡©e
);

1132 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
,

1133 
·ge_¡¬t
);

1134 
	`uÆock_ex‹Á_ÿched
(
Œ“
, 
·ge_¡¬t
, 
·ge_’d
,

1135 &
ÿched_¡©e
, 
GFP_NOFS
);

1136 ià(!
Üd”ed
)

1139 
	`uÆock_·ge
(
·ge
);

1140 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

1141 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1142 
	`lock_·ge
(
·ge
);

1147 ià(
·ge
->
m­pšg
 !ð
šode
->
i_m­pšg
) {

1148 
	`uÆock_·ge
(
·ge
);

1149 
	`put_·ge
(
·ge
);

1150 
agaš
;

1154 ià(!
	`PageU±od©e
(
·ge
)) {

1155 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

1156 
	`lock_·ge
(
·ge
);

1157 ià(!
	`PageU±od©e
(
·ge
)) {

1158 
	`uÆock_·ge
(
·ge
);

1159 
	`put_·ge
(
·ge
);

1160 
»t
 = -
EIO
;

1165 ià(
·ge
->
m­pšg
 !ð
šode
->
i_m­pšg
) {

1166 
	`uÆock_·ge
(
·ge
);

1167 
	`put_·ge
(
·ge
);

1168 
agaš
;

1171 
·ges
[
i
] = 
·ge
;

1172 
i_dÚe
++;

1174 ià(!
i_dÚe
 || 
»t
)

1175 
out
;

1177 ià(!(
šode
->
i_sb
->
s_æags
 & 
MS_ACTIVE
))

1178 
out
;

1184 
i
 = 0; i < 
i_dÚe
; i++)

1185 
	`wa™_Ú_·ge_wr™eback
(
·ges
[
i
]);

1187 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ges
[0]);

1188 
·ge_’d
 = 
	`·ge_off£t
(
·ges
[
i_dÚe
 - 1]è+ 
PAGE_SIZE
;

1190 
	`lock_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1191 
·ge_¡¬t
, 
·ge_’d
 - 1, &
ÿched_¡©e
);

1192 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
,

1193 
·ge_’d
 - 1, 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

1194 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_DEFRAG
, 0, 0,

1195 &
ÿched_¡©e
, 
GFP_NOFS
);

1197 ià(
i_dÚe
 !ð
·ge_út
) {

1198 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

1199 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1200 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

1201 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

1202 
¡¬t_šdex
 << 
PAGE_SHIFT
,

1203 (
·ge_út
 - 
i_dÚe
è<< 
PAGE_SHIFT
);

1207 
	`£t_ex‹Á_deäag
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
 - 1,

1208 &
ÿched_¡©e
);

1210 
	`uÆock_ex‹Á_ÿched
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1211 
·ge_¡¬t
, 
·ge_’d
 - 1, &
ÿched_¡©e
,

1212 
GFP_NOFS
);

1214 
i
 = 0; i < 
i_dÚe
; i++) {

1215 
	`þ—r_·ge_dœty_fÜ_io
(
·ges
[
i
]);

1216 
	`CË¬PageChecked
(
·ges
[
i
]);

1217 
	`£t_·ge_ex‹Á_m­³d
(
·ges
[
i
]);

1218 
	`£t_·ge_dœty
(
·ges
[
i
]);

1219 
	`uÆock_·ge
(
·ges
[
i
]);

1220 
	`put_·ge
(
·ges
[
i
]);

1222 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

1223  
i_dÚe
;

1224 
out
:

1225 
i
 = 0; i < 
i_dÚe
; i++) {

1226 
	`uÆock_·ge
(
·ges
[
i
]);

1227 
	`put_·ge
(
·ges
[
i
]);

1229 
	`bŒfs_d–®loc_»Ëa£_¥aû
(
šode
, 
d©a_»£rved
,

1230 
¡¬t_šdex
 << 
PAGE_SHIFT
,

1231 
·ge_út
 << 
PAGE_SHIFT
);

1232 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

1233  
»t
;

1235 
	}
}

1237 
	$bŒfs_deäag_fže
(
šode
 *šode, 
fže
 *file,

1238 
bŒfs_ioùl_deäag_¿nge_¬gs
 *
¿nge
,

1239 
u64
 
Ãw”_thª
, 
max_to_deäag
)

1241 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1242 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1243 
fže_¿_¡©e
 *
¿
 = 
NULL
;

1244 
Ï¡_šdex
;

1245 
u64
 
isize
 = 
	`i_size_»ad
(
šode
);

1246 
u64
 
Ï¡_Ën
 = 0;

1247 
u64
 
sk
 = 0;

1248 
u64
 
deäag_’d
 = 0;

1249 
u64
 
Ãw”_off
 = 
¿nge
->
¡¬t
;

1250 
i
;

1251 
¿_šdex
 = 0;

1252 
»t
;

1253 
deäag_couÁ
 = 0;

1254 
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

1255 
u32
 
ex‹Á_th»sh
 = 
¿nge
->extent_thresh;

1256 
max_þu¡”
 = 
SZ_256K
 >> 
PAGE_SHIFT
;

1257 
þu¡”
 = 
max_þu¡”
;

1258 
u64
 
Ãw_®ign
 = ~((u64)
SZ_128K
 - 1);

1259 
·ge
 **
·ges
 = 
NULL
;

1260 
boÞ
 
do_com´ess
 = 
¿nge
->
æags
 & 
BTRFS_DEFRAG_RANGE_COMPRESS
;

1262 ià(
isize
 == 0)

1265 ià(
¿nge
->
¡¬t
 >ð
isize
)

1266  -
EINVAL
;

1268 ià(
do_com´ess
) {

1269 ià(
¿nge
->
com´ess_ty³
 > 
BTRFS_COMPRESS_TYPES
)

1270  -
EINVAL
;

1271 ià(
¿nge
->
com´ess_ty³
)

1272 
com´ess_ty³
 = 
¿nge
->compress_type;

1275 ià(
ex‹Á_th»sh
 == 0)

1276 
ex‹Á_th»sh
 = 
SZ_256K
;

1283 ià(!
fže
) {

1284 
¿
 = 
	`kz®loc
((*¿), 
GFP_KERNEL
);

1285 ià(
¿
)

1286 
	`fže_¿_¡©e_š™
(
¿
, 
šode
->
i_m­pšg
);

1288 
¿
 = &
fže
->
f_¿
;

1291 
·ges
 = 
	`km®loc_¬¿y
(
max_þu¡”
, (
·ge
 *), 
GFP_KERNEL
);

1292 ià(!
·ges
) {

1293 
»t
 = -
ENOMEM
;

1294 
out_¿
;

1298 ià(
¿nge
->
¡¬t
 +„ªge->
Ën
 >„ange->start) {

1299 
Ï¡_šdex
 = 
	`mš_t
(
u64
, 
isize
 - 1,

1300 
¿nge
->
¡¬t
 +„ªge->
Ën
 - 1è>> 
PAGE_SHIFT
;

1302 
Ï¡_šdex
 = (
isize
 - 1è>> 
PAGE_SHIFT
;

1305 ià(
Ãw”_thª
) {

1306 
»t
 = 
	`fšd_Ãw_ex‹Ás
(
roÙ
, 
šode
, 
Ãw”_thª
,

1307 &
Ãw”_off
, 
SZ_64K
);

1308 ià(!
»t
) {

1309 
¿nge
->
¡¬t
 = 
Ãw”_off
;

1314 
i
 = (
Ãw”_off
 & 
Ãw_®ign
è>> 
PAGE_SHIFT
;

1316 
out_¿
;

1318 
i
 = 
¿nge
->
¡¬t
 >> 
PAGE_SHIFT
;

1320 ià(!
max_to_deäag
)

1321 
max_to_deäag
 = 
Ï¡_šdex
 - 
i
 + 1;

1327 ià(
i
 < 
šode
->
i_m­pšg
->
wr™eback_šdex
)

1328 
šode
->
i_m­pšg
->
wr™eback_šdex
 = 
i
;

1330 
i
 <ð
Ï¡_šdex
 && 
deäag_couÁ
 < 
max_to_deäag
 &&

1331 (
i
 < 
	`DIV_ROUND_UP
(
	`i_size_»ad
(
šode
), 
PAGE_SIZE
))) {

1336 ià(!(
šode
->
i_sb
->
s_æags
 & 
MS_ACTIVE
))

1339 ià(
	`bŒfs_deäag_ÿnûÎed
(
fs_šfo
)) {

1340 
	`bŒfs_debug
(
fs_šfo
, "defrag_file cancelled");

1341 
»t
 = -
EAGAIN
;

1345 ià(!
	`should_deäag_¿nge
(
šode
, (
u64
)
i
 << 
PAGE_SHIFT
,

1346 
ex‹Á_th»sh
, &
Ï¡_Ën
, &
sk
,

1347 &
deäag_’d
, 
do_com´ess
)){

1348 
Ãxt
;

1353 
Ãxt
 = 
	`DIV_ROUND_UP
(
sk
, 
PAGE_SIZE
);

1354 
i
 = 
	`max
(˜+ 1, 
Ãxt
);

1358 ià(!
Ãw”_thª
) {

1359 
þu¡”
 = (
	`PAGE_ALIGN
(
deäag_’d
) >>

1360 
PAGE_SHIFT
è- 
i
;

1361 
þu¡”
 = 
	`mš
(þu¡”, 
max_þu¡”
);

1363 
þu¡”
 = 
max_þu¡”
;

1366 ià(
i
 + 
þu¡”
 > 
¿_šdex
) {

1367 
¿_šdex
 = 
	`max
(
i
,„a_index);

1368 ià(
¿
)

1369 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, 
¿
,

1370 
fže
, 
¿_šdex
, 
þu¡”
);

1371 
¿_šdex
 +ð
þu¡”
;

1374 
	`šode_lock
(
šode
);

1375 ià(
do_com´ess
)

1376 
	`BTRFS_I
(
šode
)->
deäag_com´ess
 = 
com´ess_ty³
;

1377 
»t
 = 
	`þu¡”_·ges_fÜ_deäag
(
šode
, 
·ges
, 
i
, 
þu¡”
);

1378 ià(
»t
 < 0) {

1379 
	`šode_uÆock
(
šode
);

1380 
out_¿
;

1383 
deäag_couÁ
 +ð
»t
;

1384 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
šode
->
i_m­pšg
);

1385 
	`šode_uÆock
(
šode
);

1387 ià(
Ãw”_thª
) {

1388 ià(
Ãw”_off
 =ð(
u64
)-1)

1391 ià(
»t
 > 0)

1392 
i
 +ð
»t
;

1394 
Ãw”_off
 = 
	`max
(newer_off + 1,

1395 (
u64
)
i
 << 
PAGE_SHIFT
);

1397 
»t
 = 
	`fšd_Ãw_ex‹Ás
(
roÙ
, 
šode
, 
Ãw”_thª
,

1398 &
Ãw”_off
, 
SZ_64K
);

1399 ià(!
»t
) {

1400 
¿nge
->
¡¬t
 = 
Ãw”_off
;

1401 
i
 = (
Ãw”_off
 & 
Ãw_®ign
è>> 
PAGE_SHIFT
;

1406 ià(
»t
 > 0) {

1407 
i
 +ð
»t
;

1408 
Ï¡_Ën
 +ð
»t
 << 
PAGE_SHIFT
;

1410 
i
++;

1411 
Ï¡_Ën
 = 0;

1416 ià((
¿nge
->
æags
 & 
BTRFS_DEFRAG_RANGE_START_IO
)) {

1417 
	`fžem­_æush
(
šode
->
i_m­pšg
);

1418 ià(
	`‹¡_b™
(
BTRFS_INODE_HAS_ASYNC_EXTENT
,

1419 &
	`BTRFS_I
(
šode
)->
ruÁime_æags
))

1420 
	`fžem­_æush
(
šode
->
i_m­pšg
);

1423 ià(
do_com´ess
) {

1428 
	`©omic_šc
(&
fs_šfo
->
async_subm™_d¿ššg
);

1429 
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) ||

1430 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
)) {

1431 
	`wa™_ev’t
(
fs_šfo
->
async_subm™_wa™
,

1432 (
	`©omic_»ad
(&
fs_šfo
->
Ä_async_subm™s
) == 0 &&

1433 
	`©omic_»ad
(&
fs_šfo
->
async_d–®loc_·ges
) == 0));

1435 
	`©omic_dec
(&
fs_šfo
->
async_subm™_d¿ššg
);

1438 ià(
¿nge
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_LZO
) {

1439 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
COMPRESS_LZO
);

1440 } ià(
¿nge
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_ZSTD
) {

1441 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
COMPRESS_ZSTD
);

1444 
»t
 = 
deäag_couÁ
;

1446 
out_¿
:

1447 ià(
do_com´ess
) {

1448 
	`šode_lock
(
šode
);

1449 
	`BTRFS_I
(
šode
)->
deäag_com´ess
 = 
BTRFS_COMPRESS_NONE
;

1450 
	`šode_uÆock
(
šode
);

1452 ià(!
fže
)

1453 
	`kä“
(
¿
);

1454 
	`kä“
(
·ges
);

1455  
»t
;

1456 
	}
}

1458 
nošlše
 
	$bŒfs_ioùl_»size
(
fže
 *file,

1459 
__u£r
 *
¬g
)

1461 
šode
 *šodð
	`fže_šode
(
fže
);

1462 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1463 
u64
 
Ãw_size
;

1464 
u64
 
Þd_size
;

1465 
u64
 
devid
 = 1;

1466 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1467 
bŒfs_ioùl_vÞ_¬gs
 *
vÞ_¬gs
;

1468 
bŒfs_Œªs_hªdË
 *
Œªs
;

1469 
bŒfs_deviû
 *
deviû
 = 
NULL
;

1470 *
size¡r
;

1471 *
»Œ
;

1472 *
dev¡r
 = 
NULL
;

1473 
»t
 = 0;

1474 
mod
 = 0;

1476 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

1477  -
EPERM
;

1479 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

1480 ià(
»t
)

1481  
»t
;

1483 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
)) {

1484 
	`mÁ_drÝ_wr™e_fže
(
fže
);

1485  
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

1488 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

1489 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

1490 ià(
	`IS_ERR
(
vÞ_¬gs
)) {

1491 
»t
 = 
	`PTR_ERR
(
vÞ_¬gs
);

1492 
out
;

1495 
vÞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

1497 
size¡r
 = 
vÞ_¬gs
->
Çme
;

1498 
dev¡r
 = 
	`¡rchr
(
size¡r
, ':');

1499 ià(
dev¡r
) {

1500 
size¡r
 = 
dev¡r
 + 1;

1501 *
dev¡r
 = '\0';

1502 
dev¡r
 = 
vÞ_¬gs
->
Çme
;

1503 
»t
 = 
	`k¡¹ouÎ
(
dev¡r
, 10, &
devid
);

1504 ià(
»t
)

1505 
out_ä“
;

1506 ià(!
devid
) {

1507 
»t
 = -
EINVAL
;

1508 
out_ä“
;

1510 
	`bŒfs_šfo
(
fs_šfo
, "»sizšg devid %Îu", 
devid
);

1513 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
NULL
, NULL);

1514 ià(!
deviû
) {

1515 
	`bŒfs_šfo
(
fs_šfo
, "resizer unableo find device %llu",

1516 
devid
);

1517 
»t
 = -
ENODEV
;

1518 
out_ä“
;

1521 ià(!
deviû
->
wr™—bË
) {

1522 
	`bŒfs_šfo
(
fs_šfo
,

1524 
devid
);

1525 
»t
 = -
EPERM
;

1526 
out_ä“
;

1529 ià(!
	`¡rcmp
(
size¡r
, "max"))

1530 
Ãw_size
 = 
deviû
->
bdev
->
bd_šode
->
i_size
;

1532 ià(
size¡r
[0] == '-') {

1533 
mod
 = -1;

1534 
size¡r
++;

1535 } ià(
size¡r
[0] == '+') {

1536 
mod
 = 1;

1537 
size¡r
++;

1539 
Ãw_size
 = 
	`mem·r£
(
size¡r
, &
»Œ
);

1540 ià(*
»Œ
 !ð'\0' || 
Ãw_size
 == 0) {

1541 
»t
 = -
EINVAL
;

1542 
out_ä“
;

1546 ià(
deviû
->
is_tgtdev_fÜ_dev_»¶aû
) {

1547 
»t
 = -
EPERM
;

1548 
out_ä“
;

1551 
Þd_size
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
deviû
);

1553 ià(
mod
 < 0) {

1554 ià(
Ãw_size
 > 
Þd_size
) {

1555 
»t
 = -
EINVAL
;

1556 
out_ä“
;

1558 
Ãw_size
 = 
Þd_size
 -‚ew_size;

1559 } ià(
mod
 > 0) {

1560 ià(
Ãw_size
 > 
ULLONG_MAX
 - 
Þd_size
) {

1561 
»t
 = -
ERANGE
;

1562 
out_ä“
;

1564 
Ãw_size
 = 
Þd_size
 +‚ew_size;

1567 ià(
Ãw_size
 < 
SZ_256M
) {

1568 
»t
 = -
EINVAL
;

1569 
out_ä“
;

1571 ià(
Ãw_size
 > 
deviû
->
bdev
->
bd_šode
->
i_size
) {

1572 
»t
 = -
EFBIG
;

1573 
out_ä“
;

1576 
Ãw_size
 = 
	`round_down
Òew_size, 
fs_šfo
->
£ùÜsize
);

1578 
	`bŒfs_šfo_š_rcu
(
fs_šfo
, "new size for %s is %llu",

1579 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
Ãw_size
);

1581 ià(
Ãw_size
 > 
Þd_size
) {

1582 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1583 ià(
	`IS_ERR
(
Œªs
)) {

1584 
»t
 = 
	`PTR_ERR
(
Œªs
);

1585 
out_ä“
;

1587 
»t
 = 
	`bŒfs_grow_deviû
(
Œªs
, 
deviû
, 
Ãw_size
);

1588 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1589 } ià(
Ãw_size
 < 
Þd_size
) {

1590 
»t
 = 
	`bŒfs_shršk_deviû
(
deviû
, 
Ãw_size
);

1593 
out_ä“
:

1594 
	`kä“
(
vÞ_¬gs
);

1595 
out
:

1596 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

1597 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

1598 
	`mÁ_drÝ_wr™e_fže
(
fže
);

1599  
»t
;

1600 
	}
}

1602 
nošlše
 
	$bŒfs_ioùl_¢­_ü—‹_Œªsid
(
fže
 *file,

1603 cÚ¡ *
Çme
, 
fd
, 
subvÞ
,

1604 
u64
 *
Œªsid
, 
boÞ
 
»adÚly
,

1605 
bŒfs_qgroup_šh”™
 *
šh”™
)

1607 
Çm–’
;

1608 
»t
 = 0;

1610 ià(!
	`S_ISDIR
(
	`fže_šode
(
fže
)->
i_mode
))

1611  -
ENOTDIR
;

1613 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

1614 ià(
»t
)

1615 
out
;

1617 
Çm–’
 = 
	`¡¾’
(
Çme
);

1618 ià(
	`¡rchr
(
Çme
, '/')) {

1619 
»t
 = -
EINVAL
;

1620 
out_drÝ_wr™e
;

1623 ià(
Çme
[0] == '.' &&

1624 (
Çm–’
 =ð1 || (
Çme
[1] == '.' &&‚amelen == 2))) {

1625 
»t
 = -
EEXIST
;

1626 
out_drÝ_wr™e
;

1629 ià(
subvÞ
) {

1630 
»t
 = 
	`bŒfs_mksubvÞ
(&
fže
->
f_·th
, 
Çme
, 
Çm–’
,

1631 
NULL
, 
Œªsid
, 
»adÚly
, 
šh”™
);

1633 
fd
 
¤c
 = 
	`fdg‘
(fd);

1634 
šode
 *
¤c_šode
;

1635 ià(!
¤c
.
fže
) {

1636 
»t
 = -
EINVAL
;

1637 
out_drÝ_wr™e
;

1640 
¤c_šode
 = 
	`fže_šode
(
¤c
.
fže
);

1641 ià(
¤c_šode
->
i_sb
 !ð
	`fže_šode
(
fže
)->i_sb) {

1642 
	`bŒfs_šfo
(
	`BTRFS_I
(
	`fže_šode
(
fže
))->
roÙ
->
fs_šfo
,

1644 
»t
 = -
EXDEV
;

1645 } ià(!
	`šode_owÃr_Ü_ÿ·bË
(
¤c_šode
)) {

1650 
»t
 = -
EPERM
;

1652 
»t
 = 
	`bŒfs_mksubvÞ
(&
fže
->
f_·th
, 
Çme
, 
Çm–’
,

1653 
	`BTRFS_I
(
¤c_šode
)->
roÙ
,

1654 
Œªsid
, 
»adÚly
, 
šh”™
);

1656 
	`fdput
(
¤c
);

1658 
out_drÝ_wr™e
:

1659 
	`mÁ_drÝ_wr™e_fže
(
fže
);

1660 
out
:

1661  
»t
;

1662 
	}
}

1664 
nošlše
 
	$bŒfs_ioùl_¢­_ü—‹
(
fže
 *file,

1665 
__u£r
 *
¬g
, 
subvÞ
)

1667 
bŒfs_ioùl_vÞ_¬gs
 *
vÞ_¬gs
;

1668 
»t
;

1670 ià(!
	`S_ISDIR
(
	`fže_šode
(
fže
)->
i_mode
))

1671  -
ENOTDIR
;

1673 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

1674 ià(
	`IS_ERR
(
vÞ_¬gs
))

1675  
	`PTR_ERR
(
vÞ_¬gs
);

1676 
vÞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

1678 
»t
 = 
	`bŒfs_ioùl_¢­_ü—‹_Œªsid
(
fže
, 
vÞ_¬gs
->
Çme
,

1679 
vÞ_¬gs
->
fd
, 
subvÞ
,

1680 
NULL
, 
çl£
, NULL);

1682 
	`kä“
(
vÞ_¬gs
);

1683  
»t
;

1684 
	}
}

1686 
nošlše
 
	$bŒfs_ioùl_¢­_ü—‹_v2
(
fže
 *file,

1687 
__u£r
 *
¬g
, 
subvÞ
)

1689 
bŒfs_ioùl_vÞ_¬gs_v2
 *
vÞ_¬gs
;

1690 
»t
;

1691 
u64
 
Œªsid
 = 0;

1692 
u64
 *
±r
 = 
NULL
;

1693 
boÞ
 
»adÚly
 = 
çl£
;

1694 
bŒfs_qgroup_šh”™
 *
šh”™
 = 
NULL
;

1696 ià(!
	`S_ISDIR
(
	`fže_šode
(
fže
)->
i_mode
))

1697  -
ENOTDIR
;

1699 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

1700 ià(
	`IS_ERR
(
vÞ_¬gs
))

1701  
	`PTR_ERR
(
vÞ_¬gs
);

1702 
vÞ_¬gs
->
Çme
[
BTRFS_SUBVOL_NAME_MAX
] = '\0';

1704 ià(
vÞ_¬gs
->
æags
 &

1705 ~(
BTRFS_SUBVOL_CREATE_ASYNC
 | 
BTRFS_SUBVOL_RDONLY
 |

1706 
BTRFS_SUBVOL_QGROUP_INHERIT
)) {

1707 
»t
 = -
EOPNOTSUPP
;

1708 
ä“_¬gs
;

1711 ià(
vÞ_¬gs
->
æags
 & 
BTRFS_SUBVOL_CREATE_ASYNC
)

1712 
±r
 = &
Œªsid
;

1713 ià(
vÞ_¬gs
->
æags
 & 
BTRFS_SUBVOL_RDONLY
)

1714 
»adÚly
 = 
Œue
;

1715 ià(
vÞ_¬gs
->
æags
 & 
BTRFS_SUBVOL_QGROUP_INHERIT
) {

1716 ià(
vÞ_¬gs
->
size
 > 
PAGE_SIZE
) {

1717 
»t
 = -
EINVAL
;

1718 
ä“_¬gs
;

1720 
šh”™
 = 
	`memdup_u£r
(
vÞ_¬gs
->
qgroup_šh”™
, vÞ_¬gs->
size
);

1721 ià(
	`IS_ERR
(
šh”™
)) {

1722 
»t
 = 
	`PTR_ERR
(
šh”™
);

1723 
ä“_¬gs
;

1727 
»t
 = 
	`bŒfs_ioùl_¢­_ü—‹_Œªsid
(
fže
, 
vÞ_¬gs
->
Çme
,

1728 
vÞ_¬gs
->
fd
, 
subvÞ
, 
±r
,

1729 
»adÚly
, 
šh”™
);

1730 ià(
»t
)

1731 
ä“_šh”™
;

1733 ià(
±r
 && 
	`cÝy_to_u£r
(
¬g
 +

1734 
	`off£tof
(
bŒfs_ioùl_vÞ_¬gs_v2
,

1735 
Œªsid
),

1736 
±r
, (*ptr)))

1737 
»t
 = -
EFAULT
;

1739 
ä“_šh”™
:

1740 
	`kä“
(
šh”™
);

1741 
ä“_¬gs
:

1742 
	`kä“
(
vÞ_¬gs
);

1743  
»t
;

1744 
	}
}

1746 
nošlše
 
	$bŒfs_ioùl_subvÞ_g‘æags
(
fže
 *file,

1747 
__u£r
 *
¬g
)

1749 
šode
 *šodð
	`fže_šode
(
fže
);

1750 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1751 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1752 
»t
 = 0;

1753 
u64
 
æags
 = 0;

1755 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ð
BTRFS_FIRST_FREE_OBJECTID
)

1756  -
EINVAL
;

1758 
	`down_»ad
(&
fs_šfo
->
subvÞ_£m
);

1759 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

1760 
æags
 |ð
BTRFS_SUBVOL_RDONLY
;

1761 
	`up_»ad
(&
fs_šfo
->
subvÞ_£m
);

1763 ià(
	`cÝy_to_u£r
(
¬g
, &
æags
, (flags)))

1764 
»t
 = -
EFAULT
;

1766  
»t
;

1767 
	}
}

1769 
nošlše
 
	$bŒfs_ioùl_subvÞ_£tæags
(
fže
 *file,

1770 
__u£r
 *
¬g
)

1772 
šode
 *šodð
	`fže_šode
(
fže
);

1773 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

1774 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

1775 
bŒfs_Œªs_hªdË
 *
Œªs
;

1776 
u64
 
roÙ_æags
;

1777 
u64
 
æags
;

1778 
»t
 = 0;

1780 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

1781  -
EPERM
;

1783 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

1784 ià(
»t
)

1785 
out
;

1787 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ð
BTRFS_FIRST_FREE_OBJECTID
) {

1788 
»t
 = -
EINVAL
;

1789 
out_drÝ_wr™e
;

1792 ià(
	`cÝy_äom_u£r
(&
æags
, 
¬g
, (flags))) {

1793 
»t
 = -
EFAULT
;

1794 
out_drÝ_wr™e
;

1797 ià(
æags
 & 
BTRFS_SUBVOL_CREATE_ASYNC
) {

1798 
»t
 = -
EINVAL
;

1799 
out_drÝ_wr™e
;

1802 ià(
æags
 & ~
BTRFS_SUBVOL_RDONLY
) {

1803 
»t
 = -
EOPNOTSUPP
;

1804 
out_drÝ_wr™e
;

1807 
	`down_wr™e
(&
fs_šfo
->
subvÞ_£m
);

1810 ià(!!(
æags
 & 
BTRFS_SUBVOL_RDONLY
è=ð
	`bŒfs_roÙ_»adÚly
(
roÙ
))

1811 
out_drÝ_£m
;

1813 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(&
roÙ
->
roÙ_™em
);

1814 ià(
æags
 & 
BTRFS_SUBVOL_RDONLY
) {

1815 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
,

1816 
roÙ_æags
 | 
BTRFS_ROOT_SUBVOL_RDONLY
);

1822 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

1823 ià(
roÙ
->
£nd_š_´og»ss
 == 0) {

1824 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
,

1825 
roÙ_æags
 & ~
BTRFS_ROOT_SUBVOL_RDONLY
);

1826 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

1828 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

1829 
	`bŒfs_w¬n
(
fs_šfo
,

1831 
roÙ
->
roÙ_key
.
objeùid
);

1832 
»t
 = -
EPERM
;

1833 
out_drÝ_£m
;

1837 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

1838 ià(
	`IS_ERR
(
Œªs
)) {

1839 
»t
 = 
	`PTR_ERR
(
Œªs
);

1840 
out_»£t
;

1843 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

1844 &
roÙ
->
roÙ_key
, &roÙ->
roÙ_™em
);

1846 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1847 
out_»£t
:

1848 ià(
»t
)

1849 
	`bŒfs_£t_roÙ_æags
(&
roÙ
->
roÙ_™em
, 
roÙ_æags
);

1850 
out_drÝ_£m
:

1851 
	`up_wr™e
(&
fs_šfo
->
subvÞ_£m
);

1852 
out_drÝ_wr™e
:

1853 
	`mÁ_drÝ_wr™e_fže
(
fže
);

1854 
out
:

1855  
»t
;

1856 
	}
}

1861 
nošlše
 
	$may_de¡roy_subvÞ
(
bŒfs_roÙ
 *
roÙ
)

1863 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1864 
bŒfs_·th
 *
·th
;

1865 
bŒfs_dœ_™em
 *
di
;

1866 
bŒfs_key
 
key
;

1867 
u64
 
dœ_id
;

1868 
»t
;

1870 
·th
 = 
	`bŒfs_®loc_·th
();

1871 ià(!
·th
)

1872  -
ENOMEM
;

1875 
dœ_id
 = 
	`bŒfs_su³r_roÙ_dœ
(
fs_šfo
->
su³r_cÝy
);

1876 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, 
·th
,

1877 
dœ_id
, "default", 7, 0);

1878 ià(
di
 && !
	`IS_ERR
(di)) {

1879 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
key
);

1880 ià(
key
.
objeùid
 =ð
roÙ
->
roÙ_key
.objectid) {

1881 
»t
 = -
EPERM
;

1882 
	`bŒfs_”r
(
fs_šfo
,

1884 
key
.
objeùid
);

1885 
out
;

1887 
	`bŒfs_»Ëa£_·th
(
·th
);

1890 
key
.
objeùid
 = 
roÙ
->
roÙ_key
.objectid;

1891 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

1892 
key
.
off£t
 = (
u64
)-1;

1894 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

1895 ià(
»t
 < 0)

1896 
out
;

1897 
	`BUG_ON
(
»t
 == 0);

1899 
»t
 = 0;

1900 ià(
·th
->
¦Ùs
[0] > 0) {

1901 
·th
->
¦Ùs
[0]--;

1902 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1903 ià(
key
.
objeùid
 =ð
roÙ
->
roÙ_key
.objectid &&

1904 
key
.
ty³
 =ð
BTRFS_ROOT_REF_KEY
)

1905 
»t
 = -
ENOTEMPTY
;

1907 
out
:

1908 
	`bŒfs_ä“_·th
(
·th
);

1909  
»t
;

1910 
	}
}

1912 
nošlše
 
	$key_š_sk
(
bŒfs_key
 *
key
,

1913 
bŒfs_ioùl_£¬ch_key
 *
sk
)

1915 
bŒfs_key
 
‹¡
;

1916 
»t
;

1918 
‹¡
.
objeùid
 = 
sk
->
mš_objeùid
;

1919 
‹¡
.
ty³
 = 
sk
->
mš_ty³
;

1920 
‹¡
.
off£t
 = 
sk
->
mš_off£t
;

1922 
»t
 = 
	`bŒfs_comp_ýu_keys
(
key
, &
‹¡
);

1923 ià(
»t
 < 0)

1926 
‹¡
.
objeùid
 = 
sk
->
max_objeùid
;

1927 
‹¡
.
ty³
 = 
sk
->
max_ty³
;

1928 
‹¡
.
off£t
 = 
sk
->
max_off£t
;

1930 
»t
 = 
	`bŒfs_comp_ýu_keys
(
key
, &
‹¡
);

1931 ià(
»t
 > 0)

1934 
	}
}

1936 
nošlše
 
	$cÝy_to_sk
(
bŒfs_·th
 *
·th
,

1937 
bŒfs_key
 *
key
,

1938 
bŒfs_ioùl_£¬ch_key
 *
sk
,

1939 
size_t
 *
buf_size
,

1940 
__u£r
 *
ubuf
,

1941 *
sk_off£t
,

1942 *
num_found
)

1944 
u64
 
found_Œªsid
;

1945 
ex‹Á_bufãr
 *
Ëaf
;

1946 
bŒfs_ioùl_£¬ch_h—d”
 
sh
;

1947 
bŒfs_key
 
‹¡
;

1948 
™em_off
;

1949 
™em_Ën
;

1950 
Ä™ems
;

1951 
i
;

1952 
¦Ù
;

1953 
»t
 = 0;

1955 
Ëaf
 = 
·th
->
nodes
[0];

1956 
¦Ù
 = 
·th
->
¦Ùs
[0];

1957 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1959 ià(
	`bŒfs_h—d”_g’”©iÚ
(
Ëaf
è> 
sk
->
max_Œªsid
) {

1960 
i
 = 
Ä™ems
;

1961 
advªû_key
;

1963 
found_Œªsid
 = 
	`bŒfs_h—d”_g’”©iÚ
(
Ëaf
);

1965 
i
 = 
¦Ù
; i < 
Ä™ems
; i++) {

1966 
™em_off
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
i
);

1967 
™em_Ën
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
i
);

1969 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, 
key
, 
i
);

1970 ià(!
	`key_š_sk
(
key
, 
sk
))

1973 ià((
sh
è+ 
™em_Ën
 > *
buf_size
) {

1974 ià(*
num_found
) {

1975 
»t
 = 1;

1976 
out
;

1984 *
buf_size
 = (
sh
è+ 
™em_Ën
;

1985 
™em_Ën
 = 0;

1986 
»t
 = -
EOVERFLOW
;

1989 ià((
sh
è+ 
™em_Ën
 + *
sk_off£t
 > *
buf_size
) {

1990 
»t
 = 1;

1991 
out
;

1994 
sh
.
objeùid
 = 
key
->objectid;

1995 
sh
.
off£t
 = 
key
->offset;

1996 
sh
.
ty³
 = 
key
->type;

1997 
sh
.
Ën
 = 
™em_Ën
;

1998 
sh
.
Œªsid
 = 
found_Œªsid
;

2001 ià(
	`cÝy_to_u£r
(
ubuf
 + *
sk_off£t
, &
sh
, (sh))) {

2002 
»t
 = -
EFAULT
;

2003 
out
;

2006 *
sk_off£t
 +ð(
sh
);

2008 ià(
™em_Ën
) {

2009 
__u£r
 *
up
 = 
ubuf
 + *
sk_off£t
;

2011 ià(
	`»ad_ex‹Á_bufãr_to_u£r
(
Ëaf
, 
up
,

2012 
™em_off
, 
™em_Ën
)) {

2013 
»t
 = -
EFAULT
;

2014 
out
;

2017 *
sk_off£t
 +ð
™em_Ën
;

2019 (*
num_found
)++;

2021 ià(
»t
)

2022 
out
;

2024 ià(*
num_found
 >ð
sk
->
Ä_™ems
) {

2025 
»t
 = 1;

2026 
out
;

2029 
advªû_key
:

2030 
»t
 = 0;

2031 
‹¡
.
objeùid
 = 
sk
->
max_objeùid
;

2032 
‹¡
.
ty³
 = 
sk
->
max_ty³
;

2033 
‹¡
.
off£t
 = 
sk
->
max_off£t
;

2034 ià(
	`bŒfs_comp_ýu_keys
(
key
, &
‹¡
) >= 0)

2035 
»t
 = 1;

2036 ià(
key
->
off£t
 < (
u64
)-1)

2037 
key
->
off£t
++;

2038 ià(
key
->
ty³
 < (
u8
)-1) {

2039 
key
->
off£t
 = 0;

2040 
key
->
ty³
++;

2041 } ià(
key
->
objeùid
 < (
u64
)-1) {

2042 
key
->
off£t
 = 0;

2043 
key
->
ty³
 = 0;

2044 
key
->
objeùid
++;

2046 
»t
 = 1;

2047 
out
:

2057  
»t
;

2058 
	}
}

2060 
nošlše
 
	$£¬ch_ioùl
(
šode
 *inode,

2061 
bŒfs_ioùl_£¬ch_key
 *
sk
,

2062 
size_t
 *
buf_size
,

2063 
__u£r
 *
ubuf
)

2065 
bŒfs_fs_šfo
 *
šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2066 
bŒfs_roÙ
 *
roÙ
;

2067 
bŒfs_key
 
key
;

2068 
bŒfs_·th
 *
·th
;

2069 
»t
;

2070 
num_found
 = 0;

2071 
sk_off£t
 = 0;

2073 ià(*
buf_size
 < (
bŒfs_ioùl_£¬ch_h—d”
)) {

2074 *
buf_size
 = (
bŒfs_ioùl_£¬ch_h—d”
);

2075  -
EOVERFLOW
;

2078 
·th
 = 
	`bŒfs_®loc_·th
();

2079 ià(!
·th
)

2080  -
ENOMEM
;

2082 ià(
sk
->
Œ“_id
 == 0) {

2084 
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2086 
key
.
objeùid
 = 
sk
->
Œ“_id
;

2087 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2088 
key
.
off£t
 = (
u64
)-1;

2089 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
šfo
, &
key
);

2090 ià(
	`IS_ERR
(
roÙ
)) {

2091 
	`bŒfs_ä“_·th
(
·th
);

2092  -
ENOENT
;

2096 
key
.
objeùid
 = 
sk
->
mš_objeùid
;

2097 
key
.
ty³
 = 
sk
->
mš_ty³
;

2098 
key
.
off£t
 = 
sk
->
mš_off£t
;

2101 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 
sk
->
mš_Œªsid
);

2102 ià(
»t
 != 0) {

2103 ià(
»t
 > 0)

2104 
»t
 = 0;

2105 
”r
;

2107 
»t
 = 
	`cÝy_to_sk
(
·th
, &
key
, 
sk
, 
buf_size
, 
ubuf
,

2108 &
sk_off£t
, &
num_found
);

2109 
	`bŒfs_»Ëa£_·th
(
·th
);

2110 ià(
»t
)

2114 ià(
»t
 > 0)

2115 
»t
 = 0;

2116 
”r
:

2117 
sk
->
Ä_™ems
 = 
num_found
;

2118 
	`bŒfs_ä“_·th
(
·th
);

2119  
»t
;

2120 
	}
}

2122 
nošlše
 
	$bŒfs_ioùl_Œ“_£¬ch
(
fže
 *file,

2123 
__u£r
 *
¬gp
)

2125 
bŒfs_ioùl_£¬ch_¬gs
 
__u£r
 *
u¬gs
;

2126 
bŒfs_ioùl_£¬ch_key
 
sk
;

2127 
šode
 *inode;

2128 
»t
;

2129 
size_t
 
buf_size
;

2131 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2132  -
EPERM
;

2134 
u¬gs
 = (
bŒfs_ioùl_£¬ch_¬gs
 
__u£r
 *)
¬gp
;

2136 ià(
	`cÝy_äom_u£r
(&
sk
, &
u¬gs
->
key
, (sk)))

2137  -
EFAULT
;

2139 
buf_size
 = (
u¬gs
->
buf
);

2141 
šode
 = 
	`fže_šode
(
fže
);

2142 
»t
 = 
	`£¬ch_ioùl
(
šode
, &
sk
, &
buf_size
, 
u¬gs
->
buf
);

2148 ià(
»t
 =ð-
EOVERFLOW
)

2149 
»t
 = 0;

2151 ià(
»t
 =ð0 && 
	`cÝy_to_u£r
(&
u¬gs
->
key
, &
sk
, (sk)))

2152 
»t
 = -
EFAULT
;

2153  
»t
;

2154 
	}
}

2156 
nošlše
 
	$bŒfs_ioùl_Œ“_£¬ch_v2
(
fže
 *file,

2157 
__u£r
 *
¬gp
)

2159 
bŒfs_ioùl_£¬ch_¬gs_v2
 
__u£r
 *
u¬g
;

2160 
bŒfs_ioùl_£¬ch_¬gs_v2
 
¬gs
;

2161 
šode
 *inode;

2162 
»t
;

2163 
size_t
 
buf_size
;

2164 cÚ¡ 
size_t
 
buf_lim™
 = 
SZ_16M
;

2166 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2167  -
EPERM
;

2170 
u¬g
 = (
bŒfs_ioùl_£¬ch_¬gs_v2
 
__u£r
 *)
¬gp
;

2171 ià(
	`cÝy_äom_u£r
(&
¬gs
, 
u¬g
, (args)))

2172  -
EFAULT
;

2174 
buf_size
 = 
¬gs
.buf_size;

2177 ià(
buf_size
 > 
buf_lim™
)

2178 
buf_size
 = 
buf_lim™
;

2180 
šode
 = 
	`fže_šode
(
fže
);

2181 
»t
 = 
	`£¬ch_ioùl
(
šode
, &
¬gs
.
key
, &
buf_size
,

2182 (*)(&
u¬g
->
buf
[0]));

2183 ià(
»t
 =ð0 && 
	`cÝy_to_u£r
(&
u¬g
->
key
, &
¬gs
.key, (args.key)))

2184 
»t
 = -
EFAULT
;

2185 ià(
»t
 =ð-
EOVERFLOW
 &&

2186 
	`cÝy_to_u£r
(&
u¬g
->
buf_size
, &buf_size, (buf_size)))

2187 
»t
 = -
EFAULT
;

2189  
»t
;

2190 
	}
}

2196 
nošlše
 
	$bŒfs_£¬ch_·th_š_Œ“
(
bŒfs_fs_šfo
 *
šfo
,

2197 
u64
 
Œ“_id
, u64 
dœid
, *
Çme
)

2199 
bŒfs_roÙ
 *
roÙ
;

2200 
bŒfs_key
 
key
;

2201 *
±r
;

2202 
»t
 = -1;

2203 
¦Ù
;

2204 
Ën
;

2205 
tÙ®_Ën
 = 0;

2206 
bŒfs_šode_»f
 *
œef
;

2207 
ex‹Á_bufãr
 *
l
;

2208 
bŒfs_·th
 *
·th
;

2210 ià(
dœid
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

2211 
Çme
[0]='\0';

2215 
·th
 = 
	`bŒfs_®loc_·th
();

2216 ià(!
·th
)

2217  -
ENOMEM
;

2219 
±r
 = &
Çme
[
BTRFS_INO_LOOKUP_PATH_MAX
];

2221 
key
.
objeùid
 = 
Œ“_id
;

2222 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2223 
key
.
off£t
 = (
u64
)-1;

2224 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
šfo
, &
key
);

2225 ià(
	`IS_ERR
(
roÙ
)) {

2226 
	`bŒfs_”r
(
šfo
, "could‚Ù fšd„oÙ %Îu", 
Œ“_id
);

2227 
»t
 = -
ENOENT
;

2228 
out
;

2231 
key
.
objeùid
 = 
dœid
;

2232 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

2233 
key
.
off£t
 = (
u64
)-1;

2236 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2237 ià(
»t
 < 0)

2238 
out
;

2239 ià(
»t
 > 0) {

2240 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
dœid
,

2241 
BTRFS_INODE_REF_KEY
);

2242 ià(
»t
 < 0)

2243 
out
;

2244 ià(
»t
 > 0) {

2245 
»t
 = -
ENOENT
;

2246 
out
;

2250 
l
 = 
·th
->
nodes
[0];

2251 
¦Ù
 = 
·th
->
¦Ùs
[0];

2252 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
¦Ù
);

2254 
œef
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_šode_»f
);

2255 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
l
, 
œef
);

2256 
±r
 -ð
Ën
 + 1;

2257 
tÙ®_Ën
 +ð
Ën
 + 1;

2258 ià(
±r
 < 
Çme
) {

2259 
»t
 = -
ENAMETOOLONG
;

2260 
out
;

2263 *(
±r
 + 
Ën
) = '/';

2264 
	`»ad_ex‹Á_bufãr
(
l
, 
±r
, ()(
œef
 + 1), 
Ën
);

2266 ià(
key
.
off£t
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

2269 
	`bŒfs_»Ëa£_·th
(
·th
);

2270 
key
.
objeùid
 = key.
off£t
;

2271 
key
.
off£t
 = (
u64
)-1;

2272 
dœid
 = 
key
.
objeùid
;

2274 
	`memmove
(
Çme
, 
±r
, 
tÙ®_Ën
);

2275 
Çme
[
tÙ®_Ën
] = '\0';

2276 
»t
 = 0;

2277 
out
:

2278 
	`bŒfs_ä“_·th
(
·th
);

2279  
»t
;

2280 
	}
}

2282 
nošlše
 
	$bŒfs_ioùl_šo_lookup
(
fže
 *file,

2283 
__u£r
 *
¬gp
)

2285 
bŒfs_ioùl_šo_lookup_¬gs
 *
¬gs
;

2286 
šode
 *inode;

2287 
»t
 = 0;

2289 
¬gs
 = 
	`memdup_u£r
(
¬gp
, (*args));

2290 ià(
	`IS_ERR
(
¬gs
))

2291  
	`PTR_ERR
(
¬gs
);

2293 
šode
 = 
	`fže_šode
(
fže
);

2299 ià(
¬gs
->
Œ“id
 == 0)

2300 
¬gs
->
Œ“id
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
roÙ_key
.
objeùid
;

2302 ià(
¬gs
->
objeùid
 =ð
BTRFS_FIRST_FREE_OBJECTID
) {

2303 
¬gs
->
Çme
[0] = 0;

2304 
out
;

2307 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

2308 
»t
 = -
EPERM
;

2309 
out
;

2312 
»t
 = 
	`bŒfs_£¬ch_·th_š_Œ“
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

2313 
¬gs
->
Œ“id
,‡rgs->
objeùid
,

2314 
¬gs
->
Çme
);

2316 
out
:

2317 ià(
»t
 =ð0 && 
	`cÝy_to_u£r
(
¬gp
, 
¬gs
, (*args)))

2318 
»t
 = -
EFAULT
;

2320 
	`kä“
(
¬gs
);

2321  
»t
;

2322 
	}
}

2324 
nošlše
 
	$bŒfs_ioùl_¢­_de¡roy
(
fže
 *file,

2325 
__u£r
 *
¬g
)

2327 
d’Œy
 *
·»Á
 = 
fže
->
f_·th
.dentry;

2328 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
·»Á
->
d_sb
);

2329 
d’Œy
 *dentry;

2330 
šode
 *
dœ
 = 
	`d_šode
(
·»Á
);

2331 
šode
 *inode;

2332 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
dœ
)->root;

2333 
bŒfs_roÙ
 *
de¡
 = 
NULL
;

2334 
bŒfs_ioùl_vÞ_¬gs
 *
vÞ_¬gs
;

2335 
bŒfs_Œªs_hªdË
 *
Œªs
;

2336 
bŒfs_block_rsv
 
block_rsv
;

2337 
u64
 
roÙ_æags
;

2338 
u64
 
qgroup_»£rved
;

2339 
Çm–’
;

2340 
»t
;

2341 
”r
 = 0;

2343 ià(!
	`S_ISDIR
(
dœ
->
i_mode
))

2344  -
ENOTDIR
;

2346 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2347 ià(
	`IS_ERR
(
vÞ_¬gs
))

2348  
	`PTR_ERR
(
vÞ_¬gs
);

2350 
vÞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

2351 
Çm–’
 = 
	`¡¾’
(
vÞ_¬gs
->
Çme
);

2352 ià(
	`¡rchr
(
vÞ_¬gs
->
Çme
, '/') ||

2353 
	`¡ºcmp
(
vÞ_¬gs
->
Çme
, "..", 
Çm–’
) == 0) {

2354 
”r
 = -
EINVAL
;

2355 
out
;

2358 
”r
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

2359 ià(
”r
)

2360 
out
;

2363 
”r
 = 
	`down_wr™e_kžÏbË_Ã¡ed
(&
dœ
->
i_rw£m
, 
I_MUTEX_PARENT
);

2364 ià(
”r
 =ð-
EINTR
)

2365 
out_drÝ_wr™e
;

2366 
d’Œy
 = 
	`lookup_Úe_Ën
(
vÞ_¬gs
->
Çme
, 
·»Á
, 
Çm–’
);

2367 ià(
	`IS_ERR
(
d’Œy
)) {

2368 
”r
 = 
	`PTR_ERR
(
d’Œy
);

2369 
out_uÆock_dœ
;

2372 ià(
	`d_»®ly_is_Ãg©ive
(
d’Œy
)) {

2373 
”r
 = -
ENOENT
;

2374 
out_dput
;

2377 
šode
 = 
	`d_šode
(
d’Œy
);

2378 
de¡
 = 
	`BTRFS_I
(
šode
)->
roÙ
;

2379 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

2393 
”r
 = -
EPERM
;

2394 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
USER_SUBVOL_RM_ALLOWED
))

2395 
out_dput
;

2404 
”r
 = -
EINVAL
;

2405 ià(
roÙ
 =ð
de¡
)

2406 
out_dput
;

2408 
”r
 = 
	`šode_³rmissiÚ
(
šode
, 
MAY_WRITE
 | 
MAY_EXEC
);

2409 ià(
”r
)

2410 
out_dput
;

2414 
”r
 = 
	`bŒfs_may_d–‘e
(
dœ
, 
d’Œy
, 1);

2415 ià(
”r
)

2416 
out_dput
;

2418 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ð
BTRFS_FIRST_FREE_OBJECTID
) {

2419 
”r
 = -
EINVAL
;

2420 
out_dput
;

2423 
	`šode_lock
(
šode
);

2430 
	`¥š_lock
(&
de¡
->
roÙ_™em_lock
);

2431 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(&
de¡
->
roÙ_™em
);

2432 ià(
de¡
->
£nd_š_´og»ss
 == 0) {

2433 
	`bŒfs_£t_roÙ_æags
(&
de¡
->
roÙ_™em
,

2434 
roÙ_æags
 | 
BTRFS_ROOT_SUBVOL_DEAD
);

2435 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

2437 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

2438 
	`bŒfs_w¬n
(
fs_šfo
,

2440 
de¡
->
roÙ_key
.
objeùid
);

2441 
”r
 = -
EPERM
;

2442 
out_uÆock_šode
;

2445 
	`down_wr™e
(&
fs_šfo
->
subvÞ_£m
);

2447 
”r
 = 
	`may_de¡roy_subvÞ
(
de¡
);

2448 ià(
”r
)

2449 
out_up_wr™e
;

2451 
	`bŒfs_š™_block_rsv
(&
block_rsv
, 
BTRFS_BLOCK_RSV_TEMP
);

2456 
”r
 = 
	`bŒfs_subvÞume_»£rve_m‘ad©a
(
roÙ
, &
block_rsv
,

2457 5, &
qgroup_»£rved
, 
Œue
);

2458 ià(
”r
)

2459 
out_up_wr™e
;

2461 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

2462 ià(
	`IS_ERR
(
Œªs
)) {

2463 
”r
 = 
	`PTR_ERR
(
Œªs
);

2464 
out_»Ëa£
;

2466 
Œªs
->
block_rsv
 = &block_rsv;

2467 
Œªs
->
by‹s_»£rved
 = 
block_rsv
.
size
;

2469 
	`bŒfs_»cÜd_¢­shÙ_de¡roy
(
Œªs
, 
	`BTRFS_I
(
dœ
));

2471 
»t
 = 
	`bŒfs_uÆšk_subvÞ
(
Œªs
, 
roÙ
, 
dœ
,

2472 
de¡
->
roÙ_key
.
objeùid
,

2473 
d’Œy
->
d_Çme
.
Çme
,

2474 
d’Œy
->
d_Çme
.
Ën
);

2475 ià(
»t
) {

2476 
”r
 = 
»t
;

2477 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2478 
out_’d_Œªs
;

2481 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
de¡
);

2483 
	`mem£t
(&
de¡
->
roÙ_™em
.
drÝ_´og»ss
, 0,

2484 (
de¡
->
roÙ_™em
.
drÝ_´og»ss
));

2485 
de¡
->
roÙ_™em
.
drÝ_Ëv–
 = 0;

2486 
	`bŒfs_£t_roÙ_»fs
(&
de¡
->
roÙ_™em
, 0);

2488 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
de¡
->
¡©e
)) {

2489 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
,

2490 
fs_šfo
->
Œ“_roÙ
,

2491 
de¡
->
roÙ_key
.
objeùid
);

2492 ià(
»t
) {

2493 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2494 
”r
 = 
»t
;

2495 
out_’d_Œªs
;

2499 
»t
 = 
	`bŒfs_uuid_Œ“_»m
(
Œªs
, 
fs_šfo
, 
de¡
->
roÙ_™em
.
uuid
,

2500 
BTRFS_UUID_KEY_SUBVOL
,

2501 
de¡
->
roÙ_key
.
objeùid
);

2502 ià(
»t
 &&„‘ !ð-
ENOENT
) {

2503 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2504 
”r
 = 
»t
;

2505 
out_’d_Œªs
;

2507 ià(!
	`bŒfs_is_em±y_uuid
(
de¡
->
roÙ_™em
.
»ûived_uuid
)) {

2508 
»t
 = 
	`bŒfs_uuid_Œ“_»m
(
Œªs
, 
fs_šfo
,

2509 
de¡
->
roÙ_™em
.
»ûived_uuid
,

2510 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

2511 
de¡
->
roÙ_key
.
objeùid
);

2512 ià(
»t
 &&„‘ !ð-
ENOENT
) {

2513 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2514 
”r
 = 
»t
;

2515 
out_’d_Œªs
;

2519 
out_’d_Œªs
:

2520 
Œªs
->
block_rsv
 = 
NULL
;

2521 
Œªs
->
by‹s_»£rved
 = 0;

2522 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2523 ià(
»t
 && !
”r
)

2524 
”r
 = 
»t
;

2525 
šode
->
i_æags
 |ð
S_DEAD
;

2526 
out_»Ëa£
:

2527 
	`bŒfs_subvÞume_»Ëa£_m‘ad©a
(
fs_šfo
, &
block_rsv
);

2528 
out_up_wr™e
:

2529 
	`up_wr™e
(&
fs_šfo
->
subvÞ_£m
);

2530 ià(
”r
) {

2531 
	`¥š_lock
(&
de¡
->
roÙ_™em_lock
);

2532 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(&
de¡
->
roÙ_™em
);

2533 
	`bŒfs_£t_roÙ_æags
(&
de¡
->
roÙ_™em
,

2534 
roÙ_æags
 & ~
BTRFS_ROOT_SUBVOL_DEAD
);

2535 
	`¥š_uÆock
(&
de¡
->
roÙ_™em_lock
);

2537 
out_uÆock_šode
:

2538 
	`šode_uÆock
(
šode
);

2539 ià(!
”r
) {

2540 
	`d_šv®id©e
(
d’Œy
);

2541 
	`bŒfs_šv®id©e_šodes
(
de¡
);

2542 
	`d_d–‘e
(
d’Œy
);

2543 
	`ASSERT
(
de¡
->
£nd_š_´og»ss
 == 0);

2546 ià(
de¡
->
šo_ÿche_šode
) {

2547 
	`ut
(
de¡
->
šo_ÿche_šode
);

2548 
de¡
->
šo_ÿche_šode
 = 
NULL
;

2551 
out_dput
:

2552 
	`dput
(
d’Œy
);

2553 
out_uÆock_dœ
:

2554 
	`šode_uÆock
(
dœ
);

2555 
out_drÝ_wr™e
:

2556 
	`mÁ_drÝ_wr™e_fže
(
fže
);

2557 
out
:

2558 
	`kä“
(
vÞ_¬gs
);

2559  
”r
;

2560 
	}
}

2562 
	$bŒfs_ioùl_deäag
(
fže
 *fže, 
__u£r
 *
¬gp
)

2564 
šode
 *šodð
	`fže_šode
(
fže
);

2565 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2566 
bŒfs_ioùl_deäag_¿nge_¬gs
 *
¿nge
;

2567 
»t
;

2569 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

2570 ià(
»t
)

2571  
»t
;

2573 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
)) {

2574 
»t
 = -
EROFS
;

2575 
out
;

2578 
šode
->
i_mode
 & 
S_IFMT
) {

2579 
S_IFDIR
:

2580 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

2581 
»t
 = -
EPERM
;

2582 
out
;

2584 
»t
 = 
	`bŒfs_deäag_roÙ
(
roÙ
);

2586 
S_IFREG
:

2587 ià(!(
fže
->
f_mode
 & 
FMODE_WRITE
)) {

2588 
»t
 = -
EINVAL
;

2589 
out
;

2592 
¿nge
 = 
	`kz®loc
((*¿nge), 
GFP_KERNEL
);

2593 ià(!
¿nge
) {

2594 
»t
 = -
ENOMEM
;

2595 
out
;

2598 ià(
¬gp
) {

2599 ià(
	`cÝy_äom_u£r
(
¿nge
, 
¬gp
,

2600 (*
¿nge
))) {

2601 
»t
 = -
EFAULT
;

2602 
	`kä“
(
¿nge
);

2603 
out
;

2606 ià((
¿nge
->
æags
 & 
BTRFS_DEFRAG_RANGE_COMPRESS
)) {

2607 
¿nge
->
æags
 |ð
BTRFS_DEFRAG_RANGE_START_IO
;

2608 
¿nge
->
ex‹Á_th»sh
 = (
u32
)-1;

2612 
¿nge
->
Ën
 = (
u64
)-1;

2614 
»t
 = 
	`bŒfs_deäag_fže
(
	`fže_šode
(
fže
), file,

2615 
¿nge
, 0, 0);

2616 ià(
»t
 > 0)

2617 
»t
 = 0;

2618 
	`kä“
(
¿nge
);

2621 
»t
 = -
EINVAL
;

2623 
out
:

2624 
	`mÁ_drÝ_wr™e_fže
(
fže
);

2625  
»t
;

2626 
	}
}

2628 
	$bŒfs_ioùl_add_dev
(
bŒfs_fs_šfo
 *
fs_šfo
, 
__u£r
 *
¬g
)

2630 
bŒfs_ioùl_vÞ_¬gs
 *
vÞ_¬gs
;

2631 
»t
;

2633 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2634  -
EPERM
;

2636 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
))

2637  
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

2639 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

2640 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2641 ià(
	`IS_ERR
(
vÞ_¬gs
)) {

2642 
»t
 = 
	`PTR_ERR
(
vÞ_¬gs
);

2643 
out
;

2646 
vÞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

2647 
»t
 = 
	`bŒfs_š™_Ãw_deviû
(
fs_šfo
, 
vÞ_¬gs
->
Çme
);

2649 ià(!
»t
)

2650 
	`bŒfs_šfo
(
fs_šfo
, "disk‡dded %s", 
vÞ_¬gs
->
Çme
);

2652 
	`kä“
(
vÞ_¬gs
);

2653 
out
:

2654 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

2655 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

2656  
»t
;

2657 
	}
}

2659 
	$bŒfs_ioùl_rm_dev_v2
(
fže
 *fže, 
__u£r
 *
¬g
)

2661 
šode
 *šodð
	`fže_šode
(
fže
);

2662 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2663 
bŒfs_ioùl_vÞ_¬gs_v2
 *
vÞ_¬gs
;

2664 
»t
;

2666 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2667  -
EPERM
;

2669 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

2670 ià(
»t
)

2671  
»t
;

2673 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2674 ià(
	`IS_ERR
(
vÞ_¬gs
)) {

2675 
»t
 = 
	`PTR_ERR
(
vÞ_¬gs
);

2676 
”r_drÝ
;

2680 ià(
vÞ_¬gs
->
æags
 & ~
BTRFS_VOL_ARG_V2_FLAGS_SUPPORTED
)

2681  -
EOPNOTSUPP
;

2683 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
)) {

2684 
»t
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

2685 
out
;

2688 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

2689 ià(
vÞ_¬gs
->
æags
 & 
BTRFS_DEVICE_SPEC_BY_ID
) {

2690 
»t
 = 
	`bŒfs_rm_deviû
(
fs_šfo
, 
NULL
, 
vÞ_¬gs
->
devid
);

2692 
vÞ_¬gs
->
Çme
[
BTRFS_SUBVOL_NAME_MAX
] = '\0';

2693 
»t
 = 
	`bŒfs_rm_deviû
(
fs_šfo
, 
vÞ_¬gs
->
Çme
, 0);

2695 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

2696 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

2698 ià(!
»t
) {

2699 ià(
vÞ_¬gs
->
æags
 & 
BTRFS_DEVICE_SPEC_BY_ID
)

2700 
	`bŒfs_šfo
(
fs_šfo
, "device deleted: id %llu",

2701 
vÞ_¬gs
->
devid
);

2703 
	`bŒfs_šfo
(
fs_šfo
, "device deleted: %s",

2704 
vÞ_¬gs
->
Çme
);

2706 
out
:

2707 
	`kä“
(
vÞ_¬gs
);

2708 
”r_drÝ
:

2709 
	`mÁ_drÝ_wr™e_fže
(
fže
);

2710  
»t
;

2711 
	}
}

2713 
	$bŒfs_ioùl_rm_dev
(
fže
 *fže, 
__u£r
 *
¬g
)

2715 
šode
 *šodð
	`fže_šode
(
fže
);

2716 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

2717 
bŒfs_ioùl_vÞ_¬gs
 *
vÞ_¬gs
;

2718 
»t
;

2720 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2721  -
EPERM
;

2723 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

2724 ià(
»t
)

2725  
»t
;

2727 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
)) {

2728 
»t
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

2729 
out_drÝ_wr™e
;

2732 
vÞ_¬gs
 = 
	`memdup_u£r
(
¬g
, (*vol_args));

2733 ià(
	`IS_ERR
(
vÞ_¬gs
)) {

2734 
»t
 = 
	`PTR_ERR
(
vÞ_¬gs
);

2735 
out
;

2738 
vÞ_¬gs
->
Çme
[
BTRFS_PATH_NAME_MAX
] = '\0';

2739 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

2740 
»t
 = 
	`bŒfs_rm_deviû
(
fs_šfo
, 
vÞ_¬gs
->
Çme
, 0);

2741 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

2743 ià(!
»t
)

2744 
	`bŒfs_šfo
(
fs_šfo
, "disk d–‘ed %s", 
vÞ_¬gs
->
Çme
);

2745 
	`kä“
(
vÞ_¬gs
);

2746 
out
:

2747 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

2748 
out_drÝ_wr™e
:

2749 
	`mÁ_drÝ_wr™e_fže
(
fže
);

2751  
»t
;

2752 
	}
}

2754 
	$bŒfs_ioùl_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

2755 
__u£r
 *
¬g
)

2757 
bŒfs_ioùl_fs_šfo_¬gs
 *
fi_¬gs
;

2758 
bŒfs_deviû
 *
deviû
;

2759 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2760 
»t
 = 0;

2762 
fi_¬gs
 = 
	`kz®loc
((*fi_¬gs), 
GFP_KERNEL
);

2763 ià(!
fi_¬gs
)

2764  -
ENOMEM
;

2766 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2767 
fi_¬gs
->
num_deviûs
 = 
fs_deviûs
->num_devices;

2768 
	`memýy
(&
fi_¬gs
->
fsid
, 
fs_šfo
->fsid, (fi_args->fsid));

2770 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

2771 ià(
deviû
->
devid
 > 
fi_¬gs
->
max_id
)

2772 
fi_¬gs
->
max_id
 = 
deviû
->
devid
;

2774 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2776 
fi_¬gs
->
nodesize
 = 
fs_šfo
->nodesize;

2777 
fi_¬gs
->
£ùÜsize
 = 
fs_šfo
->sectorsize;

2778 
fi_¬gs
->
þÚe_®ignm’t
 = 
fs_šfo
->
£ùÜsize
;

2780 ià(
	`cÝy_to_u£r
(
¬g
, 
fi_¬gs
, (*fi_args)))

2781 
»t
 = -
EFAULT
;

2783 
	`kä“
(
fi_¬gs
);

2784  
»t
;

2785 
	}
}

2787 
	$bŒfs_ioùl_dev_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

2788 
__u£r
 *
¬g
)

2790 
bŒfs_ioùl_dev_šfo_¬gs
 *
di_¬gs
;

2791 
bŒfs_deviû
 *
dev
;

2792 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2793 
»t
 = 0;

2794 *
s_uuid
 = 
NULL
;

2796 
di_¬gs
 = 
	`memdup_u£r
(
¬g
, (*di_args));

2797 ià(
	`IS_ERR
(
di_¬gs
))

2798  
	`PTR_ERR
(
di_¬gs
);

2800 ià(!
	`bŒfs_is_em±y_uuid
(
di_¬gs
->
uuid
))

2801 
s_uuid
 = 
di_¬gs
->
uuid
;

2803 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2804 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
di_¬gs
->
devid
, 
s_uuid
, 
NULL
);

2806 ià(!
dev
) {

2807 
»t
 = -
ENODEV
;

2808 
out
;

2811 
di_¬gs
->
devid
 = 
dev
->devid;

2812 
di_¬gs
->
by‹s_u£d
 = 
	`bŒfs_deviû_g‘_by‹s_u£d
(
dev
);

2813 
di_¬gs
->
tÙ®_by‹s
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
dev
);

2814 
	`memýy
(
di_¬gs
->
uuid
, 
dev
->uuid, (di_args->uuid));

2815 ià(
dev
->
Çme
) {

2816 
rcu_¡ršg
 *
Çme
;

2818 
	`rcu_»ad_lock
();

2819 
Çme
 = 
	`rcu_d”eã»nû
(
dev
->name);

2820 
	`¡ºýy
(
di_¬gs
->
·th
, 
Çme
->
¡r
, (di_args->path));

2821 
	`rcu_»ad_uÆock
();

2822 
di_¬gs
->
·th
[(di_args->path) - 1] = 0;

2824 
di_¬gs
->
·th
[0] = '\0';

2827 
out
:

2828 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2829 ià(
»t
 =ð0 && 
	`cÝy_to_u£r
(
¬g
, 
di_¬gs
, (*di_args)))

2830 
»t
 = -
EFAULT
;

2832 
	`kä“
(
di_¬gs
);

2833  
»t
;

2834 
	}
}

2836 
·ge
 *
	$ex‹Á_§me_g‘_·ge
(
šode
 *šode, 
pgoff_t
 
šdex
)

2838 
·ge
 *page;

2840 
·ge
 = 
	`g¿b_ÿche_·ge
(
šode
->
i_m­pšg
, 
šdex
);

2841 ià(!
·ge
)

2842  
	`ERR_PTR
(-
ENOMEM
);

2844 ià(!
	`PageU±od©e
(
·ge
)) {

2845 
»t
;

2847 
»t
 = 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

2848 ià(
»t
)

2849  
	`ERR_PTR
(
»t
);

2850 
	`lock_·ge
(
·ge
);

2851 ià(!
	`PageU±od©e
(
·ge
)) {

2852 
	`uÆock_·ge
(
·ge
);

2853 
	`put_·ge
(
·ge
);

2854  
	`ERR_PTR
(-
EIO
);

2856 ià(
·ge
->
m­pšg
 !ð
šode
->
i_m­pšg
) {

2857 
	`uÆock_·ge
(
·ge
);

2858 
	`put_·ge
(
·ge
);

2859  
	`ERR_PTR
(-
EAGAIN
);

2863  
·ge
;

2864 
	}
}

2866 
	$g©h”_ex‹Á_·ges
(
šode
 *šode, 
·ge
 **
·ges
,

2867 
num_·ges
, 
u64
 
off
)

2869 
i
;

2870 
pgoff_t
 
šdex
 = 
off
 >> 
PAGE_SHIFT
;

2872 
i
 = 0; i < 
num_·ges
; i++) {

2873 
agaš
:

2874 
·ges
[
i
] = 
	`ex‹Á_§me_g‘_·ge
(
šode
, 
šdex
 + i);

2875 ià(
	`IS_ERR
(
·ges
[
i
])) {

2876 
”r
 = 
	`PTR_ERR
(
·ges
[
i
]);

2878 ià(
”r
 =ð-
EAGAIN
)

2879 
agaš
;

2880 
·ges
[
i
] = 
NULL
;

2881  
”r
;

2885 
	}
}

2887 
	$lock_ex‹Á_¿nge
(
šode
 *šode, 
u64
 
off
, u64 
Ën
,

2888 
boÞ
 
»Œy_¿nge_lockšg
)

2899 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

2900 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
off
, ofà+ 
Ën
 - 1);

2901 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
,

2902 
off
 + 
Ën
 - 1);

2903 ià((!
Üd”ed
 ||

2904 
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 <ð
off
 ||

2905 
Üd”ed
->
fže_off£t
 >ð
off
 + 
Ën
) &&

2906 !
	`‹¡_¿nge_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
off
,

2907 
off
 + 
Ën
 - 1, 
EXTENT_DELALLOC
, 0, 
NULL
)) {

2908 ià(
Üd”ed
)

2909 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2912 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
off
, ofà+ 
Ën
 - 1);

2913 ià(
Üd”ed
)

2914 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

2915 ià(!
»Œy_¿nge_lockšg
)

2916  -
EAGAIN
;

2917 
	`bŒfs_wa™_Üd”ed_¿nge
(
šode
, 
off
, 
Ën
);

2920 
	}
}

2922 
	$bŒfs_doubË_šode_uÆock
(
šode
 *
šode1
, šod*
šode2
)

2924 
	`šode_uÆock
(
šode1
);

2925 
	`šode_uÆock
(
šode2
);

2926 
	}
}

2928 
	$bŒfs_doubË_šode_lock
(
šode
 *
šode1
, šod*
šode2
)

2930 ià(
šode1
 < 
šode2
)

2931 
	`sw­
(
šode1
, 
šode2
);

2933 
	`šode_lock_Ã¡ed
(
šode1
, 
I_MUTEX_PARENT
);

2934 
	`šode_lock_Ã¡ed
(
šode2
, 
I_MUTEX_CHILD
);

2935 
	}
}

2937 
	$bŒfs_doubË_ex‹Á_uÆock
(
šode
 *
šode1
, 
u64
 
loff1
,

2938 
šode
 *
šode2
, 
u64
 
loff2
, u64 
Ën
)

2940 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode1
)->
io_Œ“
, 
loff1
,†off1 + 
Ën
 - 1);

2941 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode2
)->
io_Œ“
, 
loff2
,†off2 + 
Ën
 - 1);

2942 
	}
}

2944 
	$bŒfs_doubË_ex‹Á_lock
(
šode
 *
šode1
, 
u64
 
loff1
,

2945 
šode
 *
šode2
, 
u64
 
loff2
, u64 
Ën
,

2946 
boÞ
 
»Œy_¿nge_lockšg
)

2948 
»t
;

2950 ià(
šode1
 < 
šode2
) {

2951 
	`sw­
(
šode1
, 
šode2
);

2952 
	`sw­
(
loff1
, 
loff2
);

2954 
»t
 = 
	`lock_ex‹Á_¿nge
(
šode1
, 
loff1
, 
Ën
, 
»Œy_¿nge_lockšg
);

2955 ià(
»t
)

2956  
»t
;

2957 
»t
 = 
	`lock_ex‹Á_¿nge
(
šode2
, 
loff2
, 
Ën
, 
»Œy_¿nge_lockšg
);

2958 ià(
»t
)

2959 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode1
)->
io_Œ“
, 
loff1
,

2960 
loff1
 + 
Ën
 - 1);

2961  
»t
;

2962 
	}
}

2964 
	scmp_·ges
 {

2965 
	mnum_·ges
;

2966 
·ge
 **
	m¤c_·ges
;

2967 
·ge
 **
	md¡_·ges
;

2970 
	$bŒfs_cmp_d©a_ä“
(
cmp_·ges
 *
cmp
)

2972 
i
;

2973 
·ge
 *
pg
;

2975 
i
 = 0; i < 
cmp
->
num_·ges
; i++) {

2976 
pg
 = 
cmp
->
¤c_·ges
[
i
];

2977 ià(
pg
) {

2978 
	`uÆock_·ge
(
pg
);

2979 
	`put_·ge
(
pg
);

2981 
pg
 = 
cmp
->
d¡_·ges
[
i
];

2982 ià(
pg
) {

2983 
	`uÆock_·ge
(
pg
);

2984 
	`put_·ge
(
pg
);

2987 
	`kä“
(
cmp
->
¤c_·ges
);

2988 
	`kä“
(
cmp
->
d¡_·ges
);

2989 
	}
}

2991 
	$bŒfs_cmp_d©a_´•¬e
(
šode
 *
¤c
, 
u64
 
loff
,

2992 
šode
 *
d¡
, 
u64
 
d¡_loff
,

2993 
u64
 
Ën
, 
cmp_·ges
 *
cmp
)

2995 
»t
;

2996 
num_·ges
 = 
	`PAGE_ALIGN
(
Ën
è>> 
PAGE_SHIFT
;

2997 
·ge
 **
¤c_pg¬r
, **
d¡_pg¬r
;

3005 
¤c_pg¬r
 = 
	`kÿÎoc
(
num_·ges
, (
·ge
 *), 
GFP_KERNEL
);

3006 
d¡_pg¬r
 = 
	`kÿÎoc
(
num_·ges
, (
·ge
 *), 
GFP_KERNEL
);

3007 ià(!
¤c_pg¬r
 || !
d¡_pg¬r
) {

3008 
	`kä“
(
¤c_pg¬r
);

3009 
	`kä“
(
d¡_pg¬r
);

3010  -
ENOMEM
;

3012 
cmp
->
num_·ges
 =‚um_pages;

3013 
cmp
->
¤c_·ges
 = 
¤c_pg¬r
;

3014 
cmp
->
d¡_·ges
 = 
d¡_pg¬r
;

3021 ià(
¤c
 =ð
d¡
 && 
d¡_loff
 < 
loff
) {

3022 
	`sw­
(
¤c_pg¬r
, 
d¡_pg¬r
);

3023 
	`sw­
(
loff
, 
d¡_loff
);

3026 
»t
 = 
	`g©h”_ex‹Á_·ges
(
¤c
, 
¤c_pg¬r
, 
cmp
->
num_·ges
, 
loff
);

3027 ià(
»t
)

3028 
out
;

3030 
»t
 = 
	`g©h”_ex‹Á_·ges
(
d¡
, 
d¡_pg¬r
, 
cmp
->
num_·ges
, 
d¡_loff
);

3032 
out
:

3033 ià(
»t
)

3034 
	`bŒfs_cmp_d©a_ä“
(
cmp
);

3035  
»t
;

3036 
	}
}

3038 
	$bŒfs_cmp_d©a
(
u64
 
Ën
, 
cmp_·ges
 *
cmp
)

3040 
»t
 = 0;

3041 
i
;

3042 
·ge
 *
¤c_·ge
, *
d¡_·ge
;

3043 
cmp_Ën
 = 
PAGE_SIZE
;

3044 *
addr
, *
d¡_addr
;

3046 
i
 = 0;

3047 
Ën
) {

3048 ià(
Ën
 < 
PAGE_SIZE
)

3049 
cmp_Ën
 = 
Ën
;

3051 
	`BUG_ON
(
i
 >ð
cmp
->
num_·ges
);

3053 
¤c_·ge
 = 
cmp
->
¤c_·ges
[
i
];

3054 
d¡_·ge
 = 
cmp
->
d¡_·ges
[
i
];

3055 
	`ASSERT
(
	`PageLocked
(
¤c_·ge
));

3056 
	`ASSERT
(
	`PageLocked
(
d¡_·ge
));

3058 
addr
 = 
	`km­_©omic
(
¤c_·ge
);

3059 
d¡_addr
 = 
	`km­_©omic
(
d¡_·ge
);

3061 
	`æush_dÿche_·ge
(
¤c_·ge
);

3062 
	`æush_dÿche_·ge
(
d¡_·ge
);

3064 ià(
	`memcmp
(
addr
, 
d¡_addr
, 
cmp_Ën
))

3065 
»t
 = -
EBADE
;

3067 
	`kunm­_©omic
(
addr
);

3068 
	`kunm­_©omic
(
d¡_addr
);

3070 ià(
»t
)

3073 
Ën
 -ð
cmp_Ën
;

3074 
i
++;

3077  
»t
;

3078 
	}
}

3080 
	$ex‹Á_§me_check_off£ts
(
šode
 *šode, 
u64
 
off
, u64 *
¶’
,

3081 
u64
 
Þ’
)

3083 
u64
 
Ën
 = *
¶’
;

3084 
u64
 
bs
 = 
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
->
sb
->
s_blocksize
;

3086 ià(
off
 + 
Þ’
 > 
šode
->
i_size
 || off + olen < off)

3087  -
EINVAL
;

3090 ià(
off
 + 
Ën
 =ð
šode
->
i_size
)

3091 *
¶’
 = 
Ën
 = 
	`ALIGN
(
šode
->
i_size
, 
bs
è- 
off
;

3094 ià(!
	`IS_ALIGNED
(
off
, 
bs
è|| !IS_ALIGNED(ofà+ 
Ën
, bs))

3095  -
EINVAL
;

3098 
	}
}

3100 
	$bŒfs_ex‹Á_§me
(
šode
 *
¤c
, 
u64
 
loff
, u64 
Þ’
,

3101 
šode
 *
d¡
, 
u64
 
d¡_loff
)

3103 
»t
;

3104 
u64
 
Ën
 = 
Þ’
;

3105 
cmp_·ges
 
cmp
;

3106 
boÞ
 
§me_šode
 = (
¤c
 =ð
d¡
);

3107 
u64
 
§me_lock_¡¬t
 = 0;

3108 
u64
 
§me_lock_Ën
 = 0;

3110 ià(
Ën
 == 0)

3113 ià(
§me_šode
)

3114 
	`šode_lock
(
¤c
);

3116 
	`bŒfs_doubË_šode_lock
(
¤c
, 
d¡
);

3118 
»t
 = 
	`ex‹Á_§me_check_off£ts
(
¤c
, 
loff
, &
Ën
, 
Þ’
);

3119 ià(
»t
)

3120 
out_uÆock
;

3122 
»t
 = 
	`ex‹Á_§me_check_off£ts
(
d¡
, 
d¡_loff
, &
Ën
, 
Þ’
);

3123 ià(
»t
)

3124 
out_uÆock
;

3126 ià(
§me_šode
) {

3141 ià(
Ën
 !ð
Þ’
) {

3142 
»t
 = -
EINVAL
;

3143 
out_uÆock
;

3147 ià(
d¡_loff
 + 
Ën
 > 
loff
 && dst_loff <†off +†en) {

3148 
»t
 = -
EINVAL
;

3149 
out_uÆock
;

3152 
§me_lock_¡¬t
 = 
	`mš_t
(
u64
, 
loff
, 
d¡_loff
);

3153 
§me_lock_Ën
 = 
	`max_t
(
u64
, 
loff
, 
d¡_loff
è+ 
Ën
 - 
§me_lock_¡¬t
;

3157 ià((
	`BTRFS_I
(
¤c
)->
æags
 & 
BTRFS_INODE_NODATASUM
) !=

3158 (
	`BTRFS_I
(
d¡
)->
æags
 & 
BTRFS_INODE_NODATASUM
)) {

3159 
»t
 = -
EINVAL
;

3160 
out_uÆock
;

3163 
agaš
:

3164 
»t
 = 
	`bŒfs_cmp_d©a_´•¬e
(
¤c
, 
loff
, 
d¡
, 
d¡_loff
, 
Þ’
, &
cmp
);

3165 ià(
»t
)

3166 
out_uÆock
;

3168 ià(
§me_šode
)

3169 
»t
 = 
	`lock_ex‹Á_¿nge
(
¤c
, 
§me_lock_¡¬t
, 
§me_lock_Ën
,

3170 
çl£
);

3172 
»t
 = 
	`bŒfs_doubË_ex‹Á_lock
(
¤c
, 
loff
, 
d¡
, 
d¡_loff
, 
Ën
,

3173 
çl£
);

3182 ià(
»t
 =ð-
EAGAIN
) {

3187 
	`bŒfs_cmp_d©a_ä“
(&
cmp
);

3188 ià(
§me_šode
) {

3189 
	`bŒfs_wa™_Üd”ed_¿nge
(
¤c
, 
§me_lock_¡¬t
,

3190 
§me_lock_Ën
);

3192 
	`bŒfs_wa™_Üd”ed_¿nge
(
¤c
, 
loff
, 
Ën
);

3193 
	`bŒfs_wa™_Üd”ed_¿nge
(
d¡
, 
d¡_loff
, 
Ën
);

3195 
agaš
;

3197 
	`ASSERT
(
»t
 == 0);

3198 ià(
	`WARN_ON
(
»t
)) {

3200 
	`bŒfs_cmp_d©a_ä“
(&
cmp
);

3201  
»t
;

3205 
»t
 = 
	`bŒfs_cmp_d©a
(
Þ’
, &
cmp
);

3206 ià(
»t
 == 0)

3207 
»t
 = 
	`bŒfs_þÚe
(
¤c
, 
d¡
, 
loff
, 
Þ’
, 
Ën
, 
d¡_loff
, 1);

3209 ià(
§me_šode
)

3210 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
¤c
)->
io_Œ“
, 
§me_lock_¡¬t
,

3211 
§me_lock_¡¬t
 + 
§me_lock_Ën
 - 1);

3213 
	`bŒfs_doubË_ex‹Á_uÆock
(
¤c
, 
loff
, 
d¡
, 
d¡_loff
, 
Ën
);

3215 
	`bŒfs_cmp_d©a_ä“
(&
cmp
);

3216 
out_uÆock
:

3217 ià(
§me_šode
)

3218 
	`šode_uÆock
(
¤c
);

3220 
	`bŒfs_doubË_šode_uÆock
(
¤c
, 
d¡
);

3222  
»t
;

3223 
	}
}

3225 
	#BTRFS_MAX_DEDUPE_LEN
 
SZ_16M


	)

3227 
ssize_t
 
	$bŒfs_dedu³_fže_¿nge
(
fže
 *
¤c_fže
, 
u64
 
loff
, u64 
Þ’
,

3228 
fže
 *
d¡_fže
, 
u64
 
d¡_loff
)

3230 
šode
 *
¤c
 = 
	`fže_šode
(
¤c_fže
);

3231 
šode
 *
d¡
 = 
	`fže_šode
(
d¡_fže
);

3232 
u64
 
bs
 = 
	`BTRFS_I
(
¤c
)->
roÙ
->
fs_šfo
->
sb
->
s_blocksize
;

3233 
ssize_t
 
»s
;

3235 ià(
Þ’
 > 
BTRFS_MAX_DEDUPE_LEN
)

3236 
Þ’
 = 
BTRFS_MAX_DEDUPE_LEN
;

3238 ià(
	`WARN_ON_ONCE
(
bs
 < 
PAGE_SIZE
)) {

3244  -
EINVAL
;

3247 
»s
 = 
	`bŒfs_ex‹Á_§me
(
¤c
, 
loff
, 
Þ’
, 
d¡
, 
d¡_loff
);

3248 ià(
»s
)

3249  
»s
;

3250  
Þ’
;

3251 
	}
}

3253 
	$þÚe_fšish_šode_upd©e
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3254 
šode
 *inode,

3255 
u64
 
’doff
,

3256 cÚ¡ 
u64
 
de¡off
,

3257 cÚ¡ 
u64
 
Þ’
,

3258 
no_time_upd©e
)

3260 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3261 
»t
;

3263 
	`šode_šc_iv”siÚ
(
šode
);

3264 ià(!
no_time_upd©e
)

3265 
šode
->
i_mtime
 = inode->
i_ùime
 = 
	`cu¼’t_time
(inode);

3270 ià(
’doff
 > 
de¡off
 + 
Þ’
)

3271 
’doff
 = 
de¡off
 + 
Þ’
;

3272 ià(
’doff
 > 
šode
->
i_size
)

3273 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
šode
), 
’doff
);

3275 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

3276 ià(
»t
) {

3277 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3278 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3279 
out
;

3281 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3282 
out
:

3283  
»t
;

3284 
	}
}

3286 
	$þÚe_upd©e_ex‹Á_m­
(
bŒfs_šode
 *
šode
,

3287 cÚ¡ 
bŒfs_Œªs_hªdË
 *
Œªs
,

3288 cÚ¡ 
bŒfs_·th
 *
·th
,

3289 cÚ¡ 
u64
 
hÞe_off£t
,

3290 cÚ¡ 
u64
 
hÞe_Ën
)

3292 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

3293 
ex‹Á_m­
 *
em
;

3294 
»t
;

3296 
em
 = 
	`®loc_ex‹Á_m­
();

3297 ià(!
em
) {

3298 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
šode
->
ruÁime_æags
);

3302 ià(
·th
) {

3303 
bŒfs_fže_ex‹Á_™em
 *
fi
;

3305 
fi
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3306 
bŒfs_fže_ex‹Á_™em
);

3307 
	`bŒfs_ex‹Á_™em_to_ex‹Á_m­
(
šode
, 
·th
, 
fi
, 
çl£
, 
em
);

3308 
em
->
g’”©iÚ
 = -1;

3309 ià(
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
fi
) ==

3310 
BTRFS_FILE_EXTENT_INLINE
)

3311 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

3312 &
šode
->
ruÁime_æags
);

3314 
em
->
¡¬t
 = 
hÞe_off£t
;

3315 
em
->
Ën
 = 
hÞe_Ën
;

3316 
em
->
¿m_by‹s
 =ƒm->
Ën
;

3317 
em
->
Üig_¡¬t
 = 
hÞe_off£t
;

3318 
em
->
block_¡¬t
 = 
EXTENT_MAP_HOLE
;

3319 
em
->
block_Ën
 = 0;

3320 
em
->
Üig_block_Ën
 = 0;

3321 
em
->
com´ess_ty³
 = 
BTRFS_COMPRESS_NONE
;

3322 
em
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

3326 
	`wr™e_lock
(&
em_Œ“
->
lock
);

3327 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 1);

3328 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

3329 ià(
»t
 !ð-
EEXIST
) {

3330 
	`ä“_ex‹Á_m­
(
em
);

3333 
	`bŒfs_drÝ_ex‹Á_ÿche
(
šode
, 
em
->
¡¬t
,

3334 
em
->
¡¬t
 +ƒm->
Ën
 - 1, 0);

3337 ià(
»t
)

3338 
	`£t_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
, &
šode
->
ruÁime_æags
);

3339 
	}
}

3366 
	$þÚe_cÝy_šlše_ex‹Á
(
šode
 *
d¡
,

3367 
bŒfs_Œªs_hªdË
 *
Œªs
,

3368 
bŒfs_·th
 *
·th
,

3369 
bŒfs_key
 *
Ãw_key
,

3370 cÚ¡ 
u64
 
drÝ_¡¬t
,

3371 cÚ¡ 
u64
 
d©®
,

3372 cÚ¡ 
u64
 
sk
,

3373 cÚ¡ 
u64
 
size
,

3374 *
šlše_d©a
)

3376 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
d¡
->
i_sb
);

3377 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
d¡
)->root;

3378 cÚ¡ 
u64
 
®igÃd_’d
 = 
	`ALIGN
(
Ãw_key
->
off£t
 + 
d©®
,

3379 
fs_šfo
->
£ùÜsize
);

3380 
»t
;

3381 
bŒfs_key
 
key
;

3383 ià(
Ãw_key
->
off£t
 > 0)

3384  -
EOPNOTSUPP
;

3386 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
d¡
));

3387 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

3388 
key
.
off£t
 = 0;

3389 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3390 ià(
»t
 < 0) {

3391  
»t
;

3392 } ià(
»t
 > 0) {

3393 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

3394 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3395 ià(
»t
 < 0)

3396  
»t
;

3397 ià(
»t
 > 0)

3398 
cÝy_šlše_ex‹Á
;

3400 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

3401 ià(
key
.
objeùid
 =ð
	`bŒfs_šo
(
	`BTRFS_I
(
d¡
)) &&

3402 
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

3403 
	`ASSERT
(
key
.
off£t
 > 0);

3404  -
EOPNOTSUPP
;

3406 } ià(
	`i_size_»ad
(
d¡
è<ð
d©®
) {

3407 
bŒfs_fže_ex‹Á_™em
 *
ei
;

3408 
u64
 
ext_Ën
;

3415 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3416 
bŒfs_fže_ex‹Á_™em
);

3421 ià(
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
) ==

3422 
BTRFS_FILE_EXTENT_INLINE
)

3423 
cÝy_šlše_ex‹Á
;

3425 
ext_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
·th
->
nodes
[0], 
ei
);

3426 ià(
ext_Ën
 > 
®igÃd_’d
)

3427  -
EOPNOTSUPP
;

3429 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

3430 ià(
»t
 < 0) {

3431  
»t
;

3432 } ià(
»t
 == 0) {

3433 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

3434 
·th
->
¦Ùs
[0]);

3435 ià(
key
.
objeùid
 =ð
	`bŒfs_šo
(
	`BTRFS_I
(
d¡
)) &&

3436 
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
)

3437  -
EOPNOTSUPP
;

3441 
cÝy_šlše_ex‹Á
:

3446 ià(
	`i_size_»ad
(
d¡
è> 
d©®
) {

3459  -
EOPNOTSUPP
;

3462 
	`bŒfs_»Ëa£_·th
(
·th
);

3463 
»t
 = 
	`bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
d¡
, 
drÝ_¡¬t
, 
®igÃd_’d
, 1);

3464 ià(
»t
)

3465  
»t
;

3466 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
Ãw_key
, 
size
);

3467 ià(
»t
)

3468  
»t
;

3470 ià(
sk
) {

3471 cÚ¡ 
u32
 
¡¬t
 = 
	`bŒfs_fže_ex‹Á_ÿlc_šlše_size
(0);

3473 
	`memmove
(
šlše_d©a
 + 
¡¬t
, iÆše_d©¨+ s¹ + 
sk
, 
d©®
);

3476 
	`wr™e_ex‹Á_bufãr
(
·th
->
nodes
[0], 
šlše_d©a
,

3477 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

3478 
·th
->
¦Ùs
[0]),

3479 
size
);

3480 
	`šode_add_by‹s
(
d¡
, 
d©®
);

3483 
	}
}

3496 
	$bŒfs_þÚe
(
šode
 *
¤c
, inode *inode,

3497 cÚ¡ 
u64
 
off
, cÚ¡ u64 
Þ’
, cÚ¡ u64 
Þ’_®igÃd
,

3498 cÚ¡ 
u64
 
de¡off
, 
no_time_upd©e
)

3500 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3501 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3502 
bŒfs_·th
 *
·th
 = 
NULL
;

3503 
ex‹Á_bufãr
 *
Ëaf
;

3504 
bŒfs_Œªs_hªdË
 *
Œªs
;

3505 *
buf
 = 
NULL
;

3506 
bŒfs_key
 
key
;

3507 
u32
 
Ä™ems
;

3508 
¦Ù
;

3509 
»t
;

3510 cÚ¡ 
u64
 
Ën
 = 
Þ’_®igÃd
;

3511 
u64
 
Ï¡_de¡_’d
 = 
de¡off
;

3513 
»t
 = -
ENOMEM
;

3514 
buf
 = 
	`kvm®loc
(
fs_šfo
->
nodesize
, 
GFP_KERNEL
);

3515 ià(!
buf
)

3516  
»t
;

3518 
·th
 = 
	`bŒfs_®loc_·th
();

3519 ià(!
·th
) {

3520 
	`kvä“
(
buf
);

3521  
»t
;

3524 
·th
->
»ada
 = 
READA_FORWARD
;

3526 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
¤c
));

3527 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

3528 
key
.
off£t
 = 
off
;

3531 
u64
 
Ãxt_key_mš_off£t
 = 
key
.
off£t
 + 1;

3537 
·th
->
Ëave_¥šnšg
 = 1;

3538 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
	`BTRFS_I
(
¤c
)->
roÙ
, &
key
, 
·th
,

3540 ià(
»t
 < 0)

3541 
out
;

3547 ià(
key
.
off£t
 =ð
off
 && 
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

3548 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

3549 
·th
->
¦Ùs
[0] - 1);

3550 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
)

3551 
·th
->
¦Ùs
[0]--;

3554 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

3555 
´oûss_¦Ù
:

3556 ià(
·th
->
¦Ùs
[0] >ð
Ä™ems
) {

3557 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
	`BTRFS_I
(
¤c
)->
roÙ
, 
·th
);

3558 ià(
»t
 < 0)

3559 
out
;

3560 ià(
»t
 > 0)

3562 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

3564 
Ëaf
 = 
·th
->
nodes
[0];

3565 
¦Ù
 = 
·th
->
¦Ùs
[0];

3567 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

3568 ià(
key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 ||

3569 
key
.
objeùid
 !ð
	`bŒfs_šo
(
	`BTRFS_I
(
¤c
)))

3572 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

3573 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

3574 
ty³
;

3575 
u32
 
size
;

3576 
bŒfs_key
 
Ãw_key
;

3577 
u64
 
disko
 = 0, 
diskl
 = 0;

3578 
u64
 
d©ao
 = 0, 
d©®
 = 0;

3579 
u8
 
comp
;

3580 
u64
 
drÝ_¡¬t
;

3582 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

3583 
bŒfs_fže_ex‹Á_™em
);

3584 
comp
 = 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
ex‹Á
);

3585 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
);

3586 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

3587 
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

3588 
disko
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
,

3589 
ex‹Á
);

3590 
diskl
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
,

3591 
ex‹Á
);

3592 
d©ao
 = 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
ex‹Á
);

3593 
d©®
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
,

3594 
ex‹Á
);

3595 } ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

3597 
d©®
 = 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf
,

3598 
ex‹Á
);

3606 ià(
key
.
off£t
 + 
d©®
 <ð
off
) {

3607 
·th
->
¦Ùs
[0]++;

3608 
´oûss_¦Ù
;

3609 } ià(
key
.
off£t
 >ð
off
 + 
Ën
) {

3612 
Ãxt_key_mš_off£t
 = 
key
.
off£t
 + 
d©®
;

3613 
size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

3614 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
buf
,

3615 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
),

3616 
size
);

3618 
	`bŒfs_»Ëa£_·th
(
·th
);

3619 
·th
->
Ëave_¥šnšg
 = 0;

3621 
	`memýy
(&
Ãw_key
, &
key
, (new_key));

3622 
Ãw_key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

3623 ià(
off
 <ð
key
.
off£t
)

3624 
Ãw_key
.
off£t
 = 
key
.off£ˆ+ 
de¡off
 - 
off
;

3626 
Ãw_key
.
off£t
 = 
de¡off
;

3635 ià(
Ãw_key
.
off£t
 !ð
Ï¡_de¡_’d
)

3636 
drÝ_¡¬t
 = 
Ï¡_de¡_’d
;

3638 
drÝ_¡¬t
 = 
Ãw_key
.
off£t
;

3645 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

3646 ià(
	`IS_ERR
(
Œªs
)) {

3647 
»t
 = 
	`PTR_ERR
(
Œªs
);

3648 
out
;

3651 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

3652 
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

3659 ià(
key
.
off£t
 + 
d©®
 > 
off
 + 
Ën
)

3660 
d©®
 = 
off
 + 
Ën
 - 
key
.
off£t
;

3663 ià(
off
 > 
key
.
off£t
) {

3664 
d©ao
 +ð
off
 - 
key
.
off£t
;

3665 
d©®
 -ð
off
 - 
key
.
off£t
;

3668 
»t
 = 
	`bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
,

3669 
drÝ_¡¬t
,

3670 
Ãw_key
.
off£t
 + 
d©®
,

3672 ià(
»t
) {

3673 ià(
»t
 !ð-
EOPNOTSUPP
)

3674 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
,

3675 
»t
);

3676 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3677 
out
;

3680 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
,

3681 &
Ãw_key
, 
size
);

3682 ià(
»t
) {

3683 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3684 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3685 
out
;

3688 
Ëaf
 = 
·th
->
nodes
[0];

3689 
¦Ù
 = 
·th
->
¦Ùs
[0];

3690 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
buf
,

3691 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
),

3692 
size
);

3694 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

3695 
bŒfs_fže_ex‹Á_™em
);

3698 ià(!
disko
)

3699 
d©ao
 = 0;

3701 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
ex‹Á
,

3702 
d©ao
);

3703 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
,

3704 
d©®
);

3706 ià(
disko
) {

3707 
	`šode_add_by‹s
(
šode
, 
d©®
);

3708 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
,

3709 
fs_šfo
,

3710 
disko
, 
diskl
, 0,

3711 
roÙ
->
roÙ_key
.
objeùid
,

3712 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

3713 
Ãw_key
.
off£t
 - 
d©ao
);

3714 ià(
»t
) {

3715 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
,

3716 
»t
);

3717 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3718 
out
;

3722 } ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

3723 
u64
 
sk
 = 0;

3724 
u64
 
Œim
 = 0;

3726 ià(
off
 > 
key
.
off£t
) {

3727 
sk
 = 
off
 - 
key
.
off£t
;

3728 
Ãw_key
.
off£t
 +ð
sk
;

3731 ià(
key
.
off£t
 + 
d©®
 > 
off
 + 
Ën
)

3732 
Œim
 = 
key
.
off£t
 + 
d©®
 - (
off
 + 
Ën
);

3734 ià(
comp
 && (
sk
 || 
Œim
)) {

3735 
»t
 = -
EINVAL
;

3736 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3737 
out
;

3739 
size
 -ð
sk
 + 
Œim
;

3740 
d©®
 -ð
sk
 + 
Œim
;

3742 
»t
 = 
	`þÚe_cÝy_šlše_ex‹Á
(
šode
,

3743 
Œªs
, 
·th
,

3744 &
Ãw_key
,

3745 
drÝ_¡¬t
,

3746 
d©®
,

3747 
sk
, 
size
, 
buf
);

3748 ià(
»t
) {

3749 ià(
»t
 !ð-
EOPNOTSUPP
)

3750 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
,

3751 
»t
);

3752 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3753 
out
;

3755 
Ëaf
 = 
·th
->
nodes
[0];

3756 
¦Ù
 = 
·th
->
¦Ùs
[0];

3760 ià(
drÝ_¡¬t
 < 
Ãw_key
.
off£t
)

3761 
	`þÚe_upd©e_ex‹Á_m­
(
	`BTRFS_I
(
šode
), 
Œªs
,

3762 
NULL
, 
drÝ_¡¬t
,

3763 
Ãw_key
.
off£t
 - 
drÝ_¡¬t
);

3765 
	`þÚe_upd©e_ex‹Á_m­
(
	`BTRFS_I
(
šode
), 
Œªs
,

3766 
·th
, 0, 0);

3768 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

3769 
	`bŒfs_»Ëa£_·th
(
·th
);

3771 
Ï¡_de¡_’d
 = 
	`ALIGN
(
Ãw_key
.
off£t
 + 
d©®
,

3772 
fs_šfo
->
£ùÜsize
);

3773 
»t
 = 
	`þÚe_fšish_šode_upd©e
(
Œªs
, 
šode
,

3774 
Ï¡_de¡_’d
,

3775 
de¡off
, 
Þ’
,

3776 
no_time_upd©e
);

3777 ià(
»t
)

3778 
out
;

3779 ià(
Ãw_key
.
off£t
 + 
d©®
 >ð
de¡off
 + 
Ën
)

3782 
	`bŒfs_»Ëa£_·th
(
·th
);

3783 
key
.
off£t
 = 
Ãxt_key_mš_off£t
;

3785 ià(
	`çl_sigÇl_³ndšg
(
cu¼’t
)) {

3786 
»t
 = -
EINTR
;

3787 
out
;

3790 
»t
 = 0;

3792 ià(
Ï¡_de¡_’d
 < 
de¡off
 + 
Ën
) {

3797 
	`bŒfs_»Ëa£_·th
(
·th
);

3803 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

3804 ià(
	`IS_ERR
(
Œªs
)) {

3805 
»t
 = 
	`PTR_ERR
(
Œªs
);

3806 
out
;

3808 
»t
 = 
	`bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
,

3809 
Ï¡_de¡_’d
, 
de¡off
 + 
Ën
, 1);

3810 ià(
»t
) {

3811 ià(
»t
 !ð-
EOPNOTSUPP
)

3812 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3813 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3814 
out
;

3816 
	`þÚe_upd©e_ex‹Á_m­
(
	`BTRFS_I
(
šode
), 
Œªs
, 
NULL
,

3817 
Ï¡_de¡_’d
,

3818 
de¡off
 + 
Ën
 - 
Ï¡_de¡_’d
);

3819 
»t
 = 
	`þÚe_fšish_šode_upd©e
(
Œªs
, 
šode
, 
de¡off
 + 
Ën
,

3820 
de¡off
, 
Þ’
, 
no_time_upd©e
);

3823 
out
:

3824 
	`bŒfs_ä“_·th
(
·th
);

3825 
	`kvä“
(
buf
);

3826  
»t
;

3827 
	}
}

3829 
nošlše
 
	$bŒfs_þÚe_fžes
(
fže
 *fže, fž*
fže_¤c
,

3830 
u64
 
off
, u64 
Þ’
, u64 
de¡off
)

3832 
šode
 *šodð
	`fže_šode
(
fže
);

3833 
šode
 *
¤c
 = 
	`fže_šode
(
fže_¤c
);

3834 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3835 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3836 
»t
;

3837 
u64
 
Ën
 = 
Þ’
;

3838 
u64
 
bs
 = 
fs_šfo
->
sb
->
s_blocksize
;

3839 
§me_šode
 = 
¤c
 =ð
šode
;

3852 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

3853  -
EROFS
;

3855 ià(
fže_¤c
->
f_·th
.
mÁ
 !ð
fže
->f_path.mnt ||

3856 
¤c
->
i_sb
 !ð
šode
->i_sb)

3857  -
EXDEV
;

3860 ià((
	`BTRFS_I
(
¤c
)->
æags
 & 
BTRFS_INODE_NODATASUM
) !=

3861 (
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
))

3862  -
EINVAL
;

3864 ià(
	`S_ISDIR
(
¤c
->
i_mode
è|| S_ISDIR(
šode
->i_mode))

3865  -
EISDIR
;

3867 ià(!
§me_šode
) {

3868 
	`bŒfs_doubË_šode_lock
(
¤c
, 
šode
);

3870 
	`šode_lock
(
¤c
);

3874 
»t
 = -
EINVAL
;

3875 ià(
off
 + 
Ën
 > 
¤c
->
i_size
 || off +†en < off)

3876 
out_uÆock
;

3877 ià(
Ën
 == 0)

3878 
Þ’
 = 
Ën
 = 
¤c
->
i_size
 - 
off
;

3880 ià(
off
 + 
Ën
 =ð
¤c
->
i_size
)

3881 
Ën
 = 
	`ALIGN
(
¤c
->
i_size
, 
bs
è- 
off
;

3883 ià(
Ën
 == 0) {

3884 
»t
 = 0;

3885 
out_uÆock
;

3889 ià(!
	`IS_ALIGNED
(
off
, 
bs
è|| !IS_ALIGNED(ofà+ 
Ën
, bs) ||

3890 !
	`IS_ALIGNED
(
de¡off
, 
bs
))

3891 
out_uÆock
;

3894 ià(
§me_šode
) {

3895 ià(
de¡off
 + 
Ën
 > 
off
 && destoff < off +†en)

3896 
out_uÆock
;

3899 ià(
de¡off
 > 
šode
->
i_size
) {

3900 
»t
 = 
	`bŒfs_cÚt_ex·nd
(
šode
, inode->
i_size
, 
de¡off
);

3901 ià(
»t
)

3902 
out_uÆock
;

3912 ià(
§me_šode
) {

3913 
u64
 
lock_¡¬t
 = 
	`mš_t
(u64, 
off
, 
de¡off
);

3914 
u64
 
lock_Ën
 = 
	`max_t
(u64, 
off
, 
de¡off
è+ 
Ën
 - 
lock_¡¬t
;

3916 
»t
 = 
	`lock_ex‹Á_¿nge
(
¤c
, 
lock_¡¬t
, 
lock_Ën
, 
Œue
);

3918 
»t
 = 
	`bŒfs_doubË_ex‹Á_lock
(
¤c
, 
off
, 
šode
, 
de¡off
, 
Ën
,

3919 
Œue
);

3921 
	`ASSERT
(
»t
 == 0);

3922 ià(
	`WARN_ON
(
»t
)) {

3924 
out_uÆock
;

3927 
»t
 = 
	`bŒfs_þÚe
(
¤c
, 
šode
, 
off
, 
Þ’
, 
Ën
, 
de¡off
, 0);

3929 ià(
§me_šode
) {

3930 
u64
 
lock_¡¬t
 = 
	`mš_t
(u64, 
off
, 
de¡off
);

3931 
u64
 
lock_’d
 = 
	`max_t
(u64, 
off
, 
de¡off
è+ 
Ën
 - 1;

3933 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
¤c
)->
io_Œ“
, 
lock_¡¬t
, 
lock_’d
);

3935 
	`bŒfs_doubË_ex‹Á_uÆock
(
¤c
, 
off
, 
šode
, 
de¡off
, 
Ën
);

3941 
	`Œunÿ‹_šode_·ges_¿nge
(&
šode
->
i_d©a
,

3942 
	`round_down
(
de¡off
, 
PAGE_SIZE
),

3943 
	`round_up
(
de¡off
 + 
Ën
, 
PAGE_SIZE
) - 1);

3944 
out_uÆock
:

3945 ià(!
§me_šode
)

3946 
	`bŒfs_doubË_šode_uÆock
(
¤c
, 
šode
);

3948 
	`šode_uÆock
(
¤c
);

3949  
»t
;

3950 
	}
}

3952 
	$bŒfs_þÚe_fže_¿nge
(
fže
 *
¤c_fže
, 
loff_t
 
off
,

3953 
fže
 *
d¡_fže
, 
loff_t
 
de¡off
, 
u64
 
Ën
)

3955  
	`bŒfs_þÚe_fžes
(
d¡_fže
, 
¤c_fže
, 
off
, 
Ën
, 
de¡off
);

3956 
	}
}

3964 
	$bŒfs_ioùl_Œªs_¡¬t
(
fže
 *file)

3966 
šode
 *šodð
	`fže_šode
(
fže
);

3967 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3968 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

3969 
bŒfs_Œªs_hªdË
 *
Œªs
;

3970 
bŒfs_fže_´iv©e
 *
´iv©e
;

3971 
»t
;

3972 
boÞ
 
w¬Ãd
 = 
çl£
;

3974 
»t
 = -
EPERM
;

3975 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

3976 
out
;

3978 ià(!
w¬Ãd
) {

3979 
	`bŒfs_w¬n
(
fs_šfo
,

3984 
	`WARN_ON
(1);

3985 
w¬Ãd
 = 
Œue
;

3988 
»t
 = -
EINPROGRESS
;

3989 
´iv©e
 = 
fže
->
´iv©e_d©a
;

3990 ià(
´iv©e
 &&…riv©e->
Œªs
)

3991 
out
;

3992 ià(!
´iv©e
) {

3993 
´iv©e
 = 
	`kz®loc
((
bŒfs_fže_´iv©e
),

3994 
GFP_KERNEL
);

3995 ià(!
´iv©e
)

3996  -
ENOMEM
;

3997 
fže
->
´iv©e_d©a
 = 
´iv©e
;

4000 
»t
 = -
EROFS
;

4001 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

4002 
out
;

4004 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4005 ià(
»t
)

4006 
out
;

4008 
	`©omic_šc
(&
fs_šfo
->
Ý’_ioùl_Œªs
);

4010 
»t
 = -
ENOMEM
;

4011 
Œªs
 = 
	`bŒfs_¡¬t_ioùl_Œª§ùiÚ
(
roÙ
);

4012 ià(
	`IS_ERR
(
Œªs
))

4013 
out_drÝ
;

4015 
´iv©e
->
Œªs
 =rans;

4018 
out_drÝ
:

4019 
	`©omic_dec
(&
fs_šfo
->
Ý’_ioùl_Œªs
);

4020 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4021 
out
:

4022  
»t
;

4023 
	}
}

4025 
	$bŒfs_ioùl_deçuÉ_subvÞ
(
fže
 *fže, 
__u£r
 *
¬gp
)

4027 
šode
 *šodð
	`fže_šode
(
fže
);

4028 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4029 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4030 
bŒfs_roÙ
 *
Ãw_roÙ
;

4031 
bŒfs_dœ_™em
 *
di
;

4032 
bŒfs_Œªs_hªdË
 *
Œªs
;

4033 
bŒfs_·th
 *
·th
;

4034 
bŒfs_key
 
loÿtiÚ
;

4035 
bŒfs_disk_key
 
disk_key
;

4036 
u64
 
objeùid
 = 0;

4037 
u64
 
dœ_id
;

4038 
»t
;

4040 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4041  -
EPERM
;

4043 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4044 ià(
»t
)

4045  
»t
;

4047 ià(
	`cÝy_äom_u£r
(&
objeùid
, 
¬gp
, (objectid))) {

4048 
»t
 = -
EFAULT
;

4049 
out
;

4052 ià(!
objeùid
)

4053 
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

4055 
loÿtiÚ
.
objeùid
 = objectid;

4056 
loÿtiÚ
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4057 
loÿtiÚ
.
off£t
 = (
u64
)-1;

4059 
Ãw_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
loÿtiÚ
);

4060 ià(
	`IS_ERR
(
Ãw_roÙ
)) {

4061 
»t
 = 
	`PTR_ERR
(
Ãw_roÙ
);

4062 
out
;

4064 ià(!
	`is_f¡»e
(
Ãw_roÙ
->
objeùid
)) {

4065 
»t
 = -
ENOENT
;

4066 
out
;

4069 
·th
 = 
	`bŒfs_®loc_·th
();

4070 ià(!
·th
) {

4071 
»t
 = -
ENOMEM
;

4072 
out
;

4074 
·th
->
Ëave_¥šnšg
 = 1;

4076 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 1);

4077 ià(
	`IS_ERR
(
Œªs
)) {

4078 
	`bŒfs_ä“_·th
(
·th
);

4079 
»t
 = 
	`PTR_ERR
(
Œªs
);

4080 
out
;

4083 
dœ_id
 = 
	`bŒfs_su³r_roÙ_dœ
(
fs_šfo
->
su³r_cÝy
);

4084 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
, 
·th
,

4085 
dœ_id
, "default", 7, 1);

4086 ià(
	`IS_ERR_OR_NULL
(
di
)) {

4087 
	`bŒfs_ä“_·th
(
·th
);

4088 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4089 
	`bŒfs_”r
(
fs_šfo
,

4091 
»t
 = -
ENOENT
;

4092 
out
;

4095 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, &
Ãw_roÙ
->
roÙ_key
);

4096 
	`bŒfs_£t_dœ_™em_key
(
·th
->
nodes
[0], 
di
, &
disk_key
);

4097 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

4098 
	`bŒfs_ä“_·th
(
·th
);

4100 
	`bŒfs_£t_fs_šcom·t
(
fs_šfo
, 
DEFAULT_SUBVOL
);

4101 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4102 
out
:

4103 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4104  
»t
;

4105 
	}
}

4107 
	$bŒfs_g‘_block_group_šfo
(
li¡_h—d
 *
groups_li¡
,

4108 
bŒfs_ioùl_¥aû_šfo
 *
¥aû
)

4110 
bŒfs_block_group_ÿche
 *
block_group
;

4112 
¥aû
->
tÙ®_by‹s
 = 0;

4113 
¥aû
->
u£d_by‹s
 = 0;

4114 
¥aû
->
æags
 = 0;

4115 
	`li¡_fÜ_—ch_’Œy
(
block_group
, 
groups_li¡
, 
li¡
) {

4116 
¥aû
->
æags
 = 
block_group
->flags;

4117 
¥aû
->
tÙ®_by‹s
 +ð
block_group
->
key
.
off£t
;

4118 
¥aû
->
u£d_by‹s
 +=

4119 
	`bŒfs_block_group_u£d
(&
block_group
->
™em
);

4121 
	}
}

4123 
	$bŒfs_ioùl_¥aû_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
,

4124 
__u£r
 *
¬g
)

4126 
bŒfs_ioùl_¥aû_¬gs
 
¥aû_¬gs
;

4127 
bŒfs_ioùl_¥aû_šfo
 
¥aû
;

4128 
bŒfs_ioùl_¥aû_šfo
 *
de¡
;

4129 
bŒfs_ioùl_¥aû_šfo
 *
de¡_Üig
;

4130 
bŒfs_ioùl_¥aû_šfo
 
__u£r
 *
u£r_de¡
;

4131 
bŒfs_¥aû_šfo
 *
šfo
;

4132 
u64
 
ty³s
[] = {
BTRFS_BLOCK_GROUP_DATA
,

4133 
BTRFS_BLOCK_GROUP_SYSTEM
,

4134 
BTRFS_BLOCK_GROUP_METADATA
,

4135 
BTRFS_BLOCK_GROUP_DATA
 | 
BTRFS_BLOCK_GROUP_METADATA
};

4136 
num_ty³s
 = 4;

4137 
®loc_size
;

4138 
»t
 = 0;

4139 
u64
 
¦Ù_couÁ
 = 0;

4140 
i
, 
c
;

4142 ià(
	`cÝy_äom_u£r
(&
¥aû_¬gs
,

4143 (
bŒfs_ioùl_¥aû_¬gs
 
__u£r
 *)
¬g
,

4144 (
¥aû_¬gs
)))

4145  -
EFAULT
;

4147 
i
 = 0; i < 
num_ty³s
; i++) {

4148 
bŒfs_¥aû_šfo
 *
tmp
;

4150 
šfo
 = 
NULL
;

4151 
	`rcu_»ad_lock
();

4152 
	`li¡_fÜ_—ch_’Œy_rcu
(
tmp
, &
fs_šfo
->
¥aû_šfo
,

4153 
li¡
) {

4154 ià(
tmp
->
æags
 =ð
ty³s
[
i
]) {

4155 
šfo
 = 
tmp
;

4159 
	`rcu_»ad_uÆock
();

4161 ià(!
šfo
)

4164 
	`down_»ad
(&
šfo
->
groups_£m
);

4165 
c
 = 0; c < 
BTRFS_NR_RAID_TYPES
; c++) {

4166 ià(!
	`li¡_em±y
(&
šfo
->
block_groups
[
c
]))

4167 
¦Ù_couÁ
++;

4169 
	`up_»ad
(&
šfo
->
groups_£m
);

4175 
¦Ù_couÁ
++;

4178 ià(
¥aû_¬gs
.
¥aû_¦Ùs
 == 0) {

4179 
¥aû_¬gs
.
tÙ®_¥aûs
 = 
¦Ù_couÁ
;

4180 
out
;

4183 
¦Ù_couÁ
 = 
	`mš_t
(
u64
, 
¥aû_¬gs
.
¥aû_¦Ùs
, slot_count);

4185 
®loc_size
 = (*
de¡
è* 
¦Ù_couÁ
;

4190 ià(
®loc_size
 > 
PAGE_SIZE
)

4191  -
ENOMEM
;

4193 
¥aû_¬gs
.
tÙ®_¥aûs
 = 0;

4194 
de¡
 = 
	`km®loc
(
®loc_size
, 
GFP_KERNEL
);

4195 ià(!
de¡
)

4196  -
ENOMEM
;

4197 
de¡_Üig
 = 
de¡
;

4200 
i
 = 0; i < 
num_ty³s
; i++) {

4201 
bŒfs_¥aû_šfo
 *
tmp
;

4203 ià(!
¦Ù_couÁ
)

4206 
šfo
 = 
NULL
;

4207 
	`rcu_»ad_lock
();

4208 
	`li¡_fÜ_—ch_’Œy_rcu
(
tmp
, &
fs_šfo
->
¥aû_šfo
,

4209 
li¡
) {

4210 ià(
tmp
->
æags
 =ð
ty³s
[
i
]) {

4211 
šfo
 = 
tmp
;

4215 
	`rcu_»ad_uÆock
();

4217 ià(!
šfo
)

4219 
	`down_»ad
(&
šfo
->
groups_£m
);

4220 
c
 = 0; c < 
BTRFS_NR_RAID_TYPES
; c++) {

4221 ià(!
	`li¡_em±y
(&
šfo
->
block_groups
[
c
])) {

4222 
	`bŒfs_g‘_block_group_šfo
(

4223 &
šfo
->
block_groups
[
c
], &
¥aû
);

4224 
	`memýy
(
de¡
, &
¥aû
, (space));

4225 
de¡
++;

4226 
¥aû_¬gs
.
tÙ®_¥aûs
++;

4227 
¦Ù_couÁ
--;

4229 ià(!
¦Ù_couÁ
)

4232 
	`up_»ad
(&
šfo
->
groups_£m
);

4238 ià(
¦Ù_couÁ
) {

4239 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

4241 
	`¥š_lock
(&
block_rsv
->
lock
);

4242 
¥aû
.
tÙ®_by‹s
 = 
block_rsv
->
size
;

4243 
¥aû
.
u£d_by‹s
 = 
block_rsv
->
size
 - block_rsv->
»£rved
;

4244 
	`¥š_uÆock
(&
block_rsv
->
lock
);

4245 
¥aû
.
æags
 = 
BTRFS_SPACE_INFO_GLOBAL_RSV
;

4246 
	`memýy
(
de¡
, &
¥aû
, (space));

4247 
¥aû_¬gs
.
tÙ®_¥aûs
++;

4250 
u£r_de¡
 = (
bŒfs_ioùl_¥aû_šfo
 
__u£r
 *)

4251 (
¬g
 + (
bŒfs_ioùl_¥aû_¬gs
));

4253 ià(
	`cÝy_to_u£r
(
u£r_de¡
, 
de¡_Üig
, 
®loc_size
))

4254 
»t
 = -
EFAULT
;

4256 
	`kä“
(
de¡_Üig
);

4257 
out
:

4258 ià(
»t
 =ð0 && 
	`cÝy_to_u£r
(
¬g
, &
¥aû_¬gs
, (space_args)))

4259 
»t
 = -
EFAULT
;

4261  
»t
;

4262 
	}
}

4270 
	$bŒfs_ioùl_Œªs_’d
(
fže
 *file)

4272 
šode
 *šodð
	`fže_šode
(
fže
);

4273 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4274 
bŒfs_fže_´iv©e
 *
´iv©e
 = 
fže
->
´iv©e_d©a
;

4276 ià(!
´iv©e
 || !´iv©e->
Œªs
)

4277  -
EINVAL
;

4279 
	`bŒfs_’d_Œª§ùiÚ
(
´iv©e
->
Œªs
);

4280 
´iv©e
->
Œªs
 = 
NULL
;

4282 
	`©omic_dec
(&
roÙ
->
fs_šfo
->
Ý’_ioùl_Œªs
);

4284 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4286 
	}
}

4288 
nošlše
 
	$bŒfs_ioùl_¡¬t_sync
(
bŒfs_roÙ
 *
roÙ
,

4289 
__u£r
 *
¬gp
)

4291 
bŒfs_Œªs_hªdË
 *
Œªs
;

4292 
u64
 
Œªsid
;

4293 
»t
;

4295 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

4296 ià(
	`IS_ERR
(
Œªs
)) {

4297 ià(
	`PTR_ERR
(
Œªs
è!ð-
ENOENT
)

4298  
	`PTR_ERR
(
Œªs
);

4301 
Œªsid
 = 
roÙ
->
fs_šfo
->
Ï¡_Œªs_comm™‹d
;

4302 
out
;

4304 
Œªsid
 = 
Œªs
->transid;

4305 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ_async
(
Œªs
, 0);

4306 ià(
»t
) {

4307 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4308  
»t
;

4310 
out
:

4311 ià(
¬gp
)

4312 ià(
	`cÝy_to_u£r
(
¬gp
, &
Œªsid
, (transid)))

4313  -
EFAULT
;

4315 
	}
}

4317 
nošlše
 
	$bŒfs_ioùl_wa™_sync
(
bŒfs_fs_šfo
 *
fs_šfo
,

4318 
__u£r
 *
¬gp
)

4320 
u64
 
Œªsid
;

4322 ià(
¬gp
) {

4323 ià(
	`cÝy_äom_u£r
(&
Œªsid
, 
¬gp
, (transid)))

4324  -
EFAULT
;

4326 
Œªsid
 = 0;

4328  
	`bŒfs_wa™_fÜ_comm™
(
fs_šfo
, 
Œªsid
);

4329 
	}
}

4331 
	$bŒfs_ioùl_süub
(
fže
 *fže, 
__u£r
 *
¬g
)

4333 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
	`fže_šode
(
fže
)->
i_sb
);

4334 
bŒfs_ioùl_süub_¬gs
 *
§
;

4335 
»t
;

4337 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4338  -
EPERM
;

4340 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4341 ià(
	`IS_ERR
(
§
))

4342  
	`PTR_ERR
(
§
);

4344 ià(!(
§
->
æags
 & 
BTRFS_SCRUB_READONLY
)) {

4345 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4346 ià(
»t
)

4347 
out
;

4350 
»t
 = 
	`bŒfs_süub_dev
(
fs_šfo
, 
§
->
devid
, sa->
¡¬t
, sa->
’d
,

4351 &
§
->
´og»ss
, sa->
æags
 & 
BTRFS_SCRUB_READONLY
,

4354 ià(
	`cÝy_to_u£r
(
¬g
, 
§
, (*sa)))

4355 
»t
 = -
EFAULT
;

4357 ià(!(
§
->
æags
 & 
BTRFS_SCRUB_READONLY
))

4358 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4359 
out
:

4360 
	`kä“
(
§
);

4361  
»t
;

4362 
	}
}

4364 
	$bŒfs_ioùl_süub_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
)

4366 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4367  -
EPERM
;

4369  
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

4370 
	}
}

4372 
	$bŒfs_ioùl_süub_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
,

4373 
__u£r
 *
¬g
)

4375 
bŒfs_ioùl_süub_¬gs
 *
§
;

4376 
»t
;

4378 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4379  -
EPERM
;

4381 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4382 ià(
	`IS_ERR
(
§
))

4383  
	`PTR_ERR
(
§
);

4385 
»t
 = 
	`bŒfs_süub_´og»ss
(
fs_šfo
, 
§
->
devid
, &§->
´og»ss
);

4387 ià(
	`cÝy_to_u£r
(
¬g
, 
§
, (*sa)))

4388 
»t
 = -
EFAULT
;

4390 
	`kä“
(
§
);

4391  
»t
;

4392 
	}
}

4394 
	$bŒfs_ioùl_g‘_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
,

4395 
__u£r
 *
¬g
)

4397 
bŒfs_ioùl_g‘_dev_¡©s
 *
§
;

4398 
»t
;

4400 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4401 ià(
	`IS_ERR
(
§
))

4402  
	`PTR_ERR
(
§
);

4404 ià((
§
->
æags
 & 
BTRFS_DEV_STATS_RESET
è&& !
	`ÿ·bË
(
CAP_SYS_ADMIN
)) {

4405 
	`kä“
(
§
);

4406  -
EPERM
;

4409 
»t
 = 
	`bŒfs_g‘_dev_¡©s
(
fs_šfo
, 
§
);

4411 ià(
	`cÝy_to_u£r
(
¬g
, 
§
, (*sa)))

4412 
»t
 = -
EFAULT
;

4414 
	`kä“
(
§
);

4415  
»t
;

4416 
	}
}

4418 
	$bŒfs_ioùl_dev_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

4419 
__u£r
 *
¬g
)

4421 
bŒfs_ioùl_dev_»¶aû_¬gs
 *
p
;

4422 
»t
;

4424 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4425  -
EPERM
;

4427 
p
 = 
	`memdup_u£r
(
¬g
, (*p));

4428 ià(
	`IS_ERR
(
p
))

4429  
	`PTR_ERR
(
p
);

4431 
p
->
cmd
) {

4432 
BTRFS_IOCTL_DEV_REPLACE_CMD_START
:

4433 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
)) {

4434 
»t
 = -
EROFS
;

4435 
out
;

4437 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
)) {

4438 
»t
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

4440 
»t
 = 
	`bŒfs_dev_»¶aû_by_ioùl
(
fs_šfo
, 
p
);

4441 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

4444 
BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS
:

4445 
	`bŒfs_dev_»¶aû_¡©us
(
fs_šfo
, 
p
);

4446 
»t
 = 0;

4448 
BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL
:

4449 
»t
 = 
	`bŒfs_dev_»¶aû_ÿnûl
(
fs_šfo
, 
p
);

4452 
»t
 = -
EINVAL
;

4456 ià(
	`cÝy_to_u£r
(
¬g
, 
p
, (*p)))

4457 
»t
 = -
EFAULT
;

4458 
out
:

4459 
	`kä“
(
p
);

4460  
»t
;

4461 
	}
}

4463 
	$bŒfs_ioùl_šo_to_·th
(
bŒfs_roÙ
 *
roÙ
, 
__u£r
 *
¬g
)

4465 
»t
 = 0;

4466 
i
;

4467 
u64
 
»l_±r
;

4468 
size
;

4469 
bŒfs_ioùl_šo_·th_¬gs
 *
a
 = 
NULL
;

4470 
šode_fs_·ths
 *
©h
 = 
NULL
;

4471 
bŒfs_·th
 *
·th
;

4473 ià(!
	`ÿ·bË
(
CAP_DAC_READ_SEARCH
))

4474  -
EPERM
;

4476 
·th
 = 
	`bŒfs_®loc_·th
();

4477 ià(!
·th
) {

4478 
»t
 = -
ENOMEM
;

4479 
out
;

4482 
a
 = 
	`memdup_u£r
(
¬g
, (*ipa));

4483 ià(
	`IS_ERR
(
a
)) {

4484 
»t
 = 
	`PTR_ERR
(
a
);

4485 
a
 = 
NULL
;

4486 
out
;

4489 
size
 = 
	`mš_t
(
u32
, 
a
->size, 4096);

4490 
©h
 = 
	`š™_©h
(
size
, 
roÙ
, 
·th
);

4491 ià(
	`IS_ERR
(
©h
)) {

4492 
»t
 = 
	`PTR_ERR
(
©h
);

4493 
©h
 = 
NULL
;

4494 
out
;

4497 
»t
 = 
	`·ths_äom_šode
(
a
->
šum
, 
©h
);

4498 ià(
»t
 < 0)

4499 
out
;

4501 
i
 = 0; i < 
©h
->
f¥©h
->
–em_út
; ++i) {

4502 
»l_±r
 = 
©h
->
f¥©h
->
v®
[
i
] -

4503 (
u64
)()
©h
->
f¥©h
->
v®
;

4504 
©h
->
f¥©h
->
v®
[
i
] = 
»l_±r
;

4507 
»t
 = 
	`cÝy_to_u£r
((*)()
a
->
f¥©h
,

4508 (*)()
©h
->
f¥©h
, 
size
);

4509 ià(
»t
) {

4510 
»t
 = -
EFAULT
;

4511 
out
;

4514 
out
:

4515 
	`bŒfs_ä“_·th
(
·th
);

4516 
	`ä“_©h
(
©h
);

4517 
	`kä“
(
a
);

4519  
»t
;

4520 
	}
}

4522 
	$bužd_šo_li¡
(
u64
 
šum
, u64 
off£t
, u64 
roÙ
, *
ùx
)

4524 
bŒfs_d©a_cÚš”
 *
šodes
 = 
ùx
;

4525 cÚ¡ 
size_t
 
c
 = 3 * (
u64
);

4527 ià(
šodes
->
by‹s_Ëá
 >ð
c
) {

4528 
šodes
->
by‹s_Ëá
 -ð
c
;

4529 
šodes
->
v®
[šodes->
–em_út
] = 
šum
;

4530 
šodes
->
v®
[šodes->
–em_út
 + 1] = 
off£t
;

4531 
šodes
->
v®
[šodes->
–em_út
 + 2] = 
roÙ
;

4532 
šodes
->
–em_út
 += 3;

4534 
šodes
->
by‹s_missšg
 +ð
c
 - inodes->
by‹s_Ëá
;

4535 
šodes
->
by‹s_Ëá
 = 0;

4536 
šodes
->
–em_mis£d
 += 3;

4540 
	}
}

4542 
	$bŒfs_ioùl_logiÿl_to_šo
(
bŒfs_fs_šfo
 *
fs_šfo
,

4543 
__u£r
 *
¬g
)

4545 
»t
 = 0;

4546 
size
;

4547 
bŒfs_ioùl_logiÿl_šo_¬gs
 *
loi
;

4548 
bŒfs_d©a_cÚš”
 *
šodes
 = 
NULL
;

4549 
bŒfs_·th
 *
·th
 = 
NULL
;

4551 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4552  -
EPERM
;

4554 
loi
 = 
	`memdup_u£r
(
¬g
, (*loi));

4555 ià(
	`IS_ERR
(
loi
))

4556  
	`PTR_ERR
(
loi
);

4558 
·th
 = 
	`bŒfs_®loc_·th
();

4559 ià(!
·th
) {

4560 
»t
 = -
ENOMEM
;

4561 
out
;

4564 
size
 = 
	`mš_t
(
u32
, 
loi
->size, 
SZ_64K
);

4565 
šodes
 = 
	`š™_d©a_cÚš”
(
size
);

4566 ià(
	`IS_ERR
(
šodes
)) {

4567 
»t
 = 
	`PTR_ERR
(
šodes
);

4568 
šodes
 = 
NULL
;

4569 
out
;

4572 
»t
 = 
	`™”©e_šodes_äom_logiÿl
(
loi
->
logiÿl
, 
fs_šfo
, 
·th
,

4573 
bužd_šo_li¡
, 
šodes
);

4574 ià(
»t
 =ð-
EINVAL
)

4575 
»t
 = -
ENOENT
;

4576 ià(
»t
 < 0)

4577 
out
;

4579 
»t
 = 
	`cÝy_to_u£r
((*)()
loi
->
šodes
,

4580 (*)()
šodes
, 
size
);

4581 ià(
»t
)

4582 
»t
 = -
EFAULT
;

4584 
out
:

4585 
	`bŒfs_ä“_·th
(
·th
);

4586 
	`kvä“
(
šodes
);

4587 
	`kä“
(
loi
);

4589  
»t
;

4590 
	}
}

4592 
	$upd©e_ioùl_b®ªû_¬gs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
lock
,

4593 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
)

4595 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

4597 
b¬gs
->
æags
 = 
bùl
->flags;

4599 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
))

4600 
b¬gs
->
¡©e
 |ð
BTRFS_BALANCE_STATE_RUNNING
;

4601 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
))

4602 
b¬gs
->
¡©e
 |ð
BTRFS_BALANCE_STATE_PAUSE_REQ
;

4603 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
))

4604 
b¬gs
->
¡©e
 |ð
BTRFS_BALANCE_STATE_CANCEL_REQ
;

4606 
	`memýy
(&
b¬gs
->
d©a
, &
bùl
->data, (bargs->data));

4607 
	`memýy
(&
b¬gs
->
m‘a
, &
bùl
->meta, (bargs->meta));

4608 
	`memýy
(&
b¬gs
->
sys
, &
bùl
->sys, (bargs->sys));

4610 ià(
lock
) {

4611 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4612 
	`memýy
(&
b¬gs
->
¡©
, &
bùl
->stat, (bargs->stat));

4613 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4615 
	`memýy
(&
b¬gs
->
¡©
, &
bùl
->stat, (bargs->stat));

4617 
	}
}

4619 
	$bŒfs_ioùl_b®ªû
(
fže
 *fže, 
__u£r
 *
¬g
)

4621 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
	`fže_šode
(
fže
))->root;

4622 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4623 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
;

4624 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
;

4625 
boÞ
 
Ãed_uÆock
;

4626 
»t
;

4628 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4629  -
EPERM
;

4631 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4632 ià(
»t
)

4633  
»t
;

4635 
agaš
:

4636 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
)) {

4637 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

4638 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4639 
Ãed_uÆock
 = 
Œue
;

4640 
locked
;

4649 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4650 ià(
fs_šfo
->
b®ªû_ùl
) {

4652 ià(!
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
)) {

4653 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4654 ià(!
	`mu‹x_Œylock
(&
fs_šfo
->
vÞume_mu‹x
))

4655 
agaš
;

4656 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4658 ià(
fs_šfo
->
b®ªû_ùl
 &&

4659 !
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
)) {

4661 
Ãed_uÆock
 = 
çl£
;

4662 
locked
;

4665 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4666 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

4667 
agaš
;

4670 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4671 
»t
 = -
EINPROGRESS
;

4672 
out
;

4676 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4677 
»t
 = 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
;

4678 
out
;

4681 
locked
:

4682 
	`BUG_ON
(!
	`‹¡_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
));

4684 ià(
¬g
) {

4685 
b¬gs
 = 
	`memdup_u£r
(
¬g
, (*bargs));

4686 ià(
	`IS_ERR
(
b¬gs
)) {

4687 
»t
 = 
	`PTR_ERR
(
b¬gs
);

4688 
out_uÆock
;

4691 ià(
b¬gs
->
æags
 & 
BTRFS_BALANCE_RESUME
) {

4692 ià(!
fs_šfo
->
b®ªû_ùl
) {

4693 
»t
 = -
ENOTCONN
;

4694 
out_b¬gs
;

4697 
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

4698 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

4699 
bùl
->
æags
 |ð
BTRFS_BALANCE_RESUME
;

4700 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

4702 
do_b®ªû
;

4705 
b¬gs
 = 
NULL
;

4708 ià(
fs_šfo
->
b®ªû_ùl
) {

4709 
»t
 = -
EINPROGRESS
;

4710 
out_b¬gs
;

4713 
bùl
 = 
	`kz®loc
((*bùl), 
GFP_KERNEL
);

4714 ià(!
bùl
) {

4715 
»t
 = -
ENOMEM
;

4716 
out_b¬gs
;

4719 
bùl
->
fs_šfo
 = fs_info;

4720 ià(
¬g
) {

4721 
	`memýy
(&
bùl
->
d©a
, &
b¬gs
->data, (bctl->data));

4722 
	`memýy
(&
bùl
->
m‘a
, &
b¬gs
->meta, (bctl->meta));

4723 
	`memýy
(&
bùl
->
sys
, &
b¬gs
->sys, (bctl->sys));

4725 
bùl
->
æags
 = 
b¬gs
->flags;

4728 
bùl
->
æags
 |ð
BTRFS_BALANCE_TYPE_MASK
;

4731 ià(
bùl
->
æags
 & ~(
BTRFS_BALANCE_ARGS_MASK
 | 
BTRFS_BALANCE_TYPE_MASK
)) {

4732 
»t
 = -
EINVAL
;

4733 
out_bùl
;

4736 
do_b®ªû
:

4743 
Ãed_uÆock
 = 
çl£
;

4745 
»t
 = 
	`bŒfs_b®ªû
(
bùl
, 
b¬gs
);

4746 
bùl
 = 
NULL
;

4748 ià(
¬g
) {

4749 ià(
	`cÝy_to_u£r
(
¬g
, 
b¬gs
, (*bargs)))

4750 
»t
 = -
EFAULT
;

4753 
out_bùl
:

4754 
	`kä“
(
bùl
);

4755 
out_b¬gs
:

4756 
	`kä“
(
b¬gs
);

4757 
out_uÆock
:

4758 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4759 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

4760 ià(
Ãed_uÆock
)

4761 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

4762 
out
:

4763 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4764  
»t
;

4765 
	}
}

4767 
	$bŒfs_ioùl_b®ªû_ùl
(
bŒfs_fs_šfo
 *
fs_šfo
, 
cmd
)

4769 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4770  -
EPERM
;

4772 
cmd
) {

4773 
BTRFS_BALANCE_CTL_PAUSE
:

4774  
	`bŒfs_·u£_b®ªû
(
fs_šfo
);

4775 
BTRFS_BALANCE_CTL_CANCEL
:

4776  
	`bŒfs_ÿnûl_b®ªû
(
fs_šfo
);

4779  -
EINVAL
;

4780 
	}
}

4782 
	$bŒfs_ioùl_b®ªû_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
,

4783 
__u£r
 *
¬g
)

4785 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
;

4786 
»t
 = 0;

4788 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4789  -
EPERM
;

4791 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4792 ià(!
fs_šfo
->
b®ªû_ùl
) {

4793 
»t
 = -
ENOTCONN
;

4794 
out
;

4797 
b¬gs
 = 
	`kz®loc
((*b¬gs), 
GFP_KERNEL
);

4798 ià(!
b¬gs
) {

4799 
»t
 = -
ENOMEM
;

4800 
out
;

4803 
	`upd©e_ioùl_b®ªû_¬gs
(
fs_šfo
, 1, 
b¬gs
);

4805 ià(
	`cÝy_to_u£r
(
¬g
, 
b¬gs
, (*bargs)))

4806 
»t
 = -
EFAULT
;

4808 
	`kä“
(
b¬gs
);

4809 
out
:

4810 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4811  
»t
;

4812 
	}
}

4814 
	$bŒfs_ioùl_quÙa_ùl
(
fže
 *fže, 
__u£r
 *
¬g
)

4816 
šode
 *šodð
	`fže_šode
(
fže
);

4817 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4818 
bŒfs_ioùl_quÙa_ùl_¬gs
 *
§
;

4819 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

4820 
»t
;

4821 
”r
;

4823 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4824  -
EPERM
;

4826 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4827 ià(
»t
)

4828  
»t
;

4830 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4831 ià(
	`IS_ERR
(
§
)) {

4832 
»t
 = 
	`PTR_ERR
(
§
);

4833 
drÝ_wr™e
;

4836 
	`down_wr™e
(&
fs_šfo
->
subvÞ_£m
);

4837 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 2);

4838 ià(
	`IS_ERR
(
Œªs
)) {

4839 
»t
 = 
	`PTR_ERR
(
Œªs
);

4840 
out
;

4843 
§
->
cmd
) {

4844 
BTRFS_QUOTA_CTL_ENABLE
:

4845 
»t
 = 
	`bŒfs_quÙa_’abË
(
Œªs
, 
fs_šfo
);

4847 
BTRFS_QUOTA_CTL_DISABLE
:

4848 
»t
 = 
	`bŒfs_quÙa_di§bË
(
Œªs
, 
fs_šfo
);

4851 
»t
 = -
EINVAL
;

4855 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4856 ià(
”r
 && !
»t
)

4857 
»t
 = 
”r
;

4858 
out
:

4859 
	`kä“
(
§
);

4860 
	`up_wr™e
(&
fs_šfo
->
subvÞ_£m
);

4861 
drÝ_wr™e
:

4862 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4863  
»t
;

4864 
	}
}

4866 
	$bŒfs_ioùl_qgroup_assign
(
fže
 *fže, 
__u£r
 *
¬g
)

4868 
šode
 *šodð
	`fže_šode
(
fže
);

4869 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4870 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4871 
bŒfs_ioùl_qgroup_assign_¬gs
 *
§
;

4872 
bŒfs_Œªs_hªdË
 *
Œªs
;

4873 
»t
;

4874 
”r
;

4876 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4877  -
EPERM
;

4879 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4880 ià(
»t
)

4881  
»t
;

4883 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4884 ià(
	`IS_ERR
(
§
)) {

4885 
»t
 = 
	`PTR_ERR
(
§
);

4886 
drÝ_wr™e
;

4889 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4890 ià(
	`IS_ERR
(
Œªs
)) {

4891 
»t
 = 
	`PTR_ERR
(
Œªs
);

4892 
out
;

4895 ià(
§
->
assign
) {

4896 
»t
 = 
	`bŒfs_add_qgroup_»ÏtiÚ
(
Œªs
, 
fs_šfo
,

4897 
§
->
¤c
, sa->
d¡
);

4899 
»t
 = 
	`bŒfs_d–_qgroup_»ÏtiÚ
(
Œªs
, 
fs_šfo
,

4900 
§
->
¤c
, sa->
d¡
);

4904 
”r
 = 
	`bŒfs_run_qgroups
(
Œªs
, 
fs_šfo
);

4905 ià(
”r
 < 0)

4906 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
,

4908 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4909 ià(
”r
 && !
»t
)

4910 
»t
 = 
”r
;

4912 
out
:

4913 
	`kä“
(
§
);

4914 
drÝ_wr™e
:

4915 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4916  
»t
;

4917 
	}
}

4919 
	$bŒfs_ioùl_qgroup_ü—‹
(
fže
 *fže, 
__u£r
 *
¬g
)

4921 
šode
 *šodð
	`fže_šode
(
fže
);

4922 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4923 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4924 
bŒfs_ioùl_qgroup_ü—‹_¬gs
 *
§
;

4925 
bŒfs_Œªs_hªdË
 *
Œªs
;

4926 
»t
;

4927 
”r
;

4929 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4930  -
EPERM
;

4932 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4933 ià(
»t
)

4934  
»t
;

4936 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4937 ià(
	`IS_ERR
(
§
)) {

4938 
»t
 = 
	`PTR_ERR
(
§
);

4939 
drÝ_wr™e
;

4942 ià(!
§
->
qgroupid
) {

4943 
»t
 = -
EINVAL
;

4944 
out
;

4947 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4948 ià(
	`IS_ERR
(
Œªs
)) {

4949 
»t
 = 
	`PTR_ERR
(
Œªs
);

4950 
out
;

4953 ià(
§
->
ü—‹
) {

4954 
»t
 = 
	`bŒfs_ü—‹_qgroup
(
Œªs
, 
fs_šfo
, 
§
->
qgroupid
);

4956 
»t
 = 
	`bŒfs_»move_qgroup
(
Œªs
, 
fs_šfo
, 
§
->
qgroupid
);

4959 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4960 ià(
”r
 && !
»t
)

4961 
»t
 = 
”r
;

4963 
out
:

4964 
	`kä“
(
§
);

4965 
drÝ_wr™e
:

4966 
	`mÁ_drÝ_wr™e_fže
(
fže
);

4967  
»t
;

4968 
	}
}

4970 
	$bŒfs_ioùl_qgroup_lim™
(
fže
 *fže, 
__u£r
 *
¬g
)

4972 
šode
 *šodð
	`fže_šode
(
fže
);

4973 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4974 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

4975 
bŒfs_ioùl_qgroup_lim™_¬gs
 *
§
;

4976 
bŒfs_Œªs_hªdË
 *
Œªs
;

4977 
»t
;

4978 
”r
;

4979 
u64
 
qgroupid
;

4981 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

4982  -
EPERM
;

4984 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

4985 ià(
»t
)

4986  
»t
;

4988 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

4989 ià(
	`IS_ERR
(
§
)) {

4990 
»t
 = 
	`PTR_ERR
(
§
);

4991 
drÝ_wr™e
;

4994 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4995 ià(
	`IS_ERR
(
Œªs
)) {

4996 
»t
 = 
	`PTR_ERR
(
Œªs
);

4997 
out
;

5000 
qgroupid
 = 
§
->qgroupid;

5001 ià(!
qgroupid
) {

5003 
qgroupid
 = 
roÙ
->
roÙ_key
.
objeùid
;

5006 
»t
 = 
	`bŒfs_lim™_qgroup
(
Œªs
, 
fs_šfo
, 
qgroupid
, &
§
->
lim
);

5008 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5009 ià(
”r
 && !
»t
)

5010 
»t
 = 
”r
;

5012 
out
:

5013 
	`kä“
(
§
);

5014 
drÝ_wr™e
:

5015 
	`mÁ_drÝ_wr™e_fže
(
fže
);

5016  
»t
;

5017 
	}
}

5019 
	$bŒfs_ioùl_quÙa_»sÿn
(
fže
 *fže, 
__u£r
 *
¬g
)

5021 
šode
 *šodð
	`fže_šode
(
fže
);

5022 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5023 
bŒfs_ioùl_quÙa_»sÿn_¬gs
 *
q§
;

5024 
»t
;

5026 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

5027  -
EPERM
;

5029 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

5030 ià(
»t
)

5031  
»t
;

5033 
q§
 = 
	`memdup_u£r
(
¬g
, (*qsa));

5034 ià(
	`IS_ERR
(
q§
)) {

5035 
»t
 = 
	`PTR_ERR
(
q§
);

5036 
drÝ_wr™e
;

5039 ià(
q§
->
æags
) {

5040 
»t
 = -
EINVAL
;

5041 
out
;

5044 
»t
 = 
	`bŒfs_qgroup_»sÿn
(
fs_šfo
);

5046 
out
:

5047 
	`kä“
(
q§
);

5048 
drÝ_wr™e
:

5049 
	`mÁ_drÝ_wr™e_fže
(
fže
);

5050  
»t
;

5051 
	}
}

5053 
	$bŒfs_ioùl_quÙa_»sÿn_¡©us
(
fže
 *fže, 
__u£r
 *
¬g
)

5055 
šode
 *šodð
	`fže_šode
(
fže
);

5056 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5057 
bŒfs_ioùl_quÙa_»sÿn_¬gs
 *
q§
;

5058 
»t
 = 0;

5060 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

5061  -
EPERM
;

5063 
q§
 = 
	`kz®loc
((*q§), 
GFP_KERNEL
);

5064 ià(!
q§
)

5065  -
ENOMEM
;

5067 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

5068 
q§
->
æags
 = 1;

5069 
q§
->
´og»ss
 = 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
;

5072 ià(
	`cÝy_to_u£r
(
¬g
, 
q§
, (*qsa)))

5073 
»t
 = -
EFAULT
;

5075 
	`kä“
(
q§
);

5076  
»t
;

5077 
	}
}

5079 
	$bŒfs_ioùl_quÙa_»sÿn_wa™
(
fže
 *fže, 
__u£r
 *
¬g
)

5081 
šode
 *šodð
	`fže_šode
(
fže
);

5082 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5084 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

5085  -
EPERM
;

5087  
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
Œue
);

5088 
	}
}

5090 
	$_bŒfs_ioùl_£t_»ûived_subvÞ
(
fže
 *file,

5091 
bŒfs_ioùl_»ûived_subvÞ_¬gs
 *
§
)

5093 
šode
 *šodð
	`fže_šode
(
fže
);

5094 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5095 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5096 
bŒfs_roÙ_™em
 *
roÙ_™em
 = &
roÙ
->root_item;

5097 
bŒfs_Œªs_hªdË
 *
Œªs
;

5098 
time¥ec
 
ù
 = 
	`cu¼’t_time
(
šode
);

5099 
»t
 = 0;

5100 
»ûived_uuid_chªged
;

5102 ià(!
	`šode_owÃr_Ü_ÿ·bË
(
šode
))

5103  -
EPERM
;

5105 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

5106 ià(
»t
 < 0)

5107  
»t
;

5109 
	`down_wr™e
(&
fs_šfo
->
subvÞ_£m
);

5111 ià(
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)è!ð
BTRFS_FIRST_FREE_OBJECTID
) {

5112 
»t
 = -
EINVAL
;

5113 
out
;

5116 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
)) {

5117 
»t
 = -
EROFS
;

5118 
out
;

5125 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 3);

5126 ià(
	`IS_ERR
(
Œªs
)) {

5127 
»t
 = 
	`PTR_ERR
(
Œªs
);

5128 
Œªs
 = 
NULL
;

5129 
out
;

5132 
§
->
¹¿nsid
 = 
Œªs
->
Œªsid
;

5133 
§
->
¹ime
.
£c
 = 
ù
.
tv_£c
;

5134 
§
->
¹ime
.
n£c
 = 
ù
.
tv_n£c
;

5136 
»ûived_uuid_chªged
 = 
	`memcmp
(
roÙ_™em
->
»ûived_uuid
, 
§
->
uuid
,

5137 
BTRFS_UUID_SIZE
);

5138 ià(
»ûived_uuid_chªged
 &&

5139 !
	`bŒfs_is_em±y_uuid
(
roÙ_™em
->
»ûived_uuid
))

5140 
	`bŒfs_uuid_Œ“_»m
(
Œªs
, 
fs_šfo
, 
roÙ_™em
->
»ûived_uuid
,

5141 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

5142 
roÙ
->
roÙ_key
.
objeùid
);

5143 
	`memýy
(
roÙ_™em
->
»ûived_uuid
, 
§
->
uuid
, 
BTRFS_UUID_SIZE
);

5144 
	`bŒfs_£t_roÙ_¡¿nsid
(
roÙ_™em
, 
§
->
¡¿nsid
);

5145 
	`bŒfs_£t_roÙ_¹¿nsid
(
roÙ_™em
, 
§
->
¹¿nsid
);

5146 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
roÙ_™em
->
¡ime
, 
§
->¡ime.
£c
);

5147 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
roÙ_™em
->
¡ime
, 
§
->¡ime.
n£c
);

5148 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
roÙ_™em
->
¹ime
, 
§
->¹ime.
£c
);

5149 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
roÙ_™em
->
¹ime
, 
§
->¹ime.
n£c
);

5151 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

5152 &
roÙ
->
roÙ_key
, &roÙ->
roÙ_™em
);

5153 ià(
»t
 < 0) {

5154 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

5155 
out
;

5157 ià(
»ûived_uuid_chªged
 && !
	`bŒfs_is_em±y_uuid
(
§
->
uuid
)) {

5158 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
fs_šfo
, 
§
->
uuid
,

5159 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

5160 
roÙ
->
roÙ_key
.
objeùid
);

5161 ià(
»t
 < 0 &&„‘ !ð-
EEXIST
) {

5162 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5163 
out
;

5166 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5167 ià(
»t
 < 0) {

5168 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

5169 
out
;

5172 
out
:

5173 
	`up_wr™e
(&
fs_šfo
->
subvÞ_£m
);

5174 
	`mÁ_drÝ_wr™e_fže
(
fže
);

5175  
»t
;

5176 
	}
}

5178 #ifdeà
CONFIG_64BIT


5179 
	$bŒfs_ioùl_£t_»ûived_subvÞ_32
(
fže
 *file,

5180 
__u£r
 *
¬g
)

5182 
bŒfs_ioùl_»ûived_subvÞ_¬gs_32
 *
¬gs32
 = 
NULL
;

5183 
bŒfs_ioùl_»ûived_subvÞ_¬gs
 *
¬gs64
 = 
NULL
;

5184 
»t
 = 0;

5186 
¬gs32
 = 
	`memdup_u£r
(
¬g
, (*args32));

5187 ià(
	`IS_ERR
(
¬gs32
))

5188  
	`PTR_ERR
(
¬gs32
);

5190 
¬gs64
 = 
	`km®loc
((*¬gs64), 
GFP_KERNEL
);

5191 ià(!
¬gs64
) {

5192 
»t
 = -
ENOMEM
;

5193 
out
;

5196 
	`memýy
(
¬gs64
->
uuid
, 
¬gs32
->uuid, 
BTRFS_UUID_SIZE
);

5197 
¬gs64
->
¡¿nsid
 = 
¬gs32
->stransid;

5198 
¬gs64
->
¹¿nsid
 = 
¬gs32
->rtransid;

5199 
¬gs64
->
¡ime
.
£c
 = 
¬gs32
->stime.sec;

5200 
¬gs64
->
¡ime
.
n£c
 = 
¬gs32
->stime.nsec;

5201 
¬gs64
->
¹ime
.
£c
 = 
¬gs32
->rtime.sec;

5202 
¬gs64
->
¹ime
.
n£c
 = 
¬gs32
->rtime.nsec;

5203 
¬gs64
->
æags
 = 
¬gs32
->flags;

5205 
»t
 = 
	`_bŒfs_ioùl_£t_»ûived_subvÞ
(
fže
, 
¬gs64
);

5206 ià(
»t
)

5207 
out
;

5209 
	`memýy
(
¬gs32
->
uuid
, 
¬gs64
->uuid, 
BTRFS_UUID_SIZE
);

5210 
¬gs32
->
¡¿nsid
 = 
¬gs64
->stransid;

5211 
¬gs32
->
¹¿nsid
 = 
¬gs64
->rtransid;

5212 
¬gs32
->
¡ime
.
£c
 = 
¬gs64
->stime.sec;

5213 
¬gs32
->
¡ime
.
n£c
 = 
¬gs64
->stime.nsec;

5214 
¬gs32
->
¹ime
.
£c
 = 
¬gs64
->rtime.sec;

5215 
¬gs32
->
¹ime
.
n£c
 = 
¬gs64
->rtime.nsec;

5216 
¬gs32
->
æags
 = 
¬gs64
->flags;

5218 
»t
 = 
	`cÝy_to_u£r
(
¬g
, 
¬gs32
, (*args32));

5219 ià(
»t
)

5220 
»t
 = -
EFAULT
;

5222 
out
:

5223 
	`kä“
(
¬gs32
);

5224 
	`kä“
(
¬gs64
);

5225  
»t
;

5226 
	}
}

5229 
	$bŒfs_ioùl_£t_»ûived_subvÞ
(
fže
 *file,

5230 
__u£r
 *
¬g
)

5232 
bŒfs_ioùl_»ûived_subvÞ_¬gs
 *
§
 = 
NULL
;

5233 
»t
 = 0;

5235 
§
 = 
	`memdup_u£r
(
¬g
, (*sa));

5236 ià(
	`IS_ERR
(
§
))

5237  
	`PTR_ERR
(
§
);

5239 
»t
 = 
	`_bŒfs_ioùl_£t_»ûived_subvÞ
(
fže
, 
§
);

5241 ià(
»t
)

5242 
out
;

5244 
»t
 = 
	`cÝy_to_u£r
(
¬g
, 
§
, (*sa));

5245 ià(
»t
)

5246 
»t
 = -
EFAULT
;

5248 
out
:

5249 
	`kä“
(
§
);

5250  
»t
;

5251 
	}
}

5253 
	$bŒfs_ioùl_g‘_f¦ab–
(
fže
 *fže, 
__u£r
 *
¬g
)

5255 
šode
 *šodð
	`fže_šode
(
fže
);

5256 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5257 
size_t
 
Ën
;

5258 
»t
;

5259 
Ïb–
[
BTRFS_LABEL_SIZE
];

5261 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

5262 
	`memýy
(
Ïb–
, 
fs_šfo
->
su³r_cÝy
->Ïb–, 
BTRFS_LABEL_SIZE
);

5263 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

5265 
Ën
 = 
	`¡ºËn
(
Ïb–
, 
BTRFS_LABEL_SIZE
);

5267 ià(
Ën
 =ð
BTRFS_LABEL_SIZE
) {

5268 
	`bŒfs_w¬n
(
fs_šfo
,

5270 --
Ën
);

5273 
»t
 = 
	`cÝy_to_u£r
(
¬g
, 
Ïb–
, 
Ën
);

5275  
»t
 ? -
EFAULT
 : 0;

5276 
	}
}

5278 
	$bŒfs_ioùl_£t_f¦ab–
(
fže
 *fže, 
__u£r
 *
¬g
)

5280 
šode
 *šodð
	`fže_šode
(
fže
);

5281 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5282 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5283 
bŒfs_su³r_block
 *
su³r_block
 = 
fs_šfo
->
su³r_cÝy
;

5284 
bŒfs_Œªs_hªdË
 *
Œªs
;

5285 
Ïb–
[
BTRFS_LABEL_SIZE
];

5286 
»t
;

5288 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

5289  -
EPERM
;

5291 ià(
	`cÝy_äom_u£r
(
Ïb–
, 
¬g
, (label)))

5292  -
EFAULT
;

5294 ià(
	`¡ºËn
(
Ïb–
, 
BTRFS_LABEL_SIZE
) == BTRFS_LABEL_SIZE) {

5295 
	`bŒfs_”r
(
fs_šfo
,

5297 
BTRFS_LABEL_SIZE
 - 1);

5298  -
EINVAL
;

5301 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

5302 ià(
»t
)

5303  
»t
;

5305 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

5306 ià(
	`IS_ERR
(
Œªs
)) {

5307 
»t
 = 
	`PTR_ERR
(
Œªs
);

5308 
out_uÆock
;

5311 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

5312 
	`¡rýy
(
su³r_block
->
Ïb–
,†abel);

5313 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

5314 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5316 
out_uÆock
:

5317 
	`mÁ_drÝ_wr™e_fže
(
fže
);

5318  
»t
;

5319 
	}
}

5321 
	#INIT_FEATURE_FLAGS
(
suffix
) \

5322 { .
com·t_æags
 = 
BTRFS_FEATURE_COMPAT_
##
suffix
, \

5323 .
com·t_ro_æags
 = 
BTRFS_FEATURE_COMPAT_RO_
##
suffix
, \

5324 .
šcom·t_æags
 = 
BTRFS_FEATURE_INCOMPAT_
##
suffix
 }

	)

5326 
	$bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
(
__u£r
 *
¬g
)

5328 cÚ¡ 
bŒfs_ioùl_ã©u»_æags
 
ã©u»s
[3] = {

5329 
	`INIT_FEATURE_FLAGS
(
SUPP
),

5330 
	`INIT_FEATURE_FLAGS
(
SAFE_SET
),

5331 
	`INIT_FEATURE_FLAGS
(
SAFE_CLEAR
)

5334 ià(
	`cÝy_to_u£r
(
¬g
, &
ã©u»s
, (features)))

5335  -
EFAULT
;

5338 
	}
}

5340 
	$bŒfs_ioùl_g‘_ã©u»s
(
fže
 *fže, 
__u£r
 *
¬g
)

5342 
šode
 *šodð
	`fže_šode
(
fže
);

5343 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5344 
bŒfs_su³r_block
 *
su³r_block
 = 
fs_šfo
->
su³r_cÝy
;

5345 
bŒfs_ioùl_ã©u»_æags
 
ã©u»s
;

5347 
ã©u»s
.
com·t_æags
 = 
	`bŒfs_su³r_com·t_æags
(
su³r_block
);

5348 
ã©u»s
.
com·t_ro_æags
 = 
	`bŒfs_su³r_com·t_ro_æags
(
su³r_block
);

5349 
ã©u»s
.
šcom·t_æags
 = 
	`bŒfs_su³r_šcom·t_æags
(
su³r_block
);

5351 ià(
	`cÝy_to_u£r
(
¬g
, &
ã©u»s
, (features)))

5352  -
EFAULT
;

5355 
	}
}

5357 
	$check_ã©u»_b™s
(
bŒfs_fs_šfo
 *
fs_šfo
,

5358 
bŒfs_ã©u»_£t
 
£t
,

5359 
u64
 
chªge_mask
, u64 
æags
, u64 
suµÜ‹d_æags
,

5360 
u64
 
§ã_£t
, u64 
§ã_þ—r
)

5362 cÚ¡ *
ty³
 = 
bŒfs_ã©u»_£t_Çmes
[
£t
];

5363 *
Çmes
;

5364 
u64
 
di§Îowed
, 
unsuµÜ‹d
;

5365 
u64
 
£t_mask
 = 
æags
 & 
chªge_mask
;

5366 
u64
 
þ—r_mask
 = ~
æags
 & 
chªge_mask
;

5368 
unsuµÜ‹d
 = 
£t_mask
 & ~
suµÜ‹d_æags
;

5369 ià(
unsuµÜ‹d
) {

5370 
Çmes
 = 
	`bŒfs_´šbË_ã©u»s
(
£t
, 
unsuµÜ‹d
);

5371 ià(
Çmes
) {

5372 
	`bŒfs_w¬n
(
fs_šfo
,

5374 
Çmes
, 
	`¡rchr
(names, ',') ? "s" : "");

5375 
	`kä“
(
Çmes
);

5377 
	`bŒfs_w¬n
(
fs_šfo
,

5379 
ty³
, 
unsuµÜ‹d
);

5380  -
EOPNOTSUPP
;

5383 
di§Îowed
 = 
£t_mask
 & ~
§ã_£t
;

5384 ià(
di§Îowed
) {

5385 
Çmes
 = 
	`bŒfs_´šbË_ã©u»s
(
£t
, 
di§Îowed
);

5386 ià(
Çmes
) {

5387 
	`bŒfs_w¬n
(
fs_šfo
,

5389 
Çmes
, 
	`¡rchr
(names, ',') ? "s" : "");

5390 
	`kä“
(
Çmes
);

5392 
	`bŒfs_w¬n
(
fs_šfo
,

5394 
ty³
, 
di§Îowed
);

5395  -
EPERM
;

5398 
di§Îowed
 = 
þ—r_mask
 & ~
§ã_þ—r
;

5399 ià(
di§Îowed
) {

5400 
Çmes
 = 
	`bŒfs_´šbË_ã©u»s
(
£t
, 
di§Îowed
);

5401 ià(
Çmes
) {

5402 
	`bŒfs_w¬n
(
fs_šfo
,

5404 
Çmes
, 
	`¡rchr
(names, ',') ? "s" : "");

5405 
	`kä“
(
Çmes
);

5407 
	`bŒfs_w¬n
(
fs_šfo
,

5409 
ty³
, 
di§Îowed
);

5410  -
EPERM
;

5414 
	}
}

5416 
	#check_ã©u»
(
fs_šfo
, 
chªge_mask
, 
æags
, 
mask_ba£
) \

5417 
	`check_ã©u»_b™s
(
fs_šfo
, 
FEAT_
##
mask_ba£
, 
chªge_mask
, 
æags
, \

5418 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SUPP
, \

5419 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SAFE_SET
, \

5420 
BTRFS_FEATURE_
 ## 
mask_ba£
 ## 
_SAFE_CLEAR
)

	)

5422 
	$bŒfs_ioùl_£t_ã©u»s
(
fže
 *fže, 
__u£r
 *
¬g
)

5424 
šode
 *šodð
	`fže_šode
(
fže
);

5425 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5426 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5427 
bŒfs_su³r_block
 *
su³r_block
 = 
fs_šfo
->
su³r_cÝy
;

5428 
bŒfs_ioùl_ã©u»_æags
 
æags
[2];

5429 
bŒfs_Œªs_hªdË
 *
Œªs
;

5430 
u64
 
Ãwæags
;

5431 
»t
;

5433 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

5434  -
EPERM
;

5436 ià(
	`cÝy_äom_u£r
(
æags
, 
¬g
, (flags)))

5437  -
EFAULT
;

5440 ià(!
æags
[0].
com·t_æags
 && !æags[0].
com·t_ro_æags
 &&

5441 !
æags
[0].
šcom·t_æags
)

5444 
»t
 = 
	`check_ã©u»
(
fs_šfo
, 
æags
[0].
com·t_æags
,

5445 
æags
[1].
com·t_æags
, 
COMPAT
);

5446 ià(
»t
)

5447  
»t
;

5449 
»t
 = 
	`check_ã©u»
(
fs_šfo
, 
æags
[0].
com·t_ro_æags
,

5450 
æags
[1].
com·t_ro_æags
, 
COMPAT_RO
);

5451 ià(
»t
)

5452  
»t
;

5454 
»t
 = 
	`check_ã©u»
(
fs_šfo
, 
æags
[0].
šcom·t_æags
,

5455 
æags
[1].
šcom·t_æags
, 
INCOMPAT
);

5456 ià(
»t
)

5457  
»t
;

5459 
»t
 = 
	`mÁ_wªt_wr™e_fže
(
fže
);

5460 ià(
»t
)

5461  
»t
;

5463 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

5464 ià(
	`IS_ERR
(
Œªs
)) {

5465 
»t
 = 
	`PTR_ERR
(
Œªs
);

5466 
out_drÝ_wr™e
;

5469 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

5470 
Ãwæags
 = 
	`bŒfs_su³r_com·t_æags
(
su³r_block
);

5471 
Ãwæags
 |ð
æags
[0].
com·t_æags
 & flags[1].compat_flags;

5472 
Ãwæags
 &ð~(
æags
[0].
com·t_æags
 & ~flags[1].compat_flags);

5473 
	`bŒfs_£t_su³r_com·t_æags
(
su³r_block
, 
Ãwæags
);

5475 
Ãwæags
 = 
	`bŒfs_su³r_com·t_ro_æags
(
su³r_block
);

5476 
Ãwæags
 |ð
æags
[0].
com·t_ro_æags
 & flags[1].compat_ro_flags;

5477 
Ãwæags
 &ð~(
æags
[0].
com·t_ro_æags
 & ~flags[1].compat_ro_flags);

5478 
	`bŒfs_£t_su³r_com·t_ro_æags
(
su³r_block
, 
Ãwæags
);

5480 
Ãwæags
 = 
	`bŒfs_su³r_šcom·t_æags
(
su³r_block
);

5481 
Ãwæags
 |ð
æags
[0].
šcom·t_æags
 & flags[1].incompat_flags;

5482 
Ãwæags
 &ð~(
æags
[0].
šcom·t_æags
 & ~flags[1].incompat_flags);

5483 
	`bŒfs_£t_su³r_šcom·t_æags
(
su³r_block
, 
Ãwæags
);

5484 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

5486 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5487 
out_drÝ_wr™e
:

5488 
	`mÁ_drÝ_wr™e_fže
(
fže
);

5490  
»t
;

5491 
	}
}

5493 
	$bŒfs_ioùl
(
fže
 *file, 

5494 
cmd
, 
¬g
)

5496 
šode
 *šodð
	`fže_šode
(
fže
);

5497 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

5498 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

5499 
__u£r
 *
¬gp
 = (__u£¸*)
¬g
;

5501 
cmd
) {

5502 
FS_IOC_GETFLAGS
:

5503  
	`bŒfs_ioùl_g‘æags
(
fže
, 
¬gp
);

5504 
FS_IOC_SETFLAGS
:

5505  
	`bŒfs_ioùl_£tæags
(
fže
, 
¬gp
);

5506 
FS_IOC_GETVERSION
:

5507  
	`bŒfs_ioùl_g‘v”siÚ
(
fže
, 
¬gp
);

5508 
FITRIM
:

5509  
	`bŒfs_ioùl_f™rim
(
fže
, 
¬gp
);

5510 
BTRFS_IOC_SNAP_CREATE
:

5511  
	`bŒfs_ioùl_¢­_ü—‹
(
fže
, 
¬gp
, 0);

5512 
BTRFS_IOC_SNAP_CREATE_V2
:

5513  
	`bŒfs_ioùl_¢­_ü—‹_v2
(
fže
, 
¬gp
, 0);

5514 
BTRFS_IOC_SUBVOL_CREATE
:

5515  
	`bŒfs_ioùl_¢­_ü—‹
(
fže
, 
¬gp
, 1);

5516 
BTRFS_IOC_SUBVOL_CREATE_V2
:

5517  
	`bŒfs_ioùl_¢­_ü—‹_v2
(
fže
, 
¬gp
, 1);

5518 
BTRFS_IOC_SNAP_DESTROY
:

5519  
	`bŒfs_ioùl_¢­_de¡roy
(
fže
, 
¬gp
);

5520 
BTRFS_IOC_SUBVOL_GETFLAGS
:

5521  
	`bŒfs_ioùl_subvÞ_g‘æags
(
fže
, 
¬gp
);

5522 
BTRFS_IOC_SUBVOL_SETFLAGS
:

5523  
	`bŒfs_ioùl_subvÞ_£tæags
(
fže
, 
¬gp
);

5524 
BTRFS_IOC_DEFAULT_SUBVOL
:

5525  
	`bŒfs_ioùl_deçuÉ_subvÞ
(
fže
, 
¬gp
);

5526 
BTRFS_IOC_DEFRAG
:

5527  
	`bŒfs_ioùl_deäag
(
fže
, 
NULL
);

5528 
BTRFS_IOC_DEFRAG_RANGE
:

5529  
	`bŒfs_ioùl_deäag
(
fže
, 
¬gp
);

5530 
BTRFS_IOC_RESIZE
:

5531  
	`bŒfs_ioùl_»size
(
fže
, 
¬gp
);

5532 
BTRFS_IOC_ADD_DEV
:

5533  
	`bŒfs_ioùl_add_dev
(
fs_šfo
, 
¬gp
);

5534 
BTRFS_IOC_RM_DEV
:

5535  
	`bŒfs_ioùl_rm_dev
(
fže
, 
¬gp
);

5536 
BTRFS_IOC_RM_DEV_V2
:

5537  
	`bŒfs_ioùl_rm_dev_v2
(
fže
, 
¬gp
);

5538 
BTRFS_IOC_FS_INFO
:

5539  
	`bŒfs_ioùl_fs_šfo
(
fs_šfo
, 
¬gp
);

5540 
BTRFS_IOC_DEV_INFO
:

5541  
	`bŒfs_ioùl_dev_šfo
(
fs_šfo
, 
¬gp
);

5542 
BTRFS_IOC_BALANCE
:

5543  
	`bŒfs_ioùl_b®ªû
(
fže
, 
NULL
);

5544 
BTRFS_IOC_TRANS_START
:

5545  
	`bŒfs_ioùl_Œªs_¡¬t
(
fže
);

5546 
BTRFS_IOC_TRANS_END
:

5547  
	`bŒfs_ioùl_Œªs_’d
(
fže
);

5548 
BTRFS_IOC_TREE_SEARCH
:

5549  
	`bŒfs_ioùl_Œ“_£¬ch
(
fže
, 
¬gp
);

5550 
BTRFS_IOC_TREE_SEARCH_V2
:

5551  
	`bŒfs_ioùl_Œ“_£¬ch_v2
(
fže
, 
¬gp
);

5552 
BTRFS_IOC_INO_LOOKUP
:

5553  
	`bŒfs_ioùl_šo_lookup
(
fže
, 
¬gp
);

5554 
BTRFS_IOC_INO_PATHS
:

5555  
	`bŒfs_ioùl_šo_to_·th
(
roÙ
, 
¬gp
);

5556 
BTRFS_IOC_LOGICAL_INO
:

5557  
	`bŒfs_ioùl_logiÿl_to_šo
(
fs_šfo
, 
¬gp
);

5558 
BTRFS_IOC_SPACE_INFO
:

5559  
	`bŒfs_ioùl_¥aû_šfo
(
fs_šfo
, 
¬gp
);

5560 
BTRFS_IOC_SYNC
: {

5561 
»t
;

5563 
»t
 = 
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 0, -1);

5564 ià(
»t
)

5565  
»t
;

5566 
»t
 = 
	`bŒfs_sync_fs
(
šode
->
i_sb
, 1);

5572 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

5573  
»t
;

5575 
BTRFS_IOC_START_SYNC
:

5576  
	`bŒfs_ioùl_¡¬t_sync
(
roÙ
, 
¬gp
);

5577 
BTRFS_IOC_WAIT_SYNC
:

5578  
	`bŒfs_ioùl_wa™_sync
(
fs_šfo
, 
¬gp
);

5579 
BTRFS_IOC_SCRUB
:

5580  
	`bŒfs_ioùl_süub
(
fže
, 
¬gp
);

5581 
BTRFS_IOC_SCRUB_CANCEL
:

5582  
	`bŒfs_ioùl_süub_ÿnûl
(
fs_šfo
);

5583 
BTRFS_IOC_SCRUB_PROGRESS
:

5584  
	`bŒfs_ioùl_süub_´og»ss
(
fs_šfo
, 
¬gp
);

5585 
BTRFS_IOC_BALANCE_V2
:

5586  
	`bŒfs_ioùl_b®ªû
(
fže
, 
¬gp
);

5587 
BTRFS_IOC_BALANCE_CTL
:

5588  
	`bŒfs_ioùl_b®ªû_ùl
(
fs_šfo
, 
¬g
);

5589 
BTRFS_IOC_BALANCE_PROGRESS
:

5590  
	`bŒfs_ioùl_b®ªû_´og»ss
(
fs_šfo
, 
¬gp
);

5591 
BTRFS_IOC_SET_RECEIVED_SUBVOL
:

5592  
	`bŒfs_ioùl_£t_»ûived_subvÞ
(
fže
, 
¬gp
);

5593 #ifdeà
CONFIG_64BIT


5594 
BTRFS_IOC_SET_RECEIVED_SUBVOL_32
:

5595  
	`bŒfs_ioùl_£t_»ûived_subvÞ_32
(
fže
, 
¬gp
);

5597 
BTRFS_IOC_SEND
:

5598  
	`bŒfs_ioùl_£nd
(
fže
, 
¬gp
);

5599 
BTRFS_IOC_GET_DEV_STATS
:

5600  
	`bŒfs_ioùl_g‘_dev_¡©s
(
fs_šfo
, 
¬gp
);

5601 
BTRFS_IOC_QUOTA_CTL
:

5602  
	`bŒfs_ioùl_quÙa_ùl
(
fže
, 
¬gp
);

5603 
BTRFS_IOC_QGROUP_ASSIGN
:

5604  
	`bŒfs_ioùl_qgroup_assign
(
fže
, 
¬gp
);

5605 
BTRFS_IOC_QGROUP_CREATE
:

5606  
	`bŒfs_ioùl_qgroup_ü—‹
(
fže
, 
¬gp
);

5607 
BTRFS_IOC_QGROUP_LIMIT
:

5608  
	`bŒfs_ioùl_qgroup_lim™
(
fže
, 
¬gp
);

5609 
BTRFS_IOC_QUOTA_RESCAN
:

5610  
	`bŒfs_ioùl_quÙa_»sÿn
(
fže
, 
¬gp
);

5611 
BTRFS_IOC_QUOTA_RESCAN_STATUS
:

5612  
	`bŒfs_ioùl_quÙa_»sÿn_¡©us
(
fže
, 
¬gp
);

5613 
BTRFS_IOC_QUOTA_RESCAN_WAIT
:

5614  
	`bŒfs_ioùl_quÙa_»sÿn_wa™
(
fže
, 
¬gp
);

5615 
BTRFS_IOC_DEV_REPLACE
:

5616  
	`bŒfs_ioùl_dev_»¶aû
(
fs_šfo
, 
¬gp
);

5617 
BTRFS_IOC_GET_FSLABEL
:

5618  
	`bŒfs_ioùl_g‘_f¦ab–
(
fže
, 
¬gp
);

5619 
BTRFS_IOC_SET_FSLABEL
:

5620  
	`bŒfs_ioùl_£t_f¦ab–
(
fže
, 
¬gp
);

5621 
BTRFS_IOC_GET_SUPPORTED_FEATURES
:

5622  
	`bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
(
¬gp
);

5623 
BTRFS_IOC_GET_FEATURES
:

5624  
	`bŒfs_ioùl_g‘_ã©u»s
(
fže
, 
¬gp
);

5625 
BTRFS_IOC_SET_FEATURES
:

5626  
	`bŒfs_ioùl_£t_ã©u»s
(
fže
, 
¬gp
);

5629  -
ENOTTY
;

5630 
	}
}

5632 #ifdeà
CONFIG_COMPAT


5633 
	$bŒfs_com·t_ioùl
(
fže
 *fže, 
cmd
, 
¬g
)

5639 
cmd
) {

5640 
FS_IOC32_GETFLAGS
:

5641 
cmd
 = 
FS_IOC_GETFLAGS
;

5643 
FS_IOC32_SETFLAGS
:

5644 
cmd
 = 
FS_IOC_SETFLAGS
;

5646 
FS_IOC32_GETVERSION
:

5647 
cmd
 = 
FS_IOC_GETVERSION
;

5651  
	`bŒfs_ioùl
(
fže
, 
cmd
, (è
	`com·t_±r
(
¬g
));

5652 
	}
}

	@locking.c

18 
	~<lšux/sched.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/¥šlock.h
>

21 
	~<lšux/·ge-æags.h
>

22 
	~<asm/bug.h
>

23 
	~"ù»e.h
"

24 
	~"ex‹Á_io.h
"

25 
	~"lockšg.h
"

27 
bŒfs_as£¹_Œ“_»ad_locked
(
ex‹Á_bufãr
 *
eb
);

34 
	$bŒfs_£t_lock_blockšg_rw
(
ex‹Á_bufãr
 *
eb
, 
rw
)

42 ià(
eb
->
lock_Ã¡ed
 && 
cu¼’t
->
pid
 =ðeb->
lock_owÃr
)

44 ià(
rw
 =ð
BTRFS_WRITE_LOCK
) {

45 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) == 0) {

46 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_wr™”s
) != 1);

47 
	`©omic_dec
(&
eb
->
¥šnšg_wr™”s
);

48 
	`bŒfs_as£¹_Œ“_locked
(
eb
);

49 
	`©omic_šc
(&
eb
->
blockšg_wr™”s
);

50 
	`wr™e_uÆock
(&
eb
->
lock
);

52 } ià(
rw
 =ð
BTRFS_READ_LOCK
) {

53 
	`bŒfs_as£¹_Œ“_»ad_locked
(
eb
);

54 
	`©omic_šc
(&
eb
->
blockšg_»ad”s
);

55 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_»ad”s
) == 0);

56 
	`©omic_dec
(&
eb
->
¥šnšg_»ad”s
);

57 
	`»ad_uÆock
(&
eb
->
lock
);

59 
	}
}

65 
	$bŒfs_þ—r_lock_blockšg_rw
(
ex‹Á_bufãr
 *
eb
, 
rw
)

73 ià(
eb
->
lock_Ã¡ed
 && 
cu¼’t
->
pid
 =ðeb->
lock_owÃr
)

76 ià(
rw
 =ð
BTRFS_WRITE_LOCK_BLOCKING
) {

77 
	`BUG_ON
(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) != 1);

78 
	`wr™e_lock
(&
eb
->
lock
);

79 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_wr™”s
));

80 
	`©omic_šc
(&
eb
->
¥šnšg_wr™”s
);

84 ià(
	`©omic_dec_ªd_‹¡
(&
eb
->
blockšg_wr™”s
) &&

85 
	`wa™queue_aùive
(&
eb
->
wr™e_lock_wq
))

86 
	`wake_up
(&
eb
->
wr™e_lock_wq
);

87 } ià(
rw
 =ð
BTRFS_READ_LOCK_BLOCKING
) {

88 
	`BUG_ON
(
	`©omic_»ad
(&
eb
->
blockšg_»ad”s
) == 0);

89 
	`»ad_lock
(&
eb
->
lock
);

90 
	`©omic_šc
(&
eb
->
¥šnšg_»ad”s
);

94 ià(
	`©omic_dec_ªd_‹¡
(&
eb
->
blockšg_»ad”s
) &&

95 
	`wa™queue_aùive
(&
eb
->
»ad_lock_wq
))

96 
	`wake_up
(&
eb
->
»ad_lock_wq
);

98 
	}
}

104 
	$bŒfs_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
)

106 
agaš
:

107 
	`BUG_ON
(!
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) &&

108 
cu¼’t
->
pid
 =ð
eb
->
lock_owÃr
);

110 
	`»ad_lock
(&
eb
->
lock
);

111 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) &&

112 
cu¼’t
->
pid
 =ð
eb
->
lock_owÃr
) {

119 
	`BUG_ON
(
eb
->
lock_Ã¡ed
);

120 
eb
->
lock_Ã¡ed
 = 1;

121 
	`»ad_uÆock
(&
eb
->
lock
);

124 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
)) {

125 
	`»ad_uÆock
(&
eb
->
lock
);

126 
	`wa™_ev’t
(
eb
->
wr™e_lock_wq
,

127 
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) == 0);

128 
agaš
;

130 
	`©omic_šc
(&
eb
->
»ad_locks
);

131 
	`©omic_šc
(&
eb
->
¥šnšg_»ad”s
);

132 
	}
}

139 
	$bŒfs_Œ“_»ad_lock_©omic
(
ex‹Á_bufãr
 *
eb
)

141 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
))

144 
	`»ad_lock
(&
eb
->
lock
);

145 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
)) {

146 
	`»ad_uÆock
(&
eb
->
lock
);

149 
	`©omic_šc
(&
eb
->
»ad_locks
);

150 
	`©omic_šc
(&
eb
->
¥šnšg_»ad”s
);

152 
	}
}

158 
	$bŒfs_Œy_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
)

160 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
))

163 ià(!
	`»ad_Œylock
(&
eb
->
lock
))

166 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
)) {

167 
	`»ad_uÆock
(&
eb
->
lock
);

170 
	`©omic_šc
(&
eb
->
»ad_locks
);

171 
	`©omic_šc
(&
eb
->
¥šnšg_»ad”s
);

173 
	}
}

179 
	$bŒfs_Œy_Œ“_wr™e_lock
(
ex‹Á_bufãr
 *
eb
)

181 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) ||

182 
	`©omic_»ad
(&
eb
->
blockšg_»ad”s
))

185 
	`wr™e_lock
(&
eb
->
lock
);

186 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) ||

187 
	`©omic_»ad
(&
eb
->
blockšg_»ad”s
)) {

188 
	`wr™e_uÆock
(&
eb
->
lock
);

191 
	`©omic_šc
(&
eb
->
wr™e_locks
);

192 
	`©omic_šc
(&
eb
->
¥šnšg_wr™”s
);

193 
eb
->
lock_owÃr
 = 
cu¼’t
->
pid
;

195 
	}
}

200 
	$bŒfs_Œ“_»ad_uÆock
(
ex‹Á_bufãr
 *
eb
)

208 ià(
eb
->
lock_Ã¡ed
 && 
cu¼’t
->
pid
 =ðeb->
lock_owÃr
) {

209 
eb
->
lock_Ã¡ed
 = 0;

212 
	`bŒfs_as£¹_Œ“_»ad_locked
(
eb
);

213 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_»ad”s
) == 0);

214 
	`©omic_dec
(&
eb
->
¥šnšg_»ad”s
);

215 
	`©omic_dec
(&
eb
->
»ad_locks
);

216 
	`»ad_uÆock
(&
eb
->
lock
);

217 
	}
}

222 
	$bŒfs_Œ“_»ad_uÆock_blockšg
(
ex‹Á_bufãr
 *
eb
)

230 ià(
eb
->
lock_Ã¡ed
 && 
cu¼’t
->
pid
 =ðeb->
lock_owÃr
) {

231 
eb
->
lock_Ã¡ed
 = 0;

234 
	`bŒfs_as£¹_Œ“_»ad_locked
(
eb
);

235 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
blockšg_»ad”s
) == 0);

239 ià(
	`©omic_dec_ªd_‹¡
(&
eb
->
blockšg_»ad”s
) &&

240 
	`wa™queue_aùive
(&
eb
->
»ad_lock_wq
))

241 
	`wake_up
(&
eb
->
»ad_lock_wq
);

242 
	`©omic_dec
(&
eb
->
»ad_locks
);

243 
	}
}

249 
	$bŒfs_Œ“_lock
(
ex‹Á_bufãr
 *
eb
)

251 
	`WARN_ON
(
eb
->
lock_owÃr
 =ð
cu¼’t
->
pid
);

252 
agaš
:

253 
	`wa™_ev’t
(
eb
->
»ad_lock_wq
, 
	`©omic_»ad
(&eb->
blockšg_»ad”s
) == 0);

254 
	`wa™_ev’t
(
eb
->
wr™e_lock_wq
, 
	`©omic_»ad
(&eb->
blockšg_wr™”s
) == 0);

255 
	`wr™e_lock
(&
eb
->
lock
);

256 ià(
	`©omic_»ad
(&
eb
->
blockšg_»ad”s
)) {

257 
	`wr™e_uÆock
(&
eb
->
lock
);

258 
	`wa™_ev’t
(
eb
->
»ad_lock_wq
,

259 
	`©omic_»ad
(&
eb
->
blockšg_»ad”s
) == 0);

260 
agaš
;

262 ià(
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
)) {

263 
	`wr™e_uÆock
(&
eb
->
lock
);

264 
	`wa™_ev’t
(
eb
->
wr™e_lock_wq
,

265 
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
) == 0);

266 
agaš
;

268 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_wr™”s
));

269 
	`©omic_šc
(&
eb
->
¥šnšg_wr™”s
);

270 
	`©omic_šc
(&
eb
->
wr™e_locks
);

271 
eb
->
lock_owÃr
 = 
cu¼’t
->
pid
;

272 
	}
}

277 
	$bŒfs_Œ“_uÆock
(
ex‹Á_bufãr
 *
eb
)

279 
block”s
 = 
	`©omic_»ad
(&
eb
->
blockšg_wr™”s
);

281 
	`BUG_ON
(
block”s
 > 1);

283 
	`bŒfs_as£¹_Œ“_locked
(
eb
);

284 
eb
->
lock_owÃr
 = 0;

285 
	`©omic_dec
(&
eb
->
wr™e_locks
);

287 ià(
block”s
) {

288 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_wr™”s
));

289 
	`©omic_dec
(&
eb
->
blockšg_wr™”s
);

293 
	`smp_mb
();

294 ià(
	`wa™queue_aùive
(&
eb
->
wr™e_lock_wq
))

295 
	`wake_up
(&
eb
->
wr™e_lock_wq
);

297 
	`WARN_ON
(
	`©omic_»ad
(&
eb
->
¥šnšg_wr™”s
) != 1);

298 
	`©omic_dec
(&
eb
->
¥šnšg_wr™”s
);

299 
	`wr™e_uÆock
(&
eb
->
lock
);

301 
	}
}

303 
	$bŒfs_as£¹_Œ“_locked
(
ex‹Á_bufãr
 *
eb
)

305 
	`BUG_ON
(!
	`©omic_»ad
(&
eb
->
wr™e_locks
));

306 
	}
}

308 
	$bŒfs_as£¹_Œ“_»ad_locked
(
ex‹Á_bufãr
 *
eb
)

310 
	`BUG_ON
(!
	`©omic_»ad
(&
eb
->
»ad_locks
));

311 
	}
}

	@locking.h

19 #iâdeà
__BTRFS_LOCKING_


20 
	#__BTRFS_LOCKING_


	)

22 
	#BTRFS_WRITE_LOCK
 1

	)

23 
	#BTRFS_READ_LOCK
 2

	)

24 
	#BTRFS_WRITE_LOCK_BLOCKING
 3

	)

25 
	#BTRFS_READ_LOCK_BLOCKING
 4

	)

27 
bŒfs_Œ“_lock
(
ex‹Á_bufãr
 *
eb
);

28 
bŒfs_Œ“_uÆock
(
ex‹Á_bufãr
 *
eb
);

30 
bŒfs_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
);

31 
bŒfs_Œ“_»ad_uÆock
(
ex‹Á_bufãr
 *
eb
);

32 
bŒfs_Œ“_»ad_uÆock_blockšg
(
ex‹Á_bufãr
 *
eb
);

33 
bŒfs_£t_lock_blockšg_rw
(
ex‹Á_bufãr
 *
eb
, 
rw
);

34 
bŒfs_þ—r_lock_blockšg_rw
(
ex‹Á_bufãr
 *
eb
, 
rw
);

35 
bŒfs_as£¹_Œ“_locked
(
ex‹Á_bufãr
 *
eb
);

36 
bŒfs_Œy_Œ“_»ad_lock
(
ex‹Á_bufãr
 *
eb
);

37 
bŒfs_Œy_Œ“_wr™e_lock
(
ex‹Á_bufãr
 *
eb
);

38 
bŒfs_Œ“_»ad_lock_©omic
(
ex‹Á_bufãr
 *
eb
);

41 
šlše
 
	$bŒfs_Œ“_uÆock_rw
(
ex‹Á_bufãr
 *
eb
, 
rw
)

43 ià(
rw
 =ð
BTRFS_WRITE_LOCK
 ||„w =ð
BTRFS_WRITE_LOCK_BLOCKING
)

44 
	`bŒfs_Œ“_uÆock
(
eb
);

45 ià(
rw
 =ð
BTRFS_READ_LOCK_BLOCKING
)

46 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
eb
);

47 ià(
rw
 =ð
BTRFS_READ_LOCK
)

48 
	`bŒfs_Œ“_»ad_uÆock
(
eb
);

50 
	`BUG
();

51 
	}
}

53 
šlše
 
	$bŒfs_£t_lock_blockšg
(
ex‹Á_bufãr
 *
eb
)

55 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_WRITE_LOCK
);

56 
	}
}

58 
šlše
 
	$bŒfs_þ—r_lock_blockšg
(
ex‹Á_bufãr
 *
eb
)

60 
	`bŒfs_þ—r_lock_blockšg_rw
(
eb
, 
BTRFS_WRITE_LOCK_BLOCKING
);

61 
	}
}

	@lzo.c

19 
	~<lšux/k”Ãl.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/mm.h
>

22 
	~<lšux/š™.h
>

23 
	~<lšux/”r.h
>

24 
	~<lšux/sched.h
>

25 
	~<lšux/·gem­.h
>

26 
	~<lšux/bio.h
>

27 
	~<lšux/lzo.h
>

28 
	~<lšux/»fcouÁ.h
>

29 
	~"com´essiÚ.h
"

31 
	#LZO_LEN
 4

	)

33 
	swÜk¥aû
 {

34 *
	mmem
;

35 *
	mbuf
;

36 *
	mcbuf
;

37 
li¡_h—d
 
	mli¡
;

40 
	$lzo_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
)

42 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

44 
	`kvä“
(
wÜk¥aû
->
buf
);

45 
	`kvä“
(
wÜk¥aû
->
cbuf
);

46 
	`kvä“
(
wÜk¥aû
->
mem
);

47 
	`kä“
(
wÜk¥aû
);

48 
	}
}

50 
li¡_h—d
 *
	$lzo_®loc_wÜk¥aû
()

52 
wÜk¥aû
 *workspace;

54 
wÜk¥aû
 = 
	`kz®loc
((*wÜk¥aû), 
GFP_KERNEL
);

55 ià(!
wÜk¥aû
)

56  
	`ERR_PTR
(-
ENOMEM
);

58 
wÜk¥aû
->
mem
 = 
	`kvm®loc
(
LZO1X_MEM_COMPRESS
, 
GFP_KERNEL
);

59 
wÜk¥aû
->
buf
 = 
	`kvm®loc
(
	`lzo1x_wÜ¡_com´ess
(
PAGE_SIZE
), 
GFP_KERNEL
);

60 
wÜk¥aû
->
cbuf
 = 
	`kvm®loc
(
	`lzo1x_wÜ¡_com´ess
(
PAGE_SIZE
), 
GFP_KERNEL
);

61 ià(!
wÜk¥aû
->
mem
 || !wÜk¥aû->
buf
 || !wÜk¥aû->
cbuf
)

62 
çž
;

64 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
li¡
);

66  &
wÜk¥aû
->
li¡
;

67 
çž
:

68 
	`lzo_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

69  
	`ERR_PTR
(-
ENOMEM
);

70 
	}
}

72 
šlše
 
	$wr™e_com´ess_Ëngth
(*
buf
, 
size_t
 
Ën
)

74 
__Ë32
 
dËn
;

76 
dËn
 = 
	`ýu_to_Ë32
(
Ën
);

77 
	`memýy
(
buf
, &
dËn
, 
LZO_LEN
);

78 
	}
}

80 
šlše
 
size_t
 
	$»ad_com´ess_Ëngth
(cÚ¡ *
buf
)

82 
__Ë32
 
dËn
;

84 
	`memýy
(&
dËn
, 
buf
, 
LZO_LEN
);

85  
	`Ë32_to_ýu
(
dËn
);

86 
	}
}

88 
	$lzo_com´ess_·ges
(
li¡_h—d
 *
ws
,

89 
add»ss_¥aû
 *
m­pšg
,

90 
u64
 
¡¬t
,

91 
·ge
 **
·ges
,

92 *
out_·ges
,

93 *
tÙ®_š
,

94 *
tÙ®_out
)

96 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

97 
»t
 = 0;

98 *
d©a_š
;

99 *
ýage_out
;

100 
Ä_·ges
 = 0;

101 
·ge
 *
š_·ge
 = 
NULL
;

102 
·ge
 *
out_·ge
 = 
NULL
;

103 
by‹s_Ëá
;

104 
Ën
 = *
tÙ®_out
;

105 
Ä_de¡_·ges
 = *
out_·ges
;

106 cÚ¡ 
max_out
 = 
Ä_de¡_·ges
 * 
PAGE_SIZE
;

107 
size_t
 
š_Ën
;

108 
size_t
 
out_Ën
;

109 *
buf
;

110 
tÙ_š
 = 0;

111 
tÙ_out
 = 0;

112 
pg_by‹s_Ëá
;

113 
out_off£t
;

114 
by‹s
;

116 *
out_·ges
 = 0;

117 *
tÙ®_out
 = 0;

118 *
tÙ®_š
 = 0;

120 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

121 
d©a_š
 = 
	`km­
(
š_·ge
);

127 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

128 ià(
out_·ge
 =ð
NULL
) {

129 
»t
 = -
ENOMEM
;

130 
out
;

132 
ýage_out
 = 
	`km­
(
out_·ge
);

133 
out_off£t
 = 
LZO_LEN
;

134 
tÙ_out
 = 
LZO_LEN
;

135 
·ges
[0] = 
out_·ge
;

136 
Ä_·ges
 = 1;

137 
pg_by‹s_Ëá
 = 
PAGE_SIZE
 - 
LZO_LEN
;

140 
š_Ën
 = 
	`mš
(
Ën
, 
PAGE_SIZE
);

141 
tÙ_š
 < 
Ën
) {

142 
»t
 = 
	`lzo1x_1_com´ess
(
d©a_š
, 
š_Ën
, 
wÜk¥aû
->
cbuf
,

143 &
out_Ën
, 
wÜk¥aû
->
mem
);

144 ià(
»t
 !ð
LZO_E_OK
) {

145 
	`´_debug
("BTRFS:†zo in†oop„eturned %d\n",

146 
»t
);

147 
»t
 = -
EIO
;

148 
out
;

152 
	`wr™e_com´ess_Ëngth
(
ýage_out
 + 
out_off£t
, 
out_Ën
);

153 
tÙ_out
 +ð
LZO_LEN
;

154 
out_off£t
 +ð
LZO_LEN
;

155 
pg_by‹s_Ëá
 -ð
LZO_LEN
;

157 
tÙ_š
 +ð
š_Ën
;

158 
tÙ_out
 +ð
out_Ën
;

161 
buf
 = 
wÜk¥aû
->
cbuf
;

162 
out_Ën
) {

163 
by‹s
 = 
	`mš_t
(, 
pg_by‹s_Ëá
, 
out_Ën
);

165 
	`memýy
(
ýage_out
 + 
out_off£t
, 
buf
, 
by‹s
);

167 
out_Ën
 -ð
by‹s
;

168 
pg_by‹s_Ëá
 -ð
by‹s
;

169 
buf
 +ð
by‹s
;

170 
out_off£t
 +ð
by‹s
;

178 ià((
out_Ën
 =ð0 && 
pg_by‹s_Ëá
 < 
LZO_LEN
) ||

179 
pg_by‹s_Ëá
 == 0) {

180 ià(
pg_by‹s_Ëá
) {

181 
	`mem£t
(
ýage_out
 + 
out_off£t
, 0,

182 
pg_by‹s_Ëá
);

183 
tÙ_out
 +ð
pg_by‹s_Ëá
;

187 ià(
out_Ën
 =ð0 && 
tÙ_š
 >ð
Ën
)

190 
	`kunm­
(
out_·ge
);

191 ià(
Ä_·ges
 =ð
Ä_de¡_·ges
) {

192 
out_·ge
 = 
NULL
;

193 
»t
 = -
E2BIG
;

194 
out
;

197 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

198 ià(
out_·ge
 =ð
NULL
) {

199 
»t
 = -
ENOMEM
;

200 
out
;

202 
ýage_out
 = 
	`km­
(
out_·ge
);

203 
·ges
[
Ä_·ges
++] = 
out_·ge
;

205 
pg_by‹s_Ëá
 = 
PAGE_SIZE
;

206 
out_off£t
 = 0;

211 ià(
tÙ_š
 > 8192 &&Ù_š < 
tÙ_out
) {

212 
»t
 = -
E2BIG
;

213 
out
;

217 ià(
tÙ_š
 >ð
Ën
)

220 ià(
tÙ_out
 > 
max_out
)

223 
by‹s_Ëá
 = 
Ën
 - 
tÙ_š
;

224 
	`kunm­
(
š_·ge
);

225 
	`put_·ge
(
š_·ge
);

227 
¡¬t
 +ð
PAGE_SIZE
;

228 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

229 
d©a_š
 = 
	`km­
(
š_·ge
);

230 
š_Ën
 = 
	`mš
(
by‹s_Ëá
, 
PAGE_SIZE
);

233 ià(
tÙ_out
 >ð
tÙ_š
) {

234 
»t
 = -
E2BIG
;

235 
out
;

239 
ýage_out
 = 
	`km­
(
·ges
[0]);

240 
	`wr™e_com´ess_Ëngth
(
ýage_out
, 
tÙ_out
);

242 
	`kunm­
(
·ges
[0]);

244 
»t
 = 0;

245 *
tÙ®_out
 = 
tÙ_out
;

246 *
tÙ®_š
 = 
tÙ_š
;

247 
out
:

248 *
out_·ges
 = 
Ä_·ges
;

249 ià(
out_·ge
)

250 
	`kunm­
(
out_·ge
);

252 ià(
š_·ge
) {

253 
	`kunm­
(
š_·ge
);

254 
	`put_·ge
(
š_·ge
);

257  
»t
;

258 
	}
}

260 
	$lzo_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
)

262 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

263 
»t
 = 0, 
»t2
;

264 *
d©a_š
;

265 
·ge_š_šdex
 = 0;

266 
size_t
 
¤þ’
 = 
cb
->
com´es£d_Ën
;

267 
tÙ®_·ges_š
 = 
	`DIV_ROUND_UP
(
¤þ’
, 
PAGE_SIZE
);

268 
buf_¡¬t
;

269 
buf_off£t
 = 0;

270 
by‹s
;

271 
wÜkšg_by‹s
;

272 
size_t
 
š_Ën
;

273 
size_t
 
out_Ën
;

274 
š_off£t
;

275 
š_·ge_by‹s_Ëá
;

276 
tÙ_š
;

277 
tÙ_out
;

278 
tÙ_Ën
;

279 *
buf
;

280 
boÞ
 
may_Ï‹_unm­
, 
Ãed_unm­
;

281 
·ge
 **
·ges_š
 = 
cb
->
com´es£d_·ges
;

282 
u64
 
disk_¡¬t
 = 
cb
->
¡¬t
;

283 
bio
 *
Üig_bio
 = 
cb
->orig_bio;

285 
d©a_š
 = 
	`km­
(
·ges_š
[0]);

286 
tÙ_Ën
 = 
	`»ad_com´ess_Ëngth
(
d©a_š
);

288 
tÙ_š
 = 
LZO_LEN
;

289 
š_off£t
 = 
LZO_LEN
;

290 
tÙ_Ën
 = 
	`mš_t
(
size_t
, 
¤þ’
,ot_len);

291 
š_·ge_by‹s_Ëá
 = 
PAGE_SIZE
 - 
LZO_LEN
;

293 
tÙ_out
 = 0;

295 
tÙ_š
 < 
tÙ_Ën
) {

296 
š_Ën
 = 
	`»ad_com´ess_Ëngth
(
d©a_š
 + 
š_off£t
);

297 
š_·ge_by‹s_Ëá
 -ð
LZO_LEN
;

298 
š_off£t
 +ð
LZO_LEN
;

299 
tÙ_š
 +ð
LZO_LEN
;

301 
tÙ_š
 +ð
š_Ën
;

302 
wÜkšg_by‹s
 = 
š_Ën
;

303 
may_Ï‹_unm­
 = 
Ãed_unm­
 = 
çl£
;

306 ià(
š_·ge_by‹s_Ëá
 >ð
š_Ën
) {

307 
buf
 = 
d©a_š
 + 
š_off£t
;

308 
by‹s
 = 
š_Ën
;

309 
may_Ï‹_unm­
 = 
Œue
;

310 
cÚt
;

314 
buf
 = 
wÜk¥aû
->
cbuf
;

315 
buf_off£t
 = 0;

316 
wÜkšg_by‹s
) {

317 
by‹s
 = 
	`mš
(
wÜkšg_by‹s
, 
š_·ge_by‹s_Ëá
);

319 
	`memýy
(
buf
 + 
buf_off£t
, 
d©a_š
 + 
š_off£t
, 
by‹s
);

320 
buf_off£t
 +ð
by‹s
;

321 
cÚt
:

322 
wÜkšg_by‹s
 -ð
by‹s
;

323 
š_·ge_by‹s_Ëá
 -ð
by‹s
;

324 
š_off£t
 +ð
by‹s
;

327 ià((
wÜkšg_by‹s
 =ð0 && 
š_·ge_by‹s_Ëá
 < 
LZO_LEN
)

328 || 
š_·ge_by‹s_Ëá
 == 0) {

329 
tÙ_š
 +ð
š_·ge_by‹s_Ëá
;

331 ià(
wÜkšg_by‹s
 =ð0 && 
tÙ_š
 >ð
tÙ_Ën
)

334 ià(
·ge_š_šdex
 + 1 >ð
tÙ®_·ges_š
) {

335 
»t
 = -
EIO
;

336 
dÚe
;

339 ià(
may_Ï‹_unm­
)

340 
Ãed_unm­
 = 
Œue
;

342 
	`kunm­
(
·ges_š
[
·ge_š_šdex
]);

344 
d©a_š
 = 
	`km­
(
·ges_š
[++
·ge_š_šdex
]);

346 
š_·ge_by‹s_Ëá
 = 
PAGE_SIZE
;

347 
š_off£t
 = 0;

351 
out_Ën
 = 
	`lzo1x_wÜ¡_com´ess
(
PAGE_SIZE
);

352 
»t
 = 
	`lzo1x_decom´ess_§ã
(
buf
, 
š_Ën
, 
wÜk¥aû
->buf,

353 &
out_Ën
);

354 ià(
Ãed_unm­
)

355 
	`kunm­
(
·ges_š
[
·ge_š_šdex
 - 1]);

356 ià(
»t
 !ð
LZO_E_OK
) {

357 
	`´_w¬n
("BTRFS: decompress failed\n");

358 
»t
 = -
EIO
;

362 
buf_¡¬t
 = 
tÙ_out
;

363 
tÙ_out
 +ð
out_Ën
;

365 
»t2
 = 
	`bŒfs_decom´ess_buf2·ge
(
wÜk¥aû
->
buf
, 
buf_¡¬t
,

366 
tÙ_out
, 
disk_¡¬t
, 
Üig_bio
);

367 ià(
»t2
 == 0)

370 
dÚe
:

371 
	`kunm­
(
·ges_š
[
·ge_š_šdex
]);

372 ià(!
»t
)

373 
	`z”o_fžl_bio
(
Üig_bio
);

374  
»t
;

375 
	}
}

377 
	$lzo_decom´ess
(
li¡_h—d
 *
ws
, *
d©a_š
,

378 
·ge
 *
de¡_·ge
,

379 
¡¬t_by‹
,

380 
size_t
 
¤þ’
, size_ˆ
de¡Ën
)

382 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

383 
size_t
 
š_Ën
;

384 
size_t
 
out_Ën
;

385 
size_t
 
tÙ_Ën
;

386 
»t
 = 0;

387 *
kaddr
;

388 
by‹s
;

390 
	`BUG_ON
(
¤þ’
 < 
LZO_LEN
);

392 
tÙ_Ën
 = 
	`»ad_com´ess_Ëngth
(
d©a_š
);

393 
d©a_š
 +ð
LZO_LEN
;

395 
š_Ën
 = 
	`»ad_com´ess_Ëngth
(
d©a_š
);

396 
d©a_š
 +ð
LZO_LEN
;

398 
out_Ën
 = 
PAGE_SIZE
;

399 
»t
 = 
	`lzo1x_decom´ess_§ã
(
d©a_š
, 
š_Ën
, 
wÜk¥aû
->
buf
, &
out_Ën
);

400 ià(
»t
 !ð
LZO_E_OK
) {

401 
	`´_w¬n
("BTRFS: decompress failed!\n");

402 
»t
 = -
EIO
;

403 
out
;

406 ià(
out_Ën
 < 
¡¬t_by‹
) {

407 
»t
 = -
EIO
;

408 
out
;

415 
de¡Ën
 = 
	`mš_t
(, de¡Ën, 
PAGE_SIZE
);

416 
by‹s
 = 
	`mš_t
(, 
de¡Ën
, 
out_Ën
 - 
¡¬t_by‹
);

418 
kaddr
 = 
	`km­_©omic
(
de¡_·ge
);

419 
	`memýy
(
kaddr
, 
wÜk¥aû
->
buf
 + 
¡¬t_by‹
, 
by‹s
);

426 ià(
by‹s
 < 
de¡Ën
)

427 
	`mem£t
(
kaddr
+
by‹s
, 0, 
de¡Ën
-bytes);

428 
	`kunm­_©omic
(
kaddr
);

429 
out
:

430  
»t
;

431 
	}
}

433 cÚ¡ 
bŒfs_com´ess_Ý
 
	gbŒfs_lzo_com´ess
 = {

434 .
®loc_wÜk¥aû
 = 
lzo_®loc_wÜk¥aû
,

435 .
	gä“_wÜk¥aû
 = 
lzo_ä“_wÜk¥aû
,

436 .
	gcom´ess_·ges
 = 
lzo_com´ess_·ges
,

437 .
	gdecom´ess_bio
 = 
lzo_decom´ess_bio
,

438 .
	gdecom´ess
 = 
lzo_decom´ess
,

	@math.h

21 #iâdeà
__BTRFS_MATH_H


22 
	#__BTRFS_MATH_H


	)

24 
	~<asm/div64.h
>

26 
šlše
 
u64
 
	$div_çùÜ
(
u64
 
num
, 
çùÜ
)

28 ià(
çùÜ
 == 10)

29  
num
;

30 
num
 *ð
çùÜ
;

31  
	`div_u64
(
num
, 10);

32 
	}
}

34 
šlše
 
u64
 
	$div_çùÜ_fše
(
u64
 
num
, 
çùÜ
)

36 ià(
çùÜ
 == 100)

37  
num
;

38 
num
 *ð
çùÜ
;

39  
	`div_u64
(
num
, 100);

40 
	}
}

	@ordered-data.c

19 
	~<lšux/¦ab.h
>

20 
	~<lšux/blkdev.h
>

21 
	~<lšux/wr™eback.h
>

22 
	~<lšux/·gevec.h
>

23 
	~"ù»e.h
"

24 
	~"Œª§ùiÚ.h
"

25 
	~"bŒfs_šode.h
"

26 
	~"ex‹Á_io.h
"

27 
	~"disk-io.h
"

28 
	~"com´essiÚ.h
"

30 
kmem_ÿche
 *
	gbŒfs_Üd”ed_ex‹Á_ÿche
;

32 
u64
 
	$’Œy_’d
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

34 ià(
’Œy
->
fže_off£t
 +ƒÁry->
Ën
 <ƒntry->file_offset)

35  (
u64
)-1;

36  
’Œy
->
fže_off£t
 +ƒÁry->
Ën
;

37 
	}
}

42 
rb_node
 *
	$Œ“_š£¹
(
rb_roÙ
 *
roÙ
, 
u64
 
fže_off£t
,

43 
rb_node
 *
node
)

45 
rb_node
 **
p
 = &
roÙ
->rb_node;

46 
rb_node
 *
·»Á
 = 
NULL
;

47 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

49 *
p
) {

50 
·»Á
 = *
p
;

51 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

53 ià(
fže_off£t
 < 
’Œy
->file_offset)

54 
p
 = &(*p)->
rb_Ëá
;

55 ià(
fže_off£t
 >ð
	`’Œy_’d
(
’Œy
))

56 
p
 = &(*p)->
rb_right
;

58  
·»Á
;

61 
	`rb_lšk_node
(
node
, 
·»Á
, 
p
);

62 
	`rb_š£¹_cÞÜ
(
node
, 
roÙ
);

63  
NULL
;

64 
	}
}

66 
	$Üd”ed_d©a_Œ“_·nic
(
šode
 *šode, 
”ºo
,

67 
u64
 
off£t
)

69 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

70 
	`bŒfs_·nic
(
fs_šfo
, 
”ºo
,

71 "IncÚsi¡’cy iÀÜd”ed»© off£ˆ%Îu", 
off£t
);

72 
	}
}

78 
rb_node
 *
	$__Œ“_£¬ch
(
rb_roÙ
 *
roÙ
, 
u64
 
fže_off£t
,

79 
rb_node
 **
´ev_»t
)

81 
rb_node
 *
n
 = 
roÙ
->rb_node;

82 
rb_node
 *
´ev
 = 
NULL
;

83 
rb_node
 *
‹¡
;

84 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

85 
bŒfs_Üd”ed_ex‹Á
 *
´ev_’Œy
 = 
NULL
;

87 
n
) {

88 
’Œy
 = 
	`rb_’Œy
(
n
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

89 
´ev
 = 
n
;

90 
´ev_’Œy
 = 
’Œy
;

92 ià(
fže_off£t
 < 
’Œy
->file_offset)

93 
n
 =‚->
rb_Ëá
;

94 ià(
fže_off£t
 >ð
	`’Œy_’d
(
’Œy
))

95 
n
 =‚->
rb_right
;

97  
n
;

99 ià(!
´ev_»t
)

100  
NULL
;

102 
´ev
 && 
fže_off£t
 >ð
	`’Œy_’d
(
´ev_’Œy
)) {

103 
‹¡
 = 
	`rb_Ãxt
(
´ev
);

104 ià(!
‹¡
)

106 
´ev_’Œy
 = 
	`rb_’Œy
(
‹¡
, 
bŒfs_Üd”ed_ex‹Á
,

107 
rb_node
);

108 ià(
fže_off£t
 < 
	`’Œy_’d
(
´ev_’Œy
))

111 
´ev
 = 
‹¡
;

113 ià(
´ev
)

114 
´ev_’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_Üd”ed_ex‹Á
,

115 
rb_node
);

116 
´ev
 && 
fže_off£t
 < 
	`’Œy_’d
(
´ev_’Œy
)) {

117 
‹¡
 = 
	`rb_´ev
(
´ev
);

118 ià(!
‹¡
)

120 
´ev_’Œy
 = 
	`rb_’Œy
(
‹¡
, 
bŒfs_Üd”ed_ex‹Á
,

121 
rb_node
);

122 
´ev
 = 
‹¡
;

124 *
´ev_»t
 = 
´ev
;

125  
NULL
;

126 
	}
}

131 
	$off£t_š_’Œy
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
, 
u64
 
fže_off£t
)

133 ià(
fže_off£t
 < 
’Œy
->file_offset ||

134 
’Œy
->
fže_off£t
 +ƒÁry->
Ën
 <= file_offset)

137 
	}
}

139 
	$¿nge_ov”Ïps
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
, 
u64
 
fže_off£t
,

140 
u64
 
Ën
)

142 ià(
fže_off£t
 + 
Ën
 <ð
’Œy
->file_offset ||

143 
’Œy
->
fže_off£t
 +ƒÁry->
Ën
 <= file_offset)

146 
	}
}

152 
šlše
 
rb_node
 *
	$Œ“_£¬ch
(
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
,

153 
u64
 
fže_off£t
)

155 
rb_roÙ
 *
roÙ
 = &
Œ“
->tree;

156 
rb_node
 *
´ev
 = 
NULL
;

157 
rb_node
 *
»t
;

158 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

160 ià(
Œ“
->
Ï¡
) {

161 
’Œy
 = 
	`rb_’Œy
(
Œ“
->
Ï¡
, 
bŒfs_Üd”ed_ex‹Á
,

162 
rb_node
);

163 ià(
	`off£t_š_’Œy
(
’Œy
, 
fže_off£t
))

164  
Œ“
->
Ï¡
;

166 
»t
 = 
	`__Œ“_£¬ch
(
roÙ
, 
fže_off£t
, &
´ev
);

167 ià(!
»t
)

168 
»t
 = 
´ev
;

169 ià(
»t
)

170 
Œ“
->
Ï¡
 = 
»t
;

171  
»t
;

172 
	}
}

185 
	$__bŒfs_add_Üd”ed_ex‹Á
(
šode
 *šode, 
u64
 
fže_off£t
,

186 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
,

187 
ty³
, 
dio
, 
com´ess_ty³
)

189 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

190 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

191 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

192 
rb_node
 *
node
;

193 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
;

195 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

196 
’Œy
 = 
	`kmem_ÿche_z®loc
(
bŒfs_Üd”ed_ex‹Á_ÿche
, 
GFP_NOFS
);

197 ià(!
’Œy
)

198  -
ENOMEM
;

200 
’Œy
->
fže_off£t
 = file_offset;

201 
’Œy
->
¡¬t
 = start;

202 
’Œy
->
Ën
 =†en;

203 
’Œy
->
disk_Ën
 = disk_len;

204 
’Œy
->
by‹s_Ëá
 = 
Ën
;

205 
’Œy
->
šode
 = 
	`ig¿b
(inode);

206 
’Œy
->
com´ess_ty³
 = compress_type;

207 
’Œy
->
Œunÿ‹d_Ën
 = (
u64
)-1;

208 ià(
ty³
 !ð
BTRFS_ORDERED_IO_DONE
 &&y³ !ð
BTRFS_ORDERED_COMPLETE
)

209 
	`£t_b™
(
ty³
, &
’Œy
->
æags
);

211 ià(
dio
)

212 
	`£t_b™
(
BTRFS_ORDERED_DIRECT
, &
’Œy
->
æags
);

215 
	`»fcouÁ_£t
(&
’Œy
->
»fs
, 1);

216 
	`š™_wa™queue_h—d
(&
’Œy
->
wa™
);

217 
	`INIT_LIST_HEAD
(&
’Œy
->
li¡
);

218 
	`INIT_LIST_HEAD
(&
’Œy
->
roÙ_ex‹Á_li¡
);

219 
	`INIT_LIST_HEAD
(&
’Œy
->
wÜk_li¡
);

220 
	`š™_com¶‘iÚ
(&
’Œy
->
com¶‘iÚ
);

221 
	`INIT_LIST_HEAD
(&
’Œy
->
log_li¡
);

222 
	`INIT_LIST_HEAD
(&
’Œy
->
Œªs_li¡
);

224 
	`Œaû_bŒfs_Üd”ed_ex‹Á_add
(
šode
, 
’Œy
);

226 
	`¥š_lock_œq
(&
Œ“
->
lock
);

227 
node
 = 
	`Œ“_š£¹
(&
Œ“
->Œ“, 
fže_off£t
,

228 &
’Œy
->
rb_node
);

229 ià(
node
)

230 
	`Üd”ed_d©a_Œ“_·nic
(
šode
, -
EEXIST
, 
fže_off£t
);

231 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

233 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

234 
	`li¡_add_ž
(&
’Œy
->
roÙ_ex‹Á_li¡
,

235 &
roÙ
->
Üd”ed_ex‹Ás
);

236 
roÙ
->
Ä_Üd”ed_ex‹Ás
++;

237 ià(
roÙ
->
Ä_Üd”ed_ex‹Ás
 == 1) {

238 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

239 
	`BUG_ON
(!
	`li¡_em±y
(&
roÙ
->
Üd”ed_roÙ
));

240 
	`li¡_add_ž
(&
roÙ
->
Üd”ed_roÙ
, &
fs_šfo
->
Üd”ed_roÙs
);

241 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

243 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

246 
	}
}

248 
	$bŒfs_add_Üd”ed_ex‹Á
(
šode
 *šode, 
u64
 
fže_off£t
,

249 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
, 
ty³
)

251  
	`__bŒfs_add_Üd”ed_ex‹Á
(
šode
, 
fže_off£t
, 
¡¬t
, 
Ën
,

252 
disk_Ën
, 
ty³
, 0,

253 
BTRFS_COMPRESS_NONE
);

254 
	}
}

256 
	$bŒfs_add_Üd”ed_ex‹Á_dio
(
šode
 *šode, 
u64
 
fže_off£t
,

257 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
, 
ty³
)

259  
	`__bŒfs_add_Üd”ed_ex‹Á
(
šode
, 
fže_off£t
, 
¡¬t
, 
Ën
,

260 
disk_Ën
, 
ty³
, 1,

261 
BTRFS_COMPRESS_NONE
);

262 
	}
}

264 
	$bŒfs_add_Üd”ed_ex‹Á_com´ess
(
šode
 *šode, 
u64
 
fže_off£t
,

265 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
,

266 
ty³
, 
com´ess_ty³
)

268  
	`__bŒfs_add_Üd”ed_ex‹Á
(
šode
, 
fže_off£t
, 
¡¬t
, 
Ën
,

269 
disk_Ën
, 
ty³
, 0,

270 
com´ess_ty³
);

271 
	}
}

278 
	$bŒfs_add_Üd”ed_sum
(
šode
 *inode,

279 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
,

280 
bŒfs_Üd”ed_sum
 *
sum
)

282 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

284 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

285 
	`¥š_lock_œq
(&
Œ“
->
lock
);

286 
	`li¡_add_ž
(&
sum
->
li¡
, &
’Œy
->list);

287 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

288 
	}
}

302 
	$bŒfs_dec_‹¡_fœ¡_Üd”ed_³ndšg
(
šode
 *inode,

303 
bŒfs_Üd”ed_ex‹Á
 **
ÿched
,

304 
u64
 *
fže_off£t
, u64 
io_size
, 
u±od©e
)

306 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

307 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

308 
rb_node
 *
node
;

309 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

310 
»t
;

311 
æags
;

312 
u64
 
dec_’d
;

313 
u64
 
dec_¡¬t
;

314 
u64
 
to_dec
;

316 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

317 
	`¥š_lock_œq§ve
(&
Œ“
->
lock
, 
æags
);

318 
node
 = 
	`Œ“_£¬ch
(
Œ“
, *
fže_off£t
);

319 ià(!
node
) {

320 
»t
 = 1;

321 
out
;

324 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

325 ià(!
	`off£t_š_’Œy
(
’Œy
, *
fže_off£t
)) {

326 
»t
 = 1;

327 
out
;

330 
dec_¡¬t
 = 
	`max
(*
fže_off£t
, 
’Œy
->file_offset);

331 
dec_’d
 = 
	`mš
(*
fže_off£t
 + 
io_size
, 
’Œy
->file_offset +

332 
’Œy
->
Ën
);

333 *
fže_off£t
 = 
dec_’d
;

334 ià(
dec_¡¬t
 > 
dec_’d
) {

335 
	`bŒfs_ü™
(
fs_šfo
, "bad ordering dec_start %lluƒnd %llu",

336 
dec_¡¬t
, 
dec_’d
);

338 
to_dec
 = 
dec_’d
 - 
dec_¡¬t
;

339 ià(
to_dec
 > 
’Œy
->
by‹s_Ëá
) {

340 
	`bŒfs_ü™
(
fs_šfo
,

342 
’Œy
->
by‹s_Ëá
, 
to_dec
);

344 
’Œy
->
by‹s_Ëá
 -ð
to_dec
;

345 ià(!
u±od©e
)

346 
	`£t_b™
(
BTRFS_ORDERED_IOERR
, &
’Œy
->
æags
);

348 ià(
’Œy
->
by‹s_Ëá
 == 0) {

349 
»t
 = 
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_IO_DONE
, &
’Œy
->
æags
);

353 ià(
	`wa™queue_aùive
(&
’Œy
->
wa™
))

354 
	`wake_up
(&
’Œy
->
wa™
);

356 
»t
 = 1;

358 
out
:

359 ià(!
»t
 && 
ÿched
 && 
’Œy
) {

360 *
ÿched
 = 
’Œy
;

361 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

363 
	`¥š_uÆock_œq»¡Üe
(&
Œ“
->
lock
, 
æags
);

364  
»t
 == 0;

365 
	}
}

376 
	$bŒfs_dec_‹¡_Üd”ed_³ndšg
(
šode
 *inode,

377 
bŒfs_Üd”ed_ex‹Á
 **
ÿched
,

378 
u64
 
fže_off£t
, u64 
io_size
, 
u±od©e
)

380 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

381 
rb_node
 *
node
;

382 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

383 
æags
;

384 
»t
;

386 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

387 
	`¥š_lock_œq§ve
(&
Œ“
->
lock
, 
æags
);

388 ià(
ÿched
 && *cached) {

389 
’Œy
 = *
ÿched
;

390 
have_’Œy
;

393 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fže_off£t
);

394 ià(!
node
) {

395 
»t
 = 1;

396 
out
;

399 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

400 
have_’Œy
:

401 ià(!
	`off£t_š_’Œy
(
’Œy
, 
fže_off£t
)) {

402 
»t
 = 1;

403 
out
;

406 ià(
io_size
 > 
’Œy
->
by‹s_Ëá
) {

407 
	`bŒfs_ü™
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

409 
’Œy
->
by‹s_Ëá
, 
io_size
);

411 
’Œy
->
by‹s_Ëá
 -ð
io_size
;

412 ià(!
u±od©e
)

413 
	`£t_b™
(
BTRFS_ORDERED_IOERR
, &
’Œy
->
æags
);

415 ià(
’Œy
->
by‹s_Ëá
 == 0) {

416 
»t
 = 
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_IO_DONE
, &
’Œy
->
æags
);

420 ià(
	`wa™queue_aùive
(&
’Œy
->
wa™
))

421 
	`wake_up
(&
’Œy
->
wa™
);

423 
»t
 = 1;

425 
out
:

426 ià(!
»t
 && 
ÿched
 && 
’Œy
) {

427 *
ÿched
 = 
’Œy
;

428 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

430 
	`¥š_uÆock_œq»¡Üe
(&
Œ“
->
lock
, 
æags
);

431  
»t
 == 0;

432 
	}
}

435 
	$bŒfs_g‘_logged_ex‹Ás
(
bŒfs_šode
 *
šode
,

436 
li¡_h—d
 *
logged_li¡
,

437 cÚ¡ 
loff_t
 
¡¬t
,

438 cÚ¡ 
loff_t
 
’d
)

440 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

441 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

442 
rb_node
 *
n
;

443 
rb_node
 *
´ev
;

445 
Œ“
 = &
šode
->
Üd”ed_Œ“
;

446 
	`¥š_lock_œq
(&
Œ“
->
lock
);

447 
n
 = 
	`__Œ“_£¬ch
(&
Œ“
->Œ“, 
’d
, &
´ev
);

448 ià(!
n
)

449 
n
 = 
´ev
;

450 ; 
n
;‚ = 
	`rb_´ev
(n)) {

451 
Üd”ed
 = 
	`rb_’Œy
(
n
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

452 ià(
Üd”ed
->
fže_off£t
 > 
’d
)

454 ià(
	`’Œy_’d
(
Üd”ed
è<ð
¡¬t
)

456 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_LOGGED
, &
Üd”ed
->
æags
))

458 
	`li¡_add
(&
Üd”ed
->
log_li¡
, 
logged_li¡
);

459 
	`»fcouÁ_šc
(&
Üd”ed
->
»fs
);

461 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

462 
	}
}

464 
	$bŒfs_put_logged_ex‹Ás
(
li¡_h—d
 *
logged_li¡
)

466 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

468 !
	`li¡_em±y
(
logged_li¡
)) {

469 
Üd”ed
 = 
	`li¡_fœ¡_’Œy
(
logged_li¡
,

470 
bŒfs_Üd”ed_ex‹Á
,

471 
log_li¡
);

472 
	`li¡_d–_š™
(&
Üd”ed
->
log_li¡
);

473 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

475 
	}
}

477 
	$bŒfs_subm™_logged_ex‹Ás
(
li¡_h—d
 *
logged_li¡
,

478 
bŒfs_roÙ
 *
log
)

480 
šdex
 = 
log
->
log_Œªsid
 % 2;

482 
	`¥š_lock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

483 
	`li¡_¥liû_ž
(
logged_li¡
, &
log
->logged_li¡[
šdex
]);

484 
	`¥š_uÆock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

485 
	}
}

487 
	$bŒfs_wa™_logged_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

488 
bŒfs_roÙ
 *
log
, 
u64
 
Œªsid
)

490 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

491 
šdex
 = 
Œªsid
 % 2;

493 
	`¥š_lock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

494 !
	`li¡_em±y
(&
log
->
logged_li¡
[
šdex
])) {

495 
šode
 *inode;

496 
Üd”ed
 = 
	`li¡_fœ¡_’Œy
(&
log
->
logged_li¡
[
šdex
],

497 
bŒfs_Üd”ed_ex‹Á
,

498 
log_li¡
);

499 
	`li¡_d–_š™
(&
Üd”ed
->
log_li¡
);

500 
šode
 = 
Üd”ed
->inode;

501 
	`¥š_uÆock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

503 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_IO_DONE
, &
Üd”ed
->
æags
) &&

504 !
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Üd”ed
->
æags
)) {

505 
u64
 
¡¬t
 = 
Üd”ed
->
fže_off£t
;

506 
u64
 
’d
 = 
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 - 1;

508 
	`WARN_ON
(!
šode
);

509 
	`fžem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

511 
	`wa™_ev’t
(
Üd”ed
->
wa™
, 
	`‹¡_b™
(
BTRFS_ORDERED_IO_DONE
,

512 &
Üd”ed
->
æags
));

522 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_COMPLETE
, &
Üd”ed
->
æags
)) {

523 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

525 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

526 
	`¥š_lock_œq
(&
Œ“
->
lock
);

527 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_COMPLETE
, &
Üd”ed
->
æags
)) {

528 
	`£t_b™
(
BTRFS_ORDERED_PENDING
, &
Üd”ed
->
æags
);

529 
	`©omic_šc
(&
Œªs
->
Œª§ùiÚ
->
³ndšg_Üd”ed
);

531 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

533 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

534 
	`¥š_lock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

536 
	`¥š_uÆock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

537 
	}
}

539 
	$bŒfs_ä“_logged_ex‹Ás
(
bŒfs_roÙ
 *
log
, 
u64
 
Œªsid
)

541 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

542 
šdex
 = 
Œªsid
 % 2;

544 
	`¥š_lock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

545 !
	`li¡_em±y
(&
log
->
logged_li¡
[
šdex
])) {

546 
Üd”ed
 = 
	`li¡_fœ¡_’Œy
(&
log
->
logged_li¡
[
šdex
],

547 
bŒfs_Üd”ed_ex‹Á
,

548 
log_li¡
);

549 
	`li¡_d–_š™
(&
Üd”ed
->
log_li¡
);

550 
	`¥š_uÆock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

551 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

552 
	`¥š_lock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

554 
	`¥š_uÆock_œq
(&
log
->
log_ex‹Ás_lock
[
šdex
]);

555 
	}
}

561 
	$bŒfs_put_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

563 
li¡_h—d
 *
cur
;

564 
bŒfs_Üd”ed_sum
 *
sum
;

566 
	`Œaû_bŒfs_Üd”ed_ex‹Á_put
(
’Œy
->
šode
,ƒntry);

568 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
’Œy
->
»fs
)) {

569 
	`ASSERT
(
	`li¡_em±y
(&
’Œy
->
log_li¡
));

570 
	`ASSERT
(
	`li¡_em±y
(&
’Œy
->
Œªs_li¡
));

571 
	`ASSERT
(
	`li¡_em±y
(&
’Œy
->
roÙ_ex‹Á_li¡
));

572 
	`ASSERT
(
	`RB_EMPTY_NODE
(&
’Œy
->
rb_node
));

573 ià(
’Œy
->
šode
)

574 
	`bŒfs_add_d–ayed_ut
(
’Œy
->
šode
);

575 !
	`li¡_em±y
(&
’Œy
->
li¡
)) {

576 
cur
 = 
’Œy
->
li¡
.
Ãxt
;

577 
sum
 = 
	`li¡_’Œy
(
cur
, 
bŒfs_Üd”ed_sum
, 
li¡
);

578 
	`li¡_d–
(&
sum
->
li¡
);

579 
	`kä“
(
sum
);

581 
	`kmem_ÿche_ä“
(
bŒfs_Üd”ed_ex‹Á_ÿche
, 
’Œy
);

583 
	}
}

589 
	$bŒfs_»move_Üd”ed_ex‹Á
(
šode
 *inode,

590 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
)

592 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

593 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

594 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

595 
rb_node
 *
node
;

596 
boÞ
 
dec_³ndšg_Üd”ed
 = 
çl£
;

598 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

599 
	`¥š_lock_œq
(&
Œ“
->
lock
);

600 
node
 = &
’Œy
->
rb_node
;

601 
	`rb_”a£
(
node
, &
Œ“
->tree);

602 
	`RB_CLEAR_NODE
(
node
);

603 ià(
Œ“
->
Ï¡
 =ð
node
)

604 
Œ“
->
Ï¡
 = 
NULL
;

605 
	`£t_b™
(
BTRFS_ORDERED_COMPLETE
, &
’Œy
->
æags
);

606 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_ORDERED_PENDING
, &
’Œy
->
æags
))

607 
dec_³ndšg_Üd”ed
 = 
Œue
;

608 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

614 ià(
dec_³ndšg_Üd”ed
) {

615 
bŒfs_Œª§ùiÚ
 *
Œªs
;

623 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

624 
Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

625 ià(
Œªs
)

626 
	`»fcouÁ_šc
(&
Œªs
->
u£_couÁ
);

627 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

629 
	`ASSERT
(
Œªs
);

630 ià(
Œªs
) {

631 ià(
	`©omic_dec_ªd_‹¡
(&
Œªs
->
³ndšg_Üd”ed
))

632 
	`wake_up
(&
Œªs
->
³ndšg_wa™
);

633 
	`bŒfs_put_Œª§ùiÚ
(
Œªs
);

637 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

638 
	`li¡_d–_š™
(&
’Œy
->
roÙ_ex‹Á_li¡
);

639 
roÙ
->
Ä_Üd”ed_ex‹Ás
--;

641 
	`Œaû_bŒfs_Üd”ed_ex‹Á_»move
(
šode
, 
’Œy
);

643 ià(!
roÙ
->
Ä_Üd”ed_ex‹Ás
) {

644 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

645 
	`BUG_ON
(
	`li¡_em±y
(&
roÙ
->
Üd”ed_roÙ
));

646 
	`li¡_d–_š™
(&
roÙ
->
Üd”ed_roÙ
);

647 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

649 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

650 
	`wake_up
(&
’Œy
->
wa™
);

651 
	}
}

653 
	$bŒfs_run_Üd”ed_ex‹Á_wÜk
(
bŒfs_wÜk
 *
wÜk
)

655 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

657 
Üd”ed
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_Üd”ed_ex‹Á
, 
æush_wÜk
);

658 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
Üd”ed
->
šode
, ordered, 1);

659 
	`com¶‘e
(&
Üd”ed
->
com¶‘iÚ
);

660 
	}
}

666 
u64
 
	$bŒfs_wa™_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
Ä
,

667 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
)

669 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

670 
	`LIST_HEAD
(
¥liû
);

671 
	`LIST_HEAD
(
sk³d
);

672 
	`LIST_HEAD
(
wÜks
);

673 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
, *
Ãxt
;

674 
u64
 
couÁ
 = 0;

675 cÚ¡ 
u64
 
¿nge_’d
 = 
¿nge_¡¬t
 + 
¿nge_Ën
;

677 
	`mu‹x_lock
(&
roÙ
->
Üd”ed_ex‹Á_mu‹x
);

678 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

679 
	`li¡_¥liû_š™
(&
roÙ
->
Üd”ed_ex‹Ás
, &
¥liû
);

680 !
	`li¡_em±y
(&
¥liû
è&& 
Ä
) {

681 
Üd”ed
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_Üd”ed_ex‹Á
,

682 
roÙ_ex‹Á_li¡
);

684 ià(
¿nge_’d
 <ð
Üd”ed
->
¡¬t
 ||

685 
Üd”ed
->
¡¬t
 + ord”ed->
disk_Ën
 <ð
¿nge_¡¬t
) {

686 
	`li¡_move_ž
(&
Üd”ed
->
roÙ_ex‹Á_li¡
, &
sk³d
);

687 
	`cÚd_»sched_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

691 
	`li¡_move_ž
(&
Üd”ed
->
roÙ_ex‹Á_li¡
,

692 &
roÙ
->
Üd”ed_ex‹Ás
);

693 
	`»fcouÁ_šc
(&
Üd”ed
->
»fs
);

694 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

696 
	`bŒfs_š™_wÜk
(&
Üd”ed
->
æush_wÜk
,

697 
bŒfs_æush_d–®loc_h–³r
,

698 
bŒfs_run_Üd”ed_ex‹Á_wÜk
, 
NULL
, NULL);

699 
	`li¡_add_ž
(&
Üd”ed
->
wÜk_li¡
, &
wÜks
);

700 
	`bŒfs_queue_wÜk
(
fs_šfo
->
æush_wÜk”s
, &
Üd”ed
->
æush_wÜk
);

702 
	`cÚd_»sched
();

703 
	`¥š_lock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

704 ià(
Ä
 !ð
U64_MAX
)

705 
Ä
--;

706 
couÁ
++;

708 
	`li¡_¥liû_ž
(&
sk³d
, &
roÙ
->
Üd”ed_ex‹Ás
);

709 
	`li¡_¥liû_ž
(&
¥liû
, &
roÙ
->
Üd”ed_ex‹Ás
);

710 
	`¥š_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_lock
);

712 
	`li¡_fÜ_—ch_’Œy_§ã
(
Üd”ed
, 
Ãxt
, &
wÜks
, 
wÜk_li¡
) {

713 
	`li¡_d–_š™
(&
Üd”ed
->
wÜk_li¡
);

714 
	`wa™_fÜ_com¶‘iÚ
(&
Üd”ed
->
com¶‘iÚ
);

715 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

716 
	`cÚd_»sched
();

718 
	`mu‹x_uÆock
(&
roÙ
->
Üd”ed_ex‹Á_mu‹x
);

720  
couÁ
;

721 
	}
}

723 
u64
 
	$bŒfs_wa™_Üd”ed_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Ä
,

724 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
)

726 
bŒfs_roÙ
 *
roÙ
;

727 
li¡_h—d
 
¥liû
;

728 
u64
 
tÙ®_dÚe
 = 0;

729 
u64
 
dÚe
;

731 
	`INIT_LIST_HEAD
(&
¥liû
);

733 
	`mu‹x_lock
(&
fs_šfo
->
Üd”ed_Ý”©iÚs_mu‹x
);

734 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

735 
	`li¡_¥liû_š™
(&
fs_šfo
->
Üd”ed_roÙs
, &
¥liû
);

736 !
	`li¡_em±y
(&
¥liû
è&& 
Ä
) {

737 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
¥liû
, 
bŒfs_roÙ
,

738 
Üd”ed_roÙ
);

739 
roÙ
 = 
	`bŒfs_g¿b_fs_roÙ
(root);

740 
	`BUG_ON
(!
roÙ
);

741 
	`li¡_move_ž
(&
roÙ
->
Üd”ed_roÙ
,

742 &
fs_šfo
->
Üd”ed_roÙs
);

743 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

745 
dÚe
 = 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
Ä
,

746 
¿nge_¡¬t
, 
¿nge_Ën
);

747 
	`bŒfs_put_fs_roÙ
(
roÙ
);

748 
tÙ®_dÚe
 +ð
dÚe
;

750 
	`¥š_lock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

751 ià(
Ä
 !ð
U64_MAX
) {

752 
Ä
 -ð
dÚe
;

755 
	`li¡_¥liû_ž
(&
¥liû
, &
fs_šfo
->
Üd”ed_roÙs
);

756 
	`¥š_uÆock
(&
fs_šfo
->
Üd”ed_roÙ_lock
);

757 
	`mu‹x_uÆock
(&
fs_šfo
->
Üd”ed_Ý”©iÚs_mu‹x
);

759  
tÙ®_dÚe
;

760 
	}
}

769 
	$bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
 *inode,

770 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
,

771 
wa™
)

773 
u64
 
¡¬t
 = 
’Œy
->
fže_off£t
;

774 
u64
 
’d
 = 
¡¬t
 + 
’Œy
->
Ën
 - 1;

776 
	`Œaû_bŒfs_Üd”ed_ex‹Á_¡¬t
(
šode
, 
’Œy
);

783 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
’Œy
->
æags
))

784 
	`fžem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

785 ià(
wa™
) {

786 
	`wa™_ev’t
(
’Œy
->
wa™
, 
	`‹¡_b™
(
BTRFS_ORDERED_COMPLETE
,

787 &
’Œy
->
æags
));

789 
	}
}

794 
	$bŒfs_wa™_Üd”ed_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
)

796 
»t
 = 0;

797 
»t_wb
 = 0;

798 
u64
 
’d
;

799 
u64
 
Üig_’d
;

800 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

802 ià(
¡¬t
 + 
Ën
 < start) {

803 
Üig_’d
 = 
	`INT_LIMIT
(
loff_t
);

805 
Üig_’d
 = 
¡¬t
 + 
Ën
 - 1;

806 ià(
Üig_’d
 > 
	`INT_LIMIT
(
loff_t
))

807 
Üig_’d
 = 
	`INT_LIMIT
(
loff_t
);

813 
»t
 = 
	`bŒfs_fd©awr™e_¿nge
(
šode
, 
¡¬t
, 
Üig_’d
);

814 ià(
»t
)

815  
»t
;

824 
»t_wb
 = 
	`fžem­_fd©awa™_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
Üig_’d
);

826 
’d
 = 
Üig_’d
;

828 
Üd”ed
 = 
	`bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
, 
’d
);

829 ià(!
Üd”ed
)

831 ià(
Üd”ed
->
fže_off£t
 > 
Üig_’d
) {

832 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

835 ià(
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 <ð
¡¬t
) {

836 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

839 
	`bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
, 
Üd”ed
, 1);

840 
’d
 = 
Üd”ed
->
fže_off£t
;

841 ià(
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
))

842 
»t
 = -
EIO
;

843 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

844 ià(
»t
 || 
’d
 =ð0 ||ƒnd =ð
¡¬t
)

846 
’d
--;

848  
»t_wb
 ?„‘_wb : 
»t
;

849 
	}
}

855 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_lookup_Üd”ed_ex‹Á
(
šode
 *inode,

856 
u64
 
fže_off£t
)

858 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

859 
rb_node
 *
node
;

860 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

862 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

863 
	`¥š_lock_œq
(&
Œ“
->
lock
);

864 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fže_off£t
);

865 ià(!
node
)

866 
out
;

868 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

869 ià(!
	`off£t_š_’Œy
(
’Œy
, 
fže_off£t
))

870 
’Œy
 = 
NULL
;

871 ià(
’Œy
)

872 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

873 
out
:

874 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

875  
’Œy
;

876 
	}
}

881 
bŒfs_Üd”ed_ex‹Á
 *
	$bŒfs_lookup_Üd”ed_¿nge
(

882 
bŒfs_šode
 *
šode
, 
u64
 
fže_off£t
, u64 
Ën
)

884 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

885 
rb_node
 *
node
;

886 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

888 
Œ“
 = &
šode
->
Üd”ed_Œ“
;

889 
	`¥š_lock_œq
(&
Œ“
->
lock
);

890 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fže_off£t
);

891 ià(!
node
) {

892 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fže_off£t
 + 
Ën
);

893 ià(!
node
)

894 
out
;

898 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

899 ià(
	`¿nge_ov”Ïps
(
’Œy
, 
fže_off£t
, 
Ën
))

902 ià(
’Œy
->
fže_off£t
 >ðfže_off£ˆ+ 
Ën
) {

903 
’Œy
 = 
NULL
;

906 
’Œy
 = 
NULL
;

907 
node
 = 
	`rb_Ãxt
(node);

908 ià(!
node
)

911 
out
:

912 ià(
’Œy
)

913 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

914 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

915  
’Œy
;

916 
	}
}

918 
boÞ
 
	$bŒfs_have_Üd”ed_ex‹Ás_š_¿nge
(
šode
 *inode,

919 
u64
 
fže_off£t
,

920 
u64
 
Ën
)

922 
bŒfs_Üd”ed_ex‹Á
 *
Û
;

924 
Û
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
	`BTRFS_I
(
šode
), 
fže_off£t
, 
Ën
);

925 ià(
Û
) {

926 
	`bŒfs_put_Üd”ed_ex‹Á
(
Û
);

927  
Œue
;

929  
çl£
;

930 
	}
}

936 
bŒfs_Üd”ed_ex‹Á
 *

937 
	$bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
 *šode, 
u64
 
fže_off£t
)

939 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
;

940 
rb_node
 *
node
;

941 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
 = 
NULL
;

943 
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

944 
	`¥š_lock_œq
(&
Œ“
->
lock
);

945 
node
 = 
	`Œ“_£¬ch
(
Œ“
, 
fže_off£t
);

946 ià(!
node
)

947 
out
;

949 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

950 
	`»fcouÁ_šc
(&
’Œy
->
»fs
);

951 
out
:

952 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

953  
’Œy
;

954 
	}
}

960 
	$bŒfs_Üd”ed_upd©e_i_size
(
šode
 *šode, 
u64
 
off£t
,

961 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
)

963 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

964 
u64
 
disk_i_size
;

965 
u64
 
Ãw_i_size
;

966 
u64
 
i_size
 = 
	`i_size_»ad
(
šode
);

967 
rb_node
 *
node
;

968 
rb_node
 *
´ev
 = 
NULL
;

969 
bŒfs_Üd”ed_ex‹Á
 *
‹¡
;

970 
»t
 = 1;

971 
u64
 
Üig_off£t
 = 
off£t
;

973 
	`¥š_lock_œq
(&
Œ“
->
lock
);

974 ià(
Üd”ed
) {

975 
off£t
 = 
	`’Œy_’d
(
Üd”ed
);

976 ià(
	`‹¡_b™
(
BTRFS_ORDERED_TRUNCATED
, &
Üd”ed
->
æags
))

977 
off£t
 = 
	`mš
(offset,

978 
Üd”ed
->
fže_off£t
 +

979 
Üd”ed
->
Œunÿ‹d_Ën
);

981 
off£t
 = 
	`ALIGN
(off£t, 
	`bŒfs_šode_£ùÜsize
(
šode
));

983 
disk_i_size
 = 
	`BTRFS_I
(
šode
)->disk_i_size;

996 ià(!
Üd”ed
 && 
disk_i_size
 > 
i_size
) {

997 
	`BTRFS_I
(
šode
)->
disk_i_size
 = 
Üig_off£t
;

998 
»t
 = 0;

999 
out
;

1006 ià(
disk_i_size
 =ð
i_size
)

1007 
out
;

1013 ià(
off£t
 <ð
disk_i_size
 &&

1014 (!
Üd”ed
 || ord”ed->
out¡ªdšg_isize
 <ð
disk_i_size
))

1015 
out
;

1022 ià(
Üd”ed
) {

1023 
node
 = 
	`rb_´ev
(&
Üd”ed
->
rb_node
);

1025 
´ev
 = 
	`Œ“_£¬ch
(
Œ“
, 
off£t
);

1030 ià(
´ev
) {

1031 
‹¡
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_Üd”ed_ex‹Á
,

1032 
rb_node
);

1033 
	`BUG_ON
(
	`off£t_š_’Œy
(
‹¡
, 
off£t
));

1035 
node
 = 
´ev
;

1037 ; 
node
;‚odð
	`rb_´ev
(node)) {

1038 
‹¡
 = 
	`rb_’Œy
(
node
, 
bŒfs_Üd”ed_ex‹Á
, 
rb_node
);

1041 ià(
	`‹¡_b™
(
BTRFS_ORDERED_UPDATED_ISIZE
, &
‹¡
->
æags
))

1044 ià(
	`’Œy_’d
(
‹¡
è<ð
disk_i_size
)

1046 ià(
‹¡
->
fže_off£t
 >ð
i_size
)

1053 ià(
‹¡
->
out¡ªdšg_isize
 < 
off£t
)

1054 
‹¡
->
out¡ªdšg_isize
 = 
off£t
;

1055 ià(
Üd”ed
 &&

1056 
Üd”ed
->
out¡ªdšg_isize
 > 
‹¡
->outstanding_isize)

1057 
‹¡
->
out¡ªdšg_isize
 = 
Üd”ed
->outstanding_isize;

1058 
out
;

1060 
Ãw_i_size
 = 
	`mš_t
(
u64
, 
off£t
, 
i_size
);

1066 ià(
Üd”ed
 && ord”ed->
out¡ªdšg_isize
 > 
Ãw_i_size
)

1067 
Ãw_i_size
 = 
	`mš_t
(
u64
, 
Üd”ed
->
out¡ªdšg_isize
, 
i_size
);

1068 
	`BTRFS_I
(
šode
)->
disk_i_size
 = 
Ãw_i_size
;

1069 
»t
 = 0;

1070 
out
:

1078 ià(
Üd”ed
)

1079 
	`£t_b™
(
BTRFS_ORDERED_UPDATED_ISIZE
, &
Üd”ed
->
æags
);

1080 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

1081  
»t
;

1082 
	}
}

1089 
	$bŒfs_fšd_Üd”ed_sum
(
šode
 *šode, 
u64
 
off£t
, u64 
disk_by‹Ä
,

1090 
u32
 *
sum
, 
Ën
)

1092 
bŒfs_Üd”ed_sum
 *
Üd”ed_sum
;

1093 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

1094 
bŒfs_Üd”ed_šode_Œ“
 *
Œ“
 = &
	`BTRFS_I
(
šode
)->
Üd”ed_Œ“
;

1095 
num_£ùÜs
;

1096 
i
;

1097 
u32
 
£ùÜsize
 = 
	`bŒfs_šode_£ùÜsize
(
šode
);

1098 
šdex
 = 0;

1100 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
, 
off£t
);

1101 ià(!
Üd”ed
)

1104 
	`¥š_lock_œq
(&
Œ“
->
lock
);

1105 
	`li¡_fÜ_—ch_’Œy_»v”£
(
Üd”ed_sum
, &
Üd”ed
->
li¡
,†ist) {

1106 ià(
disk_by‹Ä
 >ð
Üd”ed_sum
->
by‹Ä
 &&

1107 
disk_by‹Ä
 < 
Üd”ed_sum
->
by‹Ä
 + ord”ed_sum->
Ën
) {

1108 
i
 = (
disk_by‹Ä
 - 
Üd”ed_sum
->
by‹Ä
) >>

1109 
šode
->
i_sb
->
s_blocksize_b™s
;

1110 
num_£ùÜs
 = 
Üd”ed_sum
->
Ën
 >>

1111 
šode
->
i_sb
->
s_blocksize_b™s
;

1112 
num_£ùÜs
 = 
	`mš_t
(, 
Ën
 - 
šdex
,‚um_£ùÜ - 
i
);

1113 
	`memýy
(
sum
 + 
šdex
, 
Üd”ed_sum
->
sums
 + 
i
,

1114 
num_£ùÜs
);

1116 
šdex
 +ð()
num_£ùÜs
;

1117 ià(
šdex
 =ð
Ën
)

1118 
out
;

1119 
disk_by‹Ä
 +ð
num_£ùÜs
 * 
£ùÜsize
;

1122 
out
:

1123 
	`¥š_uÆock_œq
(&
Œ“
->
lock
);

1124 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

1125  
šdex
;

1126 
	}
}

1128 
__š™
 
	$Üd”ed_d©a_š™
()

1130 
bŒfs_Üd”ed_ex‹Á_ÿche
 = 
	`kmem_ÿche_ü—‹
("btrfs_ordered_extent",

1131 (
bŒfs_Üd”ed_ex‹Á
), 0,

1132 
SLAB_MEM_SPREAD
,

1133 
NULL
);

1134 ià(!
bŒfs_Üd”ed_ex‹Á_ÿche
)

1135  -
ENOMEM
;

1138 
	}
}

1140 
	$Üd”ed_d©a_ex™
()

1142 
	`kmem_ÿche_de¡roy
(
bŒfs_Üd”ed_ex‹Á_ÿche
);

1143 
	}
}

	@ordered-data.h

19 #iâdeà
__BTRFS_ORDERED_DATA__


20 
	#__BTRFS_ORDERED_DATA__


	)

23 
	sbŒfs_Üd”ed_šode_Œ“
 {

24 
¥šlock_t
 
	mlock
;

25 
rb_roÙ
 
	mŒ“
;

26 
rb_node
 *
	mÏ¡
;

29 
	sbŒfs_Üd”ed_sum
 {

31 
u64
 
	mby‹Ä
;

36 
	mËn
;

37 
li¡_h—d
 
	mli¡
;

39 
u32
 
	msums
[];

53 
	#BTRFS_ORDERED_IO_DONE
 0

	)

55 
	#BTRFS_ORDERED_COMPLETE
 1

	)

57 
	#BTRFS_ORDERED_NOCOW
 2

	)

59 
	#BTRFS_ORDERED_COMPRESSED
 3

	)

61 
	#BTRFS_ORDERED_PREALLOC
 4

	)

63 
	#BTRFS_ORDERED_DIRECT
 5

	)

65 
	#BTRFS_ORDERED_IOERR
 6

	)

67 
	#BTRFS_ORDERED_UPDATED_ISIZE
 7

	)

70 
	#BTRFS_ORDERED_LOGGED_CSUM
 8

	)

72 
	#BTRFS_ORDERED_TRUNCATED
 9

	)

74 
	#BTRFS_ORDERED_LOGGED
 10

	)

76 
	#BTRFS_ORDERED_PENDING
 11

	)

78 
	#BTRFS_ORDERED_REGULAR
 12

	)

80 
	sbŒfs_Üd”ed_ex‹Á
 {

82 
u64
 
	mfže_off£t
;

85 
u64
 
	m¡¬t
;

88 
u64
 
	mËn
;

91 
u64
 
	mdisk_Ën
;

94 
u64
 
	mby‹s_Ëá
;

101 
u64
 
	mout¡ªdšg_isize
;

107 
u64
 
	mŒunÿ‹d_Ën
;

110 
	mæags
;

113 
	mcom´ess_ty³
;

116 
»fcouÁ_t
 
	m»fs
;

119 
šode
 *
	mšode
;

122 
li¡_h—d
 
	mli¡
;

125 
li¡_h—d
 
	mlog_li¡
;

128 
li¡_h—d
 
	mŒªs_li¡
;

131 
wa™_queue_h—d_t
 
	mwa™
;

134 
rb_node
 
	mrb_node
;

137 
li¡_h—d
 
	mroÙ_ex‹Á_li¡
;

139 
bŒfs_wÜk
 
	mwÜk
;

141 
com¶‘iÚ
 
	mcom¶‘iÚ
;

142 
bŒfs_wÜk
 
	mæush_wÜk
;

143 
li¡_h—d
 
	mwÜk_li¡
;

150 
šlše
 
	$bŒfs_Üd”ed_sum_size
(
bŒfs_fs_šfo
 *
fs_šfo
,

151 
by‹s
)

153 
num_£ùÜs
 = ()
	`DIV_ROUND_UP
(
by‹s
, 
fs_šfo
->
£ùÜsize
);

154  (
bŒfs_Üd”ed_sum
è+ 
num_£ùÜs
 * (
u32
);

155 
	}
}

157 
šlše
 

158 
	$bŒfs_Üd”ed_šode_Œ“_š™
(
bŒfs_Üd”ed_šode_Œ“
 *
t
)

160 
	`¥š_lock_š™
(&
t
->
lock
);

161 
t
->
Œ“
 = 
RB_ROOT
;

162 
t
->
Ï¡
 = 
NULL
;

163 
	}
}

165 
bŒfs_put_Üd”ed_ex‹Á
(
bŒfs_Üd”ed_ex‹Á
 *
’Œy
);

166 
bŒfs_»move_Üd”ed_ex‹Á
(
šode
 *inode,

167 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
);

168 
bŒfs_dec_‹¡_Üd”ed_³ndšg
(
šode
 *inode,

169 
bŒfs_Üd”ed_ex‹Á
 **
ÿched
,

170 
u64
 
fže_off£t
, u64 
io_size
, 
u±od©e
);

171 
bŒfs_dec_‹¡_fœ¡_Üd”ed_³ndšg
(
šode
 *inode,

172 
bŒfs_Üd”ed_ex‹Á
 **
ÿched
,

173 
u64
 *
fže_off£t
, u64 
io_size
,

174 
u±od©e
);

175 
bŒfs_add_Üd”ed_ex‹Á
(
šode
 *šode, 
u64
 
fže_off£t
,

176 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
, 
ty³
);

177 
bŒfs_add_Üd”ed_ex‹Á_dio
(
šode
 *šode, 
u64
 
fže_off£t
,

178 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
, 
ty³
);

179 
bŒfs_add_Üd”ed_ex‹Á_com´ess
(
šode
 *šode, 
u64
 
fže_off£t
,

180 
u64
 
¡¬t
, u64 
Ën
, u64 
disk_Ën
,

181 
ty³
, 
com´ess_ty³
);

182 
bŒfs_add_Üd”ed_sum
(
šode
 *inode,

183 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
,

184 
bŒfs_Üd”ed_sum
 *
sum
);

185 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_lookup_Üd”ed_ex‹Á
(
šode
 *inode,

186 
u64
 
fže_off£t
);

187 
bŒfs_¡¬t_Üd”ed_ex‹Á
(
šode
 *inode,

188 
bŒfs_Üd”ed_ex‹Á
 *
’Œy
, 
wa™
);

189 
bŒfs_wa™_Üd”ed_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
);

190 
bŒfs_Üd”ed_ex‹Á
 *

191 
bŒfs_lookup_fœ¡_Üd”ed_ex‹Á
(
šode
 * inode, 
u64
 
fže_off£t
);

192 
bŒfs_Üd”ed_ex‹Á
 *
bŒfs_lookup_Üd”ed_¿nge
(

193 
bŒfs_šode
 *
šode
,

194 
u64
 
fže_off£t
,

195 
u64
 
Ën
);

196 
boÞ
 
bŒfs_have_Üd”ed_ex‹Ás_š_¿nge
(
šode
 *inode,

197 
u64
 
fže_off£t
,

198 
u64
 
Ën
);

199 
bŒfs_Üd”ed_upd©e_i_size
(
šode
 *šode, 
u64
 
off£t
,

200 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
);

201 
bŒfs_fšd_Üd”ed_sum
(
šode
 *šode, 
u64
 
off£t
, u64 
disk_by‹Ä
,

202 
u32
 *
sum
, 
Ën
);

203 
u64
 
bŒfs_wa™_Üd”ed_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, u64 
Ä
,

204 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
);

205 
u64
 
bŒfs_wa™_Üd”ed_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
, u64 
Ä
,

206 cÚ¡ 
u64
 
¿nge_¡¬t
, cÚ¡ u64 
¿nge_Ën
);

207 
bŒfs_g‘_logged_ex‹Ás
(
bŒfs_šode
 *
šode
,

208 
li¡_h—d
 *
logged_li¡
,

209 cÚ¡ 
loff_t
 
¡¬t
,

210 cÚ¡ 
loff_t
 
’d
);

211 
bŒfs_put_logged_ex‹Ás
(
li¡_h—d
 *
logged_li¡
);

212 
bŒfs_subm™_logged_ex‹Ás
(
li¡_h—d
 *
logged_li¡
,

213 
bŒfs_roÙ
 *
log
);

214 
bŒfs_wa™_logged_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

215 
bŒfs_roÙ
 *
log
, 
u64
 
Œªsid
);

216 
bŒfs_ä“_logged_ex‹Ás
(
bŒfs_roÙ
 *
log
, 
u64
 
Œªsid
);

217 
__š™
 
Üd”ed_d©a_š™
();

218 
Üd”ed_d©a_ex™
();

	@orphan.c

19 
	~"ù»e.h
"

20 
	~"disk-io.h
"

22 
	$bŒfs_š£¹_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

23 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
)

25 
bŒfs_·th
 *
·th
;

26 
bŒfs_key
 
key
;

27 
»t
 = 0;

29 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

30 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

31 
key
.
off£t
 = offset;

33 
·th
 = 
	`bŒfs_®loc_·th
();

34 ià(!
·th
)

35  -
ENOMEM
;

37 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

39 
	`bŒfs_ä“_·th
(
·th
);

40  
»t
;

41 
	}
}

43 
	$bŒfs_d–_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

44 
bŒfs_roÙ
 *
roÙ
, 
u64
 
off£t
)

46 
bŒfs_·th
 *
·th
;

47 
bŒfs_key
 
key
;

48 
»t
 = 0;

50 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

51 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

52 
key
.
off£t
 = offset;

54 
·th
 = 
	`bŒfs_®loc_·th
();

55 ià(!
·th
)

56  -
ENOMEM
;

58 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

59 ià(
»t
 < 0)

60 
out
;

61 ià(
»t
) {

62 
»t
 = -
ENOENT
;

63 
out
;

66 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

68 
out
:

69 
	`bŒfs_ä“_·th
(
·th
);

70  
»t
;

71 
	}
}

	@print-tree.c

19 
	~"ù»e.h
"

20 
	~"disk-io.h
"

21 
	~"´št-Œ“.h
"

23 
	$´št_chunk
(
ex‹Á_bufãr
 *
eb
, 
bŒfs_chunk
 *
chunk
)

25 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
eb
, 
chunk
);

26 
i
;

27 
	`´_šfo
("\t\tchunk†ength %llu owner %lluype %llu‚um_stripes %d\n",

28 
	`bŒfs_chunk_Ëngth
(
eb
, 
chunk
), 
	`bŒfs_chunk_owÃr
(eb, chunk),

29 
	`bŒfs_chunk_ty³
(
eb
, 
chunk
), 
num_¡res
);

30 
i
 = 0 ; i < 
num_¡res
 ; i++) {

31 
	`´_šfo
("\t\t\t¡r%d devid %Îu off£ˆ%Îu\n", 
i
,

32 
	`bŒfs_¡re_devid_Ä
(
eb
, 
chunk
, 
i
),

33 
	`bŒfs_¡re_off£t_Ä
(
eb
, 
chunk
, 
i
));

35 
	}
}

36 
	$´št_dev_™em
(
ex‹Á_bufãr
 *
eb
,

37 
bŒfs_dev_™em
 *
dev_™em
)

39 
	`´_šfo
("\t\tdev item devid %lluotal_bytes %llu bytes used %llu\n",

40 
	`bŒfs_deviû_id
(
eb
, 
dev_™em
),

41 
	`bŒfs_deviû_tÙ®_by‹s
(
eb
, 
dev_™em
),

42 
	`bŒfs_deviû_by‹s_u£d
(
eb
, 
dev_™em
));

43 
	}
}

44 
	$´št_ex‹Á_d©a_»f
(
ex‹Á_bufãr
 *
eb
,

45 
bŒfs_ex‹Á_d©a_»f
 *
»f
)

47 
	`´_cÚt
("extent data backref„oot %llu objectid %llu offset %llu count %u\n",

48 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
eb
, 
»f
),

49 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
eb
, 
»f
),

50 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
eb
, 
»f
),

51 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
eb
, 
»f
));

52 
	}
}

54 
	$´št_ex‹Á_™em
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
, 
ty³
)

56 
bŒfs_ex‹Á_™em
 *
ei
;

57 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

58 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

59 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

60 
bŒfs_disk_key
 
key
;

61 
’d
;

62 
±r
;

63 
u32
 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

64 
u64
 
æags
;

65 
u64
 
off£t
;

66 
»f_šdex
 = 0;

68 ià(
™em_size
 < (*
ei
)) {

69 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


70 
bŒfs_ex‹Á_™em_v0
 *
ei0
;

71 
	`BUG_ON
(
™em_size
 !ð(*
ei0
));

72 
ei0
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_ex‹Á_™em_v0
);

73 
	`´_šfo
("\t\textent„efs %u\n",

74 
	`bŒfs_ex‹Á_»fs_v0
(
eb
, 
ei0
));

77 
	`BUG
();

81 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

82 
æags
 = 
	`bŒfs_ex‹Á_æags
(
eb
, 
ei
);

84 
	`´_šfo
("\t\textent„efs %llu gen %llu flags %llu\n",

85 
	`bŒfs_ex‹Á_»fs
(
eb
, 
ei
), 
	`bŒfs_ex‹Á_g’”©iÚ
(eb,ƒi),

86 
æags
);

88 ià((
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
) &&

89 
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

90 
bŒfs_Œ“_block_šfo
 *
šfo
;

91 
šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

92 
	`bŒfs_Œ“_block_key
(
eb
, 
šfo
, &
key
);

93 
	`´_šfo
("\t\ttree block key (%llu %u %llu)†evel %d\n",

94 
	`bŒfs_disk_key_objeùid
(&
key
), key.
ty³
,

95 
	`bŒfs_disk_key_off£t
(&
key
),

96 
	`bŒfs_Œ“_block_Ëv–
(
eb
, 
šfo
));

97 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
šfo
 + 1);

99 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
ei
 + 1);

102 
±r
 = ()
œef
;

103 
’d
 = ()
ei
 + 
™em_size
;

104 
±r
 < 
’d
) {

105 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

106 
ty³
 = 
	`bŒfs_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
);

107 
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

108 
	`´_šfo
("\t\Œef#%d: ", 
»f_šdex
++);

109 
ty³
) {

110 
BTRFS_TREE_BLOCK_REF_KEY
:

111 
	`´_cÚt
("Œ“ block back»àroÙ %Îu\n", 
off£t
);

113 
BTRFS_SHARED_BLOCK_REF_KEY
:

114 
	`´_cÚt
("sh¬ed block back»à·»Á %Îu\n", 
off£t
);

119 ià(!
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
nodesize
))

120 
	`´_šfo
("\t\t\t(parent %llu is NOT ALIGNEDo‚odesize %llu)\n",

121 
off£t
, ()
eb
->
fs_šfo
->
nodesize
);

123 
BTRFS_EXTENT_DATA_REF_KEY
:

124 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

125 
	`´št_ex‹Á_d©a_»f
(
eb
, 
d»f
);

127 
BTRFS_SHARED_DATA_REF_KEY
:

128 
¤ef
 = (
bŒfs_sh¬ed_d©a_»f
 *)(
œef
 + 1);

129 
	`´_cÚt
("shared data backref…arent %llu count %u\n",

130 
off£t
, 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
eb
, 
¤ef
));

135 ià(!
	`IS_ALIGNED
(
off£t
, 
eb
->
fs_šfo
->
nodesize
))

136 
	`´_šfo
("\t\t\t(parent %llu is NOT ALIGNEDo‚odesize %llu)\n",

137 
off£t
, ()
eb
->
fs_šfo
->
nodesize
);

140 
	`´_cÚt
("(extent %llu has INVALID„efype %d)\n",

141 
eb
->
¡¬t
, 
ty³
);

144 
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(
ty³
);

146 
	`WARN_ON
(
±r
 > 
’d
);

147 
	}
}

149 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


150 
	$´št_ex‹Á_»f_v0
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
)

152 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

154 
»f0
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_ex‹Á_»f_v0
);

155 
	`´štk
("\t\textent back„ef„oot %llu gen %llu owner %llu‚um_refs %lu\n",

156 
	`bŒfs_»f_roÙ_v0
(
eb
, 
»f0
),

157 
	`bŒfs_»f_g’”©iÚ_v0
(
eb
, 
»f0
),

158 
	`bŒfs_»f_objeùid_v0
(
eb
, 
»f0
),

159 ()
	`bŒfs_»f_couÁ_v0
(
eb
, 
»f0
));

160 
	}
}

163 
	$´št_uuid_™em
(
ex‹Á_bufãr
 *
l
, 
off£t
,

164 
u32
 
™em_size
)

166 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

167 
	`´_w¬n
("BTRFS: uuid item with illegal size %lu!\n",

168 ()
™em_size
);

171 
™em_size
) {

172 
__Ë64
 
subvÞ_id
;

174 
	`»ad_ex‹Á_bufãr
(
l
, &
subvÞ_id
, 
off£t
, (subvol_id));

175 
	`´_šfo
("\t\tsubvol_id %llu\n",

176 ()
	`Ë64_to_ýu
(
subvÞ_id
));

177 
™em_size
 -ð(
u64
);

178 
off£t
 +ð(
u64
);

180 
	}
}

182 
	$bŒfs_´št_Ëaf
(
ex‹Á_bufãr
 *
l
)

184 
bŒfs_fs_šfo
 *
fs_šfo
;

185 
i
;

186 
u32
 
ty³
, 
Ä
;

187 
bŒfs_™em
 *
™em
;

188 
bŒfs_roÙ_™em
 *
ri
;

189 
bŒfs_dœ_™em
 *
di
;

190 
bŒfs_šode_™em
 *
ii
;

191 
bŒfs_block_group_™em
 *
bi
;

192 
bŒfs_fže_ex‹Á_™em
 *
fi
;

193 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

194 
bŒfs_sh¬ed_d©a_»f
 *
¤ef
;

195 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
;

196 
bŒfs_key
 
key
;

197 
bŒfs_key
 
found_key
;

199 ià(!
l
)

202 
fs_šfo
 = 
l
->fs_info;

203 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
l
);

205 
	`bŒfs_šfo
(
fs_šfo
, "leaf %lluotal…trs %d free space %d",

206 
	`bŒfs_h—d”_by‹Ä
(
l
), 
Ä
,

207 
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
l
));

208 
i
 = 0 ; i < 
Ä
 ; i++) {

209 
™em
 = 
	`bŒfs_™em_Ä
(
i
);

210 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
i
);

211 
ty³
 = 
key
.type;

212 
	`´_šfo
("\titem %d key (%llu %u %llu) itemoff %d itemsize %d\n",

213 
i
, 
key
.
objeùid
, 
ty³
, key.
off£t
,

214 
	`bŒfs_™em_off£t
(
l
, 
™em
), 
	`bŒfs_™em_size
(l, item));

215 
ty³
) {

216 
BTRFS_INODE_ITEM_KEY
:

217 
ii
 = 
	`bŒfs_™em_±r
(
l
, 
i
, 
bŒfs_šode_™em
);

218 
	`´_šfo
("\t\tinode generation %llu size %llu mode %o\n",

219 
	`bŒfs_šode_g’”©iÚ
(
l
, 
ii
),

220 
	`bŒfs_šode_size
(
l
, 
ii
),

221 
	`bŒfs_šode_mode
(
l
, 
ii
));

223 
BTRFS_DIR_ITEM_KEY
:

224 
di
 = 
	`bŒfs_™em_±r
(
l
, 
i
, 
bŒfs_dœ_™em
);

225 
	`bŒfs_dœ_™em_key_to_ýu
(
l
, 
di
, &
found_key
);

226 
	`´_šfo
("\t\tdir oid %lluype %u\n",

227 
found_key
.
objeùid
,

228 
	`bŒfs_dœ_ty³
(
l
, 
di
));

230 
BTRFS_ROOT_ITEM_KEY
:

231 
ri
 = 
	`bŒfs_™em_±r
(
l
, 
i
, 
bŒfs_roÙ_™em
);

232 
	`´_šfo
("\t\troot data bytenr %llu„efs %u\n",

233 
	`bŒfs_disk_roÙ_by‹Ä
(
l
, 
ri
),

234 
	`bŒfs_disk_roÙ_»fs
(
l
, 
ri
));

236 
BTRFS_EXTENT_ITEM_KEY
:

237 
BTRFS_METADATA_ITEM_KEY
:

238 
	`´št_ex‹Á_™em
(
l
, 
i
, 
ty³
);

240 
BTRFS_TREE_BLOCK_REF_KEY
:

241 
	`´_šfo
("\t\ttree block backref\n");

243 
BTRFS_SHARED_BLOCK_REF_KEY
:

244 
	`´_šfo
("\t\tshared block backref\n");

246 
BTRFS_EXTENT_DATA_REF_KEY
:

247 
d»f
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

248 
bŒfs_ex‹Á_d©a_»f
);

249 
	`´št_ex‹Á_d©a_»f
(
l
, 
d»f
);

251 
BTRFS_SHARED_DATA_REF_KEY
:

252 
¤ef
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

253 
bŒfs_sh¬ed_d©a_»f
);

254 
	`´_šfo
("\t\tshared data backref count %u\n",

255 
	`bŒfs_sh¬ed_d©a_»f_couÁ
(
l
, 
¤ef
));

257 
BTRFS_EXTENT_DATA_KEY
:

258 
fi
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

259 
bŒfs_fže_ex‹Á_™em
);

260 ià(
	`bŒfs_fže_ex‹Á_ty³
(
l
, 
fi
) ==

261 
BTRFS_FILE_EXTENT_INLINE
) {

262 
	`´_šfo
("\t\tinlineƒxtent data size %u\n",

263 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
l
, 
i
, 
fi
));

266 
	`´_šfo
("\t\textent data disk bytenr %llu‚r %llu\n",

267 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
l
, 
fi
),

268 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
l
, 
fi
));

269 
	`´_šfo
("\t\textent data offset %llu‚r %llu„am %llu\n",

270 
	`bŒfs_fže_ex‹Á_off£t
(
l
, 
fi
),

271 
	`bŒfs_fže_ex‹Á_num_by‹s
(
l
, 
fi
),

272 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
l
, 
fi
));

274 
BTRFS_EXTENT_REF_V0_KEY
:

275 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


276 
	`´št_ex‹Á_»f_v0
(
l
, 
i
);

278 
	`BUG
();

281 
BTRFS_BLOCK_GROUP_ITEM_KEY
:

282 
bi
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

283 
bŒfs_block_group_™em
);

284 
	`´_šfo
(

286 
	`bŒfs_disk_block_group_u£d
(
l
, 
bi
),

287 
	`bŒfs_disk_block_group_chunk_objeùid
(
l
, 
bi
),

288 
	`bŒfs_disk_block_group_æags
(
l
, 
bi
));

290 
BTRFS_CHUNK_ITEM_KEY
:

291 
	`´št_chunk
(
l
, 
	`bŒfs_™em_±r
Ö, 
i
,

292 
bŒfs_chunk
));

294 
BTRFS_DEV_ITEM_KEY
:

295 
	`´št_dev_™em
(
l
, 
	`bŒfs_™em_±r
Ö, 
i
,

296 
bŒfs_dev_™em
));

298 
BTRFS_DEV_EXTENT_KEY
:

299 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
i
,

300 
bŒfs_dev_ex‹Á
);

301 
	`´_šfo
("\t\tdevƒxtent chunk_tree %llu\n\t\tchunk objectid %llu chunk offset %llu†ength %llu\n",

302 
	`bŒfs_dev_ex‹Á_chunk_Œ“
(
l
, 
dev_ex‹Á
),

303 
	`bŒfs_dev_ex‹Á_chunk_objeùid
(
l
, 
dev_ex‹Á
),

304 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
l
, 
dev_ex‹Á
),

305 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
, 
dev_ex‹Á
));

307 
BTRFS_PERSISTENT_ITEM_KEY
:

308 
	`´_šfo
("\t\tpersistent item objectid %llu offset %llu\n",

309 
key
.
objeùid
, key.
off£t
);

310 
key
.
objeùid
) {

311 
BTRFS_DEV_STATS_OBJECTID
:

312 
	`´_šfo
("\t\tdevice stats\n");

315 
	`´_šfo
("\t\tunknown…ersistent item\n");

318 
BTRFS_TEMPORARY_ITEM_KEY
:

319 
	`´_šfo
("\t\ttemporary item objectid %llu offset %llu\n",

320 
key
.
objeùid
, key.
off£t
);

321 
key
.
objeùid
) {

322 
BTRFS_BALANCE_OBJECTID
:

323 
	`´_šfo
("\t\tbalance status\n");

326 
	`´_šfo
("\t\tunknownemporary item\n");

329 
BTRFS_DEV_REPLACE_KEY
:

330 
	`´_šfo
("\t\tdev„eplace\n");

332 
BTRFS_UUID_KEY_SUBVOL
:

333 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
:

334 
	`´št_uuid_™em
(
l
, 
	`bŒfs_™em_±r_off£t
Ö, 
i
),

335 
	`bŒfs_™em_size_Ä
(
l
, 
i
));

339 
	}
}

341 
	$bŒfs_´št_Œ“
(
ex‹Á_bufãr
 *
c
)

343 
bŒfs_fs_šfo
 *
fs_šfo
;

344 
i
; 
u32
 
Ä
;

345 
bŒfs_key
 
key
;

346 
Ëv–
;

348 ià(!
c
)

350 
fs_šfo
 = 
c
->fs_info;

351 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
c
);

352 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
c
);

353 ià(
Ëv–
 == 0) {

354 
	`bŒfs_´št_Ëaf
(
c
);

357 
	`bŒfs_šfo
(
fs_šfo
,

359 
	`bŒfs_h—d”_by‹Ä
(
c
), 
Ëv–
, 
Ä
,

360 (
u32
)
	`BTRFS_NODEPTRS_PER_BLOCK
(
fs_šfo
è- 
Ä
);

361 
i
 = 0; i < 
Ä
; i++) {

362 
	`bŒfs_node_key_to_ýu
(
c
, &
key
, 
i
);

363 
	`´_šfo
("\tkey %d (%llu %u %llu) block %llu\n",

364 
i
, 
key
.
objeùid
, key.
ty³
, key.
off£t
,

365 
	`bŒfs_node_block±r
(
c
, 
i
));

367 
i
 = 0; i < 
Ä
; i++) {

368 
ex‹Á_bufãr
 *
Ãxt
 = 
	`»ad_Œ“_block
(
fs_šfo
,

369 
	`bŒfs_node_block±r
(
c
, 
i
),

370 
	`bŒfs_node_±r_g’”©iÚ
(
c
, 
i
));

371 ià(
	`IS_ERR
(
Ãxt
)) {

373 } ià(!
	`ex‹Á_bufãr_u±od©e
(
Ãxt
)) {

374 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

378 ià(
	`bŒfs_is_Ëaf
(
Ãxt
) &&

379 
Ëv–
 != 1)

380 
	`BUG
();

381 ià(
	`bŒfs_h—d”_Ëv–
(
Ãxt
) !=

382 
Ëv–
 - 1)

383 
	`BUG
();

384 
	`bŒfs_´št_Œ“
(
Ãxt
);

385 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

387 
	}
}

	@print-tree.h

19 #iâdeà
__PRINT_TREE_


20 
	#__PRINT_TREE_


	)

21 
bŒfs_´št_Ëaf
(
ex‹Á_bufãr
 *
l
);

22 
bŒfs_´št_Œ“
(
ex‹Á_bufãr
 *
c
);

	@props.c

19 
	~<lšux/hashbË.h
>

20 
	~"´Ýs.h
"

21 
	~"bŒfs_šode.h
"

22 
	~"hash.h
"

23 
	~"Œª§ùiÚ.h
"

24 
	~"x©Œ.h
"

25 
	~"com´essiÚ.h
"

27 
	#BTRFS_PROP_HANDLERS_HT_BITS
 8

	)

28 
DEFINE_HASHTABLE
(
´Ý_hªdËrs_ht
, 
BTRFS_PROP_HANDLERS_HT_BITS
);

30 
	s´Ý_hªdËr
 {

31 
hli¡_node
 
	mnode
;

32 cÚ¡ *
	mx©Œ_Çme
;

33 (*
	mv®id©e
)(cÚ¡ *
	mv®ue
, 
size_t
 
	mËn
);

34 (*
	m­¶y
)(
šode
 *
	mšode
, cÚ¡ *
	mv®ue
, 
size_t
 
	mËn
);

35 cÚ¡ *(*
	mexŒaù
)(
šode
 *
	mšode
);

36 
	mšh”™abË
;

39 
´Ý_com´essiÚ_v®id©e
(cÚ¡ *
v®ue
, 
size_t
 
Ën
);

40 
´Ý_com´essiÚ_­¶y
(
šode
 *inode,

41 cÚ¡ *
v®ue
,

42 
size_t
 
Ën
);

43 cÚ¡ *
´Ý_com´essiÚ_exŒaù
(
šode
 *inode);

45 
´Ý_hªdËr
 
	g´Ý_hªdËrs
[] = {

47 .
x©Œ_Çme
 = 
XATTR_BTRFS_PREFIX
 "compression",

48 .
	gv®id©e
 = 
´Ý_com´essiÚ_v®id©e
,

49 .
	g­¶y
 = 
´Ý_com´essiÚ_­¶y
,

50 .
	gexŒaù
 = 
´Ý_com´essiÚ_exŒaù
,

51 .
	gšh”™abË
 = 1

55 
__š™
 
	$bŒfs_´Ýs_š™
()

57 
i
;

59 
	`hash_š™
(
´Ý_hªdËrs_ht
);

61 
i
 = 0; i < 
	`ARRAY_SIZE
(
´Ý_hªdËrs
); i++) {

62 
´Ý_hªdËr
 *
p
 = &
´Ý_hªdËrs
[
i
];

63 
u64
 
h
 = 
	`bŒfs_Çme_hash
(
p
->
x©Œ_Çme
, 
	`¡¾’
(p->xattr_name));

65 
	`hash_add
(
´Ý_hªdËrs_ht
, &
p
->
node
, 
h
);

67 
	}
}

69 cÚ¡ 
hli¡_h—d
 *
	$fšd_´Ý_hªdËrs_by_hash
(cÚ¡ 
u64
 
hash
)

71 
hli¡_h—d
 *
h
;

73 
h
 = &
´Ý_hªdËrs_ht
[
	`hash_mš
(
hash
, 
BTRFS_PROP_HANDLERS_HT_BITS
)];

74 ià(
	`hli¡_em±y
(
h
))

75  
NULL
;

77  
h
;

78 
	}
}

80 cÚ¡ 
´Ý_hªdËr
 *

81 
	$fšd_´Ý_hªdËr
(cÚ¡ *
Çme
,

82 cÚ¡ 
hli¡_h—d
 *
hªdËrs
)

84 
´Ý_hªdËr
 *
h
;

86 ià(!
hªdËrs
) {

87 
u64
 
hash
 = 
	`bŒfs_Çme_hash
(
Çme
, 
	`¡¾’
(name));

89 
hªdËrs
 = 
	`fšd_´Ý_hªdËrs_by_hash
(
hash
);

90 ià(!
hªdËrs
)

91  
NULL
;

94 
	`hli¡_fÜ_—ch_’Œy
(
h
, 
hªdËrs
, 
node
)

95 ià(!
	`¡rcmp
(
h
->
x©Œ_Çme
, 
Çme
))

96  
h
;

98  
NULL
;

99 
	}
}

101 
	$__bŒfs_£t_´Ý
(
bŒfs_Œªs_hªdË
 *
Œªs
,

102 
šode
 *inode,

103 cÚ¡ *
Çme
,

104 cÚ¡ *
v®ue
,

105 
size_t
 
v®ue_Ën
,

106 
æags
)

108 cÚ¡ 
´Ý_hªdËr
 *
hªdËr
;

109 
»t
;

111 ià(
	`¡¾’
(
Çme
è<ð
XATTR_BTRFS_PREFIX_LEN
)

112  -
EINVAL
;

114 
hªdËr
 = 
	`fšd_´Ý_hªdËr
(
Çme
, 
NULL
);

115 ià(!
hªdËr
)

116  -
EINVAL
;

118 ià(
v®ue_Ën
 == 0) {

119 
»t
 = 
	`__bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
hªdËr
->
x©Œ_Çme
,

120 
NULL
, 0, 
æags
);

121 ià(
»t
)

122  
»t
;

124 
»t
 = 
hªdËr
->
	`­¶y
(
šode
, 
NULL
, 0);

125 
	`ASSERT
(
»t
 == 0);

127  
»t
;

130 
»t
 = 
hªdËr
->
	`v®id©e
(
v®ue
, 
v®ue_Ën
);

131 ià(
»t
)

132  
»t
;

133 
»t
 = 
	`__bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
hªdËr
->
x©Œ_Çme
,

134 
v®ue
, 
v®ue_Ën
, 
æags
);

135 ià(
»t
)

136  
»t
;

137 
»t
 = 
hªdËr
->
	`­¶y
(
šode
, 
v®ue
, 
v®ue_Ën
);

138 ià(
»t
) {

139 
	`__bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
hªdËr
->
x©Œ_Çme
,

140 
NULL
, 0, 
æags
);

141  
»t
;

144 
	`£t_b™
(
BTRFS_INODE_HAS_PROPS
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

147 
	}
}

149 
	$bŒfs_£t_´Ý
(
šode
 *inode,

150 cÚ¡ *
Çme
,

151 cÚ¡ *
v®ue
,

152 
size_t
 
v®ue_Ën
,

153 
æags
)

155  
	`__bŒfs_£t_´Ý
(
NULL
, 
šode
, 
Çme
, 
v®ue
, 
v®ue_Ën
, 
æags
);

156 
	}
}

158 
	$™”©e_objeù_´Ýs
(
bŒfs_roÙ
 *
roÙ
,

159 
bŒfs_·th
 *
·th
,

160 
u64
 
objeùid
,

161 (*
™”©Ü
)(*,

162 cÚ¡ 
´Ý_hªdËr
 *,

164 
size_t
),

165 *
ùx
)

167 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

168 
»t
;

169 *
Çme_buf
 = 
NULL
;

170 *
v®ue_buf
 = 
NULL
;

171 
Çme_buf_Ën
 = 0;

172 
v®ue_buf_Ën
 = 0;

175 
bŒfs_key
 
key
;

176 
bŒfs_dœ_™em
 *
di
;

177 
ex‹Á_bufãr
 *
Ëaf
;

178 
u32
 
tÙ®_Ën
, 
cur
, 
this_Ën
;

179 
¦Ù
;

180 cÚ¡ 
hli¡_h—d
 *
hªdËrs
;

182 
¦Ù
 = 
·th
->
¦Ùs
[0];

183 
Ëaf
 = 
·th
->
nodes
[0];

185 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

186 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

187 ià(
»t
 < 0)

188 
out
;

189 ià(
»t
 > 0)

194 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

195 ià(
key
.
objeùid
 != objectid)

197 ià(
key
.
ty³
 !ð
BTRFS_XATTR_ITEM_KEY
)

200 
hªdËrs
 = 
	`fšd_´Ý_hªdËrs_by_hash
(
key
.
off£t
);

201 ià(!
hªdËrs
)

202 
Ãxt_¦Ù
;

204 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dœ_™em
);

205 
cur
 = 0;

206 
tÙ®_Ën
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

208 
cur
 < 
tÙ®_Ën
) {

209 
u32
 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

210 
u32
 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

211 
Çme_±r
, 
d©a_±r
;

212 cÚ¡ 
´Ý_hªdËr
 *
hªdËr
;

214 
this_Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

215 
Çme_±r
 = ()(
di
 + 1);

216 
d©a_±r
 = 
Çme_±r
 + 
Çme_Ën
;

218 ià(
	`v”ify_dœ_™em
(
fs_šfo
, 
Ëaf
,

219 
·th
->
¦Ùs
[0], 
di
)) {

220 
»t
 = -
EIO
;

221 
out
;

224 ià(
Çme_Ën
 <ð
XATTR_BTRFS_PREFIX_LEN
 ||

225 
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
XATTR_BTRFS_PREFIX
,

226 
Çme_±r
,

227 
XATTR_BTRFS_PREFIX_LEN
))

228 
Ãxt_dœ_™em
;

230 ià(
Çme_Ën
 >ð
Çme_buf_Ën
) {

231 
	`kä“
(
Çme_buf
);

232 
Çme_buf_Ën
 = 
Çme_Ën
 + 1;

233 
Çme_buf
 = 
	`km®loc
(
Çme_buf_Ën
, 
GFP_NOFS
);

234 ià(!
Çme_buf
) {

235 
»t
 = -
ENOMEM
;

236 
out
;

239 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme_buf
, 
Çme_±r
, 
Çme_Ën
);

240 
Çme_buf
[
Çme_Ën
] = '\0';

242 
hªdËr
 = 
	`fšd_´Ý_hªdËr
(
Çme_buf
, 
hªdËrs
);

243 ià(!
hªdËr
)

244 
Ãxt_dœ_™em
;

246 ià(
d©a_Ën
 > 
v®ue_buf_Ën
) {

247 
	`kä“
(
v®ue_buf
);

248 
v®ue_buf_Ën
 = 
d©a_Ën
;

249 
v®ue_buf
 = 
	`km®loc
(
d©a_Ën
, 
GFP_NOFS
);

250 ià(!
v®ue_buf
) {

251 
»t
 = -
ENOMEM
;

252 
out
;

255 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
v®ue_buf
, 
d©a_±r
, 
d©a_Ën
);

257 
	`™”©Ü
(
ùx
, 
hªdËr
, 
v®ue_buf
, 
d©a_Ën
);

258 
Ãxt_dœ_™em
:

259 
cur
 +ð
this_Ën
;

260 
di
 = (
bŒfs_dœ_™em
 *)((*èd˜+ 
this_Ën
);

263 
Ãxt_¦Ù
:

264 
·th
->
¦Ùs
[0]++;

267 
»t
 = 0;

268 
out
:

269 
	`bŒfs_»Ëa£_·th
(
·th
);

270 
	`kä“
(
Çme_buf
);

271 
	`kä“
(
v®ue_buf
);

273  
»t
;

274 
	}
}

276 
	$šode_´Ý_™”©Ü
(*
ùx
,

277 cÚ¡ 
´Ý_hªdËr
 *
hªdËr
,

278 cÚ¡ *
v®ue
,

279 
size_t
 
Ën
)

281 
šode
 *šodð
ùx
;

282 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

283 
»t
;

285 
»t
 = 
hªdËr
->
	`­¶y
(
šode
, 
v®ue
, 
Ën
);

286 ià(
	`uÆik–y
(
»t
))

287 
	`bŒfs_w¬n
(
roÙ
->
fs_šfo
,

289 
hªdËr
->
x©Œ_Çme
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

290 
roÙ
->
roÙ_key
.
objeùid
, 
»t
);

292 
	`£t_b™
(
BTRFS_INODE_HAS_PROPS
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

293 
	}
}

295 
	$bŒfs_lßd_šode_´Ýs
(
šode
 *šode, 
bŒfs_·th
 *
·th
)

297 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

298 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

299 
»t
;

301 
»t
 = 
	`™”©e_objeù_´Ýs
(
roÙ
, 
·th
, 
šo
, 
šode_´Ý_™”©Ü
, 
šode
);

303  
»t
;

304 
	}
}

306 
	$šh”™_´Ýs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

307 
šode
 *inode,

308 
šode
 *
·»Á
)

310 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

311 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

312 
»t
;

313 
i
;

315 ià(!
	`‹¡_b™
(
BTRFS_INODE_HAS_PROPS
,

316 &
	`BTRFS_I
(
·»Á
)->
ruÁime_æags
))

319 
i
 = 0; i < 
	`ARRAY_SIZE
(
´Ý_hªdËrs
); i++) {

320 cÚ¡ 
´Ý_hªdËr
 *
h
 = &
´Ý_hªdËrs
[
i
];

321 cÚ¡ *
v®ue
;

322 
u64
 
num_by‹s
;

324 ià(!
h
->
šh”™abË
)

327 
v®ue
 = 
h
->
	`exŒaù
(
·»Á
);

328 ià(!
v®ue
)

331 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 1);

332 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, 
Œªs
->
block_rsv
,

333 
num_by‹s
, 
BTRFS_RESERVE_NO_FLUSH
);

334 ià(
»t
)

335 
out
;

336 
»t
 = 
	`__bŒfs_£t_´Ý
(
Œªs
, 
šode
, 
h
->
x©Œ_Çme
,

337 
v®ue
, 
	`¡¾’
(value), 0);

338 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
Œªs
->
block_rsv
, 
num_by‹s
);

339 ià(
»t
)

340 
out
;

342 
»t
 = 0;

343 
out
:

344  
»t
;

345 
	}
}

347 
	$bŒfs_šode_šh”™_´Ýs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

348 
šode
 *inode,

349 
šode
 *
dœ
)

351 ià(!
dœ
)

354  
	`šh”™_´Ýs
(
Œªs
, 
šode
, 
dœ
);

355 
	}
}

357 
	$bŒfs_subvÞ_šh”™_´Ýs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

358 
bŒfs_roÙ
 *
roÙ
,

359 
bŒfs_roÙ
 *
·»Á_roÙ
)

361 
su³r_block
 *
sb
 = 
roÙ
->
fs_šfo
->sb;

362 
bŒfs_key
 
key
;

363 
šode
 *
·»Á_šode
, *
chžd_šode
;

364 
»t
;

366 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

367 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

368 
key
.
off£t
 = 0;

370 
·»Á_šode
 = 
	`bŒfs_ig‘
(
sb
, &
key
, 
·»Á_roÙ
, 
NULL
);

371 ià(
	`IS_ERR
(
·»Á_šode
))

372  
	`PTR_ERR
(
·»Á_šode
);

374 
chžd_šode
 = 
	`bŒfs_ig‘
(
sb
, &
key
, 
roÙ
, 
NULL
);

375 ià(
	`IS_ERR
(
chžd_šode
)) {

376 
	`ut
(
·»Á_šode
);

377  
	`PTR_ERR
(
chžd_šode
);

380 
»t
 = 
	`šh”™_´Ýs
(
Œªs
, 
chžd_šode
, 
·»Á_šode
);

381 
	`ut
(
chžd_šode
);

382 
	`ut
(
·»Á_šode
);

384  
»t
;

385 
	}
}

387 
	$´Ý_com´essiÚ_v®id©e
(cÚ¡ *
v®ue
, 
size_t
 
Ën
)

389 ià(!
	`¡ºcmp
("lzo", 
v®ue
, 
Ën
))

391 ià(!
	`¡ºcmp
("zlib", 
v®ue
, 
Ën
))

393 ià(!
	`¡ºcmp
("z¡d", 
v®ue
, 
Ën
))

396  -
EINVAL
;

397 
	}
}

399 
	$´Ý_com´essiÚ_­¶y
(
šode
 *inode,

400 cÚ¡ *
v®ue
,

401 
size_t
 
Ën
)

403 
ty³
;

405 ià(
Ën
 == 0) {

406 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_NOCOMPRESS
;

407 
	`BTRFS_I
(
šode
)->
æags
 &ð~
BTRFS_INODE_COMPRESS
;

408 
	`BTRFS_I
(
šode
)->
´Ý_com´ess
 = 
BTRFS_COMPRESS_NONE
;

413 ià(!
	`¡ºcmp
("lzo", 
v®ue
, 3))

414 
ty³
 = 
BTRFS_COMPRESS_LZO
;

415 ià(!
	`¡ºcmp
("zlib", 
v®ue
, 4))

416 
ty³
 = 
BTRFS_COMPRESS_ZLIB
;

417 ià(!
	`¡ºcmp
("z¡d", 
v®ue
, 
Ën
))

418 
ty³
 = 
BTRFS_COMPRESS_ZSTD
;

420  -
EINVAL
;

422 
	`BTRFS_I
(
šode
)->
æags
 &ð~
BTRFS_INODE_NOCOMPRESS
;

423 
	`BTRFS_I
(
šode
)->
æags
 |ð
BTRFS_INODE_COMPRESS
;

424 
	`BTRFS_I
(
šode
)->
´Ý_com´ess
 = 
ty³
;

427 
	}
}

429 cÚ¡ *
	$´Ý_com´essiÚ_exŒaù
(
šode
 *inode)

431 
	`BTRFS_I
(
šode
)->
´Ý_com´ess
) {

432 
BTRFS_COMPRESS_ZLIB
:

434 
BTRFS_COMPRESS_LZO
:

436 
BTRFS_COMPRESS_ZSTD
:

440  
NULL
;

441 
	}
}

	@props.h

19 #iâdeà
__BTRFS_PROPS_H


20 
	#__BTRFS_PROPS_H


	)

22 
	~"ù»e.h
"

24 
__š™
 
bŒfs_´Ýs_š™
();

26 
bŒfs_£t_´Ý
(
šode
 *inode,

27 cÚ¡ *
Çme
,

28 cÚ¡ *
v®ue
,

29 
size_t
 
v®ue_Ën
,

30 
æags
);

32 
bŒfs_lßd_šode_´Ýs
(
šode
 *šode, 
bŒfs_·th
 *
·th
);

34 
bŒfs_šode_šh”™_´Ýs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

35 
šode
 *inode,

36 
šode
 *
dœ
);

38 
bŒfs_subvÞ_šh”™_´Ýs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

39 
bŒfs_roÙ
 *
roÙ
,

40 
bŒfs_roÙ
 *
·»Á_roÙ
);

	@qgroup.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/·gem­.h
>

21 
	~<lšux/wr™eback.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/rbŒ“.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/wÜkqueue.h
>

26 
	~<lšux/bŒfs.h
>

28 
	~"ù»e.h
"

29 
	~"Œª§ùiÚ.h
"

30 
	~"disk-io.h
"

31 
	~"lockšg.h
"

32 
	~"uli¡.h
"

33 
	~"back»f.h
"

34 
	~"ex‹Á_io.h
"

35 
	~"qgroup.h
"

50 
	$bŒfs_qgroup_upd©e_Þd_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
,

51 
mod
)

53 ià(
qg
->
Þd_»fút
 < 
£q
)

54 
qg
->
Þd_»fút
 = 
£q
;

55 
qg
->
Þd_»fút
 +ð
mod
;

56 
	}
}

58 
	$bŒfs_qgroup_upd©e_Ãw_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
,

59 
mod
)

61 ià(
qg
->
Ãw_»fút
 < 
£q
)

62 
qg
->
Ãw_»fút
 = 
£q
;

63 
qg
->
Ãw_»fút
 +ð
mod
;

64 
	}
}

66 
šlše
 
u64
 
	$bŒfs_qgroup_g‘_Þd_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
)

68 ià(
qg
->
Þd_»fút
 < 
£q
)

70  
qg
->
Þd_»fút
 - 
£q
;

71 
	}
}

73 
šlše
 
u64
 
	$bŒfs_qgroup_g‘_Ãw_»fút
(
bŒfs_qgroup
 *
qg
, 
u64
 
£q
)

75 ià(
qg
->
Ãw_»fút
 < 
£q
)

77  
qg
->
Ãw_»fút
 - 
£q
;

78 
	}
}

83 
	sbŒfs_qgroup_li¡
 {

84 
li¡_h—d
 
	mÃxt_group
;

85 
li¡_h—d
 
	mÃxt_memb”
;

86 
bŒfs_qgroup
 *
	mgroup
;

87 
bŒfs_qgroup
 *
	mmemb”
;

90 
šlše
 
u64
 
	$qgroup_to_aux
(
bŒfs_qgroup
 *
qg
)

92  (
u64
)(
ušŒ_t
)
qg
;

93 
	}
}

95 
šlše
 
bŒfs_qgroup
* 
	$unode_aux_to_qgroup
(
uli¡_node
 *
n
)

97  (
bŒfs_qgroup
 *)(
ušŒ_t
)
n
->
aux
;

98 
	}
}

101 
qgroup_»sÿn_š™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
´og»ss_objeùid
,

102 
š™_æags
);

103 
qgroup_»sÿn_z”o_Œackšg
(
bŒfs_fs_šfo
 *
fs_šfo
);

106 
bŒfs_qgroup
 *
	$fšd_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

107 
u64
 
qgroupid
)

109 
rb_node
 *
n
 = 
fs_šfo
->
qgroup_Œ“
.rb_node;

110 
bŒfs_qgroup
 *
qgroup
;

112 
n
) {

113 
qgroup
 = 
	`rb_’Œy
(
n
, 
bŒfs_qgroup
, 
node
);

114 ià(
qgroup
->
qgroupid
 < qgroupid)

115 
n
 =‚->
rb_Ëá
;

116 ià(
qgroup
->
qgroupid
 > qgroupid)

117 
n
 =‚->
rb_right
;

119  
qgroup
;

121  
NULL
;

122 
	}
}

125 
bŒfs_qgroup
 *
	$add_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

126 
u64
 
qgroupid
)

128 
rb_node
 **
p
 = &
fs_šfo
->
qgroup_Œ“
.rb_node;

129 
rb_node
 *
·»Á
 = 
NULL
;

130 
bŒfs_qgroup
 *
qgroup
;

132 *
p
) {

133 
·»Á
 = *
p
;

134 
qgroup
 = 
	`rb_’Œy
(
·»Á
, 
bŒfs_qgroup
, 
node
);

136 ià(
qgroup
->
qgroupid
 < qgroupid)

137 
p
 = &(*p)->
rb_Ëá
;

138 ià(
qgroup
->
qgroupid
 > qgroupid)

139 
p
 = &(*p)->
rb_right
;

141  
qgroup
;

144 
qgroup
 = 
	`kz®loc
((*qgroup), 
GFP_ATOMIC
);

145 ià(!
qgroup
)

146  
	`ERR_PTR
(-
ENOMEM
);

148 
qgroup
->
qgroupid
 = qgroupid;

149 
	`INIT_LIST_HEAD
(&
qgroup
->
groups
);

150 
	`INIT_LIST_HEAD
(&
qgroup
->
memb”s
);

151 
	`INIT_LIST_HEAD
(&
qgroup
->
dœty
);

153 
	`rb_lšk_node
(&
qgroup
->
node
, 
·»Á
, 
p
);

154 
	`rb_š£¹_cÞÜ
(&
qgroup
->
node
, &
fs_šfo
->
qgroup_Œ“
);

156  
qgroup
;

157 
	}
}

159 
	$__d–_qgroup_rb
(
bŒfs_qgroup
 *
qgroup
)

161 
bŒfs_qgroup_li¡
 *
li¡
;

163 
	`li¡_d–
(&
qgroup
->
dœty
);

164 !
	`li¡_em±y
(&
qgroup
->
groups
)) {

165 
li¡
 = 
	`li¡_fœ¡_’Œy
(&
qgroup
->
groups
,

166 
bŒfs_qgroup_li¡
, 
Ãxt_group
);

167 
	`li¡_d–
(&
li¡
->
Ãxt_group
);

168 
	`li¡_d–
(&
li¡
->
Ãxt_memb”
);

169 
	`kä“
(
li¡
);

172 !
	`li¡_em±y
(&
qgroup
->
memb”s
)) {

173 
li¡
 = 
	`li¡_fœ¡_’Œy
(&
qgroup
->
memb”s
,

174 
bŒfs_qgroup_li¡
, 
Ãxt_memb”
);

175 
	`li¡_d–
(&
li¡
->
Ãxt_group
);

176 
	`li¡_d–
(&
li¡
->
Ãxt_memb”
);

177 
	`kä“
(
li¡
);

179 
	`kä“
(
qgroup
);

180 
	}
}

183 
	$d–_qgroup_rb
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
)

185 
bŒfs_qgroup
 *
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

187 ià(!
qgroup
)

188  -
ENOENT
;

190 
	`rb_”a£
(&
qgroup
->
node
, &
fs_šfo
->
qgroup_Œ“
);

191 
	`__d–_qgroup_rb
(
qgroup
);

193 
	}
}

196 
	$add_»ÏtiÚ_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

197 
u64
 
memb”id
, u64 
·»Áid
)

199 
bŒfs_qgroup
 *
memb”
;

200 
bŒfs_qgroup
 *
·»Á
;

201 
bŒfs_qgroup_li¡
 *
li¡
;

203 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
memb”id
);

204 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
·»Áid
);

205 ià(!
memb”
 || !
·»Á
)

206  -
ENOENT
;

208 
li¡
 = 
	`kz®loc
((*li¡), 
GFP_ATOMIC
);

209 ià(!
li¡
)

210  -
ENOMEM
;

212 
li¡
->
group
 = 
·»Á
;

213 
li¡
->
memb”
 = member;

214 
	`li¡_add_ž
(&
li¡
->
Ãxt_group
, &
memb”
->
groups
);

215 
	`li¡_add_ž
(&
li¡
->
Ãxt_memb”
, &
·»Á
->
memb”s
);

218 
	}
}

221 
	$d–_»ÏtiÚ_rb
(
bŒfs_fs_šfo
 *
fs_šfo
,

222 
u64
 
memb”id
, u64 
·»Áid
)

224 
bŒfs_qgroup
 *
memb”
;

225 
bŒfs_qgroup
 *
·»Á
;

226 
bŒfs_qgroup_li¡
 *
li¡
;

228 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
memb”id
);

229 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
·»Áid
);

230 ià(!
memb”
 || !
·»Á
)

231  -
ENOENT
;

233 
	`li¡_fÜ_—ch_’Œy
(
li¡
, &
memb”
->
groups
, 
Ãxt_group
) {

234 ià(
li¡
->
group
 =ð
·»Á
) {

235 
	`li¡_d–
(&
li¡
->
Ãxt_group
);

236 
	`li¡_d–
(&
li¡
->
Ãxt_memb”
);

237 
	`kä“
(
li¡
);

241  -
ENOENT
;

242 
	}
}

244 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


245 
	$bŒfs_v”ify_qgroup_couÁs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
,

246 
u64
 
rãr
, u64 
exþ
)

248 
bŒfs_qgroup
 *
qgroup
;

250 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

251 ià(!
qgroup
)

252  -
EINVAL
;

253 ià(
qgroup
->
rãr
 !ðrã¸|| qgroup->
exþ
 !=ƒxcl)

254  -
EINVAL
;

256 
	}
}

263 
	$bŒfs_»ad_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
)

265 
bŒfs_key
 
key
;

266 
bŒfs_key
 
found_key
;

267 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
fs_šfo
->quota_root;

268 
bŒfs_·th
 *
·th
 = 
NULL
;

269 
ex‹Á_bufãr
 *
l
;

270 
¦Ù
;

271 
»t
 = 0;

272 
u64
 
æags
 = 0;

273 
u64
 
»sÿn_´og»ss
 = 0;

275 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

278 
fs_šfo
->
qgroup_uli¡
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

279 ià(!
fs_šfo
->
qgroup_uli¡
) {

280 
»t
 = -
ENOMEM
;

281 
out
;

284 
·th
 = 
	`bŒfs_®loc_·th
();

285 ià(!
·th
) {

286 
»t
 = -
ENOMEM
;

287 
out
;

291 
fs_šfo
->
qgroup_æags
 = 0;

296 
key
.
objeùid
 = 0;

297 
key
.
ty³
 = 0;

298 
key
.
off£t
 = 0;

299 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
quÙa_roÙ
, &
key
, 
·th
, 1, 1);

300 ià(
»t
)

301 
out
;

304 
bŒfs_qgroup
 *
qgroup
;

306 
¦Ù
 = 
·th
->
¦Ùs
[0];

307 
l
 = 
·th
->
nodes
[0];

308 
	`bŒfs_™em_key_to_ýu
(
l
, &
found_key
, 
¦Ù
);

310 ià(
found_key
.
ty³
 =ð
BTRFS_QGROUP_STATUS_KEY
) {

311 
bŒfs_qgroup_¡©us_™em
 *
±r
;

313 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

314 
bŒfs_qgroup_¡©us_™em
);

316 ià(
	`bŒfs_qgroup_¡©us_v”siÚ
(
l
, 
±r
) !=

317 
BTRFS_QGROUP_STATUS_VERSION
) {

318 
	`bŒfs_”r
(
fs_šfo
,

320 
out
;

322 ià(
	`bŒfs_qgroup_¡©us_g’”©iÚ
(
l
, 
±r
) !=

323 
fs_šfo
->
g’”©iÚ
) {

324 
æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

325 
	`bŒfs_”r
(
fs_šfo
,

328 
fs_šfo
->
qgroup_æags
 = 
	`bŒfs_qgroup_¡©us_æags
(
l
,

329 
±r
);

330 
»sÿn_´og»ss
 = 
	`bŒfs_qgroup_¡©us_»sÿn
(
l
, 
±r
);

331 
Ãxt1
;

334 ià(
found_key
.
ty³
 !ð
BTRFS_QGROUP_INFO_KEY
 &&

335 
found_key
.
ty³
 !ð
BTRFS_QGROUP_LIMIT_KEY
)

336 
Ãxt1
;

338 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
found_key
.
off£t
);

339 ià((
qgroup
 && 
found_key
.
ty³
 =ð
BTRFS_QGROUP_INFO_KEY
) ||

340 (!
qgroup
 && 
found_key
.
ty³
 =ð
BTRFS_QGROUP_LIMIT_KEY
)) {

341 
	`bŒfs_”r
(
fs_šfo
, "inconsistent qgroup config");

342 
æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

344 ià(!
qgroup
) {

345 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
found_key
.
off£t
);

346 ià(
	`IS_ERR
(
qgroup
)) {

347 
»t
 = 
	`PTR_ERR
(
qgroup
);

348 
out
;

351 
found_key
.
ty³
) {

352 
BTRFS_QGROUP_INFO_KEY
: {

353 
bŒfs_qgroup_šfo_™em
 *
±r
;

355 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

356 
bŒfs_qgroup_šfo_™em
);

357 
qgroup
->
rãr
 = 
	`bŒfs_qgroup_šfo_rãr
(
l
, 
±r
);

358 
qgroup
->
rãr_cm´
 = 
	`bŒfs_qgroup_šfo_rãr_cm´
(
l
, 
±r
);

359 
qgroup
->
exþ
 = 
	`bŒfs_qgroup_šfo_exþ
(
l
, 
±r
);

360 
qgroup
->
exþ_cm´
 = 
	`bŒfs_qgroup_šfo_exþ_cm´
(
l
, 
±r
);

364 
BTRFS_QGROUP_LIMIT_KEY
: {

365 
bŒfs_qgroup_lim™_™em
 *
±r
;

367 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

368 
bŒfs_qgroup_lim™_™em
);

369 
qgroup
->
lim_æags
 = 
	`bŒfs_qgroup_lim™_æags
(
l
, 
±r
);

370 
qgroup
->
max_rãr
 = 
	`bŒfs_qgroup_lim™_max_rãr
(
l
, 
±r
);

371 
qgroup
->
max_exþ
 = 
	`bŒfs_qgroup_lim™_max_exþ
(
l
, 
±r
);

372 
qgroup
->
rsv_rãr
 = 
	`bŒfs_qgroup_lim™_rsv_rãr
(
l
, 
±r
);

373 
qgroup
->
rsv_exþ
 = 
	`bŒfs_qgroup_lim™_rsv_exþ
(
l
, 
±r
);

377 
Ãxt1
:

378 
»t
 = 
	`bŒfs_Ãxt_™em
(
quÙa_roÙ
, 
·th
);

379 ià(
»t
 < 0)

380 
out
;

381 ià(
»t
)

384 
	`bŒfs_»Ëa£_·th
(
·th
);

389 
key
.
objeùid
 = 0;

390 
key
.
ty³
 = 
BTRFS_QGROUP_RELATION_KEY
;

391 
key
.
off£t
 = 0;

392 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
quÙa_roÙ
, &
key
, 
·th
, 1, 0);

393 ià(
»t
)

394 
out
;

396 
¦Ù
 = 
·th
->
¦Ùs
[0];

397 
l
 = 
·th
->
nodes
[0];

398 
	`bŒfs_™em_key_to_ýu
(
l
, &
found_key
, 
¦Ù
);

400 ià(
found_key
.
ty³
 !ð
BTRFS_QGROUP_RELATION_KEY
)

401 
Ãxt2
;

403 ià(
found_key
.
objeùid
 > found_key.
off£t
) {

406 
Ãxt2
;

409 
»t
 = 
	`add_»ÏtiÚ_rb
(
fs_šfo
, 
found_key
.
objeùid
,

410 
found_key
.
off£t
);

411 ià(
»t
 =ð-
ENOENT
) {

412 
	`bŒfs_w¬n
(
fs_šfo
,

414 
found_key
.
objeùid
, found_key.
off£t
);

415 
»t
 = 0;

417 ià(
»t
)

418 
out
;

419 
Ãxt2
:

420 
»t
 = 
	`bŒfs_Ãxt_™em
(
quÙa_roÙ
, 
·th
);

421 ià(
»t
 < 0)

422 
out
;

423 ià(
»t
)

426 
out
:

427 
fs_šfo
->
qgroup_æags
 |ð
æags
;

428 ià(!(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
))

429 
	`þ—r_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

430 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
 &&

431 
»t
 >= 0)

432 
»t
 = 
	`qgroup_»sÿn_š™
(
fs_šfo
, 
»sÿn_´og»ss
, 0);

433 
	`bŒfs_ä“_·th
(
·th
);

435 ià(
»t
 < 0) {

436 
	`uli¡_ä“
(
fs_šfo
->
qgroup_uli¡
);

437 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

438 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

441  
»t
 < 0 ?„et : 0;

442 
	}
}

450 
	$bŒfs_ä“_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
)

452 
rb_node
 *
n
;

453 
bŒfs_qgroup
 *
qgroup
;

455 (
n
 = 
	`rb_fœ¡
(&
fs_šfo
->
qgroup_Œ“
))) {

456 
qgroup
 = 
	`rb_’Œy
(
n
, 
bŒfs_qgroup
, 
node
);

457 
	`rb_”a£
(
n
, &
fs_šfo
->
qgroup_Œ“
);

458 
	`__d–_qgroup_rb
(
qgroup
);

465 
	`uli¡_ä“
(
fs_šfo
->
qgroup_uli¡
);

466 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

467 
	}
}

469 
	$add_qgroup_»ÏtiÚ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

470 
bŒfs_roÙ
 *
quÙa_roÙ
,

471 
u64
 
¤c
, u64 
d¡
)

473 
»t
;

474 
bŒfs_·th
 *
·th
;

475 
bŒfs_key
 
key
;

477 
·th
 = 
	`bŒfs_®loc_·th
();

478 ià(!
·th
)

479  -
ENOMEM
;

481 
key
.
objeùid
 = 
¤c
;

482 
key
.
ty³
 = 
BTRFS_QGROUP_RELATION_KEY
;

483 
key
.
off£t
 = 
d¡
;

485 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
, 0);

487 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

489 
	`bŒfs_ä“_·th
(
·th
);

490  
»t
;

491 
	}
}

493 
	$d–_qgroup_»ÏtiÚ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

494 
bŒfs_roÙ
 *
quÙa_roÙ
,

495 
u64
 
¤c
, u64 
d¡
)

497 
»t
;

498 
bŒfs_·th
 *
·th
;

499 
bŒfs_key
 
key
;

501 
·th
 = 
	`bŒfs_®loc_·th
();

502 ià(!
·th
)

503  -
ENOMEM
;

505 
key
.
objeùid
 = 
¤c
;

506 
key
.
ty³
 = 
BTRFS_QGROUP_RELATION_KEY
;

507 
key
.
off£t
 = 
d¡
;

509 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, -1, 1);

510 ià(
»t
 < 0)

511 
out
;

513 ià(
»t
 > 0) {

514 
»t
 = -
ENOENT
;

515 
out
;

518 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
);

519 
out
:

520 
	`bŒfs_ä“_·th
(
·th
);

521  
»t
;

522 
	}
}

524 
	$add_qgroup_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

525 
bŒfs_roÙ
 *
quÙa_roÙ
, 
u64
 
qgroupid
)

527 
»t
;

528 
bŒfs_·th
 *
·th
;

529 
bŒfs_qgroup_šfo_™em
 *
qgroup_šfo
;

530 
bŒfs_qgroup_lim™_™em
 *
qgroup_lim™
;

531 
ex‹Á_bufãr
 *
Ëaf
;

532 
bŒfs_key
 
key
;

534 ià(
	`bŒfs_is_‹¡šg
(
quÙa_roÙ
->
fs_šfo
))

537 
·th
 = 
	`bŒfs_®loc_·th
();

538 ià(!
·th
)

539  -
ENOMEM
;

541 
key
.
objeùid
 = 0;

542 
key
.
ty³
 = 
BTRFS_QGROUP_INFO_KEY
;

543 
key
.
off£t
 = 
qgroupid
;

551 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
,

552 (*
qgroup_šfo
));

553 ià(
»t
 &&„‘ !ð-
EEXIST
)

554 
out
;

556 
Ëaf
 = 
·th
->
nodes
[0];

557 
qgroup_šfo
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

558 
bŒfs_qgroup_šfo_™em
);

559 
	`bŒfs_£t_qgroup_šfo_g’”©iÚ
(
Ëaf
, 
qgroup_šfo
, 
Œªs
->
Œªsid
);

560 
	`bŒfs_£t_qgroup_šfo_rãr
(
Ëaf
, 
qgroup_šfo
, 0);

561 
	`bŒfs_£t_qgroup_šfo_rãr_cm´
(
Ëaf
, 
qgroup_šfo
, 0);

562 
	`bŒfs_£t_qgroup_šfo_exþ
(
Ëaf
, 
qgroup_šfo
, 0);

563 
	`bŒfs_£t_qgroup_šfo_exþ_cm´
(
Ëaf
, 
qgroup_šfo
, 0);

565 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

567 
	`bŒfs_»Ëa£_·th
(
·th
);

569 
key
.
ty³
 = 
BTRFS_QGROUP_LIMIT_KEY
;

570 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
,

571 (*
qgroup_lim™
));

572 ià(
»t
 &&„‘ !ð-
EEXIST
)

573 
out
;

575 
Ëaf
 = 
·th
->
nodes
[0];

576 
qgroup_lim™
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

577 
bŒfs_qgroup_lim™_™em
);

578 
	`bŒfs_£t_qgroup_lim™_æags
(
Ëaf
, 
qgroup_lim™
, 0);

579 
	`bŒfs_£t_qgroup_lim™_max_rãr
(
Ëaf
, 
qgroup_lim™
, 0);

580 
	`bŒfs_£t_qgroup_lim™_max_exþ
(
Ëaf
, 
qgroup_lim™
, 0);

581 
	`bŒfs_£t_qgroup_lim™_rsv_rãr
(
Ëaf
, 
qgroup_lim™
, 0);

582 
	`bŒfs_£t_qgroup_lim™_rsv_exþ
(
Ëaf
, 
qgroup_lim™
, 0);

584 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

586 
»t
 = 0;

587 
out
:

588 
	`bŒfs_ä“_·th
(
·th
);

589  
»t
;

590 
	}
}

592 
	$d–_qgroup_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

593 
bŒfs_roÙ
 *
quÙa_roÙ
, 
u64
 
qgroupid
)

595 
»t
;

596 
bŒfs_·th
 *
·th
;

597 
bŒfs_key
 
key
;

599 
·th
 = 
	`bŒfs_®loc_·th
();

600 ià(!
·th
)

601  -
ENOMEM
;

603 
key
.
objeùid
 = 0;

604 
key
.
ty³
 = 
BTRFS_QGROUP_INFO_KEY
;

605 
key
.
off£t
 = 
qgroupid
;

606 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, -1, 1);

607 ià(
»t
 < 0)

608 
out
;

610 ià(
»t
 > 0) {

611 
»t
 = -
ENOENT
;

612 
out
;

615 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
);

616 ià(
»t
)

617 
out
;

619 
	`bŒfs_»Ëa£_·th
(
·th
);

621 
key
.
ty³
 = 
BTRFS_QGROUP_LIMIT_KEY
;

622 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
quÙa_roÙ
, &
key
, 
·th
, -1, 1);

623 ià(
»t
 < 0)

624 
out
;

626 ià(
»t
 > 0) {

627 
»t
 = -
ENOENT
;

628 
out
;

631 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
);

633 
out
:

634 
	`bŒfs_ä“_·th
(
·th
);

635  
»t
;

636 
	}
}

638 
	$upd©e_qgroup_lim™_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

639 
bŒfs_roÙ
 *
roÙ
,

640 
bŒfs_qgroup
 *
qgroup
)

642 
bŒfs_·th
 *
·th
;

643 
bŒfs_key
 
key
;

644 
ex‹Á_bufãr
 *
l
;

645 
bŒfs_qgroup_lim™_™em
 *
qgroup_lim™
;

646 
»t
;

647 
¦Ù
;

649 
key
.
objeùid
 = 0;

650 
key
.
ty³
 = 
BTRFS_QGROUP_LIMIT_KEY
;

651 
key
.
off£t
 = 
qgroup
->
qgroupid
;

653 
·th
 = 
	`bŒfs_®loc_·th
();

654 ià(!
·th
)

655  -
ENOMEM
;

657 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

658 ià(
»t
 > 0)

659 
»t
 = -
ENOENT
;

661 ià(
»t
)

662 
out
;

664 
l
 = 
·th
->
nodes
[0];

665 
¦Ù
 = 
·th
->
¦Ùs
[0];

666 
qgroup_lim™
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_qgroup_lim™_™em
);

667 
	`bŒfs_£t_qgroup_lim™_æags
(
l
, 
qgroup_lim™
, 
qgroup
->
lim_æags
);

668 
	`bŒfs_£t_qgroup_lim™_max_rãr
(
l
, 
qgroup_lim™
, 
qgroup
->
max_rãr
);

669 
	`bŒfs_£t_qgroup_lim™_max_exþ
(
l
, 
qgroup_lim™
, 
qgroup
->
max_exþ
);

670 
	`bŒfs_£t_qgroup_lim™_rsv_rãr
(
l
, 
qgroup_lim™
, 
qgroup
->
rsv_rãr
);

671 
	`bŒfs_£t_qgroup_lim™_rsv_exþ
(
l
, 
qgroup_lim™
, 
qgroup
->
rsv_exþ
);

673 
	`bŒfs_m¬k_bufãr_dœty
(
l
);

675 
out
:

676 
	`bŒfs_ä“_·th
(
·th
);

677  
»t
;

678 
	}
}

680 
	$upd©e_qgroup_šfo_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

681 
bŒfs_roÙ
 *
roÙ
,

682 
bŒfs_qgroup
 *
qgroup
)

684 
bŒfs_·th
 *
·th
;

685 
bŒfs_key
 
key
;

686 
ex‹Á_bufãr
 *
l
;

687 
bŒfs_qgroup_šfo_™em
 *
qgroup_šfo
;

688 
»t
;

689 
¦Ù
;

691 ià(
	`bŒfs_is_‹¡šg
(
roÙ
->
fs_šfo
))

694 
key
.
objeùid
 = 0;

695 
key
.
ty³
 = 
BTRFS_QGROUP_INFO_KEY
;

696 
key
.
off£t
 = 
qgroup
->
qgroupid
;

698 
·th
 = 
	`bŒfs_®loc_·th
();

699 ià(!
·th
)

700  -
ENOMEM
;

702 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

703 ià(
»t
 > 0)

704 
»t
 = -
ENOENT
;

706 ià(
»t
)

707 
out
;

709 
l
 = 
·th
->
nodes
[0];

710 
¦Ù
 = 
·th
->
¦Ùs
[0];

711 
qgroup_šfo
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_qgroup_šfo_™em
);

712 
	`bŒfs_£t_qgroup_šfo_g’”©iÚ
(
l
, 
qgroup_šfo
, 
Œªs
->
Œªsid
);

713 
	`bŒfs_£t_qgroup_šfo_rãr
(
l
, 
qgroup_šfo
, 
qgroup
->
rãr
);

714 
	`bŒfs_£t_qgroup_šfo_rãr_cm´
(
l
, 
qgroup_šfo
, 
qgroup
->
rãr_cm´
);

715 
	`bŒfs_£t_qgroup_šfo_exþ
(
l
, 
qgroup_šfo
, 
qgroup
->
exþ
);

716 
	`bŒfs_£t_qgroup_šfo_exþ_cm´
(
l
, 
qgroup_šfo
, 
qgroup
->
exþ_cm´
);

718 
	`bŒfs_m¬k_bufãr_dœty
(
l
);

720 
out
:

721 
	`bŒfs_ä“_·th
(
·th
);

722  
»t
;

723 
	}
}

725 
	$upd©e_qgroup_¡©us_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

726 
bŒfs_fs_šfo
 *
fs_šfo
,

727 
bŒfs_roÙ
 *
roÙ
)

729 
bŒfs_·th
 *
·th
;

730 
bŒfs_key
 
key
;

731 
ex‹Á_bufãr
 *
l
;

732 
bŒfs_qgroup_¡©us_™em
 *
±r
;

733 
»t
;

734 
¦Ù
;

736 
key
.
objeùid
 = 0;

737 
key
.
ty³
 = 
BTRFS_QGROUP_STATUS_KEY
;

738 
key
.
off£t
 = 0;

740 
·th
 = 
	`bŒfs_®loc_·th
();

741 ià(!
·th
)

742  -
ENOMEM
;

744 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

745 ià(
»t
 > 0)

746 
»t
 = -
ENOENT
;

748 ià(
»t
)

749 
out
;

751 
l
 = 
·th
->
nodes
[0];

752 
¦Ù
 = 
·th
->
¦Ùs
[0];

753 
±r
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_qgroup_¡©us_™em
);

754 
	`bŒfs_£t_qgroup_¡©us_æags
(
l
, 
±r
, 
fs_šfo
->
qgroup_æags
);

755 
	`bŒfs_£t_qgroup_¡©us_g’”©iÚ
(
l
, 
±r
, 
Œªs
->
Œªsid
);

756 
	`bŒfs_£t_qgroup_¡©us_»sÿn
(
l
, 
±r
,

757 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
);

759 
	`bŒfs_m¬k_bufãr_dœty
(
l
);

761 
out
:

762 
	`bŒfs_ä“_·th
(
·th
);

763  
»t
;

764 
	}
}

769 
	$bŒfs_þ—n_quÙa_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

770 
bŒfs_roÙ
 *
roÙ
)

772 
bŒfs_·th
 *
·th
;

773 
bŒfs_key
 
key
;

774 
ex‹Á_bufãr
 *
Ëaf
 = 
NULL
;

775 
»t
;

776 
Ä
 = 0;

778 
·th
 = 
	`bŒfs_®loc_·th
();

779 ià(!
·th
)

780  -
ENOMEM
;

782 
·th
->
Ëave_¥šnšg
 = 1;

784 
key
.
objeùid
 = 0;

785 
key
.
off£t
 = 0;

786 
key
.
ty³
 = 0;

789 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

790 ià(
»t
 < 0)

791 
out
;

792 
Ëaf
 = 
·th
->
nodes
[0];

793 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

794 ià(!
Ä
)

801 
·th
->
¦Ùs
[0] = 0;

802 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
roÙ
, 
·th
, 0, 
Ä
);

803 ià(
»t
)

804 
out
;

806 
	`bŒfs_»Ëa£_·th
(
·th
);

808 
»t
 = 0;

809 
out
:

810 
	`bŒfs_ä“_·th
(
·th
);

811  
»t
;

812 
	}
}

814 
	$bŒfs_quÙa_’abË
(
bŒfs_Œªs_hªdË
 *
Œªs
,

815 
bŒfs_fs_šfo
 *
fs_šfo
)

817 
bŒfs_roÙ
 *
quÙa_roÙ
;

818 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

819 
bŒfs_·th
 *
·th
 = 
NULL
;

820 
bŒfs_qgroup_¡©us_™em
 *
±r
;

821 
ex‹Á_bufãr
 *
Ëaf
;

822 
bŒfs_key
 
key
;

823 
bŒfs_key
 
found_key
;

824 
bŒfs_qgroup
 *
qgroup
 = 
NULL
;

825 
»t
 = 0;

826 
¦Ù
;

828 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

829 ià(
fs_šfo
->
quÙa_roÙ
) {

830 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLING
, &
fs_šfo
->
æags
);

831 
out
;

834 
fs_šfo
->
qgroup_uli¡
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

835 ià(!
fs_šfo
->
qgroup_uli¡
) {

836 
»t
 = -
ENOMEM
;

837 
out
;

843 
quÙa_roÙ
 = 
	`bŒfs_ü—‹_Œ“
(
Œªs
, 
fs_šfo
,

844 
BTRFS_QUOTA_TREE_OBJECTID
);

845 ià(
	`IS_ERR
(
quÙa_roÙ
)) {

846 
»t
 = 
	`PTR_ERR
(
quÙa_roÙ
);

847 
out
;

850 
·th
 = 
	`bŒfs_®loc_·th
();

851 ià(!
·th
) {

852 
»t
 = -
ENOMEM
;

853 
out_ä“_roÙ
;

856 
key
.
objeùid
 = 0;

857 
key
.
ty³
 = 
BTRFS_QGROUP_STATUS_KEY
;

858 
key
.
off£t
 = 0;

860 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
quÙa_roÙ
, 
·th
, &
key
,

861 (*
±r
));

862 ià(
»t
)

863 
out_ä“_·th
;

865 
Ëaf
 = 
·th
->
nodes
[0];

866 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

867 
bŒfs_qgroup_¡©us_™em
);

868 
	`bŒfs_£t_qgroup_¡©us_g’”©iÚ
(
Ëaf
, 
±r
, 
Œªs
->
Œªsid
);

869 
	`bŒfs_£t_qgroup_¡©us_v”siÚ
(
Ëaf
, 
±r
, 
BTRFS_QGROUP_STATUS_VERSION
);

870 
fs_šfo
->
qgroup_æags
 = 
BTRFS_QGROUP_STATUS_FLAG_ON
 |

871 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

872 
	`bŒfs_£t_qgroup_¡©us_æags
(
Ëaf
, 
±r
, 
fs_šfo
->
qgroup_æags
);

873 
	`bŒfs_£t_qgroup_¡©us_»sÿn
(
Ëaf
, 
±r
, 0);

875 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

877 
key
.
objeùid
 = 0;

878 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

879 
key
.
off£t
 = 0;

881 
	`bŒfs_»Ëa£_·th
(
·th
);

882 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
Œ“_roÙ
, &
key
, 
·th
, 1, 0);

883 ià(
»t
 > 0)

884 
out_add_roÙ
;

885 ià(
»t
 < 0)

886 
out_ä“_·th
;

890 
¦Ù
 = 
·th
->
¦Ùs
[0];

891 
Ëaf
 = 
·th
->
nodes
[0];

892 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

894 ià(
found_key
.
ty³
 =ð
BTRFS_ROOT_REF_KEY
) {

895 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
,

896 
found_key
.
off£t
);

897 ià(
»t
)

898 
out_ä“_·th
;

900 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
found_key
.
off£t
);

901 ià(
	`IS_ERR
(
qgroup
)) {

902 
»t
 = 
	`PTR_ERR
(
qgroup
);

903 
out_ä“_·th
;

906 
»t
 = 
	`bŒfs_Ãxt_™em
(
Œ“_roÙ
, 
·th
);

907 ià(
»t
 < 0)

908 
out_ä“_·th
;

909 ià(
»t
)

913 
out_add_roÙ
:

914 
	`bŒfs_»Ëa£_·th
(
·th
);

915 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
BTRFS_FS_TREE_OBJECTID
);

916 ià(
»t
)

917 
out_ä“_·th
;

919 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
);

920 ià(
	`IS_ERR
(
qgroup
)) {

921 
»t
 = 
	`PTR_ERR
(
qgroup
);

922 
out_ä“_·th
;

924 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

925 
fs_šfo
->
quÙa_roÙ
 = quota_root;

926 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLING
, &
fs_šfo
->
æags
);

927 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

928 
out_ä“_·th
:

929 
	`bŒfs_ä“_·th
(
·th
);

930 
out_ä“_roÙ
:

931 ià(
»t
) {

932 
	`ä“_ex‹Á_bufãr
(
quÙa_roÙ
->
node
);

933 
	`ä“_ex‹Á_bufãr
(
quÙa_roÙ
->
comm™_roÙ
);

934 
	`kä“
(
quÙa_roÙ
);

936 
out
:

937 ià(
»t
) {

938 
	`uli¡_ä“
(
fs_šfo
->
qgroup_uli¡
);

939 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

941 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

942  
»t
;

943 
	}
}

945 
	$bŒfs_quÙa_di§bË
(
bŒfs_Œªs_hªdË
 *
Œªs
,

946 
bŒfs_fs_šfo
 *
fs_šfo
)

948 
bŒfs_roÙ
 *
quÙa_roÙ
;

949 
»t
 = 0;

951 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

952 ià(!
fs_šfo
->
quÙa_roÙ
)

953 
out
;

954 
	`þ—r_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

955 
	`bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
fs_šfo
, 
çl£
);

956 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

957 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

958 
fs_šfo
->
quÙa_roÙ
 = 
NULL
;

959 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_ON
;

960 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

962 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

964 
»t
 = 
	`bŒfs_þ—n_quÙa_Œ“
(
Œªs
, 
quÙa_roÙ
);

965 ià(
»t
)

966 
out
;

968 
»t
 = 
	`bŒfs_d–_roÙ
(
Œªs
, 
fs_šfo
, &
quÙa_roÙ
->
roÙ_key
);

969 ià(
»t
)

970 
out
;

972 
	`li¡_d–
(&
quÙa_roÙ
->
dœty_li¡
);

974 
	`bŒfs_Œ“_lock
(
quÙa_roÙ
->
node
);

975 
	`þ—n_Œ“_block
(
fs_šfo
, 
quÙa_roÙ
->
node
);

976 
	`bŒfs_Œ“_uÆock
(
quÙa_roÙ
->
node
);

977 
	`bŒfs_ä“_Œ“_block
(
Œªs
, 
quÙa_roÙ
, quÙa_roÙ->
node
, 0, 1);

979 
	`ä“_ex‹Á_bufãr
(
quÙa_roÙ
->
node
);

980 
	`ä“_ex‹Á_bufãr
(
quÙa_roÙ
->
comm™_roÙ
);

981 
	`kä“
(
quÙa_roÙ
);

982 
out
:

983 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

984  
»t
;

985 
	}
}

987 
	$qgroup_dœty
(
bŒfs_fs_šfo
 *
fs_šfo
,

988 
bŒfs_qgroup
 *
qgroup
)

990 ià(
	`li¡_em±y
(&
qgroup
->
dœty
))

991 
	`li¡_add
(&
qgroup
->
dœty
, &
fs_šfo
->
dœty_qgroups
);

992 
	}
}

994 
	$»pÜt_»£rved_und”æow
(
bŒfs_fs_šfo
 *
fs_šfo
,

995 
bŒfs_qgroup
 *
qgroup
,

996 
u64
 
num_by‹s
)

998 #ifdeà
CONFIG_BTRFS_DEBUG


999 
	`WARN_ON
(
qgroup
->
»£rved
 < 
num_by‹s
);

1000 
	`bŒfs_debug
(
fs_šfo
,

1002 
qgroup
->
qgroupid
, qgroup->
»£rved
, 
num_by‹s
);

1004 
qgroup
->
»£rved
 = 0;

1005 
	}
}

1013 
	$__qgroup_exþ_accouÁšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

1014 
uli¡
 *
tmp
, 
u64
 
»f_roÙ
,

1015 
u64
 
num_by‹s
, 
sign
)

1017 
bŒfs_qgroup
 *
qgroup
;

1018 
bŒfs_qgroup_li¡
 *
gli¡
;

1019 
uli¡_node
 *
unode
;

1020 
uli¡_™”©Ü
 
u™”
;

1021 
»t
 = 0;

1023 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

1024 ià(!
qgroup
)

1025 
out
;

1027 
qgroup
->
rãr
 +ð
sign
 * 
num_by‹s
;

1028 
qgroup
->
rãr_cm´
 +ð
sign
 * 
num_by‹s
;

1030 
	`WARN_ON
(
sign
 < 0 && 
qgroup
->
exþ
 < 
num_by‹s
);

1031 
qgroup
->
exþ
 +ð
sign
 * 
num_by‹s
;

1032 
qgroup
->
exþ_cm´
 +ð
sign
 * 
num_by‹s
;

1033 ià(
sign
 > 0) {

1034 
	`Œaû_qgroup_upd©e_»£rve
(
fs_šfo
, 
qgroup
, -(
s64
)
num_by‹s
);

1035 ià(
qgroup
->
»£rved
 < 
num_by‹s
)

1036 
	`»pÜt_»£rved_und”æow
(
fs_šfo
, 
qgroup
, 
num_by‹s
);

1038 
qgroup
->
»£rved
 -ð
num_by‹s
;

1041 
	`qgroup_dœty
(
fs_šfo
, 
qgroup
);

1044 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qgroup
->
groups
, 
Ãxt_group
) {

1045 
»t
 = 
	`uli¡_add
(
tmp
, 
gli¡
->
group
->
qgroupid
,

1046 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

1047 ià(
»t
 < 0)

1048 
out
;

1052 
	`ULIST_ITER_INIT
(&
u™”
);

1053 (
unode
 = 
	`uli¡_Ãxt
(
tmp
, &
u™”
))) {

1054 
qgroup
 = 
	`unode_aux_to_qgroup
(
unode
);

1055 
qgroup
->
rãr
 +ð
sign
 * 
num_by‹s
;

1056 
qgroup
->
rãr_cm´
 +ð
sign
 * 
num_by‹s
;

1057 
	`WARN_ON
(
sign
 < 0 && 
qgroup
->
exþ
 < 
num_by‹s
);

1058 
qgroup
->
exþ
 +ð
sign
 * 
num_by‹s
;

1059 ià(
sign
 > 0) {

1060 
	`Œaû_qgroup_upd©e_»£rve
(
fs_šfo
, 
qgroup
,

1061 -(
s64
)
num_by‹s
);

1062 ià(
qgroup
->
»£rved
 < 
num_by‹s
)

1063 
	`»pÜt_»£rved_und”æow
(
fs_šfo
, 
qgroup
,

1064 
num_by‹s
);

1066 
qgroup
->
»£rved
 -ð
num_by‹s
;

1068 
qgroup
->
exþ_cm´
 +ð
sign
 * 
num_by‹s
;

1069 
	`qgroup_dœty
(
fs_šfo
, 
qgroup
);

1072 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qgroup
->
groups
, 
Ãxt_group
) {

1073 
»t
 = 
	`uli¡_add
(
tmp
, 
gli¡
->
group
->
qgroupid
,

1074 
	`qgroup_to_aux
(
gli¡
->
group
), 
GFP_ATOMIC
);

1075 ià(
»t
 < 0)

1076 
out
;

1079 
»t
 = 0;

1080 
out
:

1081  
»t
;

1082 
	}
}

1096 
	$quick_upd©e_accouÁšg
(
bŒfs_fs_šfo
 *
fs_šfo
,

1097 
uli¡
 *
tmp
, 
u64
 
¤c
, u64 
d¡
,

1098 
sign
)

1100 
bŒfs_qgroup
 *
qgroup
;

1101 
»t
 = 1;

1102 
”r
 = 0;

1104 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤c
);

1105 ià(!
qgroup
)

1106 
out
;

1107 ià(
qgroup
->
exþ
 =ðqgroup->
rãr
) {

1108 
»t
 = 0;

1109 
”r
 = 
	`__qgroup_exþ_accouÁšg
(
fs_šfo
, 
tmp
, 
d¡
,

1110 
qgroup
->
exþ
, 
sign
);

1111 ià(
”r
 < 0) {

1112 
»t
 = 
”r
;

1113 
out
;

1116 
out
:

1117 ià(
»t
)

1118 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

1119  
»t
;

1120 
	}
}

1122 
	$bŒfs_add_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1123 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤c
, u64 
d¡
)

1125 
bŒfs_roÙ
 *
quÙa_roÙ
;

1126 
bŒfs_qgroup
 *
·»Á
;

1127 
bŒfs_qgroup
 *
memb”
;

1128 
bŒfs_qgroup_li¡
 *
li¡
;

1129 
uli¡
 *
tmp
;

1130 
»t
 = 0;

1133 ià(
	`bŒfs_qgroup_Ëv–
(
¤c
è>ðbŒfs_qgroup_Ëv–(
d¡
))

1134  -
EINVAL
;

1136 
tmp
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

1137 ià(!
tmp
)

1138  -
ENOMEM
;

1140 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1141 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1142 ià(!
quÙa_roÙ
) {

1143 
»t
 = -
EINVAL
;

1144 
out
;

1146 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤c
);

1147 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
d¡
);

1148 ià(!
memb”
 || !
·»Á
) {

1149 
»t
 = -
EINVAL
;

1150 
out
;

1154 
	`li¡_fÜ_—ch_’Œy
(
li¡
, &
memb”
->
groups
, 
Ãxt_group
) {

1155 ià(
li¡
->
group
 =ð
·»Á
) {

1156 
»t
 = -
EEXIST
;

1157 
out
;

1161 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
, 
¤c
, 
d¡
);

1162 ià(
»t
)

1163 
out
;

1165 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
, 
d¡
, 
¤c
);

1166 ià(
»t
) {

1167 
	`d–_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
, 
¤c
, 
d¡
);

1168 
out
;

1171 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1172 
»t
 = 
	`add_»ÏtiÚ_rb
(
fs_šfo
, 
¤c
, 
d¡
);

1173 ià(
»t
 < 0) {

1174 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1175 
out
;

1177 
»t
 = 
	`quick_upd©e_accouÁšg
(
fs_šfo
, 
tmp
, 
¤c
, 
d¡
, 1);

1178 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1179 
out
:

1180 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1181 
	`uli¡_ä“
(
tmp
);

1182  
»t
;

1183 
	}
}

1185 
	$__d–_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1186 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤c
, u64 
d¡
)

1188 
bŒfs_roÙ
 *
quÙa_roÙ
;

1189 
bŒfs_qgroup
 *
·»Á
;

1190 
bŒfs_qgroup
 *
memb”
;

1191 
bŒfs_qgroup_li¡
 *
li¡
;

1192 
uli¡
 *
tmp
;

1193 
»t
 = 0;

1194 
”r
;

1196 
tmp
 = 
	`uli¡_®loc
(
GFP_KERNEL
);

1197 ià(!
tmp
)

1198  -
ENOMEM
;

1200 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1201 ià(!
quÙa_roÙ
) {

1202 
»t
 = -
EINVAL
;

1203 
out
;

1206 
memb”
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤c
);

1207 
·»Á
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
d¡
);

1208 ià(!
memb”
 || !
·»Á
) {

1209 
»t
 = -
EINVAL
;

1210 
out
;

1214 
	`li¡_fÜ_—ch_’Œy
(
li¡
, &
memb”
->
groups
, 
Ãxt_group
) {

1215 ià(
li¡
->
group
 =ð
·»Á
)

1216 
exi¡
;

1218 
»t
 = -
ENOENT
;

1219 
out
;

1220 
exi¡
:

1221 
»t
 = 
	`d–_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
, 
¤c
, 
d¡
);

1222 
”r
 = 
	`d–_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
, 
d¡
, 
¤c
);

1223 ià(
”r
 && !
»t
)

1224 
»t
 = 
”r
;

1226 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1227 
	`d–_»ÏtiÚ_rb
(
fs_šfo
, 
¤c
, 
d¡
);

1228 
»t
 = 
	`quick_upd©e_accouÁšg
(
fs_šfo
, 
tmp
, 
¤c
, 
d¡
, -1);

1229 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1230 
out
:

1231 
	`uli¡_ä“
(
tmp
);

1232  
»t
;

1233 
	}
}

1235 
	$bŒfs_d–_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1236 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤c
, u64 
d¡
)

1238 
»t
 = 0;

1240 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1241 
»t
 = 
	`__d–_qgroup_»ÏtiÚ
(
Œªs
, 
fs_šfo
, 
¤c
, 
d¡
);

1242 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1244  
»t
;

1245 
	}
}

1247 
	$bŒfs_ü—‹_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1248 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
)

1250 
bŒfs_roÙ
 *
quÙa_roÙ
;

1251 
bŒfs_qgroup
 *
qgroup
;

1252 
»t
 = 0;

1254 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1255 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1256 ià(!
quÙa_roÙ
) {

1257 
»t
 = -
EINVAL
;

1258 
out
;

1260 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1261 ià(
qgroup
) {

1262 
»t
 = -
EEXIST
;

1263 
out
;

1266 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
qgroupid
);

1267 ià(
»t
)

1268 
out
;

1270 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1271 
qgroup
 = 
	`add_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1272 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1274 ià(
	`IS_ERR
(
qgroup
))

1275 
»t
 = 
	`PTR_ERR
(
qgroup
);

1276 
out
:

1277 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1278  
»t
;

1279 
	}
}

1281 
	$bŒfs_»move_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1282 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
)

1284 
bŒfs_roÙ
 *
quÙa_roÙ
;

1285 
bŒfs_qgroup
 *
qgroup
;

1286 
bŒfs_qgroup_li¡
 *
li¡
;

1287 
»t
 = 0;

1289 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1290 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1291 ià(!
quÙa_roÙ
) {

1292 
»t
 = -
EINVAL
;

1293 
out
;

1296 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1297 ià(!
qgroup
) {

1298 
»t
 = -
ENOENT
;

1299 
out
;

1302 ià(!
	`li¡_em±y
(&
qgroup
->
memb”s
)) {

1303 
»t
 = -
EBUSY
;

1304 
out
;

1307 
»t
 = 
	`d–_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
qgroupid
);

1308 ià(
»t
 &&„‘ !ð-
ENOENT
)

1309 
out
;

1311 !
	`li¡_em±y
(&
qgroup
->
groups
)) {

1312 
li¡
 = 
	`li¡_fœ¡_’Œy
(&
qgroup
->
groups
,

1313 
bŒfs_qgroup_li¡
, 
Ãxt_group
);

1314 
»t
 = 
	`__d–_qgroup_»ÏtiÚ
(
Œªs
, 
fs_šfo
,

1315 
qgroupid
,

1316 
li¡
->
group
->
qgroupid
);

1317 ià(
»t
)

1318 
out
;

1321 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1322 
	`d–_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1323 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1324 
out
:

1325 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1326  
»t
;

1327 
	}
}

1329 
	$bŒfs_lim™_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1330 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
,

1331 
bŒfs_qgroup_lim™
 *
lim™
)

1333 
bŒfs_roÙ
 *
quÙa_roÙ
;

1334 
bŒfs_qgroup
 *
qgroup
;

1335 
»t
 = 0;

1340 cÚ¡ 
u64
 
CLEAR_VALUE
 = -1;

1342 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1343 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

1344 ià(!
quÙa_roÙ
) {

1345 
»t
 = -
EINVAL
;

1346 
out
;

1349 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
qgroupid
);

1350 ià(!
qgroup
) {

1351 
»t
 = -
ENOENT
;

1352 
out
;

1355 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1356 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_MAX_RFER
) {

1357 ià(
lim™
->
max_rãr
 =ð
CLEAR_VALUE
) {

1358 
qgroup
->
lim_æags
 &ð~
BTRFS_QGROUP_LIMIT_MAX_RFER
;

1359 
lim™
->
æags
 &ð~
BTRFS_QGROUP_LIMIT_MAX_RFER
;

1360 
qgroup
->
max_rãr
 = 0;

1362 
qgroup
->
max_rãr
 = 
lim™
->max_rfer;

1365 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_MAX_EXCL
) {

1366 ià(
lim™
->
max_exþ
 =ð
CLEAR_VALUE
) {

1367 
qgroup
->
lim_æags
 &ð~
BTRFS_QGROUP_LIMIT_MAX_EXCL
;

1368 
lim™
->
æags
 &ð~
BTRFS_QGROUP_LIMIT_MAX_EXCL
;

1369 
qgroup
->
max_exþ
 = 0;

1371 
qgroup
->
max_exþ
 = 
lim™
->max_excl;

1374 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_RSV_RFER
) {

1375 ià(
lim™
->
rsv_rãr
 =ð
CLEAR_VALUE
) {

1376 
qgroup
->
lim_æags
 &ð~
BTRFS_QGROUP_LIMIT_RSV_RFER
;

1377 
lim™
->
æags
 &ð~
BTRFS_QGROUP_LIMIT_RSV_RFER
;

1378 
qgroup
->
rsv_rãr
 = 0;

1380 
qgroup
->
rsv_rãr
 = 
lim™
->rsv_rfer;

1383 ià(
lim™
->
æags
 & 
BTRFS_QGROUP_LIMIT_RSV_EXCL
) {

1384 ià(
lim™
->
rsv_exþ
 =ð
CLEAR_VALUE
) {

1385 
qgroup
->
lim_æags
 &ð~
BTRFS_QGROUP_LIMIT_RSV_EXCL
;

1386 
lim™
->
æags
 &ð~
BTRFS_QGROUP_LIMIT_RSV_EXCL
;

1387 
qgroup
->
rsv_exþ
 = 0;

1389 
qgroup
->
rsv_exþ
 = 
lim™
->rsv_excl;

1392 
qgroup
->
lim_æags
 |ð
lim™
->
æags
;

1394 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1396 
»t
 = 
	`upd©e_qgroup_lim™_™em
(
Œªs
, 
quÙa_roÙ
, 
qgroup
);

1397 ià(
»t
) {

1398 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

1399 
	`bŒfs_šfo
(
fs_šfo
, "unableo update quota†imit for %llu",

1400 
qgroupid
);

1403 
out
:

1404 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

1405  
»t
;

1406 
	}
}

1408 
	$bŒfs_qgroup_Œaû_ex‹Á_nÞock
(
bŒfs_fs_šfo
 *
fs_šfo
,

1409 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

1410 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
)

1412 
rb_node
 **
p
 = &
d–ayed_»fs
->
dœty_ex‹Á_roÙ
.rb_node;

1413 
rb_node
 *
·»Á_node
 = 
NULL
;

1414 
bŒfs_qgroup_ex‹Á_»cÜd
 *
’Œy
;

1415 
u64
 
by‹Ä
 = 
»cÜd
->bytenr;

1417 
	`as£¹_¥š_locked
(&
d–ayed_»fs
->
lock
);

1418 
	`Œaû_bŒfs_qgroup_Œaû_ex‹Á
(
fs_šfo
, 
»cÜd
);

1420 *
p
) {

1421 
·»Á_node
 = *
p
;

1422 
’Œy
 = 
	`rb_’Œy
(
·»Á_node
, 
bŒfs_qgroup_ex‹Á_»cÜd
,

1423 
node
);

1424 ià(
by‹Ä
 < 
’Œy
->bytenr)

1425 
p
 = &(*p)->
rb_Ëá
;

1426 ià(
by‹Ä
 > 
’Œy
->bytenr)

1427 
p
 = &(*p)->
rb_right
;

1432 
	`rb_lšk_node
(&
»cÜd
->
node
, 
·»Á_node
, 
p
);

1433 
	`rb_š£¹_cÞÜ
(&
»cÜd
->
node
, &
d–ayed_»fs
->
dœty_ex‹Á_roÙ
);

1435 
	}
}

1437 
	$bŒfs_qgroup_Œaû_ex‹Á_po¡
(
bŒfs_fs_šfo
 *
fs_šfo
,

1438 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
)

1440 
uli¡
 *
Þd_roÙ
;

1441 
u64
 
by‹Ä
 = 
q»cÜd
->bytenr;

1442 
»t
;

1444 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(
NULL
, 
fs_šfo
, 
by‹Ä
, 0, &
Þd_roÙ
);

1445 ià(
»t
 < 0)

1446  
»t
;

1455 
q»cÜd
->
Þd_roÙs
 = 
Þd_roÙ
;

1457 
	}
}

1459 
	$bŒfs_qgroup_Œaû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1460 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
, u64 
num_by‹s
,

1461 
gå_t
 
gå_æag
)

1463 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
;

1464 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

1465 
»t
;

1467 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)

1468 || 
by‹Ä
 =ð0 || 
num_by‹s
 == 0)

1470 ià(
	`WARN_ON
(
Œªs
 =ð
NULL
))

1471  -
EINVAL
;

1472 
»cÜd
 = 
	`km®loc
((*»cÜd), 
gå_æag
);

1473 ià(!
»cÜd
)

1474  -
ENOMEM
;

1476 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

1477 
»cÜd
->
by‹Ä
 = bytenr;

1478 
»cÜd
->
num_by‹s
 =‚um_bytes;

1479 
»cÜd
->
Þd_roÙs
 = 
NULL
;

1481 
	`¥š_lock
(&
d–ayed_»fs
->
lock
);

1482 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á_nÞock
(
fs_šfo
, 
d–ayed_»fs
, 
»cÜd
);

1483 
	`¥š_uÆock
(&
d–ayed_»fs
->
lock
);

1484 ià(
»t
 > 0) {

1485 
	`kä“
(
»cÜd
);

1488  
	`bŒfs_qgroup_Œaû_ex‹Á_po¡
(
fs_šfo
, 
»cÜd
);

1489 
	}
}

1491 
	$bŒfs_qgroup_Œaû_Ëaf_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1492 
bŒfs_fs_šfo
 *
fs_šfo
,

1493 
ex‹Á_bufãr
 *
eb
)

1495 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1496 
i
, 
ex‹Á_ty³
, 
»t
;

1497 
bŒfs_key
 
key
;

1498 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1499 
u64
 
by‹Ä
, 
num_by‹s
;

1502 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

1505 
i
 = 0; i < 
Ä
; i++) {

1506 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
i
);

1508 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

1511 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
i
, 
bŒfs_fže_ex‹Á_™em
);

1513 
ex‹Á_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
fi
);

1515 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
)

1518 
by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

1519 ià(!
by‹Ä
)

1522 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
eb
, 
fi
);

1524 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
fs_šfo
, 
by‹Ä
,

1525 
num_by‹s
, 
GFP_NOFS
);

1526 ià(
»t
)

1527  
»t
;

1529 
	`cÚd_»sched
();

1531 
	}
}

1547 
	$adju¡_¦Ùs_upw¬ds
(
bŒfs_·th
 *
·th
, 
roÙ_Ëv–
)

1549 
Ëv–
 = 0;

1550 
Ä
, 
¦Ù
;

1551 
ex‹Á_bufãr
 *
eb
;

1553 ià(
roÙ_Ëv–
 == 0)

1556 
Ëv–
 <ð
roÙ_Ëv–
) {

1557 
eb
 = 
·th
->
nodes
[
Ëv–
];

1558 
Ä
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

1559 
·th
->
¦Ùs
[
Ëv–
]++;

1560 
¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
];

1561 ià(
¦Ù
 >ð
Ä
 || 
Ëv–
 == 0) {

1567 ià(
Ëv–
 !ð
roÙ_Ëv–
) {

1568 
	`bŒfs_Œ“_uÆock_rw
(
eb
, 
·th
->
locks
[
Ëv–
]);

1569 
·th
->
locks
[
Ëv–
] = 0;

1571 
	`ä“_ex‹Á_bufãr
(
eb
);

1572 
·th
->
nodes
[
Ëv–
] = 
NULL
;

1573 
·th
->
¦Ùs
[
Ëv–
] = 0;

1584 
Ëv–
++;

1587 
eb
 = 
·th
->
nodes
[
roÙ_Ëv–
];

1588 ià(
·th
->
¦Ùs
[
roÙ_Ëv–
] >ð
	`bŒfs_h—d”_Ä™ems
(
eb
))

1592 
	}
}

1594 
	$bŒfs_qgroup_Œaû_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1595 
bŒfs_roÙ
 *
roÙ
,

1596 
ex‹Á_bufãr
 *
roÙ_eb
,

1597 
u64
 
roÙ_g’
, 
roÙ_Ëv–
)

1599 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1600 
»t
 = 0;

1601 
Ëv–
;

1602 
ex‹Á_bufãr
 *
eb
 = 
roÙ_eb
;

1603 
bŒfs_·th
 *
·th
 = 
NULL
;

1605 
	`BUG_ON
(
roÙ_Ëv–
 < 0 ||„oÙ_Ëv– >ð
BTRFS_MAX_LEVEL
);

1606 
	`BUG_ON
(
roÙ_eb
 =ð
NULL
);

1608 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

1611 ià(!
	`ex‹Á_bufãr_u±od©e
(
roÙ_eb
)) {

1612 
»t
 = 
	`bŒfs_»ad_bufãr
(
roÙ_eb
, 
roÙ_g’
);

1613 ià(
»t
)

1614 
out
;

1617 ià(
roÙ_Ëv–
 == 0) {

1618 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
, 
fs_šfo
, 
roÙ_eb
);

1619 
out
;

1622 
·th
 = 
	`bŒfs_®loc_·th
();

1623 ià(!
·th
)

1624  -
ENOMEM
;

1635 
	`ex‹Á_bufãr_g‘
(
roÙ_eb
);

1636 
·th
->
nodes
[
roÙ_Ëv–
] = 
roÙ_eb
;

1637 
·th
->
¦Ùs
[
roÙ_Ëv–
] = 0;

1638 
·th
->
locks
[
roÙ_Ëv–
] = 0;

1639 
w®k_down
:

1640 
Ëv–
 = 
roÙ_Ëv–
;

1641 
Ëv–
 >= 0) {

1642 ià(
·th
->
nodes
[
Ëv–
] =ð
NULL
) {

1643 
·»Á_¦Ù
;

1644 
u64
 
chžd_g’
;

1645 
u64
 
chžd_by‹Ä
;

1651 
eb
 = 
·th
->
nodes
[
Ëv–
 + 1];

1652 
·»Á_¦Ù
 = 
·th
->
¦Ùs
[
Ëv–
 + 1];

1653 
chžd_by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
, 
·»Á_¦Ù
);

1654 
chžd_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
·»Á_¦Ù
);

1656 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
chžd_by‹Ä
, 
chžd_g’
);

1657 ià(
	`IS_ERR
(
eb
)) {

1658 
»t
 = 
	`PTR_ERR
(
eb
);

1659 
out
;

1660 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

1661 
	`ä“_ex‹Á_bufãr
(
eb
);

1662 
»t
 = -
EIO
;

1663 
out
;

1666 
·th
->
nodes
[
Ëv–
] = 
eb
;

1667 
·th
->
¦Ùs
[
Ëv–
] = 0;

1669 
	`bŒfs_Œ“_»ad_lock
(
eb
);

1670 
	`bŒfs_£t_lock_blockšg_rw
(
eb
, 
BTRFS_READ_LOCK
);

1671 
·th
->
locks
[
Ëv–
] = 
BTRFS_READ_LOCK_BLOCKING
;

1673 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
fs_šfo
,

1674 
chžd_by‹Ä
,

1675 
fs_šfo
->
nodesize
,

1676 
GFP_NOFS
);

1677 ià(
»t
)

1678 
out
;

1681 ià(
Ëv–
 == 0) {

1682 
»t
 = 
	`bŒfs_qgroup_Œaû_Ëaf_™ems
(
Œªs
,
fs_šfo
,

1683 
·th
->
nodes
[
Ëv–
]);

1684 ià(
»t
)

1685 
out
;

1688 
»t
 = 
	`adju¡_¦Ùs_upw¬ds
(
·th
, 
roÙ_Ëv–
);

1689 ià(
»t
)

1693 
w®k_down
;

1696 
Ëv–
--;

1699 
»t
 = 0;

1700 
out
:

1701 
	`bŒfs_ä“_·th
(
·th
);

1703  
»t
;

1704 
	}
}

1706 
	#UPDATE_NEW
 0

	)

1707 
	#UPDATE_OLD
 1

	)

1711 
	$qgroup_upd©e_»fút
(
bŒfs_fs_šfo
 *
fs_šfo
,

1712 
uli¡
 *
roÙs
, uli¡ *
tmp
,

1713 
uli¡
 *
qgroups
, 
u64
 
£q
, 
upd©e_Þd
)

1715 
uli¡_node
 *
unode
;

1716 
uli¡_™”©Ü
 
u™”
;

1717 
uli¡_node
 *
tmp_unode
;

1718 
uli¡_™”©Ü
 
tmp_u™”
;

1719 
bŒfs_qgroup
 *
qg
;

1720 
»t
 = 0;

1722 ià(!
roÙs
)

1724 
	`ULIST_ITER_INIT
(&
u™”
);

1725 (
unode
 = 
	`uli¡_Ãxt
(
roÙs
, &
u™”
))) {

1726 
qg
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
unode
->
v®
);

1727 ià(!
qg
)

1730 
	`uli¡_»š™
(
tmp
);

1731 
»t
 = 
	`uli¡_add
(
qgroups
, 
qg
->
qgroupid
, 
	`qgroup_to_aux
(qg),

1732 
GFP_ATOMIC
);

1733 ià(
»t
 < 0)

1734  
»t
;

1735 
»t
 = 
	`uli¡_add
(
tmp
, 
qg
->
qgroupid
, 
	`qgroup_to_aux
(qg), 
GFP_ATOMIC
);

1736 ià(
»t
 < 0)

1737  
»t
;

1738 
	`ULIST_ITER_INIT
(&
tmp_u™”
);

1739 (
tmp_unode
 = 
	`uli¡_Ãxt
(
tmp
, &
tmp_u™”
))) {

1740 
bŒfs_qgroup_li¡
 *
gli¡
;

1742 
qg
 = 
	`unode_aux_to_qgroup
(
tmp_unode
);

1743 ià(
upd©e_Þd
)

1744 
	`bŒfs_qgroup_upd©e_Þd_»fút
(
qg
, 
£q
, 1);

1746 
	`bŒfs_qgroup_upd©e_Ãw_»fút
(
qg
, 
£q
, 1);

1747 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

1748 
»t
 = 
	`uli¡_add
(
qgroups
, 
gli¡
->
group
->
qgroupid
,

1749 
	`qgroup_to_aux
(
gli¡
->
group
),

1750 
GFP_ATOMIC
);

1751 ià(
»t
 < 0)

1752  
»t
;

1753 
»t
 = 
	`uli¡_add
(
tmp
, 
gli¡
->
group
->
qgroupid
,

1754 
	`qgroup_to_aux
(
gli¡
->
group
),

1755 
GFP_ATOMIC
);

1756 ià(
»t
 < 0)

1757  
»t
;

1762 
	}
}

1800 
	$qgroup_upd©e_couÁ”s
(
bŒfs_fs_šfo
 *
fs_šfo
,

1801 
uli¡
 *
qgroups
,

1802 
u64
 
Ä_Þd_roÙs
,

1803 
u64
 
Ä_Ãw_roÙs
,

1804 
u64
 
num_by‹s
, u64 
£q
)

1806 
uli¡_node
 *
unode
;

1807 
uli¡_™”©Ü
 
u™”
;

1808 
bŒfs_qgroup
 *
qg
;

1809 
u64
 
cur_Ãw_couÁ
, 
cur_Þd_couÁ
;

1811 
	`ULIST_ITER_INIT
(&
u™”
);

1812 (
unode
 = 
	`uli¡_Ãxt
(
qgroups
, &
u™”
))) {

1813 
boÞ
 
dœty
 = 
çl£
;

1815 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

1816 
cur_Þd_couÁ
 = 
	`bŒfs_qgroup_g‘_Þd_»fút
(
qg
, 
£q
);

1817 
cur_Ãw_couÁ
 = 
	`bŒfs_qgroup_g‘_Ãw_»fút
(
qg
, 
£q
);

1819 
	`Œaû_qgroup_upd©e_couÁ”s
(
fs_šfo
, 
qg
->
qgroupid
,

1820 
cur_Þd_couÁ
, 
cur_Ãw_couÁ
);

1823 ià(
cur_Þd_couÁ
 =ð0 && 
cur_Ãw_couÁ
 > 0) {

1824 
qg
->
rãr
 +ð
num_by‹s
;

1825 
qg
->
rãr_cm´
 +ð
num_by‹s
;

1826 
dœty
 = 
Œue
;

1828 ià(
cur_Þd_couÁ
 > 0 && 
cur_Ãw_couÁ
 == 0) {

1829 
qg
->
rãr
 -ð
num_by‹s
;

1830 
qg
->
rãr_cm´
 -ð
num_by‹s
;

1831 
dœty
 = 
Œue
;

1836 ià(
cur_Þd_couÁ
 =ð
Ä_Þd_roÙs
 &&

1837 
cur_Ãw_couÁ
 < 
Ä_Ãw_roÙs
) {

1839 ià(
cur_Þd_couÁ
 != 0) {

1840 
qg
->
exþ
 -ð
num_by‹s
;

1841 
qg
->
exþ_cm´
 -ð
num_by‹s
;

1842 
dœty
 = 
Œue
;

1847 ià(
cur_Þd_couÁ
 < 
Ä_Þd_roÙs
 &&

1848 
cur_Ãw_couÁ
 =ð
Ä_Ãw_roÙs
) {

1850 ià(
cur_Ãw_couÁ
 != 0) {

1851 
qg
->
exþ
 +ð
num_by‹s
;

1852 
qg
->
exþ_cm´
 +ð
num_by‹s
;

1853 
dœty
 = 
Œue
;

1858 ià(
cur_Þd_couÁ
 =ð
Ä_Þd_roÙs
 &&

1859 
cur_Ãw_couÁ
 =ð
Ä_Ãw_roÙs
) {

1860 ià(
cur_Þd_couÁ
 == 0) {

1863 ià(
cur_Ãw_couÁ
 != 0) {

1865 
qg
->
exþ
 +ð
num_by‹s
;

1866 
qg
->
exþ_cm´
 +ð
num_by‹s
;

1867 
dœty
 = 
Œue
;

1873 ià(
cur_Ãw_couÁ
 == 0) {

1875 
qg
->
exþ
 -ð
num_by‹s
;

1876 
qg
->
exþ_cm´
 -ð
num_by‹s
;

1877 
dœty
 = 
Œue
;

1883 ià(
dœty
)

1884 
	`qgroup_dœty
(
fs_šfo
, 
qg
);

1887 
	}
}

1896 
	$maybe_fs_roÙs
(
uli¡
 *
roÙs
)

1898 
uli¡_node
 *
unode
;

1899 
uli¡_™”©Ü
 
u™”
;

1902 ià(!
roÙs
 ||„oÙs->
Âodes
 == 0)

1905 
	`ULIST_ITER_INIT
(&
u™”
);

1906 
unode
 = 
	`uli¡_Ãxt
(
roÙs
, &
u™”
);

1907 ià(!
unode
)

1915  
	`is_f¡»e
(
unode
->
v®
);

1916 
	}
}

1919 
	$bŒfs_qgroup_accouÁ_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1920 
bŒfs_fs_šfo
 *
fs_šfo
,

1921 
u64
 
by‹Ä
, u64 
num_by‹s
,

1922 
uli¡
 *
Þd_roÙs
, uli¡ *
Ãw_roÙs
)

1924 
uli¡
 *
qgroups
 = 
NULL
;

1925 
uli¡
 *
tmp
 = 
NULL
;

1926 
u64
 
£q
;

1927 
u64
 
Ä_Ãw_roÙs
 = 0;

1928 
u64
 
Ä_Þd_roÙs
 = 0;

1929 
»t
 = 0;

1931 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

1934 ià(
Ãw_roÙs
) {

1935 ià(!
	`maybe_fs_roÙs
(
Ãw_roÙs
))

1936 
out_ä“
;

1937 
Ä_Ãw_roÙs
 = 
Ãw_roÙs
->
Âodes
;

1939 ià(
Þd_roÙs
) {

1940 ià(!
	`maybe_fs_roÙs
(
Þd_roÙs
))

1941 
out_ä“
;

1942 
Ä_Þd_roÙs
 = 
Þd_roÙs
->
Âodes
;

1946 ià(
Ä_Þd_roÙs
 =ð0 && 
Ä_Ãw_roÙs
 == 0)

1947 
out_ä“
;

1949 
	`BUG_ON
(!
fs_šfo
->
quÙa_roÙ
);

1951 
	`Œaû_bŒfs_qgroup_accouÁ_ex‹Á
(
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

1952 
Ä_Þd_roÙs
, 
Ä_Ãw_roÙs
);

1954 
qgroups
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1955 ià(!
qgroups
) {

1956 
»t
 = -
ENOMEM
;

1957 
out_ä“
;

1959 
tmp
 = 
	`uli¡_®loc
(
GFP_NOFS
);

1960 ià(!
tmp
) {

1961 
»t
 = -
ENOMEM
;

1962 
out_ä“
;

1965 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

1966 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) {

1967 ià(
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 <ð
by‹Ä
) {

1968 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

1969 
»t
 = 0;

1970 
out_ä“
;

1973 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

1975 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

1976 
£q
 = 
fs_šfo
->
qgroup_£q
;

1979 
»t
 = 
	`qgroup_upd©e_»fút
(
fs_šfo
, 
Þd_roÙs
, 
tmp
, 
qgroups
, 
£q
,

1980 
UPDATE_OLD
);

1981 ià(
»t
 < 0)

1982 
out
;

1985 
»t
 = 
	`qgroup_upd©e_»fút
(
fs_šfo
, 
Ãw_roÙs
, 
tmp
, 
qgroups
, 
£q
,

1986 
UPDATE_NEW
);

1987 ià(
»t
 < 0)

1988 
out
;

1990 
	`qgroup_upd©e_couÁ”s
(
fs_šfo
, 
qgroups
, 
Ä_Þd_roÙs
, 
Ä_Ãw_roÙs
,

1991 
num_by‹s
, 
£q
);

1996 
fs_šfo
->
qgroup_£q
 +ð
	`max
(
Ä_Þd_roÙs
, 
Ä_Ãw_roÙs
) + 1;

1997 
out
:

1998 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

1999 
out_ä“
:

2000 
	`uli¡_ä“
(
tmp
);

2001 
	`uli¡_ä“
(
qgroups
);

2002 
	`uli¡_ä“
(
Þd_roÙs
);

2003 
	`uli¡_ä“
(
Ãw_roÙs
);

2004  
»t
;

2005 
	}
}

2007 
	$bŒfs_qgroup_accouÁ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2008 
bŒfs_fs_šfo
 *
fs_šfo
)

2010 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
;

2011 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

2012 
uli¡
 *
Ãw_roÙs
 = 
NULL
;

2013 
rb_node
 *
node
;

2014 
u64
 
qgroup_to_sk
;

2015 
»t
 = 0;

2017 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

2018 
qgroup_to_sk
 = 
d–ayed_»fs
->qgroup_to_skip;

2019 (
node
 = 
	`rb_fœ¡
(&
d–ayed_»fs
->
dœty_ex‹Á_roÙ
))) {

2020 
»cÜd
 = 
	`rb_’Œy
(
node
, 
bŒfs_qgroup_ex‹Á_»cÜd
,

2021 
node
);

2023 
	`Œaû_bŒfs_qgroup_accouÁ_ex‹Ás
(
fs_šfo
, 
»cÜd
);

2025 ià(!
»t
) {

2030 ià(
	`WARN_ON
(!
»cÜd
->
Þd_roÙs
)) {

2032 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(
NULL
, 
fs_šfo
,

2033 
»cÜd
->
by‹Ä
, 0,

2034 &
»cÜd
->
Þd_roÙs
);

2035 ià(
»t
 < 0)

2036 
þ—nup
;

2044 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(
Œªs
, 
fs_šfo
,

2045 
»cÜd
->
by‹Ä
, 
SEQ_LAST
, &
Ãw_roÙs
);

2046 ià(
»t
 < 0)

2047 
þ—nup
;

2048 ià(
qgroup_to_sk
) {

2049 
	`uli¡_d–
(
Ãw_roÙs
, 
qgroup_to_sk
, 0);

2050 
	`uli¡_d–
(
»cÜd
->
Þd_roÙs
, 
qgroup_to_sk
,

2053 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(
Œªs
, 
fs_šfo
,

2054 
»cÜd
->
by‹Ä
,„ecÜd->
num_by‹s
,

2055 
»cÜd
->
Þd_roÙs
, 
Ãw_roÙs
);

2056 
»cÜd
->
Þd_roÙs
 = 
NULL
;

2057 
Ãw_roÙs
 = 
NULL
;

2059 
þ—nup
:

2060 
	`uli¡_ä“
(
»cÜd
->
Þd_roÙs
);

2061 
	`uli¡_ä“
(
Ãw_roÙs
);

2062 
Ãw_roÙs
 = 
NULL
;

2063 
	`rb_”a£
(
node
, &
d–ayed_»fs
->
dœty_ex‹Á_roÙ
);

2064 
	`kä“
(
»cÜd
);

2067  
»t
;

2068 
	}
}

2073 
	$bŒfs_run_qgroups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2074 
bŒfs_fs_šfo
 *
fs_šfo
)

2076 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
fs_šfo
->quota_root;

2077 
»t
 = 0;

2078 
¡¬t_»sÿn_wÜk”
 = 0;

2080 ià(!
quÙa_roÙ
)

2081 
out
;

2083 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) &&

2084 
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLING
, &
fs_šfo
->
æags
))

2085 
¡¬t_»sÿn_wÜk”
 = 1;

2087 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_FS_QUOTA_ENABLING
, &
fs_šfo
->
æags
))

2088 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

2090 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2091 !
	`li¡_em±y
(&
fs_šfo
->
dœty_qgroups
)) {

2092 
bŒfs_qgroup
 *
qgroup
;

2093 
qgroup
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
dœty_qgroups
,

2094 
bŒfs_qgroup
, 
dœty
);

2095 
	`li¡_d–_š™
(&
qgroup
->
dœty
);

2096 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2097 
»t
 = 
	`upd©e_qgroup_šfo_™em
(
Œªs
, 
quÙa_roÙ
, 
qgroup
);

2098 ià(
»t
)

2099 
fs_šfo
->
qgroup_æags
 |=

2100 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

2101 
»t
 = 
	`upd©e_qgroup_lim™_™em
(
Œªs
, 
quÙa_roÙ
, 
qgroup
);

2102 ià(
»t
)

2103 
fs_šfo
->
qgroup_æags
 |=

2104 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

2105 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2107 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

2108 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_ON
;

2110 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_ON
;

2111 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2113 
»t
 = 
	`upd©e_qgroup_¡©us_™em
(
Œªs
, 
fs_šfo
, 
quÙa_roÙ
);

2114 ià(
»t
)

2115 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

2117 ià(!
»t
 && 
¡¬t_»sÿn_wÜk”
) {

2118 
»t
 = 
	`qgroup_»sÿn_š™
(
fs_šfo
, 0, 1);

2119 ià(!
»t
) {

2120 
	`qgroup_»sÿn_z”o_Œackšg
(
fs_šfo
);

2121 
	`bŒfs_queue_wÜk
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
,

2122 &
fs_šfo
->
qgroup_»sÿn_wÜk
);

2124 
»t
 = 0;

2127 
out
:

2129  
»t
;

2130 
	}
}

2138 
	$bŒfs_qgroup_šh”™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2139 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤cid
, u64 
objeùid
,

2140 
bŒfs_qgroup_šh”™
 *
šh”™
)

2142 
»t
 = 0;

2143 
i
;

2144 
u64
 *
i_qgroups
;

2145 
bŒfs_roÙ
 *
quÙa_roÙ
 = 
fs_šfo
->quota_root;

2146 
bŒfs_qgroup
 *
¤cgroup
;

2147 
bŒfs_qgroup
 *
d¡group
;

2148 
u32
 
Ëv–_size
 = 0;

2149 
u64
 
nums
;

2151 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_ioùl_lock
);

2152 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

2153 
out
;

2155 ià(!
quÙa_roÙ
) {

2156 
»t
 = -
EINVAL
;

2157 
out
;

2160 ià(
šh”™
) {

2161 
i_qgroups
 = (
u64
 *)(
šh”™
 + 1);

2162 
nums
 = 
šh”™
->
num_qgroups
 + 2 * inh”™->
num_»f_cÝ›s
 +

2163 2 * 
šh”™
->
num_exþ_cÝ›s
;

2164 
i
 = 0; i < 
nums
; ++i) {

2165 
¤cgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, *
i_qgroups
);

2171 ià(!
¤cgroup
 ||

2172 ((
¤cgroup
->
qgroupid
 >> 48è<ð(
objeùid
 >> 48)))

2173 *
i_qgroups
 = 0ULL;

2175 ++
i_qgroups
;

2182 
»t
 = 
	`add_qgroup_™em
(
Œªs
, 
quÙa_roÙ
, 
objeùid
);

2183 ià(
»t
)

2184 
out
;

2186 ià(
¤cid
) {

2187 
bŒfs_roÙ
 *
¤üoÙ
;

2188 
bŒfs_key
 
¤ckey
;

2190 
¤ckey
.
objeùid
 = 
¤cid
;

2191 
¤ckey
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

2192 
¤ckey
.
off£t
 = (
u64
)-1;

2193 
¤üoÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
¤ckey
);

2194 ià(
	`IS_ERR
(
¤üoÙ
)) {

2195 
»t
 = 
	`PTR_ERR
(
¤üoÙ
);

2196 
out
;

2199 
Ëv–_size
 = 
fs_šfo
->
nodesize
;

2205 ià(
šh”™
) {

2206 
i_qgroups
 = (
u64
 *)(
šh”™
 + 1);

2207 
i
 = 0; i < 
šh”™
->
num_qgroups
; ++i, ++
i_qgroups
) {

2208 ià(*
i_qgroups
 == 0)

2210 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
,

2211 
objeùid
, *
i_qgroups
);

2212 ià(
»t
 &&„‘ !ð-
EEXIST
)

2213 
out
;

2214 
»t
 = 
	`add_qgroup_»ÏtiÚ_™em
(
Œªs
, 
quÙa_roÙ
,

2215 *
i_qgroups
, 
objeùid
);

2216 ià(
»t
 &&„‘ !ð-
EEXIST
)

2217 
out
;

2219 
»t
 = 0;

2223 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2225 
d¡group
 = 
	`add_qgroup_rb
(
fs_šfo
, 
objeùid
);

2226 ià(
	`IS_ERR
(
d¡group
)) {

2227 
»t
 = 
	`PTR_ERR
(
d¡group
);

2228 
uÆock
;

2231 ià(
šh”™
 && inh”™->
æags
 & 
BTRFS_QGROUP_INHERIT_SET_LIMITS
) {

2232 
d¡group
->
lim_æags
 = 
šh”™
->
lim
.
æags
;

2233 
d¡group
->
max_rãr
 = 
šh”™
->
lim
.max_rfer;

2234 
d¡group
->
max_exþ
 = 
šh”™
->
lim
.max_excl;

2235 
d¡group
->
rsv_rãr
 = 
šh”™
->
lim
.rsv_rfer;

2236 
d¡group
->
rsv_exþ
 = 
šh”™
->
lim
.rsv_excl;

2238 
»t
 = 
	`upd©e_qgroup_lim™_™em
(
Œªs
, 
quÙa_roÙ
, 
d¡group
);

2239 ià(
»t
) {

2240 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

2241 
	`bŒfs_šfo
(
fs_šfo
,

2243 
d¡group
->
qgroupid
);

2244 
uÆock
;

2248 ià(
¤cid
) {

2249 
¤cgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
¤cid
);

2250 ià(!
¤cgroup
)

2251 
uÆock
;

2258 
d¡group
->
rãr
 = 
¤cgroup
->rfer;

2259 
d¡group
->
rãr_cm´
 = 
¤cgroup
->rfer_cmpr;

2260 
d¡group
->
exþ
 = 
Ëv–_size
;

2261 
d¡group
->
exþ_cm´
 = 
Ëv–_size
;

2262 
¤cgroup
->
exþ
 = 
Ëv–_size
;

2263 
¤cgroup
->
exþ_cm´
 = 
Ëv–_size
;

2266 
d¡group
->
lim_æags
 = 
¤cgroup
->lim_flags;

2267 
d¡group
->
max_rãr
 = 
¤cgroup
->max_rfer;

2268 
d¡group
->
max_exþ
 = 
¤cgroup
->max_excl;

2269 
d¡group
->
rsv_rãr
 = 
¤cgroup
->rsv_rfer;

2270 
d¡group
->
rsv_exþ
 = 
¤cgroup
->rsv_excl;

2272 
	`qgroup_dœty
(
fs_šfo
, 
d¡group
);

2273 
	`qgroup_dœty
(
fs_šfo
, 
¤cgroup
);

2276 ià(!
šh”™
)

2277 
uÆock
;

2279 
i_qgroups
 = (
u64
 *)(
šh”™
 + 1);

2280 
i
 = 0; i < 
šh”™
->
num_qgroups
; ++i) {

2281 ià(*
i_qgroups
) {

2282 
»t
 = 
	`add_»ÏtiÚ_rb
(
fs_šfo
, 
objeùid
, *
i_qgroups
);

2283 ià(
»t
)

2284 
uÆock
;

2286 ++
i_qgroups
;

2289 
i
 = 0; i < 
šh”™
->
num_»f_cÝ›s
; ++i, 
i_qgroups
 += 2) {

2290 
bŒfs_qgroup
 *
¤c
;

2291 
bŒfs_qgroup
 *
d¡
;

2293 ià(!
i_qgroups
[0] || !i_qgroups[1])

2296 
¤c
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[0]);

2297 
d¡
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[1]);

2299 ià(!
¤c
 || !
d¡
) {

2300 
»t
 = -
EINVAL
;

2301 
uÆock
;

2304 
d¡
->
rãr
 = 
¤c
->rã¸- 
Ëv–_size
;

2305 
d¡
->
rãr_cm´
 = 
¤c
->rãr_cm´ - 
Ëv–_size
;

2307 
i
 = 0; i < 
šh”™
->
num_exþ_cÝ›s
; ++i, 
i_qgroups
 += 2) {

2308 
bŒfs_qgroup
 *
¤c
;

2309 
bŒfs_qgroup
 *
d¡
;

2311 ià(!
i_qgroups
[0] || !i_qgroups[1])

2314 
¤c
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[0]);

2315 
d¡
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
i_qgroups
[1]);

2317 ià(!
¤c
 || !
d¡
) {

2318 
»t
 = -
EINVAL
;

2319 
uÆock
;

2322 
d¡
->
exþ
 = 
¤c
->exþ + 
Ëv–_size
;

2323 
d¡
->
exþ_cm´
 = 
¤c
->exþ_cm´ + 
Ëv–_size
;

2326 
uÆock
:

2327 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2328 
out
:

2329 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_ioùl_lock
);

2330  
»t
;

2331 
	}
}

2333 
boÞ
 
	$qgroup_check_lim™s
(cÚ¡ 
bŒfs_qgroup
 *
qg
, 
u64
 
num_by‹s
)

2335 ià((
qg
->
lim_æags
 & 
BTRFS_QGROUP_LIMIT_MAX_RFER
) &&

2336 
qg
->
»£rved
 + (
s64
)qg->
rãr
 + 
num_by‹s
 > qg->
max_rãr
)

2337  
çl£
;

2339 ià((
qg
->
lim_æags
 & 
BTRFS_QGROUP_LIMIT_MAX_EXCL
) &&

2340 
qg
->
»£rved
 + (
s64
)qg->
exþ
 + 
num_by‹s
 > qg->
max_exþ
)

2341  
çl£
;

2343  
Œue
;

2344 
	}
}

2346 
	$qgroup_»£rve
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
num_by‹s
, 
boÞ
 
’fÜû
)

2348 
bŒfs_roÙ
 *
quÙa_roÙ
;

2349 
bŒfs_qgroup
 *
qgroup
;

2350 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2351 
u64
 
»f_roÙ
 = 
roÙ
->
roÙ_key
.
objeùid
;

2352 
»t
 = 0;

2353 
»Œ›d
 = 0;

2354 
uli¡_node
 *
unode
;

2355 
uli¡_™”©Ü
 
u™”
;

2357 ià(!
	`is_f¡»e
(
»f_roÙ
))

2360 ià(
num_by‹s
 == 0)

2363 ià(
	`‹¡_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
) &&

2364 
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

2365 
’fÜû
 = 
çl£
;

2367 
»Œy
:

2368 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2369 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

2370 ià(!
quÙa_roÙ
)

2371 
out
;

2373 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

2374 ià(!
qgroup
)

2375 
out
;

2381 
	`uli¡_»š™
(
fs_šfo
->
qgroup_uli¡
);

2382 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
, 
qgroup
->
qgroupid
,

2383 (
ušŒ_t
)
qgroup
, 
GFP_ATOMIC
);

2384 ià(
»t
 < 0)

2385 
out
;

2386 
	`ULIST_ITER_INIT
(&
u™”
);

2387 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

2388 
bŒfs_qgroup
 *
qg
;

2389 
bŒfs_qgroup_li¡
 *
gli¡
;

2391 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

2393 ià(
’fÜû
 && !
	`qgroup_check_lim™s
(
qg
, 
num_by‹s
)) {

2398 ià(!
»Œ›d
 && 
qg
->
»£rved
 > 0) {

2399 
bŒfs_Œªs_hªdË
 *
Œªs
;

2401 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2402 
»t
 = 
	`bŒfs_¡¬t_d–®loc_šodes
(
roÙ
, 0);

2403 ià(
»t
)

2404  
»t
;

2405 
	`bŒfs_wa™_Üd”ed_ex‹Ás
(
roÙ
, 
U64_MAX
, 0, (
u64
)-1);

2406 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

2407 ià(
	`IS_ERR
(
Œªs
))

2408  
	`PTR_ERR
(
Œªs
);

2409 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2410 ià(
»t
)

2411  
»t
;

2412 
»Œ›d
++;

2413 
»Œy
;

2415 
»t
 = -
EDQUOT
;

2416 
out
;

2419 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

2420 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
,

2421 
gli¡
->
group
->
qgroupid
,

2422 (
ušŒ_t
)
gli¡
->
group
, 
GFP_ATOMIC
);

2423 ià(
»t
 < 0)

2424 
out
;

2427 
»t
 = 0;

2431 
	`ULIST_ITER_INIT
(&
u™”
);

2432 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

2433 
bŒfs_qgroup
 *
qg
;

2435 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

2437 
	`Œaû_qgroup_upd©e_»£rve
(
fs_šfo
, 
qg
, 
num_by‹s
);

2438 
qg
->
»£rved
 +ð
num_by‹s
;

2441 
out
:

2442 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2443  
»t
;

2444 
	}
}

2446 
	$bŒfs_qgroup_ä“_»äoÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

2447 
u64
 
»f_roÙ
, u64 
num_by‹s
)

2449 
bŒfs_roÙ
 *
quÙa_roÙ
;

2450 
bŒfs_qgroup
 *
qgroup
;

2451 
uli¡_node
 *
unode
;

2452 
uli¡_™”©Ü
 
u™”
;

2453 
»t
 = 0;

2455 ià(!
	`is_f¡»e
(
»f_roÙ
))

2458 ià(
num_by‹s
 == 0)

2461 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2463 
quÙa_roÙ
 = 
fs_šfo
->quota_root;

2464 ià(!
quÙa_roÙ
)

2465 
out
;

2467 
qgroup
 = 
	`fšd_qgroup_rb
(
fs_šfo
, 
»f_roÙ
);

2468 ià(!
qgroup
)

2469 
out
;

2471 
	`uli¡_»š™
(
fs_šfo
->
qgroup_uli¡
);

2472 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
, 
qgroup
->
qgroupid
,

2473 (
ušŒ_t
)
qgroup
, 
GFP_ATOMIC
);

2474 ià(
»t
 < 0)

2475 
out
;

2476 
	`ULIST_ITER_INIT
(&
u™”
);

2477 (
unode
 = 
	`uli¡_Ãxt
(
fs_šfo
->
qgroup_uli¡
, &
u™”
))) {

2478 
bŒfs_qgroup
 *
qg
;

2479 
bŒfs_qgroup_li¡
 *
gli¡
;

2481 
qg
 = 
	`unode_aux_to_qgroup
(
unode
);

2483 
	`Œaû_qgroup_upd©e_»£rve
(
fs_šfo
, 
qg
, -(
s64
)
num_by‹s
);

2484 ià(
qg
->
»£rved
 < 
num_by‹s
)

2485 
	`»pÜt_»£rved_und”æow
(
fs_šfo
, 
qg
, 
num_by‹s
);

2487 
qg
->
»£rved
 -ð
num_by‹s
;

2489 
	`li¡_fÜ_—ch_’Œy
(
gli¡
, &
qg
->
groups
, 
Ãxt_group
) {

2490 
»t
 = 
	`uli¡_add
(
fs_šfo
->
qgroup_uli¡
,

2491 
gli¡
->
group
->
qgroupid
,

2492 (
ušŒ_t
)
gli¡
->
group
, 
GFP_ATOMIC
);

2493 ià(
»t
 < 0)

2494 
out
;

2498 
out
:

2499 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2500 
	}
}

2507 
	$qgroup_»sÿn_Ëaf
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_·th
 *
·th
,

2508 
bŒfs_Œªs_hªdË
 *
Œªs
)

2510 
bŒfs_key
 
found
;

2511 
ex‹Á_bufãr
 *
sü©ch_Ëaf
 = 
NULL
;

2512 
uli¡
 *
roÙs
 = 
NULL
;

2513 
£q_li¡
 
Œ“_mod_£q_–em
 = 
	`SEQ_LIST_INIT
(tree_mod_seq_elem);

2514 
u64
 
num_by‹s
;

2515 
¦Ù
;

2516 
»t
;

2518 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2519 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
fs_šfo
->
ex‹Á_roÙ
,

2520 &
fs_šfo
->
qgroup_»sÿn_´og»ss
,

2521 
·th
, 1, 0);

2523 
	`bŒfs_debug
(
fs_šfo
,

2525 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
,

2526 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
ty³
,

2527 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
off£t
, 
»t
);

2529 ià(
»t
) {

2538 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = (
u64
)-1;

2539 
	`bŒfs_»Ëa£_·th
(
·th
);

2540 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2541  
»t
;

2544 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found
,

2545 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]) - 1);

2546 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = 
found
.objectid + 1;

2548 
	`bŒfs_g‘_Œ“_mod_£q
(
fs_šfo
, &
Œ“_mod_£q_–em
);

2549 
sü©ch_Ëaf
 = 
	`bŒfs_þÚe_ex‹Á_bufãr
(
·th
->
nodes
[0]);

2550 ià(!
sü©ch_Ëaf
) {

2551 
»t
 = -
ENOMEM
;

2552 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2553 
out
;

2555 
	`ex‹Á_bufãr_g‘
(
sü©ch_Ëaf
);

2556 
	`bŒfs_Œ“_»ad_lock
(
sü©ch_Ëaf
);

2557 
	`bŒfs_£t_lock_blockšg_rw
(
sü©ch_Ëaf
, 
BTRFS_READ_LOCK
);

2558 
¦Ù
 = 
·th
->
¦Ùs
[0];

2559 
	`bŒfs_»Ëa£_·th
(
·th
);

2560 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2562 ; 
¦Ù
 < 
	`bŒfs_h—d”_Ä™ems
(
sü©ch_Ëaf
); ++slot) {

2563 
	`bŒfs_™em_key_to_ýu
(
sü©ch_Ëaf
, &
found
, 
¦Ù
);

2564 ià(
found
.
ty³
 !ð
BTRFS_EXTENT_ITEM_KEY
 &&

2565 
found
.
ty³
 !ð
BTRFS_METADATA_ITEM_KEY
)

2567 ià(
found
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

2568 
num_by‹s
 = 
fs_šfo
->
nodesize
;

2570 
num_by‹s
 = 
found
.
off£t
;

2572 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(
NULL
, 
fs_šfo
, 
found
.
objeùid
, 0,

2573 &
roÙs
);

2574 ià(
»t
 < 0)

2575 
out
;

2577 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(
Œªs
, 
fs_šfo
,

2578 
found
.
objeùid
, 
num_by‹s
, 
NULL
, 
roÙs
);

2579 ià(
»t
 < 0)

2580 
out
;

2582 
out
:

2583 ià(
sü©ch_Ëaf
) {

2584 
	`bŒfs_Œ“_»ad_uÆock_blockšg
(
sü©ch_Ëaf
);

2585 
	`ä“_ex‹Á_bufãr
(
sü©ch_Ëaf
);

2587 
	`bŒfs_put_Œ“_mod_£q
(
fs_šfo
, &
Œ“_mod_£q_–em
);

2589  
»t
;

2590 
	}
}

2592 
	$bŒfs_qgroup_»sÿn_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

2594 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`cÚš”_of
(
wÜk
, btrfs_fs_info,

2595 
qgroup_»sÿn_wÜk
);

2596 
bŒfs_·th
 *
·th
;

2597 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

2598 
”r
 = -
ENOMEM
;

2599 
»t
 = 0;

2601 
·th
 = 
	`bŒfs_®loc_·th
();

2602 ià(!
·th
)

2603 
out
;

2605 
”r
 = 0;

2606 !
”r
 && !
	`bŒfs_fs_þosšg
(
fs_šfo
)) {

2607 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
fs_roÙ
, 0);

2608 ià(
	`IS_ERR
(
Œªs
)) {

2609 
”r
 = 
	`PTR_ERR
(
Œªs
);

2612 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
)) {

2613 
”r
 = -
EINTR
;

2615 
”r
 = 
	`qgroup_»sÿn_Ëaf
(
fs_šfo
, 
·th
, 
Œªs
);

2617 ià(
”r
 > 0)

2618 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2620 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2623 
out
:

2624 
	`bŒfs_ä“_·th
(
·th
);

2626 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2627 ià(!
	`bŒfs_fs_þosšg
(
fs_šfo
))

2628 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

2630 ià(
”r
 > 0 &&

2631 
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
) {

2632 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

2633 } ià(
”r
 < 0) {

2634 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_INCONSISTENT
;

2636 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2642 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
quÙa_roÙ
, 1);

2643 ià(
	`IS_ERR
(
Œªs
)) {

2644 
”r
 = 
	`PTR_ERR
(
Œªs
);

2645 
	`bŒfs_”r
(
fs_šfo
,

2647 
”r
);

2648 
dÚe
;

2650 
»t
 = 
	`upd©e_qgroup_¡©us_™em
(
Œªs
, 
fs_šfo
, fs_šfo->
quÙa_roÙ
);

2651 ià(
»t
 < 0) {

2652 
”r
 = 
»t
;

2653 
	`bŒfs_”r
(
fs_šfo
, "çžØupd©qgrou°¡©us: %d", 
”r
);

2655 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2657 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
)) {

2658 
	`bŒfs_šfo
(
fs_šfo
, "qgroup scan…aused");

2659 } ià(
”r
 >= 0) {

2660 
	`bŒfs_šfo
(
fs_šfo
, "qgroup scan completed%s",

2661 
”r
 > 0 ? " (inconsistency flag cleared)" : "");

2663 
	`bŒfs_”r
(
fs_šfo
, "qgrou°sÿÀçžed w™h %d", 
”r
);

2666 
dÚe
:

2667 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2668 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
çl£
;

2669 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2670 
	`com¶‘e_®l
(&
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

2671 
	}
}

2678 
	$qgroup_»sÿn_š™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
´og»ss_objeùid
,

2679 
š™_æags
)

2681 
»t
 = 0;

2683 ià(!
š™_æags
 &&

2684 (!(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
) ||

2685 !(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
))) {

2686 
»t
 = -
EINVAL
;

2687 
”r
;

2690 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2691 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2693 ià(
š™_æags
) {

2694 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
)

2695 
»t
 = -
EINPROGRESS
;

2696 ià(!(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_ON
))

2697 
»t
 = -
EINVAL
;

2699 ià(
»t
) {

2700 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2701 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2702 
”r
;

2704 
fs_šfo
->
qgroup_æags
 |ð
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

2707 
	`mem£t
(&
fs_šfo
->
qgroup_»sÿn_´og»ss
, 0,

2708 (
fs_šfo
->
qgroup_»sÿn_´og»ss
));

2709 
fs_šfo
->
qgroup_»sÿn_´og»ss
.
objeùid
 = 
´og»ss_objeùid
;

2710 
	`š™_com¶‘iÚ
(&
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

2711 
fs_šfo
->
qgroup_»sÿn_ruÂšg
 = 
Œue
;

2713 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2714 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2716 
	`mem£t
(&
fs_šfo
->
qgroup_»sÿn_wÜk
, 0,

2717 (
fs_šfo
->
qgroup_»sÿn_wÜk
));

2718 
	`bŒfs_š™_wÜk
(&
fs_šfo
->
qgroup_»sÿn_wÜk
,

2719 
bŒfs_qgroup_»sÿn_h–³r
,

2720 
bŒfs_qgroup_»sÿn_wÜk”
, 
NULL
, NULL);

2722 ià(
»t
) {

2723 
”r
:

2724 
	`bŒfs_šfo
(
fs_šfo
, "qgroup_»sÿn_š™ fažed w™h %d", 
»t
);

2725  
»t
;

2729 
	}
}

2732 
	$qgroup_»sÿn_z”o_Œackšg
(
bŒfs_fs_šfo
 *
fs_šfo
)

2734 
rb_node
 *
n
;

2735 
bŒfs_qgroup
 *
qgroup
;

2737 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2739 
n
 = 
	`rb_fœ¡
(&
fs_šfo
->
qgroup_Œ“
);‚;‚ = 
	`rb_Ãxt
(n)) {

2740 
qgroup
 = 
	`rb_’Œy
(
n
, 
bŒfs_qgroup
, 
node
);

2741 
qgroup
->
rãr
 = 0;

2742 
qgroup
->
rãr_cm´
 = 0;

2743 
qgroup
->
exþ
 = 0;

2744 
qgroup
->
exþ_cm´
 = 0;

2746 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2747 
	}
}

2750 
	$bŒfs_qgroup_»sÿn
(
bŒfs_fs_šfo
 *
fs_šfo
)

2752 
»t
 = 0;

2753 
bŒfs_Œªs_hªdË
 *
Œªs
;

2755 
»t
 = 
	`qgroup_»sÿn_š™
(
fs_šfo
, 0, 1);

2756 ià(
»t
)

2757  
»t
;

2770 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
fs_šfo
->
fs_roÙ
);

2771 ià(
	`IS_ERR
(
Œªs
)) {

2772 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

2773  
	`PTR_ERR
(
Œªs
);

2775 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2776 ià(
»t
) {

2777 
fs_šfo
->
qgroup_æags
 &ð~
BTRFS_QGROUP_STATUS_FLAG_RESCAN
;

2778  
»t
;

2781 
	`qgroup_»sÿn_z”o_Œackšg
(
fs_šfo
);

2783 
	`bŒfs_queue_wÜk
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
,

2784 &
fs_šfo
->
qgroup_»sÿn_wÜk
);

2787 
	}
}

2789 
	$bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

2790 
boÞ
 
š‹¼u±ibË
)

2792 
ruÂšg
;

2793 
»t
 = 0;

2795 
	`mu‹x_lock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2796 
	`¥š_lock
(&
fs_šfo
->
qgroup_lock
);

2797 
ruÂšg
 = 
fs_šfo
->
qgroup_»sÿn_ruÂšg
;

2798 
	`¥š_uÆock
(&
fs_šfo
->
qgroup_lock
);

2799 
	`mu‹x_uÆock
(&
fs_šfo
->
qgroup_»sÿn_lock
);

2801 ià(!
ruÂšg
)

2804 ià(
š‹¼u±ibË
)

2805 
»t
 = 
	`wa™_fÜ_com¶‘iÚ_š‹¼u±ibË
(

2806 &
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

2808 
	`wa™_fÜ_com¶‘iÚ
(&
fs_šfo
->
qgroup_»sÿn_com¶‘iÚ
);

2810  
»t
;

2811 
	}
}

2818 
	$bŒfs_qgroup_»sÿn_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
)

2820 ià(
fs_šfo
->
qgroup_æags
 & 
BTRFS_QGROUP_STATUS_FLAG_RESCAN
)

2821 
	`bŒfs_queue_wÜk
(
fs_šfo
->
qgroup_»sÿn_wÜk”s
,

2822 &
fs_šfo
->
qgroup_»sÿn_wÜk
);

2823 
	}
}

2839 
	$bŒfs_qgroup_»£rve_d©a
(
šode
 *inode,

2840 
ex‹Á_chªge£t
 **
»£rved_»t
, 
u64
 
¡¬t
,

2841 
u64
 
Ën
)

2843 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2844 
uli¡_node
 *
unode
;

2845 
uli¡_™”©Ü
 
u™”
;

2846 
ex‹Á_chªge£t
 *
»£rved
;

2847 
u64
 
Üig_»£rved
;

2848 
u64
 
to_»£rve
;

2849 
»t
;

2851 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
roÙ
->
fs_šfo
->
æags
) ||

2852 !
	`is_f¡»e
(
roÙ
->
objeùid
è|| 
Ën
 == 0)

2856 ià(
	`WARN_ON
(!
»£rved_»t
))

2857  -
EINVAL
;

2858 ià(!*
»£rved_»t
) {

2859 *
»£rved_»t
 = 
	`ex‹Á_chªge£t_®loc
();

2860 ià(!*
»£rved_»t
)

2861  -
ENOMEM
;

2863 
»£rved
 = *
»£rved_»t
;

2865 
Üig_»£rved
 = 
»£rved
->
by‹s_chªged
;

2866 
»t
 = 
	`£t_»cÜd_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
,

2867 
¡¬t
 + 
Ën
 -1, 
EXTENT_QGROUP_RESERVED
, 
»£rved
);

2870 
to_»£rve
 = 
»£rved
->
by‹s_chªged
 - 
Üig_»£rved
;

2871 
	`Œaû_bŒfs_qgroup_»£rve_d©a
(
šode
, 
¡¬t
, 
Ën
,

2872 
to_»£rve
, 
QGROUP_RESERVE
);

2873 ià(
»t
 < 0)

2874 
þ—nup
;

2875 
»t
 = 
	`qgroup_»£rve
(
roÙ
, 
to_»£rve
, 
Œue
);

2876 ià(
»t
 < 0)

2877 
þ—nup
;

2879  
»t
;

2881 
þ—nup
:

2883 
	`ULIST_ITER_INIT
(&
u™”
);

2884 (
unode
 = 
	`uli¡_Ãxt
(&
»£rved
->
¿nge_chªged
, &
u™”
)))

2885 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
unode
->
v®
,

2886 
unode
->
aux
, 
EXTENT_QGROUP_RESERVED
, 0, 0, 
NULL
,

2887 
GFP_NOFS
);

2888 
	`ex‹Á_chªge£t_»Ëa£
(
»£rved
);

2889  
»t
;

2890 
	}
}

2893 
	$qgroup_ä“_»£rved_d©a
(
šode
 *inode,

2894 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

2896 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

2897 
uli¡_node
 *
unode
;

2898 
uli¡_™”©Ü
 
u™”
;

2899 
ex‹Á_chªge£t
 
chªge£t
;

2900 
ä“d
 = 0;

2901 
»t
;

2903 
	`ex‹Á_chªge£t_š™
(&
chªge£t
);

2904 
Ën
 = 
	`round_up
(
¡¬t
 +†’, 
roÙ
->
fs_šfo
->
£ùÜsize
);

2905 
¡¬t
 = 
	`round_down
(¡¬t, 
roÙ
->
fs_šfo
->
£ùÜsize
);

2907 
	`ULIST_ITER_INIT
(&
u™”
);

2908 (
unode
 = 
	`uli¡_Ãxt
(&
»£rved
->
¿nge_chªged
, &
u™”
))) {

2909 
u64
 
¿nge_¡¬t
 = 
unode
->
v®
;

2911 
u64
 
¿nge_Ën
 = 
unode
->
aux
 - 
¿nge_¡¬t
 + 1;

2912 
u64
 
ä“_¡¬t
;

2913 
u64
 
ä“_Ën
;

2915 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

2918 ià(
¿nge_¡¬t
 >ð
¡¬t
 + 
Ën
 ||

2919 
¿nge_¡¬t
 + 
¿nge_Ën
 <ð
¡¬t
)

2921 
ä“_¡¬t
 = 
	`max
(
¿nge_¡¬t
, 
¡¬t
);

2922 
ä“_Ën
 = 
	`mš
(
¡¬t
 + 
Ën
, 
¿nge_¡¬t
 + 
¿nge_Ën
) -

2923 
ä“_¡¬t
;

2932 
»t
 = 
	`þ—r_»cÜd_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_çžu»_Œ“
,

2933 
ä“_¡¬t
, f»e_¡¬ˆ+ 
ä“_Ën
 - 1,

2934 
EXTENT_QGROUP_RESERVED
, &
chªge£t
);

2935 ià(
»t
 < 0)

2936 
out
;

2937 
ä“d
 +ð
chªge£t
.
by‹s_chªged
;

2939 
	`bŒfs_qgroup_ä“_»äoÙ
(
roÙ
->
fs_šfo
,„oÙ->
objeùid
, 
ä“d
);

2940 
»t
 = 
ä“d
;

2941 
out
:

2942 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

2943  
»t
;

2944 
	}
}

2946 
	$__bŒfs_qgroup_»Ëa£_d©a
(
šode
 *inode,

2947 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
,

2948 
ä“
)

2950 
ex‹Á_chªge£t
 
chªge£t
;

2951 
Œaû_Ý
 = 
QGROUP_RELEASE
;

2952 
»t
;

2955 
	`WARN_ON
(!
ä“
 && 
»£rved
);

2956 ià(
ä“
 && 
»£rved
)

2957  
	`qgroup_ä“_»£rved_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
);

2958 
	`ex‹Á_chªge£t_š™
(&
chªge£t
);

2959 
»t
 = 
	`þ—r_»cÜd_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
,

2960 
¡¬t
 + 
Ën
 -1, 
EXTENT_QGROUP_RESERVED
, &
chªge£t
);

2961 ià(
»t
 < 0)

2962 
out
;

2964 ià(
ä“
)

2965 
Œaû_Ý
 = 
QGROUP_FREE
;

2966 
	`Œaû_bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
¡¬t
, 
Ën
,

2967 
chªge£t
.
by‹s_chªged
, 
Œaû_Ý
);

2968 ià(
ä“
)

2969 
	`bŒfs_qgroup_ä“_»äoÙ
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

2970 
	`BTRFS_I
(
šode
)->
roÙ
->
objeùid
,

2971 
chªge£t
.
by‹s_chªged
);

2972 
»t
 = 
chªge£t
.
by‹s_chªged
;

2973 
out
:

2974 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

2975  
»t
;

2976 
	}
}

2990 
	$bŒfs_qgroup_ä“_d©a
(
šode
 *inode,

2991 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
)

2993  
	`__bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
»£rved
, 
¡¬t
, 
Ën
, 1);

2994 
	}
}

3011 
	$bŒfs_qgroup_»Ëa£_d©a
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
)

3013  
	`__bŒfs_qgroup_»Ëa£_d©a
(
šode
, 
NULL
, 
¡¬t
, 
Ën
, 0);

3014 
	}
}

3016 
	$bŒfs_qgroup_»£rve_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

3017 
boÞ
 
’fÜû
)

3019 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3020 
»t
;

3022 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

3023 !
	`is_f¡»e
(
roÙ
->
objeùid
è|| 
num_by‹s
 == 0)

3026 
	`BUG_ON
(
num_by‹s
 !ð
	`round_down
Òum_by‹s, 
fs_šfo
->
nodesize
));

3027 
	`Œaû_qgroup_m‘a_»£rve
(
roÙ
, (
s64
)
num_by‹s
);

3028 
»t
 = 
	`qgroup_»£rve
(
roÙ
, 
num_by‹s
, 
’fÜû
);

3029 ià(
»t
 < 0)

3030  
»t
;

3031 
	`©omic64_add
(
num_by‹s
, &
roÙ
->
qgroup_m‘a_rsv
);

3032  
»t
;

3033 
	}
}

3035 
	$bŒfs_qgroup_ä“_m‘a_®l
(
bŒfs_roÙ
 *
roÙ
)

3037 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3038 
u64
 
»£rved
;

3040 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

3041 !
	`is_f¡»e
(
roÙ
->
objeùid
))

3044 
»£rved
 = 
	`©omic64_xchg
(&
roÙ
->
qgroup_m‘a_rsv
, 0);

3045 ià(
»£rved
 == 0)

3047 
	`Œaû_qgroup_m‘a_»£rve
(
roÙ
, -(
s64
)
»£rved
);

3048 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
, 
roÙ
->
objeùid
, 
»£rved
);

3049 
	}
}

3051 
	$bŒfs_qgroup_ä“_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
)

3053 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3055 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
) ||

3056 !
	`is_f¡»e
(
roÙ
->
objeùid
))

3059 
	`BUG_ON
(
num_by‹s
 !ð
	`round_down
Òum_by‹s, 
fs_šfo
->
nodesize
));

3060 
	`WARN_ON
(
	`©omic64_»ad
(&
roÙ
->
qgroup_m‘a_rsv
è< 
num_by‹s
);

3061 
	`©omic64_sub
(
num_by‹s
, &
roÙ
->
qgroup_m‘a_rsv
);

3062 
	`Œaû_qgroup_m‘a_»£rve
(
roÙ
, -(
s64
)
num_by‹s
);

3063 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
, 
roÙ
->
objeùid
, 
num_by‹s
);

3064 
	}
}

3070 
	$bŒfs_qgroup_check_»£rved_Ëak
(
šode
 *inode)

3072 
ex‹Á_chªge£t
 
chªge£t
;

3073 
uli¡_node
 *
unode
;

3074 
uli¡_™”©Ü
 
™”
;

3075 
»t
;

3077 
	`ex‹Á_chªge£t_š™
(&
chªge£t
);

3078 
»t
 = 
	`þ—r_»cÜd_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, (
u64
)-1,

3079 
EXTENT_QGROUP_RESERVED
, &
chªge£t
);

3081 
	`WARN_ON
(
»t
 < 0);

3082 ià(
	`WARN_ON
(
chªge£t
.
by‹s_chªged
)) {

3083 
	`ULIST_ITER_INIT
(&
™”
);

3084 (
unode
 = 
	`uli¡_Ãxt
(&
chªge£t
.
¿nge_chªged
, &
™”
))) {

3085 
	`bŒfs_w¬n
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

3087 
šode
->
i_šo
, 
unode
->
v®
, unode->
aux
);

3089 
	`bŒfs_qgroup_ä“_»äoÙ
(
	`BTRFS_I
(
šode
)->
roÙ
->
fs_šfo
,

3090 
	`BTRFS_I
(
šode
)->
roÙ
->
objeùid
,

3091 
chªge£t
.
by‹s_chªged
);

3094 
	`ex‹Á_chªge£t_»Ëa£
(&
chªge£t
);

3095 
	}
}

	@qgroup.h

19 #iâdeà
__BTRFS_QGROUP__


20 
	#__BTRFS_QGROUP__


	)

22 
	~"uli¡.h
"

23 
	~"d–ayed-»f.h
"

57 
	sbŒfs_qgroup_ex‹Á_»cÜd
 {

58 
rb_node
 
	mnode
;

59 
u64
 
	mby‹Ä
;

60 
u64
 
	mnum_by‹s
;

61 
uli¡
 *
	mÞd_roÙs
;

67 
	sbŒfs_qgroup
 {

68 
u64
 
	mqgroupid
;

73 
u64
 
	mrãr
;

74 
u64
 
	mrãr_cm´
;

75 
u64
 
	mexþ
;

76 
u64
 
	mexþ_cm´
;

81 
u64
 
	mlim_æags
;

82 
u64
 
	mmax_rãr
;

83 
u64
 
	mmax_exþ
;

84 
u64
 
	mrsv_rãr
;

85 
u64
 
	mrsv_exþ
;

90 
u64
 
	m»£rved
;

95 
li¡_h—d
 
	mgroups
;

96 
li¡_h—d
 
	mmemb”s
;

97 
li¡_h—d
 
	mdœty
;

98 
rb_node
 
	mnode
;

104 
u64
 
	mÞd_»fút
;

105 
u64
 
	mÃw_»fút
;

111 
	#QGROUP_RESERVE
 (1<<0)

	)

112 
	#QGROUP_RELEASE
 (1<<1)

	)

113 
	#QGROUP_FREE
 (1<<2)

	)

115 
bŒfs_quÙa_’abË
(
bŒfs_Œªs_hªdË
 *
Œªs
,

116 
bŒfs_fs_šfo
 *
fs_šfo
);

117 
bŒfs_quÙa_di§bË
(
bŒfs_Œªs_hªdË
 *
Œªs
,

118 
bŒfs_fs_šfo
 *
fs_šfo
);

119 
bŒfs_qgroup_»sÿn
(
bŒfs_fs_šfo
 *
fs_šfo
);

120 
bŒfs_qgroup_»sÿn_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
);

121 
bŒfs_qgroup_wa™_fÜ_com¶‘iÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

122 
boÞ
 
š‹¼u±ibË
);

123 
bŒfs_add_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

124 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤c
, u64 
d¡
);

125 
bŒfs_d–_qgroup_»ÏtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

126 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤c
, u64 
d¡
);

127 
bŒfs_ü—‹_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

128 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
);

129 
bŒfs_»move_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

130 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
);

131 
bŒfs_lim™_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

132 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
,

133 
bŒfs_qgroup_lim™
 *
lim™
);

134 
bŒfs_»ad_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
);

135 
bŒfs_ä“_qgroup_cÚfig
(
bŒfs_fs_šfo
 *
fs_šfo
);

136 
	gbŒfs_d–ayed_ex‹Á_Ý
;

149 
bŒfs_qgroup_Œaû_ex‹Á_nÞock
(

150 
bŒfs_fs_šfo
 *
fs_šfo
,

151 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
,

152 
bŒfs_qgroup_ex‹Á_»cÜd
 *
»cÜd
);

175 
bŒfs_qgroup_Œaû_ex‹Á_po¡
(
bŒfs_fs_šfo
 *
fs_šfo
,

176 
bŒfs_qgroup_ex‹Á_»cÜd
 *
q»cÜd
);

191 
bŒfs_qgroup_Œaû_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

192 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
, u64 
num_by‹s
,

193 
gå_t
 
gå_æag
);

201 
bŒfs_qgroup_Œaû_Ëaf_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

202 
bŒfs_fs_šfo
 *
fs_šfo
,

203 
ex‹Á_bufãr
 *
eb
);

214 
bŒfs_qgroup_Œaû_subŒ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

215 
bŒfs_roÙ
 *
roÙ
,

216 
ex‹Á_bufãr
 *
roÙ_eb
,

217 
u64
 
roÙ_g’
, 
roÙ_Ëv–
);

219 
bŒfs_qgroup_accouÁ_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

220 
bŒfs_fs_šfo
 *
fs_šfo
,

221 
u64
 
by‹Ä
, u64 
num_by‹s
,

222 
uli¡
 *
Þd_roÙs
, uli¡ *
Ãw_roÙs
);

223 
bŒfs_qgroup_accouÁ_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

224 
bŒfs_fs_šfo
 *
fs_šfo
);

225 
bŒfs_run_qgroups
(
bŒfs_Œªs_hªdË
 *
Œªs
,

226 
bŒfs_fs_šfo
 *
fs_šfo
);

227 
bŒfs_qgroup_šh”™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

228 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¤cid
, u64 
objeùid
,

229 
bŒfs_qgroup_šh”™
 *
šh”™
);

230 
bŒfs_qgroup_ä“_»äoÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

231 
u64
 
»f_roÙ
, u64 
num_by‹s
);

232 
šlše
 
	$bŒfs_qgroup_ä“_d–ayed_»f
(
bŒfs_fs_šfo
 *
fs_šfo
,

233 
u64
 
»f_roÙ
, u64 
num_by‹s
)

235 
	`Œaû_bŒfs_qgroup_ä“_d–ayed_»f
(
fs_šfo
, 
»f_roÙ
, 
num_by‹s
);

236 
	`bŒfs_qgroup_ä“_»äoÙ
(
fs_šfo
, 
»f_roÙ
, 
num_by‹s
);

237 
	}
}

239 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


240 
bŒfs_v”ify_qgroup_couÁs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
qgroupid
,

241 
u64
 
rãr
, u64 
exþ
);

245 
bŒfs_qgroup_»£rve_d©a
(
šode
 *inode,

246 
ex‹Á_chªge£t
 **
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

247 
bŒfs_qgroup_»Ëa£_d©a
(
šode
 *šode, 
u64
 
¡¬t
, u64 
Ën
);

248 
bŒfs_qgroup_ä“_d©a
(
šode
 *inode,

249 
ex‹Á_chªge£t
 *
»£rved
, 
u64
 
¡¬t
, u64 
Ën
);

251 
bŒfs_qgroup_»£rve_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
,

252 
boÞ
 
’fÜû
);

253 
bŒfs_qgroup_ä“_m‘a_®l
(
bŒfs_roÙ
 *
roÙ
);

254 
bŒfs_qgroup_ä“_m‘a
(
bŒfs_roÙ
 *
roÙ
, 
num_by‹s
);

255 
bŒfs_qgroup_check_»£rved_Ëak
(
šode
 *inode);

	@raid56.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/wa™.h
>

21 
	~<lšux/bio.h
>

22 
	~<lšux/¦ab.h
>

23 
	~<lšux/bufãr_h—d.h
>

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/¿ndom.h
>

26 
	~<lšux/iocÚ‹xt.h
>

27 
	~<lšux/ÿ·bž™y.h
>

28 
	~<lšux/¿‹lim™.h
>

29 
	~<lšux/kth»ad.h
>

30 
	~<lšux/¿id/pq.h
>

31 
	~<lšux/hash.h
>

32 
	~<lšux/li¡_sÜt.h
>

33 
	~<lšux/¿id/xÜ.h
>

34 
	~<lšux/mm.h
>

35 
	~<asm/div64.h
>

36 
	~"ù»e.h
"

37 
	~"ex‹Á_m­.h
"

38 
	~"disk-io.h
"

39 
	~"Œª§ùiÚ.h
"

40 
	~"´št-Œ“.h
"

41 
	~"vÞumes.h
"

42 
	~"¿id56.h
"

43 
	~"async-th»ad.h
"

44 
	~"check-š‹gr™y.h
"

45 
	~"rcu-¡ršg.h
"

48 
	#RBIO_RMW_LOCKED_BIT
 1

	)

54 
	#RBIO_CACHE_BIT
 2

	)

59 
	#RBIO_CACHE_READY_BIT
 3

	)

61 
	#RBIO_CACHE_SIZE
 1024

	)

63 
	ebŒfs_rbio_Ýs
 {

64 
	mBTRFS_RBIO_WRITE
,

65 
	mBTRFS_RBIO_READ_REBUILD
,

66 
	mBTRFS_RBIO_PARITY_SCRUB
,

67 
	mBTRFS_RBIO_REBUILD_MISSING
,

70 
	sbŒfs_¿id_bio
 {

71 
bŒfs_fs_šfo
 *
	mfs_šfo
;

72 
bŒfs_bio
 *
	mbbio
;

79 
li¡_h—d
 
	mhash_li¡
;

84 
li¡_h—d
 
	m¡re_ÿche
;

89 
bŒfs_wÜk
 
	mwÜk
;

96 
bio_li¡
 
	mbio_li¡
;

97 
¥šlock_t
 
	mbio_li¡_lock
;

105 
li¡_h—d
 
	m¶ug_li¡
;

111 
	mæags
;

114 
	m¡re_Ën
;

117 
	mÄ_d©a
;

119 
	m»®_¡res
;

121 
	m¡re_Åages
;

128 
bŒfs_rbio_Ýs
 
	mÝ”©iÚ
;

131 
	mçža
;

134 
	mçžb
;

136 
	msüubp
;

141 
	mÄ_·ges
;

148 
	mbio_li¡_by‹s
;

150 
	mg’”ic_bio_út
;

152 
»fcouÁ_t
 
	m»fs
;

154 
©omic_t
 
	m¡res_³ndšg
;

156 
©omic_t
 
	m”rÜ
;

166 
·ge
 **
	m¡re_·ges
;

172 
·ge
 **
	mbio_·ges
;

177 *
	mdb™m­
;

180 
__¿id56_·r™y_»cov”
(
bŒfs_¿id_bio
 *
rbio
);

181 
nošlše
 
fšish_rmw
(
bŒfs_¿id_bio
 *
rbio
);

182 
rmw_wÜk
(
bŒfs_wÜk
 *
wÜk
);

183 
»ad_»bužd_wÜk
(
bŒfs_wÜk
 *
wÜk
);

184 
async_rmw_¡re
(
bŒfs_¿id_bio
 *
rbio
);

185 
async_»ad_»bužd
(
bŒfs_¿id_bio
 *
rbio
);

186 
çž_bio_¡re
(
bŒfs_¿id_bio
 *
rbio
, 
bio
 *bio);

187 
çž_rbio_šdex
(
bŒfs_¿id_bio
 *
rbio
, 
çžed
);

188 
__ä“_¿id_bio
(
bŒfs_¿id_bio
 *
rbio
);

189 
šdex_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
);

190 
®loc_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
);

192 
nošlše
 
fšish_·r™y_süub
(
bŒfs_¿id_bio
 *
rbio
,

193 
Ãed_check
);

194 
async_süub_·r™y
(
bŒfs_¿id_bio
 *
rbio
);

200 
	$bŒfs_®loc_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
)

202 
bŒfs_¡re_hash_bË
 *
bË
;

203 
bŒfs_¡re_hash_bË
 *
x
;

204 
bŒfs_¡re_hash
 *
cur
;

205 
bŒfs_¡re_hash
 *
h
;

206 
num_’Œ›s
 = 1 << 
BTRFS_STRIPE_HASH_TABLE_BITS
;

207 
i
;

208 
bË_size
;

210 ià(
šfo
->
¡re_hash_bË
)

220 
bË_size
 = (*
bË
è+ (*
h
è* 
num_’Œ›s
;

221 
bË
 = 
	`kvz®loc
(
bË_size
, 
GFP_KERNEL
);

222 ià(!
bË
)

223  -
ENOMEM
;

225 
	`¥š_lock_š™
(&
bË
->
ÿche_lock
);

226 
	`INIT_LIST_HEAD
(&
bË
->
¡re_ÿche
);

228 
h
 = 
bË
->table;

230 
i
 = 0; i < 
num_’Œ›s
; i++) {

231 
cur
 = 
h
 + 
i
;

232 
	`INIT_LIST_HEAD
(&
cur
->
hash_li¡
);

233 
	`¥š_lock_š™
(&
cur
->
lock
);

234 
	`š™_wa™queue_h—d
(&
cur
->
wa™
);

237 
x
 = 
	`cmpxchg
(&
šfo
->
¡re_hash_bË
, 
NULL
, 
bË
);

238 ià(
x
)

239 
	`kvä“
(
x
);

241 
	}
}

252 
	$ÿche_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
)

254 
i
;

255 *
s
;

256 *
d
;

257 
»t
;

259 
»t
 = 
	`®loc_rbio_·ges
(
rbio
);

260 ià(
»t
)

263 
i
 = 0; i < 
rbio
->
Ä_·ges
; i++) {

264 ià(!
rbio
->
bio_·ges
[
i
])

267 
s
 = 
	`km­
(
rbio
->
bio_·ges
[
i
]);

268 
d
 = 
	`km­
(
rbio
->
¡re_·ges
[
i
]);

270 
	`memýy
(
d
, 
s
, 
PAGE_SIZE
);

272 
	`kunm­
(
rbio
->
bio_·ges
[
i
]);

273 
	`kunm­
(
rbio
->
¡re_·ges
[
i
]);

274 
	`S‘PageU±od©e
(
rbio
->
¡re_·ges
[
i
]);

276 
	`£t_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

277 
	}
}

282 
	$rbio_buck‘
(
bŒfs_¿id_bio
 *
rbio
)

284 
u64
 
num
 = 
rbio
->
bbio
->
¿id_m­
[0];

294  
	`hash_64
(
num
 >> 16, 
BTRFS_STRIPE_HASH_TABLE_BITS
);

295 
	}
}

301 
	$¡—l_rbio
(
bŒfs_¿id_bio
 *
¤c
, bŒfs_¿id_biØ*
de¡
)

303 
i
;

304 
·ge
 *
s
;

305 
·ge
 *
d
;

307 ià(!
	`‹¡_b™
(
RBIO_CACHE_READY_BIT
, &
¤c
->
æags
))

310 
i
 = 0; i < 
de¡
->
Ä_·ges
; i++) {

311 
s
 = 
¤c
->
¡re_·ges
[
i
];

312 ià(!
s
 || !
	`PageU±od©e
(s)) {

316 
d
 = 
de¡
->
¡re_·ges
[
i
];

317 ià(
d
)

318 
	`__ä“_·ge
(
d
);

320 
de¡
->
¡re_·ges
[
i
] = 
s
;

321 
¤c
->
¡re_·ges
[
i
] = 
NULL
;

323 
	}
}

332 
	$m”ge_rbio
(
bŒfs_¿id_bio
 *
de¡
,

333 
bŒfs_¿id_bio
 *
viùim
)

335 
	`bio_li¡_m”ge
(&
de¡
->
bio_li¡
, &
viùim
->bio_list);

336 
de¡
->
bio_li¡_by‹s
 +ð
viùim
->bio_list_bytes;

337 
de¡
->
g’”ic_bio_út
 +ð
viùim
->generic_bio_cnt;

338 
	`bio_li¡_š™
(&
viùim
->
bio_li¡
);

339 
	}
}

345 
	$__»move_rbio_äom_ÿche
(
bŒfs_¿id_bio
 *
rbio
)

347 
buck‘
 = 
	`rbio_buck‘
(
rbio
);

348 
bŒfs_¡re_hash_bË
 *
bË
;

349 
bŒfs_¡re_hash
 *
h
;

350 
ä“™
 = 0;

355 ià(!
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
))

358 
bË
 = 
rbio
->
fs_šfo
->
¡re_hash_bË
;

359 
h
 = 
bË
->bË + 
buck‘
;

364 
	`¥š_lock
(&
h
->
lock
);

370 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

372 ià(
	`‹¡_ªd_þ—r_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
)) {

373 
	`li¡_d–_š™
(&
rbio
->
¡re_ÿche
);

374 
bË
->
ÿche_size
 -= 1;

375 
ä“™
 = 1;

386 ià(
	`bio_li¡_em±y
(&
rbio
->
bio_li¡
)) {

387 ià(!
	`li¡_em±y
(&
rbio
->
hash_li¡
)) {

388 
	`li¡_d–_š™
(&
rbio
->
hash_li¡
);

389 
	`»fcouÁ_dec
(&
rbio
->
»fs
);

390 
	`BUG_ON
(!
	`li¡_em±y
(&
rbio
->
¶ug_li¡
));

395 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

396 
	`¥š_uÆock
(&
h
->
lock
);

398 ià(
ä“™
)

399 
	`__ä“_¿id_bio
(
rbio
);

400 
	}
}

405 
	$»move_rbio_äom_ÿche
(
bŒfs_¿id_bio
 *
rbio
)

407 
bŒfs_¡re_hash_bË
 *
bË
;

408 
æags
;

410 ià(!
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
))

413 
bË
 = 
rbio
->
fs_šfo
->
¡re_hash_bË
;

415 
	`¥š_lock_œq§ve
(&
bË
->
ÿche_lock
, 
æags
);

416 
	`__»move_rbio_äom_ÿche
(
rbio
);

417 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
ÿche_lock
, 
æags
);

418 
	}
}

423 
	$bŒfs_þ—r_rbio_ÿche
(
bŒfs_fs_šfo
 *
šfo
)

425 
bŒfs_¡re_hash_bË
 *
bË
;

426 
æags
;

427 
bŒfs_¿id_bio
 *
rbio
;

429 
bË
 = 
šfo
->
¡re_hash_bË
;

431 
	`¥š_lock_œq§ve
(&
bË
->
ÿche_lock
, 
æags
);

432 !
	`li¡_em±y
(&
bË
->
¡re_ÿche
)) {

433 
rbio
 = 
	`li¡_’Œy
(
bË
->
¡re_ÿche
.
Ãxt
,

434 
bŒfs_¿id_bio
,

435 
¡re_ÿche
);

436 
	`__»move_rbio_äom_ÿche
(
rbio
);

438 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
ÿche_lock
, 
æags
);

439 
	}
}

445 
	$bŒfs_ä“_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
)

447 ià(!
šfo
->
¡re_hash_bË
)

449 
	`bŒfs_þ—r_rbio_ÿche
(
šfo
);

450 
	`kvä“
(
šfo
->
¡re_hash_bË
);

451 
šfo
->
¡re_hash_bË
 = 
NULL
;

452 
	}
}

465 
	$ÿche_rbio
(
bŒfs_¿id_bio
 *
rbio
)

467 
bŒfs_¡re_hash_bË
 *
bË
;

468 
æags
;

470 ià(!
	`‹¡_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
))

473 
bË
 = 
rbio
->
fs_šfo
->
¡re_hash_bË
;

475 
	`¥š_lock_œq§ve
(&
bË
->
ÿche_lock
, 
æags
);

476 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

479 ià(!
	`‹¡_ªd_£t_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
))

480 
	`»fcouÁ_šc
(&
rbio
->
»fs
);

482 ià(!
	`li¡_em±y
(&
rbio
->
¡re_ÿche
)){

483 
	`li¡_move
(&
rbio
->
¡re_ÿche
, &
bË
->stripe_cache);

485 
	`li¡_add
(&
rbio
->
¡re_ÿche
, &
bË
->stripe_cache);

486 
bË
->
ÿche_size
 += 1;

489 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

491 ià(
bË
->
ÿche_size
 > 
RBIO_CACHE_SIZE
) {

492 
bŒfs_¿id_bio
 *
found
;

494 
found
 = 
	`li¡_’Œy
(
bË
->
¡re_ÿche
.
´ev
,

495 
bŒfs_¿id_bio
,

496 
¡re_ÿche
);

498 ià(
found
 !ð
rbio
)

499 
	`__»move_rbio_äom_ÿche
(
found
);

502 
	`¥š_uÆock_œq»¡Üe
(&
bË
->
ÿche_lock
, 
æags
);

503 
	}
}

510 
	$run_xÜ
(**
·ges
, 
¤c_út
, 
ssize_t
 
Ën
)

512 
¤c_off
 = 0;

513 
xÜ_¤c_út
 = 0;

514 *
de¡
 = 
·ges
[
¤c_út
];

516 
¤c_út
 > 0) {

517 
xÜ_¤c_út
 = 
	`mš
(
¤c_út
, 
MAX_XOR_BLOCKS
);

518 
	`xÜ_blocks
(
xÜ_¤c_út
, 
Ën
, 
de¡
, 
·ges
 + 
¤c_off
);

520 
¤c_út
 -ð
xÜ_¤c_út
;

521 
¤c_off
 +ð
xÜ_¤c_út
;

523 
	}
}

532 
	$__rbio_is_fuÎ
(
bŒfs_¿id_bio
 *
rbio
)

534 
size
 = 
rbio
->
bio_li¡_by‹s
;

535 
»t
 = 1;

537 ià(
size
 !ð
rbio
->
Ä_d©a
 *„bio->
¡re_Ën
)

538 
»t
 = 0;

540 
	`BUG_ON
(
size
 > 
rbio
->
Ä_d©a
 *„bio->
¡re_Ën
);

541  
»t
;

542 
	}
}

544 
	$rbio_is_fuÎ
(
bŒfs_¿id_bio
 *
rbio
)

546 
æags
;

547 
»t
;

549 
	`¥š_lock_œq§ve
(&
rbio
->
bio_li¡_lock
, 
æags
);

550 
»t
 = 
	`__rbio_is_fuÎ
(
rbio
);

551 
	`¥š_uÆock_œq»¡Üe
(&
rbio
->
bio_li¡_lock
, 
æags
);

552  
»t
;

553 
	}
}

565 
	$rbio_ÿn_m”ge
(
bŒfs_¿id_bio
 *
Ï¡
,

566 
bŒfs_¿id_bio
 *
cur
)

568 ià(
	`‹¡_b™
(
RBIO_RMW_LOCKED_BIT
, &
Ï¡
->
æags
) ||

569 
	`‹¡_b™
(
RBIO_RMW_LOCKED_BIT
, &
cur
->
æags
))

579 ià(
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
Ï¡
->
æags
) ||

580 
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
cur
->
æags
))

583 ià(
Ï¡
->
bbio
->
¿id_m­
[0] !=

584 
cur
->
bbio
->
¿id_m­
[0])

588 ià(
Ï¡
->
Ý”©iÚ
 !ð
cur
->operation)

598 ià(
Ï¡
->
Ý”©iÚ
 =ð
BTRFS_RBIO_PARITY_SCRUB
 ||

599 
cur
->
Ý”©iÚ
 =ð
BTRFS_RBIO_PARITY_SCRUB
)

602 ià(
Ï¡
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
 ||

603 
cur
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
)

607 
	}
}

609 
	$rbio_¡re_·ge_šdex
(
bŒfs_¿id_bio
 *
rbio
, 
¡re
,

610 
šdex
)

612  
¡re
 * 
rbio
->
¡re_Åages
 + 
šdex
;

613 
	}
}

619 
·ge
 *
	$rbio_¡re_·ge
(
bŒfs_¿id_bio
 *
rbio
, 
¡re
,

620 
šdex
)

622  
rbio
->
¡re_·ges
[
	`rbio_¡re_·ge_šdex
Ôbio, 
¡re
, 
šdex
)];

623 
	}
}

628 
·ge
 *
	$rbio_p¡re_·ge
(
bŒfs_¿id_bio
 *
rbio
, 
šdex
)

630  
	`rbio_¡re_·ge
(
rbio
,„bio->
Ä_d©a
, 
šdex
);

631 
	}
}

637 
·ge
 *
	$rbio_q¡re_·ge
(
bŒfs_¿id_bio
 *
rbio
, 
šdex
)

639 ià(
rbio
->
Ä_d©a
 + 1 =ðrbio->
»®_¡res
)

640  
NULL
;

641  
	`rbio_¡re_·ge
(
rbio
,„bio->
Ä_d©a
 + 1, 
šdex
);

642 
	}
}

666 
nošlše
 
	$lock_¡re_add
(
bŒfs_¿id_bio
 *
rbio
)

668 
buck‘
 = 
	`rbio_buck‘
(
rbio
);

669 
bŒfs_¡re_hash
 *
h
 = 
rbio
->
fs_šfo
->
¡re_hash_bË
->
bË
 + 
buck‘
;

670 
bŒfs_¿id_bio
 *
cur
;

671 
bŒfs_¿id_bio
 *
³ndšg
;

672 
æags
;

673 
	`DEFINE_WAIT
(
wa™
);

674 
bŒfs_¿id_bio
 *
ä“™
 = 
NULL
;

675 
bŒfs_¿id_bio
 *
ÿche_drÝ
 = 
NULL
;

676 
»t
 = 0;

678 
	`¥š_lock_œq§ve
(&
h
->
lock
, 
æags
);

679 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
h
->
hash_li¡
, hash_list) {

680 ià(
cur
->
bbio
->
¿id_m­
[0] =ð
rbio
->bbio->raid_map[0]) {

681 
	`¥š_lock
(&
cur
->
bio_li¡_lock
);

684 ià(
	`bio_li¡_em±y
(&
cur
->
bio_li¡
) &&

685 
	`li¡_em±y
(&
cur
->
¶ug_li¡
) &&

686 
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
cur
->
æags
) &&

687 !
	`‹¡_b™
(
RBIO_RMW_LOCKED_BIT
, &
cur
->
æags
)) {

688 
	`li¡_d–_š™
(&
cur
->
hash_li¡
);

689 
	`»fcouÁ_dec
(&
cur
->
»fs
);

691 
	`¡—l_rbio
(
cur
, 
rbio
);

692 
ÿche_drÝ
 = 
cur
;

693 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

695 
lock™
;

699 ià(
	`rbio_ÿn_m”ge
(
cur
, 
rbio
)) {

700 
	`m”ge_rbio
(
cur
, 
rbio
);

701 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

702 
ä“™
 = 
rbio
;

703 
»t
 = 1;

704 
out
;

716 
	`li¡_fÜ_—ch_’Œy
(
³ndšg
, &
cur
->
¶ug_li¡
,

717 
¶ug_li¡
) {

718 ià(
	`rbio_ÿn_m”ge
(
³ndšg
, 
rbio
)) {

719 
	`m”ge_rbio
(
³ndšg
, 
rbio
);

720 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

721 
ä“™
 = 
rbio
;

722 
»t
 = 1;

723 
out
;

731 
	`li¡_add_ž
(&
rbio
->
¶ug_li¡
, &
cur
->plug_list);

732 
	`¥š_uÆock
(&
cur
->
bio_li¡_lock
);

733 
»t
 = 1;

734 
out
;

737 
lock™
:

738 
	`»fcouÁ_šc
(&
rbio
->
»fs
);

739 
	`li¡_add
(&
rbio
->
hash_li¡
, &
h
->hash_list);

740 
out
:

741 
	`¥š_uÆock_œq»¡Üe
(&
h
->
lock
, 
æags
);

742 ià(
ÿche_drÝ
)

743 
	`»move_rbio_äom_ÿche
(
ÿche_drÝ
);

744 ià(
ä“™
)

745 
	`__ä“_¿id_bio
(
ä“™
);

746  
»t
;

747 
	}
}

753 
nošlše
 
	$uÆock_¡re
(
bŒfs_¿id_bio
 *
rbio
)

755 
buck‘
;

756 
bŒfs_¡re_hash
 *
h
;

757 
æags
;

758 
k“p_ÿche
 = 0;

760 
buck‘
 = 
	`rbio_buck‘
(
rbio
);

761 
h
 = 
rbio
->
fs_šfo
->
¡re_hash_bË
->
bË
 + 
buck‘
;

763 ià(
	`li¡_em±y
(&
rbio
->
¶ug_li¡
))

764 
	`ÿche_rbio
(
rbio
);

766 
	`¥š_lock_œq§ve
(&
h
->
lock
, 
æags
);

767 
	`¥š_lock
(&
rbio
->
bio_li¡_lock
);

769 ià(!
	`li¡_em±y
(&
rbio
->
hash_li¡
)) {

775 ià(
	`li¡_em±y
(&
rbio
->
¶ug_li¡
) &&

776 
	`‹¡_b™
(
RBIO_CACHE_BIT
, &
rbio
->
æags
)) {

777 
k“p_ÿche
 = 1;

778 
	`þ—r_b™
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
æags
);

779 
	`BUG_ON
(!
	`bio_li¡_em±y
(&
rbio
->
bio_li¡
));

780 
dÚe
;

783 
	`li¡_d–_š™
(&
rbio
->
hash_li¡
);

784 
	`»fcouÁ_dec
(&
rbio
->
»fs
);

791 ià(!
	`li¡_em±y
(&
rbio
->
¶ug_li¡
)) {

792 
bŒfs_¿id_bio
 *
Ãxt
;

793 
li¡_h—d
 *
h—d
 = 
rbio
->
¶ug_li¡
.
Ãxt
;

795 
Ãxt
 = 
	`li¡_’Œy
(
h—d
, 
bŒfs_¿id_bio
,

796 
¶ug_li¡
);

798 
	`li¡_d–_š™
(&
rbio
->
¶ug_li¡
);

800 
	`li¡_add
(&
Ãxt
->
hash_li¡
, &
h
->hash_list);

801 
	`»fcouÁ_šc
(&
Ãxt
->
»fs
);

802 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

803 
	`¥š_uÆock_œq»¡Üe
(&
h
->
lock
, 
æags
);

805 ià(
Ãxt
->
Ý”©iÚ
 =ð
BTRFS_RBIO_READ_REBUILD
)

806 
	`async_»ad_»bužd
(
Ãxt
);

807 ià(
Ãxt
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
) {

808 
	`¡—l_rbio
(
rbio
, 
Ãxt
);

809 
	`async_»ad_»bužd
(
Ãxt
);

810 } ià(
Ãxt
->
Ý”©iÚ
 =ð
BTRFS_RBIO_WRITE
) {

811 
	`¡—l_rbio
(
rbio
, 
Ãxt
);

812 
	`async_rmw_¡re
(
Ãxt
);

813 } ià(
Ãxt
->
Ý”©iÚ
 =ð
BTRFS_RBIO_PARITY_SCRUB
) {

814 
	`¡—l_rbio
(
rbio
, 
Ãxt
);

815 
	`async_süub_·r™y
(
Ãxt
);

818 
dÚe_nÞock
;

823 } ià(
	`wa™queue_aùive
(&
h
->
wa™
)) {

824 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

825 
	`¥š_uÆock_œq»¡Üe
(&
h
->
lock
, 
æags
);

826 
	`wake_up
(&
h
->
wa™
);

827 
dÚe_nÞock
;

830 
dÚe
:

831 
	`¥š_uÆock
(&
rbio
->
bio_li¡_lock
);

832 
	`¥š_uÆock_œq»¡Üe
(&
h
->
lock
, 
æags
);

834 
dÚe_nÞock
:

835 ià(!
k“p_ÿche
)

836 
	`»move_rbio_äom_ÿche
(
rbio
);

837 
	}
}

839 
	$__ä“_¿id_bio
(
bŒfs_¿id_bio
 *
rbio
)

841 
i
;

843 ià(!
	`»fcouÁ_dec_ªd_‹¡
(&
rbio
->
»fs
))

846 
	`WARN_ON
(!
	`li¡_em±y
(&
rbio
->
¡re_ÿche
));

847 
	`WARN_ON
(!
	`li¡_em±y
(&
rbio
->
hash_li¡
));

848 
	`WARN_ON
(!
	`bio_li¡_em±y
(&
rbio
->
bio_li¡
));

850 
i
 = 0; i < 
rbio
->
Ä_·ges
; i++) {

851 ià(
rbio
->
¡re_·ges
[
i
]) {

852 
	`__ä“_·ge
(
rbio
->
¡re_·ges
[
i
]);

853 
rbio
->
¡re_·ges
[
i
] = 
NULL
;

857 
	`bŒfs_put_bbio
(
rbio
->
bbio
);

858 
	`kä“
(
rbio
);

859 
	}
}

861 
	$ä“_¿id_bio
(
bŒfs_¿id_bio
 *
rbio
)

863 
	`uÆock_¡re
(
rbio
);

864 
	`__ä“_¿id_bio
(
rbio
);

865 
	}
}

871 
	$rbio_Üig_’d_io
(
bŒfs_¿id_bio
 *
rbio
, 
blk_¡©us_t
 
”r
)

873 
bio
 *
cur
 = 
	`bio_li¡_g‘
(&
rbio
->
bio_li¡
);

874 
bio
 *
Ãxt
;

876 ià(
rbio
->
g’”ic_bio_út
)

877 
	`bŒfs_bio_couÁ”_sub
(
rbio
->
fs_šfo
,„bio->
g’”ic_bio_út
);

879 
	`ä“_¿id_bio
(
rbio
);

881 
cur
) {

882 
Ãxt
 = 
cur
->
bi_Ãxt
;

883 
cur
->
bi_Ãxt
 = 
NULL
;

884 
cur
->
bi_¡©us
 = 
”r
;

885 
	`bio_’dio
(
cur
);

886 
cur
 = 
Ãxt
;

888 
	}
}

894 
	$¿id_wr™e_’d_io
(
bio
 *bio)

896 
bŒfs_¿id_bio
 *
rbio
 = 
bio
->
bi_´iv©e
;

897 
blk_¡©us_t
 
”r
 = 
bio
->
bi_¡©us
;

898 
max_”rÜs
;

900 ià(
”r
)

901 
	`çž_bio_¡re
(
rbio
, 
bio
);

903 
	`bio_put
(
bio
);

905 ià(!
	`©omic_dec_ªd_‹¡
(&
rbio
->
¡res_³ndšg
))

908 
”r
 = 
BLK_STS_OK
;

911 
max_”rÜs
 = (
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_PARITY_SCRUB
) ?

912 0 : 
rbio
->
bbio
->
max_”rÜs
;

913 ià(
	`©omic_»ad
(&
rbio
->
”rÜ
è> 
max_”rÜs
)

914 
”r
 = 
BLK_STS_IOERR
;

916 
	`rbio_Üig_’d_io
(
rbio
, 
”r
);

917 
	}
}

935 
·ge
 *
	$·ge_š_rbio
(
bŒfs_¿id_bio
 *
rbio
,

936 
šdex
, 
·g’r
, 
bio_li¡_Úly
)

938 
chunk_·ge
;

939 
·ge
 *
p
 = 
NULL
;

941 
chunk_·ge
 = 
šdex
 * (
rbio
->
¡re_Ën
 >> 
PAGE_SHIFT
è+ 
·g’r
;

943 
	`¥š_lock_œq
(&
rbio
->
bio_li¡_lock
);

944 
p
 = 
rbio
->
bio_·ges
[
chunk_·ge
];

945 
	`¥š_uÆock_œq
(&
rbio
->
bio_li¡_lock
);

947 ià(
p
 || 
bio_li¡_Úly
)

948  
p
;

950  
rbio
->
¡re_·ges
[
chunk_·ge
];

951 
	}
}

957 
	$rbio_Ä_·ges
(
¡re_Ën
, 
Ä_¡res
)

959  
	`DIV_ROUND_UP
(
¡re_Ën
, 
PAGE_SIZE
è* 
Ä_¡res
;

960 
	}
}

966 
bŒfs_¿id_bio
 *
	$®loc_rbio
(
bŒfs_fs_šfo
 *
fs_šfo
,

967 
bŒfs_bio
 *
bbio
,

968 
u64
 
¡re_Ën
)

970 
bŒfs_¿id_bio
 *
rbio
;

971 
Ä_d©a
 = 0;

972 
»®_¡res
 = 
bbio
->
num_¡res
 - bbio->
num_tgtdevs
;

973 
num_·ges
 = 
	`rbio_Ä_·ges
(
¡re_Ën
, 
»®_¡res
);

974 
¡re_Åages
 = 
	`DIV_ROUND_UP
(
¡re_Ën
, 
PAGE_SIZE
);

975 *
p
;

977 
rbio
 = 
	`kz®loc
((*rbioè+ 
num_·ges
 * (
·ge
 *) * 2 +

978 
	`DIV_ROUND_UP
(
¡re_Åages
, 
BITS_PER_LONG
) *

979 (), 
GFP_NOFS
);

980 ià(!
rbio
)

981  
	`ERR_PTR
(-
ENOMEM
);

983 
	`bio_li¡_š™
(&
rbio
->
bio_li¡
);

984 
	`INIT_LIST_HEAD
(&
rbio
->
¶ug_li¡
);

985 
	`¥š_lock_š™
(&
rbio
->
bio_li¡_lock
);

986 
	`INIT_LIST_HEAD
(&
rbio
->
¡re_ÿche
);

987 
	`INIT_LIST_HEAD
(&
rbio
->
hash_li¡
);

988 
rbio
->
bbio
 = bbio;

989 
rbio
->
fs_šfo
 = fs_info;

990 
rbio
->
¡re_Ën
 = stripe_len;

991 
rbio
->
Ä_·ges
 = 
num_·ges
;

992 
rbio
->
»®_¡res
 =„eal_stripes;

993 
rbio
->
¡re_Åages
 = stripe_npages;

994 
rbio
->
çža
 = -1;

995 
rbio
->
çžb
 = -1;

996 
	`»fcouÁ_£t
(&
rbio
->
»fs
, 1);

997 
	`©omic_£t
(&
rbio
->
”rÜ
, 0);

998 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 0);

1004 
p
 = 
rbio
 + 1;

1005 
rbio
->
¡re_·ges
 = 
p
;

1006 
rbio
->
bio_·ges
 = 
p
 + (
·ge
 *è* 
num_·ges
;

1007 
rbio
->
db™m­
 = 
p
 + (
·ge
 *è* 
num_·ges
 * 2;

1009 ià(
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
)

1010 
Ä_d©a
 = 
»®_¡res
 - 1;

1011 ià(
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

1012 
Ä_d©a
 = 
»®_¡res
 - 2;

1014 
	`BUG
();

1016 
rbio
->
Ä_d©a
 =‚r_data;

1017  
rbio
;

1018 
	}
}

1021 
	$®loc_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
)

1023 
i
;

1024 
·ge
 *page;

1026 
i
 = 0; i < 
rbio
->
Ä_·ges
; i++) {

1027 ià(
rbio
->
¡re_·ges
[
i
])

1029 
·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

1030 ià(!
·ge
)

1031  -
ENOMEM
;

1032 
rbio
->
¡re_·ges
[
i
] = 
·ge
;

1035 
	}
}

1038 
	$®loc_rbio_·r™y_·ges
(
bŒfs_¿id_bio
 *
rbio
)

1040 
i
;

1041 
·ge
 *page;

1043 
i
 = 
	`rbio_¡re_·ge_šdex
(
rbio
,„bio->
Ä_d©a
, 0);

1045 ; 
i
 < 
rbio
->
Ä_·ges
; i++) {

1046 ià(
rbio
->
¡re_·ges
[
i
])

1048 
·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

1049 ià(!
·ge
)

1050  -
ENOMEM
;

1051 
rbio
->
¡re_·ges
[
i
] = 
·ge
;

1054 
	}
}

1061 
	$rbio_add_io_·ge
(
bŒfs_¿id_bio
 *
rbio
,

1062 
bio_li¡
 *bio_list,

1063 
·ge
 *page,

1064 
¡re_Ä
,

1065 
·ge_šdex
,

1066 
bio_max_Ën
)

1068 
bio
 *
Ï¡
 = 
bio_li¡
->
ž
;

1069 
u64
 
Ï¡_’d
 = 0;

1070 
»t
;

1071 
bio
 *bio;

1072 
bŒfs_bio_¡re
 *
¡re
;

1073 
u64
 
disk_¡¬t
;

1075 
¡re
 = &
rbio
->
bbio
->
¡res
[
¡re_Ä
];

1076 
disk_¡¬t
 = 
¡re
->
physiÿl
 + (
·ge_šdex
 << 
PAGE_SHIFT
);

1079 ià(!
¡re
->
dev
->
bdev
)

1080  
	`çž_rbio_šdex
(
rbio
, 
¡re_Ä
);

1083 ià(
Ï¡
) {

1084 
Ï¡_’d
 = (
u64
)
Ï¡
->
bi_™”
.
bi_£ùÜ
 << 9;

1085 
Ï¡_’d
 +ð
Ï¡
->
bi_™”
.
bi_size
;

1091 ià(
Ï¡_’d
 =ð
disk_¡¬t
 && 
¡re
->
dev
->
bdev
 &&

1092 !
Ï¡
->
bi_¡©us
 &&

1093 
Ï¡
->
bi_disk
 =ð
¡re
->
dev
->
bdev
->
bd_disk
 &&

1094 
Ï¡
->
bi_·¹no
 =ð
¡re
->
dev
->
bdev
->
bd_·¹no
) {

1095 
»t
 = 
	`bio_add_·ge
(
Ï¡
, 
·ge
, 
PAGE_SIZE
, 0);

1096 ià(
»t
 =ð
PAGE_SIZE
)

1102 
bio
 = 
	`bŒfs_io_bio_®loc
(
bio_max_Ën
 >> 
PAGE_SHIFT
 ?: 1);

1103 
bio
->
bi_™”
.
bi_size
 = 0;

1104 
	`bio_£t_dev
(
bio
, 
¡re
->
dev
->
bdev
);

1105 
bio
->
bi_™”
.
bi_£ùÜ
 = 
disk_¡¬t
 >> 9;

1107 
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0);

1108 
	`bio_li¡_add
(
bio_li¡
, 
bio
);

1110 
	}
}

1119 
	$v®id©e_rbio_fÜ_rmw
(
bŒfs_¿id_bio
 *
rbio
)

1121 ià(
rbio
->
çža
 >ð0 ||„bio->
çžb
 >= 0) {

1122 
	`BUG_ON
(
rbio
->
çža
 =ðrbio->
»®_¡res
 - 1);

1123 
	`__¿id56_·r™y_»cov”
(
rbio
);

1125 
	`fšish_rmw
(
rbio
);

1127 
	}
}

1137 
	$šdex_rbio_·ges
(
bŒfs_¿id_bio
 *
rbio
)

1139 
bio
 *bio;

1140 
u64
 
¡¬t
;

1141 
¡re_off£t
;

1142 
·ge_šdex
;

1144 
	`¥š_lock_œq
(&
rbio
->
bio_li¡_lock
);

1145 
	`bio_li¡_fÜ_—ch
(
bio
, &
rbio
->
bio_li¡
) {

1146 
bio_vec
 
bvec
;

1147 
bvec_™”
 
™”
;

1148 
i
 = 0;

1150 
¡¬t
 = (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
 << 9;

1151 
¡re_off£t
 = 
¡¬t
 - 
rbio
->
bbio
->
¿id_m­
[0];

1152 
·ge_šdex
 = 
¡re_off£t
 >> 
PAGE_SHIFT
;

1154 ià(
	`bio_æagged
(
bio
, 
BIO_CLONED
))

1155 
bio
->
bi_™”
 = 
	`bŒfs_io_bio
(bio)->
™”
;

1157 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
) {

1158 
rbio
->
bio_·ges
[
·ge_šdex
 + 
i
] = 
bvec
.
bv_·ge
;

1159 
i
++;

1162 
	`¥š_uÆock_œq
(&
rbio
->
bio_li¡_lock
);

1163 
	}
}

1173 
nošlše
 
	$fšish_rmw
(
bŒfs_¿id_bio
 *
rbio
)

1175 
bŒfs_bio
 *
bbio
 = 
rbio
->bbio;

1176 *
poš‹rs
[
rbio
->
»®_¡res
];

1177 
Ä_d©a
 = 
rbio
->nr_data;

1178 
¡re
;

1179 
·g’r
;

1180 
p_¡re
 = -1;

1181 
q_¡re
 = -1;

1182 
bio_li¡
 bio_list;

1183 
bio
 *bio;

1184 
»t
;

1186 
	`bio_li¡_š™
(&
bio_li¡
);

1188 ià(
rbio
->
»®_¡res
 -„bio->
Ä_d©a
 == 1) {

1189 
p_¡re
 = 
rbio
->
»®_¡res
 - 1;

1190 } ià(
rbio
->
»®_¡res
 -„bio->
Ä_d©a
 == 2) {

1191 
p_¡re
 = 
rbio
->
»®_¡res
 - 2;

1192 
q_¡re
 = 
rbio
->
»®_¡res
 - 1;

1194 
	`BUG
();

1205 
	`¥š_lock_œq
(&
rbio
->
bio_li¡_lock
);

1206 
	`£t_b™
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
æags
);

1207 
	`¥š_uÆock_œq
(&
rbio
->
bio_li¡_lock
);

1209 
	`©omic_£t
(&
rbio
->
”rÜ
, 0);

1220 
	`šdex_rbio_·ges
(
rbio
);

1221 ià(!
	`rbio_is_fuÎ
(
rbio
))

1222 
	`ÿche_rbio_·ges
(
rbio
);

1224 
	`þ—r_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

1226 
·g’r
 = 0;…ag’¸< 
rbio
->
¡re_Åages
;…agenr++) {

1227 
·ge
 *
p
;

1229 
¡re
 = 0; sŒ< 
Ä_d©a
; stripe++) {

1230 
p
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 0);

1231 
poš‹rs
[
¡re
] = 
	`km­
(
p
);

1235 
p
 = 
	`rbio_p¡re_·ge
(
rbio
, 
·g’r
);

1236 
	`S‘PageU±od©e
(
p
);

1237 
poš‹rs
[
¡re
++] = 
	`km­
(
p
);

1239 ià(
q_¡re
 != -1) {

1245 
p
 = 
	`rbio_q¡re_·ge
(
rbio
, 
·g’r
);

1246 
	`S‘PageU±od©e
(
p
);

1247 
poš‹rs
[
¡re
++] = 
	`km­
(
p
);

1249 
¿id6_ÿÎ
.
	`g’_syndrome
(
rbio
->
»®_¡res
, 
PAGE_SIZE
,

1250 
poš‹rs
);

1253 
	`memýy
(
poš‹rs
[
Ä_d©a
],…oš‹rs[0], 
PAGE_SIZE
);

1254 
	`run_xÜ
(
poš‹rs
 + 1, 
Ä_d©a
 - 1, 
PAGE_SIZE
);

1258 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++)

1259 
	`kunm­
(
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 0));

1267 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++) {

1268 
·g’r
 = 0;…ag’¸< 
rbio
->
¡re_Åages
;…agenr++) {

1269 
·ge
 *page;

1270 ià(
¡re
 < 
rbio
->
Ä_d©a
) {

1271 
·ge
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 1);

1272 ià(!
·ge
)

1275 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

1278 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
,

1279 
·ge
, 
¡re
, 
·g’r
, 
rbio
->
¡re_Ën
);

1280 ià(
»t
)

1281 
þ—nup
;

1285 ià(
	`lik–y
(!
bbio
->
num_tgtdevs
))

1286 
wr™e_d©a
;

1288 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++) {

1289 ià(!
bbio
->
tgtdev_m­
[
¡re
])

1292 
·g’r
 = 0;…ag’¸< 
rbio
->
¡re_Åages
;…agenr++) {

1293 
·ge
 *page;

1294 ià(
¡re
 < 
rbio
->
Ä_d©a
) {

1295 
·ge
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 1);

1296 ià(!
·ge
)

1299 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

1302 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
, 
·ge
,

1303 
rbio
->
bbio
->
tgtdev_m­
[
¡re
],

1304 
·g’r
, 
rbio
->
¡re_Ën
);

1305 ià(
»t
)

1306 
þ—nup
;

1310 
wr™e_d©a
:

1311 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
	`bio_li¡_size
(&
bio_li¡
));

1312 
	`BUG_ON
(
	`©omic_»ad
(&
rbio
->
¡res_³ndšg
) == 0);

1315 
bio
 = 
	`bio_li¡_pÝ
(&
bio_li¡
);

1316 ià(!
bio
)

1319 
bio
->
bi_´iv©e
 = 
rbio
;

1320 
bio
->
bi_’d_io
 = 
¿id_wr™e_’d_io
;

1321 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

1323 
	`subm™_bio
(
bio
);

1327 
þ—nup
:

1328 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

1329 
	}
}

1336 
	$fšd_bio_¡re
(
bŒfs_¿id_bio
 *
rbio
,

1337 
bio
 *bio)

1339 
u64
 
physiÿl
 = 
bio
->
bi_™”
.
bi_£ùÜ
;

1340 
u64
 
¡re_¡¬t
;

1341 
i
;

1342 
bŒfs_bio_¡re
 *
¡re
;

1344 
physiÿl
 <<= 9;

1346 
i
 = 0; i < 
rbio
->
bbio
->
num_¡res
; i++) {

1347 
¡re
 = &
rbio
->
bbio
->
¡res
[
i
];

1348 
¡re_¡¬t
 = 
¡re
->
physiÿl
;

1349 ià(
physiÿl
 >ð
¡re_¡¬t
 &&

1350 
physiÿl
 < 
¡re_¡¬t
 + 
rbio
->
¡re_Ën
 &&

1351 
bio
->
bi_disk
 =ð
¡re
->
dev
->
bdev
->
bd_disk
 &&

1352 
bio
->
bi_·¹no
 =ð
¡re
->
dev
->
bdev
->
bd_·¹no
) {

1353  
i
;

1357 
	}
}

1364 
	$fšd_logiÿl_bio_¡re
(
bŒfs_¿id_bio
 *
rbio
,

1365 
bio
 *bio)

1367 
u64
 
logiÿl
 = 
bio
->
bi_™”
.
bi_£ùÜ
;

1368 
u64
 
¡re_¡¬t
;

1369 
i
;

1371 
logiÿl
 <<= 9;

1373 
i
 = 0; i < 
rbio
->
Ä_d©a
; i++) {

1374 
¡re_¡¬t
 = 
rbio
->
bbio
->
¿id_m­
[
i
];

1375 ià(
logiÿl
 >ð
¡re_¡¬t
 &&

1376 
logiÿl
 < 
¡re_¡¬t
 + 
rbio
->
¡re_Ën
) {

1377  
i
;

1381 
	}
}

1386 
	$çž_rbio_šdex
(
bŒfs_¿id_bio
 *
rbio
, 
çžed
)

1388 
æags
;

1389 
»t
 = 0;

1391 
	`¥š_lock_œq§ve
(&
rbio
->
bio_li¡_lock
, 
æags
);

1394 ià(
rbio
->
çža
 =ð
çžed
 ||„bio->
çžb
 == failed)

1395 
out
;

1397 ià(
rbio
->
çža
 == -1) {

1399 
rbio
->
çža
 = 
çžed
;

1400 
	`©omic_šc
(&
rbio
->
”rÜ
);

1401 } ià(
rbio
->
çžb
 == -1) {

1403 
rbio
->
çžb
 = 
çžed
;

1404 
	`©omic_šc
(&
rbio
->
”rÜ
);

1406 
»t
 = -
EIO
;

1408 
out
:

1409 
	`¥š_uÆock_œq»¡Üe
(&
rbio
->
bio_li¡_lock
, 
æags
);

1411  
»t
;

1412 
	}
}

1418 
	$çž_bio_¡re
(
bŒfs_¿id_bio
 *
rbio
,

1419 
bio
 *bio)

1421 
çžed
 = 
	`fšd_bio_¡re
(
rbio
, 
bio
);

1423 ià(
çžed
 < 0)

1424  -
EIO
;

1426  
	`çž_rbio_šdex
(
rbio
, 
çžed
);

1427 
	}
}

1433 
	$£t_bio_·ges_u±od©e
(
bio
 *bio)

1435 
bio_vec
 
bvec
;

1436 
bvec_™”
 
™”
;

1438 ià(
	`bio_æagged
(
bio
, 
BIO_CLONED
))

1439 
bio
->
bi_™”
 = 
	`bŒfs_io_bio
(bio)->
™”
;

1441 
	`bio_fÜ_—ch_£gm’t
(
bvec
, 
bio
, 
™”
)

1442 
	`S‘PageU±od©e
(
bvec
.
bv_·ge
);

1443 
	}
}

1453 
	$¿id_rmw_’d_io
(
bio
 *bio)

1455 
bŒfs_¿id_bio
 *
rbio
 = 
bio
->
bi_´iv©e
;

1457 ià(
bio
->
bi_¡©us
)

1458 
	`çž_bio_¡re
(
rbio
, 
bio
);

1460 
	`£t_bio_·ges_u±od©e
(
bio
);

1462 
	`bio_put
(
bio
);

1464 ià(!
	`©omic_dec_ªd_‹¡
(&
rbio
->
¡res_³ndšg
))

1467 ià(
	`©omic_»ad
(&
rbio
->
”rÜ
è>„bio->
bbio
->
max_”rÜs
)

1468 
þ—nup
;

1475 
	`v®id©e_rbio_fÜ_rmw
(
rbio
);

1478 
þ—nup
:

1480 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

1481 
	}
}

1483 
	$async_rmw_¡re
(
bŒfs_¿id_bio
 *
rbio
)

1485 
	`bŒfs_š™_wÜk
(&
rbio
->
wÜk
, 
bŒfs_rmw_h–³r
, 
rmw_wÜk
, 
NULL
, NULL);

1486 
	`bŒfs_queue_wÜk
(
rbio
->
fs_šfo
->
rmw_wÜk”s
, &rbio->
wÜk
);

1487 
	}
}

1489 
	$async_»ad_»bužd
(
bŒfs_¿id_bio
 *
rbio
)

1491 
	`bŒfs_š™_wÜk
(&
rbio
->
wÜk
, 
bŒfs_rmw_h–³r
,

1492 
»ad_»bužd_wÜk
, 
NULL
, NULL);

1494 
	`bŒfs_queue_wÜk
(
rbio
->
fs_šfo
->
rmw_wÜk”s
, &rbio->
wÜk
);

1495 
	}
}

1501 
	$¿id56_rmw_¡re
(
bŒfs_¿id_bio
 *
rbio
)

1503 
bios_to_»ad
 = 0;

1504 
bio_li¡
 bio_list;

1505 
»t
;

1506 
·g’r
;

1507 
¡re
;

1508 
bio
 *bio;

1510 
	`bio_li¡_š™
(&
bio_li¡
);

1512 
»t
 = 
	`®loc_rbio_·ges
(
rbio
);

1513 ià(
»t
)

1514 
þ—nup
;

1516 
	`šdex_rbio_·ges
(
rbio
);

1518 
	`©omic_£t
(&
rbio
->
”rÜ
, 0);

1523 
¡re
 = 0; sŒ< 
rbio
->
Ä_d©a
; stripe++) {

1524 
·g’r
 = 0;…ag’¸< 
rbio
->
¡re_Åages
;…agenr++) {

1525 
·ge
 *page;

1532 
·ge
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 1);

1533 ià(
·ge
)

1536 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

1541 ià(
	`PageU±od©e
(
·ge
))

1544 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
, 
·ge
,

1545 
¡re
, 
·g’r
, 
rbio
->
¡re_Ën
);

1546 ià(
»t
)

1547 
þ—nup
;

1551 
bios_to_»ad
 = 
	`bio_li¡_size
(&
bio_li¡
);

1552 ià(!
bios_to_»ad
) {

1559 
fšish
;

1566 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
bios_to_»ad
);

1568 
bio
 = 
	`bio_li¡_pÝ
(&
bio_li¡
);

1569 ià(!
bio
)

1572 
bio
->
bi_´iv©e
 = 
rbio
;

1573 
bio
->
bi_’d_io
 = 
¿id_rmw_’d_io
;

1574 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

1576 
	`bŒfs_bio_wq_’d_io
(
rbio
->
fs_šfo
, 
bio
, 
BTRFS_WQ_ENDIO_RAID56
);

1578 
	`subm™_bio
(
bio
);

1583 
þ—nup
:

1584 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

1585  -
EIO
;

1587 
fšish
:

1588 
	`v®id©e_rbio_fÜ_rmw
(
rbio
);

1590 
	}
}

1596 
	$fuÎ_¡re_wr™e
(
bŒfs_¿id_bio
 *
rbio
)

1598 
»t
;

1600 
»t
 = 
	`®loc_rbio_·r™y_·ges
(
rbio
);

1601 ià(
»t
) {

1602 
	`__ä“_¿id_bio
(
rbio
);

1603  
»t
;

1606 
»t
 = 
	`lock_¡re_add
(
rbio
);

1607 ià(
»t
 == 0)

1608 
	`fšish_rmw
(
rbio
);

1610 
	}
}

1617 
	$·¹Ÿl_¡re_wr™e
(
bŒfs_¿id_bio
 *
rbio
)

1619 
»t
;

1621 
»t
 = 
	`lock_¡re_add
(
rbio
);

1622 ià(
»t
 == 0)

1623 
	`async_rmw_¡re
(
rbio
);

1625 
	}
}

1633 
	$__¿id56_·r™y_wr™e
(
bŒfs_¿id_bio
 *
rbio
)

1636 ià(!
	`rbio_is_fuÎ
(
rbio
))

1637  
	`·¹Ÿl_¡re_wr™e
(
rbio
);

1638  
	`fuÎ_¡re_wr™e
(
rbio
);

1639 
	}
}

1648 
	sbŒfs_¶ug_cb
 {

1649 
blk_¶ug_cb
 
	mcb
;

1650 
bŒfs_fs_šfo
 *
	mšfo
;

1651 
li¡_h—d
 
	mrbio_li¡
;

1652 
bŒfs_wÜk
 
	mwÜk
;

1658 
	$¶ug_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

1660 
bŒfs_¿id_bio
 *
¿
 = 
	`cÚš”_of
(
a
, btrfs_raid_bio,

1661 
¶ug_li¡
);

1662 
bŒfs_¿id_bio
 *
rb
 = 
	`cÚš”_of
(
b
, btrfs_raid_bio,

1663 
¶ug_li¡
);

1664 
u64
 
a_£ùÜ
 = 
¿
->
bio_li¡
.
h—d
->
bi_™”
.
bi_£ùÜ
;

1665 
u64
 
b_£ùÜ
 = 
rb
->
bio_li¡
.
h—d
->
bi_™”
.
bi_£ùÜ
;

1667 ià(
a_£ùÜ
 < 
b_£ùÜ
)

1669 ià(
a_£ùÜ
 > 
b_£ùÜ
)

1672 
	}
}

1674 
	$run_¶ug
(
bŒfs_¶ug_cb
 *
¶ug
)

1676 
bŒfs_¿id_bio
 *
cur
;

1677 
bŒfs_¿id_bio
 *
Ï¡
 = 
NULL
;

1684 
	`li¡_sÜt
(
NULL
, &
¶ug
->
rbio_li¡
, 
¶ug_cmp
);

1685 !
	`li¡_em±y
(&
¶ug
->
rbio_li¡
)) {

1686 
cur
 = 
	`li¡_’Œy
(
¶ug
->
rbio_li¡
.
Ãxt
,

1687 
bŒfs_¿id_bio
, 
¶ug_li¡
);

1688 
	`li¡_d–_š™
(&
cur
->
¶ug_li¡
);

1690 ià(
	`rbio_is_fuÎ
(
cur
)) {

1692 
	`fuÎ_¡re_wr™e
(
cur
);

1695 ià(
Ï¡
) {

1696 ià(
	`rbio_ÿn_m”ge
(
Ï¡
, 
cur
)) {

1697 
	`m”ge_rbio
(
Ï¡
, 
cur
);

1698 
	`__ä“_¿id_bio
(
cur
);

1702 
	`__¿id56_·r™y_wr™e
(
Ï¡
);

1704 
Ï¡
 = 
cur
;

1706 ià(
Ï¡
) {

1707 
	`__¿id56_·r™y_wr™e
(
Ï¡
);

1709 
	`kä“
(
¶ug
);

1710 
	}
}

1716 
	$uÅlug_wÜk
(
bŒfs_wÜk
 *
wÜk
)

1718 
bŒfs_¶ug_cb
 *
¶ug
;

1719 
¶ug
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¶ug_cb
, work);

1720 
	`run_¶ug
(
¶ug
);

1721 
	}
}

1723 
	$bŒfs_¿id_uÅlug
(
blk_¶ug_cb
 *
cb
, 
boÞ
 
äom_scheduË
)

1725 
bŒfs_¶ug_cb
 *
¶ug
;

1726 
¶ug
 = 
	`cÚš”_of
(
cb
, 
bŒfs_¶ug_cb
, cb);

1728 ià(
äom_scheduË
) {

1729 
	`bŒfs_š™_wÜk
(&
¶ug
->
wÜk
, 
bŒfs_rmw_h–³r
,

1730 
uÅlug_wÜk
, 
NULL
, NULL);

1731 
	`bŒfs_queue_wÜk
(
¶ug
->
šfo
->
rmw_wÜk”s
,

1732 &
¶ug
->
wÜk
);

1735 
	`run_¶ug
(
¶ug
);

1736 
	}
}

1741 
	$¿id56_·r™y_wr™e
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

1742 
bŒfs_bio
 *
bbio
, 
u64
 
¡re_Ën
)

1744 
bŒfs_¿id_bio
 *
rbio
;

1745 
bŒfs_¶ug_cb
 *
¶ug
 = 
NULL
;

1746 
blk_¶ug_cb
 *
cb
;

1747 
»t
;

1749 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bbio
, 
¡re_Ën
);

1750 ià(
	`IS_ERR
(
rbio
)) {

1751 
	`bŒfs_put_bbio
(
bbio
);

1752  
	`PTR_ERR
(
rbio
);

1754 
	`bio_li¡_add
(&
rbio
->
bio_li¡
, 
bio
);

1755 
rbio
->
bio_li¡_by‹s
 = 
bio
->
bi_™”
.
bi_size
;

1756 
rbio
->
Ý”©iÚ
 = 
BTRFS_RBIO_WRITE
;

1758 
	`bŒfs_bio_couÁ”_šc_noblocked
(
fs_šfo
);

1759 
rbio
->
g’”ic_bio_út
 = 1;

1765 ià(
	`rbio_is_fuÎ
(
rbio
)) {

1766 
»t
 = 
	`fuÎ_¡re_wr™e
(
rbio
);

1767 ià(
»t
)

1768 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1769  
»t
;

1772 
cb
 = 
	`blk_check_¶ugged
(
bŒfs_¿id_uÅlug
, 
fs_šfo
, (*
¶ug
));

1773 ià(
cb
) {

1774 
¶ug
 = 
	`cÚš”_of
(
cb
, 
bŒfs_¶ug_cb
, cb);

1775 ià(!
¶ug
->
šfo
) {

1776 
¶ug
->
šfo
 = 
fs_šfo
;

1777 
	`INIT_LIST_HEAD
(&
¶ug
->
rbio_li¡
);

1779 
	`li¡_add_ž
(&
rbio
->
¶ug_li¡
, &
¶ug
->
rbio_li¡
);

1780 
»t
 = 0;

1782 
»t
 = 
	`__¿id56_·r™y_wr™e
(
rbio
);

1783 ià(
»t
)

1784 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1786  
»t
;

1787 
	}
}

1794 
	$__¿id_»cov”_’d_io
(
bŒfs_¿id_bio
 *
rbio
)

1796 
·g’r
, 
¡re
;

1797 **
poš‹rs
;

1798 
çža
 = -1, 
çžb
 = -1;

1799 
·ge
 *page;

1800 
blk_¡©us_t
 
”r
;

1801 
i
;

1803 
poš‹rs
 = 
	`kÿÎoc
(
rbio
->
»®_¡res
, (*), 
GFP_NOFS
);

1804 ià(!
poš‹rs
) {

1805 
”r
 = 
BLK_STS_RESOURCE
;

1806 
þ—nup_io
;

1809 
çža
 = 
rbio
->faila;

1810 
çžb
 = 
rbio
->failb;

1812 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_READ_REBUILD
 ||

1813 
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
) {

1814 
	`¥š_lock_œq
(&
rbio
->
bio_li¡_lock
);

1815 
	`£t_b™
(
RBIO_RMW_LOCKED_BIT
, &
rbio
->
æags
);

1816 
	`¥š_uÆock_œq
(&
rbio
->
bio_li¡_lock
);

1819 
	`šdex_rbio_·ges
(
rbio
);

1821 
·g’r
 = 0;…ag’¸< 
rbio
->
¡re_Åages
;…agenr++) {

1826 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_PARITY_SCRUB
 &&

1827 !
	`‹¡_b™
(
·g’r
, 
rbio
->
db™m­
))

1833 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++) {

1838 ià((
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_READ_REBUILD
 ||

1839 
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
) &&

1840 (
¡re
 =ð
çža
 || sŒ=ð
çžb
)) {

1841 
·ge
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 0);

1843 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

1845 
poš‹rs
[
¡re
] = 
	`km­
(
·ge
);

1849 ià(
rbio
->
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
) {

1854 ià(
çžb
 < 0) {

1855 ià(
çža
 =ð
rbio
->
Ä_d©a
) {

1861 
”r
 = 
BLK_STS_IOERR
;

1862 
þ—nup
;

1868 
p¡re
;

1872 ià(
çža
 > 
çžb
) {

1873 
tmp
 = 
çžb
;

1874 
çžb
 = 
çža
;

1875 
çža
 = 
tmp
;

1884 ià(
rbio
->
bbio
->
¿id_m­
[
çžb
] =ð
RAID6_Q_STRIPE
) {

1885 ià(
rbio
->
bbio
->
¿id_m­
[
çža
] ==

1886 
RAID5_P_STRIPE
) {

1887 
”r
 = 
BLK_STS_IOERR
;

1888 
þ—nup
;

1894 
p¡re
;

1897 ià(
rbio
->
bbio
->
¿id_m­
[
çžb
] =ð
RAID5_P_STRIPE
) {

1898 
	`¿id6_d©­_»cov
(
rbio
->
»®_¡res
,

1899 
PAGE_SIZE
, 
çža
, 
poš‹rs
);

1901 
	`¿id6_2d©a_»cov
(
rbio
->
»®_¡res
,

1902 
PAGE_SIZE
, 
çža
, 
çžb
,

1903 
poš‹rs
);

1906 *
p
;

1909 
	`BUG_ON
(
çžb
 != -1);

1910 
p¡re
:

1912 
	`memýy
(
poš‹rs
[
çža
],

1913 
poš‹rs
[
rbio
->
Ä_d©a
],

1914 
PAGE_SIZE
);

1917 
p
 = 
poš‹rs
[
çža
];

1918 
¡re
 = 
çža
; sŒ< 
rbio
->
Ä_d©a
 - 1; stripe++)

1919 
poš‹rs
[
¡re
] =…ointers[stripe + 1];

1920 
poš‹rs
[
rbio
->
Ä_d©a
 - 1] = 
p
;

1923 
	`run_xÜ
(
poš‹rs
, 
rbio
->
Ä_d©a
 - 1, 
PAGE_SIZE
);

1931 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_WRITE
) {

1932 
i
 = 0; i < 
rbio
->
¡re_Åages
; i++) {

1933 ià(
çža
 != -1) {

1934 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
çža
, 
i
);

1935 
	`S‘PageU±od©e
(
·ge
);

1937 ià(
çžb
 != -1) {

1938 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
çžb
, 
i
);

1939 
	`S‘PageU±od©e
(
·ge
);

1943 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++) {

1948 ià((
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_READ_REBUILD
 ||

1949 
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
) &&

1950 (
¡re
 =ð
çža
 || sŒ=ð
çžb
)) {

1951 
·ge
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 0);

1953 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

1955 
	`kunm­
(
·ge
);

1959 
”r
 = 
BLK_STS_OK
;

1960 
þ—nup
:

1961 
	`kä“
(
poš‹rs
);

1963 
þ—nup_io
:

1964 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_READ_REBUILD
) {

1965 ià(
”r
 =ð
BLK_STS_OK
)

1966 
	`ÿche_rbio_·ges
(
rbio
);

1968 
	`þ—r_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

1970 
	`rbio_Üig_’d_io
(
rbio
, 
”r
);

1971 } ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
) {

1972 
	`rbio_Üig_’d_io
(
rbio
, 
”r
);

1973 } ià(
”r
 =ð
BLK_STS_OK
) {

1974 
rbio
->
çža
 = -1;

1975 
rbio
->
çžb
 = -1;

1977 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_WRITE
)

1978 
	`fšish_rmw
(
rbio
);

1979 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_PARITY_SCRUB
)

1980 
	`fšish_·r™y_süub
(
rbio
, 0);

1982 
	`BUG
();

1984 
	`rbio_Üig_’d_io
(
rbio
, 
”r
);

1986 
	}
}

1992 
	$¿id_»cov”_’d_io
(
bio
 *bio)

1994 
bŒfs_¿id_bio
 *
rbio
 = 
bio
->
bi_´iv©e
;

2000 ià(
bio
->
bi_¡©us
)

2001 
	`çž_bio_¡re
(
rbio
, 
bio
);

2003 
	`£t_bio_·ges_u±od©e
(
bio
);

2004 
	`bio_put
(
bio
);

2006 ià(!
	`©omic_dec_ªd_‹¡
(&
rbio
->
¡res_³ndšg
))

2009 ià(
	`©omic_»ad
(&
rbio
->
”rÜ
è>„bio->
bbio
->
max_”rÜs
)

2010 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

2012 
	`__¿id_»cov”_’d_io
(
rbio
);

2013 
	}
}

2023 
	$__¿id56_·r™y_»cov”
(
bŒfs_¿id_bio
 *
rbio
)

2025 
bios_to_»ad
 = 0;

2026 
bio_li¡
 bio_list;

2027 
»t
;

2028 
·g’r
;

2029 
¡re
;

2030 
bio
 *bio;

2032 
	`bio_li¡_š™
(&
bio_li¡
);

2034 
»t
 = 
	`®loc_rbio_·ges
(
rbio
);

2035 ià(
»t
)

2036 
þ—nup
;

2038 
	`©omic_£t
(&
rbio
->
”rÜ
, 0);

2045 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++) {

2046 ià(
rbio
->
çža
 =ð
¡re
 ||„bio->
çžb
 == stripe) {

2047 
	`©omic_šc
(&
rbio
->
”rÜ
);

2051 
·g’r
 = 0;…ag’¸< 
rbio
->
¡re_Åages
;…agenr++) {

2052 
·ge
 *
p
;

2058 
p
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

2059 ià(
	`PageU±od©e
(
p
))

2062 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
,

2063 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
),

2064 
¡re
, 
·g’r
, 
rbio
->
¡re_Ën
);

2065 ià(
»t
 < 0)

2066 
þ—nup
;

2070 
bios_to_»ad
 = 
	`bio_li¡_size
(&
bio_li¡
);

2071 ià(!
bios_to_»ad
) {

2077 ià(
	`©omic_»ad
(&
rbio
->
”rÜ
è<ðrbio->
bbio
->
max_”rÜs
) {

2078 
	`__¿id_»cov”_’d_io
(
rbio
);

2079 
out
;

2081 
þ—nup
;

2089 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
bios_to_»ad
);

2091 
bio
 = 
	`bio_li¡_pÝ
(&
bio_li¡
);

2092 ià(!
bio
)

2095 
bio
->
bi_´iv©e
 = 
rbio
;

2096 
bio
->
bi_’d_io
 = 
¿id_»cov”_’d_io
;

2097 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

2099 
	`bŒfs_bio_wq_’d_io
(
rbio
->
fs_šfo
, 
bio
, 
BTRFS_WQ_ENDIO_RAID56
);

2101 
	`subm™_bio
(
bio
);

2103 
out
:

2106 
þ—nup
:

2107 ià(
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_READ_REBUILD
 ||

2108 
rbio
->
Ý”©iÚ
 =ð
BTRFS_RBIO_REBUILD_MISSING
)

2109 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

2110  -
EIO
;

2111 
	}
}

2119 
	$¿id56_·r™y_»cov”
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

2120 
bŒfs_bio
 *
bbio
, 
u64
 
¡re_Ën
,

2121 
mœrÜ_num
, 
g’”ic_io
)

2123 
bŒfs_¿id_bio
 *
rbio
;

2124 
»t
;

2126 ià(
g’”ic_io
) {

2127 
	`ASSERT
(
bbio
->
mœrÜ_num
 == mirror_num);

2128 
	`bŒfs_io_bio
(
bio
)->
mœrÜ_num
 = mirror_num;

2131 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bbio
, 
¡re_Ën
);

2132 ià(
	`IS_ERR
(
rbio
)) {

2133 ià(
g’”ic_io
)

2134 
	`bŒfs_put_bbio
(
bbio
);

2135  
	`PTR_ERR
(
rbio
);

2138 
rbio
->
Ý”©iÚ
 = 
BTRFS_RBIO_READ_REBUILD
;

2139 
	`bio_li¡_add
(&
rbio
->
bio_li¡
, 
bio
);

2140 
rbio
->
bio_li¡_by‹s
 = 
bio
->
bi_™”
.
bi_size
;

2142 
rbio
->
çža
 = 
	`fšd_logiÿl_bio_¡re
Ôbio, 
bio
);

2143 ià(
rbio
->
çža
 == -1) {

2144 
	`bŒfs_w¬n
(
fs_šfo
,

2146 
__func__
, (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
 << 9,

2147 (
u64
)
bio
->
bi_™”
.
bi_size
, 
bbio
->
m­_ty³
);

2148 ià(
g’”ic_io
)

2149 
	`bŒfs_put_bbio
(
bbio
);

2150 
	`kä“
(
rbio
);

2151  -
EIO
;

2154 ià(
g’”ic_io
) {

2155 
	`bŒfs_bio_couÁ”_šc_noblocked
(
fs_šfo
);

2156 
rbio
->
g’”ic_bio_út
 = 1;

2158 
	`bŒfs_g‘_bbio
(
bbio
);

2165 ià(
mœrÜ_num
 == 3)

2166 
rbio
->
çžb
 =„bio->
»®_¡res
 - 2;

2168 
»t
 = 
	`lock_¡re_add
(
rbio
);

2177 ià(
»t
 == 0)

2178 
	`__¿id56_·r™y_»cov”
(
rbio
);

2186 
	}
}

2188 
	$rmw_wÜk
(
bŒfs_wÜk
 *
wÜk
)

2190 
bŒfs_¿id_bio
 *
rbio
;

2192 
rbio
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work);

2193 
	`¿id56_rmw_¡re
(
rbio
);

2194 
	}
}

2196 
	$»ad_»bužd_wÜk
(
bŒfs_wÜk
 *
wÜk
)

2198 
bŒfs_¿id_bio
 *
rbio
;

2200 
rbio
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work);

2201 
	`__¿id56_·r™y_»cov”
(
rbio
);

2202 
	}
}

2214 
bŒfs_¿id_bio
 *

2215 
	$¿id56_·r™y_®loc_süub_rbio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

2216 
bŒfs_bio
 *
bbio
, 
u64
 
¡re_Ën
,

2217 
bŒfs_deviû
 *
süub_dev
,

2218 *
db™m­
, 
¡re_n£ùÜs
)

2220 
bŒfs_¿id_bio
 *
rbio
;

2221 
i
;

2223 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bbio
, 
¡re_Ën
);

2224 ià(
	`IS_ERR
(
rbio
))

2225  
NULL
;

2226 
	`bio_li¡_add
(&
rbio
->
bio_li¡
, 
bio
);

2231 
	`ASSERT
(!
bio
->
bi_™”
.
bi_size
);

2232 
rbio
->
Ý”©iÚ
 = 
BTRFS_RBIO_PARITY_SCRUB
;

2234 
i
 = 0; i < 
rbio
->
»®_¡res
; i++) {

2235 ià(
bbio
->
¡res
[
i
].
dev
 =ð
süub_dev
) {

2236 
rbio
->
süubp
 = 
i
;

2242 
	`ASSERT
(
fs_šfo
->
£ùÜsize
 =ð
PAGE_SIZE
);

2243 
	`ASSERT
(
rbio
->
¡re_Åages
 =ð
¡re_n£ùÜs
);

2244 
	`b™m­_cÝy
(
rbio
->
db™m­
, db™m­, 
¡re_n£ùÜs
);

2250 
rbio
->
g’”ic_bio_út
 = 1;

2252  
rbio
;

2253 
	}
}

2256 
	$¿id56_add_süub_·ges
(
bŒfs_¿id_bio
 *
rbio
, 
·ge
 *page,

2257 
u64
 
logiÿl
)

2259 
¡re_off£t
;

2260 
šdex
;

2262 
	`ASSERT
(
logiÿl
 >ð
rbio
->
bbio
->
¿id_m­
[0]);

2263 
	`ASSERT
(
logiÿl
 + 
PAGE_SIZE
 <ð
rbio
->
bbio
->
¿id_m­
[0] +

2264 
rbio
->
¡re_Ën
 *„bio->
Ä_d©a
);

2265 
¡re_off£t
 = ()(
logiÿl
 - 
rbio
->
bbio
->
¿id_m­
[0]);

2266 
šdex
 = 
¡re_off£t
 >> 
PAGE_SHIFT
;

2267 
rbio
->
bio_·ges
[
šdex
] = 
·ge
;

2268 
	}
}

2274 
	$®loc_rbio_es£ÁŸl_·ges
(
bŒfs_¿id_bio
 *
rbio
)

2276 
i
;

2277 
b™
;

2278 
šdex
;

2279 
·ge
 *page;

2281 
	`fÜ_—ch_£t_b™
(
b™
, 
rbio
->
db™m­
,„bio->
¡re_Åages
) {

2282 
i
 = 0; i < 
rbio
->
»®_¡res
; i++) {

2283 
šdex
 = 
i
 * 
rbio
->
¡re_Åages
 + 
b™
;

2284 ià(
rbio
->
¡re_·ges
[
šdex
])

2287 
·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

2288 ià(!
·ge
)

2289  -
ENOMEM
;

2290 
rbio
->
¡re_·ges
[
šdex
] = 
·ge
;

2294 
	}
}

2296 
nošlše
 
	$fšish_·r™y_süub
(
bŒfs_¿id_bio
 *
rbio
,

2297 
Ãed_check
)

2299 
bŒfs_bio
 *
bbio
 = 
rbio
->bbio;

2300 *
poš‹rs
[
rbio
->
»®_¡res
];

2301 
	`DECLARE_BITMAP
(
pb™m­
, 
rbio
->
¡re_Åages
);

2302 
Ä_d©a
 = 
rbio
->nr_data;

2303 
¡re
;

2304 
·g’r
;

2305 
p_¡re
 = -1;

2306 
q_¡re
 = -1;

2307 
·ge
 *
p_·ge
 = 
NULL
;

2308 
·ge
 *
q_·ge
 = 
NULL
;

2309 
bio_li¡
 bio_list;

2310 
bio
 *bio;

2311 
is_»¶aû
 = 0;

2312 
»t
;

2314 
	`bio_li¡_š™
(&
bio_li¡
);

2316 ià(
rbio
->
»®_¡res
 -„bio->
Ä_d©a
 == 1) {

2317 
p_¡re
 = 
rbio
->
»®_¡res
 - 1;

2318 } ià(
rbio
->
»®_¡res
 -„bio->
Ä_d©a
 == 2) {

2319 
p_¡re
 = 
rbio
->
»®_¡res
 - 2;

2320 
q_¡re
 = 
rbio
->
»®_¡res
 - 1;

2322 
	`BUG
();

2325 ià(
bbio
->
num_tgtdevs
 && bbio->
tgtdev_m­
[
rbio
->
süubp
]) {

2326 
is_»¶aû
 = 1;

2327 
	`b™m­_cÝy
(
pb™m­
, 
rbio
->
db™m­
,„bio->
¡re_Åages
);

2335 
	`þ—r_b™
(
RBIO_CACHE_READY_BIT
, &
rbio
->
æags
);

2337 ià(!
Ãed_check
)

2338 
wr™eback
;

2340 
p_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

2341 ià(!
p_·ge
)

2342 
þ—nup
;

2343 
	`S‘PageU±od©e
(
p_·ge
);

2345 ià(
q_¡re
 != -1) {

2346 
q_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

2347 ià(!
q_·ge
) {

2348 
	`__ä“_·ge
(
p_·ge
);

2349 
þ—nup
;

2351 
	`S‘PageU±od©e
(
q_·ge
);

2354 
	`©omic_£t
(&
rbio
->
”rÜ
, 0);

2356 
	`fÜ_—ch_£t_b™
(
·g’r
, 
rbio
->
db™m­
,„bio->
¡re_Åages
) {

2357 
·ge
 *
p
;

2358 *
·r™y
;

2360 
¡re
 = 0; sŒ< 
Ä_d©a
; stripe++) {

2361 
p
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 0);

2362 
poš‹rs
[
¡re
] = 
	`km­
(
p
);

2366 
poš‹rs
[
¡re
++] = 
	`km­
(
p_·ge
);

2368 ià(
q_¡re
 != -1) {

2374 
poš‹rs
[
¡re
++] = 
	`km­
(
q_·ge
);

2376 
¿id6_ÿÎ
.
	`g’_syndrome
(
rbio
->
»®_¡res
, 
PAGE_SIZE
,

2377 
poš‹rs
);

2380 
	`memýy
(
poš‹rs
[
Ä_d©a
],…oš‹rs[0], 
PAGE_SIZE
);

2381 
	`run_xÜ
(
poš‹rs
 + 1, 
Ä_d©a
 - 1, 
PAGE_SIZE
);

2385 
p
 = 
	`rbio_¡re_·ge
(
rbio
,„bio->
süubp
, 
·g’r
);

2386 
·r™y
 = 
	`km­
(
p
);

2387 ià(
	`memcmp
(
·r™y
, 
poš‹rs
[
rbio
->
süubp
], 
PAGE_SIZE
))

2388 
	`memýy
(
·r™y
, 
poš‹rs
[
rbio
->
süubp
], 
PAGE_SIZE
);

2391 
	`b™m­_þ—r
(
rbio
->
db™m­
, 
·g’r
, 1);

2392 
	`kunm­
(
p
);

2394 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++)

2395 
	`kunm­
(
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 0));

2398 
	`__ä“_·ge
(
p_·ge
);

2399 ià(
q_·ge
)

2400 
	`__ä“_·ge
(
q_·ge
);

2402 
wr™eback
:

2408 
	`fÜ_—ch_£t_b™
(
·g’r
, 
rbio
->
db™m­
,„bio->
¡re_Åages
) {

2409 
·ge
 *page;

2411 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
,„bio->
süubp
, 
·g’r
);

2412 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
,

2413 
·ge
, 
rbio
->
süubp
, 
·g’r
,„bio->
¡re_Ën
);

2414 ià(
»t
)

2415 
þ—nup
;

2418 ià(!
is_»¶aû
)

2419 
subm™_wr™e
;

2421 
	`fÜ_—ch_£t_b™
(
·g’r
, 
pb™m­
, 
rbio
->
¡re_Åages
) {

2422 
·ge
 *page;

2424 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
,„bio->
süubp
, 
·g’r
);

2425 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
, 
·ge
,

2426 
bbio
->
tgtdev_m­
[
rbio
->
süubp
],

2427 
·g’r
, 
rbio
->
¡re_Ën
);

2428 ià(
»t
)

2429 
þ—nup
;

2432 
subm™_wr™e
:

2433 
Ä_d©a
 = 
	`bio_li¡_size
(&
bio_li¡
);

2434 ià(!
Ä_d©a
) {

2436 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_OK
);

2440 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
Ä_d©a
);

2443 
bio
 = 
	`bio_li¡_pÝ
(&
bio_li¡
);

2444 ià(!
bio
)

2447 
bio
->
bi_´iv©e
 = 
rbio
;

2448 
bio
->
bi_’d_io
 = 
¿id_wr™e_’d_io
;

2449 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

2451 
	`subm™_bio
(
bio
);

2455 
þ—nup
:

2456 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

2457 
	}
}

2459 
šlše
 
	$is_d©a_¡re
(
bŒfs_¿id_bio
 *
rbio
, 
¡re
)

2461 ià(
¡re
 >ð0 && sŒ< 
rbio
->
Ä_d©a
)

2464 
	}
}

2473 
	$v®id©e_rbio_fÜ_·r™y_süub
(
bŒfs_¿id_bio
 *
rbio
)

2475 ià(
	`©omic_»ad
(&
rbio
->
”rÜ
è>„bio->
bbio
->
max_”rÜs
)

2476 
þ—nup
;

2478 ià(
rbio
->
çža
 >ð0 ||„bio->
çžb
 >= 0) {

2479 
dçž
 = 0, 
çžp
 = -1;

2481 ià(
	`is_d©a_¡re
(
rbio
,„bio->
çža
))

2482 
dçž
++;

2483 ià(
	`is_·r™y_¡re
(
rbio
->
çža
))

2484 
çžp
 = 
rbio
->
çža
;

2486 ià(
	`is_d©a_¡re
(
rbio
,„bio->
çžb
))

2487 
dçž
++;

2488 ià(
	`is_·r™y_¡re
(
rbio
->
çžb
))

2489 
çžp
 = 
rbio
->
çžb
;

2496 ià(
dçž
 > 
rbio
->
bbio
->
max_”rÜs
 - 1)

2497 
þ—nup
;

2503 ià(
dçž
 == 0) {

2504 
	`fšish_·r™y_süub
(
rbio
, 0);

2514 ià(
çžp
 !ð
rbio
->
süubp
)

2515 
þ—nup
;

2517 
	`__¿id_»cov”_’d_io
(
rbio
);

2519 
	`fšish_·r™y_süub
(
rbio
, 1);

2523 
þ—nup
:

2524 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

2525 
	}
}

2535 
	$¿id56_·r™y_süub_’d_io
(
bio
 *bio)

2537 
bŒfs_¿id_bio
 *
rbio
 = 
bio
->
bi_´iv©e
;

2539 ià(
bio
->
bi_¡©us
)

2540 
	`çž_bio_¡re
(
rbio
, 
bio
);

2542 
	`£t_bio_·ges_u±od©e
(
bio
);

2544 
	`bio_put
(
bio
);

2546 ià(!
	`©omic_dec_ªd_‹¡
(&
rbio
->
¡res_³ndšg
))

2554 
	`v®id©e_rbio_fÜ_·r™y_süub
(
rbio
);

2555 
	}
}

2557 
	$¿id56_·r™y_süub_¡re
(
bŒfs_¿id_bio
 *
rbio
)

2559 
bios_to_»ad
 = 0;

2560 
bio_li¡
 bio_list;

2561 
»t
;

2562 
·g’r
;

2563 
¡re
;

2564 
bio
 *bio;

2566 
»t
 = 
	`®loc_rbio_es£ÁŸl_·ges
(
rbio
);

2567 ià(
»t
)

2568 
þ—nup
;

2570 
	`bio_li¡_š™
(&
bio_li¡
);

2572 
	`©omic_£t
(&
rbio
->
”rÜ
, 0);

2577 
¡re
 = 0; sŒ< 
rbio
->
»®_¡res
; stripe++) {

2578 
	`fÜ_—ch_£t_b™
(
·g’r
, 
rbio
->
db™m­
,„bio->
¡re_Åages
) {

2579 
·ge
 *page;

2586 
·ge
 = 
	`·ge_š_rbio
(
rbio
, 
¡re
, 
·g’r
, 1);

2587 ià(
·ge
)

2590 
·ge
 = 
	`rbio_¡re_·ge
(
rbio
, 
¡re
, 
·g’r
);

2595 ià(
	`PageU±od©e
(
·ge
))

2598 
»t
 = 
	`rbio_add_io_·ge
(
rbio
, &
bio_li¡
, 
·ge
,

2599 
¡re
, 
·g’r
, 
rbio
->
¡re_Ën
);

2600 ià(
»t
)

2601 
þ—nup
;

2605 
bios_to_»ad
 = 
	`bio_li¡_size
(&
bio_li¡
);

2606 ià(!
bios_to_»ad
) {

2613 
fšish
;

2620 
	`©omic_£t
(&
rbio
->
¡res_³ndšg
, 
bios_to_»ad
);

2622 
bio
 = 
	`bio_li¡_pÝ
(&
bio_li¡
);

2623 ià(!
bio
)

2626 
bio
->
bi_´iv©e
 = 
rbio
;

2627 
bio
->
bi_’d_io
 = 
¿id56_·r™y_süub_’d_io
;

2628 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

2630 
	`bŒfs_bio_wq_’d_io
(
rbio
->
fs_šfo
, 
bio
, 
BTRFS_WQ_ENDIO_RAID56
);

2632 
	`subm™_bio
(
bio
);

2637 
þ—nup
:

2638 
	`rbio_Üig_’d_io
(
rbio
, 
BLK_STS_IOERR
);

2641 
fšish
:

2642 
	`v®id©e_rbio_fÜ_·r™y_süub
(
rbio
);

2643 
	}
}

2645 
	$süub_·r™y_wÜk
(
bŒfs_wÜk
 *
wÜk
)

2647 
bŒfs_¿id_bio
 *
rbio
;

2649 
rbio
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work);

2650 
	`¿id56_·r™y_süub_¡re
(
rbio
);

2651 
	}
}

2653 
	$async_süub_·r™y
(
bŒfs_¿id_bio
 *
rbio
)

2655 
	`bŒfs_š™_wÜk
(&
rbio
->
wÜk
, 
bŒfs_rmw_h–³r
,

2656 
süub_·r™y_wÜk
, 
NULL
, NULL);

2658 
	`bŒfs_queue_wÜk
(
rbio
->
fs_šfo
->
rmw_wÜk”s
, &rbio->
wÜk
);

2659 
	}
}

2661 
	$¿id56_·r™y_subm™_süub_rbio
(
bŒfs_¿id_bio
 *
rbio
)

2663 ià(!
	`lock_¡re_add
(
rbio
))

2664 
	`async_süub_·r™y
(
rbio
);

2665 
	}
}

2669 
bŒfs_¿id_bio
 *

2670 
	$¿id56_®loc_missšg_rbio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

2671 
bŒfs_bio
 *
bbio
, 
u64
 
Ëngth
)

2673 
bŒfs_¿id_bio
 *
rbio
;

2675 
rbio
 = 
	`®loc_rbio
(
fs_šfo
, 
bbio
, 
Ëngth
);

2676 ià(
	`IS_ERR
(
rbio
))

2677  
NULL
;

2679 
rbio
->
Ý”©iÚ
 = 
BTRFS_RBIO_REBUILD_MISSING
;

2680 
	`bio_li¡_add
(&
rbio
->
bio_li¡
, 
bio
);

2685 
	`ASSERT
(!
bio
->
bi_™”
.
bi_size
);

2687 
rbio
->
çža
 = 
	`fšd_logiÿl_bio_¡re
Ôbio, 
bio
);

2688 ià(
rbio
->
çža
 == -1) {

2689 
	`BUG
();

2690 
	`kä“
(
rbio
);

2691  
NULL
;

2698 
rbio
->
g’”ic_bio_út
 = 1;

2700  
rbio
;

2701 
	}
}

2703 
	$missšg_¿id56_wÜk
(
bŒfs_wÜk
 *
wÜk
)

2705 
bŒfs_¿id_bio
 *
rbio
;

2707 
rbio
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_¿id_bio
, work);

2708 
	`__¿id56_·r™y_»cov”
(
rbio
);

2709 
	}
}

2711 
	$async_missšg_¿id56
(
bŒfs_¿id_bio
 *
rbio
)

2713 
	`bŒfs_š™_wÜk
(&
rbio
->
wÜk
, 
bŒfs_rmw_h–³r
,

2714 
missšg_¿id56_wÜk
, 
NULL
, NULL);

2716 
	`bŒfs_queue_wÜk
(
rbio
->
fs_šfo
->
rmw_wÜk”s
, &rbio->
wÜk
);

2717 
	}
}

2719 
	$¿id56_subm™_missšg_rbio
(
bŒfs_¿id_bio
 *
rbio
)

2721 ià(!
	`lock_¡re_add
(
rbio
))

2722 
	`async_missšg_¿id56
(
rbio
);

2723 
	}
}

	@raid56.h

20 #iâdeà
__BTRFS_RAID56__


21 
	#__BTRFS_RAID56__


	)

22 
šlše
 
	$Ä_·r™y_¡res
(
m­_lookup
 *
m­
)

24 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
)

26 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

30 
	}
}

32 
šlše
 
	$Ä_d©a_¡res
(
m­_lookup
 *
m­
)

34  
m­
->
num_¡res
 - 
	`Ä_·r™y_¡res
(map);

35 
	}
}

36 
	#RAID5_P_STRIPE
 ((
u64
)-2)

	)

37 
	#RAID6_Q_STRIPE
 ((
u64
)-1)

	)

39 
	#is_·r™y_¡re
(
x
è(((xè=ð
RAID5_P_STRIPE
) || \

40 ((
x
è=ð
RAID6_Q_STRIPE
))

	)

42 
	gbŒfs_¿id_bio
;

43 
	gbŒfs_deviû
;

45 
¿id56_·r™y_»cov”
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

46 
bŒfs_bio
 *
bbio
, 
u64
 
¡re_Ën
,

47 
mœrÜ_num
, 
g’”ic_io
);

48 
¿id56_·r™y_wr™e
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

49 
bŒfs_bio
 *
bbio
, 
u64
 
¡re_Ën
);

51 
¿id56_add_süub_·ges
(
bŒfs_¿id_bio
 *
rbio
, 
·ge
 *page,

52 
u64
 
logiÿl
);

54 
bŒfs_¿id_bio
 *

55 
¿id56_·r™y_®loc_süub_rbio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

56 
bŒfs_bio
 *
bbio
, 
u64
 
¡re_Ën
,

57 
bŒfs_deviû
 *
süub_dev
,

58 *
db™m­
, 
¡re_n£ùÜs
);

59 
¿id56_·r™y_subm™_süub_rbio
(
bŒfs_¿id_bio
 *
rbio
);

61 
bŒfs_¿id_bio
 *

62 
¿id56_®loc_missšg_rbio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

63 
bŒfs_bio
 *
bbio
, 
u64
 
Ëngth
);

64 
¿id56_subm™_missšg_rbio
(
bŒfs_¿id_bio
 *
rbio
);

66 
bŒfs_®loc_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
);

67 
bŒfs_ä“_¡re_hash_bË
(
bŒfs_fs_šfo
 *
šfo
);

	@rcu-string.h

19 
	srcu_¡ršg
 {

20 
rcu_h—d
 
	mrcu
;

21 
	m¡r
[0];

24 
šlše
 
rcu_¡ršg
 *
	$rcu_¡ršg_¡rdup
(cÚ¡ *
¤c
, 
gå_t
 
mask
)

26 
size_t
 
Ën
 = 
	`¡¾’
(
¤c
) + 1;

27 
rcu_¡ršg
 *
»t
 = 
	`kz®loc
((rcu_string) +

28 (
Ën
 * ()), 
mask
);

29 ià(!
»t
)

30  
»t
;

31 
	`¡ºýy
(
»t
->
¡r
, 
¤c
, 
Ën
);

32  
»t
;

33 
	}
}

35 
šlše
 
	$rcu_¡ršg_ä“
(
rcu_¡ršg
 *
¡r
)

37 ià(
¡r
)

38 
	`kä“_rcu
(
¡r
, 
rcu
);

39 
	}
}

41 
	#´štk_š_rcu
(
fmt
, ...) do { \

42 
	`rcu_»ad_lock
(); \

43 
	`´štk
(
fmt
, 
__VA_ARGS__
); \

44 
	`rcu_»ad_uÆock
(); \

45 } 0)

	)

47 
	#´štk_¿‹lim™ed_š_rcu
(
fmt
, ...) do { \

48 
	`rcu_»ad_lock
(); \

49 
	`´štk_¿‹lim™ed
(
fmt
, 
__VA_ARGS__
); \

50 
	`rcu_»ad_uÆock
(); \

51 } 0)

	)

53 
	#rcu_¡r_d”ef
(
rcu_¡r
) ({ \

54 
rcu_¡ršg
 *
__¡r
 = 
	`rcu_d”eã»nû
(
rcu_¡r
); \

55 
__¡r
->
¡r
; \

56 })

	)

	@reada.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/·gem­.h
>

21 
	~<lšux/wr™eback.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/rbŒ“.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/wÜkqueue.h
>

26 
	~"ù»e.h
"

27 
	~"vÞumes.h
"

28 
	~"disk-io.h
"

29 
	~"Œª§ùiÚ.h
"

30 
	~"dev-»¶aû.h
"

32 #undeà
DEBUG


58 
	#MAX_IN_FLIGHT
 6

	)

60 
	s»ada_extùl
 {

61 
li¡_h—d
 
	mli¡
;

62 
»ada_cÚŒÞ
 *
	mrc
;

63 
u64
 
	mg’”©iÚ
;

66 
	s»ada_ex‹Á
 {

67 
u64
 
	mlogiÿl
;

68 
bŒfs_key
 
	mtÝ
;

69 
li¡_h—d
 
	mextùl
;

70 
	m»fút
;

71 
¥šlock_t
 
	mlock
;

72 
»ada_zÚe
 *
	mzÚes
[
BTRFS_MAX_MIRRORS
];

73 
	mnzÚes
;

74 
	mscheduËd
;

77 
	s»ada_zÚe
 {

78 
u64
 
	m¡¬t
;

79 
u64
 
	m’d
;

80 
u64
 
	m–ems
;

81 
li¡_h—d
 
	mli¡
;

82 
¥šlock_t
 
	mlock
;

83 
	mlocked
;

84 
bŒfs_deviû
 *
	mdeviû
;

85 
bŒfs_deviû
 *
	mdevs
[
BTRFS_MAX_MIRRORS
];

87 
	mndevs
;

88 
k»f
 
	m»fút
;

91 
	s»ada_machše_wÜk
 {

92 
bŒfs_wÜk
 
	mwÜk
;

93 
bŒfs_fs_šfo
 *
	mfs_šfo
;

96 
»ada_ex‹Á_put
(
bŒfs_fs_šfo
 *, 
»ada_ex‹Á
 *);

97 
»ada_cÚŒÞ_»Ëa£
(
k»f
 *kref);

98 
»ada_zÚe_»Ëa£
(
k»f
 *kref);

99 
»ada_¡¬t_machše
(
bŒfs_fs_šfo
 *
fs_šfo
);

100 
__»ada_¡¬t_machše
(
bŒfs_fs_šfo
 *
fs_šfo
);

102 
»ada_add_block
(
»ada_cÚŒÞ
 *
rc
, 
u64
 
logiÿl
,

103 
bŒfs_key
 *
tÝ
, 
u64
 
g’”©iÚ
);

107 
	$__»adah—d_hook
(
bŒfs_fs_šfo
 *
fs_šfo
,

108 
»ada_ex‹Á
 *
»
, 
ex‹Á_bufãr
 *
eb
,

109 
”r
)

111 
Ä™ems
;

112 
i
;

113 
u64
 
by‹Ä
;

114 
u64
 
g’”©iÚ
;

115 
li¡_h—d
 
li¡
;

117 
	`¥š_lock
(&
»
->
lock
);

122 
	`li¡_»¶aû_š™
(&
»
->
extùl
, &
li¡
);

123 
»
->
scheduËd
 = 0;

124 
	`¥š_uÆock
(&
»
->
lock
);

132 ià(
”r
)

133 
þ—nup
;

141 ià(!
	`bŒfs_h—d”_Ëv–
(
eb
))

142 
þ—nup
;

144 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

145 
g’”©iÚ
 = 
	`bŒfs_h—d”_g’”©iÚ
(
eb
);

146 
i
 = 0; i < 
Ä™ems
; i++) {

147 
»ada_extùl
 *
»c
;

148 
u64
 
n_g’
;

149 
bŒfs_key
 
key
;

150 
bŒfs_key
 
Ãxt_key
;

152 
	`bŒfs_node_key_to_ýu
(
eb
, &
key
, 
i
);

153 ià(
i
 + 1 < 
Ä™ems
)

154 
	`bŒfs_node_key_to_ýu
(
eb
, &
Ãxt_key
, 
i
 + 1);

156 
Ãxt_key
 = 
»
->
tÝ
;

157 
by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
, 
i
);

158 
n_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
i
);

160 
	`li¡_fÜ_—ch_’Œy
(
»c
, &
li¡
,†ist) {

161 
»ada_cÚŒÞ
 *
rc
 = 
»c
->rc;

170 #ifdeà
DEBUG


171 ià(
»c
->
g’”©iÚ
 != generation) {

172 
	`bŒfs_debug
(
fs_šfo
,

174 
key
.
objeùid
, key.
ty³
, key.
off£t
,

175 
»c
->
g’”©iÚ
, generation);

178 ià(
»c
->
g’”©iÚ
 == generation &&

179 
	`bŒfs_comp_ýu_keys
(&
key
, &
rc
->
key_’d
) < 0 &&

180 
	`bŒfs_comp_ýu_keys
(&
Ãxt_key
, &
rc
->
key_¡¬t
) > 0)

181 
	`»ada_add_block
(
rc
, 
by‹Ä
, &
Ãxt_key
, 
n_g’
);

185 
þ—nup
:

189 !
	`li¡_em±y
(&
li¡
)) {

190 
»ada_cÚŒÞ
 *
rc
;

191 
»ada_extùl
 *
»c
;

193 
»c
 = 
	`li¡_fœ¡_’Œy
(&
li¡
, 
»ada_extùl
,†ist);

194 
	`li¡_d–
(&
»c
->
li¡
);

195 
rc
 = 
»c
->rc;

196 
	`kä“
(
»c
);

198 
	`k»f_g‘
(&
rc
->
»fút
);

199 ià(
	`©omic_dec_ªd_‹¡
(&
rc
->
–ems
)) {

200 
	`k»f_put
(&
rc
->
»fút
, 
»ada_cÚŒÞ_»Ëa£
);

201 
	`wake_up
(&
rc
->
wa™
);

203 
	`k»f_put
(&
rc
->
»fút
, 
»ada_cÚŒÞ_»Ëa£
);

205 
	`»ada_ex‹Á_put
(
fs_šfo
, 
»
);

209 
	}
}

211 
	$bŒ“_»adah—d_hook
(
ex‹Á_bufãr
 *
eb
, 
”r
)

213 
bŒfs_fs_šfo
 *
fs_šfo
 = 
eb
->fs_info;

214 
»t
 = 0;

215 
»ada_ex‹Á
 *
»
;

218 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

219 
»
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
»ada_Œ“
,

220 
eb
->
¡¬t
 >> 
PAGE_SHIFT
);

221 ià(
»
)

222 
»
->
»fút
++;

223 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

224 ià(!
»
) {

225 
»t
 = -1;

226 
¡¬t_machše
;

229 
	`__»adah—d_hook
(
fs_šfo
, 
»
, 
eb
, 
”r
);

230 
	`»ada_ex‹Á_put
(
fs_šfo
, 
»
);

232 
¡¬t_machše
:

233 
	`»ada_¡¬t_machše
(
fs_šfo
);

234  
»t
;

235 
	}
}

237 
»ada_zÚe
 *
	$»ada_fšd_zÚe
(
bŒfs_deviû
 *
dev
, 
u64
 
logiÿl
,

238 
bŒfs_bio
 *
bbio
)

240 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

241 
»t
;

242 
»ada_zÚe
 *
zÚe
;

243 
bŒfs_block_group_ÿche
 *
ÿche
 = 
NULL
;

244 
u64
 
¡¬t
;

245 
u64
 
’d
;

246 
i
;

248 
zÚe
 = 
NULL
;

249 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

250 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
dev
->
»ada_zÚes
, (**)&
zÚe
,

251 
logiÿl
 >> 
PAGE_SHIFT
, 1);

252 ià(
»t
 =ð1 && 
logiÿl
 >ð
zÚe
->
¡¬t
 &&†ogiÿÈ<ðzÚe->
’d
) {

253 
	`k»f_g‘
(&
zÚe
->
»fút
);

254 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

255  
zÚe
;

258 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

260 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
logiÿl
);

261 ià(!
ÿche
)

262  
NULL
;

264 
¡¬t
 = 
ÿche
->
key
.
objeùid
;

265 
’d
 = 
¡¬t
 + 
ÿche
->
key
.
off£t
 - 1;

266 
	`bŒfs_put_block_group
(
ÿche
);

268 
zÚe
 = 
	`kz®loc
((*zÚe), 
GFP_KERNEL
);

269 ià(!
zÚe
)

270  
NULL
;

272 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_KERNEL
);

273 ià(
»t
) {

274 
	`kä“
(
zÚe
);

275  
NULL
;

278 
zÚe
->
¡¬t
 = start;

279 
zÚe
->
’d
 =ƒnd;

280 
	`INIT_LIST_HEAD
(&
zÚe
->
li¡
);

281 
	`¥š_lock_š™
(&
zÚe
->
lock
);

282 
zÚe
->
locked
 = 0;

283 
	`k»f_š™
(&
zÚe
->
»fút
);

284 
zÚe
->
–ems
 = 0;

285 
zÚe
->
deviû
 = 
dev
;

286 
i
 = 0; i < 
bbio
->
num_¡res
; ++i) {

288 
zÚe
->
devs
[
i
] = 
bbio
->
¡res
[i].
dev
;

290 
zÚe
->
ndevs
 = 
bbio
->
num_¡res
;

292 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

293 
»t
 = 
	`¿dix_Œ“_š£¹
(&
dev
->
»ada_zÚes
,

294 ()(
zÚe
->
’d
 >> 
PAGE_SHIFT
),

295 
zÚe
);

297 ià(
»t
 =ð-
EEXIST
) {

298 
	`kä“
(
zÚe
);

299 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
dev
->
»ada_zÚes
, (**)&
zÚe
,

300 
logiÿl
 >> 
PAGE_SHIFT
, 1);

301 ià(
»t
 =ð1 && 
logiÿl
 >ð
zÚe
->
¡¬t
 &&†ogiÿÈ<ðzÚe->
’d
)

302 
	`k»f_g‘
(&
zÚe
->
»fút
);

304 
zÚe
 = 
NULL
;

306 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

307 
	`¿dix_Œ“_´–ßd_’d
();

309  
zÚe
;

310 
	}
}

312 
»ada_ex‹Á
 *
	$»ada_fšd_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

313 
u64
 
logiÿl
,

314 
bŒfs_key
 *
tÝ
)

316 
»t
;

317 
»ada_ex‹Á
 *
»
 = 
NULL
;

318 
»ada_ex‹Á
 *
»_exi¡
 = 
NULL
;

319 
bŒfs_bio
 *
bbio
 = 
NULL
;

320 
bŒfs_deviû
 *
dev
;

321 
bŒfs_deviû
 *
´ev_dev
;

322 
u64
 
Ëngth
;

323 
»®_¡res
;

324 
nzÚes
 = 0;

325 
šdex
 = 
logiÿl
 >> 
PAGE_SHIFT
;

326 
dev_»¶aû_is_Úgošg
;

327 
have_zÚe
 = 0;

329 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

330 
»
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
»ada_Œ“
, 
šdex
);

331 ià(
»
)

332 
»
->
»fút
++;

333 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

335 ià(
»
)

336  
»
;

338 
»
 = 
	`kz®loc
((*»), 
GFP_KERNEL
);

339 ià(!
»
)

340  
NULL
;

342 
»
->
logiÿl
 =†ogical;

343 
»
->
tÝ
 = *top;

344 
	`INIT_LIST_HEAD
(&
»
->
extùl
);

345 
	`¥š_lock_š™
(&
»
->
lock
);

346 
»
->
»fút
 = 1;

351 
Ëngth
 = 
fs_šfo
->
nodesize
;

352 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_GET_READ_MIRRORS
, 
logiÿl
,

353 &
Ëngth
, &
bbio
, 0);

354 ià(
»t
 || !
bbio
 || 
Ëngth
 < 
fs_šfo
->
nodesize
)

355 
”rÜ
;

357 ià(
bbio
->
num_¡res
 > 
BTRFS_MAX_MIRRORS
) {

358 
	`bŒfs_”r
(
fs_šfo
,

360 
BTRFS_MAX_MIRRORS
);

361 
”rÜ
;

364 
»®_¡res
 = 
bbio
->
num_¡res
 - bbio->
num_tgtdevs
;

365 
nzÚes
 = 0;‚zÚe < 
»®_¡res
; ++nzones) {

366 
»ada_zÚe
 *
zÚe
;

368 
dev
 = 
bbio
->
¡res
[
nzÚes
].dev;

371 ià(!
dev
->
bdev
)

374 
zÚe
 = 
	`»ada_fšd_zÚe
(
dev
, 
logiÿl
, 
bbio
);

375 ià(!
zÚe
)

378 
»
->
zÚes
[»->
nzÚes
++] = 
zÚe
;

379 
	`¥š_lock
(&
zÚe
->
lock
);

380 ià(!
zÚe
->
–ems
)

381 
	`k»f_g‘
(&
zÚe
->
»fút
);

382 ++
zÚe
->
–ems
;

383 
	`¥š_uÆock
(&
zÚe
->
lock
);

384 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

385 
	`k»f_put
(&
zÚe
->
»fút
, 
»ada_zÚe_»Ëa£
);

386 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

388 ià(
»
->
nzÚes
 == 0) {

390 
”rÜ
;

393 
»t
 = 
	`¿dix_Œ“_´–ßd
(
GFP_KERNEL
);

394 ià(
»t
)

395 
”rÜ
;

398 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 0);

399 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

400 
»t
 = 
	`¿dix_Œ“_š£¹
(&
fs_šfo
->
»ada_Œ“
, 
šdex
, 
»
);

401 ià(
»t
 =ð-
EEXIST
) {

402 
»_exi¡
 = 
	`¿dix_Œ“_lookup
(&
fs_šfo
->
»ada_Œ“
, 
šdex
);

403 
»_exi¡
->
»fút
++;

404 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

405 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

406 
	`¿dix_Œ“_´–ßd_’d
();

407 
”rÜ
;

409 ià(
»t
) {

410 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

411 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

412 
	`¿dix_Œ“_´–ßd_’d
();

413 
”rÜ
;

415 
	`¿dix_Œ“_´–ßd_’d
();

416 
´ev_dev
 = 
NULL
;

417 
dev_»¶aû_is_Úgošg
 = 
	`bŒfs_dev_»¶aû_is_Úgošg
(

418 &
fs_šfo
->
dev_»¶aû
);

419 
nzÚes
 = 0;‚zÚe < 
»
->nzones; ++nzones) {

420 
dev
 = 
»
->
zÚes
[
nzÚes
]->
deviû
;

422 ià(
dev
 =ð
´ev_dev
) {

432 ià(!
dev
->
bdev
)

435 ià(
dev_»¶aû_is_Úgošg
 &&

436 
dev
 =ð
fs_šfo
->
dev_»¶aû
.
tgtdev
) {

443 
´ev_dev
 = 
dev
;

444 
»t
 = 
	`¿dix_Œ“_š£¹
(&
dev
->
»ada_ex‹Ás
, 
šdex
, 
»
);

445 ià(
»t
) {

446 --
nzÚes
 >= 0) {

447 
dev
 = 
»
->
zÚes
[
nzÚes
]->
deviû
;

448 
	`BUG_ON
(
dev
 =ð
NULL
);

450 
	`¿dix_Œ“_d–‘e
(&
dev
->
»ada_ex‹Ás
, 
šdex
);

452 
	`¿dix_Œ“_d–‘e
(&
fs_šfo
->
»ada_Œ“
, 
šdex
);

453 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

454 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

455 
”rÜ
;

457 
have_zÚe
 = 1;

459 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

460 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

462 ià(!
have_zÚe
)

463 
”rÜ
;

465 
	`bŒfs_put_bbio
(
bbio
);

466  
»
;

468 
”rÜ
:

469 
nzÚes
 = 0;‚zÚe < 
»
->nzones; ++nzones) {

470 
»ada_zÚe
 *
zÚe
;

472 
zÚe
 = 
»
->
zÚes
[
nzÚes
];

473 
	`k»f_g‘
(&
zÚe
->
»fút
);

474 
	`¥š_lock
(&
zÚe
->
lock
);

475 --
zÚe
->
–ems
;

476 ià(
zÚe
->
–ems
 == 0) {

481 
	`k»f_put
(&
zÚe
->
»fút
, 
»ada_zÚe_»Ëa£
);

483 
	`¥š_uÆock
(&
zÚe
->
lock
);

485 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

486 
	`k»f_put
(&
zÚe
->
»fút
, 
»ada_zÚe_»Ëa£
);

487 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

489 
	`bŒfs_put_bbio
(
bbio
);

490 
	`kä“
(
»
);

491  
»_exi¡
;

492 
	}
}

494 
	$»ada_ex‹Á_put
(
bŒfs_fs_šfo
 *
fs_šfo
,

495 
»ada_ex‹Á
 *
»
)

497 
i
;

498 
šdex
 = 
»
->
logiÿl
 >> 
PAGE_SHIFT
;

500 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

501 ià(--
»
->
»fút
) {

502 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

506 
	`¿dix_Œ“_d–‘e
(&
fs_šfo
->
»ada_Œ“
, 
šdex
);

507 
i
 = 0; i < 
»
->
nzÚes
; ++i) {

508 
»ada_zÚe
 *
zÚe
 = 
»
->
zÚes
[
i
];

510 
	`¿dix_Œ“_d–‘e
(&
zÚe
->
deviû
->
»ada_ex‹Ás
, 
šdex
);

513 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

515 
i
 = 0; i < 
»
->
nzÚes
; ++i) {

516 
»ada_zÚe
 *
zÚe
 = 
»
->
zÚes
[
i
];

518 
	`k»f_g‘
(&
zÚe
->
»fút
);

519 
	`¥š_lock
(&
zÚe
->
lock
);

520 --
zÚe
->
–ems
;

521 ià(
zÚe
->
–ems
 == 0) {

524 
	`k»f_put
(&
zÚe
->
»fút
, 
»ada_zÚe_»Ëa£
);

526 
	`¥š_uÆock
(&
zÚe
->
lock
);

528 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

529 
	`k»f_put
(&
zÚe
->
»fút
, 
»ada_zÚe_»Ëa£
);

530 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

533 
	`kä“
(
»
);

534 
	}
}

536 
	$»ada_zÚe_»Ëa£
(
k»f
 *kref)

538 
»ada_zÚe
 *
zÚe
 = 
	`cÚš”_of
(
k»f
, »ada_zÚe, 
»fút
);

540 
	`¿dix_Œ“_d–‘e
(&
zÚe
->
deviû
->
»ada_zÚes
,

541 
zÚe
->
’d
 >> 
PAGE_SHIFT
);

543 
	`kä“
(
zÚe
);

544 
	}
}

546 
	$»ada_cÚŒÞ_»Ëa£
(
k»f
 *kref)

548 
»ada_cÚŒÞ
 *
rc
 = 
	`cÚš”_of
(
k»f
, reada_control,

549 
»fút
);

551 
	`kä“
(
rc
);

552 
	}
}

554 
	$»ada_add_block
(
»ada_cÚŒÞ
 *
rc
, 
u64
 
logiÿl
,

555 
bŒfs_key
 *
tÝ
, 
u64
 
g’”©iÚ
)

557 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->fs_info;

558 
»ada_ex‹Á
 *
»
;

559 
»ada_extùl
 *
»c
;

562 
»
 = 
	`»ada_fšd_ex‹Á
(
fs_šfo
, 
logiÿl
, 
tÝ
);

563 ià(!
»
)

566 
»c
 = 
	`kz®loc
((*»c), 
GFP_KERNEL
);

567 ià(!
»c
) {

568 
	`»ada_ex‹Á_put
(
fs_šfo
, 
»
);

569  -
ENOMEM
;

572 
»c
->
rc
 =„c;

573 
»c
->
g’”©iÚ
 = generation;

574 
	`©omic_šc
(&
rc
->
–ems
);

576 
	`¥š_lock
(&
»
->
lock
);

577 
	`li¡_add_ž
(&
»c
->
li¡
, &
»
->
extùl
);

578 
	`¥š_uÆock
(&
»
->
lock
);

583 
	}
}

588 
	$»ada_³”_zÚes_£t_lock
(
»ada_zÚe
 *
zÚe
, 
lock
)

590 
i
;

591 
šdex
 = 
zÚe
->
’d
 >> 
PAGE_SHIFT
;

593 
i
 = 0; i < 
zÚe
->
ndevs
; ++i) {

594 
»ada_zÚe
 *
³”
;

595 
³”
 = 
	`¿dix_Œ“_lookup
(&
zÚe
->
devs
[
i
]->
»ada_zÚes
, 
šdex
);

596 ià(
³”
 &&…“r->
deviû
 !ð
zÚe
->device)

597 
³”
->
locked
 = 
lock
;

599 
	}
}

604 
	$»ada_pick_zÚe
(
bŒfs_deviû
 *
dev
)

606 
»ada_zÚe
 *
tÝ_zÚe
 = 
NULL
;

607 
»ada_zÚe
 *
tÝ_locked_zÚe
 = 
NULL
;

608 
u64
 
tÝ_–ems
 = 0;

609 
u64
 
tÝ_locked_–ems
 = 0;

610 
šdex
 = 0;

611 
»t
;

613 ià(
dev
->
»ada_cu¼_zÚe
) {

614 
	`»ada_³”_zÚes_£t_lock
(
dev
->
»ada_cu¼_zÚe
, 0);

615 
	`k»f_put
(&
dev
->
»ada_cu¼_zÚe
->
»fút
, 
»ada_zÚe_»Ëa£
);

616 
dev
->
»ada_cu¼_zÚe
 = 
NULL
;

620 
»ada_zÚe
 *
zÚe
;

622 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
dev
->
»ada_zÚes
,

623 (**)&
zÚe
, 
šdex
, 1);

624 ià(
»t
 == 0)

626 
šdex
 = (
zÚe
->
’d
 >> 
PAGE_SHIFT
) + 1;

627 ià(
zÚe
->
locked
) {

628 ià(
zÚe
->
–ems
 > 
tÝ_locked_–ems
) {

629 
tÝ_locked_–ems
 = 
zÚe
->
–ems
;

630 
tÝ_locked_zÚe
 = 
zÚe
;

633 ià(
zÚe
->
–ems
 > 
tÝ_–ems
) {

634 
tÝ_–ems
 = 
zÚe
->
–ems
;

635 
tÝ_zÚe
 = 
zÚe
;

639 ià(
tÝ_zÚe
)

640 
dev
->
»ada_cu¼_zÚe
 = 
tÝ_zÚe
;

641 ià(
tÝ_locked_zÚe
)

642 
dev
->
»ada_cu¼_zÚe
 = 
tÝ_locked_zÚe
;

646 
dev
->
»ada_Ãxt
 = dev->
»ada_cu¼_zÚe
->
¡¬t
;

647 
	`k»f_g‘
(&
dev
->
»ada_cu¼_zÚe
->
»fút
);

648 
	`»ada_³”_zÚes_£t_lock
(
dev
->
»ada_cu¼_zÚe
, 1);

651 
	}
}

653 
	$»ada_¡¬t_machše_dev
(
bŒfs_deviû
 *
dev
)

655 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

656 
»ada_ex‹Á
 *
»
 = 
NULL
;

657 
mœrÜ_num
 = 0;

658 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

659 
u64
 
logiÿl
;

660 
»t
;

661 
i
;

663 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

664 ià(
dev
->
»ada_cu¼_zÚe
 =ð
NULL
) {

665 
»t
 = 
	`»ada_pick_zÚe
(
dev
);

666 ià(!
»t
) {

667 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

676 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
dev
->
»ada_ex‹Ás
, (**)&
»
,

677 
dev
->
»ada_Ãxt
 >> 
PAGE_SHIFT
, 1);

678 ià(
»t
 =ð0 || 
»
->
logiÿl
 > 
dev
->
»ada_cu¼_zÚe
->
’d
) {

679 
»t
 = 
	`»ada_pick_zÚe
(
dev
);

680 ià(!
»t
) {

681 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

684 
»
 = 
NULL
;

685 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
dev
->
»ada_ex‹Ás
, (**)&
»
,

686 
dev
->
»ada_Ãxt
 >> 
PAGE_SHIFT
, 1);

688 ià(
»t
 == 0) {

689 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

692 
dev
->
»ada_Ãxt
 = 
»
->
logiÿl
 + 
fs_šfo
->
nodesize
;

693 
»
->
»fút
++;

695 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

697 
	`¥š_lock
(&
»
->
lock
);

698 ià(
»
->
scheduËd
 || 
	`li¡_em±y
(&»->
extùl
)) {

699 
	`¥š_uÆock
(&
»
->
lock
);

700 
	`»ada_ex‹Á_put
(
fs_šfo
, 
»
);

703 
»
->
scheduËd
 = 1;

704 
	`¥š_uÆock
(&
»
->
lock
);

709 
i
 = 0; i < 
»
->
nzÚes
; ++i) {

710 ià(
»
->
zÚes
[
i
]->
deviû
 =ð
dev
) {

711 
mœrÜ_num
 = 
i
 + 1;

715 
logiÿl
 = 
»
->logical;

717 
	`©omic_šc
(&
dev
->
»ada_š_æight
);

718 
»t
 = 
	`»ada_Œ“_block_æagged
(
fs_šfo
, 
logiÿl
, 
mœrÜ_num
, &
eb
);

719 ià(
»t
)

720 
	`__»adah—d_hook
(
fs_šfo
, 
»
, 
NULL
, 
»t
);

721 ià(
eb
)

722 
	`__»adah—d_hook
(
fs_šfo
, 
»
, 
eb
, 
»t
);

724 ià(
eb
)

725 
	`ä“_ex‹Á_bufãr
(
eb
);

727 
	`©omic_dec
(&
dev
->
»ada_š_æight
);

728 
	`»ada_ex‹Á_put
(
fs_šfo
, 
»
);

732 
	}
}

734 
	$»ada_¡¬t_machše_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

736 
»ada_machše_wÜk
 *
rmw
;

737 
bŒfs_fs_šfo
 *
fs_šfo
;

738 
Þd_iÝrio
;

740 
rmw
 = 
	`cÚš”_of
(
wÜk
, 
»ada_machše_wÜk
, work);

741 
fs_šfo
 = 
rmw
->fs_info;

743 
	`kä“
(
rmw
);

745 
Þd_iÝrio
 = 
	`IOPRIO_PRIO_VALUE
(
	`sk_niû_ioþass
(
cu¼’t
),

746 
	`sk_niû_iÝrio
(
cu¼’t
));

747 
	`£t_sk_iÝrio
(
cu¼’t
, 
BTRFS_IOPRIO_READA
);

748 
	`__»ada_¡¬t_machše
(
fs_šfo
);

749 
	`£t_sk_iÝrio
(
cu¼’t
, 
Þd_iÝrio
);

751 
	`©omic_dec
(&
fs_šfo
->
»ada_wÜks_út
);

752 
	}
}

754 
	$__»ada_¡¬t_machše
(
bŒfs_fs_šfo
 *
fs_šfo
)

756 
bŒfs_deviû
 *
deviû
;

757 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

758 
u64
 
’queued
;

759 
u64
 
tÙ®
 = 0;

760 
i
;

763 
’queued
 = 0;

764 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

765 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

766 ià(
	`©omic_»ad
(&
deviû
->
»ada_š_æight
) <

767 
MAX_IN_FLIGHT
)

768 
’queued
 +ð
	`»ada_¡¬t_machše_dev
(
deviû
);

770 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

771 
tÙ®
 +ð
’queued
;

772 } 
’queued
 && 
tÙ®
 < 10000);

774 ià(
’queued
 == 0)

784 
i
 = 0; i < 2; ++i) {

785 
	`»ada_¡¬t_machše
(
fs_šfo
);

786 ià(
	`©omic_»ad
(&
fs_šfo
->
»ada_wÜks_út
) >

787 
BTRFS_MAX_MIRRORS
 * 2)

790 
	}
}

792 
	$»ada_¡¬t_machše
(
bŒfs_fs_šfo
 *
fs_šfo
)

794 
»ada_machše_wÜk
 *
rmw
;

796 
rmw
 = 
	`kz®loc
((*rmw), 
GFP_KERNEL
);

797 ià(!
rmw
) {

799 
	`BUG
();

801 
	`bŒfs_š™_wÜk
(&
rmw
->
wÜk
, 
bŒfs_»adah—d_h–³r
,

802 
»ada_¡¬t_machše_wÜk”
, 
NULL
, NULL);

803 
rmw
->
fs_šfo
 = fs_info;

805 
	`bŒfs_queue_wÜk
(
fs_šfo
->
»adah—d_wÜk”s
, &
rmw
->
wÜk
);

806 
	`©omic_šc
(&
fs_šfo
->
»ada_wÜks_út
);

807 
	}
}

809 #ifdeà
DEBUG


810 
	$dump_devs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
®l
)

812 
bŒfs_deviû
 *
deviû
;

813 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

814 
šdex
;

815 
»t
;

816 
i
;

817 
j
;

818 
út
;

820 
	`¥š_lock
(&
fs_šfo
->
»ada_lock
);

821 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

822 
	`bŒfs_debug
(
fs_šfo
, "dev %Îd ha %d iÀæight", 
deviû
->
devid
,

823 
	`©omic_»ad
(&
deviû
->
»ada_š_æight
));

824 
šdex
 = 0;

826 
»ada_zÚe
 *
zÚe
;

827 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
deviû
->
»ada_zÚes
,

828 (**)&
zÚe
, 
šdex
, 1);

829 ià(
»t
 == 0)

831 
	`´_debug
(" zone %llu-%lluƒlems %llu†ocked %d devs",

832 
zÚe
->
¡¬t
, zÚe->
’d
, zÚe->
–ems
,

833 
zÚe
->
locked
);

834 
j
 = 0; j < 
zÚe
->
ndevs
; ++j) {

835 
	`´_cÚt
(" %lld",

836 
zÚe
->
devs
[
j
]->
devid
);

838 ià(
deviû
->
»ada_cu¼_zÚe
 =ð
zÚe
)

839 
	`´_cÚt
(" curr off %llu",

840 
deviû
->
»ada_Ãxt
 - 
zÚe
->
¡¬t
);

841 
	`´_cÚt
("\n");

842 
šdex
 = (
zÚe
->
’d
 >> 
PAGE_SHIFT
) + 1;

844 
út
 = 0;

845 
šdex
 = 0;

846 
®l
) {

847 
»ada_ex‹Á
 *
»
 = 
NULL
;

849 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
deviû
->
»ada_ex‹Ás
,

850 (**)&
»
, 
šdex
, 1);

851 ià(
»t
 == 0)

853 
	`´_debug
("„e:†ogical %llu size %uƒmpty %d scheduled %d",

854 
»
->
logiÿl
, 
fs_šfo
->
nodesize
,

855 
	`li¡_em±y
(&
»
->
extùl
),„e->
scheduËd
);

857 
i
 = 0; i < 
»
->
nzÚes
; ++i) {

858 
	`´_cÚt
(" zone %llu-%llu devs",

859 
»
->
zÚes
[
i
]->
¡¬t
,

860 
»
->
zÚes
[
i
]->
’d
);

861 
j
 = 0; j < 
»
->
zÚes
[
i
]->
ndevs
; ++j) {

862 
	`´_cÚt
(" %lld",

863 
»
->
zÚes
[
i
]->
devs
[
j
]->
devid
);

866 
	`´_cÚt
("\n");

867 
šdex
 = (
»
->
logiÿl
 >> 
PAGE_SHIFT
) + 1;

868 ià(++
út
 > 15)

873 
šdex
 = 0;

874 
út
 = 0;

875 
®l
) {

876 
»ada_ex‹Á
 *
»
 = 
NULL
;

878 
»t
 = 
	`¿dix_Œ“_gªg_lookup
(&
fs_šfo
->
»ada_Œ“
, (**)&
»
,

879 
šdex
, 1);

880 ià(
»t
 == 0)

882 ià(!
»
->
scheduËd
) {

883 
šdex
 = (
»
->
logiÿl
 >> 
PAGE_SHIFT
) + 1;

886 
	`´_debug
("re:†ogical %llu size %u†istƒmpty %d scheduled %d",

887 
»
->
logiÿl
, 
fs_šfo
->
nodesize
,

888 
	`li¡_em±y
(&
»
->
extùl
),„e->
scheduËd
);

889 
i
 = 0; i < 
»
->
nzÚes
; ++i) {

890 
	`´_cÚt
(" zone %llu-%llu devs",

891 
»
->
zÚes
[
i
]->
¡¬t
,

892 
»
->
zÚes
[
i
]->
’d
);

893 
j
 = 0; j < 
»
->
zÚes
[
i
]->
ndevs
; ++j) {

894 
	`´_cÚt
(" %lld",

895 
»
->
zÚes
[
i
]->
devs
[
j
]->
devid
);

898 
	`´_cÚt
("\n");

899 
šdex
 = (
»
->
logiÿl
 >> 
PAGE_SHIFT
) + 1;

901 
	`¥š_uÆock
(&
fs_šfo
->
»ada_lock
);

902 
	}
}

908 
»ada_cÚŒÞ
 *
	$bŒfs_»ada_add
(
bŒfs_roÙ
 *
roÙ
,

909 
bŒfs_key
 *
key_¡¬t
, bŒfs_key *
key_’d
)

911 
»ada_cÚŒÞ
 *
rc
;

912 
u64
 
¡¬t
;

913 
u64
 
g’”©iÚ
;

914 
»t
;

915 
ex‹Á_bufãr
 *
node
;

916 
bŒfs_key
 
max_key
 = {

917 .
objeùid
 = (
u64
)-1,

918 .
ty³
 = (
u8
)-1,

919 .
off£t
 = (
u64
)-1

922 
rc
 = 
	`kz®loc
((*rc), 
GFP_KERNEL
);

923 ià(!
rc
)

924  
	`ERR_PTR
(-
ENOMEM
);

926 
rc
->
fs_šfo
 = 
roÙ
->fs_info;

927 
rc
->
key_¡¬t
 = *key_start;

928 
rc
->
key_’d
 = *key_end;

929 
	`©omic_£t
(&
rc
->
–ems
, 0);

930 
	`š™_wa™queue_h—d
(&
rc
->
wa™
);

931 
	`k»f_š™
(&
rc
->
»fút
);

932 
	`k»f_g‘
(&
rc
->
»fút
);

934 
node
 = 
	`bŒfs_roÙ_node
(
roÙ
);

935 
¡¬t
 = 
node
->start;

936 
g’”©iÚ
 = 
	`bŒfs_h—d”_g’”©iÚ
(
node
);

937 
	`ä“_ex‹Á_bufãr
(
node
);

939 
»t
 = 
	`»ada_add_block
(
rc
, 
¡¬t
, &
max_key
, 
g’”©iÚ
);

940 ià(
»t
) {

941 
	`kä“
(
rc
);

942  
	`ERR_PTR
(
»t
);

945 
	`»ada_¡¬t_machše
(
roÙ
->
fs_šfo
);

947  
rc
;

948 
	}
}

950 #ifdeà
DEBUG


951 
	$bŒfs_»ada_wa™
(*
hªdË
)

953 
»ada_cÚŒÞ
 *
rc
 = 
hªdË
;

954 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->fs_info;

956 
	`©omic_»ad
(&
rc
->
–ems
)) {

957 ià(!
	`©omic_»ad
(&
fs_šfo
->
»ada_wÜks_út
))

958 
	`»ada_¡¬t_machše
(
fs_šfo
);

959 
	`wa™_ev’t_timeout
(
rc
->
wa™
, 
	`©omic_»ad
(&rc->
–ems
) == 0,

960 5 * 
HZ
);

961 
	`dump_devs
(
fs_šfo
, 
	`©omic_»ad
(&
rc
->
–ems
) < 10 ? 1 : 0);

964 
	`dump_devs
(
fs_šfo
, 
	`©omic_»ad
(&
rc
->
–ems
) < 10 ? 1 : 0);

966 
	`k»f_put
(&
rc
->
»fút
, 
»ada_cÚŒÞ_»Ëa£
);

969 
	}
}

971 
	$bŒfs_»ada_wa™
(*
hªdË
)

973 
»ada_cÚŒÞ
 *
rc
 = 
hªdË
;

974 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->fs_info;

976 
	`©omic_»ad
(&
rc
->
–ems
)) {

977 ià(!
	`©omic_»ad
(&
fs_šfo
->
»ada_wÜks_út
))

978 
	`»ada_¡¬t_machše
(
fs_šfo
);

979 
	`wa™_ev’t_timeout
(
rc
->
wa™
, 
	`©omic_»ad
(&rc->
–ems
) == 0,

980 (
HZ
 + 9) / 10);

983 
	`k»f_put
(&
rc
->
»fút
, 
»ada_cÚŒÞ_»Ëa£
);

986 
	}
}

989 
	$bŒfs_»ada_d‘ach
(*
hªdË
)

991 
»ada_cÚŒÞ
 *
rc
 = 
hªdË
;

993 
	`k»f_put
(&
rc
->
»fút
, 
»ada_cÚŒÞ_»Ëa£
);

994 
	}
}

	@relocation.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/·gem­.h
>

21 
	~<lšux/wr™eback.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/rbŒ“.h
>

24 
	~<lšux/¦ab.h
>

25 
	~"ù»e.h
"

26 
	~"disk-io.h
"

27 
	~"Œª§ùiÚ.h
"

28 
	~"vÞumes.h
"

29 
	~"lockšg.h
"

30 
	~"bŒfs_šode.h
"

31 
	~"async-th»ad.h
"

32 
	~"ä“-¥aû-ÿche.h
"

33 
	~"šode-m­.h
"

34 
	~"qgroup.h
"

35 
	~"´št-Œ“.h
"

40 
	sŒ“_’Œy
 {

41 
rb_node
 
	mrb_node
;

42 
u64
 
	mby‹Ä
;

48 
	sback»f_node
 {

49 
rb_node
 
	mrb_node
;

50 
u64
 
	mby‹Ä
;

52 
u64
 
	mÃw_by‹Ä
;

54 
u64
 
	mowÃr
;

56 
li¡_h—d
 
	mli¡
;

58 
li¡_h—d
 
	muµ”
;

60 
li¡_h—d
 
	mlow”
;

62 
bŒfs_roÙ
 *
	mroÙ
;

64 
ex‹Á_bufãr
 *
	meb
;

66 
	mËv–
:8;

68 
	mcowÚly
:1;

70 
	mlowe¡
:1;

72 
	mlocked
:1;

74 
	m´oûs£d
:1;

76 
	mchecked
:1;

81 
	m³ndšg
:1;

86 
	md‘ached
:1;

92 
	sback»f_edge
 {

93 
li¡_h—d
 
	mli¡
[2];

94 
back»f_node
 *
	mnode
[2];

97 
	#LOWER
 0

	)

98 
	#UPPER
 1

	)

99 
	#RELOCATION_RESERVED_NODES
 256

	)

101 
	sback»f_ÿche
 {

103 
rb_roÙ
 
	mrb_roÙ
;

105 
back»f_node
 *
	m·th
[
BTRFS_MAX_LEVEL
];

111 
li¡_h—d
 
	m³ndšg
[
BTRFS_MAX_LEVEL
];

113 
li¡_h—d
 
	mËaves
;

115 
li¡_h—d
 
	mchªged
;

117 
li¡_h—d
 
	md‘ached
;

119 
u64
 
	mÏ¡_Œªs
;

121 
	mÄ_nodes
;

122 
	mÄ_edges
;

128 
	sm­pšg_node
 {

129 
rb_node
 
	mrb_node
;

130 
u64
 
	mby‹Ä
;

131 *
	md©a
;

134 
	sm­pšg_Œ“
 {

135 
rb_roÙ
 
	mrb_roÙ
;

136 
¥šlock_t
 
	mlock
;

142 
	sŒ“_block
 {

143 
rb_node
 
	mrb_node
;

144 
u64
 
	mby‹Ä
;

145 
bŒfs_key
 
	mkey
;

146 
	mËv–
:8;

147 
	mkey_»ady
:1;

150 
	#MAX_EXTENTS
 128

	)

152 
	sfže_ex‹Á_þu¡”
 {

153 
u64
 
	m¡¬t
;

154 
u64
 
	m’d
;

155 
u64
 
	mbound¬y
[
MAX_EXTENTS
];

156 
	mÄ
;

159 
	s»loc_cÚŒÞ
 {

161 
bŒfs_block_group_ÿche
 *
	mblock_group
;

163 
bŒfs_roÙ
 *
	mex‹Á_roÙ
;

165 
šode
 *
	md©a_šode
;

167 
bŒfs_block_rsv
 *
	mblock_rsv
;

169 
back»f_ÿche
 
	mback»f_ÿche
;

171 
fže_ex‹Á_þu¡”
 
	mþu¡”
;

173 
ex‹Á_io_Œ“
 
	m´oûs£d_blocks
;

175 
m­pšg_Œ“
 
	m»loc_roÙ_Œ“
;

177 
li¡_h—d
 
	m»loc_roÙs
;

179 
u64
 
	mm”gšg_rsv_size
;

181 
u64
 
	mnodes_»loÿ‹d
;

183 
u64
 
	m»£rved_by‹s
;

185 
u64
 
	m£¬ch_¡¬t
;

186 
u64
 
	mex‹Ás_found
;

188 
	m¡age
:8;

189 
	mü—‹_»loc_Œ“
:1;

190 
	mm”ge_»loc_Œ“
:1;

191 
	mfound_fže_ex‹Á
:1;

195 
	#MOVE_DATA_EXTENTS
 0

	)

196 
	#UPDATE_DATA_PTRS
 1

	)

198 
»move_back»f_node
(
back»f_ÿche
 *
ÿche
,

199 
back»f_node
 *
node
);

200 
__m¬k_block_´oûs£d
(
»loc_cÚŒÞ
 *
rc
,

201 
back»f_node
 *
node
);

203 
	$m­pšg_Œ“_š™
(
m­pšg_Œ“
 *
Œ“
)

205 
Œ“
->
rb_roÙ
 = 
RB_ROOT
;

206 
	`¥š_lock_š™
(&
Œ“
->
lock
);

207 
	}
}

209 
	$back»f_ÿche_š™
(
back»f_ÿche
 *
ÿche
)

211 
i
;

212 
ÿche
->
rb_roÙ
 = 
RB_ROOT
;

213 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

214 
	`INIT_LIST_HEAD
(&
ÿche
->
³ndšg
[
i
]);

215 
	`INIT_LIST_HEAD
(&
ÿche
->
chªged
);

216 
	`INIT_LIST_HEAD
(&
ÿche
->
d‘ached
);

217 
	`INIT_LIST_HEAD
(&
ÿche
->
Ëaves
);

218 
	}
}

220 
	$back»f_ÿche_þ—nup
(
back»f_ÿche
 *
ÿche
)

222 
back»f_node
 *
node
;

223 
i
;

225 !
	`li¡_em±y
(&
ÿche
->
d‘ached
)) {

226 
node
 = 
	`li¡_’Œy
(
ÿche
->
d‘ached
.
Ãxt
,

227 
back»f_node
, 
li¡
);

228 
	`»move_back»f_node
(
ÿche
, 
node
);

231 !
	`li¡_em±y
(&
ÿche
->
Ëaves
)) {

232 
node
 = 
	`li¡_’Œy
(
ÿche
->
Ëaves
.
Ãxt
,

233 
back»f_node
, 
low”
);

234 
	`»move_back»f_node
(
ÿche
, 
node
);

237 
ÿche
->
Ï¡_Œªs
 = 0;

239 
i
 = 0; i < 
BTRFS_MAX_LEVEL
; i++)

240 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
³ndšg
[
i
]));

241 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
chªged
));

242 
	`ASSERT
(
	`li¡_em±y
(&
ÿche
->
d‘ached
));

243 
	`ASSERT
(
	`RB_EMPTY_ROOT
(&
ÿche
->
rb_roÙ
));

244 
	`ASSERT
(!
ÿche
->
Ä_nodes
);

245 
	`ASSERT
(!
ÿche
->
Ä_edges
);

246 
	}
}

248 
back»f_node
 *
	$®loc_back»f_node
(
back»f_ÿche
 *
ÿche
)

250 
back»f_node
 *
node
;

252 
node
 = 
	`kz®loc
((*node), 
GFP_NOFS
);

253 ià(
node
) {

254 
	`INIT_LIST_HEAD
(&
node
->
li¡
);

255 
	`INIT_LIST_HEAD
(&
node
->
uµ”
);

256 
	`INIT_LIST_HEAD
(&
node
->
low”
);

257 
	`RB_CLEAR_NODE
(&
node
->
rb_node
);

258 
ÿche
->
Ä_nodes
++;

260  
node
;

261 
	}
}

263 
	$ä“_back»f_node
(
back»f_ÿche
 *
ÿche
,

264 
back»f_node
 *
node
)

266 ià(
node
) {

267 
ÿche
->
Ä_nodes
--;

268 
	`kä“
(
node
);

270 
	}
}

272 
back»f_edge
 *
	$®loc_back»f_edge
(
back»f_ÿche
 *
ÿche
)

274 
back»f_edge
 *
edge
;

276 
edge
 = 
	`kz®loc
((*edge), 
GFP_NOFS
);

277 ià(
edge
)

278 
ÿche
->
Ä_edges
++;

279  
edge
;

280 
	}
}

282 
	$ä“_back»f_edge
(
back»f_ÿche
 *
ÿche
,

283 
back»f_edge
 *
edge
)

285 ià(
edge
) {

286 
ÿche
->
Ä_edges
--;

287 
	`kä“
(
edge
);

289 
	}
}

291 
rb_node
 *
	$Œ“_š£¹
(
rb_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

292 
rb_node
 *
node
)

294 
rb_node
 **
p
 = &
roÙ
->rb_node;

295 
rb_node
 *
·»Á
 = 
NULL
;

296 
Œ“_’Œy
 *
’Œy
;

298 *
p
) {

299 
·»Á
 = *
p
;

300 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
Œ“_’Œy
, 
rb_node
);

302 ià(
by‹Ä
 < 
’Œy
->bytenr)

303 
p
 = &(*p)->
rb_Ëá
;

304 ià(
by‹Ä
 > 
’Œy
->bytenr)

305 
p
 = &(*p)->
rb_right
;

307  
·»Á
;

310 
	`rb_lšk_node
(
node
, 
·»Á
, 
p
);

311 
	`rb_š£¹_cÞÜ
(
node
, 
roÙ
);

312  
NULL
;

313 
	}
}

315 
rb_node
 *
	$Œ“_£¬ch
(
rb_roÙ
 *
roÙ
, 
u64
 
by‹Ä
)

317 
rb_node
 *
n
 = 
roÙ
->rb_node;

318 
Œ“_’Œy
 *
’Œy
;

320 
n
) {

321 
’Œy
 = 
	`rb_’Œy
(
n
, 
Œ“_’Œy
, 
rb_node
);

323 ià(
by‹Ä
 < 
’Œy
->bytenr)

324 
n
 =‚->
rb_Ëá
;

325 ià(
by‹Ä
 > 
’Œy
->bytenr)

326 
n
 =‚->
rb_right
;

328  
n
;

330  
NULL
;

331 
	}
}

333 
	$back»f_Œ“_·nic
(
rb_node
 *rb_node, 
”ºo
, 
u64
 
by‹Ä
)

336 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

337 
back»f_node
 *
bnode
 = 
	`rb_’Œy
(
rb_node
, backref_node,

338 
rb_node
);

339 ià(
bnode
->
roÙ
)

340 
fs_šfo
 = 
bnode
->
roÙ
->fs_info;

341 
	`bŒfs_·nic
(
fs_šfo
, 
”ºo
,

343 
by‹Ä
);

344 
	}
}

349 
back»f_node
 *
	$w®k_up_back»f
(
back»f_node
 *
node
,

350 
back»f_edge
 *
edges
[],

351 *
šdex
)

353 
back»f_edge
 *
edge
;

354 
idx
 = *
šdex
;

356 !
	`li¡_em±y
(&
node
->
uµ”
)) {

357 
edge
 = 
	`li¡_’Œy
(
node
->
uµ”
.
Ãxt
,

358 
back»f_edge
, 
li¡
[
LOWER
]);

359 
edges
[
idx
++] = 
edge
;

360 
node
 = 
edge
->node[
UPPER
];

362 
	`BUG_ON
(
node
->
d‘ached
);

363 *
šdex
 = 
idx
;

364  
node
;

365 
	}
}

370 
back»f_node
 *
	$w®k_down_back»f
(
back»f_edge
 *
edges
[],

371 *
šdex
)

373 
back»f_edge
 *
edge
;

374 
back»f_node
 *
low”
;

375 
idx
 = *
šdex
;

377 
idx
 > 0) {

378 
edge
 = 
edges
[
idx
 - 1];

379 
low”
 = 
edge
->
node
[
LOWER
];

380 ià(
	`li¡_is_Ï¡
(&
edge
->
li¡
[
LOWER
], &
low”
->
uµ”
)) {

381 
idx
--;

384 
edge
 = 
	`li¡_’Œy
Ódge->
li¡
[
LOWER
].
Ãxt
,

385 
back»f_edge
, 
li¡
[
LOWER
]);

386 
edges
[
idx
 - 1] = 
edge
;

387 *
šdex
 = 
idx
;

388  
edge
->
node
[
UPPER
];

390 *
šdex
 = 0;

391  
NULL
;

392 
	}
}

394 
	$uÆock_node_bufãr
(
back»f_node
 *
node
)

396 ià(
node
->
locked
) {

397 
	`bŒfs_Œ“_uÆock
(
node
->
eb
);

398 
node
->
locked
 = 0;

400 
	}
}

402 
	$drÝ_node_bufãr
(
back»f_node
 *
node
)

404 ià(
node
->
eb
) {

405 
	`uÆock_node_bufãr
(
node
);

406 
	`ä“_ex‹Á_bufãr
(
node
->
eb
);

407 
node
->
eb
 = 
NULL
;

409 
	}
}

411 
	$drÝ_back»f_node
(
back»f_ÿche
 *
Œ“
,

412 
back»f_node
 *
node
)

414 
	`BUG_ON
(!
	`li¡_em±y
(&
node
->
uµ”
));

416 
	`drÝ_node_bufãr
(
node
);

417 
	`li¡_d–
(&
node
->
li¡
);

418 
	`li¡_d–
(&
node
->
low”
);

419 ià(!
	`RB_EMPTY_NODE
(&
node
->
rb_node
))

420 
	`rb_”a£
(&
node
->
rb_node
, &
Œ“
->
rb_roÙ
);

421 
	`ä“_back»f_node
(
Œ“
, 
node
);

422 
	}
}

427 
	$»move_back»f_node
(
back»f_ÿche
 *
ÿche
,

428 
back»f_node
 *
node
)

430 
back»f_node
 *
uµ”
;

431 
back»f_edge
 *
edge
;

433 ià(!
node
)

436 
	`BUG_ON
(!
node
->
lowe¡
 && !node->
d‘ached
);

437 !
	`li¡_em±y
(&
node
->
uµ”
)) {

438 
edge
 = 
	`li¡_’Œy
(
node
->
uµ”
.
Ãxt
, 
back»f_edge
,

439 
li¡
[
LOWER
]);

440 
uµ”
 = 
edge
->
node
[
UPPER
];

441 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

442 
	`li¡_d–
(&
edge
->
li¡
[
UPPER
]);

443 
	`ä“_back»f_edge
(
ÿche
, 
edge
);

445 ià(
	`RB_EMPTY_NODE
(&
uµ”
->
rb_node
)) {

446 
	`BUG_ON
(!
	`li¡_em±y
(&
node
->
uµ”
));

447 
	`drÝ_back»f_node
(
ÿche
, 
node
);

448 
node
 = 
uµ”
;

449 
node
->
lowe¡
 = 1;

456 ià(
	`li¡_em±y
(&
uµ”
->
low”
)) {

457 
	`li¡_add_ž
(&
uµ”
->
low”
, &
ÿche
->
Ëaves
);

458 
uµ”
->
lowe¡
 = 1;

462 
	`drÝ_back»f_node
(
ÿche
, 
node
);

463 
	}
}

465 
	$upd©e_back»f_node
(
back»f_ÿche
 *
ÿche
,

466 
back»f_node
 *
node
, 
u64
 
by‹Ä
)

468 
rb_node
 *rb_node;

469 
	`rb_”a£
(&
node
->
rb_node
, &
ÿche
->
rb_roÙ
);

470 
node
->
by‹Ä
 = bytenr;

471 
rb_node
 = 
	`Œ“_š£¹
(&
ÿche
->
rb_roÙ
, 
node
->
by‹Ä
, &node->rb_node);

472 ià(
rb_node
)

473 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
, 
by‹Ä
);

474 
	}
}

479 
	$upd©e_back»f_ÿche
(
bŒfs_Œªs_hªdË
 *
Œªs
,

480 
back»f_ÿche
 *
ÿche
)

482 
back»f_node
 *
node
;

483 
Ëv–
 = 0;

485 ià(
ÿche
->
Ï¡_Œªs
 == 0) {

486 
ÿche
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

490 ià(
ÿche
->
Ï¡_Œªs
 =ð
Œªs
->
Œªsid
)

498 !
	`li¡_em±y
(&
ÿche
->
d‘ached
)) {

499 
node
 = 
	`li¡_’Œy
(
ÿche
->
d‘ached
.
Ãxt
,

500 
back»f_node
, 
li¡
);

501 
	`»move_back»f_node
(
ÿche
, 
node
);

504 !
	`li¡_em±y
(&
ÿche
->
chªged
)) {

505 
node
 = 
	`li¡_’Œy
(
ÿche
->
chªged
.
Ãxt
,

506 
back»f_node
, 
li¡
);

507 
	`li¡_d–_š™
(&
node
->
li¡
);

508 
	`BUG_ON
(
node
->
³ndšg
);

509 
	`upd©e_back»f_node
(
ÿche
, 
node
,‚ode->
Ãw_by‹Ä
);

516 
Ëv–
 = 0;†ev– < 
BTRFS_MAX_LEVEL
;†evel++) {

517 
	`li¡_fÜ_—ch_’Œy
(
node
, &
ÿche
->
³ndšg
[
Ëv–
], 
li¡
) {

518 
	`BUG_ON
(!
node
->
³ndšg
);

519 ià(
node
->
by‹Ä
 =ðnode->
Ãw_by‹Ä
)

521 
	`upd©e_back»f_node
(
ÿche
, 
node
,‚ode->
Ãw_by‹Ä
);

525 
ÿche
->
Ï¡_Œªs
 = 0;

527 
	}
}

530 
	$should_ignÜe_roÙ
(
bŒfs_roÙ
 *
roÙ
)

532 
bŒfs_roÙ
 *
»loc_roÙ
;

534 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

537 
»loc_roÙ
 = 
roÙ
->reloc_root;

538 ià(!
»loc_roÙ
)

541 ià(
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
»loc_roÙ
->
roÙ_™em
) ==

542 
roÙ
->
fs_šfo
->
ruÂšg_Œª§ùiÚ
->
Œªsid
 - 1)

551 
	}
}

555 
bŒfs_roÙ
 *
	$fšd_»loc_roÙ
(
»loc_cÚŒÞ
 *
rc
,

556 
u64
 
by‹Ä
)

558 
rb_node
 *rb_node;

559 
m­pšg_node
 *
node
;

560 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

562 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

563 
rb_node
 = 
	`Œ“_£¬ch
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
, 
by‹Ä
);

564 ià(
rb_node
) {

565 
node
 = 
	`rb_’Œy
(
rb_node
, 
m­pšg_node
,„b_node);

566 
roÙ
 = (
bŒfs_roÙ
 *)
node
->
d©a
;

568 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

569  
roÙ
;

570 
	}
}

572 
	$is_cowÚly_roÙ
(
u64
 
roÙ_objeùid
)

574 ià(
roÙ_objeùid
 =ð
BTRFS_ROOT_TREE_OBJECTID
 ||

575 
roÙ_objeùid
 =ð
BTRFS_EXTENT_TREE_OBJECTID
 ||

576 
roÙ_objeùid
 =ð
BTRFS_CHUNK_TREE_OBJECTID
 ||

577 
roÙ_objeùid
 =ð
BTRFS_DEV_TREE_OBJECTID
 ||

578 
roÙ_objeùid
 =ð
BTRFS_TREE_LOG_OBJECTID
 ||

579 
roÙ_objeùid
 =ð
BTRFS_CSUM_TREE_OBJECTID
 ||

580 
roÙ_objeùid
 =ð
BTRFS_UUID_TREE_OBJECTID
 ||

581 
roÙ_objeùid
 =ð
BTRFS_QUOTA_TREE_OBJECTID
 ||

582 
roÙ_objeùid
 =ð
BTRFS_FREE_SPACE_TREE_OBJECTID
)

585 
	}
}

587 
bŒfs_roÙ
 *
	$»ad_fs_roÙ
(
bŒfs_fs_šfo
 *
fs_šfo
,

588 
u64
 
roÙ_objeùid
)

590 
bŒfs_key
 
key
;

592 
key
.
objeùid
 = 
roÙ_objeùid
;

593 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

594 ià(
	`is_cowÚly_roÙ
(
roÙ_objeùid
))

595 
key
.
off£t
 = 0;

597 
key
.
off£t
 = (
u64
)-1;

599  
	`bŒfs_g‘_fs_roÙ
(
fs_šfo
, &
key
, 
çl£
);

600 
	}
}

602 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


603 
nošlše_fÜ_¡ack


604 
bŒfs_roÙ
 *
	$fšd_Œ“_roÙ
(
»loc_cÚŒÞ
 *
rc
,

605 
ex‹Á_bufãr
 *
Ëaf
,

606 
bŒfs_ex‹Á_»f_v0
 *
»f0
)

608 
bŒfs_roÙ
 *
roÙ
;

609 
u64
 
roÙ_objeùid
 = 
	`bŒfs_»f_roÙ_v0
(
Ëaf
, 
»f0
);

610 
u64
 
g’”©iÚ
 = 
	`bŒfs_»f_g’”©iÚ_v0
(
Ëaf
, 
»f0
);

612 
	`BUG_ON
(
roÙ_objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
);

614 
roÙ
 = 
	`»ad_fs_roÙ
(
rc
->
ex‹Á_roÙ
->
fs_šfo
, 
roÙ_objeùid
);

615 
	`BUG_ON
(
	`IS_ERR
(
roÙ
));

617 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

618 
g’”©iÚ
 !ð
	`bŒfs_roÙ_g’”©iÚ
(&
roÙ
->
roÙ_™em
))

619  
NULL
;

621  
roÙ
;

622 
	}
}

625 
nošlše_fÜ_¡ack


626 
	$fšd_šlše_back»f
(
ex‹Á_bufãr
 *
Ëaf
, 
¦Ù
,

627 *
±r
, *
’d
)

629 
bŒfs_key
 
key
;

630 
bŒfs_ex‹Á_™em
 *
ei
;

631 
bŒfs_Œ“_block_šfo
 *
bi
;

632 
u32
 
™em_size
;

634 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

636 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

637 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


638 ià(
™em_size
 < (*
ei
)) {

639 
	`WARN_ON
(
™em_size
 !ð(
bŒfs_ex‹Á_™em_v0
));

643 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_ex‹Á_™em
);

644 
	`WARN_ON
(!(
	`bŒfs_ex‹Á_æags
(
Ëaf
, 
ei
) &

645 
BTRFS_EXTENT_FLAG_TREE_BLOCK
));

647 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

648 
™em_size
 <ð(*
ei
è+ (*
bi
)) {

649 
	`WARN_ON
(
™em_size
 < (*
ei
è+ (*
bi
));

652 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
 &&

653 
™em_size
 <ð(*
ei
)) {

654 
	`WARN_ON
(
™em_size
 < (*
ei
));

658 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
) {

659 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

660 *
±r
 = ()(
bi
 + 1);

662 *
±r
 = ()(
ei
 + 1);

664 *
’d
 = ()
ei
 + 
™em_size
;

666 
	}
}

682 
nošlše_fÜ_¡ack


683 
back»f_node
 *
	$bužd_back»f_Œ“
(
»loc_cÚŒÞ
 *
rc
,

684 
bŒfs_key
 *
node_key
,

685 
Ëv–
, 
u64
 
by‹Ä
)

687 
back»f_ÿche
 *
ÿche
 = &
rc
->backref_cache;

688 
bŒfs_·th
 *
·th1
;

689 
bŒfs_·th
 *
·th2
;

690 
ex‹Á_bufãr
 *
eb
;

691 
bŒfs_roÙ
 *
roÙ
;

692 
back»f_node
 *
cur
;

693 
back»f_node
 *
uµ”
;

694 
back»f_node
 *
low”
;

695 
back»f_node
 *
node
 = 
NULL
;

696 
back»f_node
 *
exi¡
 = 
NULL
;

697 
back»f_edge
 *
edge
;

698 
rb_node
 *rb_node;

699 
bŒfs_key
 
key
;

700 
’d
;

701 
±r
;

702 
	`LIST_HEAD
(
li¡
);

703 
	`LIST_HEAD
(
u£Ëss
);

704 
cowÚly
;

705 
»t
;

706 
”r
 = 0;

707 
boÞ
 
Ãed_check
 = 
Œue
;

709 
·th1
 = 
	`bŒfs_®loc_·th
();

710 
·th2
 = 
	`bŒfs_®loc_·th
();

711 ià(!
·th1
 || !
·th2
) {

712 
”r
 = -
ENOMEM
;

713 
out
;

715 
·th1
->
»ada
 = 
READA_FORWARD
;

716 
·th2
->
»ada
 = 
READA_FORWARD
;

718 
node
 = 
	`®loc_back»f_node
(
ÿche
);

719 ià(!
node
) {

720 
”r
 = -
ENOMEM
;

721 
out
;

724 
node
->
by‹Ä
 = bytenr;

725 
node
->
Ëv–
 =†evel;

726 
node
->
lowe¡
 = 1;

727 
cur
 = 
node
;

728 
agaš
:

729 
’d
 = 0;

730 
±r
 = 0;

731 
key
.
objeùid
 = 
cur
->
by‹Ä
;

732 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

733 
key
.
off£t
 = (
u64
)-1;

735 
·th1
->
£¬ch_comm™_roÙ
 = 1;

736 
·th1
->
sk_lockšg
 = 1;

737 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
rc
->
ex‹Á_roÙ
, &
key
, 
·th1
,

739 ià(
»t
 < 0) {

740 
”r
 = 
»t
;

741 
out
;

743 
	`ASSERT
(
»t
);

744 
	`ASSERT
(
·th1
->
¦Ùs
[0]);

746 
·th1
->
¦Ùs
[0]--;

748 
	`WARN_ON
(
cur
->
checked
);

749 ià(!
	`li¡_em±y
(&
cur
->
uµ”
)) {

754 
	`ASSERT
(
	`li¡_is_sšguÏr
(&
cur
->
uµ”
));

755 
edge
 = 
	`li¡_’Œy
(
cur
->
uµ”
.
Ãxt
, 
back»f_edge
,

756 
li¡
[
LOWER
]);

757 
	`ASSERT
(
	`li¡_em±y
(&
edge
->
li¡
[
UPPER
]));

758 
exi¡
 = 
edge
->
node
[
UPPER
];

763 ià(!
exi¡
->
checked
)

764 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &list);

766 
exi¡
 = 
NULL
;

770 
	`cÚd_»sched
();

771 
eb
 = 
·th1
->
nodes
[0];

773 ià(
±r
 >ð
’d
) {

774 ià(
·th1
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

775 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
rc
->
ex‹Á_roÙ
, 
·th1
);

776 ià(
»t
 < 0) {

777 
”r
 = 
»t
;

778 
out
;

780 ià(
»t
 > 0)

782 
eb
 = 
·th1
->
nodes
[0];

785 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
·th1
->
¦Ùs
[0]);

786 ià(
key
.
objeùid
 !ð
cur
->
by‹Ä
) {

787 
	`WARN_ON
(
exi¡
);

791 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 ||

792 
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
) {

793 
»t
 = 
	`fšd_šlše_back»f
(
eb
, 
·th1
->
¦Ùs
[0],

794 &
±r
, &
’d
);

795 ià(
»t
)

796 
Ãxt
;

800 ià(
±r
 < 
’d
) {

802 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

803 
ty³
;

804 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

805 
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
,

806 
BTRFS_REF_TYPE_BLOCK
);

807 ià(
ty³
 =ð
BTRFS_REF_TYPE_INVALID
) {

808 
”r
 = -
EINVAL
;

809 
out
;

811 
key
.
ty³
 =ype;

812 
key
.
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

814 
	`WARN_ON
(
key
.
ty³
 !ð
BTRFS_TREE_BLOCK_REF_KEY
 &&

815 
key
.
ty³
 !ð
BTRFS_SHARED_BLOCK_REF_KEY
);

818 ià(
exi¡
 &&

819 ((
key
.
ty³
 =ð
BTRFS_TREE_BLOCK_REF_KEY
 &&

820 
exi¡
->
owÃr
 =ð
key
.
off£t
) ||

821 (
key
.
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
 &&

822 
exi¡
->
by‹Ä
 =ð
key
.
off£t
))) {

823 
exi¡
 = 
NULL
;

824 
Ãxt
;

827 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


828 ià(
key
.
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
 ||

829 
key
.
ty³
 =ð
BTRFS_EXTENT_REF_V0_KEY
) {

830 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_REF_V0_KEY
) {

831 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

832 
»f0
 = 
	`bŒfs_™em_±r
(
eb
, 
·th1
->
¦Ùs
[0],

833 
bŒfs_ex‹Á_»f_v0
);

834 ià(
key
.
objeùid
 =ðkey.
off£t
) {

835 
roÙ
 = 
	`fšd_Œ“_roÙ
(
rc
, 
eb
, 
»f0
);

836 ià(
roÙ
 && !
	`should_ignÜe_roÙ
(root))

837 
cur
->
roÙ
 =„oot;

839 
	`li¡_add
(&
cur
->
li¡
, &
u£Ëss
);

842 ià(
	`is_cowÚly_roÙ
(
	`bŒfs_»f_roÙ_v0
(
eb
,

843 
»f0
)))

844 
cur
->
cowÚly
 = 1;

847 
	`ASSERT
(
key
.
ty³
 !ð
BTRFS_EXTENT_REF_V0_KEY
);

848 ià(
key
.
ty³
 =ð
BTRFS_SHARED_BLOCK_REF_KEY
) {

850 ià(
key
.
objeùid
 =ðkey.
off£t
) {

855 
roÙ
 = 
	`fšd_»loc_roÙ
(
rc
, 
cur
->
by‹Ä
);

856 
	`ASSERT
(
roÙ
);

857 
cur
->
roÙ
 =„oot;

861 
edge
 = 
	`®loc_back»f_edge
(
ÿche
);

862 ià(!
edge
) {

863 
”r
 = -
ENOMEM
;

864 
out
;

866 
rb_node
 = 
	`Œ“_£¬ch
(&
ÿche
->
rb_roÙ
, 
key
.
off£t
);

867 ià(!
rb_node
) {

868 
uµ”
 = 
	`®loc_back»f_node
(
ÿche
);

869 ià(!
uµ”
) {

870 
	`ä“_back»f_edge
(
ÿche
, 
edge
);

871 
”r
 = -
ENOMEM
;

872 
out
;

874 
uµ”
->
by‹Ä
 = 
key
.
off£t
;

875 
uµ”
->
Ëv–
 = 
cur
->level + 1;

880 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &list);

882 
uµ”
 = 
	`rb_’Œy
(
rb_node
, 
back»f_node
,

883 
rb_node
);

884 
	`ASSERT
(
uµ”
->
checked
);

885 
	`INIT_LIST_HEAD
(&
edge
->
li¡
[
UPPER
]);

887 
	`li¡_add_ž
(&
edge
->
li¡
[
LOWER
], &
cur
->
uµ”
);

888 
edge
->
node
[
LOWER
] = 
cur
;

889 
edge
->
node
[
UPPER
] = 
uµ”
;

891 
Ãxt
;

892 } ià(
key
.
ty³
 !ð
BTRFS_TREE_BLOCK_REF_KEY
) {

893 
Ãxt
;

897 
roÙ
 = 
	`»ad_fs_roÙ
(
rc
->
ex‹Á_roÙ
->
fs_šfo
, 
key
.
off£t
);

898 ià(
	`IS_ERR
(
roÙ
)) {

899 
”r
 = 
	`PTR_ERR
(
roÙ
);

900 
out
;

903 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

904 
cur
->
cowÚly
 = 1;

906 ià(
	`bŒfs_roÙ_Ëv–
(&
roÙ
->
roÙ_™em
è=ð
cur
->
Ëv–
) {

908 
	`ASSERT
(
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
) ==

909 
cur
->
by‹Ä
);

910 ià(
	`should_ignÜe_roÙ
(
roÙ
))

911 
	`li¡_add
(&
cur
->
li¡
, &
u£Ëss
);

913 
cur
->
roÙ
 =„oot;

917 
Ëv–
 = 
cur
->level + 1;

923 
·th2
->
£¬ch_comm™_roÙ
 = 1;

924 
·th2
->
sk_lockšg
 = 1;

925 
·th2
->
lowe¡_Ëv–
 = 
Ëv–
;

926 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
node_key
, 
·th2
, 0, 0);

927 
·th2
->
lowe¡_Ëv–
 = 0;

928 ià(
»t
 < 0) {

929 
”r
 = 
»t
;

930 
out
;

932 ià(
»t
 > 0 && 
·th2
->
¦Ùs
[
Ëv–
] > 0)

933 
·th2
->
¦Ùs
[
Ëv–
]--;

935 
eb
 = 
·th2
->
nodes
[
Ëv–
];

936 ià(
	`bŒfs_node_block±r
(
eb
, 
·th2
->
¦Ùs
[
Ëv–
]) !=

937 
cur
->
by‹Ä
) {

938 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

940 
cur
->
by‹Ä
, 
Ëv–
 - 1, 
roÙ
->
objeùid
,

941 
node_key
->
objeùid
,‚ode_key->
ty³
,

942 
node_key
->
off£t
);

943 
”r
 = -
ENOENT
;

944 
out
;

946 
low”
 = 
cur
;

947 
Ãed_check
 = 
Œue
;

948 ; 
Ëv–
 < 
BTRFS_MAX_LEVEL
;†evel++) {

949 ià(!
·th2
->
nodes
[
Ëv–
]) {

950 
	`ASSERT
(
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
) ==

951 
low”
->
by‹Ä
);

952 ià(
	`should_ignÜe_roÙ
(
roÙ
))

953 
	`li¡_add
(&
low”
->
li¡
, &
u£Ëss
);

955 
low”
->
roÙ
 =„oot;

959 
edge
 = 
	`®loc_back»f_edge
(
ÿche
);

960 ià(!
edge
) {

961 
”r
 = -
ENOMEM
;

962 
out
;

965 
eb
 = 
·th2
->
nodes
[
Ëv–
];

966 
rb_node
 = 
	`Œ“_£¬ch
(&
ÿche
->
rb_roÙ
, 
eb
->
¡¬t
);

967 ià(!
rb_node
) {

968 
uµ”
 = 
	`®loc_back»f_node
(
ÿche
);

969 ià(!
uµ”
) {

970 
	`ä“_back»f_edge
(
ÿche
, 
edge
);

971 
”r
 = -
ENOMEM
;

972 
out
;

974 
uµ”
->
by‹Ä
 = 
eb
->
¡¬t
;

975 
uµ”
->
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb
);

976 
uµ”
->
Ëv–
 = 
low”
->level + 1;

977 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
,

978 &
roÙ
->
¡©e
))

979 
uµ”
->
cowÚly
 = 1;

985 ià(
	`bŒfs_block_ÿn_be_sh¬ed
(
roÙ
, 
eb
))

986 
uµ”
->
checked
 = 0;

988 
uµ”
->
checked
 = 1;

996 ià(!
uµ”
->
checked
 && 
Ãed_check
) {

997 
Ãed_check
 = 
çl£
;

998 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
],

999 &
li¡
);

1001 ià(
uµ”
->
checked
)

1002 
Ãed_check
 = 
Œue
;

1003 
	`INIT_LIST_HEAD
(&
edge
->
li¡
[
UPPER
]);

1006 
uµ”
 = 
	`rb_’Œy
(
rb_node
, 
back»f_node
,

1007 
rb_node
);

1008 
	`ASSERT
(
uµ”
->
checked
);

1009 
	`INIT_LIST_HEAD
(&
edge
->
li¡
[
UPPER
]);

1010 ià(!
uµ”
->
owÃr
)

1011 
uµ”
->
owÃr
 = 
	`bŒfs_h—d”_owÃr
(
eb
);

1013 
	`li¡_add_ž
(&
edge
->
li¡
[
LOWER
], &
low”
->
uµ”
);

1014 
edge
->
node
[
LOWER
] = 
low”
;

1015 
edge
->
node
[
UPPER
] = 
uµ”
;

1017 ià(
rb_node
)

1019 
low”
 = 
uµ”
;

1020 
uµ”
 = 
NULL
;

1022 
	`bŒfs_»Ëa£_·th
(
·th2
);

1023 
Ãxt
:

1024 ià(
±r
 < 
’d
) {

1025 
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(
key
.
ty³
);

1026 ià(
±r
 >ð
’d
) {

1027 
	`WARN_ON
(
±r
 > 
’d
);

1028 
±r
 = 0;

1029 
’d
 = 0;

1032 ià(
±r
 >ð
’d
)

1033 
·th1
->
¦Ùs
[0]++;

1035 
	`bŒfs_»Ëa£_·th
(
·th1
);

1037 
cur
->
checked
 = 1;

1038 
	`WARN_ON
(
exi¡
);

1041 ià(!
	`li¡_em±y
(&
li¡
)) {

1042 
edge
 = 
	`li¡_’Œy
(
li¡
.
Ãxt
, 
back»f_edge
,†i¡[
UPPER
]);

1043 
	`li¡_d–_š™
(&
edge
->
li¡
[
UPPER
]);

1044 
cur
 = 
edge
->
node
[
UPPER
];

1045 
agaš
;

1052 
	`ASSERT
(
node
->
checked
);

1053 
cowÚly
 = 
node
->cowonly;

1054 ià(!
cowÚly
) {

1055 
rb_node
 = 
	`Œ“_š£¹
(&
ÿche
->
rb_roÙ
, 
node
->
by‹Ä
,

1056 &
node
->
rb_node
);

1057 ià(
rb_node
)

1058 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
, 
node
->
by‹Ä
);

1059 
	`li¡_add_ž
(&
node
->
low”
, &
ÿche
->
Ëaves
);

1062 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
node
->
uµ”
, 
li¡
[
LOWER
])

1063 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &list);

1065 !
	`li¡_em±y
(&
li¡
)) {

1066 
edge
 = 
	`li¡_’Œy
(
li¡
.
Ãxt
, 
back»f_edge
,†i¡[
UPPER
]);

1067 
	`li¡_d–_š™
(&
edge
->
li¡
[
UPPER
]);

1068 
uµ”
 = 
edge
->
node
[
UPPER
];

1069 ià(
uµ”
->
d‘ached
) {

1070 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

1071 
low”
 = 
edge
->
node
[
LOWER
];

1072 
	`ä“_back»f_edge
(
ÿche
, 
edge
);

1073 ià(
	`li¡_em±y
(&
low”
->
uµ”
))

1074 
	`li¡_add
(&
low”
->
li¡
, &
u£Ëss
);

1078 ià(!
	`RB_EMPTY_NODE
(&
uµ”
->
rb_node
)) {

1079 ià(
uµ”
->
lowe¡
) {

1080 
	`li¡_d–_š™
(&
uµ”
->
low”
);

1081 
uµ”
->
lowe¡
 = 0;

1084 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &
uµ”
->
low”
);

1088 ià(!
uµ”
->
checked
) {

1093 
	`ASSERT
(0);

1094 
”r
 = -
EINVAL
;

1095 
out
;

1097 ià(
cowÚly
 !ð
uµ”
->cowonly) {

1098 
	`ASSERT
(0);

1099 
”r
 = -
EINVAL
;

1100 
out
;

1103 ià(!
cowÚly
) {

1104 
rb_node
 = 
	`Œ“_š£¹
(&
ÿche
->
rb_roÙ
, 
uµ”
->
by‹Ä
,

1105 &
uµ”
->
rb_node
);

1106 ià(
rb_node
)

1107 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
,

1108 
uµ”
->
by‹Ä
);

1111 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &
uµ”
->
low”
);

1113 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
uµ”
->uµ”, 
li¡
[
LOWER
])

1114 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &list);

1122 !
	`li¡_em±y
(&
u£Ëss
)) {

1123 
uµ”
 = 
	`li¡_’Œy
(
u£Ëss
.
Ãxt
, 
back»f_node
, 
li¡
);

1124 
	`li¡_d–_š™
(&
uµ”
->
li¡
);

1125 
	`ASSERT
(
	`li¡_em±y
(&
uµ”
->upper));

1126 ià(
uµ”
 =ð
node
)

1127 
node
 = 
NULL
;

1128 ià(
uµ”
->
lowe¡
) {

1129 
	`li¡_d–_š™
(&
uµ”
->
low”
);

1130 
uµ”
->
lowe¡
 = 0;

1132 !
	`li¡_em±y
(&
uµ”
->
low”
)) {

1133 
edge
 = 
	`li¡_’Œy
(
uµ”
->
low”
.
Ãxt
,

1134 
back»f_edge
, 
li¡
[
UPPER
]);

1135 
	`li¡_d–
(&
edge
->
li¡
[
UPPER
]);

1136 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

1137 
low”
 = 
edge
->
node
[
LOWER
];

1138 
	`ä“_back»f_edge
(
ÿche
, 
edge
);

1140 ià(
	`li¡_em±y
(&
low”
->
uµ”
))

1141 
	`li¡_add
(&
low”
->
li¡
, &
u£Ëss
);

1143 
	`__m¬k_block_´oûs£d
(
rc
, 
uµ”
);

1144 ià(
uµ”
->
Ëv–
 > 0) {

1145 
	`li¡_add
(&
uµ”
->
li¡
, &
ÿche
->
d‘ached
);

1146 
uµ”
->
d‘ached
 = 1;

1148 
	`rb_”a£
(&
uµ”
->
rb_node
, &
ÿche
->
rb_roÙ
);

1149 
	`ä“_back»f_node
(
ÿche
, 
uµ”
);

1152 
out
:

1153 
	`bŒfs_ä“_·th
(
·th1
);

1154 
	`bŒfs_ä“_·th
(
·th2
);

1155 ià(
”r
) {

1156 !
	`li¡_em±y
(&
u£Ëss
)) {

1157 
low”
 = 
	`li¡_’Œy
(
u£Ëss
.
Ãxt
,

1158 
back»f_node
, 
li¡
);

1159 
	`li¡_d–_š™
(&
low”
->
li¡
);

1161 !
	`li¡_em±y
(&
li¡
)) {

1162 
edge
 = 
	`li¡_fœ¡_’Œy
(&
li¡
, 
back»f_edge
,

1163 
li¡
[
UPPER
]);

1164 
	`li¡_d–
(&
edge
->
li¡
[
UPPER
]);

1165 
	`li¡_d–
(&
edge
->
li¡
[
LOWER
]);

1166 
low”
 = 
edge
->
node
[
LOWER
];

1167 
uµ”
 = 
edge
->
node
[
UPPER
];

1168 
	`ä“_back»f_edge
(
ÿche
, 
edge
);

1174 ià(
	`li¡_em±y
(&
low”
->
uµ”
) &&

1175 
	`RB_EMPTY_NODE
(&
low”
->
rb_node
))

1176 
	`li¡_add
(&
low”
->
li¡
, &
u£Ëss
);

1178 ià(!
	`RB_EMPTY_NODE
(&
uµ”
->
rb_node
))

1182 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
uµ”
->uµ”, 
li¡
[
LOWER
])

1183 
	`li¡_add_ž
(&
edge
->
li¡
[
UPPER
], &list);

1184 ià(
	`li¡_em±y
(&
uµ”
->upper))

1185 
	`li¡_add
(&
uµ”
->
li¡
, &
u£Ëss
);

1188 !
	`li¡_em±y
(&
u£Ëss
)) {

1189 
low”
 = 
	`li¡_’Œy
(
u£Ëss
.
Ãxt
,

1190 
back»f_node
, 
li¡
);

1191 
	`li¡_d–_š™
(&
low”
->
li¡
);

1192 ià(
low”
 =ð
node
)

1193 
node
 = 
NULL
;

1194 
	`ä“_back»f_node
(
ÿche
, 
low”
);

1197 
	`ä“_back»f_node
(
ÿche
, 
node
);

1198  
	`ERR_PTR
(
”r
);

1200 
	`ASSERT
(!
node
 || !node->
d‘ached
);

1201  
node
;

1202 
	}
}

1209 
	$þÚe_back»f_node
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1210 
»loc_cÚŒÞ
 *
rc
,

1211 
bŒfs_roÙ
 *
¤c
,

1212 
bŒfs_roÙ
 *
de¡
)

1214 
bŒfs_roÙ
 *
»loc_roÙ
 = 
¤c
->reloc_root;

1215 
back»f_ÿche
 *
ÿche
 = &
rc
->backref_cache;

1216 
back»f_node
 *
node
 = 
NULL
;

1217 
back»f_node
 *
Ãw_node
;

1218 
back»f_edge
 *
edge
;

1219 
back»f_edge
 *
Ãw_edge
;

1220 
rb_node
 *rb_node;

1222 ià(
ÿche
->
Ï¡_Œªs
 > 0)

1223 
	`upd©e_back»f_ÿche
(
Œªs
, 
ÿche
);

1225 
rb_node
 = 
	`Œ“_£¬ch
(&
ÿche
->
rb_roÙ
, 
¤c
->
comm™_roÙ
->
¡¬t
);

1226 ià(
rb_node
) {

1227 
node
 = 
	`rb_’Œy
(
rb_node
, 
back»f_node
,„b_node);

1228 ià(
node
->
d‘ached
)

1229 
node
 = 
NULL
;

1231 
	`BUG_ON
(
node
->
Ãw_by‹Ä
 !ð
»loc_roÙ
->node->
¡¬t
);

1234 ià(!
node
) {

1235 
rb_node
 = 
	`Œ“_£¬ch
(&
ÿche
->
rb_roÙ
,

1236 
»loc_roÙ
->
comm™_roÙ
->
¡¬t
);

1237 ià(
rb_node
) {

1238 
node
 = 
	`rb_’Œy
(
rb_node
, 
back»f_node
,

1239 
rb_node
);

1240 
	`BUG_ON
(
node
->
d‘ached
);

1244 ià(!
node
)

1247 
Ãw_node
 = 
	`®loc_back»f_node
(
ÿche
);

1248 ià(!
Ãw_node
)

1249  -
ENOMEM
;

1251 
Ãw_node
->
by‹Ä
 = 
de¡
->
node
->
¡¬t
;

1252 
Ãw_node
->
Ëv–
 = 
node
->level;

1253 
Ãw_node
->
lowe¡
 = 
node
->lowest;

1254 
Ãw_node
->
checked
 = 1;

1255 
Ãw_node
->
roÙ
 = 
de¡
;

1257 ià(!
node
->
lowe¡
) {

1258 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
node
->
low”
, 
li¡
[
UPPER
]) {

1259 
Ãw_edge
 = 
	`®loc_back»f_edge
(
ÿche
);

1260 ià(!
Ãw_edge
)

1261 
çž
;

1263 
Ãw_edge
->
node
[
UPPER
] = 
Ãw_node
;

1264 
Ãw_edge
->
node
[
LOWER
] = 
edge
->node[LOWER];

1265 
	`li¡_add_ž
(&
Ãw_edge
->
li¡
[
UPPER
],

1266 &
Ãw_node
->
low”
);

1269 
	`li¡_add_ž
(&
Ãw_node
->
low”
, &
ÿche
->
Ëaves
);

1272 
rb_node
 = 
	`Œ“_š£¹
(&
ÿche
->
rb_roÙ
, 
Ãw_node
->
by‹Ä
,

1273 &
Ãw_node
->
rb_node
);

1274 ià(
rb_node
)

1275 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
, 
Ãw_node
->
by‹Ä
);

1277 ià(!
Ãw_node
->
lowe¡
) {

1278 
	`li¡_fÜ_—ch_’Œy
(
Ãw_edge
, &
Ãw_node
->
low”
, 
li¡
[
UPPER
]) {

1279 
	`li¡_add_ž
(&
Ãw_edge
->
li¡
[
LOWER
],

1280 &
Ãw_edge
->
node
[
LOWER
]->
uµ”
);

1284 
çž
:

1285 !
	`li¡_em±y
(&
Ãw_node
->
low”
)) {

1286 
Ãw_edge
 = 
	`li¡_’Œy
(
Ãw_node
->
low”
.
Ãxt
,

1287 
back»f_edge
, 
li¡
[
UPPER
]);

1288 
	`li¡_d–
(&
Ãw_edge
->
li¡
[
UPPER
]);

1289 
	`ä“_back»f_edge
(
ÿche
, 
Ãw_edge
);

1291 
	`ä“_back»f_node
(
ÿche
, 
Ãw_node
);

1292  -
ENOMEM
;

1293 
	}
}

1298 
__mu¡_check
 
	$__add_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1300 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1301 
rb_node
 *rb_node;

1302 
m­pšg_node
 *
node
;

1303 
»loc_cÚŒÞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

1305 
node
 = 
	`km®loc
((*node), 
GFP_NOFS
);

1306 ià(!
node
)

1307  -
ENOMEM
;

1309 
node
->
by‹Ä
 = 
roÙ
->node->
¡¬t
;

1310 
node
->
d©a
 = 
roÙ
;

1312 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1313 
rb_node
 = 
	`Œ“_š£¹
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

1314 
node
->
by‹Ä
, &node->
rb_node
);

1315 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1316 ià(
rb_node
) {

1317 
	`bŒfs_·nic
(
fs_šfo
, -
EEXIST
,

1319 
node
->
by‹Ä
);

1322 
	`li¡_add_ž
(&
roÙ
->
roÙ_li¡
, &
rc
->
»loc_roÙs
);

1324 
	}
}

1330 
	$__d–_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1332 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1333 
rb_node
 *rb_node;

1334 
m­pšg_node
 *
node
 = 
NULL
;

1335 
»loc_cÚŒÞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

1337 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1338 
rb_node
 = 
	`Œ“_£¬ch
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

1339 
roÙ
->
node
->
¡¬t
);

1340 ià(
rb_node
) {

1341 
node
 = 
	`rb_’Œy
(
rb_node
, 
m­pšg_node
,„b_node);

1342 
	`rb_”a£
(&
node
->
rb_node
, &
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
);

1344 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1346 ià(!
node
)

1348 
	`BUG_ON
((
bŒfs_roÙ
 *)
node
->
d©a
 !ð
roÙ
);

1350 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1351 
	`li¡_d–_š™
(&
roÙ
->
roÙ_li¡
);

1352 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1353 
	`kä“
(
node
);

1354 
	}
}

1360 
	$__upd©e_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
Ãw_by‹Ä
)

1362 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1363 
rb_node
 *rb_node;

1364 
m­pšg_node
 *
node
 = 
NULL
;

1365 
»loc_cÚŒÞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

1367 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1368 
rb_node
 = 
	`Œ“_£¬ch
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

1369 
roÙ
->
node
->
¡¬t
);

1370 ià(
rb_node
) {

1371 
node
 = 
	`rb_’Œy
(
rb_node
, 
m­pšg_node
,„b_node);

1372 
	`rb_”a£
(&
node
->
rb_node
, &
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
);

1374 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1376 ià(!
node
)

1378 
	`BUG_ON
((
bŒfs_roÙ
 *)
node
->
d©a
 !ð
roÙ
);

1380 
	`¥š_lock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1381 
node
->
by‹Ä
 = 
Ãw_by‹Ä
;

1382 
rb_node
 = 
	`Œ“_š£¹
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
,

1383 
node
->
by‹Ä
, &node->
rb_node
);

1384 
	`¥š_uÆock
(&
rc
->
»loc_roÙ_Œ“
.
lock
);

1385 ià(
rb_node
)

1386 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
, 
node
->
by‹Ä
);

1388 
	}
}

1390 
bŒfs_roÙ
 *
	$ü—‹_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1391 
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

1393 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1394 
bŒfs_roÙ
 *
»loc_roÙ
;

1395 
ex‹Á_bufãr
 *
eb
;

1396 
bŒfs_roÙ_™em
 *
roÙ_™em
;

1397 
bŒfs_key
 
roÙ_key
;

1398 
»t
;

1400 
roÙ_™em
 = 
	`km®loc
((*roÙ_™em), 
GFP_NOFS
);

1401 
	`BUG_ON
(!
roÙ_™em
);

1403 
roÙ_key
.
objeùid
 = 
BTRFS_TREE_RELOC_OBJECTID
;

1404 
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1405 
roÙ_key
.
off£t
 = 
objeùid
;

1407 ià(
roÙ
->
roÙ_key
.
objeùid
 == objectid) {

1408 
u64
 
comm™_roÙ_g’
;

1411 
»t
 = 
	`bŒfs_cÝy_roÙ
(
Œªs
, 
roÙ
,„oÙ->
comm™_roÙ
, &
eb
,

1412 
BTRFS_TREE_RELOC_OBJECTID
);

1413 
	`BUG_ON
(
»t
);

1422 
comm™_roÙ_g’
 = 
	`bŒfs_h—d”_g’”©iÚ
(
roÙ
->
comm™_roÙ
);

1423 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
, 
comm™_roÙ_g’
);

1432 
»t
 = 
	`bŒfs_cÝy_roÙ
(
Œªs
, 
roÙ
,„oÙ->
node
, &
eb
,

1433 
BTRFS_TREE_RELOC_OBJECTID
);

1434 
	`BUG_ON
(
»t
);

1437 
	`memýy
(
roÙ_™em
, &
roÙ
->root_item, (*root_item));

1438 
	`bŒfs_£t_roÙ_by‹Ä
(
roÙ_™em
, 
eb
->
¡¬t
);

1439 
	`bŒfs_£t_roÙ_Ëv–
(
roÙ_™em
, 
	`bŒfs_h—d”_Ëv–
(
eb
));

1440 
	`bŒfs_£t_roÙ_g’”©iÚ
(
roÙ_™em
, 
Œªs
->
Œªsid
);

1442 ià(
roÙ
->
roÙ_key
.
objeùid
 == objectid) {

1443 
	`bŒfs_£t_roÙ_»fs
(
roÙ_™em
, 0);

1444 
	`mem£t
(&
roÙ_™em
->
drÝ_´og»ss
, 0,

1445 (
bŒfs_disk_key
));

1446 
roÙ_™em
->
drÝ_Ëv–
 = 0;

1449 
	`bŒfs_Œ“_uÆock
(
eb
);

1450 
	`ä“_ex‹Á_bufãr
(
eb
);

1452 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

1453 &
roÙ_key
, 
roÙ_™em
);

1454 
	`BUG_ON
(
»t
);

1455 
	`kä“
(
roÙ_™em
);

1457 
»loc_roÙ
 = 
	`bŒfs_»ad_fs_roÙ
(
fs_šfo
->
Œ“_roÙ
, &
roÙ_key
);

1458 
	`BUG_ON
(
	`IS_ERR
(
»loc_roÙ
));

1459 
»loc_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

1460  
»loc_roÙ
;

1461 
	}
}

1467 
	$bŒfs_š™_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1468 
bŒfs_roÙ
 *
roÙ
)

1470 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1471 
bŒfs_roÙ
 *
»loc_roÙ
;

1472 
»loc_cÚŒÞ
 *
rc
 = 
fs_šfo
->
»loc_ùl
;

1473 
bŒfs_block_rsv
 *
rsv
;

1474 
þ—r_rsv
 = 0;

1475 
»t
;

1477 ià(
roÙ
->
»loc_roÙ
) {

1478 
»loc_roÙ
 = 
roÙ
->reloc_root;

1479 
»loc_roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

1483 ià(!
rc
 || !rc->
ü—‹_»loc_Œ“
 ||

1484 
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
)

1487 ià(!
Œªs
->
»loc_»£rved
) {

1488 
rsv
 = 
Œªs
->
block_rsv
;

1489 
Œªs
->
block_rsv
 = 
rc
->block_rsv;

1490 
þ—r_rsv
 = 1;

1492 
»loc_roÙ
 = 
	`ü—‹_»loc_roÙ
(
Œªs
, 
roÙ
,„oÙ->
roÙ_key
.
objeùid
);

1493 ià(
þ—r_rsv
)

1494 
Œªs
->
block_rsv
 = 
rsv
;

1496 
»t
 = 
	`__add_»loc_roÙ
(
»loc_roÙ
);

1497 
	`BUG_ON
(
»t
 < 0);

1498 
roÙ
->
»loc_roÙ
 =„eloc_root;

1500 
	}
}

1505 
	$bŒfs_upd©e_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1506 
bŒfs_roÙ
 *
roÙ
)

1508 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1509 
bŒfs_roÙ
 *
»loc_roÙ
;

1510 
bŒfs_roÙ_™em
 *
roÙ_™em
;

1511 
»t
;

1513 ià(!
roÙ
->
»loc_roÙ
)

1514 
out
;

1516 
»loc_roÙ
 = 
roÙ
->reloc_root;

1517 
roÙ_™em
 = &
»loc_roÙ
->root_item;

1519 ià(
fs_šfo
->
»loc_ùl
->
m”ge_»loc_Œ“
 &&

1520 
	`bŒfs_roÙ_»fs
(
roÙ_™em
) == 0) {

1521 
roÙ
->
»loc_roÙ
 = 
NULL
;

1522 
	`__d–_»loc_roÙ
(
»loc_roÙ
);

1525 ià(
»loc_roÙ
->
comm™_roÙ
 !ð»loc_roÙ->
node
) {

1526 
	`bŒfs_£t_roÙ_node
(
roÙ_™em
, 
»loc_roÙ
->
node
);

1527 
	`ä“_ex‹Á_bufãr
(
»loc_roÙ
->
comm™_roÙ
);

1528 
»loc_roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(reloc_root);

1531 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

1532 &
»loc_roÙ
->
roÙ_key
, 
roÙ_™em
);

1533 
	`BUG_ON
(
»t
);

1535 
out
:

1537 
	}
}

1543 
šode
 *
	$fšd_Ãxt_šode
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

1545 
rb_node
 *
node
;

1546 
rb_node
 *
´ev
;

1547 
bŒfs_šode
 *
’Œy
;

1548 
šode
 *inode;

1550 
	`¥š_lock
(&
roÙ
->
šode_lock
);

1551 
agaš
:

1552 
node
 = 
roÙ
->
šode_Œ“
.
rb_node
;

1553 
´ev
 = 
NULL
;

1554 
node
) {

1555 
´ev
 = 
node
;

1556 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

1558 ià(
objeùid
 < 
	`bŒfs_šo
(
’Œy
))

1559 
node
 =‚ode->
rb_Ëá
;

1560 ià(
objeùid
 > 
	`bŒfs_šo
(
’Œy
))

1561 
node
 =‚ode->
rb_right
;

1565 ià(!
node
) {

1566 
´ev
) {

1567 
’Œy
 = 
	`rb_’Œy
(
´ev
, 
bŒfs_šode
, 
rb_node
);

1568 ià(
objeùid
 <ð
	`bŒfs_šo
(
’Œy
)) {

1569 
node
 = 
´ev
;

1572 
´ev
 = 
	`rb_Ãxt
(prev);

1575 
node
) {

1576 
’Œy
 = 
	`rb_’Œy
(
node
, 
bŒfs_šode
, 
rb_node
);

1577 
šode
 = 
	`ig¿b
(&
’Œy
->
vfs_šode
);

1578 ià(
šode
) {

1579 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

1580  
šode
;

1583 
objeùid
 = 
	`bŒfs_šo
(
’Œy
) + 1;

1584 ià(
	`cÚd_»sched_lock
(&
roÙ
->
šode_lock
))

1585 
agaš
;

1587 
node
 = 
	`rb_Ãxt
(node);

1589 
	`¥š_uÆock
(&
roÙ
->
šode_lock
);

1590  
NULL
;

1591 
	}
}

1593 
	$š_block_group
(
u64
 
by‹Ä
,

1594 
bŒfs_block_group_ÿche
 *
block_group
)

1596 ià(
by‹Ä
 >ð
block_group
->
key
.
objeùid
 &&

1597 
by‹Ä
 < 
block_group
->
key
.
objeùid
 + block_group->key.
off£t
)

1600 
	}
}

1605 
	$g‘_Ãw_loÿtiÚ
(
šode
 *
»loc_šode
, 
u64
 *
Ãw_by‹Ä
,

1606 
u64
 
by‹Ä
, u64 
num_by‹s
)

1608 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
»loc_šode
)->root;

1609 
bŒfs_·th
 *
·th
;

1610 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1611 
ex‹Á_bufãr
 *
Ëaf
;

1612 
»t
;

1614 
·th
 = 
	`bŒfs_®loc_·th
();

1615 ià(!
·th
)

1616  -
ENOMEM
;

1618 
by‹Ä
 -ð
	`BTRFS_I
(
»loc_šode
)->
šdex_út
;

1619 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
NULL
, 
roÙ
, 
·th
,

1620 
	`bŒfs_šo
(
	`BTRFS_I
(
»loc_šode
)), 
by‹Ä
, 0);

1621 ià(
»t
 < 0)

1622 
out
;

1623 ià(
»t
 > 0) {

1624 
»t
 = -
ENOENT
;

1625 
out
;

1628 
Ëaf
 = 
·th
->
nodes
[0];

1629 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1630 
bŒfs_fže_ex‹Á_™em
);

1632 
	`BUG_ON
(
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
) ||

1633 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
) ||

1634 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
) ||

1635 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
));

1637 ià(
num_by‹s
 !ð
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
)) {

1638 
»t
 = -
EINVAL
;

1639 
out
;

1642 *
Ãw_by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1643 
»t
 = 0;

1644 
out
:

1645 
	`bŒfs_ä“_·th
(
·th
);

1646  
»t
;

1647 
	}
}

1653 
nošlše_fÜ_¡ack


1654 
	$»¶aû_fže_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1655 
»loc_cÚŒÞ
 *
rc
,

1656 
bŒfs_roÙ
 *
roÙ
,

1657 
ex‹Á_bufãr
 *
Ëaf
)

1659 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1660 
bŒfs_key
 
key
;

1661 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1662 
šode
 *šodð
NULL
;

1663 
u64
 
·»Á
;

1664 
u64
 
by‹Ä
;

1665 
u64
 
Ãw_by‹Ä
 = 0;

1666 
u64
 
num_by‹s
;

1667 
u64
 
’d
;

1668 
u32
 
Ä™ems
;

1669 
u32
 
i
;

1670 
»t
 = 0;

1671 
fœ¡
 = 1;

1672 
dœty
 = 0;

1674 ià(
rc
->
¡age
 !ð
UPDATE_DATA_PTRS
)

1678 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
)

1679 
·»Á
 = 
Ëaf
->
¡¬t
;

1681 
·»Á
 = 0;

1683 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

1684 
i
 = 0; i < 
Ä™ems
; i++) {

1685 
	`cÚd_»sched
();

1686 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
i
);

1687 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

1689 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
i
, 
bŒfs_fže_ex‹Á_™em
);

1690 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
) ==

1691 
BTRFS_FILE_EXTENT_INLINE
)

1693 
by‹Ä
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
);

1694 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
);

1695 ià(
by‹Ä
 == 0)

1697 ià(!
	`š_block_group
(
by‹Ä
, 
rc
->
block_group
))

1704 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
) {

1705 ià(
fœ¡
) {

1706 
šode
 = 
	`fšd_Ãxt_šode
(
roÙ
, 
key
.
objeùid
);

1707 
fœ¡
 = 0;

1708 } ià(
šode
 && 
	`bŒfs_šo
(
	`BTRFS_I
(šode)è< 
key
.
objeùid
) {

1709 
	`bŒfs_add_d–ayed_ut
(
šode
);

1710 
šode
 = 
	`fšd_Ãxt_šode
(
roÙ
, 
key
.
objeùid
);

1712 ià(
šode
 && 
	`bŒfs_šo
(
	`BTRFS_I
(šode)è=ð
key
.
objeùid
) {

1713 
’d
 = 
key
.
off£t
 +

1714 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

1715 
	`WARN_ON
(!
	`IS_ALIGNED
(
key
.
off£t
,

1716 
fs_šfo
->
£ùÜsize
));

1717 
	`WARN_ON
(!
	`IS_ALIGNED
(
’d
, 
fs_šfo
->
£ùÜsize
));

1718 
’d
--;

1719 
»t
 = 
	`Œy_lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1720 
key
.
off£t
, 
’d
);

1721 ià(!
»t
)

1724 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
),

1725 
key
.
off£t
, 
’d
, 1);

1726 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1727 
key
.
off£t
, 
’d
);

1731 
»t
 = 
	`g‘_Ãw_loÿtiÚ
(
rc
->
d©a_šode
, &
Ãw_by‹Ä
,

1732 
by‹Ä
, 
num_by‹s
);

1733 ià(
»t
) {

1741 
	`bŒfs_£t_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
, 
Ãw_by‹Ä
);

1742 
dœty
 = 1;

1744 
key
.
off£t
 -ð
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

1745 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
Ãw_by‹Ä
,

1746 
num_by‹s
, 
·»Á
,

1747 
	`bŒfs_h—d”_owÃr
(
Ëaf
),

1748 
key
.
objeùid
, key.
off£t
);

1749 ià(
»t
) {

1750 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1754 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
by‹Ä
, 
num_by‹s
,

1755 
·»Á
, 
	`bŒfs_h—d”_owÃr
(
Ëaf
),

1756 
key
.
objeùid
, key.
off£t
);

1757 ià(
»t
) {

1758 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1762 ià(
dœty
)

1763 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1764 ià(
šode
)

1765 
	`bŒfs_add_d–ayed_ut
(
šode
);

1766  
»t
;

1767 
	}
}

1769 
nošlše_fÜ_¡ack


1770 
	$memcmp_node_keys
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1771 
bŒfs_·th
 *
·th
, 
Ëv–
)

1773 
bŒfs_disk_key
 
key1
;

1774 
bŒfs_disk_key
 
key2
;

1775 
	`bŒfs_node_key
(
eb
, &
key1
, 
¦Ù
);

1776 
	`bŒfs_node_key
(
·th
->
nodes
[
Ëv–
], &
key2
,…©h->
¦Ùs
[level]);

1777  
	`memcmp
(&
key1
, &
key2
, (key1));

1778 
	}
}

1789 
nošlše_fÜ_¡ack


1790 
	$»¶aû_·th
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1791 
bŒfs_roÙ
 *
de¡
, bŒfs_roÙ *
¤c
,

1792 
bŒfs_·th
 *
·th
, 
bŒfs_key
 *
Ãxt_key
,

1793 
lowe¡_Ëv–
, 
max_Ëv–
)

1795 
bŒfs_fs_šfo
 *
fs_šfo
 = 
de¡
->fs_info;

1796 
ex‹Á_bufãr
 *
eb
;

1797 
ex‹Á_bufãr
 *
·»Á
;

1798 
bŒfs_key
 
key
;

1799 
u64
 
Þd_by‹Ä
;

1800 
u64
 
Ãw_by‹Ä
;

1801 
u64
 
Þd_±r_g’
;

1802 
u64
 
Ãw_±r_g’
;

1803 
u64
 
Ï¡_¢­shÙ
;

1804 
u32
 
blocksize
;

1805 
cow
 = 0;

1806 
Ëv–
;

1807 
»t
;

1808 
¦Ù
;

1810 
	`BUG_ON
(
¤c
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
);

1811 
	`BUG_ON
(
de¡
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
);

1813 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
¤c
->
roÙ_™em
);

1814 
agaš
:

1815 
¦Ù
 = 
·th
->
¦Ùs
[
lowe¡_Ëv–
];

1816 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
lowe¡_Ëv–
], &
key
, 
¦Ù
);

1818 
eb
 = 
	`bŒfs_lock_roÙ_node
(
de¡
);

1819 
	`bŒfs_£t_lock_blockšg
(
eb
);

1820 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

1822 ià(
Ëv–
 < 
lowe¡_Ëv–
) {

1823 
	`bŒfs_Œ“_uÆock
(
eb
);

1824 
	`ä“_ex‹Á_bufãr
(
eb
);

1828 ià(
cow
) {

1829 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
de¡
, 
eb
, 
NULL
, 0, &eb);

1830 
	`BUG_ON
(
»t
);

1832 
	`bŒfs_£t_lock_blockšg
(
eb
);

1834 ià(
Ãxt_key
) {

1835 
Ãxt_key
->
objeùid
 = (
u64
)-1;

1836 
Ãxt_key
->
ty³
 = (
u8
)-1;

1837 
Ãxt_key
->
off£t
 = (
u64
)-1;

1840 
·»Á
 = 
eb
;

1842 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
·»Á
);

1843 
	`BUG_ON
(
Ëv–
 < 
lowe¡_Ëv–
);

1845 
»t
 = 
	`bŒfs_bš_£¬ch
(
·»Á
, &
key
, 
Ëv–
, &
¦Ù
);

1846 ià(
»t
 && 
¦Ù
 > 0)

1847 
¦Ù
--;

1849 ià(
Ãxt_key
 && 
¦Ù
 + 1 < 
	`bŒfs_h—d”_Ä™ems
(
·»Á
))

1850 
	`bŒfs_node_key_to_ýu
(
·»Á
, 
Ãxt_key
, 
¦Ù
 + 1);

1852 
Þd_by‹Ä
 = 
	`bŒfs_node_block±r
(
·»Á
, 
¦Ù
);

1853 
blocksize
 = 
fs_šfo
->
nodesize
;

1854 
Þd_±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
);

1856 ià(
Ëv–
 <ð
max_Ëv–
) {

1857 
eb
 = 
·th
->
nodes
[
Ëv–
];

1858 
Ãw_by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
,

1859 
·th
->
¦Ùs
[
Ëv–
]);

1860 
Ãw_±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
,

1861 
·th
->
¦Ùs
[
Ëv–
]);

1863 
Ãw_by‹Ä
 = 0;

1864 
Ãw_±r_g’
 = 0;

1867 ià(
	`WARN_ON
(
Ãw_by‹Ä
 > 0 &&‚ew_by‹Ä =ð
Þd_by‹Ä
)) {

1868 
»t
 = 
Ëv–
;

1872 ià(
Ãw_by‹Ä
 =ð0 || 
Þd_±r_g’
 > 
Ï¡_¢­shÙ
 ||

1873 
	`memcmp_node_keys
(
·»Á
, 
¦Ù
, 
·th
, 
Ëv–
)) {

1874 ià(
Ëv–
 <ð
lowe¡_Ëv–
) {

1875 
»t
 = 0;

1879 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
Þd_by‹Ä
, 
Þd_±r_g’
);

1880 ià(
	`IS_ERR
(
eb
)) {

1881 
»t
 = 
	`PTR_ERR
(
eb
);

1883 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

1884 
»t
 = -
EIO
;

1885 
	`ä“_ex‹Á_bufãr
(
eb
);

1888 
	`bŒfs_Œ“_lock
(
eb
);

1889 ià(
cow
) {

1890 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
de¡
, 
eb
, 
·»Á
,

1891 
¦Ù
, &
eb
);

1892 
	`BUG_ON
(
»t
);

1894 
	`bŒfs_£t_lock_blockšg
(
eb
);

1896 
	`bŒfs_Œ“_uÆock
(
·»Á
);

1897 
	`ä“_ex‹Á_bufãr
(
·»Á
);

1899 
·»Á
 = 
eb
;

1903 ià(!
cow
) {

1904 
	`bŒfs_Œ“_uÆock
(
·»Á
);

1905 
	`ä“_ex‹Á_bufãr
(
·»Á
);

1906 
cow
 = 1;

1907 
agaš
;

1910 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
Ëv–
], &
key
,

1911 
·th
->
¦Ùs
[
Ëv–
]);

1912 
	`bŒfs_»Ëa£_·th
(
·th
);

1914 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

1915 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
¤c
, &
key
, 
·th
, 0, 1);

1916 
·th
->
lowe¡_Ëv–
 = 0;

1917 
	`BUG_ON
(
»t
);

1930 
»t
 = 
	`bŒfs_qgroup_Œaû_subŒ“
(
Œªs
, 
¤c
, 
·»Á
,

1931 
	`bŒfs_h—d”_g’”©iÚ
(
·»Á
),

1932 
	`bŒfs_h—d”_Ëv–
(
·»Á
));

1933 ià(
»t
 < 0)

1935 
»t
 = 
	`bŒfs_qgroup_Œaû_subŒ“
(
Œªs
, 
de¡
,

1936 
·th
->
nodes
[
Ëv–
],

1937 
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[
Ëv–
]),

1938 
	`bŒfs_h—d”_Ëv–
(
·th
->
nodes
[
Ëv–
]));

1939 ià(
»t
 < 0)

1945 
	`bŒfs_£t_node_block±r
(
·»Á
, 
¦Ù
, 
Ãw_by‹Ä
);

1946 
	`bŒfs_£t_node_±r_g’”©iÚ
(
·»Á
, 
¦Ù
, 
Ãw_±r_g’
);

1947 
	`bŒfs_m¬k_bufãr_dœty
(
·»Á
);

1949 
	`bŒfs_£t_node_block±r
(
·th
->
nodes
[
Ëv–
],

1950 
·th
->
¦Ùs
[
Ëv–
], 
Þd_by‹Ä
);

1951 
	`bŒfs_£t_node_±r_g’”©iÚ
(
·th
->
nodes
[
Ëv–
],

1952 
·th
->
¦Ùs
[
Ëv–
], 
Þd_±r_g’
);

1953 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[
Ëv–
]);

1955 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
Þd_by‹Ä
,

1956 
blocksize
, 
·th
->
nodes
[
Ëv–
]->
¡¬t
,

1957 
¤c
->
roÙ_key
.
objeùid
, 
Ëv–
 - 1, 0);

1958 
	`BUG_ON
(
»t
);

1959 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
, 
Ãw_by‹Ä
,

1960 
blocksize
, 0, 
de¡
->
roÙ_key
.
objeùid
,

1961 
Ëv–
 - 1, 0);

1962 
	`BUG_ON
(
»t
);

1964 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
Ãw_by‹Ä
, 
blocksize
,

1965 
·th
->
nodes
[
Ëv–
]->
¡¬t
,

1966 
¤c
->
roÙ_key
.
objeùid
, 
Ëv–
 - 1, 0);

1967 
	`BUG_ON
(
»t
);

1969 
»t
 = 
	`bŒfs_ä“_ex‹Á
(
Œªs
, 
fs_šfo
, 
Þd_by‹Ä
, 
blocksize
,

1970 0, 
de¡
->
roÙ_key
.
objeùid
, 
Ëv–
 - 1,

1972 
	`BUG_ON
(
»t
);

1974 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

1976 
»t
 = 
Ëv–
;

1979 
	`bŒfs_Œ“_uÆock
(
·»Á
);

1980 
	`ä“_ex‹Á_bufãr
(
·»Á
);

1981  
»t
;

1982 
	}
}

1987 
nošlše_fÜ_¡ack


1988 
	$w®k_up_»loc_Œ“
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

1989 *
Ëv–
)

1991 
ex‹Á_bufãr
 *
eb
;

1992 
i
;

1993 
u64
 
Ï¡_¢­shÙ
;

1994 
u32
 
Ä™ems
;

1996 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
);

1998 
i
 = 0; i < *
Ëv–
; i++) {

1999 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
i
]);

2000 
·th
->
nodes
[
i
] = 
NULL
;

2003 
i
 = *
Ëv–
; i < 
BTRFS_MAX_LEVEL
 && 
·th
->
nodes
[i]; i++) {

2004 
eb
 = 
·th
->
nodes
[
i
];

2005 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

2006 
·th
->
¦Ùs
[
i
] + 1 < 
Ä™ems
) {

2007 
·th
->
¦Ùs
[
i
]++;

2008 ià(
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
·th
->
¦Ùs
[
i
]) <=

2009 
Ï¡_¢­shÙ
)

2012 *
Ëv–
 = 
i
;

2015 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[
i
]);

2016 
·th
->
nodes
[
i
] = 
NULL
;

2019 
	}
}

2024 
nošlše_fÜ_¡ack


2025 
	$w®k_down_»loc_Œ“
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

2026 *
Ëv–
)

2028 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2029 
ex‹Á_bufãr
 *
eb
 = 
NULL
;

2030 
i
;

2031 
u64
 
by‹Ä
;

2032 
u64
 
±r_g’
 = 0;

2033 
u64
 
Ï¡_¢­shÙ
;

2034 
u32
 
Ä™ems
;

2036 
Ï¡_¢­shÙ
 = 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
);

2038 
i
 = *
Ëv–
; i > 0; i--) {

2039 
eb
 = 
·th
->
nodes
[
i
];

2040 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

2041 
·th
->
¦Ùs
[
i
] < 
Ä™ems
) {

2042 
±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
eb
, 
·th
->
¦Ùs
[
i
]);

2043 ià(
±r_g’
 > 
Ï¡_¢­shÙ
)

2045 
·th
->
¦Ùs
[
i
]++;

2047 ià(
·th
->
¦Ùs
[
i
] >ð
Ä™ems
) {

2048 ià(
i
 =ð*
Ëv–
)

2050 *
Ëv–
 = 
i
 + 1;

2053 ià(
i
 == 1) {

2054 *
Ëv–
 = 
i
;

2058 
by‹Ä
 = 
	`bŒfs_node_block±r
(
eb
, 
·th
->
¦Ùs
[
i
]);

2059 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
by‹Ä
, 
±r_g’
);

2060 ià(
	`IS_ERR
(
eb
)) {

2061  
	`PTR_ERR
(
eb
);

2062 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

2063 
	`ä“_ex‹Á_bufãr
(
eb
);

2064  -
EIO
;

2066 
	`BUG_ON
(
	`bŒfs_h—d”_Ëv–
(
eb
è!ð
i
 - 1);

2067 
·th
->
nodes
[
i
 - 1] = 
eb
;

2068 
·th
->
¦Ùs
[
i
 - 1] = 0;

2071 
	}
}

2077 
	$šv®id©e_ex‹Á_ÿche
(
bŒfs_roÙ
 *
roÙ
,

2078 
bŒfs_key
 *
mš_key
,

2079 
bŒfs_key
 *
max_key
)

2081 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2082 
šode
 *šodð
NULL
;

2083 
u64
 
objeùid
;

2084 
u64
 
¡¬t
, 
’d
;

2085 
u64
 
šo
;

2087 
objeùid
 = 
mš_key
->objectid;

2089 
	`cÚd_»sched
();

2090 
	`ut
(
šode
);

2092 ià(
objeùid
 > 
max_key
->objectid)

2095 
šode
 = 
	`fšd_Ãxt_šode
(
roÙ
, 
objeùid
);

2096 ià(!
šode
)

2098 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

2100 ià(
šo
 > 
max_key
->
objeùid
) {

2101 
	`ut
(
šode
);

2105 
objeùid
 = 
šo
 + 1;

2106 ià(!
	`S_ISREG
(
šode
->
i_mode
))

2109 ià(
	`uÆik–y
(
mš_key
->
objeùid
 =ð
šo
)) {

2110 ià(
mš_key
->
ty³
 > 
BTRFS_EXTENT_DATA_KEY
)

2112 ià(
mš_key
->
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

2113 
¡¬t
 = 0;

2115 
¡¬t
 = 
mš_key
->
off£t
;

2116 
	`WARN_ON
(!
	`IS_ALIGNED
(
¡¬t
, 
fs_šfo
->
£ùÜsize
));

2119 
¡¬t
 = 0;

2122 ià(
	`uÆik–y
(
max_key
->
objeùid
 =ð
šo
)) {

2123 ià(
max_key
->
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

2125 ià(
max_key
->
ty³
 > 
BTRFS_EXTENT_DATA_KEY
) {

2126 
’d
 = (
u64
)-1;

2128 ià(
max_key
->
off£t
 == 0)

2130 
’d
 = 
max_key
->
off£t
;

2131 
	`WARN_ON
(!
	`IS_ALIGNED
(
’d
, 
fs_šfo
->
£ùÜsize
));

2132 
’d
--;

2135 
’d
 = (
u64
)-1;

2139 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
);

2140 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 1);

2141 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
);

2144 
	}
}

2146 
	$fšd_Ãxt_key
(
bŒfs_·th
 *
·th
, 
Ëv–
,

2147 
bŒfs_key
 *
key
)

2150 
Ëv–
 < 
BTRFS_MAX_LEVEL
) {

2151 ià(!
·th
->
nodes
[
Ëv–
])

2153 ià(
·th
->
¦Ùs
[
Ëv–
] + 1 <

2154 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
Ëv–
])) {

2155 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
Ëv–
], 
key
,

2156 
·th
->
¦Ùs
[
Ëv–
] + 1);

2159 
Ëv–
++;

2162 
	}
}

2168 
nošlše_fÜ_¡ack
 
	$m”ge_»loc_roÙ
(
»loc_cÚŒÞ
 *
rc
,

2169 
bŒfs_roÙ
 *
roÙ
)

2171 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

2172 
	`LIST_HEAD
(
šode_li¡
);

2173 
bŒfs_key
 
key
;

2174 
bŒfs_key
 
Ãxt_key
;

2175 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

2176 
bŒfs_roÙ
 *
»loc_roÙ
;

2177 
bŒfs_roÙ_™em
 *
roÙ_™em
;

2178 
bŒfs_·th
 *
·th
;

2179 
ex‹Á_bufãr
 *
Ëaf
;

2180 
Ëv–
;

2181 
max_Ëv–
;

2182 
»¶aûd
 = 0;

2183 
»t
;

2184 
”r
 = 0;

2185 
u32
 
mš_»£rved
;

2187 
·th
 = 
	`bŒfs_®loc_·th
();

2188 ià(!
·th
)

2189  -
ENOMEM
;

2190 
·th
->
»ada
 = 
READA_FORWARD
;

2192 
»loc_roÙ
 = 
roÙ
->reloc_root;

2193 
roÙ_™em
 = &
»loc_roÙ
->root_item;

2195 ià(
	`bŒfs_disk_key_objeùid
(&
roÙ_™em
->
drÝ_´og»ss
) == 0) {

2196 
Ëv–
 = 
	`bŒfs_roÙ_Ëv–
(
roÙ_™em
);

2197 
	`ex‹Á_bufãr_g‘
(
»loc_roÙ
->
node
);

2198 
·th
->
nodes
[
Ëv–
] = 
»loc_roÙ
->
node
;

2199 
·th
->
¦Ùs
[
Ëv–
] = 0;

2201 
	`bŒfs_disk_key_to_ýu
(&
key
, &
roÙ_™em
->
drÝ_´og»ss
);

2203 
Ëv–
 = 
roÙ_™em
->
drÝ_Ëv–
;

2204 
	`BUG_ON
(
Ëv–
 == 0);

2205 
·th
->
lowe¡_Ëv–
 = 
Ëv–
;

2206 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
»loc_roÙ
, &
key
, 
·th
, 0, 0);

2207 
·th
->
lowe¡_Ëv–
 = 0;

2208 ià(
»t
 < 0) {

2209 
	`bŒfs_ä“_·th
(
·th
);

2210  
»t
;

2213 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
Ëv–
], &
Ãxt_key
,

2214 
·th
->
¦Ùs
[
Ëv–
]);

2215 
	`WARN_ON
(
	`memcmp
(&
key
, &
Ãxt_key
, (key)));

2217 
	`bŒfs_uÆock_up_§ã
(
·th
, 0);

2220 
mš_»£rved
 = 
fs_šfo
->
nodesize
 * (
BTRFS_MAX_LEVEL
 - 1) * 2;

2221 
	`mem£t
(&
Ãxt_key
, 0, (next_key));

2224 
»t
 = 
	`bŒfs_block_rsv_»fžl
(
roÙ
, 
rc
->
block_rsv
, 
mš_»£rved
,

2225 
BTRFS_RESERVE_FLUSH_ALL
);

2226 ià(
»t
) {

2227 
”r
 = 
»t
;

2228 
out
;

2230 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

2231 ià(
	`IS_ERR
(
Œªs
)) {

2232 
”r
 = 
	`PTR_ERR
(
Œªs
);

2233 
Œªs
 = 
NULL
;

2234 
out
;

2236 
Œªs
->
block_rsv
 = 
rc
->block_rsv;

2238 
»¶aûd
 = 0;

2239 
max_Ëv–
 = 
Ëv–
;

2241 
»t
 = 
	`w®k_down_»loc_Œ“
(
»loc_roÙ
, 
·th
, &
Ëv–
);

2242 ià(
»t
 < 0) {

2243 
”r
 = 
»t
;

2244 
out
;

2246 ià(
»t
 > 0)

2249 ià(!
	`fšd_Ãxt_key
(
·th
, 
Ëv–
, &
key
) &&

2250 
	`bŒfs_comp_ýu_keys
(&
Ãxt_key
, &
key
) >= 0) {

2251 
»t
 = 0;

2253 
»t
 = 
	`»¶aû_·th
(
Œªs
, 
roÙ
, 
»loc_roÙ
, 
·th
,

2254 &
Ãxt_key
, 
Ëv–
, 
max_Ëv–
);

2256 ià(
»t
 < 0) {

2257 
”r
 = 
»t
;

2258 
out
;

2261 ià(
»t
 > 0) {

2262 
Ëv–
 = 
»t
;

2263 
	`bŒfs_node_key_to_ýu
(
·th
->
nodes
[
Ëv–
], &
key
,

2264 
·th
->
¦Ùs
[
Ëv–
]);

2265 
»¶aûd
 = 1;

2268 
»t
 = 
	`w®k_up_»loc_Œ“
(
»loc_roÙ
, 
·th
, &
Ëv–
);

2269 ià(
»t
 > 0)

2272 
	`BUG_ON
(
Ëv–
 == 0);

2277 
	`bŒfs_node_key
(
·th
->
nodes
[
Ëv–
], &
roÙ_™em
->
drÝ_´og»ss
,

2278 
·th
->
¦Ùs
[
Ëv–
]);

2279 
roÙ_™em
->
drÝ_Ëv–
 = 
Ëv–
;

2281 
	`bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
Œªs
);

2282 
Œªs
 = 
NULL
;

2284 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

2286 ià(
»¶aûd
 && 
rc
->
¡age
 =ð
UPDATE_DATA_PTRS
)

2287 
	`šv®id©e_ex‹Á_ÿche
(
roÙ
, &
key
, &
Ãxt_key
);

2294 
Ëaf
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

2295 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Ëaf
, 
NULL
, 0, &leaf);

2296 
	`bŒfs_Œ“_uÆock
(
Ëaf
);

2297 
	`ä“_ex‹Á_bufãr
(
Ëaf
);

2298 ià(
»t
 < 0)

2299 
”r
 = 
»t
;

2300 
out
:

2301 
	`bŒfs_ä“_·th
(
·th
);

2303 ià(
”r
 == 0) {

2304 
	`mem£t
(&
roÙ_™em
->
drÝ_´og»ss
, 0,

2305 (
roÙ_™em
->
drÝ_´og»ss
));

2306 
roÙ_™em
->
drÝ_Ëv–
 = 0;

2307 
	`bŒfs_£t_roÙ_»fs
(
roÙ_™em
, 0);

2308 
	`bŒfs_upd©e_»loc_roÙ
(
Œªs
, 
roÙ
);

2311 ià(
Œªs
)

2312 
	`bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
Œªs
);

2314 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

2316 ià(
»¶aûd
 && 
rc
->
¡age
 =ð
UPDATE_DATA_PTRS
)

2317 
	`šv®id©e_ex‹Á_ÿche
(
roÙ
, &
key
, &
Ãxt_key
);

2319  
”r
;

2320 
	}
}

2322 
nošlše_fÜ_¡ack


2323 
	$´•¬e_to_m”ge
(
»loc_cÚŒÞ
 *
rc
, 
”r
)

2325 
bŒfs_roÙ
 *
roÙ
 = 
rc
->
ex‹Á_roÙ
;

2326 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2327 
bŒfs_roÙ
 *
»loc_roÙ
;

2328 
bŒfs_Œªs_hªdË
 *
Œªs
;

2329 
	`LIST_HEAD
(
»loc_roÙs
);

2330 
u64
 
num_by‹s
 = 0;

2331 
»t
;

2333 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2334 
rc
->
m”gšg_rsv_size
 +ð
fs_šfo
->
nodesize
 * (
BTRFS_MAX_LEVEL
 - 1) * 2;

2335 
rc
->
m”gšg_rsv_size
 +ðrc->
nodes_»loÿ‹d
 * 2;

2336 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2338 
agaš
:

2339 ià(!
”r
) {

2340 
num_by‹s
 = 
rc
->
m”gšg_rsv_size
;

2341 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, 
rc
->
block_rsv
, 
num_by‹s
,

2342 
BTRFS_RESERVE_FLUSH_ALL
);

2343 ià(
»t
)

2344 
”r
 = 
»t
;

2347 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

2348 ià(
	`IS_ERR
(
Œªs
)) {

2349 ià(!
”r
)

2350 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
,

2351 
num_by‹s
);

2352  
	`PTR_ERR
(
Œªs
);

2355 ià(!
”r
) {

2356 ià(
num_by‹s
 !ð
rc
->
m”gšg_rsv_size
) {

2357 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2358 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
,

2359 
num_by‹s
);

2360 
agaš
;

2364 
rc
->
m”ge_»loc_Œ“
 = 1;

2366 !
	`li¡_em±y
(&
rc
->
»loc_roÙs
)) {

2367 
»loc_roÙ
 = 
	`li¡_’Œy
(
rc
->
»loc_roÙs
.
Ãxt
,

2368 
bŒfs_roÙ
, 
roÙ_li¡
);

2369 
	`li¡_d–_š™
(&
»loc_roÙ
->
roÙ_li¡
);

2371 
roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
);

2372 
	`BUG_ON
(
	`IS_ERR
(
roÙ
));

2373 
	`BUG_ON
(
roÙ
->
»loc_roÙ
 !=„eloc_root);

2379 ià(!
”r
)

2380 
	`bŒfs_£t_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
, 1);

2381 
	`bŒfs_upd©e_»loc_roÙ
(
Œªs
, 
roÙ
);

2383 
	`li¡_add
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

2386 
	`li¡_¥liû
(&
»loc_roÙs
, &
rc
->reloc_roots);

2388 ià(!
”r
)

2389 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2391 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2392  
”r
;

2393 
	}
}

2395 
nošlše_fÜ_¡ack


2396 
	$ä“_»loc_roÙs
(
li¡_h—d
 *
li¡
)

2398 
bŒfs_roÙ
 *
»loc_roÙ
;

2400 !
	`li¡_em±y
(
li¡
)) {

2401 
»loc_roÙ
 = 
	`li¡_’Œy
(
li¡
->
Ãxt
, 
bŒfs_roÙ
,

2402 
roÙ_li¡
);

2403 
	`__d–_»loc_roÙ
(
»loc_roÙ
);

2404 
	`ä“_ex‹Á_bufãr
(
»loc_roÙ
->
node
);

2405 
	`ä“_ex‹Á_bufãr
(
»loc_roÙ
->
comm™_roÙ
);

2406 
»loc_roÙ
->
node
 = 
NULL
;

2407 
»loc_roÙ
->
comm™_roÙ
 = 
NULL
;

2409 
	}
}

2411 
nošlše_fÜ_¡ack


2412 
	$m”ge_»loc_roÙs
(
»loc_cÚŒÞ
 *
rc
)

2414 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

2415 
bŒfs_roÙ
 *
roÙ
;

2416 
bŒfs_roÙ
 *
»loc_roÙ
;

2417 
	`LIST_HEAD
(
»loc_roÙs
);

2418 
found
 = 0;

2419 
»t
 = 0;

2420 
agaš
:

2421 
roÙ
 = 
rc
->
ex‹Á_roÙ
;

2429 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2430 
	`li¡_¥liû_š™
(&
rc
->
»loc_roÙs
, &reloc_roots);

2431 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2433 !
	`li¡_em±y
(&
»loc_roÙs
)) {

2434 
found
 = 1;

2435 
»loc_roÙ
 = 
	`li¡_’Œy
(
»loc_roÙs
.
Ãxt
,

2436 
bŒfs_roÙ
, 
roÙ_li¡
);

2438 ià(
	`bŒfs_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
) > 0) {

2439 
roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
,

2440 
»loc_roÙ
->
roÙ_key
.
off£t
);

2441 
	`BUG_ON
(
	`IS_ERR
(
roÙ
));

2442 
	`BUG_ON
(
roÙ
->
»loc_roÙ
 !=„eloc_root);

2444 
»t
 = 
	`m”ge_»loc_roÙ
(
rc
, 
roÙ
);

2445 ià(
»t
) {

2446 ià(
	`li¡_em±y
(&
»loc_roÙ
->
roÙ_li¡
))

2447 
	`li¡_add_ž
(&
»loc_roÙ
->
roÙ_li¡
,

2448 &
»loc_roÙs
);

2449 
out
;

2452 
	`li¡_d–_š™
(&
»loc_roÙ
->
roÙ_li¡
);

2455 
»t
 = 
	`bŒfs_drÝ_¢­shÙ
(
»loc_roÙ
, 
rc
->
block_rsv
, 0, 1);

2456 ià(
»t
 < 0) {

2457 ià(
	`li¡_em±y
(&
»loc_roÙ
->
roÙ_li¡
))

2458 
	`li¡_add_ž
(&
»loc_roÙ
->
roÙ_li¡
,

2459 &
»loc_roÙs
);

2460 
out
;

2464 ià(
found
) {

2465 
found
 = 0;

2466 
agaš
;

2468 
out
:

2469 ià(
»t
) {

2470 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

2471 ià(!
	`li¡_em±y
(&
»loc_roÙs
))

2472 
	`ä“_»loc_roÙs
(&
»loc_roÙs
);

2475 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2476 
	`li¡_¥liû_š™
(&
rc
->
»loc_roÙs
, &reloc_roots);

2477 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2478 ià(!
	`li¡_em±y
(&
»loc_roÙs
))

2479 
	`ä“_»loc_roÙs
(&
»loc_roÙs
);

2482 
	`BUG_ON
(!
	`RB_EMPTY_ROOT
(&
rc
->
»loc_roÙ_Œ“
.
rb_roÙ
));

2483 
	}
}

2485 
	$ä“_block_li¡
(
rb_roÙ
 *
blocks
)

2487 
Œ“_block
 *
block
;

2488 
rb_node
 *rb_node;

2489 (
rb_node
 = 
	`rb_fœ¡
(
blocks
))) {

2490 
block
 = 
	`rb_’Œy
(
rb_node
, 
Œ“_block
,„b_node);

2491 
	`rb_”a£
(
rb_node
, 
blocks
);

2492 
	`kä“
(
block
);

2494 
	}
}

2496 
	$»cÜd_»loc_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2497 
bŒfs_roÙ
 *
»loc_roÙ
)

2499 
bŒfs_fs_šfo
 *
fs_šfo
 = 
»loc_roÙ
->fs_info;

2500 
bŒfs_roÙ
 *
roÙ
;

2502 ià(
»loc_roÙ
->
Ï¡_Œªs
 =ð
Œªs
->
Œªsid
)

2505 
roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
);

2506 
	`BUG_ON
(
	`IS_ERR
(
roÙ
));

2507 
	`BUG_ON
(
roÙ
->
»loc_roÙ
 !=„eloc_root);

2509  
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2510 
	}
}

2512 
nošlše_fÜ_¡ack


2513 
bŒfs_roÙ
 *
	$£Ëù_»loc_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2514 
»loc_cÚŒÞ
 *
rc
,

2515 
back»f_node
 *
node
,

2516 
back»f_edge
 *
edges
[])

2518 
back»f_node
 *
Ãxt
;

2519 
bŒfs_roÙ
 *
roÙ
;

2520 
šdex
 = 0;

2522 
Ãxt
 = 
node
;

2524 
	`cÚd_»sched
();

2525 
Ãxt
 = 
	`w®k_up_back»f
Òext, 
edges
, &
šdex
);

2526 
roÙ
 = 
Ãxt
->root;

2527 
	`BUG_ON
(!
roÙ
);

2528 
	`BUG_ON
(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
));

2530 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
) {

2531 
	`»cÜd_»loc_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2535 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2536 
roÙ
 =„oÙ->
»loc_roÙ
;

2538 ià(
Ãxt
->
Ãw_by‹Ä
 !ð
roÙ
->
node
->
¡¬t
) {

2539 
	`BUG_ON
(
Ãxt
->
Ãw_by‹Ä
);

2540 
	`BUG_ON
(!
	`li¡_em±y
(&
Ãxt
->
li¡
));

2541 
Ãxt
->
Ãw_by‹Ä
 = 
roÙ
->
node
->
¡¬t
;

2542 
Ãxt
->
roÙ
 =„oot;

2543 
	`li¡_add_ž
(&
Ãxt
->
li¡
,

2544 &
rc
->
back»f_ÿche
.
chªged
);

2545 
	`__m¬k_block_´oûs£d
(
rc
, 
Ãxt
);

2549 
	`WARN_ON
(1);

2550 
roÙ
 = 
NULL
;

2551 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2552 ià(!
Ãxt
 ||‚ext->
Ëv–
 <ð
node
->level)

2555 ià(!
roÙ
)

2556  
NULL
;

2558 
Ãxt
 = 
node
;

2561 
rc
->
back»f_ÿche
.
·th
[
Ãxt
->
Ëv–
] =‚ext;

2562 ià(--
šdex
 < 0)

2564 
Ãxt
 = 
edges
[
šdex
]->
node
[
UPPER
];

2566  
roÙ
;

2567 
	}
}

2575 
nošlše_fÜ_¡ack


2576 
bŒfs_roÙ
 *
	$£Ëù_Úe_roÙ
(
back»f_node
 *
node
)

2578 
back»f_node
 *
Ãxt
;

2579 
bŒfs_roÙ
 *
roÙ
;

2580 
bŒfs_roÙ
 *
fs_roÙ
 = 
NULL
;

2581 
back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2582 
šdex
 = 0;

2584 
Ãxt
 = 
node
;

2586 
	`cÚd_»sched
();

2587 
Ãxt
 = 
	`w®k_up_back»f
Òext, 
edges
, &
šdex
);

2588 
roÙ
 = 
Ãxt
->root;

2589 
	`BUG_ON
(!
roÙ
);

2592 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

2593  
roÙ
;

2595 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
)

2596 
fs_roÙ
 = 
roÙ
;

2598 ià(
Ãxt
 !ð
node
)

2599  
NULL
;

2601 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2602 ià(!
Ãxt
 ||‚ext->
Ëv–
 <ð
node
->level)

2606 ià(!
fs_roÙ
)

2607  
	`ERR_PTR
(-
ENOENT
);

2608  
fs_roÙ
;

2609 
	}
}

2611 
nošlše_fÜ_¡ack


2612 
u64
 
	$ÿlcu_m‘ad©a_size
(
»loc_cÚŒÞ
 *
rc
,

2613 
back»f_node
 *
node
, 
»£rve
)

2615 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

2616 
back»f_node
 *
Ãxt
 = 
node
;

2617 
back»f_edge
 *
edge
;

2618 
back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2619 
u64
 
num_by‹s
 = 0;

2620 
šdex
 = 0;

2622 
	`BUG_ON
(
»£rve
 && 
node
->
´oûs£d
);

2624 
Ãxt
) {

2625 
	`cÚd_»sched
();

2627 ià(
Ãxt
->
´oûs£d
 && (
»£rve
 ||‚exˆ!ð
node
))

2630 
num_by‹s
 +ð
fs_šfo
->
nodesize
;

2632 ià(
	`li¡_em±y
(&
Ãxt
->
uµ”
))

2635 
edge
 = 
	`li¡_’Œy
(
Ãxt
->
uµ”
.next,

2636 
back»f_edge
, 
li¡
[
LOWER
]);

2637 
edges
[
šdex
++] = 
edge
;

2638 
Ãxt
 = 
edge
->
node
[
UPPER
];

2640 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2642  
num_by‹s
;

2643 
	}
}

2645 
	$»£rve_m‘ad©a_¥aû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2646 
»loc_cÚŒÞ
 *
rc
,

2647 
back»f_node
 *
node
)

2649 
bŒfs_roÙ
 *
roÙ
 = 
rc
->
ex‹Á_roÙ
;

2650 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2651 
u64
 
num_by‹s
;

2652 
»t
;

2653 
u64
 
tmp
;

2655 
num_by‹s
 = 
	`ÿlcu_m‘ad©a_size
(
rc
, 
node
, 1) * 2;

2657 
Œªs
->
block_rsv
 = 
rc
->block_rsv;

2658 
rc
->
»£rved_by‹s
 +ð
num_by‹s
;

2665 
»t
 = 
	`bŒfs_block_rsv_»fžl
(
roÙ
, 
rc
->
block_rsv
, 
num_by‹s
,

2666 
BTRFS_RESERVE_FLUSH_LIMIT
);

2667 ià(
»t
) {

2668 
tmp
 = 
fs_šfo
->
nodesize
 * 
RELOCATION_RESERVED_NODES
;

2669 
tmp
 <ð
rc
->
»£rved_by‹s
)

2670 
tmp
 <<= 1;

2678 
rc
->
block_rsv
->
size
 = 
tmp
 + 
fs_šfo
->
nodesize
 *

2679 
RELOCATION_RESERVED_NODES
;

2680  -
EAGAIN
;

2684 
	}
}

2693 
	$do_»loÿtiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2694 
»loc_cÚŒÞ
 *
rc
,

2695 
back»f_node
 *
node
,

2696 
bŒfs_key
 *
key
,

2697 
bŒfs_·th
 *
·th
, 
lowe¡
)

2699 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

2700 
back»f_node
 *
uµ”
;

2701 
back»f_edge
 *
edge
;

2702 
back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2703 
bŒfs_roÙ
 *
roÙ
;

2704 
ex‹Á_bufãr
 *
eb
;

2705 
u32
 
blocksize
;

2706 
u64
 
by‹Ä
;

2707 
u64
 
g’”©iÚ
;

2708 
¦Ù
;

2709 
»t
;

2710 
”r
 = 0;

2712 
	`BUG_ON
(
lowe¡
 && 
node
->
eb
);

2714 
·th
->
lowe¡_Ëv–
 = 
node
->
Ëv–
 + 1;

2715 
rc
->
back»f_ÿche
.
·th
[
node
->
Ëv–
] =‚ode;

2716 
	`li¡_fÜ_—ch_’Œy
(
edge
, &
node
->
uµ”
, 
li¡
[
LOWER
]) {

2717 
	`cÚd_»sched
();

2719 
uµ”
 = 
edge
->
node
[
UPPER
];

2720 
roÙ
 = 
	`£Ëù_»loc_roÙ
(
Œªs
, 
rc
, 
uµ”
, 
edges
);

2721 
	`BUG_ON
(!
roÙ
);

2723 ià(
uµ”
->
eb
 && !uµ”->
locked
) {

2724 ià(!
lowe¡
) {

2725 
»t
 = 
	`bŒfs_bš_£¬ch
(
uµ”
->
eb
, 
key
,

2726 
uµ”
->
Ëv–
, &
¦Ù
);

2727 
	`BUG_ON
(
»t
);

2728 
by‹Ä
 = 
	`bŒfs_node_block±r
(
uµ”
->
eb
, 
¦Ù
);

2729 ià(
node
->
eb
->
¡¬t
 =ð
by‹Ä
)

2730 
Ãxt
;

2732 
	`drÝ_node_bufãr
(
uµ”
);

2735 ià(!
uµ”
->
eb
) {

2736 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 0, 1);

2737 ià(
»t
) {

2738 ià(
»t
 < 0)

2739 
”r
 = 
»t
;

2741 
”r
 = -
ENOENT
;

2743 
	`bŒfs_»Ëa£_·th
(
·th
);

2747 ià(!
uµ”
->
eb
) {

2748 
uµ”
->
eb
 = 
·th
->
nodes
[uµ”->
Ëv–
];

2749 
·th
->
nodes
[
uµ”
->
Ëv–
] = 
NULL
;

2751 
	`BUG_ON
(
uµ”
->
eb
 !ð
·th
->
nodes
[uµ”->
Ëv–
]);

2754 
uµ”
->
locked
 = 1;

2755 
·th
->
locks
[
uµ”
->
Ëv–
] = 0;

2757 
¦Ù
 = 
·th
->
¦Ùs
[
uµ”
->
Ëv–
];

2758 
	`bŒfs_»Ëa£_·th
(
·th
);

2760 
»t
 = 
	`bŒfs_bš_£¬ch
(
uµ”
->
eb
, 
key
, uµ”->
Ëv–
,

2761 &
¦Ù
);

2762 
	`BUG_ON
(
»t
);

2765 
by‹Ä
 = 
	`bŒfs_node_block±r
(
uµ”
->
eb
, 
¦Ù
);

2766 ià(
lowe¡
) {

2767 ià(
by‹Ä
 !ð
node
->bytenr) {

2768 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

2770 
by‹Ä
, 
node
->by‹Ä, 
¦Ù
,

2771 
uµ”
->
eb
->
¡¬t
);

2772 
”r
 = -
EIO
;

2773 
Ãxt
;

2776 ià(
node
->
eb
->
¡¬t
 =ð
by‹Ä
)

2777 
Ãxt
;

2780 
blocksize
 = 
roÙ
->
fs_šfo
->
nodesize
;

2781 
g’”©iÚ
 = 
	`bŒfs_node_±r_g’”©iÚ
(
uµ”
->
eb
, 
¦Ù
);

2782 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
by‹Ä
, 
g’”©iÚ
);

2783 ià(
	`IS_ERR
(
eb
)) {

2784 
”r
 = 
	`PTR_ERR
(
eb
);

2785 
Ãxt
;

2786 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

2787 
	`ä“_ex‹Á_bufãr
(
eb
);

2788 
”r
 = -
EIO
;

2789 
Ãxt
;

2791 
	`bŒfs_Œ“_lock
(
eb
);

2792 
	`bŒfs_£t_lock_blockšg
(
eb
);

2794 ià(!
node
->
eb
) {

2795 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
eb
, 
uµ”
->eb,

2796 
¦Ù
, &
eb
);

2797 
	`bŒfs_Œ“_uÆock
(
eb
);

2798 
	`ä“_ex‹Á_bufãr
(
eb
);

2799 ià(
»t
 < 0) {

2800 
”r
 = 
»t
;

2801 
Ãxt
;

2803 
	`BUG_ON
(
node
->
eb
 !=ƒb);

2805 
	`bŒfs_£t_node_block±r
(
uµ”
->
eb
, 
¦Ù
,

2806 
node
->
eb
->
¡¬t
);

2807 
	`bŒfs_£t_node_±r_g’”©iÚ
(
uµ”
->
eb
, 
¦Ù
,

2808 
Œªs
->
Œªsid
);

2809 
	`bŒfs_m¬k_bufãr_dœty
(
uµ”
->
eb
);

2811 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
roÙ
->
fs_šfo
,

2812 
node
->
eb
->
¡¬t
, 
blocksize
,

2813 
uµ”
->
eb
->
¡¬t
,

2814 
	`bŒfs_h—d”_owÃr
(
uµ”
->
eb
),

2815 
node
->
Ëv–
, 0);

2816 
	`BUG_ON
(
»t
);

2818 
»t
 = 
	`bŒfs_drÝ_subŒ“
(
Œªs
, 
roÙ
, 
eb
, 
uµ”
->eb);

2819 
	`BUG_ON
(
»t
);

2821 
Ãxt
:

2822 ià(!
uµ”
->
³ndšg
)

2823 
	`drÝ_node_bufãr
(
uµ”
);

2825 
	`uÆock_node_bufãr
(
uµ”
);

2826 ià(
”r
)

2830 ià(!
”r
 && 
node
->
³ndšg
) {

2831 
	`drÝ_node_bufãr
(
node
);

2832 
	`li¡_move_ž
(&
node
->
li¡
, &
rc
->
back»f_ÿche
.
chªged
);

2833 
node
->
³ndšg
 = 0;

2836 
·th
->
lowe¡_Ëv–
 = 0;

2837 
	`BUG_ON
(
”r
 =ð-
ENOSPC
);

2838  
”r
;

2839 
	}
}

2841 
	$lšk_to_uµ”
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2842 
»loc_cÚŒÞ
 *
rc
,

2843 
back»f_node
 *
node
,

2844 
bŒfs_·th
 *
·th
)

2846 
bŒfs_key
 
key
;

2848 
	`bŒfs_node_key_to_ýu
(
node
->
eb
, &
key
, 0);

2849  
	`do_»loÿtiÚ
(
Œªs
, 
rc
, 
node
, &
key
, 
·th
, 0);

2850 
	}
}

2852 
	$fšish_³ndšg_nodes
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2853 
»loc_cÚŒÞ
 *
rc
,

2854 
bŒfs_·th
 *
·th
, 
”r
)

2856 
	`LIST_HEAD
(
li¡
);

2857 
back»f_ÿche
 *
ÿche
 = &
rc
->backref_cache;

2858 
back»f_node
 *
node
;

2859 
Ëv–
;

2860 
»t
;

2862 
Ëv–
 = 0;†ev– < 
BTRFS_MAX_LEVEL
;†evel++) {

2863 !
	`li¡_em±y
(&
ÿche
->
³ndšg
[
Ëv–
])) {

2864 
node
 = 
	`li¡_’Œy
(
ÿche
->
³ndšg
[
Ëv–
].
Ãxt
,

2865 
back»f_node
, 
li¡
);

2866 
	`li¡_move_ž
(&
node
->
li¡
, &list);

2867 
	`BUG_ON
(!
node
->
³ndšg
);

2869 ià(!
”r
) {

2870 
»t
 = 
	`lšk_to_uµ”
(
Œªs
, 
rc
, 
node
, 
·th
);

2871 ià(
»t
 < 0)

2872 
”r
 = 
»t
;

2875 
	`li¡_¥liû_š™
(&
li¡
, &
ÿche
->
³ndšg
[
Ëv–
]);

2877  
”r
;

2878 
	}
}

2880 
	$m¬k_block_´oûs£d
(
»loc_cÚŒÞ
 *
rc
,

2881 
u64
 
by‹Ä
, 
u32
 
blocksize
)

2883 
	`£t_ex‹Á_b™s
(&
rc
->
´oûs£d_blocks
, 
by‹Ä
, by‹Ä + 
blocksize
 - 1,

2884 
EXTENT_DIRTY
);

2885 
	}
}

2887 
	$__m¬k_block_´oûs£d
(
»loc_cÚŒÞ
 *
rc
,

2888 
back»f_node
 *
node
)

2890 
u32
 
blocksize
;

2891 ià(
node
->
Ëv–
 == 0 ||

2892 
	`š_block_group
(
node
->
by‹Ä
, 
rc
->
block_group
)) {

2893 
blocksize
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

2894 
	`m¬k_block_´oûs£d
(
rc
, 
node
->
by‹Ä
, 
blocksize
);

2896 
node
->
´oûs£d
 = 1;

2897 
	}
}

2903 
	$upd©e_´oûs£d_blocks
(
»loc_cÚŒÞ
 *
rc
,

2904 
back»f_node
 *
node
)

2906 
back»f_node
 *
Ãxt
 = 
node
;

2907 
back»f_edge
 *
edge
;

2908 
back»f_edge
 *
edges
[
BTRFS_MAX_LEVEL
 - 1];

2909 
šdex
 = 0;

2911 
Ãxt
) {

2912 
	`cÚd_»sched
();

2914 ià(
Ãxt
->
´oûs£d
)

2917 
	`__m¬k_block_´oûs£d
(
rc
, 
Ãxt
);

2919 ià(
	`li¡_em±y
(&
Ãxt
->
uµ”
))

2922 
edge
 = 
	`li¡_’Œy
(
Ãxt
->
uµ”
.next,

2923 
back»f_edge
, 
li¡
[
LOWER
]);

2924 
edges
[
šdex
++] = 
edge
;

2925 
Ãxt
 = 
edge
->
node
[
UPPER
];

2927 
Ãxt
 = 
	`w®k_down_back»f
(
edges
, &
šdex
);

2929 
	}
}

2931 
	$Œ“_block_´oûs£d
(
u64
 
by‹Ä
, 
»loc_cÚŒÞ
 *
rc
)

2933 
u32
 
blocksize
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

2935 ià(
	`‹¡_¿nge_b™
(&
rc
->
´oûs£d_blocks
, 
by‹Ä
,

2936 
by‹Ä
 + 
blocksize
 - 1, 
EXTENT_DIRTY
, 1, 
NULL
))

2939 
	}
}

2941 
	$g‘_Œ“_block_key
(
bŒfs_fs_šfo
 *
fs_šfo
,

2942 
Œ“_block
 *
block
)

2944 
ex‹Á_bufãr
 *
eb
;

2946 
	`BUG_ON
(
block
->
key_»ady
);

2947 
eb
 = 
	`»ad_Œ“_block
(
fs_šfo
, 
block
->
by‹Ä
, block->
key
.
off£t
);

2948 ià(
	`IS_ERR
(
eb
)) {

2949  
	`PTR_ERR
(
eb
);

2950 } ià(!
	`ex‹Á_bufãr_u±od©e
(
eb
)) {

2951 
	`ä“_ex‹Á_bufãr
(
eb
);

2952  -
EIO
;

2954 
	`WARN_ON
(
	`bŒfs_h—d”_Ëv–
(
eb
è!ð
block
->
Ëv–
);

2955 ià(
block
->
Ëv–
 == 0)

2956 
	`bŒfs_™em_key_to_ýu
(
eb
, &
block
->
key
, 0);

2958 
	`bŒfs_node_key_to_ýu
(
eb
, &
block
->
key
, 0);

2959 
	`ä“_ex‹Á_bufãr
(
eb
);

2960 
block
->
key_»ady
 = 1;

2962 
	}
}

2967 
	$»loÿ‹_Œ“_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2968 
»loc_cÚŒÞ
 *
rc
,

2969 
back»f_node
 *
node
,

2970 
bŒfs_key
 *
key
,

2971 
bŒfs_·th
 *
·th
)

2973 
bŒfs_roÙ
 *
roÙ
;

2974 
»t
 = 0;

2976 ià(!
node
)

2979 
	`BUG_ON
(
node
->
´oûs£d
);

2980 
roÙ
 = 
	`£Ëù_Úe_roÙ
(
node
);

2981 ià(
roÙ
 =ð
	`ERR_PTR
(-
ENOENT
)) {

2982 
	`upd©e_´oûs£d_blocks
(
rc
, 
node
);

2983 
out
;

2986 ià(!
roÙ
 || 
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &roÙ->
¡©e
)) {

2987 
»t
 = 
	`»£rve_m‘ad©a_¥aû
(
Œªs
, 
rc
, 
node
);

2988 ià(
»t
)

2989 
out
;

2992 ià(
roÙ
) {

2993 ià(
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
)) {

2994 
	`BUG_ON
(
node
->
Ãw_by‹Ä
);

2995 
	`BUG_ON
(!
	`li¡_em±y
(&
node
->
li¡
));

2996 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
);

2997 
roÙ
 =„oÙ->
»loc_roÙ
;

2998 
node
->
Ãw_by‹Ä
 = 
roÙ
->node->
¡¬t
;

2999 
node
->
roÙ
 =„oot;

3000 
	`li¡_add_ž
(&
node
->
li¡
, &
rc
->
back»f_ÿche
.
chªged
);

3002 
·th
->
lowe¡_Ëv–
 = 
node
->
Ëv–
;

3003 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 0, 1);

3004 
	`bŒfs_»Ëa£_·th
(
·th
);

3005 ià(
»t
 > 0)

3006 
»t
 = 0;

3008 ià(!
»t
)

3009 
	`upd©e_´oûs£d_blocks
(
rc
, 
node
);

3011 
»t
 = 
	`do_»loÿtiÚ
(
Œªs
, 
rc
, 
node
, 
key
, 
·th
, 1);

3013 
out
:

3014 ià(
»t
 || 
node
->
Ëv–
 =ð0 ||‚ode->
cowÚly
)

3015 
	`»move_back»f_node
(&
rc
->
back»f_ÿche
, 
node
);

3016  
»t
;

3017 
	}
}

3022 
nošlše_fÜ_¡ack


3023 
	$»loÿ‹_Œ“_blocks
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3024 
»loc_cÚŒÞ
 *
rc
, 
rb_roÙ
 *
blocks
)

3026 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3027 
back»f_node
 *
node
;

3028 
bŒfs_·th
 *
·th
;

3029 
Œ“_block
 *
block
;

3030 
rb_node
 *rb_node;

3031 
»t
;

3032 
”r
 = 0;

3034 
·th
 = 
	`bŒfs_®loc_·th
();

3035 ià(!
·th
) {

3036 
”r
 = -
ENOMEM
;

3037 
out_ä“_blocks
;

3040 
rb_node
 = 
	`rb_fœ¡
(
blocks
);

3041 
rb_node
) {

3042 
block
 = 
	`rb_’Œy
(
rb_node
, 
Œ“_block
,„b_node);

3043 ià(!
block
->
key_»ady
)

3044 
	`»adah—d_Œ“_block
(
fs_šfo
, 
block
->
by‹Ä
);

3045 
rb_node
 = 
	`rb_Ãxt
(rb_node);

3048 
rb_node
 = 
	`rb_fœ¡
(
blocks
);

3049 
rb_node
) {

3050 
block
 = 
	`rb_’Œy
(
rb_node
, 
Œ“_block
,„b_node);

3051 ià(!
block
->
key_»ady
) {

3052 
”r
 = 
	`g‘_Œ“_block_key
(
fs_šfo
, 
block
);

3053 ià(
”r
)

3054 
out_ä“_·th
;

3056 
rb_node
 = 
	`rb_Ãxt
(rb_node);

3059 
rb_node
 = 
	`rb_fœ¡
(
blocks
);

3060 
rb_node
) {

3061 
block
 = 
	`rb_’Œy
(
rb_node
, 
Œ“_block
,„b_node);

3063 
node
 = 
	`bužd_back»f_Œ“
(
rc
, &
block
->
key
,

3064 
block
->
Ëv–
, block->
by‹Ä
);

3065 ià(
	`IS_ERR
(
node
)) {

3066 
”r
 = 
	`PTR_ERR
(
node
);

3067 
out
;

3070 
»t
 = 
	`»loÿ‹_Œ“_block
(
Œªs
, 
rc
, 
node
, &
block
->
key
,

3071 
·th
);

3072 ià(
»t
 < 0) {

3073 ià(
»t
 !ð-
EAGAIN
 || 
rb_node
 =ð
	`rb_fœ¡
(
blocks
))

3074 
”r
 = 
»t
;

3075 
out
;

3077 
rb_node
 = 
	`rb_Ãxt
(rb_node);

3079 
out
:

3080 
”r
 = 
	`fšish_³ndšg_nodes
(
Œªs
, 
rc
, 
·th
,ƒrr);

3082 
out_ä“_·th
:

3083 
	`bŒfs_ä“_·th
(
·th
);

3084 
out_ä“_blocks
:

3085 
	`ä“_block_li¡
(
blocks
);

3086  
”r
;

3087 
	}
}

3089 
nošlše_fÜ_¡ack


3090 
	$´—Îoc_fže_ex‹Á_þu¡”
(
šode
 *inode,

3091 
fže_ex‹Á_þu¡”
 *
þu¡”
)

3093 
u64
 
®loc_hšt
 = 0;

3094 
u64
 
¡¬t
;

3095 
u64
 
’d
;

3096 
u64
 
off£t
 = 
	`BTRFS_I
(
šode
)->
šdex_út
;

3097 
u64
 
num_by‹s
;

3098 
Ä
 = 0;

3099 
»t
 = 0;

3100 
u64
 
´—Îoc_¡¬t
 = 
þu¡”
->
¡¬t
 - 
off£t
;

3101 
u64
 
´—Îoc_’d
 = 
þu¡”
->
’d
 - 
off£t
;

3102 
u64
 
cur_off£t
;

3103 
ex‹Á_chªge£t
 *
d©a_»£rved
 = 
NULL
;

3105 
	`BUG_ON
(
þu¡”
->
¡¬t
 !ðþu¡”->
bound¬y
[0]);

3106 
	`šode_lock
(
šode
);

3108 
»t
 = 
	`bŒfs_check_d©a_ä“_¥aû
(
šode
, &
d©a_»£rved
, 
´—Îoc_¡¬t
,

3109 
´—Îoc_’d
 + 1 - 
´—Îoc_¡¬t
);

3110 ià(
»t
)

3111 
out
;

3113 
cur_off£t
 = 
´—Îoc_¡¬t
;

3114 
Ä
 < 
þu¡”
->nr) {

3115 
¡¬t
 = 
þu¡”
->
bound¬y
[
Ä
] - 
off£t
;

3116 ià(
Ä
 + 1 < 
þu¡”
->nr)

3117 
’d
 = 
þu¡”
->
bound¬y
[
Ä
 + 1] - 1 - 
off£t
;

3119 
’d
 = 
þu¡”
->’d - 
off£t
;

3121 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
);

3122 
num_by‹s
 = 
’d
 + 1 - 
¡¬t
;

3123 ià(
cur_off£t
 < 
¡¬t
)

3124 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
d©a_»£rved
,

3125 
cur_off£t
, 
¡¬t
 - cur_offset);

3126 
»t
 = 
	`bŒfs_´—Îoc_fže_¿nge
(
šode
, 0, 
¡¬t
,

3127 
num_by‹s
,‚um_bytes,

3128 
’d
 + 1, &
®loc_hšt
);

3129 
cur_off£t
 = 
’d
 + 1;

3130 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
);

3131 ià(
»t
)

3133 
Ä
++;

3135 ià(
cur_off£t
 < 
´—Îoc_’d
)

3136 
	`bŒfs_ä“_»£rved_d©a_¥aû
(
šode
, 
d©a_»£rved
,

3137 
cur_off£t
, 
´—Îoc_’d
 + 1 - cur_offset);

3138 
out
:

3139 
	`šode_uÆock
(
šode
);

3140 
	`ex‹Á_chªge£t_ä“
(
d©a_»£rved
);

3141  
»t
;

3142 
	}
}

3144 
nošlše_fÜ_¡ack


3145 
	$£tup_ex‹Á_m­pšg
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

3146 
u64
 
block_¡¬t
)

3148 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3149 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
	`BTRFS_I
(
šode
)->
ex‹Á_Œ“
;

3150 
ex‹Á_m­
 *
em
;

3151 
»t
 = 0;

3153 
em
 = 
	`®loc_ex‹Á_m­
();

3154 ià(!
em
)

3155  -
ENOMEM
;

3157 
em
->
¡¬t
 = start;

3158 
em
->
Ën
 = 
’d
 + 1 - 
¡¬t
;

3159 
em
->
block_Ën
 =ƒm->
Ën
;

3160 
em
->
block_¡¬t
 = block_start;

3161 
em
->
bdev
 = 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
;

3162 
	`£t_b™
(
EXTENT_FLAG_PINNED
, &
em
->
æags
);

3164 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
);

3166 
	`wr™e_lock
(&
em_Œ“
->
lock
);

3167 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

3168 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

3169 ià(
»t
 !ð-
EEXIST
) {

3170 
	`ä“_ex‹Á_m­
(
em
);

3173 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 
¡¬t
, 
’d
, 0);

3175 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
¡¬t
, 
’d
);

3176  
»t
;

3177 
	}
}

3179 
	$»loÿ‹_fže_ex‹Á_þu¡”
(
šode
 *inode,

3180 
fže_ex‹Á_þu¡”
 *
þu¡”
)

3182 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

3183 
u64
 
·ge_¡¬t
;

3184 
u64
 
·ge_’d
;

3185 
u64
 
off£t
 = 
	`BTRFS_I
(
šode
)->
šdex_út
;

3186 
šdex
;

3187 
Ï¡_šdex
;

3188 
·ge
 *page;

3189 
fže_¿_¡©e
 *
¿
;

3190 
gå_t
 
mask
 = 
	`bŒfs_®loc_wr™e_mask
(
šode
->
i_m­pšg
);

3191 
Ä
 = 0;

3192 
»t
 = 0;

3194 ià(!
þu¡”
->
Ä
)

3197 
¿
 = 
	`kz®loc
((*¿), 
GFP_NOFS
);

3198 ià(!
¿
)

3199  -
ENOMEM
;

3201 
»t
 = 
	`´—Îoc_fže_ex‹Á_þu¡”
(
šode
, 
þu¡”
);

3202 ià(
»t
)

3203 
out
;

3205 
	`fže_¿_¡©e_š™
(
¿
, 
šode
->
i_m­pšg
);

3207 
»t
 = 
	`£tup_ex‹Á_m­pšg
(
šode
, 
þu¡”
->
¡¬t
 - 
off£t
,

3208 
þu¡”
->
’d
 - 
off£t
, clu¡”->
¡¬t
);

3209 ià(
»t
)

3210 
out
;

3212 
šdex
 = (
þu¡”
->
¡¬t
 - 
off£t
è>> 
PAGE_SHIFT
;

3213 
Ï¡_šdex
 = (
þu¡”
->
’d
 - 
off£t
è>> 
PAGE_SHIFT
;

3214 
šdex
 <ð
Ï¡_šdex
) {

3215 
»t
 = 
	`bŒfs_d–®loc_»£rve_m‘ad©a
(
	`BTRFS_I
(
šode
),

3216 
PAGE_SIZE
);

3217 ià(
»t
)

3218 
out
;

3220 
·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
, 
šdex
);

3221 ià(!
·ge
) {

3222 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
,

3223 
¿
, 
NULL
, 
šdex
,

3224 
Ï¡_šdex
 + 1 - 
šdex
);

3225 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
,

3226 
mask
);

3227 ià(!
·ge
) {

3228 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

3229 
PAGE_SIZE
);

3230 
»t
 = -
ENOMEM
;

3231 
out
;

3235 ià(
	`PageR—dah—d
(
·ge
)) {

3236 
	`·ge_ÿche_async_»adah—d
(
šode
->
i_m­pšg
,

3237 
¿
, 
NULL
, 
·ge
, 
šdex
,

3238 
Ï¡_šdex
 + 1 - 
šdex
);

3241 ià(!
	`PageU±od©e
(
·ge
)) {

3242 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

3243 
	`lock_·ge
(
·ge
);

3244 ià(!
	`PageU±od©e
(
·ge
)) {

3245 
	`uÆock_·ge
(
·ge
);

3246 
	`put_·ge
(
·ge
);

3247 
	`bŒfs_d–®loc_»Ëa£_m‘ad©a
(
	`BTRFS_I
(
šode
),

3248 
PAGE_SIZE
);

3249 
»t
 = -
EIO
;

3250 
out
;

3254 
·ge_¡¬t
 = 
	`·ge_off£t
(
·ge
);

3255 
·ge_’d
 = 
·ge_¡¬t
 + 
PAGE_SIZE
 - 1;

3257 
	`lock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge_¡¬t
, 
·ge_’d
);

3259 
	`£t_·ge_ex‹Á_m­³d
(
·ge
);

3261 ià(
Ä
 < 
þu¡”
->nr &&

3262 
·ge_¡¬t
 + 
off£t
 =ð
þu¡”
->
bound¬y
[
Ä
]) {

3263 
	`£t_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

3264 
·ge_¡¬t
, 
·ge_’d
,

3265 
EXTENT_BOUNDARY
);

3266 
Ä
++;

3269 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
·ge_¡¬t
, 
·ge_’d
, 
NULL
, 0);

3270 
	`£t_·ge_dœty
(
·ge
);

3272 
	`uÆock_ex‹Á
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

3273 
·ge_¡¬t
, 
·ge_’d
);

3274 
	`uÆock_·ge
(
·ge
);

3275 
	`put_·ge
(
·ge
);

3277 
šdex
++;

3278 
	`b®ªû_dœty_·ges_¿‹lim™ed
(
šode
->
i_m­pšg
);

3279 
	`bŒfs_thrÙŽe
(
fs_šfo
);

3281 
	`WARN_ON
(
Ä
 !ð
þu¡”
->nr);

3282 
out
:

3283 
	`kä“
(
¿
);

3284  
»t
;

3285 
	}
}

3287 
nošlše_fÜ_¡ack


3288 
	$»loÿ‹_d©a_ex‹Á
(
šode
 *šode, 
bŒfs_key
 *
ex‹Á_key
,

3289 
fže_ex‹Á_þu¡”
 *
þu¡”
)

3291 
»t
;

3293 ià(
þu¡”
->
Ä
 > 0 && 
ex‹Á_key
->
objeùid
 !ðþu¡”->
’d
 + 1) {

3294 
»t
 = 
	`»loÿ‹_fže_ex‹Á_þu¡”
(
šode
, 
þu¡”
);

3295 ià(
»t
)

3296  
»t
;

3297 
þu¡”
->
Ä
 = 0;

3300 ià(!
þu¡”
->
Ä
)

3301 
þu¡”
->
¡¬t
 = 
ex‹Á_key
->
objeùid
;

3303 
	`BUG_ON
(
þu¡”
->
Ä
 >ð
MAX_EXTENTS
);

3304 
þu¡”
->
’d
 = 
ex‹Á_key
->
objeùid
 +ƒx‹Á_key->
off£t
 - 1;

3305 
þu¡”
->
bound¬y
[þu¡”->
Ä
] = 
ex‹Á_key
->
objeùid
;

3306 
þu¡”
->
Ä
++;

3308 ià(
þu¡”
->
Ä
 >ð
MAX_EXTENTS
) {

3309 
»t
 = 
	`»loÿ‹_fže_ex‹Á_þu¡”
(
šode
, 
þu¡”
);

3310 ià(
»t
)

3311  
»t
;

3312 
þu¡”
->
Ä
 = 0;

3315 
	}
}

3317 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


3318 
	$g‘_»f_objeùid_v0
(
»loc_cÚŒÞ
 *
rc
,

3319 
bŒfs_·th
 *
·th
,

3320 
bŒfs_key
 *
ex‹Á_key
,

3321 
u64
 *
»f_objeùid
, *
·th_chªge
)

3323 
bŒfs_key
 
key
;

3324 
ex‹Á_bufãr
 *
Ëaf
;

3325 
bŒfs_ex‹Á_»f_v0
 *
»f0
;

3326 
»t
;

3327 
¦Ù
;

3329 
Ëaf
 = 
·th
->
nodes
[0];

3330 
¦Ù
 = 
·th
->
¦Ùs
[0];

3332 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

3333 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
rc
->
ex‹Á_roÙ
, 
·th
);

3334 ià(
»t
 < 0)

3335  
»t
;

3336 
	`BUG_ON
(
»t
 > 0);

3337 
Ëaf
 = 
·th
->
nodes
[0];

3338 
¦Ù
 = 
·th
->
¦Ùs
[0];

3339 ià(
·th_chªge
)

3340 *
·th_chªge
 = 1;

3342 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

3343 ià(
key
.
objeùid
 !ð
ex‹Á_key
->objectid)

3344  -
ENOENT
;

3346 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_REF_V0_KEY
) {

3347 
¦Ù
++;

3350 
»f0
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

3351 
bŒfs_ex‹Á_»f_v0
);

3352 *
»f_objeùid
 = 
	`bŒfs_»f_objeùid_v0
(
Ëaf
, 
»f0
);

3356 
	}
}

3363 
	$add_Œ“_block
(
»loc_cÚŒÞ
 *
rc
,

3364 
bŒfs_key
 *
ex‹Á_key
,

3365 
bŒfs_·th
 *
·th
,

3366 
rb_roÙ
 *
blocks
)

3368 
ex‹Á_bufãr
 *
eb
;

3369 
bŒfs_ex‹Á_™em
 *
ei
;

3370 
bŒfs_Œ“_block_šfo
 *
bi
;

3371 
Œ“_block
 *
block
;

3372 
rb_node
 *rb_node;

3373 
u32
 
™em_size
;

3374 
Ëv–
 = -1;

3375 
u64
 
g’”©iÚ
;

3377 
eb
 = 
·th
->
nodes
[0];

3378 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
·th
->
¦Ùs
[0]);

3380 ià(
ex‹Á_key
->
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
 ||

3381 
™em_size
 >ð(*
ei
è+ (*
bi
)) {

3382 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0],

3383 
bŒfs_ex‹Á_™em
);

3384 ià(
ex‹Á_key
->
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
) {

3385 
bi
 = (
bŒfs_Œ“_block_šfo
 *)(
ei
 + 1);

3386 
Ëv–
 = 
	`bŒfs_Œ“_block_Ëv–
(
eb
, 
bi
);

3388 
Ëv–
 = ()
ex‹Á_key
->
off£t
;

3390 
g’”©iÚ
 = 
	`bŒfs_ex‹Á_g’”©iÚ
(
eb
, 
ei
);

3392 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


3393 
u64
 
»f_owÃr
;

3394 
»t
;

3396 
	`BUG_ON
(
™em_size
 !ð(
bŒfs_ex‹Á_™em_v0
));

3397 
»t
 = 
	`g‘_»f_objeùid_v0
(
rc
, 
·th
, 
ex‹Á_key
,

3398 &
»f_owÃr
, 
NULL
);

3399 ià(
»t
 < 0)

3400  
»t
;

3401 
	`BUG_ON
(
»f_owÃr
 >ð
BTRFS_MAX_LEVEL
);

3402 
Ëv–
 = ()
»f_owÃr
;

3404 
g’”©iÚ
 = 0;

3406 
	`BUG
();

3410 
	`bŒfs_»Ëa£_·th
(
·th
);

3412 
	`BUG_ON
(
Ëv–
 == -1);

3414 
block
 = 
	`km®loc
((*block), 
GFP_NOFS
);

3415 ià(!
block
)

3416  -
ENOMEM
;

3418 
block
->
by‹Ä
 = 
ex‹Á_key
->
objeùid
;

3419 
block
->
key
.
objeùid
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

3420 
block
->
key
.
off£t
 = 
g’”©iÚ
;

3421 
block
->
Ëv–
 =†evel;

3422 
block
->
key_»ady
 = 0;

3424 
rb_node
 = 
	`Œ“_š£¹
(
blocks
, 
block
->
by‹Ä
, &block->rb_node);

3425 ià(
rb_node
)

3426 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
, 
block
->
by‹Ä
);

3429 
	}
}

3434 
	$__add_Œ“_block
(
»loc_cÚŒÞ
 *
rc
,

3435 
u64
 
by‹Ä
, 
u32
 
blocksize
,

3436 
rb_roÙ
 *
blocks
)

3438 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3439 
bŒfs_·th
 *
·th
;

3440 
bŒfs_key
 
key
;

3441 
»t
;

3442 
boÞ
 
skšny
 = 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
);

3444 ià(
	`Œ“_block_´oûs£d
(
by‹Ä
, 
rc
))

3447 ià(
	`Œ“_£¬ch
(
blocks
, 
by‹Ä
))

3450 
·th
 = 
	`bŒfs_®loc_·th
();

3451 ià(!
·th
)

3452  -
ENOMEM
;

3453 
agaš
:

3454 
key
.
objeùid
 = 
by‹Ä
;

3455 ià(
skšny
) {

3456 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

3457 
key
.
off£t
 = (
u64
)-1;

3459 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3460 
key
.
off£t
 = 
blocksize
;

3463 
·th
->
£¬ch_comm™_roÙ
 = 1;

3464 
·th
->
sk_lockšg
 = 1;

3465 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
rc
->
ex‹Á_roÙ
, &
key
, 
·th
, 0, 0);

3466 ià(
»t
 < 0)

3467 
out
;

3469 ià(
»t
 > 0 && 
skšny
) {

3470 ià(
·th
->
¦Ùs
[0]) {

3471 
·th
->
¦Ùs
[0]--;

3472 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

3473 
·th
->
¦Ùs
[0]);

3474 ià(
key
.
objeùid
 =ð
by‹Ä
 &&

3475 (
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
 ||

3476 (
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

3477 
key
.
off£t
 =ð
blocksize
)))

3478 
»t
 = 0;

3481 ià(
»t
) {

3482 
skšny
 = 
çl£
;

3483 
	`bŒfs_»Ëa£_·th
(
·th
);

3484 
agaš
;

3487 ià(
»t
) {

3488 
	`ASSERT
(
»t
 == 1);

3489 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

3490 
	`bŒfs_”r
(
fs_šfo
,

3492 
by‹Ä
);

3493 
	`WARN_ON
(1);

3494 
»t
 = -
EINVAL
;

3495 
out
;

3498 
»t
 = 
	`add_Œ“_block
(
rc
, &
key
, 
·th
, 
blocks
);

3499 
out
:

3500 
	`bŒfs_ä“_·th
(
·th
);

3501  
»t
;

3502 
	}
}

3507 
	$block_u£_fuÎ_back»f
(
»loc_cÚŒÞ
 *
rc
,

3508 
ex‹Á_bufãr
 *
eb
)

3510 
u64
 
æags
;

3511 
»t
;

3513 ià(
	`bŒfs_h—d”_æag
(
eb
, 
BTRFS_HEADER_FLAG_RELOC
) ||

3514 
	`bŒfs_h—d”_back»f_»v
(
eb
è< 
BTRFS_MIXED_BACKREF_REV
)

3517 
»t
 = 
	`bŒfs_lookup_ex‹Á_šfo
(
NULL
, 
rc
->
ex‹Á_roÙ
->
fs_šfo
,

3518 
eb
->
¡¬t
, 
	`bŒfs_h—d”_Ëv–
(eb), 1,

3519 
NULL
, &
æags
);

3520 
	`BUG_ON
(
»t
);

3522 ià(
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
)

3523 
»t
 = 1;

3525 
»t
 = 0;

3526  
»t
;

3527 
	}
}

3529 
	$d–‘e_block_group_ÿche
(
bŒfs_fs_šfo
 *
fs_šfo
,

3530 
bŒfs_block_group_ÿche
 *
block_group
,

3531 
šode
 *inode,

3532 
u64
 
šo
)

3534 
bŒfs_key
 
key
;

3535 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3536 
bŒfs_Œªs_hªdË
 *
Œªs
;

3537 
»t
 = 0;

3539 ià(
šode
)

3540 
Œunÿ‹
;

3542 
key
.
objeùid
 = 
šo
;

3543 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

3544 
key
.
off£t
 = 0;

3546 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
roÙ
, 
NULL
);

3547 ià(
	`IS_ERR
(
šode
è|| 
	`is_bad_šode
(inode)) {

3548 ià(!
	`IS_ERR
(
šode
))

3549 
	`ut
(
šode
);

3550  -
ENOENT
;

3553 
Œunÿ‹
:

3554 
»t
 = 
	`bŒfs_check_Œunc_ÿche_ä“_¥aû
(
fs_šfo
,

3555 &
fs_šfo
->
glob®_block_rsv
);

3556 ià(
»t
)

3557 
out
;

3559 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3560 ià(
	`IS_ERR
(
Œªs
)) {

3561 
»t
 = 
	`PTR_ERR
(
Œªs
);

3562 
out
;

3565 
»t
 = 
	`bŒfs_Œunÿ‹_ä“_¥aû_ÿche
(
Œªs
, 
block_group
, 
šode
);

3567 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3568 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

3569 
out
:

3570 
	`ut
(
šode
);

3571  
»t
;

3572 
	}
}

3578 
	$fšd_d©a_»ã»nûs
(
»loc_cÚŒÞ
 *
rc
,

3579 
bŒfs_key
 *
ex‹Á_key
,

3580 
ex‹Á_bufãr
 *
Ëaf
,

3581 
bŒfs_ex‹Á_d©a_»f
 *
»f
,

3582 
rb_roÙ
 *
blocks
)

3584 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3585 
bŒfs_·th
 *
·th
;

3586 
Œ“_block
 *
block
;

3587 
bŒfs_roÙ
 *
roÙ
;

3588 
bŒfs_fže_ex‹Á_™em
 *
fi
;

3589 
rb_node
 *rb_node;

3590 
bŒfs_key
 
key
;

3591 
u64
 
»f_roÙ
;

3592 
u64
 
»f_objeùid
;

3593 
u64
 
»f_off£t
;

3594 
u32
 
»f_couÁ
;

3595 
u32
 
Ä™ems
;

3596 
”r
 = 0;

3597 
added
 = 0;

3598 
couÁed
;

3599 
»t
;

3601 
»f_roÙ
 = 
	`bŒfs_ex‹Á_d©a_»f_roÙ
(
Ëaf
, 
»f
);

3602 
»f_objeùid
 = 
	`bŒfs_ex‹Á_d©a_»f_objeùid
(
Ëaf
, 
»f
);

3603 
»f_off£t
 = 
	`bŒfs_ex‹Á_d©a_»f_off£t
(
Ëaf
, 
»f
);

3604 
»f_couÁ
 = 
	`bŒfs_ex‹Á_d©a_»f_couÁ
(
Ëaf
, 
»f
);

3610 ià(
»f_roÙ
 =ð
BTRFS_ROOT_TREE_OBJECTID
) {

3611 
»t
 = 
	`d–‘e_block_group_ÿche
(
fs_šfo
, 
rc
->
block_group
,

3612 
NULL
, 
»f_objeùid
);

3613 ià(
»t
 !ð-
ENOENT
)

3614  
»t
;

3615 
»t
 = 0;

3618 
·th
 = 
	`bŒfs_®loc_·th
();

3619 ià(!
·th
)

3620  -
ENOMEM
;

3621 
·th
->
»ada
 = 
READA_FORWARD
;

3623 
roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
, 
»f_roÙ
);

3624 ià(
	`IS_ERR
(
roÙ
)) {

3625 
”r
 = 
	`PTR_ERR
(
roÙ
);

3626 
out
;

3629 
key
.
objeùid
 = 
»f_objeùid
;

3630 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

3631 ià(
»f_off£t
 > ((
u64
)-1 << 32))

3632 
key
.
off£t
 = 0;

3634 
key
.
off£t
 = 
»f_off£t
;

3636 
·th
->
£¬ch_comm™_roÙ
 = 1;

3637 
·th
->
sk_lockšg
 = 1;

3638 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3639 ià(
»t
 < 0) {

3640 
”r
 = 
»t
;

3641 
out
;

3644 
Ëaf
 = 
·th
->
nodes
[0];

3645 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

3650 ià(
	`block_u£_fuÎ_back»f
(
rc
, 
Ëaf
))

3651 
couÁed
 = 0;

3653 
couÁed
 = 1;

3654 
rb_node
 = 
	`Œ“_£¬ch
(
blocks
, 
Ëaf
->
¡¬t
);

3655 ià(
rb_node
) {

3656 ià(
couÁed
)

3657 
added
 = 1;

3659 
·th
->
¦Ùs
[0] = 
Ä™ems
;

3662 
»f_couÁ
 > 0) {

3663 
·th
->
¦Ùs
[0] >ð
Ä™ems
) {

3664 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3665 ià(
»t
 < 0) {

3666 
”r
 = 
»t
;

3667 
out
;

3669 ià(
	`WARN_ON
(
»t
 > 0))

3670 
out
;

3672 
Ëaf
 = 
·th
->
nodes
[0];

3673 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

3674 
added
 = 0;

3676 ià(
	`block_u£_fuÎ_back»f
(
rc
, 
Ëaf
))

3677 
couÁed
 = 0;

3679 
couÁed
 = 1;

3680 
rb_node
 = 
	`Œ“_£¬ch
(
blocks
, 
Ëaf
->
¡¬t
);

3681 ià(
rb_node
) {

3682 ià(
couÁed
)

3683 
added
 = 1;

3685 
·th
->
¦Ùs
[0] = 
Ä™ems
;

3689 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

3690 ià(
	`WARN_ON
(
key
.
objeùid
 !ð
»f_objeùid
 ||

3691 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
))

3694 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3695 
bŒfs_fže_ex‹Á_™em
);

3697 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
) ==

3698 
BTRFS_FILE_EXTENT_INLINE
)

3699 
Ãxt
;

3701 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
) !=

3702 
ex‹Á_key
->
objeùid
)

3703 
Ãxt
;

3705 
key
.
off£t
 -ð
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
fi
);

3706 ià(
key
.
off£t
 !ð
»f_off£t
)

3707 
Ãxt
;

3709 ià(
couÁed
)

3710 
»f_couÁ
--;

3711 ià(
added
)

3712 
Ãxt
;

3714 ià(!
	`Œ“_block_´oûs£d
(
Ëaf
->
¡¬t
, 
rc
)) {

3715 
block
 = 
	`km®loc
((*block), 
GFP_NOFS
);

3716 ià(!
block
) {

3717 
”r
 = -
ENOMEM
;

3720 
block
->
by‹Ä
 = 
Ëaf
->
¡¬t
;

3721 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
block
->
key
, 0);

3722 
block
->
Ëv–
 = 0;

3723 
block
->
key_»ady
 = 1;

3724 
rb_node
 = 
	`Œ“_š£¹
(
blocks
, 
block
->
by‹Ä
,

3725 &
block
->
rb_node
);

3726 ià(
rb_node
)

3727 
	`back»f_Œ“_·nic
(
rb_node
, -
EEXIST
,

3728 
block
->
by‹Ä
);

3730 ià(
couÁed
)

3731 
added
 = 1;

3733 
·th
->
¦Ùs
[0] = 
Ä™ems
;

3734 
Ãxt
:

3735 
·th
->
¦Ùs
[0]++;

3738 
out
:

3739 
	`bŒfs_ä“_·th
(
·th
);

3740  
”r
;

3741 
	}
}

3746 
nošlše_fÜ_¡ack


3747 
	$add_d©a_»ã»nûs
(
»loc_cÚŒÞ
 *
rc
,

3748 
bŒfs_key
 *
ex‹Á_key
,

3749 
bŒfs_·th
 *
·th
,

3750 
rb_roÙ
 *
blocks
)

3752 
bŒfs_key
 
key
;

3753 
ex‹Á_bufãr
 *
eb
;

3754 
bŒfs_ex‹Á_d©a_»f
 *
d»f
;

3755 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

3756 
±r
;

3757 
’d
;

3758 
u32
 
blocksize
 = 
rc
->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
;

3759 
»t
 = 0;

3760 
”r
 = 0;

3762 
eb
 = 
·th
->
nodes
[0];

3763 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
·th
->
¦Ùs
[0]);

3764 
’d
 = 
±r
 + 
	`bŒfs_™em_size_Ä
(
eb
, 
·th
->
¦Ùs
[0]);

3765 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


3766 ià(
±r
 + (
bŒfs_ex‹Á_™em_v0
è=ð
’d
)

3767 
±r
 = 
’d
;

3770 
±r
 +ð(
bŒfs_ex‹Á_™em
);

3772 
±r
 < 
’d
) {

3773 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)
±r
;

3774 
key
.
ty³
 = 
	`bŒfs_g‘_ex‹Á_šlše_»f_ty³
(
eb
, 
œef
,

3775 
BTRFS_REF_TYPE_DATA
);

3776 ià(
key
.
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

3777 
key
.
off£t
 = 
	`bŒfs_ex‹Á_šlše_»f_off£t
(
eb
, 
œef
);

3778 
»t
 = 
	`__add_Œ“_block
(
rc
, 
key
.
off£t
, 
blocksize
,

3779 
blocks
);

3780 } ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

3781 
d»f
 = (
bŒfs_ex‹Á_d©a_»f
 *)(&
œef
->
off£t
);

3782 
»t
 = 
	`fšd_d©a_»ã»nûs
(
rc
, 
ex‹Á_key
,

3783 
eb
, 
d»f
, 
blocks
);

3785 
»t
 = -
EINVAL
;

3786 
	`bŒfs_”r
(
rc
->
ex‹Á_roÙ
->
fs_šfo
,

3788 
eb
->
¡¬t
, 
·th
->
¦Ùs
[0]);

3790 ià(
»t
) {

3791 
”r
 = 
»t
;

3792 
out
;

3794 
±r
 +ð
	`bŒfs_ex‹Á_šlše_»f_size
(
key
.
ty³
);

3796 
	`WARN_ON
(
±r
 > 
’d
);

3799 
	`cÚd_»sched
();

3800 
eb
 = 
·th
->
nodes
[0];

3801 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

3802 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
rc
->
ex‹Á_roÙ
, 
·th
);

3803 ià(
»t
 < 0) {

3804 
”r
 = 
»t
;

3807 ià(
»t
 > 0)

3809 
eb
 = 
·th
->
nodes
[0];

3812 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
·th
->
¦Ùs
[0]);

3813 ià(
key
.
objeùid
 !ð
ex‹Á_key
->objectid)

3816 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


3817 ià(
key
.
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
 ||

3818 
key
.
ty³
 =ð
BTRFS_EXTENT_REF_V0_KEY
) {

3820 
	`BUG_ON
(
key
.
ty³
 =ð
BTRFS_EXTENT_REF_V0_KEY
);

3821 ià(
key
.
ty³
 =ð
BTRFS_SHARED_DATA_REF_KEY
) {

3823 
»t
 = 
	`__add_Œ“_block
(
rc
, 
key
.
off£t
, 
blocksize
,

3824 
blocks
);

3825 } ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_REF_KEY
) {

3826 
d»f
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0],

3827 
bŒfs_ex‹Á_d©a_»f
);

3828 
»t
 = 
	`fšd_d©a_»ã»nûs
(
rc
, 
ex‹Á_key
,

3829 
eb
, 
d»f
, 
blocks
);

3831 
»t
 = 0;

3833 ià(
»t
) {

3834 
”r
 = 
»t
;

3837 
·th
->
¦Ùs
[0]++;

3839 
out
:

3840 
	`bŒfs_»Ëa£_·th
(
·th
);

3841 ià(
”r
)

3842 
	`ä“_block_li¡
(
blocks
);

3843  
”r
;

3844 
	}
}

3849 
nošlše_fÜ_¡ack


3850 
	$fšd_Ãxt_ex‹Á
(
»loc_cÚŒÞ
 *
rc
, 
bŒfs_·th
 *
·th
,

3851 
bŒfs_key
 *
ex‹Á_key
)

3853 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3854 
bŒfs_key
 
key
;

3855 
ex‹Á_bufãr
 *
Ëaf
;

3856 
u64
 
¡¬t
, 
’d
, 
Ï¡
;

3857 
»t
;

3859 
Ï¡
 = 
rc
->
block_group
->
key
.
objeùid
 +„c->block_group->key.
off£t
;

3861 
	`cÚd_»sched
();

3862 ià(
rc
->
£¬ch_¡¬t
 >ð
Ï¡
) {

3863 
»t
 = 1;

3867 
key
.
objeùid
 = 
rc
->
£¬ch_¡¬t
;

3868 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3869 
key
.
off£t
 = 0;

3871 
·th
->
£¬ch_comm™_roÙ
 = 1;

3872 
·th
->
sk_lockšg
 = 1;

3873 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
rc
->
ex‹Á_roÙ
, &
key
, 
·th
,

3875 ià(
»t
 < 0)

3877 
Ãxt
:

3878 
Ëaf
 = 
·th
->
nodes
[0];

3879 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

3880 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
rc
->
ex‹Á_roÙ
, 
·th
);

3881 ià(
»t
 != 0)

3883 
Ëaf
 = 
·th
->
nodes
[0];

3886 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

3887 ià(
key
.
objeùid
 >ð
Ï¡
) {

3888 
»t
 = 1;

3892 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_ITEM_KEY
 &&

3893 
key
.
ty³
 !ð
BTRFS_METADATA_ITEM_KEY
) {

3894 
·th
->
¦Ùs
[0]++;

3895 
Ãxt
;

3898 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
 &&

3899 
key
.
objeùid
 + key.
off£t
 <ð
rc
->
£¬ch_¡¬t
) {

3900 
·th
->
¦Ùs
[0]++;

3901 
Ãxt
;

3904 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
 &&

3905 
key
.
objeùid
 + 
fs_šfo
->
nodesize
 <=

3906 
rc
->
£¬ch_¡¬t
) {

3907 
·th
->
¦Ùs
[0]++;

3908 
Ãxt
;

3911 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(&
rc
->
´oûs£d_blocks
,

3912 
key
.
objeùid
, &
¡¬t
, &
’d
,

3913 
EXTENT_DIRTY
, 
NULL
);

3915 ià(
»t
 =ð0 && 
¡¬t
 <ð
key
.
objeùid
) {

3916 
	`bŒfs_»Ëa£_·th
(
·th
);

3917 
rc
->
£¬ch_¡¬t
 = 
’d
 + 1;

3919 ià(
key
.
ty³
 =ð
BTRFS_EXTENT_ITEM_KEY
)

3920 
rc
->
£¬ch_¡¬t
 = 
key
.
objeùid
 + key.
off£t
;

3922 
rc
->
£¬ch_¡¬t
 = 
key
.
objeùid
 +

3923 
fs_šfo
->
nodesize
;

3924 
	`memýy
(
ex‹Á_key
, &
key
, (key));

3928 
	`bŒfs_»Ëa£_·th
(
·th
);

3929  
»t
;

3930 
	}
}

3932 
	$£t_»loc_cÚŒÞ
(
»loc_cÚŒÞ
 *
rc
)

3934 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3936 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

3937 
fs_šfo
->
»loc_ùl
 = 
rc
;

3938 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

3939 
	}
}

3941 
	$un£t_»loc_cÚŒÞ
(
»loc_cÚŒÞ
 *
rc
)

3943 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

3945 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

3946 
fs_šfo
->
»loc_ùl
 = 
NULL
;

3947 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

3948 
	}
}

3950 
	$check_ex‹Á_æags
(
u64
 
æags
)

3952 ià((
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) &&

3953 (
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
))

3955 ià(!(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) &&

3956 !(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
))

3958 ià((
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) &&

3959 (
æags
 & 
BTRFS_BLOCK_FLAG_FULL_BACKREF
))

3962 
	}
}

3964 
nošlše_fÜ_¡ack


3965 
	$´•¬e_to_»loÿ‹
(
»loc_cÚŒÞ
 *
rc
)

3967 
bŒfs_Œªs_hªdË
 *
Œªs
;

3968 
»t
;

3970 
rc
->
block_rsv
 = 
	`bŒfs_®loc_block_rsv
Ôc->
ex‹Á_roÙ
->
fs_šfo
,

3971 
BTRFS_BLOCK_RSV_TEMP
);

3972 ià(!
rc
->
block_rsv
)

3973  -
ENOMEM
;

3975 
	`mem£t
(&
rc
->
þu¡”
, 0, (rc->cluster));

3976 
rc
->
£¬ch_¡¬t
 =„c->
block_group
->
key
.
objeùid
;

3977 
rc
->
ex‹Ás_found
 = 0;

3978 
rc
->
nodes_»loÿ‹d
 = 0;

3979 
rc
->
m”gšg_rsv_size
 = 0;

3980 
rc
->
»£rved_by‹s
 = 0;

3981 
rc
->
block_rsv
->
size
 =„c->
ex‹Á_roÙ
->
fs_šfo
->
nodesize
 *

3982 
RELOCATION_RESERVED_NODES
;

3983 
»t
 = 
	`bŒfs_block_rsv_»fžl
(
rc
->
ex‹Á_roÙ
,

3984 
rc
->
block_rsv
,„c->block_rsv->
size
,

3985 
BTRFS_RESERVE_FLUSH_ALL
);

3986 ià(
»t
)

3987  
»t
;

3989 
rc
->
ü—‹_»loc_Œ“
 = 1;

3990 
	`£t_»loc_cÚŒÞ
(
rc
);

3992 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

3993 ià(
	`IS_ERR
(
Œªs
)) {

3994 
	`un£t_»loc_cÚŒÞ
(
rc
);

4000  
	`PTR_ERR
(
Œªs
);

4002 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4004 
	}
}

4006 
nošlše_fÜ_¡ack
 
	$»loÿ‹_block_group
(
»loc_cÚŒÞ
 *
rc
)

4008 
bŒfs_fs_šfo
 *
fs_šfo
 = 
rc
->
ex‹Á_roÙ
->fs_info;

4009 
rb_roÙ
 
blocks
 = 
RB_ROOT
;

4010 
bŒfs_key
 
key
;

4011 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

4012 
bŒfs_·th
 *
·th
;

4013 
bŒfs_ex‹Á_™em
 *
ei
;

4014 
u64
 
æags
;

4015 
u32
 
™em_size
;

4016 
»t
;

4017 
”r
 = 0;

4018 
´og»ss
 = 0;

4020 
·th
 = 
	`bŒfs_®loc_·th
();

4021 ià(!
·th
)

4022  -
ENOMEM
;

4023 
·th
->
»ada
 = 
READA_FORWARD
;

4025 
»t
 = 
	`´•¬e_to_»loÿ‹
(
rc
);

4026 ià(
»t
) {

4027 
”r
 = 
»t
;

4028 
out_ä“
;

4032 
rc
->
»£rved_by‹s
 = 0;

4033 
»t
 = 
	`bŒfs_block_rsv_»fžl
(
rc
->
ex‹Á_roÙ
,

4034 
rc
->
block_rsv
,„c->block_rsv->
size
,

4035 
BTRFS_RESERVE_FLUSH_ALL
);

4036 ià(
»t
) {

4037 
”r
 = 
»t
;

4040 
´og»ss
++;

4041 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
, 0);

4042 ià(
	`IS_ERR
(
Œªs
)) {

4043 
”r
 = 
	`PTR_ERR
(
Œªs
);

4044 
Œªs
 = 
NULL
;

4047 
»¡¬t
:

4048 ià(
	`upd©e_back»f_ÿche
(
Œªs
, &
rc
->
back»f_ÿche
)) {

4049 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4053 
»t
 = 
	`fšd_Ãxt_ex‹Á
(
rc
, 
·th
, &
key
);

4054 ià(
»t
 < 0)

4055 
”r
 = 
»t
;

4056 ià(
»t
 != 0)

4059 
rc
->
ex‹Ás_found
++;

4061 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

4062 
bŒfs_ex‹Á_™em
);

4063 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

4064 ià(
™em_size
 >ð(*
ei
)) {

4065 
æags
 = 
	`bŒfs_ex‹Á_æags
(
·th
->
nodes
[0], 
ei
);

4066 
»t
 = 
	`check_ex‹Á_æags
(
æags
);

4067 
	`BUG_ON
(
»t
);

4070 #ifdeà
BTRFS_COMPAT_EXTENT_TREE_V0


4071 
u64
 
»f_owÃr
;

4072 
·th_chªge
 = 0;

4074 
	`BUG_ON
(
™em_size
 !=

4075 (
bŒfs_ex‹Á_™em_v0
));

4076 
»t
 = 
	`g‘_»f_objeùid_v0
(
rc
, 
·th
, &
key
, &
»f_owÃr
,

4077 &
·th_chªge
);

4078 ià(
»t
 < 0) {

4079 
”r
 = 
»t
;

4082 ià(
»f_owÃr
 < 
BTRFS_FIRST_FREE_OBJECTID
)

4083 
æags
 = 
BTRFS_EXTENT_FLAG_TREE_BLOCK
;

4085 
æags
 = 
BTRFS_EXTENT_FLAG_DATA
;

4087 ià(
·th_chªge
) {

4088 
	`bŒfs_»Ëa£_·th
(
·th
);

4090 
·th
->
£¬ch_comm™_roÙ
 = 1;

4091 
·th
->
sk_lockšg
 = 1;

4092 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
rc
->
ex‹Á_roÙ
,

4093 &
key
, 
·th
, 0, 0);

4094 ià(
»t
 < 0) {

4095 
”r
 = 
»t
;

4098 
	`BUG_ON
(
»t
 > 0);

4101 
	`BUG
();

4105 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

4106 
»t
 = 
	`add_Œ“_block
(
rc
, &
key
, 
·th
, &
blocks
);

4107 } ià(
rc
->
¡age
 =ð
UPDATE_DATA_PTRS
 &&

4108 (
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)) {

4109 
»t
 = 
	`add_d©a_»ã»nûs
(
rc
, &
key
, 
·th
, &
blocks
);

4111 
	`bŒfs_»Ëa£_·th
(
·th
);

4112 
»t
 = 0;

4114 ià(
»t
 < 0) {

4115 
”r
 = 
»t
;

4119 ià(!
	`RB_EMPTY_ROOT
(&
blocks
)) {

4120 
»t
 = 
	`»loÿ‹_Œ“_blocks
(
Œªs
, 
rc
, &
blocks
);

4121 ià(
»t
 < 0) {

4126 
rc
->
back»f_ÿche
.
Ï¡_Œªs
 = 
Œªs
->
Œªsid
 - 1;

4128 ià(
»t
 !ð-
EAGAIN
) {

4129 
”r
 = 
»t
;

4132 
rc
->
ex‹Ás_found
--;

4133 
rc
->
£¬ch_¡¬t
 = 
key
.
objeùid
;

4137 
	`bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
Œªs
);

4138 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

4139 
Œªs
 = 
NULL
;

4141 ià(
rc
->
¡age
 =ð
MOVE_DATA_EXTENTS
 &&

4142 (
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)) {

4143 
rc
->
found_fže_ex‹Á
 = 1;

4144 
»t
 = 
	`»loÿ‹_d©a_ex‹Á
(
rc
->
d©a_šode
,

4145 &
key
, &
rc
->
þu¡”
);

4146 ià(
»t
 < 0) {

4147 
”r
 = 
»t
;

4152 ià(
Œªs
 && 
´og»ss
 && 
”r
 =ð-
ENOSPC
) {

4153 
»t
 = 
	`bŒfs_fÜû_chunk_®loc
(
Œªs
, 
fs_šfo
,

4154 
rc
->
block_group
->
æags
);

4155 ià(
»t
 == 1) {

4156 
”r
 = 0;

4157 
´og»ss
 = 0;

4158 
»¡¬t
;

4162 
	`bŒfs_»Ëa£_·th
(
·th
);

4163 
	`þ—r_ex‹Á_b™s
(&
rc
->
´oûs£d_blocks
, 0, (
u64
)-1, 
EXTENT_DIRTY
);

4165 ià(
Œªs
) {

4166 
	`bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
Œªs
);

4167 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

4170 ià(!
”r
) {

4171 
»t
 = 
	`»loÿ‹_fže_ex‹Á_þu¡”
(
rc
->
d©a_šode
,

4172 &
rc
->
þu¡”
);

4173 ià(
»t
 < 0)

4174 
”r
 = 
»t
;

4177 
rc
->
ü—‹_»loc_Œ“
 = 0;

4178 
	`£t_»loc_cÚŒÞ
(
rc
);

4180 
	`back»f_ÿche_þ—nup
(&
rc
->
back»f_ÿche
);

4181 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
, (
u64
)-1);

4183 
”r
 = 
	`´•¬e_to_m”ge
(
rc
,ƒrr);

4185 
	`m”ge_»loc_roÙs
(
rc
);

4187 
rc
->
m”ge_»loc_Œ“
 = 0;

4188 
	`un£t_»loc_cÚŒÞ
(
rc
);

4189 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, 
rc
->
block_rsv
, (
u64
)-1);

4192 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

4193 ià(
	`IS_ERR
(
Œªs
)) {

4194 
”r
 = 
	`PTR_ERR
(
Œªs
);

4195 
out_ä“
;

4197 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4198 
out_ä“
:

4199 
	`bŒfs_ä“_block_rsv
(
fs_šfo
, 
rc
->
block_rsv
);

4200 
	`bŒfs_ä“_·th
(
·th
);

4201  
”r
;

4202 
	}
}

4204 
	$__š£¹_Üphª_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4205 
bŒfs_roÙ
 *
roÙ
, 
u64
 
objeùid
)

4207 
bŒfs_·th
 *
·th
;

4208 
bŒfs_šode_™em
 *
™em
;

4209 
ex‹Á_bufãr
 *
Ëaf
;

4210 
»t
;

4212 
·th
 = 
	`bŒfs_®loc_·th
();

4213 ià(!
·th
)

4214  -
ENOMEM
;

4216 
»t
 = 
	`bŒfs_š£¹_em±y_šode
(
Œªs
, 
roÙ
, 
·th
, 
objeùid
);

4217 ià(
»t
)

4218 
out
;

4220 
Ëaf
 = 
·th
->
nodes
[0];

4221 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_šode_™em
);

4222 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
™em
, (*item));

4223 
	`bŒfs_£t_šode_g’”©iÚ
(
Ëaf
, 
™em
, 1);

4224 
	`bŒfs_£t_šode_size
(
Ëaf
, 
™em
, 0);

4225 
	`bŒfs_£t_šode_mode
(
Ëaf
, 
™em
, 
S_IFREG
 | 0600);

4226 
	`bŒfs_£t_šode_æags
(
Ëaf
, 
™em
, 
BTRFS_INODE_NOCOMPRESS
 |

4227 
BTRFS_INODE_PREALLOC
);

4228 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4229 
out
:

4230 
	`bŒfs_ä“_·th
(
·th
);

4231  
»t
;

4232 
	}
}

4238 
nošlše_fÜ_¡ack


4239 
šode
 *
	$ü—‹_»loc_šode
(
bŒfs_fs_šfo
 *
fs_šfo
,

4240 
bŒfs_block_group_ÿche
 *
group
)

4242 
šode
 *šodð
NULL
;

4243 
bŒfs_Œªs_hªdË
 *
Œªs
;

4244 
bŒfs_roÙ
 *
roÙ
;

4245 
bŒfs_key
 
key
;

4246 
u64
 
objeùid
;

4247 
”r
 = 0;

4249 
roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
, 
BTRFS_DATA_RELOC_TREE_OBJECTID
);

4250 ià(
	`IS_ERR
(
roÙ
))

4251  
	`ERR_CAST
(
roÙ
);

4253 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 6);

4254 ià(
	`IS_ERR
(
Œªs
))

4255  
	`ERR_CAST
(
Œªs
);

4257 
”r
 = 
	`bŒfs_fšd_ä“_objeùid
(
roÙ
, &
objeùid
);

4258 ià(
”r
)

4259 
out
;

4261 
”r
 = 
	`__š£¹_Üphª_šode
(
Œªs
, 
roÙ
, 
objeùid
);

4262 
	`BUG_ON
(
”r
);

4264 
key
.
objeùid
 = objectid;

4265 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4266 
key
.
off£t
 = 0;

4267 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
roÙ
, 
NULL
);

4268 
	`BUG_ON
(
	`IS_ERR
(
šode
è|| 
	`is_bad_šode
(inode));

4269 
	`BTRFS_I
(
šode
)->
šdex_út
 = 
group
->
key
.
objeùid
;

4271 
”r
 = 
	`bŒfs_Üphª_add
(
Œªs
, 
	`BTRFS_I
(
šode
));

4272 
out
:

4273 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4274 
	`bŒfs_bŒ“_b®ªû_dœty
(
fs_šfo
);

4275 ià(
”r
) {

4276 ià(
šode
)

4277 
	`ut
(
šode
);

4278 
šode
 = 
	`ERR_PTR
(
”r
);

4280  
šode
;

4281 
	}
}

4283 
»loc_cÚŒÞ
 *
	$®loc_»loc_cÚŒÞ
(
bŒfs_fs_šfo
 *
fs_šfo
)

4285 
»loc_cÚŒÞ
 *
rc
;

4287 
rc
 = 
	`kz®loc
((*rc), 
GFP_NOFS
);

4288 ià(!
rc
)

4289  
NULL
;

4291 
	`INIT_LIST_HEAD
(&
rc
->
»loc_roÙs
);

4292 
	`back»f_ÿche_š™
(&
rc
->
back»f_ÿche
);

4293 
	`m­pšg_Œ“_š™
(&
rc
->
»loc_roÙ_Œ“
);

4294 
	`ex‹Á_io_Œ“_š™
(&
rc
->
´oûs£d_blocks
, 
NULL
);

4295  
rc
;

4296 
	}
}

4301 
	$desüibe_»loÿtiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

4302 
bŒfs_block_group_ÿche
 *
block_group
)

4304 
buf
[128];

4305 
u64
 
æags
 = 
block_group
->flags;

4308 ià(!
æags
) {

4309 
	`¡rýy
(
buf
, "|NONE");

4311 *
bp
 = 
buf
;

4313 
	#DESCRIBE_FLAG
(
f
, 
d
) \

4314 ià(
æags
 & 
BTRFS_BLOCK_GROUP_
##
f
) { \

4315 
bp
 +ð
	`¢´štf
(bp, 
buf
 - b°+ (buf), "|%s", 
d
); \

4316 
æags
 &ð~
BTRFS_BLOCK_GROUP_
##
f
; \

4317 }

	)

4318 
	`DESCRIBE_FLAG
(
DATA
, "data");

4319 
	`DESCRIBE_FLAG
(
SYSTEM
, "system");

4320 
	`DESCRIBE_FLAG
(
METADATA
, "metadata");

4321 
	`DESCRIBE_FLAG
(
RAID0
, "raid0");

4322 
	`DESCRIBE_FLAG
(
RAID1
, "raid1");

4323 
	`DESCRIBE_FLAG
(
DUP
, "dup");

4324 
	`DESCRIBE_FLAG
(
RAID10
, "raid10");

4325 
	`DESCRIBE_FLAG
(
RAID5
, "raid5");

4326 
	`DESCRIBE_FLAG
(
RAID6
, "raid6");

4327 ià(
æags
)

4328 
	`¢´štf
(
buf
, buà- 
bp
 + (buf), "|0x%Îx", 
æags
);

4329 #undeà
DESCRIBE_FLAG


4332 
	`bŒfs_šfo
(
fs_šfo
,

4334 
block_group
->
key
.
objeùid
, 
buf
 + 1);

4335 
	}
}

4340 
	$bŒfs_»loÿ‹_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
group_¡¬t
)

4342 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

4343 
»loc_cÚŒÞ
 *
rc
;

4344 
šode
 *inode;

4345 
bŒfs_·th
 *
·th
;

4346 
»t
;

4347 
rw
 = 0;

4348 
”r
 = 0;

4350 
rc
 = 
	`®loc_»loc_cÚŒÞ
(
fs_šfo
);

4351 ià(!
rc
)

4352  -
ENOMEM
;

4354 
rc
->
ex‹Á_roÙ
 =ƒxtent_root;

4356 
rc
->
block_group
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
group_¡¬t
);

4357 
	`BUG_ON
(!
rc
->
block_group
);

4359 
»t
 = 
	`bŒfs_šc_block_group_ro
(
fs_šfo
, 
rc
->
block_group
);

4360 ià(
»t
) {

4361 
”r
 = 
»t
;

4362 
out
;

4364 
rw
 = 1;

4366 
·th
 = 
	`bŒfs_®loc_·th
();

4367 ià(!
·th
) {

4368 
”r
 = -
ENOMEM
;

4369 
out
;

4372 
šode
 = 
	`lookup_ä“_¥aû_šode
(
fs_šfo
, 
rc
->
block_group
, 
·th
);

4373 
	`bŒfs_ä“_·th
(
·th
);

4375 ià(!
	`IS_ERR
(
šode
))

4376 
»t
 = 
	`d–‘e_block_group_ÿche
(
fs_šfo
, 
rc
->
block_group
, 
šode
, 0);

4378 
»t
 = 
	`PTR_ERR
(
šode
);

4380 ià(
»t
 &&„‘ !ð-
ENOENT
) {

4381 
”r
 = 
»t
;

4382 
out
;

4385 
rc
->
d©a_šode
 = 
	`ü—‹_»loc_šode
(
fs_šfo
,„c->
block_group
);

4386 ià(
	`IS_ERR
(
rc
->
d©a_šode
)) {

4387 
”r
 = 
	`PTR_ERR
(
rc
->
d©a_šode
);

4388 
rc
->
d©a_šode
 = 
NULL
;

4389 
out
;

4392 
	`desüibe_»loÿtiÚ
(
fs_šfo
, 
rc
->
block_group
);

4394 
	`bŒfs_wa™_block_group_»£rv©iÚs
(
rc
->
block_group
);

4395 
	`bŒfs_wa™_nocow_wr™”s
(
rc
->
block_group
);

4396 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
,

4397 
rc
->
block_group
->
key
.
objeùid
,

4398 
rc
->
block_group
->
key
.
off£t
);

4401 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

4402 
»t
 = 
	`»loÿ‹_block_group
(
rc
);

4403 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

4404 ià(
»t
 < 0) {

4405 
”r
 = 
»t
;

4406 
out
;

4409 ià(
rc
->
ex‹Ás_found
 == 0)

4412 
	`bŒfs_šfo
(
fs_šfo
, "found %Îuƒx‹Ás", 
rc
->
ex‹Ás_found
);

4414 ià(
rc
->
¡age
 =ð
MOVE_DATA_EXTENTS
 &&„c->
found_fže_ex‹Á
) {

4415 
»t
 = 
	`bŒfs_wa™_Üd”ed_¿nge
(
rc
->
d©a_šode
, 0,

4416 (
u64
)-1);

4417 ià(
»t
) {

4418 
”r
 = 
»t
;

4419 
out
;

4421 
	`šv®id©e_m­pšg_·ges
(
rc
->
d©a_šode
->
i_m­pšg
,

4423 
rc
->
¡age
 = 
UPDATE_DATA_PTRS
;

4427 
	`WARN_ON
(
rc
->
block_group
->
pšÃd
 > 0);

4428 
	`WARN_ON
(
rc
->
block_group
->
»£rved
 > 0);

4429 
	`WARN_ON
(
	`bŒfs_block_group_u£d
(&
rc
->
block_group
->
™em
) > 0);

4430 
out
:

4431 ià(
”r
 && 
rw
)

4432 
	`bŒfs_dec_block_group_ro
(
rc
->
block_group
);

4433 
	`ut
(
rc
->
d©a_šode
);

4434 
	`bŒfs_put_block_group
(
rc
->
block_group
);

4435 
	`kä“
(
rc
);

4436  
”r
;

4437 
	}
}

4439 
nošlše_fÜ_¡ack
 
	$m¬k_g¬bage_roÙ
(
bŒfs_roÙ
 *
roÙ
)

4441 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4442 
bŒfs_Œªs_hªdË
 *
Œªs
;

4443 
»t
, 
”r
;

4445 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

4446 ià(
	`IS_ERR
(
Œªs
))

4447  
	`PTR_ERR
(
Œªs
);

4449 
	`mem£t
(&
roÙ
->
roÙ_™em
.
drÝ_´og»ss
, 0,

4450 (
roÙ
->
roÙ_™em
.
drÝ_´og»ss
));

4451 
roÙ
->
roÙ_™em
.
drÝ_Ëv–
 = 0;

4452 
	`bŒfs_£t_roÙ_»fs
(&
roÙ
->
roÙ_™em
, 0);

4453 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

4454 &
roÙ
->
roÙ_key
, &roÙ->
roÙ_™em
);

4456 
”r
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4457 ià(
”r
)

4458  
”r
;

4459  
»t
;

4460 
	}
}

4468 
	$bŒfs_»cov”_»loÿtiÚ
(
bŒfs_roÙ
 *
roÙ
)

4470 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4471 
	`LIST_HEAD
(
»loc_roÙs
);

4472 
bŒfs_key
 
key
;

4473 
bŒfs_roÙ
 *
fs_roÙ
;

4474 
bŒfs_roÙ
 *
»loc_roÙ
;

4475 
bŒfs_·th
 *
·th
;

4476 
ex‹Á_bufãr
 *
Ëaf
;

4477 
»loc_cÚŒÞ
 *
rc
 = 
NULL
;

4478 
bŒfs_Œªs_hªdË
 *
Œªs
;

4479 
»t
;

4480 
”r
 = 0;

4482 
·th
 = 
	`bŒfs_®loc_·th
();

4483 ià(!
·th
)

4484  -
ENOMEM
;

4485 
·th
->
»ada
 = 
READA_BACK
;

4487 
key
.
objeùid
 = 
BTRFS_TREE_RELOC_OBJECTID
;

4488 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4489 
key
.
off£t
 = (
u64
)-1;

4492 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
,

4493 
·th
, 0, 0);

4494 ià(
»t
 < 0) {

4495 
”r
 = 
»t
;

4496 
out
;

4498 ià(
»t
 > 0) {

4499 ià(
·th
->
¦Ùs
[0] == 0)

4501 
·th
->
¦Ùs
[0]--;

4503 
Ëaf
 = 
·th
->
nodes
[0];

4504 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

4505 
	`bŒfs_»Ëa£_·th
(
·th
);

4507 ià(
key
.
objeùid
 !ð
BTRFS_TREE_RELOC_OBJECTID
 ||

4508 
key
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
)

4511 
»loc_roÙ
 = 
	`bŒfs_»ad_fs_roÙ
(
roÙ
, &
key
);

4512 ià(
	`IS_ERR
(
»loc_roÙ
)) {

4513 
”r
 = 
	`PTR_ERR
(
»loc_roÙ
);

4514 
out
;

4517 
	`li¡_add
(&
»loc_roÙ
->
roÙ_li¡
, &
»loc_roÙs
);

4519 ià(
	`bŒfs_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
) > 0) {

4520 
fs_roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
,

4521 
»loc_roÙ
->
roÙ_key
.
off£t
);

4522 ià(
	`IS_ERR
(
fs_roÙ
)) {

4523 
»t
 = 
	`PTR_ERR
(
fs_roÙ
);

4524 ià(
»t
 !ð-
ENOENT
) {

4525 
”r
 = 
»t
;

4526 
out
;

4528 
»t
 = 
	`m¬k_g¬bage_roÙ
(
»loc_roÙ
);

4529 ià(
»t
 < 0) {

4530 
”r
 = 
»t
;

4531 
out
;

4536 ià(
key
.
off£t
 == 0)

4539 
key
.
off£t
--;

4541 
	`bŒfs_»Ëa£_·th
(
·th
);

4543 ià(
	`li¡_em±y
(&
»loc_roÙs
))

4544 
out
;

4546 
rc
 = 
	`®loc_»loc_cÚŒÞ
(
fs_šfo
);

4547 ià(!
rc
) {

4548 
”r
 = -
ENOMEM
;

4549 
out
;

4552 
rc
->
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

4554 
	`£t_»loc_cÚŒÞ
(
rc
);

4556 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

4557 ià(
	`IS_ERR
(
Œªs
)) {

4558 
	`un£t_»loc_cÚŒÞ
(
rc
);

4559 
”r
 = 
	`PTR_ERR
(
Œªs
);

4560 
out_ä“
;

4563 
rc
->
m”ge_»loc_Œ“
 = 1;

4565 !
	`li¡_em±y
(&
»loc_roÙs
)) {

4566 
»loc_roÙ
 = 
	`li¡_’Œy
(
»loc_roÙs
.
Ãxt
,

4567 
bŒfs_roÙ
, 
roÙ_li¡
);

4568 
	`li¡_d–
(&
»loc_roÙ
->
roÙ_li¡
);

4570 ià(
	`bŒfs_roÙ_»fs
(&
»loc_roÙ
->
roÙ_™em
) == 0) {

4571 
	`li¡_add_ž
(&
»loc_roÙ
->
roÙ_li¡
,

4572 &
rc
->
»loc_roÙs
);

4576 
fs_roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
, 
»loc_roÙ
->
roÙ_key
.
off£t
);

4577 ià(
	`IS_ERR
(
fs_roÙ
)) {

4578 
”r
 = 
	`PTR_ERR
(
fs_roÙ
);

4579 
out_ä“
;

4582 
”r
 = 
	`__add_»loc_roÙ
(
»loc_roÙ
);

4583 
	`BUG_ON
(
”r
 < 0);

4584 
fs_roÙ
->
»loc_roÙ
 =„eloc_root;

4587 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4588 ià(
”r
)

4589 
out_ä“
;

4591 
	`m”ge_»loc_roÙs
(
rc
);

4593 
	`un£t_»loc_cÚŒÞ
(
rc
);

4595 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
rc
->
ex‹Á_roÙ
);

4596 ià(
	`IS_ERR
(
Œªs
)) {

4597 
”r
 = 
	`PTR_ERR
(
Œªs
);

4598 
out_ä“
;

4600 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4601 
out_ä“
:

4602 
	`kä“
(
rc
);

4603 
out
:

4604 ià(!
	`li¡_em±y
(&
»loc_roÙs
))

4605 
	`ä“_»loc_roÙs
(&
»loc_roÙs
);

4607 
	`bŒfs_ä“_·th
(
·th
);

4609 ià(
”r
 == 0) {

4611 
fs_roÙ
 = 
	`»ad_fs_roÙ
(
fs_šfo
, 
BTRFS_DATA_RELOC_TREE_OBJECTID
);

4612 ià(
	`IS_ERR
(
fs_roÙ
))

4613 
”r
 = 
	`PTR_ERR
(
fs_roÙ
);

4615 
”r
 = 
	`bŒfs_Üphª_þ—nup
(
fs_roÙ
);

4617  
”r
;

4618 
	}
}

4626 
	$bŒfs_»loc_þÚe_csums
(
šode
 *šode, 
u64
 
fže_pos
, u64 
Ën
)

4628 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

4629 
bŒfs_Üd”ed_sum
 *
sums
;

4630 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4631 
»t
;

4632 
u64
 
disk_by‹Ä
;

4633 
u64
 
Ãw_by‹Ä
;

4634 
	`LIST_HEAD
(
li¡
);

4636 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_ex‹Á
(
šode
, 
fže_pos
);

4637 
	`BUG_ON
(
Üd”ed
->
fže_off£t
 !ð
fže_pos
 || ord”ed->
Ën
 !=†en);

4639 
disk_by‹Ä
 = 
fže_pos
 + 
	`BTRFS_I
(
šode
)->
šdex_út
;

4640 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(
fs_šfo
->
csum_roÙ
, 
disk_by‹Ä
,

4641 
disk_by‹Ä
 + 
Ën
 - 1, &
li¡
, 0);

4642 ià(
»t
)

4643 
out
;

4645 !
	`li¡_em±y
(&
li¡
)) {

4646 
sums
 = 
	`li¡_’Œy
(
li¡
.
Ãxt
, 
bŒfs_Üd”ed_sum
,†ist);

4647 
	`li¡_d–_š™
(&
sums
->
li¡
);

4661 
Ãw_by‹Ä
 = 
Üd”ed
->
¡¬t
 + (
sums
->
by‹Ä
 - 
disk_by‹Ä
);

4662 
sums
->
by‹Ä
 = 
Ãw_by‹Ä
;

4664 
	`bŒfs_add_Üd”ed_sum
(
šode
, 
Üd”ed
, 
sums
);

4666 
out
:

4667 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

4668  
»t
;

4669 
	}
}

4671 
	$bŒfs_»loc_cow_block
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4672 
bŒfs_roÙ
 *
roÙ
, 
ex‹Á_bufãr
 *
buf
,

4673 
ex‹Á_bufãr
 *
cow
)

4675 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4676 
»loc_cÚŒÞ
 *
rc
;

4677 
back»f_node
 *
node
;

4678 
fœ¡_cow
 = 0;

4679 
Ëv–
;

4680 
»t
 = 0;

4682 
rc
 = 
fs_šfo
->
»loc_ùl
;

4683 ià(!
rc
)

4686 
	`BUG_ON
(
rc
->
¡age
 =ð
UPDATE_DATA_PTRS
 &&

4687 
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_DATA_RELOC_TREE_OBJECTID
);

4689 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
) {

4690 ià(
buf
 =ð
roÙ
->
node
)

4691 
	`__upd©e_»loc_roÙ
(
roÙ
, 
cow
->
¡¬t
);

4694 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
buf
);

4695 ià(
	`bŒfs_h—d”_g’”©iÚ
(
buf
) <=

4696 
	`bŒfs_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
))

4697 
fœ¡_cow
 = 1;

4699 ià(
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
 &&

4700 
rc
->
ü—‹_»loc_Œ“
) {

4701 
	`WARN_ON
(!
fœ¡_cow
 && 
Ëv–
 == 0);

4703 
node
 = 
rc
->
back»f_ÿche
.
·th
[
Ëv–
];

4704 
	`BUG_ON
(
node
->
by‹Ä
 !ð
buf
->
¡¬t
 &&

4705 
node
->
Ãw_by‹Ä
 !ð
buf
->
¡¬t
);

4707 
	`drÝ_node_bufãr
(
node
);

4708 
	`ex‹Á_bufãr_g‘
(
cow
);

4709 
node
->
eb
 = 
cow
;

4710 
node
->
Ãw_by‹Ä
 = 
cow
->
¡¬t
;

4712 ià(!
node
->
³ndšg
) {

4713 
	`li¡_move_ž
(&
node
->
li¡
,

4714 &
rc
->
back»f_ÿche
.
³ndšg
[
Ëv–
]);

4715 
node
->
³ndšg
 = 1;

4718 ià(
fœ¡_cow
)

4719 
	`__m¬k_block_´oûs£d
(
rc
, 
node
);

4721 ià(
fœ¡_cow
 && 
Ëv–
 > 0)

4722 
rc
->
nodes_»loÿ‹d
 +ð
buf
->
Ën
;

4725 ià(
Ëv–
 =ð0 && 
fœ¡_cow
 && 
rc
->
¡age
 =ð
UPDATE_DATA_PTRS
)

4726 
»t
 = 
	`»¶aû_fže_ex‹Ás
(
Œªs
, 
rc
, 
roÙ
, 
cow
);

4727  
»t
;

4728 
	}
}

4734 
	$bŒfs_»loc_´e_¢­shÙ
(
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
,

4735 
u64
 *
by‹s_to_»£rve
)

4737 
bŒfs_roÙ
 *
roÙ
;

4738 
»loc_cÚŒÞ
 *
rc
;

4740 
roÙ
 = 
³ndšg
->root;

4741 ià(!
roÙ
->
»loc_roÙ
)

4744 
rc
 = 
roÙ
->
fs_šfo
->
»loc_ùl
;

4745 ià(!
rc
->
m”ge_»loc_Œ“
)

4748 
roÙ
 =„oÙ->
»loc_roÙ
;

4749 
	`BUG_ON
(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0);

4760 *
by‹s_to_»£rve
 +ð
rc
->
nodes_»loÿ‹d
;

4761 
	}
}

4767 
	$bŒfs_»loc_po¡_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4768 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
)

4770 
bŒfs_roÙ
 *
roÙ
 = 
³ndšg
->root;

4771 
bŒfs_roÙ
 *
»loc_roÙ
;

4772 
bŒfs_roÙ
 *
Ãw_roÙ
;

4773 
»loc_cÚŒÞ
 *
rc
;

4774 
»t
;

4776 ià(!
roÙ
->
»loc_roÙ
)

4779 
rc
 = 
roÙ
->
fs_šfo
->
»loc_ùl
;

4780 
rc
->
m”gšg_rsv_size
 +ðrc->
nodes_»loÿ‹d
;

4782 ià(
rc
->
m”ge_»loc_Œ“
) {

4783 
»t
 = 
	`bŒfs_block_rsv_mig¿‹
(&
³ndšg
->
block_rsv
,

4784 
rc
->
block_rsv
,

4785 
rc
->
nodes_»loÿ‹d
, 1);

4786 ià(
»t
)

4787  
»t
;

4790 
Ãw_roÙ
 = 
³ndšg
->
¢­
;

4791 
»loc_roÙ
 = 
	`ü—‹_»loc_roÙ
(
Œªs
, 
roÙ
->reloc_root,

4792 
Ãw_roÙ
->
roÙ_key
.
objeùid
);

4793 ià(
	`IS_ERR
(
»loc_roÙ
))

4794  
	`PTR_ERR
(
»loc_roÙ
);

4796 
»t
 = 
	`__add_»loc_roÙ
(
»loc_roÙ
);

4797 
	`BUG_ON
(
»t
 < 0);

4798 
Ãw_roÙ
->
»loc_roÙ
 =„eloc_root;

4800 ià(
rc
->
ü—‹_»loc_Œ“
)

4801 
»t
 = 
	`þÚe_back»f_node
(
Œªs
, 
rc
, 
roÙ
, 
»loc_roÙ
);

4802  
»t
;

4803 
	}
}

	@root-tree.c

19 
	~<lšux/”r.h
>

20 
	~<lšux/uuid.h
>

21 
	~"ù»e.h
"

22 
	~"Œª§ùiÚ.h
"

23 
	~"disk-io.h
"

24 
	~"´št-Œ“.h
"

33 
	$bŒfs_»ad_roÙ_™em
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

34 
bŒfs_roÙ_™em
 *
™em
)

36 
uuid_Ë
 
uuid
;

37 
Ën
;

38 
Ãed_»£t
 = 0;

40 
Ën
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

41 
	`»ad_ex‹Á_bufãr
(
eb
, 
™em
, 
	`bŒfs_™em_±r_off£t
Ób, 
¦Ù
),

42 
	`mš_t
(, 
Ën
, ()(*
™em
)));

43 ià(
Ën
 < (*
™em
))

44 
Ãed_»£t
 = 1;

45 ià(!
Ãed_»£t
 && 
	`bŒfs_roÙ_g’”©iÚ
(
™em
)

46 !ð
	`bŒfs_roÙ_g’”©iÚ_v2
(
™em
)) {

47 ià(
	`bŒfs_roÙ_g’”©iÚ_v2
(
™em
) != 0) {

48 
	`bŒfs_w¬n
(
eb
->
fs_šfo
,

51 
Ãed_»£t
 = 1;

53 ià(
Ãed_»£t
) {

54 
	`mem£t
(&
™em
->
g’”©iÚ_v2
, 0,

55 (*
™em
è- 
	`off£tof
(
bŒfs_roÙ_™em
,

56 
g’”©iÚ_v2
));

58 
	`uuid_Ë_g’
(&
uuid
);

59 
	`memýy
(
™em
->
uuid
, uuid.
b
, 
BTRFS_UUID_SIZE
);

61 
	}
}

77 
	$bŒfs_fšd_roÙ
(
bŒfs_roÙ
 *
roÙ
, cÚ¡ 
bŒfs_key
 *
£¬ch_key
,

78 
bŒfs_·th
 *
·th
, 
bŒfs_roÙ_™em
 *
roÙ_™em
,

79 
bŒfs_key
 *
roÙ_key
)

81 
bŒfs_key
 
found_key
;

82 
ex‹Á_bufãr
 *
l
;

83 
»t
;

84 
¦Ù
;

86 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
£¬ch_key
, 
·th
, 0, 0);

87 ià(
»t
 < 0)

88  
»t
;

90 ià(
£¬ch_key
->
off£t
 != -1ULL) {

91 ià(
»t
 > 0)

92 
out
;

94 
	`BUG_ON
(
»t
 == 0);

95 ià(
·th
->
¦Ùs
[0] == 0)

96 
out
;

97 
·th
->
¦Ùs
[0]--;

98 
»t
 = 0;

101 
l
 = 
·th
->
nodes
[0];

102 
¦Ù
 = 
·th
->
¦Ùs
[0];

104 
	`bŒfs_™em_key_to_ýu
(
l
, &
found_key
, 
¦Ù
);

105 ià(
found_key
.
objeùid
 !ð
£¬ch_key
->objectid ||

106 
found_key
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
) {

107 
»t
 = 1;

108 
out
;

111 ià(
roÙ_™em
)

112 
	`bŒfs_»ad_roÙ_™em
(
l
, 
¦Ù
, 
roÙ_™em
);

113 ià(
roÙ_key
)

114 
	`memýy
(
roÙ_key
, &
found_key
, (found_key));

115 
out
:

116 
	`bŒfs_»Ëa£_·th
(
·th
);

117  
»t
;

118 
	}
}

120 
	$bŒfs_£t_roÙ_node
(
bŒfs_roÙ_™em
 *
™em
,

121 
ex‹Á_bufãr
 *
node
)

123 
	`bŒfs_£t_roÙ_by‹Ä
(
™em
, 
node
->
¡¬t
);

124 
	`bŒfs_£t_roÙ_Ëv–
(
™em
, 
	`bŒfs_h—d”_Ëv–
(
node
));

125 
	`bŒfs_£t_roÙ_g’”©iÚ
(
™em
, 
	`bŒfs_h—d”_g’”©iÚ
(
node
));

126 
	}
}

131 
	$bŒfs_upd©e_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ


132 *
roÙ
, 
bŒfs_key
 *
key
, 
bŒfs_roÙ_™em


133 *
™em
)

135 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

136 
bŒfs_·th
 *
·th
;

137 
ex‹Á_bufãr
 *
l
;

138 
»t
;

139 
¦Ù
;

140 
±r
;

141 
u32
 
Þd_Ën
;

143 
·th
 = 
	`bŒfs_®loc_·th
();

144 ià(!
·th
)

145  -
ENOMEM
;

147 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, 0, 1);

148 ià(
»t
 < 0) {

149 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

150 
out
;

153 ià(
»t
 != 0) {

154 
	`bŒfs_´št_Ëaf
(
·th
->
nodes
[0]);

155 
	`bŒfs_ü™
(
fs_šfo
, "unableo update„oot key %llu %u %llu",

156 
key
->
objeùid
, key->
ty³
, key->
off£t
);

157 
	`BUG_ON
(1);

160 
l
 = 
·th
->
nodes
[0];

161 
¦Ù
 = 
·th
->
¦Ùs
[0];

162 
±r
 = 
	`bŒfs_™em_±r_off£t
(
l
, 
¦Ù
);

163 
Þd_Ën
 = 
	`bŒfs_™em_size_Ä
(
l
, 
¦Ù
);

170 ià(
Þd_Ën
 < (*
™em
)) {

171 
	`bŒfs_»Ëa£_·th
(
·th
);

172 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
,

174 ià(
»t
 < 0) {

175 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

176 
out
;

179 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

180 ià(
»t
 < 0) {

181 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

182 
out
;

184 
	`bŒfs_»Ëa£_·th
(
·th
);

185 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
,

186 
key
, (*
™em
));

187 ià(
»t
 < 0) {

188 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

189 
out
;

191 
l
 = 
·th
->
nodes
[0];

192 
¦Ù
 = 
·th
->
¦Ùs
[0];

193 
±r
 = 
	`bŒfs_™em_±r_off£t
(
l
, 
¦Ù
);

200 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
™em
, 
	`bŒfs_roÙ_g’”©iÚ
(item));

202 
	`wr™e_ex‹Á_bufãr
(
l
, 
™em
, 
±r
, (*item));

203 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

204 
out
:

205 
	`bŒfs_ä“_·th
(
·th
);

206  
»t
;

207 
	}
}

209 
	$bŒfs_š£¹_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
,

210 cÚ¡ 
bŒfs_key
 *
key
, 
bŒfs_roÙ_™em
 *
™em
)

215 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
™em
, 
	`bŒfs_roÙ_g’”©iÚ
(item));

216  
	`bŒfs_š£¹_™em
(
Œªs
, 
roÙ
, 
key
, 
™em
, (*item));

217 
	}
}

219 
	$bŒfs_fšd_Üphª_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

221 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

222 
ex‹Á_bufãr
 *
Ëaf
;

223 
bŒfs_·th
 *
·th
;

224 
bŒfs_key
 
key
;

225 
bŒfs_key
 
roÙ_key
;

226 
bŒfs_roÙ
 *
roÙ
;

227 
”r
 = 0;

228 
»t
;

229 
boÞ
 
ÿn_»cov”
 = 
Œue
;

231 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

232 
ÿn_»cov”
 = 
çl£
;

234 
·th
 = 
	`bŒfs_®loc_·th
();

235 ià(!
·th
)

236  -
ENOMEM
;

238 
key
.
objeùid
 = 
BTRFS_ORPHAN_OBJECTID
;

239 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

240 
key
.
off£t
 = 0;

242 
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

243 
roÙ_key
.
off£t
 = (
u64
)-1;

246 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

247 ià(
»t
 < 0) {

248 
”r
 = 
»t
;

252 
Ëaf
 = 
·th
->
nodes
[0];

253 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

254 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
Œ“_roÙ
, 
·th
);

255 ià(
»t
 < 0)

256 
”r
 = 
»t
;

257 ià(
»t
 != 0)

259 
Ëaf
 = 
·th
->
nodes
[0];

262 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

263 
	`bŒfs_»Ëa£_·th
(
·th
);

265 ià(
key
.
objeùid
 !ð
BTRFS_ORPHAN_OBJECTID
 ||

266 
key
.
ty³
 !ð
BTRFS_ORPHAN_ITEM_KEY
)

269 
roÙ_key
.
objeùid
 = 
key
.
off£t
;

270 
key
.
off£t
++;

279 
roÙ
 = 
	`bŒfs_lookup_fs_roÙ
(
fs_šfo
, 
roÙ_key
.
objeùid
);

280 ià(
roÙ
) {

281 
	`WARN_ON
(!
	`‹¡_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
,

282 &
roÙ
->
¡©e
));

283 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

284 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

288 
roÙ
 = 
	`bŒfs_»ad_fs_roÙ
(
Œ“_roÙ
, &
roÙ_key
);

289 
”r
 = 
	`PTR_ERR_OR_ZERO
(
roÙ
);

290 ià(
”r
 &&ƒ¼ !ð-
ENOENT
) {

292 } ià(
”r
 =ð-
ENOENT
) {

293 
bŒfs_Œªs_hªdË
 *
Œªs
;

295 
	`bŒfs_»Ëa£_·th
(
·th
);

297 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
Œ“_roÙ
);

298 ià(
	`IS_ERR
(
Œªs
)) {

299 
”r
 = 
	`PTR_ERR
(
Œªs
);

300 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
,

304 
”r
 = 
	`bŒfs_d–_Üphª_™em
(
Œªs
, 
Œ“_roÙ
,

305 
roÙ_key
.
objeùid
);

306 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

307 ià(
”r
) {

308 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
”r
,

315 
”r
 = 
	`bŒfs_š™_fs_roÙ
(
roÙ
);

316 ià(
”r
) {

317 
	`bŒfs_ä“_fs_roÙ
(
roÙ
);

321 
	`£t_b™
(
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
, &
roÙ
->
¡©e
);

323 
”r
 = 
	`bŒfs_š£¹_fs_roÙ
(
fs_šfo
, 
roÙ
);

324 ià(
”r
) {

325 
	`BUG_ON
(
”r
 =ð-
EEXIST
);

326 
	`bŒfs_ä“_fs_roÙ
(
roÙ
);

330 ià(
	`bŒfs_roÙ_»fs
(&
roÙ
->
roÙ_™em
) == 0)

331 
	`bŒfs_add_d—d_roÙ
(
roÙ
);

334 
	`bŒfs_ä“_·th
(
·th
);

335  
”r
;

336 
	}
}

339 
	$bŒfs_d–_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

340 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ 
bŒfs_key
 *
key
)

342 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

343 
bŒfs_·th
 *
·th
;

344 
»t
;

346 
·th
 = 
	`bŒfs_®loc_·th
();

347 ià(!
·th
)

348  -
ENOMEM
;

349 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, 
key
, 
·th
, -1, 1);

350 ià(
»t
 < 0)

351 
out
;

353 
	`BUG_ON
(
»t
 != 0);

355 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

356 
out
:

357 
	`bŒfs_ä“_·th
(
·th
);

358  
»t
;

359 
	}
}

361 
	$bŒfs_d–_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

362 
bŒfs_fs_šfo
 *
fs_šfo
,

363 
u64
 
roÙ_id
, u64 
»f_id
, u64 
dœid
, u64 *
£qu’û
,

364 cÚ¡ *
Çme
, 
Çme_Ën
)

367 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

368 
bŒfs_·th
 *
·th
;

369 
bŒfs_roÙ_»f
 *
»f
;

370 
ex‹Á_bufãr
 *
Ëaf
;

371 
bŒfs_key
 
key
;

372 
±r
;

373 
”r
 = 0;

374 
»t
;

376 
·th
 = 
	`bŒfs_®loc_·th
();

377 ià(!
·th
)

378  -
ENOMEM
;

380 
key
.
objeùid
 = 
roÙ_id
;

381 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

382 
key
.
off£t
 = 
»f_id
;

383 
agaš
:

384 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
Œ“_roÙ
, &
key
, 
·th
, -1, 1);

385 
	`BUG_ON
(
»t
 < 0);

386 ià(
»t
 == 0) {

387 
Ëaf
 = 
·th
->
nodes
[0];

388 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

389 
bŒfs_roÙ_»f
);

391 
	`WARN_ON
(
	`bŒfs_roÙ_»f_dœid
(
Ëaf
, 
»f
è!ð
dœid
);

392 
	`WARN_ON
(
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
è!ð
Çme_Ën
);

393 
±r
 = ()(
»f
 + 1);

394 
»t
 = 
	`bŒfs_is_Çme_Ën_v®id
(
Ëaf
, 
·th
->
¦Ùs
[0], 
±r
,

395 
Çme_Ën
);

396 ià(!
»t
) {

397 
”r
 = -
EIO
;

398 
out
;

401 
	`WARN_ON
(
	`memcmp_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
±r
, 
Çme_Ën
));

402 *
£qu’û
 = 
	`bŒfs_roÙ_»f_£qu’û
(
Ëaf
, 
»f
);

404 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
Œ“_roÙ
, 
·th
);

405 ià(
»t
) {

406 
”r
 = 
»t
;

407 
out
;

410 
”r
 = -
ENOENT
;

412 ià(
key
.
ty³
 =ð
BTRFS_ROOT_BACKREF_KEY
) {

413 
	`bŒfs_»Ëa£_·th
(
·th
);

414 
key
.
objeùid
 = 
»f_id
;

415 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

416 
key
.
off£t
 = 
roÙ_id
;

417 
agaš
;

420 
out
:

421 
	`bŒfs_ä“_·th
(
·th
);

422  
”r
;

423 
	}
}

440 
	$bŒfs_add_roÙ_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

441 
bŒfs_fs_šfo
 *
fs_šfo
,

442 
u64
 
roÙ_id
, u64 
»f_id
, u64 
dœid
, u64 
£qu’û
,

443 cÚ¡ *
Çme
, 
Çme_Ën
)

445 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

446 
bŒfs_key
 
key
;

447 
»t
;

448 
bŒfs_·th
 *
·th
;

449 
bŒfs_roÙ_»f
 *
»f
;

450 
ex‹Á_bufãr
 *
Ëaf
;

451 
±r
;

453 
·th
 = 
	`bŒfs_®loc_·th
();

454 ià(!
·th
)

455  -
ENOMEM
;

457 
key
.
objeùid
 = 
roÙ_id
;

458 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

459 
key
.
off£t
 = 
»f_id
;

460 
agaš
:

461 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
Œ“_roÙ
, 
·th
, &
key
,

462 (*
»f
è+ 
Çme_Ën
);

463 ià(
»t
) {

464 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

465 
	`bŒfs_ä“_·th
(
·th
);

466  
»t
;

469 
Ëaf
 = 
·th
->
nodes
[0];

470 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_roÙ_»f
);

471 
	`bŒfs_£t_roÙ_»f_dœid
(
Ëaf
, 
»f
, 
dœid
);

472 
	`bŒfs_£t_roÙ_»f_£qu’û
(
Ëaf
, 
»f
, 
£qu’û
);

473 
	`bŒfs_£t_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
, 
Çme_Ën
);

474 
±r
 = ()(
»f
 + 1);

475 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
Çme
, 
±r
, 
Çme_Ën
);

476 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

478 ià(
key
.
ty³
 =ð
BTRFS_ROOT_BACKREF_KEY
) {

479 
	`bŒfs_»Ëa£_·th
(
·th
);

480 
key
.
objeùid
 = 
»f_id
;

481 
key
.
ty³
 = 
BTRFS_ROOT_REF_KEY
;

482 
key
.
off£t
 = 
roÙ_id
;

483 
agaš
;

486 
	`bŒfs_ä“_·th
(
·th
);

488 
	}
}

496 
	$bŒfs_check_ªd_š™_roÙ_™em
(
bŒfs_roÙ_™em
 *
roÙ_™em
)

498 
u64
 
šode_æags
 = 
	`bŒfs_¡ack_šode_æags
(&
roÙ_™em
->
šode
);

500 ià(!(
šode_æags
 & 
BTRFS_INODE_ROOT_ITEM_INIT
)) {

501 
šode_æags
 |ð
BTRFS_INODE_ROOT_ITEM_INIT
;

502 
	`bŒfs_£t_¡ack_šode_æags
(&
roÙ_™em
->
šode
, 
šode_æags
);

503 
	`bŒfs_£t_roÙ_æags
(
roÙ_™em
, 0);

504 
	`bŒfs_£t_roÙ_lim™
(
roÙ_™em
, 0);

506 
	}
}

508 
	$bŒfs_upd©e_roÙ_times
(
bŒfs_Œªs_hªdË
 *
Œªs
,

509 
bŒfs_roÙ
 *
roÙ
)

511 
bŒfs_roÙ_™em
 *
™em
 = &
roÙ
->
roÙ_™em
;

512 
time¥ec
 
ù
;

514 
	`ktime_g‘_»®_ts
(&
ù
);

515 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

516 
	`bŒfs_£t_roÙ_ù¿nsid
(
™em
, 
Œªs
->
Œªsid
);

517 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
™em
->
ùime
, 
ù
.
tv_£c
);

518 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
™em
->
ùime
, 
ù
.
tv_n£c
);

519 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

520 
	}
}

	@scrub.c

19 
	~<lšux/blkdev.h
>

20 
	~<lšux/¿‹lim™.h
>

21 
	~<lšux/sched/mm.h
>

22 
	~"ù»e.h
"

23 
	~"vÞumes.h
"

24 
	~"disk-io.h
"

25 
	~"Üd”ed-d©a.h
"

26 
	~"Œª§ùiÚ.h
"

27 
	~"back»f.h
"

28 
	~"ex‹Á_io.h
"

29 
	~"dev-»¶aû.h
"

30 
	~"check-š‹gr™y.h
"

31 
	~"rcu-¡ršg.h
"

32 
	~"¿id56.h
"

47 
	gsüub_block
;

48 
	gsüub_ùx
;

56 
	#SCRUB_PAGES_PER_RD_BIO
 32

	)

57 
	#SCRUB_PAGES_PER_WR_BIO
 32

	)

58 
	#SCRUB_BIOS_PER_SCTX
 64

	)

65 
	#SCRUB_MAX_PAGES_PER_BLOCK
 16

	)

67 
	ssüub_»cov”
 {

68 
»fcouÁ_t
 
	m»fs
;

69 
bŒfs_bio
 *
	mbbio
;

70 
u64
 
	mm­_Ëngth
;

73 
	ssüub_·ge
 {

74 
süub_block
 *
	msblock
;

75 
·ge
 *
	m·ge
;

76 
bŒfs_deviû
 *
	mdev
;

77 
li¡_h—d
 
	mli¡
;

78 
u64
 
	mæags
;

79 
u64
 
	mg’”©iÚ
;

80 
u64
 
	mlogiÿl
;

81 
u64
 
	mphysiÿl
;

82 
u64
 
	mphysiÿl_fÜ_dev_»¶aû
;

83 
©omic_t
 
	m»fs
;

85 
	mmœrÜ_num
:8;

86 
	mhave_csum
:1;

87 
	mio_”rÜ
:1;

89 
u8
 
	mcsum
[
BTRFS_CSUM_SIZE
];

91 
süub_»cov”
 *
	m»cov”
;

94 
	ssüub_bio
 {

95 
	mšdex
;

96 
süub_ùx
 *
	msùx
;

97 
bŒfs_deviû
 *
	mdev
;

98 
bio
 *
	mbio
;

99 
blk_¡©us_t
 
	m¡©us
;

100 
u64
 
	mlogiÿl
;

101 
u64
 
	mphysiÿl
;

102 #ià
SCRUB_PAGES_PER_WR_BIO
 >ð
SCRUB_PAGES_PER_RD_BIO


103 
süub_·ge
 *
	m·gev
[
SCRUB_PAGES_PER_WR_BIO
];

105 
süub_·ge
 *
	m·gev
[
SCRUB_PAGES_PER_RD_BIO
];

107 
	m·ge_couÁ
;

108 
	mÃxt_ä“
;

109 
bŒfs_wÜk
 
	mwÜk
;

112 
	ssüub_block
 {

113 
süub_·ge
 *
	m·gev
[
SCRUB_MAX_PAGES_PER_BLOCK
];

114 
	m·ge_couÁ
;

115 
©omic_t
 
	mout¡ªdšg_·ges
;

116 
»fcouÁ_t
 
	m»fs
;

117 
süub_ùx
 *
	msùx
;

118 
süub_·r™y
 *
	m¥¬™y
;

120 
	mh—d”_”rÜ
:1;

121 
	mchecksum_”rÜ
:1;

122 
	mno_io_”rÜ_£’
:1;

123 
	mg’”©iÚ_”rÜ
:1;

127 
	md©a_cÜ»ùed
:1;

129 
bŒfs_wÜk
 
	mwÜk
;

133 
	ssüub_·r™y
 {

134 
süub_ùx
 *
	msùx
;

136 
bŒfs_deviû
 *
	msüub_dev
;

138 
u64
 
	mlogic_¡¬t
;

140 
u64
 
	mlogic_’d
;

142 
	mn£ùÜs
;

144 
u64
 
	m¡re_Ën
;

146 
»fcouÁ_t
 
	m»fs
;

148 
li¡_h—d
 
	m¥ages
;

151 
bŒfs_wÜk
 
	mwÜk
;

154 *
	mdb™m­
;

160 *
	meb™m­
;

162 
	mb™m­
[0];

165 
	ssüub_ùx
 {

166 
süub_bio
 *
	mbios
[
SCRUB_BIOS_PER_SCTX
];

167 
bŒfs_fs_šfo
 *
	mfs_šfo
;

168 
	mfœ¡_ä“
;

169 
	mcu¼
;

170 
©omic_t
 
	mbios_š_æight
;

171 
©omic_t
 
	mwÜk”s_³ndšg
;

172 
¥šlock_t
 
	mli¡_lock
;

173 
wa™_queue_h—d_t
 
	mli¡_wa™
;

174 
u16
 
	mcsum_size
;

175 
li¡_h—d
 
	mcsum_li¡
;

176 
©omic_t
 
	mÿnûl_»q
;

177 
	m»adÚly
;

178 
	m·ges_³r_rd_bio
;

180 
	mis_dev_»¶aû
;

182 
süub_bio
 *
	mwr_cu¼_bio
;

183 
mu‹x
 
	mwr_lock
;

184 
	m·ges_³r_wr_bio
;

185 
bŒfs_deviû
 *
	mwr_tgtdev
;

186 
boÞ
 
	mæush_®l_wr™es
;

191 
bŒfs_süub_´og»ss
 
	m¡©
;

192 
¥šlock_t
 
	m¡©_lock
;

201 
»fcouÁ_t
 
	m»fs
;

204 
	ssüub_fixup_nod©asum
 {

205 
süub_ùx
 *
	msùx
;

206 
bŒfs_deviû
 *
	mdev
;

207 
u64
 
	mlogiÿl
;

208 
bŒfs_roÙ
 *
	mroÙ
;

209 
bŒfs_wÜk
 
	mwÜk
;

210 
	mmœrÜ_num
;

213 
	ssüub_nocow_šode
 {

214 
u64
 
	mšum
;

215 
u64
 
	moff£t
;

216 
u64
 
	mroÙ
;

217 
li¡_h—d
 
	mli¡
;

220 
	ssüub_cÝy_nocow_ùx
 {

221 
süub_ùx
 *
	msùx
;

222 
u64
 
	mlogiÿl
;

223 
u64
 
	mËn
;

224 
	mmœrÜ_num
;

225 
u64
 
	mphysiÿl_fÜ_dev_»¶aû
;

226 
li¡_h—d
 
	mšodes
;

227 
bŒfs_wÜk
 
	mwÜk
;

230 
	ssüub_w¬nšg
 {

231 
bŒfs_·th
 *
	m·th
;

232 
u64
 
	mex‹Á_™em_size
;

233 cÚ¡ *
	m”r¡r
;

234 
£ùÜ_t
 
	m£ùÜ
;

235 
u64
 
	mlogiÿl
;

236 
bŒfs_deviû
 *
	mdev
;

239 
	sfuÎ_¡re_lock
 {

240 
rb_node
 
	mnode
;

241 
u64
 
	mlogiÿl
;

242 
u64
 
	m»fs
;

243 
mu‹x
 
	mmu‹x
;

246 
süub_³ndšg_bio_šc
(
süub_ùx
 *
sùx
);

247 
süub_³ndšg_bio_dec
(
süub_ùx
 *
sùx
);

248 
süub_³ndšg_Œªs_wÜk”s_šc
(
süub_ùx
 *
sùx
);

249 
süub_³ndšg_Œªs_wÜk”s_dec
(
süub_ùx
 *
sùx
);

250 
süub_hªdË_”rÜed_block
(
süub_block
 *
sblock_to_check
);

251 
süub_£tup_»check_block
(
süub_block
 *
Üigš®_sblock
,

252 
süub_block
 *
sblocks_fÜ_»check
);

253 
süub_»check_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

254 
süub_block
 *
sblock
,

255 
»Œy_çžed_mœrÜ
);

256 
süub_»check_block_checksum
(
süub_block
 *
sblock
);

257 
süub_»·œ_block_äom_good_cÝy
(
süub_block
 *
sblock_bad
,

258 
süub_block
 *
sblock_good
);

259 
süub_»·œ_·ge_äom_good_cÝy
(
süub_block
 *
sblock_bad
,

260 
süub_block
 *
sblock_good
,

261 
·ge_num
, 
fÜû_wr™e
);

262 
süub_wr™e_block_to_dev_»¶aû
(
süub_block
 *
sblock
);

263 
süub_wr™e_·ge_to_dev_»¶aû
(
süub_block
 *
sblock
,

264 
·ge_num
);

265 
süub_checksum_d©a
(
süub_block
 *
sblock
);

266 
süub_checksum_Œ“_block
(
süub_block
 *
sblock
);

267 
süub_checksum_su³r
(
süub_block
 *
sblock
);

268 
süub_block_g‘
(
süub_block
 *
sblock
);

269 
süub_block_put
(
süub_block
 *
sblock
);

270 
süub_·ge_g‘
(
süub_·ge
 *
¥age
);

271 
süub_·ge_put
(
süub_·ge
 *
¥age
);

272 
süub_·r™y_g‘
(
süub_·r™y
 *
¥¬™y
);

273 
süub_·r™y_put
(
süub_·r™y
 *
¥¬™y
);

274 
süub_add_·ge_to_rd_bio
(
süub_ùx
 *
sùx
,

275 
süub_·ge
 *
¥age
);

276 
süub_·ges
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
, u64 
Ën
,

277 
u64
 
physiÿl
, 
bŒfs_deviû
 *
dev
, u64 
æags
,

278 
u64
 
g’
, 
mœrÜ_num
, 
u8
 *
csum
, 
fÜû
,

279 
u64
 
physiÿl_fÜ_dev_»¶aû
);

280 
süub_bio_’d_io
(
bio
 *bio);

281 
süub_bio_’d_io_wÜk”
(
bŒfs_wÜk
 *
wÜk
);

282 
süub_block_com¶‘e
(
süub_block
 *
sblock
);

283 
süub_»m­_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

284 
u64
 
ex‹Á_logiÿl
, u64 
ex‹Á_Ën
,

285 
u64
 *
ex‹Á_physiÿl
,

286 
bŒfs_deviû
 **
ex‹Á_dev
,

287 *
ex‹Á_mœrÜ_num
);

288 
süub_add_·ge_to_wr_bio
(
süub_ùx
 *
sùx
,

289 
süub_·ge
 *
¥age
);

290 
süub_wr_subm™
(
süub_ùx
 *
sùx
);

291 
süub_wr_bio_’d_io
(
bio
 *bio);

292 
süub_wr_bio_’d_io_wÜk”
(
bŒfs_wÜk
 *
wÜk
);

293 
wr™e_·ge_nocow
(
süub_ùx
 *
sùx
,

294 
u64
 
physiÿl_fÜ_dev_»¶aû
, 
·ge
 *page);

295 
cÝy_nocow_·ges_fÜ_šode
(
u64
 
šum
, u64 
off£t
, u64 
roÙ
,

296 
süub_cÝy_nocow_ùx
 *
ùx
);

297 
cÝy_nocow_·ges
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
, u64 
Ën
,

298 
mœrÜ_num
, 
u64
 
physiÿl_fÜ_dev_»¶aû
);

299 
cÝy_nocow_·ges_wÜk”
(
bŒfs_wÜk
 *
wÜk
);

300 
__süub_blocked_if_Ãeded
(
bŒfs_fs_šfo
 *
fs_šfo
);

301 
süub_blocked_if_Ãeded
(
bŒfs_fs_šfo
 *
fs_šfo
);

302 
süub_put_ùx
(
süub_ùx
 *
sùx
);

305 
	$süub_³ndšg_bio_šc
(
süub_ùx
 *
sùx
)

307 
	`»fcouÁ_šc
(&
sùx
->
»fs
);

308 
	`©omic_šc
(&
sùx
->
bios_š_æight
);

309 
	}
}

311 
	$süub_³ndšg_bio_dec
(
süub_ùx
 *
sùx
)

313 
	`©omic_dec
(&
sùx
->
bios_š_æight
);

314 
	`wake_up
(&
sùx
->
li¡_wa™
);

315 
	`süub_put_ùx
(
sùx
);

316 
	}
}

318 
	$__süub_blocked_if_Ãeded
(
bŒfs_fs_šfo
 *
fs_šfo
)

320 
	`©omic_»ad
(&
fs_šfo
->
süub_·u£_»q
)) {

321 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

322 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

323 
	`©omic_»ad
(&
fs_šfo
->
süub_·u£_»q
) == 0);

324 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

326 
	}
}

328 
	$süub_·u£_Ú
(
bŒfs_fs_šfo
 *
fs_šfo
)

330 
	`©omic_šc
(&
fs_šfo
->
süubs_·u£d
);

331 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

332 
	}
}

334 
	$süub_·u£_off
(
bŒfs_fs_šfo
 *
fs_šfo
)

336 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

337 
	`__süub_blocked_if_Ãeded
(
fs_šfo
);

338 
	`©omic_dec
(&
fs_šfo
->
süubs_·u£d
);

339 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

341 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

342 
	}
}

344 
	$süub_blocked_if_Ãeded
(
bŒfs_fs_šfo
 *
fs_šfo
)

346 
	`süub_·u£_Ú
(
fs_šfo
);

347 
	`süub_·u£_off
(
fs_šfo
);

348 
	}
}

360 
fuÎ_¡re_lock
 *
	$š£¹_fuÎ_¡re_lock
(

361 
bŒfs_fuÎ_¡re_locks_Œ“
 *
locks_roÙ
,

362 
u64
 
f¡re_logiÿl
)

364 
rb_node
 **
p
;

365 
rb_node
 *
·»Á
 = 
NULL
;

366 
fuÎ_¡re_lock
 *
’Œy
;

367 
fuÎ_¡re_lock
 *
»t
;

369 
	`WARN_ON
(!
	`mu‹x_is_locked
(&
locks_roÙ
->
lock
));

371 
p
 = &
locks_roÙ
->
roÙ
.
rb_node
;

372 *
p
) {

373 
·»Á
 = *
p
;

374 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
fuÎ_¡re_lock
, 
node
);

375 ià(
f¡re_logiÿl
 < 
’Œy
->
logiÿl
) {

376 
p
 = &(*p)->
rb_Ëá
;

377 } ià(
f¡re_logiÿl
 > 
’Œy
->
logiÿl
) {

378 
p
 = &(*p)->
rb_right
;

380 
’Œy
->
»fs
++;

381  
’Œy
;

386 
»t
 = 
	`km®loc
((*»t), 
GFP_KERNEL
);

387 ià(!
»t
)

388  
	`ERR_PTR
(-
ENOMEM
);

389 
»t
->
logiÿl
 = 
f¡re_logiÿl
;

390 
»t
->
»fs
 = 1;

391 
	`mu‹x_š™
(&
»t
->
mu‹x
);

393 
	`rb_lšk_node
(&
»t
->
node
, 
·»Á
, 
p
);

394 
	`rb_š£¹_cÞÜ
(&
»t
->
node
, &
locks_roÙ
->
roÙ
);

395  
»t
;

396 
	}
}

404 
fuÎ_¡re_lock
 *
	$£¬ch_fuÎ_¡re_lock
(

405 
bŒfs_fuÎ_¡re_locks_Œ“
 *
locks_roÙ
,

406 
u64
 
f¡re_logiÿl
)

408 
rb_node
 *
node
;

409 
fuÎ_¡re_lock
 *
’Œy
;

411 
	`WARN_ON
(!
	`mu‹x_is_locked
(&
locks_roÙ
->
lock
));

413 
node
 = 
locks_roÙ
->
roÙ
.
rb_node
;

414 
node
) {

415 
’Œy
 = 
	`rb_’Œy
(
node
, 
fuÎ_¡re_lock
,‚ode);

416 ià(
f¡re_logiÿl
 < 
’Œy
->
logiÿl
)

417 
node
 =‚ode->
rb_Ëá
;

418 ià(
f¡re_logiÿl
 > 
’Œy
->
logiÿl
)

419 
node
 =‚ode->
rb_right
;

421  
’Œy
;

423  
NULL
;

424 
	}
}

431 
u64
 
	$g‘_fuÎ_¡re_logiÿl
(
bŒfs_block_group_ÿche
 *
ÿche
,

432 
u64
 
by‹Ä
)

434 
u64
 
»t
;

440 
	`WARN_ON_ONCE
(
ÿche
->
fuÎ_¡re_Ën
 >ð
U32_MAX
);

446 
»t
 = 
	`div64_u64
(
by‹Ä
 - 
ÿche
->
key
.
objeùid
, cache->
fuÎ_¡re_Ën
) *

447 
ÿche
->
fuÎ_¡re_Ën
 + cache->
key
.
objeùid
;

448  
»t
;

449 
	}
}

462 
	$lock_fuÎ_¡re
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

463 
boÞ
 *
locked_»t
)

465 
bŒfs_block_group_ÿche
 *
bg_ÿche
;

466 
bŒfs_fuÎ_¡re_locks_Œ“
 *
locks_roÙ
;

467 
fuÎ_¡re_lock
 *
exi¡šg
;

468 
u64
 
f¡re_¡¬t
;

469 
»t
 = 0;

471 *
locked_»t
 = 
çl£
;

472 
bg_ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

473 ià(!
bg_ÿche
) {

474 
	`ASSERT
(0);

475  -
ENOENT
;

479 ià(!(
bg_ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

480 
out
;

481 
locks_roÙ
 = &
bg_ÿche
->
fuÎ_¡re_locks_roÙ
;

483 
f¡re_¡¬t
 = 
	`g‘_fuÎ_¡re_logiÿl
(
bg_ÿche
, 
by‹Ä
);

486 
	`mu‹x_lock
(&
locks_roÙ
->
lock
);

487 
exi¡šg
 = 
	`š£¹_fuÎ_¡re_lock
(
locks_roÙ
, 
f¡re_¡¬t
);

488 
	`mu‹x_uÆock
(&
locks_roÙ
->
lock
);

489 ià(
	`IS_ERR
(
exi¡šg
)) {

490 
»t
 = 
	`PTR_ERR
(
exi¡šg
);

491 
out
;

493 
	`mu‹x_lock
(&
exi¡šg
->
mu‹x
);

494 *
locked_»t
 = 
Œue
;

495 
out
:

496 
	`bŒfs_put_block_group
(
bg_ÿche
);

497  
»t
;

498 
	}
}

509 
	$uÆock_fuÎ_¡re
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
by‹Ä
,

510 
boÞ
 
locked
)

512 
bŒfs_block_group_ÿche
 *
bg_ÿche
;

513 
bŒfs_fuÎ_¡re_locks_Œ“
 *
locks_roÙ
;

514 
fuÎ_¡re_lock
 *
f¡re_lock
;

515 
u64
 
f¡re_¡¬t
;

516 
boÞ
 
ä“™
 = 
çl£
;

517 
»t
 = 0;

520 ià(!
locked
)

523 
bg_ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
by‹Ä
);

524 ià(!
bg_ÿche
) {

525 
	`ASSERT
(0);

526  -
ENOENT
;

528 ià(!(
bg_ÿche
->
æags
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

529 
out
;

531 
locks_roÙ
 = &
bg_ÿche
->
fuÎ_¡re_locks_roÙ
;

532 
f¡re_¡¬t
 = 
	`g‘_fuÎ_¡re_logiÿl
(
bg_ÿche
, 
by‹Ä
);

534 
	`mu‹x_lock
(&
locks_roÙ
->
lock
);

535 
f¡re_lock
 = 
	`£¬ch_fuÎ_¡re_lock
(
locks_roÙ
, 
f¡re_¡¬t
);

537 ià(!
f¡re_lock
) {

538 
	`WARN_ON
(1);

539 
»t
 = -
ENOENT
;

540 
	`mu‹x_uÆock
(&
locks_roÙ
->
lock
);

541 
out
;

544 ià(
f¡re_lock
->
»fs
 == 0) {

545 
	`WARN_ON
(1);

546 
	`bŒfs_w¬n
(
fs_šfo
, "full stripe†ock‡t %llu„efcount underflow",

547 
f¡re_lock
->
logiÿl
);

549 
f¡re_lock
->
»fs
--;

552 ià(
f¡re_lock
->
»fs
 == 0) {

553 
	`rb_”a£
(&
f¡re_lock
->
node
, &
locks_roÙ
->
roÙ
);

554 
ä“™
 = 
Œue
;

556 
	`mu‹x_uÆock
(&
locks_roÙ
->
lock
);

558 
	`mu‹x_uÆock
(&
f¡re_lock
->
mu‹x
);

559 ià(
ä“™
)

560 
	`kä“
(
f¡re_lock
);

561 
out
:

562 
	`bŒfs_put_block_group
(
bg_ÿche
);

563  
»t
;

564 
	}
}

570 
	$süub_³ndšg_Œªs_wÜk”s_šc
(
süub_ùx
 *
sùx
)

572 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

574 
	`»fcouÁ_šc
(&
sùx
->
»fs
);

584 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

585 
	`©omic_šc
(&
fs_šfo
->
süubs_ruÂšg
);

586 
	`©omic_šc
(&
fs_šfo
->
süubs_·u£d
);

587 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

596 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

598 
	`©omic_šc
(&
sùx
->
wÜk”s_³ndšg
);

599 
	}
}

602 
	$süub_³ndšg_Œªs_wÜk”s_dec
(
süub_ùx
 *
sùx
)

604 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

610 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

611 
	`©omic_dec
(&
fs_šfo
->
süubs_ruÂšg
);

612 
	`©omic_dec
(&
fs_šfo
->
süubs_·u£d
);

613 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

614 
	`©omic_dec
(&
sùx
->
wÜk”s_³ndšg
);

615 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

616 
	`wake_up
(&
sùx
->
li¡_wa™
);

617 
	`süub_put_ùx
(
sùx
);

618 
	}
}

620 
	$süub_ä“_csums
(
süub_ùx
 *
sùx
)

622 !
	`li¡_em±y
(&
sùx
->
csum_li¡
)) {

623 
bŒfs_Üd”ed_sum
 *
sum
;

624 
sum
 = 
	`li¡_fœ¡_’Œy
(&
sùx
->
csum_li¡
,

625 
bŒfs_Üd”ed_sum
, 
li¡
);

626 
	`li¡_d–
(&
sum
->
li¡
);

627 
	`kä“
(
sum
);

629 
	}
}

631 
nošlše_fÜ_¡ack
 
	$süub_ä“_ùx
(
süub_ùx
 *
sùx
)

633 
i
;

635 ià(!
sùx
)

639 ià(
sùx
->
cu¼
 != -1) {

640 
süub_bio
 *
sbio
 = 
sùx
->
bios
[sùx->
cu¼
];

642 
i
 = 0; i < 
sbio
->
·ge_couÁ
; i++) {

643 
	`WARN_ON
(!
sbio
->
·gev
[
i
]->
·ge
);

644 
	`süub_block_put
(
sbio
->
·gev
[
i
]->
sblock
);

646 
	`bio_put
(
sbio
->
bio
);

649 
i
 = 0; i < 
SCRUB_BIOS_PER_SCTX
; ++i) {

650 
süub_bio
 *
sbio
 = 
sùx
->
bios
[
i
];

652 ià(!
sbio
)

654 
	`kä“
(
sbio
);

657 
	`kä“
(
sùx
->
wr_cu¼_bio
);

658 
	`süub_ä“_csums
(
sùx
);

659 
	`kä“
(
sùx
);

660 
	}
}

662 
	$süub_put_ùx
(
süub_ùx
 *
sùx
)

664 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
sùx
->
»fs
))

665 
	`süub_ä“_ùx
(
sùx
);

666 
	}
}

668 
nošlše_fÜ_¡ack


669 
süub_ùx
 *
	$süub_£tup_ùx
(
bŒfs_deviû
 *
dev
, 
is_dev_»¶aû
)

671 
süub_ùx
 *
sùx
;

672 
i
;

673 
bŒfs_fs_šfo
 *
fs_šfo
 = 
dev
->fs_info;

675 
sùx
 = 
	`kz®loc
((*sùx), 
GFP_KERNEL
);

676 ià(!
sùx
)

677 
nomem
;

678 
	`»fcouÁ_£t
(&
sùx
->
»fs
, 1);

679 
sùx
->
is_dev_»¶aû
 = is_dev_replace;

680 
sùx
->
·ges_³r_rd_bio
 = 
SCRUB_PAGES_PER_RD_BIO
;

681 
sùx
->
cu¼
 = -1;

682 
sùx
->
fs_šfo
 = 
dev
->fs_info;

683 
i
 = 0; i < 
SCRUB_BIOS_PER_SCTX
; ++i) {

684 
süub_bio
 *
sbio
;

686 
sbio
 = 
	`kz®loc
((*sbio), 
GFP_KERNEL
);

687 ià(!
sbio
)

688 
nomem
;

689 
sùx
->
bios
[
i
] = 
sbio
;

691 
sbio
->
šdex
 = 
i
;

692 
sbio
->
sùx
 = sctx;

693 
sbio
->
·ge_couÁ
 = 0;

694 
	`bŒfs_š™_wÜk
(&
sbio
->
wÜk
, 
bŒfs_süub_h–³r
,

695 
süub_bio_’d_io_wÜk”
, 
NULL
, NULL);

697 ià(
i
 !ð
SCRUB_BIOS_PER_SCTX
 - 1)

698 
sùx
->
bios
[
i
]->
Ãxt_ä“
 = i + 1;

700 
sùx
->
bios
[
i
]->
Ãxt_ä“
 = -1;

702 
sùx
->
fœ¡_ä“
 = 0;

703 
	`©omic_£t
(&
sùx
->
bios_š_æight
, 0);

704 
	`©omic_£t
(&
sùx
->
wÜk”s_³ndšg
, 0);

705 
	`©omic_£t
(&
sùx
->
ÿnûl_»q
, 0);

706 
sùx
->
csum_size
 = 
	`bŒfs_su³r_csum_size
(
fs_šfo
->
su³r_cÝy
);

707 
	`INIT_LIST_HEAD
(&
sùx
->
csum_li¡
);

709 
	`¥š_lock_š™
(&
sùx
->
li¡_lock
);

710 
	`¥š_lock_š™
(&
sùx
->
¡©_lock
);

711 
	`š™_wa™queue_h—d
(&
sùx
->
li¡_wa™
);

713 
	`WARN_ON
(
sùx
->
wr_cu¼_bio
 !ð
NULL
);

714 
	`mu‹x_š™
(&
sùx
->
wr_lock
);

715 
sùx
->
wr_cu¼_bio
 = 
NULL
;

716 ià(
is_dev_»¶aû
) {

717 
	`WARN_ON
(!
fs_šfo
->
dev_»¶aû
.
tgtdev
);

718 
sùx
->
·ges_³r_wr_bio
 = 
SCRUB_PAGES_PER_WR_BIO
;

719 
sùx
->
wr_tgtdev
 = 
fs_šfo
->
dev_»¶aû
.
tgtdev
;

720 
sùx
->
æush_®l_wr™es
 = 
çl£
;

723  
sùx
;

725 
nomem
:

726 
	`süub_ä“_ùx
(
sùx
);

727  
	`ERR_PTR
(-
ENOMEM
);

728 
	}
}

730 
	$süub_´št_w¬nšg_šode
(
u64
 
šum
, u64 
off£t
, u64 
roÙ
,

731 *
w¬n_ùx
)

733 
u64
 
isize
;

734 
u32
 
Æšk
;

735 
»t
;

736 
i
;

737 
nofs_æag
;

738 
ex‹Á_bufãr
 *
eb
;

739 
bŒfs_šode_™em
 *
šode_™em
;

740 
süub_w¬nšg
 *
sw¬n
 = 
w¬n_ùx
;

741 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sw¬n
->
dev
->fs_info;

742 
šode_fs_·ths
 *
©h
 = 
NULL
;

743 
bŒfs_roÙ
 *
loÿl_roÙ
;

744 
bŒfs_key
 
roÙ_key
;

745 
bŒfs_key
 
key
;

747 
roÙ_key
.
objeùid
 = 
roÙ
;

748 
roÙ_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

749 
roÙ_key
.
off£t
 = (
u64
)-1;

750 
loÿl_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
roÙ_key
);

751 ià(
	`IS_ERR
(
loÿl_roÙ
)) {

752 
»t
 = 
	`PTR_ERR
(
loÿl_roÙ
);

753 
”r
;

759 
key
.
objeùid
 = 
šum
;

760 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

761 
key
.
off£t
 = 0;

763 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
loÿl_roÙ
, &
key
, 
sw¬n
->
·th
, 0, 0);

764 ià(
»t
) {

765 
	`bŒfs_»Ëa£_·th
(
sw¬n
->
·th
);

766 
”r
;

769 
eb
 = 
sw¬n
->
·th
->
nodes
[0];

770 
šode_™em
 = 
	`bŒfs_™em_±r
(
eb
, 
sw¬n
->
·th
->
¦Ùs
[0],

771 
bŒfs_šode_™em
);

772 
isize
 = 
	`bŒfs_šode_size
(
eb
, 
šode_™em
);

773 
Æšk
 = 
	`bŒfs_šode_Æšk
(
eb
, 
šode_™em
);

774 
	`bŒfs_»Ëa£_·th
(
sw¬n
->
·th
);

781 
nofs_æag
 = 
	`mem®loc_nofs_§ve
();

782 
©h
 = 
	`š™_©h
(4096, 
loÿl_roÙ
, 
sw¬n
->
·th
);

783 
	`mem®loc_nofs_»¡Üe
(
nofs_æag
);

784 ià(
	`IS_ERR
(
©h
)) {

785 
»t
 = 
	`PTR_ERR
(
©h
);

786 
©h
 = 
NULL
;

787 
”r
;

789 
»t
 = 
	`·ths_äom_šode
(
šum
, 
©h
);

791 ià(
»t
 < 0)

792 
”r
;

798 
i
 = 0; i < 
©h
->
f¥©h
->
–em_út
; ++i)

799 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

801 
sw¬n
->
”r¡r
, sw¬n->
logiÿl
,

802 
	`rcu_¡r_d”ef
(
sw¬n
->
dev
->
Çme
),

803 ()
sw¬n
->
£ùÜ
,

804 
roÙ
, 
šum
, 
off£t
,

805 
	`mš
(
isize
 - 
off£t
, (
u64
)
PAGE_SIZE
), 
Æšk
,

806 (*)()
©h
->
f¥©h
->
v®
[
i
]);

808 
	`ä“_©h
(
©h
);

811 
”r
:

812 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

814 
sw¬n
->
”r¡r
, sw¬n->
logiÿl
,

815 
	`rcu_¡r_d”ef
(
sw¬n
->
dev
->
Çme
),

816 ()
sw¬n
->
£ùÜ
,

817 
roÙ
, 
šum
, 
off£t
, 
»t
);

819 
	`ä“_©h
(
©h
);

821 
	}
}

823 
	$süub_´št_w¬nšg
(cÚ¡ *
”r¡r
, 
süub_block
 *
sblock
)

825 
bŒfs_deviû
 *
dev
;

826 
bŒfs_fs_šfo
 *
fs_šfo
;

827 
bŒfs_·th
 *
·th
;

828 
bŒfs_key
 
found_key
;

829 
ex‹Á_bufãr
 *
eb
;

830 
bŒfs_ex‹Á_™em
 *
ei
;

831 
süub_w¬nšg
 
sw¬n
;

832 
±r
 = 0;

833 
u64
 
ex‹Á_™em_pos
;

834 
u64
 
æags
 = 0;

835 
u64
 
»f_roÙ
;

836 
u32
 
™em_size
;

837 
u8
 
»f_Ëv–
 = 0;

838 
»t
;

840 
	`WARN_ON
(
sblock
->
·ge_couÁ
 < 1);

841 
dev
 = 
sblock
->
·gev
[0]->dev;

842 
fs_šfo
 = 
sblock
->
sùx
->fs_info;

844 
·th
 = 
	`bŒfs_®loc_·th
();

845 ià(!
·th
)

848 
sw¬n
.
£ùÜ
 = (
sblock
->
·gev
[0]->
physiÿl
) >> 9;

849 
sw¬n
.
logiÿl
 = 
sblock
->
·gev
[0]->logical;

850 
sw¬n
.
”r¡r
 =ƒrrstr;

851 
sw¬n
.
dev
 = 
NULL
;

853 
»t
 = 
	`ex‹Á_äom_logiÿl
(
fs_šfo
, 
sw¬n
.
logiÿl
, 
·th
, &
found_key
,

854 &
æags
);

855 ià(
»t
 < 0)

856 
out
;

858 
ex‹Á_™em_pos
 = 
sw¬n
.
logiÿl
 - 
found_key
.
objeùid
;

859 
sw¬n
.
ex‹Á_™em_size
 = 
found_key
.
off£t
;

861 
eb
 = 
·th
->
nodes
[0];

862 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

863 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
·th
->
¦Ùs
[0]);

865 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

867 
»t
 = 
	`Œ“_back»f_fÜ_ex‹Á
(&
±r
, 
eb
, &
found_key
, 
ei
,

868 
™em_size
, &
»f_roÙ
,

869 &
»f_Ëv–
);

870 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

872 
”r¡r
, 
sw¬n
.
logiÿl
,

873 
	`rcu_¡r_d”ef
(
dev
->
Çme
),

874 ()
sw¬n
.
£ùÜ
,

875 
»f_Ëv–
 ? "node" : "leaf",

876 
»t
 < 0 ? -1 : 
»f_Ëv–
,

877 
»t
 < 0 ? -1 : 
»f_roÙ
);

878 } 
»t
 != 1);

879 
	`bŒfs_»Ëa£_·th
(
·th
);

881 
	`bŒfs_»Ëa£_·th
(
·th
);

882 
sw¬n
.
·th
 =…ath;

883 
sw¬n
.
dev
 = dev;

884 
	`™”©e_ex‹Á_šodes
(
fs_šfo
, 
found_key
.
objeùid
,

885 
ex‹Á_™em_pos
, 1,

886 
süub_´št_w¬nšg_šode
, &
sw¬n
);

889 
out
:

890 
	`bŒfs_ä“_·th
(
·th
);

891 
	}
}

893 
	$süub_fixup_»ad·ge
(
u64
 
šum
, u64 
off£t
, u64 
roÙ
, *
fixup_ùx
)

895 
·ge
 *·gð
NULL
;

896 
šdex
;

897 
süub_fixup_nod©asum
 *
fixup
 = 
fixup_ùx
;

898 
»t
;

899 
cÜ»ùed
 = 0;

900 
bŒfs_key
 
key
;

901 
šode
 *šodð
NULL
;

902 
bŒfs_fs_šfo
 *
fs_šfo
;

903 
u64
 
’d
 = 
off£t
 + 
PAGE_SIZE
 - 1;

904 
bŒfs_roÙ
 *
loÿl_roÙ
;

905 
¤cu_šdex
;

907 
key
.
objeùid
 = 
roÙ
;

908 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

909 
key
.
off£t
 = (
u64
)-1;

911 
fs_šfo
 = 
fixup
->
roÙ
->fs_info;

912 
¤cu_šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

914 
loÿl_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

915 ià(
	`IS_ERR
(
loÿl_roÙ
)) {

916 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
¤cu_šdex
);

917  
	`PTR_ERR
(
loÿl_roÙ
);

920 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

921 
key
.
objeùid
 = 
šum
;

922 
key
.
off£t
 = 0;

923 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
loÿl_roÙ
, 
NULL
);

924 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
¤cu_šdex
);

925 ià(
	`IS_ERR
(
šode
))

926  
	`PTR_ERR
(
šode
);

928 
šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

930 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
GFP_NOFS
);

931 ià(!
·ge
) {

932 
»t
 = -
ENOMEM
;

933 
out
;

936 ià(
	`PageU±od©e
(
·ge
)) {

937 ià(
	`PageDœty
(
·ge
)) {

954 
»t
 = -
EIO
;

955 
out
;

957 
»t
 = 
	`»·œ_io_çžu»
(
fs_šfo
, 
šum
, 
off£t
, 
PAGE_SIZE
,

958 
fixup
->
logiÿl
, 
·ge
,

959 
off£t
 - 
	`·ge_off£t
(
·ge
),

960 
fixup
->
mœrÜ_num
);

961 
	`uÆock_·ge
(
·ge
);

962 
cÜ»ùed
 = !
»t
;

969 
»t
 = 
	`£t_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
off£t
, 
’d
,

970 
EXTENT_DAMAGED
);

971 ià(
»t
) {

973 
	`WARN_ON
(
»t
 > 0);

974 ià(
»t
 > 0)

975 
»t
 = -
EFAULT
;

976 
out
;

979 
»t
 = 
	`ex‹Á_»ad_fuÎ_·ge
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
·ge
,

980 
bŒfs_g‘_ex‹Á
,

981 
fixup
->
mœrÜ_num
);

982 
	`wa™_Ú_·ge_locked
(
·ge
);

984 
cÜ»ùed
 = !
	`‹¡_¿nge_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
off£t
,

985 
’d
, 
EXTENT_DAMAGED
, 0, 
NULL
);

986 ià(!
cÜ»ùed
)

987 
	`þ—r_ex‹Á_b™s
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 
off£t
, 
’d
,

988 
EXTENT_DAMAGED
);

991 
out
:

992 ià(
·ge
)

993 
	`put_·ge
(
·ge
);

995 
	`ut
(
šode
);

997 ià(
»t
 < 0)

998  
»t
;

1000 ià(
»t
 =ð0 && 
cÜ»ùed
) {

1008  -
EIO
;

1009 
	}
}

1011 
	$süub_fixup_nod©asum
(
bŒfs_wÜk
 *
wÜk
)

1013 
bŒfs_fs_šfo
 *
fs_šfo
;

1014 
»t
;

1015 
süub_fixup_nod©asum
 *
fixup
;

1016 
süub_ùx
 *
sùx
;

1017 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

1018 
bŒfs_·th
 *
·th
;

1019 
uncÜ»ùabË
 = 0;

1021 
fixup
 = 
	`cÚš”_of
(
wÜk
, 
süub_fixup_nod©asum
, work);

1022 
sùx
 = 
fixup
->sctx;

1023 
fs_šfo
 = 
fixup
->
roÙ
->fs_info;

1025 
·th
 = 
	`bŒfs_®loc_·th
();

1026 ià(!
·th
) {

1027 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1028 ++
sùx
->
¡©
.
m®loc_”rÜs
;

1029 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1030 
uncÜ»ùabË
 = 1;

1031 
out
;

1034 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
fixup
->
roÙ
);

1035 ià(
	`IS_ERR
(
Œªs
)) {

1036 
uncÜ»ùabË
 = 1;

1037 
out
;

1049 
»t
 = 
	`™”©e_šodes_äom_logiÿl
(
fixup
->
logiÿl
, 
fs_šfo
, 
·th
,

1050 
süub_fixup_»ad·ge
, 
fixup
);

1051 ià(
»t
 < 0) {

1052 
uncÜ»ùabË
 = 1;

1053 
out
;

1055 
	`WARN_ON
(
»t
 != 1);

1057 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1058 ++
sùx
->
¡©
.
cÜ»ùed_”rÜs
;

1059 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1061 
out
:

1062 ià(
Œªs
 && !
	`IS_ERR
(trans))

1063 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1064 ià(
uncÜ»ùabË
) {

1065 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1066 ++
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
;

1067 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1068 
	`bŒfs_dev_»¶aû_¡©s_šc
(

1069 &
fs_šfo
->
dev_»¶aû
.
num_uncÜ»ùabË_»ad_”rÜs
);

1070 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

1072 
fixup
->
logiÿl
, 
	`rcu_¡r_d”ef
(fixup->
dev
->
Çme
));

1075 
	`bŒfs_ä“_·th
(
·th
);

1076 
	`kä“
(
fixup
);

1078 
	`süub_³ndšg_Œªs_wÜk”s_dec
(
sùx
);

1079 
	}
}

1081 
šlše
 
	$süub_g‘_»cov”
(
süub_»cov”
 *
»cov”
)

1083 
	`»fcouÁ_šc
(&
»cov”
->
»fs
);

1084 
	}
}

1086 
šlše
 
	$süub_put_»cov”
(
bŒfs_fs_šfo
 *
fs_šfo
,

1087 
süub_»cov”
 *
»cov”
)

1089 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
»cov”
->
»fs
)) {

1090 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1091 
	`bŒfs_put_bbio
(
»cov”
->
bbio
);

1092 
	`kä“
(
»cov”
);

1094 
	}
}

1104 
	$süub_hªdË_”rÜed_block
(
süub_block
 *
sblock_to_check
)

1106 
süub_ùx
 *
sùx
 = 
sblock_to_check
->sctx;

1107 
bŒfs_deviû
 *
dev
;

1108 
bŒfs_fs_šfo
 *
fs_šfo
;

1109 
u64
 
Ëngth
;

1110 
u64
 
logiÿl
;

1111 
çžed_mœrÜ_šdex
;

1112 
is_m‘ad©a
;

1113 
have_csum
;

1114 
süub_block
 *
sblocks_fÜ_»check
;

1115 
süub_block
 *
sblock_bad
;

1116 
»t
;

1117 
mœrÜ_šdex
;

1118 
·ge_num
;

1119 
sucûss
;

1120 
boÞ
 
fuÎ_¡re_locked
;

1121 
	`DEFINE_RATELIMIT_STATE
(
_rs
, 
DEFAULT_RATELIMIT_INTERVAL
,

1122 
DEFAULT_RATELIMIT_BURST
);

1124 
	`BUG_ON
(
sblock_to_check
->
·ge_couÁ
 < 1);

1125 
fs_šfo
 = 
sùx
->fs_info;

1126 ià(
sblock_to_check
->
·gev
[0]->
æags
 & 
BTRFS_EXTENT_FLAG_SUPER
) {

1132 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1133 ++
sùx
->
¡©
.
su³r_”rÜs
;

1134 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1137 
Ëngth
 = 
sblock_to_check
->
·ge_couÁ
 * 
PAGE_SIZE
;

1138 
logiÿl
 = 
sblock_to_check
->
·gev
[0]->logical;

1139 
	`BUG_ON
(
sblock_to_check
->
·gev
[0]->
mœrÜ_num
 < 1);

1140 
çžed_mœrÜ_šdex
 = 
sblock_to_check
->
·gev
[0]->
mœrÜ_num
 - 1;

1141 
is_m‘ad©a
 = !(
sblock_to_check
->
·gev
[0]->
æags
 &

1142 
BTRFS_EXTENT_FLAG_DATA
);

1143 
have_csum
 = 
sblock_to_check
->
·gev
[0]->have_csum;

1144 
dev
 = 
sblock_to_check
->
·gev
[0]->dev;

1153 
»t
 = 
	`lock_fuÎ_¡re
(
fs_šfo
, 
logiÿl
, &
fuÎ_¡re_locked
);

1154 ià(
»t
 < 0) {

1155 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1156 ià(
»t
 =ð-
ENOMEM
)

1157 
sùx
->
¡©
.
m®loc_”rÜs
++;

1158 
sùx
->
¡©
.
»ad_”rÜs
++;

1159 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

1160 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1161  
»t
;

1164 ià(
sùx
->
is_dev_»¶aû
 && !
is_m‘ad©a
 && !
have_csum
) {

1165 
sblocks_fÜ_»check
 = 
NULL
;

1166 
nod©asum_ÿ£
;

1198 
sblocks_fÜ_»check
 = 
	`kÿÎoc
(
BTRFS_MAX_MIRRORS
,

1199 (*
sblocks_fÜ_»check
), 
GFP_NOFS
);

1200 ià(!
sblocks_fÜ_»check
) {

1201 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1202 
sùx
->
¡©
.
m®loc_”rÜs
++;

1203 
sùx
->
¡©
.
»ad_”rÜs
++;

1204 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

1205 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1206 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
);

1207 
out
;

1211 
»t
 = 
	`süub_£tup_»check_block
(
sblock_to_check
, 
sblocks_fÜ_»check
);

1212 ià(
»t
) {

1213 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1214 
sùx
->
¡©
.
»ad_”rÜs
++;

1215 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

1216 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1217 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
);

1218 
out
;

1220 
	`BUG_ON
(
çžed_mœrÜ_šdex
 >ð
BTRFS_MAX_MIRRORS
);

1221 
sblock_bad
 = 
sblocks_fÜ_»check
 + 
çžed_mœrÜ_šdex
;

1224 
	`süub_»check_block
(
fs_šfo
, 
sblock_bad
, 1);

1226 ià(!
sblock_bad
->
h—d”_”rÜ
 && !sblock_bad->
checksum_”rÜ
 &&

1227 
sblock_bad
->
no_io_”rÜ_£’
) {

1236 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1237 
sùx
->
¡©
.
unv”if›d_”rÜs
++;

1238 
sblock_to_check
->
d©a_cÜ»ùed
 = 1;

1239 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1241 ià(
sùx
->
is_dev_»¶aû
)

1242 
	`süub_wr™e_block_to_dev_»¶aû
(
sblock_bad
);

1243 
out
;

1246 ià(!
sblock_bad
->
no_io_”rÜ_£’
) {

1247 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1248 
sùx
->
¡©
.
»ad_”rÜs
++;

1249 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1250 ià(
	`__¿‹lim™
(&
_rs
))

1251 
	`süub_´št_w¬nšg
("i/Ø”rÜ", 
sblock_to_check
);

1252 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
);

1253 } ià(
sblock_bad
->
checksum_”rÜ
) {

1254 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1255 
sùx
->
¡©
.
csum_”rÜs
++;

1256 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1257 ià(
	`__¿‹lim™
(&
_rs
))

1258 
	`süub_´št_w¬nšg
("checksumƒ¼Ü", 
sblock_to_check
);

1259 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
,

1260 
BTRFS_DEV_STAT_CORRUPTION_ERRS
);

1261 } ià(
sblock_bad
->
h—d”_”rÜ
) {

1262 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1263 
sùx
->
¡©
.
v”ify_”rÜs
++;

1264 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1265 ià(
	`__¿‹lim™
(&
_rs
))

1266 
	`süub_´št_w¬nšg
("checksum/headerƒrror",

1267 
sblock_to_check
);

1268 ià(
sblock_bad
->
g’”©iÚ_”rÜ
)

1269 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
,

1270 
BTRFS_DEV_STAT_GENERATION_ERRS
);

1272 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
,

1273 
BTRFS_DEV_STAT_CORRUPTION_ERRS
);

1276 ià(
sùx
->
»adÚly
) {

1277 
	`ASSERT
(!
sùx
->
is_dev_»¶aû
);

1278 
out
;

1281 ià(!
is_m‘ad©a
 && !
have_csum
) {

1282 
süub_fixup_nod©asum
 *
fixup_nod©asum
;

1284 
	`WARN_ON
(
sùx
->
is_dev_»¶aû
);

1286 
nod©asum_ÿ£
:

1295 
fixup_nod©asum
 = 
	`kz®loc
((*fixup_nod©asum), 
GFP_NOFS
);

1296 ià(!
fixup_nod©asum
)

1297 
did_nÙ_cÜ»ù_”rÜ
;

1298 
fixup_nod©asum
->
sùx
 = sctx;

1299 
fixup_nod©asum
->
dev
 = dev;

1300 
fixup_nod©asum
->
logiÿl
 =†ogical;

1301 
fixup_nod©asum
->
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

1302 
fixup_nod©asum
->
mœrÜ_num
 = 
çžed_mœrÜ_šdex
 + 1;

1303 
	`süub_³ndšg_Œªs_wÜk”s_šc
(
sùx
);

1304 
	`bŒfs_š™_wÜk
(&
fixup_nod©asum
->
wÜk
, 
bŒfs_süub_h–³r
,

1305 
süub_fixup_nod©asum
, 
NULL
, NULL);

1306 
	`bŒfs_queue_wÜk
(
fs_šfo
->
süub_wÜk”s
,

1307 &
fixup_nod©asum
->
wÜk
);

1308 
out
;

1326 
mœrÜ_šdex
 = 0;

1327 
mœrÜ_šdex
 < 
BTRFS_MAX_MIRRORS
 &&

1328 
sblocks_fÜ_»check
[
mœrÜ_šdex
].
·ge_couÁ
 > 0;

1329 
mœrÜ_šdex
++) {

1330 
süub_block
 *
sblock_Ùh”
;

1332 ià(
mœrÜ_šdex
 =ð
çžed_mœrÜ_šdex
)

1334 
sblock_Ùh”
 = 
sblocks_fÜ_»check
 + 
mœrÜ_šdex
;

1337 
	`süub_»check_block
(
fs_šfo
, 
sblock_Ùh”
, 0);

1339 ià(!
sblock_Ùh”
->
h—d”_”rÜ
 &&

1340 !
sblock_Ùh”
->
checksum_”rÜ
 &&

1341 
sblock_Ùh”
->
no_io_”rÜ_£’
) {

1342 ià(
sùx
->
is_dev_»¶aû
) {

1343 
	`süub_wr™e_block_to_dev_»¶aû
(
sblock_Ùh”
);

1344 
cÜ»ùed_”rÜ
;

1346 
»t
 = 
	`süub_»·œ_block_äom_good_cÝy
(

1347 
sblock_bad
, 
sblock_Ùh”
);

1348 ià(!
»t
)

1349 
cÜ»ùed_”rÜ
;

1354 ià(
sblock_bad
->
no_io_”rÜ_£’
 && !
sùx
->
is_dev_»¶aû
)

1355 
did_nÙ_cÜ»ù_”rÜ
;

1381 
sucûss
 = 1;

1382 
·ge_num
 = 0;…age_num < 
sblock_bad
->
·ge_couÁ
;

1383 
·ge_num
++) {

1384 
süub_·ge
 *
·ge_bad
 = 
sblock_bad
->
·gev
[
·ge_num
];

1385 
süub_block
 *
sblock_Ùh”
 = 
NULL
;

1388 ià(!
·ge_bad
->
io_”rÜ
 && !
sùx
->
is_dev_»¶aû
)

1392 ià(
·ge_bad
->
io_”rÜ
) {

1393 
mœrÜ_šdex
 = 0;

1394 
mœrÜ_šdex
 < 
BTRFS_MAX_MIRRORS
 &&

1395 
sblocks_fÜ_»check
[
mœrÜ_šdex
].
·ge_couÁ
 > 0;

1396 
mœrÜ_šdex
++) {

1397 ià(!
sblocks_fÜ_»check
[
mœrÜ_šdex
].

1398 
·gev
[
·ge_num
]->
io_”rÜ
) {

1399 
sblock_Ùh”
 = 
sblocks_fÜ_»check
 +

1400 
mœrÜ_šdex
;

1404 ià(!
sblock_Ùh”
)

1405 
sucûss
 = 0;

1408 ià(
sùx
->
is_dev_»¶aû
) {

1416 ià(!
sblock_Ùh”
)

1417 
sblock_Ùh”
 = 
sblock_bad
;

1419 ià(
	`süub_wr™e_·ge_to_dev_»¶aû
(
sblock_Ùh”
,

1420 
·ge_num
) != 0) {

1421 
	`bŒfs_dev_»¶aû_¡©s_šc
(

1422 &
fs_šfo
->
dev_»¶aû
.
num_wr™e_”rÜs
);

1423 
sucûss
 = 0;

1425 } ià(
sblock_Ùh”
) {

1426 
»t
 = 
	`süub_»·œ_·ge_äom_good_cÝy
(
sblock_bad
,

1427 
sblock_Ùh”
,

1428 
·ge_num
, 0);

1429 ià(0 =ð
»t
)

1430 
·ge_bad
->
io_”rÜ
 = 0;

1432 
sucûss
 = 0;

1436 ià(
sucûss
 && !
sùx
->
is_dev_»¶aû
) {

1437 ià(
is_m‘ad©a
 || 
have_csum
) {

1447 
	`süub_»check_block
(
fs_šfo
, 
sblock_bad
, 1);

1448 ià(!
sblock_bad
->
h—d”_”rÜ
 &&

1449 !
sblock_bad
->
checksum_”rÜ
 &&

1450 
sblock_bad
->
no_io_”rÜ_£’
)

1451 
cÜ»ùed_”rÜ
;

1453 
did_nÙ_cÜ»ù_”rÜ
;

1455 
cÜ»ùed_”rÜ
:

1456 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1457 
sùx
->
¡©
.
cÜ»ùed_”rÜs
++;

1458 
sblock_to_check
->
d©a_cÜ»ùed
 = 1;

1459 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1460 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

1462 
logiÿl
, 
	`rcu_¡r_d”ef
(
dev
->
Çme
));

1465 
did_nÙ_cÜ»ù_”rÜ
:

1466 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1467 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

1468 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1469 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

1471 
logiÿl
, 
	`rcu_¡r_d”ef
(
dev
->
Çme
));

1474 
out
:

1475 ià(
sblocks_fÜ_»check
) {

1476 
mœrÜ_šdex
 = 0; mœrÜ_šdex < 
BTRFS_MAX_MIRRORS
;

1477 
mœrÜ_šdex
++) {

1478 
süub_block
 *
sblock
 = 
sblocks_fÜ_»check
 +

1479 
mœrÜ_šdex
;

1480 
süub_»cov”
 *
»cov”
;

1481 
·ge_šdex
;

1483 
·ge_šdex
 = 0;…age_šdex < 
sblock
->
·ge_couÁ
;

1484 
·ge_šdex
++) {

1485 
sblock
->
·gev
[
·ge_šdex
]->sblock = 
NULL
;

1486 
»cov”
 = 
sblock
->
·gev
[
·ge_šdex
]->recover;

1487 ià(
»cov”
) {

1488 
	`süub_put_»cov”
(
fs_šfo
, 
»cov”
);

1489 
sblock
->
·gev
[
·ge_šdex
]->
»cov”
 =

1490 
NULL
;

1492 
	`süub_·ge_put
(
sblock
->
·gev
[
·ge_šdex
]);

1495 
	`kä“
(
sblocks_fÜ_»check
);

1498 
»t
 = 
	`uÆock_fuÎ_¡re
(
fs_šfo
, 
logiÿl
, 
fuÎ_¡re_locked
);

1499 ià(
»t
 < 0)

1500  
»t
;

1502 
	}
}

1504 
šlše
 
	$süub_Ä_¿id_mœrÜs
(
bŒfs_bio
 *
bbio
)

1506 ià(
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
)

1508 ià(
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

1511  ()
bbio
->
num_¡res
;

1512 
	}
}

1514 
šlše
 
	$süub_¡re_šdex_ªd_off£t
(
u64
 
logiÿl
, u64 
m­_ty³
,

1515 
u64
 *
¿id_m­
,

1516 
u64
 
m­³d_Ëngth
,

1517 
n¡res
, 
mœrÜ
,

1518 *
¡re_šdex
,

1519 
u64
 *
¡re_off£t
)

1521 
i
;

1523 ià(
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

1525 
i
 = 0; i < 
n¡res
; i++) {

1526 ià(
¿id_m­
[
i
] =ð
RAID6_Q_STRIPE
 ||

1527 
¿id_m­
[
i
] =ð
RAID5_P_STRIPE
)

1530 ià(
logiÿl
 >ð
¿id_m­
[
i
] &&

1531 
logiÿl
 < 
¿id_m­
[
i
] + 
m­³d_Ëngth
)

1535 *
¡re_šdex
 = 
i
;

1536 *
¡re_off£t
 = 
logiÿl
 - 
¿id_m­
[
i
];

1539 *
¡re_šdex
 = 
mœrÜ
;

1540 *
¡re_off£t
 = 0;

1542 
	}
}

1544 
	$süub_£tup_»check_block
(
süub_block
 *
Üigš®_sblock
,

1545 
süub_block
 *
sblocks_fÜ_»check
)

1547 
süub_ùx
 *
sùx
 = 
Üigš®_sblock
->sctx;

1548 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

1549 
u64
 
Ëngth
 = 
Üigš®_sblock
->
·ge_couÁ
 * 
PAGE_SIZE
;

1550 
u64
 
logiÿl
 = 
Üigš®_sblock
->
·gev
[0]->logical;

1551 
u64
 
g’”©iÚ
 = 
Üigš®_sblock
->
·gev
[0]->generation;

1552 
u64
 
æags
 = 
Üigš®_sblock
->
·gev
[0]->flags;

1553 
u64
 
have_csum
 = 
Üigš®_sblock
->
·gev
[0]->have_csum;

1554 
süub_»cov”
 *
»cov”
;

1555 
bŒfs_bio
 *
bbio
;

1556 
u64
 
subËn
;

1557 
u64
 
m­³d_Ëngth
;

1558 
u64
 
¡re_off£t
;

1559 
¡re_šdex
;

1560 
·ge_šdex
 = 0;

1561 
mœrÜ_šdex
;

1562 
nmœrÜs
;

1563 
»t
;

1571 
Ëngth
 > 0) {

1572 
subËn
 = 
	`mš_t
(
u64
, 
Ëngth
, 
PAGE_SIZE
);

1573 
m­³d_Ëngth
 = 
subËn
;

1574 
bbio
 = 
NULL
;

1580 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

1581 
»t
 = 
	`bŒfs_m­_sblock
(
fs_šfo
, 
BTRFS_MAP_GET_READ_MIRRORS
,

1582 
logiÿl
, &
m­³d_Ëngth
, &
bbio
);

1583 ià(
»t
 || !
bbio
 || 
m­³d_Ëngth
 < 
subËn
) {

1584 
	`bŒfs_put_bbio
(
bbio
);

1585 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1586  -
EIO
;

1589 
»cov”
 = 
	`kz®loc
((
süub_»cov”
), 
GFP_NOFS
);

1590 ià(!
»cov”
) {

1591 
	`bŒfs_put_bbio
(
bbio
);

1592 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

1593  -
ENOMEM
;

1596 
	`»fcouÁ_£t
(&
»cov”
->
»fs
, 1);

1597 
»cov”
->
bbio
 = bbio;

1598 
»cov”
->
m­_Ëngth
 = 
m­³d_Ëngth
;

1600 
	`BUG_ON
(
·ge_šdex
 >ð
SCRUB_MAX_PAGES_PER_BLOCK
);

1602 
nmœrÜs
 = 
	`mš
(
	`süub_Ä_¿id_mœrÜs
(
bbio
), 
BTRFS_MAX_MIRRORS
);

1604 
mœrÜ_šdex
 = 0; mœrÜ_šdex < 
nmœrÜs
;

1605 
mœrÜ_šdex
++) {

1606 
süub_block
 *
sblock
;

1607 
süub_·ge
 *
·ge
;

1609 
sblock
 = 
sblocks_fÜ_»check
 + 
mœrÜ_šdex
;

1610 
sblock
->
sùx
 = sctx;

1612 
·ge
 = 
	`kz®loc
((*·ge), 
GFP_NOFS
);

1613 ià(!
·ge
) {

1614 
Ëave_nomem
:

1615 
	`¥š_lock
(&
sùx
->
¡©_lock
);

1616 
sùx
->
¡©
.
m®loc_”rÜs
++;

1617 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

1618 
	`süub_put_»cov”
(
fs_šfo
, 
»cov”
);

1619  -
ENOMEM
;

1621 
	`süub_·ge_g‘
(
·ge
);

1622 
sblock
->
·gev
[
·ge_šdex
] = 
·ge
;

1623 
·ge
->
sblock
 = sblock;

1624 
·ge
->
æags
 = flags;

1625 
·ge
->
g’”©iÚ
 = generation;

1626 
·ge
->
logiÿl
 =†ogical;

1627 
·ge
->
have_csum
 = have_csum;

1628 ià(
have_csum
)

1629 
	`memýy
(
·ge
->
csum
,

1630 
Üigš®_sblock
->
·gev
[0]->
csum
,

1631 
sùx
->
csum_size
);

1633 
	`süub_¡re_šdex_ªd_off£t
(
logiÿl
,

1634 
bbio
->
m­_ty³
,

1635 
bbio
->
¿id_m­
,

1636 
m­³d_Ëngth
,

1637 
bbio
->
num_¡res
 -

1638 
bbio
->
num_tgtdevs
,

1639 
mœrÜ_šdex
,

1640 &
¡re_šdex
,

1641 &
¡re_off£t
);

1642 
·ge
->
physiÿl
 = 
bbio
->
¡res
[
¡re_šdex
].physical +

1643 
¡re_off£t
;

1644 
·ge
->
dev
 = 
bbio
->
¡res
[
¡re_šdex
].dev;

1646 
	`BUG_ON
(
·ge_šdex
 >ð
Üigš®_sblock
->
·ge_couÁ
);

1647 
·ge
->
physiÿl_fÜ_dev_»¶aû
 =

1648 
Üigš®_sblock
->
·gev
[
·ge_šdex
]->

1649 
physiÿl_fÜ_dev_»¶aû
;

1651 
·ge
->
mœrÜ_num
 = 
mœrÜ_šdex
 + 1;

1652 
sblock
->
·ge_couÁ
++;

1653 
·ge
->·gð
	`®loc_·ge
(
GFP_NOFS
);

1654 ià(!
·ge
->page)

1655 
Ëave_nomem
;

1657 
	`süub_g‘_»cov”
(
»cov”
);

1658 
·ge
->
»cov”
 =„ecover;

1660 
	`süub_put_»cov”
(
fs_šfo
, 
»cov”
);

1661 
Ëngth
 -ð
subËn
;

1662 
logiÿl
 +ð
subËn
;

1663 
·ge_šdex
++;

1667 
	}
}

1669 
	ssüub_bio_»t
 {

1670 
com¶‘iÚ
 
	mev’t
;

1671 
blk_¡©us_t
 
	m¡©us
;

1674 
	$süub_bio_wa™_’dio
(
bio
 *bio)

1676 
süub_bio_»t
 *
»t
 = 
bio
->
bi_´iv©e
;

1678 
»t
->
¡©us
 = 
bio
->
bi_¡©us
;

1679 
	`com¶‘e
(&
»t
->
ev’t
);

1680 
	}
}

1682 
šlše
 
	$süub_is_·ge_Ú_¿id56
(
süub_·ge
 *
·ge
)

1684  
·ge
->
»cov”
 &&

1685 (
·ge
->
»cov”
->
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
);

1686 
	}
}

1688 
	$süub_subm™_¿id56_bio_wa™
(
bŒfs_fs_šfo
 *
fs_šfo
,

1689 
bio
 *bio,

1690 
süub_·ge
 *
·ge
)

1692 
süub_bio_»t
 
dÚe
;

1693 
»t
;

1695 
	`š™_com¶‘iÚ
(&
dÚe
.
ev’t
);

1696 
dÚe
.
¡©us
 = 0;

1697 
bio
->
bi_™”
.
bi_£ùÜ
 = 
·ge
->
logiÿl
 >> 9;

1698 
bio
->
bi_´iv©e
 = &
dÚe
;

1699 
bio
->
bi_’d_io
 = 
süub_bio_wa™_’dio
;

1701 
»t
 = 
	`¿id56_·r™y_»cov”
(
fs_šfo
, 
bio
, 
·ge
->
»cov”
->
bbio
,

1702 
·ge
->
»cov”
->
m­_Ëngth
,

1703 
·ge
->
mœrÜ_num
, 0);

1704 ià(
»t
)

1705  
»t
;

1707 
	`wa™_fÜ_com¶‘iÚ_io
(&
dÚe
.
ev’t
);

1708 ià(
dÚe
.
¡©us
)

1709  -
EIO
;

1712 
	}
}

1721 
	$süub_»check_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

1722 
süub_block
 *
sblock
,

1723 
»Œy_çžed_mœrÜ
)

1725 
·ge_num
;

1727 
sblock
->
no_io_”rÜ_£’
 = 1;

1729 
·ge_num
 = 0;…age_num < 
sblock
->
·ge_couÁ
;…age_num++) {

1730 
bio
 *bio;

1731 
süub_·ge
 *
·ge
 = 
sblock
->
·gev
[
·ge_num
];

1733 ià(
·ge
->
dev
->
bdev
 =ð
NULL
) {

1734 
·ge
->
io_”rÜ
 = 1;

1735 
sblock
->
no_io_”rÜ_£’
 = 0;

1739 
	`WARN_ON
(!
·ge
->page);

1740 
bio
 = 
	`bŒfs_io_bio_®loc
(1);

1741 
	`bio_£t_dev
(
bio
, 
·ge
->
dev
->
bdev
);

1743 
	`bio_add_·ge
(
bio
, 
·ge
->·ge, 
PAGE_SIZE
, 0);

1744 ià(!
»Œy_çžed_mœrÜ
 && 
	`süub_is_·ge_Ú_¿id56
(
·ge
)) {

1745 ià(
	`süub_subm™_¿id56_bio_wa™
(
fs_šfo
, 
bio
, 
·ge
)) {

1746 
·ge
->
io_”rÜ
 = 1;

1747 
sblock
->
no_io_”rÜ_£’
 = 0;

1750 
bio
->
bi_™”
.
bi_£ùÜ
 = 
·ge
->
physiÿl
 >> 9;

1751 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

1753 ià(
	`bŒfsic_subm™_bio_wa™
(
bio
)) {

1754 
·ge
->
io_”rÜ
 = 1;

1755 
sblock
->
no_io_”rÜ_£’
 = 0;

1759 
	`bio_put
(
bio
);

1762 ià(
sblock
->
no_io_”rÜ_£’
)

1763 
	`süub_»check_block_checksum
(
sblock
);

1764 
	}
}

1766 
šlše
 
	$süub_check_fsid
(
u8
 
fsid
[],

1767 
süub_·ge
 *
¥age
)

1769 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
¥age
->
dev
->fs_devices;

1770 
»t
;

1772 
»t
 = 
	`memcmp
(
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
);

1773  !
»t
;

1774 
	}
}

1776 
	$süub_»check_block_checksum
(
süub_block
 *
sblock
)

1778 
sblock
->
h—d”_”rÜ
 = 0;

1779 
sblock
->
checksum_”rÜ
 = 0;

1780 
sblock
->
g’”©iÚ_”rÜ
 = 0;

1782 ià(
sblock
->
·gev
[0]->
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)

1783 
	`süub_checksum_d©a
(
sblock
);

1785 
	`süub_checksum_Œ“_block
(
sblock
);

1786 
	}
}

1788 
	$süub_»·œ_block_äom_good_cÝy
(
süub_block
 *
sblock_bad
,

1789 
süub_block
 *
sblock_good
)

1791 
·ge_num
;

1792 
»t
 = 0;

1794 
·ge_num
 = 0;…age_num < 
sblock_bad
->
·ge_couÁ
;…age_num++) {

1795 
»t_sub
;

1797 
»t_sub
 = 
	`süub_»·œ_·ge_äom_good_cÝy
(
sblock_bad
,

1798 
sblock_good
,

1799 
·ge_num
, 1);

1800 ià(
»t_sub
)

1801 
»t
 = 
»t_sub
;

1804  
»t
;

1805 
	}
}

1807 
	$süub_»·œ_·ge_äom_good_cÝy
(
süub_block
 *
sblock_bad
,

1808 
süub_block
 *
sblock_good
,

1809 
·ge_num
, 
fÜû_wr™e
)

1811 
süub_·ge
 *
·ge_bad
 = 
sblock_bad
->
·gev
[
·ge_num
];

1812 
süub_·ge
 *
·ge_good
 = 
sblock_good
->
·gev
[
·ge_num
];

1813 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sblock_bad
->
sùx
->fs_info;

1815 
	`BUG_ON
(
·ge_bad
->
·ge
 =ð
NULL
);

1816 
	`BUG_ON
(
·ge_good
->
·ge
 =ð
NULL
);

1817 ià(
fÜû_wr™e
 || 
sblock_bad
->
h—d”_”rÜ
 ||

1818 
sblock_bad
->
checksum_”rÜ
 || 
·ge_bad
->
io_”rÜ
) {

1819 
bio
 *bio;

1820 
»t
;

1822 ià(!
·ge_bad
->
dev
->
bdev
) {

1823 
	`bŒfs_w¬n_¾
(
fs_šfo
,

1825  -
EIO
;

1828 
bio
 = 
	`bŒfs_io_bio_®loc
(1);

1829 
	`bio_£t_dev
(
bio
, 
·ge_bad
->
dev
->
bdev
);

1830 
bio
->
bi_™”
.
bi_£ùÜ
 = 
·ge_bad
->
physiÿl
 >> 9;

1831 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

1833 
»t
 = 
	`bio_add_·ge
(
bio
, 
·ge_good
->
·ge
, 
PAGE_SIZE
, 0);

1834 ià(
PAGE_SIZE
 !ð
»t
) {

1835 
	`bio_put
(
bio
);

1836  -
EIO
;

1839 ià(
	`bŒfsic_subm™_bio_wa™
(
bio
)) {

1840 
	`bŒfs_dev_¡©_šc_ªd_´št
(
·ge_bad
->
dev
,

1841 
BTRFS_DEV_STAT_WRITE_ERRS
);

1842 
	`bŒfs_dev_»¶aû_¡©s_šc
(

1843 &
fs_šfo
->
dev_»¶aû
.
num_wr™e_”rÜs
);

1844 
	`bio_put
(
bio
);

1845  -
EIO
;

1847 
	`bio_put
(
bio
);

1851 
	}
}

1853 
	$süub_wr™e_block_to_dev_»¶aû
(
süub_block
 *
sblock
)

1855 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sblock
->
sùx
->fs_info;

1856 
·ge_num
;

1862 ià(
sblock
->
¥¬™y
)

1865 
·ge_num
 = 0;…age_num < 
sblock
->
·ge_couÁ
;…age_num++) {

1866 
»t
;

1868 
»t
 = 
	`süub_wr™e_·ge_to_dev_»¶aû
(
sblock
, 
·ge_num
);

1869 ià(
»t
)

1870 
	`bŒfs_dev_»¶aû_¡©s_šc
(

1871 &
fs_šfo
->
dev_»¶aû
.
num_wr™e_”rÜs
);

1873 
	}
}

1875 
	$süub_wr™e_·ge_to_dev_»¶aû
(
süub_block
 *
sblock
,

1876 
·ge_num
)

1878 
süub_·ge
 *
¥age
 = 
sblock
->
·gev
[
·ge_num
];

1880 
	`BUG_ON
(
¥age
->
·ge
 =ð
NULL
);

1881 ià(
¥age
->
io_”rÜ
) {

1882 *
m­³d_bufãr
 = 
	`km­_©omic
(
¥age
->
·ge
);

1884 
	`þ—r_·ge
(
m­³d_bufãr
);

1885 
	`æush_dÿche_·ge
(
¥age
->
·ge
);

1886 
	`kunm­_©omic
(
m­³d_bufãr
);

1888  
	`süub_add_·ge_to_wr_bio
(
sblock
->
sùx
, 
¥age
);

1889 
	}
}

1891 
	$süub_add_·ge_to_wr_bio
(
süub_ùx
 *
sùx
,

1892 
süub_·ge
 *
¥age
)

1894 
süub_bio
 *
sbio
;

1895 
»t
;

1897 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

1898 
agaš
:

1899 ià(!
sùx
->
wr_cu¼_bio
) {

1900 
sùx
->
wr_cu¼_bio
 = 
	`kz®loc
((*sctx->wr_curr_bio),

1901 
GFP_KERNEL
);

1902 ià(!
sùx
->
wr_cu¼_bio
) {

1903 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

1904  -
ENOMEM
;

1906 
sùx
->
wr_cu¼_bio
->sctx = sctx;

1907 
sùx
->
wr_cu¼_bio
->
·ge_couÁ
 = 0;

1909 
sbio
 = 
sùx
->
wr_cu¼_bio
;

1910 ià(
sbio
->
·ge_couÁ
 == 0) {

1911 
bio
 *bio;

1913 
sbio
->
physiÿl
 = 
¥age
->
physiÿl_fÜ_dev_»¶aû
;

1914 
sbio
->
logiÿl
 = 
¥age
->logical;

1915 
sbio
->
dev
 = 
sùx
->
wr_tgtdev
;

1916 
bio
 = 
sbio
->bio;

1917 ià(!
bio
) {

1918 
bio
 = 
	`bŒfs_io_bio_®loc
(
sùx
->
·ges_³r_wr_bio
);

1919 
sbio
->
bio
 = bio;

1922 
bio
->
bi_´iv©e
 = 
sbio
;

1923 
bio
->
bi_’d_io
 = 
süub_wr_bio_’d_io
;

1924 
	`bio_£t_dev
(
bio
, 
sbio
->
dev
->
bdev
);

1925 
bio
->
bi_™”
.
bi_£ùÜ
 = 
sbio
->
physiÿl
 >> 9;

1926 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_WRITE
, 0);

1927 
sbio
->
¡©us
 = 0;

1928 } ià(
sbio
->
physiÿl
 + sbio->
·ge_couÁ
 * 
PAGE_SIZE
 !=

1929 
¥age
->
physiÿl_fÜ_dev_»¶aû
 ||

1930 
sbio
->
logiÿl
 + sbio->
·ge_couÁ
 * 
PAGE_SIZE
 !=

1931 
¥age
->
logiÿl
) {

1932 
	`süub_wr_subm™
(
sùx
);

1933 
agaš
;

1936 
»t
 = 
	`bio_add_·ge
(
sbio
->
bio
, 
¥age
->
·ge
, 
PAGE_SIZE
, 0);

1937 ià(
»t
 !ð
PAGE_SIZE
) {

1938 ià(
sbio
->
·ge_couÁ
 < 1) {

1939 
	`bio_put
(
sbio
->
bio
);

1940 
sbio
->
bio
 = 
NULL
;

1941 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

1942  -
EIO
;

1944 
	`süub_wr_subm™
(
sùx
);

1945 
agaš
;

1948 
sbio
->
·gev
[sbio->
·ge_couÁ
] = 
¥age
;

1949 
	`süub_·ge_g‘
(
¥age
);

1950 
sbio
->
·ge_couÁ
++;

1951 ià(
sbio
->
·ge_couÁ
 =ð
sùx
->
·ges_³r_wr_bio
)

1952 
	`süub_wr_subm™
(
sùx
);

1953 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

1956 
	}
}

1958 
	$süub_wr_subm™
(
süub_ùx
 *
sùx
)

1960 
süub_bio
 *
sbio
;

1962 ià(!
sùx
->
wr_cu¼_bio
)

1965 
sbio
 = 
sùx
->
wr_cu¼_bio
;

1966 
sùx
->
wr_cu¼_bio
 = 
NULL
;

1967 
	`WARN_ON
(!
sbio
->
bio
->
bi_disk
);

1968 
	`süub_³ndšg_bio_šc
(
sùx
);

1973 
	`bŒfsic_subm™_bio
(
sbio
->
bio
);

1974 
	}
}

1976 
	$süub_wr_bio_’d_io
(
bio
 *bio)

1978 
süub_bio
 *
sbio
 = 
bio
->
bi_´iv©e
;

1979 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sbio
->
dev
->fs_info;

1981 
sbio
->
¡©us
 = 
bio
->
bi_¡©us
;

1982 
sbio
->
bio
 = bio;

1984 
	`bŒfs_š™_wÜk
(&
sbio
->
wÜk
, 
bŒfs_süubwrc_h–³r
,

1985 
süub_wr_bio_’d_io_wÜk”
, 
NULL
, NULL);

1986 
	`bŒfs_queue_wÜk
(
fs_šfo
->
süub_wr_com¶‘iÚ_wÜk”s
, &
sbio
->
wÜk
);

1987 
	}
}

1989 
	$süub_wr_bio_’d_io_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

1991 
süub_bio
 *
sbio
 = 
	`cÚš”_of
(
wÜk
, scrub_bio, work);

1992 
süub_ùx
 *
sùx
 = 
sbio
->sctx;

1993 
i
;

1995 
	`WARN_ON
(
sbio
->
·ge_couÁ
 > 
SCRUB_PAGES_PER_WR_BIO
);

1996 ià(
sbio
->
¡©us
) {

1997 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 =

1998 &
sbio
->
sùx
->
fs_šfo
->
dev_»¶aû
;

2000 
i
 = 0; i < 
sbio
->
·ge_couÁ
; i++) {

2001 
süub_·ge
 *
¥age
 = 
sbio
->
·gev
[
i
];

2003 
¥age
->
io_”rÜ
 = 1;

2004 
	`bŒfs_dev_»¶aû_¡©s_šc
(&
dev_»¶aû
->

2005 
num_wr™e_”rÜs
);

2009 
i
 = 0; i < 
sbio
->
·ge_couÁ
; i++)

2010 
	`süub_·ge_put
(
sbio
->
·gev
[
i
]);

2012 
	`bio_put
(
sbio
->
bio
);

2013 
	`kä“
(
sbio
);

2014 
	`süub_³ndšg_bio_dec
(
sùx
);

2015 
	}
}

2017 
	$süub_checksum
(
süub_block
 *
sblock
)

2019 
u64
 
æags
;

2020 
»t
;

2030 
sblock
->
h—d”_”rÜ
 = 0;

2031 
sblock
->
g’”©iÚ_”rÜ
 = 0;

2032 
sblock
->
checksum_”rÜ
 = 0;

2034 
	`WARN_ON
(
sblock
->
·ge_couÁ
 < 1);

2035 
æags
 = 
sblock
->
·gev
[0]->flags;

2036 
»t
 = 0;

2037 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
)

2038 
»t
 = 
	`süub_checksum_d©a
(
sblock
);

2039 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
)

2040 
»t
 = 
	`süub_checksum_Œ“_block
(
sblock
);

2041 ià(
æags
 & 
BTRFS_EXTENT_FLAG_SUPER
)

2042 ()
	`süub_checksum_su³r
(
sblock
);

2044 
	`WARN_ON
(1);

2045 ià(
»t
)

2046 
	`süub_hªdË_”rÜed_block
(
sblock
);

2048  
»t
;

2049 
	}
}

2051 
	$süub_checksum_d©a
(
süub_block
 *
sblock
)

2053 
süub_ùx
 *
sùx
 = 
sblock
->sctx;

2054 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

2055 
u8
 *
Ú_disk_csum
;

2056 
·ge
 *page;

2057 *
bufãr
;

2058 
u32
 
üc
 = ~(u32)0;

2059 
u64
 
Ën
;

2060 
šdex
;

2062 
	`BUG_ON
(
sblock
->
·ge_couÁ
 < 1);

2063 ià(!
sblock
->
·gev
[0]->
have_csum
)

2066 
Ú_disk_csum
 = 
sblock
->
·gev
[0]->
csum
;

2067 
·ge
 = 
sblock
->
·gev
[0]->page;

2068 
bufãr
 = 
	`km­_©omic
(
·ge
);

2070 
Ën
 = 
sùx
->
fs_šfo
->
£ùÜsize
;

2071 
šdex
 = 0;

2073 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
PAGE_SIZE
);

2075 
üc
 = 
	`bŒfs_csum_d©a
(
bufãr
, crc, 
l
);

2076 
	`kunm­_©omic
(
bufãr
);

2077 
Ën
 -ð
l
;

2078 ià(
Ën
 == 0)

2080 
šdex
++;

2081 
	`BUG_ON
(
šdex
 >ð
sblock
->
·ge_couÁ
);

2082 
	`BUG_ON
(!
sblock
->
·gev
[
šdex
]->
·ge
);

2083 
·ge
 = 
sblock
->
·gev
[
šdex
]->page;

2084 
bufãr
 = 
	`km­_©omic
(
·ge
);

2087 
	`bŒfs_csum_fš®
(
üc
, 
csum
);

2088 ià(
	`memcmp
(
csum
, 
Ú_disk_csum
, 
sùx
->
csum_size
))

2089 
sblock
->
checksum_”rÜ
 = 1;

2091  
sblock
->
checksum_”rÜ
;

2092 
	}
}

2094 
	$süub_checksum_Œ“_block
(
süub_block
 *
sblock
)

2096 
süub_ùx
 *
sùx
 = 
sblock
->sctx;

2097 
bŒfs_h—d”
 *
h
;

2098 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2099 
u8
 
ÿlcuÏ‹d_csum
[
BTRFS_CSUM_SIZE
];

2100 
u8
 
Ú_disk_csum
[
BTRFS_CSUM_SIZE
];

2101 
·ge
 *page;

2102 *
m­³d_bufãr
;

2103 
u64
 
m­³d_size
;

2104 *
p
;

2105 
u32
 
üc
 = ~(u32)0;

2106 
u64
 
Ën
;

2107 
šdex
;

2109 
	`BUG_ON
(
sblock
->
·ge_couÁ
 < 1);

2110 
·ge
 = 
sblock
->
·gev
[0]->page;

2111 
m­³d_bufãr
 = 
	`km­_©omic
(
·ge
);

2112 
h
 = (
bŒfs_h—d”
 *)
m­³d_bufãr
;

2113 
	`memýy
(
Ú_disk_csum
, 
h
->
csum
, 
sùx
->
csum_size
);

2120 ià(
sblock
->
·gev
[0]->
logiÿl
 !ð
	`bŒfs_¡ack_h—d”_by‹Ä
(
h
))

2121 
sblock
->
h—d”_”rÜ
 = 1;

2123 ià(
sblock
->
·gev
[0]->
g’”©iÚ
 !ð
	`bŒfs_¡ack_h—d”_g’”©iÚ
(
h
)) {

2124 
sblock
->
h—d”_”rÜ
 = 1;

2125 
sblock
->
g’”©iÚ_”rÜ
 = 1;

2128 ià(!
	`süub_check_fsid
(
h
->
fsid
, 
sblock
->
·gev
[0]))

2129 
sblock
->
h—d”_”rÜ
 = 1;

2131 ià(
	`memcmp
(
h
->
chunk_Œ“_uuid
, 
fs_šfo
->chunk_tree_uuid,

2132 
BTRFS_UUID_SIZE
))

2133 
sblock
->
h—d”_”rÜ
 = 1;

2135 
Ën
 = 
sùx
->
fs_šfo
->
nodesize
 - 
BTRFS_CSUM_SIZE
;

2136 
m­³d_size
 = 
PAGE_SIZE
 - 
BTRFS_CSUM_SIZE
;

2137 
p
 = ((
u8
 *)
m­³d_bufãr
è+ 
BTRFS_CSUM_SIZE
;

2138 
šdex
 = 0;

2140 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
m­³d_size
);

2142 
üc
 = 
	`bŒfs_csum_d©a
(
p
, crc, 
l
);

2143 
	`kunm­_©omic
(
m­³d_bufãr
);

2144 
Ën
 -ð
l
;

2145 ià(
Ën
 == 0)

2147 
šdex
++;

2148 
	`BUG_ON
(
šdex
 >ð
sblock
->
·ge_couÁ
);

2149 
	`BUG_ON
(!
sblock
->
·gev
[
šdex
]->
·ge
);

2150 
·ge
 = 
sblock
->
·gev
[
šdex
]->page;

2151 
m­³d_bufãr
 = 
	`km­_©omic
(
·ge
);

2152 
m­³d_size
 = 
PAGE_SIZE
;

2153 
p
 = 
m­³d_bufãr
;

2156 
	`bŒfs_csum_fš®
(
üc
, 
ÿlcuÏ‹d_csum
);

2157 ià(
	`memcmp
(
ÿlcuÏ‹d_csum
, 
Ú_disk_csum
, 
sùx
->
csum_size
))

2158 
sblock
->
checksum_”rÜ
 = 1;

2160  
sblock
->
h—d”_”rÜ
 || sblock->
checksum_”rÜ
;

2161 
	}
}

2163 
	$süub_checksum_su³r
(
süub_block
 *
sblock
)

2165 
bŒfs_su³r_block
 *
s
;

2166 
süub_ùx
 *
sùx
 = 
sblock
->sctx;

2167 
u8
 
ÿlcuÏ‹d_csum
[
BTRFS_CSUM_SIZE
];

2168 
u8
 
Ú_disk_csum
[
BTRFS_CSUM_SIZE
];

2169 
·ge
 *page;

2170 *
m­³d_bufãr
;

2171 
u64
 
m­³d_size
;

2172 *
p
;

2173 
u32
 
üc
 = ~(u32)0;

2174 
çž_g’
 = 0;

2175 
çž_cÜ
 = 0;

2176 
u64
 
Ën
;

2177 
šdex
;

2179 
	`BUG_ON
(
sblock
->
·ge_couÁ
 < 1);

2180 
·ge
 = 
sblock
->
·gev
[0]->page;

2181 
m­³d_bufãr
 = 
	`km­_©omic
(
·ge
);

2182 
s
 = (
bŒfs_su³r_block
 *)
m­³d_bufãr
;

2183 
	`memýy
(
Ú_disk_csum
, 
s
->
csum
, 
sùx
->
csum_size
);

2185 ià(
sblock
->
·gev
[0]->
logiÿl
 !ð
	`bŒfs_su³r_by‹Ä
(
s
))

2186 ++
çž_cÜ
;

2188 ià(
sblock
->
·gev
[0]->
g’”©iÚ
 !ð
	`bŒfs_su³r_g’”©iÚ
(
s
))

2189 ++
çž_g’
;

2191 ià(!
	`süub_check_fsid
(
s
->
fsid
, 
sblock
->
·gev
[0]))

2192 ++
çž_cÜ
;

2194 
Ën
 = 
BTRFS_SUPER_INFO_SIZE
 - 
BTRFS_CSUM_SIZE
;

2195 
m­³d_size
 = 
PAGE_SIZE
 - 
BTRFS_CSUM_SIZE
;

2196 
p
 = ((
u8
 *)
m­³d_bufãr
è+ 
BTRFS_CSUM_SIZE
;

2197 
šdex
 = 0;

2199 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
m­³d_size
);

2201 
üc
 = 
	`bŒfs_csum_d©a
(
p
, crc, 
l
);

2202 
	`kunm­_©omic
(
m­³d_bufãr
);

2203 
Ën
 -ð
l
;

2204 ià(
Ën
 == 0)

2206 
šdex
++;

2207 
	`BUG_ON
(
šdex
 >ð
sblock
->
·ge_couÁ
);

2208 
	`BUG_ON
(!
sblock
->
·gev
[
šdex
]->
·ge
);

2209 
·ge
 = 
sblock
->
·gev
[
šdex
]->page;

2210 
m­³d_bufãr
 = 
	`km­_©omic
(
·ge
);

2211 
m­³d_size
 = 
PAGE_SIZE
;

2212 
p
 = 
m­³d_bufãr
;

2215 
	`bŒfs_csum_fš®
(
üc
, 
ÿlcuÏ‹d_csum
);

2216 ià(
	`memcmp
(
ÿlcuÏ‹d_csum
, 
Ú_disk_csum
, 
sùx
->
csum_size
))

2217 ++
çž_cÜ
;

2219 ià(
çž_cÜ
 + 
çž_g’
) {

2225 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2226 ++
sùx
->
¡©
.
su³r_”rÜs
;

2227 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2228 ià(
çž_cÜ
)

2229 
	`bŒfs_dev_¡©_šc_ªd_´št
(
sblock
->
·gev
[0]->
dev
,

2230 
BTRFS_DEV_STAT_CORRUPTION_ERRS
);

2232 
	`bŒfs_dev_¡©_šc_ªd_´št
(
sblock
->
·gev
[0]->
dev
,

2233 
BTRFS_DEV_STAT_GENERATION_ERRS
);

2236  
çž_cÜ
 + 
çž_g’
;

2237 
	}
}

2239 
	$süub_block_g‘
(
süub_block
 *
sblock
)

2241 
	`»fcouÁ_šc
(&
sblock
->
»fs
);

2242 
	}
}

2244 
	$süub_block_put
(
süub_block
 *
sblock
)

2246 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
sblock
->
»fs
)) {

2247 
i
;

2249 ià(
sblock
->
¥¬™y
)

2250 
	`süub_·r™y_put
(
sblock
->
¥¬™y
);

2252 
i
 = 0; i < 
sblock
->
·ge_couÁ
; i++)

2253 
	`süub_·ge_put
(
sblock
->
·gev
[
i
]);

2254 
	`kä“
(
sblock
);

2256 
	}
}

2258 
	$süub_·ge_g‘
(
süub_·ge
 *
¥age
)

2260 
	`©omic_šc
(&
¥age
->
»fs
);

2261 
	}
}

2263 
	$süub_·ge_put
(
süub_·ge
 *
¥age
)

2265 ià(
	`©omic_dec_ªd_‹¡
(&
¥age
->
»fs
)) {

2266 ià(
¥age
->
·ge
)

2267 
	`__ä“_·ge
(
¥age
->
·ge
);

2268 
	`kä“
(
¥age
);

2270 
	}
}

2272 
	$süub_subm™
(
süub_ùx
 *
sùx
)

2274 
süub_bio
 *
sbio
;

2276 ià(
sùx
->
cu¼
 == -1)

2279 
sbio
 = 
sùx
->
bios
[sùx->
cu¼
];

2280 
sùx
->
cu¼
 = -1;

2281 
	`süub_³ndšg_bio_šc
(
sùx
);

2282 
	`bŒfsic_subm™_bio
(
sbio
->
bio
);

2283 
	}
}

2285 
	$süub_add_·ge_to_rd_bio
(
süub_ùx
 *
sùx
,

2286 
süub_·ge
 *
¥age
)

2288 
süub_block
 *
sblock
 = 
¥age
->sblock;

2289 
süub_bio
 *
sbio
;

2290 
»t
;

2292 
agaš
:

2296 
sùx
->
cu¼
 == -1) {

2297 
	`¥š_lock
(&
sùx
->
li¡_lock
);

2298 
sùx
->
cu¼
 = sùx->
fœ¡_ä“
;

2299 ià(
sùx
->
cu¼
 != -1) {

2300 
sùx
->
fœ¡_ä“
 = sùx->
bios
[sùx->
cu¼
]->
Ãxt_ä“
;

2301 
sùx
->
bios
[sùx->
cu¼
]->
Ãxt_ä“
 = -1;

2302 
sùx
->
bios
[sùx->
cu¼
]->
·ge_couÁ
 = 0;

2303 
	`¥š_uÆock
(&
sùx
->
li¡_lock
);

2305 
	`¥š_uÆock
(&
sùx
->
li¡_lock
);

2306 
	`wa™_ev’t
(
sùx
->
li¡_wa™
, sùx->
fœ¡_ä“
 != -1);

2309 
sbio
 = 
sùx
->
bios
[sùx->
cu¼
];

2310 ià(
sbio
->
·ge_couÁ
 == 0) {

2311 
bio
 *bio;

2313 
sbio
->
physiÿl
 = 
¥age
->physical;

2314 
sbio
->
logiÿl
 = 
¥age
->logical;

2315 
sbio
->
dev
 = 
¥age
->dev;

2316 
bio
 = 
sbio
->bio;

2317 ià(!
bio
) {

2318 
bio
 = 
	`bŒfs_io_bio_®loc
(
sùx
->
·ges_³r_rd_bio
);

2319 
sbio
->
bio
 = bio;

2322 
bio
->
bi_´iv©e
 = 
sbio
;

2323 
bio
->
bi_’d_io
 = 
süub_bio_’d_io
;

2324 
	`bio_£t_dev
(
bio
, 
sbio
->
dev
->
bdev
);

2325 
bio
->
bi_™”
.
bi_£ùÜ
 = 
sbio
->
physiÿl
 >> 9;

2326 
	`bio_£t_Ý_©Œs
(
bio
, 
REQ_OP_READ
, 0);

2327 
sbio
->
¡©us
 = 0;

2328 } ià(
sbio
->
physiÿl
 + sbio->
·ge_couÁ
 * 
PAGE_SIZE
 !=

2329 
¥age
->
physiÿl
 ||

2330 
sbio
->
logiÿl
 + sbio->
·ge_couÁ
 * 
PAGE_SIZE
 !=

2331 
¥age
->
logiÿl
 ||

2332 
sbio
->
dev
 !ð
¥age
->dev) {

2333 
	`süub_subm™
(
sùx
);

2334 
agaš
;

2337 
sbio
->
·gev
[sbio->
·ge_couÁ
] = 
¥age
;

2338 
»t
 = 
	`bio_add_·ge
(
sbio
->
bio
, 
¥age
->
·ge
, 
PAGE_SIZE
, 0);

2339 ià(
»t
 !ð
PAGE_SIZE
) {

2340 ià(
sbio
->
·ge_couÁ
 < 1) {

2341 
	`bio_put
(
sbio
->
bio
);

2342 
sbio
->
bio
 = 
NULL
;

2343  -
EIO
;

2345 
	`süub_subm™
(
sùx
);

2346 
agaš
;

2349 
	`süub_block_g‘
(
sblock
);

2350 
	`©omic_šc
(&
sblock
->
out¡ªdšg_·ges
);

2351 
sbio
->
·ge_couÁ
++;

2352 ià(
sbio
->
·ge_couÁ
 =ð
sùx
->
·ges_³r_rd_bio
)

2353 
	`süub_subm™
(
sùx
);

2356 
	}
}

2358 
	$süub_missšg_¿id56_’d_io
(
bio
 *bio)

2360 
süub_block
 *
sblock
 = 
bio
->
bi_´iv©e
;

2361 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sblock
->
sùx
->fs_info;

2363 ià(
bio
->
bi_¡©us
)

2364 
sblock
->
no_io_”rÜ_£’
 = 0;

2366 
	`bio_put
(
bio
);

2368 
	`bŒfs_queue_wÜk
(
fs_šfo
->
süub_wÜk”s
, &
sblock
->
wÜk
);

2369 
	}
}

2371 
	$süub_missšg_¿id56_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

2373 
süub_block
 *
sblock
 = 
	`cÚš”_of
(
wÜk
, scrub_block, work);

2374 
süub_ùx
 *
sùx
 = 
sblock
->sctx;

2375 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2376 
u64
 
logiÿl
;

2377 
bŒfs_deviû
 *
dev
;

2379 
logiÿl
 = 
sblock
->
·gev
[0]->logical;

2380 
dev
 = 
sblock
->
·gev
[0]->dev;

2382 ià(
sblock
->
no_io_”rÜ_£’
)

2383 
	`süub_»check_block_checksum
(
sblock
);

2385 ià(!
sblock
->
no_io_”rÜ_£’
) {

2386 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2387 
sùx
->
¡©
.
»ad_”rÜs
++;

2388 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2389 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

2391 
logiÿl
, 
	`rcu_¡r_d”ef
(
dev
->
Çme
));

2392 } ià(
sblock
->
h—d”_”rÜ
 || sblock->
checksum_”rÜ
) {

2393 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2394 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

2395 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2396 
	`bŒfs_”r_¾_š_rcu
(
fs_šfo
,

2398 
logiÿl
, 
	`rcu_¡r_d”ef
(
dev
->
Çme
));

2400 
	`süub_wr™e_block_to_dev_»¶aû
(
sblock
);

2403 
	`süub_block_put
(
sblock
);

2405 ià(
sùx
->
is_dev_»¶aû
 && sùx->
æush_®l_wr™es
) {

2406 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

2407 
	`süub_wr_subm™
(
sùx
);

2408 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

2411 
	`süub_³ndšg_bio_dec
(
sùx
);

2412 
	}
}

2414 
	$süub_missšg_¿id56_·ges
(
süub_block
 *
sblock
)

2416 
süub_ùx
 *
sùx
 = 
sblock
->sctx;

2417 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

2418 
u64
 
Ëngth
 = 
sblock
->
·ge_couÁ
 * 
PAGE_SIZE
;

2419 
u64
 
logiÿl
 = 
sblock
->
·gev
[0]->logical;

2420 
bŒfs_bio
 *
bbio
 = 
NULL
;

2421 
bio
 *bio;

2422 
bŒfs_¿id_bio
 *
rbio
;

2423 
»t
;

2424 
i
;

2426 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

2427 
»t
 = 
	`bŒfs_m­_sblock
(
fs_šfo
, 
BTRFS_MAP_GET_READ_MIRRORS
, 
logiÿl
,

2428 &
Ëngth
, &
bbio
);

2429 ià(
»t
 || !
bbio
 || !bbio->
¿id_m­
)

2430 
bbio_out
;

2432 ià(
	`WARN_ON
(!
sùx
->
is_dev_»¶aû
 ||

2433 !(
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))) {

2440 
bbio_out
;

2443 
bio
 = 
	`bŒfs_io_bio_®loc
(0);

2444 
bio
->
bi_™”
.
bi_£ùÜ
 = 
logiÿl
 >> 9;

2445 
bio
->
bi_´iv©e
 = 
sblock
;

2446 
bio
->
bi_’d_io
 = 
süub_missšg_¿id56_’d_io
;

2448 
rbio
 = 
	`¿id56_®loc_missšg_rbio
(
fs_šfo
, 
bio
, 
bbio
, 
Ëngth
);

2449 ià(!
rbio
)

2450 
rbio_out
;

2452 
i
 = 0; i < 
sblock
->
·ge_couÁ
; i++) {

2453 
süub_·ge
 *
¥age
 = 
sblock
->
·gev
[
i
];

2455 
	`¿id56_add_süub_·ges
(
rbio
, 
¥age
->
·ge
, s·ge->
logiÿl
);

2458 
	`bŒfs_š™_wÜk
(&
sblock
->
wÜk
, 
bŒfs_süub_h–³r
,

2459 
süub_missšg_¿id56_wÜk”
, 
NULL
, NULL);

2460 
	`süub_block_g‘
(
sblock
);

2461 
	`süub_³ndšg_bio_šc
(
sùx
);

2462 
	`¿id56_subm™_missšg_rbio
(
rbio
);

2465 
rbio_out
:

2466 
	`bio_put
(
bio
);

2467 
bbio_out
:

2468 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

2469 
	`bŒfs_put_bbio
(
bbio
);

2470 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2471 
sùx
->
¡©
.
m®loc_”rÜs
++;

2472 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2473 
	}
}

2475 
	$süub_·ges
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
, u64 
Ën
,

2476 
u64
 
physiÿl
, 
bŒfs_deviû
 *
dev
, u64 
æags
,

2477 
u64
 
g’
, 
mœrÜ_num
, 
u8
 *
csum
, 
fÜû
,

2478 
u64
 
physiÿl_fÜ_dev_»¶aû
)

2480 
süub_block
 *
sblock
;

2481 
šdex
;

2483 
sblock
 = 
	`kz®loc
((*sblock), 
GFP_KERNEL
);

2484 ià(!
sblock
) {

2485 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2486 
sùx
->
¡©
.
m®loc_”rÜs
++;

2487 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2488  -
ENOMEM
;

2493 
	`»fcouÁ_£t
(&
sblock
->
»fs
, 1);

2494 
sblock
->
sùx
 = sctx;

2495 
sblock
->
no_io_”rÜ_£’
 = 1;

2497 
šdex
 = 0; 
Ën
 > 0; index++) {

2498 
süub_·ge
 *
¥age
;

2499 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
PAGE_SIZE
);

2501 
¥age
 = 
	`kz®loc
((*¥age), 
GFP_KERNEL
);

2502 ià(!
¥age
) {

2503 
Ëave_nomem
:

2504 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2505 
sùx
->
¡©
.
m®loc_”rÜs
++;

2506 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2507 
	`süub_block_put
(
sblock
);

2508  -
ENOMEM
;

2510 
	`BUG_ON
(
šdex
 >ð
SCRUB_MAX_PAGES_PER_BLOCK
);

2511 
	`süub_·ge_g‘
(
¥age
);

2512 
sblock
->
·gev
[
šdex
] = 
¥age
;

2513 
¥age
->
sblock
 = sblock;

2514 
¥age
->
dev
 = dev;

2515 
¥age
->
æags
 = flags;

2516 
¥age
->
g’”©iÚ
 = 
g’
;

2517 
¥age
->
logiÿl
 =†ogical;

2518 
¥age
->
physiÿl
 =…hysical;

2519 
¥age
->
physiÿl_fÜ_dev_»¶aû
 =…hysical_for_dev_replace;

2520 
¥age
->
mœrÜ_num
 = mirror_num;

2521 ià(
csum
) {

2522 
¥age
->
have_csum
 = 1;

2523 
	`memýy
(
¥age
->
csum
, csum, 
sùx
->
csum_size
);

2525 
¥age
->
have_csum
 = 0;

2527 
sblock
->
·ge_couÁ
++;

2528 
¥age
->
·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

2529 ià(!
¥age
->
·ge
)

2530 
Ëave_nomem
;

2531 
Ën
 -ð
l
;

2532 
logiÿl
 +ð
l
;

2533 
physiÿl
 +ð
l
;

2534 
physiÿl_fÜ_dev_»¶aû
 +ð
l
;

2537 
	`WARN_ON
(
sblock
->
·ge_couÁ
 == 0);

2538 ià(
dev
->
missšg
) {

2543 
	`süub_missšg_¿id56_·ges
(
sblock
);

2545 
šdex
 = 0; index < 
sblock
->
·ge_couÁ
; index++) {

2546 
süub_·ge
 *
¥age
 = 
sblock
->
·gev
[
šdex
];

2547 
»t
;

2549 
»t
 = 
	`süub_add_·ge_to_rd_bio
(
sùx
, 
¥age
);

2550 ià(
»t
) {

2551 
	`süub_block_put
(
sblock
);

2552  
»t
;

2556 ià(
fÜû
)

2557 
	`süub_subm™
(
sùx
);

2561 
	`süub_block_put
(
sblock
);

2563 
	}
}

2565 
	$süub_bio_’d_io
(
bio
 *bio)

2567 
süub_bio
 *
sbio
 = 
bio
->
bi_´iv©e
;

2568 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sbio
->
dev
->fs_info;

2570 
sbio
->
¡©us
 = 
bio
->
bi_¡©us
;

2571 
sbio
->
bio
 = bio;

2573 
	`bŒfs_queue_wÜk
(
fs_šfo
->
süub_wÜk”s
, &
sbio
->
wÜk
);

2574 
	}
}

2576 
	$süub_bio_’d_io_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

2578 
süub_bio
 *
sbio
 = 
	`cÚš”_of
(
wÜk
, scrub_bio, work);

2579 
süub_ùx
 *
sùx
 = 
sbio
->sctx;

2580 
i
;

2582 
	`BUG_ON
(
sbio
->
·ge_couÁ
 > 
SCRUB_PAGES_PER_RD_BIO
);

2583 ià(
sbio
->
¡©us
) {

2584 
i
 = 0; i < 
sbio
->
·ge_couÁ
; i++) {

2585 
süub_·ge
 *
¥age
 = 
sbio
->
·gev
[
i
];

2587 
¥age
->
io_”rÜ
 = 1;

2588 
¥age
->
sblock
->
no_io_”rÜ_£’
 = 0;

2593 
i
 = 0; i < 
sbio
->
·ge_couÁ
; i++) {

2594 
süub_·ge
 *
¥age
 = 
sbio
->
·gev
[
i
];

2595 
süub_block
 *
sblock
 = 
¥age
->sblock;

2597 ià(
	`©omic_dec_ªd_‹¡
(&
sblock
->
out¡ªdšg_·ges
))

2598 
	`süub_block_com¶‘e
(
sblock
);

2599 
	`süub_block_put
(
sblock
);

2602 
	`bio_put
(
sbio
->
bio
);

2603 
sbio
->
bio
 = 
NULL
;

2604 
	`¥š_lock
(&
sùx
->
li¡_lock
);

2605 
sbio
->
Ãxt_ä“
 = 
sùx
->
fœ¡_ä“
;

2606 
sùx
->
fœ¡_ä“
 = 
sbio
->
šdex
;

2607 
	`¥š_uÆock
(&
sùx
->
li¡_lock
);

2609 ià(
sùx
->
is_dev_»¶aû
 && sùx->
æush_®l_wr™es
) {

2610 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

2611 
	`süub_wr_subm™
(
sùx
);

2612 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

2615 
	`süub_³ndšg_bio_dec
(
sùx
);

2616 
	}
}

2618 
šlše
 
	$__süub_m¬k_b™m­
(
süub_·r™y
 *
¥¬™y
,

2619 *
b™m­
,

2620 
u64
 
¡¬t
, u64 
Ën
)

2622 
u64
 
off£t
;

2623 
u64
 
n£ùÜs64
;

2624 
u32
 
n£ùÜs
;

2625 
£ùÜsize
 = 
¥¬™y
->
sùx
->
fs_šfo
->sectorsize;

2627 ià(
Ën
 >ð
¥¬™y
->
¡re_Ën
) {

2628 
	`b™m­_£t
(
b™m­
, 0, 
¥¬™y
->
n£ùÜs
);

2632 
¡¬t
 -ð
¥¬™y
->
logic_¡¬t
;

2633 
¡¬t
 = 
	`div64_u64_»m
(¡¬t, 
¥¬™y
->
¡re_Ën
, &
off£t
);

2634 
off£t
 = 
	`div_u64
(off£t, 
£ùÜsize
);

2635 
n£ùÜs64
 = 
	`div_u64
(
Ën
, 
£ùÜsize
);

2637 
	`ASSERT
(
n£ùÜs64
 < 
UINT_MAX
);

2638 
n£ùÜs
 = (
u32
)
n£ùÜs64
;

2640 ià(
off£t
 + 
n£ùÜs
 <ð
¥¬™y
->nsectors) {

2641 
	`b™m­_£t
(
b™m­
, 
off£t
, 
n£ùÜs
);

2645 
	`b™m­_£t
(
b™m­
, 
off£t
, 
¥¬™y
->
n£ùÜs
 - offset);

2646 
	`b™m­_£t
(
b™m­
, 0, 
n£ùÜs
 - (
¥¬™y
->n£ùÜ - 
off£t
));

2647 
	}
}

2649 
šlše
 
	$süub_·r™y_m¬k_£ùÜs_”rÜ
(
süub_·r™y
 *
¥¬™y
,

2650 
u64
 
¡¬t
, u64 
Ën
)

2652 
	`__süub_m¬k_b™m­
(
¥¬™y
, s·r™y->
eb™m­
, 
¡¬t
, 
Ën
);

2653 
	}
}

2655 
šlše
 
	$süub_·r™y_m¬k_£ùÜs_d©a
(
süub_·r™y
 *
¥¬™y
,

2656 
u64
 
¡¬t
, u64 
Ën
)

2658 
	`__süub_m¬k_b™m­
(
¥¬™y
, s·r™y->
db™m­
, 
¡¬t
, 
Ën
);

2659 
	}
}

2661 
	$süub_block_com¶‘e
(
süub_block
 *
sblock
)

2663 
cÜru±ed
 = 0;

2665 ià(!
sblock
->
no_io_”rÜ_£’
) {

2666 
cÜru±ed
 = 1;

2667 
	`süub_hªdË_”rÜed_block
(
sblock
);

2674 
cÜru±ed
 = 
	`süub_checksum
(
sblock
);

2675 ià(!
cÜru±ed
 && 
sblock
->
sùx
->
is_dev_»¶aû
)

2676 
	`süub_wr™e_block_to_dev_»¶aû
(
sblock
);

2679 ià(
sblock
->
¥¬™y
 && 
cÜru±ed
 && !sblock->
d©a_cÜ»ùed
) {

2680 
u64
 
¡¬t
 = 
sblock
->
·gev
[0]->
logiÿl
;

2681 
u64
 
’d
 = 
sblock
->
·gev
[sblock->
·ge_couÁ
 - 1]->
logiÿl
 +

2682 
PAGE_SIZE
;

2684 
	`süub_·r™y_m¬k_£ùÜs_”rÜ
(
sblock
->
¥¬™y
,

2685 
¡¬t
, 
’d
 - start);

2687 
	}
}

2689 
	$süub_fšd_csum
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
, 
u8
 *
csum
)

2691 
bŒfs_Üd”ed_sum
 *
sum
 = 
NULL
;

2692 
šdex
;

2693 
num_£ùÜs
;

2695 !
	`li¡_em±y
(&
sùx
->
csum_li¡
)) {

2696 
sum
 = 
	`li¡_fœ¡_’Œy
(&
sùx
->
csum_li¡
,

2697 
bŒfs_Üd”ed_sum
, 
li¡
);

2698 ià(
sum
->
by‹Ä
 > 
logiÿl
)

2700 ià(
sum
->
by‹Ä
 + sum->
Ën
 > 
logiÿl
)

2703 ++
sùx
->
¡©
.
csum_disÿrds
;

2704 
	`li¡_d–
(&
sum
->
li¡
);

2705 
	`kä“
(
sum
);

2706 
sum
 = 
NULL
;

2708 ià(!
sum
)

2711 
šdex
 = 
	`div_u64
(
logiÿl
 - 
sum
->
by‹Ä
, 
sùx
->
fs_šfo
->
£ùÜsize
);

2712 
	`ASSERT
(
šdex
 < 
UINT_MAX
);

2714 
num_£ùÜs
 = 
sum
->
Ën
 / 
sùx
->
fs_šfo
->
£ùÜsize
;

2715 
	`memýy
(
csum
, 
sum
->
sums
 + 
šdex
, 
sùx
->
csum_size
);

2716 ià(
šdex
 =ð
num_£ùÜs
 - 1) {

2717 
	`li¡_d–
(&
sum
->
li¡
);

2718 
	`kä“
(
sum
);

2721 
	}
}

2724 
	$süub_ex‹Á
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
, u64 
Ën
,

2725 
u64
 
physiÿl
, 
bŒfs_deviû
 *
dev
, u64 
æags
,

2726 
u64
 
g’
, 
mœrÜ_num
, u64 
physiÿl_fÜ_dev_»¶aû
)

2728 
»t
;

2729 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

2730 
u32
 
blocksize
;

2732 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) {

2733 
blocksize
 = 
sùx
->
fs_šfo
->
£ùÜsize
;

2734 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2735 
sùx
->
¡©
.
d©a_ex‹Ás_süubbed
++;

2736 
sùx
->
¡©
.
d©a_by‹s_süubbed
 +ð
Ën
;

2737 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2738 } ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

2739 
blocksize
 = 
sùx
->
fs_šfo
->
nodesize
;

2740 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2741 
sùx
->
¡©
.
Œ“_ex‹Ás_süubbed
++;

2742 
sùx
->
¡©
.
Œ“_by‹s_süubbed
 +ð
Ën
;

2743 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2745 
blocksize
 = 
sùx
->
fs_šfo
->
£ùÜsize
;

2746 
	`WARN_ON
(1);

2749 
Ën
) {

2750 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
blocksize
);

2751 
have_csum
 = 0;

2753 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) {

2755 
have_csum
 = 
	`süub_fšd_csum
(
sùx
, 
logiÿl
, 
csum
);

2756 ià(
have_csum
 == 0)

2757 ++
sùx
->
¡©
.
no_csum
;

2758 ià(
sùx
->
is_dev_»¶aû
 && !
have_csum
) {

2759 
»t
 = 
	`cÝy_nocow_·ges
(
sùx
, 
logiÿl
, 
l
,

2760 
mœrÜ_num
,

2761 
physiÿl_fÜ_dev_»¶aû
);

2762 
behšd_süub_·ges
;

2765 
»t
 = 
	`süub_·ges
(
sùx
, 
logiÿl
, 
l
, 
physiÿl
, 
dev
, 
æags
, 
g’
,

2766 
mœrÜ_num
, 
have_csum
 ? 
csum
 : 
NULL
, 0,

2767 
physiÿl_fÜ_dev_»¶aû
);

2768 
behšd_süub_·ges
:

2769 ià(
»t
)

2770  
»t
;

2771 
Ën
 -ð
l
;

2772 
logiÿl
 +ð
l
;

2773 
physiÿl
 +ð
l
;

2774 
physiÿl_fÜ_dev_»¶aû
 +ð
l
;

2777 
	}
}

2779 
	$süub_·ges_fÜ_·r™y
(
süub_·r™y
 *
¥¬™y
,

2780 
u64
 
logiÿl
, u64 
Ën
,

2781 
u64
 
physiÿl
, 
bŒfs_deviû
 *
dev
,

2782 
u64
 
æags
, u64 
g’
, 
mœrÜ_num
, 
u8
 *
csum
)

2784 
süub_ùx
 *
sùx
 = 
¥¬™y
->sctx;

2785 
süub_block
 *
sblock
;

2786 
šdex
;

2788 
sblock
 = 
	`kz®loc
((*sblock), 
GFP_KERNEL
);

2789 ià(!
sblock
) {

2790 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2791 
sùx
->
¡©
.
m®loc_”rÜs
++;

2792 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2793  -
ENOMEM
;

2798 
	`»fcouÁ_£t
(&
sblock
->
»fs
, 1);

2799 
sblock
->
sùx
 = sctx;

2800 
sblock
->
no_io_”rÜ_£’
 = 1;

2801 
sblock
->
¥¬™y
 = sparity;

2802 
	`süub_·r™y_g‘
(
¥¬™y
);

2804 
šdex
 = 0; 
Ën
 > 0; index++) {

2805 
süub_·ge
 *
¥age
;

2806 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
PAGE_SIZE
);

2808 
¥age
 = 
	`kz®loc
((*¥age), 
GFP_KERNEL
);

2809 ià(!
¥age
) {

2810 
Ëave_nomem
:

2811 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2812 
sùx
->
¡©
.
m®loc_”rÜs
++;

2813 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2814 
	`süub_block_put
(
sblock
);

2815  -
ENOMEM
;

2817 
	`BUG_ON
(
šdex
 >ð
SCRUB_MAX_PAGES_PER_BLOCK
);

2819 
	`süub_·ge_g‘
(
¥age
);

2820 
sblock
->
·gev
[
šdex
] = 
¥age
;

2822 
	`süub_·ge_g‘
(
¥age
);

2823 
	`li¡_add_ž
(&
¥age
->
li¡
, &
¥¬™y
->
¥ages
);

2824 
¥age
->
sblock
 = sblock;

2825 
¥age
->
dev
 = dev;

2826 
¥age
->
æags
 = flags;

2827 
¥age
->
g’”©iÚ
 = 
g’
;

2828 
¥age
->
logiÿl
 =†ogical;

2829 
¥age
->
physiÿl
 =…hysical;

2830 
¥age
->
mœrÜ_num
 = mirror_num;

2831 ià(
csum
) {

2832 
¥age
->
have_csum
 = 1;

2833 
	`memýy
(
¥age
->
csum
, csum, 
sùx
->
csum_size
);

2835 
¥age
->
have_csum
 = 0;

2837 
sblock
->
·ge_couÁ
++;

2838 
¥age
->
·ge
 = 
	`®loc_·ge
(
GFP_KERNEL
);

2839 ià(!
¥age
->
·ge
)

2840 
Ëave_nomem
;

2841 
Ën
 -ð
l
;

2842 
logiÿl
 +ð
l
;

2843 
physiÿl
 +ð
l
;

2846 
	`WARN_ON
(
sblock
->
·ge_couÁ
 == 0);

2847 
šdex
 = 0; index < 
sblock
->
·ge_couÁ
; index++) {

2848 
süub_·ge
 *
¥age
 = 
sblock
->
·gev
[
šdex
];

2849 
»t
;

2851 
»t
 = 
	`süub_add_·ge_to_rd_bio
(
sùx
, 
¥age
);

2852 ià(
»t
) {

2853 
	`süub_block_put
(
sblock
);

2854  
»t
;

2859 
	`süub_block_put
(
sblock
);

2861 
	}
}

2863 
	$süub_ex‹Á_fÜ_·r™y
(
süub_·r™y
 *
¥¬™y
,

2864 
u64
 
logiÿl
, u64 
Ën
,

2865 
u64
 
physiÿl
, 
bŒfs_deviû
 *
dev
,

2866 
u64
 
æags
, u64 
g’
, 
mœrÜ_num
)

2868 
süub_ùx
 *
sùx
 = 
¥¬™y
->sctx;

2869 
»t
;

2870 
u8
 
csum
[
BTRFS_CSUM_SIZE
];

2871 
u32
 
blocksize
;

2873 ià(
dev
->
missšg
) {

2874 
	`süub_·r™y_m¬k_£ùÜs_”rÜ
(
¥¬™y
, 
logiÿl
, 
Ën
);

2878 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) {

2879 
blocksize
 = 
sùx
->
fs_šfo
->
£ùÜsize
;

2880 } ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

2881 
blocksize
 = 
sùx
->
fs_šfo
->
nodesize
;

2883 
blocksize
 = 
sùx
->
fs_šfo
->
£ùÜsize
;

2884 
	`WARN_ON
(1);

2887 
Ën
) {

2888 
u64
 
l
 = 
	`mš_t
(u64, 
Ën
, 
blocksize
);

2889 
have_csum
 = 0;

2891 ià(
æags
 & 
BTRFS_EXTENT_FLAG_DATA
) {

2893 
have_csum
 = 
	`süub_fšd_csum
(
sùx
, 
logiÿl
, 
csum
);

2894 ià(
have_csum
 == 0)

2895 
sk
;

2897 
»t
 = 
	`süub_·ges_fÜ_·r™y
(
¥¬™y
, 
logiÿl
, 
l
, 
physiÿl
, 
dev
,

2898 
æags
, 
g’
, 
mœrÜ_num
,

2899 
have_csum
 ? 
csum
 : 
NULL
);

2900 ià(
»t
)

2901  
»t
;

2902 
sk
:

2903 
Ën
 -ð
l
;

2904 
logiÿl
 +ð
l
;

2905 
physiÿl
 +ð
l
;

2908 
	}
}

2917 
	$g‘_¿id56_logic_off£t
(
u64
 
physiÿl
, 
num
,

2918 
m­_lookup
 *
m­
, 
u64
 *
off£t
,

2919 
u64
 *
¡re_¡¬t
)

2921 
i
;

2922 
j
 = 0;

2923 
u64
 
¡re_Ä
;

2924 
u64
 
Ï¡_off£t
;

2925 
u32
 
¡re_šdex
;

2926 
u32
 
rÙ
;

2928 
Ï¡_off£t
 = (
physiÿl
 - 
m­
->
¡res
[
num
].physical) *

2929 
	`Ä_d©a_¡res
(
m­
);

2930 ià(
¡re_¡¬t
)

2931 *
¡re_¡¬t
 = 
Ï¡_off£t
;

2933 *
off£t
 = 
Ï¡_off£t
;

2934 
i
 = 0; i < 
	`Ä_d©a_¡res
(
m­
); i++) {

2935 *
off£t
 = 
Ï¡_off£t
 + 
i
 * 
m­
->
¡re_Ën
;

2937 
¡re_Ä
 = 
	`div64_u64
(*
off£t
, 
m­
->
¡re_Ën
);

2938 
¡re_Ä
 = 
	`div_u64
(¡re_Ä, 
	`Ä_d©a_¡res
(
m­
));

2941 
¡re_Ä
 = 
	`div_u64_»m
(¡re_Ä, 
m­
->
num_¡res
, &
rÙ
);

2943 
rÙ
 +ð
i
;

2944 
¡re_šdex
 = 
rÙ
 % 
m­
->
num_¡res
;

2945 ià(
¡re_šdex
 =ð
num
)

2947 ià(
¡re_šdex
 < 
num
)

2948 
j
++;

2950 *
off£t
 = 
Ï¡_off£t
 + 
j
 * 
m­
->
¡re_Ën
;

2952 
	}
}

2954 
	$süub_ä“_·r™y
(
süub_·r™y
 *
¥¬™y
)

2956 
süub_ùx
 *
sùx
 = 
¥¬™y
->sctx;

2957 
süub_·ge
 *
cu¼
, *
Ãxt
;

2958 
nb™s
;

2960 
nb™s
 = 
	`b™m­_weight
(
¥¬™y
->
eb™m­
, s·r™y->
n£ùÜs
);

2961 ià(
nb™s
) {

2962 
	`¥š_lock
(&
sùx
->
¡©_lock
);

2963 
sùx
->
¡©
.
»ad_”rÜs
 +ð
nb™s
;

2964 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
 +ð
nb™s
;

2965 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

2968 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
¥¬™y
->
¥ages
, 
li¡
) {

2969 
	`li¡_d–_š™
(&
cu¼
->
li¡
);

2970 
	`süub_·ge_put
(
cu¼
);

2973 
	`kä“
(
¥¬™y
);

2974 
	}
}

2976 
	$süub_·r™y_bio_’dio_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

2978 
süub_·r™y
 *
¥¬™y
 = 
	`cÚš”_of
(
wÜk
, scrub_parity,

2979 
wÜk
);

2980 
süub_ùx
 *
sùx
 = 
¥¬™y
->sctx;

2982 
	`süub_ä“_·r™y
(
¥¬™y
);

2983 
	`süub_³ndšg_bio_dec
(
sùx
);

2984 
	}
}

2986 
	$süub_·r™y_bio_’dio
(
bio
 *bio)

2988 
süub_·r™y
 *
¥¬™y
 = (süub_·r™y *)
bio
->
bi_´iv©e
;

2989 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¥¬™y
->
sùx
->fs_info;

2991 ià(
bio
->
bi_¡©us
)

2992 
	`b™m­_Ü
(
¥¬™y
->
eb™m­
, s·r™y->eb™m­, s·r™y->
db™m­
,

2993 
¥¬™y
->
n£ùÜs
);

2995 
	`bio_put
(
bio
);

2997 
	`bŒfs_š™_wÜk
(&
¥¬™y
->
wÜk
, 
bŒfs_süub·r™y_h–³r
,

2998 
süub_·r™y_bio_’dio_wÜk”
, 
NULL
, NULL);

2999 
	`bŒfs_queue_wÜk
(
fs_šfo
->
süub_·r™y_wÜk”s
, &
¥¬™y
->
wÜk
);

3000 
	}
}

3002 
	$süub_·r™y_check_ªd_»·œ
(
süub_·r™y
 *
¥¬™y
)

3004 
süub_ùx
 *
sùx
 = 
¥¬™y
->sctx;

3005 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

3006 
bio
 *bio;

3007 
bŒfs_¿id_bio
 *
rbio
;

3008 
bŒfs_bio
 *
bbio
 = 
NULL
;

3009 
u64
 
Ëngth
;

3010 
»t
;

3012 ià(!
	`b™m­_ªdnÙ
(
¥¬™y
->
db™m­
, s·r™y->db™m­, s·r™y->
eb™m­
,

3013 
¥¬™y
->
n£ùÜs
))

3014 
out
;

3016 
Ëngth
 = 
¥¬™y
->
logic_’d
 - s·r™y->
logic_¡¬t
;

3018 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

3019 
»t
 = 
	`bŒfs_m­_sblock
(
fs_šfo
, 
BTRFS_MAP_WRITE
, 
¥¬™y
->
logic_¡¬t
,

3020 &
Ëngth
, &
bbio
);

3021 ià(
»t
 || !
bbio
 || !bbio->
¿id_m­
)

3022 
bbio_out
;

3024 
bio
 = 
	`bŒfs_io_bio_®loc
(0);

3025 
bio
->
bi_™”
.
bi_£ùÜ
 = 
¥¬™y
->
logic_¡¬t
 >> 9;

3026 
bio
->
bi_´iv©e
 = 
¥¬™y
;

3027 
bio
->
bi_’d_io
 = 
süub_·r™y_bio_’dio
;

3029 
rbio
 = 
	`¿id56_·r™y_®loc_süub_rbio
(
fs_šfo
, 
bio
, 
bbio
,

3030 
Ëngth
, 
¥¬™y
->
süub_dev
,

3031 
¥¬™y
->
db™m­
,

3032 
¥¬™y
->
n£ùÜs
);

3033 ià(!
rbio
)

3034 
rbio_out
;

3036 
	`süub_³ndšg_bio_šc
(
sùx
);

3037 
	`¿id56_·r™y_subm™_süub_rbio
(
rbio
);

3040 
rbio_out
:

3041 
	`bio_put
(
bio
);

3042 
bbio_out
:

3043 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

3044 
	`bŒfs_put_bbio
(
bbio
);

3045 
	`b™m­_Ü
(
¥¬™y
->
eb™m­
, s·r™y->eb™m­, s·r™y->
db™m­
,

3046 
¥¬™y
->
n£ùÜs
);

3047 
	`¥š_lock
(&
sùx
->
¡©_lock
);

3048 
sùx
->
¡©
.
m®loc_”rÜs
++;

3049 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

3050 
out
:

3051 
	`süub_ä“_·r™y
(
¥¬™y
);

3052 
	}
}

3054 
šlše
 
	$süub_ÿlc_·r™y_b™m­_Ën
(
n£ùÜs
)

3056  
	`DIV_ROUND_UP
(
n£ùÜs
, 
BITS_PER_LONG
) * ();

3057 
	}
}

3059 
	$süub_·r™y_g‘
(
süub_·r™y
 *
¥¬™y
)

3061 
	`»fcouÁ_šc
(&
¥¬™y
->
»fs
);

3062 
	}
}

3064 
	$süub_·r™y_put
(
süub_·r™y
 *
¥¬™y
)

3066 ià(!
	`»fcouÁ_dec_ªd_‹¡
(&
¥¬™y
->
»fs
))

3069 
	`süub_·r™y_check_ªd_»·œ
(
¥¬™y
);

3070 
	}
}

3072 
nošlše_fÜ_¡ack
 
	$süub_¿id56_·r™y
(
süub_ùx
 *
sùx
,

3073 
m­_lookup
 *
m­
,

3074 
bŒfs_deviû
 *
sdev
,

3075 
bŒfs_·th
 *
·th
,

3076 
u64
 
logic_¡¬t
,

3077 
u64
 
logic_’d
)

3079 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

3080 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

3081 
bŒfs_roÙ
 *
csum_roÙ
 = 
fs_šfo
->csum_root;

3082 
bŒfs_ex‹Á_™em
 *
ex‹Á
;

3083 
bŒfs_bio
 *
bbio
 = 
NULL
;

3084 
u64
 
æags
;

3085 
»t
;

3086 
¦Ù
;

3087 
ex‹Á_bufãr
 *
l
;

3088 
bŒfs_key
 
key
;

3089 
u64
 
g’”©iÚ
;

3090 
u64
 
ex‹Á_logiÿl
;

3091 
u64
 
ex‹Á_physiÿl
;

3092 
u64
 
ex‹Á_Ën
;

3093 
u64
 
m­³d_Ëngth
;

3094 
bŒfs_deviû
 *
ex‹Á_dev
;

3095 
süub_·r™y
 *
¥¬™y
;

3096 
n£ùÜs
;

3097 
b™m­_Ën
;

3098 
ex‹Á_mœrÜ_num
;

3099 
¡Ý_loÝ
 = 0;

3101 
n£ùÜs
 = 
	`div_u64
(
m­
->
¡re_Ën
, 
fs_šfo
->
£ùÜsize
);

3102 
b™m­_Ën
 = 
	`süub_ÿlc_·r™y_b™m­_Ën
(
n£ùÜs
);

3103 
¥¬™y
 = 
	`kz®loc
((
süub_·r™y
è+ 2 * 
b™m­_Ën
,

3104 
GFP_NOFS
);

3105 ià(!
¥¬™y
) {

3106 
	`¥š_lock
(&
sùx
->
¡©_lock
);

3107 
sùx
->
¡©
.
m®loc_”rÜs
++;

3108 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

3109  -
ENOMEM
;

3112 
¥¬™y
->
¡re_Ën
 = 
m­
->stripe_len;

3113 
¥¬™y
->
n£ùÜs
 =‚sectors;

3114 
¥¬™y
->
sùx
 = sctx;

3115 
¥¬™y
->
süub_dev
 = 
sdev
;

3116 
¥¬™y
->
logic_¡¬t
 =†ogic_start;

3117 
¥¬™y
->
logic_’d
 =†ogic_end;

3118 
	`»fcouÁ_£t
(&
¥¬™y
->
»fs
, 1);

3119 
	`INIT_LIST_HEAD
(&
¥¬™y
->
¥ages
);

3120 
¥¬™y
->
db™m­
 = s·r™y->
b™m­
;

3121 
¥¬™y
->
eb™m­
 = (*)¥¬™y->
b™m­
 + 
b™m­_Ën
;

3123 
»t
 = 0;

3124 
logic_¡¬t
 < 
logic_’d
) {

3125 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

3126 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

3128 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3129 
key
.
objeùid
 = 
logic_¡¬t
;

3130 
key
.
off£t
 = (
u64
)-1;

3132 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3133 ià(
»t
 < 0)

3134 
out
;

3136 ià(
»t
 > 0) {

3137 
»t
 = 
	`bŒfs_´evious_ex‹Á_™em
(
roÙ
, 
·th
, 0);

3138 ià(
»t
 < 0)

3139 
out
;

3140 ià(
»t
 > 0) {

3141 
	`bŒfs_»Ëa£_·th
(
·th
);

3142 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
,

3143 
·th
, 0, 0);

3144 ià(
»t
 < 0)

3145 
out
;

3149 
¡Ý_loÝ
 = 0;

3151 
u64
 
by‹s
;

3153 
l
 = 
·th
->
nodes
[0];

3154 
¦Ù
 = 
·th
->
¦Ùs
[0];

3155 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
l
)) {

3156 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3157 ià(
»t
 == 0)

3159 ià(
»t
 < 0)

3160 
out
;

3162 
¡Ý_loÝ
 = 1;

3165 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
¦Ù
);

3167 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_ITEM_KEY
 &&

3168 
key
.
ty³
 !ð
BTRFS_METADATA_ITEM_KEY
)

3169 
Ãxt
;

3171 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

3172 
by‹s
 = 
fs_šfo
->
nodesize
;

3174 
by‹s
 = 
key
.
off£t
;

3176 ià(
key
.
objeùid
 + 
by‹s
 <ð
logic_¡¬t
)

3177 
Ãxt
;

3179 ià(
key
.
objeùid
 >ð
logic_’d
) {

3180 
¡Ý_loÝ
 = 1;

3184 
key
.
objeùid
 >ð
logic_¡¬t
 + 
m­
->
¡re_Ën
)

3185 
logic_¡¬t
 +ð
m­
->
¡re_Ën
;

3187 
ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

3188 
bŒfs_ex‹Á_™em
);

3189 
æags
 = 
	`bŒfs_ex‹Á_æags
(
l
, 
ex‹Á
);

3190 
g’”©iÚ
 = 
	`bŒfs_ex‹Á_g’”©iÚ
(
l
, 
ex‹Á
);

3192 ià((
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) &&

3193 (
key
.
objeùid
 < 
logic_¡¬t
 ||

3194 
key
.
objeùid
 + 
by‹s
 >

3195 
logic_¡¬t
 + 
m­
->
¡re_Ën
)) {

3196 
	`bŒfs_”r
(
fs_šfo
,

3198 
key
.
objeùid
, 
logic_¡¬t
);

3199 
	`¥š_lock
(&
sùx
->
¡©_lock
);

3200 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

3201 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

3202 
Ãxt
;

3204 
agaš
:

3205 
ex‹Á_logiÿl
 = 
key
.
objeùid
;

3206 
ex‹Á_Ën
 = 
by‹s
;

3208 ià(
ex‹Á_logiÿl
 < 
logic_¡¬t
) {

3209 
ex‹Á_Ën
 -ð
logic_¡¬t
 - 
ex‹Á_logiÿl
;

3210 
ex‹Á_logiÿl
 = 
logic_¡¬t
;

3213 ià(
ex‹Á_logiÿl
 + 
ex‹Á_Ën
 >

3214 
logic_¡¬t
 + 
m­
->
¡re_Ën
)

3215 
ex‹Á_Ën
 = 
logic_¡¬t
 + 
m­
->
¡re_Ën
 -

3216 
ex‹Á_logiÿl
;

3218 
	`süub_·r™y_m¬k_£ùÜs_d©a
(
¥¬™y
, 
ex‹Á_logiÿl
,

3219 
ex‹Á_Ën
);

3221 
m­³d_Ëngth
 = 
ex‹Á_Ën
;

3222 
bbio
 = 
NULL
;

3223 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_READ
,

3224 
ex‹Á_logiÿl
, &
m­³d_Ëngth
, &
bbio
,

3226 ià(!
»t
) {

3227 ià(!
bbio
 || 
m­³d_Ëngth
 < 
ex‹Á_Ën
)

3228 
»t
 = -
EIO
;

3230 ià(
»t
) {

3231 
	`bŒfs_put_bbio
(
bbio
);

3232 
out
;

3234 
ex‹Á_physiÿl
 = 
bbio
->
¡res
[0].
physiÿl
;

3235 
ex‹Á_mœrÜ_num
 = 
bbio
->
mœrÜ_num
;

3236 
ex‹Á_dev
 = 
bbio
->
¡res
[0].
dev
;

3237 
	`bŒfs_put_bbio
(
bbio
);

3239 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(
csum_roÙ
,

3240 
ex‹Á_logiÿl
,

3241 
ex‹Á_logiÿl
 + 
ex‹Á_Ën
 - 1,

3242 &
sùx
->
csum_li¡
, 1);

3243 ià(
»t
)

3244 
out
;

3246 
»t
 = 
	`süub_ex‹Á_fÜ_·r™y
(
¥¬™y
, 
ex‹Á_logiÿl
,

3247 
ex‹Á_Ën
,

3248 
ex‹Á_physiÿl
,

3249 
ex‹Á_dev
, 
æags
,

3250 
g’”©iÚ
,

3251 
ex‹Á_mœrÜ_num
);

3253 
	`süub_ä“_csums
(
sùx
);

3255 ià(
»t
)

3256 
out
;

3258 ià(
ex‹Á_logiÿl
 + 
ex‹Á_Ën
 <

3259 
key
.
objeùid
 + 
by‹s
) {

3260 
logic_¡¬t
 +ð
m­
->
¡re_Ën
;

3262 ià(
logic_¡¬t
 >ð
logic_’d
) {

3263 
¡Ý_loÝ
 = 1;

3267 ià(
logic_¡¬t
 < 
key
.
objeùid
 + 
by‹s
) {

3268 
	`cÚd_»sched
();

3269 
agaš
;

3272 
Ãxt
:

3273 
·th
->
¦Ùs
[0]++;

3276 
	`bŒfs_»Ëa£_·th
(
·th
);

3278 ià(
¡Ý_loÝ
)

3281 
logic_¡¬t
 +ð
m­
->
¡re_Ën
;

3283 
out
:

3284 ià(
»t
 < 0)

3285 
	`süub_·r™y_m¬k_£ùÜs_”rÜ
(
¥¬™y
, 
logic_¡¬t
,

3286 
logic_’d
 - 
logic_¡¬t
);

3287 
	`süub_·r™y_put
(
¥¬™y
);

3288 
	`süub_subm™
(
sùx
);

3289 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

3290 
	`süub_wr_subm™
(
sùx
);

3291 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

3293 
	`bŒfs_»Ëa£_·th
(
·th
);

3294  
»t
 < 0 ?„et : 0;

3295 
	}
}

3297 
nošlše_fÜ_¡ack
 
	$süub_¡re
(
süub_ùx
 *
sùx
,

3298 
m­_lookup
 *
m­
,

3299 
bŒfs_deviû
 *
süub_dev
,

3300 
num
, 
u64
 
ba£
, u64 
Ëngth
,

3301 
is_dev_»¶aû
)

3303 
bŒfs_·th
 *
·th
, *
µ©h
;

3304 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

3305 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

3306 
bŒfs_roÙ
 *
csum_roÙ
 = 
fs_šfo
->csum_root;

3307 
bŒfs_ex‹Á_™em
 *
ex‹Á
;

3308 
blk_¶ug
 
¶ug
;

3309 
u64
 
æags
;

3310 
»t
;

3311 
¦Ù
;

3312 
u64
 
n¡res
;

3313 
ex‹Á_bufãr
 *
l
;

3314 
u64
 
physiÿl
;

3315 
u64
 
logiÿl
;

3316 
u64
 
logic_’d
;

3317 
u64
 
physiÿl_’d
;

3318 
u64
 
g’”©iÚ
;

3319 
mœrÜ_num
;

3320 
»ada_cÚŒÞ
 *
»ada1
;

3321 
»ada_cÚŒÞ
 *
»ada2
;

3322 
bŒfs_key
 
key
;

3323 
bŒfs_key
 
key_’d
;

3324 
u64
 
šüem’t
 = 
m­
->
¡re_Ën
;

3325 
u64
 
off£t
;

3326 
u64
 
ex‹Á_logiÿl
;

3327 
u64
 
ex‹Á_physiÿl
;

3328 
u64
 
ex‹Á_Ën
;

3329 
u64
 
¡re_logiÿl
;

3330 
u64
 
¡re_’d
;

3331 
bŒfs_deviû
 *
ex‹Á_dev
;

3332 
ex‹Á_mœrÜ_num
;

3333 
¡Ý_loÝ
 = 0;

3335 
physiÿl
 = 
m­
->
¡res
[
num
].physical;

3336 
off£t
 = 0;

3337 
n¡res
 = 
	`div64_u64
(
Ëngth
, 
m­
->
¡re_Ën
);

3338 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
) {

3339 
off£t
 = 
m­
->
¡re_Ën
 * 
num
;

3340 
šüem’t
 = 
m­
->
¡re_Ën
 * m­->
num_¡res
;

3341 
mœrÜ_num
 = 1;

3342 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
) {

3343 
çùÜ
 = 
m­
->
num_¡res
 / m­->
sub_¡res
;

3344 
off£t
 = 
m­
->
¡re_Ën
 * (
num
 / m­->
sub_¡res
);

3345 
šüem’t
 = 
m­
->
¡re_Ën
 * 
çùÜ
;

3346 
mœrÜ_num
 = 
num
 % 
m­
->
sub_¡res
 + 1;

3347 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1
) {

3348 
šüem’t
 = 
m­
->
¡re_Ën
;

3349 
mœrÜ_num
 = 
num
 % 
m­
->
num_¡res
 + 1;

3350 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_DUP
) {

3351 
šüem’t
 = 
m­
->
¡re_Ën
;

3352 
mœrÜ_num
 = 
num
 % 
m­
->
num_¡res
 + 1;

3353 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

3354 
	`g‘_¿id56_logic_off£t
(
physiÿl
, 
num
, 
m­
, &
off£t
, 
NULL
);

3355 
šüem’t
 = 
m­
->
¡re_Ën
 * 
	`Ä_d©a_¡res
(map);

3356 
mœrÜ_num
 = 1;

3358 
šüem’t
 = 
m­
->
¡re_Ën
;

3359 
mœrÜ_num
 = 1;

3362 
·th
 = 
	`bŒfs_®loc_·th
();

3363 ià(!
·th
)

3364  -
ENOMEM
;

3366 
µ©h
 = 
	`bŒfs_®loc_·th
();

3367 ià(!
µ©h
) {

3368 
	`bŒfs_ä“_·th
(
·th
);

3369  -
ENOMEM
;

3377 
·th
->
£¬ch_comm™_roÙ
 = 1;

3378 
·th
->
sk_lockšg
 = 1;

3380 
µ©h
->
£¬ch_comm™_roÙ
 = 1;

3381 
µ©h
->
sk_lockšg
 = 1;

3387 
logiÿl
 = 
ba£
 + 
off£t
;

3388 
physiÿl_’d
 = 
physiÿl
 + 
n¡res
 * 
m­
->
¡re_Ën
;

3389 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

3390 
	`g‘_¿id56_logic_off£t
(
physiÿl_’d
, 
num
,

3391 
m­
, &
logic_’d
, 
NULL
);

3392 
logic_’d
 +ð
ba£
;

3394 
logic_’d
 = 
logiÿl
 + 
šüem’t
 * 
n¡res
;

3396 
	`wa™_ev’t
(
sùx
->
li¡_wa™
,

3397 
	`©omic_»ad
(&
sùx
->
bios_š_æight
) == 0);

3398 
	`süub_blocked_if_Ãeded
(
fs_šfo
);

3401 
key
.
objeùid
 = 
logiÿl
;

3402 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3403 
key
.
off£t
 = (
u64
)0;

3404 
key_’d
.
objeùid
 = 
logic_’d
;

3405 
key_’d
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

3406 
key_’d
.
off£t
 = (
u64
)-1;

3407 
»ada1
 = 
	`bŒfs_»ada_add
(
roÙ
, &
key
, &
key_’d
);

3409 
key
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

3410 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

3411 
key
.
off£t
 = 
logiÿl
;

3412 
key_’d
.
objeùid
 = 
BTRFS_EXTENT_CSUM_OBJECTID
;

3413 
key_’d
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

3414 
key_’d
.
off£t
 = 
logic_’d
;

3415 
»ada2
 = 
	`bŒfs_»ada_add
(
csum_roÙ
, &
key
, &
key_’d
);

3417 ià(!
	`IS_ERR
(
»ada1
))

3418 
	`bŒfs_»ada_wa™
(
»ada1
);

3419 ià(!
	`IS_ERR
(
»ada2
))

3420 
	`bŒfs_»ada_wa™
(
»ada2
);

3427 
	`blk_¡¬t_¶ug
(&
¶ug
);

3432 
»t
 = 0;

3433 
physiÿl
 < 
physiÿl_’d
) {

3437 ià(
	`©omic_»ad
(&
fs_šfo
->
süub_ÿnûl_»q
) ||

3438 
	`©omic_»ad
(&
sùx
->
ÿnûl_»q
)) {

3439 
»t
 = -
ECANCELED
;

3440 
out
;

3445 ià(
	`©omic_»ad
(&
fs_šfo
->
süub_·u£_»q
)) {

3447 
sùx
->
æush_®l_wr™es
 = 
Œue
;

3448 
	`süub_subm™
(
sùx
);

3449 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

3450 
	`süub_wr_subm™
(
sùx
);

3451 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

3452 
	`wa™_ev’t
(
sùx
->
li¡_wa™
,

3453 
	`©omic_»ad
(&
sùx
->
bios_š_æight
) == 0);

3454 
sùx
->
æush_®l_wr™es
 = 
çl£
;

3455 
	`süub_blocked_if_Ãeded
(
fs_šfo
);

3458 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

3459 
»t
 = 
	`g‘_¿id56_logic_off£t
(
physiÿl
, 
num
, 
m­
,

3460 &
logiÿl
,

3461 &
¡re_logiÿl
);

3462 
logiÿl
 +ð
ba£
;

3463 ià(
»t
) {

3465 
¡re_logiÿl
 +ð
ba£
;

3466 
¡re_’d
 = 
¡re_logiÿl
 + 
šüem’t
;

3467 
»t
 = 
	`süub_¿id56_·r™y
(
sùx
, 
m­
, 
süub_dev
,

3468 
µ©h
, 
¡re_logiÿl
,

3469 
¡re_’d
);

3470 ià(
»t
)

3471 
out
;

3472 
sk
;

3476 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
SKINNY_METADATA
))

3477 
key
.
ty³
 = 
BTRFS_METADATA_ITEM_KEY
;

3479 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

3480 
key
.
objeùid
 = 
logiÿl
;

3481 
key
.
off£t
 = (
u64
)-1;

3483 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3484 ià(
»t
 < 0)

3485 
out
;

3487 ià(
»t
 > 0) {

3488 
»t
 = 
	`bŒfs_´evious_ex‹Á_™em
(
roÙ
, 
·th
, 0);

3489 ià(
»t
 < 0)

3490 
out
;

3491 ià(
»t
 > 0) {

3494 
	`bŒfs_»Ëa£_·th
(
·th
);

3495 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
,

3496 
·th
, 0, 0);

3497 ià(
»t
 < 0)

3498 
out
;

3502 
¡Ý_loÝ
 = 0;

3504 
u64
 
by‹s
;

3506 
l
 = 
·th
->
nodes
[0];

3507 
¦Ù
 = 
·th
->
¦Ùs
[0];

3508 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
l
)) {

3509 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3510 ià(
»t
 == 0)

3512 ià(
»t
 < 0)

3513 
out
;

3515 
¡Ý_loÝ
 = 1;

3518 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
¦Ù
);

3520 ià(
key
.
ty³
 !ð
BTRFS_EXTENT_ITEM_KEY
 &&

3521 
key
.
ty³
 !ð
BTRFS_METADATA_ITEM_KEY
)

3522 
Ãxt
;

3524 ià(
key
.
ty³
 =ð
BTRFS_METADATA_ITEM_KEY
)

3525 
by‹s
 = 
fs_šfo
->
nodesize
;

3527 
by‹s
 = 
key
.
off£t
;

3529 ià(
key
.
objeùid
 + 
by‹s
 <ð
logiÿl
)

3530 
Ãxt
;

3532 ià(
key
.
objeùid
 >ð
logiÿl
 + 
m­
->
¡re_Ën
) {

3534 ià(
key
.
objeùid
 >ð
logic_’d
)

3535 
¡Ý_loÝ
 = 1;

3539 
ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
,

3540 
bŒfs_ex‹Á_™em
);

3541 
æags
 = 
	`bŒfs_ex‹Á_æags
(
l
, 
ex‹Á
);

3542 
g’”©iÚ
 = 
	`bŒfs_ex‹Á_g’”©iÚ
(
l
, 
ex‹Á
);

3544 ià((
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) &&

3545 (
key
.
objeùid
 < 
logiÿl
 ||

3546 
key
.
objeùid
 + 
by‹s
 >

3547 
logiÿl
 + 
m­
->
¡re_Ën
)) {

3548 
	`bŒfs_”r
(
fs_šfo
,

3550 
key
.
objeùid
, 
logiÿl
);

3551 
	`¥š_lock
(&
sùx
->
¡©_lock
);

3552 
sùx
->
¡©
.
uncÜ»ùabË_”rÜs
++;

3553 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

3554 
Ãxt
;

3557 
agaš
:

3558 
ex‹Á_logiÿl
 = 
key
.
objeùid
;

3559 
ex‹Á_Ën
 = 
by‹s
;

3564 ià(
ex‹Á_logiÿl
 < 
logiÿl
) {

3565 
ex‹Á_Ën
 -ð
logiÿl
 - 
ex‹Á_logiÿl
;

3566 
ex‹Á_logiÿl
 = 
logiÿl
;

3568 ià(
ex‹Á_logiÿl
 + 
ex‹Á_Ën
 >

3569 
logiÿl
 + 
m­
->
¡re_Ën
) {

3570 
ex‹Á_Ën
 = 
logiÿl
 + 
m­
->
¡re_Ën
 -

3571 
ex‹Á_logiÿl
;

3574 
ex‹Á_physiÿl
 = 
ex‹Á_logiÿl
 - 
logiÿl
 + 
physiÿl
;

3575 
ex‹Á_dev
 = 
süub_dev
;

3576 
ex‹Á_mœrÜ_num
 = 
mœrÜ_num
;

3577 ià(
is_dev_»¶aû
)

3578 
	`süub_»m­_ex‹Á
(
fs_šfo
, 
ex‹Á_logiÿl
,

3579 
ex‹Á_Ën
, &
ex‹Á_physiÿl
,

3580 &
ex‹Á_dev
,

3581 &
ex‹Á_mœrÜ_num
);

3583 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(
csum_roÙ
,

3584 
ex‹Á_logiÿl
,

3585 
ex‹Á_logiÿl
 +

3586 
ex‹Á_Ën
 - 1,

3587 &
sùx
->
csum_li¡
, 1);

3588 ià(
»t
)

3589 
out
;

3591 
»t
 = 
	`süub_ex‹Á
(
sùx
, 
ex‹Á_logiÿl
, 
ex‹Á_Ën
,

3592 
ex‹Á_physiÿl
, 
ex‹Á_dev
, 
æags
,

3593 
g’”©iÚ
, 
ex‹Á_mœrÜ_num
,

3594 
ex‹Á_logiÿl
 - 
logiÿl
 + 
physiÿl
);

3596 
	`süub_ä“_csums
(
sùx
);

3598 ià(
»t
)

3599 
out
;

3601 ià(
ex‹Á_logiÿl
 + 
ex‹Á_Ën
 <

3602 
key
.
objeùid
 + 
by‹s
) {

3603 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

3608 
loÝ
:

3609 
physiÿl
 +ð
m­
->
¡re_Ën
;

3610 
»t
 = 
	`g‘_¿id56_logic_off£t
(
physiÿl
,

3611 
num
, 
m­
, &
logiÿl
,

3612 &
¡re_logiÿl
);

3613 
logiÿl
 +ð
ba£
;

3615 ià(
»t
 && 
physiÿl
 < 
physiÿl_’d
) {

3616 
¡re_logiÿl
 +ð
ba£
;

3617 
¡re_’d
 = 
¡re_logiÿl
 +

3618 
šüem’t
;

3619 
»t
 = 
	`süub_¿id56_·r™y
(
sùx
,

3620 
m­
, 
süub_dev
, 
µ©h
,

3621 
¡re_logiÿl
,

3622 
¡re_’d
);

3623 ià(
»t
)

3624 
out
;

3625 
loÝ
;

3628 
physiÿl
 +ð
m­
->
¡re_Ën
;

3629 
logiÿl
 +ð
šüem’t
;

3631 ià(
logiÿl
 < 
key
.
objeùid
 + 
by‹s
) {

3632 
	`cÚd_»sched
();

3633 
agaš
;

3636 ià(
physiÿl
 >ð
physiÿl_’d
) {

3637 
¡Ý_loÝ
 = 1;

3641 
Ãxt
:

3642 
·th
->
¦Ùs
[0]++;

3644 
	`bŒfs_»Ëa£_·th
(
·th
);

3645 
sk
:

3646 
logiÿl
 +ð
šüem’t
;

3647 
physiÿl
 +ð
m­
->
¡re_Ën
;

3648 
	`¥š_lock
(&
sùx
->
¡©_lock
);

3649 ià(
¡Ý_loÝ
)

3650 
sùx
->
¡©
.
Ï¡_physiÿl
 = 
m­
->
¡res
[
num
].
physiÿl
 +

3651 
Ëngth
;

3653 
sùx
->
¡©
.
Ï¡_physiÿl
 = 
physiÿl
;

3654 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

3655 ià(
¡Ý_loÝ
)

3658 
out
:

3660 
	`süub_subm™
(
sùx
);

3661 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

3662 
	`süub_wr_subm™
(
sùx
);

3663 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

3665 
	`blk_fšish_¶ug
(&
¶ug
);

3666 
	`bŒfs_ä“_·th
(
·th
);

3667 
	`bŒfs_ä“_·th
(
µ©h
);

3668  
»t
 < 0 ?„et : 0;

3669 
	}
}

3671 
nošlše_fÜ_¡ack
 
	$süub_chunk
(
süub_ùx
 *
sùx
,

3672 
bŒfs_deviû
 *
süub_dev
,

3673 
u64
 
chunk_off£t
, u64 
Ëngth
,

3674 
u64
 
dev_off£t
,

3675 
bŒfs_block_group_ÿche
 *
ÿche
,

3676 
is_dev_»¶aû
)

3678 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

3679 
bŒfs_m­pšg_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

3680 
m­_lookup
 *
m­
;

3681 
ex‹Á_m­
 *
em
;

3682 
i
;

3683 
»t
 = 0;

3685 
	`»ad_lock
(&
m­_Œ“
->m­_Œ“.
lock
);

3686 
em
 = 
	`lookup_ex‹Á_m­pšg
(&
m­_Œ“
->m­_Œ“, 
chunk_off£t
, 1);

3687 
	`»ad_uÆock
(&
m­_Œ“
->m­_Œ“.
lock
);

3689 ià(!
em
) {

3694 
	`¥š_lock
(&
ÿche
->
lock
);

3695 ià(!
ÿche
->
»moved
)

3696 
»t
 = -
EINVAL
;

3697 
	`¥š_uÆock
(&
ÿche
->
lock
);

3699  
»t
;

3702 
m­
 = 
em
->
m­_lookup
;

3703 ià(
em
->
¡¬t
 !ð
chunk_off£t
)

3704 
out
;

3706 ià(
em
->
Ën
 < 
Ëngth
)

3707 
out
;

3709 
i
 = 0; i < 
m­
->
num_¡res
; ++i) {

3710 ià(
m­
->
¡res
[
i
].
dev
->
bdev
 =ð
süub_dev
->bdev &&

3711 
m­
->
¡res
[
i
].
physiÿl
 =ð
dev_off£t
) {

3712 
»t
 = 
	`süub_¡re
(
sùx
, 
m­
, 
süub_dev
, 
i
,

3713 
chunk_off£t
, 
Ëngth
,

3714 
is_dev_»¶aû
);

3715 ià(
»t
)

3716 
out
;

3719 
out
:

3720 
	`ä“_ex‹Á_m­
(
em
);

3722  
»t
;

3723 
	}
}

3725 
nošlše_fÜ_¡ack


3726 
	$süub_’um”©e_chunks
(
süub_ùx
 *
sùx
,

3727 
bŒfs_deviû
 *
süub_dev
, 
u64
 
¡¬t
, u64 
’d
,

3728 
is_dev_»¶aû
)

3730 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
 = 
NULL
;

3731 
bŒfs_·th
 *
·th
;

3732 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

3733 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

3734 
u64
 
Ëngth
;

3735 
u64
 
chunk_off£t
;

3736 
»t
 = 0;

3737 
ro_£t
;

3738 
¦Ù
;

3739 
ex‹Á_bufãr
 *
l
;

3740 
bŒfs_key
 
key
;

3741 
bŒfs_key
 
found_key
;

3742 
bŒfs_block_group_ÿche
 *
ÿche
;

3743 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

3745 
·th
 = 
	`bŒfs_®loc_·th
();

3746 ià(!
·th
)

3747  -
ENOMEM
;

3749 
·th
->
»ada
 = 
READA_FORWARD
;

3750 
·th
->
£¬ch_comm™_roÙ
 = 1;

3751 
·th
->
sk_lockšg
 = 1;

3753 
key
.
objeùid
 = 
süub_dev
->
devid
;

3754 
key
.
off£t
 = 0ull;

3755 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

3758 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

3759 ià(
»t
 < 0)

3761 ià(
»t
 > 0) {

3762 ià(
·th
->
¦Ùs
[0] >=

3763 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0])) {

3764 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3765 ià(
»t
 < 0)

3767 ià(
»t
 > 0) {

3768 
»t
 = 0;

3772 
»t
 = 0;

3776 
l
 = 
·th
->
nodes
[0];

3777 
¦Ù
 = 
·th
->
¦Ùs
[0];

3779 
	`bŒfs_™em_key_to_ýu
(
l
, &
found_key
, 
¦Ù
);

3781 ià(
found_key
.
objeùid
 !ð
süub_dev
->
devid
)

3784 ià(
found_key
.
ty³
 !ð
BTRFS_DEV_EXTENT_KEY
)

3787 ià(
found_key
.
off£t
 >ð
’d
)

3790 ià(
found_key
.
off£t
 < 
key
.offset)

3793 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

3794 
Ëngth
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
, 
dev_ex‹Á
);

3796 ià(
found_key
.
off£t
 + 
Ëngth
 <ð
¡¬t
)

3797 
sk
;

3799 
chunk_off£t
 = 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
l
, 
dev_ex‹Á
);

3805 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3809 ià(!
ÿche
)

3810 
sk
;

3820 
	`süub_·u£_Ú
(
fs_šfo
);

3821 
»t
 = 
	`bŒfs_šc_block_group_ro
(
fs_šfo
, 
ÿche
);

3822 ià(!
»t
 && 
is_dev_»¶aû
) {

3841 
	`bŒfs_wa™_block_group_»£rv©iÚs
(
ÿche
);

3842 
	`bŒfs_wa™_nocow_wr™”s
(
ÿche
);

3843 
»t
 = 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
,

3844 
ÿche
->
key
.
objeùid
,

3845 
ÿche
->
key
.
off£t
);

3846 ià(
»t
 > 0) {

3847 
bŒfs_Œªs_hªdË
 *
Œªs
;

3849 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

3850 ià(
	`IS_ERR
(
Œªs
))

3851 
»t
 = 
	`PTR_ERR
(
Œªs
);

3853 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3854 ià(
»t
) {

3855 
	`süub_·u£_off
(
fs_šfo
);

3856 
	`bŒfs_put_block_group
(
ÿche
);

3861 
	`süub_·u£_off
(
fs_šfo
);

3863 ià(
»t
 == 0) {

3864 
ro_£t
 = 1;

3865 } ià(
»t
 =ð-
ENOSPC
) {

3873 
ro_£t
 = 0;

3875 
	`bŒfs_w¬n
(
fs_šfo
,

3876 "çžed s‘tšg block grou°ro: %d", 
»t
);

3877 
	`bŒfs_put_block_group
(
ÿche
);

3881 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 1);

3882 
dev_»¶aû
->
cursÜ_right
 = 
found_key
.
off£t
 + 
Ëngth
;

3883 
dev_»¶aû
->
cursÜ_Ëá
 = 
found_key
.
off£t
;

3884 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

3885 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 1);

3886 
»t
 = 
	`süub_chunk
(
sùx
, 
süub_dev
, 
chunk_off£t
, 
Ëngth
,

3887 
found_key
.
off£t
, 
ÿche
, 
is_dev_»¶aû
);

3899 
sùx
->
æush_®l_wr™es
 = 
Œue
;

3900 
	`süub_subm™
(
sùx
);

3901 
	`mu‹x_lock
(&
sùx
->
wr_lock
);

3902 
	`süub_wr_subm™
(
sùx
);

3903 
	`mu‹x_uÆock
(&
sùx
->
wr_lock
);

3905 
	`wa™_ev’t
(
sùx
->
li¡_wa™
,

3906 
	`©omic_»ad
(&
sùx
->
bios_š_æight
) == 0);

3908 
	`süub_·u£_Ú
(
fs_šfo
);

3915 
	`wa™_ev’t
(
sùx
->
li¡_wa™
,

3916 
	`©omic_»ad
(&
sùx
->
wÜk”s_³ndšg
) == 0);

3917 
sùx
->
æush_®l_wr™es
 = 
çl£
;

3919 
	`süub_·u£_off
(
fs_šfo
);

3921 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 1);

3922 
dev_»¶aû
->
cursÜ_Ëá
 = dev_»¶aû->
cursÜ_right
;

3923 
dev_»¶aû
->
™em_Ãeds_wr™eback
 = 1;

3924 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 1);

3926 ià(
ro_£t
)

3927 
	`bŒfs_dec_block_group_ro
(
ÿche
);

3936 
	`¥š_lock
(&
ÿche
->
lock
);

3937 ià(!
ÿche
->
»moved
 && !ÿche->
ro
 && cache->
»£rved
 == 0 &&

3938 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
) == 0) {

3939 
	`¥š_uÆock
(&
ÿche
->
lock
);

3940 
	`¥š_lock
(&
fs_šfo
->
unu£d_bgs_lock
);

3941 ià(
	`li¡_em±y
(&
ÿche
->
bg_li¡
)) {

3942 
	`bŒfs_g‘_block_group
(
ÿche
);

3943 
	`li¡_add_ž
(&
ÿche
->
bg_li¡
,

3944 &
fs_šfo
->
unu£d_bgs
);

3946 
	`¥š_uÆock
(&
fs_šfo
->
unu£d_bgs_lock
);

3948 
	`¥š_uÆock
(&
ÿche
->
lock
);

3951 
	`bŒfs_put_block_group
(
ÿche
);

3952 ià(
»t
)

3954 ià(
is_dev_»¶aû
 &&

3955 
	`©omic64_»ad
(&
dev_»¶aû
->
num_wr™e_”rÜs
) > 0) {

3956 
»t
 = -
EIO
;

3959 ià(
sùx
->
¡©
.
m®loc_”rÜs
 > 0) {

3960 
»t
 = -
ENOMEM
;

3963 
sk
:

3964 
key
.
off£t
 = 
found_key
.off£ˆ+ 
Ëngth
;

3965 
	`bŒfs_»Ëa£_·th
(
·th
);

3968 
	`bŒfs_ä“_·th
(
·th
);

3970  
»t
;

3971 
	}
}

3973 
nošlše_fÜ_¡ack
 
	$süub_su³rs
(
süub_ùx
 *
sùx
,

3974 
bŒfs_deviû
 *
süub_dev
)

3976 
i
;

3977 
u64
 
by‹Ä
;

3978 
u64
 
g’
;

3979 
»t
;

3980 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

3982 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
))

3983  -
EIO
;

3986 ià(
süub_dev
->
fs_deviûs
 !ð
fs_šfo
->fs_devices)

3987 
g’
 = 
süub_dev
->
g’”©iÚ
;

3989 
g’
 = 
fs_šfo
->
Ï¡_Œªs_comm™‹d
;

3991 
i
 = 0; i < 
BTRFS_SUPER_MIRROR_MAX
; i++) {

3992 
by‹Ä
 = 
	`bŒfs_sb_off£t
(
i
);

3993 ià(
by‹Ä
 + 
BTRFS_SUPER_INFO_SIZE
 >

3994 
süub_dev
->
comm™_tÙ®_by‹s
)

3997 
»t
 = 
	`süub_·ges
(
sùx
, 
by‹Ä
, 
BTRFS_SUPER_INFO_SIZE
, bytenr,

3998 
süub_dev
, 
BTRFS_EXTENT_FLAG_SUPER
, 
g’
, 
i
,

3999 
NULL
, 1, 
by‹Ä
);

4000 ià(
»t
)

4001  
»t
;

4003 
	`wa™_ev’t
(
sùx
->
li¡_wa™
, 
	`©omic_»ad
(&sùx->
bios_š_æight
) == 0);

4006 
	}
}

4011 
nošlše_fÜ_¡ack
 
	$süub_wÜk”s_g‘
(
bŒfs_fs_šfo
 *
fs_šfo
,

4012 
is_dev_»¶aû
)

4014 
æags
 = 
WQ_FREEZABLE
 | 
WQ_UNBOUND
;

4015 
max_aùive
 = 
fs_šfo
->
th»ad_poÞ_size
;

4017 ià(
fs_šfo
->
süub_wÜk”s_»fút
 == 0) {

4018 
fs_šfo
->
süub_wÜk”s
 = 
	`bŒfs_®loc_wÜkqueue
(fs_info, "scrub",

4019 
æags
, 
is_dev_»¶aû
 ? 1 : 
max_aùive
, 4);

4020 ià(!
fs_šfo
->
süub_wÜk”s
)

4021 
çž_süub_wÜk”s
;

4023 
fs_šfo
->
süub_wr_com¶‘iÚ_wÜk”s
 =

4024 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "süubwrc", 
æags
,

4025 
max_aùive
, 2);

4026 ià(!
fs_šfo
->
süub_wr_com¶‘iÚ_wÜk”s
)

4027 
çž_süub_wr_com¶‘iÚ_wÜk”s
;

4029 
fs_šfo
->
süub_nocow_wÜk”s
 =

4030 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "süubnc", 
æags
, 1, 0);

4031 ià(!
fs_šfo
->
süub_nocow_wÜk”s
)

4032 
çž_süub_nocow_wÜk”s
;

4033 
fs_šfo
->
süub_·r™y_wÜk”s
 =

4034 
	`bŒfs_®loc_wÜkqueue
(
fs_šfo
, "süub·r™y", 
æags
,

4035 
max_aùive
, 2);

4036 ià(!
fs_šfo
->
süub_·r™y_wÜk”s
)

4037 
çž_süub_·r™y_wÜk”s
;

4039 ++
fs_šfo
->
süub_wÜk”s_»fút
;

4042 
çž_süub_·r™y_wÜk”s
:

4043 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_nocow_wÜk”s
);

4044 
çž_süub_nocow_wÜk”s
:

4045 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_wr_com¶‘iÚ_wÜk”s
);

4046 
çž_süub_wr_com¶‘iÚ_wÜk”s
:

4047 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_wÜk”s
);

4048 
çž_süub_wÜk”s
:

4049  -
ENOMEM
;

4050 
	}
}

4052 
nošlše_fÜ_¡ack
 
	$süub_wÜk”s_put
(
bŒfs_fs_šfo
 *
fs_šfo
)

4054 ià(--
fs_šfo
->
süub_wÜk”s_»fút
 == 0) {

4055 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_wÜk”s
);

4056 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_wr_com¶‘iÚ_wÜk”s
);

4057 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_nocow_wÜk”s
);

4058 
	`bŒfs_de¡roy_wÜkqueue
(
fs_šfo
->
süub_·r™y_wÜk”s
);

4060 
	`WARN_ON
(
fs_šfo
->
süub_wÜk”s_»fút
 < 0);

4061 
	}
}

4063 
	$bŒfs_süub_dev
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
, u64 
¡¬t
,

4064 
u64
 
’d
, 
bŒfs_süub_´og»ss
 *
´og»ss
,

4065 
»adÚly
, 
is_dev_»¶aû
)

4067 
süub_ùx
 *
sùx
;

4068 
»t
;

4069 
bŒfs_deviû
 *
dev
;

4070 
rcu_¡ršg
 *
Çme
;

4072 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
))

4073  -
EINVAL
;

4075 ià(
fs_šfo
->
nodesize
 > 
BTRFS_STRIPE_LEN
) {

4081 
	`bŒfs_”r
(
fs_šfo
,

4083 
fs_šfo
->
nodesize
,

4084 
BTRFS_STRIPE_LEN
);

4085  -
EINVAL
;

4088 ià(
fs_šfo
->
£ùÜsize
 !ð
PAGE_SIZE
) {

4090 
	`bŒfs_”r_¾
(
fs_šfo
,

4092 
fs_šfo
->
£ùÜsize
, 
PAGE_SIZE
);

4093  -
EINVAL
;

4096 ià(
fs_šfo
->
nodesize
 >

4097 
PAGE_SIZE
 * 
SCRUB_MAX_PAGES_PER_BLOCK
 ||

4098 
fs_šfo
->
£ùÜsize
 > 
PAGE_SIZE
 * 
SCRUB_MAX_PAGES_PER_BLOCK
) {

4103 
	`bŒfs_”r
(
fs_šfo
,

4105 
fs_šfo
->
nodesize
,

4106 
SCRUB_MAX_PAGES_PER_BLOCK
,

4107 
fs_šfo
->
£ùÜsize
,

4108 
SCRUB_MAX_PAGES_PER_BLOCK
);

4109  -
EINVAL
;

4113 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4114 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
NULL
, NULL);

4115 ià(!
dev
 || (dev->
missšg
 && !
is_dev_»¶aû
)) {

4116 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4117  -
ENODEV
;

4120 ià(!
is_dev_»¶aû
 && !
»adÚly
 && !
dev
->
wr™—bË
) {

4121 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4122 
	`rcu_»ad_lock
();

4123 
Çme
 = 
	`rcu_d”eã»nû
(
dev
->name);

4124 
	`bŒfs_”r
(
fs_šfo
, "scrub: device %s is‚ot writable",

4125 
Çme
->
¡r
);

4126 
	`rcu_»ad_uÆock
();

4127  -
EROFS
;

4130 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4131 ià(!
dev
->
š_fs_m‘ad©a
 || dev->
is_tgtdev_fÜ_dev_»¶aû
) {

4132 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4133 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4134  -
EIO
;

4137 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 0);

4138 ià(
dev
->
süub_deviû
 ||

4139 (!
is_dev_»¶aû
 &&

4140 
	`bŒfs_dev_»¶aû_is_Úgošg
(&
fs_šfo
->
dev_»¶aû
))) {

4141 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

4142 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4143 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4144  -
EINPROGRESS
;

4146 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

4148 
»t
 = 
	`süub_wÜk”s_g‘
(
fs_šfo
, 
is_dev_»¶aû
);

4149 ià(
»t
) {

4150 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4151 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4152  
»t
;

4155 
sùx
 = 
	`süub_£tup_ùx
(
dev
, 
is_dev_»¶aû
);

4156 ià(
	`IS_ERR
(
sùx
)) {

4157 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4158 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4159 
	`süub_wÜk”s_put
(
fs_šfo
);

4160  
	`PTR_ERR
(
sùx
);

4162 
sùx
->
»adÚly
 =„eadonly;

4163 
dev
->
süub_deviû
 = 
sùx
;

4164 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4170 
	`__süub_blocked_if_Ãeded
(
fs_šfo
);

4171 
	`©omic_šc
(&
fs_šfo
->
süubs_ruÂšg
);

4172 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4174 ià(!
is_dev_»¶aû
) {

4179 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4180 
»t
 = 
	`süub_su³rs
(
sùx
, 
dev
);

4181 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4184 ià(!
»t
)

4185 
»t
 = 
	`süub_’um”©e_chunks
(
sùx
, 
dev
, 
¡¬t
, 
’d
,

4186 
is_dev_»¶aû
);

4188 
	`wa™_ev’t
(
sùx
->
li¡_wa™
, 
	`©omic_»ad
(&sùx->
bios_š_æight
) == 0);

4189 
	`©omic_dec
(&
fs_šfo
->
süubs_ruÂšg
);

4190 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

4192 
	`wa™_ev’t
(
sùx
->
li¡_wa™
, 
	`©omic_»ad
(&sùx->
wÜk”s_³ndšg
) == 0);

4194 ià(
´og»ss
)

4195 
	`memýy
(
´og»ss
, &
sùx
->
¡©
, (*progress));

4197 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4198 
dev
->
süub_deviû
 = 
NULL
;

4199 
	`süub_wÜk”s_put
(
fs_šfo
);

4200 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4202 
	`süub_put_ùx
(
sùx
);

4204  
»t
;

4205 
	}
}

4207 
	$bŒfs_süub_·u£
(
bŒfs_fs_šfo
 *
fs_šfo
)

4209 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4210 
	`©omic_šc
(&
fs_šfo
->
süub_·u£_»q
);

4211 
	`©omic_»ad
(&
fs_šfo
->
süubs_·u£d
) !=

4212 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
)) {

4213 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4214 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

4215 
	`©omic_»ad
(&
fs_šfo
->
süubs_·u£d
) ==

4216 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
));

4217 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4219 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4220 
	}
}

4222 
	$bŒfs_süub_cÚtšue
(
bŒfs_fs_šfo
 *
fs_šfo
)

4224 
	`©omic_dec
(&
fs_šfo
->
süub_·u£_»q
);

4225 
	`wake_up
(&
fs_šfo
->
süub_·u£_wa™
);

4226 
	}
}

4228 
	$bŒfs_süub_ÿnûl
(
bŒfs_fs_šfo
 *
fs_šfo
)

4230 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4231 ià(!
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
)) {

4232 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4233  -
ENOTCONN
;

4236 
	`©omic_šc
(&
fs_šfo
->
süub_ÿnûl_»q
);

4237 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
)) {

4238 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4239 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

4240 
	`©omic_»ad
(&
fs_šfo
->
süubs_ruÂšg
) == 0);

4241 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4243 
	`©omic_dec
(&
fs_šfo
->
süub_ÿnûl_»q
);

4244 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4247 
	}
}

4249 
	$bŒfs_süub_ÿnûl_dev
(
bŒfs_fs_šfo
 *
fs_šfo
,

4250 
bŒfs_deviû
 *
dev
)

4252 
süub_ùx
 *
sùx
;

4254 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4255 
sùx
 = 
dev
->
süub_deviû
;

4256 ià(!
sùx
) {

4257 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4258  -
ENOTCONN
;

4260 
	`©omic_šc
(&
sùx
->
ÿnûl_»q
);

4261 
dev
->
süub_deviû
) {

4262 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4263 
	`wa™_ev’t
(
fs_šfo
->
süub_·u£_wa™
,

4264 
dev
->
süub_deviû
 =ð
NULL
);

4265 
	`mu‹x_lock
(&
fs_šfo
->
süub_lock
);

4267 
	`mu‹x_uÆock
(&
fs_šfo
->
süub_lock
);

4270 
	}
}

4272 
	$bŒfs_süub_´og»ss
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

4273 
bŒfs_süub_´og»ss
 *
´og»ss
)

4275 
bŒfs_deviû
 *
dev
;

4276 
süub_ùx
 *
sùx
 = 
NULL
;

4278 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4279 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
NULL
, NULL);

4280 ià(
dev
)

4281 
sùx
 = 
dev
->
süub_deviû
;

4282 ià(
sùx
)

4283 
	`memýy
(
´og»ss
, &
sùx
->
¡©
, (*progress));

4284 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4286  
dev
 ? (
sùx
 ? 0 : -
ENOTCONN
è: -
ENODEV
;

4287 
	}
}

4289 
	$süub_»m­_ex‹Á
(
bŒfs_fs_šfo
 *
fs_šfo
,

4290 
u64
 
ex‹Á_logiÿl
, u64 
ex‹Á_Ën
,

4291 
u64
 *
ex‹Á_physiÿl
,

4292 
bŒfs_deviû
 **
ex‹Á_dev
,

4293 *
ex‹Á_mœrÜ_num
)

4295 
u64
 
m­³d_Ëngth
;

4296 
bŒfs_bio
 *
bbio
 = 
NULL
;

4297 
»t
;

4299 
m­³d_Ëngth
 = 
ex‹Á_Ën
;

4300 
»t
 = 
	`bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_READ
, 
ex‹Á_logiÿl
,

4301 &
m­³d_Ëngth
, &
bbio
, 0);

4302 ià(
»t
 || !
bbio
 || 
m­³d_Ëngth
 < 
ex‹Á_Ën
 ||

4303 !
bbio
->
¡res
[0].
dev
->
bdev
) {

4304 
	`bŒfs_put_bbio
(
bbio
);

4308 *
ex‹Á_physiÿl
 = 
bbio
->
¡res
[0].
physiÿl
;

4309 *
ex‹Á_mœrÜ_num
 = 
bbio
->
mœrÜ_num
;

4310 *
ex‹Á_dev
 = 
bbio
->
¡res
[0].
dev
;

4311 
	`bŒfs_put_bbio
(
bbio
);

4312 
	}
}

4314 
	$cÝy_nocow_·ges
(
süub_ùx
 *
sùx
, 
u64
 
logiÿl
, u64 
Ën
,

4315 
mœrÜ_num
, 
u64
 
physiÿl_fÜ_dev_»¶aû
)

4317 
süub_cÝy_nocow_ùx
 *
nocow_ùx
;

4318 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

4320 
nocow_ùx
 = 
	`kz®loc
((*nocow_ùx), 
GFP_NOFS
);

4321 ià(!
nocow_ùx
) {

4322 
	`¥š_lock
(&
sùx
->
¡©_lock
);

4323 
sùx
->
¡©
.
m®loc_”rÜs
++;

4324 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

4325  -
ENOMEM
;

4328 
	`süub_³ndšg_Œªs_wÜk”s_šc
(
sùx
);

4330 
nocow_ùx
->
sùx
 = sctx;

4331 
nocow_ùx
->
logiÿl
 =†ogical;

4332 
nocow_ùx
->
Ën
 =†en;

4333 
nocow_ùx
->
mœrÜ_num
 = mirror_num;

4334 
nocow_ùx
->
physiÿl_fÜ_dev_»¶aû
 =…hysical_for_dev_replace;

4335 
	`bŒfs_š™_wÜk
(&
nocow_ùx
->
wÜk
, 
bŒfs_süubnc_h–³r
,

4336 
cÝy_nocow_·ges_wÜk”
, 
NULL
, NULL);

4337 
	`INIT_LIST_HEAD
(&
nocow_ùx
->
šodes
);

4338 
	`bŒfs_queue_wÜk
(
fs_šfo
->
süub_nocow_wÜk”s
,

4339 &
nocow_ùx
->
wÜk
);

4342 
	}
}

4344 
	$»cÜd_šode_fÜ_nocow
(
u64
 
šum
, u64 
off£t
, u64 
roÙ
, *
ùx
)

4346 
süub_cÝy_nocow_ùx
 *
nocow_ùx
 = 
ùx
;

4347 
süub_nocow_šode
 *
nocow_šode
;

4349 
nocow_šode
 = 
	`kz®loc
((*nocow_šode), 
GFP_NOFS
);

4350 ià(!
nocow_šode
)

4351  -
ENOMEM
;

4352 
nocow_šode
->
šum
 = inum;

4353 
nocow_šode
->
off£t
 = offset;

4354 
nocow_šode
->
roÙ
 =„oot;

4355 
	`li¡_add_ž
(&
nocow_šode
->
li¡
, &
nocow_ùx
->
šodes
);

4357 
	}
}

4359 
	#COPY_COMPLETE
 1

	)

4361 
	$cÝy_nocow_·ges_wÜk”
(
bŒfs_wÜk
 *
wÜk
)

4363 
süub_cÝy_nocow_ùx
 *
nocow_ùx
 =

4364 
	`cÚš”_of
(
wÜk
, 
süub_cÝy_nocow_ùx
, work);

4365 
süub_ùx
 *
sùx
 = 
nocow_ùx
->sctx;

4366 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->fs_info;

4367 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
ex‹Á_roÙ
;

4368 
u64
 
logiÿl
 = 
nocow_ùx
->logical;

4369 
u64
 
Ën
 = 
nocow_ùx
->len;

4370 
mœrÜ_num
 = 
nocow_ùx
->mirror_num;

4371 
u64
 
physiÿl_fÜ_dev_»¶aû
 = 
nocow_ùx
->physical_for_dev_replace;

4372 
»t
;

4373 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

4374 
bŒfs_·th
 *
·th
;

4375 
nÙ_wr™‹n
 = 0;

4377 
·th
 = 
	`bŒfs_®loc_·th
();

4378 ià(!
·th
) {

4379 
	`¥š_lock
(&
sùx
->
¡©_lock
);

4380 
sùx
->
¡©
.
m®loc_”rÜs
++;

4381 
	`¥š_uÆock
(&
sùx
->
¡©_lock
);

4382 
nÙ_wr™‹n
 = 1;

4383 
out
;

4386 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
roÙ
);

4387 ià(
	`IS_ERR
(
Œªs
)) {

4388 
nÙ_wr™‹n
 = 1;

4389 
out
;

4392 
»t
 = 
	`™”©e_šodes_äom_logiÿl
(
logiÿl
, 
fs_šfo
, 
·th
,

4393 
»cÜd_šode_fÜ_nocow
, 
nocow_ùx
);

4394 ià(
»t
 !ð0 &&„‘ !ð-
ENOENT
) {

4395 
	`bŒfs_w¬n
(
fs_šfo
,

4397 
logiÿl
, 
physiÿl_fÜ_dev_»¶aû
, 
Ën
, 
mœrÜ_num
,

4398 
»t
);

4399 
nÙ_wr™‹n
 = 1;

4400 
out
;

4403 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4404 
Œªs
 = 
NULL
;

4405 !
	`li¡_em±y
(&
nocow_ùx
->
šodes
)) {

4406 
süub_nocow_šode
 *
’Œy
;

4407 
’Œy
 = 
	`li¡_fœ¡_’Œy
(&
nocow_ùx
->
šodes
,

4408 
süub_nocow_šode
,

4409 
li¡
);

4410 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

4411 
»t
 = 
	`cÝy_nocow_·ges_fÜ_šode
(
’Œy
->
šum
,ƒÁry->
off£t
,

4412 
’Œy
->
roÙ
, 
nocow_ùx
);

4413 
	`kä“
(
’Œy
);

4414 ià(
»t
 =ð
COPY_COMPLETE
) {

4415 
»t
 = 0;

4417 } ià(
»t
) {

4421 
out
:

4422 !
	`li¡_em±y
(&
nocow_ùx
->
šodes
)) {

4423 
süub_nocow_šode
 *
’Œy
;

4424 
’Œy
 = 
	`li¡_fœ¡_’Œy
(&
nocow_ùx
->
šodes
,

4425 
süub_nocow_šode
,

4426 
li¡
);

4427 
	`li¡_d–_š™
(&
’Œy
->
li¡
);

4428 
	`kä“
(
’Œy
);

4430 ià(
Œªs
 && !
	`IS_ERR
(trans))

4431 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4432 ià(
nÙ_wr™‹n
)

4433 
	`bŒfs_dev_»¶aû_¡©s_šc
(&
fs_šfo
->
dev_»¶aû
.

4434 
num_uncÜ»ùabË_»ad_”rÜs
);

4436 
	`bŒfs_ä“_·th
(
·th
);

4437 
	`kä“
(
nocow_ùx
);

4439 
	`süub_³ndšg_Œªs_wÜk”s_dec
(
sùx
);

4440 
	}
}

4442 
	$check_ex‹Á_to_block
(
bŒfs_šode
 *
šode
, 
u64
 
¡¬t
, u64 
Ën
,

4443 
u64
 
logiÿl
)

4445 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

4446 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

4447 
ex‹Á_io_Œ“
 *
io_Œ“
;

4448 
ex‹Á_m­
 *
em
;

4449 
u64
 
lock¡¬t
 = 
¡¬t
, 
lock’d
 = s¹ + 
Ën
 - 1;

4450 
»t
 = 0;

4452 
io_Œ“
 = &
šode
->io_tree;

4454 
	`lock_ex‹Á_b™s
(
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
);

4455 
Üd”ed
 = 
	`bŒfs_lookup_Üd”ed_¿nge
(
šode
, 
lock¡¬t
, 
Ën
);

4456 ià(
Üd”ed
) {

4457 
	`bŒfs_put_Üd”ed_ex‹Á
(
Üd”ed
);

4458 
»t
 = 1;

4459 
out_uÆock
;

4462 
em
 = 
	`bŒfs_g‘_ex‹Á
(
šode
, 
NULL
, 0, 
¡¬t
, 
Ën
, 0);

4463 ià(
	`IS_ERR
(
em
)) {

4464 
»t
 = 
	`PTR_ERR
(
em
);

4465 
out_uÆock
;

4472 ià(
em
->
block_¡¬t
 > 
logiÿl
 ||

4473 
em
->
block_¡¬t
 +ƒm->
block_Ën
 < 
logiÿl
 + 
Ën
) {

4474 
	`ä“_ex‹Á_m­
(
em
);

4475 
»t
 = 1;

4476 
out_uÆock
;

4478 
	`ä“_ex‹Á_m­
(
em
);

4480 
out_uÆock
:

4481 
	`uÆock_ex‹Á_ÿched
(
io_Œ“
, 
lock¡¬t
, 
lock’d
, &
ÿched_¡©e
,

4482 
GFP_NOFS
);

4483  
»t
;

4484 
	}
}

4486 
	$cÝy_nocow_·ges_fÜ_šode
(
u64
 
šum
, u64 
off£t
, u64 
roÙ
,

4487 
süub_cÝy_nocow_ùx
 *
nocow_ùx
)

4489 
bŒfs_fs_šfo
 *
fs_šfo
 = 
nocow_ùx
->
sùx
->fs_info;

4490 
bŒfs_key
 
key
;

4491 
šode
 *inode;

4492 
·ge
 *page;

4493 
bŒfs_roÙ
 *
loÿl_roÙ
;

4494 
ex‹Á_io_Œ“
 *
io_Œ“
;

4495 
u64
 
physiÿl_fÜ_dev_»¶aû
;

4496 
u64
 
nocow_ùx_logiÿl
;

4497 
u64
 
Ën
 = 
nocow_ùx
->len;

4498 
šdex
;

4499 
¤cu_šdex
;

4500 
»t
 = 0;

4501 
”r
 = 0;

4503 
key
.
objeùid
 = 
roÙ
;

4504 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4505 
key
.
off£t
 = (
u64
)-1;

4507 
¤cu_šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

4509 
loÿl_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

4510 ià(
	`IS_ERR
(
loÿl_roÙ
)) {

4511 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
¤cu_šdex
);

4512  
	`PTR_ERR
(
loÿl_roÙ
);

4515 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4516 
key
.
objeùid
 = 
šum
;

4517 
key
.
off£t
 = 0;

4518 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
loÿl_roÙ
, 
NULL
);

4519 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
¤cu_šdex
);

4520 ià(
	`IS_ERR
(
šode
))

4521  
	`PTR_ERR
(
šode
);

4524 
	`šode_lock
(
šode
);

4525 
	`šode_dio_wa™
(
šode
);

4527 
physiÿl_fÜ_dev_»¶aû
 = 
nocow_ùx
->physical_for_dev_replace;

4528 
io_Œ“
 = &
	`BTRFS_I
(
šode
)->io_tree;

4529 
nocow_ùx_logiÿl
 = 
nocow_ùx
->
logiÿl
;

4531 
»t
 = 
	`check_ex‹Á_to_block
(
	`BTRFS_I
(
šode
), 
off£t
, 
Ën
,

4532 
nocow_ùx_logiÿl
);

4533 ià(
»t
) {

4534 
»t
 =„et > 0 ? 0 :„et;

4535 
out
;

4538 
Ën
 >ð
PAGE_SIZE
) {

4539 
šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

4540 
agaš
:

4541 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
GFP_NOFS
);

4542 ià(!
·ge
) {

4543 
	`bŒfs_”r
(
fs_šfo
, "find_or_create_page() failed");

4544 
»t
 = -
ENOMEM
;

4545 
out
;

4548 ià(
	`PageU±od©e
(
·ge
)) {

4549 ià(
	`PageDœty
(
·ge
))

4550 
Ãxt_·ge
;

4552 
	`CË¬PageE¼Ü
(
·ge
);

4553 
”r
 = 
	`ex‹Á_»ad_fuÎ_·ge
(
io_Œ“
, 
·ge
,

4554 
bŒfs_g‘_ex‹Á
,

4555 
nocow_ùx
->
mœrÜ_num
);

4556 ià(
”r
) {

4557 
»t
 = 
”r
;

4558 
Ãxt_·ge
;

4561 
	`lock_·ge
(
·ge
);

4568 ià(
·ge
->
m­pšg
 !ð
šode
->
i_m­pšg
) {

4569 
	`uÆock_·ge
(
·ge
);

4570 
	`put_·ge
(
·ge
);

4571 
agaš
;

4573 ià(!
	`PageU±od©e
(
·ge
)) {

4574 
»t
 = -
EIO
;

4575 
Ãxt_·ge
;

4579 
»t
 = 
	`check_ex‹Á_to_block
(
	`BTRFS_I
(
šode
), 
off£t
, 
Ën
,

4580 
nocow_ùx_logiÿl
);

4581 ià(
»t
) {

4582 
»t
 =„et > 0 ? 0 :„et;

4583 
Ãxt_·ge
;

4586 
”r
 = 
	`wr™e_·ge_nocow
(
nocow_ùx
->
sùx
,

4587 
physiÿl_fÜ_dev_»¶aû
, 
·ge
);

4588 ià(
”r
)

4589 
»t
 = 
”r
;

4590 
Ãxt_·ge
:

4591 
	`uÆock_·ge
(
·ge
);

4592 
	`put_·ge
(
·ge
);

4594 ià(
»t
)

4597 
off£t
 +ð
PAGE_SIZE
;

4598 
physiÿl_fÜ_dev_»¶aû
 +ð
PAGE_SIZE
;

4599 
nocow_ùx_logiÿl
 +ð
PAGE_SIZE
;

4600 
Ën
 -ð
PAGE_SIZE
;

4602 
»t
 = 
COPY_COMPLETE
;

4603 
out
:

4604 
	`šode_uÆock
(
šode
);

4605 
	`ut
(
šode
);

4606  
»t
;

4607 
	}
}

4609 
	$wr™e_·ge_nocow
(
süub_ùx
 *
sùx
,

4610 
u64
 
physiÿl_fÜ_dev_»¶aû
, 
·ge
 *page)

4612 
bio
 *bio;

4613 
bŒfs_deviû
 *
dev
;

4614 
»t
;

4616 
dev
 = 
sùx
->
wr_tgtdev
;

4617 ià(!
dev
)

4618  -
EIO
;

4619 ià(!
dev
->
bdev
) {

4620 
	`bŒfs_w¬n_¾
(
dev
->
fs_šfo
,

4622  -
EIO
;

4624 
bio
 = 
	`bŒfs_io_bio_®loc
(1);

4625 
bio
->
bi_™”
.
bi_size
 = 0;

4626 
bio
->
bi_™”
.
bi_£ùÜ
 = 
physiÿl_fÜ_dev_»¶aû
 >> 9;

4627 
	`bio_£t_dev
(
bio
, 
dev
->
bdev
);

4628 
bio
->
bi_Ýf
 = 
REQ_OP_WRITE
 | 
REQ_SYNC
;

4629 
»t
 = 
	`bio_add_·ge
(
bio
, 
·ge
, 
PAGE_SIZE
, 0);

4630 ià(
»t
 !ð
PAGE_SIZE
) {

4631 
Ëave_w™h_eio
:

4632 
	`bio_put
(
bio
);

4633 
	`bŒfs_dev_¡©_šc_ªd_´št
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
);

4634  -
EIO
;

4637 ià(
	`bŒfsic_subm™_bio_wa™
(
bio
))

4638 
Ëave_w™h_eio
;

4640 
	`bio_put
(
bio
);

4642 
	}
}

	@send.c

19 
	~<lšux/b£¬ch.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/fže.h
>

22 
	~<lšux/sÜt.h
>

23 
	~<lšux/mouÁ.h
>

24 
	~<lšux/x©Œ.h
>

25 
	~<lšux/posix_aþ_x©Œ.h
>

26 
	~<lšux/¿dix-Œ“.h
>

27 
	~<lšux/vm®loc.h
>

28 
	~<lšux/¡ršg.h
>

30 
	~"£nd.h
"

31 
	~"back»f.h
"

32 
	~"hash.h
"

33 
	~"lockšg.h
"

34 
	~"disk-io.h
"

35 
	~"bŒfs_šode.h
"

36 
	~"Œª§ùiÚ.h
"

37 
	~"com´essiÚ.h
"

46 
	sfs_·th
 {

49 *
	m¡¬t
;

50 *
	m’d
;

52 *
	mbuf
;

53 
	mbuf_Ën
:15;

54 
	m»v”£d
:1;

55 
	mšlše_buf
[];

62 
	m·d
[256];

65 
	#FS_PATH_INLINE_SIZE
 \

66 ((
fs_·th
è- 
	`off£tof
(fs_·th, 
šlše_buf
))

	)

70 
	sþÚe_roÙ
 {

71 
bŒfs_roÙ
 *
	mroÙ
;

72 
u64
 
	mšo
;

73 
u64
 
	moff£t
;

75 
u64
 
	mfound_»fs
;

78 
	#SEND_CTX_MAX_NAME_CACHE_SIZE
 128

	)

79 
	#SEND_CTX_NAME_CACHE_CLEAN_SIZE
 (
SEND_CTX_MAX_NAME_CACHE_SIZE
 * 2)

	)

81 
	s£nd_ùx
 {

82 
fže
 *
	m£nd_fžp
;

83 
loff_t
 
	m£nd_off
;

84 *
	m£nd_buf
;

85 
u32
 
	m£nd_size
;

86 
u32
 
	m£nd_max_size
;

87 
u64
 
	mtÙ®_£nd_size
;

88 
u64
 
	mcmd_£nd_size
[
BTRFS_SEND_C_MAX
 + 1];

89 
u64
 
	mæags
;

91 
bŒfs_roÙ
 *
	m£nd_roÙ
;

92 
bŒfs_roÙ
 *
	m·»Á_roÙ
;

93 
þÚe_roÙ
 *
	mþÚe_roÙs
;

94 
	mþÚe_roÙs_út
;

97 
bŒfs_·th
 *
	mËá_·th
;

98 
bŒfs_·th
 *
	mright_·th
;

99 
bŒfs_key
 *
	mcmp_key
;

105 
u64
 
	mcur_šo
;

106 
u64
 
	mcur_šode_g’
;

107 
	mcur_šode_Ãw
;

108 
	mcur_šode_Ãw_g’
;

109 
	mcur_šode_d–‘ed
;

110 
u64
 
	mcur_šode_size
;

111 
u64
 
	mcur_šode_mode
;

112 
u64
 
	mcur_šode_rdev
;

113 
u64
 
	mcur_šode_Ï¡_ex‹Á
;

115 
u64
 
	m£nd_´og»ss
;

117 
li¡_h—d
 
	mÃw_»fs
;

118 
li¡_h—d
 
	md–‘ed_»fs
;

120 
¿dix_Œ“_roÙ
 
	mÇme_ÿche
;

121 
li¡_h—d
 
	mÇme_ÿche_li¡
;

122 
	mÇme_ÿche_size
;

124 
fže_¿_¡©e
 
	m¿
;

126 *
	m»ad_buf
;

173 
rb_roÙ
 
	m³ndšg_dœ_moves
;

180 
rb_roÙ
 
	mwa™šg_dœ_moves
;

221 
rb_roÙ
 
	mÜphª_dœs
;

224 
	s³ndšg_dœ_move
 {

225 
rb_node
 
	mnode
;

226 
li¡_h—d
 
	mli¡
;

227 
u64
 
	m·»Á_šo
;

228 
u64
 
	mšo
;

229 
u64
 
	mg’
;

230 
li¡_h—d
 
	mupd©e_»fs
;

233 
	swa™šg_dœ_move
 {

234 
rb_node
 
	mnode
;

235 
u64
 
	mšo
;

241 
u64
 
	mrmdœ_šo
;

242 
boÞ
 
	mÜphªized
;

245 
	sÜphª_dœ_šfo
 {

246 
rb_node
 
	mnode
;

247 
u64
 
	mšo
;

248 
u64
 
	mg’
;

251 
	sÇme_ÿche_’Œy
 {

252 
li¡_h—d
 
	mli¡
;

261 
li¡_h—d
 
	m¿dix_li¡
;

262 
u64
 
	mšo
;

263 
u64
 
	mg’
;

264 
u64
 
	m·»Á_šo
;

265 
u64
 
	m·»Á_g’
;

266 
	m»t
;

267 
	mÃed_Ï‹r_upd©e
;

268 
	mÇme_Ën
;

269 
	mÇme
[];

272 
	$šcÚsi¡’t_¢­shÙ_”rÜ
(
£nd_ùx
 *
sùx
,

273 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
,

274 cÚ¡ *
wh©
)

276 cÚ¡ *
»suÉ_¡ršg
;

278 
»suÉ
) {

279 
BTRFS_COMPARE_TREE_NEW
:

280 
»suÉ_¡ršg
 = "new";

282 
BTRFS_COMPARE_TREE_DELETED
:

283 
»suÉ_¡ršg
 = "deleted";

285 
BTRFS_COMPARE_TREE_CHANGED
:

286 
»suÉ_¡ršg
 = "updated";

288 
BTRFS_COMPARE_TREE_SAME
:

289 
	`ASSERT
(0);

290 
»suÉ_¡ršg
 = "unchanged";

293 
	`ASSERT
(0);

294 
»suÉ_¡ršg
 = "unexpected";

297 
	`bŒfs_”r
(
sùx
->
£nd_roÙ
->
fs_šfo
,

299 
»suÉ_¡ršg
, 
wh©
, 
sùx
->
cmp_key
->
objeùid
,

300 
sùx
->
£nd_roÙ
->
roÙ_key
.
objeùid
,

301 (
sùx
->
·»Á_roÙ
 ?

302 
sùx
->
·»Á_roÙ
->
roÙ_key
.
objeùid
 : 0));

303 
	}
}

305 
is_wa™šg_fÜ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
);

307 
wa™šg_dœ_move
 *

308 
g‘_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
);

310 
is_wa™šg_fÜ_rm
(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
);

312 
	$Ãed_£nd_hÞe
(
£nd_ùx
 *
sùx
)

314  (
sùx
->
·»Á_roÙ
 && !sùx->
cur_šode_Ãw
 &&

315 !
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
 &&

316 
	`S_ISREG
(
sùx
->
cur_šode_mode
));

317 
	}
}

319 
	$fs_·th_»£t
(
fs_·th
 *
p
)

321 ià(
p
->
»v”£d
) {

322 
p
->
¡¬t
 =…->
buf
 +…->
buf_Ën
 - 1;

323 
p
->
’d
 =…->
¡¬t
;

324 *
p
->
¡¬t
 = 0;

326 
p
->
¡¬t
 =…->
buf
;

327 
p
->
’d
 =…->
¡¬t
;

328 *
p
->
¡¬t
 = 0;

330 
	}
}

332 
fs_·th
 *
	$fs_·th_®loc
()

334 
fs_·th
 *
p
;

336 
p
 = 
	`km®loc
((*p), 
GFP_KERNEL
);

337 ià(!
p
)

338  
NULL
;

339 
p
->
»v”£d
 = 0;

340 
p
->
buf
 =…->
šlše_buf
;

341 
p
->
buf_Ën
 = 
FS_PATH_INLINE_SIZE
;

342 
	`fs_·th_»£t
(
p
);

343  
p
;

344 
	}
}

346 
fs_·th
 *
	$fs_·th_®loc_»v”£d
()

348 
fs_·th
 *
p
;

350 
p
 = 
	`fs_·th_®loc
();

351 ià(!
p
)

352  
NULL
;

353 
p
->
»v”£d
 = 1;

354 
	`fs_·th_»£t
(
p
);

355  
p
;

356 
	}
}

358 
	$fs_·th_ä“
(
fs_·th
 *
p
)

360 ià(!
p
)

362 ià(
p
->
buf
 !ðp->
šlše_buf
)

363 
	`kä“
(
p
->
buf
);

364 
	`kä“
(
p
);

365 
	}
}

367 
	$fs_·th_Ën
(
fs_·th
 *
p
)

369  
p
->
’d
 -…->
¡¬t
;

370 
	}
}

372 
	$fs_·th_’su»_buf
(
fs_·th
 *
p
, 
Ën
)

374 *
tmp_buf
;

375 
·th_Ën
;

376 
Þd_buf_Ën
;

378 
Ën
++;

380 ià(
p
->
buf_Ën
 >ð
Ën
)

383 ià(
Ën
 > 
PATH_MAX
) {

384 
	`WARN_ON
(1);

385  -
ENOMEM
;

388 
·th_Ën
 = 
p
->
’d
 -…->
¡¬t
;

389 
Þd_buf_Ën
 = 
p
->
buf_Ën
;

394 ià(
p
->
buf
 =ðp->
šlše_buf
) {

395 
tmp_buf
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

396 ià(
tmp_buf
)

397 
	`memýy
(
tmp_buf
, 
p
->
buf
, 
Þd_buf_Ën
);

399 
tmp_buf
 = 
	`k»®loc
(
p
->
buf
, 
Ën
, 
GFP_KERNEL
);

401 ià(!
tmp_buf
)

402  -
ENOMEM
;

403 
p
->
buf
 = 
tmp_buf
;

408 
p
->
buf_Ën
 = 
	`ksize
Õ->
buf
);

410 ià(
p
->
»v”£d
) {

411 
tmp_buf
 = 
p
->
buf
 + 
Þd_buf_Ën
 - 
·th_Ën
 - 1;

412 
p
->
’d
 =…->
buf
 +…->
buf_Ën
 - 1;

413 
p
->
¡¬t
 =…->
’d
 - 
·th_Ën
;

414 
	`memmove
(
p
->
¡¬t
, 
tmp_buf
, 
·th_Ën
 + 1);

416 
p
->
¡¬t
 =…->
buf
;

417 
p
->
’d
 =…->
¡¬t
 + 
·th_Ën
;

420 
	}
}

422 
	$fs_·th_´•¬e_fÜ_add
(
fs_·th
 *
p
, 
Çme_Ën
,

423 **
´•¬ed
)

425 
»t
;

426 
Ãw_Ën
;

428 
Ãw_Ën
 = 
p
->
’d
 -…->
¡¬t
 + 
Çme_Ën
;

429 ià(
p
->
¡¬t
 !ðp->
’d
)

430 
Ãw_Ën
++;

431 
»t
 = 
	`fs_·th_’su»_buf
(
p
, 
Ãw_Ën
);

432 ià(
»t
 < 0)

433 
out
;

435 ià(
p
->
»v”£d
) {

436 ià(
p
->
¡¬t
 !ðp->
’d
)

437 *--
p
->
¡¬t
 = '/';

438 
p
->
¡¬t
 -ð
Çme_Ën
;

439 *
´•¬ed
 = 
p
->
¡¬t
;

441 ià(
p
->
¡¬t
 !ðp->
’d
)

442 *
p
->
’d
++ = '/';

443 *
´•¬ed
 = 
p
->
’d
;

444 
p
->
’d
 +ð
Çme_Ën
;

445 *
p
->
’d
 = 0;

448 
out
:

449  
»t
;

450 
	}
}

452 
	$fs_·th_add
(
fs_·th
 *
p
, cÚ¡ *
Çme
, 
Çme_Ën
)

454 
»t
;

455 *
´•¬ed
;

457 
»t
 = 
	`fs_·th_´•¬e_fÜ_add
(
p
, 
Çme_Ën
, &
´•¬ed
);

458 ià(
»t
 < 0)

459 
out
;

460 
	`memýy
(
´•¬ed
, 
Çme
, 
Çme_Ën
);

462 
out
:

463  
»t
;

464 
	}
}

466 
	$fs_·th_add_·th
(
fs_·th
 *
p
, fs_·th *
p2
)

468 
»t
;

469 *
´•¬ed
;

471 
»t
 = 
	`fs_·th_´•¬e_fÜ_add
(
p
, 
p2
->
’d
 -…2->
¡¬t
, &
´•¬ed
);

472 ià(
»t
 < 0)

473 
out
;

474 
	`memýy
(
´•¬ed
, 
p2
->
¡¬t
,…2->
’d
 -…2->start);

476 
out
:

477  
»t
;

478 
	}
}

480 
	$fs_·th_add_äom_ex‹Á_bufãr
(
fs_·th
 *
p
,

481 
ex‹Á_bufãr
 *
eb
,

482 
off
, 
Ën
)

484 
»t
;

485 *
´•¬ed
;

487 
»t
 = 
	`fs_·th_´•¬e_fÜ_add
(
p
, 
Ën
, &
´•¬ed
);

488 ià(
»t
 < 0)

489 
out
;

491 
	`»ad_ex‹Á_bufãr
(
eb
, 
´•¬ed
, 
off
, 
Ën
);

493 
out
:

494  
»t
;

495 
	}
}

497 
	$fs_·th_cÝy
(
fs_·th
 *
p
, fs_·th *
äom
)

499 
»t
;

501 
p
->
»v”£d
 = 
äom
->reversed;

502 
	`fs_·th_»£t
(
p
);

504 
»t
 = 
	`fs_·th_add_·th
(
p
, 
äom
);

506  
»t
;

507 
	}
}

510 
	$fs_·th_uÄev”£
(
fs_·th
 *
p
)

512 *
tmp
;

513 
Ën
;

515 ià(!
p
->
»v”£d
)

518 
tmp
 = 
p
->
¡¬t
;

519 
Ën
 = 
p
->
’d
 -…->
¡¬t
;

520 
p
->
¡¬t
 =…->
buf
;

521 
p
->
’d
 =…->
¡¬t
 + 
Ën
;

522 
	`memmove
(
p
->
¡¬t
, 
tmp
, 
Ën
 + 1);

523 
p
->
»v”£d
 = 0;

524 
	}
}

526 
bŒfs_·th
 *
	$®loc_·th_fÜ_£nd
()

528 
bŒfs_·th
 *
·th
;

530 
·th
 = 
	`bŒfs_®loc_·th
();

531 ià(!
·th
)

532  
NULL
;

533 
·th
->
£¬ch_comm™_roÙ
 = 1;

534 
·th
->
sk_lockšg
 = 1;

535 
·th
->
Ãed_comm™_£m
 = 1;

536  
·th
;

537 
	}
}

539 
	$wr™e_buf
(
fže
 *
fžp
, cÚ¡ *
buf
, 
u32
 
Ën
, 
loff_t
 *
off
)

541 
»t
;

542 
u32
 
pos
 = 0;

544 
pos
 < 
Ën
) {

545 
»t
 = 
	`k”Ãl_wr™e
(
fžp
, 
buf
 + 
pos
, 
Ën
 -…os, 
off
);

550 ià(
»t
 < 0)

551  
»t
;

552 ià(
»t
 == 0) {

553  -
EIO
;

555 
pos
 +ð
»t
;

559 
	}
}

561 
	$Žv_put
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
, cÚ¡ *
d©a
, 
Ën
)

563 
bŒfs_Žv_h—d”
 *
hdr
;

564 
tÙ®_Ën
 = (*
hdr
è+ 
Ën
;

565 
Ëá
 = 
sùx
->
£nd_max_size
 - sùx->
£nd_size
;

567 ià(
	`uÆik–y
(
Ëá
 < 
tÙ®_Ën
))

568  -
EOVERFLOW
;

570 
hdr
 = (
bŒfs_Žv_h—d”
 *è(
sùx
->
£nd_buf
 + sùx->
£nd_size
);

571 
hdr
->
Žv_ty³
 = 
	`ýu_to_Ë16
(
©Œ
);

572 
hdr
->
Žv_Ën
 = 
	`ýu_to_Ë16
(
Ën
);

573 
	`memýy
(
hdr
 + 1, 
d©a
, 
Ën
);

574 
sùx
->
£nd_size
 +ð
tÙ®_Ën
;

577 
	}
}

579 
	#TLV_PUT_DEFINE_INT
(
b™s
) \

580 
Žv_put_u
##
	`b™s
(
£nd_ùx
 *
sùx
, \

581 
u
##
b™s
 
©Œ
, u##b™ 
v®ue
) \

583 
__Ë
##
b™s
 
__tmp
 = 
ýu_to_Ë
##
	`b™s
(
v®ue
); \

584  
	`Žv_put
(
sùx
, 
©Œ
, &
__tmp
, (__tmp)); \

585 }

	)

587 
	$TLV_PUT_DEFINE_INT
(64)

589 
	$Žv_put_¡ršg
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
,

590 cÚ¡ *
¡r
, 
Ën
)

592 ià(
Ën
 == -1)

593 
Ën
 = 
	`¡¾’
(
¡r
);

594  
	`Žv_put
(
sùx
, 
©Œ
, 
¡r
, 
Ën
);

595 
	}
}

597 
	$Žv_put_uuid
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
,

598 cÚ¡ 
u8
 *
uuid
)

600  
	`Žv_put
(
sùx
, 
©Œ
, 
uuid
, 
BTRFS_UUID_SIZE
);

601 
	}
}

603 
	$Žv_put_bŒfs_time¥ec
(
£nd_ùx
 *
sùx
, 
u16
 
©Œ
,

604 
ex‹Á_bufãr
 *
eb
,

605 
bŒfs_time¥ec
 *
ts
)

607 
bŒfs_time¥ec
 
bts
;

608 
	`»ad_ex‹Á_bufãr
(
eb
, &
bts
, ()
ts
, (bts));

609  
	`Žv_put
(
sùx
, 
©Œ
, &
bts
, (bts));

610 
	}
}

613 
	#TLV_PUT
(
sùx
, 
©Œty³
, 
©ŒËn
, 
d©a
) \

615 
»t
 = 
	`Žv_put
(
sùx
, 
©Œty³
, 
©ŒËn
, 
d©a
); \

616 ià(
»t
 < 0) \

617 
Žv_put_çžu»
; \

618 } 0)

	)

620 
	#TLV_PUT_INT
(
sùx
, 
©Œty³
, 
b™s
, 
v®ue
) \

622 
»t
 = 
Žv_put_u
##
	`b™s
(
sùx
, 
©Œty³
, 
v®ue
); \

623 ià(
»t
 < 0) \

624 
Žv_put_çžu»
; \

625 } 0)

	)

627 
	#TLV_PUT_U8
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 8, d©a)

	)

628 
	#TLV_PUT_U16
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 16, d©a)

	)

629 
	#TLV_PUT_U32
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 32, d©a)

	)

630 
	#TLV_PUT_U64
(
sùx
, 
©Œty³
, 
d©a
è
	`TLV_PUT_INT
(sùx,‡‰¹y³, 64, d©a)

	)

631 
	#TLV_PUT_STRING
(
sùx
, 
©Œty³
, 
¡r
, 
Ën
) \

633 
»t
 = 
	`Žv_put_¡ršg
(
sùx
, 
©Œty³
, 
¡r
, 
Ën
); \

634 ià(
»t
 < 0) \

635 
Žv_put_çžu»
; \

636 } 0)

	)

637 
	#TLV_PUT_PATH
(
sùx
, 
©Œty³
, 
p
) \

639 
»t
 = 
	`Žv_put_¡ršg
(
sùx
, 
©Œty³
, 
p
->
¡¬t
, \

640 
p
->
’d
 -…->
¡¬t
); \

641 ià(
»t
 < 0) \

642 
Žv_put_çžu»
; \

643 } 0)

	)

644 
	#TLV_PUT_UUID
(
sùx
, 
©Œty³
, 
uuid
) \

646 
»t
 = 
	`Žv_put_uuid
(
sùx
, 
©Œty³
, 
uuid
); \

647 ià(
»t
 < 0) \

648 
Žv_put_çžu»
; \

649 } 0)

	)

650 
	#TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
©Œty³
, 
eb
, 
ts
) \

652 
»t
 = 
	`Žv_put_bŒfs_time¥ec
(
sùx
, 
©Œty³
, 
eb
, 
ts
); \

653 ià(
»t
 < 0) \

654 
Žv_put_çžu»
; \

655 } 0)

	)

657 
	$£nd_h—d”
(
£nd_ùx
 *
sùx
)

659 
bŒfs_¡»am_h—d”
 
hdr
;

661 
	`¡rýy
(
hdr
.
magic
, 
BTRFS_SEND_STREAM_MAGIC
);

662 
hdr
.
v”siÚ
 = 
	`ýu_to_Ë32
(
BTRFS_SEND_STREAM_VERSION
);

664  
	`wr™e_buf
(
sùx
->
£nd_fžp
, &
hdr
, (hdr),

665 &
sùx
->
£nd_off
);

666 
	}
}

671 
	$begš_cmd
(
£nd_ùx
 *
sùx
, 
cmd
)

673 
bŒfs_cmd_h—d”
 *
hdr
;

675 ià(
	`WARN_ON
(!
sùx
->
£nd_buf
))

676  -
EINVAL
;

678 
	`BUG_ON
(
sùx
->
£nd_size
);

680 
sùx
->
£nd_size
 +ð(*
hdr
);

681 
hdr
 = (
bŒfs_cmd_h—d”
 *)
sùx
->
£nd_buf
;

682 
hdr
->
cmd
 = 
	`ýu_to_Ë16
(cmd);

685 
	}
}

687 
	$£nd_cmd
(
£nd_ùx
 *
sùx
)

689 
»t
;

690 
bŒfs_cmd_h—d”
 *
hdr
;

691 
u32
 
üc
;

693 
hdr
 = (
bŒfs_cmd_h—d”
 *)
sùx
->
£nd_buf
;

694 
hdr
->
Ën
 = 
	`ýu_to_Ë32
(
sùx
->
£nd_size
 - (*hdr));

695 
hdr
->
üc
 = 0;

697 
üc
 = 
	`bŒfs_üc32c
(0, (*)
sùx
->
£nd_buf
, sùx->
£nd_size
);

698 
hdr
->
üc
 = 
	`ýu_to_Ë32
(crc);

700 
»t
 = 
	`wr™e_buf
(
sùx
->
£nd_fžp
, sùx->
£nd_buf
, sùx->
£nd_size
,

701 &
sùx
->
£nd_off
);

703 
sùx
->
tÙ®_£nd_size
 +ðsùx->
£nd_size
;

704 
sùx
->
cmd_£nd_size
[
	`Ë16_to_ýu
(
hdr
->
cmd
)] +ðsùx->
£nd_size
;

705 
sùx
->
£nd_size
 = 0;

707  
»t
;

708 
	}
}

713 
	$£nd_»Çme
(
£nd_ùx
 *
sùx
,

714 
fs_·th
 *
äom
, fs_·th *
to
)

716 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

717 
»t
;

719 
	`bŒfs_debug
(
fs_šfo
, "£nd_»Çm% -> %s", 
äom
->
¡¬t
, 
to
->start);

721 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_RENAME
);

722 ià(
»t
 < 0)

723 
out
;

725 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
äom
);

726 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH_TO
, 
to
);

728 
»t
 = 
	`£nd_cmd
(
sùx
);

730 
Žv_put_çžu»
:

731 
out
:

732  
»t
;

733 
	}
}

738 
	$£nd_lšk
(
£nd_ùx
 *
sùx
,

739 
fs_·th
 *
·th
, fs_·th *
Êk
)

741 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

742 
»t
;

744 
	`bŒfs_debug
(
fs_šfo
, "£nd_lšk % -> %s", 
·th
->
¡¬t
, 
Êk
->start);

746 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_LINK
);

747 ià(
»t
 < 0)

748 
out
;

750 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

751 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH_LINK
, 
Êk
);

753 
»t
 = 
	`£nd_cmd
(
sùx
);

755 
Žv_put_çžu»
:

756 
out
:

757  
»t
;

758 
	}
}

763 
	$£nd_uÆšk
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
·th
)

765 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

766 
»t
;

768 
	`bŒfs_debug
(
fs_šfo
, "£nd_uÆšk %s", 
·th
->
¡¬t
);

770 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_UNLINK
);

771 ià(
»t
 < 0)

772 
out
;

774 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

776 
»t
 = 
	`£nd_cmd
(
sùx
);

778 
Žv_put_çžu»
:

779 
out
:

780  
»t
;

781 
	}
}

786 
	$£nd_rmdœ
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
·th
)

788 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

789 
»t
;

791 
	`bŒfs_debug
(
fs_šfo
, "£nd_rmdœ %s", 
·th
->
¡¬t
);

793 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_RMDIR
);

794 ià(
»t
 < 0)

795 
out
;

797 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

799 
»t
 = 
	`£nd_cmd
(
sùx
);

801 
Žv_put_çžu»
:

802 
out
:

803  
»t
;

804 
	}
}

809 
	$__g‘_šode_šfo
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

810 
u64
 
šo
, u64 *
size
, u64 *
g’
, u64 *
mode
, u64 *
uid
,

811 
u64
 *
gid
, u64 *
rdev
)

813 
»t
;

814 
bŒfs_šode_™em
 *
ii
;

815 
bŒfs_key
 
key
;

817 
key
.
objeùid
 = 
šo
;

818 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

819 
key
.
off£t
 = 0;

820 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

821 ià(
»t
) {

822 ià(
»t
 > 0)

823 
»t
 = -
ENOENT
;

824  
»t
;

827 
ii
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

828 
bŒfs_šode_™em
);

829 ià(
size
)

830 *
size
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0], 
ii
);

831 ià(
g’
)

832 *
g’
 = 
	`bŒfs_šode_g’”©iÚ
(
·th
->
nodes
[0], 
ii
);

833 ià(
mode
)

834 *
mode
 = 
	`bŒfs_šode_mode
(
·th
->
nodes
[0], 
ii
);

835 ià(
uid
)

836 *
uid
 = 
	`bŒfs_šode_uid
(
·th
->
nodes
[0], 
ii
);

837 ià(
gid
)

838 *
gid
 = 
	`bŒfs_šode_gid
(
·th
->
nodes
[0], 
ii
);

839 ià(
rdev
)

840 *
rdev
 = 
	`bŒfs_šode_rdev
(
·th
->
nodes
[0], 
ii
);

842  
»t
;

843 
	}
}

845 
	$g‘_šode_šfo
(
bŒfs_roÙ
 *
roÙ
,

846 
u64
 
šo
, u64 *
size
, u64 *
g’
,

847 
u64
 *
mode
, u64 *
uid
, u64 *
gid
,

848 
u64
 *
rdev
)

850 
bŒfs_·th
 *
·th
;

851 
»t
;

853 
·th
 = 
	`®loc_·th_fÜ_£nd
();

854 ià(!
·th
)

855  -
ENOMEM
;

856 
»t
 = 
	`__g‘_šode_šfo
(
roÙ
, 
·th
, 
šo
, 
size
, 
g’
, 
mode
, 
uid
, 
gid
,

857 
rdev
);

858 
	`bŒfs_ä“_·th
(
·th
);

859  
»t
;

860 
	}
}

862 (*
	t™”©e_šode_»f_t
)(
	tnum
, 
	tu64
 
	tdœ
, 
	tšdex
,

863 
	tfs_·th
 *
	tp
,

864 *
	tùx
);

874 
	$™”©e_šode_»f
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

875 
bŒfs_key
 *
found_key
, 
»sÞve
,

876 
™”©e_šode_»f_t
 
™”©e
, *
ùx
)

878 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[0];

879 
bŒfs_™em
 *
™em
;

880 
bŒfs_šode_»f
 *
œef
;

881 
bŒfs_šode_exŒef
 *
exŒef
;

882 
bŒfs_·th
 *
tmp_·th
;

883 
fs_·th
 *
p
;

884 
u32
 
cur
 = 0;

885 
u32
 
tÙ®
;

886 
¦Ù
 = 
·th
->
¦Ùs
[0];

887 
u32
 
Çme_Ën
;

888 *
¡¬t
;

889 
»t
 = 0;

890 
num
 = 0;

891 
šdex
;

892 
u64
 
dœ
;

893 
Çme_off
;

894 
–em_size
;

895 
±r
;

897 
p
 = 
	`fs_·th_®loc_»v”£d
();

898 ià(!
p
)

899  -
ENOMEM
;

901 
tmp_·th
 = 
	`®loc_·th_fÜ_£nd
();

902 ià(!
tmp_·th
) {

903 
	`fs_·th_ä“
(
p
);

904  -
ENOMEM
;

908 ià(
found_key
->
ty³
 =ð
BTRFS_INODE_REF_KEY
) {

909 
±r
 = ()
	`bŒfs_™em_±r
(
eb
, 
¦Ù
,

910 
bŒfs_šode_»f
);

911 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

912 
tÙ®
 = 
	`bŒfs_™em_size
(
eb
, 
™em
);

913 
–em_size
 = (*
œef
);

915 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

916 
tÙ®
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

917 
–em_size
 = (*
exŒef
);

920 
cur
 < 
tÙ®
) {

921 
	`fs_·th_»£t
(
p
);

923 ià(
found_key
->
ty³
 =ð
BTRFS_INODE_REF_KEY
) {

924 
œef
 = (
bŒfs_šode_»f
 *)(
±r
 + 
cur
);

925 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

926 
Çme_off
 = ()(
œef
 + 1);

927 
šdex
 = 
	`bŒfs_šode_»f_šdex
(
eb
, 
œef
);

928 
dœ
 = 
found_key
->
off£t
;

930 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 + 
cur
);

931 
Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

932 
Çme_off
 = ()&
exŒef
->
Çme
;

933 
šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
eb
, 
exŒef
);

934 
dœ
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

937 ià(
»sÞve
) {

938 
¡¬t
 = 
	`bŒfs_»f_to_·th
(
roÙ
, 
tmp_·th
, 
Çme_Ën
,

939 
Çme_off
, 
eb
, 
dœ
,

940 
p
->
buf
,…->
buf_Ën
);

941 ià(
	`IS_ERR
(
¡¬t
)) {

942 
»t
 = 
	`PTR_ERR
(
¡¬t
);

943 
out
;

945 ià(
¡¬t
 < 
p
->
buf
) {

947 
»t
 = 
	`fs_·th_’su»_buf
(
p
,

948 
p
->
buf_Ën
 +…->
buf
 - 
¡¬t
);

949 ià(
»t
 < 0)

950 
out
;

951 
¡¬t
 = 
	`bŒfs_»f_to_·th
(
roÙ
, 
tmp_·th
,

952 
Çme_Ën
, 
Çme_off
,

953 
eb
, 
dœ
,

954 
p
->
buf
,…->
buf_Ën
);

955 ià(
	`IS_ERR
(
¡¬t
)) {

956 
»t
 = 
	`PTR_ERR
(
¡¬t
);

957 
out
;

959 
	`BUG_ON
(
¡¬t
 < 
p
->
buf
);

961 
p
->
¡¬t
 = start;

963 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
p
, 
eb
, 
Çme_off
,

964 
Çme_Ën
);

965 ià(
»t
 < 0)

966 
out
;

969 
cur
 +ð
–em_size
 + 
Çme_Ën
;

970 
»t
 = 
	`™”©e
(
num
, 
dœ
, 
šdex
, 
p
, 
ùx
);

971 ià(
»t
)

972 
out
;

973 
num
++;

976 
out
:

977 
	`bŒfs_ä“_·th
(
tmp_·th
);

978 
	`fs_·th_ä“
(
p
);

979  
»t
;

980 
	}
}

982 (*
	t™”©e_dœ_™em_t
)(
	tnum
, 
	tbŒfs_key
 *
	tdi_key
,

983 cÚ¡ *
	tÇme
, 
	tÇme_Ën
,

984 cÚ¡ *
	td©a
, 
	td©a_Ën
,

985 
	tu8
 
	tty³
, *
	tùx
);

994 
	$™”©e_dœ_™em
(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,

995 
bŒfs_key
 *
found_key
,

996 
™”©e_dœ_™em_t
 
™”©e
, *
ùx
)

998 
»t
 = 0;

999 
ex‹Á_bufãr
 *
eb
;

1000 
bŒfs_™em
 *
™em
;

1001 
bŒfs_dœ_™em
 *
di
;

1002 
bŒfs_key
 
di_key
;

1003 *
buf
 = 
NULL
;

1004 
buf_Ën
;

1005 
u32
 
Çme_Ën
;

1006 
u32
 
d©a_Ën
;

1007 
u32
 
cur
;

1008 
u32
 
Ën
;

1009 
u32
 
tÙ®
;

1010 
¦Ù
;

1011 
num
;

1012 
u8
 
ty³
;

1020 
buf_Ën
 = 
PATH_MAX
;

1021 
buf
 = 
	`km®loc
(
buf_Ën
, 
GFP_KERNEL
);

1022 ià(!
buf
) {

1023 
»t
 = -
ENOMEM
;

1024 
out
;

1027 
eb
 = 
·th
->
nodes
[0];

1028 
¦Ù
 = 
·th
->
¦Ùs
[0];

1029 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

1030 
di
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dœ_™em
);

1031 
cur
 = 0;

1032 
Ën
 = 0;

1033 
tÙ®
 = 
	`bŒfs_™em_size
(
eb
, 
™em
);

1035 
num
 = 0;

1036 
cur
 < 
tÙ®
) {

1037 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
eb
, 
di
);

1038 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
eb
, 
di
);

1039 
ty³
 = 
	`bŒfs_dœ_ty³
(
eb
, 
di
);

1040 
	`bŒfs_dœ_™em_key_to_ýu
(
eb
, 
di
, &
di_key
);

1042 ià(
ty³
 =ð
BTRFS_FT_XATTR
) {

1043 ià(
Çme_Ën
 > 
XATTR_NAME_MAX
) {

1044 
»t
 = -
ENAMETOOLONG
;

1045 
out
;

1047 ià(
Çme_Ën
 + 
d©a_Ën
 >

1048 
	`BTRFS_MAX_XATTR_SIZE
(
roÙ
->
fs_šfo
)) {

1049 
»t
 = -
E2BIG
;

1050 
out
;

1056 ià(
Çme_Ën
 + 
d©a_Ën
 > 
PATH_MAX
) {

1057 
»t
 = -
ENAMETOOLONG
;

1058 
out
;

1062 
»t
 = 
	`bŒfs_is_Çme_Ën_v®id
(
eb
, 
·th
->
¦Ùs
[0],

1063 ()(
di
 + 1), 
Çme_Ën
 + 
d©a_Ën
);

1064 ià(!
»t
) {

1065 
»t
 = -
EIO
;

1066 
out
;

1068 ià(
Çme_Ën
 + 
d©a_Ën
 > 
buf_Ën
) {

1069 
buf_Ën
 = 
Çme_Ën
 + 
d©a_Ën
;

1070 ià(
	`is_vm®loc_addr
(
buf
)) {

1071 
	`vä“
(
buf
);

1072 
buf
 = 
NULL
;

1074 *
tmp
 = 
	`k»®loc
(
buf
, 
buf_Ën
,

1075 
GFP_KERNEL
 | 
__GFP_NOWARN
);

1077 ià(!
tmp
)

1078 
	`kä“
(
buf
);

1079 
buf
 = 
tmp
;

1081 ià(!
buf
) {

1082 
buf
 = 
	`kvm®loc
(
buf_Ën
, 
GFP_KERNEL
);

1083 ià(!
buf
) {

1084 
»t
 = -
ENOMEM
;

1085 
out
;

1090 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, ()(
di
 + 1),

1091 
Çme_Ën
 + 
d©a_Ën
);

1093 
Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

1094 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
Ën
);

1095 
cur
 +ð
Ën
;

1097 
»t
 = 
	`™”©e
(
num
, &
di_key
, 
buf
, 
Çme_Ën
, buf +‚ame_len,

1098 
d©a_Ën
, 
ty³
, 
ùx
);

1099 ià(
»t
 < 0)

1100 
out
;

1101 ià(
»t
) {

1102 
»t
 = 0;

1103 
out
;

1106 
num
++;

1109 
out
:

1110 
	`kvä“
(
buf
);

1111  
»t
;

1112 
	}
}

1114 
	$__cÝy_fœ¡_»f
(
num
, 
u64
 
dœ
, 
šdex
,

1115 
fs_·th
 *
p
, *
ùx
)

1117 
»t
;

1118 
fs_·th
 *
±
 = 
ùx
;

1120 
»t
 = 
	`fs_·th_cÝy
(
±
, 
p
);

1121 ià(
»t
 < 0)

1122  
»t
;

1126 
	}
}

1132 
	$g‘_šode_·th
(
bŒfs_roÙ
 *
roÙ
,

1133 
u64
 
šo
, 
fs_·th
 *
·th
)

1135 
»t
;

1136 
bŒfs_key
 
key
, 
found_key
;

1137 
bŒfs_·th
 *
p
;

1139 
p
 = 
	`®loc_·th_fÜ_£nd
();

1140 ià(!
p
)

1141  -
ENOMEM
;

1143 
	`fs_·th_»£t
(
·th
);

1145 
key
.
objeùid
 = 
šo
;

1146 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1147 
key
.
off£t
 = 0;

1149 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
roÙ
, &
key
, 
p
, 1, 0);

1150 ià(
»t
 < 0)

1151 
out
;

1152 ià(
»t
) {

1153 
»t
 = 1;

1154 
out
;

1156 
	`bŒfs_™em_key_to_ýu
(
p
->
nodes
[0], &
found_key
,…->
¦Ùs
[0]);

1157 ià(
found_key
.
objeùid
 !ð
šo
 ||

1158 (
found_key
.
ty³
 !ð
BTRFS_INODE_REF_KEY
 &&

1159 
found_key
.
ty³
 !ð
BTRFS_INODE_EXTREF_KEY
)) {

1160 
»t
 = -
ENOENT
;

1161 
out
;

1164 
»t
 = 
	`™”©e_šode_»f
(
roÙ
, 
p
, &
found_key
, 1,

1165 
__cÝy_fœ¡_»f
, 
·th
);

1166 ià(
»t
 < 0)

1167 
out
;

1168 
»t
 = 0;

1170 
out
:

1171 
	`bŒfs_ä“_·th
(
p
);

1172  
»t
;

1173 
	}
}

1175 
	sback»f_ùx
 {

1176 
£nd_ùx
 *
	msùx
;

1178 
bŒfs_·th
 *
	m·th
;

1180 
u64
 
	mfound
;

1186 
u64
 
	mcur_objeùid
;

1187 
u64
 
	mcur_off£t
;

1190 
u64
 
	mex‹Á_Ën
;

1193 
u64
 
	md©a_off£t
;

1196 
	mfound_™£lf
;

1199 
	$__þÚe_roÙ_cmp_b£¬ch
(cÚ¡ *
key
, cÚ¡ *
–t
)

1201 
u64
 
roÙ
 = (u64)(
ušŒ_t
)
key
;

1202 
þÚe_roÙ
 *
ü
 = (þÚe_roÙ *)
–t
;

1204 ià(
roÙ
 < 
ü
->roÙ->
objeùid
)

1206 ià(
roÙ
 > 
ü
->roÙ->
objeùid
)

1209 
	}
}

1211 
	$__þÚe_roÙ_cmp_sÜt
(cÚ¡ *
e1
, cÚ¡ *
e2
)

1213 
þÚe_roÙ
 *
ü1
 = (þÚe_roÙ *)
e1
;

1214 
þÚe_roÙ
 *
ü2
 = (þÚe_roÙ *)
e2
;

1216 ià(
ü1
->
roÙ
->
objeùid
 < 
ü2
->root->objectid)

1218 ià(
ü1
->
roÙ
->
objeùid
 > 
ü2
->root->objectid)

1221 
	}
}

1227 
	$__™”©e_back»fs
(
u64
 
šo
, u64 
off£t
, u64 
roÙ
, *
ùx_
)

1229 
back»f_ùx
 *
bùx
 = 
ùx_
;

1230 
þÚe_roÙ
 *
found
;

1231 
»t
;

1232 
u64
 
i_size
;

1235 
found
 = 
	`b£¬ch
((*)(
ušŒ_t
)
roÙ
, 
bùx
->
sùx
->
þÚe_roÙs
,

1236 
bùx
->
sùx
->
þÚe_roÙs_út
,

1237 (
þÚe_roÙ
),

1238 
__þÚe_roÙ_cmp_b£¬ch
);

1239 ià(!
found
)

1242 ià(
found
->
roÙ
 =ð
bùx
->
sùx
->
£nd_roÙ
 &&

1243 
šo
 =ð
bùx
->
cur_objeùid
 &&

1244 
off£t
 =ð
bùx
->
cur_off£t
) {

1245 
bùx
->
found_™£lf
 = 1;

1252 
»t
 = 
	`__g‘_šode_šfo
(
found
->
roÙ
, 
bùx
->
·th
, 
šo
, &
i_size
, 
NULL
, NULL,

1253 
NULL
, NULL, NULL);

1254 
	`bŒfs_»Ëa£_·th
(
bùx
->
·th
);

1255 ià(
»t
 < 0)

1256  
»t
;

1258 ià(
off£t
 + 
bùx
->
d©a_off£t
 + bùx->
ex‹Á_Ën
 > 
i_size
)

1265 ià(
found
->
roÙ
 =ð
bùx
->
sùx
->
£nd_roÙ
) {

1272 ià(
šo
 >ð
bùx
->
cur_objeùid
)

1275 ià(
šo
 > 
bùx
->
cur_objeùid
)

1277 ià(
off£t
 + 
bùx
->
ex‹Á_Ën
 > bùx->
cur_off£t
)

1282 
bùx
->
found
++;

1283 
found
->
found_»fs
++;

1284 ià(
šo
 < 
found
->ino) {

1285 
found
->
šo
 = ino;

1286 
found
->
off£t
 = offset;

1287 } ià(
found
->
šo
 == ino) {

1291 ià(
found
->
off£t
 > off£ˆ+ 
bùx
->
ex‹Á_Ën
)

1292 
found
->
off£t
 = offset;

1296 
	}
}

1307 
	$fšd_ex‹Á_þÚe
(
£nd_ùx
 *
sùx
,

1308 
bŒfs_·th
 *
·th
,

1309 
u64
 
šo
, u64 
d©a_off£t
,

1310 
u64
 
šo_size
,

1311 
þÚe_roÙ
 **
found
)

1313 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

1314 
»t
;

1315 
ex‹Á_ty³
;

1316 
u64
 
logiÿl
;

1317 
u64
 
disk_by‹
;

1318 
u64
 
num_by‹s
;

1319 
u64
 
ex‹Á_™em_pos
;

1320 
u64
 
æags
 = 0;

1321 
bŒfs_fže_ex‹Á_™em
 *
fi
;

1322 
ex‹Á_bufãr
 *
eb
 = 
·th
->
nodes
[0];

1323 
back»f_ùx
 *back»f_ùx = 
NULL
;

1324 
þÚe_roÙ
 *
cur_þÚe_roÙ
;

1325 
bŒfs_key
 
found_key
;

1326 
bŒfs_·th
 *
tmp_·th
;

1327 
com´es£d
;

1328 
u32
 
i
;

1330 
tmp_·th
 = 
	`®loc_·th_fÜ_£nd
();

1331 ià(!
tmp_·th
)

1332  -
ENOMEM
;

1335 
tmp_·th
->
Ãed_comm™_£m
 = 0;

1337 
back»f_ùx
 = 
	`km®loc
((*back»f_ùx), 
GFP_KERNEL
);

1338 ià(!
back»f_ùx
) {

1339 
»t
 = -
ENOMEM
;

1340 
out
;

1343 
back»f_ùx
->
·th
 = 
tmp_·th
;

1345 ià(
d©a_off£t
 >ð
šo_size
) {

1351 
»t
 = 0;

1352 
out
;

1355 
fi
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0],

1356 
bŒfs_fže_ex‹Á_™em
);

1357 
ex‹Á_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
fi
);

1358 ià(
ex‹Á_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

1359 
»t
 = -
ENOENT
;

1360 
out
;

1362 
com´es£d
 = 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
eb
, 
fi
);

1364 
num_by‹s
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
eb
, 
fi
);

1365 
disk_by‹
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
fi
);

1366 ià(
disk_by‹
 == 0) {

1367 
»t
 = -
ENOENT
;

1368 
out
;

1370 
logiÿl
 = 
disk_by‹
 + 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
fi
);

1372 
	`down_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1373 
»t
 = 
	`ex‹Á_äom_logiÿl
(
fs_šfo
, 
disk_by‹
, 
tmp_·th
,

1374 &
found_key
, &
æags
);

1375 
	`up_»ad
(&
fs_šfo
->
comm™_roÙ_£m
);

1376 
	`bŒfs_»Ëa£_·th
(
tmp_·th
);

1378 ià(
»t
 < 0)

1379 
out
;

1380 ià(
æags
 & 
BTRFS_EXTENT_FLAG_TREE_BLOCK
) {

1381 
»t
 = -
EIO
;

1382 
out
;

1388 
i
 = 0; i < 
sùx
->
þÚe_roÙs_út
; i++) {

1389 
cur_þÚe_roÙ
 = 
sùx
->
þÚe_roÙs
 + 
i
;

1390 
cur_þÚe_roÙ
->
šo
 = (
u64
)-1;

1391 
cur_þÚe_roÙ
->
off£t
 = 0;

1392 
cur_þÚe_roÙ
->
found_»fs
 = 0;

1395 
back»f_ùx
->
sùx
 = sctx;

1396 
back»f_ùx
->
found
 = 0;

1397 
back»f_ùx
->
cur_objeùid
 = 
šo
;

1398 
back»f_ùx
->
cur_off£t
 = 
d©a_off£t
;

1399 
back»f_ùx
->
found_™£lf
 = 0;

1400 
back»f_ùx
->
ex‹Á_Ën
 = 
num_by‹s
;

1410 ià(
com´es£d
 =ð
BTRFS_COMPRESS_NONE
)

1411 
back»f_ùx
->
d©a_off£t
 = 0;

1413 
back»f_ùx
->
d©a_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
fi
);

1420 ià(
d©a_off£t
 + 
num_by‹s
 >ð
šo_size
)

1421 
back»f_ùx
->
ex‹Á_Ën
 = 
šo_size
 - 
d©a_off£t
;

1426 ià(
com´es£d
 =ð
BTRFS_COMPRESS_NONE
)

1427 
ex‹Á_™em_pos
 = 
logiÿl
 - 
found_key
.
objeùid
;

1429 
ex‹Á_™em_pos
 = 0;

1430 
»t
 = 
	`™”©e_ex‹Á_šodes
(
fs_šfo
, 
found_key
.
objeùid
,

1431 
ex‹Á_™em_pos
, 1, 
__™”©e_back»fs
,

1432 
back»f_ùx
);

1434 ià(
»t
 < 0)

1435 
out
;

1437 ià(!
back»f_ùx
->
found_™£lf
) {

1439 
»t
 = -
EIO
;

1440 
	`bŒfs_”r
(
fs_šfo
,

1442 
šo
, 
d©a_off£t
, 
disk_by‹
, 
found_key
.
objeùid
);

1443 
out
;

1446 
	`bŒfs_debug
(
fs_šfo
,

1448 
d©a_off£t
, 
šo
, 
num_by‹s
, 
logiÿl
);

1450 ià(!
back»f_ùx
->
found
)

1451 
	`bŒfs_debug
(
fs_šfo
, "no clones found");

1453 
cur_þÚe_roÙ
 = 
NULL
;

1454 
i
 = 0; i < 
sùx
->
þÚe_roÙs_út
; i++) {

1455 ià(
sùx
->
þÚe_roÙs
[
i
].
found_»fs
) {

1456 ià(!
cur_þÚe_roÙ
)

1457 
cur_þÚe_roÙ
 = 
sùx
->
þÚe_roÙs
 + 
i
;

1458 ià(
sùx
->
þÚe_roÙs
[
i
].
roÙ
 =ðsùx->
£nd_roÙ
)

1460 
cur_þÚe_roÙ
 = 
sùx
->
þÚe_roÙs
 + 
i
;

1465 ià(
cur_þÚe_roÙ
) {

1466 *
found
 = 
cur_þÚe_roÙ
;

1467 
»t
 = 0;

1469 
»t
 = -
ENOENT
;

1472 
out
:

1473 
	`bŒfs_ä“_·th
(
tmp_·th
);

1474 
	`kä“
(
back»f_ùx
);

1475  
»t
;

1476 
	}
}

1478 
	$»ad_symlšk
(
bŒfs_roÙ
 *
roÙ
,

1479 
u64
 
šo
,

1480 
fs_·th
 *
de¡
)

1482 
»t
;

1483 
bŒfs_·th
 *
·th
;

1484 
bŒfs_key
 
key
;

1485 
bŒfs_fže_ex‹Á_™em
 *
ei
;

1486 
u8
 
ty³
;

1487 
u8
 
com´essiÚ
;

1488 
off
;

1489 
Ën
;

1491 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1492 ià(!
·th
)

1493  -
ENOMEM
;

1495 
key
.
objeùid
 = 
šo
;

1496 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

1497 
key
.
off£t
 = 0;

1498 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1499 ià(
»t
 < 0)

1500 
out
;

1501 ià(
»t
) {

1510 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

1512 
šo
, 
roÙ
->
roÙ_key
.
objeùid
);

1513 
»t
 = -
EIO
;

1514 
out
;

1517 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1518 
bŒfs_fže_ex‹Á_™em
);

1519 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
);

1520 
com´essiÚ
 = 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
·th
->
nodes
[0], 
ei
);

1521 
	`BUG_ON
(
ty³
 !ð
BTRFS_FILE_EXTENT_INLINE
);

1522 
	`BUG_ON
(
com´essiÚ
);

1524 
off
 = 
	`bŒfs_fže_ex‹Á_šlše_¡¬t
(
ei
);

1525 
Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
·th
->
nodes
[0],…©h->
¦Ùs
[0], 
ei
);

1527 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
de¡
, 
·th
->
nodes
[0], 
off
, 
Ën
);

1529 
out
:

1530 
	`bŒfs_ä“_·th
(
·th
);

1531  
»t
;

1532 
	}
}

1538 
	$g’_unique_Çme
(
£nd_ùx
 *
sùx
,

1539 
u64
 
šo
, u64 
g’
,

1540 
fs_·th
 *
de¡
)

1542 
»t
 = 0;

1543 
bŒfs_·th
 *
·th
;

1544 
bŒfs_dœ_™em
 *
di
;

1545 
tmp
[64];

1546 
Ën
;

1547 
u64
 
idx
 = 0;

1549 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1550 ià(!
·th
)

1551  -
ENOMEM
;

1554 
Ën
 = 
	`¢´štf
(
tmp
, (tmp), "o%llu-%llu-%llu",

1555 
šo
, 
g’
, 
idx
);

1556 
	`ASSERT
(
Ën
 < (
tmp
));

1558 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
sùx
->
£nd_roÙ
,

1559 
·th
, 
BTRFS_FIRST_FREE_OBJECTID
,

1560 
tmp
, 
	`¡¾’
(tmp), 0);

1561 
	`bŒfs_»Ëa£_·th
(
·th
);

1562 ià(
	`IS_ERR
(
di
)) {

1563 
»t
 = 
	`PTR_ERR
(
di
);

1564 
out
;

1566 ià(
di
) {

1568 
idx
++;

1572 ià(!
sùx
->
·»Á_roÙ
) {

1574 
»t
 = 0;

1578 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
sùx
->
·»Á_roÙ
,

1579 
·th
, 
BTRFS_FIRST_FREE_OBJECTID
,

1580 
tmp
, 
	`¡¾’
(tmp), 0);

1581 
	`bŒfs_»Ëa£_·th
(
·th
);

1582 ià(
	`IS_ERR
(
di
)) {

1583 
»t
 = 
	`PTR_ERR
(
di
);

1584 
out
;

1586 ià(
di
) {

1588 
idx
++;

1595 
»t
 = 
	`fs_·th_add
(
de¡
, 
tmp
, 
	`¡¾’
(tmp));

1597 
out
:

1598 
	`bŒfs_ä“_·th
(
·th
);

1599  
»t
;

1600 
	}
}

1602 
	ešode_¡©e
 {

1603 
	mšode_¡©e_no_chªge
,

1604 
	mšode_¡©e_wžl_ü—‹
,

1605 
	mšode_¡©e_did_ü—‹
,

1606 
	mšode_¡©e_wžl_d–‘e
,

1607 
	mšode_¡©e_did_d–‘e
,

1610 
	$g‘_cur_šode_¡©e
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
)

1612 
»t
;

1613 
Ëá_»t
;

1614 
right_»t
;

1615 
u64
 
Ëá_g’
;

1616 
u64
 
right_g’
;

1618 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
šo
, 
NULL
, &
Ëá_g’
, NULL, NULL,

1619 
NULL
, NULL);

1620 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1621 
out
;

1622 
Ëá_»t
 = 
»t
;

1624 ià(!
sùx
->
·»Á_roÙ
) {

1625 
right_»t
 = -
ENOENT
;

1627 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
šo
, 
NULL
, &
right_g’
,

1628 
NULL
, NULL, NULL, NULL);

1629 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1630 
out
;

1631 
right_»t
 = 
»t
;

1634 ià(!
Ëá_»t
 && !
right_»t
) {

1635 ià(
Ëá_g’
 =ð
g’
 && 
right_g’
 == gen) {

1636 
»t
 = 
šode_¡©e_no_chªge
;

1637 } ià(
Ëá_g’
 =ð
g’
) {

1638 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1639 
»t
 = 
šode_¡©e_did_ü—‹
;

1641 
»t
 = 
šode_¡©e_wžl_ü—‹
;

1642 } ià(
right_g’
 =ð
g’
) {

1643 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1644 
»t
 = 
šode_¡©e_did_d–‘e
;

1646 
»t
 = 
šode_¡©e_wžl_d–‘e
;

1648 
»t
 = -
ENOENT
;

1650 } ià(!
Ëá_»t
) {

1651 ià(
Ëá_g’
 =ð
g’
) {

1652 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1653 
»t
 = 
šode_¡©e_did_ü—‹
;

1655 
»t
 = 
šode_¡©e_wžl_ü—‹
;

1657 
»t
 = -
ENOENT
;

1659 } ià(!
right_»t
) {

1660 ià(
right_g’
 =ð
g’
) {

1661 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

1662 
»t
 = 
šode_¡©e_did_d–‘e
;

1664 
»t
 = 
šode_¡©e_wžl_d–‘e
;

1666 
»t
 = -
ENOENT
;

1669 
»t
 = -
ENOENT
;

1672 
out
:

1673  
»t
;

1674 
	}
}

1676 
	$is_šode_exi¡’t
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
)

1678 
»t
;

1680 ià(
šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

1683 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
šo
, 
g’
);

1684 ià(
»t
 < 0)

1685 
out
;

1687 ià(
»t
 =ð
šode_¡©e_no_chªge
 ||

1688 
»t
 =ð
šode_¡©e_did_ü—‹
 ||

1689 
»t
 =ð
šode_¡©e_wžl_d–‘e
)

1690 
»t
 = 1;

1692 
»t
 = 0;

1694 
out
:

1695  
»t
;

1696 
	}
}

1701 
	$lookup_dœ_™em_šode
(
bŒfs_roÙ
 *
roÙ
,

1702 
u64
 
dœ
, cÚ¡ *
Çme
, 
Çme_Ën
,

1703 
u64
 *
found_šode
,

1704 
u8
 *
found_ty³
)

1706 
»t
 = 0;

1707 
bŒfs_dœ_™em
 *
di
;

1708 
bŒfs_key
 
key
;

1709 
bŒfs_·th
 *
·th
;

1711 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1712 ià(!
·th
)

1713  -
ENOMEM
;

1715 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
,

1716 
dœ
, 
Çme
, 
Çme_Ën
, 0);

1717 ià(!
di
) {

1718 
»t
 = -
ENOENT
;

1719 
out
;

1721 ià(
	`IS_ERR
(
di
)) {

1722 
»t
 = 
	`PTR_ERR
(
di
);

1723 
out
;

1725 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
key
);

1726 ià(
key
.
ty³
 =ð
BTRFS_ROOT_ITEM_KEY
) {

1727 
»t
 = -
ENOENT
;

1728 
out
;

1730 *
found_šode
 = 
key
.
objeùid
;

1731 *
found_ty³
 = 
	`bŒfs_dœ_ty³
(
·th
->
nodes
[0], 
di
);

1733 
out
:

1734 
	`bŒfs_ä“_·th
(
·th
);

1735  
»t
;

1736 
	}
}

1742 
	$g‘_fœ¡_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
šo
,

1743 
u64
 *
dœ
, u64 *
dœ_g’
, 
fs_·th
 *
Çme
)

1745 
»t
;

1746 
bŒfs_key
 
key
;

1747 
bŒfs_key
 
found_key
;

1748 
bŒfs_·th
 *
·th
;

1749 
Ën
;

1750 
u64
 
·»Á_dœ
;

1752 
·th
 = 
	`®loc_·th_fÜ_£nd
();

1753 ià(!
·th
)

1754  -
ENOMEM
;

1756 
key
.
objeùid
 = 
šo
;

1757 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1758 
key
.
off£t
 = 0;

1760 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
roÙ
, &
key
, 
·th
, 1, 0);

1761 ià(
»t
 < 0)

1762 
out
;

1763 ià(!
»t
)

1764 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

1765 
·th
->
¦Ùs
[0]);

1766 ià(
»t
 || 
found_key
.
objeùid
 !ð
šo
 ||

1767 (
found_key
.
ty³
 !ð
BTRFS_INODE_REF_KEY
 &&

1768 
found_key
.
ty³
 !ð
BTRFS_INODE_EXTREF_KEY
)) {

1769 
»t
 = -
ENOENT
;

1770 
out
;

1773 ià(
found_key
.
ty³
 =ð
BTRFS_INODE_REF_KEY
) {

1774 
bŒfs_šode_»f
 *
œef
;

1775 
œef
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1776 
bŒfs_šode_»f
);

1777 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
œef
);

1778 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
Çme
, 
·th
->
nodes
[0],

1779 ()(
œef
 + 1),

1780 
Ën
);

1781 
·»Á_dœ
 = 
found_key
.
off£t
;

1783 
bŒfs_šode_exŒef
 *
exŒef
;

1784 
exŒef
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1785 
bŒfs_šode_exŒef
);

1786 
Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
·th
->
nodes
[0], 
exŒef
);

1787 
»t
 = 
	`fs_·th_add_äom_ex‹Á_bufãr
(
Çme
, 
·th
->
nodes
[0],

1788 ()&
exŒef
->
Çme
, 
Ën
);

1789 
·»Á_dœ
 = 
	`bŒfs_šode_exŒef_·»Á
(
·th
->
nodes
[0], 
exŒef
);

1791 ià(
»t
 < 0)

1792 
out
;

1793 
	`bŒfs_»Ëa£_·th
(
·th
);

1795 ià(
dœ_g’
) {

1796 
»t
 = 
	`g‘_šode_šfo
(
roÙ
, 
·»Á_dœ
, 
NULL
, 
dœ_g’
, NULL,

1797 
NULL
, NULL, NULL);

1798 ià(
»t
 < 0)

1799 
out
;

1802 *
dœ
 = 
·»Á_dœ
;

1804 
out
:

1805 
	`bŒfs_ä“_·th
(
·th
);

1806  
»t
;

1807 
	}
}

1809 
	$is_fœ¡_»f
(
bŒfs_roÙ
 *
roÙ
,

1810 
u64
 
šo
, u64 
dœ
,

1811 cÚ¡ *
Çme
, 
Çme_Ën
)

1813 
»t
;

1814 
fs_·th
 *
tmp_Çme
;

1815 
u64
 
tmp_dœ
;

1817 
tmp_Çme
 = 
	`fs_·th_®loc
();

1818 ià(!
tmp_Çme
)

1819  -
ENOMEM
;

1821 
»t
 = 
	`g‘_fœ¡_»f
(
roÙ
, 
šo
, &
tmp_dœ
, 
NULL
, 
tmp_Çme
);

1822 ià(
»t
 < 0)

1823 
out
;

1825 ià(
dœ
 !ð
tmp_dœ
 || 
Çme_Ën
 !ð
	`fs_·th_Ën
(
tmp_Çme
)) {

1826 
»t
 = 0;

1827 
out
;

1830 
»t
 = !
	`memcmp
(
tmp_Çme
->
¡¬t
, 
Çme
, 
Çme_Ën
);

1832 
out
:

1833 
	`fs_·th_ä“
(
tmp_Çme
);

1834  
»t
;

1835 
	}
}

1847 
	$wžl_ov”wr™e_»f
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
, u64 
dœ_g’
,

1848 cÚ¡ *
Çme
, 
Çme_Ën
,

1849 
u64
 *
who_šo
, u64 *
who_g’
, u64 *
who_mode
)

1851 
»t
 = 0;

1852 
u64
 
g’
;

1853 
u64
 
Ùh”_šode
 = 0;

1854 
u8
 
Ùh”_ty³
 = 0;

1856 ià(!
sùx
->
·»Á_roÙ
)

1857 
out
;

1859 
»t
 = 
	`is_šode_exi¡’t
(
sùx
, 
dœ
, 
dœ_g’
);

1860 ià(
»t
 <= 0)

1861 
out
;

1868 ià(
sùx
->
·»Á_roÙ
 && 
dœ
 !ð
BTRFS_FIRST_FREE_OBJECTID
) {

1869 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
dœ
, 
NULL
, &
g’
, NULL,

1870 
NULL
, NULL, NULL);

1871 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1872 
out
;

1873 ià(
»t
) {

1874 
»t
 = 0;

1875 
out
;

1877 ià(
g’
 !ð
dœ_g’
)

1878 
out
;

1881 
»t
 = 
	`lookup_dœ_™em_šode
(
sùx
->
·»Á_roÙ
, 
dœ
, 
Çme
, 
Çme_Ën
,

1882 &
Ùh”_šode
, &
Ùh”_ty³
);

1883 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1884 
out
;

1885 ià(
»t
) {

1886 
»t
 = 0;

1887 
out
;

1895 ià(
Ùh”_šode
 > 
sùx
->
£nd_´og»ss
 ||

1896 
	`is_wa™šg_fÜ_move
(
sùx
, 
Ùh”_šode
)) {

1897 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
Ùh”_šode
, 
NULL
,

1898 
who_g’
, 
who_mode
, 
NULL
, NULL, NULL);

1899 ià(
»t
 < 0)

1900 
out
;

1902 
»t
 = 1;

1903 *
who_šo
 = 
Ùh”_šode
;

1905 
»t
 = 0;

1908 
out
:

1909  
»t
;

1910 
	}
}

1919 
	$did_ov”wr™e_»f
(
£nd_ùx
 *
sùx
,

1920 
u64
 
dœ
, u64 
dœ_g’
,

1921 
u64
 
šo
, u64 
šo_g’
,

1922 cÚ¡ *
Çme
, 
Çme_Ën
)

1924 
»t
 = 0;

1925 
u64
 
g’
;

1926 
u64
 
ow_šode
;

1927 
u8
 
Ùh”_ty³
;

1929 ià(!
sùx
->
·»Á_roÙ
)

1930 
out
;

1932 
»t
 = 
	`is_šode_exi¡’t
(
sùx
, 
dœ
, 
dœ_g’
);

1933 ià(
»t
 <= 0)

1934 
out
;

1936 ià(
dœ
 !ð
BTRFS_FIRST_FREE_OBJECTID
) {

1937 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
dœ
, 
NULL
, &
g’
, NULL,

1938 
NULL
, NULL, NULL);

1939 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1940 
out
;

1941 ià(
»t
) {

1942 
»t
 = 0;

1943 
out
;

1945 ià(
g’
 !ð
dœ_g’
)

1946 
out
;

1950 
»t
 = 
	`lookup_dœ_™em_šode
(
sùx
->
£nd_roÙ
, 
dœ
, 
Çme
, 
Çme_Ën
,

1951 &
ow_šode
, &
Ùh”_ty³
);

1952 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1953 
out
;

1954 ià(
»t
) {

1956 
»t
 = 0;

1957 
out
;

1960 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
ow_šode
, 
NULL
, &
g’
, NULL, NULL,

1961 
NULL
, NULL);

1962 ià(
»t
 < 0)

1963 
out
;

1965 ià(
ow_šode
 =ð
šo
 && 
g’
 =ð
šo_g’
) {

1966 
»t
 = 0;

1967 
out
;

1976 ià((
ow_šode
 < 
sùx
->
£nd_´og»ss
) ||

1977 (
šo
 !ð
sùx
->
cur_šo
 && 
ow_šode
 == sctx->cur_ino &&

1978 
g’
 =ð
sùx
->
cur_šode_g’
))

1979 
»t
 = 1;

1981 
»t
 = 0;

1983 
out
:

1984  
»t
;

1985 
	}
}

1992 
	$did_ov”wr™e_fœ¡_»f
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
)

1994 
»t
 = 0;

1995 
fs_·th
 *
Çme
 = 
NULL
;

1996 
u64
 
dœ
;

1997 
u64
 
dœ_g’
;

1999 ià(!
sùx
->
·»Á_roÙ
)

2000 
out
;

2002 
Çme
 = 
	`fs_·th_®loc
();

2003 ià(!
Çme
)

2004  -
ENOMEM
;

2006 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
, &
dœ
, &
dœ_g’
, 
Çme
);

2007 ià(
»t
 < 0)

2008 
out
;

2010 
»t
 = 
	`did_ov”wr™e_»f
(
sùx
, 
dœ
, 
dœ_g’
, 
šo
, 
g’
,

2011 
Çme
->
¡¬t
, 
	`fs_·th_Ën
(name));

2013 
out
:

2014 
	`fs_·th_ä“
(
Çme
);

2015  
»t
;

2016 
	}
}

2024 
	$Çme_ÿche_š£¹
(
£nd_ùx
 *
sùx
,

2025 
Çme_ÿche_’Œy
 *
nû
)

2027 
»t
 = 0;

2028 
li¡_h—d
 *
nû_h—d
;

2030 
nû_h—d
 = 
	`¿dix_Œ“_lookup
(&
sùx
->
Çme_ÿche
,

2031 ()
nû
->
šo
);

2032 ià(!
nû_h—d
) {

2033 
nû_h—d
 = 
	`km®loc
((*nû_h—d), 
GFP_KERNEL
);

2034 ià(!
nû_h—d
) {

2035 
	`kä“
(
nû
);

2036  -
ENOMEM
;

2038 
	`INIT_LIST_HEAD
(
nû_h—d
);

2040 
»t
 = 
	`¿dix_Œ“_š£¹
(&
sùx
->
Çme_ÿche
, 
nû
->
šo
, 
nû_h—d
);

2041 ià(
»t
 < 0) {

2042 
	`kä“
(
nû_h—d
);

2043 
	`kä“
(
nû
);

2044  
»t
;

2047 
	`li¡_add_ž
(&
nû
->
¿dix_li¡
, 
nû_h—d
);

2048 
	`li¡_add_ž
(&
nû
->
li¡
, &
sùx
->
Çme_ÿche_li¡
);

2049 
sùx
->
Çme_ÿche_size
++;

2051  
»t
;

2052 
	}
}

2054 
	$Çme_ÿche_d–‘e
(
£nd_ùx
 *
sùx
,

2055 
Çme_ÿche_’Œy
 *
nû
)

2057 
li¡_h—d
 *
nû_h—d
;

2059 
nû_h—d
 = 
	`¿dix_Œ“_lookup
(&
sùx
->
Çme_ÿche
,

2060 ()
nû
->
šo
);

2061 ià(!
nû_h—d
) {

2062 
	`bŒfs_”r
(
sùx
->
£nd_roÙ
->
fs_šfo
,

2064 
nû
->
šo
, 
sùx
->
Çme_ÿche_size
);

2067 
	`li¡_d–
(&
nû
->
¿dix_li¡
);

2068 
	`li¡_d–
(&
nû
->
li¡
);

2069 
sùx
->
Çme_ÿche_size
--;

2074 ià(
nû_h—d
 && 
	`li¡_em±y
(nce_head)) {

2075 
	`¿dix_Œ“_d–‘e
(&
sùx
->
Çme_ÿche
, ()
nû
->
šo
);

2076 
	`kä“
(
nû_h—d
);

2078 
	}
}

2080 
Çme_ÿche_’Œy
 *
	$Çme_ÿche_£¬ch
(
£nd_ùx
 *
sùx
,

2081 
u64
 
šo
, u64 
g’
)

2083 
li¡_h—d
 *
nû_h—d
;

2084 
Çme_ÿche_’Œy
 *
cur
;

2086 
nû_h—d
 = 
	`¿dix_Œ“_lookup
(&
sùx
->
Çme_ÿche
, ()
šo
);

2087 ià(!
nû_h—d
)

2088  
NULL
;

2090 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
nû_h—d
, 
¿dix_li¡
) {

2091 ià(
cur
->
šo
 =ðšØ&& cur->
g’
 == gen)

2092  
cur
;

2094  
NULL
;

2095 
	}
}

2101 
	$Çme_ÿche_u£d
(
£nd_ùx
 *
sùx
, 
Çme_ÿche_’Œy
 *
nû
)

2103 
	`li¡_d–
(&
nû
->
li¡
);

2104 
	`li¡_add_ž
(&
nû
->
li¡
, &
sùx
->
Çme_ÿche_li¡
);

2105 
	}
}

2110 
	$Çme_ÿche_þ—n_unu£d
(
£nd_ùx
 *
sùx
)

2112 
Çme_ÿche_’Œy
 *
nû
;

2114 ià(
sùx
->
Çme_ÿche_size
 < 
SEND_CTX_NAME_CACHE_CLEAN_SIZE
)

2117 
sùx
->
Çme_ÿche_size
 > 
SEND_CTX_MAX_NAME_CACHE_SIZE
) {

2118 
nû
 = 
	`li¡_’Œy
(
sùx
->
Çme_ÿche_li¡
.
Ãxt
,

2119 
Çme_ÿche_’Œy
, 
li¡
);

2120 
	`Çme_ÿche_d–‘e
(
sùx
, 
nû
);

2121 
	`kä“
(
nû
);

2123 
	}
}

2125 
	$Çme_ÿche_ä“
(
£nd_ùx
 *
sùx
)

2127 
Çme_ÿche_’Œy
 *
nû
;

2129 !
	`li¡_em±y
(&
sùx
->
Çme_ÿche_li¡
)) {

2130 
nû
 = 
	`li¡_’Œy
(
sùx
->
Çme_ÿche_li¡
.
Ãxt
,

2131 
Çme_ÿche_’Œy
, 
li¡
);

2132 
	`Çme_ÿche_d–‘e
(
sùx
, 
nû
);

2133 
	`kä“
(
nû
);

2135 
	}
}

2145 
	$__g‘_cur_Çme_ªd_·»Á
(
£nd_ùx
 *
sùx
,

2146 
u64
 
šo
, u64 
g’
,

2147 
u64
 *
·»Á_šo
,

2148 
u64
 *
·»Á_g’
,

2149 
fs_·th
 *
de¡
)

2151 
»t
;

2152 
nû_»t
;

2153 
Çme_ÿche_’Œy
 *
nû
 = 
NULL
;

2160 
nû
 = 
	`Çme_ÿche_£¬ch
(
sùx
, 
šo
, 
g’
);

2161 ià(
nû
) {

2162 ià(
šo
 < 
sùx
->
£nd_´og»ss
 && 
nû
->
Ãed_Ï‹r_upd©e
) {

2163 
	`Çme_ÿche_d–‘e
(
sùx
, 
nû
);

2164 
	`kä“
(
nû
);

2165 
nû
 = 
NULL
;

2167 
	`Çme_ÿche_u£d
(
sùx
, 
nû
);

2168 *
·»Á_šo
 = 
nû
->parent_ino;

2169 *
·»Á_g’
 = 
nû
->parent_gen;

2170 
»t
 = 
	`fs_·th_add
(
de¡
, 
nû
->
Çme
,‚û->
Çme_Ën
);

2171 ià(
»t
 < 0)

2172 
out
;

2173 
»t
 = 
nû
->ret;

2174 
out
;

2183 
»t
 = 
	`is_šode_exi¡’t
(
sùx
, 
šo
, 
g’
);

2184 ià(
»t
 < 0)

2185 
out
;

2187 ià(!
»t
) {

2188 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
de¡
);

2189 ià(
»t
 < 0)

2190 
out
;

2191 
»t
 = 1;

2192 
out_ÿche
;

2199 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

2200 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
£nd_roÙ
, 
šo
,

2201 
·»Á_šo
, 
·»Á_g’
, 
de¡
);

2203 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
,

2204 
·»Á_šo
, 
·»Á_g’
, 
de¡
);

2205 ià(
»t
 < 0)

2206 
out
;

2212 
»t
 = 
	`did_ov”wr™e_»f
(
sùx
, *
·»Á_šo
, *
·»Á_g’
, 
šo
, 
g’
,

2213 
de¡
->
¡¬t
, de¡->
’d
 - dest->start);

2214 ià(
»t
 < 0)

2215 
out
;

2216 ià(
»t
) {

2217 
	`fs_·th_»£t
(
de¡
);

2218 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
de¡
);

2219 ià(
»t
 < 0)

2220 
out
;

2221 
»t
 = 1;

2224 
out_ÿche
:

2228 
nû
 = 
	`km®loc
((*nûè+ 
	`fs_·th_Ën
(
de¡
è+ 1, 
GFP_KERNEL
);

2229 ià(!
nû
) {

2230 
»t
 = -
ENOMEM
;

2231 
out
;

2234 
nû
->
šo
 = ino;

2235 
nû
->
g’
 = gen;

2236 
nû
->
·»Á_šo
 = *parent_ino;

2237 
nû
->
·»Á_g’
 = *parent_gen;

2238 
nû
->
Çme_Ën
 = 
	`fs_·th_Ën
(
de¡
);

2239 
nû
->
»t
 =„et;

2240 
	`¡rýy
(
nû
->
Çme
, 
de¡
->
¡¬t
);

2242 ià(
šo
 < 
sùx
->
£nd_´og»ss
)

2243 
nû
->
Ãed_Ï‹r_upd©e
 = 0;

2245 
nû
->
Ãed_Ï‹r_upd©e
 = 1;

2247 
nû_»t
 = 
	`Çme_ÿche_š£¹
(
sùx
, 
nû
);

2248 ià(
nû_»t
 < 0)

2249 
»t
 = 
nû_»t
;

2250 
	`Çme_ÿche_þ—n_unu£d
(
sùx
);

2252 
out
:

2253  
»t
;

2254 
	}
}

2281 
	$g‘_cur_·th
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
,

2282 
fs_·th
 *
de¡
)

2284 
»t
 = 0;

2285 
fs_·th
 *
Çme
 = 
NULL
;

2286 
u64
 
·»Á_šode
 = 0;

2287 
u64
 
·»Á_g’
 = 0;

2288 
¡Ý
 = 0;

2290 
Çme
 = 
	`fs_·th_®loc
();

2291 ià(!
Çme
) {

2292 
»t
 = -
ENOMEM
;

2293 
out
;

2296 
de¡
->
»v”£d
 = 1;

2297 
	`fs_·th_»£t
(
de¡
);

2299 !
¡Ý
 && 
šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
) {

2300 
wa™šg_dœ_move
 *
wdm
;

2302 
	`fs_·th_»£t
(
Çme
);

2304 ià(
	`is_wa™šg_fÜ_rm
(
sùx
, 
šo
)) {

2305 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
Çme
);

2306 ià(
»t
 < 0)

2307 
out
;

2308 
»t
 = 
	`fs_·th_add_·th
(
de¡
, 
Çme
);

2312 
wdm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
šo
);

2313 ià(
wdm
 && wdm->
Üphªized
) {

2314 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
Çme
);

2315 
¡Ý
 = 1;

2316 } ià(
wdm
) {

2317 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
,

2318 &
·»Á_šode
, &
·»Á_g’
, 
Çme
);

2320 
»t
 = 
	`__g‘_cur_Çme_ªd_·»Á
(
sùx
, 
šo
, 
g’
,

2321 &
·»Á_šode
,

2322 &
·»Á_g’
, 
Çme
);

2323 ià(
»t
)

2324 
¡Ý
 = 1;

2327 ià(
»t
 < 0)

2328 
out
;

2330 
»t
 = 
	`fs_·th_add_·th
(
de¡
, 
Çme
);

2331 ià(
»t
 < 0)

2332 
out
;

2334 
šo
 = 
·»Á_šode
;

2335 
g’
 = 
·»Á_g’
;

2338 
out
:

2339 
	`fs_·th_ä“
(
Çme
);

2340 ià(!
»t
)

2341 
	`fs_·th_uÄev”£
(
de¡
);

2342  
»t
;

2343 
	}
}

2348 
	$£nd_subvÞ_begš
(
£nd_ùx
 *
sùx
)

2350 
»t
;

2351 
bŒfs_roÙ
 *
£nd_roÙ
 = 
sùx
->send_root;

2352 
bŒfs_roÙ
 *
·»Á_roÙ
 = 
sùx
->parent_root;

2353 
bŒfs_·th
 *
·th
;

2354 
bŒfs_key
 
key
;

2355 
bŒfs_roÙ_»f
 *
»f
;

2356 
ex‹Á_bufãr
 *
Ëaf
;

2357 *
Çme
 = 
NULL
;

2358 
Çm–’
;

2360 
·th
 = 
	`bŒfs_®loc_·th
();

2361 ià(!
·th
)

2362  -
ENOMEM
;

2364 
Çme
 = 
	`km®loc
(
BTRFS_PATH_NAME_MAX
, 
GFP_KERNEL
);

2365 ià(!
Çme
) {

2366 
	`bŒfs_ä“_·th
(
·th
);

2367  -
ENOMEM
;

2370 
key
.
objeùid
 = 
£nd_roÙ
->objectid;

2371 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

2372 
key
.
off£t
 = 0;

2374 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
£nd_roÙ
->
fs_šfo
->
Œ“_roÙ
,

2375 &
key
, 
·th
, 1, 0);

2376 ià(
»t
 < 0)

2377 
out
;

2378 ià(
»t
) {

2379 
»t
 = -
ENOENT
;

2380 
out
;

2383 
Ëaf
 = 
·th
->
nodes
[0];

2384 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2385 ià(
key
.
ty³
 !ð
BTRFS_ROOT_BACKREF_KEY
 ||

2386 
key
.
objeùid
 !ð
£nd_roÙ
->objectid) {

2387 
»t
 = -
ENOENT
;

2388 
out
;

2390 
»f
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_roÙ_»f
);

2391 
Çm–’
 = 
	`bŒfs_roÙ_»f_Çme_Ën
(
Ëaf
, 
»f
);

2392 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme
, ()(
»f
 + 1), 
Çm–’
);

2393 
	`bŒfs_»Ëa£_·th
(
·th
);

2395 ià(
·»Á_roÙ
) {

2396 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_SNAPSHOT
);

2397 ià(
»t
 < 0)

2398 
out
;

2400 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_SUBVOL
);

2401 ià(
»t
 < 0)

2402 
out
;

2405 
	`TLV_PUT_STRING
(
sùx
, 
BTRFS_SEND_A_PATH
, 
Çme
, 
Çm–’
);

2407 ià(!
	`bŒfs_is_em±y_uuid
(
sùx
->
£nd_roÙ
->
roÙ_™em
.
»ûived_uuid
))

2408 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_UUID
,

2409 
sùx
->
£nd_roÙ
->
roÙ_™em
.
»ûived_uuid
);

2411 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_UUID
,

2412 
sùx
->
£nd_roÙ
->
roÙ_™em
.
uuid
);

2414 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CTRANSID
,

2415 
	`Ë64_to_ýu
(
sùx
->
£nd_roÙ
->
roÙ_™em
.
ù¿nsid
));

2416 ià(
·»Á_roÙ
) {

2417 ià(!
	`bŒfs_is_em±y_uuid
(
·»Á_roÙ
->
roÙ_™em
.
»ûived_uuid
))

2418 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

2419 
·»Á_roÙ
->
roÙ_™em
.
»ûived_uuid
);

2421 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

2422 
·»Á_roÙ
->
roÙ_™em
.
uuid
);

2423 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_CTRANSID
,

2424 
	`Ë64_to_ýu
(
sùx
->
·»Á_roÙ
->
roÙ_™em
.
ù¿nsid
));

2427 
»t
 = 
	`£nd_cmd
(
sùx
);

2429 
Žv_put_çžu»
:

2430 
out
:

2431 
	`bŒfs_ä“_·th
(
·th
);

2432 
	`kä“
(
Çme
);

2433  
»t
;

2434 
	}
}

2436 
	$£nd_Œunÿ‹
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
size
)

2438 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2439 
»t
 = 0;

2440 
fs_·th
 *
p
;

2442 
	`bŒfs_debug
(
fs_šfo
, "£nd_Œunÿ‹ %Îu size=%Îu", 
šo
, 
size
);

2444 
p
 = 
	`fs_·th_®loc
();

2445 ià(!
p
)

2446  -
ENOMEM
;

2448 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_TRUNCATE
);

2449 ià(
»t
 < 0)

2450 
out
;

2452 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2453 ià(
»t
 < 0)

2454 
out
;

2455 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2456 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_SIZE
, 
size
);

2458 
»t
 = 
	`£nd_cmd
(
sùx
);

2460 
Žv_put_çžu»
:

2461 
out
:

2462 
	`fs_·th_ä“
(
p
);

2463  
»t
;

2464 
	}
}

2466 
	$£nd_chmod
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
mode
)

2468 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2469 
»t
 = 0;

2470 
fs_·th
 *
p
;

2472 
	`bŒfs_debug
(
fs_šfo
, "£nd_chmod %Îu mode=%Îu", 
šo
, 
mode
);

2474 
p
 = 
	`fs_·th_®loc
();

2475 ià(!
p
)

2476  -
ENOMEM
;

2478 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_CHMOD
);

2479 ià(
»t
 < 0)

2480 
out
;

2482 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2483 ià(
»t
 < 0)

2484 
out
;

2485 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2486 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_MODE
, 
mode
 & 07777);

2488 
»t
 = 
	`£nd_cmd
(
sùx
);

2490 
Žv_put_çžu»
:

2491 
out
:

2492 
	`fs_·th_ä“
(
p
);

2493  
»t
;

2494 
	}
}

2496 
	$£nd_chown
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
, u64 
uid
, u64 
gid
)

2498 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2499 
»t
 = 0;

2500 
fs_·th
 *
p
;

2502 
	`bŒfs_debug
(
fs_šfo
, "send_chown %llu uid=%llu, gid=%llu",

2503 
šo
, 
uid
, 
gid
);

2505 
p
 = 
	`fs_·th_®loc
();

2506 ià(!
p
)

2507  -
ENOMEM
;

2509 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_CHOWN
);

2510 ià(
»t
 < 0)

2511 
out
;

2513 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2514 ià(
»t
 < 0)

2515 
out
;

2516 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2517 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_UID
, 
uid
);

2518 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_GID
, 
gid
);

2520 
»t
 = 
	`£nd_cmd
(
sùx
);

2522 
Žv_put_çžu»
:

2523 
out
:

2524 
	`fs_·th_ä“
(
p
);

2525  
»t
;

2526 
	}
}

2528 
	$£nd_utimes
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
)

2530 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2531 
»t
 = 0;

2532 
fs_·th
 *
p
 = 
NULL
;

2533 
bŒfs_šode_™em
 *
ii
;

2534 
bŒfs_·th
 *
·th
 = 
NULL
;

2535 
ex‹Á_bufãr
 *
eb
;

2536 
bŒfs_key
 
key
;

2537 
¦Ù
;

2539 
	`bŒfs_debug
(
fs_šfo
, "£nd_utime %Îu", 
šo
);

2541 
p
 = 
	`fs_·th_®loc
();

2542 ià(!
p
)

2543  -
ENOMEM
;

2545 
·th
 = 
	`®loc_·th_fÜ_£nd
();

2546 ià(!
·th
) {

2547 
»t
 = -
ENOMEM
;

2548 
out
;

2551 
key
.
objeùid
 = 
šo
;

2552 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

2553 
key
.
off£t
 = 0;

2554 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
sùx
->
£nd_roÙ
, &
key
, 
·th
, 0, 0);

2555 ià(
»t
 > 0)

2556 
»t
 = -
ENOENT
;

2557 ià(
»t
 < 0)

2558 
out
;

2560 
eb
 = 
·th
->
nodes
[0];

2561 
¦Ù
 = 
·th
->
¦Ùs
[0];

2562 
ii
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_™em
);

2564 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_UTIMES
);

2565 ià(
»t
 < 0)

2566 
out
;

2568 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
šo
, 
g’
, 
p
);

2569 ià(
»t
 < 0)

2570 
out
;

2571 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2572 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_ATIME
, 
eb
, &
ii
->
©ime
);

2573 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_MTIME
, 
eb
, &
ii
->
mtime
);

2574 
	`TLV_PUT_BTRFS_TIMESPEC
(
sùx
, 
BTRFS_SEND_A_CTIME
, 
eb
, &
ii
->
ùime
);

2577 
»t
 = 
	`£nd_cmd
(
sùx
);

2579 
Žv_put_çžu»
:

2580 
out
:

2581 
	`fs_·th_ä“
(
p
);

2582 
	`bŒfs_ä“_·th
(
·th
);

2583  
»t
;

2584 
	}
}

2591 
	$£nd_ü—‹_šode
(
£nd_ùx
 *
sùx
, 
u64
 
šo
)

2593 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

2594 
»t
 = 0;

2595 
fs_·th
 *
p
;

2596 
cmd
;

2597 
u64
 
g’
;

2598 
u64
 
mode
;

2599 
u64
 
rdev
;

2601 
	`bŒfs_debug
(
fs_šfo
, "£nd_ü—‹_šod%Îu", 
šo
);

2603 
p
 = 
	`fs_·th_®loc
();

2604 ià(!
p
)

2605  -
ENOMEM
;

2607 ià(
šo
 !ð
sùx
->
cur_šo
) {

2608 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
šo
, 
NULL
, &
g’
, &
mode
,

2609 
NULL
, NULL, &
rdev
);

2610 ià(
»t
 < 0)

2611 
out
;

2613 
g’
 = 
sùx
->
cur_šode_g’
;

2614 
mode
 = 
sùx
->
cur_šode_mode
;

2615 
rdev
 = 
sùx
->
cur_šode_rdev
;

2618 ià(
	`S_ISREG
(
mode
)) {

2619 
cmd
 = 
BTRFS_SEND_C_MKFILE
;

2620 } ià(
	`S_ISDIR
(
mode
)) {

2621 
cmd
 = 
BTRFS_SEND_C_MKDIR
;

2622 } ià(
	`S_ISLNK
(
mode
)) {

2623 
cmd
 = 
BTRFS_SEND_C_SYMLINK
;

2624 } ià(
	`S_ISCHR
(
mode
è|| 
	`S_ISBLK
(mode)) {

2625 
cmd
 = 
BTRFS_SEND_C_MKNOD
;

2626 } ià(
	`S_ISFIFO
(
mode
)) {

2627 
cmd
 = 
BTRFS_SEND_C_MKFIFO
;

2628 } ià(
	`S_ISSOCK
(
mode
)) {

2629 
cmd
 = 
BTRFS_SEND_C_MKSOCK
;

2631 
	`bŒfs_w¬n
(
sùx
->
£nd_roÙ
->
fs_šfo
, "unexpected inodeype %o",

2632 ()(
mode
 & 
S_IFMT
));

2633 
»t
 = -
EOPNOTSUPP
;

2634 
out
;

2637 
»t
 = 
	`begš_cmd
(
sùx
, 
cmd
);

2638 ià(
»t
 < 0)

2639 
out
;

2641 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
p
);

2642 ià(
»t
 < 0)

2643 
out
;

2645 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

2646 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_INO
, 
šo
);

2648 ià(
	`S_ISLNK
(
mode
)) {

2649 
	`fs_·th_»£t
(
p
);

2650 
»t
 = 
	`»ad_symlšk
(
sùx
->
£nd_roÙ
, 
šo
, 
p
);

2651 ià(
»t
 < 0)

2652 
out
;

2653 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH_LINK
, 
p
);

2654 } ià(
	`S_ISCHR
(
mode
è|| 
	`S_ISBLK
(mode) ||

2655 
	`S_ISFIFO
(
mode
è|| 
	`S_ISSOCK
(mode)) {

2656 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_RDEV
, 
	`Ãw_’code_dev
(
rdev
));

2657 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_MODE
, 
mode
);

2660 
»t
 = 
	`£nd_cmd
(
sùx
);

2661 ià(
»t
 < 0)

2662 
out
;

2665 
Žv_put_çžu»
:

2666 
out
:

2667 
	`fs_·th_ä“
(
p
);

2668  
»t
;

2669 
	}
}

2676 
	$did_ü—‹_dœ
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
)

2678 
»t
 = 0;

2679 
bŒfs_·th
 *
·th
 = 
NULL
;

2680 
bŒfs_key
 
key
;

2681 
bŒfs_key
 
found_key
;

2682 
bŒfs_key
 
di_key
;

2683 
ex‹Á_bufãr
 *
eb
;

2684 
bŒfs_dœ_™em
 *
di
;

2685 
¦Ù
;

2687 
·th
 = 
	`®loc_·th_fÜ_£nd
();

2688 ià(!
·th
) {

2689 
»t
 = -
ENOMEM
;

2690 
out
;

2693 
key
.
objeùid
 = 
dœ
;

2694 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

2695 
key
.
off£t
 = 0;

2696 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
sùx
->
£nd_roÙ
, &
key
, 
·th
, 0, 0);

2697 ià(
»t
 < 0)

2698 
out
;

2701 
eb
 = 
·th
->
nodes
[0];

2702 
¦Ù
 = 
·th
->
¦Ùs
[0];

2703 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

2704 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
sùx
->
£nd_roÙ
, 
·th
);

2705 ià(
»t
 < 0) {

2706 
out
;

2707 } ià(
»t
 > 0) {

2708 
»t
 = 0;

2714 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

2715 ià(
found_key
.
objeùid
 !ð
key
.objectid ||

2716 
found_key
.
ty³
 !ð
key
.type) {

2717 
»t
 = 0;

2718 
out
;

2721 
di
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_dœ_™em
);

2722 
	`bŒfs_dœ_™em_key_to_ýu
(
eb
, 
di
, &
di_key
);

2724 ià(
di_key
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
 &&

2725 
di_key
.
objeùid
 < 
sùx
->
£nd_´og»ss
) {

2726 
»t
 = 1;

2727 
out
;

2730 
·th
->
¦Ùs
[0]++;

2733 
out
:

2734 
	`bŒfs_ä“_·th
(
·th
);

2735  
»t
;

2736 
	}
}

2744 
	$£nd_ü—‹_šode_if_Ãeded
(
£nd_ùx
 *
sùx
)

2746 
»t
;

2748 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
)) {

2749 
»t
 = 
	`did_ü—‹_dœ
(
sùx
, sùx->
cur_šo
);

2750 ià(
»t
 < 0)

2751 
out
;

2752 ià(
»t
) {

2753 
»t
 = 0;

2754 
out
;

2758 
»t
 = 
	`£nd_ü—‹_šode
(
sùx
, sùx->
cur_šo
);

2759 ià(
»t
 < 0)

2760 
out
;

2762 
out
:

2763  
»t
;

2764 
	}
}

2766 
	s»cÜded_»f
 {

2767 
li¡_h—d
 
	mli¡
;

2768 *
	mÇme
;

2769 
fs_·th
 *
	mfuÎ_·th
;

2770 
u64
 
	mdœ
;

2771 
u64
 
	mdœ_g’
;

2772 
	mÇme_Ën
;

2775 
	$£t_»f_·th
(
»cÜded_»f
 *
»f
, 
fs_·th
 *
·th
)

2777 
»f
->
fuÎ_·th
 = 
·th
;

2778 
»f
->
Çme
 = (*)
	`kba£Çme
Ôef->
fuÎ_·th
->
¡¬t
);

2779 
»f
->
Çme_Ën
 =„ef->
fuÎ_·th
->
’d
 -„ef->
Çme
;

2780 
	}
}

2787 
	$__»cÜd_»f
(
li¡_h—d
 *
h—d
, 
u64
 
dœ
,

2788 
u64
 
dœ_g’
, 
fs_·th
 *
·th
)

2790 
»cÜded_»f
 *
»f
;

2792 
»f
 = 
	`km®loc
((*»f), 
GFP_KERNEL
);

2793 ià(!
»f
)

2794  -
ENOMEM
;

2796 
»f
->
dœ
 = dir;

2797 
»f
->
dœ_g’
 = dir_gen;

2798 
	`£t_»f_·th
(
»f
, 
·th
);

2799 
	`li¡_add_ž
(&
»f
->
li¡
, 
h—d
);

2801 
	}
}

2803 
	$dup_»f
(
»cÜded_»f
 *
»f
, 
li¡_h—d
 *
li¡
)

2805 
»cÜded_»f
 *
Ãw
;

2807 
Ãw
 = 
	`km®loc
((*
»f
), 
GFP_KERNEL
);

2808 ià(!
Ãw
)

2809  -
ENOMEM
;

2811 
Ãw
->
dœ
 = 
»f
->dir;

2812 
Ãw
->
dœ_g’
 = 
»f
->dir_gen;

2813 
Ãw
->
fuÎ_·th
 = 
NULL
;

2814 
	`INIT_LIST_HEAD
(&
Ãw
->
li¡
);

2815 
	`li¡_add_ž
(&
Ãw
->
li¡
,†ist);

2817 
	}
}

2819 
	$__ä“_»cÜded_»fs
(
li¡_h—d
 *
h—d
)

2821 
»cÜded_»f
 *
cur
;

2823 !
	`li¡_em±y
(
h—d
)) {

2824 
cur
 = 
	`li¡_’Œy
(
h—d
->
Ãxt
, 
»cÜded_»f
, 
li¡
);

2825 
	`fs_·th_ä“
(
cur
->
fuÎ_·th
);

2826 
	`li¡_d–
(&
cur
->
li¡
);

2827 
	`kä“
(
cur
);

2829 
	}
}

2831 
	$ä“_»cÜded_»fs
(
£nd_ùx
 *
sùx
)

2833 
	`__ä“_»cÜded_»fs
(&
sùx
->
Ãw_»fs
);

2834 
	`__ä“_»cÜded_»fs
(&
sùx
->
d–‘ed_»fs
);

2835 
	}
}

2842 
	$Üphªize_šode
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, u64 
g’
,

2843 
fs_·th
 *
·th
)

2845 
»t
;

2846 
fs_·th
 *
Üphª
;

2848 
Üphª
 = 
	`fs_·th_®loc
();

2849 ià(!
Üphª
)

2850  -
ENOMEM
;

2852 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
šo
, 
g’
, 
Üphª
);

2853 ià(
»t
 < 0)

2854 
out
;

2856 
»t
 = 
	`£nd_»Çme
(
sùx
, 
·th
, 
Üphª
);

2858 
out
:

2859 
	`fs_·th_ä“
(
Üphª
);

2860  
»t
;

2861 
	}
}

2863 
Üphª_dœ_šfo
 *

2864 
	$add_Üphª_dœ_šfo
(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
)

2866 
rb_node
 **
p
 = &
sùx
->
Üphª_dœs
.rb_node;

2867 
rb_node
 *
·»Á
 = 
NULL
;

2868 
Üphª_dœ_šfo
 *
’Œy
, *
odi
;

2870 
odi
 = 
	`km®loc
((*odi), 
GFP_KERNEL
);

2871 ià(!
odi
)

2872  
	`ERR_PTR
(-
ENOMEM
);

2873 
odi
->
šo
 = 
dœ_šo
;

2874 
odi
->
g’
 = 0;

2876 *
p
) {

2877 
·»Á
 = *
p
;

2878 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
Üphª_dœ_šfo
, 
node
);

2879 ià(
dœ_šo
 < 
’Œy
->
šo
) {

2880 
p
 = &(*p)->
rb_Ëá
;

2881 } ià(
dœ_šo
 > 
’Œy
->
šo
) {

2882 
p
 = &(*p)->
rb_right
;

2884 
	`kä“
(
odi
);

2885  
’Œy
;

2889 
	`rb_lšk_node
(&
odi
->
node
, 
·»Á
, 
p
);

2890 
	`rb_š£¹_cÞÜ
(&
odi
->
node
, &
sùx
->
Üphª_dœs
);

2891  
odi
;

2892 
	}
}

2894 
Üphª_dœ_šfo
 *

2895 
	$g‘_Üphª_dœ_šfo
(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
)

2897 
rb_node
 *
n
 = 
sùx
->
Üphª_dœs
.rb_node;

2898 
Üphª_dœ_šfo
 *
’Œy
;

2900 
n
) {

2901 
’Œy
 = 
	`rb_’Œy
(
n
, 
Üphª_dœ_šfo
, 
node
);

2902 ià(
dœ_šo
 < 
’Œy
->
šo
)

2903 
n
 =‚->
rb_Ëá
;

2904 ià(
dœ_šo
 > 
’Œy
->
šo
)

2905 
n
 =‚->
rb_right
;

2907  
’Œy
;

2909  
NULL
;

2910 
	}
}

2912 
	$is_wa™šg_fÜ_rm
(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
)

2914 
Üphª_dœ_šfo
 *
odi
 = 
	`g‘_Üphª_dœ_šfo
(
sùx
, 
dœ_šo
);

2916  
odi
 !ð
NULL
;

2917 
	}
}

2919 
	$ä“_Üphª_dœ_šfo
(
£nd_ùx
 *
sùx
,

2920 
Üphª_dœ_šfo
 *
odi
)

2922 ià(!
odi
)

2924 
	`rb_”a£
(&
odi
->
node
, &
sùx
->
Üphª_dœs
);

2925 
	`kä“
(
odi
);

2926 
	}
}

2933 
	$ÿn_rmdœ
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
, u64 
dœ_g’
,

2934 
u64
 
£nd_´og»ss
)

2936 
»t
 = 0;

2937 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
·»Á_roÙ
;

2938 
bŒfs_·th
 *
·th
;

2939 
bŒfs_key
 
key
;

2940 
bŒfs_key
 
found_key
;

2941 
bŒfs_key
 
loc
;

2942 
bŒfs_dœ_™em
 *
di
;

2947 ià(
dœ
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

2950 
·th
 = 
	`®loc_·th_fÜ_£nd
();

2951 ià(!
·th
)

2952  -
ENOMEM
;

2954 
key
.
objeùid
 = 
dœ
;

2955 
key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

2956 
key
.
off£t
 = 0;

2957 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

2958 ià(
»t
 < 0)

2959 
out
;

2962 
wa™šg_dœ_move
 *
dm
;

2964 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

2965 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2966 ià(
»t
 < 0)

2967 
out
;

2968 ià(
»t
 > 0)

2972 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

2973 
·th
->
¦Ùs
[0]);

2974 ià(
found_key
.
objeùid
 !ð
key
.objectid ||

2975 
found_key
.
ty³
 !ð
key
.type)

2978 
di
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

2979 
bŒfs_dœ_™em
);

2980 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
loc
);

2982 
dm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
loc
.
objeùid
);

2983 ià(
dm
) {

2984 
Üphª_dœ_šfo
 *
odi
;

2986 
odi
 = 
	`add_Üphª_dœ_šfo
(
sùx
, 
dœ
);

2987 ià(
	`IS_ERR
(
odi
)) {

2988 
»t
 = 
	`PTR_ERR
(
odi
);

2989 
out
;

2991 
odi
->
g’
 = 
dœ_g’
;

2992 
dm
->
rmdœ_šo
 = 
dœ
;

2993 
»t
 = 0;

2994 
out
;

2997 ià(
loc
.
objeùid
 > 
£nd_´og»ss
) {

2998 
Üphª_dœ_šfo
 *
odi
;

3000 
odi
 = 
	`g‘_Üphª_dœ_šfo
(
sùx
, 
dœ
);

3001 
	`ä“_Üphª_dœ_šfo
(
sùx
, 
odi
);

3002 
»t
 = 0;

3003 
out
;

3006 
·th
->
¦Ùs
[0]++;

3009 
»t
 = 1;

3011 
out
:

3012 
	`bŒfs_ä“_·th
(
·th
);

3013  
»t
;

3014 
	}
}

3016 
	$is_wa™šg_fÜ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
)

3018 
wa™šg_dœ_move
 *
’Œy
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
šo
);

3020  
’Œy
 !ð
NULL
;

3021 
	}
}

3023 
	$add_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
, 
boÞ
 
Üphªized
)

3025 
rb_node
 **
p
 = &
sùx
->
wa™šg_dœ_moves
.rb_node;

3026 
rb_node
 *
·»Á
 = 
NULL
;

3027 
wa™šg_dœ_move
 *
’Œy
, *
dm
;

3029 
dm
 = 
	`km®loc
((*dm), 
GFP_KERNEL
);

3030 ià(!
dm
)

3031  -
ENOMEM
;

3032 
dm
->
šo
 = ino;

3033 
dm
->
rmdœ_šo
 = 0;

3034 
dm
->
Üphªized
 = orphanized;

3036 *
p
) {

3037 
·»Á
 = *
p
;

3038 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
wa™šg_dœ_move
, 
node
);

3039 ià(
šo
 < 
’Œy
->ino) {

3040 
p
 = &(*p)->
rb_Ëá
;

3041 } ià(
šo
 > 
’Œy
->ino) {

3042 
p
 = &(*p)->
rb_right
;

3044 
	`kä“
(
dm
);

3045  -
EEXIST
;

3049 
	`rb_lšk_node
(&
dm
->
node
, 
·»Á
, 
p
);

3050 
	`rb_š£¹_cÞÜ
(&
dm
->
node
, &
sùx
->
wa™šg_dœ_moves
);

3052 
	}
}

3054 
wa™šg_dœ_move
 *

3055 
	$g‘_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
, 
u64
 
šo
)

3057 
rb_node
 *
n
 = 
sùx
->
wa™šg_dœ_moves
.rb_node;

3058 
wa™šg_dœ_move
 *
’Œy
;

3060 
n
) {

3061 
’Œy
 = 
	`rb_’Œy
(
n
, 
wa™šg_dœ_move
, 
node
);

3062 ià(
šo
 < 
’Œy
->ino)

3063 
n
 =‚->
rb_Ëá
;

3064 ià(
šo
 > 
’Œy
->ino)

3065 
n
 =‚->
rb_right
;

3067  
’Œy
;

3069  
NULL
;

3070 
	}
}

3072 
	$ä“_wa™šg_dœ_move
(
£nd_ùx
 *
sùx
,

3073 
wa™šg_dœ_move
 *
dm
)

3075 ià(!
dm
)

3077 
	`rb_”a£
(&
dm
->
node
, &
sùx
->
wa™šg_dœ_moves
);

3078 
	`kä“
(
dm
);

3079 
	}
}

3081 
	$add_³ndšg_dœ_move
(
£nd_ùx
 *
sùx
,

3082 
u64
 
šo
,

3083 
u64
 
šo_g’
,

3084 
u64
 
·»Á_šo
,

3085 
li¡_h—d
 *
Ãw_»fs
,

3086 
li¡_h—d
 *
d–‘ed_»fs
,

3087 cÚ¡ 
boÞ
 
is_Üphª
)

3089 
rb_node
 **
p
 = &
sùx
->
³ndšg_dœ_moves
.rb_node;

3090 
rb_node
 *
·»Á
 = 
NULL
;

3091 
³ndšg_dœ_move
 *
’Œy
 = 
NULL
, *
pm
;

3092 
»cÜded_»f
 *
cur
;

3093 
exi¡s
 = 0;

3094 
»t
;

3096 
pm
 = 
	`km®loc
((*pm), 
GFP_KERNEL
);

3097 ià(!
pm
)

3098  -
ENOMEM
;

3099 
pm
->
·»Á_šo
 =…arent_ino;

3100 
pm
->
šo
 = ino;

3101 
pm
->
g’
 = 
šo_g’
;

3102 
	`INIT_LIST_HEAD
(&
pm
->
li¡
);

3103 
	`INIT_LIST_HEAD
(&
pm
->
upd©e_»fs
);

3104 
	`RB_CLEAR_NODE
(&
pm
->
node
);

3106 *
p
) {

3107 
·»Á
 = *
p
;

3108 
’Œy
 = 
	`rb_’Œy
(
·»Á
, 
³ndšg_dœ_move
, 
node
);

3109 ià(
·»Á_šo
 < 
’Œy
->parent_ino) {

3110 
p
 = &(*p)->
rb_Ëá
;

3111 } ià(
·»Á_šo
 > 
’Œy
->parent_ino) {

3112 
p
 = &(*p)->
rb_right
;

3114 
exi¡s
 = 1;

3119 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
d–‘ed_»fs
, 
li¡
) {

3120 
»t
 = 
	`dup_»f
(
cur
, &
pm
->
upd©e_»fs
);

3121 ià(
»t
 < 0)

3122 
out
;

3124 
	`li¡_fÜ_—ch_’Œy
(
cur
, 
Ãw_»fs
, 
li¡
) {

3125 
»t
 = 
	`dup_»f
(
cur
, &
pm
->
upd©e_»fs
);

3126 ià(
»t
 < 0)

3127 
out
;

3130 
»t
 = 
	`add_wa™šg_dœ_move
(
sùx
, 
pm
->
šo
, 
is_Üphª
);

3131 ià(
»t
)

3132 
out
;

3134 ià(
exi¡s
) {

3135 
	`li¡_add_ž
(&
pm
->
li¡
, &
’Œy
->list);

3137 
	`rb_lšk_node
(&
pm
->
node
, 
·»Á
, 
p
);

3138 
	`rb_š£¹_cÞÜ
(&
pm
->
node
, &
sùx
->
³ndšg_dœ_moves
);

3140 
»t
 = 0;

3141 
out
:

3142 ià(
»t
) {

3143 
	`__ä“_»cÜded_»fs
(&
pm
->
upd©e_»fs
);

3144 
	`kä“
(
pm
);

3146  
»t
;

3147 
	}
}

3149 
³ndšg_dœ_move
 *
	$g‘_³ndšg_dœ_moves
(
£nd_ùx
 *
sùx
,

3150 
u64
 
·»Á_šo
)

3152 
rb_node
 *
n
 = 
sùx
->
³ndšg_dœ_moves
.rb_node;

3153 
³ndšg_dœ_move
 *
’Œy
;

3155 
n
) {

3156 
’Œy
 = 
	`rb_’Œy
(
n
, 
³ndšg_dœ_move
, 
node
);

3157 ià(
·»Á_šo
 < 
’Œy
->parent_ino)

3158 
n
 =‚->
rb_Ëá
;

3159 ià(
·»Á_šo
 > 
’Œy
->parent_ino)

3160 
n
 =‚->
rb_right
;

3162  
’Œy
;

3164  
NULL
;

3165 
	}
}

3167 
	$·th_loÝ
(
£nd_ùx
 *
sùx
, 
fs_·th
 *
Çme
,

3168 
u64
 
šo
, u64 
g’
, u64 *
ªû¡Ü_šo
)

3170 
»t
 = 0;

3171 
u64
 
·»Á_šode
 = 0;

3172 
u64
 
·»Á_g’
 = 0;

3173 
u64
 
¡¬t_šo
 = 
šo
;

3175 *
ªû¡Ü_šo
 = 0;

3176 
šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
) {

3177 
	`fs_·th_»£t
(
Çme
);

3179 ià(
	`is_wa™šg_fÜ_rm
(
sùx
, 
šo
))

3181 ià(
	`is_wa™šg_fÜ_move
(
sùx
, 
šo
)) {

3182 ià(*
ªû¡Ü_šo
 == 0)

3183 *
ªû¡Ü_šo
 = 
šo
;

3184 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
,

3185 &
·»Á_šode
, &
·»Á_g’
, 
Çme
);

3187 
»t
 = 
	`__g‘_cur_Çme_ªd_·»Á
(
sùx
, 
šo
, 
g’
,

3188 &
·»Á_šode
,

3189 &
·»Á_g’
, 
Çme
);

3190 ià(
»t
 > 0) {

3191 
»t
 = 0;

3195 ià(
»t
 < 0)

3197 ià(
·»Á_šode
 =ð
¡¬t_šo
) {

3198 
»t
 = 1;

3199 ià(*
ªû¡Ü_šo
 == 0)

3200 *
ªû¡Ü_šo
 = 
šo
;

3203 
šo
 = 
·»Á_šode
;

3204 
g’
 = 
·»Á_g’
;

3206  
»t
;

3207 
	}
}

3209 
	$­¶y_dœ_move
(
£nd_ùx
 *
sùx
, 
³ndšg_dœ_move
 *
pm
)

3211 
fs_·th
 *
äom_·th
 = 
NULL
;

3212 
fs_·th
 *
to_·th
 = 
NULL
;

3213 
fs_·th
 *
Çme
 = 
NULL
;

3214 
u64
 
Üig_´og»ss
 = 
sùx
->
£nd_´og»ss
;

3215 
»cÜded_»f
 *
cur
;

3216 
u64
 
·»Á_šo
, 
·»Á_g’
;

3217 
wa™šg_dœ_move
 *
dm
 = 
NULL
;

3218 
u64
 
rmdœ_šo
 = 0;

3219 
u64
 
ªû¡Ü
;

3220 
boÞ
 
is_Üphª
;

3221 
»t
;

3223 
Çme
 = 
	`fs_·th_®loc
();

3224 
äom_·th
 = 
	`fs_·th_®loc
();

3225 ià(!
Çme
 || !
äom_·th
) {

3226 
»t
 = -
ENOMEM
;

3227 
out
;

3230 
dm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
pm
->
šo
);

3231 
	`ASSERT
(
dm
);

3232 
rmdœ_šo
 = 
dm
->rmdir_ino;

3233 
is_Üphª
 = 
dm
->
Üphªized
;

3234 
	`ä“_wa™šg_dœ_move
(
sùx
, 
dm
);

3236 ià(
is_Üphª
) {

3237 
»t
 = 
	`g’_unique_Çme
(
sùx
, 
pm
->
šo
,

3238 
pm
->
g’
, 
äom_·th
);

3240 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
pm
->
šo
,

3241 &
·»Á_šo
, &
·»Á_g’
, 
Çme
);

3242 ià(
»t
 < 0)

3243 
out
;

3244 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
·»Á_šo
, 
·»Á_g’
,

3245 
äom_·th
);

3246 ià(
»t
 < 0)

3247 
out
;

3248 
»t
 = 
	`fs_·th_add_·th
(
äom_·th
, 
Çme
);

3250 ià(
»t
 < 0)

3251 
out
;

3253 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

3254 
»t
 = 
	`·th_loÝ
(
sùx
, 
Çme
, 
pm
->
šo
,…m->
g’
, &
ªû¡Ü
);

3255 ià(
»t
 < 0)

3256 
out
;

3257 ià(
»t
) {

3258 
	`LIST_HEAD
(
d–‘ed_»fs
);

3259 
	`ASSERT
(
ªû¡Ü
 > 
BTRFS_FIRST_FREE_OBJECTID
);

3260 
»t
 = 
	`add_³ndšg_dœ_move
(
sùx
, 
pm
->
šo
,…m->
g’
, 
ªû¡Ü
,

3261 &
pm
->
upd©e_»fs
, &
d–‘ed_»fs
,

3262 
is_Üphª
);

3263 ià(
»t
 < 0)

3264 
out
;

3265 ià(
rmdœ_šo
) {

3266 
dm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
pm
->
šo
);

3267 
	`ASSERT
(
dm
);

3268 
dm
->
rmdœ_šo
 =„mdir_ino;

3270 
out
;

3272 
	`fs_·th_»£t
(
Çme
);

3273 
to_·th
 = 
Çme
;

3274 
Çme
 = 
NULL
;

3275 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
pm
->
šo
,…m->
g’
, 
to_·th
);

3276 ià(
»t
 < 0)

3277 
out
;

3279 
»t
 = 
	`£nd_»Çme
(
sùx
, 
äom_·th
, 
to_·th
);

3280 ià(
»t
 < 0)

3281 
out
;

3283 ià(
rmdœ_šo
) {

3284 
Üphª_dœ_šfo
 *
odi
;

3286 
odi
 = 
	`g‘_Üphª_dœ_šfo
(
sùx
, 
rmdœ_šo
);

3287 ià(!
odi
) {

3289 
fšish
;

3291 
»t
 = 
	`ÿn_rmdœ
(
sùx
, 
rmdœ_šo
, 
odi
->
g’
, sùx->
cur_šo
);

3292 ià(
»t
 < 0)

3293 
out
;

3294 ià(!
»t
)

3295 
fšish
;

3297 
Çme
 = 
	`fs_·th_®loc
();

3298 ià(!
Çme
) {

3299 
»t
 = -
ENOMEM
;

3300 
out
;

3302 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
rmdœ_šo
, 
odi
->
g’
, 
Çme
);

3303 ià(
»t
 < 0)

3304 
out
;

3305 
»t
 = 
	`£nd_rmdœ
(
sùx
, 
Çme
);

3306 ià(
»t
 < 0)

3307 
out
;

3308 
	`ä“_Üphª_dœ_šfo
(
sùx
, 
odi
);

3311 
fšish
:

3312 
»t
 = 
	`£nd_utimes
(
sùx
, 
pm
->
šo
,…m->
g’
);

3313 ià(
»t
 < 0)

3314 
out
;

3320 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
pm
->
upd©e_»fs
, 
li¡
) {

3324 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
cur
->
dœ
, 
NULL
,

3325 
NULL
, NULL, NULL, NULL, NULL);

3326 ià(
»t
 =ð-
ENOENT
) {

3327 
»t
 = 0;

3330 ià(
»t
 < 0)

3331 
out
;

3333 
»t
 = 
	`£nd_utimes
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

3334 ià(
»t
 < 0)

3335 
out
;

3338 
out
:

3339 
	`fs_·th_ä“
(
Çme
);

3340 
	`fs_·th_ä“
(
äom_·th
);

3341 
	`fs_·th_ä“
(
to_·th
);

3342 
sùx
->
£nd_´og»ss
 = 
Üig_´og»ss
;

3344  
»t
;

3345 
	}
}

3347 
	$ä“_³ndšg_move
(
£nd_ùx
 *
sùx
, 
³ndšg_dœ_move
 *
m
)

3349 ià(!
	`li¡_em±y
(&
m
->
li¡
))

3350 
	`li¡_d–
(&
m
->
li¡
);

3351 ià(!
	`RB_EMPTY_NODE
(&
m
->
node
))

3352 
	`rb_”a£
(&
m
->
node
, &
sùx
->
³ndšg_dœ_moves
);

3353 
	`__ä“_»cÜded_»fs
(&
m
->
upd©e_»fs
);

3354 
	`kä“
(
m
);

3355 
	}
}

3357 
	$ž_­³nd_³ndšg_moves
(
³ndšg_dœ_move
 *
moves
,

3358 
li¡_h—d
 *
¡ack
)

3360 ià(
	`li¡_em±y
(&
moves
->
li¡
)) {

3361 
	`li¡_add_ž
(&
moves
->
li¡
, 
¡ack
);

3363 
	`LIST_HEAD
(
li¡
);

3364 
	`li¡_¥liû_š™
(&
moves
->
li¡
, &list);

3365 
	`li¡_add_ž
(&
moves
->
li¡
, 
¡ack
);

3366 
	`li¡_¥liû_ž
(&
li¡
, 
¡ack
);

3368 
	}
}

3370 
	$­¶y_chžd»n_dœ_moves
(
£nd_ùx
 *
sùx
)

3372 
³ndšg_dœ_move
 *
pm
;

3373 
li¡_h—d
 
¡ack
;

3374 
u64
 
·»Á_šo
 = 
sùx
->
cur_šo
;

3375 
»t
 = 0;

3377 
pm
 = 
	`g‘_³ndšg_dœ_moves
(
sùx
, 
·»Á_šo
);

3378 ià(!
pm
)

3381 
	`INIT_LIST_HEAD
(&
¡ack
);

3382 
	`ž_­³nd_³ndšg_moves
(
pm
, &
¡ack
);

3384 !
	`li¡_em±y
(&
¡ack
)) {

3385 
pm
 = 
	`li¡_fœ¡_’Œy
(&
¡ack
, 
³ndšg_dœ_move
, 
li¡
);

3386 
·»Á_šo
 = 
pm
->
šo
;

3387 
»t
 = 
	`­¶y_dœ_move
(
sùx
, 
pm
);

3388 
	`ä“_³ndšg_move
(
sùx
, 
pm
);

3389 ià(
»t
)

3390 
out
;

3391 
pm
 = 
	`g‘_³ndšg_dœ_moves
(
sùx
, 
·»Á_šo
);

3392 ià(
pm
)

3393 
	`ž_­³nd_³ndšg_moves
(
pm
, &
¡ack
);

3397 
out
:

3398 !
	`li¡_em±y
(&
¡ack
)) {

3399 
pm
 = 
	`li¡_fœ¡_’Œy
(&
¡ack
, 
³ndšg_dœ_move
, 
li¡
);

3400 
	`ä“_³ndšg_move
(
sùx
, 
pm
);

3402  
»t
;

3403 
	}
}

3441 
	$wa™_fÜ_de¡_dœ_move
(
£nd_ùx
 *
sùx
,

3442 
»cÜded_»f
 *
·»Á_»f
,

3443 cÚ¡ 
boÞ
 
is_Üphª
)

3445 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
·»Á_roÙ
->fs_info;

3446 
bŒfs_·th
 *
·th
;

3447 
bŒfs_key
 
key
;

3448 
bŒfs_key
 
di_key
;

3449 
bŒfs_dœ_™em
 *
di
;

3450 
u64
 
Ëá_g’
;

3451 
u64
 
right_g’
;

3452 
»t
 = 0;

3453 
wa™šg_dœ_move
 *
wdm
;

3455 ià(
	`RB_EMPTY_ROOT
(&
sùx
->
wa™šg_dœ_moves
))

3458 
·th
 = 
	`®loc_·th_fÜ_£nd
();

3459 ià(!
·th
)

3460  -
ENOMEM
;

3462 
key
.
objeùid
 = 
·»Á_»f
->
dœ
;

3463 
key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

3464 
key
.
off£t
 = 
	`bŒfs_Çme_hash
(
·»Á_»f
->
Çme
,…¬’t_»f->
Çme_Ën
);

3466 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
sùx
->
·»Á_roÙ
, &
key
, 
·th
, 0, 0);

3467 ià(
»t
 < 0) {

3468 
out
;

3469 } ià(
»t
 > 0) {

3470 
»t
 = 0;

3471 
out
;

3474 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
·»Á_»f
->
Çme
,

3475 
·»Á_»f
->
Çme_Ën
);

3476 ià(!
di
) {

3477 
»t
 = 0;

3478 
out
;

3488 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
di_key
);

3489 ià(
di_key
.
ty³
 !ð
BTRFS_INODE_ITEM_KEY
) {

3490 
»t
 = 0;

3491 
out
;

3494 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
di_key
.
objeùid
, 
NULL
,

3495 &
Ëá_g’
, 
NULL
, NULL, NULL, NULL);

3496 ià(
»t
 < 0)

3497 
out
;

3498 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
di_key
.
objeùid
, 
NULL
,

3499 &
right_g’
, 
NULL
, NULL, NULL, NULL);

3500 ià(
»t
 < 0) {

3501 ià(
»t
 =ð-
ENOENT
)

3502 
»t
 = 0;

3503 
out
;

3507 ià(
right_g’
 !ð
Ëá_g’
) {

3508 
»t
 = 0;

3509 
out
;

3512 
wdm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
, 
di_key
.
objeùid
);

3513 ià(
wdm
 && !wdm->
Üphªized
) {

3514 
»t
 = 
	`add_³ndšg_dœ_move
(
sùx
,

3515 
sùx
->
cur_šo
,

3516 
sùx
->
cur_šode_g’
,

3517 
di_key
.
objeùid
,

3518 &
sùx
->
Ãw_»fs
,

3519 &
sùx
->
d–‘ed_»fs
,

3520 
is_Üphª
);

3521 ià(!
»t
)

3522 
»t
 = 1;

3524 
out
:

3525 
	`bŒfs_ä“_·th
(
·th
);

3526  
»t
;

3527 
	}
}

3533 
	$is_ªû¡Ü
(
bŒfs_roÙ
 *
roÙ
,

3534 cÚ¡ 
u64
 
šo1
,

3535 cÚ¡ 
u64
 
šo1_g’
,

3536 cÚ¡ 
u64
 
šo2
,

3537 
fs_·th
 *fs_path)

3539 
u64
 
šo
 = 
šo2
;

3540 
boÞ
 
ä“_·th
 = 
çl£
;

3541 
»t
 = 0;

3543 ià(!
fs_·th
) {

3544 
fs_·th
 = 
	`fs_·th_®loc
();

3545 ià(!
fs_·th
)

3546  -
ENOMEM
;

3547 
ä“_·th
 = 
Œue
;

3550 
šo
 > 
BTRFS_FIRST_FREE_OBJECTID
) {

3551 
u64
 
·»Á
;

3552 
u64
 
·»Á_g’
;

3554 
	`fs_·th_»£t
(
fs_·th
);

3555 
»t
 = 
	`g‘_fœ¡_»f
(
roÙ
, 
šo
, &
·»Á
, &
·»Á_g’
, 
fs_·th
);

3556 ià(
»t
 < 0) {

3557 ià(
»t
 =ð-
ENOENT
 && 
šo
 =ð
šo2
)

3558 
»t
 = 0;

3559 
out
;

3561 ià(
·»Á
 =ð
šo1
) {

3562 
»t
 = 
·»Á_g’
 =ð
šo1_g’
 ? 1 : 0;

3563 
out
;

3565 
šo
 = 
·»Á
;

3567 
out
:

3568 ià(
ä“_·th
)

3569 
	`fs_·th_ä“
(
fs_·th
);

3570  
»t
;

3571 
	}
}

3573 
	$wa™_fÜ_·»Á_move
(
£nd_ùx
 *
sùx
,

3574 
»cÜded_»f
 *
·»Á_»f
,

3575 cÚ¡ 
boÞ
 
is_Üphª
)

3577 
»t
 = 0;

3578 
u64
 
šo
 = 
·»Á_»f
->
dœ
;

3579 
u64
 
šo_g’
 = 
·»Á_»f
->
dœ_g’
;

3580 
u64
 
·»Á_šo_befÜe
, 
·»Á_šo_aá”
;

3581 
fs_·th
 *
·th_befÜe
 = 
NULL
;

3582 
fs_·th
 *
·th_aá”
 = 
NULL
;

3583 
Ën1
, 
Ën2
;

3585 
·th_aá”
 = 
	`fs_·th_®loc
();

3586 
·th_befÜe
 = 
	`fs_·th_®loc
();

3587 ià(!
·th_aá”
 || !
·th_befÜe
) {

3588 
»t
 = -
ENOMEM
;

3589 
out
;

3599 
šo
 > 
BTRFS_FIRST_FREE_OBJECTID
) {

3600 
u64
 
·»Á_šo_aá”_g’
;

3602 ià(
	`is_wa™šg_fÜ_move
(
sùx
, 
šo
)) {

3613 
»t
 = 
	`is_ªû¡Ü
(
sùx
->
·»Á_roÙ
,

3614 
sùx
->
cur_šo
, sùx->
cur_šode_g’
,

3615 
šo
, 
·th_befÜe
);

3616 ià(
»t
)

3620 
	`fs_·th_»£t
(
·th_befÜe
);

3621 
	`fs_·th_»£t
(
·th_aá”
);

3623 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
£nd_roÙ
, 
šo
, &
·»Á_šo_aá”
,

3624 &
·»Á_šo_aá”_g’
, 
·th_aá”
);

3625 ià(
»t
 < 0)

3626 
out
;

3627 
»t
 = 
	`g‘_fœ¡_»f
(
sùx
->
·»Á_roÙ
, 
šo
, &
·»Á_šo_befÜe
,

3628 
NULL
, 
·th_befÜe
);

3629 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
) {

3630 
out
;

3631 } ià(
»t
 =ð-
ENOENT
) {

3632 
»t
 = 0;

3636 
Ën1
 = 
	`fs_·th_Ën
(
·th_befÜe
);

3637 
Ën2
 = 
	`fs_·th_Ën
(
·th_aá”
);

3638 ià(
šo
 > 
sùx
->
cur_šo
 &&

3639 (
·»Á_šo_befÜe
 !ð
·»Á_šo_aá”
 || 
Ën1
 !ð
Ën2
 ||

3640 
	`memcmp
(
·th_befÜe
->
¡¬t
, 
·th_aá”
->¡¬t, 
Ën1
))) {

3641 
u64
 
·»Á_šo_g’
;

3643 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
šo
, 
NULL
,

3644 &
·»Á_šo_g’
, 
NULL
, NULL, NULL,

3645 
NULL
);

3646 ià(
»t
 < 0)

3647 
out
;

3648 ià(
šo_g’
 =ð
·»Á_šo_g’
) {

3649 
»t
 = 1;

3653 
šo
 = 
·»Á_šo_aá”
;

3654 
šo_g’
 = 
·»Á_šo_aá”_g’
;

3657 
out
:

3658 
	`fs_·th_ä“
(
·th_befÜe
);

3659 
	`fs_·th_ä“
(
·th_aá”
);

3661 ià(
»t
 == 1) {

3662 
»t
 = 
	`add_³ndšg_dœ_move
(
sùx
,

3663 
sùx
->
cur_šo
,

3664 
sùx
->
cur_šode_g’
,

3665 
šo
,

3666 &
sùx
->
Ãw_»fs
,

3667 &
sùx
->
d–‘ed_»fs
,

3668 
is_Üphª
);

3669 ià(!
»t
)

3670 
»t
 = 1;

3673  
»t
;

3674 
	}
}

3676 
	$upd©e_»f_·th
(
£nd_ùx
 *
sùx
, 
»cÜded_»f
 *
»f
)

3678 
»t
;

3679 
fs_·th
 *
Ãw_·th
;

3685 
Ãw_·th
 = 
	`fs_·th_®loc
();

3686 ià(!
Ãw_·th
)

3687  -
ENOMEM
;

3689 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
»f
->
dœ
,„ef->
dœ_g’
, 
Ãw_·th
);

3690 ià(
»t
 < 0) {

3691 
	`fs_·th_ä“
(
Ãw_·th
);

3692  
»t
;

3694 
»t
 = 
	`fs_·th_add
(
Ãw_·th
, 
»f
->
Çme
,„ef->
Çme_Ën
);

3695 ià(
»t
 < 0) {

3696 
	`fs_·th_ä“
(
Ãw_·th
);

3697  
»t
;

3700 
	`fs_·th_ä“
(
»f
->
fuÎ_·th
);

3701 
	`£t_»f_·th
(
»f
, 
Ãw_·th
);

3704 
	}
}

3709 
	$´oûss_»cÜded_»fs
(
£nd_ùx
 *
sùx
, *
³ndšg_move
)

3711 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

3712 
»t
 = 0;

3713 
»cÜded_»f
 *
cur
;

3714 
»cÜded_»f
 *
cur2
;

3715 
li¡_h—d
 
check_dœs
;

3716 
fs_·th
 *
v®id_·th
 = 
NULL
;

3717 
u64
 
ow_šode
 = 0;

3718 
u64
 
ow_g’
;

3719 
u64
 
ow_mode
;

3720 
did_ov”wr™e
 = 0;

3721 
is_Üphª
 = 0;

3722 
u64
 
Ï¡_dœ_šo_rm
 = 0;

3723 
boÞ
 
ÿn_»Çme
 = 
Œue
;

3724 
boÞ
 
Üphªized_dœ
 = 
çl£
;

3725 
boÞ
 
Üphªized_ªû¡Ü
 = 
çl£
;

3727 
	`bŒfs_debug
(
fs_šfo
, "´oûss_»cÜded_»f %Îu", 
sùx
->
cur_šo
);

3733 
	`BUG_ON
(
sùx
->
cur_šo
 <ð
BTRFS_FIRST_FREE_OBJECTID
);

3734 
	`INIT_LIST_HEAD
(&
check_dœs
);

3736 
v®id_·th
 = 
	`fs_·th_®loc
();

3737 ià(!
v®id_·th
) {

3738 
»t
 = -
ENOMEM
;

3739 
out
;

3753 ià(!
sùx
->
cur_šode_Ãw
) {

3754 
»t
 = 
	`did_ov”wr™e_fœ¡_»f
(
sùx
, sùx->
cur_šo
,

3755 
sùx
->
cur_šode_g’
);

3756 ià(
»t
 < 0)

3757 
out
;

3758 ià(
»t
)

3759 
did_ov”wr™e
 = 1;

3761 ià(
sùx
->
cur_šode_Ãw
 || 
did_ov”wr™e
) {

3762 
»t
 = 
	`g’_unique_Çme
(
sùx
, sùx->
cur_šo
,

3763 
sùx
->
cur_šode_g’
, 
v®id_·th
);

3764 ià(
»t
 < 0)

3765 
out
;

3766 
is_Üphª
 = 1;

3768 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

3769 
v®id_·th
);

3770 ià(
»t
 < 0)

3771 
out
;

3774 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
Ãw_»fs
, 
li¡
) {

3782 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

3783 ià(
»t
 < 0)

3784 
out
;

3785 ià(
»t
 =ð
šode_¡©e_wžl_ü—‹
) {

3786 
»t
 = 0;

3791 
	`li¡_fÜ_—ch_’Œy
(
cur2
, &
sùx
->
Ãw_»fs
, 
li¡
) {

3792 ià(
cur
 =ð
cur2
)

3794 ià(
cur2
->
dœ
 =ð
cur
->dir) {

3795 
»t
 = 1;

3804 ià(!
»t
)

3805 
»t
 = 
	`did_ü—‹_dœ
(
sùx
, 
cur
->
dœ
);

3806 ià(
»t
 < 0)

3807 
out
;

3808 ià(!
»t
) {

3809 
»t
 = 
	`£nd_ü—‹_šode
(
sùx
, 
cur
->
dœ
);

3810 ià(
»t
 < 0)

3811 
out
;

3821 
»t
 = 
	`wžl_ov”wr™e_»f
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
,

3822 
cur
->
Çme
, cur->
Çme_Ën
,

3823 &
ow_šode
, &
ow_g’
, &
ow_mode
);

3824 ià(
»t
 < 0)

3825 
out
;

3826 ià(
»t
) {

3827 
»t
 = 
	`is_fœ¡_»f
(
sùx
->
·»Á_roÙ
,

3828 
ow_šode
, 
cur
->
dœ
, cur->
Çme
,

3829 
cur
->
Çme_Ën
);

3830 ià(
»t
 < 0)

3831 
out
;

3832 ià(
»t
) {

3833 
Çme_ÿche_’Œy
 *
nû
;

3834 
wa™šg_dœ_move
 *
wdm
;

3836 
»t
 = 
	`Üphªize_šode
(
sùx
, 
ow_šode
, 
ow_g’
,

3837 
cur
->
fuÎ_·th
);

3838 ià(
»t
 < 0)

3839 
out
;

3840 ià(
	`S_ISDIR
(
ow_mode
))

3841 
Üphªized_dœ
 = 
Œue
;

3849 ià(
	`is_wa™šg_fÜ_move
(
sùx
, 
ow_šode
)) {

3850 
wdm
 = 
	`g‘_wa™šg_dœ_move
(
sùx
,

3851 
ow_šode
);

3852 
	`ASSERT
(
wdm
);

3853 
wdm
->
Üphªized
 = 
Œue
;

3866 
nû
 = 
	`Çme_ÿche_£¬ch
(
sùx
, 
ow_šode
, 
ow_g’
);

3867 ià(
nû
) {

3868 
	`Çme_ÿche_d–‘e
(
sùx
, 
nû
);

3869 
	`kä“
(
nû
);

3879 
»t
 = 
	`is_ªû¡Ü
(
sùx
->
·»Á_roÙ
,

3880 
ow_šode
, 
ow_g’
,

3881 
sùx
->
cur_šo
, 
NULL
);

3882 ià(
»t
 > 0) {

3883 
Üphªized_ªû¡Ü
 = 
Œue
;

3884 
	`fs_·th_»£t
(
v®id_·th
);

3885 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
,

3886 
sùx
->
cur_šode_g’
,

3887 
v®id_·th
);

3889 ià(
»t
 < 0)

3890 
out
;

3892 
»t
 = 
	`£nd_uÆšk
(
sùx
, 
cur
->
fuÎ_·th
);

3893 ià(
»t
 < 0)

3894 
out
;

3898 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
·»Á_roÙ
) {

3899 
»t
 = 
	`wa™_fÜ_de¡_dœ_move
(
sùx
, 
cur
, 
is_Üphª
);

3900 ià(
»t
 < 0)

3901 
out
;

3902 ià(
»t
 == 1) {

3903 
ÿn_»Çme
 = 
çl£
;

3904 *
³ndšg_move
 = 1;

3908 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
·»Á_roÙ
 &&

3909 
ÿn_»Çme
) {

3910 
»t
 = 
	`wa™_fÜ_·»Á_move
(
sùx
, 
cur
, 
is_Üphª
);

3911 ià(
»t
 < 0)

3912 
out
;

3913 ià(
»t
 == 1) {

3914 
ÿn_»Çme
 = 
çl£
;

3915 *
³ndšg_move
 = 1;

3924 ià(
is_Üphª
 && 
ÿn_»Çme
) {

3925 
»t
 = 
	`£nd_»Çme
(
sùx
, 
v®id_·th
, 
cur
->
fuÎ_·th
);

3926 ià(
»t
 < 0)

3927 
out
;

3928 
is_Üphª
 = 0;

3929 
»t
 = 
	`fs_·th_cÝy
(
v®id_·th
, 
cur
->
fuÎ_·th
);

3930 ià(
»t
 < 0)

3931 
out
;

3932 } ià(
ÿn_»Çme
) {

3933 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
)) {

3939 
»t
 = 
	`£nd_»Çme
(
sùx
, 
v®id_·th
,

3940 
cur
->
fuÎ_·th
);

3941 ià(!
»t
)

3942 
»t
 = 
	`fs_·th_cÝy
(
v®id_·th
,

3943 
cur
->
fuÎ_·th
);

3944 ià(
»t
 < 0)

3945 
out
;

3954 ià(
Üphªized_dœ
) {

3955 
»t
 = 
	`upd©e_»f_·th
(
sùx
, 
cur
);

3956 ià(
»t
 < 0)

3957 
out
;

3959 
»t
 = 
	`£nd_lšk
(
sùx
, 
cur
->
fuÎ_·th
,

3960 
v®id_·th
);

3961 ià(
»t
 < 0)

3962 
out
;

3965 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

3966 ià(
»t
 < 0)

3967 
out
;

3970 ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
è&& sùx->
cur_šode_d–‘ed
) {

3977 
»t
 = 
	`ÿn_rmdœ
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

3978 
sùx
->
cur_šo
);

3979 ià(
»t
 < 0)

3980 
out
;

3981 ià(
»t
) {

3982 
»t
 = 
	`£nd_rmdœ
(
sùx
, 
v®id_·th
);

3983 ià(
»t
 < 0)

3984 
out
;

3985 } ià(!
is_Üphª
) {

3986 
»t
 = 
	`Üphªize_šode
(
sùx
, sùx->
cur_šo
,

3987 
sùx
->
cur_šode_g’
, 
v®id_·th
);

3988 ià(
»t
 < 0)

3989 
out
;

3990 
is_Üphª
 = 1;

3993 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
d–‘ed_»fs
, 
li¡
) {

3994 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

3995 ià(
»t
 < 0)

3996 
out
;

3998 } ià(
	`S_ISDIR
(
sùx
->
cur_šode_mode
) &&

3999 !
	`li¡_em±y
(&
sùx
->
d–‘ed_»fs
)) {

4003 
cur
 = 
	`li¡_’Œy
(
sùx
->
d–‘ed_»fs
.
Ãxt
, 
»cÜded_»f
,

4004 
li¡
);

4005 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

4006 ià(
»t
 < 0)

4007 
out
;

4008 } ià(!
	`S_ISDIR
(
sùx
->
cur_šode_mode
)) {

4014 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
sùx
->
d–‘ed_»fs
, 
li¡
) {

4015 
»t
 = 
	`did_ov”wr™e_»f
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
,

4016 
sùx
->
cur_šo
, sùx->
cur_šode_g’
,

4017 
cur
->
Çme
, cur->
Çme_Ën
);

4018 ià(
»t
 < 0)

4019 
out
;

4020 ià(!
»t
) {

4028 ià(
Üphªized_ªû¡Ü
) {

4029 
»t
 = 
	`upd©e_»f_·th
(
sùx
, 
cur
);

4030 ià(
»t
 < 0)

4031 
out
;

4033 
»t
 = 
	`£nd_uÆšk
(
sùx
, 
cur
->
fuÎ_·th
);

4034 ià(
»t
 < 0)

4035 
out
;

4037 
»t
 = 
	`dup_»f
(
cur
, &
check_dœs
);

4038 ià(
»t
 < 0)

4039 
out
;

4049 ià(
is_Üphª
) {

4050 
»t
 = 
	`£nd_uÆšk
(
sùx
, 
v®id_·th
);

4051 ià(
»t
 < 0)

4052 
out
;

4062 
	`li¡_fÜ_—ch_’Œy
(
cur
, &
check_dœs
, 
li¡
) {

4068 ià(
cur
->
dœ
 > 
sùx
->
cur_šo
)

4071 
»t
 = 
	`g‘_cur_šode_¡©e
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

4072 ià(
»t
 < 0)

4073 
out
;

4075 ià(
»t
 =ð
šode_¡©e_did_ü—‹
 ||

4076 
»t
 =ð
šode_¡©e_no_chªge
) {

4078 
»t
 = 
	`£nd_utimes
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
);

4079 ià(
»t
 < 0)

4080 
out
;

4081 } ià(
»t
 =ð
šode_¡©e_did_d–‘e
 &&

4082 
cur
->
dœ
 !ð
Ï¡_dœ_šo_rm
) {

4083 
»t
 = 
	`ÿn_rmdœ
(
sùx
, 
cur
->
dœ
, cur->
dœ_g’
,

4084 
sùx
->
cur_šo
);

4085 ià(
»t
 < 0)

4086 
out
;

4087 ià(
»t
) {

4088 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
cur
->
dœ
,

4089 
cur
->
dœ_g’
, 
v®id_·th
);

4090 ià(
»t
 < 0)

4091 
out
;

4092 
»t
 = 
	`£nd_rmdœ
(
sùx
, 
v®id_·th
);

4093 ià(
»t
 < 0)

4094 
out
;

4095 
Ï¡_dœ_šo_rm
 = 
cur
->
dœ
;

4100 
»t
 = 0;

4102 
out
:

4103 
	`__ä“_»cÜded_»fs
(&
check_dœs
);

4104 
	`ä“_»cÜded_»fs
(
sùx
);

4105 
	`fs_·th_ä“
(
v®id_·th
);

4106  
»t
;

4107 
	}
}

4109 
	$»cÜd_»f
(
bŒfs_roÙ
 *
roÙ
, 
num
, 
u64
 
dœ
, 
šdex
,

4110 
fs_·th
 *
Çme
, *
ùx
, 
li¡_h—d
 *
»fs
)

4112 
»t
 = 0;

4113 
£nd_ùx
 *
sùx
 = 
ùx
;

4114 
fs_·th
 *
p
;

4115 
u64
 
g’
;

4117 
p
 = 
	`fs_·th_®loc
();

4118 ià(!
p
)

4119  -
ENOMEM
;

4121 
»t
 = 
	`g‘_šode_šfo
(
roÙ
, 
dœ
, 
NULL
, &
g’
, NULL, NULL,

4122 
NULL
, NULL);

4123 ià(
»t
 < 0)

4124 
out
;

4126 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
dœ
, 
g’
, 
p
);

4127 ià(
»t
 < 0)

4128 
out
;

4129 
»t
 = 
	`fs_·th_add_·th
(
p
, 
Çme
);

4130 ià(
»t
 < 0)

4131 
out
;

4133 
»t
 = 
	`__»cÜd_»f
(
»fs
, 
dœ
, 
g’
, 
p
);

4135 
out
:

4136 ià(
»t
)

4137 
	`fs_·th_ä“
(
p
);

4138  
»t
;

4139 
	}
}

4141 
	$__»cÜd_Ãw_»f
(
num
, 
u64
 
dœ
, 
šdex
,

4142 
fs_·th
 *
Çme
,

4143 *
ùx
)

4145 
£nd_ùx
 *
sùx
 = 
ùx
;

4146  
	`»cÜd_»f
(
sùx
->
£nd_roÙ
, 
num
, 
dœ
, 
šdex
, 
Çme
,

4147 
ùx
, &
sùx
->
Ãw_»fs
);

4148 
	}
}

4151 
	$__»cÜd_d–‘ed_»f
(
num
, 
u64
 
dœ
, 
šdex
,

4152 
fs_·th
 *
Çme
,

4153 *
ùx
)

4155 
£nd_ùx
 *
sùx
 = 
ùx
;

4156  
	`»cÜd_»f
(
sùx
->
·»Á_roÙ
, 
num
, 
dœ
, 
šdex
, 
Çme
,

4157 
ùx
, &
sùx
->
d–‘ed_»fs
);

4158 
	}
}

4160 
	$»cÜd_Ãw_»f
(
£nd_ùx
 *
sùx
)

4162 
»t
;

4164 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4165 
sùx
->
cmp_key
, 0, 
__»cÜd_Ãw_»f
, sctx);

4166 ià(
»t
 < 0)

4167 
out
;

4168 
»t
 = 0;

4170 
out
:

4171  
»t
;

4172 
	}
}

4174 
	$»cÜd_d–‘ed_»f
(
£nd_ùx
 *
sùx
)

4176 
»t
;

4178 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4179 
sùx
->
cmp_key
, 0, 
__»cÜd_d–‘ed_»f
, sctx);

4180 ià(
»t
 < 0)

4181 
out
;

4182 
»t
 = 0;

4184 
out
:

4185  
»t
;

4186 
	}
}

4188 
	sfšd_»f_ùx
 {

4189 
u64
 
	mdœ
;

4190 
u64
 
	mdœ_g’
;

4191 
bŒfs_roÙ
 *
	mroÙ
;

4192 
fs_·th
 *
	mÇme
;

4193 
	mfound_idx
;

4196 
	$__fšd_œef
(
num
, 
u64
 
dœ
, 
šdex
,

4197 
fs_·th
 *
Çme
,

4198 *
ùx_
)

4200 
fšd_»f_ùx
 *
ùx
 = 
ùx_
;

4201 
u64
 
dœ_g’
;

4202 
»t
;

4204 ià(
dœ
 =ð
ùx
->dœ && 
	`fs_·th_Ën
(
Çme
) == fs_path_len(ctx->name) &&

4205 
	`¡ºcmp
(
Çme
->
¡¬t
, 
ùx
->Çme->¡¬t, 
	`fs_·th_Ën
(name)) == 0) {

4210 
»t
 = 
	`g‘_šode_šfo
(
ùx
->
roÙ
, 
dœ
, 
NULL
, &
dœ_g’
, NULL,

4211 
NULL
, NULL, NULL);

4212 ià(
»t
)

4213  
»t
;

4214 ià(
dœ_g’
 !ð
ùx
->dir_gen)

4216 
ùx
->
found_idx
 = 
num
;

4220 
	}
}

4222 
	$fšd_œef
(
bŒfs_roÙ
 *
roÙ
,

4223 
bŒfs_·th
 *
·th
,

4224 
bŒfs_key
 *
key
,

4225 
u64
 
dœ
, u64 
dœ_g’
, 
fs_·th
 *
Çme
)

4227 
»t
;

4228 
fšd_»f_ùx
 
ùx
;

4230 
ùx
.
dœ
 = dir;

4231 
ùx
.
Çme
 =‚ame;

4232 
ùx
.
dœ_g’
 = dir_gen;

4233 
ùx
.
found_idx
 = -1;

4234 
ùx
.
roÙ
 =„oot;

4236 
»t
 = 
	`™”©e_šode_»f
(
roÙ
, 
·th
, 
key
, 0, 
__fšd_œef
, &
ùx
);

4237 ià(
»t
 < 0)

4238  
»t
;

4240 ià(
ùx
.
found_idx
 == -1)

4241  -
ENOENT
;

4243  
ùx
.
found_idx
;

4244 
	}
}

4246 
	$__»cÜd_chªged_Ãw_»f
(
num
, 
u64
 
dœ
, 
šdex
,

4247 
fs_·th
 *
Çme
,

4248 *
ùx
)

4250 
u64
 
dœ_g’
;

4251 
»t
;

4252 
£nd_ùx
 *
sùx
 = 
ùx
;

4254 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
dœ
, 
NULL
, &
dœ_g’
, NULL,

4255 
NULL
, NULL, NULL);

4256 ià(
»t
)

4257  
»t
;

4259 
»t
 = 
	`fšd_œef
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4260 
sùx
->
cmp_key
, 
dœ
, 
dœ_g’
, 
Çme
);

4261 ià(
»t
 =ð-
ENOENT
)

4262 
»t
 = 
	`__»cÜd_Ãw_»f
(
num
, 
dœ
, 
šdex
, 
Çme
, 
sùx
);

4263 ià(
»t
 > 0)

4264 
»t
 = 0;

4266  
»t
;

4267 
	}
}

4269 
	$__»cÜd_chªged_d–‘ed_»f
(
num
, 
u64
 
dœ
, 
šdex
,

4270 
fs_·th
 *
Çme
,

4271 *
ùx
)

4273 
u64
 
dœ_g’
;

4274 
»t
;

4275 
£nd_ùx
 *
sùx
 = 
ùx
;

4277 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
dœ
, 
NULL
, &
dœ_g’
, NULL,

4278 
NULL
, NULL, NULL);

4279 ià(
»t
)

4280  
»t
;

4282 
»t
 = 
	`fšd_œef
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
, sùx->
cmp_key
,

4283 
dœ
, 
dœ_g’
, 
Çme
);

4284 ià(
»t
 =ð-
ENOENT
)

4285 
»t
 = 
	`__»cÜd_d–‘ed_»f
(
num
, 
dœ
, 
šdex
, 
Çme
, 
sùx
);

4286 ià(
»t
 > 0)

4287 
»t
 = 0;

4289  
»t
;

4290 
	}
}

4292 
	$»cÜd_chªged_»f
(
£nd_ùx
 *
sùx
)

4294 
»t
 = 0;

4296 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4297 
sùx
->
cmp_key
, 0, 
__»cÜd_chªged_Ãw_»f
, sctx);

4298 ià(
»t
 < 0)

4299 
out
;

4300 
»t
 = 
	`™”©e_šode_»f
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4301 
sùx
->
cmp_key
, 0, 
__»cÜd_chªged_d–‘ed_»f
, sctx);

4302 ià(
»t
 < 0)

4303 
out
;

4304 
»t
 = 0;

4306 
out
:

4307  
»t
;

4308 
	}
}

4314 
	$´oûss_®l_»fs
(
£nd_ùx
 *
sùx
,

4315 
bŒfs_com·»_Œ“_»suÉ
 
cmd
)

4317 
»t
;

4318 
bŒfs_roÙ
 *
roÙ
;

4319 
bŒfs_·th
 *
·th
;

4320 
bŒfs_key
 
key
;

4321 
bŒfs_key
 
found_key
;

4322 
ex‹Á_bufãr
 *
eb
;

4323 
¦Ù
;

4324 
™”©e_šode_»f_t
 
cb
;

4325 
³ndšg_move
 = 0;

4327 
·th
 = 
	`®loc_·th_fÜ_£nd
();

4328 ià(!
·th
)

4329  -
ENOMEM
;

4331 ià(
cmd
 =ð
BTRFS_COMPARE_TREE_NEW
) {

4332 
roÙ
 = 
sùx
->
£nd_roÙ
;

4333 
cb
 = 
__»cÜd_Ãw_»f
;

4334 } ià(
cmd
 =ð
BTRFS_COMPARE_TREE_DELETED
) {

4335 
roÙ
 = 
sùx
->
·»Á_roÙ
;

4336 
cb
 = 
__»cÜd_d–‘ed_»f
;

4338 
	`bŒfs_”r
(
sùx
->
£nd_roÙ
->
fs_šfo
,

4339 "WrÚg commªd %d iÀ´oûss_®l_»fs", 
cmd
);

4340 
»t
 = -
EINVAL
;

4341 
out
;

4344 
key
.
objeùid
 = 
sùx
->
cmp_key
->objectid;

4345 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

4346 
key
.
off£t
 = 0;

4347 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4348 ià(
»t
 < 0)

4349 
out
;

4352 
eb
 = 
·th
->
nodes
[0];

4353 
¦Ù
 = 
·th
->
¦Ùs
[0];

4354 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

4355 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

4356 ià(
»t
 < 0)

4357 
out
;

4358 ià(
»t
 > 0)

4363 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

4365 ià(
found_key
.
objeùid
 !ð
key
.objectid ||

4366 (
found_key
.
ty³
 !ð
BTRFS_INODE_REF_KEY
 &&

4367 
found_key
.
ty³
 !ð
BTRFS_INODE_EXTREF_KEY
))

4370 
»t
 = 
	`™”©e_šode_»f
(
roÙ
, 
·th
, &
found_key
, 0, 
cb
, 
sùx
);

4371 ià(
»t
 < 0)

4372 
out
;

4374 
·th
->
¦Ùs
[0]++;

4376 
	`bŒfs_»Ëa£_·th
(
·th
);

4383 
»t
 = 
	`´oûss_»cÜded_»fs
(
sùx
, &
³ndšg_move
);

4384 
out
:

4385 
	`bŒfs_ä“_·th
(
·th
);

4386  
»t
;

4387 
	}
}

4389 
	$£nd_£t_x©Œ
(
£nd_ùx
 *
sùx
,

4390 
fs_·th
 *
·th
,

4391 cÚ¡ *
Çme
, 
Çme_Ën
,

4392 cÚ¡ *
d©a
, 
d©a_Ën
)

4394 
»t
 = 0;

4396 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_SET_XATTR
);

4397 ià(
»t
 < 0)

4398 
out
;

4400 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

4401 
	`TLV_PUT_STRING
(
sùx
, 
BTRFS_SEND_A_XATTR_NAME
, 
Çme
, 
Çme_Ën
);

4402 
	`TLV_PUT
(
sùx
, 
BTRFS_SEND_A_XATTR_DATA
, 
d©a
, 
d©a_Ën
);

4404 
»t
 = 
	`£nd_cmd
(
sùx
);

4406 
Žv_put_çžu»
:

4407 
out
:

4408  
»t
;

4409 
	}
}

4411 
	$£nd_»move_x©Œ
(
£nd_ùx
 *
sùx
,

4412 
fs_·th
 *
·th
,

4413 cÚ¡ *
Çme
, 
Çme_Ën
)

4415 
»t
 = 0;

4417 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_REMOVE_XATTR
);

4418 ià(
»t
 < 0)

4419 
out
;

4421 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
·th
);

4422 
	`TLV_PUT_STRING
(
sùx
, 
BTRFS_SEND_A_XATTR_NAME
, 
Çme
, 
Çme_Ën
);

4424 
»t
 = 
	`£nd_cmd
(
sùx
);

4426 
Žv_put_çžu»
:

4427 
out
:

4428  
»t
;

4429 
	}
}

4431 
	$__´oûss_Ãw_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4432 cÚ¡ *
Çme
, 
Çme_Ën
,

4433 cÚ¡ *
d©a
, 
d©a_Ën
,

4434 
u8
 
ty³
, *
ùx
)

4436 
»t
;

4437 
£nd_ùx
 *
sùx
 = 
ùx
;

4438 
fs_·th
 *
p
;

4439 
posix_aþ_x©Œ_h—d”
 
dummy_aþ
;

4441 
p
 = 
	`fs_·th_®loc
();

4442 ià(!
p
)

4443  -
ENOMEM
;

4451 ià(!
	`¡ºcmp
(
Çme
, 
XATTR_NAME_POSIX_ACL_ACCESS
, 
Çme_Ën
) ||

4452 !
	`¡ºcmp
(
Çme
, 
XATTR_NAME_POSIX_ACL_DEFAULT
, 
Çme_Ën
)) {

4453 ià(
d©a_Ën
 == 0) {

4454 
dummy_aþ
.
a_v”siÚ
 =

4455 
	`ýu_to_Ë32
(
POSIX_ACL_XATTR_VERSION
);

4456 
d©a
 = (*)&
dummy_aþ
;

4457 
d©a_Ën
 = (
dummy_aþ
);

4461 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4462 ià(
»t
 < 0)

4463 
out
;

4465 
»t
 = 
	`£nd_£t_x©Œ
(
sùx
, 
p
, 
Çme
, 
Çme_Ën
, 
d©a
, 
d©a_Ën
);

4467 
out
:

4468 
	`fs_·th_ä“
(
p
);

4469  
»t
;

4470 
	}
}

4472 
	$__´oûss_d–‘ed_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4473 cÚ¡ *
Çme
, 
Çme_Ën
,

4474 cÚ¡ *
d©a
, 
d©a_Ën
,

4475 
u8
 
ty³
, *
ùx
)

4477 
»t
;

4478 
£nd_ùx
 *
sùx
 = 
ùx
;

4479 
fs_·th
 *
p
;

4481 
p
 = 
	`fs_·th_®loc
();

4482 ià(!
p
)

4483  -
ENOMEM
;

4485 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4486 ià(
»t
 < 0)

4487 
out
;

4489 
»t
 = 
	`£nd_»move_x©Œ
(
sùx
, 
p
, 
Çme
, 
Çme_Ën
);

4491 
out
:

4492 
	`fs_·th_ä“
(
p
);

4493  
»t
;

4494 
	}
}

4496 
	$´oûss_Ãw_x©Œ
(
£nd_ùx
 *
sùx
)

4498 
»t
 = 0;

4500 
»t
 = 
	`™”©e_dœ_™em
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4501 
sùx
->
cmp_key
, 
__´oûss_Ãw_x©Œ
, sctx);

4503  
»t
;

4504 
	}
}

4506 
	$´oûss_d–‘ed_x©Œ
(
£nd_ùx
 *
sùx
)

4508  
	`™”©e_dœ_™em
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4509 
sùx
->
cmp_key
, 
__´oûss_d–‘ed_x©Œ
, sctx);

4510 
	}
}

4512 
	sfšd_x©Œ_ùx
 {

4513 cÚ¡ *
	mÇme
;

4514 
	mÇme_Ën
;

4515 
	mfound_idx
;

4516 *
	mfound_d©a
;

4517 
	mfound_d©a_Ën
;

4520 
	$__fšd_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4521 cÚ¡ *
Çme
, 
Çme_Ën
,

4522 cÚ¡ *
d©a
, 
d©a_Ën
,

4523 
u8
 
ty³
, *
vùx
)

4525 
fšd_x©Œ_ùx
 *
ùx
 = 
vùx
;

4527 ià(
Çme_Ën
 =ð
ùx
->name_len &&

4528 
	`¡ºcmp
(
Çme
, 
ùx
->Çme, 
Çme_Ën
) == 0) {

4529 
ùx
->
found_idx
 = 
num
;

4530 
ùx
->
found_d©a_Ën
 = 
d©a_Ën
;

4531 
ùx
->
found_d©a
 = 
	`kmemdup
(
d©a
, 
d©a_Ën
, 
GFP_KERNEL
);

4532 ià(!
ùx
->
found_d©a
)

4533  -
ENOMEM
;

4537 
	}
}

4539 
	$fšd_x©Œ
(
bŒfs_roÙ
 *
roÙ
,

4540 
bŒfs_·th
 *
·th
,

4541 
bŒfs_key
 *
key
,

4542 cÚ¡ *
Çme
, 
Çme_Ën
,

4543 **
d©a
, *
d©a_Ën
)

4545 
»t
;

4546 
fšd_x©Œ_ùx
 
ùx
;

4548 
ùx
.
Çme
 =‚ame;

4549 
ùx
.
Çme_Ën
 =‚ame_len;

4550 
ùx
.
found_idx
 = -1;

4551 
ùx
.
found_d©a
 = 
NULL
;

4552 
ùx
.
found_d©a_Ën
 = 0;

4554 
»t
 = 
	`™”©e_dœ_™em
(
roÙ
, 
·th
, 
key
, 
__fšd_x©Œ
, &
ùx
);

4555 ià(
»t
 < 0)

4556  
»t
;

4558 ià(
ùx
.
found_idx
 == -1)

4559  -
ENOENT
;

4560 ià(
d©a
) {

4561 *
d©a
 = 
ùx
.
found_d©a
;

4562 *
d©a_Ën
 = 
ùx
.
found_d©a_Ën
;

4564 
	`kä“
(
ùx
.
found_d©a
);

4566  
ùx
.
found_idx
;

4567 
	}
}

4570 
	$__´oûss_chªged_Ãw_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4571 cÚ¡ *
Çme
, 
Çme_Ën
,

4572 cÚ¡ *
d©a
, 
d©a_Ën
,

4573 
u8
 
ty³
, *
ùx
)

4575 
»t
;

4576 
£nd_ùx
 *
sùx
 = 
ùx
;

4577 *
found_d©a
 = 
NULL
;

4578 
found_d©a_Ën
 = 0;

4580 
»t
 = 
	`fšd_x©Œ
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4581 
sùx
->
cmp_key
, 
Çme
, 
Çme_Ën
, &
found_d©a
,

4582 &
found_d©a_Ën
);

4583 ià(
»t
 =ð-
ENOENT
) {

4584 
»t
 = 
	`__´oûss_Ãw_x©Œ
(
num
, 
di_key
, 
Çme
, 
Çme_Ën
, 
d©a
,

4585 
d©a_Ën
, 
ty³
, 
ùx
);

4586 } ià(
»t
 >= 0) {

4587 ià(
d©a_Ën
 !ð
found_d©a_Ën
 ||

4588 
	`memcmp
(
d©a
, 
found_d©a
, 
d©a_Ën
)) {

4589 
»t
 = 
	`__´oûss_Ãw_x©Œ
(
num
, 
di_key
, 
Çme
, 
Çme_Ën
,

4590 
d©a
, 
d©a_Ën
, 
ty³
, 
ùx
);

4592 
»t
 = 0;

4596 
	`kä“
(
found_d©a
);

4597  
»t
;

4598 
	}
}

4600 
	$__´oûss_chªged_d–‘ed_x©Œ
(
num
, 
bŒfs_key
 *
di_key
,

4601 cÚ¡ *
Çme
, 
Çme_Ën
,

4602 cÚ¡ *
d©a
, 
d©a_Ën
,

4603 
u8
 
ty³
, *
ùx
)

4605 
»t
;

4606 
£nd_ùx
 *
sùx
 = 
ùx
;

4608 
»t
 = 
	`fšd_x©Œ
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
, sùx->
cmp_key
,

4609 
Çme
, 
Çme_Ën
, 
NULL
, NULL);

4610 ià(
»t
 =ð-
ENOENT
)

4611 
»t
 = 
	`__´oûss_d–‘ed_x©Œ
(
num
, 
di_key
, 
Çme
, 
Çme_Ën
, 
d©a
,

4612 
d©a_Ën
, 
ty³
, 
ùx
);

4613 ià(
»t
 >= 0)

4614 
»t
 = 0;

4616  
»t
;

4617 
	}
}

4619 
	$´oûss_chªged_x©Œ
(
£nd_ùx
 *
sùx
)

4621 
»t
 = 0;

4623 
»t
 = 
	`™”©e_dœ_™em
(
sùx
->
£nd_roÙ
, sùx->
Ëá_·th
,

4624 
sùx
->
cmp_key
, 
__´oûss_chªged_Ãw_x©Œ
, sctx);

4625 ià(
»t
 < 0)

4626 
out
;

4627 
»t
 = 
	`™”©e_dœ_™em
(
sùx
->
·»Á_roÙ
, sùx->
right_·th
,

4628 
sùx
->
cmp_key
, 
__´oûss_chªged_d–‘ed_x©Œ
, sctx);

4630 
out
:

4631  
»t
;

4632 
	}
}

4634 
	$´oûss_®l_Ãw_x©Œs
(
£nd_ùx
 *
sùx
)

4636 
»t
;

4637 
bŒfs_roÙ
 *
roÙ
;

4638 
bŒfs_·th
 *
·th
;

4639 
bŒfs_key
 
key
;

4640 
bŒfs_key
 
found_key
;

4641 
ex‹Á_bufãr
 *
eb
;

4642 
¦Ù
;

4644 
·th
 = 
	`®loc_·th_fÜ_£nd
();

4645 ià(!
·th
)

4646  -
ENOMEM
;

4648 
roÙ
 = 
sùx
->
£nd_roÙ
;

4650 
key
.
objeùid
 = 
sùx
->
cmp_key
->objectid;

4651 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

4652 
key
.
off£t
 = 0;

4653 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4654 ià(
»t
 < 0)

4655 
out
;

4658 
eb
 = 
·th
->
nodes
[0];

4659 
¦Ù
 = 
·th
->
¦Ùs
[0];

4660 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

4661 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

4662 ià(
»t
 < 0) {

4663 
out
;

4664 } ià(
»t
 > 0) {

4665 
»t
 = 0;

4671 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

4672 ià(
found_key
.
objeùid
 !ð
key
.objectid ||

4673 
found_key
.
ty³
 !ð
key
.type) {

4674 
»t
 = 0;

4675 
out
;

4678 
»t
 = 
	`™”©e_dœ_™em
(
roÙ
, 
·th
, &
found_key
,

4679 
__´oûss_Ãw_x©Œ
, 
sùx
);

4680 ià(
»t
 < 0)

4681 
out
;

4683 
·th
->
¦Ùs
[0]++;

4686 
out
:

4687 
	`bŒfs_ä“_·th
(
·th
);

4688  
»t
;

4689 
	}
}

4691 
ssize_t
 
	$fžl_»ad_buf
(
£nd_ùx
 *
sùx
, 
u64
 
off£t
, 
u32
 
Ën
)

4693 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

4694 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4695 
šode
 *inode;

4696 
·ge
 *page;

4697 *
addr
;

4698 
bŒfs_key
 
key
;

4699 
pgoff_t
 
šdex
 = 
off£t
 >> 
PAGE_SHIFT
;

4700 
pgoff_t
 
Ï¡_šdex
;

4701 
pg_off£t
 = 
off£t
 & ~
PAGE_MASK
;

4702 
ssize_t
 
»t
 = 0;

4704 
key
.
objeùid
 = 
sùx
->
cur_šo
;

4705 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4706 
key
.
off£t
 = 0;

4708 
šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
key
, 
roÙ
, 
NULL
);

4709 ià(
	`IS_ERR
(
šode
))

4710  
	`PTR_ERR
(
šode
);

4712 ià(
off£t
 + 
Ën
 > 
	`i_size_»ad
(
šode
)) {

4713 ià(
off£t
 > 
	`i_size_»ad
(
šode
))

4714 
Ën
 = 0;

4716 
Ën
 = 
off£t
 - 
	`i_size_»ad
(
šode
);

4718 ià(
Ën
 == 0)

4719 
out
;

4721 
Ï¡_šdex
 = (
off£t
 + 
Ën
 - 1è>> 
PAGE_SHIFT
;

4724 
	`mem£t
(&
sùx
->
¿
, 0, (
fže_¿_¡©e
));

4725 
	`fže_¿_¡©e_š™
(&
sùx
->
¿
, 
šode
->
i_m­pšg
);

4726 
	`·ge_ÿche_sync_»adah—d
(
šode
->
i_m­pšg
, &
sùx
->
¿
, 
NULL
, 
šdex
,

4727 
Ï¡_šdex
 - 
šdex
 + 1);

4729 
šdex
 <ð
Ï¡_šdex
) {

4730 
cur_Ën
 = 
	`mš_t
(, 
Ën
,

4731 
PAGE_SIZE
 - 
pg_off£t
);

4732 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
GFP_KERNEL
);

4733 ià(!
·ge
) {

4734 
»t
 = -
ENOMEM
;

4738 ià(!
	`PageU±od©e
(
·ge
)) {

4739 
	`bŒfs_»ad·ge
(
NULL
, 
·ge
);

4740 
	`lock_·ge
(
·ge
);

4741 ià(!
	`PageU±od©e
(
·ge
)) {

4742 
	`uÆock_·ge
(
·ge
);

4743 
	`put_·ge
(
·ge
);

4744 
»t
 = -
EIO
;

4749 
addr
 = 
	`km­
(
·ge
);

4750 
	`memýy
(
sùx
->
»ad_buf
 + 
»t
, 
addr
 + 
pg_off£t
, 
cur_Ën
);

4751 
	`kunm­
(
·ge
);

4752 
	`uÆock_·ge
(
·ge
);

4753 
	`put_·ge
(
·ge
);

4754 
šdex
++;

4755 
pg_off£t
 = 0;

4756 
Ën
 -ð
cur_Ën
;

4757 
»t
 +ð
cur_Ën
;

4759 
out
:

4760 
	`ut
(
šode
);

4761  
»t
;

4762 
	}
}

4768 
	$£nd_wr™e
(
£nd_ùx
 *
sùx
, 
u64
 
off£t
, 
u32
 
Ën
)

4770 
bŒfs_fs_šfo
 *
fs_šfo
 = 
sùx
->
£nd_roÙ
->fs_info;

4771 
»t
 = 0;

4772 
fs_·th
 *
p
;

4773 
ssize_t
 
num_»ad
 = 0;

4775 
p
 = 
	`fs_·th_®loc
();

4776 ià(!
p
)

4777  -
ENOMEM
;

4779 
	`bŒfs_debug
(
fs_šfo
, "£nd_wr™off£t=%Îu,†’=%d", 
off£t
, 
Ën
);

4781 
num_»ad
 = 
	`fžl_»ad_buf
(
sùx
, 
off£t
, 
Ën
);

4782 ià(
num_»ad
 <= 0) {

4783 ià(
num_»ad
 < 0)

4784 
»t
 = 
num_»ad
;

4785 
out
;

4788 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_WRITE
);

4789 ià(
»t
 < 0)

4790 
out
;

4792 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4793 ià(
»t
 < 0)

4794 
out
;

4796 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

4797 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

4798 
	`TLV_PUT
(
sùx
, 
BTRFS_SEND_A_DATA
, sùx->
»ad_buf
, 
num_»ad
);

4800 
»t
 = 
	`£nd_cmd
(
sùx
);

4802 
Žv_put_çžu»
:

4803 
out
:

4804 
	`fs_·th_ä“
(
p
);

4805 ià(
»t
 < 0)

4806  
»t
;

4807  
num_»ad
;

4808 
	}
}

4813 
	$£nd_þÚe
(
£nd_ùx
 *
sùx
,

4814 
u64
 
off£t
, 
u32
 
Ën
,

4815 
þÚe_roÙ
 *clone_root)

4817 
»t
 = 0;

4818 
fs_·th
 *
p
;

4819 
u64
 
g’
;

4821 
	`bŒfs_debug
(
sùx
->
£nd_roÙ
->
fs_šfo
,

4823 
off£t
, 
Ën
, 
þÚe_roÙ
->
roÙ
->
objeùid
, clÚe_roÙ->
šo
,

4824 
þÚe_roÙ
->
off£t
);

4826 
p
 = 
	`fs_·th_®loc
();

4827 ià(!
p
)

4828  -
ENOMEM
;

4830 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_CLONE
);

4831 ià(
»t
 < 0)

4832 
out
;

4834 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4835 ià(
»t
 < 0)

4836 
out
;

4838 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

4839 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_LEN
, 
Ën
);

4840 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

4842 ià(
þÚe_roÙ
->
roÙ
 =ð
sùx
->
£nd_roÙ
) {

4843 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
þÚe_roÙ
->
šo
, 
NULL
,

4844 &
g’
, 
NULL
, NULL, NULL, NULL);

4845 ià(
»t
 < 0)

4846 
out
;

4847 
»t
 = 
	`g‘_cur_·th
(
sùx
, 
þÚe_roÙ
->
šo
, 
g’
, 
p
);

4849 
»t
 = 
	`g‘_šode_·th
(
þÚe_roÙ
->
roÙ
, clÚe_roÙ->
šo
, 
p
);

4851 ià(
»t
 < 0)

4852 
out
;

4863 ià(!
	`bŒfs_is_em±y_uuid
(
þÚe_roÙ
->
roÙ
->
roÙ_™em
.
»ûived_uuid
))

4864 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

4865 
þÚe_roÙ
->
roÙ
->
roÙ_™em
.
»ûived_uuid
);

4867 
	`TLV_PUT_UUID
(
sùx
, 
BTRFS_SEND_A_CLONE_UUID
,

4868 
þÚe_roÙ
->
roÙ
->
roÙ_™em
.
uuid
);

4869 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_CTRANSID
,

4870 
	`Ë64_to_ýu
(
þÚe_roÙ
->
roÙ
->
roÙ_™em
.
ù¿nsid
));

4871 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_CLONE_PATH
, 
p
);

4872 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_CLONE_OFFSET
,

4873 
þÚe_roÙ
->
off£t
);

4875 
»t
 = 
	`£nd_cmd
(
sùx
);

4877 
Žv_put_çžu»
:

4878 
out
:

4879 
	`fs_·th_ä“
(
p
);

4880  
»t
;

4881 
	}
}

4886 
	$£nd_upd©e_ex‹Á
(
£nd_ùx
 *
sùx
,

4887 
u64
 
off£t
, 
u32
 
Ën
)

4889 
»t
 = 0;

4890 
fs_·th
 *
p
;

4892 
p
 = 
	`fs_·th_®loc
();

4893 ià(!
p
)

4894  -
ENOMEM
;

4896 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_UPDATE_EXTENT
);

4897 ià(
»t
 < 0)

4898 
out
;

4900 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4901 ià(
»t
 < 0)

4902 
out
;

4904 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

4905 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

4906 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_SIZE
, 
Ën
);

4908 
»t
 = 
	`£nd_cmd
(
sùx
);

4910 
Žv_put_çžu»
:

4911 
out
:

4912 
	`fs_·th_ä“
(
p
);

4913  
»t
;

4914 
	}
}

4916 
	$£nd_hÞe
(
£nd_ùx
 *
sùx
, 
u64
 
’d
)

4918 
fs_·th
 *
p
 = 
NULL
;

4919 
u64
 
off£t
 = 
sùx
->
cur_šode_Ï¡_ex‹Á
;

4920 
u64
 
Ën
;

4921 
»t
 = 0;

4923 
p
 = 
	`fs_·th_®loc
();

4924 ià(!
p
)

4925  -
ENOMEM
;

4926 
»t
 = 
	`g‘_cur_·th
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
, 
p
);

4927 ià(
»t
 < 0)

4928 
Žv_put_çžu»
;

4929 
	`mem£t
(
sùx
->
»ad_buf
, 0, 
BTRFS_SEND_READ_SIZE
);

4930 
off£t
 < 
’d
) {

4931 
Ën
 = 
	`mš_t
(
u64
, 
’d
 - 
off£t
, 
BTRFS_SEND_READ_SIZE
);

4933 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_WRITE
);

4934 ià(
»t
 < 0)

4936 
	`TLV_PUT_PATH
(
sùx
, 
BTRFS_SEND_A_PATH
, 
p
);

4937 
	`TLV_PUT_U64
(
sùx
, 
BTRFS_SEND_A_FILE_OFFSET
, 
off£t
);

4938 
	`TLV_PUT
(
sùx
, 
BTRFS_SEND_A_DATA
, sùx->
»ad_buf
, 
Ën
);

4939 
»t
 = 
	`£nd_cmd
(
sùx
);

4940 ià(
»t
 < 0)

4942 
off£t
 +ð
Ën
;

4944 
Žv_put_çžu»
:

4945 
	`fs_·th_ä“
(
p
);

4946  
»t
;

4947 
	}
}

4949 
	$£nd_ex‹Á_d©a
(
£nd_ùx
 *
sùx
,

4950 cÚ¡ 
u64
 
off£t
,

4951 cÚ¡ 
u64
 
Ën
)

4953 
u64
 
£Á
 = 0;

4955 ià(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_NO_FILE_DATA
)

4956  
	`£nd_upd©e_ex‹Á
(
sùx
, 
off£t
, 
Ën
);

4958 
£Á
 < 
Ën
) {

4959 
u64
 
size
 = 
Ën
 - 
£Á
;

4960 
»t
;

4962 ià(
size
 > 
BTRFS_SEND_READ_SIZE
)

4963 
size
 = 
BTRFS_SEND_READ_SIZE
;

4964 
»t
 = 
	`£nd_wr™e
(
sùx
, 
off£t
 + 
£Á
, 
size
);

4965 ià(
»t
 < 0)

4966  
»t
;

4967 ià(!
»t
)

4969 
£Á
 +ð
»t
;

4972 
	}
}

4974 
	$þÚe_¿nge
(
£nd_ùx
 *
sùx
,

4975 
þÚe_roÙ
 *clone_root,

4976 cÚ¡ 
u64
 
disk_by‹
,

4977 
u64
 
d©a_off£t
,

4978 
u64
 
off£t
,

4979 
u64
 
Ën
)

4981 
bŒfs_·th
 *
·th
;

4982 
bŒfs_key
 
key
;

4983 
»t
;

5000 ià(
þÚe_roÙ
->
off£t
 == 0 &&

5001 
Ën
 =ð
sùx
->
£nd_roÙ
->
fs_šfo
->
£ùÜsize
)

5002  
	`£nd_ex‹Á_d©a
(
sùx
, 
off£t
, 
Ën
);

5004 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5005 ià(!
·th
)

5006  -
ENOMEM
;

5030 
key
.
objeùid
 = 
þÚe_roÙ
->
šo
;

5031 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5032 
key
.
off£t
 = 
þÚe_roÙ
->offset;

5033 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
þÚe_roÙ
->
roÙ
, &
key
, 
·th
, 0, 0);

5034 ià(
»t
 < 0)

5035 
out
;

5036 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0) {

5037 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0] - 1);

5038 ià(
key
.
objeùid
 =ð
þÚe_roÙ
->
šo
 &&

5039 
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
)

5040 
·th
->
¦Ùs
[0]--;

5043 
Œue
) {

5044 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5045 
¦Ù
 = 
·th
->
¦Ùs
[0];

5046 
bŒfs_fže_ex‹Á_™em
 *
ei
;

5047 
u8
 
ty³
;

5048 
u64
 
ext_Ën
;

5049 
u64
 
þÚe_Ën
;

5051 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

5052 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
þÚe_roÙ
->
roÙ
, 
·th
);

5053 ià(
»t
 < 0)

5054 
out
;

5055 ià(
»t
 > 0)

5060 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

5066 ià(
key
.
objeùid
 !ð
þÚe_roÙ
->
šo
 ||

5067 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

5070 
ei
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

5071 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
ei
);

5072 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

5073 
ext_Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
, 
¦Ù
, 
ei
);

5074 
ext_Ën
 = 
	`PAGE_ALIGN
(ext_len);

5076 
ext_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
ei
);

5079 ià(
key
.
off£t
 + 
ext_Ën
 <ð
þÚe_roÙ
->offset)

5080 
Ãxt
;

5082 ià(
key
.
off£t
 > 
þÚe_roÙ
->offset) {

5084 
u64
 
hÞe_Ën
 = 
key
.
off£t
 - 
þÚe_roÙ
->offset;

5086 ià(
hÞe_Ën
 > 
Ën
)

5087 
hÞe_Ën
 = 
Ën
;

5088 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
off£t
, 
hÞe_Ën
);

5089 ià(
»t
 < 0)

5090 
out
;

5092 
Ën
 -ð
hÞe_Ën
;

5093 ià(
Ën
 == 0)

5095 
off£t
 +ð
hÞe_Ën
;

5096 
þÚe_roÙ
->
off£t
 +ð
hÞe_Ën
;

5097 
d©a_off£t
 +ð
hÞe_Ën
;

5100 ià(
key
.
off£t
 >ð
þÚe_roÙ
->off£ˆ+ 
Ën
)

5103 
þÚe_Ën
 = 
	`mš_t
(
u64
, 
ext_Ën
, 
Ën
);

5105 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
ei
è=ð
disk_by‹
 &&

5106 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf
, 
ei
è=ð
d©a_off£t
)

5107 
»t
 = 
	`£nd_þÚe
(
sùx
, 
off£t
, 
þÚe_Ën
, 
þÚe_roÙ
);

5109 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
off£t
, 
þÚe_Ën
);

5111 ià(
»t
 < 0)

5112 
out
;

5114 
Ën
 -ð
þÚe_Ën
;

5115 ià(
Ën
 == 0)

5117 
off£t
 +ð
þÚe_Ën
;

5118 
þÚe_roÙ
->
off£t
 +ð
þÚe_Ën
;

5119 
d©a_off£t
 +ð
þÚe_Ën
;

5120 
Ãxt
:

5121 
·th
->
¦Ùs
[0]++;

5124 ià(
Ën
 > 0)

5125 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
off£t
, 
Ën
);

5127 
»t
 = 0;

5128 
out
:

5129 
	`bŒfs_ä“_·th
(
·th
);

5130  
»t
;

5131 
	}
}

5133 
	$£nd_wr™e_Ü_þÚe
(
£nd_ùx
 *
sùx
,

5134 
bŒfs_·th
 *
·th
,

5135 
bŒfs_key
 *
key
,

5136 
þÚe_roÙ
 *clone_root)

5138 
»t
 = 0;

5139 
bŒfs_fže_ex‹Á_™em
 *
ei
;

5140 
u64
 
off£t
 = 
key
->offset;

5141 
u64
 
Ën
;

5142 
u8
 
ty³
;

5143 
u64
 
bs
 = 
sùx
->
£nd_roÙ
->
fs_šfo
->
sb
->
s_blocksize
;

5145 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

5146 
bŒfs_fže_ex‹Á_™em
);

5147 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
);

5148 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

5149 
Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
·th
->
nodes
[0],

5150 
·th
->
¦Ùs
[0], 
ei
);

5156 
Ën
 = 
	`PAGE_ALIGN
(len);

5158 
Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
·th
->
nodes
[0], 
ei
);

5161 ià(
off£t
 + 
Ën
 > 
sùx
->
cur_šode_size
)

5162 
Ën
 = 
sùx
->
cur_šode_size
 - 
off£t
;

5163 ià(
Ën
 == 0) {

5164 
»t
 = 0;

5165 
out
;

5168 ià(
þÚe_roÙ
 && 
	`IS_ALIGNED
(
off£t
 + 
Ën
, 
bs
)) {

5169 
u64
 
disk_by‹
;

5170 
u64
 
d©a_off£t
;

5172 
disk_by‹
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
·th
->
nodes
[0], 
ei
);

5173 
d©a_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
·th
->
nodes
[0], 
ei
);

5174 
»t
 = 
	`þÚe_¿nge
(
sùx
, 
þÚe_roÙ
, 
disk_by‹
, 
d©a_off£t
,

5175 
off£t
, 
Ën
);

5177 
»t
 = 
	`£nd_ex‹Á_d©a
(
sùx
, 
off£t
, 
Ën
);

5179 
out
:

5180  
»t
;

5181 
	}
}

5183 
	$is_ex‹Á_unchªged
(
£nd_ùx
 *
sùx
,

5184 
bŒfs_·th
 *
Ëá_·th
,

5185 
bŒfs_key
 *
ekey
)

5187 
»t
 = 0;

5188 
bŒfs_key
 
key
;

5189 
bŒfs_·th
 *
·th
 = 
NULL
;

5190 
ex‹Á_bufãr
 *
eb
;

5191 
¦Ù
;

5192 
bŒfs_key
 
found_key
;

5193 
bŒfs_fže_ex‹Á_™em
 *
ei
;

5194 
u64
 
Ëá_diskÄ
;

5195 
u64
 
right_diskÄ
;

5196 
u64
 
Ëá_off£t
;

5197 
u64
 
right_off£t
;

5198 
u64
 
Ëá_off£t_fixed
;

5199 
u64
 
Ëá_Ën
;

5200 
u64
 
right_Ën
;

5201 
u64
 
Ëá_g’
;

5202 
u64
 
right_g’
;

5203 
u8
 
Ëá_ty³
;

5204 
u8
 
right_ty³
;

5206 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5207 ià(!
·th
)

5208  -
ENOMEM
;

5210 
eb
 = 
Ëá_·th
->
nodes
[0];

5211 
¦Ù
 = 
Ëá_·th
->
¦Ùs
[0];

5212 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

5213 
Ëá_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
ei
);

5215 ià(
Ëá_ty³
 !ð
BTRFS_FILE_EXTENT_REG
) {

5216 
»t
 = 0;

5217 
out
;

5219 
Ëá_diskÄ
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
ei
);

5220 
Ëá_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
eb
, 
ei
);

5221 
Ëá_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
ei
);

5222 
Ëá_g’
 = 
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
eb
, 
ei
);

5245 
key
.
objeùid
 = 
ekey
->objectid;

5246 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5247 
key
.
off£t
 = 
ekey
->offset;

5248 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
sùx
->
·»Á_roÙ
, &
key
, 
·th
, 0, 0);

5249 ià(
»t
 < 0)

5250 
out
;

5251 ià(
»t
) {

5252 
»t
 = 0;

5253 
out
;

5259 
eb
 = 
·th
->
nodes
[0];

5260 
¦Ù
 = 
·th
->
¦Ùs
[0];

5261 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

5262 ià(
found_key
.
objeùid
 !ð
key
.objectid ||

5263 
found_key
.
ty³
 !ð
key
.type) {

5265 
»t
 = (
Ëá_diskÄ
) ? 0 : 1;

5266 
out
;

5272 
key
 = 
found_key
;

5273 
key
.
off£t
 < 
ekey
->off£ˆ+ 
Ëá_Ën
) {

5274 
ei
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

5275 
right_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
ei
);

5276 ià(
right_ty³
 !ð
BTRFS_FILE_EXTENT_REG
 &&

5277 
right_ty³
 !ð
BTRFS_FILE_EXTENT_INLINE
) {

5278 
»t
 = 0;

5279 
out
;

5282 ià(
right_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

5283 
right_Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
eb
, 
¦Ù
, 
ei
);

5284 
right_Ën
 = 
	`PAGE_ALIGN
(right_len);

5286 
right_Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
eb
, 
ei
);

5293 ià(
found_key
.
off£t
 + 
right_Ën
 <ð
ekey
->offset) {

5295 
»t
 = (
Ëá_diskÄ
) ? 0 : 1;

5296 
out
;

5307 ià(
right_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

5308 
»t
 = 0;

5309 
out
;

5312 
right_diskÄ
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
ei
);

5313 
right_off£t
 = 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
ei
);

5314 
right_g’
 = 
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
eb
, 
ei
);

5316 
Ëá_off£t_fixed
 = 
Ëá_off£t
;

5317 ià(
key
.
off£t
 < 
ekey
->offset) {

5319 
right_off£t
 +ð
ekey
->
off£t
 - 
key
.offset;

5322 
Ëá_off£t_fixed
 +ð
key
.
off£t
 - 
ekey
->offset;

5328 ià(
Ëá_diskÄ
 !ð
right_diskÄ
 ||

5329 
Ëá_off£t_fixed
 !ð
right_off£t
 ||

5330 
Ëá_g’
 !ð
right_g’
) {

5331 
»t
 = 0;

5332 
out
;

5338 
»t
 = 
	`bŒfs_Ãxt_™em
(
sùx
->
·»Á_roÙ
, 
·th
);

5339 ià(
»t
 < 0)

5340 
out
;

5341 ià(!
»t
) {

5342 
eb
 = 
·th
->
nodes
[0];

5343 
¦Ù
 = 
·th
->
¦Ùs
[0];

5344 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

5346 ià(
»t
 || 
found_key
.
objeùid
 !ð
key
.objectid ||

5347 
found_key
.
ty³
 !ð
key
.type) {

5348 
key
.
off£t
 +ð
right_Ën
;

5351 ià(
found_key
.
off£t
 !ð
key
.off£ˆ+ 
right_Ën
) {

5352 
»t
 = 0;

5353 
out
;

5355 
key
 = 
found_key
;

5362 ià(
key
.
off£t
 >ð
ekey
->off£ˆ+ 
Ëá_Ën
)

5363 
»t
 = 1;

5365 
»t
 = 0;

5368 
out
:

5369 
	`bŒfs_ä“_·th
(
·th
);

5370  
»t
;

5371 
	}
}

5373 
	$g‘_Ï¡_ex‹Á
(
£nd_ùx
 *
sùx
, 
u64
 
off£t
)

5375 
bŒfs_·th
 *
·th
;

5376 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
£nd_roÙ
;

5377 
bŒfs_fže_ex‹Á_™em
 *
fi
;

5378 
bŒfs_key
 
key
;

5379 
u64
 
ex‹Á_’d
;

5380 
u8
 
ty³
;

5381 
»t
;

5383 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5384 ià(!
·th
)

5385  -
ENOMEM
;

5387 
sùx
->
cur_šode_Ï¡_ex‹Á
 = 0;

5389 
key
.
objeùid
 = 
sùx
->
cur_šo
;

5390 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5391 
key
.
off£t
 = offset;

5392 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
roÙ
, &
key
, 
·th
, 0, 1);

5393 ià(
»t
 < 0)

5394 
out
;

5395 
»t
 = 0;

5396 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

5397 ià(
key
.
objeùid
 !ð
sùx
->
cur_šo
 || key.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

5398 
out
;

5400 
fi
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

5401 
bŒfs_fže_ex‹Á_™em
);

5402 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
fi
);

5403 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

5404 
u64
 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
·th
->
nodes
[0],

5405 
·th
->
¦Ùs
[0], 
fi
);

5406 
ex‹Á_’d
 = 
	`ALIGN
(
key
.
off£t
 + 
size
,

5407 
sùx
->
£nd_roÙ
->
fs_šfo
->
£ùÜsize
);

5409 
ex‹Á_’d
 = 
key
.
off£t
 +

5410 
	`bŒfs_fže_ex‹Á_num_by‹s
(
·th
->
nodes
[0], 
fi
);

5412 
sùx
->
cur_šode_Ï¡_ex‹Á
 = 
ex‹Á_’d
;

5413 
out
:

5414 
	`bŒfs_ä“_·th
(
·th
);

5415  
»t
;

5416 
	}
}

5418 
	$¿nge_is_hÞe_š_·»Á
(
£nd_ùx
 *
sùx
,

5419 cÚ¡ 
u64
 
¡¬t
,

5420 cÚ¡ 
u64
 
’d
)

5422 
bŒfs_·th
 *
·th
;

5423 
bŒfs_key
 
key
;

5424 
bŒfs_roÙ
 *
roÙ
 = 
sùx
->
·»Á_roÙ
;

5425 
u64
 
£¬ch_¡¬t
 = 
¡¬t
;

5426 
»t
;

5428 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5429 ià(!
·th
)

5430  -
ENOMEM
;

5432 
key
.
objeùid
 = 
sùx
->
cur_šo
;

5433 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5434 
key
.
off£t
 = 
£¬ch_¡¬t
;

5435 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5436 ià(
»t
 < 0)

5437 
out
;

5438 ià(
»t
 > 0 && 
·th
->
¦Ùs
[0] > 0)

5439 
·th
->
¦Ùs
[0]--;

5441 
£¬ch_¡¬t
 < 
’d
) {

5442 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5443 
¦Ù
 = 
·th
->
¦Ùs
[0];

5444 
bŒfs_fže_ex‹Á_™em
 *
fi
;

5445 
u64
 
ex‹Á_’d
;

5447 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

5448 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

5449 ià(
»t
 < 0)

5450 
out
;

5451 ià(
»t
 > 0)

5456 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

5457 ià(
key
.
objeùid
 < 
sùx
->
cur_šo
 ||

5458 
key
.
ty³
 < 
BTRFS_EXTENT_DATA_KEY
)

5459 
Ãxt
;

5460 ià(
key
.
objeùid
 > 
sùx
->
cur_šo
 ||

5461 
key
.
ty³
 > 
BTRFS_EXTENT_DATA_KEY
 ||

5462 
key
.
off£t
 >ð
’d
)

5465 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

5466 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
fi
) ==

5467 
BTRFS_FILE_EXTENT_INLINE
) {

5468 
u64
 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
, 
¦Ù
, 
fi
);

5470 
ex‹Á_’d
 = 
	`ALIGN
(
key
.
off£t
 + 
size
,

5471 
roÙ
->
fs_šfo
->
£ùÜsize
);

5473 
ex‹Á_’d
 = 
key
.
off£t
 +

5474 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
);

5476 ià(
ex‹Á_’d
 <ð
¡¬t
)

5477 
Ãxt
;

5478 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
) == 0) {

5479 
£¬ch_¡¬t
 = 
ex‹Á_’d
;

5480 
Ãxt
;

5482 
»t
 = 0;

5483 
out
;

5484 
Ãxt
:

5485 
·th
->
¦Ùs
[0]++;

5487 
»t
 = 1;

5488 
out
:

5489 
	`bŒfs_ä“_·th
(
·th
);

5490  
»t
;

5491 
	}
}

5493 
	$maybe_£nd_hÞe
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
·th
,

5494 
bŒfs_key
 *
key
)

5496 
bŒfs_fže_ex‹Á_™em
 *
fi
;

5497 
u64
 
ex‹Á_’d
;

5498 
u8
 
ty³
;

5499 
»t
 = 0;

5501 ià(
sùx
->
cur_šo
 !ð
key
->
objeùid
 || !
	`Ãed_£nd_hÞe
(sctx))

5504 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 =ð(
u64
)-1) {

5505 
»t
 = 
	`g‘_Ï¡_ex‹Á
(
sùx
, 
key
->
off£t
 - 1);

5506 ià(
»t
)

5507  
»t
;

5510 
fi
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

5511 
bŒfs_fže_ex‹Á_™em
);

5512 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
fi
);

5513 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

5514 
u64
 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
·th
->
nodes
[0],

5515 
·th
->
¦Ùs
[0], 
fi
);

5516 
ex‹Á_’d
 = 
	`ALIGN
(
key
->
off£t
 + 
size
,

5517 
sùx
->
£nd_roÙ
->
fs_šfo
->
£ùÜsize
);

5519 
ex‹Á_’d
 = 
key
->
off£t
 +

5520 
	`bŒfs_fže_ex‹Á_num_by‹s
(
·th
->
nodes
[0], 
fi
);

5523 ià(
·th
->
¦Ùs
[0] == 0 &&

5524 
sùx
->
cur_šode_Ï¡_ex‹Á
 < 
key
->
off£t
) {

5532 
»t
 = 
	`g‘_Ï¡_ex‹Á
(
sùx
, 
key
->
off£t
 - 1);

5533 ià(
»t
)

5534  
»t
;

5537 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 < 
key
->
off£t
) {

5538 
»t
 = 
	`¿nge_is_hÞe_š_·»Á
(
sùx
,

5539 
sùx
->
cur_šode_Ï¡_ex‹Á
,

5540 
key
->
off£t
);

5541 ià(
»t
 < 0)

5542  
»t
;

5543 ià(
»t
 == 0)

5544 
»t
 = 
	`£nd_hÞe
(
sùx
, 
key
->
off£t
);

5546 
»t
 = 0;

5548 
sùx
->
cur_šode_Ï¡_ex‹Á
 = 
ex‹Á_’d
;

5549  
»t
;

5550 
	}
}

5552 
	$´oûss_ex‹Á
(
£nd_ùx
 *
sùx
,

5553 
bŒfs_·th
 *
·th
,

5554 
bŒfs_key
 *
key
)

5556 
þÚe_roÙ
 *
found_þÚe
 = 
NULL
;

5557 
»t
 = 0;

5559 ià(
	`S_ISLNK
(
sùx
->
cur_šode_mode
))

5562 ià(
sùx
->
·»Á_roÙ
 && !sùx->
cur_šode_Ãw
) {

5563 
»t
 = 
	`is_ex‹Á_unchªged
(
sùx
, 
·th
, 
key
);

5564 ià(
»t
 < 0)

5565 
out
;

5566 ià(
»t
) {

5567 
»t
 = 0;

5568 
out_hÞe
;

5571 
bŒfs_fže_ex‹Á_™em
 *
ei
;

5572 
u8
 
ty³
;

5574 
ei
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

5575 
bŒfs_fže_ex‹Á_™em
);

5576 
ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
·th
->
nodes
[0], 
ei
);

5577 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
 ||

5578 
ty³
 =ð
BTRFS_FILE_EXTENT_REG
) {

5585 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

5586 
»t
 = 0;

5587 
out
;

5591 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
·th
->
nodes
[0], 
ei
) == 0) {

5592 
»t
 = 0;

5593 
out
;

5598 
»t
 = 
	`fšd_ex‹Á_þÚe
(
sùx
, 
·th
, 
key
->
objeùid
, key->
off£t
,

5599 
sùx
->
cur_šode_size
, &
found_þÚe
);

5600 ià(
»t
 !ð-
ENOENT
 &&„et < 0)

5601 
out
;

5603 
»t
 = 
	`£nd_wr™e_Ü_þÚe
(
sùx
, 
·th
, 
key
, 
found_þÚe
);

5604 ià(
»t
)

5605 
out
;

5606 
out_hÞe
:

5607 
»t
 = 
	`maybe_£nd_hÞe
(
sùx
, 
·th
, 
key
);

5608 
out
:

5609  
»t
;

5610 
	}
}

5612 
	$´oûss_®l_ex‹Ás
(
£nd_ùx
 *
sùx
)

5614 
»t
;

5615 
bŒfs_roÙ
 *
roÙ
;

5616 
bŒfs_·th
 *
·th
;

5617 
bŒfs_key
 
key
;

5618 
bŒfs_key
 
found_key
;

5619 
ex‹Á_bufãr
 *
eb
;

5620 
¦Ù
;

5622 
roÙ
 = 
sùx
->
£nd_roÙ
;

5623 
·th
 = 
	`®loc_·th_fÜ_£nd
();

5624 ià(!
·th
)

5625  -
ENOMEM
;

5627 
key
.
objeùid
 = 
sùx
->
cmp_key
->objectid;

5628 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

5629 
key
.
off£t
 = 0;

5630 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5631 ià(
»t
 < 0)

5632 
out
;

5635 
eb
 = 
·th
->
nodes
[0];

5636 
¦Ù
 = 
·th
->
¦Ùs
[0];

5638 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
eb
)) {

5639 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

5640 ià(
»t
 < 0) {

5641 
out
;

5642 } ià(
»t
 > 0) {

5643 
»t
 = 0;

5649 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

5651 ià(
found_key
.
objeùid
 !ð
key
.objectid ||

5652 
found_key
.
ty³
 !ð
key
.type) {

5653 
»t
 = 0;

5654 
out
;

5657 
»t
 = 
	`´oûss_ex‹Á
(
sùx
, 
·th
, &
found_key
);

5658 ià(
»t
 < 0)

5659 
out
;

5661 
·th
->
¦Ùs
[0]++;

5664 
out
:

5665 
	`bŒfs_ä“_·th
(
·th
);

5666  
»t
;

5667 
	}
}

5669 
	$´oûss_»cÜded_»fs_if_Ãeded
(
£nd_ùx
 *
sùx
, 
©_’d
,

5670 *
³ndšg_move
,

5671 *
»fs_´oûs£d
)

5673 
»t
 = 0;

5675 ià(
sùx
->
cur_šo
 == 0)

5676 
out
;

5677 ià(!
©_’d
 && 
sùx
->
cur_šo
 =ðsùx->
cmp_key
->
objeùid
 &&

5678 
sùx
->
cmp_key
->
ty³
 <ð
BTRFS_INODE_EXTREF_KEY
)

5679 
out
;

5680 ià(
	`li¡_em±y
(&
sùx
->
Ãw_»fs
è&&†i¡_em±y(&sùx->
d–‘ed_»fs
))

5681 
out
;

5683 
»t
 = 
	`´oûss_»cÜded_»fs
(
sùx
, 
³ndšg_move
);

5684 ià(
»t
 < 0)

5685 
out
;

5687 *
»fs_´oûs£d
 = 1;

5688 
out
:

5689  
»t
;

5690 
	}
}

5692 
	$fšish_šode_if_Ãeded
(
£nd_ùx
 *
sùx
, 
©_’d
)

5694 
»t
 = 0;

5695 
u64
 
Ëá_mode
;

5696 
u64
 
Ëá_uid
;

5697 
u64
 
Ëá_gid
;

5698 
u64
 
right_mode
;

5699 
u64
 
right_uid
;

5700 
u64
 
right_gid
;

5701 
Ãed_chmod
 = 0;

5702 
Ãed_chown
 = 0;

5703 
³ndšg_move
 = 0;

5704 
»fs_´oûs£d
 = 0;

5706 
»t
 = 
	`´oûss_»cÜded_»fs_if_Ãeded
(
sùx
, 
©_’d
, &
³ndšg_move
,

5707 &
»fs_´oûs£d
);

5708 ià(
»t
 < 0)

5709 
out
;

5723 ià(
»fs_´oûs£d
 && !
³ndšg_move
)

5724 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

5726 ià(
sùx
->
cur_šo
 =ð0 || sùx->
cur_šode_d–‘ed
)

5727 
out
;

5728 ià(!
©_’d
 && 
sùx
->
cmp_key
->
objeùid
 =ðsùx->
cur_šo
)

5729 
out
;

5731 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, sùx->
cur_šo
, 
NULL
, NULL,

5732 &
Ëá_mode
, &
Ëá_uid
, &
Ëá_gid
, 
NULL
);

5733 ià(
»t
 < 0)

5734 
out
;

5736 ià(!
sùx
->
·»Á_roÙ
 || sùx->
cur_šode_Ãw
) {

5737 
Ãed_chown
 = 1;

5738 ià(!
	`S_ISLNK
(
sùx
->
cur_šode_mode
))

5739 
Ãed_chmod
 = 1;

5741 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, sùx->
cur_šo
,

5742 
NULL
, NULL, &
right_mode
, &
right_uid
,

5743 &
right_gid
, 
NULL
);

5744 ià(
»t
 < 0)

5745 
out
;

5747 ià(
Ëá_uid
 !ð
right_uid
 || 
Ëá_gid
 !ð
right_gid
)

5748 
Ãed_chown
 = 1;

5749 ià(!
	`S_ISLNK
(
sùx
->
cur_šode_mode
è&& 
Ëá_mode
 !ð
right_mode
)

5750 
Ãed_chmod
 = 1;

5753 ià(
	`S_ISREG
(
sùx
->
cur_šode_mode
)) {

5754 ià(
	`Ãed_£nd_hÞe
(
sùx
)) {

5755 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 =ð(
u64
)-1 ||

5756 
sùx
->
cur_šode_Ï¡_ex‹Á
 <

5757 
sùx
->
cur_šode_size
) {

5758 
»t
 = 
	`g‘_Ï¡_ex‹Á
(
sùx
, (
u64
)-1);

5759 ià(
»t
)

5760 
out
;

5762 ià(
sùx
->
cur_šode_Ï¡_ex‹Á
 <

5763 
sùx
->
cur_šode_size
) {

5764 
»t
 = 
	`£nd_hÞe
(
sùx
, sùx->
cur_šode_size
);

5765 ià(
»t
)

5766 
out
;

5769 
»t
 = 
	`£nd_Œunÿ‹
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

5770 
sùx
->
cur_šode_size
);

5771 ià(
»t
 < 0)

5772 
out
;

5775 ià(
Ãed_chown
) {

5776 
»t
 = 
	`£nd_chown
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

5777 
Ëá_uid
, 
Ëá_gid
);

5778 ià(
»t
 < 0)

5779 
out
;

5781 ià(
Ãed_chmod
) {

5782 
»t
 = 
	`£nd_chmod
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
,

5783 
Ëá_mode
);

5784 ià(
»t
 < 0)

5785 
out
;

5792 ià(!
	`is_wa™šg_fÜ_move
(
sùx
, sùx->
cur_šo
)) {

5793 
»t
 = 
	`­¶y_chžd»n_dœ_moves
(
sùx
);

5794 ià(
»t
)

5795 
out
;

5803 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

5804 
»t
 = 
	`£nd_utimes
(
sùx
, sùx->
cur_šo
, sùx->
cur_šode_g’
);

5805 ià(
»t
 < 0)

5806 
out
;

5809 
out
:

5810  
»t
;

5811 
	}
}

5813 
	$chªged_šode
(
£nd_ùx
 *
sùx
,

5814 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

5816 
»t
 = 0;

5817 
bŒfs_key
 *
key
 = 
sùx
->
cmp_key
;

5818 
bŒfs_šode_™em
 *
Ëá_ii
 = 
NULL
;

5819 
bŒfs_šode_™em
 *
right_ii
 = 
NULL
;

5820 
u64
 
Ëá_g’
 = 0;

5821 
u64
 
right_g’
 = 0;

5823 
sùx
->
cur_šo
 = 
key
->
objeùid
;

5824 
sùx
->
cur_šode_Ãw_g’
 = 0;

5825 
sùx
->
cur_šode_Ï¡_ex‹Á
 = (
u64
)-1;

5832 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
;

5834 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_NEW
 ||

5835 
»suÉ
 =ð
BTRFS_COMPARE_TREE_CHANGED
) {

5836 
Ëá_ii
 = 
	`bŒfs_™em_±r
(
sùx
->
Ëá_·th
->
nodes
[0],

5837 
sùx
->
Ëá_·th
->
¦Ùs
[0],

5838 
bŒfs_šode_™em
);

5839 
Ëá_g’
 = 
	`bŒfs_šode_g’”©iÚ
(
sùx
->
Ëá_·th
->
nodes
[0],

5840 
Ëá_ii
);

5842 
right_ii
 = 
	`bŒfs_™em_±r
(
sùx
->
right_·th
->
nodes
[0],

5843 
sùx
->
right_·th
->
¦Ùs
[0],

5844 
bŒfs_šode_™em
);

5845 
right_g’
 = 
	`bŒfs_šode_g’”©iÚ
(
sùx
->
right_·th
->
nodes
[0],

5846 
right_ii
);

5848 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_CHANGED
) {

5849 
right_ii
 = 
	`bŒfs_™em_±r
(
sùx
->
right_·th
->
nodes
[0],

5850 
sùx
->
right_·th
->
¦Ùs
[0],

5851 
bŒfs_šode_™em
);

5853 
right_g’
 = 
	`bŒfs_šode_g’”©iÚ
(
sùx
->
right_·th
->
nodes
[0],

5854 
right_ii
);

5861 ià(
Ëá_g’
 !ð
right_g’
 &&

5862 
sùx
->
cur_šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
)

5863 
sùx
->
cur_šode_Ãw_g’
 = 1;

5866 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_NEW
) {

5867 
sùx
->
cur_šode_g’
 = 
Ëá_g’
;

5868 
sùx
->
cur_šode_Ãw
 = 1;

5869 
sùx
->
cur_šode_d–‘ed
 = 0;

5870 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

5871 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5872 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

5873 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5874 
sùx
->
cur_šode_rdev
 = 
	`bŒfs_šode_rdev
(

5875 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5876 ià(
sùx
->
cur_šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
)

5877 
»t
 = 
	`£nd_ü—‹_šode_if_Ãeded
(
sùx
);

5878 } ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_DELETED
) {

5879 
sùx
->
cur_šode_g’
 = 
right_g’
;

5880 
sùx
->
cur_šode_Ãw
 = 0;

5881 
sùx
->
cur_šode_d–‘ed
 = 1;

5882 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

5883 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

5884 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

5885 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

5886 } ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_CHANGED
) {

5894 ià(
sùx
->
cur_šode_Ãw_g’
) {

5898 
sùx
->
cur_šode_g’
 = 
right_g’
;

5899 
sùx
->
cur_šode_Ãw
 = 0;

5900 
sùx
->
cur_šode_d–‘ed
 = 1;

5901 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

5902 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

5903 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

5904 
sùx
->
right_·th
->
nodes
[0], 
right_ii
);

5905 
»t
 = 
	`´oûss_®l_»fs
(
sùx
,

5906 
BTRFS_COMPARE_TREE_DELETED
);

5907 ià(
»t
 < 0)

5908 
out
;

5913 
sùx
->
cur_šode_g’
 = 
Ëá_g’
;

5914 
sùx
->
cur_šode_Ãw
 = 1;

5915 
sùx
->
cur_šode_d–‘ed
 = 0;

5916 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

5917 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5918 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

5919 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5920 
sùx
->
cur_šode_rdev
 = 
	`bŒfs_šode_rdev
(

5921 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5922 
»t
 = 
	`£nd_ü—‹_šode_if_Ãeded
(
sùx
);

5923 ià(
»t
 < 0)

5924 
out
;

5926 
»t
 = 
	`´oûss_®l_»fs
(
sùx
, 
BTRFS_COMPARE_TREE_NEW
);

5927 ià(
»t
 < 0)

5928 
out
;

5933 
sùx
->
£nd_´og»ss
 = sùx->
cur_šo
 + 1;

5939 
»t
 = 
	`´oûss_®l_ex‹Ás
(
sùx
);

5940 ià(
»t
 < 0)

5941 
out
;

5942 
»t
 = 
	`´oûss_®l_Ãw_x©Œs
(
sùx
);

5943 ià(
»t
 < 0)

5944 
out
;

5946 
sùx
->
cur_šode_g’
 = 
Ëá_g’
;

5947 
sùx
->
cur_šode_Ãw
 = 0;

5948 
sùx
->
cur_šode_Ãw_g’
 = 0;

5949 
sùx
->
cur_šode_d–‘ed
 = 0;

5950 
sùx
->
cur_šode_size
 = 
	`bŒfs_šode_size
(

5951 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5952 
sùx
->
cur_šode_mode
 = 
	`bŒfs_šode_mode
(

5953 
sùx
->
Ëá_·th
->
nodes
[0], 
Ëá_ii
);

5957 
out
:

5958  
»t
;

5959 
	}
}

5971 
	$chªged_»f
(
£nd_ùx
 *
sùx
,

5972 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

5974 
»t
 = 0;

5976 ià(
sùx
->
cur_šo
 !ðsùx->
cmp_key
->
objeùid
) {

5977 
	`šcÚsi¡’t_¢­shÙ_”rÜ
(
sùx
, 
»suÉ
, "reference");

5978  -
EIO
;

5981 ià(!
sùx
->
cur_šode_Ãw_g’
 &&

5982 
sùx
->
cur_šo
 !ð
BTRFS_FIRST_FREE_OBJECTID
) {

5983 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_NEW
)

5984 
»t
 = 
	`»cÜd_Ãw_»f
(
sùx
);

5985 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_DELETED
)

5986 
»t
 = 
	`»cÜd_d–‘ed_»f
(
sùx
);

5987 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_CHANGED
)

5988 
»t
 = 
	`»cÜd_chªged_»f
(
sùx
);

5991  
»t
;

5992 
	}
}

5999 
	$chªged_x©Œ
(
£nd_ùx
 *
sùx
,

6000 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

6002 
»t
 = 0;

6004 ià(
sùx
->
cur_šo
 !ðsùx->
cmp_key
->
objeùid
) {

6005 
	`šcÚsi¡’t_¢­shÙ_”rÜ
(
sùx
, 
»suÉ
, "xattr");

6006  -
EIO
;

6009 ià(!
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
) {

6010 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_NEW
)

6011 
»t
 = 
	`´oûss_Ãw_x©Œ
(
sùx
);

6012 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_DELETED
)

6013 
»t
 = 
	`´oûss_d–‘ed_x©Œ
(
sùx
);

6014 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_CHANGED
)

6015 
»t
 = 
	`´oûss_chªged_x©Œ
(
sùx
);

6018  
»t
;

6019 
	}
}

6026 
	$chªged_ex‹Á
(
£nd_ùx
 *
sùx
,

6027 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
)

6029 
»t
 = 0;

6031 ià(
sùx
->
cur_šo
 !ðsùx->
cmp_key
->
objeùid
) {

6033 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_CHANGED
) {

6034 
ex‹Á_bufãr
 *
Ëaf_l
;

6035 
ex‹Á_bufãr
 *
Ëaf_r
;

6036 
bŒfs_fže_ex‹Á_™em
 *
ei_l
;

6037 
bŒfs_fže_ex‹Á_™em
 *
ei_r
;

6039 
Ëaf_l
 = 
sùx
->
Ëá_·th
->
nodes
[0];

6040 
Ëaf_r
 = 
sùx
->
right_·th
->
nodes
[0];

6041 
ei_l
 = 
	`bŒfs_™em_±r
(
Ëaf_l
,

6042 
sùx
->
Ëá_·th
->
¦Ùs
[0],

6043 
bŒfs_fže_ex‹Á_™em
);

6044 
ei_r
 = 
	`bŒfs_™em_±r
(
Ëaf_r
,

6045 
sùx
->
right_·th
->
¦Ùs
[0],

6046 
bŒfs_fže_ex‹Á_™em
);

6067 ià(
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
Ëaf_l
, 
ei_l
) ==

6068 
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
Ëaf_r
, 
ei_r
) &&

6069 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf_l
, 
ei_l
) ==

6070 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
Ëaf_r
, 
ei_r
) &&

6071 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf_l
, 
ei_l
) ==

6072 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf_r
, 
ei_r
) &&

6073 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf_l
, 
ei_l
) ==

6074 
	`bŒfs_fže_ex‹Á_’üy±iÚ
(
Ëaf_r
, 
ei_r
) &&

6075 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf_l
, 
ei_l
) ==

6076 
	`bŒfs_fže_ex‹Á_Ùh”_’codšg
(
Ëaf_r
, 
ei_r
) &&

6077 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf_l
, 
ei_l
) ==

6078 
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf_r
, 
ei_r
) &&

6079 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf_l
, 
ei_l
) !=

6080 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
Ëaf_r
, 
ei_r
) &&

6081 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf_l
, 
ei_l
) ==

6082 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
Ëaf_r
, 
ei_r
) &&

6083 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf_l
, 
ei_l
) ==

6084 
	`bŒfs_fže_ex‹Á_off£t
(
Ëaf_r
, 
ei_r
) &&

6085 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf_l
, 
ei_l
) ==

6086 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf_r
, 
ei_r
))

6090 
	`šcÚsi¡’t_¢­shÙ_”rÜ
(
sùx
, 
»suÉ
, "extent");

6091  -
EIO
;

6094 ià(!
sùx
->
cur_šode_Ãw_g’
 && !sùx->
cur_šode_d–‘ed
) {

6095 ià(
»suÉ
 !ð
BTRFS_COMPARE_TREE_DELETED
)

6096 
»t
 = 
	`´oûss_ex‹Á
(
sùx
, sùx->
Ëá_·th
,

6097 
sùx
->
cmp_key
);

6100  
»t
;

6101 
	}
}

6103 
	$dœ_chªged
(
£nd_ùx
 *
sùx
, 
u64
 
dœ
)

6105 
u64
 
Üig_g’
, 
Ãw_g’
;

6106 
»t
;

6108 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
£nd_roÙ
, 
dœ
, 
NULL
, &
Ãw_g’
, NULL, NULL,

6109 
NULL
, NULL);

6110 ià(
»t
)

6111  
»t
;

6113 
»t
 = 
	`g‘_šode_šfo
(
sùx
->
·»Á_roÙ
, 
dœ
, 
NULL
, &
Üig_g’
, NULL,

6114 
NULL
, NULL, NULL);

6115 ià(
»t
)

6116  
»t
;

6118  (
Üig_g’
 !ð
Ãw_g’
) ? 1 : 0;

6119 
	}
}

6121 
	$com·»_»fs
(
£nd_ùx
 *
sùx
, 
bŒfs_·th
 *
·th
,

6122 
bŒfs_key
 *
key
)

6124 
bŒfs_šode_exŒef
 *
exŒef
;

6125 
ex‹Á_bufãr
 *
Ëaf
;

6126 
u64
 
dœid
 = 0, 
Ï¡_dœid
 = 0;

6127 
±r
;

6128 
u32
 
™em_size
;

6129 
u32
 
cur_off£t
 = 0;

6130 
»f_Çme_Ën
;

6131 
»t
 = 0;

6134 ià(
key
->
ty³
 =ð
BTRFS_INODE_REF_KEY
) {

6135 
dœid
 = 
key
->
off£t
;

6137 
»t
 = 
	`dœ_chªged
(
sùx
, 
dœid
);

6138 
out
;

6141 
Ëaf
 = 
·th
->
nodes
[0];

6142 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

6143 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

6144 
cur_off£t
 < 
™em_size
) {

6145 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 +

6146 
cur_off£t
);

6147 
dœid
 = 
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
, 
exŒef
);

6148 
»f_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

6149 
cur_off£t
 +ð
»f_Çme_Ën
 + (*
exŒef
);

6150 ià(
dœid
 =ð
Ï¡_dœid
)

6152 
»t
 = 
	`dœ_chªged
(
sùx
, 
dœid
);

6153 ià(
»t
)

6155 
Ï¡_dœid
 = 
dœid
;

6157 
out
:

6158  
»t
;

6159 
	}
}

6165 
	$chªged_cb
(
bŒfs_roÙ
 *
Ëá_roÙ
,

6166 
bŒfs_roÙ
 *
right_roÙ
,

6167 
bŒfs_·th
 *
Ëá_·th
,

6168 
bŒfs_·th
 *
right_·th
,

6169 
bŒfs_key
 *
key
,

6170 
bŒfs_com·»_Œ“_»suÉ
 
»suÉ
,

6171 *
ùx
)

6173 
»t
 = 0;

6174 
£nd_ùx
 *
sùx
 = 
ùx
;

6176 ià(
»suÉ
 =ð
BTRFS_COMPARE_TREE_SAME
) {

6177 ià(
key
->
ty³
 =ð
BTRFS_INODE_REF_KEY
 ||

6178 
key
->
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) {

6179 
»t
 = 
	`com·»_»fs
(
sùx
, 
Ëá_·th
, 
key
);

6180 ià(!
»t
)

6182 ià(
»t
 < 0)

6183  
»t
;

6184 } ià(
key
->
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

6185  
	`maybe_£nd_hÞe
(
sùx
, 
Ëá_·th
, 
key
);

6189 
»suÉ
 = 
BTRFS_COMPARE_TREE_CHANGED
;

6190 
»t
 = 0;

6193 
sùx
->
Ëá_·th
 =†eft_path;

6194 
sùx
->
right_·th
 =„ight_path;

6195 
sùx
->
cmp_key
 = 
key
;

6197 
»t
 = 
	`fšish_šode_if_Ãeded
(
sùx
, 0);

6198 ià(
»t
 < 0)

6199 
out
;

6202 ià(
key
->
objeùid
 =ð
BTRFS_FREE_INO_OBJECTID
 ||

6203 
key
->
objeùid
 =ð
BTRFS_FREE_SPACE_OBJECTID
)

6204 
out
;

6206 ià(
key
->
ty³
 =ð
BTRFS_INODE_ITEM_KEY
)

6207 
»t
 = 
	`chªged_šode
(
sùx
, 
»suÉ
);

6208 ià(
key
->
ty³
 =ð
BTRFS_INODE_REF_KEY
 ||

6209 
key
->
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
)

6210 
»t
 = 
	`chªged_»f
(
sùx
, 
»suÉ
);

6211 ià(
key
->
ty³
 =ð
BTRFS_XATTR_ITEM_KEY
)

6212 
»t
 = 
	`chªged_x©Œ
(
sùx
, 
»suÉ
);

6213 ià(
key
->
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
)

6214 
»t
 = 
	`chªged_ex‹Á
(
sùx
, 
»suÉ
);

6216 
out
:

6217  
»t
;

6218 
	}
}

6220 
	$fuÎ_£nd_Œ“
(
£nd_ùx
 *
sùx
)

6222 
»t
;

6223 
bŒfs_roÙ
 *
£nd_roÙ
 = 
sùx
->send_root;

6224 
bŒfs_key
 
key
;

6225 
bŒfs_key
 
found_key
;

6226 
bŒfs_·th
 *
·th
;

6227 
ex‹Á_bufãr
 *
eb
;

6228 
¦Ù
;

6230 
·th
 = 
	`®loc_·th_fÜ_£nd
();

6231 ià(!
·th
)

6232  -
ENOMEM
;

6234 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

6235 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

6236 
key
.
off£t
 = 0;

6238 
»t
 = 
	`bŒfs_£¬ch_¦Ù_fÜ_»ad
(
£nd_roÙ
, &
key
, 
·th
, 1, 0);

6239 ià(
»t
 < 0)

6240 
out
;

6241 ià(
»t
)

6242 
out_fšish
;

6245 
eb
 = 
·th
->
nodes
[0];

6246 
¦Ù
 = 
·th
->
¦Ùs
[0];

6247 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

6249 
»t
 = 
	`chªged_cb
(
£nd_roÙ
, 
NULL
, 
·th
, NULL,

6250 &
found_key
, 
BTRFS_COMPARE_TREE_NEW
, 
sùx
);

6251 ià(
»t
 < 0)

6252 
out
;

6254 
key
.
objeùid
 = 
found_key
.objectid;

6255 
key
.
ty³
 = 
found_key
.type;

6256 
key
.
off£t
 = 
found_key
.offset + 1;

6258 
»t
 = 
	`bŒfs_Ãxt_™em
(
£nd_roÙ
, 
·th
);

6259 ià(
»t
 < 0)

6260 
out
;

6261 ià(
»t
) {

6262 
»t
 = 0;

6267 
out_fšish
:

6268 
»t
 = 
	`fšish_šode_if_Ãeded
(
sùx
, 1);

6270 
out
:

6271 
	`bŒfs_ä“_·th
(
·th
);

6272  
»t
;

6273 
	}
}

6275 
	$£nd_subvÞ
(
£nd_ùx
 *
sùx
)

6277 
»t
;

6279 ià(!(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
)) {

6280 
»t
 = 
	`£nd_h—d”
(
sùx
);

6281 ià(
»t
 < 0)

6282 
out
;

6285 
»t
 = 
	`£nd_subvÞ_begš
(
sùx
);

6286 ià(
»t
 < 0)

6287 
out
;

6289 ià(
sùx
->
·»Á_roÙ
) {

6290 
»t
 = 
	`bŒfs_com·»_Œ“s
(
sùx
->
£nd_roÙ
, sùx->
·»Á_roÙ
,

6291 
chªged_cb
, 
sùx
);

6292 ià(
»t
 < 0)

6293 
out
;

6294 
»t
 = 
	`fšish_šode_if_Ãeded
(
sùx
, 1);

6295 ià(
»t
 < 0)

6296 
out
;

6298 
»t
 = 
	`fuÎ_£nd_Œ“
(
sùx
);

6299 ià(
»t
 < 0)

6300 
out
;

6303 
out
:

6304 
	`ä“_»cÜded_»fs
(
sùx
);

6305  
»t
;

6306 
	}
}

6321 
	$’su»_comm™_roÙs_u±od©e
(
£nd_ùx
 *
sùx
)

6323 
i
;

6324 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

6326 
agaš
:

6327 ià(
sùx
->
·»Á_roÙ
 &&

6328 
sùx
->
·»Á_roÙ
->
node
 !ðsùx->·»Á_roÙ->
comm™_roÙ
)

6329 
comm™_Œªs
;

6331 
i
 = 0; i < 
sùx
->
þÚe_roÙs_út
; i++)

6332 ià(
sùx
->
þÚe_roÙs
[
i
].
roÙ
->
node
 !=

6333 
sùx
->
þÚe_roÙs
[
i
].
roÙ
->
comm™_roÙ
)

6334 
comm™_Œªs
;

6336 ià(
Œªs
)

6337  
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

6341 
comm™_Œªs
:

6343 ià(!
Œªs
) {

6344 
Œªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
sùx
->
£nd_roÙ
);

6345 ià(
	`IS_ERR
(
Œªs
))

6346  
	`PTR_ERR
(
Œªs
);

6347 
agaš
;

6350  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

6351 
	}
}

6353 
	$bŒfs_roÙ_dec_£nd_š_´og»ss
(
bŒfs_roÙ
* 
roÙ
)

6355 
	`¥š_lock
(&
roÙ
->
roÙ_™em_lock
);

6356 
roÙ
->
£nd_š_´og»ss
--;

6361 ià(
roÙ
->
£nd_š_´og»ss
 < 0)

6362 
	`bŒfs_”r
(
roÙ
->
fs_šfo
,

6364 
roÙ
->
£nd_š_´og»ss
,„oÙ->
roÙ_key
.
objeùid
);

6365 
	`¥š_uÆock
(&
roÙ
->
roÙ_™em_lock
);

6366 
	}
}

6368 
	$bŒfs_ioùl_£nd
(
fže
 *
mÁ_fže
, 
__u£r
 *
¬g_
)

6370 
»t
 = 0;

6371 
bŒfs_roÙ
 *
£nd_roÙ
 = 
	`BTRFS_I
(
	`fže_šode
(
mÁ_fže
))->
roÙ
;

6372 
bŒfs_fs_šfo
 *
fs_šfo
 = 
£nd_roÙ
->fs_info;

6373 
bŒfs_roÙ
 *
þÚe_roÙ
;

6374 
bŒfs_ioùl_£nd_¬gs
 *
¬g
 = 
NULL
;

6375 
bŒfs_key
 
key
;

6376 
£nd_ùx
 *
sùx
 = 
NULL
;

6377 
u32
 
i
;

6378 
u64
 *
þÚe_sourûs_tmp
 = 
NULL
;

6379 
þÚe_sourûs_to_rÞlback
 = 0;

6380 
®loc_size
;

6381 
sÜt_þÚe_roÙs
 = 0;

6382 
šdex
;

6384 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

6385  -
EPERM
;

6391 
	`¥š_lock
(&
£nd_roÙ
->
roÙ_™em_lock
);

6392 
£nd_roÙ
->
£nd_š_´og»ss
++;

6393 
	`¥š_uÆock
(&
£nd_roÙ
->
roÙ_™em_lock
);

6399 
	`WARN_ON
(
£nd_roÙ
->
Üphª_þ—nup_¡©e
 !ð
ORPHAN_CLEANUP_DONE
);

6405 ià(!
	`bŒfs_roÙ_»adÚly
(
£nd_roÙ
)) {

6406 
»t
 = -
EPERM
;

6407 
out
;

6410 
¬g
 = 
	`memdup_u£r
(
¬g_
, (*arg));

6411 ià(
	`IS_ERR
(
¬g
)) {

6412 
»t
 = 
	`PTR_ERR
(
¬g
);

6413 
¬g
 = 
NULL
;

6414 
out
;

6422 ià(
¬g
->
þÚe_sourûs_couÁ
 >

6423 
ULONG_MAX
 / (
þÚe_roÙ
) - 1) {

6424 
»t
 = -
EINVAL
;

6425 
out
;

6428 ià(!
	`acûss_ok
(
VERIFY_READ
, 
¬g
->
þÚe_sourûs
,

6429 (*
¬g
->
þÚe_sourûs
) *

6430 
¬g
->
þÚe_sourûs_couÁ
)) {

6431 
»t
 = -
EFAULT
;

6432 
out
;

6435 ià(
¬g
->
æags
 & ~
BTRFS_SEND_FLAG_MASK
) {

6436 
»t
 = -
EINVAL
;

6437 
out
;

6440 
sùx
 = 
	`kz®loc
((
£nd_ùx
), 
GFP_KERNEL
);

6441 ià(!
sùx
) {

6442 
»t
 = -
ENOMEM
;

6443 
out
;

6446 
	`INIT_LIST_HEAD
(&
sùx
->
Ãw_»fs
);

6447 
	`INIT_LIST_HEAD
(&
sùx
->
d–‘ed_»fs
);

6448 
	`INIT_RADIX_TREE
(&
sùx
->
Çme_ÿche
, 
GFP_KERNEL
);

6449 
	`INIT_LIST_HEAD
(&
sùx
->
Çme_ÿche_li¡
);

6451 
sùx
->
æags
 = 
¬g
->flags;

6453 
sùx
->
£nd_fžp
 = 
	`fg‘
(
¬g
->
£nd_fd
);

6454 ià(!
sùx
->
£nd_fžp
) {

6455 
»t
 = -
EBADF
;

6456 
out
;

6459 
sùx
->
£nd_roÙ
 = send_root;

6464 ià(
	`bŒfs_roÙ_d—d
(
sùx
->
£nd_roÙ
)) {

6465 
»t
 = -
EPERM
;

6466 
out
;

6469 
sùx
->
þÚe_roÙs_út
 = 
¬g
->
þÚe_sourûs_couÁ
;

6471 
sùx
->
£nd_max_size
 = 
BTRFS_SEND_BUF_SIZE
;

6472 
sùx
->
£nd_buf
 = 
	`kvm®loc
(sùx->
£nd_max_size
, 
GFP_KERNEL
);

6473 ià(!
sùx
->
£nd_buf
) {

6474 
»t
 = -
ENOMEM
;

6475 
out
;

6478 
sùx
->
»ad_buf
 = 
	`kvm®loc
(
BTRFS_SEND_READ_SIZE
, 
GFP_KERNEL
);

6479 ià(!
sùx
->
»ad_buf
) {

6480 
»t
 = -
ENOMEM
;

6481 
out
;

6484 
sùx
->
³ndšg_dœ_moves
 = 
RB_ROOT
;

6485 
sùx
->
wa™šg_dœ_moves
 = 
RB_ROOT
;

6486 
sùx
->
Üphª_dœs
 = 
RB_ROOT
;

6488 
®loc_size
 = (
þÚe_roÙ
è* (
¬g
->
þÚe_sourûs_couÁ
 + 1);

6490 
sùx
->
þÚe_roÙs
 = 
	`kz®loc
(
®loc_size
, 
GFP_KERNEL
);

6491 ià(!
sùx
->
þÚe_roÙs
) {

6492 
»t
 = -
ENOMEM
;

6493 
out
;

6496 
®loc_size
 = 
¬g
->
þÚe_sourûs_couÁ
 * (*¬g->
þÚe_sourûs
);

6498 ià(
¬g
->
þÚe_sourûs_couÁ
) {

6499 
þÚe_sourûs_tmp
 = 
	`kvm®loc
(
®loc_size
, 
GFP_KERNEL
);

6500 ià(!
þÚe_sourûs_tmp
) {

6501 
»t
 = -
ENOMEM
;

6502 
out
;

6505 
»t
 = 
	`cÝy_äom_u£r
(
þÚe_sourûs_tmp
, 
¬g
->
þÚe_sourûs
,

6506 
®loc_size
);

6507 ià(
»t
) {

6508 
»t
 = -
EFAULT
;

6509 
out
;

6512 
i
 = 0; i < 
¬g
->
þÚe_sourûs_couÁ
; i++) {

6513 
key
.
objeùid
 = 
þÚe_sourûs_tmp
[
i
];

6514 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

6515 
key
.
off£t
 = (
u64
)-1;

6517 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

6519 
þÚe_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

6520 ià(
	`IS_ERR
(
þÚe_roÙ
)) {

6521 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

6522 
»t
 = 
	`PTR_ERR
(
þÚe_roÙ
);

6523 
out
;

6525 
	`¥š_lock
(&
þÚe_roÙ
->
roÙ_™em_lock
);

6526 ià(!
	`bŒfs_roÙ_»adÚly
(
þÚe_roÙ
) ||

6527 
	`bŒfs_roÙ_d—d
(
þÚe_roÙ
)) {

6528 
	`¥š_uÆock
(&
þÚe_roÙ
->
roÙ_™em_lock
);

6529 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

6530 
»t
 = -
EPERM
;

6531 
out
;

6533 
þÚe_roÙ
->
£nd_š_´og»ss
++;

6534 
	`¥š_uÆock
(&
þÚe_roÙ
->
roÙ_™em_lock
);

6535 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

6537 
sùx
->
þÚe_roÙs
[
i
].
roÙ
 = 
þÚe_roÙ
;

6538 
þÚe_sourûs_to_rÞlback
 = 
i
 + 1;

6540 
	`kvä“
(
þÚe_sourûs_tmp
);

6541 
þÚe_sourûs_tmp
 = 
NULL
;

6544 ià(
¬g
->
·»Á_roÙ
) {

6545 
key
.
objeùid
 = 
¬g
->
·»Á_roÙ
;

6546 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

6547 
key
.
off£t
 = (
u64
)-1;

6549 
šdex
 = 
	`¤cu_»ad_lock
(&
fs_šfo
->
subvÞ_¤cu
);

6551 
sùx
->
·»Á_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

6552 ià(
	`IS_ERR
(
sùx
->
·»Á_roÙ
)) {

6553 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

6554 
»t
 = 
	`PTR_ERR
(
sùx
->
·»Á_roÙ
);

6555 
out
;

6558 
	`¥š_lock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

6559 
sùx
->
·»Á_roÙ
->
£nd_š_´og»ss
++;

6560 ià(!
	`bŒfs_roÙ_»adÚly
(
sùx
->
·»Á_roÙ
) ||

6561 
	`bŒfs_roÙ_d—d
(
sùx
->
·»Á_roÙ
)) {

6562 
	`¥š_uÆock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

6563 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

6564 
»t
 = -
EPERM
;

6565 
out
;

6567 
	`¥š_uÆock
(&
sùx
->
·»Á_roÙ
->
roÙ_™em_lock
);

6569 
	`¤cu_»ad_uÆock
(&
fs_šfo
->
subvÞ_¤cu
, 
šdex
);

6577 
sùx
->
þÚe_roÙs
[sùx->
þÚe_roÙs_út
++].
roÙ
 = sùx->
£nd_roÙ
;

6580 
	`sÜt
(
sùx
->
þÚe_roÙs
, sùx->
þÚe_roÙs_út
,

6581 (*
sùx
->
þÚe_roÙs
), 
__þÚe_roÙ_cmp_sÜt
,

6582 
NULL
);

6583 
sÜt_þÚe_roÙs
 = 1;

6585 
»t
 = 
	`’su»_comm™_roÙs_u±od©e
(
sùx
);

6586 ià(
»t
)

6587 
out
;

6589 
cu¼’t
->
jouº®_šfo
 = 
BTRFS_SEND_TRANS_STUB
;

6590 
»t
 = 
	`£nd_subvÞ
(
sùx
);

6591 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

6592 ià(
»t
 < 0)

6593 
out
;

6595 ià(!(
sùx
->
æags
 & 
BTRFS_SEND_FLAG_OMIT_END_CMD
)) {

6596 
»t
 = 
	`begš_cmd
(
sùx
, 
BTRFS_SEND_C_END
);

6597 ià(
»t
 < 0)

6598 
out
;

6599 
»t
 = 
	`£nd_cmd
(
sùx
);

6600 ià(
»t
 < 0)

6601 
out
;

6604 
out
:

6605 
	`WARN_ON
(
sùx
 && !
»t
 && !
	`RB_EMPTY_ROOT
(&sùx->
³ndšg_dœ_moves
));

6606 
sùx
 && !
	`RB_EMPTY_ROOT
(&sùx->
³ndšg_dœ_moves
)) {

6607 
rb_node
 *
n
;

6608 
³ndšg_dœ_move
 *
pm
;

6610 
n
 = 
	`rb_fœ¡
(&
sùx
->
³ndšg_dœ_moves
);

6611 
pm
 = 
	`rb_’Œy
(
n
, 
³ndšg_dœ_move
, 
node
);

6612 !
	`li¡_em±y
(&
pm
->
li¡
)) {

6613 
³ndšg_dœ_move
 *
pm2
;

6615 
pm2
 = 
	`li¡_fœ¡_’Œy
(&
pm
->
li¡
,

6616 
³ndšg_dœ_move
, 
li¡
);

6617 
	`ä“_³ndšg_move
(
sùx
, 
pm2
);

6619 
	`ä“_³ndšg_move
(
sùx
, 
pm
);

6622 
	`WARN_ON
(
sùx
 && !
»t
 && !
	`RB_EMPTY_ROOT
(&sùx->
wa™šg_dœ_moves
));

6623 
sùx
 && !
	`RB_EMPTY_ROOT
(&sùx->
wa™šg_dœ_moves
)) {

6624 
rb_node
 *
n
;

6625 
wa™šg_dœ_move
 *
dm
;

6627 
n
 = 
	`rb_fœ¡
(&
sùx
->
wa™šg_dœ_moves
);

6628 
dm
 = 
	`rb_’Œy
(
n
, 
wa™šg_dœ_move
, 
node
);

6629 
	`rb_”a£
(&
dm
->
node
, &
sùx
->
wa™šg_dœ_moves
);

6630 
	`kä“
(
dm
);

6633 
	`WARN_ON
(
sùx
 && !
»t
 && !
	`RB_EMPTY_ROOT
(&sùx->
Üphª_dœs
));

6634 
sùx
 && !
	`RB_EMPTY_ROOT
(&sùx->
Üphª_dœs
)) {

6635 
rb_node
 *
n
;

6636 
Üphª_dœ_šfo
 *
odi
;

6638 
n
 = 
	`rb_fœ¡
(&
sùx
->
Üphª_dœs
);

6639 
odi
 = 
	`rb_’Œy
(
n
, 
Üphª_dœ_šfo
, 
node
);

6640 
	`ä“_Üphª_dœ_šfo
(
sùx
, 
odi
);

6643 ià(
sÜt_þÚe_roÙs
) {

6644 
i
 = 0; i < 
sùx
->
þÚe_roÙs_út
; i++)

6645 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(

6646 
sùx
->
þÚe_roÙs
[
i
].
roÙ
);

6648 
i
 = 0; 
sùx
 && i < 
þÚe_sourûs_to_rÞlback
; i++)

6649 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(

6650 
sùx
->
þÚe_roÙs
[
i
].
roÙ
);

6652 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(
£nd_roÙ
);

6654 ià(
sùx
 && !
	`IS_ERR_OR_NULL
(sùx->
·»Á_roÙ
))

6655 
	`bŒfs_roÙ_dec_£nd_š_´og»ss
(
sùx
->
·»Á_roÙ
);

6657 
	`kä“
(
¬g
);

6658 
	`kvä“
(
þÚe_sourûs_tmp
);

6660 ià(
sùx
) {

6661 ià(
sùx
->
£nd_fžp
)

6662 
	`åut
(
sùx
->
£nd_fžp
);

6664 
	`kvä“
(
sùx
->
þÚe_roÙs
);

6665 
	`kvä“
(
sùx
->
£nd_buf
);

6666 
	`kvä“
(
sùx
->
»ad_buf
);

6668 
	`Çme_ÿche_ä“
(
sùx
);

6670 
	`kä“
(
sùx
);

6673  
»t
;

6674 
	}
}

	@send.h

20 
	~"ù»e.h
"

22 
	#BTRFS_SEND_STREAM_MAGIC
 "bŒfs-¡»am"

	)

23 
	#BTRFS_SEND_STREAM_VERSION
 1

	)

25 
	#BTRFS_SEND_BUF_SIZE
 
SZ_64K


	)

26 
	#BTRFS_SEND_READ_SIZE
 (48 * 
SZ_1K
)

	)

28 
	ebŒfs_Žv_ty³
 {

29 
	mBTRFS_TLV_U8
,

30 
	mBTRFS_TLV_U16
,

31 
	mBTRFS_TLV_U32
,

32 
	mBTRFS_TLV_U64
,

33 
	mBTRFS_TLV_BINARY
,

34 
	mBTRFS_TLV_STRING
,

35 
	mBTRFS_TLV_UUID
,

36 
	mBTRFS_TLV_TIMESPEC
,

39 
	sbŒfs_¡»am_h—d”
 {

40 
	mmagic
[(
BTRFS_SEND_STREAM_MAGIC
)];

41 
__Ë32
 
	mv”siÚ
;

42 } 
__©Œibu‹__
 ((
__·cked__
));

44 
	sbŒfs_cmd_h—d”
 {

46 
__Ë32
 
	mËn
;

47 
__Ë16
 
	mcmd
;

49 
__Ë32
 
	müc
;

50 } 
__©Œibu‹__
 ((
__·cked__
));

52 
	sbŒfs_Žv_h—d”
 {

53 
__Ë16
 
	mŽv_ty³
;

55 
__Ë16
 
	mŽv_Ën
;

56 } 
__©Œibu‹__
 ((
__·cked__
));

59 
	ebŒfs_£nd_cmd
 {

60 
	mBTRFS_SEND_C_UNSPEC
,

62 
	mBTRFS_SEND_C_SUBVOL
,

63 
	mBTRFS_SEND_C_SNAPSHOT
,

65 
	mBTRFS_SEND_C_MKFILE
,

66 
	mBTRFS_SEND_C_MKDIR
,

67 
	mBTRFS_SEND_C_MKNOD
,

68 
	mBTRFS_SEND_C_MKFIFO
,

69 
	mBTRFS_SEND_C_MKSOCK
,

70 
	mBTRFS_SEND_C_SYMLINK
,

72 
	mBTRFS_SEND_C_RENAME
,

73 
	mBTRFS_SEND_C_LINK
,

74 
	mBTRFS_SEND_C_UNLINK
,

75 
	mBTRFS_SEND_C_RMDIR
,

77 
	mBTRFS_SEND_C_SET_XATTR
,

78 
	mBTRFS_SEND_C_REMOVE_XATTR
,

80 
	mBTRFS_SEND_C_WRITE
,

81 
	mBTRFS_SEND_C_CLONE
,

83 
	mBTRFS_SEND_C_TRUNCATE
,

84 
	mBTRFS_SEND_C_CHMOD
,

85 
	mBTRFS_SEND_C_CHOWN
,

86 
	mBTRFS_SEND_C_UTIMES
,

88 
	mBTRFS_SEND_C_END
,

89 
	mBTRFS_SEND_C_UPDATE_EXTENT
,

90 
	m__BTRFS_SEND_C_MAX
,

92 
	#BTRFS_SEND_C_MAX
 (
__BTRFS_SEND_C_MAX
 - 1)

	)

96 
	mBTRFS_SEND_A_UNSPEC
,

98 
	mBTRFS_SEND_A_UUID
,

99 
	mBTRFS_SEND_A_CTRANSID
,

101 
	mBTRFS_SEND_A_INO
,

102 
	mBTRFS_SEND_A_SIZE
,

103 
	mBTRFS_SEND_A_MODE
,

104 
	mBTRFS_SEND_A_UID
,

105 
	mBTRFS_SEND_A_GID
,

106 
	mBTRFS_SEND_A_RDEV
,

107 
	mBTRFS_SEND_A_CTIME
,

108 
	mBTRFS_SEND_A_MTIME
,

109 
	mBTRFS_SEND_A_ATIME
,

110 
	mBTRFS_SEND_A_OTIME
,

112 
	mBTRFS_SEND_A_XATTR_NAME
,

113 
	mBTRFS_SEND_A_XATTR_DATA
,

115 
	mBTRFS_SEND_A_PATH
,

116 
	mBTRFS_SEND_A_PATH_TO
,

117 
	mBTRFS_SEND_A_PATH_LINK
,

119 
	mBTRFS_SEND_A_FILE_OFFSET
,

120 
	mBTRFS_SEND_A_DATA
,

122 
	mBTRFS_SEND_A_CLONE_UUID
,

123 
	mBTRFS_SEND_A_CLONE_CTRANSID
,

124 
	mBTRFS_SEND_A_CLONE_PATH
,

125 
	mBTRFS_SEND_A_CLONE_OFFSET
,

126 
	mBTRFS_SEND_A_CLONE_LEN
,

128 
	m__BTRFS_SEND_A_MAX
,

130 
	#BTRFS_SEND_A_MAX
 (
__BTRFS_SEND_A_MAX
 - 1)

	)

132 #ifdeà
__KERNEL__


133 
bŒfs_ioùl_£nd
(
fže
 *
mÁ_fže
, 
__u£r
 *
¬g
);

	@struct-funcs.c

19 
	~<lšux/highmem.h
>

20 
	~<asm/uÇligÃd.h
>

22 
	~"ù»e.h
"

24 
šlše
 
u8
 
	$g‘_uÇligÃd_Ë8
(cÚ¡ *
p
)

26  *(
u8
 *)
p
;

27 
	}
}

29 
šlše
 
	$put_uÇligÃd_Ë8
(
u8
 
v®
, *
p
)

31 *(
u8
 *)
p
 = 
v®
;

32 
	}
}

52 
	#DEFINE_BTRFS_SETGET_BITS
(
b™s
) \

53 
u
##
b™s
 
bŒfs_g‘_tok’_
##
	`b™s
(cÚ¡ 
ex‹Á_bufãr
 *
eb
, \

54 cÚ¡ *
±r
, 
off
, \

55 
bŒfs_m­_tok’
 *
tok’
) \

57 
·¹_off£t
 = ()
±r
; \

58 
off£t
 = 
·¹_off£t
 + 
off
; \

59 *
p
; \

60 
”r
; \

61 *
kaddr
; \

62 
m­_¡¬t
; \

63 
m­_Ën
; \

64 
size
 = (
u
##
b™s
); \

65 
u
##
b™s
 
»s
; \

67 ià(
tok’
 &&ok’->
kaddr
 &&ok’->
off£t
 <= offset && \

68 
tok’
->
eb
 ==ƒb && \

69 (
tok’
->
off£t
 + 
PAGE_SIZE
 >ðoff£ˆ+ 
size
)) { \

70 
kaddr
 = 
tok’
->kaddr; \

71 
p
 = 
kaddr
 + 
·¹_off£t
 - 
tok’
->
off£t
; \

72 
»s
 = 
g‘_uÇligÃd_Ë
##
	`b™s
(
p
 + 
off
); \

73  
»s
; \

75 
”r
 = 
	`m­_´iv©e_ex‹Á_bufãr
(
eb
, 
off£t
, 
size
, \

76 &
kaddr
, &
m­_¡¬t
, &
m­_Ën
); \

77 ià(
”r
) { \

78 
__Ë
##
b™s
 
Ë»s
; \

80 
	`»ad_ex‹Á_bufãr
(
eb
, &
Ë»s
, 
off£t
, 
size
); \

81  
Ë
##
b™s
##
	`_to_ýu
(
Ë»s
); \

83 
p
 = 
kaddr
 + 
·¹_off£t
 - 
m­_¡¬t
; \

84 
»s
 = 
g‘_uÇligÃd_Ë
##
	`b™s
(
p
 + 
off
); \

85 ià(
tok’
) { \

86 
tok’
->
kaddr
 = kaddr; \

87 
tok’
->
off£t
 = 
m­_¡¬t
; \

88 
tok’
->
eb
 =ƒb; \

90  
»s
; \

92 
bŒfs_£t_tok’_
##
	`b™s
(
ex‹Á_bufãr
 *
eb
, \

93 cÚ¡ *
±r
, 
off
, \

94 
u
##
b™s
 
v®
, \

95 
bŒfs_m­_tok’
 *
tok’
) \

97 
·¹_off£t
 = ()
±r
; \

98 
off£t
 = 
·¹_off£t
 + 
off
; \

99 *
p
; \

100 
”r
; \

101 *
kaddr
; \

102 
m­_¡¬t
; \

103 
m­_Ën
; \

104 
size
 = (
u
##
b™s
); \

106 ià(
tok’
 &&ok’->
kaddr
 &&ok’->
off£t
 <= offset && \

107 
tok’
->
eb
 ==ƒb && \

108 (
tok’
->
off£t
 + 
PAGE_SIZE
 >ðoff£ˆ+ 
size
)) { \

109 
kaddr
 = 
tok’
->kaddr; \

110 
p
 = 
kaddr
 + 
·¹_off£t
 - 
tok’
->
off£t
; \

111 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
p
 + 
off
); \

114 
”r
 = 
	`m­_´iv©e_ex‹Á_bufãr
(
eb
, 
off£t
, 
size
, \

115 &
kaddr
, &
m­_¡¬t
, &
m­_Ën
); \

116 ià(
”r
) { \

117 
__Ë
##
b™s
 
v®2
; \

119 
v®2
 = 
ýu_to_Ë
##
	`b™s
(
v®
); \

120 
	`wr™e_ex‹Á_bufãr
(
eb
, &
v®2
, 
off£t
, 
size
); \

123 
p
 = 
kaddr
 + 
·¹_off£t
 - 
m­_¡¬t
; \

124 
put_uÇligÃd_Ë
##
	`b™s
(
v®
, 
p
 + 
off
); \

125 ià(
tok’
) { \

126 
tok’
->
kaddr
 = kaddr; \

127 
tok’
->
off£t
 = 
m­_¡¬t
; \

128 
tok’
->
eb
 =ƒb; \

130 }

	)

132 
	$DEFINE_BTRFS_SETGET_BITS
(8)

133 
	$DEFINE_BTRFS_SETGET_BITS
(16)

134 
	$DEFINE_BTRFS_SETGET_BITS
(32)

135 
	$DEFINE_BTRFS_SETGET_BITS
(64)

137 
	$bŒfs_node_key
(cÚ¡ 
ex‹Á_bufãr
 *
eb
,

138 
bŒfs_disk_key
 *
disk_key
, 
Ä
)

140 
±r
 = 
	`bŒfs_node_key_±r_off£t
(
Ä
);

141 
	`»ad_eb_memb”
(
eb
, (
bŒfs_key_±r
 *)
±r
,

142 
bŒfs_key_±r
, 
key
, 
disk_key
);

143 
	}
}

	@super.c

19 
	~<lšux/blkdev.h
>

20 
	~<lšux/moduË.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/fs.h
>

23 
	~<lšux/·gem­.h
>

24 
	~<lšux/highmem.h
>

25 
	~<lšux/time.h
>

26 
	~<lšux/š™.h
>

27 
	~<lšux/£q_fže.h
>

28 
	~<lšux/¡ršg.h
>

29 
	~<lšux/backšg-dev.h
>

30 
	~<lšux/mouÁ.h
>

31 
	~<lšux/m·ge.h
>

32 
	~<lšux/sw­.h
>

33 
	~<lšux/wr™eback.h
>

34 
	~<lšux/¡©fs.h
>

35 
	~<lšux/com·t.h
>

36 
	~<lšux/·r£r.h
>

37 
	~<lšux/ùy³.h
>

38 
	~<lšux/Çmei.h
>

39 
	~<lšux/miscdeviû.h
>

40 
	~<lšux/magic.h
>

41 
	~<lšux/¦ab.h
>

42 
	~<lšux/þ—nÿche.h
>

43 
	~<lšux/¿‹lim™.h
>

44 
	~<lšux/bŒfs.h
>

45 
	~"d–ayed-šode.h
"

46 
	~"ù»e.h
"

47 
	~"disk-io.h
"

48 
	~"Œª§ùiÚ.h
"

49 
	~"bŒfs_šode.h
"

50 
	~"´št-Œ“.h
"

51 
	~"hash.h
"

52 
	~"´Ýs.h
"

53 
	~"x©Œ.h
"

54 
	~"vÞumes.h
"

55 
	~"expÜt.h
"

56 
	~"com´essiÚ.h
"

57 
	~"rcu-¡ršg.h
"

58 
	~"dev-»¶aû.h
"

59 
	~"ä“-¥aû-ÿche.h
"

60 
	~"back»f.h
"

61 
	~"‹¡s/bŒfs-‹¡s.h
"

63 
	~"qgroup.h
"

64 
	~"back»f.h
"

65 
	#CREATE_TRACE_POINTS


	)

66 
	~<Œaû/ev’ts/bŒfs.h
>

68 cÚ¡ 
su³r_Ý”©iÚs
 
	gbŒfs_su³r_Ýs
;

69 
fže_sy¡em_ty³
 
	gbŒfs_fs_ty³
;

71 
bŒfs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
);

73 cÚ¡ *
	$bŒfs_decode_”rÜ
(
”ºo
)

75 *
”r¡r
 = "unknown";

77 
”ºo
) {

78 -
EIO
:

79 
”r¡r
 = "IO failure";

81 -
ENOMEM
:

82 
”r¡r
 = "Out of memory";

84 -
EROFS
:

85 
”r¡r
 = "Readonly filesystem";

87 -
EEXIST
:

88 
”r¡r
 = "Object‡lreadyƒxists";

90 -
ENOSPC
:

91 
”r¡r
 = "No space†eft";

93 -
ENOENT
:

94 
”r¡r
 = "No suchƒntry";

98  
”r¡r
;

99 
	}
}

102 
	$bŒfs_hªdË_”rÜ
(
bŒfs_fs_šfo
 *
fs_šfo
)

104 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

106 ià(
	`sb_rdÚly
(
sb
))

109 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

110 
sb
->
s_æags
 |ð
MS_RDONLY
;

111 
	`bŒfs_šfo
(
fs_šfo
, "forced„eadonly");

123 
	}
}

129 
__cÞd


130 
	$__bŒfs_hªdË_fs_”rÜ
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

131 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...)

133 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

134 #ifdeà
CONFIG_PRINTK


135 cÚ¡ *
”r¡r
;

142 ià(
”ºo
 =ð-
EROFS
 && 
	`sb_rdÚly
(
sb
))

145 #ifdeà
CONFIG_PRINTK


146 
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
”ºo
);

147 ià(
fmt
) {

148 
va_fÜm©
 
vaf
;

149 
va_li¡
 
¬gs
;

151 
	`va_¡¬t
(
¬gs
, 
fmt
);

152 
vaf
.
fmt
 = fmt;

153 
vaf
.
va
 = &
¬gs
;

155 
	`´_ü™
("BTRFS:ƒrror (device %s) in %s:%d:ƒrrno=%d %s (%pV)\n",

156 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
”ºo
, 
”r¡r
, &
vaf
);

157 
	`va_’d
(
¬gs
);

159 
	`´_ü™
("BTRFS:ƒrror (device %s) in %s:%d:ƒrrno=%d %s\n",

160 
sb
->
s_id
, 
funùiÚ
, 
lše
, 
”ºo
, 
”r¡r
);

168 
	`£t_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
);

171 ià(
sb
->
s_æags
 & 
MS_BORN
)

172 
	`bŒfs_hªdË_”rÜ
(
fs_šfo
);

173 
	}
}

175 #ifdeà
CONFIG_PRINTK


176 cÚ¡ * cÚ¡ 
	glogty³s
[] = {

192 
¿‹lim™_¡©e
 
	g´štk_lim™s
[] = {

193 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[0], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

194 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[1], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

195 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[2], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

196 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[3], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

197 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[4], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

198 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[5], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

199 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[6], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

200 
RATELIMIT_STATE_INIT
(
´štk_lim™s
[7], 
DEFAULT_RATELIMIT_INTERVAL
, 100),

203 
	$bŒfs_´štk
(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
fmt
, ...)

205 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

206 
lvl
[
PRINTK_MAX_SINGLE_HEADER_LEN
 + 1] = "\0";

207 
va_fÜm©
 
vaf
;

208 
va_li¡
 
¬gs
;

209 
k”n_Ëv–
;

210 cÚ¡ *
ty³
 = 
logty³s
[4];

211 
¿‹lim™_¡©e
 *
¿‹lim™
 = &
´štk_lim™s
[4];

213 
	`va_¡¬t
(
¬gs
, 
fmt
);

215 (
k”n_Ëv–
 = 
	`´štk_g‘_Ëv–
(
fmt
)) != 0) {

216 
size_t
 
size
 = 
	`´štk_sk_Ëv–
(
fmt
) - fmt;

218 ià(
k”n_Ëv–
 >= '0' && kern_level <= '7') {

219 
	`memýy
(
lvl
, 
fmt
, 
size
);

220 
lvl
[
size
] = '\0';

221 
ty³
 = 
logty³s
[
k”n_Ëv–
 - '0'];

222 
¿‹lim™
 = &
´štk_lim™s
[
k”n_Ëv–
 - '0'];

224 
fmt
 +ð
size
;

227 
vaf
.
fmt
 = fmt;

228 
vaf
.
va
 = &
¬gs
;

230 ià(
	`__¿‹lim™
(
¿‹lim™
))

231 
	`´štk
("%sBTRFS % (deviû %s): %pV\n", 
lvl
, 
ty³
, 
sb
->
s_id
, &
vaf
);

233 
	`va_’d
(
¬gs
);

234 
	}
}

250 
__cÞd


251 
	$__bŒfs_abÜt_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

252 cÚ¡ *
funùiÚ
,

253 
lše
, 
”ºo
)

255 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

257 
Œªs
->
abÜ‹d
 = 
”ºo
;

260 ià(!
Œªs
->
dœty
 && 
	`li¡_em±y
(&Œªs->
Ãw_bgs
)) {

261 cÚ¡ *
”r¡r
;

263 
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
”ºo
);

264 
	`bŒfs_w¬n
(
fs_šfo
,

266 
funùiÚ
, 
lše
, 
”r¡r
);

269 
	`WRITE_ONCE
(
Œªs
->
Œª§ùiÚ
->
abÜ‹d
, 
”ºo
);

271 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

272 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

273 
	`__bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
funùiÚ
, 
lše
, 
”ºo
, 
NULL
);

274 
	}
}

279 
__cÞd


280 
	$__bŒfs_·nic
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,

281 
lše
, 
”ºo
, cÚ¡ *
fmt
, ...)

283 *
s_id
 = "<unknown>";

284 cÚ¡ *
”r¡r
;

285 
va_fÜm©
 
vaf
 = { .
fmt
 = fmt };

286 
va_li¡
 
¬gs
;

288 ià(
fs_šfo
)

289 
s_id
 = 
fs_šfo
->
sb
->s_id;

291 
	`va_¡¬t
(
¬gs
, 
fmt
);

292 
vaf
.
va
 = &
¬gs
;

294 
”r¡r
 = 
	`bŒfs_decode_”rÜ
(
”ºo
);

295 ià(
fs_šfo
 && (fs_šfo->
mouÁ_Ýt
 & 
BTRFS_MOUNT_PANIC_ON_FATAL_ERROR
))

296 
	`·nic
(
KERN_CRIT
 "BTRFS…anic (device %s) in %s:%d: %pV (errno=%d %s)\n",

297 
s_id
, 
funùiÚ
, 
lše
, &
vaf
, 
”ºo
, 
”r¡r
);

299 
	`bŒfs_ü™
(
fs_šfo
, "panic in %s:%d: %pV (errno=%d %s)",

300 
funùiÚ
, 
lše
, &
vaf
, 
”ºo
, 
”r¡r
);

301 
	`va_’d
(
¬gs
);

303 
	}
}

305 
	$bŒfs_put_su³r
(
su³r_block
 *
sb
)

307 
	`þo£_ù»e
(
	`bŒfs_sb
(
sb
));

308 
	}
}

311 
	mO±_deg¿ded
, 
	mO±_subvÞ
, 
	mO±_subvÞid
, 
	mO±_deviû
, 
	mO±_nod©asum
,

312 
	mO±_nod©acow
, 
	mO±_max_šlše
, 
	mO±_®loc_¡¬t
, 
	mO±_nob¬r›r
, 
	mO±_ssd
,

313 
	mO±_nossd
, 
	mO±_ssd_¥»ad
, 
	mO±_th»ad_poÞ
, 
	mO±_nßþ
, 
	mO±_com´ess
,

314 
	mO±_com´ess_ty³
, 
	mO±_com´ess_fÜû
, 
	mO±_com´ess_fÜû_ty³
,

315 
	mO±_nÙ»–og
, 
	mO±_¿tio
, 
	mO±_æushÚcomm™
, 
	mO±_disÿrd
,

316 
	mO±_¥aû_ÿche
, 
	mO±_¥aû_ÿche_v”siÚ
, 
	mO±_þ—r_ÿche
,

317 
	mO±_u£r_subvÞ_rm_®lowed
, 
	mO±_’o¥c_debug
, 
	mO±_subvÞroÙid
,

318 
	mO±_deäag
, 
	mO±_šode_ÿche
, 
	mO±_no_¥aû_ÿche
, 
	mO±_»cov”y
,

319 
	mO±_sk_b®ªû
, 
	mO±_check_š‹gr™y
,

320 
	mO±_check_š‹gr™y_šþudšg_ex‹Á_d©a
,

321 
	mO±_check_š‹gr™y_´št_mask
, 
	mO±_çl_”rÜs
, 
	mO±_»sÿn_uuid_Œ“
,

322 
	mO±_comm™_š‹rv®
, 
	mO±_b¬r›r
, 
	mO±_nodeäag
, 
	mO±_nodisÿrd
,

323 
	mO±_nÛno¥c_debug
, 
	mO±_noæushÚcomm™
, 
	mO±_aþ
, 
	mO±_d©acow
,

324 
	mO±_d©asum
, 
	mO±_Œ“log
, 
	mO±_nošode_ÿche
, 
	mO±_u£backu´oÙ
,

325 
	mO±_nÞog»¶ay
, 
	mO±_nÜecov”y
,

326 #ifdeà
CONFIG_BTRFS_DEBUG


327 
	mO±_äagm’t_d©a
, 
	mO±_äagm’t_m‘ad©a
, 
	mO±_äagm’t_®l
,

329 
	mO±_”r
,

332 cÚ¡ 
m©ch_bË_t
 
	gtok’s
 = {

333 {
O±_deg¿ded
, "degraded"},

334 {
O±_subvÞ
, "subvol=%s"},

335 {
O±_subvÞid
, "subvolid=%s"},

336 {
O±_deviû
, "device=%s"},

337 {
O±_nod©asum
, "nodatasum"},

338 {
O±_d©asum
, "datasum"},

339 {
O±_nod©acow
, "nodatacow"},

340 {
O±_d©acow
, "datacow"},

341 {
O±_nob¬r›r
, "nobarrier"},

342 {
O±_b¬r›r
, "barrier"},

343 {
O±_max_šlše
, "max_inline=%s"},

344 {
O±_®loc_¡¬t
, "alloc_start=%s"},

345 {
O±_th»ad_poÞ
, "thread_pool=%d"},

346 {
O±_com´ess
, "compress"},

347 {
O±_com´ess_ty³
, "compress=%s"},

348 {
O±_com´ess_fÜû
, "compress-force"},

349 {
O±_com´ess_fÜû_ty³
, "compress-force=%s"},

350 {
O±_ssd
, "ssd"},

351 {
O±_ssd_¥»ad
, "ssd_spread"},

352 {
O±_nossd
, "nossd"},

353 {
O±_aþ
, "acl"},

354 {
O±_nßþ
, "noacl"},

355 {
O±_nÙ»–og
, "notreelog"},

356 {
O±_Œ“log
, "treelog"},

357 {
O±_nÞog»¶ay
, "nologreplay"},

358 {
O±_nÜecov”y
, "norecovery"},

359 {
O±_æushÚcomm™
, "flushoncommit"},

360 {
O±_noæushÚcomm™
, "noflushoncommit"},

361 {
O±_¿tio
, "metadata_ratio=%d"},

362 {
O±_disÿrd
, "discard"},

363 {
O±_nodisÿrd
, "nodiscard"},

364 {
O±_¥aû_ÿche
, "space_cache"},

365 {
O±_¥aû_ÿche_v”siÚ
, "space_cache=%s"},

366 {
O±_þ—r_ÿche
, "clear_cache"},

367 {
O±_u£r_subvÞ_rm_®lowed
, "user_subvol_rm_allowed"},

368 {
O±_’o¥c_debug
, "enospc_debug"},

369 {
O±_nÛno¥c_debug
, "noenospc_debug"},

370 {
O±_subvÞroÙid
, "subvolrootid=%d"},

371 {
O±_deäag
, "autodefrag"},

372 {
O±_nodeäag
, "noautodefrag"},

373 {
O±_šode_ÿche
, "inode_cache"},

374 {
O±_nošode_ÿche
, "noinode_cache"},

375 {
O±_no_¥aû_ÿche
, "nospace_cache"},

376 {
O±_»cov”y
, "recovery"},

377 {
O±_u£backu´oÙ
, "usebackuproot"},

378 {
O±_sk_b®ªû
, "skip_balance"},

379 {
O±_check_š‹gr™y
, "check_int"},

380 {
O±_check_š‹gr™y_šþudšg_ex‹Á_d©a
, "check_int_data"},

381 {
O±_check_š‹gr™y_´št_mask
, "check_int_print_mask=%d"},

382 {
O±_»sÿn_uuid_Œ“
, "rescan_uuid_tree"},

383 {
O±_çl_”rÜs
, "fatal_errors=%s"},

384 {
O±_comm™_š‹rv®
, "commit=%d"},

385 #ifdeà
CONFIG_BTRFS_DEBUG


386 {
O±_äagm’t_d©a
, "fragment=data"},

387 {
O±_äagm’t_m‘ad©a
, "fragment=metadata"},

388 {
O±_äagm’t_®l
, "fragment=all"},

390 {
O±_”r
, 
NULL
},

398 
	$bŒfs_·r£_ÝtiÚs
(
bŒfs_fs_šfo
 *
šfo
, *
ÝtiÚs
,

399 
Ãw_æags
)

401 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

402 *
p
, *
num
, *
Üig
 = 
NULL
;

403 
u64
 
ÿche_g’
;

404 
šrg
;

405 
»t
 = 0;

406 *
com´ess_ty³
;

407 
boÞ
 
com´ess_fÜû
 = 
çl£
;

408 
bŒfs_com´essiÚ_ty³
 
§ved_com´ess_ty³
;

409 
boÞ
 
§ved_com´ess_fÜû
;

410 
no_com´ess
 = 0;

412 
ÿche_g’
 = 
	`bŒfs_su³r_ÿche_g’”©iÚ
(
šfo
->
su³r_cÝy
);

413 ià(
	`bŒfs_fs_com·t_ro
(
šfo
, 
FREE_SPACE_TREE
))

414 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
FREE_SPACE_TREE
);

415 ià(
ÿche_g’
)

416 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
SPACE_CACHE
);

422 ià(!
ÝtiÚs
)

423 
check
;

429 
ÝtiÚs
 = 
	`k¡rdup
(ÝtiÚs, 
GFP_KERNEL
);

430 ià(!
ÝtiÚs
)

431  -
ENOMEM
;

433 
Üig
 = 
ÝtiÚs
;

435 (
p
 = 
	`¡r£p
(&
ÝtiÚs
, ",")è!ð
NULL
) {

436 
tok’
;

437 ià(!*
p
)

440 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

441 
tok’
) {

442 
O±_deg¿ded
:

443 
	`bŒfs_šfo
(
šfo
, "allowing degraded mounts");

444 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
DEGRADED
);

446 
O±_subvÞ
:

447 
O±_subvÞid
:

448 
O±_subvÞroÙid
:

449 
O±_deviû
:

455 
O±_nod©asum
:

456 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NODATASUM
,

459 
O±_d©asum
:

460 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NODATASUM
)) {

461 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NODATACOW
))

462 
	`bŒfs_šfo
(
šfo
,

465 
	`bŒfs_šfo
(
šfo
, "setting datasum");

467 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATACOW
);

468 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATASUM
);

470 
O±_nod©acow
:

471 ià(!
	`bŒfs_‹¡_Ýt
(
šfo
, 
NODATACOW
)) {

472 ià(!
	`bŒfs_‹¡_Ýt
(
šfo
, 
COMPRESS
) ||

473 !
	`bŒfs_‹¡_Ýt
(
šfo
, 
FORCE_COMPRESS
)) {

474 
	`bŒfs_šfo
(
šfo
,

477 
	`bŒfs_šfo
(
šfo
, "setting‚odatacow");

480 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
COMPRESS
);

481 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
FORCE_COMPRESS
);

482 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATACOW
);

483 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATASUM
);

485 
O±_d©acow
:

486 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
NODATACOW
,

489 
O±_com´ess_fÜû
:

490 
O±_com´ess_fÜû_ty³
:

491 
com´ess_fÜû
 = 
Œue
;

493 
O±_com´ess
:

494 
O±_com´ess_ty³
:

495 
§ved_com´ess_ty³
 = 
	`bŒfs_‹¡_Ýt
(
šfo
,

496 
COMPRESS
) ?

497 
šfo
->
com´ess_ty³
 : 
BTRFS_COMPRESS_NONE
;

498 
§ved_com´ess_fÜû
 =

499 
	`bŒfs_‹¡_Ýt
(
šfo
, 
FORCE_COMPRESS
);

500 ià(
tok’
 =ð
O±_com´ess
 ||

501 
tok’
 =ð
O±_com´ess_fÜû
 ||

502 
	`¡ºcmp
(
¬gs
[0].
äom
, "zlib", 4) == 0) {

503 
com´ess_ty³
 = "zlib";

504 
šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZLIB
;

505 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
COMPRESS
);

506 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATACOW
);

507 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATASUM
);

508 
no_com´ess
 = 0;

509 } ià(
	`¡ºcmp
(
¬gs
[0].
äom
, "lzo", 3) == 0) {

510 
com´ess_ty³
 = "lzo";

511 
šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_LZO
;

512 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
COMPRESS
);

513 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATACOW
);

514 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATASUM
);

515 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
COMPRESS_LZO
);

516 
no_com´ess
 = 0;

517 } ià(
	`¡rcmp
(
¬gs
[0].
äom
, "zstd") == 0) {

518 
com´ess_ty³
 = "zstd";

519 
šfo
->
com´ess_ty³
 = 
BTRFS_COMPRESS_ZSTD
;

520 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
COMPRESS
);

521 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATACOW
);

522 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NODATASUM
);

523 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
COMPRESS_ZSTD
);

524 
no_com´ess
 = 0;

525 } ià(
	`¡ºcmp
(
¬gs
[0].
äom
, "no", 2) == 0) {

526 
com´ess_ty³
 = "no";

527 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
COMPRESS
);

528 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
FORCE_COMPRESS
);

529 
com´ess_fÜû
 = 
çl£
;

530 
no_com´ess
++;

532 
»t
 = -
EINVAL
;

533 
out
;

536 ià(
com´ess_fÜû
) {

537 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
FORCE_COMPRESS
);

545 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
FORCE_COMPRESS
);

547 ià((
	`bŒfs_‹¡_Ýt
(
šfo
, 
COMPRESS
) &&

548 (
šfo
->
com´ess_ty³
 !ð
§ved_com´ess_ty³
 ||

549 
com´ess_fÜû
 !ð
§ved_com´ess_fÜû
)) ||

550 (!
	`bŒfs_‹¡_Ýt
(
šfo
, 
COMPRESS
) &&

551 
no_com´ess
 == 1)) {

552 
	`bŒfs_šfo
(
šfo
, "%s %s compression",

553 (
com´ess_fÜû
) ? "force" : "use",

554 
com´ess_ty³
);

556 
com´ess_fÜû
 = 
çl£
;

558 
O±_ssd
:

559 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SSD
,

561 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NOSSD
);

563 
O±_ssd_¥»ad
:

564 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SSD
,

566 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SSD_SPREAD
,

568 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
NOSSD
);

570 
O±_nossd
:

571 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
NOSSD
);

572 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
SSD
,

574 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
SSD_SPREAD
,

577 
O±_b¬r›r
:

578 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
NOBARRIER
,

581 
O±_nob¬r›r
:

582 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOBARRIER
,

585 
O±_th»ad_poÞ
:

586 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

587 ià(
»t
) {

588 
out
;

589 } ià(
šrg
 > 0) {

590 
šfo
->
th»ad_poÞ_size
 = 
šrg
;

592 
»t
 = -
EINVAL
;

593 
out
;

596 
O±_max_šlše
:

597 
num
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

598 ià(
num
) {

599 
šfo
->
max_šlše
 = 
	`mem·r£
(
num
, 
NULL
);

600 
	`kä“
(
num
);

602 ià(
šfo
->
max_šlše
) {

603 
šfo
->
max_šlše
 = 
	`mš_t
(
u64
,

604 
šfo
->
max_šlše
,

605 
šfo
->
£ùÜsize
);

607 
	`bŒfs_šfo
(
šfo
, "max_inline‡t %llu",

608 
šfo
->
max_šlše
);

610 
»t
 = -
ENOMEM
;

611 
out
;

614 
O±_®loc_¡¬t
:

615 
	`bŒfs_šfo
(
šfo
,

618 
O±_aþ
:

619 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


620 
šfo
->
sb
->
s_æags
 |ð
MS_POSIXACL
;

623 
	`bŒfs_”r
(
šfo
, "support for ACL‚ot compiled in!");

624 
»t
 = -
EINVAL
;

625 
out
;

627 
O±_nßþ
:

628 
šfo
->
sb
->
s_æags
 &ð~
MS_POSIXACL
;

630 
O±_nÙ»–og
:

631 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOTREELOG
,

634 
O±_Œ“log
:

635 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
NOTREELOG
,

638 
O±_nÜecov”y
:

639 
O±_nÞog»¶ay
:

640 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
NOLOGREPLAY
,

643 
O±_æushÚcomm™
:

644 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
FLUSHONCOMMIT
,

647 
O±_noæushÚcomm™
:

648 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
FLUSHONCOMMIT
,

651 
O±_¿tio
:

652 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

653 ià(
»t
) {

654 
out
;

655 } ià(
šrg
 >= 0) {

656 
šfo
->
m‘ad©a_¿tio
 = 
šrg
;

657 
	`bŒfs_šfo
(
šfo
, "metadata„atio %d",

658 
šfo
->
m‘ad©a_¿tio
);

660 
»t
 = -
EINVAL
;

661 
out
;

664 
O±_disÿrd
:

665 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
DISCARD
,

668 
O±_nodisÿrd
:

669 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
DISCARD
,

672 
O±_¥aû_ÿche
:

673 
O±_¥aû_ÿche_v”siÚ
:

674 ià(
tok’
 =ð
O±_¥aû_ÿche
 ||

675 
	`¡rcmp
(
¬gs
[0].
äom
, "v1") == 0) {

676 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
,

677 
FREE_SPACE_TREE
);

678 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
SPACE_CACHE
,

680 } ià(
	`¡rcmp
(
¬gs
[0].
äom
, "v2") == 0) {

681 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
,

682 
SPACE_CACHE
);

683 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
FREE_SPACE_TREE
,

686 
»t
 = -
EINVAL
;

687 
out
;

690 
O±_»sÿn_uuid_Œ“
:

691 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
RESCAN_UUID_TREE
);

693 
O±_no_¥aû_ÿche
:

694 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SPACE_CACHE
)) {

695 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
SPACE_CACHE
,

698 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
FREE_SPACE_TREE
)) {

699 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
FREE_SPACE_TREE
,

703 
O±_šode_ÿche
:

704 
	`bŒfs_£t_³ndšg_ªd_šfo
(
šfo
, 
INODE_MAP_CACHE
,

707 
O±_nošode_ÿche
:

708 
	`bŒfs_þ—r_³ndšg_ªd_šfo
(
šfo
, 
INODE_MAP_CACHE
,

711 
O±_þ—r_ÿche
:

712 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
CLEAR_CACHE
,

715 
O±_u£r_subvÞ_rm_®lowed
:

716 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
USER_SUBVOL_RM_ALLOWED
);

718 
O±_’o¥c_debug
:

719 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
ENOSPC_DEBUG
);

721 
O±_nÛno¥c_debug
:

722 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
, 
ENOSPC_DEBUG
);

724 
O±_deäag
:

725 
	`bŒfs_£t_ªd_šfo
(
šfo
, 
AUTO_DEFRAG
,

728 
O±_nodeäag
:

729 
	`bŒfs_þ—r_ªd_šfo
(
šfo
, 
AUTO_DEFRAG
,

732 
O±_»cov”y
:

733 
	`bŒfs_w¬n
(
šfo
,

735 
O±_u£backu´oÙ
:

736 
	`bŒfs_šfo
(
šfo
,

738 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
USEBACKUPROOT
);

740 
O±_sk_b®ªû
:

741 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
SKIP_BALANCE
);

743 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


744 
O±_check_š‹gr™y_šþudšg_ex‹Á_d©a
:

745 
	`bŒfs_šfo
(
šfo
,

747 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
,

748 
CHECK_INTEGRITY_INCLUDING_EXTENT_DATA
);

749 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
CHECK_INTEGRITY
);

751 
O±_check_š‹gr™y
:

752 
	`bŒfs_šfo
(
šfo
, "enabling check integrity");

753 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
CHECK_INTEGRITY
);

755 
O±_check_š‹gr™y_´št_mask
:

756 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

757 ià(
»t
) {

758 
out
;

759 } ià(
šrg
 >= 0) {

760 
šfo
->
check_š‹gr™y_´št_mask
 = 
šrg
;

761 
	`bŒfs_šfo
(
šfo
,

763 
šfo
->
check_š‹gr™y_´št_mask
);

765 
»t
 = -
EINVAL
;

766 
out
;

770 
O±_check_š‹gr™y_šþudšg_ex‹Á_d©a
:

771 
O±_check_š‹gr™y
:

772 
O±_check_š‹gr™y_´št_mask
:

773 
	`bŒfs_”r
(
šfo
,

775 
»t
 = -
EINVAL
;

776 
out
;

778 
O±_çl_”rÜs
:

779 ià(
	`¡rcmp
(
¬gs
[0].
äom
, "panic") == 0)

780 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
,

781 
PANIC_ON_FATAL_ERROR
);

782 ià(
	`¡rcmp
(
¬gs
[0].
äom
, "bug") == 0)

783 
	`bŒfs_þ—r_Ýt
(
šfo
->
mouÁ_Ýt
,

784 
PANIC_ON_FATAL_ERROR
);

786 
»t
 = -
EINVAL
;

787 
out
;

790 
O±_comm™_š‹rv®
:

791 
šrg
 = 0;

792 
»t
 = 
	`m©ch_št
(&
¬gs
[0], &
šrg
);

793 ià(
»t
 < 0) {

794 
	`bŒfs_”r
(
šfo
, "invalid commit interval");

795 
»t
 = -
EINVAL
;

796 
out
;

798 ià(
šrg
 > 0) {

799 ià(
šrg
 > 300) {

800 
	`bŒfs_w¬n
(
šfo
,

802 
šrg
);

804 
šfo
->
comm™_š‹rv®
 = 
šrg
;

806 
	`bŒfs_šfo
(
šfo
,

808 
BTRFS_DEFAULT_COMMIT_INTERVAL
);

809 
šfo
->
comm™_š‹rv®
 = 
BTRFS_DEFAULT_COMMIT_INTERVAL
;

812 #ifdeà
CONFIG_BTRFS_DEBUG


813 
O±_äagm’t_®l
:

814 
	`bŒfs_šfo
(
šfo
, "fragmenting‡ll space");

815 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
FRAGMENT_DATA
);

816 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
FRAGMENT_METADATA
);

818 
O±_äagm’t_m‘ad©a
:

819 
	`bŒfs_šfo
(
šfo
, "fragmenting metadata");

820 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
,

821 
FRAGMENT_METADATA
);

823 
O±_äagm’t_d©a
:

824 
	`bŒfs_šfo
(
šfo
, "fragmenting data");

825 
	`bŒfs_£t_Ýt
(
šfo
->
mouÁ_Ýt
, 
FRAGMENT_DATA
);

828 
O±_”r
:

829 
	`bŒfs_šfo
(
šfo
, "uÄecognized mouÁ o±iÚ '%s'", 
p
);

830 
»t
 = -
EINVAL
;

831 
out
;

836 
check
:

840 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NOLOGREPLAY
è&& !(
Ãw_æags
 & 
MS_RDONLY
)) {

841 
	`bŒfs_”r
(
šfo
,

843 
»t
 = -
EINVAL
;

845 
out
:

846 ià(
	`bŒfs_fs_com·t_ro
(
šfo
, 
FREE_SPACE_TREE
) &&

847 !
	`bŒfs_‹¡_Ýt
(
šfo
, 
FREE_SPACE_TREE
) &&

848 !
	`bŒfs_‹¡_Ýt
(
šfo
, 
CLEAR_CACHE
)) {

849 
	`bŒfs_”r
(
šfo
, "cannot disable free spaceree");

850 
»t
 = -
EINVAL
;

853 ià(!
»t
 && 
	`bŒfs_‹¡_Ýt
(
šfo
, 
SPACE_CACHE
))

854 
	`bŒfs_šfo
(
šfo
, "disk space caching isƒnabled");

855 ià(!
»t
 && 
	`bŒfs_‹¡_Ýt
(
šfo
, 
FREE_SPACE_TREE
))

856 
	`bŒfs_šfo
(
šfo
, "using free spaceree");

857 
	`kä“
(
Üig
);

858  
»t
;

859 
	}
}

867 
	$bŒfs_·r£_—¾y_ÝtiÚs
(cÚ¡ *
ÝtiÚs
, 
fmode_t
 
æags
,

868 *
hÞd”
, **
subvÞ_Çme
, 
u64
 *
subvÞ_objeùid
,

869 
bŒfs_fs_deviûs
 **
fs_deviûs
)

871 
sub¡ršg_t
 
¬gs
[
MAX_OPT_ARGS
];

872 *
deviû_Çme
, *
Ýts
, *
Üig
, *
p
;

873 *
num
 = 
NULL
;

874 
”rÜ
 = 0;

876 ià(!
ÝtiÚs
)

883 
Ýts
 = 
	`k¡rdup
(
ÝtiÚs
, 
GFP_KERNEL
);

884 ià(!
Ýts
)

885  -
ENOMEM
;

886 
Üig
 = 
Ýts
;

888 (
p
 = 
	`¡r£p
(&
Ýts
, ",")è!ð
NULL
) {

889 
tok’
;

890 ià(!*
p
)

893 
tok’
 = 
	`m©ch_tok’
(
p
, 
tok’s
, 
¬gs
);

894 
tok’
) {

895 
O±_subvÞ
:

896 
	`kä“
(*
subvÞ_Çme
);

897 *
subvÞ_Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

898 ià(!*
subvÞ_Çme
) {

899 
”rÜ
 = -
ENOMEM
;

900 
out
;

903 
O±_subvÞid
:

904 
num
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

905 ià(
num
) {

906 *
subvÞ_objeùid
 = 
	`mem·r£
(
num
, 
NULL
);

907 
	`kä“
(
num
);

909 ià(!*
subvÞ_objeùid
)

910 *
subvÞ_objeùid
 =

911 
BTRFS_FS_TREE_OBJECTID
;

913 
”rÜ
 = -
EINVAL
;

914 
out
;

917 
O±_subvÞroÙid
:

918 
	`´_w¬n
("BTRFS: 'subvolrootid' mount option is deprecated‡nd has‚oƒffect\n");

920 
O±_deviû
:

921 
deviû_Çme
 = 
	`m©ch_¡rdup
(&
¬gs
[0]);

922 ià(!
deviû_Çme
) {

923 
”rÜ
 = -
ENOMEM
;

924 
out
;

926 
”rÜ
 = 
	`bŒfs_sÿn_Úe_deviû
(
deviû_Çme
,

927 
æags
, 
hÞd”
, 
fs_deviûs
);

928 
	`kä“
(
deviû_Çme
);

929 ià(
”rÜ
)

930 
out
;

937 
out
:

938 
	`kä“
(
Üig
);

939  
”rÜ
;

940 
	}
}

942 *
	$g‘_subvÞ_Çme_äom_objeùid
(
bŒfs_fs_šfo
 *
fs_šfo
,

943 
u64
 
subvÞ_objeùid
)

945 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

946 
bŒfs_roÙ
 *
fs_roÙ
;

947 
bŒfs_roÙ_»f
 *
roÙ_»f
;

948 
bŒfs_šode_»f
 *
šode_»f
;

949 
bŒfs_key
 
key
;

950 
bŒfs_·th
 *
·th
 = 
NULL
;

951 *
Çme
 = 
NULL
, *
±r
;

952 
u64
 
dœid
;

953 
Ën
;

954 
»t
;

956 
·th
 = 
	`bŒfs_®loc_·th
();

957 ià(!
·th
) {

958 
»t
 = -
ENOMEM
;

959 
”r
;

961 
·th
->
Ëave_¥šnšg
 = 1;

963 
Çme
 = 
	`km®loc
(
PATH_MAX
, 
GFP_KERNEL
);

964 ià(!
Çme
) {

965 
»t
 = -
ENOMEM
;

966 
”r
;

968 
±r
 = 
Çme
 + 
PATH_MAX
 - 1;

969 
±r
[0] = '\0';

975 
subvÞ_objeùid
 !ð
BTRFS_FS_TREE_OBJECTID
) {

976 
key
.
objeùid
 = 
subvÞ_objeùid
;

977 
key
.
ty³
 = 
BTRFS_ROOT_BACKREF_KEY
;

978 
key
.
off£t
 = (
u64
)-1;

980 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

981 ià(
»t
 < 0) {

982 
”r
;

983 } ià(
»t
 > 0) {

984 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
subvÞ_objeùid
,

985 
BTRFS_ROOT_BACKREF_KEY
);

986 ià(
»t
 < 0) {

987 
”r
;

988 } ià(
»t
 > 0) {

989 
»t
 = -
ENOENT
;

990 
”r
;

994 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

995 
subvÞ_objeùid
 = 
key
.
off£t
;

997 
roÙ_»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

998 
bŒfs_roÙ_»f
);

999 
Ën
 = 
	`bŒfs_roÙ_»f_Çme_Ën
(
·th
->
nodes
[0], 
roÙ_»f
);

1000 
±r
 -ð
Ën
 + 1;

1001 ià(
±r
 < 
Çme
) {

1002 
»t
 = -
ENAMETOOLONG
;

1003 
”r
;

1005 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
±r
 + 1,

1006 ()(
roÙ_»f
 + 1), 
Ën
);

1007 
±r
[0] = '/';

1008 
dœid
 = 
	`bŒfs_roÙ_»f_dœid
(
·th
->
nodes
[0], 
roÙ_»f
);

1009 
	`bŒfs_»Ëa£_·th
(
·th
);

1011 
key
.
objeùid
 = 
subvÞ_objeùid
;

1012 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1013 
key
.
off£t
 = (
u64
)-1;

1014 
fs_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

1015 ià(
	`IS_ERR
(
fs_roÙ
)) {

1016 
»t
 = 
	`PTR_ERR
(
fs_roÙ
);

1017 
”r
;

1024 
dœid
 !ð
BTRFS_FIRST_FREE_OBJECTID
) {

1025 
key
.
objeùid
 = 
dœid
;

1026 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1027 
key
.
off£t
 = (
u64
)-1;

1029 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_roÙ
, &
key
, 
·th
, 0, 0);

1030 ià(
»t
 < 0) {

1031 
”r
;

1032 } ià(
»t
 > 0) {

1033 
»t
 = 
	`bŒfs_´evious_™em
(
fs_roÙ
, 
·th
, 
dœid
,

1034 
BTRFS_INODE_REF_KEY
);

1035 ià(
»t
 < 0) {

1036 
”r
;

1037 } ià(
»t
 > 0) {

1038 
»t
 = -
ENOENT
;

1039 
”r
;

1043 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1044 
dœid
 = 
key
.
off£t
;

1046 
šode_»f
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],

1047 
·th
->
¦Ùs
[0],

1048 
bŒfs_šode_»f
);

1049 
Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0],

1050 
šode_»f
);

1051 
±r
 -ð
Ën
 + 1;

1052 ià(
±r
 < 
Çme
) {

1053 
»t
 = -
ENAMETOOLONG
;

1054 
”r
;

1056 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
±r
 + 1,

1057 ()(
šode_»f
 + 1), 
Ën
);

1058 
±r
[0] = '/';

1059 
	`bŒfs_»Ëa£_·th
(
·th
);

1063 
	`bŒfs_ä“_·th
(
·th
);

1064 ià(
±r
 =ð
Çme
 + 
PATH_MAX
 - 1) {

1065 
Çme
[0] = '/';

1066 
Çme
[1] = '\0';

1068 
	`memmove
(
Çme
, 
±r
,‚am+ 
PATH_MAX
 -…tr);

1070  
Çme
;

1072 
”r
:

1073 
	`bŒfs_ä“_·th
(
·th
);

1074 
	`kä“
(
Çme
);

1075  
	`ERR_PTR
(
»t
);

1076 
	}
}

1078 
	$g‘_deçuÉ_subvÞ_objeùid
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 *
objeùid
)

1080 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

1081 
bŒfs_dœ_™em
 *
di
;

1082 
bŒfs_·th
 *
·th
;

1083 
bŒfs_key
 
loÿtiÚ
;

1084 
u64
 
dœ_id
;

1086 
·th
 = 
	`bŒfs_®loc_·th
();

1087 ià(!
·th
)

1088  -
ENOMEM
;

1089 
·th
->
Ëave_¥šnšg
 = 1;

1096 
dœ_id
 = 
	`bŒfs_su³r_roÙ_dœ
(
fs_šfo
->
su³r_cÝy
);

1097 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
dœ_id
, "default", 7, 0);

1098 ià(
	`IS_ERR
(
di
)) {

1099 
	`bŒfs_ä“_·th
(
·th
);

1100  
	`PTR_ERR
(
di
);

1102 ià(!
di
) {

1108 
	`bŒfs_ä“_·th
(
·th
);

1109 *
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

1113 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
loÿtiÚ
);

1114 
	`bŒfs_ä“_·th
(
·th
);

1115 *
objeùid
 = 
loÿtiÚ
.objectid;

1117 
	}
}

1119 
	$bŒfs_fžl_su³r
(
su³r_block
 *
sb
,

1120 
bŒfs_fs_deviûs
 *
fs_deviûs
,

1121 *
d©a
)

1123 
šode
 *inode;

1124 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1125 
bŒfs_key
 
key
;

1126 
”r
;

1128 
sb
->
s_maxby‹s
 = 
MAX_LFS_FILESIZE
;

1129 
sb
->
s_magic
 = 
BTRFS_SUPER_MAGIC
;

1130 
sb
->
s_Ý
 = &
bŒfs_su³r_Ýs
;

1131 
sb
->
s_d_Ý
 = &
bŒfs_d’Œy_Ý”©iÚs
;

1132 
sb
->
s_expÜt_Ý
 = &
bŒfs_expÜt_Ýs
;

1133 
sb
->
s_x©Œ
 = 
bŒfs_x©Œ_hªdËrs
;

1134 
sb
->
s_time_g¿n
 = 1;

1135 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


1136 
sb
->
s_æags
 |ð
MS_POSIXACL
;

1138 
sb
->
s_æags
 |ð
SB_I_VERSION
;

1139 
sb
->
s_iæags
 |ð
SB_I_CGROUPWB
;

1141 
”r
 = 
	`su³r_£tup_bdi
(
sb
);

1142 ià(
”r
) {

1143 
	`bŒfs_”r
(
fs_šfo
, "super_setup_bdi failed");

1144  
”r
;

1147 
”r
 = 
	`Ý’_ù»e
(
sb
, 
fs_deviûs
, (*)
d©a
);

1148 ià(
”r
) {

1149 
	`bŒfs_”r
(
fs_šfo
, "open_ctree failed");

1150  
”r
;

1153 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

1154 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

1155 
key
.
off£t
 = 0;

1156 
šode
 = 
	`bŒfs_ig‘
(
sb
, &
key
, 
fs_šfo
->
fs_roÙ
, 
NULL
);

1157 ià(
	`IS_ERR
(
šode
)) {

1158 
”r
 = 
	`PTR_ERR
(
šode
);

1159 
çž_þo£
;

1162 
sb
->
s_roÙ
 = 
	`d_make_roÙ
(
šode
);

1163 ià(!
sb
->
s_roÙ
) {

1164 
”r
 = -
ENOMEM
;

1165 
çž_þo£
;

1168 
	`þ—nÿche_š™_fs
(
sb
);

1169 
sb
->
s_æags
 |ð
MS_ACTIVE
;

1172 
çž_þo£
:

1173 
	`þo£_ù»e
(
fs_šfo
);

1174  
”r
;

1175 
	}
}

1177 
	$bŒfs_sync_fs
(
su³r_block
 *
sb
, 
wa™
)

1179 
bŒfs_Œªs_hªdË
 *
Œªs
;

1180 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1181 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

1183 
	`Œaû_bŒfs_sync_fs
(
fs_šfo
, 
wa™
);

1185 ià(!
wa™
) {

1186 
	`fžem­_æush
(
fs_šfo
->
bŒ“_šode
->
i_m­pšg
);

1190 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

1192 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

1193 ià(
	`IS_ERR
(
Œªs
)) {

1195 ià(
	`PTR_ERR
(
Œªs
è=ð-
ENOENT
) {

1200 ià(
fs_šfo
->
³ndšg_chªges
 == 0)

1208 ià(
	`__sb_¡¬t_wr™e
(
sb
, 
SB_FREEZE_WRITE
, 
çl£
))

1209 
	`__sb_’d_wr™e
(
sb
, 
SB_FREEZE_WRITE
);

1212 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1214 ià(
	`IS_ERR
(
Œªs
))

1215  
	`PTR_ERR
(
Œªs
);

1217  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1218 
	}
}

1220 
	$bŒfs_show_ÝtiÚs
(
£q_fže
 *
£q
, 
d’Œy
 *dentry)

1222 
bŒfs_fs_šfo
 *
šfo
 = 
	`bŒfs_sb
(
d’Œy
->
d_sb
);

1223 *
com´ess_ty³
;

1225 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
DEGRADED
))

1226 
	`£q_puts
(
£q
, ",degraded");

1227 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NODATASUM
))

1228 
	`£q_puts
(
£q
, ",nodatasum");

1229 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NODATACOW
))

1230 
	`£q_puts
(
£q
, ",nodatacow");

1231 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NOBARRIER
))

1232 
	`£q_puts
(
£q
, ",nobarrier");

1233 ià(
šfo
->
max_šlše
 !ð
BTRFS_DEFAULT_MAX_INLINE
)

1234 
	`£q_´štf
(
£q
, ",max_šlše=%Îu", 
šfo
->
max_šlše
);

1235 ià(
šfo
->
th»ad_poÞ_size
 !ð
	`mš_t
(,

1236 
	`num_Úlše_ýus
() + 2, 8))

1237 
	`£q_´štf
(
£q
, ",th»ad_poÞ=%d", 
šfo
->
th»ad_poÞ_size
);

1238 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
COMPRESS
)) {

1239 ià(
šfo
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_ZLIB
)

1240 
com´ess_ty³
 = "zlib";

1241 ià(
šfo
->
com´ess_ty³
 =ð
BTRFS_COMPRESS_LZO
)

1242 
com´ess_ty³
 = "lzo";

1244 
com´ess_ty³
 = "zstd";

1245 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
FORCE_COMPRESS
))

1246 
	`£q_´štf
(
£q
, ",com´ess-fÜû=%s", 
com´ess_ty³
);

1248 
	`£q_´štf
(
£q
, ",com´ess=%s", 
com´ess_ty³
);

1250 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NOSSD
))

1251 
	`£q_puts
(
£q
, ",nossd");

1252 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SSD_SPREAD
))

1253 
	`£q_puts
(
£q
, ",ssd_spread");

1254 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SSD
))

1255 
	`£q_puts
(
£q
, ",ssd");

1256 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NOTREELOG
))

1257 
	`£q_puts
(
£q
, ",notreelog");

1258 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
NOLOGREPLAY
))

1259 
	`£q_puts
(
£q
, ",nologreplay");

1260 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
FLUSHONCOMMIT
))

1261 
	`£q_puts
(
£q
, ",flushoncommit");

1262 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
DISCARD
))

1263 
	`£q_puts
(
£q
, ",discard");

1264 ià(!(
šfo
->
sb
->
s_æags
 & 
MS_POSIXACL
))

1265 
	`£q_puts
(
£q
, ",noacl");

1266 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SPACE_CACHE
))

1267 
	`£q_puts
(
£q
, ",space_cache");

1268 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
FREE_SPACE_TREE
))

1269 
	`£q_puts
(
£q
, ",space_cache=v2");

1271 
	`£q_puts
(
£q
, ",nospace_cache");

1272 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
RESCAN_UUID_TREE
))

1273 
	`£q_puts
(
£q
, ",rescan_uuid_tree");

1274 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
CLEAR_CACHE
))

1275 
	`£q_puts
(
£q
, ",clear_cache");

1276 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
USER_SUBVOL_RM_ALLOWED
))

1277 
	`£q_puts
(
£q
, ",user_subvol_rm_allowed");

1278 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
ENOSPC_DEBUG
))

1279 
	`£q_puts
(
£q
, ",enospc_debug");

1280 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
AUTO_DEFRAG
))

1281 
	`£q_puts
(
£q
, ",autodefrag");

1282 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
INODE_MAP_CACHE
))

1283 
	`£q_puts
(
£q
, ",inode_cache");

1284 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
SKIP_BALANCE
))

1285 
	`£q_puts
(
£q
, ",skip_balance");

1286 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


1287 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
CHECK_INTEGRITY_INCLUDING_EXTENT_DATA
))

1288 
	`£q_puts
(
£q
, ",check_int_data");

1289 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
CHECK_INTEGRITY
))

1290 
	`£q_puts
(
£q
, ",check_int");

1291 ià(
šfo
->
check_š‹gr™y_´št_mask
)

1292 
	`£q_´štf
(
£q
, ",check_int_print_mask=%d",

1293 
šfo
->
check_š‹gr™y_´št_mask
);

1295 ià(
šfo
->
m‘ad©a_¿tio
)

1296 
	`£q_´štf
(
£q
, ",metadata_ratio=%d",

1297 
šfo
->
m‘ad©a_¿tio
);

1298 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
PANIC_ON_FATAL_ERROR
))

1299 
	`£q_puts
(
£q
, ",fatal_errors=panic");

1300 ià(
šfo
->
comm™_š‹rv®
 !ð
BTRFS_DEFAULT_COMMIT_INTERVAL
)

1301 
	`£q_´štf
(
£q
, ",comm™=%d", 
šfo
->
comm™_š‹rv®
);

1302 #ifdeà
CONFIG_BTRFS_DEBUG


1303 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
FRAGMENT_DATA
))

1304 
	`£q_puts
(
£q
, ",fragment=data");

1305 ià(
	`bŒfs_‹¡_Ýt
(
šfo
, 
FRAGMENT_METADATA
))

1306 
	`£q_puts
(
£q
, ",fragment=metadata");

1308 
	`£q_´štf
(
£q
, ",subvolid=%llu",

1309 
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
roÙ_key
.
objeùid
);

1310 
	`£q_puts
(
£q
, ",subvol=");

1311 
	`£q_d’Œy
(
£q
, 
d’Œy
, " \t\n\\");

1313 
	}
}

1315 
	$bŒfs_‹¡_su³r
(
su³r_block
 *
s
, *
d©a
)

1317 
bŒfs_fs_šfo
 *
p
 = 
d©a
;

1318 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
s
);

1320  
fs_šfo
->
fs_deviûs
 =ð
p
->fs_devices;

1321 
	}
}

1323 
	$bŒfs_£t_su³r
(
su³r_block
 *
s
, *
d©a
)

1325 
”r
 = 
	`£t_ªÚ_su³r
(
s
, 
d©a
);

1326 ià(!
”r
)

1327 
s
->
s_fs_šfo
 = 
d©a
;

1328  
”r
;

1329 
	}
}

1334 
šlše
 
	$is_subvÞume_šode
(
šode
 *inode)

1336 ià(
šode
 && inode->
i_šo
 =ð
BTRFS_FIRST_FREE_OBJECTID
)

1339 
	}
}

1346 *
	$£tup_roÙ_¬gs
(*
¬gs
)

1348 *
buf
, *
d¡
, *
£p
;

1350 ià(!
¬gs
)

1351  
	`k¡rdup
("subvÞid=0", 
GFP_KERNEL
);

1354 
buf
 = 
d¡
 = 
	`km®loc
(
	`¡¾’
(
¬gs
) + strlen(",subvolid=0") + 1,

1355 
GFP_KERNEL
);

1356 ià(!
buf
)

1357  
NULL
;

1360 
£p
 = 
	`¡rchºul
(
¬gs
, ',');

1361 ià(!
	`¡r¡¬ts
(
¬gs
, "subvol=") &&

1362 !
	`¡r¡¬ts
(
¬gs
, "subvolid=")) {

1363 
	`memýy
(
d¡
, 
¬gs
, 
£p
 -‡rgs);

1364 
d¡
 +ð
£p
 - 
¬gs
;

1365 *
d¡
++ = ',';

1367 ià(*
£p
)

1368 
¬gs
 = 
£p
 + 1;

1372 
	`¡rýy
(
d¡
, "subvolid=0");

1374  
buf
;

1375 
	}
}

1377 
d’Œy
 *
	$mouÁ_subvÞ
(cÚ¡ *
subvÞ_Çme
, 
u64
 
subvÞ_objeùid
,

1378 
æags
, cÚ¡ *
deviû_Çme
,

1379 *
d©a
)

1381 
d’Œy
 *
roÙ
;

1382 
vfsmouÁ
 *
mÁ
 = 
NULL
;

1383 *
Ãw¬gs
;

1384 
»t
;

1386 
Ãw¬gs
 = 
	`£tup_roÙ_¬gs
(
d©a
);

1387 ià(!
Ãw¬gs
) {

1388 
roÙ
 = 
	`ERR_PTR
(-
ENOMEM
);

1389 
out
;

1392 
mÁ
 = 
	`vfs_k”n_mouÁ
(&
bŒfs_fs_ty³
, 
æags
, 
deviû_Çme
, 
Ãw¬gs
);

1393 ià(
	`PTR_ERR_OR_ZERO
(
mÁ
è=ð-
EBUSY
) {

1394 ià(
æags
 & 
MS_RDONLY
) {

1395 
mÁ
 = 
	`vfs_k”n_mouÁ
(&
bŒfs_fs_ty³
, 
æags
 & ~
MS_RDONLY
,

1396 
deviû_Çme
, 
Ãw¬gs
);

1398 
mÁ
 = 
	`vfs_k”n_mouÁ
(&
bŒfs_fs_ty³
, 
æags
 | 
MS_RDONLY
,

1399 
deviû_Çme
, 
Ãw¬gs
);

1400 ià(
	`IS_ERR
(
mÁ
)) {

1401 
roÙ
 = 
	`ERR_CAST
(
mÁ
);

1402 
mÁ
 = 
NULL
;

1403 
out
;

1406 
	`down_wr™e
(&
mÁ
->
mÁ_sb
->
s_umouÁ
);

1407 
»t
 = 
	`bŒfs_»mouÁ
(
mÁ
->
mÁ_sb
, &
æags
, 
NULL
);

1408 
	`up_wr™e
(&
mÁ
->
mÁ_sb
->
s_umouÁ
);

1409 ià(
»t
 < 0) {

1410 
roÙ
 = 
	`ERR_PTR
(
»t
);

1411 
out
;

1415 ià(
	`IS_ERR
(
mÁ
)) {

1416 
roÙ
 = 
	`ERR_CAST
(
mÁ
);

1417 
mÁ
 = 
NULL
;

1418 
out
;

1421 ià(!
subvÞ_Çme
) {

1422 ià(!
subvÞ_objeùid
) {

1423 
»t
 = 
	`g‘_deçuÉ_subvÞ_objeùid
(
	`bŒfs_sb
(
mÁ
->
mÁ_sb
),

1424 &
subvÞ_objeùid
);

1425 ià(
»t
) {

1426 
roÙ
 = 
	`ERR_PTR
(
»t
);

1427 
out
;

1430 
subvÞ_Çme
 = 
	`g‘_subvÞ_Çme_äom_objeùid
(
	`bŒfs_sb
(
mÁ
->
mÁ_sb
),

1431 
subvÞ_objeùid
);

1432 ià(
	`IS_ERR
(
subvÞ_Çme
)) {

1433 
roÙ
 = 
	`ERR_CAST
(
subvÞ_Çme
);

1434 
subvÞ_Çme
 = 
NULL
;

1435 
out
;

1440 
roÙ
 = 
	`mouÁ_subŒ“
(
mÁ
, 
subvÞ_Çme
);

1442 
mÁ
 = 
NULL
;

1444 ià(!
	`IS_ERR
(
roÙ
)) {

1445 
su³r_block
 *
s
 = 
roÙ
->
d_sb
;

1446 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
s
);

1447 
šode
 *
roÙ_šode
 = 
	`d_šode
(
roÙ
);

1448 
u64
 
roÙ_objeùid
 = 
	`BTRFS_I
(
roÙ_šode
)->
roÙ
->
roÙ_key
.
objeùid
;

1450 
»t
 = 0;

1451 ià(!
	`is_subvÞume_šode
(
roÙ_šode
)) {

1452 
	`bŒfs_”r
(
fs_šfo
, "'%s' is‚ot‡ valid subvolume",

1453 
subvÞ_Çme
);

1454 
»t
 = -
EINVAL
;

1456 ià(
subvÞ_objeùid
 && 
roÙ_objeùid
 != subvol_objectid) {

1462 
	`bŒfs_”r
(
fs_šfo
,

1464 
subvÞ_Çme
, 
subvÞ_objeùid
);

1465 
»t
 = -
EINVAL
;

1467 ià(
»t
) {

1468 
	`dput
(
roÙ
);

1469 
roÙ
 = 
	`ERR_PTR
(
»t
);

1470 
	`d—ùiv©e_locked_su³r
(
s
);

1474 
out
:

1475 
	`mÁput
(
mÁ
);

1476 
	`kä“
(
Ãw¬gs
);

1477 
	`kä“
(
subvÞ_Çme
);

1478  
roÙ
;

1479 
	}
}

1481 
	$·r£_£cur™y_ÝtiÚs
(*
Üig_Ýts
,

1482 
£cur™y_mÁ_Ýts
 *
£c_Ýts
)

1484 *
£cd©a
 = 
NULL
;

1485 
»t
 = 0;

1487 
£cd©a
 = 
	`®loc_£cd©a
();

1488 ià(!
£cd©a
)

1489  -
ENOMEM
;

1490 
»t
 = 
	`£cur™y_sb_cÝy_d©a
(
Üig_Ýts
, 
£cd©a
);

1491 ià(
»t
) {

1492 
	`ä“_£cd©a
(
£cd©a
);

1493  
»t
;

1495 
»t
 = 
	`£cur™y_sb_·r£_Ýts_¡r
(
£cd©a
, 
£c_Ýts
);

1496 
	`ä“_£cd©a
(
£cd©a
);

1497  
»t
;

1498 
	}
}

1500 
	$£tup_£cur™y_ÝtiÚs
(
bŒfs_fs_šfo
 *
fs_šfo
,

1501 
su³r_block
 *
sb
,

1502 
£cur™y_mÁ_Ýts
 *
£c_Ýts
)

1504 
»t
 = 0;

1510 
»t
 = 
	`£cur™y_sb_£t_mÁ_Ýts
(
sb
, 
£c_Ýts
, 0, 
NULL
);

1511 ià(
»t
)

1512  
»t
;

1514 #ifdeà
CONFIG_SECURITY


1515 ià(!
fs_šfo
->
£cur™y_Ýts
.
num_mÁ_Ýts
) {

1517 
	`memýy
(&
fs_šfo
->
£cur™y_Ýts
, 
£c_Ýts
, (*sec_opts));

1525 
	`£cur™y_ä“_mÁ_Ýts
(
£c_Ýts
);

1528  
»t
;

1529 
	}
}

1537 
d’Œy
 *
	$bŒfs_mouÁ
(
fže_sy¡em_ty³
 *
fs_ty³
, 
æags
,

1538 cÚ¡ *
deviû_Çme
, *
d©a
)

1540 
block_deviû
 *
bdev
 = 
NULL
;

1541 
su³r_block
 *
s
;

1542 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
NULL
;

1543 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

1544 
£cur™y_mÁ_Ýts
 
Ãw_£c_Ýts
;

1545 
fmode_t
 
mode
 = 
FMODE_READ
;

1546 *
subvÞ_Çme
 = 
NULL
;

1547 
u64
 
subvÞ_objeùid
 = 0;

1548 
”rÜ
 = 0;

1550 ià(!(
æags
 & 
MS_RDONLY
))

1551 
mode
 |ð
FMODE_WRITE
;

1553 
”rÜ
 = 
	`bŒfs_·r£_—¾y_ÝtiÚs
(
d©a
, 
mode
, 
fs_ty³
,

1554 &
subvÞ_Çme
, &
subvÞ_objeùid
,

1555 &
fs_deviûs
);

1556 ià(
”rÜ
) {

1557 
	`kä“
(
subvÞ_Çme
);

1558  
	`ERR_PTR
(
”rÜ
);

1561 ià(
subvÞ_Çme
 || 
subvÞ_objeùid
 !ð
BTRFS_FS_TREE_OBJECTID
) {

1563  
	`mouÁ_subvÞ
(
subvÞ_Çme
, 
subvÞ_objeùid
, 
æags
,

1564 
deviû_Çme
, 
d©a
);

1567 
	`£cur™y_š™_mÁ_Ýts
(&
Ãw_£c_Ýts
);

1568 ià(
d©a
) {

1569 
”rÜ
 = 
	`·r£_£cur™y_ÝtiÚs
(
d©a
, &
Ãw_£c_Ýts
);

1570 ià(
”rÜ
)

1571  
	`ERR_PTR
(
”rÜ
);

1574 
”rÜ
 = 
	`bŒfs_sÿn_Úe_deviû
(
deviû_Çme
, 
mode
, 
fs_ty³
, &
fs_deviûs
);

1575 ià(
”rÜ
)

1576 
”rÜ_£c_Ýts
;

1584 
fs_šfo
 = 
	`kz®loc
((
bŒfs_fs_šfo
), 
GFP_KERNEL
);

1585 ià(!
fs_šfo
) {

1586 
”rÜ
 = -
ENOMEM
;

1587 
”rÜ_£c_Ýts
;

1590 
fs_šfo
->
fs_deviûs
 = fs_devices;

1592 
fs_šfo
->
su³r_cÝy
 = 
	`kz®loc
(
BTRFS_SUPER_INFO_SIZE
, 
GFP_KERNEL
);

1593 
fs_šfo
->
su³r_fÜ_comm™
 = 
	`kz®loc
(
BTRFS_SUPER_INFO_SIZE
, 
GFP_KERNEL
);

1594 
	`£cur™y_š™_mÁ_Ýts
(&
fs_šfo
->
£cur™y_Ýts
);

1595 ià(!
fs_šfo
->
su³r_cÝy
 || !fs_šfo->
su³r_fÜ_comm™
) {

1596 
”rÜ
 = -
ENOMEM
;

1597 
”rÜ_fs_šfo
;

1600 
”rÜ
 = 
	`bŒfs_Ý’_deviûs
(
fs_deviûs
, 
mode
, 
fs_ty³
);

1601 ià(
”rÜ
)

1602 
”rÜ_fs_šfo
;

1604 ià(!(
æags
 & 
MS_RDONLY
è&& 
fs_deviûs
->
rw_deviûs
 == 0) {

1605 
”rÜ
 = -
EACCES
;

1606 
”rÜ_þo£_deviûs
;

1609 
bdev
 = 
fs_deviûs
->
Ï‹¡_bdev
;

1610 
s
 = 
	`sg‘
(
fs_ty³
, 
bŒfs_‹¡_su³r
, 
bŒfs_£t_su³r
, 
æags
 | 
MS_NOSEC
,

1611 
fs_šfo
);

1612 ià(
	`IS_ERR
(
s
)) {

1613 
”rÜ
 = 
	`PTR_ERR
(
s
);

1614 
”rÜ_þo£_deviûs
;

1617 ià(
s
->
s_roÙ
) {

1618 
	`bŒfs_þo£_deviûs
(
fs_deviûs
);

1619 
	`ä“_fs_šfo
(
fs_šfo
);

1620 ià((
æags
 ^ 
s
->
s_æags
è& 
MS_RDONLY
)

1621 
”rÜ
 = -
EBUSY
;

1623 
	`¢´štf
(
s
->
s_id
, (s->s_id), "%pg", 
bdev
);

1624 
	`bŒfs_sb
(
s
)->
bdev_hÞd”
 = 
fs_ty³
;

1625 
”rÜ
 = 
	`bŒfs_fžl_su³r
(
s
, 
fs_deviûs
, 
d©a
);

1627 ià(
”rÜ
) {

1628 
	`d—ùiv©e_locked_su³r
(
s
);

1629 
”rÜ_£c_Ýts
;

1632 
fs_šfo
 = 
	`bŒfs_sb
(
s
);

1633 
”rÜ
 = 
	`£tup_£cur™y_ÝtiÚs
(
fs_šfo
, 
s
, &
Ãw_£c_Ýts
);

1634 ià(
”rÜ
) {

1635 
	`d—ùiv©e_locked_su³r
(
s
);

1636 
”rÜ_£c_Ýts
;

1639  
	`dg‘
(
s
->
s_roÙ
);

1641 
”rÜ_þo£_deviûs
:

1642 
	`bŒfs_þo£_deviûs
(
fs_deviûs
);

1643 
”rÜ_fs_šfo
:

1644 
	`ä“_fs_šfo
(
fs_šfo
);

1645 
”rÜ_£c_Ýts
:

1646 
	`£cur™y_ä“_mÁ_Ýts
(&
Ãw_£c_Ýts
);

1647  
	`ERR_PTR
(
”rÜ
);

1648 
	}
}

1650 
	$bŒfs_»size_th»ad_poÞ
(
bŒfs_fs_šfo
 *
fs_šfo
,

1651 
Ãw_poÞ_size
, 
Þd_poÞ_size
)

1653 ià(
Ãw_poÞ_size
 =ð
Þd_poÞ_size
)

1656 
fs_šfo
->
th»ad_poÞ_size
 = 
Ãw_poÞ_size
;

1658 
	`bŒfs_šfo
(
fs_šfo
, "resizehread…ool %d -> %d",

1659 
Þd_poÞ_size
, 
Ãw_poÞ_size
);

1661 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
wÜk”s
, 
Ãw_poÞ_size
);

1662 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
d–®loc_wÜk”s
, 
Ãw_poÞ_size
);

1663 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
subm™_wÜk”s
, 
Ãw_poÞ_size
);

1664 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
ÿchšg_wÜk”s
, 
Ãw_poÞ_size
);

1665 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_wÜk”s
, 
Ãw_poÞ_size
);

1666 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_m‘a_wÜk”s
, 
Ãw_poÞ_size
);

1667 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_m‘a_wr™e_wÜk”s
,

1668 
Ãw_poÞ_size
);

1669 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_wr™e_wÜk”s
, 
Ãw_poÞ_size
);

1670 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
’dio_ä“¥aû_wÜk”
, 
Ãw_poÞ_size
);

1671 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
d–ayed_wÜk”s
, 
Ãw_poÞ_size
);

1672 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
»adah—d_wÜk”s
, 
Ãw_poÞ_size
);

1673 
	`bŒfs_wÜkqueue_£t_max
(
fs_šfo
->
süub_wr_com¶‘iÚ_wÜk”s
,

1674 
Ãw_poÞ_size
);

1675 
	}
}

1677 
šlše
 
	$bŒfs_»mouÁ_´•¬e
(
bŒfs_fs_šfo
 *
fs_šfo
)

1679 
	`£t_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
);

1680 
	}
}

1682 
šlše
 
	$bŒfs_»mouÁ_begš
(
bŒfs_fs_šfo
 *
fs_šfo
,

1683 
Þd_Ýts
, 
æags
)

1685 ià(
	`bŒfs_¿w_‹¡_Ýt
(
Þd_Ýts
, 
AUTO_DEFRAG
) &&

1686 (!
	`bŒfs_¿w_‹¡_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
AUTO_DEFRAG
) ||

1687 (
æags
 & 
MS_RDONLY
))) {

1689 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

1690 (
	`©omic_»ad
(&
fs_šfo
->
deäag_ruÂšg
) == 0));

1691 ià(
æags
 & 
MS_RDONLY
)

1692 
	`sync_fžesy¡em
(
fs_šfo
->
sb
);

1694 
	}
}

1696 
šlše
 
	$bŒfs_»mouÁ_þ—nup
(
bŒfs_fs_šfo
 *
fs_šfo
,

1697 
Þd_Ýts
)

1703 ià(
	`bŒfs_¿w_‹¡_Ýt
(
Þd_Ýts
, 
AUTO_DEFRAG
) &&

1704 (!
	`bŒfs_¿w_‹¡_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
AUTO_DEFRAG
è|| 
	`sb_rdÚly
(fs_šfo->
sb
))) {

1705 
	`bŒfs_þ—nup_deäag_šodes
(
fs_šfo
);

1708 
	`þ—r_b™
(
BTRFS_FS_STATE_REMOUNTING
, &
fs_šfo
->
fs_¡©e
);

1709 
	}
}

1711 
	$bŒfs_»mouÁ
(
su³r_block
 *
sb
, *
æags
, *
d©a
)

1713 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

1714 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

1715 
Þd_æags
 = 
sb
->
s_æags
;

1716 
Þd_Ýts
 = 
fs_šfo
->
mouÁ_Ýt
;

1717 
Þd_com´ess_ty³
 = 
fs_šfo
->
com´ess_ty³
;

1718 
u64
 
Þd_max_šlše
 = 
fs_šfo
->
max_šlše
;

1719 
Þd_th»ad_poÞ_size
 = 
fs_šfo
->
th»ad_poÞ_size
;

1720 
Þd_m‘ad©a_¿tio
 = 
fs_šfo
->
m‘ad©a_¿tio
;

1721 
»t
;

1723 
	`sync_fžesy¡em
(
sb
);

1724 
	`bŒfs_»mouÁ_´•¬e
(
fs_šfo
);

1726 ià(
d©a
) {

1727 
£cur™y_mÁ_Ýts
 
Ãw_£c_Ýts
;

1729 
	`£cur™y_š™_mÁ_Ýts
(&
Ãw_£c_Ýts
);

1730 
»t
 = 
	`·r£_£cur™y_ÝtiÚs
(
d©a
, &
Ãw_£c_Ýts
);

1731 ià(
»t
)

1732 
»¡Üe
;

1733 
»t
 = 
	`£tup_£cur™y_ÝtiÚs
(
fs_šfo
, 
sb
,

1734 &
Ãw_£c_Ýts
);

1735 ià(
»t
) {

1736 
	`£cur™y_ä“_mÁ_Ýts
(&
Ãw_£c_Ýts
);

1737 
»¡Üe
;

1741 
»t
 = 
	`bŒfs_·r£_ÝtiÚs
(
fs_šfo
, 
d©a
, *
æags
);

1742 ià(
»t
) {

1743 
»t
 = -
EINVAL
;

1744 
»¡Üe
;

1747 
	`bŒfs_»mouÁ_begš
(
fs_šfo
, 
Þd_Ýts
, *
æags
);

1748 
	`bŒfs_»size_th»ad_poÞ
(
fs_šfo
,

1749 
fs_šfo
->
th»ad_poÞ_size
, 
Þd_th»ad_poÞ_size
);

1751 ià((
boÞ
)(*
æags
 & 
MS_RDONLY
è=ð
	`sb_rdÚly
(
sb
))

1752 
out
;

1754 ià(*
æags
 & 
MS_RDONLY
) {

1759 
	`ÿnûl_wÜk_sync
(&
fs_šfo
->
async_»þaim_wÜk
);

1762 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

1764 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

1766 
sb
->
s_æags
 |ð
MS_RDONLY
;

1775 
	`bŒfs_d–‘e_unu£d_bgs
(
fs_šfo
);

1777 
	`bŒfs_dev_»¶aû_su¥’d_fÜ_unmouÁ
(
fs_šfo
);

1778 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

1779 
	`bŒfs_·u£_b®ªû
(
fs_šfo
);

1781 
»t
 = 
	`bŒfs_comm™_su³r
(
fs_šfo
);

1782 ià(
»t
)

1783 
»¡Üe
;

1785 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

1786 
	`bŒfs_”r
(
fs_šfo
,

1788 
»t
 = -
EINVAL
;

1789 
»¡Üe
;

1791 ià(
fs_šfo
->
fs_deviûs
->
rw_deviûs
 == 0) {

1792 
»t
 = -
EACCES
;

1793 
»¡Üe
;

1796 ià(!
	`bŒfs_check_rw_deg¿dabË
(
fs_šfo
)) {

1797 
	`bŒfs_w¬n
(
fs_šfo
,

1799 
»t
 = -
EACCES
;

1800 
»¡Üe
;

1803 ià(
	`bŒfs_su³r_log_roÙ
(
fs_šfo
->
su³r_cÝy
) != 0) {

1804 
»t
 = -
EINVAL
;

1805 
»¡Üe
;

1808 
»t
 = 
	`bŒfs_þ—nup_fs_roÙs
(
fs_šfo
);

1809 ià(
»t
)

1810 
»¡Üe
;

1813 
	`mu‹x_lock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

1814 
»t
 = 
	`bŒfs_»cov”_»loÿtiÚ
(
roÙ
);

1815 
	`mu‹x_uÆock
(&
fs_šfo
->
þ—Ãr_mu‹x
);

1816 ià(
»t
)

1817 
»¡Üe
;

1819 
»t
 = 
	`bŒfs_»sume_b®ªû_async
(
fs_šfo
);

1820 ià(
»t
)

1821 
»¡Üe
;

1823 
»t
 = 
	`bŒfs_»sume_dev_»¶aû_async
(
fs_šfo
);

1824 ià(
»t
) {

1825 
	`bŒfs_w¬n
(
fs_šfo
, "failedo„esume dev_replace");

1826 
»¡Üe
;

1829 
	`bŒfs_qgroup_»sÿn_»sume
(
fs_šfo
);

1831 ià(!
fs_šfo
->
uuid_roÙ
) {

1832 
	`bŒfs_šfo
(
fs_šfo
, "creating UUIDree");

1833 
»t
 = 
	`bŒfs_ü—‹_uuid_Œ“
(
fs_šfo
);

1834 ià(
»t
) {

1835 
	`bŒfs_w¬n
(
fs_šfo
,

1837 
»t
);

1838 
»¡Üe
;

1841 
sb
->
s_æags
 &ð~
MS_RDONLY
;

1843 
	`£t_b™
(
BTRFS_FS_OPEN
, &
fs_šfo
->
æags
);

1845 
out
:

1846 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

1847 
	`bŒfs_»mouÁ_þ—nup
(
fs_šfo
, 
Þd_Ýts
);

1850 
»¡Üe
:

1852 ià(
	`sb_rdÚly
(
sb
))

1853 
Þd_æags
 |ð
MS_RDONLY
;

1854 
sb
->
s_æags
 = 
Þd_æags
;

1855 
fs_šfo
->
mouÁ_Ýt
 = 
Þd_Ýts
;

1856 
fs_šfo
->
com´ess_ty³
 = 
Þd_com´ess_ty³
;

1857 
fs_šfo
->
max_šlše
 = 
Þd_max_šlše
;

1858 
	`bŒfs_»size_th»ad_poÞ
(
fs_šfo
,

1859 
Þd_th»ad_poÞ_size
, 
fs_šfo
->
th»ad_poÞ_size
);

1860 
fs_šfo
->
m‘ad©a_¿tio
 = 
Þd_m‘ad©a_¿tio
;

1861 
	`bŒfs_»mouÁ_þ—nup
(
fs_šfo
, 
Þd_Ýts
);

1862  
»t
;

1863 
	}
}

1866 
	$bŒfs_cmp_deviû_ä“_by‹s
(cÚ¡ *
dev_šfo1
,

1867 cÚ¡ *
dev_šfo2
)

1869 ià(((
bŒfs_deviû_šfo
 *)
dev_šfo1
)->
max_avaž
 >

1870 ((
bŒfs_deviû_šfo
 *)
dev_šfo2
)->
max_avaž
)

1872 ià(((
bŒfs_deviû_šfo
 *)
dev_šfo1
)->
max_avaž
 <

1873 ((
bŒfs_deviû_šfo
 *)
dev_šfo2
)->
max_avaž
)

1877 
	}
}

1883 
šlše
 
	$bŒfs_desûndšg_sÜt_deviûs
(

1884 
bŒfs_deviû_šfo
 *
deviûs
,

1885 
size_t
 
Ä_deviûs
)

1887 
	`sÜt
(
deviûs
, 
Ä_deviûs
, (
bŒfs_deviû_šfo
),

1888 
bŒfs_cmp_deviû_ä“_by‹s
, 
NULL
);

1889 
	}
}

1895 
	$bŒfs_ÿlc_avaž_d©a_¥aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

1896 
u64
 *
ä“_by‹s
)

1898 
bŒfs_deviû_šfo
 *
deviûs_šfo
;

1899 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

1900 
bŒfs_deviû
 *
deviû
;

1901 
u64
 
sk_¥aû
;

1902 
u64
 
ty³
;

1903 
u64
 
avaž_¥aû
;

1904 
u64
 
mš_¡re_size
;

1905 
mš_¡res
 = 1, 
num_¡res
 = 1;

1906 
i
 = 0, 
Ä_deviûs
;

1912 
Ä_deviûs
 = 
fs_šfo
->
fs_deviûs
->
Ý’_deviûs
;

1913 ià(!
Ä_deviûs
) {

1914 
	`smp_mb
();

1915 
Ä_deviûs
 = 
fs_šfo
->
fs_deviûs
->
Ý’_deviûs
;

1916 
	`ASSERT
(
Ä_deviûs
);

1917 ià(!
Ä_deviûs
) {

1918 *
ä“_by‹s
 = 0;

1923 
deviûs_šfo
 = 
	`km®loc_¬¿y
(
Ä_deviûs
, (*devices_info),

1924 
GFP_KERNEL
);

1925 ià(!
deviûs_šfo
)

1926  -
ENOMEM
;

1929 
ty³
 = 
	`bŒfs_d©a_®loc_´ofže
(
fs_šfo
);

1930 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
) {

1931 
mš_¡res
 = 2;

1932 
num_¡res
 = 
Ä_deviûs
;

1933 } ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1
) {

1934 
mš_¡res
 = 2;

1935 
num_¡res
 = 2;

1936 } ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
) {

1937 
mš_¡res
 = 4;

1938 
num_¡res
 = 4;

1941 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_DUP
)

1942 
mš_¡re_size
 = 2 * 
BTRFS_STRIPE_LEN
;

1944 
mš_¡re_size
 = 
BTRFS_STRIPE_LEN
;

1946 
	`rcu_»ad_lock
();

1947 
	`li¡_fÜ_—ch_’Œy_rcu
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

1948 ià(!
deviû
->
š_fs_m‘ad©a
 || !deviû->
bdev
 ||

1949 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
)

1952 ià(
i
 >ð
Ä_deviûs
)

1955 
avaž_¥aû
 = 
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
;

1958 
avaž_¥aû
 = 
	`div_u64
×važ_¥aû, 
BTRFS_STRIPE_LEN
);

1959 
avaž_¥aû
 *ð
BTRFS_STRIPE_LEN
;

1966 
sk_¥aû
 = 
SZ_1M
;

1972 ià(
avaž_¥aû
 &&‡važ_¥aû >ð
sk_¥aû
)

1973 
avaž_¥aû
 -ð
sk_¥aû
;

1975 
avaž_¥aû
 = 0;

1977 ià(
avaž_¥aû
 < 
mš_¡re_size
)

1980 
deviûs_šfo
[
i
].
dev
 = 
deviû
;

1981 
deviûs_šfo
[
i
].
max_avaž
 = 
avaž_¥aû
;

1983 
i
++;

1985 
	`rcu_»ad_uÆock
();

1987 
Ä_deviûs
 = 
i
;

1989 
	`bŒfs_desûndšg_sÜt_deviûs
(
deviûs_šfo
, 
Ä_deviûs
);

1991 
i
 = 
Ä_deviûs
 - 1;

1992 
avaž_¥aû
 = 0;

1993 
Ä_deviûs
 >ð
mš_¡res
) {

1994 ià(
num_¡res
 > 
Ä_deviûs
)

1995 
num_¡res
 = 
Ä_deviûs
;

1997 ià(
deviûs_šfo
[
i
].
max_avaž
 >ð
mš_¡re_size
) {

1998 
j
;

1999 
u64
 
®loc_size
;

2001 
avaž_¥aû
 +ð
deviûs_šfo
[
i
].
max_avaž
 * 
num_¡res
;

2002 
®loc_size
 = 
deviûs_šfo
[
i
].
max_avaž
;

2003 
j
 = 
i
 + 1 - 
num_¡res
; j <= i; j++)

2004 
deviûs_šfo
[
j
].
max_avaž
 -ð
®loc_size
;

2006 
i
--;

2007 
Ä_deviûs
--;

2010 
	`kä“
(
deviûs_šfo
);

2011 *
ä“_by‹s
 = 
avaž_¥aû
;

2013 
	}
}

2028 
	$bŒfs_¡©fs
(
d’Œy
 *d’Œy, 
k¡©fs
 *
buf
)

2030 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
d’Œy
->
d_sb
);

2031 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

2032 
li¡_h—d
 *
h—d
 = &
fs_šfo
->
¥aû_šfo
;

2033 
bŒfs_¥aû_šfo
 *
found
;

2034 
u64
 
tÙ®_u£d
 = 0;

2035 
u64
 
tÙ®_ä“_d©a
 = 0;

2036 
u64
 
tÙ®_ä“_m‘a
 = 0;

2037 
b™s
 = 
d’Œy
->
d_sb
->
s_blocksize_b™s
;

2038 
__be32
 *
fsid
 = (__be32 *)
fs_šfo
->fsid;

2039 
çùÜ
 = 1;

2040 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

2041 
»t
;

2042 
u64
 
th»sh
 = 0;

2043 
mixed
 = 0;

2045 
	`rcu_»ad_lock
();

2046 
	`li¡_fÜ_—ch_’Œy_rcu
(
found
, 
h—d
, 
li¡
) {

2047 ià(
found
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
) {

2048 
i
;

2050 
tÙ®_ä“_d©a
 +ð
found
->
disk_tÙ®
 - found->
disk_u£d
;

2051 
tÙ®_ä“_d©a
 -=

2052 
	`bŒfs_accouÁ_ro_block_groups_ä“_¥aû
(
found
);

2054 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

2055 ià(!
	`li¡_em±y
(&
found
->
block_groups
[
i
])) {

2056 
i
) {

2057 
BTRFS_RAID_DUP
:

2058 
BTRFS_RAID_RAID1
:

2059 
BTRFS_RAID_RAID10
:

2060 
çùÜ
 = 2;

2069 ià(!
mixed
 && 
found
->
æags
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

2070 ià(
found
->
æags
 & 
BTRFS_BLOCK_GROUP_DATA
)

2071 
mixed
 = 1;

2073 
tÙ®_ä“_m‘a
 +ð
found
->
disk_tÙ®
 -

2074 
found
->
disk_u£d
;

2077 
tÙ®_u£d
 +ð
found
->
disk_u£d
;

2080 
	`rcu_»ad_uÆock
();

2082 
buf
->
f_blocks
 = 
	`div_u64
(
	`bŒfs_su³r_tÙ®_by‹s
(
disk_su³r
), 
çùÜ
);

2083 
buf
->
f_blocks
 >>ð
b™s
;

2084 
buf
->
f_bä“
 = buf->
f_blocks
 - (
	`div_u64
(
tÙ®_u£d
, 
çùÜ
è>> 
b™s
);

2087 
	`¥š_lock
(&
block_rsv
->
lock
);

2089 ià(
buf
->
f_bä“
 >ð
block_rsv
->
size
 >> 
b™s
)

2090 
buf
->
f_bä“
 -ð
block_rsv
->
size
 >> 
b™s
;

2092 
buf
->
f_bä“
 = 0;

2093 
	`¥š_uÆock
(&
block_rsv
->
lock
);

2095 
buf
->
f_bavaž
 = 
	`div_u64
(
tÙ®_ä“_d©a
, 
çùÜ
);

2096 
»t
 = 
	`bŒfs_ÿlc_avaž_d©a_¥aû
(
fs_šfo
, &
tÙ®_ä“_d©a
);

2097 ià(
»t
)

2098  
»t
;

2099 
buf
->
f_bavaž
 +ð
	`div_u64
(
tÙ®_ä“_d©a
, 
çùÜ
);

2100 
buf
->
f_bavaž
 = buf->f_bavaž >> 
b™s
;

2115 
th»sh
 = 4 * 1024 * 1024;

2117 ià(!
mixed
 && 
tÙ®_ä“_m‘a
 - 
th»sh
 < 
block_rsv
->
size
)

2118 
buf
->
f_bavaž
 = 0;

2120 
buf
->
f_ty³
 = 
BTRFS_SUPER_MAGIC
;

2121 
buf
->
f_bsize
 = 
d’Œy
->
d_sb
->
s_blocksize
;

2122 
buf
->
f_Çm–’
 = 
BTRFS_NAME_LEN
;

2127 
buf
->
f_fsid
.
v®
[0] = 
	`be32_to_ýu
(
fsid
[0]) ^ be32_to_cpu(fsid[2]);

2128 
buf
->
f_fsid
.
v®
[1] = 
	`be32_to_ýu
(
fsid
[1]) ^ be32_to_cpu(fsid[3]);

2130 
buf
->
f_fsid
.
v®
[0] ^ð
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
objeùid
 >> 32;

2131 
buf
->
f_fsid
.
v®
[1] ^ð
	`BTRFS_I
(
	`d_šode
(
d’Œy
))->
roÙ
->
objeùid
;

2134 
	}
}

2136 
	$bŒfs_kžl_su³r
(
su³r_block
 *
sb
)

2138 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2139 
	`kžl_ªÚ_su³r
(
sb
);

2140 
	`ä“_fs_šfo
(
fs_šfo
);

2141 
	}
}

2143 
fže_sy¡em_ty³
 
	gbŒfs_fs_ty³
 = {

2144 .
owÃr
 = 
THIS_MODULE
,

2145 .
	gÇme
 = "btrfs",

2146 .
	gmouÁ
 = 
bŒfs_mouÁ
,

2147 .
	gkžl_sb
 = 
bŒfs_kžl_su³r
,

2148 .
	gfs_æags
 = 
FS_REQUIRES_DEV
 | 
FS_BINARY_MOUNTDATA
,

2150 
MODULE_ALIAS_FS
("btrfs");

2152 
	$bŒfs_cÚŒÞ_Ý’
(
šode
 *šode, 
fže
 *file)

2159 
fže
->
´iv©e_d©a
 = 
NULL
;

2161 
	}
}

2166 
	$bŒfs_cÚŒÞ_ioùl
(
fže
 *fže, 
cmd
,

2167 
¬g
)

2169 
bŒfs_ioùl_vÞ_¬gs
 *
vÞ
;

2170 
bŒfs_fs_deviûs
 *
fs_deviûs
;

2171 
»t
 = -
ENOTTY
;

2173 ià(!
	`ÿ·bË
(
CAP_SYS_ADMIN
))

2174  -
EPERM
;

2176 
vÞ
 = 
	`memdup_u£r
((
__u£r
 *)
¬g
, (*vol));

2177 ià(
	`IS_ERR
(
vÞ
))

2178  
	`PTR_ERR
(
vÞ
);

2180 
cmd
) {

2181 
BTRFS_IOC_SCAN_DEV
:

2182 
»t
 = 
	`bŒfs_sÿn_Úe_deviû
(
vÞ
->
Çme
, 
FMODE_READ
,

2183 &
bŒfs_fs_ty³
, &
fs_deviûs
);

2185 
BTRFS_IOC_DEVICES_READY
:

2186 
»t
 = 
	`bŒfs_sÿn_Úe_deviû
(
vÞ
->
Çme
, 
FMODE_READ
,

2187 &
bŒfs_fs_ty³
, &
fs_deviûs
);

2188 ià(
»t
)

2190 
»t
 = !(
fs_deviûs
->
num_deviûs
 =ðfs_deviûs->
tÙ®_deviûs
);

2192 
BTRFS_IOC_GET_SUPPORTED_FEATURES
:

2193 
»t
 = 
	`bŒfs_ioùl_g‘_suµÜ‹d_ã©u»s
((
__u£r
*)
¬g
);

2197 
	`kä“
(
vÞ
);

2198  
»t
;

2199 
	}
}

2201 
	$bŒfs_ä“ze
(
su³r_block
 *
sb
)

2203 
bŒfs_Œªs_hªdË
 *
Œªs
;

2204 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2205 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

2207 
	`£t_b™
(
BTRFS_FS_FROZEN
, &
fs_šfo
->
æags
);

2214 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
roÙ
);

2215 ià(
	`IS_ERR
(
Œªs
)) {

2217 ià(
	`PTR_ERR
(
Œªs
è=ð-
ENOENT
)

2219  
	`PTR_ERR
(
Œªs
);

2221  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2222 
	}
}

2224 
	$bŒfs_unä“ze
(
su³r_block
 *
sb
)

2226 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
sb
);

2228 
	`þ—r_b™
(
BTRFS_FS_FROZEN
, &
fs_šfo
->
æags
);

2230 
	}
}

2232 
	$bŒfs_show_devÇme
(
£q_fže
 *
m
, 
d’Œy
 *
roÙ
)

2234 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
roÙ
->
d_sb
);

2235 
bŒfs_fs_deviûs
 *
cur_deviûs
;

2236 
bŒfs_deviû
 *
dev
, *
fœ¡_dev
 = 
NULL
;

2237 
li¡_h—d
 *
h—d
;

2238 
rcu_¡ršg
 *
Çme
;

2240 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2241 
cur_deviûs
 = 
fs_šfo
->
fs_deviûs
;

2242 
cur_deviûs
) {

2243 
h—d
 = &
cur_deviûs
->
deviûs
;

2244 
	`li¡_fÜ_—ch_’Œy
(
dev
, 
h—d
, 
dev_li¡
) {

2245 ià(
dev
->
missšg
)

2247 ià(!
dev
->
Çme
)

2249 ià(!
fœ¡_dev
 || 
dev
->
devid
 < first_dev->devid)

2250 
fœ¡_dev
 = 
dev
;

2252 
cur_deviûs
 = cur_deviûs->
£ed
;

2255 ià(
fœ¡_dev
) {

2256 
	`rcu_»ad_lock
();

2257 
Çme
 = 
	`rcu_d”eã»nû
(
fœ¡_dev
->name);

2258 
	`£q_esÿ³
(
m
, 
Çme
->
¡r
, " \t\n\\");

2259 
	`rcu_»ad_uÆock
();

2261 
	`WARN_ON
(1);

2263 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2265 
	}
}

2267 cÚ¡ 
su³r_Ý”©iÚs
 
	gbŒfs_su³r_Ýs
 = {

2268 .
drÝ_šode
 = 
bŒfs_drÝ_šode
,

2269 .
	geviù_šode
 = 
bŒfs_eviù_šode
,

2270 .
	gput_su³r
 = 
bŒfs_put_su³r
,

2271 .
	gsync_fs
 = 
bŒfs_sync_fs
,

2272 .
	gshow_ÝtiÚs
 = 
bŒfs_show_ÝtiÚs
,

2273 .
	gshow_devÇme
 = 
bŒfs_show_devÇme
,

2274 .
	gwr™e_šode
 = 
bŒfs_wr™e_šode
,

2275 .
	g®loc_šode
 = 
bŒfs_®loc_šode
,

2276 .
	gde¡roy_šode
 = 
bŒfs_de¡roy_šode
,

2277 .
	g¡©fs
 = 
bŒfs_¡©fs
,

2278 .
	g»mouÁ_fs
 = 
bŒfs_»mouÁ
,

2279 .
	gä“ze_fs
 = 
bŒfs_ä“ze
,

2280 .
	gunä“ze_fs
 = 
bŒfs_unä“ze
,

2283 cÚ¡ 
fže_Ý”©iÚs
 
	gbŒfs_ùl_fÝs
 = {

2284 .
Ý’
 = 
bŒfs_cÚŒÞ_Ý’
,

2285 .
	guÆocked_ioùl
 = 
bŒfs_cÚŒÞ_ioùl
,

2286 .
	gcom·t_ioùl
 = 
bŒfs_cÚŒÞ_ioùl
,

2287 .
	gowÃr
 = 
THIS_MODULE
,

2288 .
	gÎ£ek
 = 
noÝ_Î£ek
,

2291 
miscdeviû
 
	gbŒfs_misc
 = {

2292 .
mšÜ
 = 
BTRFS_MINOR
,

2293 .
	gÇme
 = "btrfs-control",

2294 .
	gfÝs
 = &
bŒfs_ùl_fÝs


2297 
MODULE_ALIAS_MISCDEV
(
BTRFS_MINOR
);

2298 
MODULE_ALIAS
("devname:btrfs-control");

2300 
	$bŒfs_š‹rçû_š™
()

2302  
	`misc_»gi¡”
(&
bŒfs_misc
);

2303 
	}
}

2305 
	$bŒfs_š‹rçû_ex™
()

2307 
	`misc_d”egi¡”
(&
bŒfs_misc
);

2308 
	}
}

2310 
	$bŒfs_´št_mod_šfo
()

2312 
	`´_šfo
("Btrfs†oaded, crc32c=%s"

2313 #ifdeà
CONFIG_BTRFS_DEBUG


2316 #ifdeà
CONFIG_BTRFS_ASSERT


2319 #ifdeà
CONFIG_BTRFS_FS_CHECK_INTEGRITY


2323 
	`bŒfs_üc32c_im¶
());

2324 
	}
}

2326 
__š™
 
	$š™_bŒfs_fs
()

2328 
”r
;

2330 
”r
 = 
	`bŒfs_hash_š™
();

2331 ià(
”r
)

2332  
”r
;

2334 
	`bŒfs_´Ýs_š™
();

2336 
”r
 = 
	`bŒfs_š™_sysfs
();

2337 ià(
”r
)

2338 
ä“_hash
;

2340 
	`bŒfs_š™_com´ess
();

2342 
”r
 = 
	`bŒfs_š™_ÿch•
();

2343 ià(
”r
)

2344 
ä“_com´ess
;

2346 
”r
 = 
	`ex‹Á_io_š™
();

2347 ià(
”r
)

2348 
ä“_ÿch•
;

2350 
”r
 = 
	`ex‹Á_m­_š™
();

2351 ià(
”r
)

2352 
ä“_ex‹Á_io
;

2354 
”r
 = 
	`Üd”ed_d©a_š™
();

2355 ià(
”r
)

2356 
ä“_ex‹Á_m­
;

2358 
”r
 = 
	`bŒfs_d–ayed_šode_š™
();

2359 ià(
”r
)

2360 
ä“_Üd”ed_d©a
;

2362 
”r
 = 
	`bŒfs_auto_deäag_š™
();

2363 ià(
”r
)

2364 
ä“_d–ayed_šode
;

2366 
”r
 = 
	`bŒfs_d–ayed_»f_š™
();

2367 ià(
”r
)

2368 
ä“_auto_deäag
;

2370 
”r
 = 
	`bŒfs_´–im_»f_š™
();

2371 ià(
”r
)

2372 
ä“_d–ayed_»f
;

2374 
”r
 = 
	`bŒfs_’d_io_wq_š™
();

2375 ià(
”r
)

2376 
ä“_´–im_»f
;

2378 
”r
 = 
	`bŒfs_š‹rçû_š™
();

2379 ià(
”r
)

2380 
ä“_’d_io_wq
;

2382 
	`bŒfs_š™_lockd•
();

2384 
	`bŒfs_´št_mod_šfo
();

2386 
”r
 = 
	`bŒfs_run_§n™y_‹¡s
();

2387 ià(
”r
)

2388 
uÄegi¡”_ioùl
;

2390 
”r
 = 
	`»gi¡”_fžesy¡em
(&
bŒfs_fs_ty³
);

2391 ià(
”r
)

2392 
uÄegi¡”_ioùl
;

2396 
uÄegi¡”_ioùl
:

2397 
	`bŒfs_š‹rçû_ex™
();

2398 
ä“_’d_io_wq
:

2399 
	`bŒfs_’d_io_wq_ex™
();

2400 
ä“_´–im_»f
:

2401 
	`bŒfs_´–im_»f_ex™
();

2402 
ä“_d–ayed_»f
:

2403 
	`bŒfs_d–ayed_»f_ex™
();

2404 
ä“_auto_deäag
:

2405 
	`bŒfs_auto_deäag_ex™
();

2406 
ä“_d–ayed_šode
:

2407 
	`bŒfs_d–ayed_šode_ex™
();

2408 
ä“_Üd”ed_d©a
:

2409 
	`Üd”ed_d©a_ex™
();

2410 
ä“_ex‹Á_m­
:

2411 
	`ex‹Á_m­_ex™
();

2412 
ä“_ex‹Á_io
:

2413 
	`ex‹Á_io_ex™
();

2414 
ä“_ÿch•
:

2415 
	`bŒfs_de¡roy_ÿch•
();

2416 
ä“_com´ess
:

2417 
	`bŒfs_ex™_com´ess
();

2418 
	`bŒfs_ex™_sysfs
();

2419 
ä“_hash
:

2420 
	`bŒfs_hash_ex™
();

2421  
”r
;

2422 
	}
}

2424 
__ex™
 
	$ex™_bŒfs_fs
()

2426 
	`bŒfs_de¡roy_ÿch•
();

2427 
	`bŒfs_d–ayed_»f_ex™
();

2428 
	`bŒfs_auto_deäag_ex™
();

2429 
	`bŒfs_d–ayed_šode_ex™
();

2430 
	`bŒfs_´–im_»f_ex™
();

2431 
	`Üd”ed_d©a_ex™
();

2432 
	`ex‹Á_m­_ex™
();

2433 
	`ex‹Á_io_ex™
();

2434 
	`bŒfs_š‹rçû_ex™
();

2435 
	`bŒfs_’d_io_wq_ex™
();

2436 
	`uÄegi¡”_fžesy¡em
(&
bŒfs_fs_ty³
);

2437 
	`bŒfs_ex™_sysfs
();

2438 
	`bŒfs_þ—nup_fs_uuids
();

2439 
	`bŒfs_ex™_com´ess
();

2440 
	`bŒfs_hash_ex™
();

2441 
	}
}

2443 
Ï‹_š™ÿÎ
(
š™_bŒfs_fs
);

2444 
	$moduË_ex™
(
ex™_bŒfs_fs
)

2446 
	`MODULE_LICENSE
("GPL");

	@sysfs.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/¥šlock.h
>

22 
	~<lšux/com¶‘iÚ.h
>

23 
	~<lšux/bufãr_h—d.h
>

24 
	~<lšux/kobjeù.h
>

25 
	~<lšux/bug.h
>

26 
	~<lšux/g’hd.h
>

27 
	~<lšux/debugfs.h
>

29 
	~"ù»e.h
"

30 
	~"disk-io.h
"

31 
	~"Œª§ùiÚ.h
"

32 
	~"sysfs.h
"

33 
	~"vÞumes.h
"

35 
šlše
 
bŒfs_fs_šfo
 *
to_fs_šfo
(
kobjeù
 *
kobj
);

36 
šlše
 
bŒfs_fs_deviûs
 *
to_fs_devs
(
kobjeù
 *
kobj
);

38 
u64
 
	$g‘_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
,

39 
bŒfs_ã©u»_£t
 
£t
)

41 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

42 ià(
£t
 =ð
FEAT_COMPAT
)

43  
	`bŒfs_su³r_com·t_æags
(
disk_su³r
);

44 ià(
£t
 =ð
FEAT_COMPAT_RO
)

45  
	`bŒfs_su³r_com·t_ro_æags
(
disk_su³r
);

47  
	`bŒfs_su³r_šcom·t_æags
(
disk_su³r
);

48 
	}
}

50 
	$£t_ã©u»s
(
bŒfs_fs_šfo
 *
fs_šfo
,

51 
bŒfs_ã©u»_£t
 
£t
, 
u64
 
ã©u»s
)

53 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

54 ià(
£t
 =ð
FEAT_COMPAT
)

55 
	`bŒfs_£t_su³r_com·t_æags
(
disk_su³r
, 
ã©u»s
);

56 ià(
£t
 =ð
FEAT_COMPAT_RO
)

57 
	`bŒfs_£t_su³r_com·t_ro_æags
(
disk_su³r
, 
ã©u»s
);

59 
	`bŒfs_£t_su³r_šcom·t_æags
(
disk_su³r
, 
ã©u»s
);

60 
	}
}

62 
	$ÿn_modify_ã©u»
(
bŒfs_ã©u»_©Œ
 *
ç
)

64 
v®
 = 0;

65 
u64
 
£t
, 
þ—r
;

66 
ç
->
ã©u»_£t
) {

67 
FEAT_COMPAT
:

68 
£t
 = 
BTRFS_FEATURE_COMPAT_SAFE_SET
;

69 
þ—r
 = 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
;

71 
FEAT_COMPAT_RO
:

72 
£t
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
;

73 
þ—r
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
;

75 
FEAT_INCOMPAT
:

76 
£t
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
;

77 
þ—r
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
;

80 
	`´_w¬n
("btrfs: sysfs: unknown feature set %d\n",

81 
ç
->
ã©u»_£t
);

85 ià(
£t
 & 
ç
->
ã©u»_b™
)

86 
v®
 |= 1;

87 ià(
þ—r
 & 
ç
->
ã©u»_b™
)

88 
v®
 |= 2;

90  
v®
;

91 
	}
}

93 
ssize_t
 
	$bŒfs_ã©u»_©Œ_show
(
kobjeù
 *
kobj
,

94 
kobj_©Œibu‹
 *
a
, *
buf
)

96 
v®
 = 0;

97 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

98 
bŒfs_ã©u»_©Œ
 *
ç
 = 
	`to_bŒfs_ã©u»_©Œ
(
a
);

99 ià(
fs_šfo
) {

100 
u64
 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

101 ià(
ã©u»s
 & 
ç
->
ã©u»_b™
)

102 
v®
 = 1;

104 
v®
 = 
	`ÿn_modify_ã©u»
(
ç
);

106  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%d\n", 
v®
);

107 
	}
}

109 
ssize_t
 
	$bŒfs_ã©u»_©Œ_¡Üe
(
kobjeù
 *
kobj
,

110 
kobj_©Œibu‹
 *
a
,

111 cÚ¡ *
buf
, 
size_t
 
couÁ
)

113 
bŒfs_fs_šfo
 *
fs_šfo
;

114 
bŒfs_ã©u»_©Œ
 *
ç
 = 
	`to_bŒfs_ã©u»_©Œ
(
a
);

115 
u64
 
ã©u»s
, 
£t
, 
þ—r
;

116 
v®
;

117 
»t
;

119 
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

120 ià(!
fs_šfo
)

121  -
EPERM
;

123 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

124  -
EROFS
;

126 
»t
 = 
	`k¡¹oul
(
	`sk_¥aûs
(
buf
), 0, &
v®
);

127 ià(
»t
)

128  
»t
;

130 ià(
ç
->
ã©u»_£t
 =ð
FEAT_COMPAT
) {

131 
£t
 = 
BTRFS_FEATURE_COMPAT_SAFE_SET
;

132 
þ—r
 = 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
;

133 } ià(
ç
->
ã©u»_£t
 =ð
FEAT_COMPAT_RO
) {

134 
£t
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
;

135 
þ—r
 = 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
;

137 
£t
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
;

138 
þ—r
 = 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
;

141 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

144 ià((
v®
 && (
ã©u»s
 & 
ç
->
ã©u»_b™
)) ||

145 (!
v®
 && !(
ã©u»s
 & 
ç
->
ã©u»_b™
)))

146  
couÁ
;

148 ià((
v®
 && !(
£t
 & 
ç
->
ã©u»_b™
)) ||

149 (!
v®
 && !(
þ—r
 & 
ç
->
ã©u»_b™
))) {

150 
	`bŒfs_šfo
(
fs_šfo
,

152 
v®
 ? "En" : "Dis", 
ç
->
kobj_©Œ
.
©Œ
.
Çme
);

153  -
EPERM
;

156 
	`bŒfs_šfo
(
fs_šfo
, "%s %s feature flag",

157 
v®
 ? "S‘tšg" : "CË¬šg", 
ç
->
kobj_©Œ
.
©Œ
.
Çme
);

159 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

160 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

161 ià(
v®
)

162 
ã©u»s
 |ð
ç
->
ã©u»_b™
;

164 
ã©u»s
 &ð~
ç
->
ã©u»_b™
;

165 
	`£t_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
, 
ã©u»s
);

166 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

171 
	`bŒfs_£t_³ndšg
(
fs_šfo
, 
COMMIT
);

172 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

174  
couÁ
;

175 
	}
}

177 
umode_t
 
	$bŒfs_ã©u»_visibË
(
kobjeù
 *
kobj
,

178 
©Œibu‹
 *
©Œ
, 
unu£d
)

180 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

181 
umode_t
 
mode
 = 
©Œ
->mode;

183 ià(
fs_šfo
) {

184 
bŒfs_ã©u»_©Œ
 *
ç
;

185 
u64
 
ã©u»s
;

187 
ç
 = 
	`©Œ_to_bŒfs_ã©u»_©Œ
(
©Œ
);

188 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
ç
->
ã©u»_£t
);

190 ià(
	`ÿn_modify_ã©u»
(
ç
))

191 
mode
 |ð
S_IWUSR
;

192 ià(!(
ã©u»s
 & 
ç
->
ã©u»_b™
))

193 
mode
 = 0;

196  
mode
;

197 
	}
}

199 
BTRFS_FEAT_ATTR_INCOMPAT
(
mixed_back»f
, 
MIXED_BACKREF
);

200 
BTRFS_FEAT_ATTR_INCOMPAT
(
deçuÉ_subvÞ
, 
DEFAULT_SUBVOL
);

201 
BTRFS_FEAT_ATTR_INCOMPAT
(
mixed_groups
, 
MIXED_GROUPS
);

202 
BTRFS_FEAT_ATTR_INCOMPAT
(
com´ess_lzo
, 
COMPRESS_LZO
);

203 
BTRFS_FEAT_ATTR_INCOMPAT
(
com´ess_z¡d
, 
COMPRESS_ZSTD
);

204 
BTRFS_FEAT_ATTR_INCOMPAT
(
big_m‘ad©a
, 
BIG_METADATA
);

205 
BTRFS_FEAT_ATTR_INCOMPAT
(
ex‹nded_œef
, 
EXTENDED_IREF
);

206 
BTRFS_FEAT_ATTR_INCOMPAT
(
¿id56
, 
RAID56
);

207 
BTRFS_FEAT_ATTR_INCOMPAT
(
skšny_m‘ad©a
, 
SKINNY_METADATA
);

208 
BTRFS_FEAT_ATTR_INCOMPAT
(
no_hÞes
, 
NO_HOLES
);

209 
BTRFS_FEAT_ATTR_COMPAT_RO
(
ä“_¥aû_Œ“
, 
FREE_SPACE_TREE
);

211 
©Œibu‹
 *
	gbŒfs_suµÜ‹d_ã©u»_©Œs
[] = {

212 
BTRFS_FEAT_ATTR_PTR
(
mixed_back»f
),

213 
BTRFS_FEAT_ATTR_PTR
(
deçuÉ_subvÞ
),

214 
BTRFS_FEAT_ATTR_PTR
(
mixed_groups
),

215 
BTRFS_FEAT_ATTR_PTR
(
com´ess_lzo
),

216 
BTRFS_FEAT_ATTR_PTR
(
com´ess_z¡d
),

217 
BTRFS_FEAT_ATTR_PTR
(
big_m‘ad©a
),

218 
BTRFS_FEAT_ATTR_PTR
(
ex‹nded_œef
),

219 
BTRFS_FEAT_ATTR_PTR
(
¿id56
),

220 
BTRFS_FEAT_ATTR_PTR
(
skšny_m‘ad©a
),

221 
BTRFS_FEAT_ATTR_PTR
(
no_hÞes
),

222 
BTRFS_FEAT_ATTR_PTR
(
ä“_¥aû_Œ“
),

223 
NULL


226 cÚ¡ 
©Œibu‹_group
 
	gbŒfs_ã©u»_©Œ_group
 = {

227 .
Çme
 = "features",

228 .
	gis_visibË
 = 
bŒfs_ã©u»_visibË
,

229 .
	g©Œs
 = 
bŒfs_suµÜ‹d_ã©u»_©Œs
,

232 
ssize_t
 
	$bŒfs_show_u64
(
u64
 *
v®ue_±r
, 
¥šlock_t
 *
lock
, *
buf
)

234 
u64
 
v®
;

235 ià(
lock
)

236 
	`¥š_lock
(
lock
);

237 
v®
 = *
v®ue_±r
;

238 ià(
lock
)

239 
	`¥š_uÆock
(
lock
);

240  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%Îu\n", 
v®
);

241 
	}
}

243 
ssize_t
 
	$glob®_rsv_size_show
(
kobjeù
 *
kobj
,

244 
kobj_©Œibu‹
 *
ka
, *
buf
)

246 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
->
·»Á
);

247 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

248  
	`bŒfs_show_u64
(&
block_rsv
->
size
, &block_rsv->
lock
, 
buf
);

249 
	}
}

250 
BTRFS_ATTR
(
glob®_rsv_size
, 
glob®_rsv_size_show
);

252 
ssize_t
 
	$glob®_rsv_»£rved_show
(
kobjeù
 *
kobj
,

253 
kobj_©Œibu‹
 *
a
, *
buf
)

255 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
->
·»Á
);

256 
bŒfs_block_rsv
 *
block_rsv
 = &
fs_šfo
->
glob®_block_rsv
;

257  
	`bŒfs_show_u64
(&
block_rsv
->
»£rved
, &block_rsv->
lock
, 
buf
);

258 
	}
}

259 
BTRFS_ATTR
(
glob®_rsv_»£rved
, 
glob®_rsv_»£rved_show
);

261 
	#to_¥aû_šfo
(
_kobj
è
	`cÚš”_of
(_kobj, 
bŒfs_¥aû_šfo
, 
kobj
)

	)

262 
	#to_¿id_kobj
(
_kobj
è
	`cÚš”_of
(_kobj, 
¿id_kobjeù
, 
kobj
)

	)

264 
ssize_t
 
¿id_by‹s_show
(
kobjeù
 *
kobj
,

265 
kobj_©Œibu‹
 *
©Œ
, *
buf
);

266 
BTRFS_RAID_ATTR
(
tÙ®_by‹s
, 
¿id_by‹s_show
);

267 
BTRFS_RAID_ATTR
(
u£d_by‹s
, 
¿id_by‹s_show
);

269 
ssize_t
 
	$¿id_by‹s_show
(
kobjeù
 *
kobj
,

270 
kobj_©Œibu‹
 *
©Œ
, *
buf
)

273 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
->
·»Á
);

274 
bŒfs_block_group_ÿche
 *
block_group
;

275 
šdex
 = 
	`to_¿id_kobj
(
kobj
)->
¿id_ty³
;

276 
u64
 
v®
 = 0;

278 
	`down_»ad
(&
sšfo
->
groups_£m
);

279 
	`li¡_fÜ_—ch_’Œy
(
block_group
, &
sšfo
->
block_groups
[
šdex
], 
li¡
) {

280 ià(&
©Œ
->©Œ =ð
	`BTRFS_RAID_ATTR_PTR
(
tÙ®_by‹s
))

281 
v®
 +ð
block_group
->
key
.
off£t
;

283 
v®
 +ð
	`bŒfs_block_group_u£d
(&
block_group
->
™em
);

285 
	`up_»ad
(&
sšfo
->
groups_£m
);

286  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%Îu\n", 
v®
);

287 
	}
}

289 
©Œibu‹
 *
	g¿id_©Œibu‹s
[] = {

290 
BTRFS_RAID_ATTR_PTR
(
tÙ®_by‹s
),

291 
BTRFS_RAID_ATTR_PTR
(
u£d_by‹s
),

292 
NULL


295 
	$»Ëa£_¿id_kobj
(
kobjeù
 *
kobj
)

297 
	`kä“
(
	`to_¿id_kobj
(
kobj
));

298 
	}
}

300 
kobj_ty³
 
	gbŒfs_¿id_kty³
 = {

301 .
sysfs_Ýs
 = &
kobj_sysfs_Ýs
,

302 .
	g»Ëa£
 = 
»Ëa£_¿id_kobj
,

303 .
	gdeçuÉ_©Œs
 = 
¿id_©Œibu‹s
,

306 
	#SPACE_INFO_ATTR
(
f›ld
) \

307 
ssize_t
 
bŒfs_¥aû_šfo_show_
##
	`f›ld
(
kobjeù
 *
kobj
, \

308 
kobj_©Œibu‹
 *
a
, \

309 *
buf
) \

311 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
); \

312  
	`bŒfs_show_u64
(&
sšfo
->
f›ld
, &sšfo->
lock
, 
buf
); \

314 
	`BTRFS_ATTR
(
f›ld
, 
bŒfs_¥aû_šfo_show_
##f›ld)

	)

316 
ssize_t
 
	$bŒfs_¥aû_šfo_show_tÙ®_by‹s_pšÃd
(
kobjeù
 *
kobj
,

317 
kobj_©Œibu‹
 *
a
,

318 *
buf
)

320 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
);

321 
s64
 
v®
 = 
	`³rýu_couÁ”_sum
(&
sšfo
->
tÙ®_by‹s_pšÃd
);

322  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%Îd\n", 
v®
);

323 
	}
}

325 
SPACE_INFO_ATTR
(
æags
);

326 
SPACE_INFO_ATTR
(
tÙ®_by‹s
);

327 
SPACE_INFO_ATTR
(
by‹s_u£d
);

328 
SPACE_INFO_ATTR
(
by‹s_pšÃd
);

329 
SPACE_INFO_ATTR
(
by‹s_»£rved
);

330 
SPACE_INFO_ATTR
(
by‹s_may_u£
);

331 
SPACE_INFO_ATTR
(
by‹s_»adÚly
);

332 
SPACE_INFO_ATTR
(
disk_u£d
);

333 
SPACE_INFO_ATTR
(
disk_tÙ®
);

334 
BTRFS_ATTR
(
tÙ®_by‹s_pšÃd
, 
bŒfs_¥aû_šfo_show_tÙ®_by‹s_pšÃd
);

336 
©Œibu‹
 *
	g¥aû_šfo_©Œs
[] = {

337 
BTRFS_ATTR_PTR
(
æags
),

338 
BTRFS_ATTR_PTR
(
tÙ®_by‹s
),

339 
BTRFS_ATTR_PTR
(
by‹s_u£d
),

340 
BTRFS_ATTR_PTR
(
by‹s_pšÃd
),

341 
BTRFS_ATTR_PTR
(
by‹s_»£rved
),

342 
BTRFS_ATTR_PTR
(
by‹s_may_u£
),

343 
BTRFS_ATTR_PTR
(
by‹s_»adÚly
),

344 
BTRFS_ATTR_PTR
(
disk_u£d
),

345 
BTRFS_ATTR_PTR
(
disk_tÙ®
),

346 
BTRFS_ATTR_PTR
(
tÙ®_by‹s_pšÃd
),

347 
NULL
,

350 
	$¥aû_šfo_»Ëa£
(
kobjeù
 *
kobj
)

352 
bŒfs_¥aû_šfo
 *
sšfo
 = 
	`to_¥aû_šfo
(
kobj
);

353 
	`³rýu_couÁ”_de¡roy
(&
sšfo
->
tÙ®_by‹s_pšÃd
);

354 
	`kä“
(
sšfo
);

355 
	}
}

357 
kobj_ty³
 
	g¥aû_šfo_kty³
 = {

358 .
sysfs_Ýs
 = &
kobj_sysfs_Ýs
,

359 .
	g»Ëa£
 = 
¥aû_šfo_»Ëa£
,

360 .
	gdeçuÉ_©Œs
 = 
¥aû_šfo_©Œs
,

363 cÚ¡ 
©Œibu‹
 *
	g®loÿtiÚ_©Œs
[] = {

364 
BTRFS_ATTR_PTR
(
glob®_rsv_»£rved
),

365 
BTRFS_ATTR_PTR
(
glob®_rsv_size
),

366 
NULL
,

369 
ssize_t
 
	$bŒfs_Ïb–_show
(
kobjeù
 *
kobj
,

370 
kobj_©Œibu‹
 *
a
, *
buf
)

372 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

373 *
Ïb–
 = 
fs_šfo
->
su³r_cÝy
->label;

374 
ssize_t
 
»t
;

376 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

377 
»t
 = 
	`¢´štf
(
buf
, 
PAGE_SIZE
, 
Ïb–
[0] ? "%s\n" : "%s",†abel);

378 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

380  
»t
;

381 
	}
}

383 
ssize_t
 
	$bŒfs_Ïb–_¡Üe
(
kobjeù
 *
kobj
,

384 
kobj_©Œibu‹
 *
a
,

385 cÚ¡ *
buf
, 
size_t
 
Ën
)

387 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

388 
size_t
 
p_Ën
;

390 ià(!
fs_šfo
)

391  -
EPERM
;

393 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

394  -
EROFS
;

400 
p_Ën
 = 
	`¡rc¥n
(
buf
, "\n");

402 ià(
p_Ën
 >ð
BTRFS_LABEL_SIZE
)

403  -
EINVAL
;

405 
	`¥š_lock
(&
fs_šfo
->
su³r_lock
);

406 
	`mem£t
(
fs_šfo
->
su³r_cÝy
->
Ïb–
, 0, 
BTRFS_LABEL_SIZE
);

407 
	`memýy
(
fs_šfo
->
su³r_cÝy
->
Ïb–
, 
buf
, 
p_Ën
);

408 
	`¥š_uÆock
(&
fs_šfo
->
su³r_lock
);

413 
	`bŒfs_£t_³ndšg
(
fs_šfo
, 
COMMIT
);

414 
	`wake_up_´oûss
(
fs_šfo
->
Œª§ùiÚ_kth»ad
);

416  
Ën
;

417 
	}
}

418 
BTRFS_ATTR_RW
(
Ïb–
, 
bŒfs_Ïb–_show
, 
bŒfs_Ïb–_¡Üe
);

420 
ssize_t
 
	$bŒfs_nodesize_show
(
kobjeù
 *
kobj
,

421 
kobj_©Œibu‹
 *
a
, *
buf
)

423 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

425  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n", 
fs_šfo
->
su³r_cÝy
->
nodesize
);

426 
	}
}

428 
BTRFS_ATTR
(
nodesize
, 
bŒfs_nodesize_show
);

430 
ssize_t
 
	$bŒfs_£ùÜsize_show
(
kobjeù
 *
kobj
,

431 
kobj_©Œibu‹
 *
a
, *
buf
)

433 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

435  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n",

436 
fs_šfo
->
su³r_cÝy
->
£ùÜsize
);

437 
	}
}

439 
BTRFS_ATTR
(
£ùÜsize
, 
bŒfs_£ùÜsize_show
);

441 
ssize_t
 
	$bŒfs_þÚe_®ignm’t_show
(
kobjeù
 *
kobj
,

442 
kobj_©Œibu‹
 *
a
, *
buf
)

444 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

446  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%u\n",

447 
fs_šfo
->
su³r_cÝy
->
£ùÜsize
);

448 
	}
}

450 
BTRFS_ATTR
(
þÚe_®ignm’t
, 
bŒfs_þÚe_®ignm’t_show
);

452 
ssize_t
 
	$quÙa_ov”ride_show
(
kobjeù
 *
kobj
,

453 
kobj_©Œibu‹
 *
a
, *
buf
)

455 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

456 
quÙa_ov”ride
;

458 
quÙa_ov”ride
 = 
	`‹¡_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
);

459  
	`¢´štf
(
buf
, 
PAGE_SIZE
, "%d\n", 
quÙa_ov”ride
);

460 
	}
}

462 
ssize_t
 
	$quÙa_ov”ride_¡Üe
(
kobjeù
 *
kobj
,

463 
kobj_©Œibu‹
 *
a
,

464 cÚ¡ *
buf
, 
size_t
 
Ën
)

466 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`to_fs_šfo
(
kobj
);

467 
knob
;

468 
”r
;

470 ià(!
fs_šfo
)

471  -
EPERM
;

473 ià(!
	`ÿ·bË
(
CAP_SYS_RESOURCE
))

474  -
EPERM
;

476 
”r
 = 
	`k¡¹oul
(
buf
, 10, &
knob
);

477 ià(
”r
)

478  
”r
;

479 ià(
knob
 > 1)

480  -
EINVAL
;

482 ià(
knob
)

483 
	`£t_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
);

485 
	`þ—r_b™
(
BTRFS_FS_QUOTA_OVERRIDE
, &
fs_šfo
->
æags
);

487  
Ën
;

488 
	}
}

490 
BTRFS_ATTR_RW
(
quÙa_ov”ride
, 
quÙa_ov”ride_show
, 
quÙa_ov”ride_¡Üe
);

492 cÚ¡ 
©Œibu‹
 *
	gbŒfs_©Œs
[] = {

493 
BTRFS_ATTR_PTR
(
Ïb–
),

494 
BTRFS_ATTR_PTR
(
nodesize
),

495 
BTRFS_ATTR_PTR
(
£ùÜsize
),

496 
BTRFS_ATTR_PTR
(
þÚe_®ignm’t
),

497 
BTRFS_ATTR_PTR
(
quÙa_ov”ride
),

498 
NULL
,

501 
	$bŒfs_»Ëa£_fsid_kobj
(
kobjeù
 *
kobj
)

503 
bŒfs_fs_deviûs
 *
fs_devs
 = 
	`to_fs_devs
(
kobj
);

505 
	`mem£t
(&
fs_devs
->
fsid_kobj
, 0, (
kobjeù
));

506 
	`com¶‘e
(&
fs_devs
->
kobj_uÄegi¡”
);

507 
	}
}

509 
kobj_ty³
 
	gbŒfs_kty³
 = {

510 .
sysfs_Ýs
 = &
kobj_sysfs_Ýs
,

511 .
	g»Ëa£
 = 
bŒfs_»Ëa£_fsid_kobj
,

514 
šlše
 
bŒfs_fs_deviûs
 *
	$to_fs_devs
(
kobjeù
 *
kobj
)

516 ià(
kobj
->
kty³
 !ð&
bŒfs_kty³
)

517  
NULL
;

518  
	`cÚš”_of
(
kobj
, 
bŒfs_fs_deviûs
, 
fsid_kobj
);

519 
	}
}

521 
šlše
 
bŒfs_fs_šfo
 *
	$to_fs_šfo
(
kobjeù
 *
kobj
)

523 ià(
kobj
->
kty³
 !ð&
bŒfs_kty³
)

524  
NULL
;

525  
	`to_fs_devs
(
kobj
)->
fs_šfo
;

526 
	}
}

528 
	#NUM_FEATURE_BITS
 64

	)

529 
	gbŒfs_unknown_ã©u»_Çmes
[3][
NUM_FEATURE_BITS
][13];

530 
bŒfs_ã©u»_©Œ
 
	gbŒfs_ã©u»_©Œs
[3][
NUM_FEATURE_BITS
];

532 cÚ¡ 
u64
 
	gsuµÜ‹d_ã©u»_masks
[3] = {

533 [
FEAT_COMPAT
] = 
BTRFS_FEATURE_COMPAT_SUPP
,

534 [
FEAT_COMPAT_RO
] = 
BTRFS_FEATURE_COMPAT_RO_SUPP
,

535 [
FEAT_INCOMPAT
] = 
BTRFS_FEATURE_INCOMPAT_SUPP
,

538 
	$addrm_unknown_ã©u»_©Œs
(
bŒfs_fs_šfo
 *
fs_šfo
, 
boÞ
 
add
)

540 
£t
;

542 
£t
 = 0; s‘ < 
FEAT_MAX
; set++) {

543 
i
;

544 
©Œibu‹
 *
©Œs
[2];

545 
©Œibu‹_group
 
agroup
 = {

546 .
Çme
 = "features",

547 .
©Œs
 =‡ttrs,

549 
u64
 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
£t
);

550 
ã©u»s
 &ð~
suµÜ‹d_ã©u»_masks
[
£t
];

552 ià(!
ã©u»s
)

555 
©Œs
[1] = 
NULL
;

556 
i
 = 0; i < 
NUM_FEATURE_BITS
; i++) {

557 
bŒfs_ã©u»_©Œ
 *
ç
;

559 ià(!(
ã©u»s
 & (1ULL << 
i
)))

562 
ç
 = &
bŒfs_ã©u»_©Œs
[
£t
][
i
];

563 
©Œs
[0] = &
ç
->
kobj_©Œ
.
©Œ
;

564 ià(
add
) {

565 
»t
;

566 
»t
 = 
	`sysfs_m”ge_group
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
,

567 &
agroup
);

568 ià(
»t
)

569  
»t
;

571 
	`sysfs_unm”ge_group
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
,

572 &
agroup
);

577 
	}
}

579 
	$__bŒfs_sysfs_»move_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
)

581 ià(
fs_devs
->
deviû_dœ_kobj
) {

582 
	`kobjeù_d–
(
fs_devs
->
deviû_dœ_kobj
);

583 
	`kobjeù_put
(
fs_devs
->
deviû_dœ_kobj
);

584 
fs_devs
->
deviû_dœ_kobj
 = 
NULL
;

587 ià(
fs_devs
->
fsid_kobj
.
¡©e_š™Ÿlized
) {

588 
	`kobjeù_d–
(&
fs_devs
->
fsid_kobj
);

589 
	`kobjeù_put
(&
fs_devs
->
fsid_kobj
);

590 
	`wa™_fÜ_com¶‘iÚ
(&
fs_devs
->
kobj_uÄegi¡”
);

592 
	}
}

595 
	$bŒfs_sysfs_»move_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
)

597 
li¡_h—d
 *
fs_uuids
 = 
	`bŒfs_g‘_fs_uuids
();

599 ià(
fs_devs
) {

600 
	`__bŒfs_sysfs_»move_fsid
(
fs_devs
);

604 
	`li¡_fÜ_—ch_’Œy
(
fs_devs
, 
fs_uuids
, 
li¡
) {

605 
	`__bŒfs_sysfs_»move_fsid
(
fs_devs
);

607 
	}
}

609 
	$bŒfs_sysfs_»move_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
)

611 
	`bŒfs_»£t_fs_šfo_±r
(
fs_šfo
);

613 ià(
fs_šfo
->
¥aû_šfo_kobj
) {

614 
	`sysfs_»move_fžes
(
fs_šfo
->
¥aû_šfo_kobj
, 
®loÿtiÚ_©Œs
);

615 
	`kobjeù_d–
(
fs_šfo
->
¥aû_šfo_kobj
);

616 
	`kobjeù_put
(
fs_šfo
->
¥aû_šfo_kobj
);

618 
	`addrm_unknown_ã©u»_©Œs
(
fs_šfo
, 
çl£
);

619 
	`sysfs_»move_group
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
, &
bŒfs_ã©u»_©Œ_group
);

620 
	`sysfs_»move_fžes
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
, 
bŒfs_©Œs
);

621 
	`bŒfs_sysfs_rm_deviû_lšk
(
fs_šfo
->
fs_deviûs
, 
NULL
);

622 
	}
}

624 cÚ¡ * cÚ¡ 
	gbŒfs_ã©u»_£t_Çmes
[3] = {

625 [
FEAT_COMPAT
] = "compat",

626 [
FEAT_COMPAT_RO
] = "compat_ro",

627 [
FEAT_INCOMPAT
] = "incompat",

630 *
	$bŒfs_´šbË_ã©u»s
(
bŒfs_ã©u»_£t
 
£t
, 
u64
 
æags
)

632 
size_t
 
bufsize
 = 4096;

633 
Ën
 = 0;

634 
i
;

635 *
¡r
;

637 
¡r
 = 
	`km®loc
(
bufsize
, 
GFP_KERNEL
);

638 ià(!
¡r
)

639  
¡r
;

641 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
[
£t
]); i++) {

642 cÚ¡ *
Çme
;

644 ià(!(
æags
 & (1ULL << 
i
)))

647 
Çme
 = 
bŒfs_ã©u»_©Œs
[
£t
][
i
].
kobj_©Œ
.
©Œ
.name;

648 
Ën
 +ð
	`¢´štf
(
¡r
 +†’, 
bufsize
 -†en, "%s%s",

649 
Ën
 ? "," : "", 
Çme
);

652  
¡r
;

653 
	}
}

655 
	$š™_ã©u»_©Œs
()

657 
bŒfs_ã©u»_©Œ
 *
ç
;

658 
£t
, 
i
;

660 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
bŒfs_unknown_ã©u»_Çmes
) !=

661 
	`ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
));

662 
	`BUILD_BUG_ON
(
	`ARRAY_SIZE
(
bŒfs_unknown_ã©u»_Çmes
[0]) !=

663 
	`ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
[0]));

665 
	`mem£t
(
bŒfs_ã©u»_©Œs
, 0, (btrfs_feature_attrs));

666 
	`mem£t
(
bŒfs_unknown_ã©u»_Çmes
, 0,

667 (
bŒfs_unknown_ã©u»_Çmes
));

669 
i
 = 0; 
bŒfs_suµÜ‹d_ã©u»_©Œs
[i]; i++) {

670 
bŒfs_ã©u»_©Œ
 *
sç
;

671 
©Œibu‹
 *
a
 = 
bŒfs_suµÜ‹d_ã©u»_©Œs
[
i
];

672 
b™
;

673 
sç
 = 
	`©Œ_to_bŒfs_ã©u»_©Œ
(
a
);

674 
b™
 = 
	`žog2
(
sç
->
ã©u»_b™
);

675 
ç
 = &
bŒfs_ã©u»_©Œs
[
sç
->
ã©u»_£t
][
b™
];

677 
ç
->
kobj_©Œ
.
©Œ
.
Çme
 = 
sç
->kobj_attr.attr.name;

680 
£t
 = 0; s‘ < 
FEAT_MAX
; set++) {

681 
i
 = 0; i < 
	`ARRAY_SIZE
(
bŒfs_ã©u»_©Œs
[
£t
]); i++) {

682 *
Çme
 = 
bŒfs_unknown_ã©u»_Çmes
[
£t
][
i
];

683 
ç
 = &
bŒfs_ã©u»_©Œs
[
£t
][
i
];

685 ià(
ç
->
kobj_©Œ
.
©Œ
.
Çme
)

688 
	`¢´štf
(
Çme
, 13, "%s:%u",

689 
bŒfs_ã©u»_£t_Çmes
[
£t
], 
i
);

691 
ç
->
kobj_©Œ
.
©Œ
.
Çme
 =‚ame;

692 
ç
->
kobj_©Œ
.
©Œ
.
mode
 = 
S_IRUGO
;

693 
ç
->
ã©u»_£t
 = 
£t
;

694 
ç
->
ã©u»_b™
 = 1ULL << 
i
;

697 
	}
}

701 
	$bŒfs_sysfs_rm_deviû_lšk
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

702 
bŒfs_deviû
 *
Úe_deviû
)

704 
hd_¡ruù
 *
disk
;

705 
kobjeù
 *
disk_kobj
;

707 ià(!
fs_deviûs
->
deviû_dœ_kobj
)

708  -
EINVAL
;

710 ià(
Úe_deviû
 && oÃ_deviû->
bdev
) {

711 
disk
 = 
Úe_deviû
->
bdev
->
bd_·¹
;

712 
disk_kobj
 = &
	`·¹_to_dev
(
disk
)->
kobj
;

714 
	`sysfs_»move_lšk
(
fs_deviûs
->
deviû_dœ_kobj
,

715 
disk_kobj
->
Çme
);

718 ià(
Úe_deviû
)

721 
	`li¡_fÜ_—ch_’Œy
(
Úe_deviû
,

722 &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

723 ià(!
Úe_deviû
->
bdev
)

725 
disk
 = 
Úe_deviû
->
bdev
->
bd_·¹
;

726 
disk_kobj
 = &
	`·¹_to_dev
(
disk
)->
kobj
;

728 
	`sysfs_»move_lšk
(
fs_deviûs
->
deviû_dœ_kobj
,

729 
disk_kobj
->
Çme
);

733 
	}
}

735 
	$bŒfs_sysfs_add_deviû
(
bŒfs_fs_deviûs
 *
fs_devs
)

737 ià(!
fs_devs
->
deviû_dœ_kobj
)

738 
fs_devs
->
deviû_dœ_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("devices",

739 &
fs_devs
->
fsid_kobj
);

741 ià(!
fs_devs
->
deviû_dœ_kobj
)

742  -
ENOMEM
;

745 
	}
}

747 
	$bŒfs_sysfs_add_deviû_lšk
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

748 
bŒfs_deviû
 *
Úe_deviû
)

750 
”rÜ
 = 0;

751 
bŒfs_deviû
 *
dev
;

753 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

754 
hd_¡ruù
 *
disk
;

755 
kobjeù
 *
disk_kobj
;

757 ià(!
dev
->
bdev
)

760 ià(
Úe_deviû
 && oÃ_deviû !ð
dev
)

763 
disk
 = 
dev
->
bdev
->
bd_·¹
;

764 
disk_kobj
 = &
	`·¹_to_dev
(
disk
)->
kobj
;

766 
”rÜ
 = 
	`sysfs_ü—‹_lšk
(
fs_deviûs
->
deviû_dœ_kobj
,

767 
disk_kobj
, disk_kobj->
Çme
);

768 ià(
”rÜ
)

772  
”rÜ
;

773 
	}
}

776 
k£t
 *
	gbŒfs_k£t
;

779 
d’Œy
 *
	gbŒfs_debugfs_roÙ_d’Œy
;

782 
u64
 
	gbŒfs_debugfs_‹¡
;

788 
	$bŒfs_sysfs_add_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
,

789 
kobjeù
 *
·»Á
)

791 
”rÜ
;

793 
	`š™_com¶‘iÚ
(&
fs_devs
->
kobj_uÄegi¡”
);

794 
fs_devs
->
fsid_kobj
.
k£t
 = 
bŒfs_k£t
;

795 
”rÜ
 = 
	`kobjeù_š™_ªd_add
(&
fs_devs
->
fsid_kobj
,

796 &
bŒfs_kty³
, 
·»Á
, "%pU", 
fs_devs
->
fsid
);

797  
”rÜ
;

798 
	}
}

800 
	$bŒfs_sysfs_add_mouÁed
(
bŒfs_fs_šfo
 *
fs_šfo
)

802 
”rÜ
;

803 
bŒfs_fs_deviûs
 *
fs_devs
 = 
fs_šfo
->
fs_deviûs
;

804 
kobjeù
 *
fsid_kobj
 = &
fs_devs
->fsid_kobj;

806 
	`bŒfs_£t_fs_šfo_±r
(
fs_šfo
);

808 
”rÜ
 = 
	`bŒfs_sysfs_add_deviû_lšk
(
fs_devs
, 
NULL
);

809 ià(
”rÜ
)

810  
”rÜ
;

812 
”rÜ
 = 
	`sysfs_ü—‹_fžes
(
fsid_kobj
, 
bŒfs_©Œs
);

813 ià(
”rÜ
) {

814 
	`bŒfs_sysfs_rm_deviû_lšk
(
fs_devs
, 
NULL
);

815  
”rÜ
;

818 
”rÜ
 = 
	`sysfs_ü—‹_group
(
fsid_kobj
,

819 &
bŒfs_ã©u»_©Œ_group
);

820 ià(
”rÜ
)

821 
çžu»
;

823 
”rÜ
 = 
	`addrm_unknown_ã©u»_©Œs
(
fs_šfo
, 
Œue
);

824 ià(
”rÜ
)

825 
çžu»
;

827 
fs_šfo
->
¥aû_šfo_kobj
 = 
	`kobjeù_ü—‹_ªd_add
("allocation",

828 
fsid_kobj
);

829 ià(!
fs_šfo
->
¥aû_šfo_kobj
) {

830 
”rÜ
 = -
ENOMEM
;

831 
çžu»
;

834 
”rÜ
 = 
	`sysfs_ü—‹_fžes
(
fs_šfo
->
¥aû_šfo_kobj
, 
®loÿtiÚ_©Œs
);

835 ià(
”rÜ
)

836 
çžu»
;

839 
çžu»
:

840 
	`bŒfs_sysfs_»move_mouÁed
(
fs_šfo
);

841  
”rÜ
;

842 
	}
}

849 
	$bŒfs_sysfs_ã©u»_upd©e
(
bŒfs_fs_šfo
 *
fs_šfo
,

850 
u64
 
b™
, 
bŒfs_ã©u»_£t
 
£t
)

852 
bŒfs_fs_deviûs
 *
fs_devs
;

853 
kobjeù
 *
fsid_kobj
;

854 
u64
 
ã©u»s
;

855 
»t
;

857 ià(!
fs_šfo
)

860 
ã©u»s
 = 
	`g‘_ã©u»s
(
fs_šfo
, 
£t
);

861 
	`ASSERT
(
b™
 & 
suµÜ‹d_ã©u»_masks
[
£t
]);

863 
fs_devs
 = 
fs_šfo
->
fs_deviûs
;

864 
fsid_kobj
 = &
fs_devs
->fsid_kobj;

866 ià(!
fsid_kobj
->
¡©e_š™Ÿlized
)

873 
	`sysfs_»move_group
(
fsid_kobj
, &
bŒfs_ã©u»_©Œ_group
);

874 
»t
 = 
	`sysfs_ü—‹_group
(
fsid_kobj
, &
bŒfs_ã©u»_©Œ_group
);

875 
	}
}

877 
	$bŒfs_š™_debugfs
()

879 #ifdeà
CONFIG_DEBUG_FS


880 
bŒfs_debugfs_roÙ_d’Œy
 = 
	`debugfs_ü—‹_dœ
("bŒfs", 
NULL
);

881 ià(!
bŒfs_debugfs_roÙ_d’Œy
)

882  -
ENOMEM
;

890 #ifdeà
CONFIG_BTRFS_DEBUG


891 
	`debugfs_ü—‹_u64
("‹¡", 
S_IRUGO
 | 
S_IWUSR
, 
bŒfs_debugfs_roÙ_d’Œy
,

892 &
bŒfs_debugfs_‹¡
);

897 
	}
}

899 
	$bŒfs_š™_sysfs
()

901 
»t
;

903 
bŒfs_k£t
 = 
	`k£t_ü—‹_ªd_add
("bŒfs", 
NULL
, 
fs_kobj
);

904 ià(!
bŒfs_k£t
)

905  -
ENOMEM
;

907 
»t
 = 
	`bŒfs_š™_debugfs
();

908 ià(
»t
)

909 
out1
;

911 
	`š™_ã©u»_©Œs
();

912 
»t
 = 
	`sysfs_ü—‹_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_ã©u»_©Œ_group
);

913 ià(
»t
)

914 
out2
;

917 
out2
:

918 
	`debugfs_»move_»cursive
(
bŒfs_debugfs_roÙ_d’Œy
);

919 
out1
:

920 
	`k£t_uÄegi¡”
(
bŒfs_k£t
);

922  
»t
;

923 
	}
}

925 
	$bŒfs_ex™_sysfs
()

927 
	`sysfs_»move_group
(&
bŒfs_k£t
->
kobj
, &
bŒfs_ã©u»_©Œ_group
);

928 
	`k£t_uÄegi¡”
(
bŒfs_k£t
);

929 
	`debugfs_»move_»cursive
(
bŒfs_debugfs_roÙ_d’Œy
);

930 
	}
}

	@sysfs.h

2 #iâdeà
_BTRFS_SYSFS_H_


3 
	#_BTRFS_SYSFS_H_


	)

8 
u64
 
bŒfs_debugfs_‹¡
;

10 
	ebŒfs_ã©u»_£t
 {

11 
	mFEAT_COMPAT
,

12 
	mFEAT_COMPAT_RO
,

13 
	mFEAT_INCOMPAT
,

14 
	mFEAT_MAX


17 
	#__INIT_KOBJ_ATTR
(
_Çme
, 
_mode
, 
_show
, 
_¡Üe
) \

19 .
©Œ
 = { .
Çme
 = 
	`__¡ršgify
(
_Çme
), .
mode
 = 
_mode
 }, \

20 .
show
 = 
_show
, \

21 .
¡Üe
 = 
_¡Üe
, \

22 }

	)

24 
	#BTRFS_ATTR_RW
(
_Çme
, 
_show
, 
_¡Üe
) \

25 
kobj_©Œibu‹
 
bŒfs_©Œ_
##
_Çme
 = \

26 
	`__INIT_KOBJ_ATTR
(
_Çme
, 0644, 
_show
, 
_¡Üe
)

	)

28 
	#BTRFS_ATTR
(
_Çme
, 
_show
) \

29 
kobj_©Œibu‹
 
bŒfs_©Œ_
##
_Çme
 = \

30 
	`__INIT_KOBJ_ATTR
(
_Çme
, 0444, 
_show
, 
NULL
)

	)

32 
	#BTRFS_ATTR_PTR
(
_Çme
è(&
bŒfs_©Œ_
##_Çme.
©Œ
)

	)

34 
	#BTRFS_RAID_ATTR
(
_Çme
, 
_show
) \

35 
kobj_©Œibu‹
 
bŒfs_¿id_©Œ_
##
_Çme
 = \

36 
	`__INIT_KOBJ_ATTR
(
_Çme
, 0444, 
_show
, 
NULL
)

	)

38 
	#BTRFS_RAID_ATTR_PTR
(
_Çme
è(&
bŒfs_¿id_©Œ_
##_Çme.
©Œ
)

	)

41 
	sbŒfs_ã©u»_©Œ
 {

42 
kobj_©Œibu‹
 
	mkobj_©Œ
;

43 
bŒfs_ã©u»_£t
 
	mã©u»_£t
;

44 
u64
 
	mã©u»_b™
;

47 
	#BTRFS_FEAT_ATTR
(
_Çme
, 
_ã©u»_£t
, 
_´efix
, 
_ã©u»_b™
) \

48 
bŒfs_ã©u»_©Œ
 
bŒfs_©Œ_
##
_Çme
 = { \

49 .
kobj_©Œ
 = 
	`__INIT_KOBJ_ATTR
(
_Çme
, 
S_IRUGO
, \

50 
bŒfs_ã©u»_©Œ_show
, \

51 
bŒfs_ã©u»_©Œ_¡Üe
), \

52 .
ã©u»_£t
 = 
_ã©u»_£t
, \

53 .
ã©u»_b™
 = 
_´efix
 ##
_
## 
_ã©u»_b™
, \

54 }

	)

55 
	#BTRFS_FEAT_ATTR_PTR
(
_Çme
è(&
bŒfs_©Œ_
##_Çme.
kobj_©Œ
.
©Œ
)

	)

57 
	#BTRFS_FEAT_ATTR_COMPAT
(
Çme
, 
ã©u»
) \

58 
	`BTRFS_FEAT_ATTR
(
Çme
, 
FEAT_COMPAT
, 
BTRFS_FEATURE_COMPAT
, 
ã©u»
)

	)

59 
	#BTRFS_FEAT_ATTR_COMPAT_RO
(
Çme
, 
ã©u»
) \

60 
	`BTRFS_FEAT_ATTR
(
Çme
, 
FEAT_COMPAT_RO
, 
BTRFS_FEATURE_COMPAT_RO
, 
ã©u»
)

	)

61 
	#BTRFS_FEAT_ATTR_INCOMPAT
(
Çme
, 
ã©u»
) \

62 
	`BTRFS_FEAT_ATTR
(
Çme
, 
FEAT_INCOMPAT
, 
BTRFS_FEATURE_INCOMPAT
, 
ã©u»
)

	)

65 
šlše
 
bŒfs_ã©u»_©Œ
 *

66 
	$to_bŒfs_ã©u»_©Œ
(
kobj_©Œibu‹
 *
a
)

68  
	`cÚš”_of
(
a
, 
bŒfs_ã©u»_©Œ
, 
kobj_©Œ
);

69 
	}
}

71 
šlše
 
kobj_©Œibu‹
 *
	$©Œ_to_bŒfs_©Œ
(
©Œibu‹
 *
©Œ
)

73  
	`cÚš”_of
(
©Œ
, 
kobj_©Œibu‹
,‡ttr);

74 
	}
}

76 
šlše
 
bŒfs_ã©u»_©Œ
 *

77 
	$©Œ_to_bŒfs_ã©u»_©Œ
(
©Œibu‹
 *
©Œ
)

79  
	`to_bŒfs_ã©u»_©Œ
(
	`©Œ_to_bŒfs_©Œ
(
©Œ
));

80 
	}
}

82 *
bŒfs_´šbË_ã©u»s
(
bŒfs_ã©u»_£t
 
£t
, 
u64
 
æags
);

83 cÚ¡ * cÚ¡ 
bŒfs_ã©u»_£t_Çmes
[3];

84 
kobj_ty³
 
¥aû_šfo_kty³
;

85 
kobj_ty³
 
bŒfs_¿id_kty³
;

86 
bŒfs_sysfs_add_deviû_lšk
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

87 
bŒfs_deviû
 *
Úe_deviû
);

88 
bŒfs_sysfs_rm_deviû_lšk
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

89 
bŒfs_deviû
 *
Úe_deviû
);

90 
bŒfs_sysfs_add_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
,

91 
kobjeù
 *
·»Á
);

92 
bŒfs_sysfs_add_deviû
(
bŒfs_fs_deviûs
 *
fs_devs
);

93 
bŒfs_sysfs_»move_fsid
(
bŒfs_fs_deviûs
 *
fs_devs
);

94 
bŒfs_sysfs_ã©u»_upd©e
(
bŒfs_fs_šfo
 *
fs_šfo
,

95 
u64
 
b™
, 
bŒfs_ã©u»_£t
 
£t
);

	@tags

1 !
	g_TAG_FILE_FORMAT
 2 /
ex‹nded
 
	gfÜm©
; --fÜm©=1 
wžl
 
nÙ
 
­³nd
 ;"o†ines/

2 !
	g_TAG_FILE_SORTED
 1 /0=
unsÜ‹d
, 1=
sÜ‹d
, 2=
fÞdÿ£
/

3 !
_TAG_PROGRAM_AUTHOR
 
D¬»n
 
H›b”t
 /
dh›b”t
@
u£rs
.
sourûfÜge
.
Ãt
/

4 !
_TAG_PROGRAM_NAME
 
Exub”ªt
 
Cgs


5 !
_TAG_PROGRAM_URL
 
h‰p
:

6 !
_TAG_PROGRAM_VERSION
 5.9~
svn20110310


7 
ADVANCE
 
ù»e
.
c
 5343;" d file:

8 
ADVANCE_ONLY_NEXT
 
	gù»e
.
	gc
 5344;" d file:

9 
ALLOC_CHUNK
 
	gù»e
.
	gh
 /^ 
	gALLOC_CHUNK
 = 5,
	g$
/;"ƒƒnum:btrfs_flush_state

10 
ASSERT
 
	gù»e
.
	gh
 3454;" d

11 
ASSERT
 
	gù»e
.
	gh
 3457;" d

12 
BACKREF_FOUND_SHARED
 
	gback»f
.
	gc
 31;" d file:

13 
BITMAP_FIRST_BYTE_MASK
 
	gex‹Á_io
.
	gh
 77;" d

14 
BITMAP_LAST_BYTE_MASK
 
	gex‹Á_io
.
	gh
 79;" d

15 
BITS_PER_BITMAP
 
	gä“
-
	g¥aû
-
	gÿche
.
	gc
 33;" d file:

16 
BITS_PER_BITMAP
 
	g‹¡s
/
	gä“
-
	g¥aû
-‹¡s.
	gc
 25;" d file:

17 
BIT_BYTE
 
	gex‹Á_io
.
	gh
 75;" d

18 
BTRFSIC_BLOCK_HASHTABLE_SIZE
 
	gcheck
-
	gš‹gr™y
.
	gc
 111;" d file:

19 
BTRFSIC_BLOCK_LINK_HASHTABLE_SIZE
 
	gcheck
-
	gš‹gr™y
.
	gc
 112;" d file:

20 
BTRFSIC_BLOCK_LINK_MAGIC_NUMBER
 
	gcheck
-
	gš‹gr™y
.
	gc
 115;" d file:

21 
BTRFSIC_BLOCK_MAGIC_NUMBER
 
	gcheck
-
	gš‹gr™y
.
	gc
 114;" d file:

22 
BTRFSIC_BLOCK_STACK_FRAME_MAGIC_NUMBER
 
	gcheck
-
	gš‹gr™y
.
	gc
 117;" d file:

23 
BTRFSIC_DEV2STATE_HASHTABLE_SIZE
 
	gcheck
-
	gš‹gr™y
.
	gc
 113;" d file:

24 
BTRFSIC_DEV2STATE_MAGIC_NUMBER
 
	gcheck
-
	gš‹gr™y
.
	gc
 116;" d file:

25 
BTRFSIC_GENERATION_UNKNOWN
 
	gcheck
-
	gš‹gr™y
.
	gc
 120;" d file:

26 
BTRFSIC_PRINT_MASK_END_IO_BIO_BH
 
	gcheck
-
	gš‹gr™y
.
	gc
 131;" d file:

27 
BTRFSIC_PRINT_MASK_INITIAL_ALL_TREES
 
	gcheck
-
	gš‹gr™y
.
	gc
 135;" d file:

28 
BTRFSIC_PRINT_MASK_INITIAL_DATABASE
 
	gcheck
-
	gš‹gr™y
.
	gc
 136;" d file:

29 
BTRFSIC_PRINT_MASK_INITIAL_TREE
 
	gcheck
-
	gš‹gr™y
.
	gc
 134;" d file:

30 
BTRFSIC_PRINT_MASK_NUM_COPIES
 
	gcheck
-
	gš‹gr™y
.
	gc
 137;" d file:

31 
BTRFSIC_PRINT_MASK_ROOT_CHUNK_LOG_TREE_LOCATION
 
	gcheck
-
	gš‹gr™y
.
	gc
 127;" d file:

32 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH
 
	gcheck
-
	gš‹gr™y
.
	gc
 130;" d file:

33 
BTRFSIC_PRINT_MASK_SUBMIT_BIO_BH_VERBOSE
 
	gcheck
-
	gš‹gr™y
.
	gc
 139;" d file:

34 
BTRFSIC_PRINT_MASK_SUPERBLOCK_WRITE
 
	gcheck
-
	gš‹gr™y
.
	gc
 126;" d file:

35 
BTRFSIC_PRINT_MASK_TREE_AFTER_SB_WRITE
 
	gcheck
-
	gš‹gr™y
.
	gc
 128;" d file:

36 
BTRFSIC_PRINT_MASK_TREE_BEFORE_SB_WRITE
 
	gcheck
-
	gš‹gr™y
.
	gc
 129;" d file:

37 
BTRFSIC_PRINT_MASK_TREE_WITH_ALL_MIRRORS
 
	gcheck
-
	gš‹gr™y
.
	gc
 138;" d file:

38 
BTRFSIC_PRINT_MASK_VERBOSE
 
	gcheck
-
	gš‹gr™y
.
	gc
 132;" d file:

39 
BTRFSIC_PRINT_MASK_VERY_VERBOSE
 
	gcheck
-
	gš‹gr™y
.
	gc
 133;" d file:

40 
BTRFSIC_TREE_DUMP_MAX_INDENT_LEVEL
 
	gcheck
-
	gš‹gr™y
.
	gc
 118;" d file:

41 
BTRFS_ADD_DELAYED_EXTENT
 
	gd–ayed
-
	g»f
.
	gh
 26;" d

42 
BTRFS_ADD_DELAYED_REF
 
	gd–ayed
-
	g»f
.
	gh
 24;" d

43 
BTRFS_ATTR
 
	gsysfs
.
	gh
 28;" d

44 
BTRFS_ATTR_PTR
 
	gsysfs
.
	gh
 32;" d

45 
BTRFS_ATTR_RW
 
	gsysfs
.
	gh
 24;" d

46 
BTRFS_BACKREF_REV_MASK
 
	gù»e
.
	gh
 131;" d

47 
BTRFS_BACKREF_REV_MAX
 
	gù»e
.
	gh
 129;" d

48 
BTRFS_BACKREF_REV_SHIFT
 
	gù»e
.
	gh
 130;" d

49 
BTRFS_BDEV_BLOCKSIZE
 
	gdisk
-
	gio
.
	gh
 34;" d

50 
BTRFS_BIO_INLINE_CSUM_SIZE
 
	gvÞumes
.
	gh
 264;" d

51 
BTRFS_BLOCK_RSV_CHUNK
 
	gù»e
.
	gh
 457;" d

52 
BTRFS_BLOCK_RSV_DELALLOC
 
	gù»e
.
	gh
 455;" d

53 
BTRFS_BLOCK_RSV_DELOPS
 
	gù»e
.
	gh
 458;" d

54 
BTRFS_BLOCK_RSV_EMPTY
 
	gù»e
.
	gh
 459;" d

55 
BTRFS_BLOCK_RSV_GLOBAL
 
	gù»e
.
	gh
 454;" d

56 
BTRFS_BLOCK_RSV_TEMP
 
	gù»e
.
	gh
 460;" d

57 
BTRFS_BLOCK_RSV_TRANS
 
	gù»e
.
	gh
 456;" d

58 
BTRFS_BYTES_TO_BLKS
 
	gù»e
.
	gh
 1445;" d

59 
BTRFS_CACHE_ERROR
 
	gù»e
.
	gh
 /^ 
	gBTRFS_CACHE_ERROR
 = 4,
	g$
/;"ƒƒnum:btrfs_caching_type

60 
BTRFS_CACHE_FAST
 
	gù»e
.
	gh
 /^ 
	gBTRFS_CACHE_FAST
 = 2,
	g$
/;"ƒƒnum:btrfs_caching_type

61 
BTRFS_CACHE_FINISHED
 
	gù»e
.
	gh
 /^ 
	gBTRFS_CACHE_FINISHED
 = 3,
	g$
/;"ƒƒnum:btrfs_caching_type

62 
BTRFS_CACHE_NO
 
	gù»e
.
	gh
 /^ 
	gBTRFS_CACHE_NO
 = 0,
	g$
/;"ƒƒnum:btrfs_caching_type

63 
BTRFS_CACHE_STARTED
 
	gù»e
.
	gh
 /^ 
	gBTRFS_CACHE_STARTED
 = 1,
	g$
/;"ƒƒnum:btrfs_caching_type

64 
BTRFS_COMPARE_TREE_CHANGED
 
	gù»e
.
	gh
 /^ 
	gBTRFS_COMPARE_TREE_CHANGED
,
	g$
/;"ƒƒnum:btrfs_compare_tree_result

65 
BTRFS_COMPARE_TREE_DELETED
 
	gù»e
.
	gh
 /^ 
	gBTRFS_COMPARE_TREE_DELETED
,
	g$
/;"ƒƒnum:btrfs_compare_tree_result

66 
BTRFS_COMPARE_TREE_NEW
 
	gù»e
.
	gh
 /^ 
	gBTRFS_COMPARE_TREE_NEW
,
	g$
/;"ƒƒnum:btrfs_compare_tree_result

67 
BTRFS_COMPARE_TREE_SAME
 
	gù»e
.
	gh
 /^ 
	gBTRFS_COMPARE_TREE_SAME
,
	g$
/;"ƒƒnum:btrfs_compare_tree_result

68 
BTRFS_COMPAT_EXTENT_TREE_V0
 
	gù»e
.
	gh
 68;" d

69 
BTRFS_COMPRESS_LZO
 
	gcom´essiÚ
.
	gh
 /^ 
	gBTRFS_COMPRESS_LZO
 = 2,
	g$
/;"ƒƒnum:btrfs_compression_type

70 
BTRFS_COMPRESS_NONE
 
	gcom´essiÚ
.
	gh
 /^ 
	gBTRFS_COMPRESS_NONE
 = 0,
	g$
/;"ƒƒnum:btrfs_compression_type

71 
BTRFS_COMPRESS_TYPES
 
	gcom´essiÚ
.
	gh
 /^ 
	gBTRFS_COMPRESS_TYPES
 = 3,
	g$
/;"ƒƒnum:btrfs_compression_type

72 
BTRFS_COMPRESS_ZLIB
 
	gcom´essiÚ
.
	gh
 /^ 
	gBTRFS_COMPRESS_ZLIB
 = 1,
	g$
/;"ƒƒnum:btrfs_compression_type

73 
BTRFS_COMPRESS_ZSTD
 
	gcom´essiÚ
.
	gh
 /^ 
	gBTRFS_COMPRESS_ZSTD
 = 3,
	g$
/;"ƒƒnum:btrfs_compression_type

74 
BTRFS_DC_CLEAR
 
	gù»e
.
	gh
 /^ 
	gBTRFS_DC_CLEAR
 = 2,
	g$
/;"ƒƒnum:btrfs_disk_cache_state

75 
BTRFS_DC_ERROR
 
	gù»e
.
	gh
 /^ 
	gBTRFS_DC_ERROR
 = 1,
	g$
/;"ƒƒnum:btrfs_disk_cache_state

76 
BTRFS_DC_SETUP
 
	gù»e
.
	gh
 /^ 
	gBTRFS_DC_SETUP
 = 3,
	g$
/;"ƒƒnum:btrfs_disk_cache_state

77 
BTRFS_DC_WRITTEN
 
	gù»e
.
	gh
 /^ 
	gBTRFS_DC_WRITTEN
 = 0,
	g$
/;"ƒƒnum:btrfs_disk_cache_state

78 
BTRFS_DEFAULT_COMMIT_INTERVAL
 
	gù»e
.
	gh
 1342;" d

79 
BTRFS_DEFAULT_MAX_INLINE
 
	gù»e
.
	gh
 1343;" d

80 
BTRFS_DEFRAG_BATCH
 
	gfže
.
	gc
 284;" d file:

81 
BTRFS_DELAYED_BACKGROUND
 
	gd–ayed
-
	gšode
.
	gc
 27;" d file:

82 
BTRFS_DELAYED_BATCH
 
	gd–ayed
-
	gšode
.
	gc
 28;" d file:

83 
BTRFS_DELAYED_DELETION_ITEM
 
	gd–ayed
-
	gšode
.
	gh
 34;" d

84 
BTRFS_DELAYED_INSERTION_ITEM
 
	gd–ayed
-
	gšode
.
	gh
 33;" d

85 
BTRFS_DELAYED_NODE_DEL_IREF
 
	gd–ayed
-
	gšode
.
	gh
 53;" d

86 
BTRFS_DELAYED_NODE_INODE_DIRTY
 
	gd–ayed
-
	gšode
.
	gh
 52;" d

87 
BTRFS_DELAYED_NODE_IN_LIST
 
	gd–ayed
-
	gšode
.
	gh
 51;" d

88 
BTRFS_DELAYED_WRITEBACK
 
	gd–ayed
-
	gšode
.
	gc
 26;" d file:

89 
BTRFS_DEVICE_GETSET_FUNCS
 
	gvÞumes
.
	gh
 160;" d

90 
BTRFS_DEVICE_GETSET_FUNCS
 
	gvÞumes
.
	gh
 184;" d

91 
BTRFS_DEVICE_GETSET_FUNCS
 
	gvÞumes
.
	gh
 204;" d

92 
BTRFS_DIO_ORIG_BIO_SUBMITTED
 
	gbŒfs_šode
.
	gh
 292;" d

93 
BTRFS_DIRTY_METADATA_THRESH
 
	gù»e
.
	gh
 97;" d

94 
BTRFS_DROP_DELAYED_REF
 
	gd–ayed
-
	g»f
.
	gh
 25;" d

95 
BTRFS_EMPTY_DIR_SIZE
 
	gù»e
.
	gh
 92;" d

96 
BTRFS_EXPORT_H
 
	gexpÜt
.
	gh
 3;" d

97 
BTRFS_FEATURE_COMPAT_RO_SAFE_CLEAR
 
	gù»e
.
	gh
 265;" d

98 
BTRFS_FEATURE_COMPAT_RO_SAFE_SET
 
	gù»e
.
	gh
 264;" d

99 
BTRFS_FEATURE_COMPAT_RO_SUPP
 
	gù»e
.
	gh
 260;" d

100 
BTRFS_FEATURE_COMPAT_SAFE_CLEAR
 
	gù»e
.
	gh
 258;" d

101 
BTRFS_FEATURE_COMPAT_SAFE_SET
 
	gù»e
.
	gh
 257;" d

102 
BTRFS_FEATURE_COMPAT_SUPP
 
	gù»e
.
	gh
 256;" d

103 
BTRFS_FEATURE_INCOMPAT_SAFE_CLEAR
 
	gù»e
.
	gh
 281;" d

104 
BTRFS_FEATURE_INCOMPAT_SAFE_SET
 
	gù»e
.
	gh
 279;" d

105 
BTRFS_FEATURE_INCOMPAT_SUPP
 
	gù»e
.
	gh
 267;" d

106 
BTRFS_FEAT_ATTR
 
	gsysfs
.
	gh
 47;" d

107 
BTRFS_FEAT_ATTR_COMPAT
 
	gsysfs
.
	gh
 57;" d

108 
BTRFS_FEAT_ATTR_COMPAT_RO
 
	gsysfs
.
	gh
 59;" d

109 
BTRFS_FEAT_ATTR_INCOMPAT
 
	gsysfs
.
	gh
 61;" d

110 
BTRFS_FEAT_ATTR_PTR
 
	gsysfs
.
	gh
 55;" d

111 
BTRFS_FID_SIZE_CONNECTABLE
 
	gexpÜt
.
	gc
 12;" d file:

112 
BTRFS_FID_SIZE_CONNECTABLE_ROOT
 
	gexpÜt
.
	gc
 14;" d file:

113 
BTRFS_FID_SIZE_NON_CONNECTABLE
 
	gexpÜt
.
	gc
 10;" d file:

114 
BTRFS_FIEMAP_FLAGS
 
	gšode
.
	gc
 8929;" d file:

115 
BTRFS_FILE_EXTENT_INLINE_DATA_START
 
	gù»e
.
	gh
 1295;" d

116 
BTRFS_FREE_SPACE_BITMAP_BITS
 
	gä“
-
	g¥aû
-
	gŒ“
.
	gh
 28;" d

117 
BTRFS_FREE_SPACE_BITMAP_SIZE
 
	gä“
-
	g¥aû
-
	gŒ“
.
	gh
 27;" d

118 
BTRFS_FS_BARRIER
 
	gù»e
.
	gh
 705;" d

119 
BTRFS_FS_BTREE_ERR
 
	gù»e
.
	gh
 714;" d

120 
BTRFS_FS_CLOSING_DONE
 
	gù»e
.
	gh
 707;" d

121 
BTRFS_FS_CLOSING_START
 
	gù»e
.
	gh
 706;" d

122 
BTRFS_FS_CREATING_FREE_SPACE_TREE
 
	gù»e
.
	gh
 713;" d

123 
BTRFS_FS_EXCL_OP
 
	gù»e
.
	gh
 725;" d

124 
BTRFS_FS_FROZEN
 
	gù»e
.
	gh
 719;" d

125 
BTRFS_FS_LOG1_ERR
 
	gù»e
.
	gh
 715;" d

126 
BTRFS_FS_LOG2_ERR
 
	gù»e
.
	gh
 716;" d

127 
BTRFS_FS_LOG_RECOVERING
 
	gù»e
.
	gh
 708;" d

128 
BTRFS_FS_OPEN
 
	gù»e
.
	gh
 709;" d

129 
BTRFS_FS_QUOTA_ENABLED
 
	gù»e
.
	gh
 710;" d

130 
BTRFS_FS_QUOTA_ENABLING
 
	gù»e
.
	gh
 711;" d

131 
BTRFS_FS_QUOTA_OVERRIDE
 
	gù»e
.
	gh
 717;" d

132 
BTRFS_FS_STATE_DEV_REPLACING
 
	gù»e
.
	gh
 126;" d

133 
BTRFS_FS_STATE_DUMMY_FS_INFO
 
	gù»e
.
	gh
 127;" d

134 
BTRFS_FS_STATE_ERROR
 
	gù»e
.
	gh
 123;" d

135 
BTRFS_FS_STATE_REMOUNTING
 
	gù»e
.
	gh
 124;" d

136 
BTRFS_FS_STATE_TRANS_ABORTED
 
	gù»e
.
	gh
 125;" d

137 
BTRFS_FS_UPDATE_UUID_TREE_GEN
 
	gù»e
.
	gh
 712;" d

138 
BTRFS_I
 
	gbŒfs_šode
.
	gh
 /^
šlše
 
bŒfs_šode
 *BTRFS_I(cÚ¡ 
šode
 *šode)
	g$
/;" f

139 
BTRFS_INODE_APPEND
 
	gù»e
.
	gh
 1431;" d

140 
BTRFS_INODE_COMPRESS
 
	gù»e
.
	gh
 1435;" d

141 
BTRFS_INODE_COPY_EVERYTHING
 
	gbŒfs_šode
.
	gh
 43;" d

142 
BTRFS_INODE_DELALLOC_META_RESERVED
 
	gbŒfs_šode
.
	gh
 39;" d

143 
BTRFS_INODE_DIRSYNC
 
	gù»e
.
	gh
 1434;" d

144 
BTRFS_INODE_DUMMY
 
	gbŒfs_šode
.
	gh
 37;" d

145 
BTRFS_INODE_HAS_ASYNC_EXTENT
 
	gbŒfs_šode
.
	gh
 41;" d

146 
BTRFS_INODE_HAS_ORPHAN_ITEM
 
	gbŒfs_šode
.
	gh
 40;" d

147 
BTRFS_INODE_HAS_PROPS
 
	gbŒfs_šode
.
	gh
 46;" d

148 
BTRFS_INODE_IMMUTABLE
 
	gù»e
.
	gh
 1430;" d

149 
BTRFS_INODE_IN_DEFRAG
 
	gbŒfs_šode
.
	gh
 38;" d

150 
BTRFS_INODE_IN_DELALLOC_LIST
 
	gbŒfs_šode
.
	gh
 44;" d

151 
BTRFS_INODE_NEEDS_FULL_SYNC
 
	gbŒfs_šode
.
	gh
 42;" d

152 
BTRFS_INODE_NOATIME
 
	gù»e
.
	gh
 1433;" d

153 
BTRFS_INODE_NOCOMPRESS
 
	gù»e
.
	gh
 1427;" d

154 
BTRFS_INODE_NODATACOW
 
	gù»e
.
	gh
 1425;" d

155 
BTRFS_INODE_NODATASUM
 
	gù»e
.
	gh
 1424;" d

156 
BTRFS_INODE_NODUMP
 
	gù»e
.
	gh
 1432;" d

157 
BTRFS_INODE_ORDERED_DATA_CLOSE
 
	gbŒfs_šode
.
	gh
 35;" d

158 
BTRFS_INODE_ORPHAN_META_RESERVED
 
	gbŒfs_šode
.
	gh
 36;" d

159 
BTRFS_INODE_PREALLOC
 
	gù»e
.
	gh
 1428;" d

160 
BTRFS_INODE_READDIO_NEED_LOCK
 
	gbŒfs_šode
.
	gh
 45;" d

161 
BTRFS_INODE_READONLY
 
	gù»e
.
	gh
 1426;" d

162 
BTRFS_INODE_ROOT_ITEM_INIT
 
	gù»e
.
	gh
 1437;" d

163 
BTRFS_INODE_SYNC
 
	gù»e
.
	gh
 1429;" d

164 
BTRFS_IOC_SET_RECEIVED_SUBVOL_32
 
	gioùl
.
	gc
 85;" d file:

165 
BTRFS_IOPRIO_READA
 
	gù»e
.
	gh
 95;" d

166 
BTRFS_LEAF_DATA_OFFSET
 
	gù»e
.
	gh
 1283;" d

167 
BTRFS_LEAF_DATA_SIZE
 
	gù»e
.
	gh
 /^
šlše
 
u32
 BTRFS_LEAF_DATA_SIZE(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)
	g$
/;" f

168 
BTRFS_LINK_MAX
 
	gù»e
.
	gh
 87;" d

169 
BTRFS_MAGIC
 
	gù»e
.
	gh
 62;" d

170 
BTRFS_MAP_DISCARD
 
	gvÞumes
.
	gh
 /^ 
	gBTRFS_MAP_DISCARD
,
	g$
/;"ƒƒnum:btrfs_map_op

171 
BTRFS_MAP_GET_READ_MIRRORS
 
	gvÞumes
.
	gh
 /^ 
	gBTRFS_MAP_GET_READ_MIRRORS
,
	g$
/;"ƒƒnum:btrfs_map_op

172 
BTRFS_MAP_READ
 
	gvÞumes
.
	gh
 /^ 
	gBTRFS_MAP_READ
,
	g$
/;"ƒƒnum:btrfs_map_op

173 
BTRFS_MAP_WRITE
 
	gvÞumes
.
	gh
 /^ 
	gBTRFS_MAP_WRITE
,
	g$
/;"ƒƒnum:btrfs_map_op

174 
BTRFS_MAX_COMPRESSED
 
	gcom´essiÚ
.
	gh
 33;" d

175 
BTRFS_MAX_DEDUPE_LEN
 
	gioùl
.
	gc
 3225;" d file:

176 
BTRFS_MAX_DEVS
 
	gvÞumes
.
	gc
 4575;" d file:

177 
BTRFS_MAX_DEVS_SYS_CHUNK
 
	gvÞumes
.
	gc
 4579;" d file:

178 
BTRFS_MAX_EXTENT_ITEM_SIZE
 
	gù»e
.
	gh
 350;" d

179 
BTRFS_MAX_EXTENT_SIZE
 
	gù»e
.
	gh
 99;" d

180 
BTRFS_MAX_INLINE_DATA_SIZE
 
	gù»e
.
	gh
 /^
šlše
 
u32
 BTRFS_MAX_INLINE_DATA_SIZE(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)
	g$
/;" f

181 
BTRFS_MAX_ITEM_SIZE
 
	gù»e
.
	gh
 /^
šlše
 
u32
 BTRFS_MAX_ITEM_SIZE(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)
	g$
/;" f

182 
BTRFS_MAX_LEVEL
 
	gù»e
.
	gh
 66;" d

183 
BTRFS_MAX_METADATA_BLOCKSIZE
 
	gù»e
.
	gh
 74;" d

184 
BTRFS_MAX_MIRRORS
 
	gù»e
.
	gh
 64;" d

185 
BTRFS_MAX_UNCOMPRESSED
 
	gcom´essiÚ
.
	gh
 35;" d

186 
BTRFS_MAX_XATTR_SIZE
 
	gù»e
.
	gh
 /^
šlše
 
u32
 BTRFS_MAX_XATTR_SIZE(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)
	g$
/;" f

187 
BTRFS_MINOR
 
	gsu³r
.
	gc
 /^
MODULE_ALIAS_MISCDEV
(BTRFS_MINOR);
	g$
/;" v

188 
BTRFS_MIXED_BACKREF_REV
 
	gù»e
.
	gh
 135;" d

189 
BTRFS_MOUNT_AUTO_DEFRAG
 
	gù»e
.
	gh
 1329;" d

190 
BTRFS_MOUNT_CHECK_INTEGRITY
 
	gù»e
.
	gh
 1333;" d

191 
BTRFS_MOUNT_CHECK_INTEGRITY_INCLUDING_EXTENT_DATA
 
	gù»e
.
	gh
 1334;" d

192 
BTRFS_MOUNT_CLEAR_CACHE
 
	gù»e
.
	gh
 1326;" d

193 
BTRFS_MOUNT_COMPRESS
 
	gù»e
.
	gh
 1318;" d

194 
BTRFS_MOUNT_DEGRADED
 
	gù»e
.
	gh
 1317;" d

195 
BTRFS_MOUNT_DISCARD
 
	gù»e
.
	gh
 1323;" d

196 
BTRFS_MOUNT_ENOSPC_DEBUG
 
	gù»e
.
	gh
 1328;" d

197 
BTRFS_MOUNT_FLUSHONCOMMIT
 
	gù»e
.
	gh
 1320;" d

198 
BTRFS_MOUNT_FORCE_COMPRESS
 
	gù»e
.
	gh
 1324;" d

199 
BTRFS_MOUNT_FRAGMENT_DATA
 
	gù»e
.
	gh
 1337;" d

200 
BTRFS_MOUNT_FRAGMENT_METADATA
 
	gù»e
.
	gh
 1338;" d

201 
BTRFS_MOUNT_FREE_SPACE_TREE
 
	gù»e
.
	gh
 1339;" d

202 
BTRFS_MOUNT_INODE_MAP_CACHE
 
	gù»e
.
	gh
 1330;" d

203 
BTRFS_MOUNT_NOBARRIER
 
	gù»e
.
	gh
 1315;" d

204 
BTRFS_MOUNT_NODATACOW
 
	gù»e
.
	gh
 1314;" d

205 
BTRFS_MOUNT_NODATASUM
 
	gù»e
.
	gh
 1313;" d

206 
BTRFS_MOUNT_NOLOGREPLAY
 
	gù»e
.
	gh
 1340;" d

207 
BTRFS_MOUNT_NOSSD
 
	gù»e
.
	gh
 1322;" d

208 
BTRFS_MOUNT_NOTREELOG
 
	gù»e
.
	gh
 1319;" d

209 
BTRFS_MOUNT_PANIC_ON_FATAL_ERROR
 
	gù»e
.
	gh
 1335;" d

210 
BTRFS_MOUNT_RESCAN_UUID_TREE
 
	gù»e
.
	gh
 1336;" d

211 
BTRFS_MOUNT_SKIP_BALANCE
 
	gù»e
.
	gh
 1332;" d

212 
BTRFS_MOUNT_SPACE_CACHE
 
	gù»e
.
	gh
 1325;" d

213 
BTRFS_MOUNT_SSD
 
	gù»e
.
	gh
 1316;" d

214 
BTRFS_MOUNT_SSD_SPREAD
 
	gù»e
.
	gh
 1321;" d

215 
BTRFS_MOUNT_USEBACKUPROOT
 
	gù»e
.
	gh
 1331;" d

216 
BTRFS_MOUNT_USER_SUBVOL_RM_ALLOWED
 
	gù»e
.
	gh
 1327;" d

217 
BTRFS_NAME_LEN
 
	gù»e
.
	gh
 80;" d

218 
BTRFS_NODEPTRS_PER_BLOCK
 
	gù»e
.
	gh
 /^
šlše
 
u32
 BTRFS_NODEPTRS_PER_BLOCK(cÚ¡ 
bŒfs_fs_šfo
 *
šfo
)
	g$
/;" f

219 
BTRFS_NO_LOG_SYNC
 
	gŒ“
-
	glog
.
	gh
 26;" d

220 
BTRFS_NUM_BACKUP_ROOTS
 
	gù»e
.
	gh
 166;" d

221 
BTRFS_OLD_BACKREF_REV
 
	gù»e
.
	gh
 134;" d

222 
BTRFS_ORDERED_COMPLETE
 
	gÜd”ed
-
	gd©a
.
	gh
 55;" d

223 
BTRFS_ORDERED_COMPRESSED
 
	gÜd”ed
-
	gd©a
.
	gh
 59;" d

224 
BTRFS_ORDERED_DIRECT
 
	gÜd”ed
-
	gd©a
.
	gh
 63;" d

225 
BTRFS_ORDERED_IOERR
 
	gÜd”ed
-
	gd©a
.
	gh
 65;" d

226 
BTRFS_ORDERED_IO_DONE
 
	gÜd”ed
-
	gd©a
.
	gh
 53;" d

227 
BTRFS_ORDERED_LOGGED
 
	gÜd”ed
-
	gd©a
.
	gh
 74;" d

228 
BTRFS_ORDERED_LOGGED_CSUM
 
	gÜd”ed
-
	gd©a
.
	gh
 70;" d

229 
BTRFS_ORDERED_NOCOW
 
	gÜd”ed
-
	gd©a
.
	gh
 57;" d

230 
BTRFS_ORDERED_PENDING
 
	gÜd”ed
-
	gd©a
.
	gh
 76;" d

231 
BTRFS_ORDERED_PREALLOC
 
	gÜd”ed
-
	gd©a
.
	gh
 61;" d

232 
BTRFS_ORDERED_REGULAR
 
	gÜd”ed
-
	gd©a
.
	gh
 78;" d

233 
BTRFS_ORDERED_TRUNCATED
 
	gÜd”ed
-
	gd©a
.
	gh
 72;" d

234 
BTRFS_ORDERED_UPDATED_ISIZE
 
	gÜd”ed
-
	gd©a
.
	gh
 67;" d

235 
BTRFS_PENDING_CLEAR_INODE_MAP_CACHE
 
	gù»e
.
	gh
 1387;" d

236 
BTRFS_PENDING_COMMIT
 
	gù»e
.
	gh
 1388;" d

237 
BTRFS_PENDING_SET_INODE_MAP_CACHE
 
	gù»e
.
	gh
 1386;" d

238 
BTRFS_PROP_HANDLERS_HT_BITS
 
	g´Ýs
.
	gc
 27;" d file:

239 
BTRFS_RAID_ATTR
 
	gsysfs
.
	gh
 34;" d

240 
BTRFS_RAID_ATTR_PTR
 
	gsysfs
.
	gh
 38;" d

241 
BTRFS_RBIO_PARITY_SCRUB
 
	g¿id56
.
	gc
 /^ 
	gBTRFS_RBIO_PARITY_SCRUB
,
	g$
/;"ƒƒnum:btrfs_rbio_ops file:

242 
BTRFS_RBIO_READ_REBUILD
 
	g¿id56
.
	gc
 /^ 
	gBTRFS_RBIO_READ_REBUILD
,
	g$
/;"ƒƒnum:btrfs_rbio_ops file:

243 
BTRFS_RBIO_REBUILD_MISSING
 
	g¿id56
.
	gc
 /^ 
	gBTRFS_RBIO_REBUILD_MISSING
,
	g$
/;"ƒƒnum:btrfs_rbio_ops file:

244 
BTRFS_RBIO_WRITE
 
	g¿id56
.
	gc
 /^ 
	gBTRFS_RBIO_WRITE
,
	g$
/;"ƒƒnum:btrfs_rbio_ops file:

245 
BTRFS_READ_LOCK
 
	glockšg
.
	gh
 23;" d

246 
BTRFS_READ_LOCK_BLOCKING
 
	glockšg
.
	gh
 25;" d

247 
BTRFS_REF_TYPE_ANY
 
	gù»e
.
	gh
 /^ 
	gBTRFS_REF_TYPE_ANY
 = 3,
	g$
/;"ƒƒnum:btrfs_inline_ref_type

248 
BTRFS_REF_TYPE_BLOCK
 
	gù»e
.
	gh
 /^ 
	gBTRFS_REF_TYPE_BLOCK
 = 1,
	g$
/;"ƒƒnum:btrfs_inline_ref_type

249 
BTRFS_REF_TYPE_DATA
 
	gù»e
.
	gh
 /^ 
	gBTRFS_REF_TYPE_DATA
 = 2,
	g$
/;"ƒƒnum:btrfs_inline_ref_type

250 
BTRFS_REF_TYPE_INVALID
 
	gù»e
.
	gh
 /^ 
	gBTRFS_REF_TYPE_INVALID
 = 0,
	g$
/;"ƒƒnum:btrfs_inline_ref_type

251 
BTRFS_RESERVE_FLUSH_ALL
 
	gù»e
.
	gh
 /^ 
	gBTRFS_RESERVE_FLUSH_ALL
,
	g$
/;"ƒƒnum:btrfs_reserve_flush_enum

252 
BTRFS_RESERVE_FLUSH_LIMIT
 
	gù»e
.
	gh
 /^ 
	gBTRFS_RESERVE_FLUSH_LIMIT
,
	g$
/;"ƒƒnum:btrfs_reserve_flush_enum

253 
BTRFS_RESERVE_NO_FLUSH
 
	gù»e
.
	gh
 /^ 
	gBTRFS_RESERVE_NO_FLUSH
,
	g$
/;"ƒƒnum:btrfs_reserve_flush_enum

254 
BTRFS_ROOT_DEFRAG_RUNNING
 
	gù»e
.
	gh
 1130;" d

255 
BTRFS_ROOT_DIRTY
 
	gù»e
.
	gh
 1133;" d

256 
BTRFS_ROOT_FORCE_COW
 
	gù»e
.
	gh
 1131;" d

257 
BTRFS_ROOT_IN_RADIX
 
	gù»e
.
	gh
 1128;" d

258 
BTRFS_ROOT_IN_TRANS_SETUP
 
	gù»e
.
	gh
 1125;" d

259 
BTRFS_ROOT_MULTI_LOG_TASKS
 
	gù»e
.
	gh
 1132;" d

260 
BTRFS_ROOT_ORPHAN_ITEM_INSERTED
 
	gù»e
.
	gh
 1129;" d

261 
BTRFS_ROOT_REF_COWS
 
	gù»e
.
	gh
 1126;" d

262 
BTRFS_ROOT_TRACK_DIRTY
 
	gù»e
.
	gh
 1127;" d

263 
BTRFS_ROOT_TRANS_TAG
 
	gŒª§ùiÚ
.
	gc
 36;" d file:

264 
BTRFS_SEND_A_ATIME
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_ATIME
,
	g$
/;"ƒƒnum:__anon7

265 
BTRFS_SEND_A_CLONE_CTRANSID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CLONE_CTRANSID
,
	g$
/;"ƒƒnum:__anon7

266 
BTRFS_SEND_A_CLONE_LEN
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CLONE_LEN
,
	g$
/;"ƒƒnum:__anon7

267 
BTRFS_SEND_A_CLONE_OFFSET
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CLONE_OFFSET
,
	g$
/;"ƒƒnum:__anon7

268 
BTRFS_SEND_A_CLONE_PATH
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CLONE_PATH
,
	g$
/;"ƒƒnum:__anon7

269 
BTRFS_SEND_A_CLONE_UUID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CLONE_UUID
,
	g$
/;"ƒƒnum:__anon7

270 
BTRFS_SEND_A_CTIME
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CTIME
,
	g$
/;"ƒƒnum:__anon7

271 
BTRFS_SEND_A_CTRANSID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_CTRANSID
,
	g$
/;"ƒƒnum:__anon7

272 
BTRFS_SEND_A_DATA
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_DATA
,
	g$
/;"ƒƒnum:__anon7

273 
BTRFS_SEND_A_FILE_OFFSET
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_FILE_OFFSET
,
	g$
/;"ƒƒnum:__anon7

274 
BTRFS_SEND_A_GID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_GID
,
	g$
/;"ƒƒnum:__anon7

275 
BTRFS_SEND_A_INO
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_INO
,
	g$
/;"ƒƒnum:__anon7

276 
BTRFS_SEND_A_MAX
 
	g£nd
.
	gh
 130;" d

277 
BTRFS_SEND_A_MODE
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_MODE
,
	g$
/;"ƒƒnum:__anon7

278 
BTRFS_SEND_A_MTIME
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_MTIME
,
	g$
/;"ƒƒnum:__anon7

279 
BTRFS_SEND_A_OTIME
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_OTIME
,
	g$
/;"ƒƒnum:__anon7

280 
BTRFS_SEND_A_PATH
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_PATH
,
	g$
/;"ƒƒnum:__anon7

281 
BTRFS_SEND_A_PATH_LINK
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_PATH_LINK
,
	g$
/;"ƒƒnum:__anon7

282 
BTRFS_SEND_A_PATH_TO
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_PATH_TO
,
	g$
/;"ƒƒnum:__anon7

283 
BTRFS_SEND_A_RDEV
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_RDEV
,
	g$
/;"ƒƒnum:__anon7

284 
BTRFS_SEND_A_SIZE
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_SIZE
,
	g$
/;"ƒƒnum:__anon7

285 
BTRFS_SEND_A_UID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_UID
,
	g$
/;"ƒƒnum:__anon7

286 
BTRFS_SEND_A_UNSPEC
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_UNSPEC
,
	g$
/;"ƒƒnum:__anon7

287 
BTRFS_SEND_A_UUID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_UUID
,
	g$
/;"ƒƒnum:__anon7

288 
BTRFS_SEND_A_XATTR_DATA
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_XATTR_DATA
,
	g$
/;"ƒƒnum:__anon7

289 
BTRFS_SEND_A_XATTR_NAME
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_A_XATTR_NAME
,
	g$
/;"ƒƒnum:__anon7

290 
BTRFS_SEND_BUF_SIZE
 
	g£nd
.
	gh
 25;" d

291 
BTRFS_SEND_C_CHMOD
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_CHMOD
,
	g$
/;"ƒƒnum:btrfs_send_cmd

292 
BTRFS_SEND_C_CHOWN
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_CHOWN
,
	g$
/;"ƒƒnum:btrfs_send_cmd

293 
BTRFS_SEND_C_CLONE
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_CLONE
,
	g$
/;"ƒƒnum:btrfs_send_cmd

294 
BTRFS_SEND_C_END
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_END
,
	g$
/;"ƒƒnum:btrfs_send_cmd

295 
BTRFS_SEND_C_LINK
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_LINK
,
	g$
/;"ƒƒnum:btrfs_send_cmd

296 
BTRFS_SEND_C_MAX
 
	g£nd
.
	gh
 92;" d

297 
BTRFS_SEND_C_MKDIR
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_MKDIR
,
	g$
/;"ƒƒnum:btrfs_send_cmd

298 
BTRFS_SEND_C_MKFIFO
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_MKFIFO
,
	g$
/;"ƒƒnum:btrfs_send_cmd

299 
BTRFS_SEND_C_MKFILE
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_MKFILE
,
	g$
/;"ƒƒnum:btrfs_send_cmd

300 
BTRFS_SEND_C_MKNOD
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_MKNOD
,
	g$
/;"ƒƒnum:btrfs_send_cmd

301 
BTRFS_SEND_C_MKSOCK
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_MKSOCK
,
	g$
/;"ƒƒnum:btrfs_send_cmd

302 
BTRFS_SEND_C_REMOVE_XATTR
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_REMOVE_XATTR
,
	g$
/;"ƒƒnum:btrfs_send_cmd

303 
BTRFS_SEND_C_RENAME
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_RENAME
,
	g$
/;"ƒƒnum:btrfs_send_cmd

304 
BTRFS_SEND_C_RMDIR
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_RMDIR
,
	g$
/;"ƒƒnum:btrfs_send_cmd

305 
BTRFS_SEND_C_SET_XATTR
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_SET_XATTR
,
	g$
/;"ƒƒnum:btrfs_send_cmd

306 
BTRFS_SEND_C_SNAPSHOT
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_SNAPSHOT
,
	g$
/;"ƒƒnum:btrfs_send_cmd

307 
BTRFS_SEND_C_SUBVOL
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_SUBVOL
,
	g$
/;"ƒƒnum:btrfs_send_cmd

308 
BTRFS_SEND_C_SYMLINK
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_SYMLINK
,
	g$
/;"ƒƒnum:btrfs_send_cmd

309 
BTRFS_SEND_C_TRUNCATE
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_TRUNCATE
,
	g$
/;"ƒƒnum:btrfs_send_cmd

310 
BTRFS_SEND_C_UNLINK
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_UNLINK
,
	g$
/;"ƒƒnum:btrfs_send_cmd

311 
BTRFS_SEND_C_UNSPEC
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_UNSPEC
,
	g$
/;"ƒƒnum:btrfs_send_cmd

312 
BTRFS_SEND_C_UPDATE_EXTENT
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_UPDATE_EXTENT
,
	g$
/;"ƒƒnum:btrfs_send_cmd

313 
BTRFS_SEND_C_UTIMES
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_UTIMES
,
	g$
/;"ƒƒnum:btrfs_send_cmd

314 
BTRFS_SEND_C_WRITE
 
	g£nd
.
	gh
 /^ 
	gBTRFS_SEND_C_WRITE
,
	g$
/;"ƒƒnum:btrfs_send_cmd

315 
BTRFS_SEND_READ_SIZE
 
	g£nd
.
	gh
 26;" d

316 
BTRFS_SEND_STREAM_MAGIC
 
	g£nd
.
	gh
 22;" d

317 
BTRFS_SEND_STREAM_VERSION
 
	g£nd
.
	gh
 23;" d

318 
BTRFS_SEND_TRANS_STUB
 
	gŒª§ùiÚ
.
	gh
 108;" d

319 
BTRFS_SETGET_FUNCS
 
	gù»e
.
	gh
 1497;" d

320 
BTRFS_SETGET_HEADER_FUNCS
 
	gù»e
.
	gh
 1525;" d

321 
BTRFS_SETGET_STACK_FUNCS
 
	gù»e
.
	gh
 1539;" d

322 
BTRFS_STRIPE_HASH_TABLE_BITS
 
	gù»e
.
	gh
 694;" d

323 
BTRFS_STRIPE_LEN
 
	gvÞumes
.
	gh
 29;" d

324 
BTRFS_SUPER_FLAG_SUPP
 
	gdisk
-
	gio
.
	gc
 58;" d file:

325 
BTRFS_SUPER_INFO_OFFSET
 
	gdisk
-
	gio
.
	gh
 22;" d

326 
BTRFS_SUPER_INFO_SIZE
 
	gdisk
-
	gio
.
	gh
 23;" d

327 
BTRFS_SUPER_MIRROR_MAX
 
	gdisk
-
	gio
.
	gh
 25;" d

328 
BTRFS_SUPER_MIRROR_SHIFT
 
	gdisk
-
	gio
.
	gh
 26;" d

329 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
 
	gù»e
.
	gh
 159;" d

330 
BTRFS_TLV_BINARY
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_BINARY
,
	g$
/;"ƒƒnum:btrfs_tlv_type

331 
BTRFS_TLV_STRING
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_STRING
,
	g$
/;"ƒƒnum:btrfs_tlv_type

332 
BTRFS_TLV_TIMESPEC
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_TIMESPEC
,
	g$
/;"ƒƒnum:btrfs_tlv_type

333 
BTRFS_TLV_U16
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_U16
,
	g$
/;"ƒƒnum:btrfs_tlv_type

334 
BTRFS_TLV_U32
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_U32
,
	g$
/;"ƒƒnum:btrfs_tlv_type

335 
BTRFS_TLV_U64
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_U64
,
	g$
/;"ƒƒnum:btrfs_tlv_type

336 
BTRFS_TLV_U8
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_U8
,
	g$
/;"ƒƒnum:btrfs_tlv_type

337 
BTRFS_TLV_UUID
 
	g£nd
.
	gh
 /^ 
	gBTRFS_TLV_UUID
,
	g$
/;"ƒƒnum:btrfs_tlv_type

338 
BTRFS_TRANS_CACHE_ENOSPC
 
	gŒª§ùiÚ
.
	gh
 39;" d

339 
BTRFS_TRANS_DIRTY_BG_RUN
 
	gŒª§ùiÚ
.
	gh
 38;" d

340 
BTRFS_TRANS_HAVE_FREE_BGS
 
	gŒª§ùiÚ
.
	gh
 37;" d

341 
BTRFS_UPDATE_DELAYED_HEAD
 
	gd–ayed
-
	g»f
.
	gh
 27;" d

342 
BTRFS_WORK_HELPER
 
	gasync
-
	gth»ad
.
	gc
 69;" d file:

343 
BTRFS_WORK_HELPER_PROTO
 
	gasync
-
	gth»ad
.
	gh
 44;" d

344 
BTRFS_WQ_ENDIO_DATA
 
	gdisk
-
	gio
.
	gh
 /^ 
	gBTRFS_WQ_ENDIO_DATA
 = 0,
	g$
/;"ƒƒnum:btrfs_wq_endio_type

345 
BTRFS_WQ_ENDIO_DIO_REPAIR
 
	gdisk
-
	gio
.
	gh
 /^ 
	gBTRFS_WQ_ENDIO_DIO_REPAIR
 = 4,
	g$
/;"ƒƒnum:btrfs_wq_endio_type

346 
BTRFS_WQ_ENDIO_FREE_SPACE
 
	gdisk
-
	gio
.
	gh
 /^ 
	gBTRFS_WQ_ENDIO_FREE_SPACE
 = 2,
	g$
/;"ƒƒnum:btrfs_wq_endio_type

347 
BTRFS_WQ_ENDIO_METADATA
 
	gdisk
-
	gio
.
	gh
 /^ 
	gBTRFS_WQ_ENDIO_METADATA
 = 1,
	g$
/;"ƒƒnum:btrfs_wq_endio_type

348 
BTRFS_WQ_ENDIO_RAID56
 
	gdisk
-
	gio
.
	gh
 /^ 
	gBTRFS_WQ_ENDIO_RAID56
 = 3,
	g$
/;"ƒƒnum:btrfs_wq_endio_type

349 
BTRFS_WRITE_LOCK
 
	glockšg
.
	gh
 22;" d

350 
BTRFS_WRITE_LOCK_BLOCKING
 
	glockšg
.
	gh
 24;" d

351 
BUFFER_LRU_MAX
 
	gex‹Á_io
.
	gc
 101;" d file:

352 
BYTE_MASK
 
	gex‹Á_io
.
	gh
 76;" d

353 
CACHING_CTL_WAKE_UP
 
	gù»e
.
	gh
 526;" d

354 
CHUNK_ALLOC_FORCE
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gCHUNK_ALLOC_FORCE
 = 2,
	g$
/;"ƒƒnum:__anon8 file:

355 
CHUNK_ALLOC_LIMITED
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gCHUNK_ALLOC_LIMITED
 = 1,
	g$
/;"ƒƒnum:__anon8 file:

356 
CHUNK_ALLOC_NO_FORCE
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gCHUNK_ALLOC_NO_FORCE
 = 0,
	g$
/;"ƒƒnum:__anon8 file:

357 
COMMIT_TRANS
 
	gù»e
.
	gh
 /^ 
	gCOMMIT_TRANS
 = 6,
	g$
/;"ƒƒnum:btrfs_flush_state

358 
COPY_COMPLETE
 
	gsüub
.
	gc
 4359;" d file:

359 
CORRUPT
 
	gdisk
-
	gio
.
	gc
 546;" d file:

360 
CREATE_TRACE_POINTS
 
	gsu³r
.
	gc
 65;" d file:

361 
DEBUG
 
	g»ada
.
	gc
 32;" d file:

362 
DECLARE_BTRFS_SETGET_BITS
 
	gù»e
.
	gh
 1473;" d

363 
DEFINE_BTRFS_SETGET_BITS
 -
	gfuncs
.
	gc
 52;" d file:

364 
DESCRIBE_FLAG
 
	g»loÿtiÚ
.
	gc
 4313;" d file:

365 
DESCRIBE_FLAG
 
	g»loÿtiÚ
.
	gc
 4329;" d file:

366 
DFT_THRESHOLD
 
	gasync
-
	gth»ad
.
	gc
 33;" d file:

367 
DROP_REFERENCE
 
	gex‹Á
-
	gŒ“
.
	gc
 8576;" d file:

368 
EXTENT_BIO_COMPRESSED
 
	gex‹Á_io
.
	gh
 36;" d

369 
EXTENT_BIO_FLAG_SHIFT
 
	gex‹Á_io
.
	gh
 38;" d

370 
EXTENT_BIO_TREE_LOG
 
	gex‹Á_io
.
	gh
 37;" d

371 
EXTENT_BOUNDARY
 
	gex‹Á_io
.
	gh
 17;" d

372 
EXTENT_BUFFER_CORRUPT
 
	gex‹Á_io
.
	gh
 43;" d

373 
EXTENT_BUFFER_DIRTY
 
	gex‹Á_io
.
	gh
 42;" d

374 
EXTENT_BUFFER_DUMMY
 
	gex‹Á_io
.
	gh
 49;" d

375 
EXTENT_BUFFER_IN_TREE
 
	gex‹Á_io
.
	gh
 50;" d

376 
EXTENT_BUFFER_READAHEAD
 
	gex‹Á_io
.
	gh
 44;" d

377 
EXTENT_BUFFER_READ_ERR
 
	gex‹Á_io
.
	gh
 48;" d

378 
EXTENT_BUFFER_STALE
 
	gex‹Á_io
.
	gh
 46;" d

379 
EXTENT_BUFFER_TREE_REF
 
	gex‹Á_io
.
	gh
 45;" d

380 
EXTENT_BUFFER_UPTODATE
 
	gex‹Á_io
.
	gh
 41;" d

381 
EXTENT_BUFFER_WRITEBACK
 
	gex‹Á_io
.
	gh
 47;" d

382 
EXTENT_BUFFER_WRITE_ERR
 
	gex‹Á_io
.
	gh
 51;" d

383 
EXTENT_CLEAR_DATA_RESV
 
	gex‹Á_io
.
	gh
 25;" d

384 
EXTENT_CLEAR_META_RESV
 
	gex‹Á_io
.
	gh
 19;" d

385 
EXTENT_CTLBITS
 
	gex‹Á_io
.
	gh
 30;" d

386 
EXTENT_DAMAGED
 
	gex‹Á_io
.
	gh
 22;" d

387 
EXTENT_DEFRAG
 
	gex‹Á_io
.
	gh
 16;" d

388 
EXTENT_DELALLOC
 
	gex‹Á_io
.
	gh
 15;" d

389 
EXTENT_DELALLOC_NEW
 
	gex‹Á_io
.
	gh
 26;" d

390 
EXTENT_DIRTY
 
	gex‹Á_io
.
	gh
 10;" d

391 
EXTENT_DO_ACCOUNTING
 
	gex‹Á_io
.
	gh
 28;" d

392 
EXTENT_FIRST_DELALLOC
 
	gex‹Á_io
.
	gh
 20;" d

393 
EXTENT_FLAG_COMPRESSED
 
	gex‹Á_m­
.
	gh
 15;" d

394 
EXTENT_FLAG_FILLING
 
	gex‹Á_m­
.
	gh
 19;" d

395 
EXTENT_FLAG_FS_MAPPING
 
	gex‹Á_m­
.
	gh
 20;" d

396 
EXTENT_FLAG_LOGGING
 
	gex‹Á_m­
.
	gh
 18;" d

397 
EXTENT_FLAG_PINNED
 
	gex‹Á_m­
.
	gh
 14;" d

398 
EXTENT_FLAG_PREALLOC
 
	gex‹Á_m­
.
	gh
 17;" d

399 
EXTENT_FLAG_VACANCY
 
	gex‹Á_m­
.
	gh
 16;" d

400 
EXTENT_IOBITS
 
	gex‹Á_io
.
	gh
 27;" d

401 
EXTENT_LOCKED
 
	gex‹Á_io
.
	gh
 13;" d

402 
EXTENT_MAP_DELALLOC
 
	gex‹Á_m­
.
	gh
 11;" d

403 
EXTENT_MAP_HOLE
 
	gex‹Á_m­
.
	gh
 9;" d

404 
EXTENT_MAP_INLINE
 
	gex‹Á_m­
.
	gh
 10;" d

405 
EXTENT_MAP_LAST_BYTE
 
	gex‹Á_m­
.
	gh
 8;" d

406 
EXTENT_NEED_WAIT
 
	gex‹Á_io
.
	gh
 21;" d

407 
EXTENT_NEW
 
	gex‹Á_io
.
	gh
 14;" d

408 
EXTENT_NODATASUM
 
	gex‹Á_io
.
	gh
 18;" d

409 
EXTENT_NORESERVE
 
	gex‹Á_io
.
	gh
 23;" d

410 
EXTENT_PAGE_PRIVATE
 
	gex‹Á_io
.
	gh
 66;" d

411 
EXTENT_QGROUP_RESERVED
 
	gex‹Á_io
.
	gh
 24;" d

412 
EXTENT_SIZE_PER_ITEM
 
	gex‹Á
-
	gŒ“
.
	gc
 4838;" d file:

413 
EXTENT_UPTODATE
 
	gex‹Á_io
.
	gh
 12;" d

414 
EXTENT_WRITEBACK
 
	gex‹Á_io
.
	gh
 11;" d

415 
FEAT_COMPAT
 
	gsysfs
.
	gh
 /^ 
	gFEAT_COMPAT
,
	g$
/;"ƒƒnum:btrfs_feature_set

416 
FEAT_COMPAT_RO
 
	gsysfs
.
	gh
 /^ 
	gFEAT_COMPAT_RO
,
	g$
/;"ƒƒnum:btrfs_feature_set

417 
FEAT_INCOMPAT
 
	gsysfs
.
	gh
 /^ 
	gFEAT_INCOMPAT
,
	g$
/;"ƒƒnum:btrfs_feature_set

418 
FEAT_MAX
 
	gsysfs
.
	gh
 /^ 
	gFEAT_MAX$
/;"ƒƒnum:btrfs_feature_set

419 
FLUSH_DELALLOC
 
	gù»e
.
	gh
 /^ 
	gFLUSH_DELALLOC
 = 3,
	g$
/;"ƒƒnum:btrfs_flush_state

420 
FLUSH_DELALLOC_WAIT
 
	gù»e
.
	gh
 /^ 
	gFLUSH_DELALLOC_WAIT
 = 4,
	g$
/;"ƒƒnum:btrfs_flush_state

421 
FLUSH_DELAYED_ITEMS
 
	gù»e
.
	gh
 /^ 
	gFLUSH_DELAYED_ITEMS
 = 2,
	g$
/;"ƒƒnum:btrfs_flush_state

422 
FLUSH_DELAYED_ITEMS_NR
 
	gù»e
.
	gh
 /^ 
	gFLUSH_DELAYED_ITEMS_NR
 = 1,
	g$
/;"ƒƒnum:btrfs_flush_state

423 
FS_PATH_INLINE_SIZE
 
	g£nd
.
	gc
 65;" d file:

424 
INIT_FEATURE_FLAGS
 
	gioùl
.
	gc
 5321;" d file:

425 
INIT_THRESHOLD
 
	gšode
-
	gm­
.
	gc
 288;" d file:

426 
INLINE_EXTENT_BUFFER_PAGES
 
	gex‹Á_io
.
	gh
 165;" d

427 
INODES_PER_BITMAP
 
	gšode
-
	gm­
.
	gc
 289;" d file:

428 
KDIR
 
	gMakefže
 /^
	gKDIR
 :=\/
lib
\/
moduËs
\/
$
(
sh–l
 
uÇme
 -
r
)\/
bužd$
/;" m

429 
LOG_INODE_ALL
 
	gŒ“
-
	glog
.
	gc
 38;" d file:

430 
LOG_INODE_EXISTS
 
	gŒ“
-
	glog
.
	gc
 39;" d file:

431 
LOG_OTHER_INODE
 
	gŒ“
-
	glog
.
	gc
 40;" d file:

432 
LOG_WALK_PIN_ONLY
 
	gŒ“
-
	glog
.
	gc
 94;" d file:

433 
LOG_WALK_REPLAY_ALL
 
	gŒ“
-
	glog
.
	gc
 97;" d file:

434 
LOG_WALK_REPLAY_DIR_INDEX
 
	gŒ“
-
	glog
.
	gc
 96;" d file:

435 
LOG_WALK_REPLAY_INODES
 
	gŒ“
-
	glog
.
	gc
 95;" d file:

436 
LOOP_ALLOC_CHUNK
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gLOOP_ALLOC_CHUNK
 = 2,
	g$
/;"ƒƒnum:btrfs_loop_type file:

437 
LOOP_CACHING_NOWAIT
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gLOOP_CACHING_NOWAIT
 = 0,
	g$
/;"ƒƒnum:btrfs_loop_type file:

438 
LOOP_CACHING_WAIT
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gLOOP_CACHING_WAIT
 = 1,
	g$
/;"ƒƒnum:btrfs_loop_type file:

439 
LOOP_NO_EMPTY_SIZE
 
	gex‹Á
-
	gŒ“
.
	gc
 /^ 
	gLOOP_NO_EMPTY_SIZE
 = 3,
	g$
/;"ƒƒnum:btrfs_loop_type file:

440 
LOWER
 
	g»loÿtiÚ
.
	gc
 97;" d file:

441 
LZO_LEN
 
	glzo
.
	gc
 31;" d file:

442 
MAX_CACHE_BYTES_PER_GIG
 
	gä“
-
	g¥aû
-
	gÿche
.
	gc
 34;" d file:

443 
MAX_CSUM_ITEMS
 
	gfže
-
	g™em
.
	gc
 34;" d file:

444 
MAX_EXTENTS
 
	g»loÿtiÚ
.
	gc
 150;" d file:

445 
MAX_INLINE_EXTENT_BUFFER_SIZE
 
	gex‹Á_io
.
	gh
 166;" d

446 
MAX_IN_FLIGHT
 
	g»ada
.
	gc
 58;" d file:

447 
MAX_ORDERED_SUM_BYTES
 
	gfže
-
	g™em
.
	gc
 37;" d file:

448 
MOD_LOG_KEY_ADD
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_KEY_ADD
,
	g$
/;"ƒƒnum:mod_log_op file:

449 
MOD_LOG_KEY_REMOVE
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_KEY_REMOVE
,
	g$
/;"ƒƒnum:mod_log_op file:

450 
MOD_LOG_KEY_REMOVE_WHILE_FREEING
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_KEY_REMOVE_WHILE_FREEING
,
	g$
/;"ƒƒnum:mod_log_op file:

451 
MOD_LOG_KEY_REMOVE_WHILE_MOVING
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_KEY_REMOVE_WHILE_MOVING
,
	g$
/;"ƒƒnum:mod_log_op file:

452 
MOD_LOG_KEY_REPLACE
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_KEY_REPLACE
,
	g$
/;"ƒƒnum:mod_log_op file:

453 
MOD_LOG_MOVE_KEYS
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_MOVE_KEYS
,
	g$
/;"ƒƒnum:mod_log_op file:

454 
MOD_LOG_ROOT_REPLACE
 
	gù»e
.
	gc
 /^ 
	gMOD_LOG_ROOT_REPLACE
,
	g$
/;"ƒƒnum:mod_log_op file:

455 
MOVE_DATA_EXTENTS
 
	g»loÿtiÚ
.
	gc
 195;" d file:

456 
NO_THRESHOLD
 
	gasync
-
	gth»ad
.
	gc
 32;" d file:

457 
NUM_FEATURE_BITS
 
	gsysfs
.
	gc
 528;" d file:

458 
ORPHAN_CLEANUP_DONE
 
	gù»e
.
	gh
 /^ 
	gORPHAN_CLEANUP_DONE
 = 2,
	g$
/;"ƒƒnum:btrfs_orphan_cleanup_state

459 
ORPHAN_CLEANUP_STARTED
 
	gù»e
.
	gh
 /^ 
	gORPHAN_CLEANUP_STARTED
 = 1,
	g$
/;"ƒƒnum:btrfs_orphan_cleanup_state

460 
O±_aþ
 
	gsu³r
.
	gc
 /^ 
	gO±_nÛno¥c_debug
, 
	gO±_noæushÚcomm™
, 
	gO±_aþ
, 
	gO±_d©acow
,
	g$
/;"ƒƒnum:__anon9 file:

461 
O±_®loc_¡¬t
 
	gsu³r
.
	gc
 /^ 
	gO±_nod©acow
, 
	gO±_max_šlše
, 
	gO±_®loc_¡¬t
, 
	gO±_nob¬r›r
, 
	gO±_ssd
,
	g$
/;"ƒƒnum:__anon9 file:

462 
O±_b¬r›r
 
	gsu³r
.
	gc
 /^ 
	gO±_comm™_š‹rv®
, 
	gO±_b¬r›r
, 
	gO±_nodeäag
, 
	gO±_nodisÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

463 
O±_check_š‹gr™y
 
	gsu³r
.
	gc
 /^ 
	gO±_sk_b®ªû
, 
	gO±_check_š‹gr™y
,
	g$
/;"ƒƒnum:__anon9 file:

464 
O±_check_š‹gr™y_šþudšg_ex‹Á_d©a
 
	gsu³r
.
	gc
 /^ 
	gO±_check_š‹gr™y_šþudšg_ex‹Á_d©a
,
	g$
/;"ƒƒnum:__anon9 file:

465 
O±_check_š‹gr™y_´št_mask
 
	gsu³r
.
	gc
 /^ 
	gO±_check_š‹gr™y_´št_mask
, 
	gO±_çl_”rÜs
, 
	gO±_»sÿn_uuid_Œ“
,
	g$
/;"ƒƒnum:__anon9 file:

466 
O±_þ—r_ÿche
 
	gsu³r
.
	gc
 /^ 
	gO±_¥aû_ÿche
, 
	gO±_¥aû_ÿche_v”siÚ
, 
	gO±_þ—r_ÿche
,
	g$
/;"ƒƒnum:__anon9 file:

467 
O±_comm™_š‹rv®
 
	gsu³r
.
	gc
 /^ 
	gO±_comm™_š‹rv®
, 
	gO±_b¬r›r
, 
	gO±_nodeäag
, 
	gO±_nodisÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

468 
O±_com´ess
 
	gsu³r
.
	gc
 /^ 
	gO±_nossd
, 
	gO±_ssd_¥»ad
, 
	gO±_th»ad_poÞ
, 
	gO±_nßþ
, 
	gO±_com´ess
,
	g$
/;"ƒƒnum:__anon9 file:

469 
O±_com´ess_fÜû
 
	gsu³r
.
	gc
 /^ 
	gO±_com´ess_ty³
, 
	gO±_com´ess_fÜû
, 
	gO±_com´ess_fÜû_ty³
,
	g$
/;"ƒƒnum:__anon9 file:

470 
O±_com´ess_fÜû_ty³
 
	gsu³r
.
	gc
 /^ 
	gO±_com´ess_ty³
, 
	gO±_com´ess_fÜû
, 
	gO±_com´ess_fÜû_ty³
,
	g$
/;"ƒƒnum:__anon9 file:

471 
O±_com´ess_ty³
 
	gsu³r
.
	gc
 /^ 
	gO±_com´ess_ty³
, 
	gO±_com´ess_fÜû
, 
	gO±_com´ess_fÜû_ty³
,
	g$
/;"ƒƒnum:__anon9 file:

472 
O±_d©acow
 
	gsu³r
.
	gc
 /^ 
	gO±_nÛno¥c_debug
, 
	gO±_noæushÚcomm™
, 
	gO±_aþ
, 
	gO±_d©acow
,
	g$
/;"ƒƒnum:__anon9 file:

473 
O±_d©asum
 
	gsu³r
.
	gc
 /^ 
	gO±_d©asum
, 
	gO±_Œ“log
, 
	gO±_nošode_ÿche
, 
	gO±_u£backu´oÙ
,
	g$
/;"ƒƒnum:__anon9 file:

474 
O±_deäag
 
	gsu³r
.
	gc
 /^ 
	gO±_deäag
, 
	gO±_šode_ÿche
, 
	gO±_no_¥aû_ÿche
, 
	gO±_»cov”y
,
	g$
/;"ƒƒnum:__anon9 file:

475 
O±_deg¿ded
 
	gsu³r
.
	gc
 /^ 
	gO±_deg¿ded
, 
	gO±_subvÞ
, 
	gO±_subvÞid
, 
	gO±_deviû
, 
	gO±_nod©asum
,
	g$
/;"ƒƒnum:__anon9 file:

476 
O±_deviû
 
	gsu³r
.
	gc
 /^ 
	gO±_deg¿ded
, 
	gO±_subvÞ
, 
	gO±_subvÞid
, 
	gO±_deviû
, 
	gO±_nod©asum
,
	g$
/;"ƒƒnum:__anon9 file:

477 
O±_disÿrd
 
	gsu³r
.
	gc
 /^ 
	gO±_nÙ»–og
, 
	gO±_¿tio
, 
	gO±_æushÚcomm™
, 
	gO±_disÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

478 
O±_’o¥c_debug
 
	gsu³r
.
	gc
 /^ 
	gO±_u£r_subvÞ_rm_®lowed
, 
	gO±_’o¥c_debug
, 
	gO±_subvÞroÙid
,
	g$
/;"ƒƒnum:__anon9 file:

479 
O±_”r
 
	gsu³r
.
	gc
 /^ 
	gO±_”r
,
	g$
/;"ƒƒnum:__anon9 file:

480 
O±_çl_”rÜs
 
	gsu³r
.
	gc
 /^ 
	gO±_check_š‹gr™y_´št_mask
, 
	gO±_çl_”rÜs
, 
	gO±_»sÿn_uuid_Œ“
,
	g$
/;"ƒƒnum:__anon9 file:

481 
O±_æushÚcomm™
 
	gsu³r
.
	gc
 /^ 
	gO±_nÙ»–og
, 
	gO±_¿tio
, 
	gO±_æushÚcomm™
, 
	gO±_disÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

482 
O±_äagm’t_®l
 
	gsu³r
.
	gc
 /^ 
	gO±_äagm’t_d©a
, 
	gO±_äagm’t_m‘ad©a
, 
	gO±_äagm’t_®l
,
	g$
/;"ƒƒnum:__anon9 file:

483 
O±_äagm’t_d©a
 
	gsu³r
.
	gc
 /^ 
	gO±_äagm’t_d©a
, 
	gO±_äagm’t_m‘ad©a
, 
	gO±_äagm’t_®l
,
	g$
/;"ƒƒnum:__anon9 file:

484 
O±_äagm’t_m‘ad©a
 
	gsu³r
.
	gc
 /^ 
	gO±_äagm’t_d©a
, 
	gO±_äagm’t_m‘ad©a
, 
	gO±_äagm’t_®l
,
	g$
/;"ƒƒnum:__anon9 file:

485 
O±_šode_ÿche
 
	gsu³r
.
	gc
 /^ 
	gO±_deäag
, 
	gO±_šode_ÿche
, 
	gO±_no_¥aû_ÿche
, 
	gO±_»cov”y
,
	g$
/;"ƒƒnum:__anon9 file:

486 
O±_max_šlše
 
	gsu³r
.
	gc
 /^ 
	gO±_nod©acow
, 
	gO±_max_šlše
, 
	gO±_®loc_¡¬t
, 
	gO±_nob¬r›r
, 
	gO±_ssd
,
	g$
/;"ƒƒnum:__anon9 file:

487 
O±_no_¥aû_ÿche
 
	gsu³r
.
	gc
 /^ 
	gO±_deäag
, 
	gO±_šode_ÿche
, 
	gO±_no_¥aû_ÿche
, 
	gO±_»cov”y
,
	g$
/;"ƒƒnum:__anon9 file:

488 
O±_nßþ
 
	gsu³r
.
	gc
 /^ 
	gO±_nossd
, 
	gO±_ssd_¥»ad
, 
	gO±_th»ad_poÞ
, 
	gO±_nßþ
, 
	gO±_com´ess
,
	g$
/;"ƒƒnum:__anon9 file:

489 
O±_nob¬r›r
 
	gsu³r
.
	gc
 /^ 
	gO±_nod©acow
, 
	gO±_max_šlše
, 
	gO±_®loc_¡¬t
, 
	gO±_nob¬r›r
, 
	gO±_ssd
,
	g$
/;"ƒƒnum:__anon9 file:

490 
O±_nod©acow
 
	gsu³r
.
	gc
 /^ 
	gO±_nod©acow
, 
	gO±_max_šlše
, 
	gO±_®loc_¡¬t
, 
	gO±_nob¬r›r
, 
	gO±_ssd
,
	g$
/;"ƒƒnum:__anon9 file:

491 
O±_nod©asum
 
	gsu³r
.
	gc
 /^ 
	gO±_deg¿ded
, 
	gO±_subvÞ
, 
	gO±_subvÞid
, 
	gO±_deviû
, 
	gO±_nod©asum
,
	g$
/;"ƒƒnum:__anon9 file:

492 
O±_nodeäag
 
	gsu³r
.
	gc
 /^ 
	gO±_comm™_š‹rv®
, 
	gO±_b¬r›r
, 
	gO±_nodeäag
, 
	gO±_nodisÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

493 
O±_nodisÿrd
 
	gsu³r
.
	gc
 /^ 
	gO±_comm™_š‹rv®
, 
	gO±_b¬r›r
, 
	gO±_nodeäag
, 
	gO±_nodisÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

494 
O±_nÛno¥c_debug
 
	gsu³r
.
	gc
 /^ 
	gO±_nÛno¥c_debug
, 
	gO±_noæushÚcomm™
, 
	gO±_aþ
, 
	gO±_d©acow
,
	g$
/;"ƒƒnum:__anon9 file:

495 
O±_noæushÚcomm™
 
	gsu³r
.
	gc
 /^ 
	gO±_nÛno¥c_debug
, 
	gO±_noæushÚcomm™
, 
	gO±_aþ
, 
	gO±_d©acow
,
	g$
/;"ƒƒnum:__anon9 file:

496 
O±_nošode_ÿche
 
	gsu³r
.
	gc
 /^ 
	gO±_d©asum
, 
	gO±_Œ“log
, 
	gO±_nošode_ÿche
, 
	gO±_u£backu´oÙ
,
	g$
/;"ƒƒnum:__anon9 file:

497 
O±_nÞog»¶ay
 
	gsu³r
.
	gc
 /^ 
	gO±_nÞog»¶ay
, 
	gO±_nÜecov”y
,
	g$
/;"ƒƒnum:__anon9 file:

498 
O±_nÜecov”y
 
	gsu³r
.
	gc
 /^ 
	gO±_nÞog»¶ay
, 
	gO±_nÜecov”y
,
	g$
/;"ƒƒnum:__anon9 file:

499 
O±_nossd
 
	gsu³r
.
	gc
 /^ 
	gO±_nossd
, 
	gO±_ssd_¥»ad
, 
	gO±_th»ad_poÞ
, 
	gO±_nßþ
, 
	gO±_com´ess
,
	g$
/;"ƒƒnum:__anon9 file:

500 
O±_nÙ»–og
 
	gsu³r
.
	gc
 /^ 
	gO±_nÙ»–og
, 
	gO±_¿tio
, 
	gO±_æushÚcomm™
, 
	gO±_disÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

501 
O±_¿tio
 
	gsu³r
.
	gc
 /^ 
	gO±_nÙ»–og
, 
	gO±_¿tio
, 
	gO±_æushÚcomm™
, 
	gO±_disÿrd
,
	g$
/;"ƒƒnum:__anon9 file:

502 
O±_»cov”y
 
	gsu³r
.
	gc
 /^ 
	gO±_deäag
, 
	gO±_šode_ÿche
, 
	gO±_no_¥aû_ÿche
, 
	gO±_»cov”y
,
	g$
/;"ƒƒnum:__anon9 file:

503 
O±_»sÿn_uuid_Œ“
 
	gsu³r
.
	gc
 /^ 
	gO±_check_š‹gr™y_´št_mask
, 
	gO±_çl_”rÜs
, 
	gO±_»sÿn_uuid_Œ“
,
	g$
/;"ƒƒnum:__anon9 file:

504 
O±_sk_b®ªû
 
	gsu³r
.
	gc
 /^ 
	gO±_sk_b®ªû
, 
	gO±_check_š‹gr™y
,
	g$
/;"ƒƒnum:__anon9 file:

505 
O±_¥aû_ÿche
 
	gsu³r
.
	gc
 /^ 
	gO±_¥aû_ÿche
, 
	gO±_¥aû_ÿche_v”siÚ
, 
	gO±_þ—r_ÿche
,
	g$
/;"ƒƒnum:__anon9 file:

506 
O±_¥aû_ÿche_v”siÚ
 
	gsu³r
.
	gc
 /^ 
	gO±_¥aû_ÿche
, 
	gO±_¥aû_ÿche_v”siÚ
, 
	gO±_þ—r_ÿche
,
	g$
/;"ƒƒnum:__anon9 file:

507 
O±_ssd
 
	gsu³r
.
	gc
 /^ 
	gO±_nod©acow
, 
	gO±_max_šlše
, 
	gO±_®loc_¡¬t
, 
	gO±_nob¬r›r
, 
	gO±_ssd
,
	g$
/;"ƒƒnum:__anon9 file:

508 
O±_ssd_¥»ad
 
	gsu³r
.
	gc
 /^ 
	gO±_nossd
, 
	gO±_ssd_¥»ad
, 
	gO±_th»ad_poÞ
, 
	gO±_nßþ
, 
	gO±_com´ess
,
	g$
/;"ƒƒnum:__anon9 file:

509 
O±_subvÞ
 
	gsu³r
.
	gc
 /^ 
	gO±_deg¿ded
, 
	gO±_subvÞ
, 
	gO±_subvÞid
, 
	gO±_deviû
, 
	gO±_nod©asum
,
	g$
/;"ƒƒnum:__anon9 file:

510 
O±_subvÞid
 
	gsu³r
.
	gc
 /^ 
	gO±_deg¿ded
, 
	gO±_subvÞ
, 
	gO±_subvÞid
, 
	gO±_deviû
, 
	gO±_nod©asum
,
	g$
/;"ƒƒnum:__anon9 file:

511 
O±_subvÞroÙid
 
	gsu³r
.
	gc
 /^ 
	gO±_u£r_subvÞ_rm_®lowed
, 
	gO±_’o¥c_debug
, 
	gO±_subvÞroÙid
,
	g$
/;"ƒƒnum:__anon9 file:

512 
O±_th»ad_poÞ
 
	gsu³r
.
	gc
 /^ 
	gO±_nossd
, 
	gO±_ssd_¥»ad
, 
	gO±_th»ad_poÞ
, 
	gO±_nßþ
, 
	gO±_com´ess
,
	g$
/;"ƒƒnum:__anon9 file:

513 
O±_Œ“log
 
	gsu³r
.
	gc
 /^ 
	gO±_d©asum
, 
	gO±_Œ“log
, 
	gO±_nošode_ÿche
, 
	gO±_u£backu´oÙ
,
	g$
/;"ƒƒnum:__anon9 file:

514 
O±_u£backu´oÙ
 
	gsu³r
.
	gc
 /^ 
	gO±_d©asum
, 
	gO±_Œ“log
, 
	gO±_nošode_ÿche
, 
	gO±_u£backu´oÙ
,
	g$
/;"ƒƒnum:__anon9 file:

515 
O±_u£r_subvÞ_rm_®lowed
 
	gsu³r
.
	gc
 /^ 
	gO±_u£r_subvÞ_rm_®lowed
, 
	gO±_’o¥c_debug
, 
	gO±_subvÞroÙid
,
	g$
/;"ƒƒnum:__anon9 file:

516 
PAGE_CLEAR_DIRTY
 
	gex‹Á_io
.
	gh
 55;" d

517 
PAGE_END_WRITEBACK
 
	gex‹Á_io
.
	gh
 57;" d

518 
PAGE_LOCK
 
	gex‹Á_io
.
	gh
 60;" d

519 
PAGE_SET_ERROR
 
	gex‹Á_io
.
	gh
 59;" d

520 
PAGE_SET_PRIVATE2
 
	gex‹Á_io
.
	gh
 58;" d

521 
PAGE_SET_WRITEBACK
 
	gex‹Á_io
.
	gh
 56;" d

522 
PAGE_UNLOCK
 
	gex‹Á_io
.
	gh
 54;" d

523 
PREFTREE_INIT
 
	gback»f
.
	gc
 129;" d file:

524 
PROCESS_RELEASE
 
	g‹¡s
/
	gex‹Á
-
	gio
-‹¡s.
	gc
 28;" d file:

525 
PROCESS_TEST_LOCKED
 
	g‹¡s
/
	gex‹Á
-
	gio
-‹¡s.
	gc
 29;" d file:

526 
PROCESS_UNLOCK
 
	g‹¡s
/
	gex‹Á
-
	gio
-‹¡s.
	gc
 27;" d file:

527 
PWD
 
	gMakefže
 /^
	gPWD
 :ð
$
(
sh–l
 
pwd
)$/;" m

528 
QGROUP_FREE
 
	gqgroup
.
	gh
 113;" d

529 
QGROUP_RELEASE
 
	gqgroup
.
	gh
 112;" d

530 
QGROUP_RESERVE
 
	gqgroup
.
	gh
 111;" d

531 
RAID5_P_STRIPE
 
	g¿id56
.
	gh
 36;" d

532 
RAID6_Q_STRIPE
 
	g¿id56
.
	gh
 37;" d

533 
RBIO_CACHE_BIT
 
	g¿id56
.
	gc
 54;" d file:

534 
RBIO_CACHE_READY_BIT
 
	g¿id56
.
	gc
 59;" d file:

535 
RBIO_CACHE_SIZE
 
	g¿id56
.
	gc
 61;" d file:

536 
RBIO_RMW_LOCKED_BIT
 
	g¿id56
.
	gc
 48;" d file:

537 
READA_BACK
 
	gù»e
.
	gh
 /^’um { 
	mREADA_NONE
 = 0, 
	mREADA_BACK
, 
	mREADA_FORWARD
 };
	g$
/;"ƒƒnum:__anon11

538 
READA_FORWARD
 
	gù»e
.
	gh
 /^’um { 
	mREADA_NONE
 = 0, 
	mREADA_BACK
, 
	mREADA_FORWARD
 };
	g$
/;"ƒƒnum:__anon11

539 
READA_NONE
 
	gù»e
.
	gh
 /^’um { 
	mREADA_NONE
 = 0, 
	mREADA_BACK
, 
	mREADA_FORWARD
 };
	g$
/;"ƒƒnum:__anon11

540 
RELOCATION_RESERVED_NODES
 
	g»loÿtiÚ
.
	gc
 99;" d file:

541 
SCRAMBLE_DELAYED_REFS
 
	gex‹Á
-
	gŒ“
.
	gc
 42;" d file:

542 
SCRUB_BIOS_PER_SCTX
 
	gsüub
.
	gc
 58;" d file:

543 
SCRUB_MAX_PAGES_PER_BLOCK
 
	gsüub
.
	gc
 65;" d file:

544 
SCRUB_PAGES_PER_RD_BIO
 
	gsüub
.
	gc
 56;" d file:

545 
SCRUB_PAGES_PER_WR_BIO
 
	gsüub
.
	gc
 57;" d file:

546 
SEND_CTX_MAX_NAME_CACHE_SIZE
 
	g£nd
.
	gc
 78;" d file:

547 
SEND_CTX_NAME_CACHE_CLEAN_SIZE
 
	g£nd
.
	gc
 79;" d file:

548 
SEQ_LAST
 
	gù»e
.
	gh
 672;" d

549 
SEQ_LIST_INIT
 
	gù»e
.
	gh
 670;" d

550 
SPACE_INFO_ATTR
 
	gsysfs
.
	gc
 306;" d file:

551 
STATIC
 
	gù»e
.
	gh
 57;" d

552 
STATIC
 
	gù»e
.
	gh
 59;" d

553 
S_SHIFT
 
	gšode
.
	gc
 92;" d file:

554 
TLV_PUT
 
	g£nd
.
	gc
 613;" d file:

555 
TLV_PUT_BTRFS_TIMESPEC
 
	g£nd
.
	gc
 650;" d file:

556 
TLV_PUT_DEFINE_INT
 
	g£nd
.
	gc
 579;" d file:

557 
TLV_PUT_INT
 
	g£nd
.
	gc
 620;" d file:

558 
TLV_PUT_PATH
 
	g£nd
.
	gc
 637;" d file:

559 
TLV_PUT_STRING
 
	g£nd
.
	gc
 631;" d file:

560 
TLV_PUT_U16
 
	g£nd
.
	gc
 628;" d file:

561 
TLV_PUT_U32
 
	g£nd
.
	gc
 629;" d file:

562 
TLV_PUT_U64
 
	g£nd
.
	gc
 630;" d file:

563 
TLV_PUT_U8
 
	g£nd
.
	gc
 627;" d file:

564 
TLV_PUT_UUID
 
	g£nd
.
	gc
 644;" d file:

565 
TRANS_ATTACH
 
	gŒª§ùiÚ
.
	gh
 101;" d

566 
TRANS_EXTWRITERS
 
	gŒª§ùiÚ
.
	gh
 105;" d

567 
TRANS_JOIN
 
	gŒª§ùiÚ
.
	gh
 102;" d

568 
TRANS_JOIN_NOLOCK
 
	gŒª§ùiÚ
.
	gh
 103;" d

569 
TRANS_START
 
	gŒª§ùiÚ
.
	gh
 100;" d

570 
TRANS_STATE_BLOCKED
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_BLOCKED
 = 1,
	g$
/;"ƒƒnum:btrfs_trans_state

571 
TRANS_STATE_COMMIT_DOING
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_COMMIT_DOING
 = 3,
	g$
/;"ƒƒnum:btrfs_trans_state

572 
TRANS_STATE_COMMIT_START
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_COMMIT_START
 = 2,
	g$
/;"ƒƒnum:btrfs_trans_state

573 
TRANS_STATE_COMPLETED
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_COMPLETED
 = 5,
	g$
/;"ƒƒnum:btrfs_trans_state

574 
TRANS_STATE_MAX
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_MAX
 = 6,
	g$
/;"ƒƒnum:btrfs_trans_state

575 
TRANS_STATE_RUNNING
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_RUNNING
 = 0,
	g$
/;"ƒƒnum:btrfs_trans_state

576 
TRANS_STATE_UNBLOCKED
 
	gŒª§ùiÚ
.
	gh
 /^ 
	gTRANS_STATE_UNBLOCKED
 = 4,
	g$
/;"ƒƒnum:btrfs_trans_state

577 
TRANS_USERSPACE
 
	gŒª§ùiÚ
.
	gh
 99;" d

578 
ULIST_ITER_INIT
 
	guli¡
.
	gh
 73;" d

579 
UPDATE_BACKREF
 
	gex‹Á
-
	gŒ“
.
	gc
 8577;" d file:

580 
UPDATE_DATA_PTRS
 
	g»loÿtiÚ
.
	gc
 196;" d file:

581 
UPDATE_NEW
 
	gqgroup
.
	gc
 1706;" d file:

582 
UPDATE_OLD
 
	gqgroup
.
	gc
 1707;" d file:

583 
UPPER
 
	g»loÿtiÚ
.
	gc
 98;" d file:

584 
WAIT_COMPLETE
 
	gex‹Á_io
.
	gh
 435;" d

585 
WAIT_NONE
 
	gex‹Á_io
.
	gh
 434;" d

586 
WAIT_PAGE_LOCK
 
	gex‹Á_io
.
	gh
 436;" d

587 
WORK_DONE_BIT
 
	gasync
-
	gth»ad
.
	gc
 28;" d file:

588 
WORK_HIGH_PRIO_BIT
 
	gasync
-
	gth»ad
.
	gc
 30;" d file:

589 
WORK_ORDER_DONE_BIT
 
	gasync
-
	gth»ad
.
	gc
 29;" d file:

590 
ZSTD_BTRFS_DEFAULT_LEVEL
 
	gz¡d
.
	gc
 28;" d file:

591 
ZSTD_BTRFS_MAX_INPUT
 
	gz¡d
.
	gc
 27;" d file:

592 
ZSTD_BTRFS_MAX_WINDOWLOG
 
	gz¡d
.
	gc
 26;" d file:

593 
_BTRFS_SYSFS_H_
 
	gsysfs
.
	gh
 3;" d

594 
__BTRFS_ASYNC_THREAD_
 
	gasync
-
	gth»ad
.
	gh
 21;" d

595 
__BTRFS_BACKREF__
 
	gback»f
.
	gh
 20;" d

596 
__BTRFS_CHECK_INTEGRITY__
 
	gcheck
-
	gš‹gr™y
.
	gh
 20;" d

597 
__BTRFS_COMPRESSION_
 
	gcom´essiÚ
.
	gh
 20;" d

598 
__BTRFS_CTREE__
 
	gù»e
.
	gh
 20;" d

599 
__BTRFS_DEDUPE__
 
	gdedu³
.
	gh
 20;" d

600 
__BTRFS_DEV_REPLACE__
 
	gdev
-
	g»¶aû
.
	gh
 20;" d

601 
__BTRFS_FREE_SPACE_CACHE
 
	gä“
-
	g¥aû
-
	gÿche
.
	gh
 20;" d

602 
__BTRFS_FREE_SPACE_TREE
 
	gä“
-
	g¥aû
-
	gŒ“
.
	gh
 20;" d

603 
__BTRFS_INODE_MAP
 
	gšode
-
	gm­
.
	gh
 3;" d

604 
__BTRFS_I__
 
	gbŒfs_šode
.
	gh
 20;" d

605 
__BTRFS_LOCKING_
 
	glockšg
.
	gh
 20;" d

606 
__BTRFS_MATH_H
 
	gm©h
.
	gh
 22;" d

607 
__BTRFS_NEED_DEVICE_DATA_ORDERED
 
	gvÞumes
.
	gh
 43;" d

608 
__BTRFS_ORDERED_DATA__
 
	gÜd”ed
-
	gd©a
.
	gh
 20;" d

609 
__BTRFS_PROPS_H
 
	g´Ýs
.
	gh
 20;" d

610 
__BTRFS_QGROUP__
 
	gqgroup
.
	gh
 20;" d

611 
__BTRFS_RAID56__
 
	g¿id56
.
	gh
 21;" d

612 
__BTRFS_SEND_A_MAX
 
	g£nd
.
	gh
 /^ 
	g__BTRFS_SEND_A_MAX
,
	g$
/;"ƒƒnum:__anon7

613 
__BTRFS_SEND_C_MAX
 
	g£nd
.
	gh
 /^ 
	g__BTRFS_SEND_C_MAX
,
	g$
/;"ƒƒnum:btrfs_send_cmd

614 
__BTRFS_TESTS
 
	g‹¡s
/
	gbŒfs
-‹¡s.
	gh
 20;" d

615 
__BTRFS_TRANSACTION__
 
	gŒª§ùiÚ
.
	gh
 20;" d

616 
__BTRFS_VOLUMES_
 
	gvÞumes
.
	gh
 20;" d

617 
__DELAYED_REF__
 
	gd–ayed
-
	g»f
.
	gh
 19;" d

618 
__DELAYED_TREE_OPERATION_H
 
	gd–ayed
-
	gšode
.
	gh
 21;" d

619 
__DISKIO__
 
	gdisk
-
	gio
.
	gh
 20;" d

620 
__EXTENTIO__
 
	gex‹Á_io
.
	gh
 3;" d

621 
__EXTENTMAP__
 
	gex‹Á_m­
.
	gh
 3;" d

622 
__HASH__
 
	ghash
.
	gh
 20;" d

623 
__INIT_KOBJ_ATTR
 
	gsysfs
.
	gh
 17;" d

624 
__MAX_CSUM_ITEMS
 
	gfže
-
	g™em
.
	gc
 30;" d file:

625 
__PRINT_TREE_
 
	g´št
-
	gŒ“
.
	gh
 20;" d

626 
__TRANS_ATTACH
 
	gŒª§ùiÚ
.
	gh
 94;" d

627 
__TRANS_DUMMY
 
	gŒª§ùiÚ
.
	gh
 97;" d

628 
__TRANS_FREEZABLE
 
	gŒª§ùiÚ
.
	gh
 90;" d

629 
__TRANS_JOIN
 
	gŒª§ùiÚ
.
	gh
 95;" d

630 
__TRANS_JOIN_NOLOCK
 
	gŒª§ùiÚ
.
	gh
 96;" d

631 
__TRANS_START
 
	gŒª§ùiÚ
.
	gh
 93;" d

632 
__TRANS_USERSPACE
 
	gŒª§ùiÚ
.
	gh
 92;" d

633 
__TREE_LOG_
 
	gŒ“
-
	glog
.
	gh
 20;" d

634 
__ULIST__
 
	guli¡
.
	gh
 9;" d

635 
__XATTR__
 
	gx©Œ
.
	gh
 20;" d

636 
____ÿch–še_®igÃd
 
	gvÞumes
.
	gh
 /^ 
¥šlock_t
 
io_lock
 
	g____ÿch–še_®igÃd
;
	g$
/;" m struct:btrfs_device

637 
__add_block_group_ä“_¥aû
 
	gä“
-
	g¥aû
-
	gŒ“
.
	gc
 /^__add_block_group_ä“_¥aû(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

638 
__add_šode_»f
 
Œ“
-
log
.
c
 /^
šlše
 __add_šode_»f(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

639 
__add_»loc_roÙ
 
»loÿtiÚ
.
c
 /^
__mu¡_check
 __add_»loc_roÙ(
bŒfs_roÙ
 *
roÙ
)
$
/;" f file:

640 
__add_to_ä“_¥aû_Œ“
 
ä“
-
¥aû
-
Œ“
.
c
 /^__add_to_ä“_¥aû_Œ“(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

641 
__add_Œ“_block
 
»loÿtiÚ
.
c
 /^__add_Œ“_block(
»loc_cÚŒÞ
 *
rc
,
$
/;" f file:

642 
__®loc_deviû
 
vÞumes
.
c
 /^
bŒfs_deviû
 *__®loc_deviû()
$
/;" f file:

643 
__®loc_dummy_ex‹Á_bufãr
 
ex‹Á_io
.
c
 /^
ex‹Á_bufãr
 *__®loc_dummy_ex‹Á_bufãr(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f

644 
__®loc_ex‹Á_bufãr
 
ex‹Á_io
.
c
 /^__®loc_ex‹Á_bufãr(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
,
$
/;" f file:

645 
__b™m­_þ—r_b™s
 
ä“
-
¥aû
-
ÿche
.
c
 /^
šlše
 __b™m­_þ—r_b™s(
bŒfs_ä“_¥aû_ùl
 *
ùl
,
$
/;" f file:

646 
__bŒ“_subm™_bio_dÚe
 
disk
-
io
.
c
 /^
blk_¡©us_t
 __bŒ“_subm™_bio_dÚe(*
´iv©e_d©a
, 
bio
 *bio,
$
/;" f file:

647 
__bŒ“_subm™_bio_¡¬t
 
disk
-
io
.
c
 /^
blk_¡©us_t
 __bŒ“_subm™_bio_¡¬t(*
´iv©e_d©a
, 
bio
 *bio,
$
/;" f file:

648 
__bŒfs_abÜt_Œª§ùiÚ
 
su³r
.
c
 /^__bŒfs_abÜt_Œª§ùiÚ(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

649 
__bŒfs_add_d–ayed_d–‘iÚ_™em
 
d–ayed
-
šode
.
c
 /^__bŒfs_add_d–ayed_d–‘iÚ_™em(
bŒfs_d–ayed_node
 *
node
,
$
/;" f file:

650 
__bŒfs_add_d–ayed_š£¹iÚ_™em
 
d–ayed
-
šode
.
c
 /^__bŒfs_add_d–ayed_š£¹iÚ_™em(
bŒfs_d–ayed_node
 *
node
,
$
/;" f file:

651 
__bŒfs_add_d–ayed_™em
 
d–ayed
-
šode
.
c
 /^__bŒfs_add_d–ayed_™em(
bŒfs_d–ayed_node
 *
d–ayed_node
,
$
/;" f file:

652 
__bŒfs_add_ä“_¥aû
 
ä“
-
¥aû
-
ÿche
.
c
 /^__bŒfs_add_ä“_¥aû(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f

653 
__bŒfs_add_šode_deäag
 
fže
.
c
 /^__bŒfs_add_šode_deäag(
bŒfs_šode
 *
šode
,
$
/;" f file:

654 
__bŒfs_add_Üd”ed_ex‹Á
 
Üd”ed
-
d©a
.
c
 /^__bŒfs_add_Üd”ed_ex‹Á(
šode
 *šode, 
u64
 
fže_off£t
,
$
/;" f file:

655 
__bŒfs_®loc_chunk
 
vÞumes
.
c
 /^__bŒfs_®loc_chunk(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

656 
__bŒfs_®loc_wÜkqueue
 
async
-
th»ad
.
c
 /^__bŒfs_®loc_wÜkqueue(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
Çme
,
$
/;" f file:

657 
__bŒfs_b®ªû
 
vÞumes
.
c
 /^__bŒfs_b®ªû(
bŒfs_fs_šfo
 *
fs_šfo
)
$
/;" f file:

658 
__bŒfs_bŒ“_b®ªû_dœty
 
disk
-
io
.
c
 /^__bŒfs_bŒ“_b®ªû_dœty(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

659 
__bŒfs_bufã»d_wr™e
 
fže
.
c
 /^
nošlše
 
ssize_t
 __bŒfs_bufã»d_wr™e(fž*fže,
$
/;" f file:

660 
__bŒfs_þ—r_fs_com·t_ro
 
ù»e
.
h
 /^
šlše
 __bŒfs_þ—r_fs_com·t_ro(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f

661 
__bŒfs_þ—r_fs_šcom·t
 
ù»e
.
h
 /^
šlše
 __bŒfs_þ—r_fs_šcom·t(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f

662 
__bŒfs_þo£_deviûs
 
vÞumes
.
c
 /^__bŒfs_þo£_deviûs(
bŒfs_fs_deviûs
 *
fs_deviûs
)
$
/;" f file:

663 
__bŒfs_comm™_šode_d–ayed_™ems
 
d–ayed
-
šode
.
c
 /^__bŒfs_comm™_šode_d–ayed_™ems(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

664 
__bŒfs_cÜ»ù_d©a_nocsum
 
šode
.
c
 /^
blk_¡©us_t
 __bŒfs_cÜ»ù_d©a_nocsum(šod*šode,
$
/;" f file:

665 
__bŒfs_cow_block
 
ù»e
.
c
 /^
nošlše
 __bŒfs_cow_block(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

666 
__bŒfs_debug_check_ex‹Á_io_¿nge
 
ex‹Á_io
.
c
 /^
šlše
 __bŒfs_debug_check_ex‹Á_io_¿nge(cÚ¡ *
ÿÎ”
,
$
/;" f file:

667 
__bŒfs_de¡roy_wÜkqueue
 
async
-
th»ad
.
c
 /^__bŒfs_de¡roy_wÜkqueue(
__bŒfs_wÜkqueue
 *
wq
)
$
/;" f file:

668 
__bŒfs_dev_»¶aû_ÿnûl
 
dev
-
»¶aû
.
c
 /^
u64
 __bŒfs_dev_»¶aû_ÿnûl(
bŒfs_fs_šfo
 *
fs_šfo
)
$
/;" f file:

669 
__bŒfs_dœeù_wr™e
 
fže
.
c
 /^
ssize_t
 __bŒfs_dœeù_wr™e(
kiocb
 *
iocb
, 
iov_™”
 *
äom
)
$
/;" f file:

670 
__bŒfs_drÝ_ex‹Ás
 
fže
.
c
 /^__bŒfs_drÝ_ex‹Ás(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

671 
__bŒfs_’d_Œª§ùiÚ
 
Œª§ùiÚ
.
c
 /^__bŒfs_’d_Œª§ùiÚ(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

672 
__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em
 
d–ayed
-
šode
.
c
 /^
bŒfs_d–ayed_™em
 *__bŒfs_fœ¡_d–ayed_d–‘iÚ_™em(
$
/;" f file:

673 
__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em
 
d–ayed
-
šode
.
c
 /^
bŒfs_d–ayed_™em
 *__bŒfs_fœ¡_d–ayed_š£¹iÚ_™em(
$
/;" f file:

674 
__bŒfs_ä“_block_rsv
 
ex‹Á
-
Œ“
.
c
 /^__bŒfs_ä“_block_rsv(
bŒfs_block_rsv
 *
rsv
)
$
/;" f

675 
__bŒfs_ä“_ex‹Á
 
ex‹Á
-
Œ“
.
c
 /^__bŒfs_ä“_ex‹Á(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

676 
__bŒfs_ä“_»£rved_ex‹Á
 
ex‹Á
-
Œ“
.
c
 /^__bŒfs_ä“_»£rved_ex‹Á(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

677 
__bŒfs_fs_com·t_ro
 
ù»e
.
h
 /^
šlše
 __bŒfs_fs_com·t_ro(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
)
$
/;" f

678 
__bŒfs_fs_šcom·t
 
ù»e
.
h
 /^
šlše
 
boÞ
 __bŒfs_fs_šcom·t(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
æag
)
$
/;" f

679 
__bŒfs_g‘x©Œ
 
x©Œ
.
c
 /^
ssize_t
 __bŒfs_g‘x©Œ(
šode
 *šode, cÚ¡ *
Çme
,
$
/;" f

680 
__bŒfs_hªdË_fs_”rÜ
 
su³r
.
c
 /^__bŒfs_hªdË_fs_”rÜ(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,
$
/;" f

681 
__bŒfs_šc_ex‹Á_»f
 
ex‹Á
-
Œ“
.
c
 /^__bŒfs_šc_ex‹Á_»f(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

682 
__bŒfs_kžl_d–ayed_node
 
d–ayed
-
šode
.
c
 /^__bŒfs_kžl_d–ayed_node(
bŒfs_d–ayed_node
 *
d–ayed_node
)
$
/;" f file:

683 
__bŒfs_lookup_bio_sums
 
fže
-
™em
.
c
 /^
blk_¡©us_t
 __bŒfs_lookup_bio_sums(
šode
 *šode, 
bio
 *bio,
$
/;" f file:

684 
__bŒfs_lookup_d–ayed_š£¹iÚ_™em
 
d–ayed
-
šode
.
c
 /^
bŒfs_d–ayed_™em
 *__bŒfs_lookup_d–ayed_š£¹iÚ_™em(
$
/;" f file:

685 
__bŒfs_lookup_d–ayed_™em
 
d–ayed
-
šode
.
c
 /^
bŒfs_d–ayed_™em
 *__bŒfs_lookup_d–ayed_™em(
$
/;" f file:

686 
__bŒfs_m­_block
 
vÞumes
.
c
 /^__bŒfs_m­_block(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

687 
__bŒfs_m­_block_fÜ_disÿrd
 
vÞumes
.
c
 /^__bŒfs_m­_block_fÜ_disÿrd(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

688 
__bŒfs_mod_»f
 
ex‹Á
-
Œ“
.
c
 /^__bŒfs_mod_»f(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

689 
__bŒfs_Ãxt_d–ayed_™em
 
d–ayed
-
šode
.
c
 /^
bŒfs_d–ayed_™em
 *__bŒfs_Ãxt_d–ayed_™em(
$
/;" f file:

690 
__bŒfs_Ý’_deviûs
 
vÞumes
.
c
 /^__bŒfs_Ý’_deviûs(
bŒfs_fs_deviûs
 *
fs_deviûs
,
$
/;" f file:

691 
__bŒfs_·nic
 
su³r
.
c
 /^__bŒfs_·nic(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
funùiÚ
,
$
/;" f

692 
__bŒfs_´—Îoc_fže_¿nge
 
šode
.
c
 /^__bŒfs_´—Îoc_fže_¿nge(šod*šode, 
mode
,
$
/;" f file:

693 
__bŒfs_qgroup_»Ëa£_d©a
 
qgroup
.
c
 /^__bŒfs_qgroup_»Ëa£_d©a(
šode
 *šode,
$
/;" f file:

694 
__bŒfs_queue_wÜk
 
async
-
th»ad
.
c
 /^
šlše
 __bŒfs_queue_wÜk(
__bŒfs_wÜkqueue
 *
wq
,
$
/;" f file:

695 
__bŒfs_»Ëa£_d–ayed_node
 
d–ayed
-
šode
.
c
 /^__bŒfs_»Ëa£_d–ayed_node(
$
/;" f file:

696 
__bŒfs_»Ëa£·ge
 
šode
.
c
 /^__bŒfs_»Ëa£·ge(
·ge
 *·ge, 
gå_t
 
gå_æags
)
$
/;" f file:

697 
__bŒfs_»move_d–ayed_™em
 
d–ayed
-
šode
.
c
 /^__bŒfs_»move_d–ayed_™em(
bŒfs_d–ayed_™em
 *
d–ayed_™em
)
$
/;" f file:

698 
__bŒfs_»move_ä“_¥aû_ÿche
 
ä“
-
¥aû
-
ÿche
.
c
 /^__bŒfs_»move_ä“_¥aû_ÿche(
bŒfs_ä“_¥aû_ùl
 *
ùl
)
$
/;" f

699 
__bŒfs_»move_ä“_¥aû_ÿche_locked
 
ä“
-
¥aû
-
ÿche
.
c
 /^__bŒfs_»move_ä“_¥aû_ÿche_locked(
$
/;" f file:

700 
__bŒfs_»£t_dev_¡©s
 
vÞumes
.
c
 /^__bŒfs_»£t_dev_¡©s(
bŒfs_deviû
 *
dev
)
$
/;" f file:

701 
__bŒfs_»tuº_þu¡”_to_ä“_¥aû
 
ä“
-
¥aû
-
ÿche
.
c
 /^__bŒfs_»tuº_þu¡”_to_ä“_¥aû(
$
/;" f file:

702 
__bŒfs_run_deäag_šode
 
fže
.
c
 /^__bŒfs_run_deäag_šode(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

703 
__bŒfs_run_d–ayed_™ems
 
d–ayed
-
šode
.
c
 /^__bŒfs_run_d–ayed_™ems(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

704 
__bŒfs_run_d–ayed_»fs
 
ex‹Á
-
Œ“
.
c
 /^
nošlše
 __bŒfs_run_d–ayed_»fs(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

705 
__bŒfs_£t_aþ
 
aþ
.
c
 /^__bŒfs_£t_aþ(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

706 
__bŒfs_£t_fs_com·t_ro
 
ù»e
.
h
 /^
šlše
 __bŒfs_£t_fs_com·t_ro(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f

707 
__bŒfs_£t_fs_šcom·t
 
ù»e
.
h
 /^
šlše
 __bŒfs_£t_fs_šcom·t(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f

708 
__bŒfs_£t_´Ý
 
´Ýs
.
c
 /^__bŒfs_£t_´Ý(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

709 
__bŒfs_£tx©Œ
 
x©Œ
.
c
 /^__bŒfs_£tx©Œ(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

710 
__bŒfs_subio_’dio_»ad
 
šode
.
c
 /^
blk_¡©us_t
 __bŒfs_subio_’dio_»ad(šod*šode,
$
/;" f file:

711 
__bŒfs_subm™_bio_dÚe
 
šode
.
c
 /^
blk_¡©us_t
 __bŒfs_subm™_bio_dÚe(*
´iv©e_d©a
, 
bio
 *bio,
$
/;" f file:

712 
__bŒfs_subm™_bio_¡¬t
 
šode
.
c
 /^
blk_¡©us_t
 __bŒfs_subm™_bio_¡¬t(*
´iv©e_d©a
, 
bio
 *bio,
$
/;" f file:

713 
__bŒfs_subm™_bio_¡¬t_dœeù_io
 
šode
.
c
 /^
blk_¡©us_t
 __bŒfs_subm™_bio_¡¬t_dœeù_io(*
´iv©e_d©a
,
$
/;" f file:

714 
__bŒfs_subm™_dio_bio
 
šode
.
c
 /^__bŒfs_subm™_dio_bio(
bio
 *bio, šod*šode, 
u64
 
fže_off£t
,
$
/;" f file:

715 
__bŒfs_sysfs_»move_fsid
 
sysfs
.
c
 /^__bŒfs_sysfs_»move_fsid(
bŒfs_fs_deviûs
 *
fs_devs
)
$
/;" f file:

716 
__bŒfs_uÆšk_šode
 
šode
.
c
 /^__bŒfs_uÆšk_šode(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

717 
__bŒfs_upd©e_d–ayed_šode
 
d–ayed
-
šode
.
c
 /^__bŒfs_upd©e_d–ayed_šode(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

718 
__bŒfs_wa™_ÿche_io
 
ä“
-
¥aû
-
ÿche
.
c
 /^__bŒfs_wa™_ÿche_io(
bŒfs_roÙ
 *
roÙ
,
$
/;" f file:

719 
__bŒfs_wa™_m¬ked_ex‹Ás
 
Œª§ùiÚ
.
c
 /^__bŒfs_wa™_m¬ked_ex‹Ás(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

720 
__bŒfs_wÜkqueue
 
async
-
th»ad
.
c
 /^
	s__bŒfs_wÜkqueue
 {
$
/;" s file:

721 
__bŒfs_wr™e_out_ÿche
 
ä“
-
¥aû
-
ÿche
.
c
 /^__bŒfs_wr™e_out_ÿche(
bŒfs_roÙ
 *
roÙ
, 
šode
 *šode,
$
/;" f file:

722 
__bŒfsic_subm™_bio
 
check
-
š‹gr™y
.
c
 /^__bŒfsic_subm™_bio(
bio
 *bio)
$
/;" f file:

723 
__ÿnûl_b®ªû
 
vÞumes
.
c
 /^__ÿnûl_b®ªû(
bŒfs_fs_šfo
 *
fs_šfo
)
$
/;" f file:

724 
__check_ä“_¥aû_ex‹Ás
 
‹¡s
/
ä“
-
¥aû
-
Œ“
-‹¡s.
c
 /^__check_ä“_¥aû_ex‹Ás(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

725 
__þ—r_ex‹Á_b™
 
ex‹Á_io
.
c
 /^__þ—r_ex‹Á_b™(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,
$
/;" f file:

726 
__þÚe_roÙ_cmp_b£¬ch
 
£nd
.
c
 /^__þÚe_roÙ_cmp_b£¬ch(cÚ¡ *
key
, cÚ¡ *
–t
)
$
/;" f file:

727 
__þÚe_roÙ_cmp_sÜt
 
£nd
.
c
 /^__þÚe_roÙ_cmp_sÜt(cÚ¡ *
e1
, cÚ¡ *
e2
)
$
/;" f file:

728 
__com·»_šode_deäag
 
fže
.
c
 /^__com·»_šode_deäag(
šode_deäag
 *
deäag1
,
$
/;" f file:

729 
__cÝy_fœ¡_»f
 
£nd
.
c
 /^__cÝy_fœ¡_»f(
num
, 
u64
 
dœ
, 
šdex
,
$
/;" f file:

730 
__ü—‹_ä“_¥aû_šode
 
ä“
-
¥aû
-
ÿche
.
c
 /^__ü—‹_ä“_¥aû_šode(
bŒfs_roÙ
 *
roÙ
,
$
/;" f file:

731 
__d–_qgroup_rb
 
qgroup
.
c
 /^__d–_qgroup_rb(
bŒfs_qgroup
 *qgroup)
$
/;" f file:

732 
__d–_qgroup_»ÏtiÚ
 
qgroup
.
c
 /^__d–_qgroup_»ÏtiÚ(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

733 
__d–_»loc_roÙ
 
»loÿtiÚ
.
c
 /^__d–_»loc_roÙ(
bŒfs_roÙ
 *
roÙ
)
$
/;" f file:

734 
__do_cÚtiguous_»ad·ges
 
ex‹Á_io
.
c
 /^
šlše
 __do_cÚtiguous_»ad·ges(
ex‹Á_io_Œ“
 *
Œ“
,
$
/;" f file:

735 
__do_»ad·ge
 
ex‹Á_io
.
c
 /^__do_»ad·ge(
ex‹Á_io_Œ“
 *
Œ“
,
$
/;" f file:

736 
__’dio_wr™e_upd©e_Üd”ed
 
šode
.
c
 /^__’dio_wr™e_upd©e_Üd”ed(šod*šode,
$
/;" f file:

737 
__‘»e_£¬ch
 
ex‹Á_io
.
c
 /^
rb_node
 *__‘»e_£¬ch(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
off£t
,
$
/;" f file:

738 
__exþude_logged_ex‹Á
 
ex‹Á
-
Œ“
.
c
 /^__exþude_logged_ex‹Á(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

739 
__ex‹Á_»ad_fuÎ_·ge
 
ex‹Á_io
.
c
 /^__ex‹Á_»ad_fuÎ_·ge(
ex‹Á_io_Œ“
 *
Œ“
,
$
/;" f file:

740 
__ex‹Á_»ad·ges
 
ex‹Á_io
.
c
 /^__ex‹Á_»ad·ges(
ex‹Á_io_Œ“
 *
Œ“
,
$
/;" f file:

741 
__ex‹Á_wr™•age
 
ex‹Á_io
.
c
 /^__ex‹Á_wr™•age(
·ge
 *·ge, 
wr™eback_cÚŒÞ
 *
wbc
,
$
/;" f file:

742 
__ex‹Á_wr™•age_io
 
ex‹Á_io
.
c
 /^
nošlše_fÜ_¡ack
 __ex‹Á_wr™•age_io(
šode
 *šode,
$
/;" f file:

743 
__fšd_œef
 
£nd
.
c
 /^__fšd_œef(
num
, 
u64
 
dœ
, 
šdex
,
$
/;" f file:

744 
__fšd_¥aû_šfo
 
ex‹Á
-
Œ“
.
c
 /^
bŒfs_¥aû_šfo
 *__fšd_¥aû_šfo(
bŒfs_fs_šfo
 *
šfo
,
$
/;" f file:

745 
__fšd_x©Œ
 
£nd
.
c
 /^__fšd_x©Œ(
num
, 
bŒfs_key
 *
di_key
,
$
/;" f file:

746 
__ä“_deviû
 
vÞumes
.
c
 /^__ä“_deviû(
wÜk_¡ruù
 *
wÜk
)
$
/;" f file:

747 
__ä“_ex‹Á_bufãr
 
ex‹Á_io
.
c
 /^__ä“_ex‹Á_bufãr(
ex‹Á_bufãr
 *
eb
)
$
/;" f file:

748 
__ä“_¿id_bio
 
¿id56
.
c
 /^__ä“_¿id_bio(
bŒfs_¿id_bio
 *
rbio
)
$
/;" f file:

749 
__ä“_»cÜded_»fs
 
£nd
.
c
 /^__ä“_»cÜded_»fs(
li¡_h—d
 *
h—d
)
$
/;" f file:

750 
__g‘_cur_Çme_ªd_·»Á
 
£nd
.
c
 /^__g‘_cur_Çme_ªd_·»Á(
£nd_ùx
 *
sùx
,
$
/;" f file:

751 
__g‘_ex‹Á_m­
 
ex‹Á_io
.
c
 /^__g‘_ex‹Á_m­(
šode
 *šode, 
·ge
 *·ge, 
size_t
 
pg_off£t
,
$
/;" f file:

752 
__g‘_šode_šfo
 
£nd
.
c
 /^__g‘_šode_šfo(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,
$
/;" f file:

753 
__g‘_¿id_šdex
 
ex‹Á
-
Œ“
.
c
 /^__g‘_¿id_šdex(
u64
 
æags
)
$
/;" f

754 
__š£¹_Üphª_šode
 
»loÿtiÚ
.
c
 /^__š£¹_Üphª_šode(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

755 
__™”©e_back»fs
 
£nd
.
c
 /^__™”©e_back»fs(
u64
 
šo
, u64 
off£t
, u64 
roÙ
, *
ùx_
)
$
/;" f file:

756 
__Ë8
 
ù»e
.
h
 1459;" d

757 
__lšk_block_group
 
ex‹Á
-
Œ“
.
c
 /^__lšk_block_group(
bŒfs_¥aû_šfo
 *
¥aû_šfo
,
$
/;" f file:

758 
__lßd_ä“_¥aû_ÿche
 
ä“
-
¥aû
-
ÿche
.
c
 /^__lßd_ä“_¥aû_ÿche(
bŒfs_roÙ
 *
roÙ
, 
šode
 *šode,
$
/;" f file:

759 
__lookup_ex‹Á_m­pšg
 
ex‹Á_m­
.
c
 /^__lookup_ex‹Á_m­pšg(
ex‹Á_m­_Œ“
 *
Œ“
,
$
/;" f file:

760 
__lookup_ä“_¥aû_šode
 
ä“
-
¥aû
-
ÿche
.
c
 /^
šode
 *__lookup_ä“_¥aû_šode(
bŒfs_roÙ
 *
roÙ
,
$
/;" f file:

761 
__m¬k_block_´oûs£d
 
»loÿtiÚ
.
c
 /^__m¬k_block_´oûs£d(
»loc_cÚŒÞ
 *
rc
,
$
/;" f file:

762 
__Ãed_auto_deäag
 
fže
.
c
 /^
šlše
 __Ãed_auto_deäag(
bŒfs_fs_šfo
 *
fs_šfo
)
$
/;" f file:

763 
__´oûss_chªged_d–‘ed_x©Œ
 
£nd
.
c
 /^__´oûss_chªged_d–‘ed_x©Œ(
num
, 
bŒfs_key
 *
di_key
,
$
/;" f file:

764 
__´oûss_chªged_Ãw_x©Œ
 
£nd
.
c
 /^__´oûss_chªged_Ãw_x©Œ(
num
, 
bŒfs_key
 *
di_key
,
$
/;" f file:

765 
__´oûss_d–‘ed_x©Œ
 
£nd
.
c
 /^__´oûss_d–‘ed_x©Œ(
num
, 
bŒfs_key
 *
di_key
,
$
/;" f file:

766 
__´oûss_Ãw_x©Œ
 
£nd
.
c
 /^__´oûss_Ãw_x©Œ(
num
, 
bŒfs_key
 *
di_key
,
$
/;" f file:

767 
__´oûss_·ges_cÚtig
 
ex‹Á_io
.
c
 /^__´oûss_·ges_cÚtig(
add»ss_¥aû
 *
m­pšg
,
$
/;" f file:

768 
__push_Ëaf_Ëá
 
ù»e
.
c
 /^
nošlše
 __push_Ëaf_Ëá(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

769 
__push_Ëaf_right
 
ù»e
.
c
 /^
nošlše
 __push_Ëaf_right(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

770 
__qgroup_exþ_accouÁšg
 
qgroup
.
c
 /^__qgroup_exþ_accouÁšg(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

771 
__¿id56_·r™y_»cov”
 
¿id56
.
c
 /^__¿id56_·r™y_»cov”(
bŒfs_¿id_bio
 *
rbio
)
$
/;" f file:

772 
__¿id56_·r™y_wr™e
 
¿id56
.
c
 /^__¿id56_·r™y_wr™e(
bŒfs_¿id_bio
 *
rbio
)
$
/;" f file:

773 
__¿id_»cov”_’d_io
 
¿id56
.
c
 /^__¿id_»cov”_’d_io(
bŒfs_¿id_bio
 *
rbio
)
$
/;" f file:

774 
__rbio_is_fuÎ
 
¿id56
.
c
 /^__rbio_is_fuÎ(
bŒfs_¿id_bio
 *
rbio
)
$
/;" f file:

775 
__»ada_¡¬t_machše
 
»ada
.
c
 /^__»ada_¡¬t_machše(
bŒfs_fs_šfo
 *
fs_šfo
)
$
/;" f file:

776 
__»adah—d_hook
 
»ada
.
c
 /^__»adah—d_hook(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

777 
__»ad·ge_’dio_check
 
šode
.
c
 /^__»ad·ge_’dio_check(šod*šode,
$
/;" f file:

778 
__»cÜd_chªged_d–‘ed_»f
 
£nd
.
c
 /^__»cÜd_chªged_d–‘ed_»f(
num
, 
u64
 
dœ
, 
šdex
,
$
/;" f file:

779 
__»cÜd_chªged_Ãw_»f
 
£nd
.
c
 /^__»cÜd_chªged_Ãw_»f(
num
, 
u64
 
dœ
, 
šdex
,
$
/;" f file:

780 
__»cÜd_d–‘ed_»f
 
£nd
.
c
 /^__»cÜd_d–‘ed_»f(
num
, 
u64
 
dœ
, 
šdex
,
$
/;" f file:

781 
__»cÜd_Ãw_»f
 
£nd
.
c
 /^__»cÜd_Ãw_»f(
num
, 
u64
 
dœ
, 
šdex
,
$
/;" f file:

782 
__»cÜd_»f
 
£nd
.
c
 /^__»cÜd_»f(
li¡_h—d
 *
h—d
, 
u64
 
dœ
,
$
/;" f file:

783 
__»move_äom_ä“_¥aû_Œ“
 
ä“
-
¥aû
-
Œ“
.
c
 /^__»move_äom_ä“_¥aû_Œ“(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

784 
__»move_rbio_äom_ÿche
 
¿id56
.
c
 /^__»move_rbio_äom_ÿche(
bŒfs_¿id_bio
 *
rbio
)
$
/;" f file:

785 
__»£rve_m‘ad©a_by‹s
 
ex‹Á
-
Œ“
.
c
 /^__»£rve_m‘ad©a_by‹s(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

786 
__run_d–ayed_ex‹Á_Ý
 
ex‹Á
-
Œ“
.
c
 /^__run_d–ayed_ex‹Á_Ý(
bŒfs_d–ayed_ex‹Á_Ý
 *
ex‹Á_Ý
,
$
/;" f file:

787 
__süub_blocked_if_Ãeded
 
süub
.
c
 /^__süub_blocked_if_Ãeded(
bŒfs_fs_šfo
 *
fs_šfo
)
$
/;" f file:

788 
__süub_m¬k_b™m­
 
süub
.
c
 /^
šlše
 __süub_m¬k_b™m­(
süub_·r™y
 *
¥¬™y
,
$
/;" f file:

789 
__£t_ex‹Á_b™
 
ex‹Á_io
.
c
 /^__£t_ex‹Á_b™(
ex‹Á_io_Œ“
 *
Œ“
, 
u64
 
¡¬t
, u64 
’d
,
$
/;" f file:

790 
__£tup_roÙ
 
disk
-
io
.
c
 /^__£tup_roÙ(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

791 
__¡¬t_d–®loc_šodes
 
šode
.
c
 /^__¡¬t_d–®loc_šodes(
bŒfs_roÙ
 *
roÙ
, 
d–ay_ut
,
$
/;" f file:

792 
__‹¡_eb_b™m­s
 
‹¡s
/
ex‹Á
-
io
-‹¡s.
c
 /^__‹¡_eb_b™m­s(*
b™m­
, 
ex‹Á_bufãr
 *
eb
,
$
/;" f file:

793 
__this_moduË
 
bŒfs
.
mod
.
c
 /^
__visibË
 
moduË
 
__this_moduË$
/;" vyperef:struct:module

794 
__Œ“_mod_log_ä“_eb
 
ù»e
.
c
 /^__Œ“_mod_log_ä“_eb(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

795 
__Œ“_mod_log_š£¹
 
ù»e
.
c
 /^__Œ“_mod_log_š£¹(
bŒfs_fs_šfo
 *
fs_šfo
, 
Œ“_mod_–em
 *
tm
)
$
/;" f file:

796 
__Œ“_mod_log_Þde¡_roÙ
 
ù»e
.
c
 /^__Œ“_mod_log_Þde¡_roÙ(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

797 
__Œ“_mod_log_»wšd
 
ù»e
.
c
 /^__Œ“_mod_log_»wšd(
bŒfs_fs_šfo
 *
fs_šfo
, 
ex‹Á_bufãr
 *
eb
,
$
/;" f file:

798 
__Œ“_mod_log_£¬ch
 
ù»e
.
c
 /^__Œ“_mod_log_£¬ch(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
¡¬t
, u64 
mš_£q
,
$
/;" f file:

799 
__Œ“_£¬ch
 
ex‹Á_m­
.
c
 /^
rb_node
 *__Œ“_£¬ch(
rb_roÙ
 *
roÙ
, 
u64
 
off£t
,
$
/;" f file:

800 
__Œ“_£¬ch
 
Üd”ed
-
d©a
.
c
 /^
rb_node
 *__Œ“_£¬ch(
rb_roÙ
 *
roÙ
, 
u64
 
fže_off£t
,
$
/;" f file:

801 
__uÆšk_ä“_¥aû
 
ä“
-
¥aû
-
ÿche
.
c
 /^__uÆšk_ä“_¥aû(
bŒfs_ä“_¥aû_ùl
 *
ùl
,
$
/;" f file:

802 
__uÆšk_¡¬t_Œªs
 
šode
.
c
 /^
bŒfs_Œªs_hªdË
 *__uÆšk_¡¬t_Œªs(šod*
dœ
)
$
/;" f file:

803 
__uÆock_fÜ_d–®loc
 
ex‹Á_io
.
c
 /^
nošlše
 __uÆock_fÜ_d–®loc(
šode
 *šode,
$
/;" f file:

804 
__unu£d_Ëafsize
 
ù»e
.
h
 /^ 
__Ë32
 __unu£d_Ëafsize;
$
/;" m struct:btrfs_super_block

805 
__upd©e_»loc_roÙ
 
»loÿtiÚ
.
c
 /^__upd©e_»loc_roÙ(
bŒfs_roÙ
 *
roÙ
, 
u64
 
Ãw_by‹Ä
)
$
/;" f file:

806 
__u£d
 
bŒfs
.
mod
.
c
 /^
__u£d$
/;" v file:

807 
__u£d
 
bŒfs
.
mod
.
c
 /^
__u£d$
/;" vyperef:struct:____versions file:

808 
_bŒfs_ioùl_£t_»ûived_subvÞ
 
ioùl
.
c
 /^_bŒfs_ioùl_£t_»ûived_subvÞ(
fže
 *fže,
$
/;" f file:

809 
abÜ‹d
 
Œª§ùiÚ
.
h
 /^ abÜ‹d;
$
/;" m struct:btrfs_transaction

810 
abÜ‹d
 
Œª§ùiÚ
.
h
 /^ abÜ‹d;
$
/;" m struct:btrfs_trans_handle

811 
accouÁšg_lock
 
ù»e
.
h
 /^ 
¥šlock_t
‡ccouÁšg_lock;
$
/;" m struct:btrfs_root

812 
aþs_aá”_šode_™em
 
šode
.
c
 /^
nošlše
 aþs_aá”_šode_™em(
ex‹Á_bufãr
 *
Ëaf
,
$
/;" f file:

813 
aùiÚ
 
d–ayed
-
»f
.
h
 /^ aùiÚ:8;
$
/;" m struct:btrfs_delayed_ref_node

814 
add_®l_·»Ás
 
back»f
.
c
 /^add_®l_·»Ás(
bŒfs_roÙ
 *
roÙ
, 
bŒfs_·th
 *
·th
,
$
/;" f file:

815 
add_async_ex‹Á
 
šode
.
c
 /^
nošlše
 add_async_ex‹Á(
async_cow
 *
cow
,
$
/;" f file:

816 
add_block_group_ä“_¥aû
 
ä“
-
¥aû
-
Œ“
.
c
 /^add_block_group_ä“_¥aû(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

817 
add_by‹s_to_b™m­
 
ä“
-
¥aû
-
ÿche
.
c
 /^
u64
‡dd_by‹s_to_b™m­(
bŒfs_ä“_¥aû_ùl
 *
ùl
,
$
/;" f file:

818 
add_d©a_»ã»nûs
 
»loÿtiÚ
.
c
 /^add_d©a_»ã»nûs(
»loc_cÚŒÞ
 *
rc
,
$
/;" f file:

819 
add_d–ayed_d©a_»f
 
d–ayed
-
»f
.
c
 /^add_d–ayed_d©a_»f(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

820 
add_d–ayed_»f_h—d
 
d–ayed
-
»f
.
c
 /^add_d–ayed_»f_h—d(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

821 
add_d–ayed_»f_ž_m”ge
 
d–ayed
-
»f
.
c
 /^add_d–ayed_»f_ž_m”ge(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

822 
add_d–ayed_»fs
 
back»f
.
c
 /^add_d–ayed_»fs(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

823 
add_d–ayed_Œ“_»f
 
d–ayed
-
»f
.
c
 /^add_d–ayed_Œ“_»f(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

824 
add_dœeù_»f
 
back»f
.
c
 /^add_dœeù_»f(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

825 
add_exþuded_ex‹Á
 
ex‹Á
-
Œ“
.
c
 /^add_exþuded_ex‹Á(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

826 
add_ex‹Á_chªge£t
 
ex‹Á_io
.
c
 /^add_ex‹Á_chªge£t(
ex‹Á_¡©e
 *
¡©e
, 
b™s
,
$
/;" f file:

827 
add_ex‹Á_m­pšg
 
ex‹Á_m­
.
c
 /^add_ex‹Á_m­pšg(
ex‹Á_m­_Œ“
 *
Œ“
,
$
/;" f

828 
add_çÎoc_¿nge
 
fže
.
c
 /^add_çÎoc_¿nge(
li¡_h—d
 *
h—d
, 
u64
 
¡¬t
, u64 
Ën
)
$
/;" f file:

829 
add_ä“_¥aû_ex‹Á
 
ä“
-
¥aû
-
Œ“
.
c
 /^add_ä“_¥aû_ex‹Á(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

830 
add_šdœeù_»f
 
back»f
.
c
 /^add_šdœeù_»f(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

831 
add_šlše_»fs
 
back»f
.
c
 /^add_šlše_»fs(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

832 
add_šode_»f
 
Œ“
-
log
.
c
 /^
nošlše
 add_šode_»f(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

833 
add_keyed_»fs
 
back»f
.
c
 /^add_keyed_»fs(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

834 
add_li¡
 
d–ayed
-
»f
.
h
 /^ 
li¡_h—d
‡dd_li¡;
$
/;" m struct:btrfs_delayed_ref_nodeyperef:struct:btrfs_delayed_ref_node::list_head

835 
add_missšg_dev
 
vÞumes
.
c
 /^
bŒfs_deviû
 *add_missšg_dev(
bŒfs_fs_deviûs
 *
fs_deviûs
,
$
/;" f file:

836 
add_missšg_keys
 
back»f
.
c
 /^add_missšg_keys(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

837 
add_Ãw_b™m­
 
ä“
-
¥aû
-
ÿche
.
c
 /^add_Ãw_b™m­(
bŒfs_ä“_¥aû_ùl
 *
ùl
,
$
/;" f file:

838 
add_Ãw_ä“_¥aû
 
ex‹Á
-
Œ“
.
c
 /^
u64
‡dd_Ãw_ä“_¥aû(
bŒfs_block_group_ÿche
 *
block_group
,
$
/;" f

839 
add_Ãw_ä“_¥aû_šfo
 
ä“
-
¥aû
-
Œ“
.
c
 /^add_Ãw_ä“_¥aû_šfo(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

840 
add_Üphª_dœ_šfo
 
£nd
.
c
 /^add_Üphª_dœ_šfo(
£nd_ùx
 *
sùx
, 
u64
 
dœ_šo
)
$
/;" f file:

841 
add_³ndšg_csums
 
šode
.
c
 /^
nošlše
 add_³ndšg_csums(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

842 
add_³ndšg_dœ_move
 
£nd
.
c
 /^add_³ndšg_dœ_move(
£nd_ùx
 *
sùx
,
$
/;" f file:

843 
add_pšÃd_by‹s
 
ex‹Á
-
Œ“
.
c
 /^add_pšÃd_by‹s(
bŒfs_fs_šfo
 *
fs_šfo
, 
s64
 
num_by‹s
,
$
/;" f file:

844 
add_´–im_»f
 
back»f
.
c
 /^add_´–im_»f(cÚ¡ 
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

845 
add_qgroup_™em
 
qgroup
.
c
 /^add_qgroup_™em(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

846 
add_qgroup_rb
 
qgroup
.
c
 /^
bŒfs_qgroup
 *add_qgroup_rb(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

847 
add_qgroup_»ÏtiÚ_™em
 
qgroup
.
c
 /^add_qgroup_»ÏtiÚ_™em(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f file:

848 
add_¿_bio_·ges
 
com´essiÚ
.
c
 /^
nošlše
 add_¿_bio_·ges(
šode
 *šode,
$
/;" f file:

849 
add_»ÏtiÚ_rb
 
qgroup
.
c
 /^add_»ÏtiÚ_rb(
bŒfs_fs_šfo
 *
fs_šfo
,
$
/;" f file:

850 
add_roÙ_to_dœty_li¡
 
ù»e
.
c
 /^add_roÙ_to_dœty_li¡(
bŒfs_roÙ
 *
roÙ
)
$
/;" f file:

851 
add_to_ä“_¥aû_Œ“
 
ä“
-
¥aû
-
Œ“
.
c
 /^add_to_ä“_¥aû_Œ“(
bŒfs_Œªs_hªdË
 *
Œªs
,
$
/;" f

852 
add_Œ“_block
 
»loÿtiÚ
.
c
 /^add_Œ“_block(
»loc_cÚŒÞ
 *
rc
,
$
/;" f file:

853 
add_Œ“_»f
 
‹¡s
/
qgroup
-‹¡s.
c
 /^add_Œ“_»f(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
num_by‹s
,
$
/;" f file:

854 
add_wa™šg_dœ_move
 
£nd
.
c
 /^add_wa™šg_dœ_move(
£nd_ùx
 *
sùx
, 
u64
 
šo
, 
boÞ
 
Üphªized
)
$
/;" f file:

855 
addšg_csums
 
Œª§ùiÚ
.
h
 /^ addšg_csums;
$
/;" m struct:btrfs_trans_handle

856 
addrm_unknown_ã©u»_©Œs
 
sysfs
.
c
 /^addrm_unknown_ã©u»_©Œs(
bŒfs_fs_šfo
 *
fs_šfo
, 
boÞ
 
add
)
$
/;" f file:

857 
adju¡_dio_out¡ªdšg_ex‹Ás
 
šode
.
c
 /^adju¡_dio_out¡ªdšg_ex‹Ás(šod*šode,
$
/;" f file:

858 
adju¡_¦Ùs_upw¬ds
 
qgroup
.
c
 /^adju¡_¦Ùs_upw¬ds(
bŒfs_·th
 *
·th
, 
roÙ_Ëv–
)
$
/;" f file:

859 
®l_blocks_li¡
 
check
-
š‹gr™y
.
c
 /^ 
li¡_h—d
‡Î_blocks_li¡;
$
/;" m struct:btrfsic_stateyperef:struct:btrfsic_state::list_head file:

860 
®l_blocks_node
 
check
-
š‹gr™y
.
c
 /^ 
li¡_h—d
‡ll_blocks_node; \

	@tests/btrfs-tests.c

19 
	~<lšux/fs.h
>

20 
	~<lšux/mouÁ.h
>

21 
	~<lšux/magic.h
>

22 
	~"bŒfs-‹¡s.h
"

23 
	~"../ù»e.h
"

24 
	~"../ä“-¥aû-ÿche.h
"

25 
	~"../ä“-¥aû-Œ“.h
"

26 
	~"../Œª§ùiÚ.h
"

27 
	~"../vÞumes.h
"

28 
	~"../disk-io.h
"

29 
	~"../qgroup.h
"

31 
vfsmouÁ
 *
	g‹¡_mÁ
 = 
NULL
;

33 cÚ¡ 
su³r_Ý”©iÚs
 
	gbŒfs_‹¡_su³r_Ýs
 = {

34 .
®loc_šode
 = 
bŒfs_®loc_šode
,

35 .
	gde¡roy_šode
 = 
bŒfs_‹¡_de¡roy_šode
,

38 
d’Œy
 *
	$bŒfs_‹¡_mouÁ
(
fže_sy¡em_ty³
 *
fs_ty³
,

39 
æags
, cÚ¡ *
dev_Çme
,

40 *
d©a
)

42  
	`mouÁ_p£udo
(
fs_ty³
, "bŒfs_‹¡:", &
bŒfs_‹¡_su³r_Ýs
,

43 
NULL
, 
BTRFS_TEST_MAGIC
);

44 
	}
}

46 
fže_sy¡em_ty³
 
	g‹¡_ty³
 = {

47 .
Çme
 = "btrfs_test_fs",

48 .
	gmouÁ
 = 
bŒfs_‹¡_mouÁ
,

49 .
	gkžl_sb
 = 
kžl_ªÚ_su³r
,

52 
šode
 *
	$bŒfs_Ãw_‹¡_šode
()

54  
	`Ãw_šode
(
‹¡_mÁ
->
mÁ_sb
);

55 
	}
}

57 
	$bŒfs_š™_‹¡_fs
()

59 
»t
;

61 
»t
 = 
	`»gi¡”_fžesy¡em
(&
‹¡_ty³
);

62 ià(
»t
) {

63 
	`´štk
(
KERN_ERR
 "btrfs: cannot„egisterest file system\n");

64  
»t
;

67 
‹¡_mÁ
 = 
	`k”n_mouÁ
(&
‹¡_ty³
);

68 ià(
	`IS_ERR
(
‹¡_mÁ
)) {

69 
	`´štk
(
KERN_ERR
 "btrfs: cannot mountest file system\n");

70 
	`uÄegi¡”_fžesy¡em
(&
‹¡_ty³
);

71  
	`PTR_ERR
(
‹¡_mÁ
);

74 
	}
}

76 
	$bŒfs_de¡roy_‹¡_fs
()

78 
	`k”n_unmouÁ
(
‹¡_mÁ
);

79 
	`uÄegi¡”_fžesy¡em
(&
‹¡_ty³
);

80 
	}
}

82 
bŒfs_fs_šfo
 *
	$bŒfs_®loc_dummy_fs_šfo
(
u32
 
nodesize
, u32 
£ùÜsize
)

84 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`kz®loc
((btrfs_fs_info),

85 
GFP_KERNEL
);

87 ià(!
fs_šfo
)

88  
fs_šfo
;

89 
fs_šfo
->
fs_deviûs
 = 
	`kz®loc
((
bŒfs_fs_deviûs
),

90 
GFP_KERNEL
);

91 ià(!
fs_šfo
->
fs_deviûs
) {

92 
	`kä“
(
fs_šfo
);

93  
NULL
;

95 
fs_šfo
->
su³r_cÝy
 = 
	`kz®loc
((
bŒfs_su³r_block
),

96 
GFP_KERNEL
);

97 ià(!
fs_šfo
->
su³r_cÝy
) {

98 
	`kä“
(
fs_šfo
->
fs_deviûs
);

99 
	`kä“
(
fs_šfo
);

100  
NULL
;

103 
fs_šfo
->
nodesize
 =‚odesize;

104 
fs_šfo
->
£ùÜsize
 = sectorsize;

106 ià(
	`š™_¤cu_¡ruù
(&
fs_šfo
->
subvÞ_¤cu
)) {

107 
	`kä“
(
fs_šfo
->
fs_deviûs
);

108 
	`kä“
(
fs_šfo
->
su³r_cÝy
);

109 
	`kä“
(
fs_šfo
);

110  
NULL
;

113 
	`¥š_lock_š™
(&
fs_šfo
->
bufãr_lock
);

114 
	`¥š_lock_š™
(&
fs_šfo
->
qgroup_lock
);

115 
	`¥š_lock_š™
(&
fs_šfo
->
qgroup_Ý_lock
);

116 
	`¥š_lock_š™
(&
fs_šfo
->
su³r_lock
);

117 
	`¥š_lock_š™
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

118 
	`¥š_lock_š™
(&
fs_šfo
->
Œ“_mod_£q_lock
);

119 
	`mu‹x_š™
(&
fs_šfo
->
qgroup_ioùl_lock
);

120 
	`mu‹x_š™
(&
fs_šfo
->
qgroup_»sÿn_lock
);

121 
	`rwlock_š™
(&
fs_šfo
->
Œ“_mod_log_lock
);

122 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

123 
fs_šfo
->
qgroup_Œ“
 = 
RB_ROOT
;

124 
fs_šfo
->
qgroup_uli¡
 = 
NULL
;

125 
	`©omic64_£t
(&
fs_šfo
->
Œ“_mod_£q
, 0);

126 
	`INIT_LIST_HEAD
(&
fs_šfo
->
dœty_qgroups
);

127 
	`INIT_LIST_HEAD
(&
fs_šfo
->
d—d_roÙs
);

128 
	`INIT_LIST_HEAD
(&
fs_šfo
->
Œ“_mod_£q_li¡
);

129 
	`INIT_RADIX_TREE
(&
fs_šfo
->
bufãr_¿dix
, 
GFP_ATOMIC
);

130 
	`INIT_RADIX_TREE
(&
fs_šfo
->
fs_roÙs_¿dix
, 
GFP_ATOMIC
);

131 
	`ex‹Á_io_Œ“_š™
(&
fs_šfo
->
ä“d_ex‹Ás
[0], 
NULL
);

132 
	`ex‹Á_io_Œ“_š™
(&
fs_šfo
->
ä“d_ex‹Ás
[1], 
NULL
);

133 
fs_šfo
->
pšÃd_ex‹Ás
 = &fs_šfo->
ä“d_ex‹Ás
[0];

134 
	`£t_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
, &
fs_šfo
->
fs_¡©e
);

136 
‹¡_mÁ
->
mÁ_sb
->
s_fs_šfo
 = 
fs_šfo
;

138  
fs_šfo
;

139 
	}
}

141 
	$bŒfs_ä“_dummy_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
)

143 
¿dix_Œ“_™”
 
™”
;

144 **
¦Ù
;

146 ià(!
fs_šfo
)

149 ià(
	`WARN_ON
(!
	`‹¡_b™
(
BTRFS_FS_STATE_DUMMY_FS_INFO
,

150 &
fs_šfo
->
fs_¡©e
)))

153 
‹¡_mÁ
->
mÁ_sb
->
s_fs_šfo
 = 
NULL
;

155 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

156 
	`¿dix_Œ“_fÜ_—ch_¦Ù
(
¦Ù
, &
fs_šfo
->
bufãr_¿dix
, &
™”
, 0) {

157 
ex‹Á_bufãr
 *
eb
;

159 
eb
 = 
	`¿dix_Œ“_d”ef_¦Ù_´Ùeùed
(
¦Ù
, &
fs_šfo
->
bufãr_lock
);

160 ià(!
eb
)

163 ià(
	`¿dix_Œ“_exû±iÚ
(
eb
)) {

164 ià(
	`¿dix_Œ“_d”ef_»Œy
(
eb
))

165 
¦Ù
 = 
	`¿dix_Œ“_™”_»Œy
(&
™”
);

168 
¦Ù
 = 
	`¿dix_Œ“_™”_»sume
(¦Ù, &
™”
);

169 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

170 
	`ä“_ex‹Á_bufãr_¡®e
(
eb
);

171 
	`¥š_lock
(&
fs_šfo
->
bufãr_lock
);

173 
	`¥š_uÆock
(&
fs_šfo
->
bufãr_lock
);

175 
	`bŒfs_ä“_qgroup_cÚfig
(
fs_šfo
);

176 
	`bŒfs_ä“_fs_roÙs
(
fs_šfo
);

177 
	`þ—nup_¤cu_¡ruù
(&
fs_šfo
->
subvÞ_¤cu
);

178 
	`kä“
(
fs_šfo
->
su³r_cÝy
);

179 
	`kä“
(
fs_šfo
->
fs_deviûs
);

180 
	`kä“
(
fs_šfo
);

181 
	}
}

183 
	$bŒfs_ä“_dummy_roÙ
(
bŒfs_roÙ
 *
roÙ
)

185 ià(!
roÙ
)

188 ià(
	`WARN_ON
(
	`‹¡_b™
(
BTRFS_ROOT_IN_RADIX
, &
roÙ
->
¡©e
)))

190 ià(
roÙ
->
node
)

191 
	`ä“_ex‹Á_bufãr
(
roÙ
->
node
);

192 
	`kä“
(
roÙ
);

193 
	}
}

195 
bŒfs_block_group_ÿche
 *

196 
	$bŒfs_®loc_dummy_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
,

197 
Ëngth
)

199 
bŒfs_block_group_ÿche
 *
ÿche
;

201 
ÿche
 = 
	`kz®loc
((*ÿche), 
GFP_KERNEL
);

202 ià(!
ÿche
)

203  
NULL
;

204 
ÿche
->
ä“_¥aû_ùl
 = 
	`kz®loc
((*cache->free_space_ctl),

205 
GFP_KERNEL
);

206 ià(!
ÿche
->
ä“_¥aû_ùl
) {

207 
	`kä“
(
ÿche
);

208  
NULL
;

211 
ÿche
->
key
.
objeùid
 = 0;

212 
ÿche
->
key
.
off£t
 = 
Ëngth
;

213 
ÿche
->
key
.
ty³
 = 
BTRFS_BLOCK_GROUP_ITEM_KEY
;

214 
ÿche
->
fuÎ_¡re_Ën
 = 
fs_šfo
->
£ùÜsize
;

215 
ÿche
->
fs_šfo
 = fs_info;

217 
	`INIT_LIST_HEAD
(&
ÿche
->
li¡
);

218 
	`INIT_LIST_HEAD
(&
ÿche
->
þu¡”_li¡
);

219 
	`INIT_LIST_HEAD
(&
ÿche
->
bg_li¡
);

220 
	`bŒfs_š™_ä“_¥aû_ùl
(
ÿche
);

221 
	`mu‹x_š™
(&
ÿche
->
ä“_¥aû_lock
);

223  
ÿche
;

224 
	}
}

226 
	$bŒfs_ä“_dummy_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
)

228 ià(!
ÿche
)

230 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

231 
	`kä“
(
ÿche
->
ä“_¥aû_ùl
);

232 
	`kä“
(
ÿche
);

233 
	}
}

235 
	$bŒfs_š™_dummy_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
)

237 
	`mem£t
(
Œªs
, 0, (*trans));

238 
Œªs
->
Œªsid
 = 1;

239 
Œªs
->
ty³
 = 
__TRANS_DUMMY
;

240 
	}
}

242 
	$bŒfs_run_§n™y_‹¡s
()

244 
»t
, 
i
;

245 
u32
 
£ùÜsize
, 
nodesize
;

246 
u32
 
‹¡_£ùÜsize
[] = {

247 
PAGE_SIZE
,

249 
»t
 = 
	`bŒfs_š™_‹¡_fs
();

250 ià(
»t
)

251  
»t
;

252 
i
 = 0; i < 
	`ARRAY_SIZE
(
‹¡_£ùÜsize
); i++) {

253 
£ùÜsize
 = 
‹¡_£ùÜsize
[
i
];

254 
nodesize
 = 
£ùÜsize
;

255 
nodesize
 <ð
BTRFS_MAX_METADATA_BLOCKSIZE
;

256 
nodesize
 <<= 1) {

257 
	`´_šfo
("BTRFS: selftest: sectorsize: %u‚odesize: %u\n",

258 
£ùÜsize
, 
nodesize
);

259 
»t
 = 
	`bŒfs_‹¡_ä“_¥aû_ÿche
(
£ùÜsize
, 
nodesize
);

260 ià(
»t
)

261 
out
;

262 
»t
 = 
	`bŒfs_‹¡_ex‹Á_bufãr_Ý”©iÚs
(
£ùÜsize
,

263 
nodesize
);

264 ià(
»t
)

265 
out
;

266 
»t
 = 
	`bŒfs_‹¡_ex‹Á_io
(
£ùÜsize
, 
nodesize
);

267 ià(
»t
)

268 
out
;

269 
»t
 = 
	`bŒfs_‹¡_šodes
(
£ùÜsize
, 
nodesize
);

270 ià(
»t
)

271 
out
;

272 
»t
 = 
	`bŒfs_‹¡_qgroups
(
£ùÜsize
, 
nodesize
);

273 ià(
»t
)

274 
out
;

275 
»t
 = 
	`bŒfs_‹¡_ä“_¥aû_Œ“
(
£ùÜsize
, 
nodesize
);

276 ià(
»t
)

277 
out
;

280 
out
:

281 
	`bŒfs_de¡roy_‹¡_fs
();

282  
»t
;

283 
	}
}

	@tests/btrfs-tests.h

19 #iâdeà
__BTRFS_TESTS


20 
	#__BTRFS_TESTS


	)

22 #ifdeà
CONFIG_BTRFS_FS_RUN_SANITY_TESTS


23 
bŒfs_run_§n™y_‹¡s
();

25 
	#‹¡_msg
(
fmt
, ...è
	`´_šfo
("BTRFS: s–áe¡: " fmt, ##
__VA_ARGS__
)

	)

27 
	gbŒfs_roÙ
;

28 
	gbŒfs_Œªs_hªdË
;

30 
bŒfs_‹¡_ex‹Á_bufãr_Ý”©iÚs
(
u32
 
£ùÜsize
, u32 
nodesize
);

31 
bŒfs_‹¡_ä“_¥aû_ÿche
(
u32
 
£ùÜsize
, u32 
nodesize
);

32 
bŒfs_‹¡_ex‹Á_io
(
u32
 
£ùÜsize
, u32 
nodesize
);

33 
bŒfs_‹¡_šodes
(
u32
 
£ùÜsize
, u32 
nodesize
);

34 
bŒfs_‹¡_qgroups
(
u32
 
£ùÜsize
, u32 
nodesize
);

35 
bŒfs_‹¡_ä“_¥aû_Œ“
(
u32
 
£ùÜsize
, u32 
nodesize
);

36 
šode
 *
bŒfs_Ãw_‹¡_šode
();

37 
bŒfs_fs_šfo
 *
bŒfs_®loc_dummy_fs_šfo
(
u32
 
nodesize
, u32 
£ùÜsize
);

38 
bŒfs_ä“_dummy_fs_šfo
(
bŒfs_fs_šfo
 *
fs_šfo
);

39 
bŒfs_ä“_dummy_roÙ
(
bŒfs_roÙ
 *
roÙ
);

40 
bŒfs_block_group_ÿche
 *

41 
bŒfs_®loc_dummy_block_group
(
bŒfs_fs_šfo
 *
fs_šfo
, 
Ëngth
);

42 
bŒfs_ä“_dummy_block_group
(
bŒfs_block_group_ÿche
 *
ÿche
);

43 
bŒfs_š™_dummy_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
);

45 
šlše
 
	$bŒfs_run_§n™y_‹¡s
()

48 
	}
}

	@tests/extent-buffer-tests.c

19 
	~<lšux/¦ab.h
>

20 
	~"bŒfs-‹¡s.h
"

21 
	~"../ù»e.h
"

22 
	~"../ex‹Á_io.h
"

23 
	~"../disk-io.h
"

25 
	$‹¡_bŒfs_¥l™_™em
(
u32
 
£ùÜsize
, u32 
nodesize
)

27 
bŒfs_fs_šfo
 *
fs_šfo
;

28 
bŒfs_·th
 *
·th
 = 
NULL
;

29 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

30 
ex‹Á_bufãr
 *
eb
;

31 
bŒfs_™em
 *
™em
;

32 *
v®ue
 = "mary had‡†ittle†amb";

33 *
¥l™1
 = "mary had‡†ittle";

34 *
¥l™2
 = "†amb";

35 *
¥l™3
 = "mary";

36 *
¥l™4
 = " had‡†ittle";

37 
buf
[32];

38 
bŒfs_key
 
key
;

39 
u32
 
v®ue_Ën
 = 
	`¡¾’
(
v®ue
);

40 
»t
 = 0;

42 
	`‹¡_msg
("Running btrfs_split_itemests\n");

44 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

45 ià(!
fs_šfo
) {

46 
	`‹¡_msg
("Could‚ot‡llocate fs_info\n");

47  -
ENOMEM
;

50 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

51 ià(
	`IS_ERR
(
roÙ
)) {

52 
	`‹¡_msg
("Could‚ot‡llocate„oot\n");

53 
»t
 = 
	`PTR_ERR
(
roÙ
);

54 
out
;

57 
·th
 = 
	`bŒfs_®loc_·th
();

58 ià(!
·th
) {

59 
	`‹¡_msg
("Could‚ot‡llocate…ath\n");

60 
»t
 = -
ENOMEM
;

61 
out
;

64 
·th
->
nodes
[0] = 
eb
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
nodesize
);

65 ià(!
eb
) {

66 
	`‹¡_msg
("Could‚ot‡llocate dummy buffer\n");

67 
»t
 = -
ENOMEM
;

68 
out
;

70 
·th
->
¦Ùs
[0] = 0;

72 
key
.
objeùid
 = 0;

73 
key
.
ty³
 = 
BTRFS_EXTENT_CSUM_KEY
;

74 
key
.
off£t
 = 0;

76 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, 
·th
, &
key
, &
v®ue_Ën
, value_len,

77 
v®ue_Ën
 + (
bŒfs_™em
), 1);

78 
™em
 = 
	`bŒfs_™em_Ä
(0);

79 
	`wr™e_ex‹Á_bufãr
(
eb
, 
v®ue
, 
	`bŒfs_™em_±r_off£t
(eb, 0),

80 
v®ue_Ën
);

82 
key
.
off£t
 = 3;

89 
»t
 = 
	`bŒfs_¥l™_™em
(
NULL
, 
roÙ
, 
·th
, &
key
, 17);

90 ià(
»t
) {

91 
	`‹¡_msg
("S¶™ i‹m fažed %d\n", 
»t
);

92 
out
;

99 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 0);

100 ià(
key
.
objeùid
 !ð0 || key.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

101 
key
.
off£t
 != 0) {

102 
	`‹¡_msg
("Invalid key‡t slot 0\n");

103 
»t
 = -
EINVAL
;

104 
out
;

107 
™em
 = 
	`bŒfs_™em_Ä
(0);

108 ià(
	`bŒfs_™em_size
(
eb
, 
™em
è!ð
	`¡¾’
(
¥l™1
)) {

109 
	`‹¡_msg
("Invalid†en inhe first split\n");

110 
»t
 = -
EINVAL
;

111 
out
;

114 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 0),

115 
	`¡¾’
(
¥l™1
));

116 ià(
	`memcmp
(
buf
, 
¥l™1
, 
	`¡¾’
(split1))) {

117 
	`‹¡_msg
("Data inhe buffer doesn't match what it should "

119 ()
	`¡¾’
(
¥l™1
), 
buf
, split1);

120 
»t
 = -
EINVAL
;

121 
out
;

124 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 1);

125 ià(
key
.
objeùid
 !ð0 || key.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

126 
key
.
off£t
 != 3) {

127 
	`‹¡_msg
("Invalid key‡t slot 1\n");

128 
»t
 = -
EINVAL
;

129 
out
;

132 
™em
 = 
	`bŒfs_™em_Ä
(1);

133 ià(
	`bŒfs_™em_size
(
eb
, 
™em
è!ð
	`¡¾’
(
¥l™2
)) {

134 
	`‹¡_msg
("Invalid†en inhe second split\n");

135 
»t
 = -
EINVAL
;

136 
out
;

139 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 1),

140 
	`¡¾’
(
¥l™2
));

141 ià(
	`memcmp
(
buf
, 
¥l™2
, 
	`¡¾’
(split2))) {

142 
	`‹¡_msg
("Data inhe buffer doesn't match what it should "

144 
»t
 = -
EINVAL
;

145 
out
;

148 
key
.
off£t
 = 1;

150 
»t
 = 
	`bŒfs_¥l™_™em
(
NULL
, 
roÙ
, 
·th
, &
key
, 4);

151 ià(
»t
) {

152 
	`‹¡_msg
("SecÚd s¶™ i‹m fažed %d\n", 
»t
);

153 
out
;

156 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 0);

157 ià(
key
.
objeùid
 !ð0 || key.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

158 
key
.
off£t
 != 0) {

159 
	`‹¡_msg
("Invalid key‡t slot 0\n");

160 
»t
 = -
EINVAL
;

161 
out
;

164 
™em
 = 
	`bŒfs_™em_Ä
(0);

165 ià(
	`bŒfs_™em_size
(
eb
, 
™em
è!ð
	`¡¾’
(
¥l™3
)) {

166 
	`‹¡_msg
("Invalid†en inhe first split\n");

167 
»t
 = -
EINVAL
;

168 
out
;

171 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 0),

172 
	`¡¾’
(
¥l™3
));

173 ià(
	`memcmp
(
buf
, 
¥l™3
, 
	`¡¾’
(split3))) {

174 
	`‹¡_msg
("Data inhe buffer doesn't match what it should "

176 
»t
 = -
EINVAL
;

177 
out
;

180 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 1);

181 ià(
key
.
objeùid
 !ð0 || key.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

182 
key
.
off£t
 != 1) {

183 
	`‹¡_msg
("Invalid key‡t slot 1\n");

184 
»t
 = -
EINVAL
;

185 
out
;

188 
™em
 = 
	`bŒfs_™em_Ä
(1);

189 ià(
	`bŒfs_™em_size
(
eb
, 
™em
è!ð
	`¡¾’
(
¥l™4
)) {

190 
	`‹¡_msg
("Invalid†en inhe second split\n");

191 
»t
 = -
EINVAL
;

192 
out
;

195 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 1),

196 
	`¡¾’
(
¥l™4
));

197 ià(
	`memcmp
(
buf
, 
¥l™4
, 
	`¡¾’
(split4))) {

198 
	`‹¡_msg
("Data inhe buffer doesn't match what it should "

200 
»t
 = -
EINVAL
;

201 
out
;

204 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 2);

205 ià(
key
.
objeùid
 !ð0 || key.
ty³
 !ð
BTRFS_EXTENT_CSUM_KEY
 ||

206 
key
.
off£t
 != 3) {

207 
	`‹¡_msg
("Invalid key‡t slot 2\n");

208 
»t
 = -
EINVAL
;

209 
out
;

212 
™em
 = 
	`bŒfs_™em_Ä
(2);

213 ià(
	`bŒfs_™em_size
(
eb
, 
™em
è!ð
	`¡¾’
(
¥l™2
)) {

214 
	`‹¡_msg
("Invalid†en inhe second split\n");

215 
»t
 = -
EINVAL
;

216 
out
;

219 
	`»ad_ex‹Á_bufãr
(
eb
, 
buf
, 
	`bŒfs_™em_±r_off£t
(eb, 2),

220 
	`¡¾’
(
¥l™2
));

221 ià(
	`memcmp
(
buf
, 
¥l™2
, 
	`¡¾’
(split2))) {

222 
	`‹¡_msg
("Data inhe buffer doesn't match what it should "

224 
»t
 = -
EINVAL
;

225 
out
;

227 
out
:

228 
	`bŒfs_ä“_·th
(
·th
);

229 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

230 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

231  
»t
;

232 
	}
}

234 
	$bŒfs_‹¡_ex‹Á_bufãr_Ý”©iÚs
(
u32
 
£ùÜsize
, u32 
nodesize
)

236 
	`‹¡_msg
("Runningƒxtent buffer operationests\n");

237  
	`‹¡_bŒfs_¥l™_™em
(
£ùÜsize
, 
nodesize
);

238 
	}
}

	@tests/extent-io-tests.c

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/sched.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/sizes.h
>

23 
	~"bŒfs-‹¡s.h
"

24 
	~"../ù»e.h
"

25 
	~"../ex‹Á_io.h
"

27 
	#PROCESS_UNLOCK
 (1 << 0)

	)

28 
	#PROCESS_RELEASE
 (1 << 1)

	)

29 
	#PROCESS_TEST_LOCKED
 (1 << 2)

	)

31 
nošlše
 
	$´oûss_·ge_¿nge
(
šode
 *šode, 
u64
 
¡¬t
, u64 
’d
,

32 
æags
)

34 
»t
;

35 
·ge
 *
·ges
[16];

36 
šdex
 = 
¡¬t
 >> 
PAGE_SHIFT
;

37 
’d_šdex
 = 
’d
 >> 
PAGE_SHIFT
;

38 
Ä_·ges
 = 
’d_šdex
 - 
šdex
 + 1;

39 
i
;

40 
couÁ
 = 0;

41 
loÝs
 = 0;

43 
Ä_·ges
 > 0) {

44 
»t
 = 
	`fšd_g‘_·ges_cÚtig
(
šode
->
i_m­pšg
, 
šdex
,

45 
	`mš_t
(, 
Ä_·ges
,

46 
	`ARRAY_SIZE
(
·ges
)),…ages);

47 
i
 = 0; i < 
»t
; i++) {

48 ià(
æags
 & 
PROCESS_TEST_LOCKED
 &&

49 !
	`PageLocked
(
·ges
[
i
]))

50 
couÁ
++;

51 ià(
æags
 & 
PROCESS_UNLOCK
 && 
	`PageLocked
(
·ges
[
i
]))

52 
	`uÆock_·ge
(
·ges
[
i
]);

53 
	`put_·ge
(
·ges
[
i
]);

54 ià(
æags
 & 
PROCESS_RELEASE
)

55 
	`put_·ge
(
·ges
[
i
]);

57 
Ä_·ges
 -ð
»t
;

58 
šdex
 +ð
»t
;

59 
	`cÚd_»sched
();

60 
loÝs
++;

61 ià(
loÝs
 > 100000) {

62 
	`´štk
(
KERN_ERR
 "¡uck iÀ¨loÝ, s¹ %Lu,ƒnd %Lu,‚r_·ge %lu,„‘ %d\n", 
¡¬t
, 
’d
, 
Ä_·ges
, 
»t
);

66  
couÁ
;

67 
	}
}

69 
	$‹¡_fšd_d–®loc
(
u32
 
£ùÜsize
)

71 
šode
 *inode;

72 
ex‹Á_io_Œ“
 
tmp
;

73 
·ge
 *page;

74 
·ge
 *
locked_·ge
 = 
NULL
;

75 
šdex
 = 0;

76 
u64
 
tÙ®_dœty
 = 
SZ_256M
;

77 
u64
 
max_by‹s
 = 
SZ_128M
;

78 
u64
 
¡¬t
, 
’d
, 
‹¡_¡¬t
;

79 
u64
 
found
;

80 
»t
 = -
EINVAL
;

82 
	`‹¡_msg
("Running find delallocests\n");

84 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

85 ià(!
šode
) {

86 
	`‹¡_msg
("Failedo‡llocateest inode\n");

87  -
ENOMEM
;

90 
	`ex‹Á_io_Œ“_š™
(&
tmp
, 
šode
);

97 
šdex
 = 0; index < (
tÙ®_dœty
 >> 
PAGE_SHIFT
); index++) {

98 
·ge
 = 
	`fšd_Ü_ü—‹_·ge
(
šode
->
i_m­pšg
, 
šdex
, 
GFP_KERNEL
);

99 ià(!
·ge
) {

100 
	`‹¡_msg
("Failedo‡llocateest…age\n");

101 
»t
 = -
ENOMEM
;

102 
out
;

104 
	`S‘PageDœty
(
·ge
);

105 ià(
šdex
) {

106 
	`uÆock_·ge
(
·ge
);

108 
	`g‘_·ge
(
·ge
);

109 
locked_·ge
 = 
·ge
;

117 
	`£t_ex‹Á_d–®loc
(&
tmp
, 0, 
£ùÜsize
 - 1, 
NULL
);

118 
¡¬t
 = 0;

119 
’d
 = 0;

120 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, &
tmp
, 
locked_·ge
, &
¡¬t
,

121 &
’d
, 
max_by‹s
);

122 ià(!
found
) {

123 
	`‹¡_msg
("Should have found‡t†east one delalloc\n");

124 
out_b™s
;

126 ià(
¡¬t
 !ð0 || 
’d
 !ð(
£ùÜsize
 - 1)) {

127 
	`‹¡_msg
("Expected start 0ƒnd %u, got start %lluƒnd %llu\n",

128 
£ùÜsize
 - 1, 
¡¬t
, 
’d
);

129 
out_b™s
;

131 
	`uÆock_ex‹Á
(&
tmp
, 
¡¬t
, 
’d
);

132 
	`uÆock_·ge
(
locked_·ge
);

133 
	`put_·ge
(
locked_·ge
);

141 
‹¡_¡¬t
 = 
SZ_64M
;

142 
locked_·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
,

143 
‹¡_¡¬t
 >> 
PAGE_SHIFT
);

144 ià(!
locked_·ge
) {

145 
	`‹¡_msg
("Couldn't findhe†ocked…age\n");

146 
out_b™s
;

148 
	`£t_ex‹Á_d–®loc
(&
tmp
, 
£ùÜsize
, 
max_by‹s
 - 1, 
NULL
);

149 
¡¬t
 = 
‹¡_¡¬t
;

150 
’d
 = 0;

151 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, &
tmp
, 
locked_·ge
, &
¡¬t
,

152 &
’d
, 
max_by‹s
);

153 ià(!
found
) {

154 
	`‹¡_msg
("Couldn't find delalloc in our„ange\n");

155 
out_b™s
;

157 ià(
¡¬t
 !ð
‹¡_¡¬t
 || 
’d
 !ð
max_by‹s
 - 1) {

158 
	`‹¡_msg
("Expected start %Luƒnd %Lu, got start %Lu,ƒnd "

159 "%Lu\n", 
‹¡_¡¬t
, 
max_by‹s
 - 1, 
¡¬t
, 
’d
);

160 
out_b™s
;

162 ià(
	`´oûss_·ge_¿nge
(
šode
, 
¡¬t
, 
’d
,

163 
PROCESS_TEST_LOCKED
 | 
PROCESS_UNLOCK
)) {

164 
	`‹¡_msg
("There were unlocked…ages inhe„ange\n");

165 
out_b™s
;

167 
	`uÆock_ex‹Á
(&
tmp
, 
¡¬t
, 
’d
);

169 
	`put_·ge
(
locked_·ge
);

176 
‹¡_¡¬t
 = 
max_by‹s
 + 
£ùÜsize
;

177 
locked_·ge
 = 
	`fšd_lock_·ge
(
šode
->
i_m­pšg
, 
‹¡_¡¬t
 >>

178 
PAGE_SHIFT
);

179 ià(!
locked_·ge
) {

180 
	`‹¡_msg
("Couldn't findhe†ocked…age\n");

181 
out_b™s
;

183 
¡¬t
 = 
‹¡_¡¬t
;

184 
’d
 = 0;

185 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, &
tmp
, 
locked_·ge
, &
¡¬t
,

186 &
’d
, 
max_by‹s
);

187 ià(
found
) {

188 
	`‹¡_msg
("Found„ange when we shouldn't have\n");

189 
out_b™s
;

191 ià(
’d
 !ð(
u64
)-1) {

192 
	`‹¡_msg
("Did‚ot„eturnhe…roperƒnd offset\n");

193 
out_b™s
;

203 
	`£t_ex‹Á_d–®loc
(&
tmp
, 
max_by‹s
, 
tÙ®_dœty
 - 1, 
NULL
);

204 
¡¬t
 = 
‹¡_¡¬t
;

205 
’d
 = 0;

206 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, &
tmp
, 
locked_·ge
, &
¡¬t
,

207 &
’d
, 
max_by‹s
);

208 ià(!
found
) {

209 
	`‹¡_msg
("Didn't find our„ange\n");

210 
out_b™s
;

212 ià(
¡¬t
 !ð
‹¡_¡¬t
 || 
’d
 !ð
tÙ®_dœty
 - 1) {

213 
	`‹¡_msg
("Expected start %Luƒnd %Lu, got start %Luƒnd %Lu\n",

214 
‹¡_¡¬t
, 
tÙ®_dœty
 - 1, 
¡¬t
, 
’d
);

215 
out_b™s
;

217 ià(
	`´oûss_·ge_¿nge
(
šode
, 
¡¬t
, 
’d
,

218 
PROCESS_TEST_LOCKED
 | 
PROCESS_UNLOCK
)) {

219 
	`‹¡_msg
("Pages in„ange were‚ot‡ll†ocked\n");

220 
out_b™s
;

222 
	`uÆock_ex‹Á
(&
tmp
, 
¡¬t
, 
’d
);

228 
·ge
 = 
	`fšd_g‘_·ge
(
šode
->
i_m­pšg
,

229 (
max_by‹s
 + 
SZ_1M
è>> 
PAGE_SHIFT
);

230 ià(!
·ge
) {

231 
	`‹¡_msg
("Couldn't find our…age\n");

232 
out_b™s
;

234 
	`CË¬PageDœty
(
·ge
);

235 
	`put_·ge
(
·ge
);

238 
	`lock_·ge
(
locked_·ge
);

239 
¡¬t
 = 
‹¡_¡¬t
;

240 
’d
 = 0;

247 
found
 = 
	`fšd_lock_d–®loc_¿nge
(
šode
, &
tmp
, 
locked_·ge
, &
¡¬t
,

248 &
’d
, 
max_by‹s
);

249 ià(!
found
) {

250 
	`‹¡_msg
("Didn't find our„ange\n");

251 
out_b™s
;

253 ià(
¡¬t
 !ð
‹¡_¡¬t
 && 
’d
 !ð‹¡_¡¬ˆ+ 
PAGE_SIZE
 - 1) {

254 
	`‹¡_msg
("Expected start %Luƒnd %Lu, got start %Luƒnd %Lu\n",

255 
‹¡_¡¬t
,e¡_¡¬ˆ+ 
PAGE_SIZE
 - 1, 
¡¬t
,

256 
’d
);

257 
out_b™s
;

259 ià(
	`´oûss_·ge_¿nge
(
šode
, 
¡¬t
, 
’d
, 
PROCESS_TEST_LOCKED
 |

260 
PROCESS_UNLOCK
)) {

261 
	`‹¡_msg
("Pages in„ange were‚ot‡ll†ocked\n");

262 
out_b™s
;

264 
»t
 = 0;

265 
out_b™s
:

266 
	`þ—r_ex‹Á_b™s
(&
tmp
, 0, 
tÙ®_dœty
 - 1, ()-1);

267 
out
:

268 ià(
locked_·ge
)

269 
	`put_·ge
(
locked_·ge
);

270 
	`´oûss_·ge_¿nge
(
šode
, 0, 
tÙ®_dœty
 - 1,

271 
PROCESS_UNLOCK
 | 
PROCESS_RELEASE
);

272 
	`ut
(
šode
);

273  
»t
;

274 
	}
}

276 
	$check_eb_b™m­
(*
b™m­
, 
ex‹Á_bufãr
 *
eb
,

277 
Ën
)

279 
i
;

281 
i
 = 0; i < 
Ën
 * 
BITS_PER_BYTE
; i++) {

282 
b™
, 
b™1
;

284 
b™
 = !!
	`‹¡_b™
(
i
, 
b™m­
);

285 
b™1
 = !!
	`ex‹Á_bufãr_‹¡_b™
(
eb
, 0, 
i
);

286 ià(
b™1
 !ð
b™
) {

287 
	`‹¡_msg
("Bits do‚ot match\n");

288  -
EINVAL
;

291 
b™1
 = !!
	`ex‹Á_bufãr_‹¡_b™
(
eb
, 
i
 / 
BITS_PER_BYTE
,

292 
i
 % 
BITS_PER_BYTE
);

293 ià(
b™1
 !ð
b™
) {

294 
	`‹¡_msg
("Offset bits do‚ot match\n");

295  -
EINVAL
;

299 
	}
}

301 
	$__‹¡_eb_b™m­s
(*
b™m­
, 
ex‹Á_bufãr
 *
eb
,

302 
Ën
)

304 
i
, 
j
;

305 
u32
 
x
;

306 
»t
;

308 
	`mem£t
(
b™m­
, 0, 
Ën
);

309 
	`memz”o_ex‹Á_bufãr
(
eb
, 0, 
Ën
);

310 ià(
	`memcmp_ex‹Á_bufãr
(
eb
, 
b™m­
, 0, 
Ën
) != 0) {

311 
	`‹¡_msg
("Bitmap was‚ot zeroed\n");

312  -
EINVAL
;

315 
	`b™m­_£t
(
b™m­
, 0, 
Ën
 * 
BITS_PER_BYTE
);

316 
	`ex‹Á_bufãr_b™m­_£t
(
eb
, 0, 0, 
Ën
 * 
BITS_PER_BYTE
);

317 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
, 
Ën
);

318 ià(
»t
) {

319 
	`‹¡_msg
("Setting‡ll bits failed\n");

320  
»t
;

323 
	`b™m­_þ—r
(
b™m­
, 0, 
Ën
 * 
BITS_PER_BYTE
);

324 
	`ex‹Á_bufãr_b™m­_þ—r
(
eb
, 0, 0, 
Ën
 * 
BITS_PER_BYTE
);

325 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
, 
Ën
);

326 ià(
»t
) {

327 
	`‹¡_msg
("Clearing‡ll bits failed\n");

328  
»t
;

332 ià(
Ën
 > 
PAGE_SIZE
) {

333 
	`b™m­_£t
(
b™m­
,

334 (
PAGE_SIZE
 - (è/ 2è* 
BITS_PER_BYTE
,

335 (è* 
BITS_PER_BYTE
);

336 
	`ex‹Á_bufãr_b™m­_£t
(
eb
, 
PAGE_SIZE
 - () / 2, 0,

337 (è* 
BITS_PER_BYTE
);

338 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
, 
Ën
);

339 ià(
»t
) {

340 
	`‹¡_msg
("Setting straddling…ages failed\n");

341  
»t
;

344 
	`b™m­_£t
(
b™m­
, 0, 
Ën
 * 
BITS_PER_BYTE
);

345 
	`b™m­_þ—r
(
b™m­
,

346 (
PAGE_SIZE
 - (è/ 2è* 
BITS_PER_BYTE
,

347 (è* 
BITS_PER_BYTE
);

348 
	`ex‹Á_bufãr_b™m­_£t
(
eb
, 0, 0, 
Ën
 * 
BITS_PER_BYTE
);

349 
	`ex‹Á_bufãr_b™m­_þ—r
(
eb
, 
PAGE_SIZE
 - () / 2, 0,

350 (è* 
BITS_PER_BYTE
);

351 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
, 
Ën
);

352 ià(
»t
) {

353 
	`‹¡_msg
("Clearing straddling…ages failed\n");

354  
»t
;

362 
x
 = 0;

363 
	`b™m­_þ—r
(
b™m­
, 0, 
Ën
 * 
BITS_PER_BYTE
);

364 
	`ex‹Á_bufãr_b™m­_þ—r
(
eb
, 0, 0, 
Ën
 * 
BITS_PER_BYTE
);

365 
i
 = 0; i < 
Ën
 * 
BITS_PER_BYTE
 / 32; i++) {

366 
x
 = (0x19660dULL * (
u64
)x + 0x3c6ef35fULL) & 0xffffffffU;

367 
j
 = 0; j < 32; j++) {

368 ià(
x
 & (1U << 
j
)) {

369 
	`b™m­_£t
(
b™m­
, 
i
 * 32 + 
j
, 1);

370 
	`ex‹Á_bufãr_b™m­_£t
(
eb
, 0, 
i
 * 32 + 
j
, 1);

375 
»t
 = 
	`check_eb_b™m­
(
b™m­
, 
eb
, 
Ën
);

376 ià(
»t
) {

377 
	`‹¡_msg
("Random bit…attern failed\n");

378  
»t
;

382 
	}
}

384 
	$‹¡_eb_b™m­s
(
u32
 
£ùÜsize
, u32 
nodesize
)

386 
bŒfs_fs_šfo
 *
fs_šfo
;

387 
Ën
;

388 *
b™m­
;

389 
ex‹Á_bufãr
 *
eb
;

390 
»t
;

392 
	`‹¡_msg
("Runningƒxtent buffer bitmapests\n");

398 
Ën
 = (
£ùÜsize
 < 
BTRFS_MAX_METADATA_BLOCKSIZE
)

399 ? 
£ùÜsize
 * 4 : sectorsize;

401 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
Ën
,†en);

403 
b™m­
 = 
	`km®loc
(
Ën
, 
GFP_KERNEL
);

404 ià(!
b™m­
) {

405 
	`‹¡_msg
("Couldn't‡llocateest bitmap\n");

406  -
ENOMEM
;

409 
eb
 = 
	`__®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 0, 
Ën
);

410 ià(!
eb
) {

411 
	`‹¡_msg
("Couldn't‡llocateestƒxtent buffer\n");

412 
	`kä“
(
b™m­
);

413  -
ENOMEM
;

416 
»t
 = 
	`__‹¡_eb_b™m­s
(
b™m­
, 
eb
, 
Ën
);

417 ià(
»t
)

418 
out
;

421 
	`ä“_ex‹Á_bufãr
(
eb
);

422 
eb
 = 
	`__®loc_dummy_ex‹Á_bufãr
(
NULL
, 
nodesize
 / 2, 
Ën
);

423 ià(!
eb
) {

424 
	`‹¡_msg
("Couldn't‡llocateestƒxtent buffer\n");

425 
	`kä“
(
b™m­
);

426  -
ENOMEM
;

429 
»t
 = 
	`__‹¡_eb_b™m­s
(
b™m­
, 
eb
, 
Ën
);

430 
out
:

431 
	`ä“_ex‹Á_bufãr
(
eb
);

432 
	`kä“
(
b™m­
);

433  
»t
;

434 
	}
}

436 
	$bŒfs_‹¡_ex‹Á_io
(
u32
 
£ùÜsize
, u32 
nodesize
)

438 
»t
;

440 
	`‹¡_msg
("Runningƒxtent I/Oests\n");

442 
»t
 = 
	`‹¡_fšd_d–®loc
(
£ùÜsize
);

443 ià(
»t
)

444 
out
;

446 
»t
 = 
	`‹¡_eb_b™m­s
(
£ùÜsize
, 
nodesize
);

447 
out
:

448 
	`‹¡_msg
("Extent I/Oests finished\n");

449  
»t
;

450 
	}
}

	@tests/free-space-tests.c

19 
	~<lšux/¦ab.h
>

20 
	~"bŒfs-‹¡s.h
"

21 
	~"../ù»e.h
"

22 
	~"../disk-io.h
"

23 
	~"../ä“-¥aû-ÿche.h
"

25 
	#BITS_PER_BITMAP
 (
PAGE_SIZE
 * 8UL)

	)

32 
	$‹¡_ex‹Ás
(
bŒfs_block_group_ÿche
 *
ÿche
)

34 
»t
 = 0;

36 
	`‹¡_msg
("Runningƒxtent onlyests\n");

39 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

40 ià(
»t
) {

41 
	`‹¡_msg
("E¼Ü‡ddšg in™ŸÈex‹Á %d\n", 
»t
);

42  
»t
;

45 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

46 ià(
»t
) {

47 
	`‹¡_msg
("E¼Ü„emovšgƒx‹Á %d\n", 
»t
);

48  
»t
;

51 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_4M
)) {

52 
	`‹¡_msg
("Full„emove†eft some†ingering space\n");

57 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

58 ià(
»t
) {

59 
	`‹¡_msg
("E¼Ü‡ddšg h®àex‹Á %d\n", 
»t
);

60  
»t
;

63 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 3 * 
SZ_1M
, SZ_1M);

64 ià(
»t
) {

65 
	`‹¡_msg
("E¼Ü„emovšgažƒnd %d\n", 
»t
);

66  
»t
;

69 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_1M
);

70 ià(
»t
) {

71 
	`‹¡_msg
("E¼Ü„emovšg frÚˆ’d %d\n", 
»t
);

72  
»t
;

75 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_2M
, 4096);

76 ià(
»t
) {

77 
	`‹¡_msg
("E¼Ü„emovšg middË…›û %d\n", 
»t
);

78  
»t
;

81 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_1M
)) {

82 
	`‹¡_msg
("Still have space‡the front\n");

86 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_2M
, 4096)) {

87 
	`‹¡_msg
("Still have space inhe middle\n");

91 ià(
	`‹¡_check_exi¡s
(
ÿche
, 3 * 
SZ_1M
, SZ_1M)) {

92 
	`‹¡_msg
("Still have space‡theƒnd\n");

97 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

100 
	}
}

102 
	$‹¡_b™m­s
(
bŒfs_block_group_ÿche
 *
ÿche
,

103 
u32
 
£ùÜsize
)

105 
u64
 
Ãxt_b™m­_off£t
;

106 
»t
;

108 
	`‹¡_msg
("Running bitmap onlyests\n");

110 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_4M
, 1);

111 ià(
»t
) {

112 
	`‹¡_msg
("Couldn'ˆü—‹‡ b™m­ƒÁry %d\n", 
»t
);

113  
»t
;

116 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_4M
);

117 ià(
»t
) {

118 
	`‹¡_msg
("E¼Ü„emovšg b™m­ fuÎ„ªg%d\n", 
»t
);

119  
»t
;

122 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_4M
)) {

123 
	`‹¡_msg
("Left some space in bitmap\n");

127 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_4M
, 1);

128 ià(
»t
) {

129 
	`‹¡_msg
("Couldn'ˆaddØou¸b™m­ƒÁry %d\n", 
»t
);

130  
»t
;

133 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_1M
, 
SZ_2M
);

134 ià(
»t
) {

135 
	`‹¡_msg
("Couldn'ˆ»movmiddË chunk %d\n", 
»t
);

136  
»t
;

143 
Ãxt_b™m­_off£t
 = (
u64
)(
BITS_PER_BITMAP
 * 
£ùÜsize
);

146 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
Ãxt_b™m­_off£t
 - 
SZ_2M
,

147 
SZ_4M
, 1);

148 ià(
»t
) {

149 
	`‹¡_msg
("Couldn't‡dd spacehat straddleswo bitmaps %d\n",

150 
»t
);

151  
»t
;

154 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
Ãxt_b™m­_off£t
 - 
SZ_1M
, 
SZ_2M
);

155 ià(
»t
) {

156 
	`‹¡_msg
("Couldn'ˆ»movov”Ïµšg s·û %d\n", 
»t
);

157  
»t
;

160 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
Ãxt_b™m­_off£t
 - 
SZ_1M
, 
SZ_2M
)) {

161 
	`‹¡_msg
("Left some space when„emoving overlapping\n");

165 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

168 
	}
}

171 
	$‹¡_b™m­s_ªd_ex‹Ás
(
bŒfs_block_group_ÿche
 *
ÿche
,

172 
u32
 
£ùÜsize
)

174 
u64
 
b™m­_off£t
 = (u64)(
BITS_PER_BITMAP
 * 
£ùÜsize
);

175 
»t
;

177 
	`‹¡_msg
("Running bitmap‡ndƒxtentests\n");

184 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_4M
, 
SZ_1M
, 1);

185 ià(
»t
) {

186 
	`‹¡_msg
("Couldn'ˆü—‹ b™m­ƒÁry %d\n", 
»t
);

187  
»t
;

190 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_1M
, 0);

191 ià(
»t
) {

192 
	`‹¡_msg
("Couldn'ˆaddƒx‹ÁƒÁry %d\n", 
»t
);

193  
»t
;

196 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_1M
);

197 ià(
»t
) {

198 
	`‹¡_msg
("Couldn'ˆ»movex‹ÁƒÁry %d\n", 
»t
);

199  
»t
;

202 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_1M
)) {

203 
	`‹¡_msg
("Left„emnants‡fter our„emove\n");

208 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_1M
, 0);

209 ià(
»t
) {

210 
	`‹¡_msg
("Couldn'ˆ»-addƒx‹ÁƒÁry %d\n", 
»t
);

211  
»t
;

214 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_4M
, 
SZ_1M
);

215 ià(
»t
) {

216 
	`‹¡_msg
("Couldn'ˆ»moväom b™m­ %d\n", 
»t
);

217  
»t
;

220 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_4M
, 
SZ_1M
)) {

221 
	`‹¡_msg
("Left„emnants inhe bitmap\n");

229 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_1M
, 
SZ_4M
, 1);

230 ià(
»t
) {

231 
	`‹¡_msg
("Couldn'ˆaddØ¨b™m­ %d\n", 
»t
);

232  
»t
;

235 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_512K
, 3 * 
SZ_1M
);

236 ià(
»t
) {

237 
	`‹¡_msg
("Couldn'ˆ»movov”Ïµšg s·û %d\n", 
»t
);

238  
»t
;

241 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_512K
, 3 * 
SZ_1M
)) {

242 
	`‹¡_msg
("Left over…ieces‡fter„emoving overlapping\n");

246 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

249 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_4M
, SZ_4M, 1);

250 ià(
»t
) {

251 
	`‹¡_msg
("Couldn'ˆadd s·ûØthb™m­ %d\n", 
»t
);

252  
»t
;

255 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_2M
, SZ_2M, 0);

256 ià(
»t
) {

257 
	`‹¡_msg
("Couldn'ˆaddƒx‹ÁØthÿch%d\n", 
»t
);

258  
»t
;

261 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 3 * 
SZ_1M
, 
SZ_4M
);

262 ià(
»t
) {

263 
	`‹¡_msg
("ProbËm„emovšg ov”Ïµšg s·û %d\n", 
»t
);

264  
»t
;

267 ià(
	`‹¡_check_exi¡s
(
ÿche
, 3 * 
SZ_1M
, 
SZ_4M
)) {

268 
	`‹¡_msg
("Left something behind when„emoving space");

282 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

283 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
b™m­_off£t
 + 
SZ_4M
, SZ_4M, 1);

284 ià(
»t
) {

285 
	`‹¡_msg
("Couldn'ˆadd b™m­ %d\n", 
»t
);

286  
»t
;

289 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
b™m­_off£t
 - 
SZ_1M
,

290 5 * 
SZ_1M
, 0);

291 ià(
»t
) {

292 
	`‹¡_msg
("Couldn'ˆaddƒx‹ÁƒÁry %d\n", 
»t
);

293  
»t
;

296 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
b™m­_off£t
 + 
SZ_1M
, 5 * SZ_1M);

297 ià(
»t
) {

298 
	`‹¡_msg
("FažedØä“ ou¸¥aû %d\n", 
»t
);

299  
»t
;

302 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
b™m­_off£t
 + 
SZ_1M
, 5 * SZ_1M)) {

303 
	`‹¡_msg
("Left stuff over\n");

307 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

315 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_1M
, 
SZ_2M
, 1);

316 ià(
»t
) {

317 
	`‹¡_msg
("Couldn'ˆadd b™m­ƒÁry %d\n", 
»t
);

318  
»t
;

321 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 3 * 
SZ_1M
, SZ_1M, 0);

322 ià(
»t
) {

323 
	`‹¡_msg
("Couldn'ˆaddƒx‹ÁƒÁry %d\n", 
»t
);

324  
»t
;

327 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 
SZ_1M
, 3 * SZ_1M);

328 ià(
»t
) {

329 
	`‹¡_msg
("E¼Ü„emovšg b™m­‡ndƒx‹Á ov”Ïµšg %d\n", 
»t
);

330  
»t
;

333 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

335 
	}
}

338 
boÞ
 
	$‹¡_u£_b™m­
(
bŒfs_ä“_¥aû_ùl
 *
ùl
,

339 
bŒfs_ä“_¥aû
 *
šfo
)

341  
ùl
->
ä“_ex‹Ás
 > 0;

342 
	}
}

346 
	$check_num_ex‹Ás_ªd_b™m­s
(cÚ¡ 
bŒfs_block_group_ÿche
 *
ÿche
,

347 cÚ¡ 
num_ex‹Ás
,

348 cÚ¡ 
num_b™m­s
)

350 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_ex‹Ás
 !ð
num_ex‹Ás
) {

351 
	`‹¡_msg
("Incorrect # ofƒxtentƒntries inhe cache: %d,ƒxpected %d\n",

352 
ÿche
->
ä“_¥aû_ùl
->
ä“_ex‹Ás
, 
num_ex‹Ás
);

353  -
EINVAL
;

355 ià(
ÿche
->
ä“_¥aû_ùl
->
tÙ®_b™m­s
 !ð
num_b™m­s
) {

356 
	`‹¡_msg
("Incorrect # ofƒxtentƒntries inhe cache: %d,ƒxpected %d\n",

357 
ÿche
->
ä“_¥aû_ùl
->
tÙ®_b™m­s
, 
num_b™m­s
);

358  -
EINVAL
;

361 
	}
}

364 
	$check_ÿche_em±y
(
bŒfs_block_group_ÿche
 *
ÿche
)

366 
u64
 
off£t
;

367 
u64
 
max_ex‹Á_size
;

373 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 != 0) {

374 
	`‹¡_msg
("Cache free space is‚ot 0\n");

375  -
EINVAL
;

379 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
, 0, 4096, 0,

380 &
max_ex‹Á_size
);

381 ià(
off£t
 != 0) {

382 
	`‹¡_msg
("Space‡llocation did‚ot fail,„eturned offset: %llu",

383 
off£t
);

384  -
EINVAL
;

388  
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 0, 0);

389 
	}
}

406 
	$‹¡_¡—l_¥aû_äom_b™m­_to_ex‹Á
(
bŒfs_block_group_ÿche
 *
ÿche
,

407 
u32
 
£ùÜsize
)

409 
»t
;

410 
u64
 
off£t
;

411 
u64
 
max_ex‹Á_size
;

412 cÚ¡ 
bŒfs_ä“_¥aû_Ý
 
‹¡_ä“_¥aû_Ýs
 = {

413 .
»ÿlc_th»shÞds
 = 
ÿche
->
ä“_¥aû_ùl
->
Ý
->recalc_thresholds,

414 .
u£_b™m­
 = 
‹¡_u£_b™m­
,

416 cÚ¡ 
bŒfs_ä“_¥aû_Ý
 *
Üig_ä“_¥aû_Ýs
;

418 
	`‹¡_msg
("Running space stealing from bitmapoƒxtent\n");

438 
Üig_ä“_¥aû_Ýs
 = 
ÿche
->
ä“_¥aû_ùl
->
Ý
;

439 
ÿche
->
ä“_¥aû_ùl
->
Ý
 = &
‹¡_ä“_¥aû_Ýs
;

444 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_128K
, 0);

445 ià(
»t
) {

446 
	`‹¡_msg
("Couldn'ˆaddƒx‹ÁƒÁry %d\n", 
»t
);

447  
»t
;

451 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_128M
 + 
SZ_512K
,

452 
SZ_128M
 - 
SZ_512K
, 1);

453 ià(
»t
) {

454 
	`‹¡_msg
("Couldn'ˆadd b™m­ƒÁry %d\n", 
»t
);

455  
»t
;

458 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

459 ià(
»t
)

460  
»t
;

469 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
,

470 
SZ_128M
 + 768 * 
SZ_1K
,

471 
SZ_128M
 - 768 * 
SZ_1K
);

472 ià(
»t
) {

473 
	`‹¡_msg
("FažedØä“…¬ˆoàb™m­ s·û %d\n", 
»t
);

474  
»t
;

478 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_128K
)) {

479 
	`‹¡_msg
("Free space„ange missing\n");

480  -
ENOENT
;

482 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 
SZ_512K
, 
SZ_256K
)) {

483 
	`‹¡_msg
("Free space„ange missing\n");

484  -
ENOENT
;

491 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 768 * 
SZ_1K
,

492 
SZ_128M
 - 768 * 
SZ_1K
)) {

493 
	`‹¡_msg
("Bitmap„egion‚ot„emoved from space cache\n");

494  -
EINVAL
;

501 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 
SZ_256K
, SZ_256K)) {

502 
	`‹¡_msg
("Invalid bitmap„egion marked‡s free\n");

503  -
EINVAL
;

510 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
, 
SZ_256K
)) {

511 
	`‹¡_msg
("Invalid bitmap„egion marked‡s free\n");

512  -
EINVAL
;

520 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
, 
SZ_512K
);

521 ià(
»t
) {

522 
	`‹¡_msg
("E¼Ü‡ddšg f»¥aû: %d\n", 
»t
);

523  
»t
;

526 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
, 
SZ_512K
)) {

527 
	`‹¡_msg
("Bitmap„egion‚ot marked‡s free\n");

528  -
ENOENT
;

535 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

536 ià(
»t
)

537  
»t
;

545 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
 + 
SZ_16M
, 
£ùÜsize
);

546 ià(
»t
) {

547 
	`‹¡_msg
("E¼Ü‡ddšg f»¥aû: %d\n", 
»t
);

548  
»t
;

555 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

556 ià(
»t
)

557  
»t
;

564 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
 - 
SZ_128K
, SZ_128K);

565 ià(
»t
) {

566 
	`‹¡_msg
("E¼Ü‡ddšg f»¥aû: %d\n", 
»t
);

567  
»t
;

570 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_128K
, SZ_128K)) {

571 
	`‹¡_msg
("Extent„egion‚ot marked‡s free\n");

572  -
ENOENT
;

579 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

580 ià(
»t
)

581  
»t
;

598 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_256K
, 
SZ_1M
)) {

599 
	`‹¡_msg
("Expected„egion‚ot marked‡s free\n");

600  -
ENOENT
;

603 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ð(
SZ_1M
 + 
£ùÜsize
)) {

604 
	`‹¡_msg
("Cachä“ s·û i nÙ 1Mb + %u\n", 
£ùÜsize
);

605  -
EINVAL
;

608 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
,

609 0, 
SZ_1M
, 0,

610 &
max_ex‹Á_size
);

611 ià(
off£t
 !ð(
SZ_128M
 - 
SZ_256K
)) {

612 
	`‹¡_msg
("Failedo‡llocate 1Mb from space cache,„eturned offset is: %llu\n",

613 
off£t
);

614  -
EINVAL
;

621 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 1, 1);

622 ià(
»t
)

623  
»t
;

625 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ð
£ùÜsize
) {

626 
	`‹¡_msg
("Cachä“ s·û i nÙ %u\n", 
£ùÜsize
);

627  -
EINVAL
;

630 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
,

631 0, 
£ùÜsize
, 0,

632 &
max_ex‹Á_size
);

633 ià(
off£t
 !ð(
SZ_128M
 + 
SZ_16M
)) {

634 
	`‹¡_msg
("Failedo‡llocate %u,„eturned offset : %llu\n",

635 
£ùÜsize
, 
off£t
);

636  -
EINVAL
;

639 
»t
 = 
	`check_ÿche_em±y
(
ÿche
);

640 ià(
»t
)

641  
»t
;

643 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

654 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 
SZ_128M
 + 
SZ_128K
, SZ_128K, 0);

655 ià(
»t
) {

656 
	`‹¡_msg
("Couldn'ˆaddƒx‹ÁƒÁry %d\n", 
»t
);

657  
»t
;

661 
»t
 = 
	`‹¡_add_ä“_¥aû_’Œy
(
ÿche
, 0, 
SZ_128M
 - 
SZ_512K
, 1);

662 ià(
»t
) {

663 
	`‹¡_msg
("Couldn'ˆadd b™m­ƒÁry %d\n", 
»t
);

664  
»t
;

667 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

668 ià(
»t
)

669  
»t
;

678 
»t
 = 
	`bŒfs_»move_ä“_¥aû
(
ÿche
, 0, 
SZ_128M
 - 768 * 
SZ_1K
);

679 ià(
»t
) {

680 
	`‹¡_msg
("FažedØä“…¬ˆoàb™m­ s·û %d\n", 
»t
);

681  
»t
;

685 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 + 
SZ_128K
, SZ_128K)) {

686 
	`‹¡_msg
("Free space„ange missing\n");

687  -
ENOENT
;

689 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 768 * 
SZ_1K
, 
SZ_256K
)) {

690 
	`‹¡_msg
("Free space„ange missing\n");

691  -
ENOENT
;

698 ià(
	`‹¡_check_exi¡s
(
ÿche
, 0, 
SZ_128M
 - 768 * 
SZ_1K
)) {

699 
	`‹¡_msg
("Bitmap„egion‚ot„emoved from space cache\n");

700  -
EINVAL
;

707 ià(
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K)) {

708 
	`‹¡_msg
("Invalid bitmap„egion marked‡s free\n");

709  -
EINVAL
;

717 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K);

718 ià(
»t
) {

719 
	`‹¡_msg
("E¼Ü‡ddšg f»¥aû: %d\n", 
»t
);

720  
»t
;

723 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 
SZ_512K
, SZ_512K)) {

724 
	`‹¡_msg
("Bitmap„egion‚ot marked‡s free\n");

725  -
ENOENT
;

732 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

733 ià(
»t
)

734  
»t
;

742 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_32M
, 2 * 
£ùÜsize
);

743 ià(
»t
) {

744 
	`‹¡_msg
("E¼Ü‡ddšg f»¥aû: %d\n", 
»t
);

745  
»t
;

753 
»t
 = 
	`bŒfs_add_ä“_¥aû
(
ÿche
, 
SZ_128M
, 
SZ_128K
);

754 ià(
»t
) {

755 
	`‹¡_msg
("E¼Ü‡ddšg f»¥aû: %d\n", 
»t
);

756  
»t
;

759 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
, 
SZ_128K
)) {

760 
	`‹¡_msg
("Extent„egion‚ot marked‡s free\n");

761  -
ENOENT
;

768 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 2, 1);

769 ià(
»t
)

770  
»t
;

787 ià(!
	`‹¡_check_exi¡s
(
ÿche
, 
SZ_128M
 - 768 * 
SZ_1K
, 
SZ_1M
)) {

788 
	`‹¡_msg
("Expected„egion‚ot marked‡s free\n");

789  -
ENOENT
;

792 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ð(
SZ_1M
 + 2 * 
£ùÜsize
)) {

793 
	`‹¡_msg
("Cachä“ s·û i nÙ 1Mb + %u\n", 2 * 
£ùÜsize
);

794  -
EINVAL
;

797 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
, 0, 
SZ_1M
, 0,

798 &
max_ex‹Á_size
);

799 ià(
off£t
 !ð(
SZ_128M
 - 768 * 
SZ_1K
)) {

800 
	`‹¡_msg
("Failedo‡llocate 1Mb from space cache,„eturned offset is: %llu\n",

801 
off£t
);

802  -
EINVAL
;

809 
»t
 = 
	`check_num_ex‹Ás_ªd_b™m­s
(
ÿche
, 1, 1);

810 ià(
»t
)

811  
»t
;

813 ià(
ÿche
->
ä“_¥aû_ùl
->
ä“_¥aû
 !ð2 * 
£ùÜsize
) {

814 
	`‹¡_msg
("Cachä“ s·û i nÙ %u\n", 2 * 
£ùÜsize
);

815  -
EINVAL
;

818 
off£t
 = 
	`bŒfs_fšd_¥aû_fÜ_®loc
(
ÿche
,

819 0, 2 * 
£ùÜsize
, 0,

820 &
max_ex‹Á_size
);

821 ià(
off£t
 !ð
SZ_32M
) {

822 
	`‹¡_msg
("Failedo‡llocate %u, offset: %llu\n",

823 2 * 
£ùÜsize
,

824 
off£t
);

825  -
EINVAL
;

828 
»t
 = 
	`check_ÿche_em±y
(
ÿche
);

829 ià(
»t
)

830  
»t
;

832 
ÿche
->
ä“_¥aû_ùl
->
Ý
 = 
Üig_ä“_¥aû_Ýs
;

833 
	`__bŒfs_»move_ä“_¥aû_ÿche
(
ÿche
->
ä“_¥aû_ùl
);

836 
	}
}

838 
	$bŒfs_‹¡_ä“_¥aû_ÿche
(
u32
 
£ùÜsize
, u32 
nodesize
)

840 
bŒfs_fs_šfo
 *
fs_šfo
;

841 
bŒfs_block_group_ÿche
 *
ÿche
;

842 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

843 
»t
 = -
ENOMEM
;

845 
	`‹¡_msg
("Running btrfs free space cacheests\n");

846 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

847 ià(!
fs_šfo
)

848  -
ENOMEM
;

856 
ÿche
 = 
	`bŒfs_®loc_dummy_block_group
(
fs_šfo
,

857 
BITS_PER_BITMAP
 * 
£ùÜsize
 + 
PAGE_SIZE
);

858 ià(!
ÿche
) {

859 
	`‹¡_msg
("Couldn't„unheests\n");

860 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

864 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

865 ià(
	`IS_ERR
(
roÙ
)) {

866 
»t
 = 
	`PTR_ERR
(
roÙ
);

867 
out
;

870 
roÙ
->
fs_šfo
->
ex‹Á_roÙ
 =„oot;

872 
»t
 = 
	`‹¡_ex‹Ás
(
ÿche
);

873 ià(
»t
)

874 
out
;

875 
»t
 = 
	`‹¡_b™m­s
(
ÿche
, 
£ùÜsize
);

876 ià(
»t
)

877 
out
;

878 
»t
 = 
	`‹¡_b™m­s_ªd_ex‹Ás
(
ÿche
, 
£ùÜsize
);

879 ià(
»t
)

880 
out
;

882 
»t
 = 
	`‹¡_¡—l_¥aû_äom_b™m­_to_ex‹Á
(
ÿche
, 
£ùÜsize
);

883 
out
:

884 
	`bŒfs_ä“_dummy_block_group
(
ÿche
);

885 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

886 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

887 
	`‹¡_msg
("Free space cacheests finished\n");

888  
»t
;

889 
	}
}

	@tests/free-space-tree-tests.c

19 
	~<lšux/ty³s.h
>

20 
	~"bŒfs-‹¡s.h
"

21 
	~"../ù»e.h
"

22 
	~"../disk-io.h
"

23 
	~"../ä“-¥aû-Œ“.h
"

24 
	~"../Œª§ùiÚ.h
"

26 
	sä“_¥aû_ex‹Á
 {

27 
u64
 
	m¡¬t
;

28 
u64
 
	mËngth
;

31 
	$__check_ä“_¥aû_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

32 
bŒfs_fs_šfo
 *
fs_šfo
,

33 
bŒfs_block_group_ÿche
 *
ÿche
,

34 
bŒfs_·th
 *
·th
,

35 cÚ¡ 
ä“_¥aû_ex‹Á
 * cÚ¡ 
ex‹Ás
,

36 
num_ex‹Ás
)

38 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

39 
bŒfs_key
 
key
;

40 
´ev_b™
 = 0, 
b™
;

41 
u64
 
ex‹Á_¡¬t
 = 0, 
off£t
, 
’d
;

42 
u32
 
æags
, 
ex‹Á_couÁ
;

43 
i
;

44 
»t
;

46 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
, 0);

47 ià(
	`IS_ERR
(
šfo
)) {

48 
	`‹¡_msg
("Could‚ot find free space info\n");

49 
»t
 = 
	`PTR_ERR
(
šfo
);

50 
out
;

52 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

53 
ex‹Á_couÁ
 = 
	`bŒfs_ä“_¥aû_ex‹Á_couÁ
(
·th
->
nodes
[0], 
šfo
);

55 ià(
ex‹Á_couÁ
 !ð
num_ex‹Ás
) {

56 
	`‹¡_msg
("Extent count is wrong\n");

57 
»t
 = -
EINVAL
;

58 
out
;

60 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

61 ià(
·th
->
¦Ùs
[0] != 0)

62 
šv®id
;

63 
’d
 = 
ÿche
->
key
.
objeùid
 + cache->key.
off£t
;

64 
i
 = 0;

65 ++
·th
->
¦Ùs
[0] < 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[0])) {

66 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

67 ià(
key
.
ty³
 !ð
BTRFS_FREE_SPACE_BITMAP_KEY
)

68 
šv®id
;

69 
off£t
 = 
key
.
objeùid
;

70 
off£t
 < 
key
.
objeùid
 + key.offset) {

71 
b™
 = 
	`ä“_¥aû_‹¡_b™
(
ÿche
, 
·th
, 
off£t
);

72 ià(
´ev_b™
 =ð0 && 
b™
 == 1) {

73 
ex‹Á_¡¬t
 = 
off£t
;

74 } ià(
´ev_b™
 =ð1 && 
b™
 == 0) {

75 ià(
i
 >ð
num_ex‹Ás
)

76 
šv®id
;

77 ià(
i
 >ð
num_ex‹Ás
 ||

78 
ex‹Á_¡¬t
 !ð
ex‹Ás
[
i
].
¡¬t
 ||

79 
off£t
 - 
ex‹Á_¡¬t
 !ð
ex‹Ás
[
i
].
Ëngth
)

80 
šv®id
;

81 
i
++;

83 
´ev_b™
 = 
b™
;

84 
off£t
 +ð
fs_šfo
->
£ùÜsize
;

87 ià(
´ev_b™
 == 1) {

88 ià(
i
 >ð
num_ex‹Ás
 ||

89 
ex‹Á_¡¬t
 !ð
ex‹Ás
[
i
].
¡¬t
 ||

90 
’d
 - 
ex‹Á_¡¬t
 !ð
ex‹Ás
[
i
].
Ëngth
)

91 
šv®id
;

92 
i
++;

94 ià(
i
 !ð
num_ex‹Ás
)

95 
šv®id
;

97 ià(
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]è!ð
num_ex‹Ás
 + 1 ||

98 
·th
->
¦Ùs
[0] != 0)

99 
šv®id
;

100 
i
 = 0; i < 
num_ex‹Ás
; i++) {

101 
·th
->
¦Ùs
[0]++;

102 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

103 ià(
key
.
ty³
 !ð
BTRFS_FREE_SPACE_EXTENT_KEY
 ||

104 
key
.
objeùid
 !ð
ex‹Ás
[
i
].
¡¬t
 ||

105 
key
.
off£t
 !ð
ex‹Ás
[
i
].
Ëngth
)

106 
šv®id
;

110 
»t
 = 0;

111 
out
:

112 
	`bŒfs_»Ëa£_·th
(
·th
);

113  
»t
;

114 
šv®id
:

115 
	`‹¡_msg
("Free spaceree is invalid\n");

116 
»t
 = -
EINVAL
;

117 
out
;

118 
	}
}

120 
	$check_ä“_¥aû_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

121 
bŒfs_fs_šfo
 *
fs_šfo
,

122 
bŒfs_block_group_ÿche
 *
ÿche
,

123 
bŒfs_·th
 *
·th
,

124 cÚ¡ 
ä“_¥aû_ex‹Á
 * cÚ¡ 
ex‹Ás
,

125 
num_ex‹Ás
)

127 
bŒfs_ä“_¥aû_šfo
 *
šfo
;

128 
u32
 
æags
;

129 
»t
;

131 
šfo
 = 
	`£¬ch_ä“_¥aû_šfo
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
, 0);

132 ià(
	`IS_ERR
(
šfo
)) {

133 
	`‹¡_msg
("Could‚ot find free space info\n");

134 
	`bŒfs_»Ëa£_·th
(
·th
);

135  
	`PTR_ERR
(
šfo
);

137 
æags
 = 
	`bŒfs_ä“_¥aû_æags
(
·th
->
nodes
[0], 
šfo
);

138 
	`bŒfs_»Ëa£_·th
(
·th
);

140 
»t
 = 
	`__check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
, 
ex‹Ás
,

141 
num_ex‹Ás
);

142 ià(
»t
)

143  
»t
;

146 ià(
æags
 & 
BTRFS_FREE_SPACE_USING_BITMAPS
) {

147 
»t
 = 
	`cÚv”t_ä“_¥aû_to_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
);

148 ià(
»t
) {

149 
	`‹¡_msg
("Could‚ot convertoƒxtents\n");

150  
»t
;

153 
»t
 = 
	`cÚv”t_ä“_¥aû_to_b™m­s
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
);

154 ià(
»t
) {

155 
	`‹¡_msg
("Could‚ot converto bitmaps\n");

156  
»t
;

159  
	`__check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
, 
ex‹Ás
,

160 
num_ex‹Ás
);

161 
	}
}

163 
	$‹¡_em±y_block_group
(
bŒfs_Œªs_hªdË
 *
Œªs
,

164 
bŒfs_fs_šfo
 *
fs_šfo
,

165 
bŒfs_block_group_ÿche
 *
ÿche
,

166 
bŒfs_·th
 *
·th
,

167 
u32
 
®ignm’t
)

169 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

170 {
ÿche
->
key
.
objeùid
, cache->key.
off£t
},

173  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

174 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

175 
	}
}

177 
	$‹¡_»move_®l
(
bŒfs_Œªs_hªdË
 *
Œªs
,

178 
bŒfs_fs_šfo
 *
fs_šfo
,

179 
bŒfs_block_group_ÿche
 *
ÿche
,

180 
bŒfs_·th
 *
·th
,

181 
u32
 
®ignm’t
)

183 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {};

184 
»t
;

186 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

187 
ÿche
->
key
.
objeùid
,

188 
ÿche
->
key
.
off£t
);

189 ià(
»t
) {

190 
	`‹¡_msg
("Could‚ot„emove free space\n");

191  
»t
;

194  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

195 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

196 
	}
}

198 
	$‹¡_»move_begšnšg
(
bŒfs_Œªs_hªdË
 *
Œªs
,

199 
bŒfs_fs_šfo
 *
fs_šfo
,

200 
bŒfs_block_group_ÿche
 *
ÿche
,

201 
bŒfs_·th
 *
·th
,

202 
u32
 
®ignm’t
)

204 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

205 {
ÿche
->
key
.
objeùid
 + 
®ignm’t
,

206 
ÿche
->
key
.
off£t
 - 
®ignm’t
},

208 
»t
;

210 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

211 
ÿche
->
key
.
objeùid
, 
®ignm’t
);

212 ià(
»t
) {

213 
	`‹¡_msg
("Could‚ot„emove free space\n");

214  
»t
;

217  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

218 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

220 
	}
}

222 
	$‹¡_»move_’d
(
bŒfs_Œªs_hªdË
 *
Œªs
,

223 
bŒfs_fs_šfo
 *
fs_šfo
,

224 
bŒfs_block_group_ÿche
 *
ÿche
,

225 
bŒfs_·th
 *
·th
,

226 
u32
 
®ignm’t
)

228 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

229 {
ÿche
->
key
.
objeùid
, cache->key.
off£t
 - 
®ignm’t
},

231 
»t
;

233 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

234 
ÿche
->
key
.
objeùid
 +

235 
ÿche
->
key
.
off£t
 - 
®ignm’t
,

236 
®ignm’t
);

237 ià(
»t
) {

238 
	`‹¡_msg
("Could‚ot„emove free space\n");

239  
»t
;

242  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

243 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

244 
	}
}

246 
	$‹¡_»move_middË
(
bŒfs_Œªs_hªdË
 *
Œªs
,

247 
bŒfs_fs_šfo
 *
fs_šfo
,

248 
bŒfs_block_group_ÿche
 *
ÿche
,

249 
bŒfs_·th
 *
·th
,

250 
u32
 
®ignm’t
)

252 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

253 {
ÿche
->
key
.
objeùid
, 
®ignm’t
},

254 {
ÿche
->
key
.
objeùid
 + 2 * 
®ignm’t
,

255 
ÿche
->
key
.
off£t
 - 2 * 
®ignm’t
},

257 
»t
;

259 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

260 
ÿche
->
key
.
objeùid
 + 
®ignm’t
,

261 
®ignm’t
);

262 ià(
»t
) {

263 
	`‹¡_msg
("Could‚ot„emove free space\n");

264  
»t
;

267  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

268 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

269 
	}
}

271 
	$‹¡_m”ge_Ëá
(
bŒfs_Œªs_hªdË
 *
Œªs
,

272 
bŒfs_fs_šfo
 *
fs_šfo
,

273 
bŒfs_block_group_ÿche
 *
ÿche
,

274 
bŒfs_·th
 *
·th
,

275 
u32
 
®ignm’t
)

277 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

278 {
ÿche
->
key
.
objeùid
, 2 * 
®ignm’t
},

280 
»t
;

282 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

283 
ÿche
->
key
.
objeùid
,

284 
ÿche
->
key
.
off£t
);

285 ià(
»t
) {

286 
	`‹¡_msg
("Could‚ot„emove free space\n");

287  
»t
;

290 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

291 
ÿche
->
key
.
objeùid
, 
®ignm’t
);

292 ià(
»t
) {

293 
	`‹¡_msg
("Could‚ot‡dd free space\n");

294  
»t
;

297 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

298 
ÿche
->
key
.
objeùid
 + 
®ignm’t
,

299 
®ignm’t
);

300 ià(
»t
) {

301 
	`‹¡_msg
("Could‚ot‡dd free space\n");

302  
»t
;

305  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

306 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

307 
	}
}

309 
	$‹¡_m”ge_right
(
bŒfs_Œªs_hªdË
 *
Œªs
,

310 
bŒfs_fs_šfo
 *
fs_šfo
,

311 
bŒfs_block_group_ÿche
 *
ÿche
,

312 
bŒfs_·th
 *
·th
,

313 
u32
 
®ignm’t
)

315 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

316 {
ÿche
->
key
.
objeùid
 + 
®ignm’t
, 2 *‡lignment},

318 
»t
;

320 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

321 
ÿche
->
key
.
objeùid
,

322 
ÿche
->
key
.
off£t
);

323 ià(
»t
) {

324 
	`‹¡_msg
("Could‚ot„emove free space\n");

325  
»t
;

328 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

329 
ÿche
->
key
.
objeùid
 + 2 * 
®ignm’t
,

330 
®ignm’t
);

331 ià(
»t
) {

332 
	`‹¡_msg
("Could‚ot‡dd free space\n");

333  
»t
;

336 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

337 
ÿche
->
key
.
objeùid
 + 
®ignm’t
,

338 
®ignm’t
);

339 ià(
»t
) {

340 
	`‹¡_msg
("Could‚ot‡dd free space\n");

341  
»t
;

344  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

345 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

346 
	}
}

348 
	$‹¡_m”ge_bÙh
(
bŒfs_Œªs_hªdË
 *
Œªs
,

349 
bŒfs_fs_šfo
 *
fs_šfo
,

350 
bŒfs_block_group_ÿche
 *
ÿche
,

351 
bŒfs_·th
 *
·th
,

352 
u32
 
®ignm’t
)

354 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

355 {
ÿche
->
key
.
objeùid
, 3 * 
®ignm’t
},

357 
»t
;

359 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

360 
ÿche
->
key
.
objeùid
,

361 
ÿche
->
key
.
off£t
);

362 ià(
»t
) {

363 
	`‹¡_msg
("Could‚ot„emove free space\n");

364  
»t
;

367 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

368 
ÿche
->
key
.
objeùid
, 
®ignm’t
);

369 ià(
»t
) {

370 
	`‹¡_msg
("Could‚ot‡dd free space\n");

371  
»t
;

374 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

375 
ÿche
->
key
.
objeùid
 + 2 * 
®ignm’t
,

376 
®ignm’t
);

377 ià(
»t
) {

378 
	`‹¡_msg
("Could‚ot‡dd free space\n");

379  
»t
;

382 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

383 
ÿche
->
key
.
objeùid
 + 
®ignm’t
,

384 
®ignm’t
);

385 ià(
»t
) {

386 
	`‹¡_msg
("Could‚ot‡dd free space\n");

387  
»t
;

390  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

391 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

392 
	}
}

394 
	$‹¡_m”ge_nÚe
(
bŒfs_Œªs_hªdË
 *
Œªs
,

395 
bŒfs_fs_šfo
 *
fs_šfo
,

396 
bŒfs_block_group_ÿche
 *
ÿche
,

397 
bŒfs_·th
 *
·th
,

398 
u32
 
®ignm’t
)

400 cÚ¡ 
ä“_¥aû_ex‹Á
 
ex‹Ás
[] = {

401 {
ÿche
->
key
.
objeùid
, 
®ignm’t
},

402 {
ÿche
->
key
.
objeùid
 + 2 * 
®ignm’t
,‡lignment},

403 {
ÿche
->
key
.
objeùid
 + 4 * 
®ignm’t
,‡lignment},

405 
»t
;

407 
»t
 = 
	`__»move_äom_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

408 
ÿche
->
key
.
objeùid
,

409 
ÿche
->
key
.
off£t
);

410 ià(
»t
) {

411 
	`‹¡_msg
("Could‚ot„emove free space\n");

412  
»t
;

415 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

416 
ÿche
->
key
.
objeùid
, 
®ignm’t
);

417 ià(
»t
) {

418 
	`‹¡_msg
("Could‚ot‡dd free space\n");

419  
»t
;

422 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

423 
ÿche
->
key
.
objeùid
 + 4 * 
®ignm’t
,

424 
®ignm’t
);

425 ià(
»t
) {

426 
	`‹¡_msg
("Could‚ot‡dd free space\n");

427  
»t
;

430 
»t
 = 
	`__add_to_ä“_¥aû_Œ“
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

431 
ÿche
->
key
.
objeùid
 + 2 * 
®ignm’t
,

432 
®ignm’t
);

433 ià(
»t
) {

434 
	`‹¡_msg
("Could‚ot‡dd free space\n");

435  
»t
;

438  
	`check_ä“_¥aû_ex‹Ás
(
Œªs
, 
fs_šfo
, 
ÿche
, 
·th
,

439 
ex‹Ás
, 
	`ARRAY_SIZE
(extents));

440 
	}
}

442 (*
	t‹¡_func_t
)(
	tbŒfs_Œªs_hªdË
 *,

443 
	tbŒfs_fs_šfo
 *,

444 
	tbŒfs_block_group_ÿche
 *,

445 
	tbŒfs_·th
 *,

446 
	tu32
 
	t®ignm’t
);

448 
	$run_‹¡
(
‹¡_func_t
 
‹¡_func
, 
b™m­s
, 
u32
 
£ùÜsize
,

449 
u32
 
nodesize
, u32 
®ignm’t
)

451 
bŒfs_fs_šfo
 *
fs_šfo
;

452 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

453 
bŒfs_block_group_ÿche
 *
ÿche
 = 
NULL
;

454 
bŒfs_Œªs_hªdË
 
Œªs
;

455 
bŒfs_·th
 *
·th
 = 
NULL
;

456 
»t
;

458 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

459 ià(!
fs_šfo
) {

460 
	`‹¡_msg
("Couldn't‡llocate dummy fs info\n");

461 
»t
 = -
ENOMEM
;

462 
out
;

465 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

466 ià(
	`IS_ERR
(
roÙ
)) {

467 
	`‹¡_msg
("Couldn't‡llocate dummy„oot\n");

468 
»t
 = 
	`PTR_ERR
(
roÙ
);

469 
out
;

472 
	`bŒfs_£t_su³r_com·t_ro_æags
(
roÙ
->
fs_šfo
->
su³r_cÝy
,

473 
BTRFS_FEATURE_COMPAT_RO_FREE_SPACE_TREE
);

474 
roÙ
->
fs_šfo
->
ä“_¥aû_roÙ
 =„oot;

475 
roÙ
->
fs_šfo
->
Œ“_roÙ
 =„oot;

477 
roÙ
->
node
 = 
	`®loc_‹¡_ex‹Á_bufãr
ÔoÙ->
fs_šfo
, 
nodesize
);

478 ià(!
roÙ
->
node
) {

479 
	`‹¡_msg
("Couldn't‡llocate dummy buffer\n");

480 
»t
 = -
ENOMEM
;

481 
out
;

483 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

484 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

485 
roÙ
->
®loc_by‹Ä
 +ð2 * 
nodesize
;

487 
ÿche
 = 
	`bŒfs_®loc_dummy_block_group
(
fs_šfo
, 8 * 
®ignm’t
);

488 ià(!
ÿche
) {

489 
	`‹¡_msg
("Couldn't‡llocate dummy block group cache\n");

490 
»t
 = -
ENOMEM
;

491 
out
;

493 
ÿche
->
b™m­_low_th»sh
 = 0;

494 
ÿche
->
b™m­_high_th»sh
 = (
u32
)-1;

495 
ÿche
->
Ãeds_ä“_¥aû
 = 1;

496 
ÿche
->
fs_šfo
 = 
roÙ
->fs_info;

498 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

500 
·th
 = 
	`bŒfs_®loc_·th
();

501 ià(!
·th
) {

502 
	`‹¡_msg
("Couldn't‡llocate…ath\n");

503  -
ENOMEM
;

506 
»t
 = 
	`add_block_group_ä“_¥aû
(&
Œªs
, 
roÙ
->
fs_šfo
, 
ÿche
);

507 ià(
»t
) {

508 
	`‹¡_msg
("Could‚ot‡dd block group free space\n");

509 
out
;

512 ià(
b™m­s
) {

513 
»t
 = 
	`cÚv”t_ä“_¥aû_to_b™m­s
(&
Œªs
, 
roÙ
->
fs_šfo
,

514 
ÿche
, 
·th
);

515 ià(
»t
) {

516 
	`‹¡_msg
("Could‚ot convert block groupo bitmaps\n");

517 
out
;

521 
»t
 = 
	`‹¡_func
(&
Œªs
, 
roÙ
->
fs_šfo
, 
ÿche
, 
·th
, 
®ignm’t
);

522 ià(
»t
)

523 
out
;

525 
»t
 = 
	`»move_block_group_ä“_¥aû
(&
Œªs
, 
roÙ
->
fs_šfo
, 
ÿche
);

526 ià(
»t
) {

527 
	`‹¡_msg
("Could‚ot„emove block group free space\n");

528 
out
;

531 ià(
	`bŒfs_h—d”_Ä™ems
(
roÙ
->
node
) != 0) {

532 
	`‹¡_msg
("Free spaceree has†eftover items\n");

533 
»t
 = -
EINVAL
;

534 
out
;

537 
»t
 = 0;

538 
out
:

539 
	`bŒfs_ä“_·th
(
·th
);

540 
	`bŒfs_ä“_dummy_block_group
(
ÿche
);

541 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

542 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

543  
»t
;

544 
	}
}

546 
	$run_‹¡_bÙh_fÜm©s
(
‹¡_func_t
 
‹¡_func
, 
u32
 
£ùÜsize
,

547 
u32
 
nodesize
, u32 
®ignm’t
)

549 
‹¡_»t
 = 0;

550 
»t
;

552 
»t
 = 
	`run_‹¡
(
‹¡_func
, 0, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

553 ià(
»t
) {

554 
	`‹¡_msg
("%pf failed withƒxtents, sectorsize=%u,‚odesize=%u,‡lignment=%u\n",

555 
‹¡_func
, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

556 
‹¡_»t
 = 
»t
;

559 
»t
 = 
	`run_‹¡
(
‹¡_func
, 1, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

560 ià(
»t
) {

561 
	`‹¡_msg
("%pf failed with bitmaps, sectorsize=%u,‚odesize=%u,‡lignment=%u\n",

562 
‹¡_func
, 
£ùÜsize
, 
nodesize
, 
®ignm’t
);

563 
‹¡_»t
 = 
»t
;

566  
‹¡_»t
;

567 
	}
}

569 
	$bŒfs_‹¡_ä“_¥aû_Œ“
(
u32
 
£ùÜsize
, u32 
nodesize
)

571 
‹¡_func_t
 
‹¡s
[] = {

572 
‹¡_em±y_block_group
,

573 
‹¡_»move_®l
,

574 
‹¡_»move_begšnšg
,

575 
‹¡_»move_’d
,

576 
‹¡_»move_middË
,

577 
‹¡_m”ge_Ëá
,

578 
‹¡_m”ge_right
,

579 
‹¡_m”ge_bÙh
,

580 
‹¡_m”ge_nÚe
,

582 
u32
 
b™m­_®ignm’t
;

583 
‹¡_»t
 = 0;

584 
i
;

590 
b™m­_®ignm’t
 = 
BTRFS_FREE_SPACE_BITMAP_BITS
 * 
PAGE_SIZE
;

592 
	`‹¡_msg
("Running free spacereeests\n");

593 
i
 = 0; i < 
	`ARRAY_SIZE
(
‹¡s
); i++) {

594 
»t
;

596 
»t
 = 
	`run_‹¡_bÙh_fÜm©s
(
‹¡s
[
i
], 
£ùÜsize
, 
nodesize
,

597 
£ùÜsize
);

598 ià(
»t
)

599 
‹¡_»t
 = 
»t
;

601 
»t
 = 
	`run_‹¡_bÙh_fÜm©s
(
‹¡s
[
i
], 
£ùÜsize
, 
nodesize
,

602 
b™m­_®ignm’t
);

603 ià(
»t
)

604 
‹¡_»t
 = 
»t
;

607  
‹¡_»t
;

608 
	}
}

	@tests/inode-tests.c

19 
	~<lšux/ty³s.h
>

20 
	~"bŒfs-‹¡s.h
"

21 
	~"../ù»e.h
"

22 
	~"../bŒfs_šode.h
"

23 
	~"../disk-io.h
"

24 
	~"../ex‹Á_io.h
"

25 
	~"../vÞumes.h
"

26 
	~"../com´essiÚ.h
"

28 
	$š£¹_ex‹Á
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
¡¬t
, u64 
Ën
,

29 
u64
 
¿m_by‹s
, u64 
off£t
, u64 
disk_by‹Ä
,

30 
u64
 
disk_Ën
, 
u32
 
ty³
, 
u8
 
com´essiÚ
, 
¦Ù
)

32 
bŒfs_·th
 
·th
;

33 
bŒfs_fže_ex‹Á_™em
 *
fi
;

34 
ex‹Á_bufãr
 *
Ëaf
 = 
roÙ
->
node
;

35 
bŒfs_key
 
key
;

36 
u32
 
v®ue_Ën
 = (
bŒfs_fže_ex‹Á_™em
);

38 ià(
ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
)

39 
v®ue_Ën
 +ð
Ën
;

40 
	`mem£t
(&
·th
, 0, (path));

42 
·th
.
nodes
[0] = 
Ëaf
;

43 
·th
.
¦Ùs
[0] = 
¦Ù
;

45 
key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

46 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

47 
key
.
off£t
 = 
¡¬t
;

49 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, &
·th
, &
key
, &
v®ue_Ën
, value_len,

50 
v®ue_Ën
 + (
bŒfs_™em
), 1);

51 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

52 
	`bŒfs_£t_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 1);

53 
	`bŒfs_£t_fže_ex‹Á_ty³
(
Ëaf
, 
fi
, 
ty³
);

54 
	`bŒfs_£t_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
, 
disk_by‹Ä
);

55 
	`bŒfs_£t_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
, 
disk_Ën
);

56 
	`bŒfs_£t_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 
off£t
);

57 
	`bŒfs_£t_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
Ën
);

58 
	`bŒfs_£t_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
¿m_by‹s
);

59 
	`bŒfs_£t_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
, 
com´essiÚ
);

60 
	`bŒfs_£t_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
, 0);

61 
	`bŒfs_£t_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
, 0);

62 
	}
}

64 
	$š£¹_šode_™em_key
(
bŒfs_roÙ
 *
roÙ
)

66 
bŒfs_·th
 
·th
;

67 
ex‹Á_bufãr
 *
Ëaf
 = 
roÙ
->
node
;

68 
bŒfs_key
 
key
;

69 
u32
 
v®ue_Ën
 = 0;

71 
	`mem£t
(&
·th
, 0, (path));

73 
·th
.
nodes
[0] = 
Ëaf
;

74 
·th
.
¦Ùs
[0] = 0;

76 
key
.
objeùid
 = 
BTRFS_INODE_ITEM_KEY
;

77 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

78 
key
.
off£t
 = 0;

80 
	`£tup_™ems_fÜ_š£¹
(
roÙ
, &
·th
, &
key
, &
v®ue_Ën
, value_len,

81 
v®ue_Ën
 + (
bŒfs_™em
), 1);

82 
	}
}

102 
	$£tup_fže_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, 
u32
 
£ùÜsize
)

104 
¦Ù
 = 0;

105 
u64
 
disk_by‹Ä
 = 
SZ_1M
;

106 
u64
 
off£t
 = 0;

109 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 5, 5, 0, 0, 0, 
BTRFS_FILE_EXTENT_REG
, 0,

110 
¦Ù
);

111 
¦Ù
++;

112 
off£t
 += 5;

120 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 1, 1, 0, 0, 0, 
BTRFS_FILE_EXTENT_INLINE
, 0,

121 
¦Ù
);

122 
¦Ù
++;

123 
off£t
 = 
£ùÜsize
;

126 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 4, 4, 0, 0, 0, 
BTRFS_FILE_EXTENT_REG
, 0,

127 
¦Ù
);

128 
¦Ù
++;

129 
off£t
 += 4;

132 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
 - 1, sectorsize - 1, 0,

133 
disk_by‹Ä
, 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

134 
¦Ù
++;

135 
disk_by‹Ä
 +ð
£ùÜsize
;

136 
off£t
 +ð
£ùÜsize
 - 1;

142 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * seùÜsize, 0, 
disk_by‹Ä
,

143 4 * 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

144 
¦Ù
++;

145 
off£t
 +ð
£ùÜsize
;

146 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, sectorsize, 0, 0, 0,

147 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

148 
¦Ù
++;

149 
off£t
 +ð
£ùÜsize
;

150 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 4 * sectorsize,

151 2 * 
£ùÜsize
, 
disk_by‹Ä
, 4 * sectorsize,

152 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

153 
¦Ù
++;

154 
off£t
 +ð2 * 
£ùÜsize
;

155 
disk_by‹Ä
 +ð4 * 
£ùÜsize
;

158 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, seùÜsize, 0, 
disk_by‹Ä
,

159 
£ùÜsize
, 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¦Ù
);

160 
¦Ù
++;

161 
off£t
 +ð
£ùÜsize
;

167 
disk_by‹Ä
 +ð2 * 
£ùÜsize
;

174 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * seùÜsize, 0, 
disk_by‹Ä
,

175 4 * 
£ùÜsize
, 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¦Ù
);

176 
¦Ù
++;

177 
off£t
 +ð
£ùÜsize
;

178 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * sectorsize, sectorsize,

179 
disk_by‹Ä
, 4 * 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0,

180 
¦Ù
);

181 
¦Ù
++;

182 
off£t
 +ð
£ùÜsize
;

183 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 4 * sectorsize,

184 2 * 
£ùÜsize
, 
disk_by‹Ä
, 4 * sectorsize,

185 
BTRFS_FILE_EXTENT_PREALLOC
, 0, 
¦Ù
);

186 
¦Ù
++;

187 
off£t
 +ð2 * 
£ùÜsize
;

188 
disk_by‹Ä
 +ð4 * 
£ùÜsize
;

191 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 2 * sectorsize, 0,

192 
disk_by‹Ä
, 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
,

193 
BTRFS_COMPRESS_ZLIB
, 
¦Ù
);

194 
¦Ù
++;

195 
off£t
 +ð2 * 
£ùÜsize
;

197 
disk_by‹Ä
 +ð2 * 
£ùÜsize
;

200 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, 4 * seùÜsize, 0, 
disk_by‹Ä
,

201 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
,

202 
BTRFS_COMPRESS_ZLIB
, 
¦Ù
);

203 
¦Ù
++;

204 
off£t
 +ð
£ùÜsize
;

205 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, sectorsize, 0,

206 
disk_by‹Ä
 + 
£ùÜsize
, sectorsize,

207 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

208 
¦Ù
++;

209 
off£t
 +ð
£ùÜsize
;

210 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 2 * 
£ùÜsize
, 4 * sectorsize,

211 2 * 
£ùÜsize
, 
disk_by‹Ä
, sectorsize,

212 
BTRFS_FILE_EXTENT_REG
, 
BTRFS_COMPRESS_ZLIB
, 
¦Ù
);

213 
¦Ù
++;

214 
off£t
 +ð2 * 
£ùÜsize
;

215 
disk_by‹Ä
 +ð2 * 
£ùÜsize
;

218 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, seùÜsize, 0, 
disk_by‹Ä
,

219 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

220 
¦Ù
++;

221 
off£t
 +ð4 * 
£ùÜsize
;

222 
disk_by‹Ä
 +ð
£ùÜsize
;

223 
	`š£¹_ex‹Á
(
roÙ
, 
off£t
, 
£ùÜsize
, seùÜsize, 0, 
disk_by‹Ä
,

224 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 
¦Ù
);

225 
	}
}

227 
	g´—Îoc_Úly
 = 0;

228 
	gcom´es£d_Úly
 = 0;

229 
	gvaÿncy_Úly
 = 0;

231 
nošlše
 
	$‹¡_bŒfs_g‘_ex‹Á
(
u32
 
£ùÜsize
, u32 
nodesize
)

233 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

234 
šode
 *šodð
NULL
;

235 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

236 
ex‹Á_m­
 *
em
 = 
NULL
;

237 
u64
 
Üig_¡¬t
;

238 
u64
 
disk_by‹Ä
;

239 
u64
 
off£t
;

240 
»t
 = -
ENOMEM
;

242 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

243 ià(!
šode
) {

244 
	`‹¡_msg
("Couldn't‡llocate inode\n");

245  
»t
;

248 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

249 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

250 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
off£t
 = 0;

252 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

253 ià(!
fs_šfo
) {

254 
	`‹¡_msg
("Couldn't‡llocate dummy fs info\n");

255 
out
;

258 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

259 ià(
	`IS_ERR
(
roÙ
)) {

260 
	`‹¡_msg
("Couldn't‡llocate„oot\n");

261 
out
;

264 
roÙ
->
node
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
nodesize
);

265 ià(!
roÙ
->
node
) {

266 
	`‹¡_msg
("Couldn't‡llocate dummy buffer\n");

267 
out
;

274 
	`ex‹Á_bufãr_g‘
(
roÙ
->
node
);

275 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

276 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

277 
»t
 = -
EINVAL
;

280 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

281 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 0, 
£ùÜsize
, 0);

282 ià(
	`IS_ERR
(
em
)) {

283 
em
 = 
NULL
;

284 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

285 
out
;

287 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

288 
	`‹¡_msg
("Ex³ùed‡ hÞe, gÙ %Îu\n", 
em
->
block_¡¬t
);

289 
out
;

291 ià(!
	`‹¡_b™
(
EXTENT_FLAG_VACANCY
, &
em
->
æags
)) {

292 
	`‹¡_msg
("Vacancy flag wasn't set…roperly\n");

293 
out
;

295 
	`ä“_ex‹Á_m­
(
em
);

296 
	`bŒfs_drÝ_ex‹Á_ÿche
(
	`BTRFS_I
(
šode
), 0, (
u64
)-1, 0);

303 
	`£tup_fže_ex‹Ás
(
roÙ
, 
£ùÜsize
);

305 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 0, (
u64
)-1, 0);

306 ià(
	`IS_ERR
(
em
)) {

307 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

308 
out
;

310 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

311 
	`‹¡_msg
("Ex³ùed‡ hÞe, gÙ %Îu\n", 
em
->
block_¡¬t
);

312 
out
;

314 ià(
em
->
¡¬t
 !ð0 ||ƒm->
Ën
 != 5) {

315 
	`‹¡_msg
("Unexpectedƒxtent wanted start 0†en 5, got start "

316 "%Îu†’ %Îu\n", 
em
->
¡¬t
,ƒm->
Ën
);

317 
out
;

319 ià(
em
->
æags
 != 0) {

320 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

321 
out
;

323 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

324 
	`ä“_ex‹Á_m­
(
em
);

326 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

327 ià(
	`IS_ERR
(
em
)) {

328 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

329 
out
;

331 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_INLINE
) {

332 
	`‹¡_msg
("Ex³ùed‡Àšlše, gÙ %Îu\n", 
em
->
block_¡¬t
);

333 
out
;

336 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð(
£ùÜsize
 - 5)) {

337 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en 1, got start "

338 "%Îu†’ %Îu\n", 
off£t
, 
em
->
¡¬t
,ƒm->
Ën
);

339 
out
;

341 ià(
em
->
æags
 != 0) {

342 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

343 
out
;

350 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

351 
	`ä“_ex‹Á_m­
(
em
);

353 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

354 ià(
	`IS_ERR
(
em
)) {

355 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

356 
out
;

358 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

359 
	`‹¡_msg
("Ex³ùed‡ hÞe, gÙ %Îu\n", 
em
->
block_¡¬t
);

360 
out
;

362 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 != 4) {

363 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en 4, got start "

364 "%Îu†’ %Îu\n", 
off£t
, 
em
->
¡¬t
,ƒm->
Ën
);

365 
out
;

367 ià(
em
->
æags
 != 0) {

368 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

369 
out
;

371 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

372 
	`ä“_ex‹Á_m­
(
em
);

375 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

376 ià(
	`IS_ERR
(
em
)) {

377 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

378 
out
;

380 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

381 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

382 
out
;

384 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
 - 1) {

385 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en 4095, got "

386 "¡¬ˆ%Îu†’ %Îu\n", 
off£t
, 
em
->
¡¬t
,ƒm->
Ën
);

387 
out
;

389 ià(
em
->
æags
 != 0) {

390 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

391 
out
;

393 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

394 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

395 
em
->
Üig_¡¬t
);

396 
out
;

398 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

399 
	`ä“_ex‹Á_m­
(
em
);

402 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

403 ià(
	`IS_ERR
(
em
)) {

404 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

405 
out
;

407 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

408 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

409 
out
;

411 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

412 
	`‹¡_msg
("Unexpectedƒxtent start %llu†en %u, "

414 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

415 
out
;

417 ià(
em
->
æags
 != 0) {

418 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

419 
out
;

421 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

422 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

423 
em
->
Üig_¡¬t
);

424 
out
;

426 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

427 
Üig_¡¬t
 = 
em
->
¡¬t
;

428 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

429 
	`ä“_ex‹Á_m­
(
em
);

431 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

432 ià(
	`IS_ERR
(
em
)) {

433 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

434 
out
;

436 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

437 
	`‹¡_msg
("Ex³ùed‡ hÞe, gÙ %Îu\n", 
em
->
block_¡¬t
);

438 
out
;

440 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

441 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

443 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

444 
out
;

446 ià(
em
->
æags
 != 0) {

447 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

448 
out
;

450 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

451 
	`ä“_ex‹Á_m­
(
em
);

453 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

454 ià(
	`IS_ERR
(
em
)) {

455 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

456 
out
;

458 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

459 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

460 
out
;

462 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð2 * 
£ùÜsize
) {

463 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

465 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

466 
out
;

468 ià(
em
->
æags
 != 0) {

469 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

470 
out
;

472 ià(
em
->
Üig_¡¬t
 != orig_start) {

473 
	`‹¡_msg
("Wrong orig offset, want %llu, have %llu\n",

474 
Üig_¡¬t
, 
em
->orig_start);

475 
out
;

477 
disk_by‹Ä
 +ð(
em
->
¡¬t
 - 
Üig_¡¬t
);

478 ià(
em
->
block_¡¬t
 !ð
disk_by‹Ä
) {

479 
	`‹¡_msg
("Wrong block start, want %llu, have %llu\n",

480 
disk_by‹Ä
, 
em
->
block_¡¬t
);

481 
out
;

483 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

484 
	`ä“_ex‹Á_m­
(
em
);

487 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

488 ià(
	`IS_ERR
(
em
)) {

489 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

490 
out
;

492 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

493 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

494 
out
;

496 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

497 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

499 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

500 
out
;

502 ià(
em
->
æags
 !ð
´—Îoc_Úly
) {

503 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

504 
´—Îoc_Úly
, 
em
->
æags
);

505 
out
;

507 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

508 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

509 
em
->
Üig_¡¬t
);

510 
out
;

512 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

513 
	`ä“_ex‹Á_m­
(
em
);

516 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

517 ià(
	`IS_ERR
(
em
)) {

518 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

519 
out
;

521 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

522 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

523 
out
;

525 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

526 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

528 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

529 
out
;

531 ià(
em
->
æags
 !ð
´—Îoc_Úly
) {

532 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

533 
´—Îoc_Úly
, 
em
->
æags
);

534 
out
;

536 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

537 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

538 
em
->
Üig_¡¬t
);

539 
out
;

541 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

542 
Üig_¡¬t
 = 
em
->
¡¬t
;

543 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

544 
	`ä“_ex‹Á_m­
(
em
);

546 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

547 ià(
	`IS_ERR
(
em
)) {

548 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

549 
out
;

551 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_HOLE
) {

552 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

553 
out
;

555 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

556 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

558 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

559 
out
;

561 ià(
em
->
æags
 != 0) {

562 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

563 
out
;

565 ià(
em
->
Üig_¡¬t
 != orig_start) {

566 
	`‹¡_msg
("Unexpected orig offset, wanted %llu, have %llu\n",

567 
Üig_¡¬t
, 
em
->orig_start);

568 
out
;

570 ià(
em
->
block_¡¬t
 !ð(
disk_by‹Ä
 + (em->
¡¬t
 -ƒm->
Üig_¡¬t
))) {

571 
	`‹¡_msg
("Unexpected block start, wanted %llu, have %llu\n",

572 
disk_by‹Ä
 + (
em
->
¡¬t
 -ƒm->
Üig_¡¬t
),

573 
em
->
block_¡¬t
);

574 
out
;

576 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

577 
	`ä“_ex‹Á_m­
(
em
);

579 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

580 ià(
	`IS_ERR
(
em
)) {

581 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

582 
out
;

584 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

585 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

586 
out
;

588 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð2 * 
£ùÜsize
) {

589 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

591 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

592 
out
;

594 ià(
em
->
æags
 !ð
´—Îoc_Úly
) {

595 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

596 
´—Îoc_Úly
, 
em
->
æags
);

597 
out
;

599 ià(
em
->
Üig_¡¬t
 != orig_start) {

600 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
Üig_¡¬t
,

601 
em
->
Üig_¡¬t
);

602 
out
;

604 ià(
em
->
block_¡¬t
 !ð(
disk_by‹Ä
 + (em->
¡¬t
 -ƒm->
Üig_¡¬t
))) {

605 
	`‹¡_msg
("Unexpected block start, wanted %llu, have %llu\n",

606 
disk_by‹Ä
 + (
em
->
¡¬t
 -ƒm->
Üig_¡¬t
),

607 
em
->
block_¡¬t
);

608 
out
;

610 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

611 
	`ä“_ex‹Á_m­
(
em
);

614 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

615 ià(
	`IS_ERR
(
em
)) {

616 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

617 
out
;

619 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

620 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

621 
out
;

623 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð2 * 
£ùÜsize
) {

624 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u,"

626 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

627 
out
;

629 ià(
em
->
æags
 !ð
com´es£d_Úly
) {

630 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

631 
com´es£d_Úly
, 
em
->
æags
);

632 
out
;

634 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

635 
	`‹¡_msg
("Wrong orig offset, want %llu, have %llu\n",

636 
em
->
¡¬t
,ƒm->
Üig_¡¬t
);

637 
out
;

639 ià(
em
->
com´ess_ty³
 !ð
BTRFS_COMPRESS_ZLIB
) {

640 
	`‹¡_msg
("Unexpected compressype, wanted %d, got %d\n",

641 
BTRFS_COMPRESS_ZLIB
, 
em
->
com´ess_ty³
);

642 
out
;

644 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

645 
	`ä“_ex‹Á_m­
(
em
);

648 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

649 ià(
	`IS_ERR
(
em
)) {

650 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

651 
out
;

653 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

654 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

655 
out
;

657 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

658 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u,"

660 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

661 
out
;

663 ià(
em
->
æags
 !ð
com´es£d_Úly
) {

664 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

665 
com´es£d_Úly
, 
em
->
æags
);

666 
out
;

668 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

669 
	`‹¡_msg
("Wrong orig offset, want %llu, have %llu\n",

670 
em
->
¡¬t
,ƒm->
Üig_¡¬t
);

671 
out
;

673 ià(
em
->
com´ess_ty³
 !ð
BTRFS_COMPRESS_ZLIB
) {

674 
	`‹¡_msg
("Unexpected compressype, wanted %d, got %d\n",

675 
BTRFS_COMPRESS_ZLIB
, 
em
->
com´ess_ty³
);

676 
out
;

678 
disk_by‹Ä
 = 
em
->
block_¡¬t
;

679 
Üig_¡¬t
 = 
em
->
¡¬t
;

680 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

681 
	`ä“_ex‹Á_m­
(
em
);

683 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

684 ià(
	`IS_ERR
(
em
)) {

685 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

686 
out
;

688 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

689 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

690 
out
;

692 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

693 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

695 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

696 
out
;

698 ià(
em
->
æags
 != 0) {

699 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

700 
out
;

702 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

703 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

704 
em
->
Üig_¡¬t
);

705 
out
;

707 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

708 
	`ä“_ex‹Á_m­
(
em
);

710 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

711 ià(
	`IS_ERR
(
em
)) {

712 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

713 
out
;

715 ià(
em
->
block_¡¬t
 !ð
disk_by‹Ä
) {

716 
	`‹¡_msg
("Block start does‚ot match, want %llu got %llu\n",

717 
disk_by‹Ä
, 
em
->
block_¡¬t
);

718 
out
;

720 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð2 * 
£ùÜsize
) {

721 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

723 
off£t
, 2 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

724 
out
;

726 ià(
em
->
æags
 !ð
com´es£d_Úly
) {

727 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

728 
com´es£d_Úly
, 
em
->
æags
);

729 
out
;

731 ià(
em
->
Üig_¡¬t
 != orig_start) {

732 
	`‹¡_msg
("Wrong orig offset, want %llu, have %llu\n",

733 
em
->
¡¬t
, 
Üig_¡¬t
);

734 
out
;

736 ià(
em
->
com´ess_ty³
 !ð
BTRFS_COMPRESS_ZLIB
) {

737 
	`‹¡_msg
("Unexpected compressype, wanted %d, got %d\n",

738 
BTRFS_COMPRESS_ZLIB
, 
em
->
com´ess_ty³
);

739 
out
;

741 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

742 
	`ä“_ex‹Á_m­
(
em
);

745 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
 + 6,

746 
£ùÜsize
, 0);

747 ià(
	`IS_ERR
(
em
)) {

748 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

749 
out
;

751 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

752 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

753 
out
;

755 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

756 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

758 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

759 
out
;

761 ià(
em
->
æags
 != 0) {

762 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

763 
out
;

765 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

766 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

767 
em
->
Üig_¡¬t
);

768 
out
;

770 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

771 
	`ä“_ex‹Á_m­
(
em
);

773 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 4096 * 1024, 0);

774 ià(
	`IS_ERR
(
em
)) {

775 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

776 
out
;

778 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

779 
	`‹¡_msg
("Ex³ùed‡ hÞex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

780 
out
;

787 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð3 * 
£ùÜsize
) {

788 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u, "

790 
off£t
, 3 * 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

791 
out
;

793 ià(
em
->
æags
 !ð
vaÿncy_Úly
) {

794 
	`‹¡_msg
("Unexpected flags set, want %lu have %lu\n",

795 
vaÿncy_Úly
, 
em
->
æags
);

796 
out
;

798 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

799 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

800 
em
->
Üig_¡¬t
);

801 
out
;

803 
off£t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

804 
	`ä“_ex‹Á_m­
(
em
);

806 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
off£t
, 
£ùÜsize
, 0);

807 ià(
	`IS_ERR
(
em
)) {

808 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

809 
out
;

811 ià(
em
->
block_¡¬t
 >ð
EXTENT_MAP_LAST_BYTE
) {

812 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

813 
out
;

815 ià(
em
->
¡¬t
 !ð
off£t
 ||ƒm->
Ën
 !ð
£ùÜsize
) {

816 
	`‹¡_msg
("Unexpectedƒxtent wanted start %llu†en %u,"

818 
off£t
, 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

819 
out
;

821 ià(
em
->
æags
 != 0) {

822 
	`‹¡_msg
("UÃx³ùed fÏg £t, wªˆ0 hav%lu\n", 
em
->
æags
);

823 
out
;

825 ià(
em
->
Üig_¡¬t
 !ðem->
¡¬t
) {

826 
	`‹¡_msg
("WrÚg orig off£t, wªˆ%Îu, hav%Îu\n", 
em
->
¡¬t
,

827 
em
->
Üig_¡¬t
);

828 
out
;

830 
»t
 = 0;

831 
out
:

832 ià(!
	`IS_ERR
(
em
))

833 
	`ä“_ex‹Á_m­
(
em
);

834 
	`ut
(
šode
);

835 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

836 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

837  
»t
;

838 
	}
}

840 
	$‹¡_hÞe_fœ¡
(
u32
 
£ùÜsize
, u32 
nodesize
)

842 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

843 
šode
 *šodð
NULL
;

844 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

845 
ex‹Á_m­
 *
em
 = 
NULL
;

846 
»t
 = -
ENOMEM
;

848 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

849 ià(!
šode
) {

850 
	`‹¡_msg
("Couldn't‡llocate inode\n");

851  
»t
;

854 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

855 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

856 
	`BTRFS_I
(
šode
)->
loÿtiÚ
.
off£t
 = 0;

858 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

859 ià(!
fs_šfo
) {

860 
	`‹¡_msg
("Couldn't‡llocate dummy fs info\n");

861 
out
;

864 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

865 ià(
	`IS_ERR
(
roÙ
)) {

866 
	`‹¡_msg
("Couldn't‡llocate„oot\n");

867 
out
;

870 
roÙ
->
node
 = 
	`®loc_dummy_ex‹Á_bufãr
(
fs_šfo
, 
nodesize
);

871 ià(!
roÙ
->
node
) {

872 
	`‹¡_msg
("Couldn't‡llocate dummy buffer\n");

873 
out
;

876 
	`ex‹Á_bufãr_g‘
(
roÙ
->
node
);

877 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

878 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

879 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

880 
»t
 = -
EINVAL
;

886 
	`š£¹_šode_™em_key
(
roÙ
);

887 
	`š£¹_ex‹Á
(
roÙ
, 
£ùÜsize
, sectorsize, sectorsize, 0, sectorsize,

888 
£ùÜsize
, 
BTRFS_FILE_EXTENT_REG
, 0, 1);

889 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 0, 2 * 
£ùÜsize
, 0);

890 ià(
	`IS_ERR
(
em
)) {

891 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

892 
out
;

894 ià(
em
->
block_¡¬t
 !ð
EXTENT_MAP_HOLE
) {

895 
	`‹¡_msg
("Ex³ùed‡ hÞe, gÙ %Îu\n", 
em
->
block_¡¬t
);

896 
out
;

898 ià(
em
->
¡¬t
 !ð0 ||ƒm->
Ën
 !ð
£ùÜsize
) {

899 
	`‹¡_msg
("Unexpectedƒxtent wanted start 0†en %u, "

901 
£ùÜsize
, 
em
->
¡¬t
,ƒm->
Ën
);

902 
out
;

904 ià(
em
->
æags
 !ð
vaÿncy_Úly
) {

905 
	`‹¡_msg
("WrÚg fÏgs, wª‹d %lu, hav%lu\n", 
vaÿncy_Úly
,

906 
em
->
æags
);

907 
out
;

909 
	`ä“_ex‹Á_m­
(
em
);

911 
em
 = 
	`bŒfs_g‘_ex‹Á
(
	`BTRFS_I
(
šode
), 
NULL
, 0, 
£ùÜsize
,

912 2 * 
£ùÜsize
, 0);

913 ià(
	`IS_ERR
(
em
)) {

914 
	`‹¡_msg
("Got‡nƒrror when we shouldn't have\n");

915 
out
;

917 ià(
em
->
block_¡¬t
 !ð
£ùÜsize
) {

918 
	`‹¡_msg
("Ex³ùed‡„—Èex‹Á, gÙ %Îu\n", 
em
->
block_¡¬t
);

919 
out
;

921 ià(
em
->
¡¬t
 !ð
£ùÜsize
 ||ƒm->
Ën
 != sectorsize) {

922 
	`‹¡_msg
("Unexpectedƒxtent wanted start %u†en %u, "

924 
£ùÜsize
, seùÜsize, 
em
->
¡¬t
,ƒm->
Ën
);

925 
out
;

927 ià(
em
->
æags
 != 0) {

928 
	`‹¡_msg
("Unexpected flags set, wanted 0 got %lu\n",

929 
em
->
æags
);

930 
out
;

932 
»t
 = 0;

933 
out
:

934 ià(!
	`IS_ERR
(
em
))

935 
	`ä“_ex‹Á_m­
(
em
);

936 
	`ut
(
šode
);

937 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

938 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

939  
»t
;

940 
	}
}

942 
	$‹¡_ex‹Á_accouÁšg
(
u32
 
£ùÜsize
, u32 
nodesize
)

944 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

945 
šode
 *šodð
NULL
;

946 
bŒfs_roÙ
 *
roÙ
 = 
NULL
;

947 
»t
 = -
ENOMEM
;

949 
šode
 = 
	`bŒfs_Ãw_‹¡_šode
();

950 ià(!
šode
) {

951 
	`‹¡_msg
("Couldn't‡llocate inode\n");

952  
»t
;

955 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

956 ià(!
fs_šfo
) {

957 
	`‹¡_msg
("Couldn't‡llocate dummy fs info\n");

958 
out
;

961 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

962 ià(
	`IS_ERR
(
roÙ
)) {

963 
	`‹¡_msg
("Couldn't‡llocate„oot\n");

964 
out
;

967 
	`BTRFS_I
(
šode
)->
roÙ
 =„oot;

968 
	`bŒfs_‹¡_šode_£t_Ýs
(
šode
);

971 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

972 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 0, 
BTRFS_MAX_EXTENT_SIZE
 - 1,

973 
NULL
, 0);

974 ià(
»t
) {

975 
	`‹¡_msg
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d\n", 
»t
);

976 
out
;

978 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 1) {

979 
»t
 = -
EINVAL
;

980 
	`‹¡_msg
("Miscount, wanted 1, got %u\n",

981 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

982 
out
;

986 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

987 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
BTRFS_MAX_EXTENT_SIZE
,

988 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
 - 1,

989 
NULL
, 0);

990 ià(
»t
) {

991 
	`‹¡_msg
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d\n", 
»t
);

992 
out
;

994 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 2) {

995 
»t
 = -
EINVAL
;

996 
	`‹¡_msg
("Miscount, wanted 2, got %u\n",

997 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

998 
out
;

1002 
»t
 = 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1003 
BTRFS_MAX_EXTENT_SIZE
 >> 1,

1004 (
BTRFS_MAX_EXTENT_SIZE
 >> 1è+ 
£ùÜsize
 - 1,

1005 
EXTENT_DELALLOC
 | 
EXTENT_DIRTY
 |

1006 
EXTENT_UPTODATE
 | 
EXTENT_DO_ACCOUNTING
, 0, 0,

1007 
NULL
, 
GFP_KERNEL
);

1008 ià(
»t
) {

1009 
	`‹¡_msg
("þ—r_ex‹Á_b™„‘uºed %d\n", 
»t
);

1010 
out
;

1012 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 2) {

1013 
»t
 = -
EINVAL
;

1014 
	`‹¡_msg
("Miscount, wanted 2, got %u\n",

1015 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1016 
out
;

1020 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1021 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
, 
BTRFS_MAX_EXTENT_SIZE
 >> 1,

1022 (
BTRFS_MAX_EXTENT_SIZE
 >> 1)

1023 + 
£ùÜsize
 - 1,

1024 
NULL
, 0);

1025 ià(
»t
) {

1026 
	`‹¡_msg
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d\n", 
»t
);

1027 
out
;

1029 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 2) {

1030 
»t
 = -
EINVAL
;

1031 
	`‹¡_msg
("Miscount, wanted 2, got %u\n",

1032 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1033 
out
;

1043 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 += 2;

1044 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
,

1045 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
,

1046 (
BTRFS_MAX_EXTENT_SIZE
 << 1è+ 3 * 
£ùÜsize
 - 1,

1047 
NULL
, 0);

1048 ià(
»t
) {

1049 
	`‹¡_msg
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d\n", 
»t
);

1050 
out
;

1052 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 4) {

1053 
»t
 = -
EINVAL
;

1054 
	`‹¡_msg
("Miscount, wanted 4, got %u\n",

1055 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1056 
out
;

1062 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1063 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
,

1064 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
,

1065 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
 - 1, 
NULL
, 0);

1066 ià(
»t
) {

1067 
	`‹¡_msg
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d\n", 
»t
);

1068 
out
;

1070 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 3) {

1071 
»t
 = -
EINVAL
;

1072 
	`‹¡_msg
("Miscount, wanted 3, got %u\n",

1073 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1074 
out
;

1078 
»t
 = 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
,

1079 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
,

1080 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
 - 1,

1081 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

1082 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_UPTODATE
, 0, 0,

1083 
NULL
, 
GFP_KERNEL
);

1084 ià(
»t
) {

1085 
	`‹¡_msg
("þ—r_ex‹Á_b™„‘uºed %d\n", 
»t
);

1086 
out
;

1088 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 4) {

1089 
»t
 = -
EINVAL
;

1090 
	`‹¡_msg
("Miscount, wanted 4, got %u\n",

1091 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1092 
out
;

1099 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
++;

1100 
»t
 = 
	`bŒfs_£t_ex‹Á_d–®loc
(
šode
,

1101 
BTRFS_MAX_EXTENT_SIZE
 + 
£ùÜsize
,

1102 
BTRFS_MAX_EXTENT_SIZE
 + 2 * 
£ùÜsize
 - 1, 
NULL
, 0);

1103 ià(
»t
) {

1104 
	`‹¡_msg
("bŒfs_£t_ex‹Á_d–®loø»tuºed %d\n", 
»t
);

1105 
out
;

1107 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
 != 3) {

1108 
»t
 = -
EINVAL
;

1109 
	`‹¡_msg
("Miscount, wanted 3, got %u\n",

1110 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1111 
out
;

1115 
»t
 = 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, (
u64
)-1,

1116 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

1117 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_UPTODATE
, 0, 0,

1118 
NULL
, 
GFP_KERNEL
);

1119 ià(
»t
) {

1120 
	`‹¡_msg
("þ—r_ex‹Á_b™„‘uºed %d\n", 
»t
);

1121 
out
;

1123 ià(
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
) {

1124 
»t
 = -
EINVAL
;

1125 
	`‹¡_msg
("Miscount, wanted 0, got %u\n",

1126 
	`BTRFS_I
(
šode
)->
out¡ªdšg_ex‹Ás
);

1127 
out
;

1129 
»t
 = 0;

1130 
out
:

1131 ià(
»t
)

1132 
	`þ—r_ex‹Á_b™
(&
	`BTRFS_I
(
šode
)->
io_Œ“
, 0, (
u64
)-1,

1133 
EXTENT_DIRTY
 | 
EXTENT_DELALLOC
 |

1134 
EXTENT_DO_ACCOUNTING
 | 
EXTENT_UPTODATE
, 0, 0,

1135 
NULL
, 
GFP_KERNEL
);

1136 
	`ut
(
šode
);

1137 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

1138 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

1139  
»t
;

1140 
	}
}

1142 
	$bŒfs_‹¡_šodes
(
u32
 
£ùÜsize
, u32 
nodesize
)

1144 
»t
;

1146 
	`£t_b™
(
EXTENT_FLAG_COMPRESSED
, &
com´es£d_Úly
);

1147 
	`£t_b™
(
EXTENT_FLAG_VACANCY
, &
vaÿncy_Úly
);

1148 
	`£t_b™
(
EXTENT_FLAG_PREALLOC
, &
´—Îoc_Úly
);

1150 
	`‹¡_msg
("Running btrfs_get_extentests\n");

1151 
»t
 = 
	`‹¡_bŒfs_g‘_ex‹Á
(
£ùÜsize
, 
nodesize
);

1152 ià(
»t
)

1153  
»t
;

1154 
	`‹¡_msg
("Running hole first btrfs_get_extentest\n");

1155 
»t
 = 
	`‹¡_hÞe_fœ¡
(
£ùÜsize
, 
nodesize
);

1156 ià(
»t
)

1157  
»t
;

1158 
	`‹¡_msg
("Running outstanding_extentsests\n");

1159  
	`‹¡_ex‹Á_accouÁšg
(
£ùÜsize
, 
nodesize
);

1160 
	}
}

	@tests/qgroup-tests.c

19 
	~<lšux/ty³s.h
>

20 
	~"bŒfs-‹¡s.h
"

21 
	~"../ù»e.h
"

22 
	~"../Œª§ùiÚ.h
"

23 
	~"../disk-io.h
"

24 
	~"../qgroup.h
"

25 
	~"../back»f.h
"

27 
	$š£¹_nÜm®_Œ“_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

28 
u64
 
num_by‹s
, u64 
·»Á
, u64 
roÙ_objeùid
)

30 
bŒfs_Œªs_hªdË
 
Œªs
;

31 
bŒfs_ex‹Á_™em
 *
™em
;

32 
bŒfs_ex‹Á_šlše_»f
 *
œef
;

33 
bŒfs_Œ“_block_šfo
 *
block_šfo
;

34 
bŒfs_·th
 *
·th
;

35 
ex‹Á_bufãr
 *
Ëaf
;

36 
bŒfs_key
 
šs
;

37 
u32
 
size
 = (*
™em
è+ (*
œef
è+ (*
block_šfo
);

38 
»t
;

40 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

42 
šs
.
objeùid
 = 
by‹Ä
;

43 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

44 
šs
.
off£t
 = 
num_by‹s
;

46 
·th
 = 
	`bŒfs_®loc_·th
();

47 ià(!
·th
) {

48 
	`‹¡_msg
("Couldn't‡llocate…ath\n");

49  -
ENOMEM
;

52 
·th
->
Ëave_¥šnšg
 = 1;

53 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(&
Œªs
, 
roÙ
, 
·th
, &
šs
, 
size
);

54 ià(
»t
) {

55 
	`‹¡_msg
("Couldn'ˆš£¹„eà%d\n", 
»t
);

56 
	`bŒfs_ä“_·th
(
·th
);

57  
»t
;

60 
Ëaf
 = 
·th
->
nodes
[0];

61 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_ex‹Á_™em
);

62 
	`bŒfs_£t_ex‹Á_»fs
(
Ëaf
, 
™em
, 1);

63 
	`bŒfs_£t_ex‹Á_g’”©iÚ
(
Ëaf
, 
™em
, 1);

64 
	`bŒfs_£t_ex‹Á_æags
(
Ëaf
, 
™em
, 
BTRFS_EXTENT_FLAG_TREE_BLOCK
);

65 
block_šfo
 = (
bŒfs_Œ“_block_šfo
 *)(
™em
 + 1);

66 
	`bŒfs_£t_Œ“_block_Ëv–
(
Ëaf
, 
block_šfo
, 1);

67 
œef
 = (
bŒfs_ex‹Á_šlše_»f
 *)(
block_šfo
 + 1);

68 ià(
·»Á
 > 0) {

69 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
,

70 
BTRFS_SHARED_BLOCK_REF_KEY
);

71 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
·»Á
);

73 
	`bŒfs_£t_ex‹Á_šlše_»f_ty³
(
Ëaf
, 
œef
, 
BTRFS_TREE_BLOCK_REF_KEY
);

74 
	`bŒfs_£t_ex‹Á_šlše_»f_off£t
(
Ëaf
, 
œef
, 
roÙ_objeùid
);

76 
	`bŒfs_ä“_·th
(
·th
);

78 
	}
}

80 
	$add_Œ“_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
, u64 
num_by‹s
,

81 
u64
 
·»Á
, u64 
roÙ_objeùid
)

83 
bŒfs_Œªs_hªdË
 
Œªs
;

84 
bŒfs_ex‹Á_™em
 *
™em
;

85 
bŒfs_·th
 *
·th
;

86 
bŒfs_key
 
key
;

87 
u64
 
»fs
;

88 
»t
;

90 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

92 
key
.
objeùid
 = 
by‹Ä
;

93 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

94 
key
.
off£t
 = 
num_by‹s
;

96 
·th
 = 
	`bŒfs_®loc_·th
();

97 ià(!
·th
) {

98 
	`‹¡_msg
("Couldn't‡llocate…ath\n");

99  -
ENOMEM
;

102 
·th
->
Ëave_¥šnšg
 = 1;

103 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

104 ià(
»t
) {

105 
	`‹¡_msg
("Couldn't findƒxtent„ef\n");

106 
	`bŒfs_ä“_·th
(
·th
);

107  
»t
;

110 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

111 
bŒfs_ex‹Á_™em
);

112 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
);

113 
	`bŒfs_£t_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
, 
»fs
 + 1);

114 
	`bŒfs_»Ëa£_·th
(
·th
);

116 
key
.
objeùid
 = 
by‹Ä
;

117 ià(
·»Á
) {

118 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

119 
key
.
off£t
 = 
·»Á
;

121 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

122 
key
.
off£t
 = 
roÙ_objeùid
;

125 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(&
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

126 ià(
»t
)

127 
	`‹¡_msg
("Failedo insert backref\n");

128 
	`bŒfs_ä“_·th
(
·th
);

129  
»t
;

130 
	}
}

132 
	$»move_ex‹Á_™em
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

133 
u64
 
num_by‹s
)

135 
bŒfs_Œªs_hªdË
 
Œªs
;

136 
bŒfs_key
 
key
;

137 
bŒfs_·th
 *
·th
;

138 
»t
;

140 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

142 
key
.
objeùid
 = 
by‹Ä
;

143 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

144 
key
.
off£t
 = 
num_by‹s
;

146 
·th
 = 
	`bŒfs_®loc_·th
();

147 ià(!
·th
) {

148 
	`‹¡_msg
("Couldn't‡llocate…ath\n");

149  -
ENOMEM
;

151 
·th
->
Ëave_¥šnšg
 = 1;

153 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

154 ià(
»t
) {

155 
	`‹¡_msg
("Didn'ˆfšd ou¸key %d\n", 
»t
);

156 
	`bŒfs_ä“_·th
(
·th
);

157  
»t
;

159 
	`bŒfs_d–_™em
(&
Œªs
, 
roÙ
, 
·th
);

160 
	`bŒfs_ä“_·th
(
·th
);

162 
	}
}

164 
	$»move_ex‹Á_»f
(
bŒfs_roÙ
 *
roÙ
, 
u64
 
by‹Ä
,

165 
u64
 
num_by‹s
, u64 
·»Á
, u64 
roÙ_objeùid
)

167 
bŒfs_Œªs_hªdË
 
Œªs
;

168 
bŒfs_ex‹Á_™em
 *
™em
;

169 
bŒfs_·th
 *
·th
;

170 
bŒfs_key
 
key
;

171 
u64
 
»fs
;

172 
»t
;

174 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

176 
key
.
objeùid
 = 
by‹Ä
;

177 
key
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

178 
key
.
off£t
 = 
num_by‹s
;

180 
·th
 = 
	`bŒfs_®loc_·th
();

181 ià(!
·th
) {

182 
	`‹¡_msg
("Couldn't‡llocate…ath\n");

183  -
ENOMEM
;

186 
·th
->
Ëave_¥šnšg
 = 1;

187 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

188 ià(
»t
) {

189 
	`‹¡_msg
("Couldn't findƒxtent„ef\n");

190 
	`bŒfs_ä“_·th
(
·th
);

191  
»t
;

194 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

195 
bŒfs_ex‹Á_™em
);

196 
»fs
 = 
	`bŒfs_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
);

197 
	`bŒfs_£t_ex‹Á_»fs
(
·th
->
nodes
[0], 
™em
, 
»fs
 - 1);

198 
	`bŒfs_»Ëa£_·th
(
·th
);

200 
key
.
objeùid
 = 
by‹Ä
;

201 ià(
·»Á
) {

202 
key
.
ty³
 = 
BTRFS_SHARED_BLOCK_REF_KEY
;

203 
key
.
off£t
 = 
·»Á
;

205 
key
.
ty³
 = 
BTRFS_TREE_BLOCK_REF_KEY
;

206 
key
.
off£t
 = 
roÙ_objeùid
;

209 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(&
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

210 ià(
»t
) {

211 
	`‹¡_msg
("Couldn'ˆfšd back»à%d\n", 
»t
);

212 
	`bŒfs_ä“_·th
(
·th
);

213  
»t
;

215 
	`bŒfs_d–_™em
(&
Œªs
, 
roÙ
, 
·th
);

216 
	`bŒfs_ä“_·th
(
·th
);

217  
»t
;

218 
	}
}

220 
	$‹¡_no_sh¬ed_qgroup
(
bŒfs_roÙ
 *
roÙ
,

221 
u32
 
£ùÜsize
, u32 
nodesize
)

223 
bŒfs_Œªs_hªdË
 
Œªs
;

224 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

225 
uli¡
 *
Þd_roÙs
 = 
NULL
;

226 
uli¡
 *
Ãw_roÙs
 = 
NULL
;

227 
»t
;

229 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

231 
	`‹¡_msg
("Qgroup basic‡dd\n");

232 
»t
 = 
	`bŒfs_ü—‹_qgroup
(
NULL
, 
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
);

233 ià(
»t
) {

234 
	`‹¡_msg
("Couldn'ˆü—‹‡ qgrou°%d\n", 
»t
);

235  
»t
;

243 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Þd_roÙs
);

244 ià(
»t
) {

245 
	`uli¡_ä“
(
Þd_roÙs
);

246 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

247  
»t
;

250 
»t
 = 
	`š£¹_nÜm®_Œ“_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

251 
BTRFS_FS_TREE_OBJECTID
);

252 ià(
»t
)

253  
»t
;

255 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Ãw_roÙs
);

256 ià(
»t
) {

257 
	`uli¡_ä“
(
Þd_roÙs
);

258 
	`uli¡_ä“
(
Ãw_roÙs
);

259 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

260  
»t
;

263 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
fs_šfo
, 
nodesize
,

264 
nodesize
, 
Þd_roÙs
, 
Ãw_roÙs
);

265 ià(
»t
) {

266 
	`‹¡_msg
("Couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d\n", 
»t
);

267  
»t
;

270 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

271 
nodesize
,‚odesize)) {

272 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

273  -
EINVAL
;

275 
Þd_roÙs
 = 
NULL
;

276 
Ãw_roÙs
 = 
NULL
;

278 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Þd_roÙs
);

279 ià(
»t
) {

280 
	`uli¡_ä“
(
Þd_roÙs
);

281 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

282  
»t
;

285 
»t
 = 
	`»move_ex‹Á_™em
(
roÙ
, 
nodesize
,‚odesize);

286 ià(
»t
)

287  -
EINVAL
;

289 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Ãw_roÙs
);

290 ià(
»t
) {

291 
	`uli¡_ä“
(
Þd_roÙs
);

292 
	`uli¡_ä“
(
Ãw_roÙs
);

293 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

294  
»t
;

297 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
fs_šfo
, 
nodesize
,

298 
nodesize
, 
Þd_roÙs
, 
Ãw_roÙs
);

299 ià(
»t
) {

300 
	`‹¡_msg
("Couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d\n", 
»t
);

301  -
EINVAL
;

304 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
, 0, 0)) {

305 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

306  -
EINVAL
;

310 
	}
}

317 
	$‹¡_muÉË_»fs
(
bŒfs_roÙ
 *
roÙ
,

318 
u32
 
£ùÜsize
, u32 
nodesize
)

320 
bŒfs_Œªs_hªdË
 
Œªs
;

321 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

322 
uli¡
 *
Þd_roÙs
 = 
NULL
;

323 
uli¡
 *
Ãw_roÙs
 = 
NULL
;

324 
»t
;

326 
	`bŒfs_š™_dummy_Œªs
(&
Œªs
);

328 
	`‹¡_msg
("Qgroup multiple„efsest\n");

334 
»t
 = 
	`bŒfs_ü—‹_qgroup
(
NULL
, 
fs_šfo
, 
BTRFS_FIRST_FREE_OBJECTID
);

335 ià(
»t
) {

336 
	`‹¡_msg
("Couldn'ˆü—‹‡ qgrou°%d\n", 
»t
);

337  
»t
;

340 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Þd_roÙs
);

341 ià(
»t
) {

342 
	`uli¡_ä“
(
Þd_roÙs
);

343 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

344  
»t
;

347 
»t
 = 
	`š£¹_nÜm®_Œ“_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

348 
BTRFS_FS_TREE_OBJECTID
);

349 ià(
»t
)

350  
»t
;

352 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Ãw_roÙs
);

353 ià(
»t
) {

354 
	`uli¡_ä“
(
Þd_roÙs
);

355 
	`uli¡_ä“
(
Ãw_roÙs
);

356 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

357  
»t
;

360 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
fs_šfo
, 
nodesize
,

361 
nodesize
, 
Þd_roÙs
, 
Ãw_roÙs
);

362 ià(
»t
) {

363 
	`‹¡_msg
("Couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d\n", 
»t
);

364  
»t
;

367 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

368 
nodesize
,‚odesize)) {

369 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

370  -
EINVAL
;

373 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Þd_roÙs
);

374 ià(
»t
) {

375 
	`uli¡_ä“
(
Þd_roÙs
);

376 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

377  
»t
;

380 
»t
 = 
	`add_Œ“_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

381 
BTRFS_FIRST_FREE_OBJECTID
);

382 ià(
»t
)

383  
»t
;

385 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Ãw_roÙs
);

386 ià(
»t
) {

387 
	`uli¡_ä“
(
Þd_roÙs
);

388 
	`uli¡_ä“
(
Ãw_roÙs
);

389 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

390  
»t
;

393 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
fs_šfo
, 
nodesize
,

394 
nodesize
, 
Þd_roÙs
, 
Ãw_roÙs
);

395 ià(
»t
) {

396 
	`‹¡_msg
("Couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d\n", 
»t
);

397  
»t
;

400 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

401 
nodesize
, 0)) {

402 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

403  -
EINVAL
;

406 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FIRST_FREE_OBJECTID
,

407 
nodesize
, 0)) {

408 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

409  -
EINVAL
;

412 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Þd_roÙs
);

413 ià(
»t
) {

414 
	`uli¡_ä“
(
Þd_roÙs
);

415 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

416  
»t
;

419 
»t
 = 
	`»move_ex‹Á_»f
(
roÙ
, 
nodesize
,‚odesize, 0,

420 
BTRFS_FIRST_FREE_OBJECTID
);

421 ià(
»t
)

422  
»t
;

424 
»t
 = 
	`bŒfs_fšd_®l_roÙs
(&
Œªs
, 
fs_šfo
, 
nodesize
, 0, &
Ãw_roÙs
);

425 ià(
»t
) {

426 
	`uli¡_ä“
(
Þd_roÙs
);

427 
	`uli¡_ä“
(
Ãw_roÙs
);

428 
	`‹¡_msg
("Couldn'ˆfšd old„oÙs: %d\n", 
»t
);

429  
»t
;

432 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Á
(&
Œªs
, 
fs_šfo
, 
nodesize
,

433 
nodesize
, 
Þd_roÙs
, 
Ãw_roÙs
);

434 ià(
»t
) {

435 
	`‹¡_msg
("Couldn'ˆaccouÁ s·û fÜ‡ qgrou°%d\n", 
»t
);

436  
»t
;

439 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FIRST_FREE_OBJECTID
,

441 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

442  -
EINVAL
;

445 ià(
	`bŒfs_v”ify_qgroup_couÁs
(
fs_šfo
, 
BTRFS_FS_TREE_OBJECTID
,

446 
nodesize
,‚odesize)) {

447 
	`‹¡_msg
("Qgroup counts didn't matchƒxpected values\n");

448  -
EINVAL
;

452 
	}
}

454 
	$bŒfs_‹¡_qgroups
(
u32
 
£ùÜsize
, u32 
nodesize
)

456 
bŒfs_fs_šfo
 *
fs_šfo
 = 
NULL
;

457 
bŒfs_roÙ
 *
roÙ
;

458 
bŒfs_roÙ
 *
tmp_roÙ
;

459 
»t
 = 0;

461 
fs_šfo
 = 
	`bŒfs_®loc_dummy_fs_šfo
(
nodesize
, 
£ùÜsize
);

462 ià(!
fs_šfo
) {

463 
	`‹¡_msg
("Couldn't‡llocate dummy fs info\n");

464  -
ENOMEM
;

467 
roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

468 ià(
	`IS_ERR
(
roÙ
)) {

469 
	`‹¡_msg
("Couldn't‡llocate„oot\n");

470 
»t
 = 
	`PTR_ERR
(
roÙ
);

471 
out
;

475 
roÙ
->
fs_šfo
->
ex‹Á_roÙ
 =„oot;

481 
roÙ
->
fs_šfo
->
Œ“_roÙ
 =„oot;

482 
roÙ
->
fs_šfo
->
quÙa_roÙ
 =„oot;

483 
	`£t_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
);

489 
roÙ
->
node
 = 
	`®loc_‹¡_ex‹Á_bufãr
ÔoÙ->
fs_šfo
, 
nodesize
);

490 ià(!
roÙ
->
node
) {

491 
	`‹¡_msg
("Couldn't‡llocate dummy buffer\n");

492 
»t
 = -
ENOMEM
;

493 
out
;

495 
	`bŒfs_£t_h—d”_Ëv–
(
roÙ
->
node
, 0);

496 
	`bŒfs_£t_h—d”_Ä™ems
(
roÙ
->
node
, 0);

497 
roÙ
->
®loc_by‹Ä
 +ð2 * 
nodesize
;

499 
tmp_roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

500 ià(
	`IS_ERR
(
tmp_roÙ
)) {

501 
	`‹¡_msg
("Couldn't‡llocate‡ fs„oot\n");

502 
»t
 = 
	`PTR_ERR
(
tmp_roÙ
);

503 
out
;

506 
tmp_roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_FS_TREE_OBJECTID
;

507 
roÙ
->
fs_šfo
->
fs_roÙ
 = 
tmp_roÙ
;

508 
»t
 = 
	`bŒfs_š£¹_fs_roÙ
(
roÙ
->
fs_šfo
, 
tmp_roÙ
);

509 ià(
»t
) {

510 
	`‹¡_msg
("Couldn'ˆš£¹ f roÙ %d\n", 
»t
);

511 
out
;

514 
tmp_roÙ
 = 
	`bŒfs_®loc_dummy_roÙ
(
fs_šfo
);

515 ià(
	`IS_ERR
(
tmp_roÙ
)) {

516 
	`‹¡_msg
("Couldn't‡llocate‡ fs„oot\n");

517 
»t
 = 
	`PTR_ERR
(
tmp_roÙ
);

518 
out
;

521 
tmp_roÙ
->
roÙ_key
.
objeùid
 = 
BTRFS_FIRST_FREE_OBJECTID
;

522 
»t
 = 
	`bŒfs_š£¹_fs_roÙ
(
roÙ
->
fs_šfo
, 
tmp_roÙ
);

523 ià(
»t
) {

524 
	`‹¡_msg
("Couldn'ˆš£¹ f roÙ %d\n", 
»t
);

525 
out
;

528 
	`‹¡_msg
("Running qgroupests\n");

529 
»t
 = 
	`‹¡_no_sh¬ed_qgroup
(
roÙ
, 
£ùÜsize
, 
nodesize
);

530 ià(
»t
)

531 
out
;

532 
»t
 = 
	`‹¡_muÉË_»fs
(
roÙ
, 
£ùÜsize
, 
nodesize
);

533 
out
:

534 
	`bŒfs_ä“_dummy_roÙ
(
roÙ
);

535 
	`bŒfs_ä“_dummy_fs_šfo
(
fs_šfo
);

536  
»t
;

537 
	}
}

	@transaction.c

19 
	~<lšux/fs.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/wr™eback.h
>

23 
	~<lšux/·gem­.h
>

24 
	~<lšux/blkdev.h
>

25 
	~<lšux/uuid.h
>

26 
	~"ù»e.h
"

27 
	~"disk-io.h
"

28 
	~"Œª§ùiÚ.h
"

29 
	~"lockšg.h
"

30 
	~"Œ“-log.h
"

31 
	~"šode-m­.h
"

32 
	~"vÞumes.h
"

33 
	~"dev-»¶aû.h
"

34 
	~"qgroup.h
"

36 
	#BTRFS_ROOT_TRANS_TAG
 0

	)

38 cÚ¡ 
	gbŒfs_blocked_Œªs_ty³s
[
TRANS_STATE_MAX
] = {

39 [
TRANS_STATE_RUNNING
] = 0U,

40 [
TRANS_STATE_BLOCKED
] = (
__TRANS_USERSPACE
 |

41 
__TRANS_START
),

42 [
TRANS_STATE_COMMIT_START
] = (
__TRANS_USERSPACE
 |

43 
__TRANS_START
 |

44 
__TRANS_ATTACH
),

45 [
TRANS_STATE_COMMIT_DOING
] = (
__TRANS_USERSPACE
 |

46 
__TRANS_START
 |

47 
__TRANS_ATTACH
 |

48 
__TRANS_JOIN
),

49 [
TRANS_STATE_UNBLOCKED
] = (
__TRANS_USERSPACE
 |

50 
__TRANS_START
 |

51 
__TRANS_ATTACH
 |

52 
__TRANS_JOIN
 |

53 
__TRANS_JOIN_NOLOCK
),

54 [
TRANS_STATE_COMPLETED
] = (
__TRANS_USERSPACE
 |

55 
__TRANS_START
 |

56 
__TRANS_ATTACH
 |

57 
__TRANS_JOIN
 |

58 
__TRANS_JOIN_NOLOCK
),

61 
	$bŒfs_put_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
)

63 
	`WARN_ON
(
	`»fcouÁ_»ad
(&
Œª§ùiÚ
->
u£_couÁ
) == 0);

64 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
Œª§ùiÚ
->
u£_couÁ
)) {

65 
	`BUG_ON
(!
	`li¡_em±y
(&
Œª§ùiÚ
->
li¡
));

66 
	`WARN_ON
(!
	`RB_EMPTY_ROOT
(&
Œª§ùiÚ
->
d–ayed_»fs
.
h»f_roÙ
));

67 ià(
Œª§ùiÚ
->
d–ayed_»fs
.
³ndšg_csums
)

68 
	`bŒfs_”r
(
Œª§ùiÚ
->
fs_šfo
,

70 
Œª§ùiÚ
->
d–ayed_»fs
.
³ndšg_csums
);

71 !
	`li¡_em±y
(&
Œª§ùiÚ
->
³ndšg_chunks
)) {

72 
ex‹Á_m­
 *
em
;

74 
em
 = 
	`li¡_fœ¡_’Œy
(&
Œª§ùiÚ
->
³ndšg_chunks
,

75 
ex‹Á_m­
, 
li¡
);

76 
	`li¡_d–_š™
(&
em
->
li¡
);

77 
	`ä“_ex‹Á_m­
(
em
);

86 !
	`li¡_em±y
(&
Œª§ùiÚ
->
d–‘ed_bgs
)) {

87 
bŒfs_block_group_ÿche
 *
ÿche
;

89 
ÿche
 = 
	`li¡_fœ¡_’Œy
(&
Œª§ùiÚ
->
d–‘ed_bgs
,

90 
bŒfs_block_group_ÿche
,

91 
bg_li¡
);

92 
	`li¡_d–_š™
(&
ÿche
->
bg_li¡
);

93 
	`bŒfs_put_block_group_Œimmšg
(
ÿche
);

94 
	`bŒfs_put_block_group
(
ÿche
);

96 
	`kä“
(
Œª§ùiÚ
);

98 
	}
}

100 
	$þ—r_bŒ“_io_Œ“
(
ex‹Á_io_Œ“
 *
Œ“
)

102 
	`¥š_lock
(&
Œ“
->
lock
);

108 
	`smp_mb
();

109 !
	`RB_EMPTY_ROOT
(&
Œ“
->
¡©e
)) {

110 
rb_node
 *
node
;

111 
ex‹Á_¡©e
 *
¡©e
;

113 
node
 = 
	`rb_fœ¡
(&
Œ“
->
¡©e
);

114 
¡©e
 = 
	`rb_’Œy
(
node
, 
ex‹Á_¡©e
, 
rb_node
);

115 
	`rb_”a£
(&
¡©e
->
rb_node
, &
Œ“
->state);

116 
	`RB_CLEAR_NODE
(&
¡©e
->
rb_node
);

121 
	`ASSERT
(!
	`wa™queue_aùive
(&
¡©e
->
wq
));

122 
	`ä“_ex‹Á_¡©e
(
¡©e
);

124 
	`cÚd_»sched_lock
(&
Œ“
->
lock
);

126 
	`¥š_uÆock
(&
Œ“
->
lock
);

127 
	}
}

129 
nošlše
 
	$sw™ch_comm™_roÙs
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

130 
bŒfs_fs_šfo
 *
fs_šfo
)

132 
bŒfs_roÙ
 *
roÙ
, *
tmp
;

134 
	`down_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

135 
	`li¡_fÜ_—ch_’Œy_§ã
(
roÙ
, 
tmp
, &
Œªs
->
sw™ch_comm™s
,

136 
dœty_li¡
) {

137 
	`li¡_d–_š™
(&
roÙ
->
dœty_li¡
);

138 
	`ä“_ex‹Á_bufãr
(
roÙ
->
comm™_roÙ
);

139 
roÙ
->
comm™_roÙ
 = 
	`bŒfs_roÙ_node
(root);

140 ià(
	`is_f¡»e
(
roÙ
->
objeùid
))

141 
	`bŒfs_uÅš_ä“_šo
(
roÙ
);

142 
	`þ—r_bŒ“_io_Œ“
(&
roÙ
->
dœty_log_·ges
);

146 
	`¥š_lock
(&
Œªs
->
drÝ³d_roÙs_lock
);

147 !
	`li¡_em±y
(&
Œªs
->
drÝ³d_roÙs
)) {

148 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
Œªs
->
drÝ³d_roÙs
,

149 
bŒfs_roÙ
, 
roÙ_li¡
);

150 
	`li¡_d–_š™
(&
roÙ
->
roÙ_li¡
);

151 
	`¥š_uÆock
(&
Œªs
->
drÝ³d_roÙs_lock
);

152 
	`bŒfs_drÝ_ªd_ä“_fs_roÙ
(
fs_šfo
, 
roÙ
);

153 
	`¥š_lock
(&
Œªs
->
drÝ³d_roÙs_lock
);

155 
	`¥š_uÆock
(&
Œªs
->
drÝ³d_roÙs_lock
);

156 
	`up_wr™e
(&
fs_šfo
->
comm™_roÙ_£m
);

157 
	}
}

159 
šlše
 
	$extwr™”_couÁ”_šc
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

160 
ty³
)

162 ià(
ty³
 & 
TRANS_EXTWRITERS
)

163 
	`©omic_šc
(&
Œªs
->
num_extwr™”s
);

164 
	}
}

166 
šlše
 
	$extwr™”_couÁ”_dec
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

167 
ty³
)

169 ià(
ty³
 & 
TRANS_EXTWRITERS
)

170 
	`©omic_dec
(&
Œªs
->
num_extwr™”s
);

171 
	}
}

173 
šlše
 
	$extwr™”_couÁ”_š™
(
bŒfs_Œª§ùiÚ
 *
Œªs
,

174 
ty³
)

176 
	`©omic_£t
(&
Œªs
->
num_extwr™”s
, ((
ty³
 & 
TRANS_EXTWRITERS
) ? 1 : 0));

177 
	}
}

179 
šlše
 
	$extwr™”_couÁ”_»ad
(
bŒfs_Œª§ùiÚ
 *
Œªs
)

181  
	`©omic_»ad
(&
Œªs
->
num_extwr™”s
);

182 
	}
}

187 
nošlše
 
	$još_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
,

188 
ty³
)

190 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

192 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

193 
loÝ
:

195 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

196 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

197  -
EROFS
;

200 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

201 ià(
cur_Œªs
) {

202 ià(
cur_Œªs
->
abÜ‹d
) {

203 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

204  
cur_Œªs
->
abÜ‹d
;

206 ià(
bŒfs_blocked_Œªs_ty³s
[
cur_Œªs
->
¡©e
] & 
ty³
) {

207 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

208  -
EBUSY
;

210 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

211 
	`©omic_šc
(&
cur_Œªs
->
num_wr™”s
);

212 
	`extwr™”_couÁ”_šc
(
cur_Œªs
, 
ty³
);

213 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

216 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

222 ià(
ty³
 =ð
TRANS_ATTACH
)

223  -
ENOENT
;

229 
	`BUG_ON
(
ty³
 =ð
TRANS_JOIN_NOLOCK
);

231 
cur_Œªs
 = 
	`km®loc
((*cur_Œªs), 
GFP_NOFS
);

232 ià(!
cur_Œªs
)

233  -
ENOMEM
;

235 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

236 ià(
fs_šfo
->
ruÂšg_Œª§ùiÚ
) {

241 
	`kä“
(
cur_Œªs
);

242 
loÝ
;

243 } ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
)) {

244 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

245 
	`kä“
(
cur_Œªs
);

246  -
EROFS
;

249 
cur_Œªs
->
fs_šfo
 = fs_info;

250 
	`©omic_£t
(&
cur_Œªs
->
num_wr™”s
, 1);

251 
	`extwr™”_couÁ”_š™
(
cur_Œªs
, 
ty³
);

252 
	`š™_wa™queue_h—d
(&
cur_Œªs
->
wr™”_wa™
);

253 
	`š™_wa™queue_h—d
(&
cur_Œªs
->
comm™_wa™
);

254 
	`š™_wa™queue_h—d
(&
cur_Œªs
->
³ndšg_wa™
);

255 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_RUNNING
;

260 
	`»fcouÁ_£t
(&
cur_Œªs
->
u£_couÁ
, 2);

261 
	`©omic_£t
(&
cur_Œªs
->
³ndšg_Üd”ed
, 0);

262 
cur_Œªs
->
æags
 = 0;

263 
cur_Œªs
->
¡¬t_time
 = 
	`g‘_£cÚds
();

265 
	`mem£t
(&
cur_Œªs
->
d–ayed_»fs
, 0, (cur_trans->delayed_refs));

267 
cur_Œªs
->
d–ayed_»fs
.
h»f_roÙ
 = 
RB_ROOT
;

268 
cur_Œªs
->
d–ayed_»fs
.
dœty_ex‹Á_roÙ
 = 
RB_ROOT
;

269 
	`©omic_£t
(&
cur_Œªs
->
d–ayed_»fs
.
num_’Œ›s
, 0);

275 
	`smp_mb
();

276 ià(!
	`li¡_em±y
(&
fs_šfo
->
Œ“_mod_£q_li¡
))

277 
	`WARN
(1, 
KERN_ERR
 "BTRFS:ree_mod_seq_list‚otƒmpty when creating‡ freshransaction\n");

278 ià(!
	`RB_EMPTY_ROOT
(&
fs_šfo
->
Œ“_mod_log
))

279 
	`WARN
(1, 
KERN_ERR
 "BTRFS:ree_mod_log„bree‚otƒmpty when creating‡ freshransaction\n");

280 
	`©omic64_£t
(&
fs_šfo
->
Œ“_mod_£q
, 0);

282 
	`¥š_lock_š™
(&
cur_Œªs
->
d–ayed_»fs
.
lock
);

284 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
³ndšg_¢­shÙs
);

285 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
³ndšg_chunks
);

286 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
sw™ch_comm™s
);

287 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
dœty_bgs
);

288 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
io_bgs
);

289 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
drÝ³d_roÙs
);

290 
	`mu‹x_š™
(&
cur_Œªs
->
ÿche_wr™e_mu‹x
);

291 
cur_Œªs
->
num_dœty_bgs
 = 0;

292 
	`¥š_lock_š™
(&
cur_Œªs
->
dœty_bgs_lock
);

293 
	`INIT_LIST_HEAD
(&
cur_Œªs
->
d–‘ed_bgs
);

294 
	`¥š_lock_š™
(&
cur_Œªs
->
drÝ³d_roÙs_lock
);

295 
	`li¡_add_ž
(&
cur_Œªs
->
li¡
, &
fs_šfo
->
Œªs_li¡
);

296 
	`ex‹Á_io_Œ“_š™
(&
cur_Œªs
->
dœty_·ges
,

297 
fs_šfo
->
bŒ“_šode
);

298 
fs_šfo
->
g’”©iÚ
++;

299 
cur_Œªs
->
Œªsid
 = 
fs_šfo
->
g’”©iÚ
;

300 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
cur_Œªs
;

301 
cur_Œªs
->
abÜ‹d
 = 0;

302 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

305 
	}
}

313 
	$»cÜd_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

314 
bŒfs_roÙ
 *
roÙ
,

315 
fÜû
)

317 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

319 ià((
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) &&

320 
roÙ
->
Ï¡_Œªs
 < 
Œªs
->
Œªsid
è|| 
fÜû
) {

321 
	`WARN_ON
(
roÙ
 =ð
fs_šfo
->
ex‹Á_roÙ
);

322 
	`WARN_ON
(
roÙ
->
comm™_roÙ
 !ðroÙ->
node
);

329 
	`£t_b™
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roÙ
->
¡©e
);

334 
	`smp_wmb
();

336 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

337 ià(
roÙ
->
Ï¡_Œªs
 =ð
Œªs
->
Œªsid
 && !
fÜû
) {

338 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

341 
	`¿dix_Œ“_g_£t
(&
fs_šfo
->
fs_roÙs_¿dix
,

342 ()
roÙ
->
roÙ_key
.
objeùid
,

343 
BTRFS_ROOT_TRANS_TAG
);

344 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

345 
roÙ
->
Ï¡_Œªs
 = 
Œªs
->
Œªsid
;

366 
	`bŒfs_š™_»loc_roÙ
(
Œªs
, 
roÙ
);

367 
	`smp_mb__befÜe_©omic
();

368 
	`þ—r_b™
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roÙ
->
¡©e
);

371 
	}
}

374 
	$bŒfs_add_drÝ³d_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

375 
bŒfs_roÙ
 *
roÙ
)

377 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

378 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

381 
	`¥š_lock
(&
cur_Œªs
->
drÝ³d_roÙs_lock
);

382 
	`li¡_add_ž
(&
roÙ
->
roÙ_li¡
, &
cur_Œªs
->
drÝ³d_roÙs
);

383 
	`¥š_uÆock
(&
cur_Œªs
->
drÝ³d_roÙs_lock
);

386 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

387 
	`¿dix_Œ“_g_þ—r
(&
fs_šfo
->
fs_roÙs_¿dix
,

388 ()
roÙ
->
roÙ_key
.
objeùid
,

389 
BTRFS_ROOT_TRANS_TAG
);

390 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

391 
	}
}

393 
	$bŒfs_»cÜd_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

394 
bŒfs_roÙ
 *
roÙ
)

396 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

398 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

405 
	`smp_rmb
();

406 ià(
roÙ
->
Ï¡_Œªs
 =ð
Œªs
->
Œªsid
 &&

407 !
	`‹¡_b™
(
BTRFS_ROOT_IN_TRANS_SETUP
, &
roÙ
->
¡©e
))

410 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

411 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
, 0);

412 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

415 
	}
}

417 
šlše
 
	$is_Œª§ùiÚ_blocked
(
bŒfs_Œª§ùiÚ
 *
Œªs
)

419  (
Œªs
->
¡©e
 >ð
TRANS_STATE_BLOCKED
 &&

420 
Œªs
->
¡©e
 < 
TRANS_STATE_UNBLOCKED
 &&

421 !
Œªs
->
abÜ‹d
);

422 
	}
}

428 
	$wa™_cu¼’t_Œªs
(
bŒfs_fs_šfo
 *
fs_šfo
)

430 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

432 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

433 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

434 ià(
cur_Œªs
 && 
	`is_Œª§ùiÚ_blocked
(cur_trans)) {

435 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

436 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

438 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

439 
cur_Œªs
->
¡©e
 >ð
TRANS_STATE_UNBLOCKED
 ||

440 
cur_Œªs
->
abÜ‹d
);

441 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

443 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

445 
	}
}

447 
	$may_wa™_Œª§ùiÚ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
ty³
)

449 ià(
	`‹¡_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
))

452 ià(
ty³
 =ð
TRANS_USERSPACE
)

455 ià(
ty³
 =ð
TRANS_START
 &&

456 !
	`©omic_»ad
(&
fs_šfo
->
Ý’_ioùl_Œªs
))

460 
	}
}

462 
šlše
 
boÞ
 
	$Ãed_»£rve_»loc_roÙ
(
bŒfs_roÙ
 *
roÙ
)

464 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

466 ià(!
fs_šfo
->
»loc_ùl
 ||

467 !
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
) ||

468 
roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_RELOC_OBJECTID
 ||

469 
roÙ
->
»loc_roÙ
)

470  
çl£
;

472  
Œue
;

473 
	}
}

475 
bŒfs_Œªs_hªdË
 *

476 
	$¡¬t_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
, 
num_™ems
,

477 
ty³
, 
bŒfs_»£rve_æush_’um
 
æush
,

478 
boÞ
 
’fÜû_qgroups
)

480 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

482 
bŒfs_Œªs_hªdË
 *
h
;

483 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

484 
u64
 
num_by‹s
 = 0;

485 
u64
 
qgroup_»£rved
 = 0;

486 
boÞ
 
»loc_»£rved
 = 
çl£
;

487 
»t
;

490 
	`ASSERT
(
cu¼’t
->
jouº®_šfo
 !ð
BTRFS_SEND_TRANS_STUB
);

492 ià(
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
fs_šfo
->
fs_¡©e
))

493  
	`ERR_PTR
(-
EROFS
);

495 ià(
cu¼’t
->
jouº®_šfo
) {

496 
	`WARN_ON
(
ty³
 & 
TRANS_EXTWRITERS
);

497 
h
 = 
cu¼’t
->
jouº®_šfo
;

498 
h
->
u£_couÁ
++;

499 
	`WARN_ON
(
h
->
u£_couÁ
 > 2);

500 
h
->
Üig_rsv
 = h->
block_rsv
;

501 
h
->
block_rsv
 = 
NULL
;

502 
gÙ_™
;

509 ià(
num_™ems
 && 
roÙ
 !ð
fs_šfo
->
chunk_roÙ
) {

510 
qgroup_»£rved
 = 
num_™ems
 * 
fs_šfo
->
nodesize
;

511 
»t
 = 
	`bŒfs_qgroup_»£rve_m‘a
(
roÙ
, 
qgroup_»£rved
,

512 
’fÜû_qgroups
);

513 ià(
»t
)

514  
	`ERR_PTR
(
»t
);

516 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
num_™ems
);

520 ià(
	`Ãed_»£rve_»loc_roÙ
(
roÙ
)) {

521 
num_by‹s
 +ð
fs_šfo
->
nodesize
;

522 
»loc_»£rved
 = 
Œue
;

525 
»t
 = 
	`bŒfs_block_rsv_add
(
roÙ
, &
fs_šfo
->
Œªs_block_rsv
,

526 
num_by‹s
, 
æush
);

527 ià(
»t
)

528 
»£rve_çž
;

530 
agaš
:

531 
h
 = 
	`kmem_ÿche_z®loc
(
bŒfs_Œªs_hªdË_ÿch•
, 
GFP_NOFS
);

532 ià(!
h
) {

533 
»t
 = -
ENOMEM
;

534 
®loc_çž
;

547 ià(
ty³
 & 
__TRANS_FREEZABLE
)

548 
	`sb_¡¬t_štwr™e
(
fs_šfo
->
sb
);

550 ià(
	`may_wa™_Œª§ùiÚ
(
fs_šfo
, 
ty³
))

551 
	`wa™_cu¼’t_Œªs
(
fs_šfo
);

554 
»t
 = 
	`još_Œª§ùiÚ
(
fs_šfo
, 
ty³
);

555 ià(
»t
 =ð-
EBUSY
) {

556 
	`wa™_cu¼’t_Œªs
(
fs_šfo
);

557 ià(
	`uÆik–y
(
ty³
 =ð
TRANS_ATTACH
))

558 
»t
 = -
ENOENT
;

560 } 
»t
 =ð-
EBUSY
);

562 ià(
»t
 < 0)

563 
još_çž
;

565 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

567 
h
->
Œªsid
 = 
cur_Œªs
->transid;

568 
h
->
Œª§ùiÚ
 = 
cur_Œªs
;

569 
h
->
roÙ
 =„oot;

570 
h
->
u£_couÁ
 = 1;

571 
h
->
fs_šfo
 = 
roÙ
->fs_info;

573 
h
->
ty³
 =ype;

574 
h
->
ÿn_æush_³ndšg_bgs
 = 
Œue
;

575 
	`INIT_LIST_HEAD
(&
h
->
Ãw_bgs
);

577 
	`smp_mb
();

578 ià(
cur_Œªs
->
¡©e
 >ð
TRANS_STATE_BLOCKED
 &&

579 
	`may_wa™_Œª§ùiÚ
(
fs_šfo
, 
ty³
)) {

580 
cu¼’t
->
jouº®_šfo
 = 
h
;

581 
	`bŒfs_comm™_Œª§ùiÚ
(
h
);

582 
agaš
;

585 ià(
num_by‹s
) {

586 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

587 
h
->
Œªsid
, 
num_by‹s
, 1);

588 
h
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

589 
h
->
by‹s_»£rved
 = 
num_by‹s
;

590 
h
->
»loc_»£rved
 =„eloc_reserved;

593 
gÙ_™
:

594 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
h
, 
roÙ
);

596 ià(!
cu¼’t
->
jouº®_šfo
 && 
ty³
 !ð
TRANS_USERSPACE
)

597 
cu¼’t
->
jouº®_šfo
 = 
h
;

598  
h
;

600 
još_çž
:

601 ià(
ty³
 & 
__TRANS_FREEZABLE
)

602 
	`sb_’d_štwr™e
(
fs_šfo
->
sb
);

603 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
h
);

604 
®loc_çž
:

605 ià(
num_by‹s
)

606 
	`bŒfs_block_rsv_»Ëa£
(
fs_šfo
, &fs_šfo->
Œªs_block_rsv
,

607 
num_by‹s
);

608 
»£rve_çž
:

609 
	`bŒfs_qgroup_ä“_m‘a
(
roÙ
, 
qgroup_»£rved
);

610  
	`ERR_PTR
(
»t
);

611 
	}
}

613 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
,

614 
num_™ems
)

616  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 
num_™ems
, 
TRANS_START
,

617 
BTRFS_RESERVE_FLUSH_ALL
, 
Œue
);

618 
	}
}

620 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(

621 
bŒfs_roÙ
 *
roÙ
,

622 
num_™ems
,

623 
mš_çùÜ
)

625 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

626 
bŒfs_Œªs_hªdË
 *
Œªs
;

627 
u64
 
num_by‹s
;

628 
»t
;

636 
Œªs
 = 
	`¡¬t_Œª§ùiÚ
(
roÙ
, 
num_™ems
, 
TRANS_START
,

637 
BTRFS_RESERVE_FLUSH_ALL
, 
çl£
);

638 ià(!
	`IS_ERR
(
Œªs
è|| 
	`PTR_ERR
Ñ¿nsè!ð-
ENOSPC
)

639  
Œªs
;

641 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

642 ià(
	`IS_ERR
(
Œªs
))

643  
Œªs
;

645 
num_by‹s
 = 
	`bŒfs_ÿlc_Œªs_m‘ad©a_size
(
fs_šfo
, 
num_™ems
);

646 
»t
 = 
	`bŒfs_cÚd_mig¿‹_by‹s
(
fs_šfo
, &fs_šfo->
Œªs_block_rsv
,

647 
num_by‹s
, 
mš_çùÜ
);

648 ià(
»t
) {

649 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

650  
	`ERR_PTR
(
»t
);

653 
Œªs
->
block_rsv
 = &
fs_šfo
->
Œªs_block_rsv
;

654 
Œªs
->
by‹s_»£rved
 = 
num_by‹s
;

655 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

656 
Œªs
->
Œªsid
, 
num_by‹s
, 1);

658  
Œªs
;

659 
	}
}

661 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_Œª§ùiÚ_læush
(

662 
bŒfs_roÙ
 *
roÙ
,

663 
num_™ems
)

665  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 
num_™ems
, 
TRANS_START
,

666 
BTRFS_RESERVE_FLUSH_LIMIT
, 
Œue
);

667 
	}
}

669 
bŒfs_Œªs_hªdË
 *
	$bŒfs_još_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
)

671  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_JOIN
, 
BTRFS_RESERVE_NO_FLUSH
,

672 
Œue
);

673 
	}
}

675 
bŒfs_Œªs_hªdË
 *
	$bŒfs_još_Œª§ùiÚ_nÞock
(
bŒfs_roÙ
 *
roÙ
)

677  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_JOIN_NOLOCK
,

678 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

679 
	}
}

681 
bŒfs_Œªs_hªdË
 *
	$bŒfs_¡¬t_ioùl_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
)

683  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_USERSPACE
,

684 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

685 
	}
}

700 
bŒfs_Œªs_hªdË
 *
	$bŒfs_©ch_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
)

702  
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_ATTACH
,

703 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

704 
	}
}

713 
bŒfs_Œªs_hªdË
 *

714 
	$bŒfs_©ch_Œª§ùiÚ_b¬r›r
(
bŒfs_roÙ
 *
roÙ
)

716 
bŒfs_Œªs_hªdË
 *
Œªs
;

718 
Œªs
 = 
	`¡¬t_Œª§ùiÚ
(
roÙ
, 0, 
TRANS_ATTACH
,

719 
BTRFS_RESERVE_NO_FLUSH
, 
Œue
);

720 ià(
	`IS_ERR
(
Œªs
è&& 
	`PTR_ERR
Ñ¿nsè=ð-
ENOENT
)

721 
	`bŒfs_wa™_fÜ_comm™
(
roÙ
->
fs_šfo
, 0);

723  
Œªs
;

724 
	}
}

727 
nošlše
 
	$wa™_fÜ_comm™
(
bŒfs_Œª§ùiÚ
 *
comm™
)

729 
	`wa™_ev’t
(
comm™
->
comm™_wa™
, comm™->
¡©e
 =ð
TRANS_STATE_COMPLETED
);

730 
	}
}

732 
	$bŒfs_wa™_fÜ_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Œªsid
)

734 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
NULL
, *
t
;

735 
»t
 = 0;

737 ià(
Œªsid
) {

738 ià(
Œªsid
 <ð
fs_šfo
->
Ï¡_Œªs_comm™‹d
)

739 
out
;

742 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

743 
	`li¡_fÜ_—ch_’Œy
(
t
, &
fs_šfo
->
Œªs_li¡
, 
li¡
) {

744 ià(
t
->
Œªsid
 ==ransid) {

745 
cur_Œªs
 = 
t
;

746 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

747 
»t
 = 0;

750 ià(
t
->
Œªsid
 >ransid) {

751 
»t
 = 0;

755 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

761 ià(!
cur_Œªs
) {

762 ià(
Œªsid
 > 
fs_šfo
->
Ï¡_Œªs_comm™‹d
)

763 
»t
 = -
EINVAL
;

764 
out
;

768 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

769 
	`li¡_fÜ_—ch_’Œy_»v”£
(
t
, &
fs_šfo
->
Œªs_li¡
,

770 
li¡
) {

771 ià(
t
->
¡©e
 >ð
TRANS_STATE_COMMIT_START
) {

772 ià(
t
->
¡©e
 =ð
TRANS_STATE_COMPLETED
)

774 
cur_Œªs
 = 
t
;

775 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

779 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

780 ià(!
cur_Œªs
)

781 
out
;

784 
	`wa™_fÜ_comm™
(
cur_Œªs
);

785 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

786 
out
:

787  
»t
;

788 
	}
}

790 
	$bŒfs_thrÙŽe
(
bŒfs_fs_šfo
 *
fs_šfo
)

792 ià(!
	`©omic_»ad
(&
fs_šfo
->
Ý’_ioùl_Œªs
))

793 
	`wa™_cu¼’t_Œªs
(
fs_šfo
);

794 
	}
}

796 
	$should_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

798 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

800 ià(
fs_šfo
->
glob®_block_rsv
.
¥aû_šfo
->
fuÎ
 &&

801 
	`bŒfs_check_¥aû_fÜ_d–ayed_»fs
(
Œªs
, 
fs_šfo
))

804  !!
	`bŒfs_block_rsv_check
(&
fs_šfo
->
glob®_block_rsv
, 5);

805 
	}
}

807 
	$bŒfs_should_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

809 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

810 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

811 
upd©es
;

812 
”r
;

814 
	`smp_mb
();

815 ià(
cur_Œªs
->
¡©e
 >ð
TRANS_STATE_BLOCKED
 ||

816 
cur_Œªs
->
d–ayed_»fs
.
æushšg
)

819 
upd©es
 = 
Œªs
->
d–ayed_»f_upd©es
;

820 
Œªs
->
d–ayed_»f_upd©es
 = 0;

821 ià(
upd©es
) {

822 
”r
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 
upd©es
 * 2);

823 ià(
”r
)

824  
”r
;

827  
	`should_’d_Œª§ùiÚ
(
Œªs
);

828 
	}
}

830 
	$__bŒfs_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

831 
thrÙŽe
)

833 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

834 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

835 
u64
 
Œªsid
 = 
Œªs
->transid;

836 
cur
 = 
Œªs
->
d–ayed_»f_upd©es
;

837 
lock
 = (
Œªs
->
ty³
 !ð
TRANS_JOIN_NOLOCK
);

838 
”r
 = 0;

839 
mu¡_run_d–ayed_»fs
 = 0;

841 ià(
Œªs
->
u£_couÁ
 > 1) {

842 
Œªs
->
u£_couÁ
--;

843 
Œªs
->
block_rsv
 =¿ns->
Üig_rsv
;

847 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
, 
šfo
);

848 
Œªs
->
block_rsv
 = 
NULL
;

850 ià(!
	`li¡_em±y
(&
Œªs
->
Ãw_bgs
))

851 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
, 
šfo
);

853 
Œªs
->
d–ayed_»f_upd©es
 = 0;

854 ià(!
Œªs
->
sync
) {

855 
mu¡_run_d–ayed_»fs
 =

856 
	`bŒfs_should_thrÙŽe_d–ayed_»fs
(
Œªs
, 
šfo
);

857 
cur
 = 
	`max_t
(, cur, 32);

863 ià(
mu¡_run_d–ayed_»fs
 == 1 &&

864 (
Œªs
->
ty³
 & (
__TRANS_JOIN_NOLOCK
 | 
__TRANS_ATTACH
)))

865 
mu¡_run_d–ayed_»fs
 = 2;

868 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
, 
šfo
);

869 
Œªs
->
block_rsv
 = 
NULL
;

871 ià(!
	`li¡_em±y
(&
Œªs
->
Ãw_bgs
))

872 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
, 
šfo
);

874 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

876 ià(
lock
 && !
	`©omic_»ad
(&
šfo
->
Ý’_ioùl_Œªs
) &&

877 
	`should_’d_Œª§ùiÚ
(
Œªs
) &&

878 
	`READ_ONCE
(
cur_Œªs
->
¡©e
è=ð
TRANS_STATE_RUNNING
) {

879 
	`¥š_lock
(&
šfo
->
Œªs_lock
);

880 ià(
cur_Œªs
->
¡©e
 =ð
TRANS_STATE_RUNNING
)

881 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_BLOCKED
;

882 
	`¥š_uÆock
(&
šfo
->
Œªs_lock
);

885 ià(
lock
 && 
	`READ_ONCE
(
cur_Œªs
->
¡©e
è=ð
TRANS_STATE_BLOCKED
) {

886 ià(
thrÙŽe
)

887  
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

889 
	`wake_up_´oûss
(
šfo
->
Œª§ùiÚ_kth»ad
);

892 ià(
Œªs
->
ty³
 & 
__TRANS_FREEZABLE
)

893 
	`sb_’d_štwr™e
(
šfo
->
sb
);

895 
	`WARN_ON
(
cur_Œªs
 !ð
šfo
->
ruÂšg_Œª§ùiÚ
);

896 
	`WARN_ON
(
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) < 1);

897 
	`©omic_dec
(&
cur_Œªs
->
num_wr™”s
);

898 
	`extwr™”_couÁ”_dec
(
cur_Œªs
, 
Œªs
->
ty³
);

903 
	`smp_mb
();

904 ià(
	`wa™queue_aùive
(&
cur_Œªs
->
wr™”_wa™
))

905 
	`wake_up
(&
cur_Œªs
->
wr™”_wa™
);

906 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

908 ià(
cu¼’t
->
jouº®_šfo
 =ð
Œªs
)

909 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

911 ià(
thrÙŽe
)

912 
	`bŒfs_run_d–ayed_uts
(
šfo
);

914 ià(
Œªs
->
abÜ‹d
 ||

915 
	`‹¡_b™
(
BTRFS_FS_STATE_ERROR
, &
šfo
->
fs_¡©e
)) {

916 
	`wake_up_´oûss
(
šfo
->
Œª§ùiÚ_kth»ad
);

917 
”r
 = -
EIO
;

920 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
Œªs
);

921 ià(
mu¡_run_d–ayed_»fs
) {

922 
	`bŒfs_async_run_d–ayed_»fs
(
šfo
, 
cur
, 
Œªsid
,

923 
mu¡_run_d–ayed_»fs
 == 1);

925  
”r
;

926 
	}
}

928 
	$bŒfs_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

930  
	`__bŒfs_’d_Œª§ùiÚ
(
Œªs
, 0);

931 
	}
}

933 
	$bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
bŒfs_Œªs_hªdË
 *
Œªs
)

935  
	`__bŒfs_’d_Œª§ùiÚ
(
Œªs
, 1);

936 
	}
}

943 
	$bŒfs_wr™e_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

944 
ex‹Á_io_Œ“
 *
dœty_·ges
, 
m¬k
)

946 
”r
 = 0;

947 
w”r
 = 0;

948 
add»ss_¥aû
 *
m­pšg
 = 
fs_šfo
->
bŒ“_šode
->
i_m­pšg
;

949 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

950 
u64
 
¡¬t
 = 0;

951 
u64
 
’d
;

953 !
	`fšd_fœ¡_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, &¡¬t, &
’d
,

954 
m¬k
, &
ÿched_¡©e
)) {

955 
boÞ
 
wa™_wr™eback
 = 
çl£
;

957 
”r
 = 
	`cÚv”t_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, 
’d
,

958 
EXTENT_NEED_WAIT
,

959 
m¬k
, &
ÿched_¡©e
);

973 ià(
”r
 =ð-
ENOMEM
) {

974 
”r
 = 0;

975 
wa™_wr™eback
 = 
Œue
;

977 ià(!
”r
)

978 
”r
 = 
	`fžem­_fd©awr™e_¿nge
(
m­pšg
, 
¡¬t
, 
’d
);

979 ià(
”r
)

980 
w”r
 = 
”r
;

981 ià(
wa™_wr™eback
)

982 
w”r
 = 
	`fžem­_fd©awa™_¿nge
(
m­pšg
, 
¡¬t
, 
’d
);

983 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

984 
ÿched_¡©e
 = 
NULL
;

985 
	`cÚd_»sched
();

986 
¡¬t
 = 
’d
 + 1;

988  
w”r
;

989 
	}
}

997 
	$__bŒfs_wa™_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

998 
ex‹Á_io_Œ“
 *
dœty_·ges
)

1000 
”r
 = 0;

1001 
w”r
 = 0;

1002 
add»ss_¥aû
 *
m­pšg
 = 
fs_šfo
->
bŒ“_šode
->
i_m­pšg
;

1003 
ex‹Á_¡©e
 *
ÿched_¡©e
 = 
NULL
;

1004 
u64
 
¡¬t
 = 0;

1005 
u64
 
’d
;

1007 !
	`fšd_fœ¡_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, &¡¬t, &
’d
,

1008 
EXTENT_NEED_WAIT
, &
ÿched_¡©e
)) {

1017 
”r
 = 
	`þ—r_ex‹Á_b™
(
dœty_·ges
, 
¡¬t
, 
’d
,

1018 
EXTENT_NEED_WAIT
,

1019 0, 0, &
ÿched_¡©e
, 
GFP_NOFS
);

1020 ià(
”r
 =ð-
ENOMEM
)

1021 
”r
 = 0;

1022 ià(!
”r
)

1023 
”r
 = 
	`fžem­_fd©awa™_¿nge
(
m­pšg
, 
¡¬t
, 
’d
);

1024 ià(
”r
)

1025 
w”r
 = 
”r
;

1026 
	`ä“_ex‹Á_¡©e
(
ÿched_¡©e
);

1027 
ÿched_¡©e
 = 
NULL
;

1028 
	`cÚd_»sched
();

1029 
¡¬t
 = 
’d
 + 1;

1031 ià(
”r
)

1032 
w”r
 = 
”r
;

1033  
w”r
;

1034 
	}
}

1036 
	$bŒfs_wa™_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

1037 
ex‹Á_io_Œ“
 *
dœty_·ges
)

1039 
boÞ
 
”rÜs
 = 
çl£
;

1040 
”r
;

1042 
”r
 = 
	`__bŒfs_wa™_m¬ked_ex‹Ás
(
fs_šfo
, 
dœty_·ges
);

1043 ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_FS_BTREE_ERR
, &
fs_šfo
->
æags
))

1044 
”rÜs
 = 
Œue
;

1046 ià(
”rÜs
 && !
”r
)

1047 
”r
 = -
EIO
;

1048  
”r
;

1049 
	}
}

1051 
	$bŒfs_wa™_Œ“_log_ex‹Ás
(
bŒfs_roÙ
 *
log_roÙ
, 
m¬k
)

1053 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log_roÙ
->fs_info;

1054 
ex‹Á_io_Œ“
 *
dœty_·ges
 = &
log_roÙ
->
dœty_log_·ges
;

1055 
boÞ
 
”rÜs
 = 
çl£
;

1056 
”r
;

1058 
	`ASSERT
(
log_roÙ
->
roÙ_key
.
objeùid
 =ð
BTRFS_TREE_LOG_OBJECTID
);

1060 
”r
 = 
	`__bŒfs_wa™_m¬ked_ex‹Ás
(
fs_šfo
, 
dœty_·ges
);

1061 ià((
m¬k
 & 
EXTENT_DIRTY
) &&

1062 
	`‹¡_ªd_þ—r_b™
(
BTRFS_FS_LOG1_ERR
, &
fs_šfo
->
æags
))

1063 
”rÜs
 = 
Œue
;

1065 ià((
m¬k
 & 
EXTENT_NEW
) &&

1066 
	`‹¡_ªd_þ—r_b™
(
BTRFS_FS_LOG2_ERR
, &
fs_šfo
->
æags
))

1067 
”rÜs
 = 
Œue
;

1069 ià(
”rÜs
 && !
”r
)

1070 
”r
 = -
EIO
;

1071  
”r
;

1072 
	}
}

1079 
	$bŒfs_wr™e_ªd_wa™_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

1080 
ex‹Á_io_Œ“
 *
dœty_·ges
, 
m¬k
)

1082 
»t
;

1083 
»t2
;

1084 
blk_¶ug
 
¶ug
;

1086 
	`blk_¡¬t_¶ug
(&
¶ug
);

1087 
»t
 = 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
fs_šfo
, 
dœty_·ges
, 
m¬k
);

1088 
	`blk_fšish_¶ug
(&
¶ug
);

1089 
»t2
 = 
	`bŒfs_wa™_ex‹Ás
(
fs_šfo
, 
dœty_·ges
);

1091 ià(
»t
)

1092  
»t
;

1093 ià(
»t2
)

1094  
»t2
;

1096 
	}
}

1098 
	$bŒfs_wr™e_ªd_wa™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1099 
bŒfs_fs_šfo
 *
fs_šfo
)

1101 
»t
;

1103 
»t
 = 
	`bŒfs_wr™e_ªd_wa™_m¬ked_ex‹Ás
(
fs_šfo
,

1104 &
Œªs
->
Œª§ùiÚ
->
dœty_·ges
,

1105 
EXTENT_DIRTY
);

1106 
	`þ—r_bŒ“_io_Œ“
(&
Œªs
->
Œª§ùiÚ
->
dœty_·ges
);

1108  
»t
;

1109 
	}
}

1121 
	$upd©e_cowÚly_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1122 
bŒfs_roÙ
 *
roÙ
)

1124 
»t
;

1125 
u64
 
Þd_roÙ_by‹Ä
;

1126 
u64
 
Þd_roÙ_u£d
;

1127 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1128 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1130 
Þd_roÙ_u£d
 = 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
);

1133 
Þd_roÙ_by‹Ä
 = 
	`bŒfs_roÙ_by‹Ä
(&
roÙ
->
roÙ_™em
);

1134 ià(
Þd_roÙ_by‹Ä
 =ð
roÙ
->
node
->
¡¬t
 &&

1135 
Þd_roÙ_u£d
 =ð
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
))

1138 
	`bŒfs_£t_roÙ_node
(&
roÙ
->
roÙ_™em
,„oÙ->
node
);

1139 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
Œ“_roÙ
,

1140 &
roÙ
->
roÙ_key
,

1141 &
roÙ
->
roÙ_™em
);

1142 ià(
»t
)

1143  
»t
;

1145 
Þd_roÙ_u£d
 = 
	`bŒfs_roÙ_u£d
(&
roÙ
->
roÙ_™em
);

1149 
	}
}

1158 
nošlše
 
	$comm™_cowÚly_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1159 
bŒfs_fs_šfo
 *
fs_šfo
)

1161 
li¡_h—d
 *
dœty_bgs
 = &
Œªs
->
Œª§ùiÚ
->dirty_bgs;

1162 
li¡_h—d
 *
io_bgs
 = &
Œªs
->
Œª§ùiÚ
->io_bgs;

1163 
li¡_h—d
 *
Ãxt
;

1164 
ex‹Á_bufãr
 *
eb
;

1165 
»t
;

1167 
eb
 = 
	`bŒfs_lock_roÙ_node
(
fs_šfo
->
Œ“_roÙ
);

1168 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
, 
eb
, 
NULL
,

1169 0, &
eb
);

1170 
	`bŒfs_Œ“_uÆock
(
eb
);

1171 
	`ä“_ex‹Á_bufãr
(
eb
);

1173 ià(
»t
)

1174  
»t
;

1176 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

1177 ià(
»t
)

1178  
»t
;

1180 
»t
 = 
	`bŒfs_run_dev_¡©s
(
Œªs
, 
fs_šfo
);

1181 ià(
»t
)

1182  
»t
;

1183 
»t
 = 
	`bŒfs_run_dev_»¶aû
(
Œªs
, 
fs_šfo
);

1184 ià(
»t
)

1185  
»t
;

1186 
»t
 = 
	`bŒfs_run_qgroups
(
Œªs
, 
fs_šfo
);

1187 ià(
»t
)

1188  
»t
;

1190 
»t
 = 
	`bŒfs_£tup_¥aû_ÿche
(
Œªs
, 
fs_šfo
);

1191 ià(
»t
)

1192  
»t
;

1195 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

1196 ià(
»t
)

1197  
»t
;

1198 
agaš
:

1199 !
	`li¡_em±y
(&
fs_šfo
->
dœty_cowÚly_roÙs
)) {

1200 
bŒfs_roÙ
 *
roÙ
;

1201 
Ãxt
 = 
fs_šfo
->
dœty_cowÚly_roÙs
.next;

1202 
	`li¡_d–_š™
(
Ãxt
);

1203 
roÙ
 = 
	`li¡_’Œy
(
Ãxt
, 
bŒfs_roÙ
, 
dœty_li¡
);

1204 
	`þ—r_b™
(
BTRFS_ROOT_DIRTY
, &
roÙ
->
¡©e
);

1206 ià(
roÙ
 !ð
fs_šfo
->
ex‹Á_roÙ
)

1207 
	`li¡_add_ž
(&
roÙ
->
dœty_li¡
,

1208 &
Œªs
->
Œª§ùiÚ
->
sw™ch_comm™s
);

1209 
»t
 = 
	`upd©e_cowÚly_roÙ
(
Œªs
, 
roÙ
);

1210 ià(
»t
)

1211  
»t
;

1212 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

1213 ià(
»t
)

1214  
»t
;

1217 !
	`li¡_em±y
(
dœty_bgs
è|| !li¡_em±y(
io_bgs
)) {

1218 
»t
 = 
	`bŒfs_wr™e_dœty_block_groups
(
Œªs
, 
fs_šfo
);

1219 ià(
»t
)

1220  
»t
;

1221 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

1222 ià(
»t
)

1223  
»t
;

1226 ià(!
	`li¡_em±y
(&
fs_šfo
->
dœty_cowÚly_roÙs
))

1227 
agaš
;

1229 
	`li¡_add_ž
(&
fs_šfo
->
ex‹Á_roÙ
->
dœty_li¡
,

1230 &
Œªs
->
Œª§ùiÚ
->
sw™ch_comm™s
);

1231 
	`bŒfs_aá”_dev_»¶aû_comm™
(
fs_šfo
);

1234 
	}
}

1241 
	$bŒfs_add_d—d_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1243 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1245 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1246 ià(
	`li¡_em±y
(&
roÙ
->
roÙ_li¡
))

1247 
	`li¡_add_ž
(&
roÙ
->
roÙ_li¡
, &
fs_šfo
->
d—d_roÙs
);

1248 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1249 
	}
}

1254 
nošlše
 
	$comm™_fs_roÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1255 
bŒfs_fs_šfo
 *
fs_šfo
)

1257 
bŒfs_roÙ
 *
gªg
[8];

1258 
i
;

1259 
»t
;

1260 
”r
 = 0;

1262 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1264 
»t
 = 
	`¿dix_Œ“_gªg_lookup_g
(&
fs_šfo
->
fs_roÙs_¿dix
,

1265 (**)
gªg
, 0,

1266 
	`ARRAY_SIZE
(
gªg
),

1267 
BTRFS_ROOT_TRANS_TAG
);

1268 ià(
»t
 == 0)

1270 
i
 = 0; i < 
»t
; i++) {

1271 
bŒfs_roÙ
 *
roÙ
 = 
gªg
[
i
];

1272 
	`¿dix_Œ“_g_þ—r
(&
fs_šfo
->
fs_roÙs_¿dix
,

1273 ()
roÙ
->
roÙ_key
.
objeùid
,

1274 
BTRFS_ROOT_TRANS_TAG
);

1275 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1277 
	`bŒfs_ä“_log
(
Œªs
, 
roÙ
);

1278 
	`bŒfs_upd©e_»loc_roÙ
(
Œªs
, 
roÙ
);

1279 
	`bŒfs_Üphª_comm™_roÙ
(
Œªs
, 
roÙ
);

1281 
	`bŒfs_§ve_šo_ÿche
(
roÙ
, 
Œªs
);

1284 
	`þ—r_b™
(
BTRFS_ROOT_FORCE_COW
, &
roÙ
->
¡©e
);

1285 
	`smp_mb__aá”_©omic
();

1287 ià(
roÙ
->
comm™_roÙ
 !ðroÙ->
node
) {

1288 
	`li¡_add_ž
(&
roÙ
->
dœty_li¡
,

1289 &
Œªs
->
Œª§ùiÚ
->
sw™ch_comm™s
);

1290 
	`bŒfs_£t_roÙ_node
(&
roÙ
->
roÙ_™em
,

1291 
roÙ
->
node
);

1294 
”r
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
Œ“_roÙ
,

1295 &
roÙ
->
roÙ_key
,

1296 &
roÙ
->
roÙ_™em
);

1297 
	`¥š_lock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1298 ià(
”r
)

1300 
	`bŒfs_qgroup_ä“_m‘a_®l
(
roÙ
);

1303 
	`¥š_uÆock
(&
fs_šfo
->
fs_roÙs_¿dix_lock
);

1304  
”r
;

1305 
	}
}

1311 
	$bŒfs_deäag_roÙ
(
bŒfs_roÙ
 *
roÙ
)

1313 
bŒfs_fs_šfo
 *
šfo
 = 
roÙ
->
fs_šfo
;

1314 
bŒfs_Œªs_hªdË
 *
Œªs
;

1315 
»t
;

1317 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ROOT_DEFRAG_RUNNING
, &
roÙ
->
¡©e
))

1321 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1322 ià(
	`IS_ERR
(
Œªs
))

1323  
	`PTR_ERR
(
Œªs
);

1325 
»t
 = 
	`bŒfs_deäag_Ëaves
(
Œªs
, 
roÙ
);

1327 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1328 
	`bŒfs_bŒ“_b®ªû_dœty
(
šfo
);

1329 
	`cÚd_»sched
();

1331 ià(
	`bŒfs_fs_þosšg
(
šfo
è|| 
»t
 !ð-
EAGAIN
)

1334 ià(
	`bŒfs_deäag_ÿnûÎed
(
šfo
)) {

1335 
	`bŒfs_debug
(
šfo
, "defrag_root cancelled");

1336 
»t
 = -
EAGAIN
;

1340 
	`þ—r_b™
(
BTRFS_ROOT_DEFRAG_RUNNING
, &
roÙ
->
¡©e
);

1341  
»t
;

1342 
	}
}

1351 
	$qgroup_accouÁ_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1352 
bŒfs_roÙ
 *
¤c
,

1353 
bŒfs_roÙ
 *
·»Á
,

1354 
bŒfs_qgroup_šh”™
 *
šh”™
,

1355 
u64
 
d¡_objeùid
)

1357 
bŒfs_fs_šfo
 *
fs_šfo
 = 
¤c
->fs_info;

1358 
»t
;

1365 ià(!
	`‹¡_b™
(
BTRFS_FS_QUOTA_ENABLED
, &
fs_šfo
->
æags
))

1372 
	`mu‹x_lock
(&
fs_šfo
->
Œ“_log_mu‹x
);

1374 
»t
 = 
	`comm™_fs_roÙs
(
Œªs
, 
fs_šfo
);

1375 ià(
»t
)

1376 
out
;

1377 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Ás
(
Œªs
, 
fs_šfo
);

1378 ià(
»t
 < 0)

1379 
out
;

1382 
»t
 = 
	`bŒfs_qgroup_šh”™
(
Œªs
, 
fs_šfo
,

1383 
¤c
->
roÙ_key
.
objeùid
, 
d¡_objeùid
,

1384 
šh”™
);

1385 ià(
»t
 < 0)

1386 
out
;

1400 
»t
 = 
	`comm™_cowÚly_roÙs
(
Œªs
, 
fs_šfo
);

1401 ià(
»t
)

1402 
out
;

1403 
	`sw™ch_comm™_roÙs
(
Œªs
->
Œª§ùiÚ
, 
fs_šfo
);

1404 
»t
 = 
	`bŒfs_wr™e_ªd_wa™_Œª§ùiÚ
(
Œªs
, 
fs_šfo
);

1405 ià(
»t
)

1406 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

1409 
out
:

1410 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

1418 ià(!
»t
)

1419 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
·»Á
, 1);

1420  
»t
;

1421 
	}
}

1432 
nošlše
 
	$ü—‹_³ndšg_¢­shÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1433 
bŒfs_fs_šfo
 *
fs_šfo
,

1434 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
)

1436 
bŒfs_key
 
key
;

1437 
bŒfs_roÙ_™em
 *
Ãw_roÙ_™em
;

1438 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

1439 
bŒfs_roÙ
 *
roÙ
 = 
³ndšg
->root;

1440 
bŒfs_roÙ
 *
·»Á_roÙ
;

1441 
bŒfs_block_rsv
 *
rsv
;

1442 
šode
 *
·»Á_šode
;

1443 
bŒfs_·th
 *
·th
;

1444 
bŒfs_dœ_™em
 *
dœ_™em
;

1445 
d’Œy
 *dentry;

1446 
ex‹Á_bufãr
 *
tmp
;

1447 
ex‹Á_bufãr
 *
Þd
;

1448 
time¥ec
 
cur_time
;

1449 
»t
 = 0;

1450 
u64
 
to_»£rve
 = 0;

1451 
u64
 
šdex
 = 0;

1452 
u64
 
objeùid
;

1453 
u64
 
roÙ_æags
;

1454 
uuid_Ë
 
Ãw_uuid
;

1456 
	`ASSERT
(
³ndšg
->
·th
);

1457 
·th
 = 
³ndšg
->path;

1459 
	`ASSERT
(
³ndšg
->
roÙ_™em
);

1460 
Ãw_roÙ_™em
 = 
³ndšg
->
roÙ_™em
;

1462 
³ndšg
->
”rÜ
 = 
	`bŒfs_fšd_ä“_objeùid
(
Œ“_roÙ
, &
objeùid
);

1463 ià(
³ndšg
->
”rÜ
)

1464 
no_ä“_objeùid
;

1470 
	`bŒfs_£t_sk_qgroup
(
Œªs
, 
objeùid
);

1472 
	`bŒfs_»loc_´e_¢­shÙ
(
³ndšg
, &
to_»£rve
);

1474 ià(
to_»£rve
 > 0) {

1475 
³ndšg
->
”rÜ
 = 
	`bŒfs_block_rsv_add
(
roÙ
,

1476 &
³ndšg
->
block_rsv
,

1477 
to_»£rve
,

1478 
BTRFS_RESERVE_NO_FLUSH
);

1479 ià(
³ndšg
->
”rÜ
)

1480 
þ—r_sk_qgroup
;

1483 
key
.
objeùid
 = objectid;

1484 
key
.
off£t
 = (
u64
)-1;

1485 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

1487 
rsv
 = 
Œªs
->
block_rsv
;

1488 
Œªs
->
block_rsv
 = &
³ndšg
->block_rsv;

1489 
Œªs
->
by‹s_»£rved
 =¿ns->
block_rsv
->
»£rved
;

1490 
	`Œaû_bŒfs_¥aû_»£rv©iÚ
(
fs_šfo
, "transaction",

1491 
Œªs
->
Œªsid
,

1492 
Œªs
->
by‹s_»£rved
, 1);

1493 
d’Œy
 = 
³ndšg
->dentry;

1494 
·»Á_šode
 = 
³ndšg
->
dœ
;

1495 
·»Á_roÙ
 = 
	`BTRFS_I
(
·»Á_šode
)->
roÙ
;

1496 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
·»Á_roÙ
, 0);

1498 
cur_time
 = 
	`cu¼’t_time
(
·»Á_šode
);

1503 
»t
 = 
	`bŒfs_£t_šode_šdex
(
	`BTRFS_I
(
·»Á_šode
), &
šdex
);

1504 
	`BUG_ON
(
»t
);

1507 
dœ_™em
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
·»Á_roÙ
, 
·th
,

1508 
	`bŒfs_šo
(
	`BTRFS_I
(
·»Á_šode
)),

1509 
d’Œy
->
d_Çme
.
Çme
,

1510 
d’Œy
->
d_Çme
.
Ën
, 0);

1511 ià(
dœ_™em
 !ð
NULL
 && !
	`IS_ERR
(dir_item)) {

1512 
³ndšg
->
”rÜ
 = -
EEXIST
;

1513 
dœ_™em_exi¡ed
;

1514 } ià(
	`IS_ERR
(
dœ_™em
)) {

1515 
»t
 = 
	`PTR_ERR
(
dœ_™em
);

1516 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1517 
çž
;

1519 
	`bŒfs_»Ëa£_·th
(
·th
);

1527 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

1528 ià(
»t
) {

1529 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1530 
çž
;

1533 
	`»cÜd_roÙ_š_Œªs
(
Œªs
, 
roÙ
, 0);

1534 
	`bŒfs_£t_roÙ_Ï¡_¢­shÙ
(&
roÙ
->
roÙ_™em
, 
Œªs
->
Œªsid
);

1535 
	`memýy
(
Ãw_roÙ_™em
, &
roÙ
->
roÙ_™em
, (*new_root_item));

1536 
	`bŒfs_check_ªd_š™_roÙ_™em
(
Ãw_roÙ_™em
);

1538 
roÙ_æags
 = 
	`bŒfs_roÙ_æags
(
Ãw_roÙ_™em
);

1539 ià(
³ndšg
->
»adÚly
)

1540 
roÙ_æags
 |ð
BTRFS_ROOT_SUBVOL_RDONLY
;

1542 
roÙ_æags
 &ð~
BTRFS_ROOT_SUBVOL_RDONLY
;

1543 
	`bŒfs_£t_roÙ_æags
(
Ãw_roÙ_™em
, 
roÙ_æags
);

1545 
	`bŒfs_£t_roÙ_g’”©iÚ_v2
(
Ãw_roÙ_™em
,

1546 
Œªs
->
Œªsid
);

1547 
	`uuid_Ë_g’
(&
Ãw_uuid
);

1548 
	`memýy
(
Ãw_roÙ_™em
->
uuid
, 
Ãw_uuid
.
b
, 
BTRFS_UUID_SIZE
);

1549 
	`memýy
(
Ãw_roÙ_™em
->
·»Á_uuid
, 
roÙ
->
roÙ_™em
.
uuid
,

1550 
BTRFS_UUID_SIZE
);

1551 ià(!(
roÙ_æags
 & 
BTRFS_ROOT_SUBVOL_RDONLY
)) {

1552 
	`mem£t
(
Ãw_roÙ_™em
->
»ûived_uuid
, 0,

1553 (
Ãw_roÙ_™em
->
»ûived_uuid
));

1554 
	`mem£t
(&
Ãw_roÙ_™em
->
¡ime
, 0, (new_root_item->stime));

1555 
	`mem£t
(&
Ãw_roÙ_™em
->
¹ime
, 0, (new_root_item->rtime));

1556 
	`bŒfs_£t_roÙ_¡¿nsid
(
Ãw_roÙ_™em
, 0);

1557 
	`bŒfs_£t_roÙ_¹¿nsid
(
Ãw_roÙ_™em
, 0);

1559 
	`bŒfs_£t_¡ack_time¥ec_£c
(&
Ãw_roÙ_™em
->
Ùime
, 
cur_time
.
tv_£c
);

1560 
	`bŒfs_£t_¡ack_time¥ec_n£c
(&
Ãw_roÙ_™em
->
Ùime
, 
cur_time
.
tv_n£c
);

1561 
	`bŒfs_£t_roÙ_Ù¿nsid
(
Ãw_roÙ_™em
, 
Œªs
->
Œªsid
);

1563 
Þd
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

1564 
»t
 = 
	`bŒfs_cow_block
(
Œªs
, 
roÙ
, 
Þd
, 
NULL
, 0, &old);

1565 ià(
»t
) {

1566 
	`bŒfs_Œ“_uÆock
(
Þd
);

1567 
	`ä“_ex‹Á_bufãr
(
Þd
);

1568 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1569 
çž
;

1572 
	`bŒfs_£t_lock_blockšg
(
Þd
);

1574 
»t
 = 
	`bŒfs_cÝy_roÙ
(
Œªs
, 
roÙ
, 
Þd
, &
tmp
, 
objeùid
);

1576 
	`bŒfs_Œ“_uÆock
(
Þd
);

1577 
	`ä“_ex‹Á_bufãr
(
Þd
);

1578 ià(
»t
) {

1579 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1580 
çž
;

1583 
	`£t_b™
(
BTRFS_ROOT_FORCE_COW
, &
roÙ
->
¡©e
);

1584 
	`smp_wmb
();

1586 
	`bŒfs_£t_roÙ_node
(
Ãw_roÙ_™em
, 
tmp
);

1588 
key
.
off£t
 = 
Œªs
->
Œªsid
;

1589 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
Œ“_roÙ
, &
key
, 
Ãw_roÙ_™em
);

1590 
	`bŒfs_Œ“_uÆock
(
tmp
);

1591 
	`ä“_ex‹Á_bufãr
(
tmp
);

1592 ià(
»t
) {

1593 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1594 
çž
;

1600 
»t
 = 
	`bŒfs_add_roÙ_»f
(
Œªs
, 
fs_šfo
, 
objeùid
,

1601 
·»Á_roÙ
->
roÙ_key
.
objeùid
,

1602 
	`bŒfs_šo
(
	`BTRFS_I
(
·»Á_šode
)), 
šdex
,

1603 
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
);

1604 ià(
»t
) {

1605 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1606 
çž
;

1609 
key
.
off£t
 = (
u64
)-1;

1610 
³ndšg
->
¢­
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

1611 ià(
	`IS_ERR
(
³ndšg
->
¢­
)) {

1612 
»t
 = 
	`PTR_ERR
(
³ndšg
->
¢­
);

1613 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1614 
çž
;

1617 
»t
 = 
	`bŒfs_»loc_po¡_¢­shÙ
(
Œªs
, 
³ndšg
);

1618 ià(
»t
) {

1619 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1620 
çž
;

1623 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

1624 ià(
»t
) {

1625 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1626 
çž
;

1635 
»t
 = 
	`qgroup_accouÁ_¢­shÙ
(
Œªs
, 
roÙ
, 
·»Á_roÙ
,

1636 
³ndšg
->
šh”™
, 
objeùid
);

1637 ià(
»t
 < 0)

1638 
çž
;

1640 
»t
 = 
	`bŒfs_š£¹_dœ_™em
(
Œªs
, 
·»Á_roÙ
,

1641 
d’Œy
->
d_Çme
.
Çme
, d’Œy->d_Çme.
Ën
,

1642 
	`BTRFS_I
(
·»Á_šode
), &
key
,

1643 
BTRFS_FT_DIR
, 
šdex
);

1645 
	`BUG_ON
(
»t
 =ð-
EEXIST
 ||„‘ =ð-
EOVERFLOW
);

1646 ià(
»t
) {

1647 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1648 
çž
;

1651 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
·»Á_šode
),…¬’t_šode->
i_size
 +

1652 
d’Œy
->
d_Çme
.
Ën
 * 2);

1653 
·»Á_šode
->
i_mtime
 =…¬’t_šode->
i_ùime
 =

1654 
	`cu¼’t_time
(
·»Á_šode
);

1655 
»t
 = 
	`bŒfs_upd©e_šode_çÎback
(
Œªs
, 
·»Á_roÙ
, 
·»Á_šode
);

1656 ià(
»t
) {

1657 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1658 
çž
;

1660 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
fs_šfo
, 
Ãw_uuid
.
b
,

1661 
BTRFS_UUID_KEY_SUBVOL
, 
objeùid
);

1662 ià(
»t
) {

1663 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1664 
çž
;

1666 ià(!
	`bŒfs_is_em±y_uuid
(
Ãw_roÙ_™em
->
»ûived_uuid
)) {

1667 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
fs_šfo
,

1668 
Ãw_roÙ_™em
->
»ûived_uuid
,

1669 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

1670 
objeùid
);

1671 ià(
»t
 &&„‘ !ð-
EEXIST
) {

1672 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1673 
çž
;

1677 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

1678 ià(
»t
) {

1679 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

1680 
çž
;

1683 
çž
:

1684 
³ndšg
->
”rÜ
 = 
»t
;

1685 
dœ_™em_exi¡ed
:

1686 
Œªs
->
block_rsv
 = 
rsv
;

1687 
Œªs
->
by‹s_»£rved
 = 0;

1688 
þ—r_sk_qgroup
:

1689 
	`bŒfs_þ—r_sk_qgroup
(
Œªs
);

1690 
no_ä“_objeùid
:

1691 
	`kä“
(
Ãw_roÙ_™em
);

1692 
³ndšg
->
roÙ_™em
 = 
NULL
;

1693 
	`bŒfs_ä“_·th
(
·th
);

1694 
³ndšg
->
·th
 = 
NULL
;

1696  
»t
;

1697 
	}
}

1702 
nošlše
 
	$ü—‹_³ndšg_¢­shÙs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1703 
bŒfs_fs_šfo
 *
fs_šfo
)

1705 
bŒfs_³ndšg_¢­shÙ
 *
³ndšg
, *
Ãxt
;

1706 
li¡_h—d
 *
h—d
 = &
Œªs
->
Œª§ùiÚ
->
³ndšg_¢­shÙs
;

1707 
»t
 = 0;

1709 
	`li¡_fÜ_—ch_’Œy_§ã
(
³ndšg
, 
Ãxt
, 
h—d
, 
li¡
) {

1710 
	`li¡_d–
(&
³ndšg
->
li¡
);

1711 
»t
 = 
	`ü—‹_³ndšg_¢­shÙ
(
Œªs
, 
fs_šfo
, 
³ndšg
);

1712 ià(
»t
)

1715  
»t
;

1716 
	}
}

1718 
	$upd©e_su³r_roÙs
(
bŒfs_fs_šfo
 *
fs_šfo
)

1720 
bŒfs_roÙ_™em
 *
roÙ_™em
;

1721 
bŒfs_su³r_block
 *
su³r
;

1723 
su³r
 = 
fs_šfo
->
su³r_cÝy
;

1725 
roÙ_™em
 = &
fs_šfo
->
chunk_roÙ
->root_item;

1726 
su³r
->
chunk_roÙ
 = 
roÙ_™em
->
by‹Ä
;

1727 
su³r
->
chunk_roÙ_g’”©iÚ
 = 
roÙ_™em
->
g’”©iÚ
;

1728 
su³r
->
chunk_roÙ_Ëv–
 = 
roÙ_™em
->
Ëv–
;

1730 
roÙ_™em
 = &
fs_šfo
->
Œ“_roÙ
->root_item;

1731 
su³r
->
roÙ
 = 
roÙ_™em
->
by‹Ä
;

1732 
su³r
->
g’”©iÚ
 = 
roÙ_™em
->generation;

1733 
su³r
->
roÙ_Ëv–
 = 
roÙ_™em
->
Ëv–
;

1734 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SPACE_CACHE
))

1735 
su³r
->
ÿche_g’”©iÚ
 = 
roÙ_™em
->
g’”©iÚ
;

1736 ià(
	`‹¡_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
))

1737 
su³r
->
uuid_Œ“_g’”©iÚ
 = 
roÙ_™em
->
g’”©iÚ
;

1738 
	}
}

1740 
	$bŒfs_Œª§ùiÚ_š_comm™
(
bŒfs_fs_šfo
 *
šfo
)

1742 
bŒfs_Œª§ùiÚ
 *
Œªs
;

1743 
»t
 = 0;

1745 
	`¥š_lock
(&
šfo
->
Œªs_lock
);

1746 
Œªs
 = 
šfo
->
ruÂšg_Œª§ùiÚ
;

1747 ià(
Œªs
)

1748 
»t
 = (
Œªs
->
¡©e
 >ð
TRANS_STATE_COMMIT_START
);

1749 
	`¥š_uÆock
(&
šfo
->
Œªs_lock
);

1750  
»t
;

1751 
	}
}

1753 
	$bŒfs_Œª§ùiÚ_blocked
(
bŒfs_fs_šfo
 *
šfo
)

1755 
bŒfs_Œª§ùiÚ
 *
Œªs
;

1756 
»t
 = 0;

1758 
	`¥š_lock
(&
šfo
->
Œªs_lock
);

1759 
Œªs
 = 
šfo
->
ruÂšg_Œª§ùiÚ
;

1760 ià(
Œªs
)

1761 
»t
 = 
	`is_Œª§ùiÚ_blocked
(
Œªs
);

1762 
	`¥š_uÆock
(&
šfo
->
Œªs_lock
);

1763  
»t
;

1764 
	}
}

1770 
	$wa™_cu¼’t_Œªs_comm™_¡¬t
(
bŒfs_fs_šfo
 *
fs_šfo
,

1771 
bŒfs_Œª§ùiÚ
 *
Œªs
)

1773 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_blocked_wa™
,

1774 
Œªs
->
¡©e
 >ð
TRANS_STATE_COMMIT_START
 ||¿ns->
abÜ‹d
);

1775 
	}
}

1781 
	$wa™_cu¼’t_Œªs_comm™_¡¬t_ªd_unblock
(

1782 
bŒfs_fs_šfo
 *
fs_šfo
,

1783 
bŒfs_Œª§ùiÚ
 *
Œªs
)

1785 
	`wa™_ev’t
(
fs_šfo
->
Œª§ùiÚ_wa™
,

1786 
Œªs
->
¡©e
 >ð
TRANS_STATE_UNBLOCKED
 ||¿ns->
abÜ‹d
);

1787 
	}
}

1793 
	sbŒfs_async_comm™
 {

1794 
bŒfs_Œªs_hªdË
 *
	mÃwŒªs
;

1795 
wÜk_¡ruù
 
	mwÜk
;

1798 
	$do_async_comm™
(
wÜk_¡ruù
 *
wÜk
)

1800 
bŒfs_async_comm™
 *
ac
 =

1801 
	`cÚš”_of
(
wÜk
, 
bŒfs_async_comm™
, work);

1807 ià(
ac
->
ÃwŒªs
->
ty³
 & 
__TRANS_FREEZABLE
)

1808 
	`__sb_wr™”s_acquœed
(
ac
->
ÃwŒªs
->
fs_šfo
->
sb
, 
SB_FREEZE_FS
);

1810 
cu¼’t
->
jouº®_šfo
 = 
ac
->
ÃwŒªs
;

1812 
	`bŒfs_comm™_Œª§ùiÚ
(
ac
->
ÃwŒªs
);

1813 
	`kä“
(
ac
);

1814 
	}
}

1816 
	$bŒfs_comm™_Œª§ùiÚ_async
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1817 
wa™_fÜ_unblock
)

1819 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1820 
bŒfs_async_comm™
 *
ac
;

1821 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
;

1823 
ac
 = 
	`km®loc
((*ac), 
GFP_NOFS
);

1824 ià(!
ac
)

1825  -
ENOMEM
;

1827 
	`INIT_WORK
(&
ac
->
wÜk
, 
do_async_comm™
);

1828 
ac
->
ÃwŒªs
 = 
	`bŒfs_još_Œª§ùiÚ
(
Œªs
->
roÙ
);

1829 ià(
	`IS_ERR
(
ac
->
ÃwŒªs
)) {

1830 
”r
 = 
	`PTR_ERR
(
ac
->
ÃwŒªs
);

1831 
	`kä“
(
ac
);

1832  
”r
;

1836 
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

1837 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

1839 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1845 ià(
ac
->
ÃwŒªs
->
ty³
 & 
__TRANS_FREEZABLE
)

1846 
	`__sb_wr™”s_»Ëa£
(
fs_šfo
->
sb
, 
SB_FREEZE_FS
);

1848 
	`scheduË_wÜk
(&
ac
->
wÜk
);

1851 ià(
wa™_fÜ_unblock
)

1852 
	`wa™_cu¼’t_Œªs_comm™_¡¬t_ªd_unblock
(
fs_šfo
, 
cur_Œªs
);

1854 
	`wa™_cu¼’t_Œªs_comm™_¡¬t
(
fs_šfo
, 
cur_Œªs
);

1856 ià(
cu¼’t
->
jouº®_šfo
 =ð
Œªs
)

1857 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

1859 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

1861 
	}
}

1864 
	$þ—nup_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1865 
bŒfs_roÙ
 *
roÙ
, 
”r
)

1867 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1868 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

1869 
	`DEFINE_WAIT
(
wa™
);

1871 
	`WARN_ON
(
Œªs
->
u£_couÁ
 > 1);

1873 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
”r
);

1875 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1882 
	`BUG_ON
(
	`li¡_em±y
(&
cur_Œªs
->
li¡
));

1884 
	`li¡_d–_š™
(&
cur_Œªs
->
li¡
);

1885 ià(
cur_Œªs
 =ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
) {

1886 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_DOING
;

1887 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1888 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

1889 
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) == 1);

1891 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1893 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1895 
	`bŒfs_þ—nup_Úe_Œª§ùiÚ
(
Œªs
->
Œª§ùiÚ
, 
fs_šfo
);

1897 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

1898 ià(
cur_Œªs
 =ð
fs_šfo
->
ruÂšg_Œª§ùiÚ
)

1899 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

1900 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

1902 ià(
Œªs
->
ty³
 & 
__TRANS_FREEZABLE
)

1903 
	`sb_’d_štwr™e
(
fs_šfo
->
sb
);

1904 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

1905 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

1907 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
roÙ
);

1909 ià(
cu¼’t
->
jouº®_šfo
 =ð
Œªs
)

1910 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

1911 
	`bŒfs_süub_ÿnûl
(
fs_šfo
);

1913 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
Œªs
);

1914 
	}
}

1916 
šlše
 
	$bŒfs_¡¬t_d–®loc_æush
(
bŒfs_fs_šfo
 *
fs_šfo
)

1918 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FLUSHONCOMMIT
))

1919  
	`bŒfs_¡¬t_d–®loc_roÙs
(
fs_šfo
, 1, -1);

1921 
	}
}

1923 
šlše
 
	$bŒfs_wa™_d–®loc_æush
(
bŒfs_fs_šfo
 *
fs_šfo
)

1925 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
FLUSHONCOMMIT
))

1926 
	`bŒfs_wa™_Üd”ed_roÙs
(
fs_šfo
, 
U64_MAX
, 0, (
u64
)-1);

1927 
	}
}

1929 
šlše
 

1930 
	$bŒfs_wa™_³ndšg_Üd”ed
(
bŒfs_Œª§ùiÚ
 *
cur_Œªs
)

1932 
	`wa™_ev’t
(
cur_Œªs
->
³ndšg_wa™
,

1933 
	`©omic_»ad
(&
cur_Œªs
->
³ndšg_Üd”ed
) == 0);

1934 
	}
}

1936 
	$bŒfs_comm™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
)

1938 
bŒfs_fs_šfo
 *
fs_šfo
 = 
Œªs
->fs_info;

1939 
bŒfs_Œª§ùiÚ
 *
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

1940 
bŒfs_Œª§ùiÚ
 *
´ev_Œªs
 = 
NULL
;

1941 
»t
;

1944 ià(
	`uÆik–y
(
	`READ_ONCE
(
cur_Œªs
->
abÜ‹d
))) {

1945 
»t
 = 
cur_Œªs
->
abÜ‹d
;

1946 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1947  
»t
;

1953 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 0);

1954 ià(
»t
) {

1955 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1956  
»t
;

1959 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
, 
fs_šfo
);

1960 
Œªs
->
block_rsv
 = 
NULL
;

1962 
cur_Œªs
 = 
Œªs
->
Œª§ùiÚ
;

1968 
cur_Œªs
->
d–ayed_»fs
.
æushšg
 = 1;

1969 
	`smp_wmb
();

1971 ià(!
	`li¡_em±y
(&
Œªs
->
Ãw_bgs
))

1972 
	`bŒfs_ü—‹_³ndšg_block_groups
(
Œªs
, 
fs_šfo
);

1974 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, 0);

1975 ià(
»t
) {

1976 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

1977  
»t
;

1980 ià(!
	`‹¡_b™
(
BTRFS_TRANS_DIRTY_BG_RUN
, &
cur_Œªs
->
æags
)) {

1981 
run_™
 = 0;

1996 
	`mu‹x_lock
(&
fs_šfo
->
ro_block_group_mu‹x
);

1997 ià(!
	`‹¡_ªd_£t_b™
(
BTRFS_TRANS_DIRTY_BG_RUN
,

1998 &
cur_Œªs
->
æags
))

1999 
run_™
 = 1;

2000 
	`mu‹x_uÆock
(&
fs_šfo
->
ro_block_group_mu‹x
);

2002 ià(
run_™
)

2003 
»t
 = 
	`bŒfs_¡¬t_dœty_block_groups
(
Œªs
, 
fs_šfo
);

2005 ià(
»t
) {

2006 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2007  
»t
;

2010 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2011 ià(
cur_Œªs
->
¡©e
 >ð
TRANS_STATE_COMMIT_START
) {

2012 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2013 
	`»fcouÁ_šc
(&
cur_Œªs
->
u£_couÁ
);

2014 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2016 
	`wa™_fÜ_comm™
(
cur_Œªs
);

2018 ià(
	`uÆik–y
(
cur_Œªs
->
abÜ‹d
))

2019 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2021 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2023  
»t
;

2026 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_START
;

2027 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_blocked_wa™
);

2029 ià(
cur_Œªs
->
li¡
.
´ev
 !ð&
fs_šfo
->
Œªs_li¡
) {

2030 
´ev_Œªs
 = 
	`li¡_’Œy
(
cur_Œªs
->
li¡
.
´ev
,

2031 
bŒfs_Œª§ùiÚ
, 
li¡
);

2032 ià(
´ev_Œªs
->
¡©e
 !ð
TRANS_STATE_COMPLETED
) {

2033 
	`»fcouÁ_šc
(&
´ev_Œªs
->
u£_couÁ
);

2034 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2036 
	`wa™_fÜ_comm™
(
´ev_Œªs
);

2037 
»t
 = 
´ev_Œªs
->
abÜ‹d
;

2039 
	`bŒfs_put_Œª§ùiÚ
(
´ev_Œªs
);

2040 ià(
»t
)

2041 
þ—nup_Œª§ùiÚ
;

2043 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2046 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2049 
	`extwr™”_couÁ”_dec
(
cur_Œªs
, 
Œªs
->
ty³
);

2051 
»t
 = 
	`bŒfs_¡¬t_d–®loc_æush
(
fs_šfo
);

2052 ià(
»t
)

2053 
þ—nup_Œª§ùiÚ
;

2055 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

2056 ià(
»t
)

2057 
þ—nup_Œª§ùiÚ
;

2059 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

2060 
	`extwr™”_couÁ”_»ad
(
cur_Œªs
) == 0);

2063 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

2064 ià(
»t
)

2065 
þ—nup_Œª§ùiÚ
;

2067 
	`bŒfs_wa™_d–®loc_æush
(
fs_šfo
);

2069 
	`bŒfs_wa™_³ndšg_Üd”ed
(
cur_Œªs
);

2071 
	`bŒfs_süub_·u£
(
fs_šfo
);

2077 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2078 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMMIT_DOING
;

2079 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2080 
	`wa™_ev’t
(
cur_Œªs
->
wr™”_wa™
,

2081 
	`©omic_»ad
(&
cur_Œªs
->
num_wr™”s
) == 1);

2084 ià(
	`uÆik–y
(
	`READ_ONCE
(
cur_Œªs
->
abÜ‹d
))) {

2085 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2086 
süub_cÚtšue
;

2093 
	`mu‹x_lock
(&
fs_šfo
->
»loc_mu‹x
);

2100 
»t
 = 
	`ü—‹_³ndšg_¢­shÙs
(
Œªs
, 
fs_šfo
);

2101 ià(
»t
) {

2102 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2103 
süub_cÚtšue
;

2116 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

2117 ià(
»t
) {

2118 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2119 
süub_cÚtšue
;

2122 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

2123 ià(
»t
) {

2124 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2125 
süub_cÚtšue
;

2132 
	`bŒfs_as£¹_d–ayed_roÙ_em±y
(
fs_šfo
);

2134 
	`WARN_ON
(
cur_Œªs
 !ð
Œªs
->
Œª§ùiÚ
);

2149 
	`mu‹x_lock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2151 
»t
 = 
	`comm™_fs_roÙs
(
Œªs
, 
fs_šfo
);

2152 ià(
»t
) {

2153 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2154 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2155 
süub_cÚtšue
;

2162 
	`bŒfs_­¶y_³ndšg_chªges
(
fs_šfo
);

2167 
	`bŒfs_ä“_log_roÙ_Œ“
(
Œªs
, 
fs_šfo
);

2173 
»t
 = 
	`bŒfs_run_d–ayed_»fs
(
Œªs
, 
fs_šfo
, ()-1);

2174 ià(
»t
) {

2175 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2176 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2177 
süub_cÚtšue
;

2184 
»t
 = 
	`bŒfs_qgroup_accouÁ_ex‹Ás
(
Œªs
, 
fs_šfo
);

2185 ià(
»t
 < 0) {

2186 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2187 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2188 
süub_cÚtšue
;

2191 
»t
 = 
	`comm™_cowÚly_roÙs
(
Œªs
, 
fs_šfo
);

2192 ià(
»t
) {

2193 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2194 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2195 
süub_cÚtšue
;

2202 ià(
	`uÆik–y
(
	`READ_ONCE
(
cur_Œªs
->
abÜ‹d
))) {

2203 
»t
 = 
cur_Œªs
->
abÜ‹d
;

2204 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2205 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2206 
süub_cÚtšue
;

2209 
	`bŒfs_´•¬e_ex‹Á_comm™
(
fs_šfo
);

2211 
cur_Œªs
 = 
fs_šfo
->
ruÂšg_Œª§ùiÚ
;

2213 
	`bŒfs_£t_roÙ_node
(&
fs_šfo
->
Œ“_roÙ
->
roÙ_™em
,

2214 
fs_šfo
->
Œ“_roÙ
->
node
);

2215 
	`li¡_add_ž
(&
fs_šfo
->
Œ“_roÙ
->
dœty_li¡
,

2216 &
cur_Œªs
->
sw™ch_comm™s
);

2218 
	`bŒfs_£t_roÙ_node
(&
fs_šfo
->
chunk_roÙ
->
roÙ_™em
,

2219 
fs_šfo
->
chunk_roÙ
->
node
);

2220 
	`li¡_add_ž
(&
fs_šfo
->
chunk_roÙ
->
dœty_li¡
,

2221 &
cur_Œªs
->
sw™ch_comm™s
);

2223 
	`sw™ch_comm™_roÙs
(
cur_Œªs
, 
fs_šfo
);

2225 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
dœty_bgs
));

2226 
	`ASSERT
(
	`li¡_em±y
(&
cur_Œªs
->
io_bgs
));

2227 
	`upd©e_su³r_roÙs
(
fs_šfo
);

2229 
	`bŒfs_£t_su³r_log_roÙ
(
fs_šfo
->
su³r_cÝy
, 0);

2230 
	`bŒfs_£t_su³r_log_roÙ_Ëv–
(
fs_šfo
->
su³r_cÝy
, 0);

2231 
	`memýy
(
fs_šfo
->
su³r_fÜ_comm™
, fs_šfo->
su³r_cÝy
,

2232 (*
fs_šfo
->
su³r_cÝy
));

2234 
	`bŒfs_upd©e_comm™_deviû_size
(
fs_šfo
);

2235 
	`bŒfs_upd©e_comm™_deviû_by‹s_u£d
(
fs_šfo
, 
cur_Œªs
);

2237 
	`þ—r_b™
(
BTRFS_FS_LOG1_ERR
, &
fs_šfo
->
æags
);

2238 
	`þ—r_b™
(
BTRFS_FS_LOG2_ERR
, &
fs_šfo
->
æags
);

2240 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2242 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2243 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_UNBLOCKED
;

2244 
fs_šfo
->
ruÂšg_Œª§ùiÚ
 = 
NULL
;

2245 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2246 
	`mu‹x_uÆock
(&
fs_šfo
->
»loc_mu‹x
);

2248 
	`wake_up
(&
fs_šfo
->
Œª§ùiÚ_wa™
);

2250 
»t
 = 
	`bŒfs_wr™e_ªd_wa™_Œª§ùiÚ
(
Œªs
, 
fs_šfo
);

2251 ià(
»t
) {

2252 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2254 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2255 
süub_cÚtšue
;

2258 
»t
 = 
	`wr™e_®l_su³rs
(
fs_šfo
, 0);

2259 ià(
»t
) {

2260 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2261 
süub_cÚtšue
;

2268 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

2270 
	`bŒfs_fšish_ex‹Á_comm™
(
Œªs
, 
fs_šfo
);

2272 ià(
	`‹¡_b™
(
BTRFS_TRANS_HAVE_FREE_BGS
, &
cur_Œªs
->
æags
))

2273 
	`bŒfs_þ—r_¥aû_šfo_fuÎ
(
fs_šfo
);

2275 
fs_šfo
->
Ï¡_Œªs_comm™‹d
 = 
cur_Œªs
->
Œªsid
;

2280 
cur_Œªs
->
¡©e
 = 
TRANS_STATE_COMPLETED
;

2281 
	`wake_up
(&
cur_Œªs
->
comm™_wa™
);

2283 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2284 
	`li¡_d–_š™
(&
cur_Œªs
->
li¡
);

2285 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2287 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2288 
	`bŒfs_put_Œª§ùiÚ
(
cur_Œªs
);

2290 ià(
Œªs
->
ty³
 & 
__TRANS_FREEZABLE
)

2291 
	`sb_’d_štwr™e
(
fs_šfo
->
sb
);

2293 
	`Œaû_bŒfs_Œª§ùiÚ_comm™
(
Œªs
->
roÙ
);

2295 
	`bŒfs_süub_cÚtšue
(
fs_šfo
);

2297 ià(
cu¼’t
->
jouº®_šfo
 =ð
Œªs
)

2298 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

2300 
	`kmem_ÿche_ä“
(
bŒfs_Œªs_hªdË_ÿch•
, 
Œªs
);

2306 ià(
cu¼’t
 !ð
fs_šfo
->
Œª§ùiÚ_kth»ad
 &&

2307 
cu¼’t
 !ð
fs_šfo
->
þ—Ãr_kth»ad
 &&

2308 !
	`‹¡_b™
(
BTRFS_FS_FROZEN
, &
fs_šfo
->
æags
))

2309 
	`bŒfs_run_d–ayed_uts
(
fs_šfo
);

2311  
»t
;

2313 
süub_cÚtšue
:

2314 
	`bŒfs_süub_cÚtšue
(
fs_šfo
);

2315 
þ—nup_Œª§ùiÚ
:

2316 
	`bŒfs_Œªs_»Ëa£_m‘ad©a
(
Œªs
, 
fs_šfo
);

2317 
	`bŒfs_Œªs_»Ëa£_chunk_m‘ad©a
(
Œªs
);

2318 
Œªs
->
block_rsv
 = 
NULL
;

2319 
	`bŒfs_w¬n
(
fs_šfo
, "Skipping commit of‡bortedransaction.");

2320 ià(
cu¼’t
->
jouº®_šfo
 =ð
Œªs
)

2321 
cu¼’t
->
jouº®_šfo
 = 
NULL
;

2322 
	`þ—nup_Œª§ùiÚ
(
Œªs
,¿ns->
roÙ
, 
»t
);

2324  
»t
;

2325 
	}
}

2337 
	$bŒfs_þ—n_Úe_d–‘ed_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
)

2339 
»t
;

2340 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2342 
	`¥š_lock
(&
fs_šfo
->
Œªs_lock
);

2343 ià(
	`li¡_em±y
(&
fs_šfo
->
d—d_roÙs
)) {

2344 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2347 
roÙ
 = 
	`li¡_fœ¡_’Œy
(&
fs_šfo
->
d—d_roÙs
,

2348 
bŒfs_roÙ
, 
roÙ_li¡
);

2349 
	`li¡_d–_š™
(&
roÙ
->
roÙ_li¡
);

2350 
	`¥š_uÆock
(&
fs_šfo
->
Œªs_lock
);

2352 
	`bŒfs_debug
(
fs_šfo
, "þ—Ã¸»movšg %Îu", 
roÙ
->
objeùid
);

2354 
	`bŒfs_kžl_®l_d–ayed_nodes
(
roÙ
);

2356 ià(
	`bŒfs_h—d”_back»f_»v
(
roÙ
->
node
) <

2357 
BTRFS_MIXED_BACKREF_REV
)

2358 
»t
 = 
	`bŒfs_drÝ_¢­shÙ
(
roÙ
, 
NULL
, 0, 0);

2360 
»t
 = 
	`bŒfs_drÝ_¢­shÙ
(
roÙ
, 
NULL
, 1, 0);

2362  (
»t
 < 0) ? 0 : 1;

2363 
	}
}

2365 
	$bŒfs_­¶y_³ndšg_chªges
(
bŒfs_fs_šfo
 *
fs_šfo
)

2367 
´ev
;

2368 
b™
;

2370 
´ev
 = 
	`xchg
(&
fs_šfo
->
³ndšg_chªges
, 0);

2371 ià(!
´ev
)

2374 
b™
 = 1 << 
BTRFS_PENDING_SET_INODE_MAP_CACHE
;

2375 ià(
´ev
 & 
b™
)

2376 
	`bŒfs_£t_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
INODE_MAP_CACHE
);

2377 
´ev
 &ð~
b™
;

2379 
b™
 = 1 << 
BTRFS_PENDING_CLEAR_INODE_MAP_CACHE
;

2380 ià(
´ev
 & 
b™
)

2381 
	`bŒfs_þ—r_Ýt
(
fs_šfo
->
mouÁ_Ýt
, 
INODE_MAP_CACHE
);

2382 
´ev
 &ð~
b™
;

2384 
b™
 = 1 << 
BTRFS_PENDING_COMMIT
;

2385 ià(
´ev
 & 
b™
)

2386 
	`bŒfs_debug
(
fs_šfo
, "pending commit done");

2387 
´ev
 &ð~
b™
;

2389 ià(
´ev
)

2390 
	`bŒfs_w¬n
(
fs_šfo
,

2391 "unknowÀ³ndšg chªge Ëá 0x%lx, ignÜšg", 
´ev
);

2392 
	}
}

	@transaction.h

19 #iâdeà
__BTRFS_TRANSACTION__


20 
	#__BTRFS_TRANSACTION__


	)

22 
	~<lšux/»fcouÁ.h
>

23 
	~"bŒfs_šode.h
"

24 
	~"d–ayed-»f.h
"

25 
	~"ù»e.h
"

27 
	ebŒfs_Œªs_¡©e
 {

28 
	mTRANS_STATE_RUNNING
 = 0,

29 
	mTRANS_STATE_BLOCKED
 = 1,

30 
	mTRANS_STATE_COMMIT_START
 = 2,

31 
	mTRANS_STATE_COMMIT_DOING
 = 3,

32 
	mTRANS_STATE_UNBLOCKED
 = 4,

33 
	mTRANS_STATE_COMPLETED
 = 5,

34 
	mTRANS_STATE_MAX
 = 6,

37 
	#BTRFS_TRANS_HAVE_FREE_BGS
 0

	)

38 
	#BTRFS_TRANS_DIRTY_BG_RUN
 1

	)

39 
	#BTRFS_TRANS_CACHE_ENOSPC
 2

	)

41 
	sbŒfs_Œª§ùiÚ
 {

42 
u64
 
	mŒªsid
;

48 
©omic_t
 
	mnum_extwr™”s
;

53 
©omic_t
 
	mnum_wr™”s
;

54 
»fcouÁ_t
 
	mu£_couÁ
;

55 
©omic_t
 
	m³ndšg_Üd”ed
;

57 
	mæags
;

60 
bŒfs_Œªs_¡©e
 
	m¡©e
;

61 
li¡_h—d
 
	mli¡
;

62 
ex‹Á_io_Œ“
 
	mdœty_·ges
;

63 
	m¡¬t_time
;

64 
wa™_queue_h—d_t
 
	mwr™”_wa™
;

65 
wa™_queue_h—d_t
 
	mcomm™_wa™
;

66 
wa™_queue_h—d_t
 
	m³ndšg_wa™
;

67 
li¡_h—d
 
	m³ndšg_¢­shÙs
;

68 
li¡_h—d
 
	m³ndšg_chunks
;

69 
li¡_h—d
 
	msw™ch_comm™s
;

70 
li¡_h—d
 
	mdœty_bgs
;

71 
li¡_h—d
 
	mio_bgs
;

72 
li¡_h—d
 
	mdrÝ³d_roÙs
;

73 
u64
 
	mnum_dœty_bgs
;

80 
mu‹x
 
	mÿche_wr™e_mu‹x
;

81 
¥šlock_t
 
	mdœty_bgs_lock
;

83 
li¡_h—d
 
	md–‘ed_bgs
;

84 
¥šlock_t
 
	mdrÝ³d_roÙs_lock
;

85 
bŒfs_d–ayed_»f_roÙ
 
	md–ayed_»fs
;

86 
	mabÜ‹d
;

87 
bŒfs_fs_šfo
 *
	mfs_šfo
;

90 
	#__TRANS_FREEZABLE
 (1U << 0)

	)

92 
	#__TRANS_USERSPACE
 (1U << 8)

	)

93 
	#__TRANS_START
 (1U << 9)

	)

94 
	#__TRANS_ATTACH
 (1U << 10)

	)

95 
	#__TRANS_JOIN
 (1U << 11)

	)

96 
	#__TRANS_JOIN_NOLOCK
 (1U << 12)

	)

97 
	#__TRANS_DUMMY
 (1U << 13)

	)

99 
	#TRANS_USERSPACE
 (
__TRANS_USERSPACE
 | 
__TRANS_FREEZABLE
)

	)

100 
	#TRANS_START
 (
__TRANS_START
 | 
__TRANS_FREEZABLE
)

	)

101 
	#TRANS_ATTACH
 (
__TRANS_ATTACH
)

	)

102 
	#TRANS_JOIN
 (
__TRANS_JOIN
 | 
__TRANS_FREEZABLE
)

	)

103 
	#TRANS_JOIN_NOLOCK
 (
__TRANS_JOIN_NOLOCK
)

	)

105 
	#TRANS_EXTWRITERS
 (
__TRANS_USERSPACE
 | 
__TRANS_START
 | \

106 
__TRANS_ATTACH
)

	)

108 
	#BTRFS_SEND_TRANS_STUB
 ((*)1)

	)

110 
	sbŒfs_Œªs_hªdË
 {

111 
u64
 
	mŒªsid
;

112 
u64
 
	mby‹s_»£rved
;

113 
u64
 
	mchunk_by‹s_»£rved
;

114 
	mu£_couÁ
;

115 
	mblocks_»£rved
;

116 
	md–ayed_»f_upd©es
;

117 
bŒfs_Œª§ùiÚ
 *
	mŒª§ùiÚ
;

118 
bŒfs_block_rsv
 *
	mblock_rsv
;

119 
bŒfs_block_rsv
 *
	mÜig_rsv
;

120 
	mabÜ‹d
;

121 
	maddšg_csums
;

122 
boÞ
 
	m®loÿtšg_chunk
;

123 
boÞ
 
	mÿn_æush_³ndšg_bgs
;

124 
boÞ
 
	m»loc_»£rved
;

125 
boÞ
 
	msync
;

126 
boÞ
 
	mdœty
;

127 
	mty³
;

128 
bŒfs_roÙ
 *
	mroÙ
;

129 
bŒfs_fs_šfo
 *
	mfs_šfo
;

130 
li¡_h—d
 
	mÃw_bgs
;

133 
	sbŒfs_³ndšg_¢­shÙ
 {

134 
d’Œy
 *
	md’Œy
;

135 
šode
 *
	mdœ
;

136 
bŒfs_roÙ
 *
	mroÙ
;

137 
bŒfs_roÙ_™em
 *
	mroÙ_™em
;

138 
bŒfs_roÙ
 *
	m¢­
;

139 
bŒfs_qgroup_šh”™
 *
	mšh”™
;

140 
bŒfs_·th
 *
	m·th
;

142 
bŒfs_block_rsv
 
	mblock_rsv
;

143 
u64
 
	mqgroup_»£rved
;

145 
	m”rÜ
;

146 
boÞ
 
	m»adÚly
;

147 
li¡_h—d
 
	mli¡
;

150 
šlše
 
	$bŒfs_£t_šode_Ï¡_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

151 
šode
 *inode)

153 
	`¥š_lock
(&
	`BTRFS_I
(
šode
)->
lock
);

154 
	`BTRFS_I
(
šode
)->
Ï¡_Œªs
 = 
Œªs
->
Œª§ùiÚ
->
Œªsid
;

155 
	`BTRFS_I
(
šode
)->
Ï¡_sub_Œªs
 = BTRFS_I(šode)->
roÙ
->
log_Œªsid
;

156 
	`BTRFS_I
(
šode
)->
Ï¡_log_comm™
 = BTRFS_I(šode)->
roÙ
->last_log_commit;

157 
	`¥š_uÆock
(&
	`BTRFS_I
(
šode
)->
lock
);

158 
	}
}

164 
šlše
 
	$bŒfs_£t_sk_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
,

165 
u64
 
qgroupid
)

167 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

169 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

170 
	`WARN_ON
(
d–ayed_»fs
->
qgroup_to_sk
);

171 
d–ayed_»fs
->
qgroup_to_sk
 = 
qgroupid
;

172 
	}
}

174 
šlše
 
	$bŒfs_þ—r_sk_qgroup
(
bŒfs_Œªs_hªdË
 *
Œªs
)

176 
bŒfs_d–ayed_»f_roÙ
 *
d–ayed_»fs
;

178 
d–ayed_»fs
 = &
Œªs
->
Œª§ùiÚ
->delayed_refs;

179 
	`WARN_ON
(!
d–ayed_»fs
->
qgroup_to_sk
);

180 
d–ayed_»fs
->
qgroup_to_sk
 = 0;

181 
	}
}

183 
bŒfs_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
);

184 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
,

185 
num_™ems
);

186 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œª§ùiÚ_çÎback_glob®_rsv
(

187 
bŒfs_roÙ
 *
roÙ
,

188 
num_™ems
,

189 
mš_çùÜ
);

190 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_Œª§ùiÚ_læush
(

191 
bŒfs_roÙ
 *
roÙ
,

192 
num_™ems
);

193 
bŒfs_Œªs_hªdË
 *
bŒfs_još_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
);

194 
bŒfs_Œªs_hªdË
 *
bŒfs_još_Œª§ùiÚ_nÞock
(
bŒfs_roÙ
 *
roÙ
);

195 
bŒfs_Œªs_hªdË
 *
bŒfs_©ch_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
);

196 
bŒfs_Œªs_hªdË
 *
bŒfs_©ch_Œª§ùiÚ_b¬r›r
(

197 
bŒfs_roÙ
 *
roÙ
);

198 
bŒfs_Œªs_hªdË
 *
bŒfs_¡¬t_ioùl_Œª§ùiÚ
(
bŒfs_roÙ
 *
roÙ
);

199 
bŒfs_wa™_fÜ_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
Œªsid
);

201 
bŒfs_add_d—d_roÙ
(
bŒfs_roÙ
 *
roÙ
);

202 
bŒfs_deäag_roÙ
(
bŒfs_roÙ
 *
roÙ
);

203 
bŒfs_þ—n_Úe_d–‘ed_¢­shÙ
(
bŒfs_roÙ
 *
roÙ
);

204 
bŒfs_comm™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
);

205 
bŒfs_comm™_Œª§ùiÚ_async
(
bŒfs_Œªs_hªdË
 *
Œªs
,

206 
wa™_fÜ_unblock
);

207 
bŒfs_’d_Œª§ùiÚ_thrÙŽe
(
bŒfs_Œªs_hªdË
 *
Œªs
);

208 
bŒfs_should_’d_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
);

209 
bŒfs_thrÙŽe
(
bŒfs_fs_šfo
 *
fs_šfo
);

210 
bŒfs_»cÜd_roÙ_š_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

211 
bŒfs_roÙ
 *
roÙ
);

212 
bŒfs_wr™e_m¬ked_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

213 
ex‹Á_io_Œ“
 *
dœty_·ges
, 
m¬k
);

214 
bŒfs_wa™_ex‹Ás
(
bŒfs_fs_šfo
 *
fs_šfo
,

215 
ex‹Á_io_Œ“
 *
dœty_·ges
);

216 
bŒfs_wa™_Œ“_log_ex‹Ás
(
bŒfs_roÙ
 *
roÙ
, 
m¬k
);

217 
bŒfs_Œª§ùiÚ_blocked
(
bŒfs_fs_šfo
 *
šfo
);

218 
bŒfs_Œª§ùiÚ_š_comm™
(
bŒfs_fs_šfo
 *
šfo
);

219 
bŒfs_put_Œª§ùiÚ
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
);

220 
bŒfs_­¶y_³ndšg_chªges
(
bŒfs_fs_šfo
 *
fs_šfo
);

221 
bŒfs_add_drÝ³d_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

222 
bŒfs_roÙ
 *
roÙ
);

	@tree-defrag.c

19 
	~<lšux/sched.h
>

20 
	~"ù»e.h
"

21 
	~"disk-io.h
"

22 
	~"´št-Œ“.h
"

23 
	~"Œª§ùiÚ.h
"

24 
	~"lockšg.h
"

32 
	$bŒfs_deäag_Ëaves
(
bŒfs_Œªs_hªdË
 *
Œªs
,

33 
bŒfs_roÙ
 *
roÙ
)

35 
bŒfs_·th
 *
·th
 = 
NULL
;

36 
bŒfs_key
 
key
;

37 
»t
 = 0;

38 
w»t
;

39 
Ëv–
;

40 
Ãxt_key_»t
 = 0;

41 
u64
 
Ï¡_»t
 = 0;

42 
u64
 
mš_Œªs
 = 0;

44 ià(
roÙ
->
fs_šfo
->
ex‹Á_roÙ
 ==„oot) {

49 
out
;

52 ià(!
	`‹¡_b™
(
BTRFS_ROOT_REF_COWS
, &
roÙ
->
¡©e
))

53 
out
;

55 
·th
 = 
	`bŒfs_®loc_·th
();

56 ià(!
·th
)

57  -
ENOMEM
;

59 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
roÙ
->
node
);

61 ià(
Ëv–
 == 0)

62 
out
;

64 ià(
roÙ
->
deäag_´og»ss
.
objeùid
 == 0) {

65 
ex‹Á_bufãr
 *
roÙ_node
;

66 
u32
 
Ä™ems
;

68 
roÙ_node
 = 
	`bŒfs_lock_roÙ_node
(
roÙ
);

69 
	`bŒfs_£t_lock_blockšg
(
roÙ_node
);

70 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
roÙ_node
);

71 
roÙ
->
deäag_max
.
objeùid
 = 0;

73 
	`bŒfs_node_key_to_ýu
(
roÙ_node
, &
roÙ
->
deäag_max
,

74 
Ä™ems
 - 1);

75 
	`bŒfs_Œ“_uÆock
(
roÙ_node
);

76 
	`ä“_ex‹Á_bufãr
(
roÙ_node
);

77 
	`mem£t
(&
key
, 0, (key));

79 
	`memýy
(&
key
, &
roÙ
->
deäag_´og»ss
, (key));

82 
·th
->
k“p_locks
 = 1;

84 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 
mš_Œªs
);

85 ià(
»t
 < 0)

86 
out
;

87 ià(
»t
 > 0) {

88 
»t
 = 0;

89 
out
;

91 
	`bŒfs_»Ëa£_·th
(
·th
);

97 
·th
->
lowe¡_Ëv–
 = 1;

98 
w»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

100 ià(
w»t
 < 0) {

101 
»t
 = 
w»t
;

102 
out
;

104 ià(!
·th
->
nodes
[1]) {

105 
»t
 = 0;

106 
out
;

113 
	`BUG_ON
(
·th
->
locks
[1] == 0);

114 
»t
 = 
	`bŒfs_»®loc_node
(
Œªs
, 
roÙ
,

115 
·th
->
nodes
[1], 0,

116 &
Ï¡_»t
,

117 &
roÙ
->
deäag_´og»ss
);

118 ià(
»t
) {

119 
	`WARN_ON
(
»t
 =ð-
EAGAIN
);

120 
out
;

131 
·th
->
¦Ùs
[1] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[1]);

132 
Ãxt_key_»t
 = 
	`bŒfs_fšd_Ãxt_key
(
roÙ
, 
·th
, &
key
, 1,

133 
mš_Œªs
);

134 ià(
Ãxt_key_»t
 == 0) {

135 
	`memýy
(&
roÙ
->
deäag_´og»ss
, &
key
, (key));

136 
»t
 = -
EAGAIN
;

138 
out
:

139 
	`bŒfs_ä“_·th
(
·th
);

140 ià(
»t
 =ð-
EAGAIN
) {

141 ià(
roÙ
->
deäag_max
.
objeùid
 >„oÙ->
deäag_´og»ss
.objectid)

142 
dÚe
;

143 ià(
roÙ
->
deäag_max
.
ty³
 >„oÙ->
deäag_´og»ss
.type)

144 
dÚe
;

145 ià(
roÙ
->
deäag_max
.
off£t
 >„oÙ->
deäag_´og»ss
.offset)

146 
dÚe
;

147 
»t
 = 0;

149 
dÚe
:

150 ià(
»t
 !ð-
EAGAIN
) {

151 
	`mem£t
(&
roÙ
->
deäag_´og»ss
, 0,

152 (
roÙ
->
deäag_´og»ss
));

153 
roÙ
->
deäag_Œªs_¡¬t
 = 
Œªs
->
Œªsid
;

155  
»t
;

156 
	}
}

	@tree-log.c

19 
	~<lšux/sched.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/blkdev.h
>

22 
	~<lšux/li¡_sÜt.h
>

23 
	~"Œ“-log.h
"

24 
	~"disk-io.h
"

25 
	~"lockšg.h
"

26 
	~"´št-Œ“.h
"

27 
	~"back»f.h
"

28 
	~"hash.h
"

29 
	~"com´essiÚ.h
"

30 
	~"qgroup.h
"

38 
	#LOG_INODE_ALL
 0

	)

39 
	#LOG_INODE_EXISTS
 1

	)

40 
	#LOG_OTHER_INODE
 2

	)

94 
	#LOG_WALK_PIN_ONLY
 0

	)

95 
	#LOG_WALK_REPLAY_INODES
 1

	)

96 
	#LOG_WALK_REPLAY_DIR_INDEX
 2

	)

97 
	#LOG_WALK_REPLAY_ALL
 3

	)

99 
bŒfs_log_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

100 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

101 
šode_Úly
,

102 cÚ¡ 
loff_t
 
¡¬t
,

103 cÚ¡ 
loff_t
 
’d
,

104 
bŒfs_log_ùx
 *
ùx
);

105 
lšk_to_fixup_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

106 
bŒfs_roÙ
 *
roÙ
,

107 
bŒfs_·th
 *
·th
, 
u64
 
objeùid
);

108 
nošlše
 
»¶ay_dœ_d–‘es
(
bŒfs_Œªs_hªdË
 *
Œªs
,

109 
bŒfs_roÙ
 *
roÙ
,

110 
bŒfs_roÙ
 *
log
,

111 
bŒfs_·th
 *
·th
,

112 
u64
 
dœid
, 
d–_®l
);

142 
	$¡¬t_log_Œªs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

143 
bŒfs_roÙ
 *
roÙ
,

144 
bŒfs_log_ùx
 *
ùx
)

146 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

147 
»t
 = 0;

149 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

151 ià(
roÙ
->
log_roÙ
) {

152 ià(
	`bŒfs_Ãed_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
)) {

153 
»t
 = -
EAGAIN
;

154 
out
;

157 ià(!
roÙ
->
log_¡¬t_pid
) {

158 
	`þ—r_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
);

159 
roÙ
->
log_¡¬t_pid
 = 
cu¼’t
->
pid
;

160 } ià(
roÙ
->
log_¡¬t_pid
 !ð
cu¼’t
->
pid
) {

161 
	`£t_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
);

164 
	`mu‹x_lock
(&
fs_šfo
->
Œ“_log_mu‹x
);

165 ià(!
fs_šfo
->
log_roÙ_Œ“
)

166 
»t
 = 
	`bŒfs_š™_log_roÙ_Œ“
(
Œªs
, 
fs_šfo
);

167 
	`mu‹x_uÆock
(&
fs_šfo
->
Œ“_log_mu‹x
);

168 ià(
»t
)

169 
out
;

171 
»t
 = 
	`bŒfs_add_log_Œ“
(
Œªs
, 
roÙ
);

172 ià(
»t
)

173 
out
;

175 
	`þ—r_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
);

176 
roÙ
->
log_¡¬t_pid
 = 
cu¼’t
->
pid
;

179 
	`©omic_šc
(&
roÙ
->
log_b©ch
);

180 
	`©omic_šc
(&
roÙ
->
log_wr™”s
);

181 ià(
ùx
) {

182 
šdex
 = 
roÙ
->
log_Œªsid
 % 2;

183 
	`li¡_add_ž
(&
ùx
->
li¡
, &
roÙ
->
log_ùxs
[
šdex
]);

184 
ùx
->
log_Œªsid
 = 
roÙ
->log_transid;

187 
out
:

188 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

189  
»t
;

190 
	}
}

197 
	$još_ruÂšg_log_Œªs
(
bŒfs_roÙ
 *
roÙ
)

199 
»t
 = -
ENOENT
;

201 
	`smp_mb
();

202 ià(!
roÙ
->
log_roÙ
)

203  -
ENOENT
;

205 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

206 ià(
roÙ
->
log_roÙ
) {

207 
»t
 = 0;

208 
	`©omic_šc
(&
roÙ
->
log_wr™”s
);

210 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

211  
»t
;

212 
	}
}

219 
	$bŒfs_pš_log_Œªs
(
bŒfs_roÙ
 *
roÙ
)

221 
»t
 = -
ENOENT
;

223 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

224 
	`©omic_šc
(&
roÙ
->
log_wr™”s
);

225 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

226  
»t
;

227 
	}
}

233 
	$bŒfs_’d_log_Œªs
(
bŒfs_roÙ
 *
roÙ
)

235 ià(
	`©omic_dec_ªd_‹¡
(&
roÙ
->
log_wr™”s
)) {

239 ià(
	`wa™queue_aùive
(&
roÙ
->
log_wr™”_wa™
))

240 
	`wake_up
(&
roÙ
->
log_wr™”_wa™
);

242 
	}
}

251 
	sw®k_cÚŒÞ
 {

255 
	mä“
;

260 
	mwr™e
;

265 
	mwa™
;

270 
	mpš
;

273 
	m¡age
;

276 
bŒfs_roÙ
 *
	m»¶ay_de¡
;

279 
bŒfs_Œªs_hªdË
 *
	mŒªs
;

286 (*
	m´oûss_func
)(
bŒfs_roÙ
 *
	mlog
, 
ex‹Á_bufãr
 *
	meb
,

287 
w®k_cÚŒÞ
 *
	mwc
, 
u64
 
	mg’
);

293 
	$´oûss_Úe_bufãr
(
bŒfs_roÙ
 *
log
,

294 
ex‹Á_bufãr
 *
eb
,

295 
w®k_cÚŒÞ
 *
wc
, 
u64
 
g’
)

297 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log
->fs_info;

298 
»t
 = 0;

304 ià(
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
MIXED_GROUPS
)) {

305 
»t
 = 
	`bŒfs_»ad_bufãr
(
eb
, 
g’
);

306 ià(
»t
)

307  
»t
;

310 ià(
wc
->
pš
)

311 
»t
 = 
	`bŒfs_pš_ex‹Á_fÜ_log_»¶ay
(
fs_šfo
, 
eb
->
¡¬t
,

312 
eb
->
Ën
);

314 ià(!
»t
 && 
	`bŒfs_bufãr_u±od©e
(
eb
, 
g’
, 0)) {

315 ià(
wc
->
pš
 && 
	`bŒfs_h—d”_Ëv–
(
eb
) == 0)

316 
»t
 = 
	`bŒfs_exþude_logged_ex‹Ás
(
fs_šfo
, 
eb
);

317 ià(
wc
->
wr™e
)

318 
	`bŒfs_wr™e_Œ“_block
(
eb
);

319 ià(
wc
->
wa™
)

320 
	`bŒfs_wa™_Œ“_block_wr™eback
(
eb
);

322  
»t
;

323 
	}
}

339 
nošlše
 
	$ov”wr™e_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

340 
bŒfs_roÙ
 *
roÙ
,

341 
bŒfs_·th
 *
·th
,

342 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

343 
bŒfs_key
 *
key
)

345 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

346 
»t
;

347 
u32
 
™em_size
;

348 
u64
 
§ved_i_size
 = 0;

349 
§ve_Þd_i_size
 = 0;

350 
¤c_±r
;

351 
d¡_±r
;

352 
ov”wr™e_roÙ
 = 0;

353 
boÞ
 
šode_™em
 = 
key
->
ty³
 =ð
BTRFS_INODE_ITEM_KEY
;

355 ià(
roÙ
->
roÙ_key
.
objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
)

356 
ov”wr™e_roÙ
 = 1;

358 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

359 
¤c_±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

362 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
key
, 
·th
, 0, 0);

363 ià(
»t
 < 0)

364  
»t
;

366 ià(
»t
 == 0) {

367 *
¤c_cÝy
;

368 *
d¡_cÝy
;

369 
u32
 
d¡_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],

370 
·th
->
¦Ùs
[0]);

371 ià(
d¡_size
 !ð
™em_size
)

372 
š£¹
;

374 ià(
™em_size
 == 0) {

375 
	`bŒfs_»Ëa£_·th
(
·th
);

378 
d¡_cÝy
 = 
	`km®loc
(
™em_size
, 
GFP_NOFS
);

379 
¤c_cÝy
 = 
	`km®loc
(
™em_size
, 
GFP_NOFS
);

380 ià(!
d¡_cÝy
 || !
¤c_cÝy
) {

381 
	`bŒfs_»Ëa£_·th
(
·th
);

382 
	`kä“
(
d¡_cÝy
);

383 
	`kä“
(
¤c_cÝy
);

384  -
ENOMEM
;

387 
	`»ad_ex‹Á_bufãr
(
eb
, 
¤c_cÝy
, 
¤c_±r
, 
™em_size
);

389 
d¡_±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

390 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
d¡_cÝy
, 
d¡_±r
,

391 
™em_size
);

392 
»t
 = 
	`memcmp
(
d¡_cÝy
, 
¤c_cÝy
, 
™em_size
);

394 
	`kä“
(
d¡_cÝy
);

395 
	`kä“
(
¤c_cÝy
);

402 ià(
»t
 == 0) {

403 
	`bŒfs_»Ëa£_·th
(
·th
);

411 ià(
šode_™em
) {

412 
bŒfs_šode_™em
 *
™em
;

413 
u64
 
nby‹s
;

414 
u32
 
mode
;

416 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

417 
bŒfs_šode_™em
);

418 
nby‹s
 = 
	`bŒfs_šode_nby‹s
(
·th
->
nodes
[0], 
™em
);

419 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
,

420 
bŒfs_šode_™em
);

421 
	`bŒfs_£t_šode_nby‹s
(
eb
, 
™em
, 
nby‹s
);

428 
mode
 = 
	`bŒfs_šode_mode
(
eb
, 
™em
);

429 ià(
	`S_ISDIR
(
mode
))

430 
	`bŒfs_£t_šode_size
(
eb
, 
™em
, 0);

432 } ià(
šode_™em
) {

433 
bŒfs_šode_™em
 *
™em
;

434 
u32
 
mode
;

440 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_šode_™em
);

441 
	`bŒfs_£t_šode_nby‹s
(
eb
, 
™em
, 0);

448 
mode
 = 
	`bŒfs_šode_mode
(
eb
, 
™em
);

449 ià(
	`S_ISDIR
(
mode
))

450 
	`bŒfs_£t_šode_size
(
eb
, 
™em
, 0);

452 
š£¹
:

453 
	`bŒfs_»Ëa£_·th
(
·th
);

455 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 1;

456 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
,

457 
key
, 
™em_size
);

458 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 0;

461 ià(
»t
 =ð-
EEXIST
 ||„‘ =ð-
EOVERFLOW
) {

462 
u32
 
found_size
;

463 
found_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],

464 
·th
->
¦Ùs
[0]);

465 ià(
found_size
 > 
™em_size
)

466 
	`bŒfs_Œunÿ‹_™em
(
fs_šfo
, 
·th
, 
™em_size
, 1);

467 ià(
found_size
 < 
™em_size
)

468 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
,

469 
™em_size
 - 
found_size
);

470 } ià(
»t
) {

471  
»t
;

473 
d¡_±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

474 
·th
->
¦Ùs
[0]);

485 ià(
key
->
ty³
 =ð
BTRFS_INODE_ITEM_KEY
 && 
»t
 =ð-
EEXIST
) {

486 
bŒfs_šode_™em
 *
¤c_™em
;

487 
bŒfs_šode_™em
 *
d¡_™em
;

489 
¤c_™em
 = (
bŒfs_šode_™em
 *)
¤c_±r
;

490 
d¡_™em
 = (
bŒfs_šode_™em
 *)
d¡_±r
;

492 ià(
	`bŒfs_šode_g’”©iÚ
(
eb
, 
¤c_™em
) == 0) {

493 
ex‹Á_bufãr
 *
d¡_eb
 = 
·th
->
nodes
[0];

494 cÚ¡ 
u64
 
šo_size
 = 
	`bŒfs_šode_size
(
eb
, 
¤c_™em
);

503 ià(
	`S_ISREG
(
	`bŒfs_šode_mode
(
eb
, 
¤c_™em
)) &&

504 
	`S_ISREG
(
	`bŒfs_šode_mode
(
d¡_eb
, 
d¡_™em
)) &&

505 
šo_size
 != 0) {

506 
bŒfs_m­_tok’
 
tok’
;

508 
	`bŒfs_š™_m­_tok’
(&
tok’
);

509 
	`bŒfs_£t_tok’_šode_size
(
d¡_eb
, 
d¡_™em
,

510 
šo_size
, &
tok’
);

512 
no_cÝy
;

515 ià(
ov”wr™e_roÙ
 &&

516 
	`S_ISDIR
(
	`bŒfs_šode_mode
(
eb
, 
¤c_™em
)) &&

517 
	`S_ISDIR
(
	`bŒfs_šode_mode
(
·th
->
nodes
[0], 
d¡_™em
))) {

518 
§ve_Þd_i_size
 = 1;

519 
§ved_i_size
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0],

520 
d¡_™em
);

524 
	`cÝy_ex‹Á_bufãr
(
·th
->
nodes
[0], 
eb
, 
d¡_±r
,

525 
¤c_±r
, 
™em_size
);

527 ià(
§ve_Þd_i_size
) {

528 
bŒfs_šode_™em
 *
d¡_™em
;

529 
d¡_™em
 = (
bŒfs_šode_™em
 *)
d¡_±r
;

530 
	`bŒfs_£t_šode_size
(
·th
->
nodes
[0], 
d¡_™em
, 
§ved_i_size
);

534 ià(
key
->
ty³
 =ð
BTRFS_INODE_ITEM_KEY
) {

535 
bŒfs_šode_™em
 *
d¡_™em
;

536 
d¡_™em
 = (
bŒfs_šode_™em
 *)
d¡_±r
;

537 ià(
	`bŒfs_šode_g’”©iÚ
(
·th
->
nodes
[0], 
d¡_™em
) == 0) {

538 
	`bŒfs_£t_šode_g’”©iÚ
(
·th
->
nodes
[0], 
d¡_™em
,

539 
Œªs
->
Œªsid
);

542 
no_cÝy
:

543 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

544 
	`bŒfs_»Ëa£_·th
(
·th
);

546 
	}
}

552 
nošlše
 
šode
 *
	$»ad_Úe_šode
(
bŒfs_roÙ
 *
roÙ
,

553 
u64
 
objeùid
)

555 
bŒfs_key
 
key
;

556 
šode
 *inode;

558 
key
.
objeùid
 = objectid;

559 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

560 
key
.
off£t
 = 0;

561 
šode
 = 
	`bŒfs_ig‘
(
roÙ
->
fs_šfo
->
sb
, &
key
,„oÙ, 
NULL
);

562 ià(
	`IS_ERR
(
šode
)) {

563 
šode
 = 
NULL
;

564 } ià(
	`is_bad_šode
(
šode
)) {

565 
	`ut
(
šode
);

566 
šode
 = 
NULL
;

568  
šode
;

569 
	}
}

583 
nošlše
 
	$»¶ay_Úe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

584 
bŒfs_roÙ
 *
roÙ
,

585 
bŒfs_·th
 *
·th
,

586 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

587 
bŒfs_key
 *
key
)

589 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

590 
found_ty³
;

591 
u64
 
ex‹Á_’d
;

592 
u64
 
¡¬t
 = 
key
->
off£t
;

593 
u64
 
nby‹s
 = 0;

594 
bŒfs_fže_ex‹Á_™em
 *
™em
;

595 
šode
 *šodð
NULL
;

596 
size
;

597 
»t
 = 0;

599 
™em
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
, 
bŒfs_fže_ex‹Á_™em
);

600 
found_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
eb
, 
™em
);

602 ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

603 
found_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

604 
nby‹s
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
eb
, 
™em
);

605 
ex‹Á_’d
 = 
¡¬t
 + 
nby‹s
;

611 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
™em
) == 0)

612 
nby‹s
 = 0;

613 } ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

614 
size
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
eb
, 
¦Ù
, 
™em
);

615 
nby‹s
 = 
	`bŒfs_fže_ex‹Á_¿m_by‹s
(
eb
, 
™em
);

616 
ex‹Á_’d
 = 
	`ALIGN
(
¡¬t
 + 
size
,

617 
fs_šfo
->
£ùÜsize
);

619 
»t
 = 0;

620 
out
;

623 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
->
objeùid
);

624 ià(!
šode
) {

625 
»t
 = -
EIO
;

626 
out
;

634 
»t
 = 
	`bŒfs_lookup_fže_ex‹Á
(
Œªs
, 
roÙ
, 
·th
,

635 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
¡¬t
, 0);

637 ià(
»t
 == 0 &&

638 (
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

639 
found_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
)) {

640 
bŒfs_fže_ex‹Á_™em
 
cmp1
;

641 
bŒfs_fže_ex‹Á_™em
 
cmp2
;

642 
bŒfs_fže_ex‹Á_™em
 *
exi¡šg
;

643 
ex‹Á_bufãr
 *
Ëaf
;

645 
Ëaf
 = 
·th
->
nodes
[0];

646 
exi¡šg
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

647 
bŒfs_fže_ex‹Á_™em
);

649 
	`»ad_ex‹Á_bufãr
(
eb
, &
cmp1
, ()
™em
,

650 (
cmp1
));

651 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
cmp2
, ()
exi¡šg
,

652 (
cmp2
));

658 ià(
	`memcmp
(&
cmp1
, &
cmp2
, (cmp1)) == 0) {

659 
	`bŒfs_»Ëa£_·th
(
·th
);

660 
out
;

663 
	`bŒfs_»Ëa£_·th
(
·th
);

666 
»t
 = 
	`bŒfs_drÝ_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
¡¬t
, 
ex‹Á_’d
, 1);

667 ià(
»t
)

668 
out
;

670 ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
 ||

671 
found_ty³
 =ð
BTRFS_FILE_EXTENT_PREALLOC
) {

672 
u64
 
off£t
;

673 
de¡_off£t
;

674 
bŒfs_key
 
šs
;

676 ià(
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
™em
) == 0 &&

677 
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))

678 
upd©e_šode
;

680 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, 
key
,

681 (*
™em
));

682 ià(
»t
)

683 
out
;

684 
de¡_off£t
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],

685 
·th
->
¦Ùs
[0]);

686 
	`cÝy_ex‹Á_bufãr
(
·th
->
nodes
[0], 
eb
, 
de¡_off£t
,

687 ()
™em
, (*item));

689 
šs
.
objeùid
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
™em
);

690 
šs
.
off£t
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
eb
, 
™em
);

691 
šs
.
ty³
 = 
BTRFS_EXTENT_ITEM_KEY
;

692 
off£t
 = 
key
->off£ˆ- 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
™em
);

702 
»t
 = 
	`bŒfs_qgroup_Œaû_ex‹Á
(
Œªs
, 
fs_šfo
,

703 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
eb
, 
™em
),

704 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
eb
, 
™em
),

705 
GFP_NOFS
);

706 ià(
»t
 < 0)

707 
out
;

709 ià(
šs
.
objeùid
 > 0) {

710 
u64
 
csum_¡¬t
;

711 
u64
 
csum_’d
;

712 
	`LIST_HEAD
(
Üd”ed_sums
);

717 
»t
 = 
	`bŒfs_lookup_d©a_ex‹Á
(
fs_šfo
, 
šs
.
objeùid
,

718 
šs
.
off£t
);

719 ià(
»t
 == 0) {

720 
»t
 = 
	`bŒfs_šc_ex‹Á_»f
(
Œªs
, 
fs_šfo
,

721 
šs
.
objeùid
, ins.
off£t
,

722 0, 
roÙ
->
roÙ_key
.
objeùid
,

723 
key
->
objeùid
, 
off£t
);

724 ià(
»t
)

725 
out
;

731 
»t
 = 
	`bŒfs_®loc_logged_fže_ex‹Á
(
Œªs
,

732 
fs_šfo
,

733 
roÙ
->
roÙ_key
.
objeùid
,

734 
key
->
objeùid
, 
off£t
, &
šs
);

735 ià(
»t
)

736 
out
;

738 
	`bŒfs_»Ëa£_·th
(
·th
);

740 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
eb
, 
™em
)) {

741 
csum_¡¬t
 = 
šs
.
objeùid
;

742 
csum_’d
 = 
csum_¡¬t
 + 
šs
.
off£t
;

744 
csum_¡¬t
 = 
šs
.
objeùid
 +

745 
	`bŒfs_fže_ex‹Á_off£t
(
eb
, 
™em
);

746 
csum_’d
 = 
csum_¡¬t
 +

747 
	`bŒfs_fže_ex‹Á_num_by‹s
(
eb
, 
™em
);

750 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(
roÙ
->
log_roÙ
,

751 
csum_¡¬t
, 
csum_’d
 - 1,

752 &
Üd”ed_sums
, 0);

753 ià(
»t
)

754 
out
;

804 !
	`li¡_em±y
(&
Üd”ed_sums
)) {

805 
bŒfs_Üd”ed_sum
 *
sums
;

806 
sums
 = 
	`li¡_’Œy
(
Üd”ed_sums
.
Ãxt
,

807 
bŒfs_Üd”ed_sum
,

808 
li¡
);

809 ià(!
»t
)

810 
»t
 = 
	`bŒfs_d–_csums
(
Œªs
, 
fs_šfo
,

811 
sums
->
by‹Ä
,

812 
sums
->
Ën
);

813 ià(!
»t
)

814 
»t
 = 
	`bŒfs_csum_fže_blocks
(
Œªs
,

815 
fs_šfo
->
csum_roÙ
, 
sums
);

816 
	`li¡_d–
(&
sums
->
li¡
);

817 
	`kä“
(
sums
);

819 ià(
»t
)

820 
out
;

822 
	`bŒfs_»Ëa£_·th
(
·th
);

824 } ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_INLINE
) {

826 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
roÙ
, 
·th
, 
eb
, 
¦Ù
, 
key
);

827 ià(
»t
)

828 
out
;

831 
	`šode_add_by‹s
(
šode
, 
nby‹s
);

832 
upd©e_šode
:

833 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

834 
out
:

835 ià(
šode
)

836 
	`ut
(
šode
);

837  
»t
;

838 
	}
}

848 
nošlše
 
	$drÝ_Úe_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

849 
bŒfs_roÙ
 *
roÙ
,

850 
bŒfs_·th
 *
·th
,

851 
bŒfs_šode
 *
dœ
,

852 
bŒfs_dœ_™em
 *
di
)

854 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

855 
šode
 *inode;

856 *
Çme
;

857 
Çme_Ën
;

858 
ex‹Á_bufãr
 *
Ëaf
;

859 
bŒfs_key
 
loÿtiÚ
;

860 
»t
;

862 
Ëaf
 = 
·th
->
nodes
[0];

864 
	`bŒfs_dœ_™em_key_to_ýu
(
Ëaf
, 
di
, &
loÿtiÚ
);

865 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

866 
Çme
 = 
	`km®loc
(
Çme_Ën
, 
GFP_NOFS
);

867 ià(!
Çme
)

868  -
ENOMEM
;

870 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
Çme
, ()(
di
 + 1), 
Çme_Ën
);

871 
	`bŒfs_»Ëa£_·th
(
·th
);

873 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
loÿtiÚ
.
objeùid
);

874 ià(!
šode
) {

875 
»t
 = -
EIO
;

876 
out
;

879 
»t
 = 
	`lšk_to_fixup_dœ
(
Œªs
, 
roÙ
, 
·th
, 
loÿtiÚ
.
objeùid
);

880 ià(
»t
)

881 
out
;

883 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
dœ
, 
	`BTRFS_I
(
šode
), 
Çme
,

884 
Çme_Ën
);

885 ià(
»t
)

886 
out
;

888 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

889 
out
:

890 
	`kä“
(
Çme
);

891 
	`ut
(
šode
);

892  
»t
;

893 
	}
}

900 
nošlše
 
	$šode_š_dœ
(
bŒfs_roÙ
 *
roÙ
,

901 
bŒfs_·th
 *
·th
,

902 
u64
 
dœid
, u64 
objeùid
, u64 
šdex
,

903 cÚ¡ *
Çme
, 
Çme_Ën
)

905 
bŒfs_dœ_™em
 *
di
;

906 
bŒfs_key
 
loÿtiÚ
;

907 
m©ch
 = 0;

909 
di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
NULL
, 
roÙ
, 
·th
, 
dœid
,

910 
šdex
, 
Çme
, 
Çme_Ën
, 0);

911 ià(
di
 && !
	`IS_ERR
(di)) {

912 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
loÿtiÚ
);

913 ià(
loÿtiÚ
.
objeùid
 != objectid)

914 
out
;

916 
out
;

917 
	`bŒfs_»Ëa£_·th
(
·th
);

919 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
roÙ
, 
·th
, 
dœid
, 
Çme
, 
Çme_Ën
, 0);

920 ià(
di
 && !
	`IS_ERR
(di)) {

921 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
di
, &
loÿtiÚ
);

922 ià(
loÿtiÚ
.
objeùid
 != objectid)

923 
out
;

925 
out
;

926 
m©ch
 = 1;

927 
out
:

928 
	`bŒfs_»Ëa£_·th
(
·th
);

929  
m©ch
;

930 
	}
}

942 
nošlše
 
	$back»f_š_log
(
bŒfs_roÙ
 *
log
,

943 
bŒfs_key
 *
key
,

944 
u64
 
»f_objeùid
,

945 cÚ¡ *
Çme
, 
Çm–’
)

947 
bŒfs_·th
 *
·th
;

948 
bŒfs_šode_»f
 *
»f
;

949 
±r
;

950 
±r_’d
;

951 
Çme_±r
;

952 
found_Çme_Ën
;

953 
™em_size
;

954 
»t
;

955 
m©ch
 = 0;

957 
·th
 = 
	`bŒfs_®loc_·th
();

958 ià(!
·th
)

959  -
ENOMEM
;

961 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
log
, 
key
, 
·th
, 0, 0);

962 ià(
»t
 != 0)

963 
out
;

965 
±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

967 ià(
key
->
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) {

968 ià(
	`bŒfs_fšd_Çme_š_ext_back»f
(
·th
, 
»f_objeùid
,

969 
Çme
, 
Çm–’
, 
NULL
))

970 
m©ch
 = 1;

972 
out
;

975 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

976 
±r_’d
 = 
±r
 + 
™em_size
;

977 
±r
 < 
±r_’d
) {

978 
»f
 = (
bŒfs_šode_»f
 *)
±r
;

979 
found_Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0], 
»f
);

980 ià(
found_Çme_Ën
 =ð
Çm–’
) {

981 
Çme_±r
 = ()(
»f
 + 1);

982 
»t
 = 
	`memcmp_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
,

983 
Çme_±r
, 
Çm–’
);

984 ià(
»t
 == 0) {

985 
m©ch
 = 1;

986 
out
;

989 
±r
 = ()(
»f
 + 1è+ 
found_Çme_Ën
;

991 
out
:

992 
	`bŒfs_ä“_·th
(
·th
);

993  
m©ch
;

994 
	}
}

996 
šlše
 
	$__add_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

997 
bŒfs_roÙ
 *
roÙ
,

998 
bŒfs_·th
 *
·th
,

999 
bŒfs_roÙ
 *
log_roÙ
,

1000 
bŒfs_šode
 *
dœ
,

1001 
bŒfs_šode
 *
šode
,

1002 
u64
 
šode_objeùid
, u64 
·»Á_objeùid
,

1003 
u64
 
»f_šdex
, *
Çme
, 
Çm–’
,

1004 *
£¬ch_dÚe
)

1006 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1007 
»t
;

1008 *
viùim_Çme
;

1009 
viùim_Çme_Ën
;

1010 
ex‹Á_bufãr
 *
Ëaf
;

1011 
bŒfs_dœ_™em
 *
di
;

1012 
bŒfs_key
 
£¬ch_key
;

1013 
bŒfs_šode_exŒef
 *
exŒef
;

1015 
agaš
:

1017 
£¬ch_key
.
objeùid
 = 
šode_objeùid
;

1018 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1019 
£¬ch_key
.
off£t
 = 
·»Á_objeùid
;

1020 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

1021 ià(
»t
 == 0) {

1022 
bŒfs_šode_»f
 *
viùim_»f
;

1023 
±r
;

1024 
±r_’d
;

1026 
Ëaf
 = 
·th
->
nodes
[0];

1031 ià(
£¬ch_key
.
objeùid
 =ð£¬ch_key.
off£t
)

1038 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1039 
±r_’d
 = 
±r
 + 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1040 
±r
 < 
±r_’d
) {

1041 
viùim_»f
 = (
bŒfs_šode_»f
 *)
±r
;

1042 
viùim_Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
Ëaf
,

1043 
viùim_»f
);

1044 
viùim_Çme
 = 
	`km®loc
(
viùim_Çme_Ën
, 
GFP_NOFS
);

1045 ià(!
viùim_Çme
)

1046  -
ENOMEM
;

1048 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
viùim_Çme
,

1049 ()(
viùim_»f
 + 1),

1050 
viùim_Çme_Ën
);

1052 ià(!
	`back»f_š_log
(
log_roÙ
, &
£¬ch_key
,

1053 
·»Á_objeùid
,

1054 
viùim_Çme
,

1055 
viùim_Çme_Ën
)) {

1056 
	`šc_Æšk
(&
šode
->
vfs_šode
);

1057 
	`bŒfs_»Ëa£_·th
(
·th
);

1059 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
dœ
, 
šode
,

1060 
viùim_Çme
, 
viùim_Çme_Ën
);

1061 
	`kä“
(
viùim_Çme
);

1062 ià(
»t
)

1063  
»t
;

1064 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

1065 ià(
»t
)

1066  
»t
;

1067 *
£¬ch_dÚe
 = 1;

1068 
agaš
;

1070 
	`kä“
(
viùim_Çme
);

1072 
±r
 = ()(
viùim_»f
 + 1è+ 
viùim_Çme_Ën
;

1079 *
£¬ch_dÚe
 = 1;

1081 
	`bŒfs_»Ëa£_·th
(
·th
);

1084 
exŒef
 = 
	`bŒfs_lookup_šode_exŒef
(
NULL
, 
roÙ
, 
·th
, 
Çme
, 
Çm–’
,

1085 
šode_objeùid
, 
·»Á_objeùid
, 0,

1087 ià(!
	`IS_ERR_OR_NULL
(
exŒef
)) {

1088 
u32
 
™em_size
;

1089 
u32
 
cur_off£t
 = 0;

1090 
ba£
;

1091 
šode
 *
viùim_·»Á
;

1093 
Ëaf
 = 
·th
->
nodes
[0];

1095 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1096 
ba£
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1098 
cur_off£t
 < 
™em_size
) {

1099 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
ba£
 + 
cur_off£t
);

1101 
viùim_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

1103 ià(
	`bŒfs_šode_exŒef_·»Á
(
Ëaf
, 
exŒef
è!ð
·»Á_objeùid
)

1104 
Ãxt
;

1106 
viùim_Çme
 = 
	`km®loc
(
viùim_Çme_Ën
, 
GFP_NOFS
);

1107 ià(!
viùim_Çme
)

1108  -
ENOMEM
;

1109 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
viùim_Çme
, ()&
exŒef
->
Çme
,

1110 
viùim_Çme_Ën
);

1112 
£¬ch_key
.
objeùid
 = 
šode_objeùid
;

1113 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1114 
£¬ch_key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
·»Á_objeùid
,

1115 
viùim_Çme
,

1116 
viùim_Çme_Ën
);

1117 
»t
 = 0;

1118 ià(!
	`back»f_š_log
(
log_roÙ
, &
£¬ch_key
,

1119 
·»Á_objeùid
, 
viùim_Çme
,

1120 
viùim_Çme_Ën
)) {

1121 
»t
 = -
ENOENT
;

1122 
viùim_·»Á
 = 
	`»ad_Úe_šode
(
roÙ
,

1123 
·»Á_objeùid
);

1124 ià(
viùim_·»Á
) {

1125 
	`šc_Æšk
(&
šode
->
vfs_šode
);

1126 
	`bŒfs_»Ëa£_·th
(
·th
);

1128 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
,

1129 
	`BTRFS_I
(
viùim_·»Á
),

1130 
šode
,

1131 
viùim_Çme
,

1132 
viùim_Çme_Ën
);

1133 ià(!
»t
)

1134 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(

1135 
Œªs
,

1136 
fs_šfo
);

1138 
	`ut
(
viùim_·»Á
);

1139 
	`kä“
(
viùim_Çme
);

1140 ià(
»t
)

1141  
»t
;

1142 *
£¬ch_dÚe
 = 1;

1143 
agaš
;

1145 
	`kä“
(
viùim_Çme
);

1146 
Ãxt
:

1147 
cur_off£t
 +ð
viùim_Çme_Ën
 + (*
exŒef
);

1149 *
£¬ch_dÚe
 = 1;

1151 
	`bŒfs_»Ëa£_·th
(
·th
);

1154 
di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
dœ
),

1155 
»f_šdex
, 
Çme
, 
Çm–’
, 0);

1156 ià(
di
 && !
	`IS_ERR
(di)) {

1157 
»t
 = 
	`drÝ_Úe_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
dœ
, 
di
);

1158 ià(
»t
)

1159  
»t
;

1161 
	`bŒfs_»Ëa£_·th
(
·th
);

1164 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
dœ
),

1165 
Çme
, 
Çm–’
, 0);

1166 ià(
di
 && !
	`IS_ERR
(di)) {

1167 
»t
 = 
	`drÝ_Úe_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
dœ
, 
di
);

1168 ià(
»t
)

1169  
»t
;

1171 
	`bŒfs_»Ëa£_·th
(
·th
);

1174 
	}
}

1176 
	$exŒef_g‘_f›lds
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1177 
»f_±r
, 
u32
 *
Çm–’
, **
Çme
,

1178 
u64
 *
šdex
, u64 *
·»Á_objeùid
)

1180 
bŒfs_šode_exŒef
 *
exŒef
;

1182 
exŒef
 = (
bŒfs_šode_exŒef
 *)
»f_±r
;

1184 *
Çm–’
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

1185 ià(!
	`bŒfs_is_Çme_Ën_v®id
(
eb
, 
¦Ù
, ()&
exŒef
->
Çme
,

1186 *
Çm–’
))

1187  -
EIO
;

1189 *
Çme
 = 
	`km®loc
(*
Çm–’
, 
GFP_NOFS
);

1190 ià(*
Çme
 =ð
NULL
)

1191  -
ENOMEM
;

1193 
	`»ad_ex‹Á_bufãr
(
eb
, *
Çme
, ()&
exŒef
->name,

1194 *
Çm–’
);

1196 *
šdex
 = 
	`bŒfs_šode_exŒef_šdex
(
eb
, 
exŒef
);

1197 ià(
·»Á_objeùid
)

1198 *
·»Á_objeùid
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

1201 
	}
}

1203 
	$»f_g‘_f›lds
(
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1204 
»f_±r
, 
u32
 *
Çm–’
, **
Çme
,

1205 
u64
 *
šdex
)

1207 
bŒfs_šode_»f
 *
»f
;

1209 
»f
 = (
bŒfs_šode_»f
 *)
»f_±r
;

1211 *
Çm–’
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
»f
);

1212 ià(!
	`bŒfs_is_Çme_Ën_v®id
(
eb
, 
¦Ù
, ()(
»f
 + 1),

1213 *
Çm–’
))

1214  -
EIO
;

1216 *
Çme
 = 
	`km®loc
(*
Çm–’
, 
GFP_NOFS
);

1217 ià(*
Çme
 =ð
NULL
)

1218  -
ENOMEM
;

1220 
	`»ad_ex‹Á_bufãr
(
eb
, *
Çme
, ()(
»f
 + 1), *
Çm–’
);

1222 *
šdex
 = 
	`bŒfs_šode_»f_šdex
(
eb
, 
»f
);

1225 
	}
}

1233 
nošlše
 
	$add_šode_»f
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1234 
bŒfs_roÙ
 *
roÙ
,

1235 
bŒfs_roÙ
 *
log
,

1236 
bŒfs_·th
 *
·th
,

1237 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1238 
bŒfs_key
 *
key
)

1240 
šode
 *
dœ
 = 
NULL
;

1241 
šode
 *šodð
NULL
;

1242 
»f_±r
;

1243 
»f_’d
;

1244 *
Çme
 = 
NULL
;

1245 
Çm–’
;

1246 
»t
;

1247 
£¬ch_dÚe
 = 0;

1248 
log_»f_v”
 = 0;

1249 
u64
 
·»Á_objeùid
;

1250 
u64
 
šode_objeùid
;

1251 
u64
 
»f_šdex
 = 0;

1252 
»f_¡ruù_size
;

1254 
»f_±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

1255 
»f_’d
 = 
»f_±r
 + 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

1257 ià(
key
->
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) {

1258 
bŒfs_šode_exŒef
 *
r
;

1260 
»f_¡ruù_size
 = (
bŒfs_šode_exŒef
);

1261 
log_»f_v”
 = 1;

1262 
r
 = (
bŒfs_šode_exŒef
 *)
»f_±r
;

1263 
·»Á_objeùid
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
r
);

1265 
»f_¡ruù_size
 = (
bŒfs_šode_»f
);

1266 
·»Á_objeùid
 = 
key
->
off£t
;

1268 
šode_objeùid
 = 
key
->
objeùid
;

1276 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
·»Á_objeùid
);

1277 ià(!
dœ
) {

1278 
»t
 = -
ENOENT
;

1279 
out
;

1282 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
šode_objeùid
);

1283 ià(!
šode
) {

1284 
»t
 = -
EIO
;

1285 
out
;

1288 
»f_±r
 < 
»f_’d
) {

1289 ià(
log_»f_v”
) {

1290 
»t
 = 
	`exŒef_g‘_f›lds
(
eb
, 
¦Ù
, 
»f_±r
, &
Çm–’
,

1291 &
Çme
, &
»f_šdex
, &
·»Á_objeùid
);

1296 ià(!
dœ
)

1297 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
·»Á_objeùid
);

1298 ià(!
dœ
) {

1299 
»t
 = -
ENOENT
;

1300 
out
;

1303 
»t
 = 
	`»f_g‘_f›lds
(
eb
, 
¦Ù
, 
»f_±r
, &
Çm–’
,

1304 &
Çme
, &
»f_šdex
);

1306 ià(
»t
)

1307 
out
;

1310 ià(!
	`šode_š_dœ
(
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
dœ
)),

1311 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
»f_šdex
,

1312 
Çme
, 
Çm–’
)) {

1321 ià(!
£¬ch_dÚe
) {

1322 
»t
 = 
	`__add_šode_»f
(
Œªs
, 
roÙ
, 
·th
, 
log
,

1323 
	`BTRFS_I
(
dœ
),

1324 
	`BTRFS_I
(
šode
),

1325 
šode_objeùid
,

1326 
·»Á_objeùid
,

1327 
»f_šdex
, 
Çme
, 
Çm–’
,

1328 &
£¬ch_dÚe
);

1329 ià(
»t
) {

1330 ià(
»t
 == 1)

1331 
»t
 = 0;

1332 
out
;

1337 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
),

1338 
	`BTRFS_I
(
šode
),

1339 
Çme
, 
Çm–’
, 0, 
»f_šdex
);

1340 ià(
»t
)

1341 
out
;

1343 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

1346 
»f_±r
 = ()Ôef_±¸+ 
»f_¡ruù_size
è+ 
Çm–’
;

1347 
	`kä“
(
Çme
);

1348 
Çme
 = 
NULL
;

1349 ià(
log_»f_v”
) {

1350 
	`ut
(
dœ
);

1351 
dœ
 = 
NULL
;

1356 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
roÙ
, 
·th
, 
eb
, 
¦Ù
, 
key
);

1357 
out
:

1358 
	`bŒfs_»Ëa£_·th
(
·th
);

1359 
	`kä“
(
Çme
);

1360 
	`ut
(
dœ
);

1361 
	`ut
(
šode
);

1362  
»t
;

1363 
	}
}

1365 
	$š£¹_Üphª_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1366 
bŒfs_roÙ
 *
roÙ
, 
u64
 
šo
)

1368 
»t
;

1370 
»t
 = 
	`bŒfs_š£¹_Üphª_™em
(
Œªs
, 
roÙ
, 
šo
);

1371 ià(
»t
 =ð-
EEXIST
)

1372 
»t
 = 0;

1374  
»t
;

1375 
	}
}

1377 
	$couÁ_šode_exŒefs
(
bŒfs_roÙ
 *
roÙ
,

1378 
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
)

1380 
»t
 = 0;

1381 
Çme_Ën
;

1382 
Æšk
 = 0;

1383 
u32
 
™em_size
;

1384 
u32
 
cur_off£t
 = 0;

1385 
u64
 
šode_objeùid
 = 
	`bŒfs_šo
(
šode
);

1386 
u64
 
off£t
 = 0;

1387 
±r
;

1388 
bŒfs_šode_exŒef
 *
exŒef
;

1389 
ex‹Á_bufãr
 *
Ëaf
;

1392 
»t
 = 
	`bŒfs_fšd_Úe_exŒef
(
roÙ
, 
šode_objeùid
, 
off£t
, 
·th
,

1393 &
exŒef
, &
off£t
);

1394 ià(
»t
)

1397 
Ëaf
 = 
·th
->
nodes
[0];

1398 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1399 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
·th
->
¦Ùs
[0]);

1400 
cur_off£t
 = 0;

1402 
cur_off£t
 < 
™em_size
) {

1403 
exŒef
 = (
bŒfs_šode_exŒef
 *è(
±r
 + 
cur_off£t
);

1404 
Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
, 
exŒef
);

1406 
Æšk
++;

1408 
cur_off£t
 +ð
Çme_Ën
 + (*
exŒef
);

1411 
off£t
++;

1412 
	`bŒfs_»Ëa£_·th
(
·th
);

1414 
	`bŒfs_»Ëa£_·th
(
·th
);

1416 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

1417  
»t
;

1418  
Æšk
;

1419 
	}
}

1421 
	$couÁ_šode_»fs
(
bŒfs_roÙ
 *
roÙ
,

1422 
bŒfs_šode
 *
šode
, 
bŒfs_·th
 *
·th
)

1424 
»t
;

1425 
bŒfs_key
 
key
;

1426 
Æšk
 = 0;

1427 
±r
;

1428 
±r_’d
;

1429 
Çme_Ën
;

1430 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

1432 
key
.
objeùid
 = 
šo
;

1433 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1434 
key
.
off£t
 = (
u64
)-1;

1437 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1438 ià(
»t
 < 0)

1440 ià(
»t
 > 0) {

1441 ià(
·th
->
¦Ùs
[0] == 0)

1443 
·th
->
¦Ùs
[0]--;

1445 
´oûss_¦Ù
:

1446 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,

1447 
·th
->
¦Ùs
[0]);

1448 ià(
key
.
objeùid
 !ð
šo
 ||

1449 
key
.
ty³
 !ð
BTRFS_INODE_REF_KEY
)

1451 
±r
 = 
	`bŒfs_™em_±r_off£t
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]);

1452 
±r_’d
 = 
±r
 + 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],

1453 
·th
->
¦Ùs
[0]);

1454 
±r
 < 
±r_’d
) {

1455 
bŒfs_šode_»f
 *
»f
;

1457 
»f
 = (
bŒfs_šode_»f
 *)
±r
;

1458 
Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
·th
->
nodes
[0],

1459 
»f
);

1460 
±r
 = ()(
»f
 + 1è+ 
Çme_Ën
;

1461 
Æšk
++;

1464 ià(
key
.
off£t
 == 0)

1466 ià(
·th
->
¦Ùs
[0] > 0) {

1467 
·th
->
¦Ùs
[0]--;

1468 
´oûss_¦Ù
;

1470 
key
.
off£t
--;

1471 
	`bŒfs_»Ëa£_·th
(
·th
);

1473 
	`bŒfs_»Ëa£_·th
(
·th
);

1475  
Æšk
;

1476 
	}
}

1488 
nošlše
 
	$fixup_šode_lšk_couÁ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1489 
bŒfs_roÙ
 *
roÙ
,

1490 
šode
 *inode)

1492 
bŒfs_·th
 *
·th
;

1493 
»t
;

1494 
u64
 
Æšk
 = 0;

1495 
u64
 
šo
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

1497 
·th
 = 
	`bŒfs_®loc_·th
();

1498 ià(!
·th
)

1499  -
ENOMEM
;

1501 
»t
 = 
	`couÁ_šode_»fs
(
roÙ
, 
	`BTRFS_I
(
šode
), 
·th
);

1502 ià(
»t
 < 0)

1503 
out
;

1505 
Æšk
 = 
»t
;

1507 
»t
 = 
	`couÁ_šode_exŒefs
(
roÙ
, 
	`BTRFS_I
(
šode
), 
·th
);

1508 ià(
»t
 < 0)

1509 
out
;

1511 
Æšk
 +ð
»t
;

1513 
»t
 = 0;

1515 ià(
Æšk
 !ð
šode
->
i_Æšk
) {

1516 
	`£t_Æšk
(
šode
, 
Æšk
);

1517 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

1519 
	`BTRFS_I
(
šode
)->
šdex_út
 = (
u64
)-1;

1521 ià(
šode
->
i_Æšk
 == 0) {

1522 ià(
	`S_ISDIR
(
šode
->
i_mode
)) {

1523 
»t
 = 
	`»¶ay_dœ_d–‘es
(
Œªs
, 
roÙ
, 
NULL
, 
·th
,

1524 
šo
, 1);

1525 ià(
»t
)

1526 
out
;

1528 
»t
 = 
	`š£¹_Üphª_™em
(
Œªs
, 
roÙ
, 
šo
);

1531 
out
:

1532 
	`bŒfs_ä“_·th
(
·th
);

1533  
»t
;

1534 
	}
}

1536 
nošlše
 
	$fixup_šode_lšk_couÁs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1537 
bŒfs_roÙ
 *
roÙ
,

1538 
bŒfs_·th
 *
·th
)

1540 
»t
;

1541 
bŒfs_key
 
key
;

1542 
šode
 *inode;

1544 
key
.
objeùid
 = 
BTRFS_TREE_LOG_FIXUP_OBJECTID
;

1545 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1546 
key
.
off£t
 = (
u64
)-1;

1548 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1549 ià(
»t
 < 0)

1552 ià(
»t
 == 1) {

1553 ià(
·th
->
¦Ùs
[0] == 0)

1555 
·th
->
¦Ùs
[0]--;

1558 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1559 ià(
key
.
objeùid
 !ð
BTRFS_TREE_LOG_FIXUP_OBJECTID
 ||

1560 
key
.
ty³
 !ð
BTRFS_ORPHAN_ITEM_KEY
)

1563 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1564 ià(
»t
)

1565 
out
;

1567 
	`bŒfs_»Ëa£_·th
(
·th
);

1568 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
.
off£t
);

1569 ià(!
šode
)

1570  -
EIO
;

1572 
»t
 = 
	`fixup_šode_lšk_couÁ
(
Œªs
, 
roÙ
, 
šode
);

1573 
	`ut
(
šode
);

1574 ià(
»t
)

1575 
out
;

1582 
key
.
off£t
 = (
u64
)-1;

1584 
»t
 = 0;

1585 
out
:

1586 
	`bŒfs_»Ëa£_·th
(
·th
);

1587  
»t
;

1588 
	}
}

1596 
nošlše
 
	$lšk_to_fixup_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1597 
bŒfs_roÙ
 *
roÙ
,

1598 
bŒfs_·th
 *
·th
,

1599 
u64
 
objeùid
)

1601 
bŒfs_key
 
key
;

1602 
»t
 = 0;

1603 
šode
 *inode;

1605 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
objeùid
);

1606 ià(!
šode
)

1607  -
EIO
;

1609 
key
.
objeùid
 = 
BTRFS_TREE_LOG_FIXUP_OBJECTID
;

1610 
key
.
ty³
 = 
BTRFS_ORPHAN_ITEM_KEY
;

1611 
key
.
off£t
 = 
objeùid
;

1613 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
, 0);

1615 
	`bŒfs_»Ëa£_·th
(
·th
);

1616 ià(
»t
 == 0) {

1617 ià(!
šode
->
i_Æšk
)

1618 
	`£t_Æšk
(
šode
, 1);

1620 
	`šc_Æšk
(
šode
);

1621 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

1622 } ià(
»t
 =ð-
EEXIST
) {

1623 
»t
 = 0;

1625 
	`BUG
();

1627 
	`ut
(
šode
);

1629  
»t
;

1630 
	}
}

1637 
nošlše
 
	$š£¹_Úe_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1638 
bŒfs_roÙ
 *
roÙ
,

1639 
u64
 
dœid
, u64 
šdex
,

1640 *
Çme
, 
Çme_Ën
,

1641 
bŒfs_key
 *
loÿtiÚ
)

1643 
šode
 *inode;

1644 
šode
 *
dœ
;

1645 
»t
;

1647 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
loÿtiÚ
->
objeùid
);

1648 ià(!
šode
)

1649  -
ENOENT
;

1651 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
dœid
);

1652 ià(!
dœ
) {

1653 
	`ut
(
šode
);

1654  -
EIO
;

1657 
»t
 = 
	`bŒfs_add_lšk
(
Œªs
, 
	`BTRFS_I
(
dœ
), BTRFS_I(
šode
), 
Çme
,

1658 
Çme_Ën
, 1, 
šdex
);

1662 
	`ut
(
šode
);

1663 
	`ut
(
dœ
);

1664  
»t
;

1665 
	}
}

1671 
boÞ
 
	$Çme_š_log_»f
(
bŒfs_roÙ
 *
log_roÙ
,

1672 cÚ¡ *
Çme
, cÚ¡ 
Çme_Ën
,

1673 cÚ¡ 
u64
 
dœid
, cÚ¡ u64 
šo
)

1675 
bŒfs_key
 
£¬ch_key
;

1677 
£¬ch_key
.
objeùid
 = 
šo
;

1678 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

1679 
£¬ch_key
.
off£t
 = 
dœid
;

1680 ià(
	`back»f_š_log
(
log_roÙ
, &
£¬ch_key
, 
dœid
, 
Çme
, 
Çme_Ën
))

1681  
Œue
;

1683 
£¬ch_key
.
ty³
 = 
BTRFS_INODE_EXTREF_KEY
;

1684 
£¬ch_key
.
off£t
 = 
	`bŒfs_exŒef_hash
(
dœid
, 
Çme
, 
Çme_Ën
);

1685 ià(
	`back»f_š_log
(
log_roÙ
, &
£¬ch_key
, 
dœid
, 
Çme
, 
Çme_Ën
))

1686  
Œue
;

1688  
çl£
;

1689 
	}
}

1707 
nošlše
 
	$»¶ay_Úe_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1708 
bŒfs_roÙ
 *
roÙ
,

1709 
bŒfs_·th
 *
·th
,

1710 
ex‹Á_bufãr
 *
eb
,

1711 
bŒfs_dœ_™em
 *
di
,

1712 
bŒfs_key
 *
key
)

1714 *
Çme
;

1715 
Çme_Ën
;

1716 
bŒfs_dœ_™em
 *
d¡_di
;

1717 
bŒfs_key
 
found_key
;

1718 
bŒfs_key
 
log_key
;

1719 
šode
 *
dœ
;

1720 
u8
 
log_ty³
;

1721 
exi¡s
;

1722 
»t
 = 0;

1723 
boÞ
 
upd©e_size
 = (
key
->
ty³
 =ð
BTRFS_DIR_INDEX_KEY
);

1724 
boÞ
 
Çme_added
 = 
çl£
;

1726 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
key
->
objeùid
);

1727 ià(!
dœ
)

1728  -
EIO
;

1730 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
eb
, 
di
);

1731 
Çme
 = 
	`km®loc
(
Çme_Ën
, 
GFP_NOFS
);

1732 ià(!
Çme
) {

1733 
»t
 = -
ENOMEM
;

1734 
out
;

1737 
log_ty³
 = 
	`bŒfs_dœ_ty³
(
eb
, 
di
);

1738 
	`»ad_ex‹Á_bufãr
(
eb
, 
Çme
, ()(
di
 + 1),

1739 
Çme_Ën
);

1741 
	`bŒfs_dœ_™em_key_to_ýu
(
eb
, 
di
, &
log_key
);

1742 
exi¡s
 = 
	`bŒfs_lookup_šode
(
Œªs
, 
roÙ
, 
·th
, &
log_key
, 0);

1743 ià(
exi¡s
 == 0)

1744 
exi¡s
 = 1;

1746 
exi¡s
 = 0;

1747 
	`bŒfs_»Ëa£_·th
(
·th
);

1749 ià(
key
->
ty³
 =ð
BTRFS_DIR_ITEM_KEY
) {

1750 
d¡_di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
key
->
objeùid
,

1751 
Çme
, 
Çme_Ën
, 1);

1752 } ià(
key
->
ty³
 =ð
BTRFS_DIR_INDEX_KEY
) {

1753 
d¡_di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
roÙ
, 
·th
,

1754 
key
->
objeùid
,

1755 
key
->
off£t
, 
Çme
,

1756 
Çme_Ën
, 1);

1759 
»t
 = -
EINVAL
;

1760 
out
;

1762 ià(
	`IS_ERR_OR_NULL
(
d¡_di
)) {

1766 ià(
key
->
ty³
 !ð
BTRFS_DIR_INDEX_KEY
)

1767 
out
;

1768 
š£¹
;

1771 
	`bŒfs_dœ_™em_key_to_ýu
(
·th
->
nodes
[0], 
d¡_di
, &
found_key
);

1773 ià(
found_key
.
objeùid
 =ð
log_key
.objectid &&

1774 
found_key
.
ty³
 =ð
log_key
.type &&

1775 
found_key
.
off£t
 =ð
log_key
.offset &&

1776 
	`bŒfs_dœ_ty³
(
·th
->
nodes
[0], 
d¡_di
è=ð
log_ty³
) {

1777 
upd©e_size
 = 
çl£
;

1778 
out
;

1785 ià(!
exi¡s
)

1786 
out
;

1788 
»t
 = 
	`drÝ_Úe_dœ_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`BTRFS_I
(
dœ
), 
d¡_di
);

1789 ià(
»t
)

1790 
out
;

1792 ià(
key
->
ty³
 =ð
BTRFS_DIR_INDEX_KEY
)

1793 
š£¹
;

1794 
out
:

1795 
	`bŒfs_»Ëa£_·th
(
·th
);

1796 ià(!
»t
 && 
upd©e_size
) {

1797 
	`bŒfs_i_size_wr™e
(
	`BTRFS_I
(
dœ
), dœ->
i_size
 + 
Çme_Ën
 * 2);

1798 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
dœ
);

1800 
	`kä“
(
Çme
);

1801 
	`ut
(
dœ
);

1802 ià(!
»t
 && 
Çme_added
)

1803 
»t
 = 1;

1804  
»t
;

1806 
š£¹
:

1807 ià(
	`Çme_š_log_»f
(
roÙ
->
log_roÙ
, 
Çme
, 
Çme_Ën
,

1808 
key
->
objeùid
, 
log_key
.objectid)) {

1810 
»t
 = 0;

1811 
upd©e_size
 = 
çl£
;

1812 
out
;

1814 
	`bŒfs_»Ëa£_·th
(
·th
);

1815 
»t
 = 
	`š£¹_Úe_Çme
(
Œªs
, 
roÙ
, 
key
->
objeùid
, key->
off£t
,

1816 
Çme
, 
Çme_Ën
, &
log_key
);

1817 ià(
»t
 &&„‘ !ð-
ENOENT
 &&„‘ !ð-
EEXIST
)

1818 
out
;

1819 ià(!
»t
)

1820 
Çme_added
 = 
Œue
;

1821 
upd©e_size
 = 
çl£
;

1822 
»t
 = 0;

1823 
out
;

1824 
	}
}

1832 
nošlše
 
	$»¶ay_Úe_dœ_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1833 
bŒfs_roÙ
 *
roÙ
,

1834 
bŒfs_·th
 *
·th
,

1835 
ex‹Á_bufãr
 *
eb
, 
¦Ù
,

1836 
bŒfs_key
 *
key
)

1838 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

1839 
»t
 = 0;

1840 
u32
 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

1841 
bŒfs_dœ_™em
 *
di
;

1842 
Çme_Ën
;

1843 
±r
;

1844 
±r_’d
;

1845 
bŒfs_·th
 *
fixup_·th
 = 
NULL
;

1847 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

1848 
±r_’d
 = 
±r
 + 
™em_size
;

1849 
±r
 < 
±r_’d
) {

1850 
di
 = (
bŒfs_dœ_™em
 *)
±r
;

1851 ià(
	`v”ify_dœ_™em
(
fs_šfo
, 
eb
, 
¦Ù
, 
di
))

1852  -
EIO
;

1853 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
eb
, 
di
);

1854 
»t
 = 
	`»¶ay_Úe_Çme
(
Œªs
, 
roÙ
, 
·th
, 
eb
, 
di
, 
key
);

1855 ià(
»t
 < 0)

1857 
±r
 = ()(
di
 + 1);

1858 
±r
 +ð
Çme_Ën
;

1887 ià(
»t
 =ð1 && 
	`bŒfs_dœ_ty³
(
eb
, 
di
è!ð
BTRFS_FT_DIR
) {

1888 
bŒfs_key
 
di_key
;

1890 ià(!
fixup_·th
) {

1891 
fixup_·th
 = 
	`bŒfs_®loc_·th
();

1892 ià(!
fixup_·th
) {

1893 
»t
 = -
ENOMEM
;

1898 
	`bŒfs_dœ_™em_key_to_ýu
(
eb
, 
di
, &
di_key
);

1899 
»t
 = 
	`lšk_to_fixup_dœ
(
Œªs
, 
roÙ
, 
fixup_·th
,

1900 
di_key
.
objeùid
);

1901 ià(
»t
)

1904 
»t
 = 0;

1906 
	`bŒfs_ä“_·th
(
fixup_·th
);

1907  
»t
;

1908 
	}
}

1921 
nošlše
 
	$fšd_dœ_¿nge
(
bŒfs_roÙ
 *
roÙ
,

1922 
bŒfs_·th
 *
·th
,

1923 
u64
 
dœid
, 
key_ty³
,

1924 
u64
 *
¡¬t_»t
, u64 *
’d_»t
)

1926 
bŒfs_key
 
key
;

1927 
u64
 
found_’d
;

1928 
bŒfs_dœ_log_™em
 *
™em
;

1929 
»t
;

1930 
Ä™ems
;

1932 ià(*
¡¬t_»t
 =ð(
u64
)-1)

1935 
key
.
objeùid
 = 
dœid
;

1936 
key
.
ty³
 = 
key_ty³
;

1937 
key
.
off£t
 = *
¡¬t_»t
;

1939 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1940 ià(
»t
 < 0)

1941 
out
;

1942 ià(
»t
 > 0) {

1943 ià(
·th
->
¦Ùs
[0] == 0)

1944 
out
;

1945 
·th
->
¦Ùs
[0]--;

1947 ià(
»t
 != 0)

1948 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1950 ià(
key
.
ty³
 !ð
key_ty³
 || key.
objeùid
 !ð
dœid
) {

1951 
»t
 = 1;

1952 
Ãxt
;

1954 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1955 
bŒfs_dœ_log_™em
);

1956 
found_’d
 = 
	`bŒfs_dœ_log_’d
(
·th
->
nodes
[0], 
™em
);

1958 ià(*
¡¬t_»t
 >ð
key
.
off£t
 && *¡¬t_»ˆ<ð
found_’d
) {

1959 
»t
 = 0;

1960 *
¡¬t_»t
 = 
key
.
off£t
;

1961 *
’d_»t
 = 
found_’d
;

1962 
out
;

1964 
»t
 = 1;

1965 
Ãxt
:

1967 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

1968 
·th
->
¦Ùs
[0]++;

1969 ià(
·th
->
¦Ùs
[0] >ð
Ä™ems
) {

1970 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1971 ià(
»t
)

1972 
out
;

1975 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
,…©h->
¦Ùs
[0]);

1977 ià(
key
.
ty³
 !ð
key_ty³
 || key.
objeùid
 !ð
dœid
) {

1978 
»t
 = 1;

1979 
out
;

1981 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

1982 
bŒfs_dœ_log_™em
);

1983 
found_’d
 = 
	`bŒfs_dœ_log_’d
(
·th
->
nodes
[0], 
™em
);

1984 *
¡¬t_»t
 = 
key
.
off£t
;

1985 *
’d_»t
 = 
found_’d
;

1986 
»t
 = 0;

1987 
out
:

1988 
	`bŒfs_»Ëa£_·th
(
·th
);

1989  
»t
;

1990 
	}
}

1997 
nošlše
 
	$check_™em_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1998 
bŒfs_roÙ
 *
roÙ
,

1999 
bŒfs_roÙ
 *
log
,

2000 
bŒfs_·th
 *
·th
,

2001 
bŒfs_·th
 *
log_·th
,

2002 
šode
 *
dœ
,

2003 
bŒfs_key
 *
dœ_key
)

2005 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2006 
»t
;

2007 
ex‹Á_bufãr
 *
eb
;

2008 
¦Ù
;

2009 
u32
 
™em_size
;

2010 
bŒfs_dœ_™em
 *
di
;

2011 
bŒfs_dœ_™em
 *
log_di
;

2012 
Çme_Ën
;

2013 
±r
;

2014 
±r_’d
;

2015 *
Çme
;

2016 
šode
 *inode;

2017 
bŒfs_key
 
loÿtiÚ
;

2019 
agaš
:

2020 
eb
 = 
·th
->
nodes
[0];

2021 
¦Ù
 = 
·th
->
¦Ùs
[0];

2022 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

2023 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

2024 
±r_’d
 = 
±r
 + 
™em_size
;

2025 
±r
 < 
±r_’d
) {

2026 
di
 = (
bŒfs_dœ_™em
 *)
±r
;

2027 ià(
	`v”ify_dœ_™em
(
fs_šfo
, 
eb
, 
¦Ù
, 
di
)) {

2028 
»t
 = -
EIO
;

2029 
out
;

2032 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
eb
, 
di
);

2033 
Çme
 = 
	`km®loc
(
Çme_Ën
, 
GFP_NOFS
);

2034 ià(!
Çme
) {

2035 
»t
 = -
ENOMEM
;

2036 
out
;

2038 
	`»ad_ex‹Á_bufãr
(
eb
, 
Çme
, ()(
di
 + 1),

2039 
Çme_Ën
);

2040 
log_di
 = 
NULL
;

2041 ià(
log
 && 
dœ_key
->
ty³
 =ð
BTRFS_DIR_ITEM_KEY
) {

2042 
log_di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
log
, 
log_·th
,

2043 
dœ_key
->
objeùid
,

2044 
Çme
, 
Çme_Ën
, 0);

2045 } ià(
log
 && 
dœ_key
->
ty³
 =ð
BTRFS_DIR_INDEX_KEY
) {

2046 
log_di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
log
,

2047 
log_·th
,

2048 
dœ_key
->
objeùid
,

2049 
dœ_key
->
off£t
,

2050 
Çme
, 
Çme_Ën
, 0);

2052 ià(!
log_di
 || (
	`IS_ERR
Öog_diè&& 
	`PTR_ERR
Öog_diè=ð-
ENOENT
)) {

2053 
	`bŒfs_dœ_™em_key_to_ýu
(
eb
, 
di
, &
loÿtiÚ
);

2054 
	`bŒfs_»Ëa£_·th
(
·th
);

2055 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2056 
šode
 = 
	`»ad_Úe_šode
(
roÙ
, 
loÿtiÚ
.
objeùid
);

2057 ià(!
šode
) {

2058 
	`kä“
(
Çme
);

2059  -
EIO
;

2062 
»t
 = 
	`lšk_to_fixup_dœ
(
Œªs
, 
roÙ
,

2063 
·th
, 
loÿtiÚ
.
objeùid
);

2064 ià(
»t
) {

2065 
	`kä“
(
Çme
);

2066 
	`ut
(
šode
);

2067 
out
;

2070 
	`šc_Æšk
(
šode
);

2071 
»t
 = 
	`bŒfs_uÆšk_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
dœ
),

2072 
	`BTRFS_I
(
šode
), 
Çme
, 
Çme_Ën
);

2073 ià(!
»t
)

2074 
»t
 = 
	`bŒfs_run_d–ayed_™ems
(
Œªs
, 
fs_šfo
);

2075 
	`kä“
(
Çme
);

2076 
	`ut
(
šode
);

2077 ià(
»t
)

2078 
out
;

2083 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, 
dœ_key
, 
·th
,

2085 ià(
»t
 == 0)

2086 
agaš
;

2087 
»t
 = 0;

2088 
out
;

2089 } ià(
	`IS_ERR
(
log_di
)) {

2090 
	`kä“
(
Çme
);

2091  
	`PTR_ERR
(
log_di
);

2093 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2094 
	`kä“
(
Çme
);

2096 
±r
 = ()(
di
 + 1);

2097 
±r
 +ð
Çme_Ën
;

2099 
»t
 = 0;

2100 
out
:

2101 
	`bŒfs_»Ëa£_·th
(
·th
);

2102 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2103  
»t
;

2104 
	}
}

2106 
	$»¶ay_x©Œ_d–‘es
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2107 
bŒfs_roÙ
 *
roÙ
,

2108 
bŒfs_roÙ
 *
log
,

2109 
bŒfs_·th
 *
·th
,

2110 cÚ¡ 
u64
 
šo
)

2112 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2113 
bŒfs_key
 
£¬ch_key
;

2114 
bŒfs_·th
 *
log_·th
;

2115 
i
;

2116 
Ä™ems
;

2117 
»t
;

2119 
log_·th
 = 
	`bŒfs_®loc_·th
();

2120 ià(!
log_·th
)

2121  -
ENOMEM
;

2123 
£¬ch_key
.
objeùid
 = 
šo
;

2124 
£¬ch_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

2125 
£¬ch_key
.
off£t
 = 0;

2126 
agaš
:

2127 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
£¬ch_key
, 
·th
, 0, 0);

2128 ià(
»t
 < 0)

2129 
out
;

2130 
´oûss_Ëaf
:

2131 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

2132 
i
 = 
·th
->
¦Ùs
[0]; i < 
Ä™ems
; i++) {

2133 
bŒfs_key
 
key
;

2134 
bŒfs_dœ_™em
 *
di
;

2135 
bŒfs_dœ_™em
 *
log_di
;

2136 
u32
 
tÙ®_size
;

2137 
u32
 
cur
;

2139 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
key
, 
i
);

2140 ià(
key
.
objeùid
 !ð
šo
 || key.
ty³
 !ð
BTRFS_XATTR_ITEM_KEY
) {

2141 
»t
 = 0;

2142 
out
;

2145 
di
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0], 
i
, 
bŒfs_dœ_™em
);

2146 
tÙ®_size
 = 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0], 
i
);

2147 
cur
 = 0;

2148 
cur
 < 
tÙ®_size
) {

2149 
u16
 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
·th
->
nodes
[0], 
di
);

2150 
u16
 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
·th
->
nodes
[0], 
di
);

2151 
u32
 
this_Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

2152 *
Çme
;

2154 
»t
 = 
	`v”ify_dœ_™em
(
fs_šfo
, 
·th
->
nodes
[0], 
i
, 
di
);

2155 ià(
»t
) {

2156 
»t
 = -
EIO
;

2157 
out
;

2159 
Çme
 = 
	`km®loc
(
Çme_Ën
, 
GFP_NOFS
);

2160 ià(!
Çme
) {

2161 
»t
 = -
ENOMEM
;

2162 
out
;

2164 
	`»ad_ex‹Á_bufãr
(
·th
->
nodes
[0], 
Çme
,

2165 ()(
di
 + 1), 
Çme_Ën
);

2167 
log_di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
log
, 
log_·th
, 
šo
,

2168 
Çme
, 
Çme_Ën
, 0);

2169 
	`bŒfs_»Ëa£_·th
(
log_·th
);

2170 ià(!
log_di
) {

2172 
	`bŒfs_»Ëa£_·th
(
·th
);

2173 
di
 = 
	`bŒfs_lookup_x©Œ
(
Œªs
, 
roÙ
, 
·th
, 
šo
,

2174 
Çme
, 
Çme_Ën
, -1);

2175 
	`kä“
(
Çme
);

2176 ià(
	`IS_ERR
(
di
)) {

2177 
»t
 = 
	`PTR_ERR
(
di
);

2178 
out
;

2180 
	`ASSERT
(
di
);

2181 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
,

2182 
·th
, 
di
);

2183 ià(
»t
)

2184 
out
;

2185 
	`bŒfs_»Ëa£_·th
(
·th
);

2186 
£¬ch_key
 = 
key
;

2187 
agaš
;

2189 
	`kä“
(
Çme
);

2190 ià(
	`IS_ERR
(
log_di
)) {

2191 
»t
 = 
	`PTR_ERR
(
log_di
);

2192 
out
;

2194 
cur
 +ð
this_Ën
;

2195 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
this_Ën
);

2198 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2199 ià(
»t
 > 0)

2200 
»t
 = 0;

2201 ià(
»t
 == 0)

2202 
´oûss_Ëaf
;

2203 
out
:

2204 
	`bŒfs_ä“_·th
(
log_·th
);

2205 
	`bŒfs_»Ëa£_·th
(
·th
);

2206  
»t
;

2207 
	}
}

2220 
nošlše
 
	$»¶ay_dœ_d–‘es
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2221 
bŒfs_roÙ
 *
roÙ
,

2222 
bŒfs_roÙ
 *
log
,

2223 
bŒfs_·th
 *
·th
,

2224 
u64
 
dœid
, 
d–_®l
)

2226 
u64
 
¿nge_¡¬t
;

2227 
u64
 
¿nge_’d
;

2228 
key_ty³
 = 
BTRFS_DIR_LOG_ITEM_KEY
;

2229 
»t
 = 0;

2230 
bŒfs_key
 
dœ_key
;

2231 
bŒfs_key
 
found_key
;

2232 
bŒfs_·th
 *
log_·th
;

2233 
šode
 *
dœ
;

2235 
dœ_key
.
objeùid
 = 
dœid
;

2236 
dœ_key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

2237 
log_·th
 = 
	`bŒfs_®loc_·th
();

2238 ià(!
log_·th
)

2239  -
ENOMEM
;

2241 
dœ
 = 
	`»ad_Úe_šode
(
roÙ
, 
dœid
);

2246 ià(!
dœ
) {

2247 
	`bŒfs_ä“_·th
(
log_·th
);

2250 
agaš
:

2251 
¿nge_¡¬t
 = 0;

2252 
¿nge_’d
 = 0;

2254 ià(
d–_®l
)

2255 
¿nge_’d
 = (
u64
)-1;

2257 
»t
 = 
	`fšd_dœ_¿nge
(
log
, 
·th
, 
dœid
, 
key_ty³
,

2258 &
¿nge_¡¬t
, &
¿nge_’d
);

2259 ià(
»t
 != 0)

2263 
dœ_key
.
off£t
 = 
¿nge_¡¬t
;

2265 
Ä™ems
;

2266 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
dœ_key
, 
·th
,

2268 ià(
»t
 < 0)

2269 
out
;

2271 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

2272 ià(
·th
->
¦Ùs
[0] >ð
Ä™ems
) {

2273 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2274 ià(
»t
)

2277 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

2278 
·th
->
¦Ùs
[0]);

2279 ià(
found_key
.
objeùid
 !ð
dœid
 ||

2280 
found_key
.
ty³
 !ð
dœ_key
.type)

2281 
Ãxt_ty³
;

2283 ià(
found_key
.
off£t
 > 
¿nge_’d
)

2286 
»t
 = 
	`check_™em_š_log
(
Œªs
, 
roÙ
, 
log
, 
·th
,

2287 
log_·th
, 
dœ
,

2288 &
found_key
);

2289 ià(
»t
)

2290 
out
;

2291 ià(
found_key
.
off£t
 =ð(
u64
)-1)

2293 
dœ_key
.
off£t
 = 
found_key
.offset + 1;

2295 
	`bŒfs_»Ëa£_·th
(
·th
);

2296 ià(
¿nge_’d
 =ð(
u64
)-1)

2298 
¿nge_¡¬t
 = 
¿nge_’d
 + 1;

2301 
Ãxt_ty³
:

2302 
»t
 = 0;

2303 ià(
key_ty³
 =ð
BTRFS_DIR_LOG_ITEM_KEY
) {

2304 
key_ty³
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

2305 
dœ_key
.
ty³
 = 
BTRFS_DIR_INDEX_KEY
;

2306 
	`bŒfs_»Ëa£_·th
(
·th
);

2307 
agaš
;

2309 
out
:

2310 
	`bŒfs_»Ëa£_·th
(
·th
);

2311 
	`bŒfs_ä“_·th
(
log_·th
);

2312 
	`ut
(
dœ
);

2313  
»t
;

2314 
	}
}

2327 
	$»¶ay_Úe_bufãr
(
bŒfs_roÙ
 *
log
, 
ex‹Á_bufãr
 *
eb
,

2328 
w®k_cÚŒÞ
 *
wc
, 
u64
 
g’
)

2330 
Ä™ems
;

2331 
bŒfs_·th
 *
·th
;

2332 
bŒfs_roÙ
 *
roÙ
 = 
wc
->
»¶ay_de¡
;

2333 
bŒfs_key
 
key
;

2334 
Ëv–
;

2335 
i
;

2336 
»t
;

2338 
»t
 = 
	`bŒfs_»ad_bufãr
(
eb
, 
g’
);

2339 ià(
»t
)

2340  
»t
;

2342 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
eb
);

2344 ià(
Ëv–
 != 0)

2347 
·th
 = 
	`bŒfs_®loc_·th
();

2348 ià(!
·th
)

2349  -
ENOMEM
;

2351 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
eb
);

2352 
i
 = 0; i < 
Ä™ems
; i++) {

2353 
	`bŒfs_™em_key_to_ýu
(
eb
, &
key
, 
i
);

2356 ià(
key
.
ty³
 =ð
BTRFS_INODE_ITEM_KEY
 &&

2357 
wc
->
¡age
 =ð
LOG_WALK_REPLAY_INODES
) {

2358 
bŒfs_šode_™em
 *
šode_™em
;

2359 
u32
 
mode
;

2361 
šode_™em
 = 
	`bŒfs_™em_±r
(
eb
, 
i
,

2362 
bŒfs_šode_™em
);

2363 
»t
 = 
	`»¶ay_x©Œ_d–‘es
(
wc
->
Œªs
, 
roÙ
, 
log
,

2364 
·th
, 
key
.
objeùid
);

2365 ià(
»t
)

2367 
mode
 = 
	`bŒfs_šode_mode
(
eb
, 
šode_™em
);

2368 ià(
	`S_ISDIR
(
mode
)) {

2369 
»t
 = 
	`»¶ay_dœ_d–‘es
(
wc
->
Œªs
,

2370 
roÙ
, 
log
, 
·th
, 
key
.
objeùid
, 0);

2371 ià(
»t
)

2374 
»t
 = 
	`ov”wr™e_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2375 
eb
, 
i
, &
key
);

2376 ià(
»t
)

2383 ià(
	`S_ISREG
(
mode
)) {

2384 
»t
 = 
	`š£¹_Üphª_™em
(
wc
->
Œªs
, 
roÙ
,

2385 
key
.
objeùid
);

2386 ià(
»t
)

2390 
»t
 = 
	`lšk_to_fixup_dœ
(
wc
->
Œªs
, 
roÙ
,

2391 
·th
, 
key
.
objeùid
);

2392 ià(
»t
)

2396 ià(
key
.
ty³
 =ð
BTRFS_DIR_INDEX_KEY
 &&

2397 
wc
->
¡age
 =ð
LOG_WALK_REPLAY_DIR_INDEX
) {

2398 
»t
 = 
	`»¶ay_Úe_dœ_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2399 
eb
, 
i
, &
key
);

2400 ià(
»t
)

2404 ià(
wc
->
¡age
 < 
LOG_WALK_REPLAY_ALL
)

2408 ià(
key
.
ty³
 =ð
BTRFS_XATTR_ITEM_KEY
) {

2409 
»t
 = 
	`ov”wr™e_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2410 
eb
, 
i
, &
key
);

2411 ià(
»t
)

2413 } ià(
key
.
ty³
 =ð
BTRFS_INODE_REF_KEY
 ||

2414 
key
.
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) {

2415 
»t
 = 
	`add_šode_»f
(
wc
->
Œªs
, 
roÙ
, 
log
, 
·th
,

2416 
eb
, 
i
, &
key
);

2417 ià(
»t
 &&„‘ !ð-
ENOENT
)

2419 
»t
 = 0;

2420 } ià(
key
.
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

2421 
»t
 = 
	`»¶ay_Úe_ex‹Á
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2422 
eb
, 
i
, &
key
);

2423 ià(
»t
)

2425 } ià(
key
.
ty³
 =ð
BTRFS_DIR_ITEM_KEY
) {

2426 
»t
 = 
	`»¶ay_Úe_dœ_™em
(
wc
->
Œªs
, 
roÙ
, 
·th
,

2427 
eb
, 
i
, &
key
);

2428 ià(
»t
)

2432 
	`bŒfs_ä“_·th
(
·th
);

2433  
»t
;

2434 
	}
}

2436 
nošlše
 
	$w®k_down_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2437 
bŒfs_roÙ
 *
roÙ
,

2438 
bŒfs_·th
 *
·th
, *
Ëv–
,

2439 
w®k_cÚŒÞ
 *
wc
)

2441 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2442 
u64
 
roÙ_owÃr
;

2443 
u64
 
by‹Ä
;

2444 
u64
 
±r_g’
;

2445 
ex‹Á_bufãr
 *
Ãxt
;

2446 
ex‹Á_bufãr
 *
cur
;

2447 
ex‹Á_bufãr
 *
·»Á
;

2448 
u32
 
blocksize
;

2449 
»t
 = 0;

2451 
	`WARN_ON
(*
Ëv–
 < 0);

2452 
	`WARN_ON
(*
Ëv–
 >ð
BTRFS_MAX_LEVEL
);

2454 *
Ëv–
 > 0) {

2455 
	`WARN_ON
(*
Ëv–
 < 0);

2456 
	`WARN_ON
(*
Ëv–
 >ð
BTRFS_MAX_LEVEL
);

2457 
cur
 = 
·th
->
nodes
[*
Ëv–
];

2459 
	`WARN_ON
(
	`bŒfs_h—d”_Ëv–
(
cur
è!ð*
Ëv–
);

2461 ià(
·th
->
¦Ùs
[*
Ëv–
] >=

2462 
	`bŒfs_h—d”_Ä™ems
(
cur
))

2465 
by‹Ä
 = 
	`bŒfs_node_block±r
(
cur
, 
·th
->
¦Ùs
[*
Ëv–
]);

2466 
±r_g’
 = 
	`bŒfs_node_±r_g’”©iÚ
(
cur
, 
·th
->
¦Ùs
[*
Ëv–
]);

2467 
blocksize
 = 
fs_šfo
->
nodesize
;

2469 
·»Á
 = 
·th
->
nodes
[*
Ëv–
];

2470 
roÙ_owÃr
 = 
	`bŒfs_h—d”_owÃr
(
·»Á
);

2472 
Ãxt
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
by‹Ä
);

2473 ià(
	`IS_ERR
(
Ãxt
))

2474  
	`PTR_ERR
(
Ãxt
);

2476 ià(*
Ëv–
 == 1) {

2477 
»t
 = 
wc
->
	`´oûss_func
(
roÙ
, 
Ãxt
, wc, 
±r_g’
);

2478 ià(
»t
) {

2479 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2480  
»t
;

2483 
·th
->
¦Ùs
[*
Ëv–
]++;

2484 ià(
wc
->
ä“
) {

2485 
»t
 = 
	`bŒfs_»ad_bufãr
(
Ãxt
, 
±r_g’
);

2486 ià(
»t
) {

2487 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2488  
»t
;

2491 ià(
Œªs
) {

2492 
	`bŒfs_Œ“_lock
(
Ãxt
);

2493 
	`bŒfs_£t_lock_blockšg
(
Ãxt
);

2494 
	`þ—n_Œ“_block
(
fs_šfo
, 
Ãxt
);

2495 
	`bŒfs_wa™_Œ“_block_wr™eback
(
Ãxt
);

2496 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

2499 
	`WARN_ON
(
roÙ_owÃr
 !=

2500 
BTRFS_TREE_LOG_OBJECTID
);

2501 
»t
 = 
	`bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(

2502 
fs_šfo
, 
by‹Ä
,

2503 
blocksize
);

2504 ià(
»t
) {

2505 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2506  
»t
;

2509 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2512 
»t
 = 
	`bŒfs_»ad_bufãr
(
Ãxt
, 
±r_g’
);

2513 ià(
»t
) {

2514 
	`ä“_ex‹Á_bufãr
(
Ãxt
);

2515  
»t
;

2518 
	`WARN_ON
(*
Ëv–
 <= 0);

2519 ià(
·th
->
nodes
[*
Ëv–
-1])

2520 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[*
Ëv–
-1]);

2521 
·th
->
nodes
[*
Ëv–
-1] = 
Ãxt
;

2522 *
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
Ãxt
);

2523 
·th
->
¦Ùs
[*
Ëv–
] = 0;

2524 
	`cÚd_»sched
();

2526 
	`WARN_ON
(*
Ëv–
 < 0);

2527 
	`WARN_ON
(*
Ëv–
 >ð
BTRFS_MAX_LEVEL
);

2529 
·th
->
¦Ùs
[*
Ëv–
] = 
	`bŒfs_h—d”_Ä™ems
Õ©h->
nodes
[*level]);

2531 
	`cÚd_»sched
();

2533 
	}
}

2535 
nošlše
 
	$w®k_up_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2536 
bŒfs_roÙ
 *
roÙ
,

2537 
bŒfs_·th
 *
·th
, *
Ëv–
,

2538 
w®k_cÚŒÞ
 *
wc
)

2540 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2541 
u64
 
roÙ_owÃr
;

2542 
i
;

2543 
¦Ù
;

2544 
»t
;

2546 
i
 = *
Ëv–
; i < 
BTRFS_MAX_LEVEL
 - 1 && 
·th
->
nodes
[i]; i++) {

2547 
¦Ù
 = 
·th
->
¦Ùs
[
i
];

2548 ià(
¦Ù
 + 1 < 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[
i
])) {

2549 
·th
->
¦Ùs
[
i
]++;

2550 *
Ëv–
 = 
i
;

2551 
	`WARN_ON
(*
Ëv–
 == 0);

2554 
ex‹Á_bufãr
 *
·»Á
;

2555 ià(
·th
->
nodes
[*
Ëv–
] =ð
roÙ
->
node
)

2556 
·»Á
 = 
·th
->
nodes
[*
Ëv–
];

2558 
·»Á
 = 
·th
->
nodes
[*
Ëv–
 + 1];

2560 
roÙ_owÃr
 = 
	`bŒfs_h—d”_owÃr
(
·»Á
);

2561 
»t
 = 
wc
->
	`´oûss_func
(
roÙ
, 
·th
->
nodes
[*
Ëv–
], wc,

2562 
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[*
Ëv–
]));

2563 ià(
»t
)

2564  
»t
;

2566 ià(
wc
->
ä“
) {

2567 
ex‹Á_bufãr
 *
Ãxt
;

2569 
Ãxt
 = 
·th
->
nodes
[*
Ëv–
];

2571 ià(
Œªs
) {

2572 
	`bŒfs_Œ“_lock
(
Ãxt
);

2573 
	`bŒfs_£t_lock_blockšg
(
Ãxt
);

2574 
	`þ—n_Œ“_block
(
fs_šfo
, 
Ãxt
);

2575 
	`bŒfs_wa™_Œ“_block_wr™eback
(
Ãxt
);

2576 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

2579 
	`WARN_ON
(
roÙ_owÃr
 !ð
BTRFS_TREE_LOG_OBJECTID
);

2580 
»t
 = 
	`bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(

2581 
fs_šfo
,

2582 
·th
->
nodes
[*
Ëv–
]->
¡¬t
,

2583 
·th
->
nodes
[*
Ëv–
]->
Ën
);

2584 ià(
»t
)

2585  
»t
;

2587 
	`ä“_ex‹Á_bufãr
(
·th
->
nodes
[*
Ëv–
]);

2588 
·th
->
nodes
[*
Ëv–
] = 
NULL
;

2589 *
Ëv–
 = 
i
 + 1;

2593 
	}
}

2600 
	$w®k_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2601 
bŒfs_roÙ
 *
log
, 
w®k_cÚŒÞ
 *
wc
)

2603 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log
->fs_info;

2604 
»t
 = 0;

2605 
w»t
;

2606 
Ëv–
;

2607 
bŒfs_·th
 *
·th
;

2608 
Üig_Ëv–
;

2610 
·th
 = 
	`bŒfs_®loc_·th
();

2611 ià(!
·th
)

2612  -
ENOMEM
;

2614 
Ëv–
 = 
	`bŒfs_h—d”_Ëv–
(
log
->
node
);

2615 
Üig_Ëv–
 = 
Ëv–
;

2616 
·th
->
nodes
[
Ëv–
] = 
log
->
node
;

2617 
	`ex‹Á_bufãr_g‘
(
log
->
node
);

2618 
·th
->
¦Ùs
[
Ëv–
] = 0;

2621 
w»t
 = 
	`w®k_down_log_Œ“
(
Œªs
, 
log
, 
·th
, &
Ëv–
, 
wc
);

2622 ià(
w»t
 > 0)

2624 ià(
w»t
 < 0) {

2625 
»t
 = 
w»t
;

2626 
out
;

2629 
w»t
 = 
	`w®k_up_log_Œ“
(
Œªs
, 
log
, 
·th
, &
Ëv–
, 
wc
);

2630 ià(
w»t
 > 0)

2632 ià(
w»t
 < 0) {

2633 
»t
 = 
w»t
;

2634 
out
;

2639 ià(
·th
->
nodes
[
Üig_Ëv–
]) {

2640 
»t
 = 
wc
->
	`´oûss_func
(
log
, 
·th
->
nodes
[
Üig_Ëv–
], wc,

2641 
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[
Üig_Ëv–
]));

2642 ià(
»t
)

2643 
out
;

2644 ià(
wc
->
ä“
) {

2645 
ex‹Á_bufãr
 *
Ãxt
;

2647 
Ãxt
 = 
·th
->
nodes
[
Üig_Ëv–
];

2649 ià(
Œªs
) {

2650 
	`bŒfs_Œ“_lock
(
Ãxt
);

2651 
	`bŒfs_£t_lock_blockšg
(
Ãxt
);

2652 
	`þ—n_Œ“_block
(
fs_šfo
, 
Ãxt
);

2653 
	`bŒfs_wa™_Œ“_block_wr™eback
(
Ãxt
);

2654 
	`bŒfs_Œ“_uÆock
(
Ãxt
);

2657 
	`WARN_ON
(
log
->
roÙ_key
.
objeùid
 !=

2658 
BTRFS_TREE_LOG_OBJECTID
);

2659 
»t
 = 
	`bŒfs_ä“_ªd_pš_»£rved_ex‹Á
(
fs_šfo
,

2660 
Ãxt
->
¡¬t
,‚ext->
Ën
);

2661 ià(
»t
)

2662 
out
;

2666 
out
:

2667 
	`bŒfs_ä“_·th
(
·th
);

2668  
»t
;

2669 
	}
}

2675 
	$upd©e_log_roÙ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2676 
bŒfs_roÙ
 *
log
)

2678 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log
->fs_info;

2679 
»t
;

2681 ià(
log
->
log_Œªsid
 == 1) {

2683 
»t
 = 
	`bŒfs_š£¹_roÙ
(
Œªs
, 
fs_šfo
->
log_roÙ_Œ“
,

2684 &
log
->
roÙ_key
, &log->
roÙ_™em
);

2686 
»t
 = 
	`bŒfs_upd©e_roÙ
(
Œªs
, 
fs_šfo
->
log_roÙ_Œ“
,

2687 &
log
->
roÙ_key
, &log->
roÙ_™em
);

2689  
»t
;

2690 
	}
}

2692 
	$wa™_log_comm™
(
bŒfs_roÙ
 *
roÙ
, 
Œªsid
)

2694 
	`DEFINE_WAIT
(
wa™
);

2695 
šdex
 = 
Œªsid
 % 2;

2703 
	`´•¬e_to_wa™
(&
roÙ
->
log_comm™_wa™
[
šdex
],

2704 &
wa™
, 
TASK_UNINTERRUPTIBLE
);

2705 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2707 ià(
roÙ
->
log_Œªsid_comm™‹d
 < 
Œªsid
 &&

2708 
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex
]))

2709 
	`scheduË
();

2711 
	`fšish_wa™
(&
roÙ
->
log_comm™_wa™
[
šdex
], &
wa™
);

2712 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2713 } 
roÙ
->
log_Œªsid_comm™‹d
 < 
Œªsid
 &&

2714 
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex
]));

2715 
	}
}

2717 
	$wa™_fÜ_wr™”
(
bŒfs_roÙ
 *
roÙ
)

2719 
	`DEFINE_WAIT
(
wa™
);

2721 
	`©omic_»ad
(&
roÙ
->
log_wr™”s
)) {

2722 
	`´•¬e_to_wa™
(&
roÙ
->
log_wr™”_wa™
,

2723 &
wa™
, 
TASK_UNINTERRUPTIBLE
);

2724 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2725 ià(
	`©omic_»ad
(&
roÙ
->
log_wr™”s
))

2726 
	`scheduË
();

2727 
	`fšish_wa™
(&
roÙ
->
log_wr™”_wa™
, &
wa™
);

2728 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2730 
	}
}

2732 
šlše
 
	$bŒfs_»move_log_ùx
(
bŒfs_roÙ
 *
roÙ
,

2733 
bŒfs_log_ùx
 *
ùx
)

2735 ià(!
ùx
)

2738 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2739 
	`li¡_d–_š™
(&
ùx
->
li¡
);

2740 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2741 
	}
}

2747 
šlše
 
	$bŒfs_»move_®l_log_ùxs
(
bŒfs_roÙ
 *
roÙ
,

2748 
šdex
, 
”rÜ
)

2750 
bŒfs_log_ùx
 *
ùx
;

2751 
bŒfs_log_ùx
 *
§ã
;

2753 
	`li¡_fÜ_—ch_’Œy_§ã
(
ùx
, 
§ã
, &
roÙ
->
log_ùxs
[
šdex
], 
li¡
) {

2754 
	`li¡_d–_š™
(&
ùx
->
li¡
);

2755 
ùx
->
log_»t
 = 
”rÜ
;

2758 
	`INIT_LIST_HEAD
(&
roÙ
->
log_ùxs
[
šdex
]);

2759 
	}
}

2773 
	$bŒfs_sync_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2774 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_log_ùx
 *
ùx
)

2776 
šdex1
;

2777 
šdex2
;

2778 
m¬k
;

2779 
»t
;

2780 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

2781 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

2782 
bŒfs_roÙ
 *
log_roÙ_Œ“
 = 
fs_šfo
->log_root_tree;

2783 
log_Œªsid
 = 0;

2784 
bŒfs_log_ùx
 
roÙ_log_ùx
;

2785 
blk_¶ug
 
¶ug
;

2787 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2788 
log_Œªsid
 = 
ùx
->log_transid;

2789 ià(
roÙ
->
log_Œªsid_comm™‹d
 >ð
log_Œªsid
) {

2790 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2791  
ùx
->
log_»t
;

2794 
šdex1
 = 
log_Œªsid
 % 2;

2795 ià(
	`©omic_»ad
(&
roÙ
->
log_comm™
[
šdex1
])) {

2796 
	`wa™_log_comm™
(
roÙ
, 
log_Œªsid
);

2797 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2798  
ùx
->
log_»t
;

2800 
	`ASSERT
(
log_Œªsid
 =ð
roÙ
->log_transid);

2801 
	`©omic_£t
(&
roÙ
->
log_comm™
[
šdex1
], 1);

2804 ià(
	`©omic_»ad
(&
roÙ
->
log_comm™
[(
šdex1
 + 1) % 2]))

2805 
	`wa™_log_comm™
(
roÙ
, 
log_Œªsid
 - 1);

2808 
b©ch
 = 
	`©omic_»ad
(&
roÙ
->
log_b©ch
);

2810 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SSD
) &&

2811 
	`‹¡_b™
(
BTRFS_ROOT_MULTI_LOG_TASKS
, &
roÙ
->
¡©e
)) {

2812 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2813 
	`scheduË_timeout_unš‹¼u±ibË
(1);

2814 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2816 
	`wa™_fÜ_wr™”
(
roÙ
);

2817 ià(
b©ch
 =ð
	`©omic_»ad
(&
roÙ
->
log_b©ch
))

2822 ià(
	`bŒfs_Ãed_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
)) {

2823 
»t
 = -
EAGAIN
;

2824 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 
log_Œªsid
);

2825 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2826 
out
;

2829 ià(
log_Œªsid
 % 2 == 0)

2830 
m¬k
 = 
EXTENT_DIRTY
;

2832 
m¬k
 = 
EXTENT_NEW
;

2837 
	`blk_¡¬t_¶ug
(&
¶ug
);

2838 
»t
 = 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
fs_šfo
, &
log
->
dœty_log_·ges
, 
m¬k
);

2839 ià(
»t
) {

2840 
	`blk_fšish_¶ug
(&
¶ug
);

2841 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2842 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 
log_Œªsid
);

2843 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

2844 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2845 
out
;

2848 
	`bŒfs_£t_roÙ_node
(&
log
->
roÙ_™em
,†og->
node
);

2850 
roÙ
->
log_Œªsid
++;

2851 
log
->
log_Œªsid
 = 
roÙ
->log_transid;

2852 
roÙ
->
log_¡¬t_pid
 = 0;

2858 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2860 
	`bŒfs_š™_log_ùx
(&
roÙ_log_ùx
, 
NULL
);

2862 
	`mu‹x_lock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2863 
	`©omic_šc
(&
log_roÙ_Œ“
->
log_b©ch
);

2864 
	`©omic_šc
(&
log_roÙ_Œ“
->
log_wr™”s
);

2866 
šdex2
 = 
log_roÙ_Œ“
->
log_Œªsid
 % 2;

2867 
	`li¡_add_ž
(&
roÙ_log_ùx
.
li¡
, &
log_roÙ_Œ“
->
log_ùxs
[
šdex2
]);

2868 
roÙ_log_ùx
.
log_Œªsid
 = 
log_roÙ_Œ“
->log_transid;

2870 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2872 
»t
 = 
	`upd©e_log_roÙ
(
Œªs
, 
log
);

2874 
	`mu‹x_lock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2875 ià(
	`©omic_dec_ªd_‹¡
(&
log_roÙ_Œ“
->
log_wr™”s
)) {

2879 ià(
	`wa™queue_aùive
(&
log_roÙ_Œ“
->
log_wr™”_wa™
))

2880 
	`wake_up
(&
log_roÙ_Œ“
->
log_wr™”_wa™
);

2883 ià(
»t
) {

2884 ià(!
	`li¡_em±y
(&
roÙ_log_ùx
.
li¡
))

2885 
	`li¡_d–_š™
(&
roÙ_log_ùx
.
li¡
);

2887 
	`blk_fšish_¶ug
(&
¶ug
);

2888 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

2890 ià(
»t
 !ð-
ENOSPC
) {

2891 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2892 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2893 
out
;

2895 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

2896 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 
log_Œªsid
);

2897 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2898 
»t
 = -
EAGAIN
;

2899 
out
;

2902 ià(
log_roÙ_Œ“
->
log_Œªsid_comm™‹d
 >ð
roÙ_log_ùx
.
log_Œªsid
) {

2903 
	`blk_fšish_¶ug
(&
¶ug
);

2904 
	`li¡_d–_š™
(&
roÙ_log_ùx
.
li¡
);

2905 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2906 
»t
 = 
roÙ_log_ùx
.
log_»t
;

2907 
out
;

2910 
šdex2
 = 
roÙ_log_ùx
.
log_Œªsid
 % 2;

2911 ià(
	`©omic_»ad
(&
log_roÙ_Œ“
->
log_comm™
[
šdex2
])) {

2912 
	`blk_fšish_¶ug
(&
¶ug
);

2913 
»t
 = 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

2914 
	`bŒfs_wa™_logged_ex‹Ás
(
Œªs
, 
log
, 
log_Œªsid
);

2915 
	`wa™_log_comm™
(
log_roÙ_Œ“
,

2916 
roÙ_log_ùx
.
log_Œªsid
);

2917 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2918 ià(!
»t
)

2919 
»t
 = 
roÙ_log_ùx
.
log_»t
;

2920 
out
;

2922 
	`ASSERT
(
roÙ_log_ùx
.
log_Œªsid
 =ð
log_roÙ_Œ“
->log_transid);

2923 
	`©omic_£t
(&
log_roÙ_Œ“
->
log_comm™
[
šdex2
], 1);

2925 ià(
	`©omic_»ad
(&
log_roÙ_Œ“
->
log_comm™
[(
šdex2
 + 1) % 2])) {

2926 
	`wa™_log_comm™
(
log_roÙ_Œ“
,

2927 
roÙ_log_ùx
.
log_Œªsid
 - 1);

2930 
	`wa™_fÜ_wr™”
(
log_roÙ_Œ“
);

2936 ià(
	`bŒfs_Ãed_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
)) {

2937 
	`blk_fšish_¶ug
(&
¶ug
);

2938 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

2939 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 
log_Œªsid
);

2940 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2941 
»t
 = -
EAGAIN
;

2942 
out_wake_log_roÙ
;

2945 
»t
 = 
	`bŒfs_wr™e_m¬ked_ex‹Ás
(
fs_šfo
,

2946 &
log_roÙ_Œ“
->
dœty_log_·ges
,

2947 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

2948 
	`blk_fšish_¶ug
(&
¶ug
);

2949 ià(
»t
) {

2950 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

2951 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2952 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 
log_Œªsid
);

2953 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2954 
out_wake_log_roÙ
;

2956 
»t
 = 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log
, 
m¬k
);

2957 ià(!
»t
)

2958 
»t
 = 
	`bŒfs_wa™_Œ“_log_ex‹Ás
(
log_roÙ_Œ“
,

2959 
EXTENT_NEW
 | 
EXTENT_DIRTY
);

2960 ià(
»t
) {

2961 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

2962 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 
log_Œªsid
);

2963 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2964 
out_wake_log_roÙ
;

2966 
	`bŒfs_wa™_logged_ex‹Ás
(
Œªs
, 
log
, 
log_Œªsid
);

2968 
	`bŒfs_£t_su³r_log_roÙ
(
fs_šfo
->
su³r_fÜ_comm™
,

2969 
log_roÙ_Œ“
->
node
->
¡¬t
);

2970 
	`bŒfs_£t_su³r_log_roÙ_Ëv–
(
fs_šfo
->
su³r_fÜ_comm™
,

2971 
	`bŒfs_h—d”_Ëv–
(
log_roÙ_Œ“
->
node
));

2973 
log_roÙ_Œ“
->
log_Œªsid
++;

2974 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2983 
»t
 = 
	`wr™e_®l_su³rs
(
fs_šfo
, 1);

2984 ià(
»t
) {

2985 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

2986 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2987 
out_wake_log_roÙ
;

2990 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

2991 ià(
roÙ
->
Ï¡_log_comm™
 < 
log_Œªsid
)

2992 
roÙ
->
Ï¡_log_comm™
 = 
log_Œªsid
;

2993 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

2995 
out_wake_log_roÙ
:

2996 
	`mu‹x_lock
(&
log_roÙ_Œ“
->
log_mu‹x
);

2997 
	`bŒfs_»move_®l_log_ùxs
(
log_roÙ_Œ“
, 
šdex2
, 
»t
);

2999 
log_roÙ_Œ“
->
log_Œªsid_comm™‹d
++;

3000 
	`©omic_£t
(&
log_roÙ_Œ“
->
log_comm™
[
šdex2
], 0);

3001 
	`mu‹x_uÆock
(&
log_roÙ_Œ“
->
log_mu‹x
);

3006 ià(
	`wa™queue_aùive
(&
log_roÙ_Œ“
->
log_comm™_wa™
[
šdex2
]))

3007 
	`wake_up
(&
log_roÙ_Œ“
->
log_comm™_wa™
[
šdex2
]);

3008 
out
:

3009 
	`mu‹x_lock
(&
roÙ
->
log_mu‹x
);

3010 
	`bŒfs_»move_®l_log_ùxs
(
roÙ
, 
šdex1
, 
»t
);

3011 
roÙ
->
log_Œªsid_comm™‹d
++;

3012 
	`©omic_£t
(&
roÙ
->
log_comm™
[
šdex1
], 0);

3013 
	`mu‹x_uÆock
(&
roÙ
->
log_mu‹x
);

3018 ià(
	`wa™queue_aùive
(&
roÙ
->
log_comm™_wa™
[
šdex1
]))

3019 
	`wake_up
(&
roÙ
->
log_comm™_wa™
[
šdex1
]);

3020  
»t
;

3021 
	}
}

3023 
	$ä“_log_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3024 
bŒfs_roÙ
 *
log
)

3026 
»t
;

3027 
u64
 
¡¬t
;

3028 
u64
 
’d
;

3029 
w®k_cÚŒÞ
 
wc
 = {

3030 .
ä“
 = 1,

3031 .
´oûss_func
 = 
´oûss_Úe_bufãr


3034 
»t
 = 
	`w®k_log_Œ“
(
Œªs
, 
log
, &
wc
);

3036 ià(
»t
)

3037 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3040 
»t
 = 
	`fšd_fœ¡_ex‹Á_b™
(&
log
->
dœty_log_·ges
,

3041 0, &
¡¬t
, &
’d
, 
EXTENT_DIRTY
 | 
EXTENT_NEW
,

3042 
NULL
);

3043 ià(
»t
)

3046 
	`þ—r_ex‹Á_b™s
(&
log
->
dœty_log_·ges
, 
¡¬t
, 
’d
,

3047 
EXTENT_DIRTY
 | 
EXTENT_NEW
);

3055 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 0);

3056 
	`bŒfs_ä“_logged_ex‹Ás
(
log
, 1);

3058 
	`ä“_ex‹Á_bufãr
(
log
->
node
);

3059 
	`kä“
(
log
);

3060 
	}
}

3066 
	$bŒfs_ä“_log
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
)

3068 ià(
roÙ
->
log_roÙ
) {

3069 
	`ä“_log_Œ“
(
Œªs
, 
roÙ
->
log_roÙ
);

3070 
roÙ
->
log_roÙ
 = 
NULL
;

3073 
	}
}

3075 
	$bŒfs_ä“_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3076 
bŒfs_fs_šfo
 *
fs_šfo
)

3078 ià(
fs_šfo
->
log_roÙ_Œ“
) {

3079 
	`ä“_log_Œ“
(
Œªs
, 
fs_šfo
->
log_roÙ_Œ“
);

3080 
fs_šfo
->
log_roÙ_Œ“
 = 
NULL
;

3083 
	}
}

3106 
	$bŒfs_d–_dœ_’Œ›s_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3107 
bŒfs_roÙ
 *
roÙ
,

3108 cÚ¡ *
Çme
, 
Çme_Ën
,

3109 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
)

3111 
bŒfs_roÙ
 *
log
;

3112 
bŒfs_dœ_™em
 *
di
;

3113 
bŒfs_·th
 *
·th
;

3114 
»t
;

3115 
”r
 = 0;

3116 
by‹s_d–
 = 0;

3117 
u64
 
dœ_šo
 = 
	`bŒfs_šo
(
dœ
);

3119 ià(
dœ
->
logged_Œªs
 < 
Œªs
->
Œªsid
)

3122 
»t
 = 
	`još_ruÂšg_log_Œªs
(
roÙ
);

3123 ià(
»t
)

3126 
	`mu‹x_lock
(&
dœ
->
log_mu‹x
);

3128 
log
 = 
roÙ
->
log_roÙ
;

3129 
·th
 = 
	`bŒfs_®loc_·th
();

3130 ià(!
·th
) {

3131 
”r
 = -
ENOMEM
;

3132 
out_uÆock
;

3135 
di
 = 
	`bŒfs_lookup_dœ_™em
(
Œªs
, 
log
, 
·th
, 
dœ_šo
,

3136 
Çme
, 
Çme_Ën
, -1);

3137 ià(
	`IS_ERR
(
di
)) {

3138 
”r
 = 
	`PTR_ERR
(
di
);

3139 
çž
;

3141 ià(
di
) {

3142 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
log
, 
·th
, 
di
);

3143 
by‹s_d–
 +ð
Çme_Ën
;

3144 ià(
»t
) {

3145 
”r
 = 
»t
;

3146 
çž
;

3149 
	`bŒfs_»Ëa£_·th
(
·th
);

3150 
di
 = 
	`bŒfs_lookup_dœ_šdex_™em
(
Œªs
, 
log
, 
·th
, 
dœ_šo
,

3151 
šdex
, 
Çme
, 
Çme_Ën
, -1);

3152 ià(
	`IS_ERR
(
di
)) {

3153 
”r
 = 
	`PTR_ERR
(
di
);

3154 
çž
;

3156 ià(
di
) {

3157 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
log
, 
·th
, 
di
);

3158 
by‹s_d–
 +ð
Çme_Ën
;

3159 ià(
»t
) {

3160 
”r
 = 
»t
;

3161 
çž
;

3168 ià(
by‹s_d–
) {

3169 
bŒfs_key
 
key
;

3171 
key
.
objeùid
 = 
dœ_šo
;

3172 
key
.
off£t
 = 0;

3173 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

3174 
	`bŒfs_»Ëa£_·th
(
·th
);

3176 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
log
, &
key
, 
·th
, 0, 1);

3177 ià(
»t
 < 0) {

3178 
”r
 = 
»t
;

3179 
çž
;

3181 ià(
»t
 == 0) {

3182 
bŒfs_šode_™em
 *
™em
;

3183 
u64
 
i_size
;

3185 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3186 
bŒfs_šode_™em
);

3187 
i_size
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0], 
™em
);

3188 ià(
i_size
 > 
by‹s_d–
)

3189 
i_size
 -ð
by‹s_d–
;

3191 
i_size
 = 0;

3192 
	`bŒfs_£t_šode_size
(
·th
->
nodes
[0], 
™em
, 
i_size
);

3193 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

3195 
»t
 = 0;

3196 
	`bŒfs_»Ëa£_·th
(
·th
);

3198 
çž
:

3199 
	`bŒfs_ä“_·th
(
·th
);

3200 
out_uÆock
:

3201 
	`mu‹x_uÆock
(&
dœ
->
log_mu‹x
);

3202 ià(
»t
 =ð-
ENOSPC
) {

3203 
	`bŒfs_£t_log_fuÎ_comm™
(
roÙ
->
fs_šfo
, 
Œªs
);

3204 
»t
 = 0;

3205 } ià(
»t
 < 0)

3206 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3208 
	`bŒfs_’d_log_Œªs
(
roÙ
);

3210  
”r
;

3211 
	}
}

3214 
	$bŒfs_d–_šode_»f_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3215 
bŒfs_roÙ
 *
roÙ
,

3216 cÚ¡ *
Çme
, 
Çme_Ën
,

3217 
bŒfs_šode
 *
šode
, 
u64
 
dœid
)

3219 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3220 
bŒfs_roÙ
 *
log
;

3221 
u64
 
šdex
;

3222 
»t
;

3224 ià(
šode
->
logged_Œªs
 < 
Œªs
->
Œªsid
)

3227 
»t
 = 
	`još_ruÂšg_log_Œªs
(
roÙ
);

3228 ià(
»t
)

3230 
log
 = 
roÙ
->
log_roÙ
;

3231 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

3233 
»t
 = 
	`bŒfs_d–_šode_»f
(
Œªs
, 
log
, 
Çme
, 
Çme_Ën
, 
	`bŒfs_šo
(
šode
),

3234 
dœid
, &
šdex
);

3235 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

3236 ià(
»t
 =ð-
ENOSPC
) {

3237 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

3238 
»t
 = 0;

3239 } ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

3240 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

3241 
	`bŒfs_’d_log_Œªs
(
roÙ
);

3243  
»t
;

3244 
	}
}

3251 
nošlše
 
	$š£¹_dœ_log_key
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3252 
bŒfs_roÙ
 *
log
,

3253 
bŒfs_·th
 *
·th
,

3254 
key_ty³
, 
u64
 
dœid
,

3255 
u64
 
fœ¡_off£t
, u64 
Ï¡_off£t
)

3257 
»t
;

3258 
bŒfs_key
 
key
;

3259 
bŒfs_dœ_log_™em
 *
™em
;

3261 
key
.
objeùid
 = 
dœid
;

3262 
key
.
off£t
 = 
fœ¡_off£t
;

3263 ià(
key_ty³
 =ð
BTRFS_DIR_ITEM_KEY
)

3264 
key
.
ty³
 = 
BTRFS_DIR_LOG_ITEM_KEY
;

3266 
key
.
ty³
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

3267 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
log
, 
·th
, &
key
, (*
™em
));

3268 ià(
»t
)

3269  
»t
;

3271 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3272 
bŒfs_dœ_log_™em
);

3273 
	`bŒfs_£t_dœ_log_’d
(
·th
->
nodes
[0], 
™em
, 
Ï¡_off£t
);

3274 
	`bŒfs_m¬k_bufãr_dœty
(
·th
->
nodes
[0]);

3275 
	`bŒfs_»Ëa£_·th
(
·th
);

3277 
	}
}

3284 
nošlše
 
	$log_dœ_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3285 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

3286 
bŒfs_·th
 *
·th
,

3287 
bŒfs_·th
 *
d¡_·th
, 
key_ty³
,

3288 
bŒfs_log_ùx
 *
ùx
,

3289 
u64
 
mš_off£t
, u64 *
Ï¡_off£t_»t
)

3291 
bŒfs_key
 
mš_key
;

3292 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

3293 
ex‹Á_bufãr
 *
¤c
;

3294 
”r
 = 0;

3295 
»t
;

3296 
i
;

3297 
Ä™ems
;

3298 
u64
 
fœ¡_off£t
 = 
mš_off£t
;

3299 
u64
 
Ï¡_off£t
 = (u64)-1;

3300 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

3302 
log
 = 
roÙ
->
log_roÙ
;

3304 
mš_key
.
objeùid
 = 
šo
;

3305 
mš_key
.
ty³
 = 
key_ty³
;

3306 
mš_key
.
off£t
 = 
mš_off£t
;

3308 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
mš_key
, 
·th
, 
Œªs
->
Œªsid
);

3314 ià(
»t
 !ð0 || 
mš_key
.
objeùid
 !ð
šo
 || mš_key.
ty³
 !ð
key_ty³
) {

3315 
mš_key
.
objeùid
 = 
šo
;

3316 
mš_key
.
ty³
 = 
key_ty³
;

3317 
mš_key
.
off£t
 = (
u64
)-1;

3318 
	`bŒfs_»Ëa£_·th
(
·th
);

3319 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
mš_key
, 
·th
, 0, 0);

3320 ià(
»t
 < 0) {

3321 
	`bŒfs_»Ëa£_·th
(
·th
);

3322  
»t
;

3324 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
šo
, 
key_ty³
);

3331 ià(
»t
 == 0) {

3332 
bŒfs_key
 
tmp
;

3333 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
tmp
,

3334 
·th
->
¦Ùs
[0]);

3335 ià(
key_ty³
 =ð
tmp
.
ty³
)

3336 
fœ¡_off£t
 = 
	`max
(
mš_off£t
, 
tmp
.
off£t
) + 1;

3338 
dÚe
;

3342 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
šo
, 
key_ty³
);

3343 ià(
»t
 == 0) {

3344 
bŒfs_key
 
tmp
;

3345 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
tmp
,…©h->
¦Ùs
[0]);

3346 ià(
key_ty³
 =ð
tmp
.
ty³
) {

3347 
fœ¡_off£t
 = 
tmp
.
off£t
;

3348 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
log
, 
d¡_·th
,

3349 
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3350 &
tmp
);

3351 ià(
»t
) {

3352 
”r
 = 
»t
;

3353 
dÚe
;

3357 
	`bŒfs_»Ëa£_·th
(
·th
);

3360 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
mš_key
, 
·th
, 0, 0);

3361 ià(
	`WARN_ON
(
»t
 != 0))

3362 
dÚe
;

3369 
bŒfs_key
 
tmp
;

3370 
¤c
 = 
·th
->
nodes
[0];

3371 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
¤c
);

3372 
i
 = 
·th
->
¦Ùs
[0]; i < 
Ä™ems
; i++) {

3373 
bŒfs_dœ_™em
 *
di
;

3375 
	`bŒfs_™em_key_to_ýu
(
¤c
, &
mš_key
, 
i
);

3377 ià(
mš_key
.
objeùid
 !ð
šo
 || mš_key.
ty³
 !ð
key_ty³
)

3378 
dÚe
;

3379 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
log
, 
d¡_·th
, 
¤c
, 
i
,

3380 &
mš_key
);

3381 ià(
»t
) {

3382 
”r
 = 
»t
;

3383 
dÚe
;

3409 
di
 = 
	`bŒfs_™em_±r
(
¤c
, 
i
, 
bŒfs_dœ_™em
);

3410 
	`bŒfs_dœ_™em_key_to_ýu
(
¤c
, 
di
, &
tmp
);

3411 ià(
ùx
 &&

3412 (
	`bŒfs_dœ_Œªsid
(
¤c
, 
di
è=ð
Œªs
->
Œªsid
 ||

3413 
	`bŒfs_dœ_ty³
(
¤c
, 
di
è=ð
BTRFS_FT_DIR
) &&

3414 
tmp
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
)

3415 
ùx
->
log_Ãw_d’Œ›s
 = 
Œue
;

3417 
·th
->
¦Ùs
[0] = 
Ä™ems
;

3423 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

3424 ià(
»t
 == 1) {

3425 
Ï¡_off£t
 = (
u64
)-1;

3426 
dÚe
;

3428 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
tmp
,…©h->
¦Ùs
[0]);

3429 ià(
tmp
.
objeùid
 !ð
šo
 ||mp.
ty³
 !ð
key_ty³
) {

3430 
Ï¡_off£t
 = (
u64
)-1;

3431 
dÚe
;

3433 ià(
	`bŒfs_h—d”_g’”©iÚ
(
·th
->
nodes
[0]è!ð
Œªs
->
Œªsid
) {

3434 
»t
 = 
	`ov”wr™e_™em
(
Œªs
, 
log
, 
d¡_·th
,

3435 
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3436 &
tmp
);

3437 ià(
»t
)

3438 
”r
 = 
»t
;

3440 
Ï¡_off£t
 = 
tmp
.
off£t
;

3441 
dÚe
;

3444 
dÚe
:

3445 
	`bŒfs_»Ëa£_·th
(
·th
);

3446 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

3448 ià(
”r
 == 0) {

3449 *
Ï¡_off£t_»t
 = 
Ï¡_off£t
;

3454 
»t
 = 
	`š£¹_dœ_log_key
(
Œªs
, 
log
, 
·th
, 
key_ty³
,

3455 
šo
, 
fœ¡_off£t
, 
Ï¡_off£t
);

3456 ià(
»t
)

3457 
”r
 = 
»t
;

3459  
”r
;

3460 
	}
}

3474 
nošlše
 
	$log_dœeùÜy_chªges
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3475 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

3476 
bŒfs_·th
 *
·th
,

3477 
bŒfs_·th
 *
d¡_·th
,

3478 
bŒfs_log_ùx
 *
ùx
)

3480 
u64
 
mš_key
;

3481 
u64
 
max_key
;

3482 
»t
;

3483 
key_ty³
 = 
BTRFS_DIR_ITEM_KEY
;

3485 
agaš
:

3486 
mš_key
 = 0;

3487 
max_key
 = 0;

3489 
»t
 = 
	`log_dœ_™ems
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
d¡_·th
, 
key_ty³
,

3490 
ùx
, 
mš_key
, &
max_key
);

3491 ià(
»t
)

3492  
»t
;

3493 ià(
max_key
 =ð(
u64
)-1)

3495 
mš_key
 = 
max_key
 + 1;

3498 ià(
key_ty³
 =ð
BTRFS_DIR_ITEM_KEY
) {

3499 
key_ty³
 = 
BTRFS_DIR_INDEX_KEY
;

3500 
agaš
;

3503 
	}
}

3511 
	$drÝ_objeùid_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3512 
bŒfs_roÙ
 *
log
,

3513 
bŒfs_·th
 *
·th
,

3514 
u64
 
objeùid
, 
max_key_ty³
)

3516 
»t
;

3517 
bŒfs_key
 
key
;

3518 
bŒfs_key
 
found_key
;

3519 
¡¬t_¦Ù
;

3521 
key
.
objeùid
 = objectid;

3522 
key
.
ty³
 = 
max_key_ty³
;

3523 
key
.
off£t
 = (
u64
)-1;

3526 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
log
, &
key
, 
·th
, -1, 1);

3527 
	`BUG_ON
(
»t
 == 0);

3528 ià(
»t
 < 0)

3531 ià(
·th
->
¦Ùs
[0] == 0)

3534 
·th
->
¦Ùs
[0]--;

3535 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

3536 
·th
->
¦Ùs
[0]);

3538 ià(
found_key
.
objeùid
 != objectid)

3541 
found_key
.
off£t
 = 0;

3542 
found_key
.
ty³
 = 0;

3543 
»t
 = 
	`bŒfs_bš_£¬ch
(
·th
->
nodes
[0], &
found_key
, 0,

3544 &
¡¬t_¦Ù
);

3546 
»t
 = 
	`bŒfs_d–_™ems
(
Œªs
, 
log
, 
·th
, 
¡¬t_¦Ù
,

3547 
·th
->
¦Ùs
[0] - 
¡¬t_¦Ù
 + 1);

3552 ià(
»t
 || 
¡¬t_¦Ù
 != 0)

3554 
	`bŒfs_»Ëa£_·th
(
·th
);

3556 
	`bŒfs_»Ëa£_·th
(
·th
);

3557 ià(
»t
 > 0)

3558 
»t
 = 0;

3559  
»t
;

3560 
	}
}

3562 
	$fžl_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3563 
ex‹Á_bufãr
 *
Ëaf
,

3564 
bŒfs_šode_™em
 *
™em
,

3565 
šode
 *šode, 
log_šode_Úly
,

3566 
u64
 
logged_isize
)

3568 
bŒfs_m­_tok’
 
tok’
;

3570 
	`bŒfs_š™_m­_tok’
(&
tok’
);

3572 ià(
log_šode_Úly
) {

3578 
	`bŒfs_£t_tok’_šode_g’”©iÚ
(
Ëaf
, 
™em
, 0, &
tok’
);

3579 
	`bŒfs_£t_tok’_šode_size
(
Ëaf
, 
™em
, 
logged_isize
, &
tok’
);

3581 
	`bŒfs_£t_tok’_šode_g’”©iÚ
(
Ëaf
, 
™em
,

3582 
	`BTRFS_I
(
šode
)->
g’”©iÚ
,

3583 &
tok’
);

3584 
	`bŒfs_£t_tok’_šode_size
(
Ëaf
, 
™em
, 
šode
->
i_size
, &
tok’
);

3587 
	`bŒfs_£t_tok’_šode_uid
(
Ëaf
, 
™em
, 
	`i_uid_»ad
(
šode
), &
tok’
);

3588 
	`bŒfs_£t_tok’_šode_gid
(
Ëaf
, 
™em
, 
	`i_gid_»ad
(
šode
), &
tok’
);

3589 
	`bŒfs_£t_tok’_šode_mode
(
Ëaf
, 
™em
, 
šode
->
i_mode
, &
tok’
);

3590 
	`bŒfs_£t_tok’_šode_Æšk
(
Ëaf
, 
™em
, 
šode
->
i_Æšk
, &
tok’
);

3592 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
©ime
,

3593 
šode
->
i_©ime
.
tv_£c
, &
tok’
);

3594 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
©ime
,

3595 
šode
->
i_©ime
.
tv_n£c
, &
tok’
);

3597 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
mtime
,

3598 
šode
->
i_mtime
.
tv_£c
, &
tok’
);

3599 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
mtime
,

3600 
šode
->
i_mtime
.
tv_n£c
, &
tok’
);

3602 
	`bŒfs_£t_tok’_time¥ec_£c
(
Ëaf
, &
™em
->
ùime
,

3603 
šode
->
i_ùime
.
tv_£c
, &
tok’
);

3604 
	`bŒfs_£t_tok’_time¥ec_n£c
(
Ëaf
, &
™em
->
ùime
,

3605 
šode
->
i_ùime
.
tv_n£c
, &
tok’
);

3607 
	`bŒfs_£t_tok’_šode_nby‹s
(
Ëaf
, 
™em
, 
	`šode_g‘_by‹s
(
šode
),

3608 &
tok’
);

3610 
	`bŒfs_£t_tok’_šode_£qu’û
(
Ëaf
, 
™em
, 
šode
->
i_v”siÚ
, &
tok’
);

3611 
	`bŒfs_£t_tok’_šode_Œªsid
(
Ëaf
, 
™em
, 
Œªs
->
Œªsid
, &
tok’
);

3612 
	`bŒfs_£t_tok’_šode_rdev
(
Ëaf
, 
™em
, 
šode
->
i_rdev
, &
tok’
);

3613 
	`bŒfs_£t_tok’_šode_æags
(
Ëaf
, 
™em
, 
	`BTRFS_I
(
šode
)->
æags
, &
tok’
);

3614 
	`bŒfs_£t_tok’_šode_block_group
(
Ëaf
, 
™em
, 0, &
tok’
);

3615 
	}
}

3617 
	$log_šode_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3618 
bŒfs_roÙ
 *
log
, 
bŒfs_·th
 *
·th
,

3619 
bŒfs_šode
 *
šode
)

3621 
bŒfs_šode_™em
 *
šode_™em
;

3622 
»t
;

3624 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
log
, 
·th
,

3625 &
šode
->
loÿtiÚ
, (*
šode_™em
));

3626 ià(
»t
 &&„‘ !ð-
EEXIST
)

3627  
»t
;

3628 
šode_™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

3629 
bŒfs_šode_™em
);

3630 
	`fžl_šode_™em
(
Œªs
, 
·th
->
nodes
[0], 
šode_™em
, &
šode
->
vfs_šode
,

3632 
	`bŒfs_»Ëa£_·th
(
·th
);

3634 
	}
}

3636 
nošlše
 
	$cÝy_™ems
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3637 
bŒfs_šode
 *
šode
,

3638 
bŒfs_·th
 *
d¡_·th
,

3639 
bŒfs_·th
 *
¤c_·th
, 
u64
 *
Ï¡_ex‹Á
,

3640 
¡¬t_¦Ù
, 
Ä
, 
šode_Úly
,

3641 
u64
 
logged_isize
)

3643 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

3644 
¤c_off£t
;

3645 
d¡_off£t
;

3646 
bŒfs_roÙ
 *
log
 = 
šode
->
roÙ
->
log_roÙ
;

3647 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

3648 
bŒfs_šode_™em
 *
šode_™em
;

3649 
ex‹Á_bufãr
 *
¤c
 = 
¤c_·th
->
nodes
[0];

3650 
bŒfs_key
 
fœ¡_key
, 
Ï¡_key
, 
key
;

3651 
»t
;

3652 
bŒfs_key
 *
šs_keys
;

3653 
u32
 *
šs_sizes
;

3654 *
šs_d©a
;

3655 
i
;

3656 
li¡_h—d
 
Üd”ed_sums
;

3657 
sk_csum
 = 
šode
->
æags
 & 
BTRFS_INODE_NODATASUM
;

3658 
boÞ
 
has_ex‹Ás
 = 
çl£
;

3659 
boÞ
 
Ãed_fšd_Ï¡_ex‹Á
 = 
Œue
;

3660 
boÞ
 
dÚe
 = 
çl£
;

3662 
	`INIT_LIST_HEAD
(&
Üd”ed_sums
);

3664 
šs_d©a
 = 
	`km®loc
(
Ä
 * (
bŒfs_key
) +

3665 
Ä
 * (
u32
), 
GFP_NOFS
);

3666 ià(!
šs_d©a
)

3667  -
ENOMEM
;

3669 
fœ¡_key
.
objeùid
 = (
u64
)-1;

3671 
šs_sizes
 = (
u32
 *)
šs_d©a
;

3672 
šs_keys
 = (
bŒfs_key
 *)(
šs_d©a
 + 
Ä
 * (
u32
));

3674 
i
 = 0; i < 
Ä
; i++) {

3675 
šs_sizes
[
i
] = 
	`bŒfs_™em_size_Ä
(
¤c
, i + 
¡¬t_¦Ù
);

3676 
	`bŒfs_™em_key_to_ýu
(
¤c
, 
šs_keys
 + 
i
, i + 
¡¬t_¦Ù
);

3678 
»t
 = 
	`bŒfs_š£¹_em±y_™ems
(
Œªs
, 
log
, 
d¡_·th
,

3679 
šs_keys
, 
šs_sizes
, 
Ä
);

3680 ià(
»t
) {

3681 
	`kä“
(
šs_d©a
);

3682  
»t
;

3685 
i
 = 0; i < 
Ä
; i++, 
d¡_·th
->
¦Ùs
[0]++) {

3686 
d¡_off£t
 = 
	`bŒfs_™em_±r_off£t
(
d¡_·th
->
nodes
[0],

3687 
d¡_·th
->
¦Ùs
[0]);

3689 
¤c_off£t
 = 
	`bŒfs_™em_±r_off£t
(
¤c
, 
¡¬t_¦Ù
 + 
i
);

3691 ià(
i
 =ð
Ä
 - 1)

3692 
Ï¡_key
 = 
šs_keys
[
i
];

3694 ià(
šs_keys
[
i
].
ty³
 =ð
BTRFS_INODE_ITEM_KEY
) {

3695 
šode_™em
 = 
	`bŒfs_™em_±r
(
d¡_·th
->
nodes
[0],

3696 
d¡_·th
->
¦Ùs
[0],

3697 
bŒfs_šode_™em
);

3698 
	`fžl_šode_™em
(
Œªs
, 
d¡_·th
->
nodes
[0], 
šode_™em
,

3699 &
šode
->
vfs_šode
,

3700 
šode_Úly
 =ð
LOG_INODE_EXISTS
,

3701 
logged_isize
);

3703 
	`cÝy_ex‹Á_bufãr
(
d¡_·th
->
nodes
[0], 
¤c
, 
d¡_off£t
,

3704 
¤c_off£t
, 
šs_sizes
[
i
]);

3713 ià(
šs_keys
[
i
].
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
) {

3714 
has_ex‹Ás
 = 
Œue
;

3715 ià(
fœ¡_key
.
objeùid
 =ð(
u64
)-1)

3716 
fœ¡_key
 = 
šs_keys
[
i
];

3718 
Ãed_fšd_Ï¡_ex‹Á
 = 
çl£
;

3725 ià(
šs_keys
[
i
].
ty³
 =ð
BTRFS_EXTENT_DATA_KEY
 &&

3726 !
sk_csum
) {

3727 
found_ty³
;

3728 
ex‹Á
 = 
	`bŒfs_™em_±r
(
¤c
, 
¡¬t_¦Ù
 + 
i
,

3729 
bŒfs_fže_ex‹Á_™em
);

3731 ià(
	`bŒfs_fže_ex‹Á_g’”©iÚ
(
¤c
, 
ex‹Á
è< 
Œªs
->
Œªsid
)

3734 
found_ty³
 = 
	`bŒfs_fže_ex‹Á_ty³
(
¤c
, 
ex‹Á
);

3735 ià(
found_ty³
 =ð
BTRFS_FILE_EXTENT_REG
) {

3736 
u64
 
ds
, 
dl
, 
cs
, 
þ
;

3737 
ds
 = 
	`bŒfs_fže_ex‹Á_disk_by‹Ä
(
¤c
,

3738 
ex‹Á
);

3740 ià(
ds
 == 0)

3743 
dl
 = 
	`bŒfs_fže_ex‹Á_disk_num_by‹s
(
¤c
,

3744 
ex‹Á
);

3745 
cs
 = 
	`bŒfs_fže_ex‹Á_off£t
(
¤c
, 
ex‹Á
);

3746 
þ
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
¤c
,

3747 
ex‹Á
);

3748 ià(
	`bŒfs_fže_ex‹Á_com´essiÚ
(
¤c
,

3749 
ex‹Á
)) {

3750 
cs
 = 0;

3751 
þ
 = 
dl
;

3754 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(

3755 
fs_šfo
->
csum_roÙ
,

3756 
ds
 + 
cs
, d + c + 
þ
 - 1,

3757 &
Üd”ed_sums
, 0);

3758 ià(
»t
) {

3759 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

3760 
	`kä“
(
šs_d©a
);

3761  
»t
;

3767 
	`bŒfs_m¬k_bufãr_dœty
(
d¡_·th
->
nodes
[0]);

3768 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

3769 
	`kä“
(
šs_d©a
);

3775 
»t
 = 0;

3776 !
	`li¡_em±y
(&
Üd”ed_sums
)) {

3777 
bŒfs_Üd”ed_sum
 *
sums
 = 
	`li¡_’Œy
(
Üd”ed_sums
.
Ãxt
,

3778 
bŒfs_Üd”ed_sum
,

3779 
li¡
);

3780 ià(!
»t
)

3781 
»t
 = 
	`bŒfs_csum_fže_blocks
(
Œªs
, 
log
, 
sums
);

3782 
	`li¡_d–
(&
sums
->
li¡
);

3783 
	`kä“
(
sums
);

3786 ià(!
has_ex‹Ás
)

3787  
»t
;

3789 ià(
Ãed_fšd_Ï¡_ex‹Á
 && *
Ï¡_ex‹Á
 =ð
fœ¡_key
.
off£t
) {

3796 
Ãed_fšd_Ï¡_ex‹Á
 = 
çl£
;

3805 ià(
Ãed_fšd_Ï¡_ex‹Á
) {

3806 
u64
 
Ën
;

3808 
»t
 = 
	`bŒfs_´ev_Ëaf
(
šode
->
roÙ
, 
¤c_·th
);

3809 ià(
»t
 < 0)

3810  
»t
;

3811 ià(
»t
)

3812 
fžl_hÞes
;

3813 ià(
¤c_·th
->
¦Ùs
[0])

3814 
¤c_·th
->
¦Ùs
[0]--;

3815 
¤c
 = 
¤c_·th
->
nodes
[0];

3816 
	`bŒfs_™em_key_to_ýu
(
¤c
, &
key
, 
¤c_·th
->
¦Ùs
[0]);

3817 ià(
key
.
objeùid
 !ð
	`bŒfs_šo
(
šode
) ||

3818 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
)

3819 
fžl_hÞes
;

3820 
ex‹Á
 = 
	`bŒfs_™em_±r
(
¤c
, 
¤c_·th
->
¦Ùs
[0],

3821 
bŒfs_fže_ex‹Á_™em
);

3822 ià(
	`bŒfs_fže_ex‹Á_ty³
(
¤c
, 
ex‹Á
) ==

3823 
BTRFS_FILE_EXTENT_INLINE
) {

3824 
Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
¤c
,

3825 
¤c_·th
->
¦Ùs
[0],

3826 
ex‹Á
);

3827 *
Ï¡_ex‹Á
 = 
	`ALIGN
(
key
.
off£t
 + 
Ën
,

3828 
fs_šfo
->
£ùÜsize
);

3830 
Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
¤c
, 
ex‹Á
);

3831 *
Ï¡_ex‹Á
 = 
key
.
off£t
 + 
Ën
;

3834 
fžl_hÞes
:

3847 ià(
Ãed_fšd_Ï¡_ex‹Á
) {

3849 
	`bŒfs_»Ëa£_·th
(
¤c_·th
);

3850 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
šode
->
roÙ
, &
fœ¡_key
,

3851 
¤c_·th
, 0, 0);

3852 ià(
»t
 < 0)

3853  
»t
;

3854 
	`ASSERT
(
»t
 == 0);

3855 
¤c
 = 
¤c_·th
->
nodes
[0];

3856 
i
 = 
¤c_·th
->
¦Ùs
[0];

3858 
i
 = 
¡¬t_¦Ù
;

3866 !
dÚe
) {

3867 
u64
 
off£t
, 
Ën
;

3868 
u64
 
ex‹Á_’d
;

3870 ià(
i
 >ð
	`bŒfs_h—d”_Ä™ems
(
¤c_·th
->
nodes
[0])) {

3871 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
šode
->
roÙ
, 
¤c_·th
);

3872 ià(
»t
 < 0)

3873  
»t
;

3874 
	`ASSERT
(
»t
 == 0);

3875 
¤c
 = 
¤c_·th
->
nodes
[0];

3876 
i
 = 0;

3879 
	`bŒfs_™em_key_to_ýu
(
¤c
, &
key
, 
i
);

3880 ià(!
	`bŒfs_comp_ýu_keys
(&
key
, &
Ï¡_key
))

3881 
dÚe
 = 
Œue
;

3882 ià(
key
.
objeùid
 !ð
	`bŒfs_šo
(
šode
) ||

3883 
key
.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
) {

3884 
i
++;

3887 
ex‹Á
 = 
	`bŒfs_™em_±r
(
¤c
, 
i
, 
bŒfs_fže_ex‹Á_™em
);

3888 ià(
	`bŒfs_fže_ex‹Á_ty³
(
¤c
, 
ex‹Á
) ==

3889 
BTRFS_FILE_EXTENT_INLINE
) {

3890 
Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
¤c
, 
i
, 
ex‹Á
);

3891 
ex‹Á_’d
 = 
	`ALIGN
(
key
.
off£t
 + 
Ën
,

3892 
fs_šfo
->
£ùÜsize
);

3894 
Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
¤c
, 
ex‹Á
);

3895 
ex‹Á_’d
 = 
key
.
off£t
 + 
Ën
;

3897 
i
++;

3899 ià(*
Ï¡_ex‹Á
 =ð
key
.
off£t
) {

3900 *
Ï¡_ex‹Á
 = 
ex‹Á_’d
;

3903 
off£t
 = *
Ï¡_ex‹Á
;

3904 
Ën
 = 
key
.
off£t
 - *
Ï¡_ex‹Á
;

3905 
»t
 = 
	`bŒfs_š£¹_fže_ex‹Á
(
Œªs
, 
log
, 
	`bŒfs_šo
(
šode
),

3906 
off£t
, 0, 0, 
Ën
, 0,†en, 0, 0, 0);

3907 ià(
»t
)

3909 *
Ï¡_ex‹Á
 = 
ex‹Á_’d
;

3915 ià(!
»t
 && 
Ãed_fšd_Ï¡_ex‹Á
)

3916 
»t
 = 1;

3917  
»t
;

3918 
	}
}

3920 
	$ex‹Á_cmp
(*
´iv
, 
li¡_h—d
 *
a
, li¡_h—d *
b
)

3922 
ex‹Á_m­
 *
em1
, *
em2
;

3924 
em1
 = 
	`li¡_’Œy
(
a
, 
ex‹Á_m­
, 
li¡
);

3925 
em2
 = 
	`li¡_’Œy
(
b
, 
ex‹Á_m­
, 
li¡
);

3927 ià(
em1
->
¡¬t
 < 
em2
->start)

3929 ià(
em1
->
¡¬t
 > 
em2
->start)

3932 
	}
}

3934 
	$wa™_Üd”ed_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

3935 
šode
 *inode,

3936 
bŒfs_roÙ
 *
roÙ
,

3937 cÚ¡ 
ex‹Á_m­
 *
em
,

3938 cÚ¡ 
li¡_h—d
 *
logged_li¡
,

3939 
boÞ
 *
Üd”ed_io_”rÜ
)

3941 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

3942 
bŒfs_Üd”ed_ex‹Á
 *
Üd”ed
;

3943 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

3944 
u64
 
mod_¡¬t
 = 
em
->mod_start;

3945 
u64
 
mod_Ën
 = 
em
->mod_len;

3946 cÚ¡ 
boÞ
 
sk_csum
 = 
	`BTRFS_I
(
šode
)->
æags
 & 
BTRFS_INODE_NODATASUM
;

3947 
u64
 
csum_off£t
;

3948 
u64
 
csum_Ën
;

3949 
	`LIST_HEAD
(
Üd”ed_sums
);

3950 
»t
 = 0;

3952 *
Üd”ed_io_”rÜ
 = 
çl£
;

3954 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
) ||

3955 
em
->
block_¡¬t
 =ð
EXTENT_MAP_HOLE
)

3963 
	`li¡_fÜ_—ch_’Œy
(
Üd”ed
, 
logged_li¡
, 
log_li¡
) {

3964 
bŒfs_Üd”ed_sum
 *
sum
;

3966 ià(!
mod_Ën
)

3969 ià(
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 <ð
mod_¡¬t
 ||

3970 
mod_¡¬t
 + 
mod_Ën
 <ð
Üd”ed
->
fže_off£t
)

3973 ià(!
	`‹¡_b™
(
BTRFS_ORDERED_IO_DONE
, &
Üd”ed
->
æags
) &&

3974 !
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
) &&

3975 !
	`‹¡_b™
(
BTRFS_ORDERED_DIRECT
, &
Üd”ed
->
æags
)) {

3976 cÚ¡ 
u64
 
¡¬t
 = 
Üd”ed
->
fže_off£t
;

3977 cÚ¡ 
u64
 
’d
 = 
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 - 1;

3979 
	`WARN_ON
(
Üd”ed
->
šode
 != inode);

3980 
	`fžem­_fd©awr™e_¿nge
(
šode
->
i_m­pšg
, 
¡¬t
, 
’d
);

3983 
	`wa™_ev’t
(
Üd”ed
->
wa™
,

3984 (
	`‹¡_b™
(
BTRFS_ORDERED_IO_DONE
, &
Üd”ed
->
æags
) ||

3985 
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
)));

3987 ià(
	`‹¡_b™
(
BTRFS_ORDERED_IOERR
, &
Üd”ed
->
æags
)) {

3993 
	`fžem­_check_”rÜs
(
šode
->
i_m­pšg
);

3994 *
Üd”ed_io_”rÜ
 = 
Œue
;

4002 ià(
Üd”ed
->
fže_off£t
 > 
mod_¡¬t
) {

4003 ià(
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 >=

4004 
mod_¡¬t
 + 
mod_Ën
)

4005 
mod_Ën
 = 
Üd”ed
->
fže_off£t
 - 
mod_¡¬t
;

4017 ià(
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
 <

4018 
mod_¡¬t
 + 
mod_Ën
) {

4019 
mod_Ën
 = (
mod_¡¬t
 + mod_len) -

4020 (
Üd”ed
->
fže_off£t
 + ord”ed->
Ën
);

4021 
mod_¡¬t
 = 
Üd”ed
->
fže_off£t
 +

4022 
Üd”ed
->
Ën
;

4024 
mod_Ën
 = 0;

4028 ià(
sk_csum
)

4035 ià(
	`‹¡_ªd_£t_b™
(
BTRFS_ORDERED_LOGGED_CSUM
,

4036 &
Üd”ed
->
æags
))

4039 
	`li¡_fÜ_—ch_’Œy
(
sum
, &
Üd”ed
->
li¡
,†ist) {

4040 
»t
 = 
	`bŒfs_csum_fže_blocks
(
Œªs
, 
log
, 
sum
);

4041 ià(
»t
)

4046 ià(*
Üd”ed_io_”rÜ
 || !
mod_Ën
 || 
»t
 || 
sk_csum
)

4047  
»t
;

4049 ià(
em
->
com´ess_ty³
) {

4050 
csum_off£t
 = 0;

4051 
csum_Ën
 = 
	`max
(
em
->
block_Ën
,ƒm->
Üig_block_Ën
);

4053 
csum_off£t
 = 
mod_¡¬t
 - 
em
->
¡¬t
;

4054 
csum_Ën
 = 
mod_Ën
;

4058 
»t
 = 
	`bŒfs_lookup_csums_¿nge
(
fs_šfo
->
csum_roÙ
,

4059 
em
->
block_¡¬t
 + 
csum_off£t
,

4060 
em
->
block_¡¬t
 + 
csum_off£t
 +

4061 
csum_Ën
 - 1, &
Üd”ed_sums
, 0);

4062 ià(
»t
)

4063  
»t
;

4065 !
	`li¡_em±y
(&
Üd”ed_sums
)) {

4066 
bŒfs_Üd”ed_sum
 *
sums
 = 
	`li¡_’Œy
(
Üd”ed_sums
.
Ãxt
,

4067 
bŒfs_Üd”ed_sum
,

4068 
li¡
);

4069 ià(!
»t
)

4070 
»t
 = 
	`bŒfs_csum_fže_blocks
(
Œªs
, 
log
, 
sums
);

4071 
	`li¡_d–
(&
sums
->
li¡
);

4072 
	`kä“
(
sums
);

4075  
»t
;

4076 
	}
}

4078 
	$log_Úe_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4079 
bŒfs_šode
 *
šode
, 
bŒfs_roÙ
 *
roÙ
,

4080 cÚ¡ 
ex‹Á_m­
 *
em
,

4081 
bŒfs_·th
 *
·th
,

4082 cÚ¡ 
li¡_h—d
 *
logged_li¡
,

4083 
bŒfs_log_ùx
 *
ùx
)

4085 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

4086 
bŒfs_fže_ex‹Á_™em
 *
fi
;

4087 
ex‹Á_bufãr
 *
Ëaf
;

4088 
bŒfs_m­_tok’
 
tok’
;

4089 
bŒfs_key
 
key
;

4090 
u64
 
ex‹Á_off£t
 = 
em
->
¡¬t
 -ƒm->
Üig_¡¬t
;

4091 
u64
 
block_Ën
;

4092 
»t
;

4093 
ex‹Á_š£¹ed
 = 0;

4094 
boÞ
 
Üd”ed_io_”r
 = 
çl£
;

4096 
»t
 = 
	`wa™_Üd”ed_ex‹Ás
(
Œªs
, &
šode
->
vfs_šode
, 
roÙ
, 
em
,

4097 
logged_li¡
, &
Üd”ed_io_”r
);

4098 ià(
»t
)

4099  
»t
;

4101 ià(
Üd”ed_io_”r
) {

4102 
ùx
->
io_”r
 = -
EIO
;

4106 
	`bŒfs_š™_m­_tok’
(&
tok’
);

4108 
»t
 = 
	`__bŒfs_drÝ_ex‹Ás
(
Œªs
, 
log
, &
šode
->
vfs_šode
, 
·th
, 
em
->
¡¬t
,

4109 
em
->
¡¬t
 +ƒm->
Ën
, 
NULL
, 0, 1,

4110 (*
fi
), &
ex‹Á_š£¹ed
);

4111 ià(
»t
)

4112  
»t
;

4114 ià(!
ex‹Á_š£¹ed
) {

4115 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

4116 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

4117 
key
.
off£t
 = 
em
->
¡¬t
;

4119 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
log
, 
·th
, &
key
,

4120 (*
fi
));

4121 ià(
»t
)

4122  
»t
;

4124 
Ëaf
 = 
·th
->
nodes
[0];

4125 
fi
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4126 
bŒfs_fže_ex‹Á_™em
);

4128 
	`bŒfs_£t_tok’_fže_ex‹Á_g’”©iÚ
(
Ëaf
, 
fi
, 
Œªs
->
Œªsid
,

4129 &
tok’
);

4130 ià(
	`‹¡_b™
(
EXTENT_FLAG_PREALLOC
, &
em
->
æags
))

4131 
	`bŒfs_£t_tok’_fže_ex‹Á_ty³
(
Ëaf
, 
fi
,

4132 
BTRFS_FILE_EXTENT_PREALLOC
,

4133 &
tok’
);

4135 
	`bŒfs_£t_tok’_fže_ex‹Á_ty³
(
Ëaf
, 
fi
,

4136 
BTRFS_FILE_EXTENT_REG
,

4137 &
tok’
);

4139 
block_Ën
 = 
	`max
(
em
->block_Ën,ƒm->
Üig_block_Ën
);

4140 ià(
em
->
com´ess_ty³
 !ð
BTRFS_COMPRESS_NONE
) {

4141 
	`bŒfs_£t_tok’_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
,

4142 
em
->
block_¡¬t
,

4143 &
tok’
);

4144 
	`bŒfs_£t_tok’_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
, 
block_Ën
,

4145 &
tok’
);

4146 } ià(
em
->
block_¡¬t
 < 
EXTENT_MAP_LAST_BYTE
) {

4147 
	`bŒfs_£t_tok’_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
,

4148 
em
->
block_¡¬t
 -

4149 
ex‹Á_off£t
, &
tok’
);

4150 
	`bŒfs_£t_tok’_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
, 
block_Ën
,

4151 &
tok’
);

4153 
	`bŒfs_£t_tok’_fže_ex‹Á_disk_by‹Ä
(
Ëaf
, 
fi
, 0, &
tok’
);

4154 
	`bŒfs_£t_tok’_fže_ex‹Á_disk_num_by‹s
(
Ëaf
, 
fi
, 0,

4155 &
tok’
);

4158 
	`bŒfs_£t_tok’_fže_ex‹Á_off£t
(
Ëaf
, 
fi
, 
ex‹Á_off£t
, &
tok’
);

4159 
	`bŒfs_£t_tok’_fže_ex‹Á_num_by‹s
(
Ëaf
, 
fi
, 
em
->
Ën
, &
tok’
);

4160 
	`bŒfs_£t_tok’_fže_ex‹Á_¿m_by‹s
(
Ëaf
, 
fi
, 
em
->
¿m_by‹s
, &
tok’
);

4161 
	`bŒfs_£t_tok’_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
fi
, 
em
->
com´ess_ty³
,

4162 &
tok’
);

4163 
	`bŒfs_£t_tok’_fže_ex‹Á_’üy±iÚ
(
Ëaf
, 
fi
, 0, &
tok’
);

4164 
	`bŒfs_£t_tok’_fže_ex‹Á_Ùh”_’codšg
(
Ëaf
, 
fi
, 0, &
tok’
);

4165 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

4167 
	`bŒfs_»Ëa£_·th
(
·th
);

4169  
»t
;

4170 
	}
}

4172 
	$bŒfs_log_chªged_ex‹Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4173 
bŒfs_roÙ
 *
roÙ
,

4174 
bŒfs_šode
 *
šode
,

4175 
bŒfs_·th
 *
·th
,

4176 
li¡_h—d
 *
logged_li¡
,

4177 
bŒfs_log_ùx
 *
ùx
,

4178 cÚ¡ 
u64
 
¡¬t
,

4179 cÚ¡ 
u64
 
’d
)

4181 
ex‹Á_m­
 *
em
, *
n
;

4182 
li¡_h—d
 
ex‹Ás
;

4183 
ex‹Á_m­_Œ“
 *
Œ“
 = &
šode
->
ex‹Á_Œ“
;

4184 
u64
 
logged_¡¬t
, 
logged_’d
;

4185 
u64
 
‹¡_g’
;

4186 
»t
 = 0;

4187 
num
 = 0;

4189 
	`INIT_LIST_HEAD
(&
ex‹Ás
);

4191 
	`down_wr™e
(&
šode
->
dio_£m
);

4192 
	`wr™e_lock
(&
Œ“
->
lock
);

4193 
‹¡_g’
 = 
roÙ
->
fs_šfo
->
Ï¡_Œªs_comm™‹d
;

4194 
logged_¡¬t
 = 
¡¬t
;

4195 
logged_’d
 = 
’d
;

4197 
	`li¡_fÜ_—ch_’Œy_§ã
(
em
, 
n
, &
Œ“
->
modif›d_ex‹Ás
, 
li¡
) {

4198 
	`li¡_d–_š™
(&
em
->
li¡
);

4205 ià(++
num
 > 32768) {

4206 
	`li¡_d–_š™
(&
Œ“
->
modif›d_ex‹Ás
);

4207 
»t
 = -
EFBIG
;

4208 
´oûss
;

4211 ià(
em
->
g’”©iÚ
 <ð
‹¡_g’
)

4214 ià(
em
->
¡¬t
 < 
logged_¡¬t
)

4215 
logged_¡¬t
 = 
em
->
¡¬t
;

4216 ià((
em
->
¡¬t
 +ƒm->
Ën
 - 1è> 
logged_’d
)

4217 
logged_’d
 = 
em
->
¡¬t
 +ƒm->
Ën
 - 1;

4220 
	`»fcouÁ_šc
(&
em
->
»fs
);

4221 
	`£t_b™
(
EXTENT_FLAG_LOGGING
, &
em
->
æags
);

4222 
	`li¡_add_ž
(&
em
->
li¡
, &
ex‹Ás
);

4223 
num
++;

4226 
	`li¡_sÜt
(
NULL
, &
ex‹Ás
, 
ex‹Á_cmp
);

4227 
	`bŒfs_g‘_logged_ex‹Ás
(
šode
, 
logged_li¡
, 
logged_¡¬t
, 
logged_’d
);

4238 
»t
 = 
	`fžem­_check_”rÜs
(
šode
->
vfs_šode
.
i_m­pšg
);

4239 ià(
»t
)

4240 
ùx
->
io_”r
 = 
»t
;

4241 
´oûss
:

4242 !
	`li¡_em±y
(&
ex‹Ás
)) {

4243 
em
 = 
	`li¡_’Œy
(
ex‹Ás
.
Ãxt
, 
ex‹Á_m­
, 
li¡
);

4245 
	`li¡_d–_š™
(&
em
->
li¡
);

4251 ià(
»t
) {

4252 
	`þ—r_em_loggšg
(
Œ“
, 
em
);

4253 
	`ä“_ex‹Á_m­
(
em
);

4257 
	`wr™e_uÆock
(&
Œ“
->
lock
);

4259 
»t
 = 
	`log_Úe_ex‹Á
(
Œªs
, 
šode
, 
roÙ
, 
em
, 
·th
, 
logged_li¡
,

4260 
ùx
);

4261 
	`wr™e_lock
(&
Œ“
->
lock
);

4262 
	`þ—r_em_loggšg
(
Œ“
, 
em
);

4263 
	`ä“_ex‹Á_m­
(
em
);

4265 
	`WARN_ON
(!
	`li¡_em±y
(&
ex‹Ás
));

4266 
	`wr™e_uÆock
(&
Œ“
->
lock
);

4267 
	`up_wr™e
(&
šode
->
dio_£m
);

4269 
	`bŒfs_»Ëa£_·th
(
·th
);

4270  
»t
;

4271 
	}
}

4273 
	$logged_šode_size
(
bŒfs_roÙ
 *
log
, 
bŒfs_šode
 *
šode
,

4274 
bŒfs_·th
 *
·th
, 
u64
 *
size_»t
)

4276 
bŒfs_key
 
key
;

4277 
»t
;

4279 
key
.
objeùid
 = 
	`bŒfs_šo
(
šode
);

4280 
key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4281 
key
.
off£t
 = 0;

4283 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
log
, &
key
, 
·th
, 0, 0);

4284 ià(
»t
 < 0) {

4285  
»t
;

4286 } ià(
»t
 > 0) {

4287 *
size_»t
 = 0;

4289 
bŒfs_šode_™em
 *
™em
;

4291 
™em
 = 
	`bŒfs_™em_±r
(
·th
->
nodes
[0],…©h->
¦Ùs
[0],

4292 
bŒfs_šode_™em
);

4293 *
size_»t
 = 
	`bŒfs_šode_size
(
·th
->
nodes
[0], 
™em
);

4296 
	`bŒfs_»Ëa£_·th
(
·th
);

4298 
	}
}

4309 
	$bŒfs_log_®l_x©Œs
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4310 
bŒfs_roÙ
 *
roÙ
,

4311 
bŒfs_šode
 *
šode
,

4312 
bŒfs_·th
 *
·th
,

4313 
bŒfs_·th
 *
d¡_·th
)

4315 
»t
;

4316 
bŒfs_key
 
key
;

4317 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4318 
šs_Ä
 = 0;

4319 
¡¬t_¦Ù
 = 0;

4321 
key
.
objeùid
 = 
šo
;

4322 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

4323 
key
.
off£t
 = 0;

4325 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4326 ià(
»t
 < 0)

4327  
»t
;

4329 
Œue
) {

4330 
¦Ù
 = 
·th
->
¦Ùs
[0];

4331 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

4332 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

4334 ià(
¦Ù
 >ð
Ä™ems
) {

4335 ià(
šs_Ä
 > 0) {

4336 
u64
 
Ï¡_ex‹Á
 = 0;

4338 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4339 &
Ï¡_ex‹Á
, 
¡¬t_¦Ù
,

4340 
šs_Ä
, 1, 0);

4342 
	`ASSERT
(
»t
 <= 0);

4343 ià(
»t
 < 0)

4344  
»t
;

4345 
šs_Ä
 = 0;

4347 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

4348 ià(
»t
 < 0)

4349  
»t
;

4350 ià(
»t
 > 0)

4355 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

4356 ià(
key
.
objeùid
 !ð
šo
 || key.
ty³
 !ð
BTRFS_XATTR_ITEM_KEY
)

4359 ià(
šs_Ä
 == 0)

4360 
¡¬t_¦Ù
 = 
¦Ù
;

4361 
šs_Ä
++;

4362 
·th
->
¦Ùs
[0]++;

4363 
	`cÚd_»sched
();

4365 ià(
šs_Ä
 > 0) {

4366 
u64
 
Ï¡_ex‹Á
 = 0;

4368 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4369 &
Ï¡_ex‹Á
, 
¡¬t_¦Ù
,

4370 
šs_Ä
, 1, 0);

4372 
	`ASSERT
(
»t
 <= 0);

4373 ià(
»t
 < 0)

4374  
»t
;

4378 
	}
}

4404 
	$bŒfs_log_Œažšg_hÞe
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4405 
bŒfs_roÙ
 *
roÙ
,

4406 
bŒfs_šode
 *
šode
,

4407 
bŒfs_·th
 *
·th
)

4409 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4410 
»t
;

4411 
bŒfs_key
 
key
;

4412 
u64
 
hÞe_¡¬t
;

4413 
u64
 
hÞe_size
;

4414 
ex‹Á_bufãr
 *
Ëaf
;

4415 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

4416 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4417 cÚ¡ 
u64
 
i_size
 = 
	`i_size_»ad
(&
šode
->
vfs_šode
);

4419 ià(!
	`bŒfs_fs_šcom·t
(
fs_šfo
, 
NO_HOLES
))

4422 
key
.
objeùid
 = 
šo
;

4423 
key
.
ty³
 = 
BTRFS_EXTENT_DATA_KEY
;

4424 
key
.
off£t
 = (
u64
)-1;

4426 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4427 
	`ASSERT
(
»t
 != 0);

4428 ià(
»t
 < 0)

4429  
»t
;

4431 
	`ASSERT
(
·th
->
¦Ùs
[0] > 0);

4432 
·th
->
¦Ùs
[0]--;

4433 
Ëaf
 = 
·th
->
nodes
[0];

4434 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

4436 ià(
key
.
objeùid
 !ð
šo
 || key.
ty³
 !ð
BTRFS_EXTENT_DATA_KEY
) {

4438 
hÞe_¡¬t
 = 0;

4439 
hÞe_size
 = 
i_size
;

4441 
bŒfs_fže_ex‹Á_™em
 *
ex‹Á
;

4442 
u64
 
Ën
;

4448 ià(
key
.
off£t
 >ð
i_size
)

4451 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

4452 
bŒfs_fže_ex‹Á_™em
);

4454 ià(
	`bŒfs_fže_ex‹Á_ty³
(
Ëaf
, 
ex‹Á
) ==

4455 
BTRFS_FILE_EXTENT_INLINE
) {

4456 
Ën
 = 
	`bŒfs_fže_ex‹Á_šlše_Ën
(
Ëaf
,

4457 
·th
->
¦Ùs
[0],

4458 
ex‹Á
);

4459 
	`ASSERT
(
Ën
 =ð
i_size
 ||

4460 (
Ën
 =ð
fs_šfo
->
£ùÜsize
 &&

4461 
	`bŒfs_fže_ex‹Á_com´essiÚ
(
Ëaf
, 
ex‹Á
) !=

4462 
BTRFS_COMPRESS_NONE
));

4466 
Ën
 = 
	`bŒfs_fže_ex‹Á_num_by‹s
(
Ëaf
, 
ex‹Á
);

4468 ià(
key
.
off£t
 + 
Ën
 > 
i_size
)

4470 
hÞe_¡¬t
 = 
key
.
off£t
 + 
Ën
;

4471 
hÞe_size
 = 
i_size
 - 
hÞe_¡¬t
;

4473 
	`bŒfs_»Ëa£_·th
(
·th
);

4476 ià(
hÞe_size
 == 0)

4479 
hÞe_size
 = 
	`ALIGN
(hÞe_size, 
fs_šfo
->
£ùÜsize
);

4480 
»t
 = 
	`bŒfs_š£¹_fže_ex‹Á
(
Œªs
, 
log
, 
šo
, 
hÞe_¡¬t
, 0, 0,

4481 
hÞe_size
, 0, hole_size, 0, 0, 0);

4482  
»t
;

4483 
	}
}

4527 
	$bŒfs_check_»f_Çme_ov”ride
(
ex‹Á_bufãr
 *
eb
,

4528 cÚ¡ 
¦Ù
,

4529 cÚ¡ 
bŒfs_key
 *
key
,

4530 
bŒfs_šode
 *
šode
,

4531 
u64
 *
Ùh”_šo
)

4533 
»t
;

4534 
bŒfs_·th
 *
£¬ch_·th
;

4535 *
Çme
 = 
NULL
;

4536 
u32
 
Çme_Ën
 = 0;

4537 
u32
 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

4538 
u32
 
cur_off£t
 = 0;

4539 
±r
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

4541 
£¬ch_·th
 = 
	`bŒfs_®loc_·th
();

4542 ià(!
£¬ch_·th
)

4543  -
ENOMEM
;

4544 
£¬ch_·th
->
£¬ch_comm™_roÙ
 = 1;

4545 
£¬ch_·th
->
sk_lockšg
 = 1;

4547 
cur_off£t
 < 
™em_size
) {

4548 
u64
 
·»Á
;

4549 
u32
 
this_Çme_Ën
;

4550 
u32
 
this_Ën
;

4551 
Çme_±r
;

4552 
bŒfs_dœ_™em
 *
di
;

4554 ià(
key
->
ty³
 =ð
BTRFS_INODE_REF_KEY
) {

4555 
bŒfs_šode_»f
 *
œef
;

4557 
œef
 = (
bŒfs_šode_»f
 *)(
±r
 + 
cur_off£t
);

4558 
·»Á
 = 
key
->
off£t
;

4559 
this_Çme_Ën
 = 
	`bŒfs_šode_»f_Çme_Ën
(
eb
, 
œef
);

4560 
Çme_±r
 = ()(
œef
 + 1);

4561 
this_Ën
 = (*
œef
è+ 
this_Çme_Ën
;

4563 
bŒfs_šode_exŒef
 *
exŒef
;

4565 
exŒef
 = (
bŒfs_šode_exŒef
 *)(
±r
 +

4566 
cur_off£t
);

4567 
·»Á
 = 
	`bŒfs_šode_exŒef_·»Á
(
eb
, 
exŒef
);

4568 
this_Çme_Ën
 = 
	`bŒfs_šode_exŒef_Çme_Ën
(
eb
, 
exŒef
);

4569 
Çme_±r
 = ()&
exŒef
->
Çme
;

4570 
this_Ën
 = (*
exŒef
è+ 
this_Çme_Ën
;

4573 
»t
 = 
	`bŒfs_is_Çme_Ën_v®id
(
eb
, 
¦Ù
, 
Çme_±r
,

4574 
this_Çme_Ën
);

4575 ià(!
»t
) {

4576 
»t
 = -
EIO
;

4577 
out
;

4579 ià(
this_Çme_Ën
 > 
Çme_Ën
) {

4580 *
Ãw_Çme
;

4582 
Ãw_Çme
 = 
	`k»®loc
(
Çme
, 
this_Çme_Ën
, 
GFP_NOFS
);

4583 ià(!
Ãw_Çme
) {

4584 
»t
 = -
ENOMEM
;

4585 
out
;

4587 
Çme_Ën
 = 
this_Çme_Ën
;

4588 
Çme
 = 
Ãw_Çme
;

4591 
	`»ad_ex‹Á_bufãr
(
eb
, 
Çme
, 
Çme_±r
, 
this_Çme_Ën
);

4592 
di
 = 
	`bŒfs_lookup_dœ_™em
(
NULL
, 
šode
->
roÙ
, 
£¬ch_·th
,

4593 
·»Á
, 
Çme
, 
this_Çme_Ën
, 0);

4594 ià(
di
 && !
	`IS_ERR
(di)) {

4595 
bŒfs_key
 
di_key
;

4597 
	`bŒfs_dœ_™em_key_to_ýu
(
£¬ch_·th
->
nodes
[0],

4598 
di
, &
di_key
);

4599 ià(
di_key
.
ty³
 =ð
BTRFS_INODE_ITEM_KEY
) {

4600 
»t
 = 1;

4601 *
Ùh”_šo
 = 
di_key
.
objeùid
;

4603 
»t
 = -
EAGAIN
;

4605 
out
;

4606 } ià(
	`IS_ERR
(
di
)) {

4607 
»t
 = 
	`PTR_ERR
(
di
);

4608 
out
;

4610 
	`bŒfs_»Ëa£_·th
(
£¬ch_·th
);

4612 
cur_off£t
 +ð
this_Ën
;

4614 
»t
 = 0;

4615 
out
:

4616 
	`bŒfs_ä“_·th
(
£¬ch_·th
);

4617 
	`kä“
(
Çme
);

4618  
»t
;

4619 
	}
}

4635 
	$bŒfs_log_šode
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4636 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_šode
 *
šode
,

4637 
šode_Úly
,

4638 cÚ¡ 
loff_t
 
¡¬t
,

4639 cÚ¡ 
loff_t
 
’d
,

4640 
bŒfs_log_ùx
 *
ùx
)

4642 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

4643 
bŒfs_·th
 *
·th
;

4644 
bŒfs_·th
 *
d¡_·th
;

4645 
bŒfs_key
 
mš_key
;

4646 
bŒfs_key
 
max_key
;

4647 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

4648 
ex‹Á_bufãr
 *
¤c
 = 
NULL
;

4649 
	`LIST_HEAD
(
logged_li¡
);

4650 
u64
 
Ï¡_ex‹Á
 = 0;

4651 
”r
 = 0;

4652 
»t
;

4653 
Ä™ems
;

4654 
šs_¡¬t_¦Ù
 = 0;

4655 
šs_Ä
;

4656 
boÞ
 
ç¡_£¬ch
 = 
çl£
;

4657 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

4658 
ex‹Á_m­_Œ“
 *
em_Œ“
 = &
šode
->
ex‹Á_Œ“
;

4659 
u64
 
logged_isize
 = 0;

4660 
boÞ
 
Ãed_log_šode_™em
 = 
Œue
;

4662 
·th
 = 
	`bŒfs_®loc_·th
();

4663 ià(!
·th
)

4664  -
ENOMEM
;

4665 
d¡_·th
 = 
	`bŒfs_®loc_·th
();

4666 ià(!
d¡_·th
) {

4667 
	`bŒfs_ä“_·th
(
·th
);

4668  -
ENOMEM
;

4671 
mš_key
.
objeùid
 = 
šo
;

4672 
mš_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4673 
mš_key
.
off£t
 = 0;

4675 
max_key
.
objeùid
 = 
šo
;

4679 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
) ||

4680 (!
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

4681 &
šode
->
ruÁime_æags
) &&

4682 
šode_Úly
 >ð
LOG_INODE_EXISTS
))

4683 
max_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

4685 
max_key
.
ty³
 = (
u8
)-1;

4686 
max_key
.
off£t
 = (
u64
)-1;

4694 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
) ||

4695 
šode
->
g’”©iÚ
 > 
fs_šfo
->
Ï¡_Œªs_comm™‹d
)

4696 
»t
 = 
	`bŒfs_comm™_šode_d–ayed_™ems
(
Œªs
, 
šode
);

4698 
»t
 = 
	`bŒfs_comm™_šode_d–ayed_šode
(
šode
);

4700 ià(
»t
) {

4701 
	`bŒfs_ä“_·th
(
·th
);

4702 
	`bŒfs_ä“_·th
(
d¡_·th
);

4703  
»t
;

4706 ià(
šode_Úly
 =ð
LOG_OTHER_INODE
) {

4707 
šode_Úly
 = 
LOG_INODE_EXISTS
;

4708 
	`mu‹x_lock_Ã¡ed
(&
šode
->
log_mu‹x
, 
SINGLE_DEPTH_NESTING
);

4710 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

4717 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
)) {

4718 
max_key_ty³
 = 
BTRFS_DIR_LOG_INDEX_KEY
;

4720 ià(
šode_Úly
 =ð
LOG_INODE_EXISTS
)

4721 
max_key_ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

4722 
»t
 = 
	`drÝ_objeùid_™ems
(
Œªs
, 
log
, 
·th
, 
šo
, 
max_key_ty³
);

4724 ià(
šode_Úly
 =ð
LOG_INODE_EXISTS
) {

4738 
”r
 = 
	`logged_šode_size
(
log
, 
šode
, 
·th
, &
logged_isize
);

4739 ià(
”r
)

4740 
out_uÆock
;

4742 ià(
	`‹¡_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

4743 &
šode
->
ruÁime_æags
)) {

4744 ià(
šode_Úly
 =ð
LOG_INODE_EXISTS
) {

4745 
max_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

4746 
»t
 = 
	`drÝ_objeùid_™ems
(
Œªs
, 
log
, 
·th
, 
šo
,

4747 
max_key
.
ty³
);

4749 
	`þ—r_b™
(
BTRFS_INODE_NEEDS_FULL_SYNC
,

4750 &
šode
->
ruÁime_æags
);

4751 
	`þ—r_b™
(
BTRFS_INODE_COPY_EVERYTHING
,

4752 &
šode
->
ruÁime_æags
);

4754 
»t
 = 
	`bŒfs_Œunÿ‹_šode_™ems
(
Œªs
,

4755 
log
, &
šode
->
vfs_šode
, 0, 0);

4756 ià(
»t
 !ð-
EAGAIN
)

4760 } ià(
	`‹¡_ªd_þ—r_b™
(
BTRFS_INODE_COPY_EVERYTHING
,

4761 &
šode
->
ruÁime_æags
) ||

4762 
šode_Úly
 =ð
LOG_INODE_EXISTS
) {

4763 ià(
šode_Úly
 =ð
LOG_INODE_ALL
)

4764 
ç¡_£¬ch
 = 
Œue
;

4765 
max_key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

4766 
»t
 = 
	`drÝ_objeùid_™ems
(
Œªs
, 
log
, 
·th
, 
šo
,

4767 
max_key
.
ty³
);

4769 ià(
šode_Úly
 =ð
LOG_INODE_ALL
)

4770 
ç¡_£¬ch
 = 
Œue
;

4771 
log_ex‹Ás
;

4775 ià(
»t
) {

4776 
”r
 = 
»t
;

4777 
out_uÆock
;

4781 
šs_Ä
 = 0;

4782 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
mš_key
,

4783 
·th
, 
Œªs
->
Œªsid
);

4784 ià(
»t
 < 0) {

4785 
”r
 = 
»t
;

4786 
out_uÆock
;

4788 ià(
»t
 != 0)

4790 
agaš
:

4792 ià(
mš_key
.
objeùid
 !ð
šo
)

4794 ià(
mš_key
.
ty³
 > 
max_key
.type)

4797 ià(
mš_key
.
ty³
 =ð
BTRFS_INODE_ITEM_KEY
)

4798 
Ãed_log_šode_™em
 = 
çl£
;

4800 ià((
mš_key
.
ty³
 =ð
BTRFS_INODE_REF_KEY
 ||

4801 
mš_key
.
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) &&

4802 
šode
->
g’”©iÚ
 =ð
Œªs
->
Œªsid
) {

4803 
u64
 
Ùh”_šo
 = 0;

4805 
»t
 = 
	`bŒfs_check_»f_Çme_ov”ride
(
·th
->
nodes
[0],

4806 
·th
->
¦Ùs
[0], &
mš_key
, 
šode
,

4807 &
Ùh”_šo
);

4808 ià(
»t
 < 0) {

4809 
”r
 = 
»t
;

4810 
out_uÆock
;

4811 } ià(
»t
 > 0 && 
ùx
 &&

4812 
Ùh”_šo
 !ð
	`bŒfs_šo
(
	`BTRFS_I
(
ùx
->
šode
))) {

4813 
bŒfs_key
 
šode_key
;

4814 
šode
 *
Ùh”_šode
;

4816 ià(
šs_Ä
 > 0) {

4817 
šs_Ä
++;

4819 
šs_Ä
 = 1;

4820 
šs_¡¬t_¦Ù
 = 
·th
->
¦Ùs
[0];

4822 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4823 &
Ï¡_ex‹Á
, 
šs_¡¬t_¦Ù
,

4824 
šs_Ä
, 
šode_Úly
,

4825 
logged_isize
);

4826 ià(
»t
 < 0) {

4827 
”r
 = 
»t
;

4828 
out_uÆock
;

4830 
šs_Ä
 = 0;

4831 
	`bŒfs_»Ëa£_·th
(
·th
);

4832 
šode_key
.
objeùid
 = 
Ùh”_šo
;

4833 
šode_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

4834 
šode_key
.
off£t
 = 0;

4835 
Ùh”_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
,

4836 &
šode_key
, 
roÙ
,

4837 
NULL
);

4844 ià(
	`IS_ERR
(
Ùh”_šode
) &&

4845 
	`PTR_ERR
(
Ùh”_šode
è=ð-
ENOENT
) {

4846 
Ãxt_key
;

4847 } ià(
	`IS_ERR
(
Ùh”_šode
)) {

4848 
”r
 = 
	`PTR_ERR
(
Ùh”_šode
);

4849 
out_uÆock
;

4860 
”r
 = 
	`bŒfs_log_šode
(
Œªs
, 
roÙ
,

4861 
	`BTRFS_I
(
Ùh”_šode
),

4862 
LOG_OTHER_INODE
, 0, 
LLONG_MAX
,

4863 
ùx
);

4864 
	`ut
(
Ùh”_šode
);

4865 ià(
”r
)

4866 
out_uÆock
;

4868 
Ãxt_key
;

4873 ià(
mš_key
.
ty³
 =ð
BTRFS_XATTR_ITEM_KEY
) {

4874 ià(
šs_Ä
 == 0)

4875 
Ãxt_¦Ù
;

4876 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4877 &
Ï¡_ex‹Á
, 
šs_¡¬t_¦Ù
,

4878 
šs_Ä
, 
šode_Úly
, 
logged_isize
);

4879 ià(
»t
 < 0) {

4880 
”r
 = 
»t
;

4881 
out_uÆock
;

4883 
šs_Ä
 = 0;

4884 ià(
»t
) {

4885 
	`bŒfs_»Ëa£_·th
(
·th
);

4888 
Ãxt_¦Ù
;

4891 
¤c
 = 
·th
->
nodes
[0];

4892 ià(
šs_Ä
 && 
šs_¡¬t_¦Ù
 + ins_Ä =ð
·th
->
¦Ùs
[0]) {

4893 
šs_Ä
++;

4894 
Ãxt_¦Ù
;

4895 } ià(!
šs_Ä
) {

4896 
šs_¡¬t_¦Ù
 = 
·th
->
¦Ùs
[0];

4897 
šs_Ä
 = 1;

4898 
Ãxt_¦Ù
;

4901 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
, &
Ï¡_ex‹Á
,

4902 
šs_¡¬t_¦Ù
, 
šs_Ä
, 
šode_Úly
,

4903 
logged_isize
);

4904 ià(
»t
 < 0) {

4905 
”r
 = 
»t
;

4906 
out_uÆock
;

4908 ià(
»t
) {

4909 
šs_Ä
 = 0;

4910 
	`bŒfs_»Ëa£_·th
(
·th
);

4913 
šs_Ä
 = 1;

4914 
šs_¡¬t_¦Ù
 = 
·th
->
¦Ùs
[0];

4915 
Ãxt_¦Ù
:

4917 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
·th
->
nodes
[0]);

4918 
·th
->
¦Ùs
[0]++;

4919 ià(
·th
->
¦Ùs
[0] < 
Ä™ems
) {

4920 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
mš_key
,

4921 
·th
->
¦Ùs
[0]);

4922 
agaš
;

4924 ià(
šs_Ä
) {

4925 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
,

4926 &
Ï¡_ex‹Á
, 
šs_¡¬t_¦Ù
,

4927 
šs_Ä
, 
šode_Úly
, 
logged_isize
);

4928 ià(
»t
 < 0) {

4929 
”r
 = 
»t
;

4930 
out_uÆock
;

4932 
»t
 = 0;

4933 
šs_Ä
 = 0;

4935 
	`bŒfs_»Ëa£_·th
(
·th
);

4936 
Ãxt_key
:

4937 ià(
mš_key
.
off£t
 < (
u64
)-1) {

4938 
mš_key
.
off£t
++;

4939 } ià(
mš_key
.
ty³
 < 
max_key
.type) {

4940 
mš_key
.
ty³
++;

4941 
mš_key
.
off£t
 = 0;

4946 ià(
šs_Ä
) {

4947 
»t
 = 
	`cÝy_™ems
(
Œªs
, 
šode
, 
d¡_·th
, 
·th
, &
Ï¡_ex‹Á
,

4948 
šs_¡¬t_¦Ù
, 
šs_Ä
, 
šode_Úly
,

4949 
logged_isize
);

4950 ià(
»t
 < 0) {

4951 
”r
 = 
»t
;

4952 
out_uÆock
;

4954 
»t
 = 0;

4955 
šs_Ä
 = 0;

4958 
	`bŒfs_»Ëa£_·th
(
·th
);

4959 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

4960 
”r
 = 
	`bŒfs_log_®l_x©Œs
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
d¡_·th
);

4961 ià(
”r
)

4962 
out_uÆock
;

4963 ià(
max_key
.
ty³
 >ð
BTRFS_EXTENT_DATA_KEY
 && !
ç¡_£¬ch
) {

4964 
	`bŒfs_»Ëa£_·th
(
·th
);

4965 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

4966 
”r
 = 
	`bŒfs_log_Œažšg_hÞe
(
Œªs
, 
roÙ
, 
šode
, 
·th
);

4967 ià(
”r
)

4968 
out_uÆock
;

4970 
log_ex‹Ás
:

4971 
	`bŒfs_»Ëa£_·th
(
·th
);

4972 
	`bŒfs_»Ëa£_·th
(
d¡_·th
);

4973 ià(
Ãed_log_šode_™em
) {

4974 
”r
 = 
	`log_šode_™em
(
Œªs
, 
log
, 
d¡_·th
, 
šode
);

4975 ià(
”r
)

4976 
out_uÆock
;

4978 ià(
ç¡_£¬ch
) {

4979 
»t
 = 
	`bŒfs_log_chªged_ex‹Ás
(
Œªs
, 
roÙ
, 
šode
, 
d¡_·th
,

4980 &
logged_li¡
, 
ùx
, 
¡¬t
, 
’d
);

4981 ià(
»t
) {

4982 
”r
 = 
»t
;

4983 
out_uÆock
;

4985 } ià(
šode_Úly
 =ð
LOG_INODE_ALL
) {

4986 
ex‹Á_m­
 *
em
, *
n
;

4988 
	`wr™e_lock
(&
em_Œ“
->
lock
);

5007 
	`li¡_fÜ_—ch_’Œy_§ã
(
em
, 
n
, &
em_Œ“
->
modif›d_ex‹Ás
,

5008 
li¡
) {

5009 cÚ¡ 
u64
 
mod_’d
 = 
em
->
mod_¡¬t
 +ƒm->
mod_Ën
 - 1;

5011 ià(
em
->
mod_¡¬t
 >ð
¡¬t
 && 
mod_’d
 <ð
’d
)

5012 
	`li¡_d–_š™
(&
em
->
li¡
);

5014 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

5017 ià(
šode_Úly
 =ð
LOG_INODE_ALL
 && 
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
)) {

5018 
»t
 = 
	`log_dœeùÜy_chªges
(
Œªs
, 
roÙ
, 
šode
, 
·th
, 
d¡_·th
,

5019 
ùx
);

5020 ià(
»t
) {

5021 
”r
 = 
»t
;

5022 
out_uÆock
;

5026 
	`¥š_lock
(&
šode
->
lock
);

5027 
šode
->
logged_Œªs
 = 
Œªs
->
Œªsid
;

5028 
šode
->
Ï¡_log_comm™
 = inode->
Ï¡_sub_Œªs
;

5029 
	`¥š_uÆock
(&
šode
->
lock
);

5030 
out_uÆock
:

5031 ià(
	`uÆik–y
(
”r
))

5032 
	`bŒfs_put_logged_ex‹Ás
(&
logged_li¡
);

5034 
	`bŒfs_subm™_logged_ex‹Ás
(&
logged_li¡
, 
log
);

5035 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

5037 
	`bŒfs_ä“_·th
(
·th
);

5038 
	`bŒfs_ä“_·th
(
d¡_·th
);

5039  
”r
;

5040 
	}
}

5058 
boÞ
 
	$bŒfs_mu¡_comm™_Œª§ùiÚ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5059 
bŒfs_šode
 *
šode
)

5061 
bŒfs_fs_šfo
 *
fs_šfo
 = 
šode
->
roÙ
->fs_info;

5062 
boÞ
 
»t
 = 
çl£
;

5064 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

5065 ià(
šode
->
Ï¡_uÆšk_Œªs
 > 
fs_šfo
->
Ï¡_Œªs_comm™‹d
) {

5070 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

5071 
»t
 = 
Œue
;

5073 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

5075  
»t
;

5076 
	}
}

5084 
nošlše
 
	$check_·»Á_dœs_fÜ_sync
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5085 
bŒfs_šode
 *
šode
,

5086 
d’Œy
 *
·»Á
,

5087 
su³r_block
 *
sb
,

5088 
u64
 
Ï¡_comm™‹d
)

5090 
»t
 = 0;

5091 
d’Œy
 *
Þd_·»Á
 = 
NULL
;

5092 
bŒfs_šode
 *
Üig_šode
 = 
šode
;

5100 ià(
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
) &&

5101 
šode
->
g’”©iÚ
 <ð
Ï¡_comm™‹d
 &&

5102 
šode
->
Ï¡_uÆšk_Œªs
 <ð
Ï¡_comm™‹d
)

5103 
out
;

5105 ià(!
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
)) {

5106 ià(!
·»Á
 || 
	`d_»®ly_is_Ãg©ive
Õ¬’tè|| 
sb
 !ð·»Á->
d_sb
)

5107 
out
;

5108 
šode
 = 
	`BTRFS_I
(
	`d_šode
(
·»Á
));

5118 ià(
šode
 !ð
Üig_šode
)

5119 
šode
->
logged_Œªs
 = 
Œªs
->
Œªsid
;

5120 
	`smp_mb
();

5122 ià(
	`bŒfs_mu¡_comm™_Œª§ùiÚ
(
Œªs
, 
šode
)) {

5123 
»t
 = 1;

5127 ià(!
·»Á
 || 
	`d_»®ly_is_Ãg©ive
Õ¬’tè|| 
sb
 !ð·»Á->
d_sb
)

5130 ià(
	`IS_ROOT
(
·»Á
)) {

5131 
šode
 = 
	`BTRFS_I
(
	`d_šode
(
·»Á
));

5132 ià(
	`bŒfs_mu¡_comm™_Œª§ùiÚ
(
Œªs
, 
šode
))

5133 
»t
 = 1;

5137 
·»Á
 = 
	`dg‘_·»Á
(parent);

5138 
	`dput
(
Þd_·»Á
);

5139 
Þd_·»Á
 = 
·»Á
;

5140 
šode
 = 
	`BTRFS_I
(
	`d_šode
(
·»Á
));

5143 
	`dput
(
Þd_·»Á
);

5144 
out
:

5145  
»t
;

5146 
	}
}

5148 
	sbŒfs_dœ_li¡
 {

5149 
u64
 
	mšo
;

5150 
li¡_h—d
 
	mli¡
;

5195 
	$log_Ãw_dœ_d’Œ›s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5196 
bŒfs_roÙ
 *
roÙ
,

5197 
bŒfs_šode
 *
¡¬t_šode
,

5198 
bŒfs_log_ùx
 *
ùx
)

5200 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5201 
bŒfs_roÙ
 *
log
 = 
roÙ
->
log_roÙ
;

5202 
bŒfs_·th
 *
·th
;

5203 
	`LIST_HEAD
(
dœ_li¡
);

5204 
bŒfs_dœ_li¡
 *
dœ_–em
;

5205 
»t
 = 0;

5207 
·th
 = 
	`bŒfs_®loc_·th
();

5208 ià(!
·th
)

5209  -
ENOMEM
;

5211 
dœ_–em
 = 
	`km®loc
((*dœ_–em), 
GFP_NOFS
);

5212 ià(!
dœ_–em
) {

5213 
	`bŒfs_ä“_·th
(
·th
);

5214  -
ENOMEM
;

5216 
dœ_–em
->
šo
 = 
	`bŒfs_šo
(
¡¬t_šode
);

5217 
	`li¡_add_ž
(&
dœ_–em
->
li¡
, &
dœ_li¡
);

5219 !
	`li¡_em±y
(&
dœ_li¡
)) {

5220 
ex‹Á_bufãr
 *
Ëaf
;

5221 
bŒfs_key
 
mš_key
;

5222 
Ä™ems
;

5223 
i
;

5225 
dœ_–em
 = 
	`li¡_fœ¡_’Œy
(&
dœ_li¡
, 
bŒfs_dœ_li¡
,

5226 
li¡
);

5227 ià(
»t
)

5228 
Ãxt_dœ_šode
;

5230 
mš_key
.
objeùid
 = 
dœ_–em
->
šo
;

5231 
mš_key
.
ty³
 = 
BTRFS_DIR_ITEM_KEY
;

5232 
mš_key
.
off£t
 = 0;

5233 
agaš
:

5234 
	`bŒfs_»Ëa£_·th
(
·th
);

5235 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
log
, &
mš_key
, 
·th
, 
Œªs
->
Œªsid
);

5236 ià(
»t
 < 0) {

5237 
Ãxt_dœ_šode
;

5238 } ià(
»t
 > 0) {

5239 
»t
 = 0;

5240 
Ãxt_dœ_šode
;

5243 
´oûss_Ëaf
:

5244 
Ëaf
 = 
·th
->
nodes
[0];

5245 
Ä™ems
 = 
	`bŒfs_h—d”_Ä™ems
(
Ëaf
);

5246 
i
 = 
·th
->
¦Ùs
[0]; i < 
Ä™ems
; i++) {

5247 
bŒfs_dœ_™em
 *
di
;

5248 
bŒfs_key
 
di_key
;

5249 
šode
 *
di_šode
;

5250 
bŒfs_dœ_li¡
 *
Ãw_dœ_–em
;

5251 
log_mode
 = 
LOG_INODE_EXISTS
;

5252 
ty³
;

5254 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
mš_key
, 
i
);

5255 ià(
mš_key
.
objeùid
 !ð
dœ_–em
->
šo
 ||

5256 
mš_key
.
ty³
 !ð
BTRFS_DIR_ITEM_KEY
)

5257 
Ãxt_dœ_šode
;

5259 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
i
, 
bŒfs_dœ_™em
);

5260 
ty³
 = 
	`bŒfs_dœ_ty³
(
Ëaf
, 
di
);

5261 ià(
	`bŒfs_dœ_Œªsid
(
Ëaf
, 
di
è< 
Œªs
->
Œªsid
 &&

5262 
ty³
 !ð
BTRFS_FT_DIR
)

5264 
	`bŒfs_dœ_™em_key_to_ýu
(
Ëaf
, 
di
, &
di_key
);

5265 ià(
di_key
.
ty³
 =ð
BTRFS_ROOT_ITEM_KEY
)

5268 
	`bŒfs_»Ëa£_·th
(
·th
);

5269 
di_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
di_key
, 
roÙ
, 
NULL
);

5270 ià(
	`IS_ERR
(
di_šode
)) {

5271 
»t
 = 
	`PTR_ERR
(
di_šode
);

5272 
Ãxt_dœ_šode
;

5275 ià(
	`bŒfs_šode_š_log
(
	`BTRFS_I
(
di_šode
), 
Œªs
->
Œªsid
)) {

5276 
	`ut
(
di_šode
);

5280 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

5281 ià(
ty³
 =ð
BTRFS_FT_DIR
 ||y³ =ð
BTRFS_FT_SYMLINK
)

5282 
log_mode
 = 
LOG_INODE_ALL
;

5283 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
di_šode
),

5284 
log_mode
, 0, 
LLONG_MAX
, 
ùx
);

5285 ià(!
»t
 &&

5286 
	`bŒfs_mu¡_comm™_Œª§ùiÚ
(
Œªs
, 
	`BTRFS_I
(
di_šode
)))

5287 
»t
 = 1;

5288 
	`ut
(
di_šode
);

5289 ià(
»t
)

5290 
Ãxt_dœ_šode
;

5291 ià(
ùx
->
log_Ãw_d’Œ›s
) {

5292 
Ãw_dœ_–em
 = 
	`km®loc
((*new_dir_elem),

5293 
GFP_NOFS
);

5294 ià(!
Ãw_dœ_–em
) {

5295 
»t
 = -
ENOMEM
;

5296 
Ãxt_dœ_šode
;

5298 
Ãw_dœ_–em
->
šo
 = 
di_key
.
objeùid
;

5299 
	`li¡_add_ž
(&
Ãw_dœ_–em
->
li¡
, &
dœ_li¡
);

5303 ià(
i
 =ð
Ä™ems
) {

5304 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
log
, 
·th
);

5305 ià(
»t
 < 0) {

5306 
Ãxt_dœ_šode
;

5307 } ià(
»t
 > 0) {

5308 
»t
 = 0;

5309 
Ãxt_dœ_šode
;

5311 
´oûss_Ëaf
;

5313 ià(
mš_key
.
off£t
 < (
u64
)-1) {

5314 
mš_key
.
off£t
++;

5315 
agaš
;

5317 
Ãxt_dœ_šode
:

5318 
	`li¡_d–
(&
dœ_–em
->
li¡
);

5319 
	`kä“
(
dœ_–em
);

5322 
	`bŒfs_ä“_·th
(
·th
);

5323  
»t
;

5324 
	}
}

5326 
	$bŒfs_log_®l_·»Ás
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5327 
bŒfs_šode
 *
šode
,

5328 
bŒfs_log_ùx
 *
ùx
)

5330 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

5331 
»t
;

5332 
bŒfs_·th
 *
·th
;

5333 
bŒfs_key
 
key
;

5334 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5335 cÚ¡ 
u64
 
šo
 = 
	`bŒfs_šo
(
šode
);

5337 
·th
 = 
	`bŒfs_®loc_·th
();

5338 ià(!
·th
)

5339  -
ENOMEM
;

5340 
·th
->
sk_lockšg
 = 1;

5341 
·th
->
£¬ch_comm™_roÙ
 = 1;

5343 
key
.
objeùid
 = 
šo
;

5344 
key
.
ty³
 = 
BTRFS_INODE_REF_KEY
;

5345 
key
.
off£t
 = 0;

5346 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

5347 ià(
»t
 < 0)

5348 
out
;

5350 
Œue
) {

5351 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

5352 
¦Ù
 = 
·th
->
¦Ùs
[0];

5353 
u32
 
cur_off£t
 = 0;

5354 
u32
 
™em_size
;

5355 
±r
;

5357 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

5358 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

5359 ià(
»t
 < 0)

5360 
out
;

5361 ià(
»t
 > 0)

5366 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

5368 ià(
key
.
objeùid
 !ð
šo
 || key.
ty³
 > 
BTRFS_INODE_EXTREF_KEY
)

5371 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

5372 
±r
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

5373 
cur_off£t
 < 
™em_size
) {

5374 
bŒfs_key
 
šode_key
;

5375 
šode
 *
dœ_šode
;

5377 
šode_key
.
ty³
 = 
BTRFS_INODE_ITEM_KEY
;

5378 
šode_key
.
off£t
 = 0;

5380 ià(
key
.
ty³
 =ð
BTRFS_INODE_EXTREF_KEY
) {

5381 
bŒfs_šode_exŒef
 *
exŒef
;

5383 
exŒef
 = (
bŒfs_šode_exŒef
 *)

5384 (
±r
 + 
cur_off£t
);

5385 
šode_key
.
objeùid
 = 
	`bŒfs_šode_exŒef_·»Á
(

5386 
Ëaf
, 
exŒef
);

5387 
cur_off£t
 +ð(*
exŒef
);

5388 
cur_off£t
 +ð
	`bŒfs_šode_exŒef_Çme_Ën
(
Ëaf
,

5389 
exŒef
);

5391 
šode_key
.
objeùid
 = 
key
.
off£t
;

5392 
cur_off£t
 = 
™em_size
;

5395 
dœ_šode
 = 
	`bŒfs_ig‘
(
fs_šfo
->
sb
, &
šode_key
,

5396 
roÙ
, 
NULL
);

5398 ià(
	`IS_ERR
(
dœ_šode
))

5401 ià(
ùx
)

5402 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

5403 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
dœ_šode
),

5404 
LOG_INODE_ALL
, 0, 
LLONG_MAX
, 
ùx
);

5405 ià(!
»t
 &&

5406 
	`bŒfs_mu¡_comm™_Œª§ùiÚ
(
Œªs
, 
	`BTRFS_I
(
dœ_šode
)))

5407 
»t
 = 1;

5408 ià(!
»t
 && 
ùx
 && ctx->
log_Ãw_d’Œ›s
)

5409 
»t
 = 
	`log_Ãw_dœ_d’Œ›s
(
Œªs
, 
roÙ
,

5410 
	`BTRFS_I
(
dœ_šode
), 
ùx
);

5411 
	`ut
(
dœ_šode
);

5412 ià(
»t
)

5413 
out
;

5415 
·th
->
¦Ùs
[0]++;

5417 
»t
 = 0;

5418 
out
:

5419 
	`bŒfs_ä“_·th
(
·th
);

5420  
»t
;

5421 
	}
}

5429 
	$bŒfs_log_šode_·»Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5430 
bŒfs_roÙ
 *
roÙ
,

5431 
bŒfs_šode
 *
šode
,

5432 
d’Œy
 *
·»Á
,

5433 cÚ¡ 
loff_t
 
¡¬t
,

5434 cÚ¡ 
loff_t
 
’d
,

5435 
exi¡s_Úly
,

5436 
bŒfs_log_ùx
 *
ùx
)

5438 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

5439 
šode_Úly
 = 
exi¡s_Úly
 ? 
LOG_INODE_EXISTS
 : 
LOG_INODE_ALL
;

5440 
su³r_block
 *
sb
;

5441 
d’Œy
 *
Þd_·»Á
 = 
NULL
;

5442 
»t
 = 0;

5443 
u64
 
Ï¡_comm™‹d
 = 
fs_šfo
->
Ï¡_Œªs_comm™‹d
;

5444 
boÞ
 
log_d’Œ›s
 = 
çl£
;

5445 
bŒfs_šode
 *
Üig_šode
 = 
šode
;

5447 
sb
 = 
šode
->
vfs_šode
.
i_sb
;

5449 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
NOTREELOG
)) {

5450 
»t
 = 1;

5451 
’d_no_Œªs
;

5458 ià(
fs_šfo
->
Ï¡_Œªs_log_fuÎ_comm™
 >

5459 
fs_šfo
->
Ï¡_Œªs_comm™‹d
) {

5460 
»t
 = 1;

5461 
’d_no_Œªs
;

5464 ià(
roÙ
 !ð
šode
->roÙ || 
	`bŒfs_roÙ_»fs
(&roÙ->
roÙ_™em
) == 0) {

5465 
»t
 = 1;

5466 
’d_no_Œªs
;

5469 
»t
 = 
	`check_·»Á_dœs_fÜ_sync
(
Œªs
, 
šode
, 
·»Á
, 
sb
,

5470 
Ï¡_comm™‹d
);

5471 ià(
»t
)

5472 
’d_no_Œªs
;

5474 ià(
	`bŒfs_šode_š_log
(
šode
, 
Œªs
->
Œªsid
)) {

5475 
»t
 = 
BTRFS_NO_LOG_SYNC
;

5476 
’d_no_Œªs
;

5479 
»t
 = 
	`¡¬t_log_Œªs
(
Œªs
, 
roÙ
, 
ùx
);

5480 ià(
»t
)

5481 
’d_no_Œªs
;

5483 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
roÙ
, 
šode
, 
šode_Úly
, 
¡¬t
, 
’d
, 
ùx
);

5484 ià(
»t
)

5485 
’d_Œªs
;

5493 ià(
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
) &&

5494 
šode
->
g’”©iÚ
 <ð
Ï¡_comm™‹d
 &&

5495 
šode
->
Ï¡_uÆšk_Œªs
 <ð
Ï¡_comm™‹d
) {

5496 
»t
 = 0;

5497 
’d_Œªs
;

5500 ià(
	`S_ISDIR
(
šode
->
vfs_šode
.
i_mode
è&& 
ùx
 && ctx->
log_Ãw_d’Œ›s
)

5501 
log_d’Œ›s
 = 
Œue
;

5544 ià(
šode
->
Ï¡_uÆšk_Œªs
 > 
Ï¡_comm™‹d
) {

5545 
»t
 = 
	`bŒfs_log_®l_·»Ás
(
Œªs
, 
Üig_šode
, 
ùx
);

5546 ià(
»t
)

5547 
’d_Œªs
;

5551 ià(!
·»Á
 || 
	`d_»®ly_is_Ãg©ive
Õ¬’tè|| 
sb
 !ð·»Á->
d_sb
)

5554 
šode
 = 
	`BTRFS_I
(
	`d_šode
(
·»Á
));

5555 ià(
roÙ
 !ð
šode
->root)

5558 ià(
šode
->
g’”©iÚ
 > 
Ï¡_comm™‹d
) {

5559 
»t
 = 
	`bŒfs_log_šode
(
Œªs
, 
roÙ
, 
šode
,

5560 
LOG_INODE_EXISTS
, 0, 
LLONG_MAX
, 
ùx
);

5561 ià(
»t
)

5562 
’d_Œªs
;

5564 ià(
	`IS_ROOT
(
·»Á
))

5567 
·»Á
 = 
	`dg‘_·»Á
(parent);

5568 
	`dput
(
Þd_·»Á
);

5569 
Þd_·»Á
 = 
·»Á
;

5571 ià(
log_d’Œ›s
)

5572 
»t
 = 
	`log_Ãw_dœ_d’Œ›s
(
Œªs
, 
roÙ
, 
Üig_šode
, 
ùx
);

5574 
»t
 = 0;

5575 
’d_Œªs
:

5576 
	`dput
(
Þd_·»Á
);

5577 ià(
»t
 < 0) {

5578 
	`bŒfs_£t_log_fuÎ_comm™
(
fs_šfo
, 
Œªs
);

5579 
»t
 = 1;

5582 ià(
»t
)

5583 
	`bŒfs_»move_log_ùx
(
roÙ
, 
ùx
);

5584 
	`bŒfs_’d_log_Œªs
(
roÙ
);

5585 
’d_no_Œªs
:

5586  
»t
;

5587 
	}
}

5595 
	$bŒfs_log_d’Œy_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5596 
bŒfs_roÙ
 *
roÙ
, 
d’Œy
 *dentry,

5597 cÚ¡ 
loff_t
 
¡¬t
,

5598 cÚ¡ 
loff_t
 
’d
,

5599 
bŒfs_log_ùx
 *
ùx
)

5601 
d’Œy
 *
·»Á
 = 
	`dg‘_·»Á
(dentry);

5602 
»t
;

5604 
»t
 = 
	`bŒfs_log_šode_·»Á
(
Œªs
, 
roÙ
, 
	`BTRFS_I
(
	`d_šode
(
d’Œy
)),

5605 
·»Á
, 
¡¬t
, 
’d
, 0, 
ùx
);

5606 
	`dput
(
·»Á
);

5608  
»t
;

5609 
	}
}

5615 
	$bŒfs_»cov”_log_Œ“s
(
bŒfs_roÙ
 *
log_roÙ_Œ“
)

5617 
»t
;

5618 
bŒfs_·th
 *
·th
;

5619 
bŒfs_Œªs_hªdË
 *
Œªs
;

5620 
bŒfs_key
 
key
;

5621 
bŒfs_key
 
found_key
;

5622 
bŒfs_key
 
tmp_key
;

5623 
bŒfs_roÙ
 *
log
;

5624 
bŒfs_fs_šfo
 *
fs_šfo
 = 
log_roÙ_Œ“
->fs_info;

5625 
w®k_cÚŒÞ
 
wc
 = {

5626 .
´oûss_func
 = 
´oûss_Úe_bufãr
,

5627 .
¡age
 = 0,

5630 
·th
 = 
	`bŒfs_®loc_·th
();

5631 ià(!
·th
)

5632  -
ENOMEM
;

5634 
	`£t_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
);

5636 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
Œ“_roÙ
, 0);

5637 ià(
	`IS_ERR
(
Œªs
)) {

5638 
»t
 = 
	`PTR_ERR
(
Œªs
);

5639 
”rÜ
;

5642 
wc
.
Œªs
 =rans;

5643 
wc
.
pš
 = 1;

5645 
»t
 = 
	`w®k_log_Œ“
(
Œªs
, 
log_roÙ_Œ“
, &
wc
);

5646 ià(
»t
) {

5647 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

5649 
”rÜ
;

5652 
agaš
:

5653 
key
.
objeùid
 = 
BTRFS_TREE_LOG_OBJECTID
;

5654 
key
.
off£t
 = (
u64
)-1;

5655 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

5658 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
log_roÙ_Œ“
, &
key
, 
·th
, 0, 0);

5660 ià(
»t
 < 0) {

5661 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

5663 
”rÜ
;

5665 ià(
»t
 > 0) {

5666 ià(
·th
->
¦Ùs
[0] == 0)

5668 
·th
->
¦Ùs
[0]--;

5670 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

5671 
·th
->
¦Ùs
[0]);

5672 
	`bŒfs_»Ëa£_·th
(
·th
);

5673 ià(
found_key
.
objeùid
 !ð
BTRFS_TREE_LOG_OBJECTID
)

5676 
log
 = 
	`bŒfs_»ad_fs_roÙ
(
log_roÙ_Œ“
, &
found_key
);

5677 ià(
	`IS_ERR
(
log
)) {

5678 
»t
 = 
	`PTR_ERR
(
log
);

5679 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

5681 
”rÜ
;

5684 
tmp_key
.
objeùid
 = 
found_key
.
off£t
;

5685 
tmp_key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

5686 
tmp_key
.
off£t
 = (
u64
)-1;

5688 
wc
.
»¶ay_de¡
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
tmp_key
);

5689 ià(
	`IS_ERR
(
wc
.
»¶ay_de¡
)) {

5690 
»t
 = 
	`PTR_ERR
(
wc
.
»¶ay_de¡
);

5691 
	`ä“_ex‹Á_bufãr
(
log
->
node
);

5692 
	`ä“_ex‹Á_bufãr
(
log
->
comm™_roÙ
);

5693 
	`kä“
(
log
);

5694 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

5696 
”rÜ
;

5699 
wc
.
»¶ay_de¡
->
log_roÙ
 = 
log
;

5700 
	`bŒfs_»cÜd_roÙ_š_Œªs
(
Œªs
, 
wc
.
»¶ay_de¡
);

5701 
»t
 = 
	`w®k_log_Œ“
(
Œªs
, 
log
, &
wc
);

5703 ià(!
»t
 && 
wc
.
¡age
 =ð
LOG_WALK_REPLAY_ALL
) {

5704 
»t
 = 
	`fixup_šode_lšk_couÁs
(
Œªs
, 
wc
.
»¶ay_de¡
,

5705 
·th
);

5708 
key
.
off£t
 = 
found_key
.offset - 1;

5709 
wc
.
»¶ay_de¡
->
log_roÙ
 = 
NULL
;

5710 
	`ä“_ex‹Á_bufãr
(
log
->
node
);

5711 
	`ä“_ex‹Á_bufãr
(
log
->
comm™_roÙ
);

5712 
	`kä“
(
log
);

5714 ià(
»t
)

5715 
”rÜ
;

5717 ià(
found_key
.
off£t
 == 0)

5720 
	`bŒfs_»Ëa£_·th
(
·th
);

5723 ià(
wc
.
pš
) {

5724 
wc
.
pš
 = 0;

5725 
wc
.
´oûss_func
 = 
»¶ay_Úe_bufãr
;

5726 
wc
.
¡age
 = 
LOG_WALK_REPLAY_INODES
;

5727 
agaš
;

5730 ià(
wc
.
¡age
 < 
LOG_WALK_REPLAY_ALL
) {

5731 
wc
.
¡age
++;

5732 
agaš
;

5735 
	`bŒfs_ä“_·th
(
·th
);

5738 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

5739 ià(
»t
)

5740  
»t
;

5742 
	`ä“_ex‹Á_bufãr
(
log_roÙ_Œ“
->
node
);

5743 
log_roÙ_Œ“
->
log_roÙ
 = 
NULL
;

5744 
	`þ—r_b™
(
BTRFS_FS_LOG_RECOVERING
, &
fs_šfo
->
æags
);

5745 
	`kä“
(
log_roÙ_Œ“
);

5748 
”rÜ
:

5749 ià(
wc
.
Œªs
)

5750 
	`bŒfs_’d_Œª§ùiÚ
(
wc
.
Œªs
);

5751 
	`bŒfs_ä“_·th
(
·th
);

5752  
»t
;

5753 
	}
}

5766 
	$bŒfs_»cÜd_uÆšk_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5767 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

5768 
fÜ_»Çme
)

5780 
	`mu‹x_lock
(&
šode
->
log_mu‹x
);

5781 
šode
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

5782 
	`mu‹x_uÆock
(&
šode
->
log_mu‹x
);

5788 
	`smp_mb
();

5789 ià(
dœ
->
logged_Œªs
 =ð
Œªs
->
Œªsid
)

5796 ià(
šode
->
logged_Œªs
 =ð
Œªs
->
Œªsid
)

5806 ià(
fÜ_»Çme
)

5807 
»cÜd
;

5812 
»cÜd
:

5813 
	`mu‹x_lock
(&
dœ
->
log_mu‹x
);

5814 
dœ
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

5815 
	`mu‹x_uÆock
(&
dœ
->
log_mu‹x
);

5816 
	}
}

5830 
	$bŒfs_»cÜd_¢­shÙ_de¡roy
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5831 
bŒfs_šode
 *
dœ
)

5833 
	`mu‹x_lock
(&
dœ
->
log_mu‹x
);

5834 
dœ
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

5835 
	`mu‹x_uÆock
(&
dœ
->
log_mu‹x
);

5836 
	}
}

5845 
	$bŒfs_log_Ãw_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

5846 
bŒfs_šode
 *
šode
, bŒfs_šod*
Þd_dœ
,

5847 
d’Œy
 *
·»Á
)

5849 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
vfs_šode
.
i_sb
);

5850 
bŒfs_roÙ
 *
roÙ
 = 
šode
->root;

5856 ià(
	`S_ISREG
(
šode
->
vfs_šode
.
i_mode
))

5857 
šode
->
Ï¡_uÆšk_Œªs
 = 
Œªs
->
Œªsid
;

5863 ià(
šode
->
logged_Œªs
 <ð
fs_šfo
->
Ï¡_Œªs_comm™‹d
 &&

5864 (!
Þd_dœ
 || old_dœ->
logged_Œªs
 <ð
fs_šfo
->
Ï¡_Œªs_comm™‹d
))

5867  
	`bŒfs_log_šode_·»Á
(
Œªs
, 
roÙ
, 
šode
, 
·»Á
, 0,

5868 
LLONG_MAX
, 1, 
NULL
);

5869 
	}
}

	@tree-log.h

19 #iâdeà
__TREE_LOG_


20 
	#__TREE_LOG_


	)

22 
	~"ù»e.h
"

23 
	~"Œª§ùiÚ.h
"

26 
	#BTRFS_NO_LOG_SYNC
 256

	)

28 
	sbŒfs_log_ùx
 {

29 
	mlog_»t
;

30 
	mlog_Œªsid
;

31 
	mio_”r
;

32 
boÞ
 
	mlog_Ãw_d’Œ›s
;

33 
šode
 *
	mšode
;

34 
li¡_h—d
 
	mli¡
;

37 
šlše
 
	$bŒfs_š™_log_ùx
(
bŒfs_log_ùx
 *
ùx
,

38 
šode
 *inode)

40 
ùx
->
log_»t
 = 0;

41 
ùx
->
log_Œªsid
 = 0;

42 
ùx
->
io_”r
 = 0;

43 
ùx
->
log_Ãw_d’Œ›s
 = 
çl£
;

44 
ùx
->
šode
 = inode;

45 
	`INIT_LIST_HEAD
(&
ùx
->
li¡
);

46 
	}
}

48 
šlše
 
	$bŒfs_£t_log_fuÎ_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
,

49 
bŒfs_Œªs_hªdË
 *
Œªs
)

51 
	`WRITE_ONCE
(
fs_šfo
->
Ï¡_Œªs_log_fuÎ_comm™
, 
Œªs
->
Œªsid
);

52 
	}
}

54 
šlše
 
	$bŒfs_Ãed_log_fuÎ_comm™
(
bŒfs_fs_šfo
 *
fs_šfo
,

55 
bŒfs_Œªs_hªdË
 *
Œªs
)

57  
	`READ_ONCE
(
fs_šfo
->
Ï¡_Œªs_log_fuÎ_comm™
) ==

58 
Œªs
->
Œªsid
;

59 
	}
}

61 
bŒfs_sync_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

62 
bŒfs_roÙ
 *
roÙ
, 
bŒfs_log_ùx
 *
ùx
);

63 
bŒfs_ä“_log
(
bŒfs_Œªs_hªdË
 *
Œªs
, 
bŒfs_roÙ
 *
roÙ
);

64 
bŒfs_ä“_log_roÙ_Œ“
(
bŒfs_Œªs_hªdË
 *
Œªs
,

65 
bŒfs_fs_šfo
 *
fs_šfo
);

66 
bŒfs_»cov”_log_Œ“s
(
bŒfs_roÙ
 *
Œ“_roÙ
);

67 
bŒfs_log_d’Œy_§ã
(
bŒfs_Œªs_hªdË
 *
Œªs
,

68 
bŒfs_roÙ
 *
roÙ
, 
d’Œy
 *dentry,

69 cÚ¡ 
loff_t
 
¡¬t
,

70 cÚ¡ 
loff_t
 
’d
,

71 
bŒfs_log_ùx
 *
ùx
);

72 
bŒfs_d–_dœ_’Œ›s_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

73 
bŒfs_roÙ
 *
roÙ
,

74 cÚ¡ *
Çme
, 
Çme_Ën
,

75 
bŒfs_šode
 *
dœ
, 
u64
 
šdex
);

76 
bŒfs_d–_šode_»f_š_log
(
bŒfs_Œªs_hªdË
 *
Œªs
,

77 
bŒfs_roÙ
 *
roÙ
,

78 cÚ¡ *
Çme
, 
Çme_Ën
,

79 
bŒfs_šode
 *
šode
, 
u64
 
dœid
);

80 
bŒfs_’d_log_Œªs
(
bŒfs_roÙ
 *
roÙ
);

81 
bŒfs_pš_log_Œªs
(
bŒfs_roÙ
 *
roÙ
);

82 
bŒfs_»cÜd_uÆšk_dœ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

83 
bŒfs_šode
 *
dœ
, bŒfs_šod*
šode
,

84 
fÜ_»Çme
);

85 
bŒfs_»cÜd_¢­shÙ_de¡roy
(
bŒfs_Œªs_hªdË
 *
Œªs
,

86 
bŒfs_šode
 *
dœ
);

87 
bŒfs_log_Ãw_Çme
(
bŒfs_Œªs_hªdË
 *
Œªs
,

88 
bŒfs_šode
 *
šode
, bŒfs_šod*
Þd_dœ
,

89 
d’Œy
 *
·»Á
);

	@ulist.c

7 
	~<lšux/¦ab.h
>

8 
	~"uli¡.h
"

9 
	~"ù»e.h
"

47 
	$uli¡_š™
(
uli¡
 *ulist)

49 
	`INIT_LIST_HEAD
(&
uli¡
->
nodes
);

50 
uli¡
->
roÙ
 = 
RB_ROOT
;

51 
uli¡
->
Âodes
 = 0;

52 
	}
}

61 
	$uli¡_»Ëa£
(
uli¡
 *ulist)

63 
uli¡_node
 *
node
;

64 
uli¡_node
 *
Ãxt
;

66 
	`li¡_fÜ_—ch_’Œy_§ã
(
node
, 
Ãxt
, &
uli¡
->
nodes
, 
li¡
) {

67 
	`kä“
(
node
);

69 
uli¡
->
roÙ
 = 
RB_ROOT
;

70 
	`INIT_LIST_HEAD
(&
uli¡
->
nodes
);

71 
	}
}

80 
	$uli¡_»š™
(
uli¡
 *ulist)

82 
	`uli¡_»Ëa£
(
uli¡
);

83 
	`uli¡_š™
(
uli¡
);

84 
	}
}

92 
uli¡
 *
	$uli¡_®loc
(
gå_t
 
gå_mask
)

94 
uli¡
 *uli¡ = 
	`km®loc
((*uli¡), 
gå_mask
);

96 ià(!
uli¡
)

97  
NULL
;

99 
	`uli¡_š™
(
uli¡
);

101  
uli¡
;

102 
	}
}

110 
	$uli¡_ä“
(
uli¡
 *ulist)

112 ià(!
uli¡
)

114 
	`uli¡_»Ëa£
(
uli¡
);

115 
	`kä“
(
uli¡
);

116 
	}
}

118 
uli¡_node
 *
	$uli¡_rbŒ“_£¬ch
(
uli¡
 *uli¡, 
u64
 
v®
)

120 
rb_node
 *
n
 = 
uli¡
->
roÙ
.rb_node;

121 
uli¡_node
 *
u
 = 
NULL
;

123 
n
) {

124 
u
 = 
	`rb_’Œy
(
n
, 
uli¡_node
, 
rb_node
);

125 ià(
u
->
v®
 < val)

126 
n
 =‚->
rb_right
;

127 ià(
u
->
v®
 > val)

128 
n
 =‚->
rb_Ëá
;

130  
u
;

132  
NULL
;

133 
	}
}

135 
	$uli¡_rbŒ“_”a£
(
uli¡
 *uli¡, 
uli¡_node
 *
node
)

137 
	`rb_”a£
(&
node
->
rb_node
, &
uli¡
->
roÙ
);

138 
	`li¡_d–
(&
node
->
li¡
);

139 
	`kä“
(
node
);

140 
	`BUG_ON
(
uli¡
->
Âodes
 == 0);

141 
uli¡
->
Âodes
--;

142 
	}
}

144 
	$uli¡_rbŒ“_š£¹
(
uli¡
 *uli¡, 
uli¡_node
 *
šs
)

146 
rb_node
 **
p
 = &
uli¡
->
roÙ
.rb_node;

147 
rb_node
 *
·»Á
 = 
NULL
;

148 
uli¡_node
 *
cur
 = 
NULL
;

150 *
p
) {

151 
·»Á
 = *
p
;

152 
cur
 = 
	`rb_’Œy
(
·»Á
, 
uli¡_node
, 
rb_node
);

154 ià(
cur
->
v®
 < 
šs
->val)

155 
p
 = &(*p)->
rb_right
;

156 ià(
cur
->
v®
 > 
šs
->val)

157 
p
 = &(*p)->
rb_Ëá
;

159  -
EEXIST
;

161 
	`rb_lšk_node
(&
šs
->
rb_node
, 
·»Á
, 
p
);

162 
	`rb_š£¹_cÞÜ
(&
šs
->
rb_node
, &
uli¡
->
roÙ
);

164 
	}
}

186 
	$uli¡_add
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
, 
gå_t
 
gå_mask
)

188  
	`uli¡_add_m”ge
(
uli¡
, 
v®
, 
aux
, 
NULL
, 
gå_mask
);

189 
	}
}

191 
	$uli¡_add_m”ge
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
,

192 
u64
 *
Þd_aux
, 
gå_t
 
gå_mask
)

194 
»t
;

195 
uli¡_node
 *
node
;

197 
node
 = 
	`uli¡_rbŒ“_£¬ch
(
uli¡
, 
v®
);

198 ià(
node
) {

199 ià(
Þd_aux
)

200 *
Þd_aux
 = 
node
->
aux
;

203 
node
 = 
	`km®loc
((*node), 
gå_mask
);

204 ià(!
node
)

205  -
ENOMEM
;

207 
node
->
v®
 = val;

208 
node
->
aux
 =‡ux;

210 
»t
 = 
	`uli¡_rbŒ“_š£¹
(
uli¡
, 
node
);

211 
	`ASSERT
(!
»t
);

212 
	`li¡_add_ž
(&
node
->
li¡
, &
uli¡
->
nodes
);

213 
uli¡
->
Âodes
++;

216 
	}
}

228 
	$uli¡_d–
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
)

230 
uli¡_node
 *
node
;

232 
node
 = 
	`uli¡_rbŒ“_£¬ch
(
uli¡
, 
v®
);

234 ià(!
node
)

237 ià(
node
->
aux
 !=‡ux)

241 
	`uli¡_rbŒ“_”a£
(
uli¡
, 
node
);

243 
	}
}

261 
uli¡_node
 *
	$uli¡_Ãxt
(
uli¡
 *uli¡, 
uli¡_™”©Ü
 *
u™”
)

263 
uli¡_node
 *
node
;

265 ià(
	`li¡_em±y
(&
uli¡
->
nodes
))

266  
NULL
;

267 ià(
u™”
->
cur_li¡
 && u™”->cur_li¡->
Ãxt
 =ð&
uli¡
->
nodes
)

268  
NULL
;

269 ià(
u™”
->
cur_li¡
) {

270 
u™”
->
cur_li¡
 = u™”->cur_li¡->
Ãxt
;

272 
u™”
->
cur_li¡
 = 
uli¡
->
nodes
.
Ãxt
;

274 
node
 = 
	`li¡_’Œy
(
u™”
->
cur_li¡
, 
uli¡_node
, 
li¡
);

275  
node
;

276 
	}
}

	@ulist.h

8 #iâdeà
__ULIST__


9 
	#__ULIST__


	)

11 
	~<lšux/li¡.h
>

12 
	~<lšux/rbŒ“.h
>

21 
	suli¡_™”©Ü
 {

22 
li¡_h—d
 *
	mcur_li¡
;

28 
	suli¡_node
 {

29 
u64
 
	mv®
;

30 
u64
 
	maux
;

32 
li¡_h—d
 
	mli¡
;

33 
rb_node
 
	mrb_node
;

36 
	suli¡
 {

40 
	mÂodes
;

42 
li¡_h—d
 
	mnodes
;

43 
rb_roÙ
 
	mroÙ
;

46 
uli¡_š™
(
uli¡
 *ulist);

47 
uli¡_»Ëa£
(
uli¡
 *ulist);

48 
uli¡_»š™
(
uli¡
 *ulist);

49 
uli¡
 *
uli¡_®loc
(
gå_t
 
gå_mask
);

50 
uli¡_ä“
(
uli¡
 *ulist);

51 
uli¡_add
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
, 
gå_t
 
gå_mask
);

52 
uli¡_add_m”ge
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
,

53 
u64
 *
Þd_aux
, 
gå_t
 
gå_mask
);

54 
uli¡_d–
(
uli¡
 *uli¡, 
u64
 
v®
, u64 
aux
);

57 
šlše
 
	$uli¡_add_m”ge_±r
(
uli¡
 *uli¡, 
u64
 
v®
, *
aux
,

58 **
Þd_aux
, 
gå_t
 
gå_mask
)

60 #ià
BITS_PER_LONG
 == 32

61 
u64
 
Þd64
 = (
ušŒ_t
)*
Þd_aux
;

62 
»t
 = 
	`uli¡_add_m”ge
(
uli¡
, 
v®
, (
ušŒ_t
)
aux
, &
Þd64
, 
gå_mask
);

63 *
Þd_aux
 = (*)((
ušŒ_t
)
Þd64
);

64  
»t
;

66  
	`uli¡_add_m”ge
(
uli¡
, 
v®
, (
u64
)
aux
, (u64 *)
Þd_aux
, 
gå_mask
);

68 
	}
}

70 
uli¡_node
 *
uli¡_Ãxt
(
uli¡
 *ulist,

71 
uli¡_™”©Ü
 *
u™”
);

73 
	#ULIST_ITER_INIT
(
u™”
è((u™”)->
cur_li¡
 = 
NULL
)

	)

	@uuid-tree.c

18 
	~<lšux/uuid.h
>

19 
	~<asm/uÇligÃd.h
>

20 
	~"ù»e.h
"

21 
	~"Œª§ùiÚ.h
"

22 
	~"disk-io.h
"

23 
	~"´št-Œ“.h
"

26 
	$bŒfs_uuid_to_key
(
u8
 *
uuid
, u8 
ty³
, 
bŒfs_key
 *
key
)

28 
key
->
ty³
 =ype;

29 
key
->
objeùid
 = 
	`g‘_uÇligÃd_Ë64
(
uuid
);

30 
key
->
off£t
 = 
	`g‘_uÇligÃd_Ë64
(
uuid
 + (
u64
));

31 
	}
}

34 
	$bŒfs_uuid_Œ“_lookup
(
bŒfs_roÙ
 *
uuid_roÙ
, 
u8
 *
uuid
,

35 
u8
 
ty³
, 
u64
 
subid
)

37 
»t
;

38 
bŒfs_·th
 *
·th
 = 
NULL
;

39 
ex‹Á_bufãr
 *
eb
;

40 
¦Ù
;

41 
u32
 
™em_size
;

42 
off£t
;

43 
bŒfs_key
 
key
;

45 ià(
	`WARN_ON_ONCE
(!
uuid_roÙ
)) {

46 
»t
 = -
ENOENT
;

47 
out
;

50 
·th
 = 
	`bŒfs_®loc_·th
();

51 ià(!
·th
) {

52 
»t
 = -
ENOMEM
;

53 
out
;

56 
	`bŒfs_uuid_to_key
(
uuid
, 
ty³
, &
key
);

57 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
uuid_roÙ
, &
key
, 
·th
, 0, 0);

58 ià(
»t
 < 0) {

59 
out
;

60 } ià(
»t
 > 0) {

61 
»t
 = -
ENOENT
;

62 
out
;

65 
eb
 = 
·th
->
nodes
[0];

66 
¦Ù
 = 
·th
->
¦Ùs
[0];

67 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

68 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

69 
»t
 = -
ENOENT
;

71 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

72 
	`bŒfs_w¬n
(
uuid_roÙ
->
fs_šfo
,

74 ()
™em_size
);

75 
out
;

77 
™em_size
) {

78 
__Ë64
 
d©a
;

80 
	`»ad_ex‹Á_bufãr
(
eb
, &
d©a
, 
off£t
, (data));

81 ià(
	`Ë64_to_ýu
(
d©a
è=ð
subid
) {

82 
»t
 = 0;

85 
off£t
 +ð(
d©a
);

86 
™em_size
 -ð(
d©a
);

89 
out
:

90 
	`bŒfs_ä“_·th
(
·th
);

91  
»t
;

92 
	}
}

94 
	$bŒfs_uuid_Œ“_add
(
bŒfs_Œªs_hªdË
 *
Œªs
,

95 
bŒfs_fs_šfo
 *
fs_šfo
, 
u8
 *
uuid
, u8 
ty³
,

96 
u64
 
subid_ýu
)

98 
bŒfs_roÙ
 *
uuid_roÙ
 = 
fs_šfo
->uuid_root;

99 
»t
;

100 
bŒfs_·th
 *
·th
 = 
NULL
;

101 
bŒfs_key
 
key
;

102 
ex‹Á_bufãr
 *
eb
;

103 
¦Ù
;

104 
off£t
;

105 
__Ë64
 
subid_Ë
;

107 
»t
 = 
	`bŒfs_uuid_Œ“_lookup
(
uuid_roÙ
, 
uuid
, 
ty³
, 
subid_ýu
);

108 ià(
»t
 !ð-
ENOENT
)

109  
»t
;

111 ià(
	`WARN_ON_ONCE
(!
uuid_roÙ
)) {

112 
»t
 = -
EINVAL
;

113 
out
;

116 
	`bŒfs_uuid_to_key
(
uuid
, 
ty³
, &
key
);

118 
·th
 = 
	`bŒfs_®loc_·th
();

119 ià(!
·th
) {

120 
»t
 = -
ENOMEM
;

121 
out
;

124 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
uuid_roÙ
, 
·th
, &
key
,

125 (
subid_Ë
));

126 ià(
»t
 >= 0) {

128 
eb
 = 
·th
->
nodes
[0];

129 
¦Ù
 = 
·th
->
¦Ùs
[0];

130 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

131 } ià(
»t
 =ð-
EEXIST
) {

136 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, (
subid_Ë
));

137 
eb
 = 
·th
->
nodes
[0];

138 
¦Ù
 = 
·th
->
¦Ùs
[0];

139 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

140 
off£t
 +ð
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
è- (
subid_Ë
);

141 } ià(
»t
 < 0) {

142 
	`bŒfs_w¬n
(
fs_šfo
,

144 
»t
, ()
key
.
objeùid
,

145 ()
key
.
off£t
, 
ty³
);

146 
out
;

149 
»t
 = 0;

150 
subid_Ë
 = 
	`ýu_to_Ë64
(
subid_ýu
);

151 
	`wr™e_ex‹Á_bufãr
(
eb
, &
subid_Ë
, 
off£t
, (subid_le));

152 
	`bŒfs_m¬k_bufãr_dœty
(
eb
);

154 
out
:

155 
	`bŒfs_ä“_·th
(
·th
);

156  
»t
;

157 
	}
}

159 
	$bŒfs_uuid_Œ“_»m
(
bŒfs_Œªs_hªdË
 *
Œªs
,

160 
bŒfs_fs_šfo
 *
fs_šfo
, 
u8
 *
uuid
, u8 
ty³
,

161 
u64
 
subid
)

163 
bŒfs_roÙ
 *
uuid_roÙ
 = 
fs_šfo
->uuid_root;

164 
»t
;

165 
bŒfs_·th
 *
·th
 = 
NULL
;

166 
bŒfs_key
 
key
;

167 
ex‹Á_bufãr
 *
eb
;

168 
¦Ù
;

169 
off£t
;

170 
u32
 
™em_size
;

171 
move_d¡
;

172 
move_¤c
;

173 
move_Ën
;

175 ià(
	`WARN_ON_ONCE
(!
uuid_roÙ
)) {

176 
»t
 = -
EINVAL
;

177 
out
;

180 
	`bŒfs_uuid_to_key
(
uuid
, 
ty³
, &
key
);

182 
·th
 = 
	`bŒfs_®loc_·th
();

183 ià(!
·th
) {

184 
»t
 = -
ENOMEM
;

185 
out
;

188 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
uuid_roÙ
, &
key
, 
·th
, -1, 1);

189 ià(
»t
 < 0) {

190 
	`bŒfs_w¬n
(
fs_šfo
, "error %d while searching for uuid item!",

191 
»t
);

192 
out
;

194 ià(
»t
 > 0) {

195 
»t
 = -
ENOENT
;

196 
out
;

199 
eb
 = 
·th
->
nodes
[0];

200 
¦Ù
 = 
·th
->
¦Ùs
[0];

201 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
);

202 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

203 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

204 
	`bŒfs_w¬n
(
fs_šfo
, "uuid item with illegal size %lu!",

205 ()
™em_size
);

206 
»t
 = -
ENOENT
;

207 
out
;

209 
™em_size
) {

210 
__Ë64
 
»ad_subid
;

212 
	`»ad_ex‹Á_bufãr
(
eb
, &
»ad_subid
, 
off£t
, (read_subid));

213 ià(
	`Ë64_to_ýu
(
»ad_subid
è=ð
subid
)

215 
off£t
 +ð(
»ad_subid
);

216 
™em_size
 -ð(
»ad_subid
);

219 ià(!
™em_size
) {

220 
»t
 = -
ENOENT
;

221 
out
;

224 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

225 ià(
™em_size
 =ð(
subid
)) {

226 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
uuid_roÙ
, 
·th
);

227 
out
;

230 
move_d¡
 = 
off£t
;

231 
move_¤c
 = 
off£t
 + (
subid
);

232 
move_Ën
 = 
™em_size
 - (
move_¤c
 - 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
));

233 
	`memmove_ex‹Á_bufãr
(
eb
, 
move_d¡
, 
move_¤c
, 
move_Ën
);

234 
	`bŒfs_Œunÿ‹_™em
(
fs_šfo
, 
·th
, 
™em_size
 - (
subid
), 1);

236 
out
:

237 
	`bŒfs_ä“_·th
(
·th
);

238  
»t
;

239 
	}
}

241 
	$bŒfs_uuid_™”_»m
(
bŒfs_roÙ
 *
uuid_roÙ
, 
u8
 *
uuid
, u8 
ty³
,

242 
u64
 
subid
)

244 
bŒfs_Œªs_hªdË
 *
Œªs
;

245 
»t
;

248 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
uuid_roÙ
, 1);

249 ià(
	`IS_ERR
(
Œªs
)) {

250 
»t
 = 
	`PTR_ERR
(
Œªs
);

251 
out
;

254 
»t
 = 
	`bŒfs_uuid_Œ“_»m
(
Œªs
, 
uuid_roÙ
->
fs_šfo
, 
uuid
, 
ty³
, 
subid
);

255 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

257 
out
:

258  
»t
;

259 
	}
}

261 
	$bŒfs_uuid_Œ“_™”©e
(
bŒfs_fs_šfo
 *
fs_šfo
,

262 (*
check_func
)(
bŒfs_fs_šfo
 *, 
u8
 *, u8,

263 
u64
))

265 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
uuid_roÙ
;

266 
bŒfs_key
 
key
;

267 
bŒfs_·th
 *
·th
;

268 
»t
 = 0;

269 
ex‹Á_bufãr
 *
Ëaf
;

270 
¦Ù
;

271 
u32
 
™em_size
;

272 
off£t
;

274 
·th
 = 
	`bŒfs_®loc_·th
();

275 ià(!
·th
) {

276 
»t
 = -
ENOMEM
;

277 
out
;

280 
key
.
objeùid
 = 0;

281 
key
.
ty³
 = 0;

282 
key
.
off£t
 = 0;

284 
agaš_£¬ch_¦Ù
:

285 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 0);

286 ià(
»t
) {

287 ià(
»t
 > 0)

288 
»t
 = 0;

289 
out
;

293 
	`cÚd_»sched
();

294 
Ëaf
 = 
·th
->
nodes
[0];

295 
¦Ù
 = 
·th
->
¦Ùs
[0];

296 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
¦Ù
);

298 ià(
key
.
ty³
 !ð
BTRFS_UUID_KEY_SUBVOL
 &&

299 
key
.
ty³
 !ð
BTRFS_UUID_KEY_RECEIVED_SUBVOL
)

300 
sk
;

302 
off£t
 = 
	`bŒfs_™em_±r_off£t
(
Ëaf
, 
¦Ù
);

303 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

304 ià(!
	`IS_ALIGNED
(
™em_size
, (
u64
))) {

305 
	`bŒfs_w¬n
(
fs_šfo
,

307 ()
™em_size
);

308 
sk
;

310 
™em_size
) {

311 
u8
 
uuid
[
BTRFS_UUID_SIZE
];

312 
__Ë64
 
subid_Ë
;

313 
u64
 
subid_ýu
;

315 
	`put_uÇligÃd_Ë64
(
key
.
objeùid
, 
uuid
);

316 
	`put_uÇligÃd_Ë64
(
key
.
off£t
, 
uuid
 + (
u64
));

317 
	`»ad_ex‹Á_bufãr
(
Ëaf
, &
subid_Ë
, 
off£t
,

318 (
subid_Ë
));

319 
subid_ýu
 = 
	`Ë64_to_ýu
(
subid_Ë
);

320 
»t
 = 
	`check_func
(
fs_šfo
, 
uuid
, 
key
.
ty³
, 
subid_ýu
);

321 ià(
»t
 < 0)

322 
out
;

323 ià(
»t
 > 0) {

324 
	`bŒfs_»Ëa£_·th
(
·th
);

325 
»t
 = 
	`bŒfs_uuid_™”_»m
(
roÙ
, 
uuid
, 
key
.
ty³
,

326 
subid_ýu
);

327 ià(
»t
 == 0) {

335 
agaš_£¬ch_¦Ù
;

337 ià(
»t
 < 0 &&„‘ !ð-
ENOENT
)

338 
out
;

340 
™em_size
 -ð(
subid_Ë
);

341 
off£t
 +ð(
subid_Ë
);

344 
sk
:

345 
»t
 = 
	`bŒfs_Ãxt_™em
(
roÙ
, 
·th
);

346 ià(
»t
 == 0)

348 ià(
»t
 > 0)

349 
»t
 = 0;

353 
out
:

354 
	`bŒfs_ä“_·th
(
·th
);

355  
»t
;

356 
	}
}

	@volumes.c

18 
	~<lšux/sched.h
>

19 
	~<lšux/bio.h
>

20 
	~<lšux/¦ab.h
>

21 
	~<lšux/bufãr_h—d.h
>

22 
	~<lšux/blkdev.h
>

23 
	~<lšux/iocÚ‹xt.h
>

24 
	~<lšux/ÿ·bž™y.h
>

25 
	~<lšux/¿‹lim™.h
>

26 
	~<lšux/kth»ad.h
>

27 
	~<lšux/¿id/pq.h
>

28 
	~<lšux/£m­hÜe.h
>

29 
	~<lšux/uuid.h
>

30 
	~<asm/div64.h
>

31 
	~"ù»e.h
"

32 
	~"ex‹Á_m­.h
"

33 
	~"disk-io.h
"

34 
	~"Œª§ùiÚ.h
"

35 
	~"´št-Œ“.h
"

36 
	~"vÞumes.h
"

37 
	~"¿id56.h
"

38 
	~"async-th»ad.h
"

39 
	~"check-š‹gr™y.h
"

40 
	~"rcu-¡ršg.h
"

41 
	~"m©h.h
"

42 
	~"dev-»¶aû.h
"

43 
	~"sysfs.h
"

45 cÚ¡ 
bŒfs_¿id_©Œ
 
	gbŒfs_¿id_¬¿y
[
BTRFS_NR_RAID_TYPES
] = {

46 [
BTRFS_RAID_RAID10
] = {

47 .
sub_¡res
 = 2,

48 .
	gdev_¡res
 = 1,

49 .
	gdevs_max
 = 0,

50 .
	gdevs_mš
 = 4,

51 .
	gtÞ”©ed_çžu»s
 = 1,

52 .
	gdevs_šüem’t
 = 2,

53 .
	gncÝ›s
 = 2,

55 [
BTRFS_RAID_RAID1
] = {

56 .
sub_¡res
 = 1,

57 .
	gdev_¡res
 = 1,

58 .
	gdevs_max
 = 2,

59 .
	gdevs_mš
 = 2,

60 .
	gtÞ”©ed_çžu»s
 = 1,

61 .
	gdevs_šüem’t
 = 2,

62 .
	gncÝ›s
 = 2,

64 [
BTRFS_RAID_DUP
] = {

65 .
sub_¡res
 = 1,

66 .
	gdev_¡res
 = 2,

67 .
	gdevs_max
 = 1,

68 .
	gdevs_mš
 = 1,

69 .
	gtÞ”©ed_çžu»s
 = 0,

70 .
	gdevs_šüem’t
 = 1,

71 .
	gncÝ›s
 = 2,

73 [
BTRFS_RAID_RAID0
] = {

74 .
sub_¡res
 = 1,

75 .
	gdev_¡res
 = 1,

76 .
	gdevs_max
 = 0,

77 .
	gdevs_mš
 = 2,

78 .
	gtÞ”©ed_çžu»s
 = 0,

79 .
	gdevs_šüem’t
 = 1,

80 .
	gncÝ›s
 = 1,

82 [
BTRFS_RAID_SINGLE
] = {

83 .
sub_¡res
 = 1,

84 .
	gdev_¡res
 = 1,

85 .
	gdevs_max
 = 1,

86 .
	gdevs_mš
 = 1,

87 .
	gtÞ”©ed_çžu»s
 = 0,

88 .
	gdevs_šüem’t
 = 1,

89 .
	gncÝ›s
 = 1,

91 [
BTRFS_RAID_RAID5
] = {

92 .
sub_¡res
 = 1,

93 .
	gdev_¡res
 = 1,

94 .
	gdevs_max
 = 0,

95 .
	gdevs_mš
 = 2,

96 .
	gtÞ”©ed_çžu»s
 = 1,

97 .
	gdevs_šüem’t
 = 1,

98 .
	gncÝ›s
 = 2,

100 [
BTRFS_RAID_RAID6
] = {

101 .
sub_¡res
 = 1,

102 .
	gdev_¡res
 = 1,

103 .
	gdevs_max
 = 0,

104 .
	gdevs_mš
 = 3,

105 .
	gtÞ”©ed_çžu»s
 = 2,

106 .
	gdevs_šüem’t
 = 1,

107 .
	gncÝ›s
 = 3,

111 cÚ¡ 
u64
 
	gbŒfs_¿id_group
[
BTRFS_NR_RAID_TYPES
] = {

112 [
BTRFS_RAID_RAID10
] = 
BTRFS_BLOCK_GROUP_RAID10
,

113 [
BTRFS_RAID_RAID1
] = 
BTRFS_BLOCK_GROUP_RAID1
,

114 [
BTRFS_RAID_DUP
] = 
BTRFS_BLOCK_GROUP_DUP
,

115 [
BTRFS_RAID_RAID0
] = 
BTRFS_BLOCK_GROUP_RAID0
,

116 [
BTRFS_RAID_SINGLE
] = 0,

117 [
BTRFS_RAID_RAID5
] = 
BTRFS_BLOCK_GROUP_RAID5
,

118 [
BTRFS_RAID_RAID6
] = 
BTRFS_BLOCK_GROUP_RAID6
,

126 cÚ¡ 
	gbŒfs_¿id_mšdev_”rÜ
[
BTRFS_NR_RAID_TYPES
] = {

127 [
BTRFS_RAID_RAID10
] = 
BTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
,

128 [
BTRFS_RAID_RAID1
] = 
BTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
,

129 [
BTRFS_RAID_DUP
] = 0,

130 [
BTRFS_RAID_RAID0
] = 0,

131 [
BTRFS_RAID_SINGLE
] = 0,

132 [
BTRFS_RAID_RAID5
] = 
BTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
,

133 [
BTRFS_RAID_RAID6
] = 
BTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
,

136 
š™_fœ¡_rw_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

137 
bŒfs_fs_šfo
 *
fs_šfo
);

138 
bŒfs_»loÿ‹_sys_chunks
(
bŒfs_fs_šfo
 *
fs_šfo
);

139 
__bŒfs_»£t_dev_¡©s
(
bŒfs_deviû
 *
dev
);

140 
bŒfs_dev_¡©_´št_Ú_”rÜ
(
bŒfs_deviû
 *
dev
);

141 
bŒfs_dev_¡©_´št_Ú_lßd
(
bŒfs_deviû
 *
deviû
);

142 
__bŒfs_m­_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

143 
bŒfs_m­_Ý
 
Ý
,

144 
u64
 
logiÿl
, u64 *
Ëngth
,

145 
bŒfs_bio
 **
bbio_»t
,

146 
mœrÜ_num
, 
Ãed_¿id_m­
);

148 
DEFINE_MUTEX
(
uuid_mu‹x
);

149 
LIST_HEAD
(
fs_uuids
);

150 
li¡_h—d
 *
	$bŒfs_g‘_fs_uuids
()

152  &
fs_uuids
;

153 
	}
}

163 
bŒfs_fs_deviûs
 *
	$®loc_fs_deviûs
(cÚ¡ 
u8
 *
fsid
)

165 
bŒfs_fs_deviûs
 *
fs_devs
;

167 
fs_devs
 = 
	`kz®loc
((*fs_devs), 
GFP_KERNEL
);

168 ià(!
fs_devs
)

169  
	`ERR_PTR
(-
ENOMEM
);

171 
	`mu‹x_š™
(&
fs_devs
->
deviû_li¡_mu‹x
);

173 
	`INIT_LIST_HEAD
(&
fs_devs
->
deviûs
);

174 
	`INIT_LIST_HEAD
(&
fs_devs
->
»sized_deviûs
);

175 
	`INIT_LIST_HEAD
(&
fs_devs
->
®loc_li¡
);

176 
	`INIT_LIST_HEAD
(&
fs_devs
->
li¡
);

177 ià(
fsid
)

178 
	`memýy
(
fs_devs
->
fsid
, fsid, 
BTRFS_FSID_SIZE
);

180  
fs_devs
;

181 
	}
}

183 
	$ä“_fs_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

185 
bŒfs_deviû
 *
deviû
;

186 
	`WARN_ON
(
fs_deviûs
->
Ý’ed
);

187 !
	`li¡_em±y
(&
fs_deviûs
->
deviûs
)) {

188 
deviû
 = 
	`li¡_’Œy
(
fs_deviûs
->
deviûs
.
Ãxt
,

189 
bŒfs_deviû
, 
dev_li¡
);

190 
	`li¡_d–
(&
deviû
->
dev_li¡
);

191 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

192 
	`kä“
(
deviû
);

194 
	`kä“
(
fs_deviûs
);

195 
	}
}

197 
	$bŒfs_kobjeù_uev’t
(
block_deviû
 *
bdev
,

198 
kobjeù_aùiÚ
 
aùiÚ
)

200 
»t
;

202 
»t
 = 
	`kobjeù_uev’t
(&
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
, 
aùiÚ
);

203 ià(
»t
)

204 
	`´_w¬n
("BTRFS: Sendingƒvent '%d'o kobject: '%s' (%p): failed\n",

205 
aùiÚ
,

206 
	`kobjeù_Çme
(&
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
),

207 &
	`disk_to_dev
(
bdev
->
bd_disk
)->
kobj
);

208 
	}
}

210 
	$bŒfs_þ—nup_fs_uuids
()

212 
bŒfs_fs_deviûs
 *
fs_deviûs
;

214 !
	`li¡_em±y
(&
fs_uuids
)) {

215 
fs_deviûs
 = 
	`li¡_’Œy
(
fs_uuids
.
Ãxt
,

216 
bŒfs_fs_deviûs
, 
li¡
);

217 
	`li¡_d–
(&
fs_deviûs
->
li¡
);

218 
	`ä“_fs_deviûs
(
fs_deviûs
);

220 
	}
}

222 
bŒfs_deviû
 *
	$__®loc_deviû
()

224 
bŒfs_deviû
 *
dev
;

226 
dev
 = 
	`kz®loc
((*dev), 
GFP_KERNEL
);

227 ià(!
dev
)

228  
	`ERR_PTR
(-
ENOMEM
);

234 
dev
->
æush_bio
 = 
	`bio_®loc_bio£t
(
GFP_KERNEL
, 0, 
NULL
);

235 ià(!
dev
->
æush_bio
) {

236 
	`kä“
(
dev
);

237  
	`ERR_PTR
(-
ENOMEM
);

239 
	`bio_g‘
(
dev
->
æush_bio
);

241 
	`INIT_LIST_HEAD
(&
dev
->
dev_li¡
);

242 
	`INIT_LIST_HEAD
(&
dev
->
dev_®loc_li¡
);

243 
	`INIT_LIST_HEAD
(&
dev
->
»sized_li¡
);

245 
	`¥š_lock_š™
(&
dev
->
io_lock
);

247 
	`¥š_lock_š™
(&
dev
->
»ada_lock
);

248 
	`©omic_£t
(&
dev
->
»ada_š_æight
, 0);

249 
	`©omic_£t
(&
dev
->
dev_¡©s_cút
, 0);

250 
	`bŒfs_deviû_d©a_Üd”ed_š™
(
dev
);

251 
	`INIT_RADIX_TREE
(&
dev
->
»ada_zÚes
, 
GFP_NOFS
 & ~
__GFP_DIRECT_RECLAIM
);

252 
	`INIT_RADIX_TREE
(&
dev
->
»ada_ex‹Ás
, 
GFP_NOFS
 & ~
__GFP_DIRECT_RECLAIM
);

254  
dev
;

255 
	}
}

264 
bŒfs_deviû
 *
	$fšd_deviû
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

265 
u64
 
devid
, cÚ¡ 
u8
 *
uuid
)

267 
li¡_h—d
 *
h—d
 = &
fs_deviûs
->
deviûs
;

268 
bŒfs_deviû
 *
dev
;

270 
	`li¡_fÜ_—ch_’Œy
(
dev
, 
h—d
, 
dev_li¡
) {

271 ià(
dev
->
devid
 == devid &&

272 (!
uuid
 || !
	`memcmp
(
dev
->uuid, uuid, 
BTRFS_UUID_SIZE
))) {

273  
dev
;

276  
NULL
;

277 
	}
}

279 
nošlše
 
bŒfs_fs_deviûs
 *
	$fšd_fsid
(
u8
 *
fsid
)

281 
bŒfs_fs_deviûs
 *
fs_deviûs
;

283 
	`li¡_fÜ_—ch_’Œy
(
fs_deviûs
, &
fs_uuids
, 
li¡
) {

284 ià(
	`memcmp
(
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
) == 0)

285  
fs_deviûs
;

287  
NULL
;

288 
	}
}

291 
	$bŒfs_g‘_bdev_ªd_sb
(cÚ¡ *
deviû_·th
, 
fmode_t
 
æags
, *
hÞd”
,

292 
æush
, 
block_deviû
 **
bdev
,

293 
bufãr_h—d
 **
bh
)

295 
»t
;

297 *
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
æags
, 
hÞd”
);

299 ià(
	`IS_ERR
(*
bdev
)) {

300 
»t
 = 
	`PTR_ERR
(*
bdev
);

301 
”rÜ
;

304 ià(
æush
)

305 
	`fžem­_wr™e_ªd_wa™
((*
bdev
)->
bd_šode
->
i_m­pšg
);

306 
»t
 = 
	`£t_blocksize
(*
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

307 ià(
»t
) {

308 
	`blkdev_put
(*
bdev
, 
æags
);

309 
”rÜ
;

311 
	`šv®id©e_bdev
(*
bdev
);

312 *
bh
 = 
	`bŒfs_»ad_dev_su³r
(*
bdev
);

313 ià(
	`IS_ERR
(*
bh
)) {

314 
»t
 = 
	`PTR_ERR
(*
bh
);

315 
	`blkdev_put
(*
bdev
, 
æags
);

316 
”rÜ
;

321 
”rÜ
:

322 *
bdev
 = 
NULL
;

323 *
bh
 = 
NULL
;

324  
»t
;

325 
	}
}

327 
	$»queue_li¡
(
bŒfs_³ndšg_bios
 *
³ndšg_bios
,

328 
bio
 *
h—d
, biØ*
ž
)

331 
bio
 *
Þd_h—d
;

333 
Þd_h—d
 = 
³ndšg_bios
->
h—d
;

334 
³ndšg_bios
->
h—d
 = head;

335 ià(
³ndšg_bios
->
ž
)

336 
ž
->
bi_Ãxt
 = 
Þd_h—d
;

338 
³ndšg_bios
->
ž
 =ail;

339 
	}
}

352 
nošlše
 
	$run_scheduËd_bios
(
bŒfs_deviû
 *
deviû
)

354 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

355 
bio
 *
³ndšg
;

356 
backšg_dev_šfo
 *
bdi
;

357 
bŒfs_³ndšg_bios
 *
³ndšg_bios
;

358 
bio
 *
ž
;

359 
bio
 *
cur
;

360 
agaš
 = 0;

361 
num_run
;

362 
b©ch_run
 = 0;

363 
lim™
;

364 
Ï¡_wa™ed
 = 0;

365 
fÜû_»g
 = 0;

366 
sync_³ndšg
 = 0;

367 
blk_¶ug
 
¶ug
;

375 
	`blk_¡¬t_¶ug
(&
¶ug
);

377 
bdi
 = 
deviû
->
bdev
->
bd_bdi
;

378 
lim™
 = 
	`bŒfs_async_subm™_lim™
(
fs_šfo
);

379 
lim™
 =†imit * 2 / 3;

381 
loÝ
:

382 
	`¥š_lock
(&
deviû
->
io_lock
);

384 
loÝ_lock
:

385 
num_run
 = 0;

392 ià(!
fÜû_»g
 && 
deviû
->
³ndšg_sync_bios
.
h—d
) {

393 
³ndšg_bios
 = &
deviû
->
³ndšg_sync_bios
;

394 
fÜû_»g
 = 1;

396 
³ndšg_bios
 = &
deviû
->pending_bios;

397 
fÜû_»g
 = 0;

400 
³ndšg
 = 
³ndšg_bios
->
h—d
;

401 
ž
 = 
³ndšg_bios
->tail;

402 
	`WARN_ON
(
³ndšg
 && !
ž
);

412 ià(
deviû
->
³ndšg_sync_bios
.
h—d
 =ð
NULL
 &&

413 
deviû
->
³ndšg_bios
.
h—d
 =ð
NULL
) {

414 
agaš
 = 0;

415 
deviû
->
ruÂšg_³ndšg
 = 0;

417 
agaš
 = 1;

418 
deviû
->
ruÂšg_³ndšg
 = 1;

421 
³ndšg_bios
->
h—d
 = 
NULL
;

422 
³ndšg_bios
->
ž
 = 
NULL
;

424 
	`¥š_uÆock
(&
deviû
->
io_lock
);

426 
³ndšg
) {

428 
	`rmb
();

432 ià((
num_run
 > 32 &&

433 
³ndšg_bios
 !ð&
deviû
->
³ndšg_sync_bios
 &&

434 
deviû
->
³ndšg_sync_bios
.
h—d
) ||

435 (
num_run
 > 64 && 
³ndšg_bios
 =ð&
deviû
->
³ndšg_sync_bios
 &&

436 
deviû
->
³ndšg_bios
.
h—d
)) {

437 
	`¥š_lock
(&
deviû
->
io_lock
);

438 
	`»queue_li¡
(
³ndšg_bios
, 
³ndšg
, 
ž
);

439 
loÝ_lock
;

442 
cur
 = 
³ndšg
;

443 
³ndšg
 =…’dšg->
bi_Ãxt
;

444 
cur
->
bi_Ãxt
 = 
NULL
;

449 ià(
	`©omic_dec_»tuº
(&
fs_šfo
->
Ä_async_bios
è< 
lim™
 &&

450 
	`wa™queue_aùive
(&
fs_šfo
->
async_subm™_wa™
))

451 
	`wake_up
(&
fs_šfo
->
async_subm™_wa™
);

453 
	`BUG_ON
(
	`©omic_»ad
(&
cur
->
__bi_út
) == 0);

463 ià(
³ndšg_bios
 =ð&
deviû
->
³ndšg_sync_bios
) {

464 
sync_³ndšg
 = 1;

465 } ià(
sync_³ndšg
) {

466 
	`blk_fšish_¶ug
(&
¶ug
);

467 
	`blk_¡¬t_¶ug
(&
¶ug
);

468 
sync_³ndšg
 = 0;

471 
	`bŒfsic_subm™_bio
(
cur
);

472 
num_run
++;

473 
b©ch_run
++;

475 
	`cÚd_»sched
();

482 ià(
³ndšg
 && 
	`bdi_wr™e_cÚge¡ed
(
bdi
è&& 
b©ch_run
 > 8 &&

483 
fs_šfo
->
fs_deviûs
->
Ý’_deviûs
 > 1) {

484 
io_cÚ‹xt
 *
ioc
;

486 
ioc
 = 
cu¼’t
->
io_cÚ‹xt
;

497 ià(
ioc
 && ioc->
Ä_b©ch_»que¡s
 > 0 &&

498 
	`time_befÜe
(
jiff›s
, 
ioc
->
Ï¡_wa™ed
 + 
HZ
/50UL) &&

499 (
Ï¡_wa™ed
 == 0 ||

500 
ioc
->
Ï¡_wa™ed
 ==†ast_waited)) {

507 
Ï¡_wa™ed
 = 
ioc
->last_waited;

508 
	`cÚd_»sched
();

511 
	`¥š_lock
(&
deviû
->
io_lock
);

512 
	`»queue_li¡
(
³ndšg_bios
, 
³ndšg
, 
ž
);

513 
deviû
->
ruÂšg_³ndšg
 = 1;

515 
	`¥š_uÆock
(&
deviû
->
io_lock
);

516 
	`bŒfs_queue_wÜk
(
fs_šfo
->
subm™_wÜk”s
,

517 &
deviû
->
wÜk
);

518 
dÚe
;

521 ià(
b©ch_run
 % 64 == 0) {

522 
	`blk_fšish_¶ug
(&
¶ug
);

523 
	`blk_¡¬t_¶ug
(&
¶ug
);

524 
sync_³ndšg
 = 0;

528 
	`cÚd_»sched
();

529 ià(
agaš
)

530 
loÝ
;

532 
	`¥š_lock
(&
deviû
->
io_lock
);

533 ià(
deviû
->
³ndšg_bios
.
h—d
 || deviû->
³ndšg_sync_bios
.head)

534 
loÝ_lock
;

535 
	`¥š_uÆock
(&
deviû
->
io_lock
);

537 
dÚe
:

538 
	`blk_fšish_¶ug
(&
¶ug
);

539 
	}
}

541 
	$³ndšg_bios_â
(
bŒfs_wÜk
 *
wÜk
)

543 
bŒfs_deviû
 *
deviû
;

545 
deviû
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_deviû
, work);

546 
	`run_scheduËd_bios
(
deviû
);

547 
	}
}

550 
	$bŒfs_ä“_¡®e_deviû
(
bŒfs_deviû
 *
cur_dev
)

552 
bŒfs_fs_deviûs
 *
fs_devs
;

553 
bŒfs_deviû
 *
dev
;

555 ià(!
cur_dev
->
Çme
)

558 
	`li¡_fÜ_—ch_’Œy
(
fs_devs
, &
fs_uuids
, 
li¡
) {

559 
d–
 = 1;

561 ià(
fs_devs
->
Ý’ed
)

563 ià(
fs_devs
->
£edšg
)

566 
	`li¡_fÜ_—ch_’Œy
(
dev
, &
fs_devs
->
deviûs
, 
dev_li¡
) {

568 ià(
dev
 =ð
cur_dev
)

570 ià(!
dev
->
Çme
)

579 
	`rcu_»ad_lock
();

580 
d–
 = 
	`¡rcmp
(
	`rcu_¡r_d”ef
(
dev
->
Çme
),

581 
	`rcu_¡r_d”ef
(
cur_dev
->
Çme
));

582 
	`rcu_»ad_uÆock
();

583 ià(!
d–
)

587 ià(!
d–
) {

589 ià(
fs_devs
->
num_deviûs
 == 1) {

590 
	`bŒfs_sysfs_»move_fsid
(
fs_devs
);

591 
	`li¡_d–
(&
fs_devs
->
li¡
);

592 
	`ä“_fs_deviûs
(
fs_devs
);

594 
fs_devs
->
num_deviûs
--;

595 
	`li¡_d–
(&
dev
->
dev_li¡
);

596 
	`rcu_¡ršg_ä“
(
dev
->
Çme
);

597 
	`kä“
(
dev
);

602 
	}
}

612 
nošlše
 
	$deviû_li¡_add
(cÚ¡ *
·th
,

613 
bŒfs_su³r_block
 *
disk_su³r
,

614 
u64
 
devid
, 
bŒfs_fs_deviûs
 **
fs_deviûs_»t
)

616 
bŒfs_deviû
 *
deviû
;

617 
bŒfs_fs_deviûs
 *
fs_deviûs
;

618 
rcu_¡ršg
 *
Çme
;

619 
»t
 = 0;

620 
u64
 
found_Œªsid
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

622 
fs_deviûs
 = 
	`fšd_fsid
(
disk_su³r
->
fsid
);

623 ià(!
fs_deviûs
) {

624 
fs_deviûs
 = 
	`®loc_fs_deviûs
(
disk_su³r
->
fsid
);

625 ià(
	`IS_ERR
(
fs_deviûs
))

626  
	`PTR_ERR
(
fs_deviûs
);

628 
	`li¡_add
(&
fs_deviûs
->
li¡
, &
fs_uuids
);

630 
deviû
 = 
NULL
;

632 
deviû
 = 
	`fšd_deviû
(
fs_deviûs
, 
devid
,

633 
disk_su³r
->
dev_™em
.
uuid
);

636 ià(!
deviû
) {

637 ià(
fs_deviûs
->
Ý’ed
)

638  -
EBUSY
;

640 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
devid
,

641 
disk_su³r
->
dev_™em
.
uuid
);

642 ià(
	`IS_ERR
(
deviû
)) {

644  
	`PTR_ERR
(
deviû
);

647 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
·th
, 
GFP_NOFS
);

648 ià(!
Çme
) {

649 
	`kä“
(
deviû
);

650  -
ENOMEM
;

652 
	`rcu_assign_poš‹r
(
deviû
->
Çme
,‚ame);

654 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

655 
	`li¡_add_rcu
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

656 
fs_deviûs
->
num_deviûs
++;

657 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

659 
»t
 = 1;

660 
deviû
->
fs_deviûs
 = fs_devices;

661 } ià(!
deviû
->
Çme
 || 
	`¡rcmp
(deviû->Çme->
¡r
, 
·th
)) {

688 ià(!
fs_deviûs
->
Ý’ed
 && 
found_Œªsid
 < 
deviû
->
g’”©iÚ
) {

696  -
EEXIST
;

699 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
·th
, 
GFP_NOFS
);

700 ià(!
Çme
)

701  -
ENOMEM
;

702 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

703 
	`rcu_assign_poš‹r
(
deviû
->
Çme
,‚ame);

704 ià(
deviû
->
missšg
) {

705 
fs_deviûs
->
missšg_deviûs
--;

706 
deviû
->
missšg
 = 0;

716 ià(!
fs_deviûs
->
Ý’ed
)

717 
deviû
->
g’”©iÚ
 = 
found_Œªsid
;

723 ià(
»t
 > 0)

724 
	`bŒfs_ä“_¡®e_deviû
(
deviû
);

726 *
fs_deviûs_»t
 = 
fs_deviûs
;

728  
»t
;

729 
	}
}

731 
bŒfs_fs_deviûs
 *
	$þÚe_fs_deviûs
(
bŒfs_fs_deviûs
 *
Üig
)

733 
bŒfs_fs_deviûs
 *
fs_deviûs
;

734 
bŒfs_deviû
 *
deviû
;

735 
bŒfs_deviû
 *
Üig_dev
;

737 
fs_deviûs
 = 
	`®loc_fs_deviûs
(
Üig
->
fsid
);

738 ià(
	`IS_ERR
(
fs_deviûs
))

739  
fs_deviûs
;

741 
	`mu‹x_lock
(&
Üig
->
deviû_li¡_mu‹x
);

742 
fs_deviûs
->
tÙ®_deviûs
 = 
Üig
->total_devices;

745 
	`li¡_fÜ_—ch_’Œy
(
Üig_dev
, &
Üig
->
deviûs
, 
dev_li¡
) {

746 
rcu_¡ršg
 *
Çme
;

748 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
Üig_dev
->
devid
,

749 
Üig_dev
->
uuid
);

750 ià(
	`IS_ERR
(
deviû
))

751 
”rÜ
;

757 ià(
Üig_dev
->
Çme
) {

758 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
Üig_dev
->Çme->
¡r
,

759 
GFP_KERNEL
);

760 ià(!
Çme
) {

761 
	`kä“
(
deviû
);

762 
”rÜ
;

764 
	`rcu_assign_poš‹r
(
deviû
->
Çme
,‚ame);

767 
	`li¡_add
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

768 
deviû
->
fs_deviûs
 = fs_devices;

769 
fs_deviûs
->
num_deviûs
++;

771 
	`mu‹x_uÆock
(&
Üig
->
deviû_li¡_mu‹x
);

772  
fs_deviûs
;

773 
”rÜ
:

774 
	`mu‹x_uÆock
(&
Üig
->
deviû_li¡_mu‹x
);

775 
	`ä“_fs_deviûs
(
fs_deviûs
);

776  
	`ERR_PTR
(-
ENOMEM
);

777 
	}
}

779 
	$bŒfs_þo£_exŒa_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
, 
¡•
)

781 
bŒfs_deviû
 *
deviû
, *
Ãxt
;

782 
bŒfs_deviû
 *
Ï‹¡_dev
 = 
NULL
;

784 
	`mu‹x_lock
(&
uuid_mu‹x
);

785 
agaš
:

787 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
Ãxt
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

788 ià(
deviû
->
š_fs_m‘ad©a
) {

789 ià(!
deviû
->
is_tgtdev_fÜ_dev_»¶aû
 &&

790 (!
Ï‹¡_dev
 ||

791 
deviû
->
g’”©iÚ
 > 
Ï‹¡_dev
->generation)) {

792 
Ï‹¡_dev
 = 
deviû
;

797 ià(
deviû
->
devid
 =ð
BTRFS_DEV_REPLACE_DEVID
) {

808 ià(
¡•
 =ð0 || 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
) {

812 ià(
deviû
->
bdev
) {

813 
	`blkdev_put
(
deviû
->
bdev
, deviû->
mode
);

814 
deviû
->
bdev
 = 
NULL
;

815 
fs_deviûs
->
Ý’_deviûs
--;

817 ià(
deviû
->
wr™—bË
) {

818 
	`li¡_d–_š™
(&
deviû
->
dev_®loc_li¡
);

819 
deviû
->
wr™—bË
 = 0;

820 ià(!
deviû
->
is_tgtdev_fÜ_dev_»¶aû
)

821 
fs_deviûs
->
rw_deviûs
--;

823 
	`li¡_d–_š™
(&
deviû
->
dev_li¡
);

824 
fs_deviûs
->
num_deviûs
--;

825 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

826 
	`kä“
(
deviû
);

829 ià(
fs_deviûs
->
£ed
) {

830 
fs_deviûs
 = fs_deviûs->
£ed
;

831 
agaš
;

834 
fs_deviûs
->
Ï‹¡_bdev
 = 
Ï‹¡_dev
->
bdev
;

836 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

837 
	}
}

839 
	$__ä“_deviû
(
wÜk_¡ruù
 *
wÜk
)

841 
bŒfs_deviû
 *
deviû
;

843 
deviû
 = 
	`cÚš”_of
(
wÜk
, 
bŒfs_deviû
, 
rcu_wÜk
);

844 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

845 
	`bio_put
(
deviû
->
æush_bio
);

846 
	`kä“
(
deviû
);

847 
	}
}

849 
	$ä“_deviû
(
rcu_h—d
 *
h—d
)

851 
bŒfs_deviû
 *
deviû
;

853 
deviû
 = 
	`cÚš”_of
(
h—d
, 
bŒfs_deviû
, 
rcu
);

855 
	`INIT_WORK
(&
deviû
->
rcu_wÜk
, 
__ä“_deviû
);

856 
	`scheduË_wÜk
(&
deviû
->
rcu_wÜk
);

857 
	}
}

859 
	$bŒfs_þo£_bdev
(
bŒfs_deviû
 *
deviû
)

861 ià(
deviû
->
bdev
 && deviû->
wr™—bË
) {

862 
	`sync_blockdev
(
deviû
->
bdev
);

863 
	`šv®id©e_bdev
(
deviû
->
bdev
);

866 ià(
deviû
->
bdev
)

867 
	`blkdev_put
(
deviû
->
bdev
, deviû->
mode
);

868 
	}
}

870 
	$bŒfs_´•¬e_þo£_Úe_deviû
(
bŒfs_deviû
 *
deviû
)

872 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
deviû
->fs_devices;

873 
bŒfs_deviû
 *
Ãw_deviû
;

874 
rcu_¡ršg
 *
Çme
;

876 ià(
deviû
->
bdev
)

877 
fs_deviûs
->
Ý’_deviûs
--;

879 ià(
deviû
->
wr™—bË
 &&

880 
deviû
->
devid
 !ð
BTRFS_DEV_REPLACE_DEVID
) {

881 
	`li¡_d–_š™
(&
deviû
->
dev_®loc_li¡
);

882 
fs_deviûs
->
rw_deviûs
--;

885 ià(
deviû
->
missšg
)

886 
fs_deviûs
->
missšg_deviûs
--;

888 
Ãw_deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
deviû
->
devid
,

889 
deviû
->
uuid
);

890 
	`BUG_ON
(
	`IS_ERR
(
Ãw_deviû
));

893 ià(
deviû
->
Çme
) {

894 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
deviû
->Çme->
¡r
, 
GFP_NOFS
);

895 
	`BUG_ON
(!
Çme
);

896 
	`rcu_assign_poš‹r
(
Ãw_deviû
->
Çme
,‚ame);

899 
	`li¡_»¶aû_rcu
(&
deviû
->
dev_li¡
, &
Ãw_deviû
->dev_list);

900 
Ãw_deviû
->
fs_deviûs
 = 
deviû
->fs_devices;

901 
	}
}

903 
	$__bŒfs_þo£_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

905 
bŒfs_deviû
 *
deviû
, *
tmp
;

906 
li¡_h—d
 
³ndšg_put
;

908 
	`INIT_LIST_HEAD
(&
³ndšg_put
);

910 ià(--
fs_deviûs
->
Ý’ed
 > 0)

913 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

914 
	`li¡_fÜ_—ch_’Œy_§ã
(
deviû
, 
tmp
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

915 
	`bŒfs_´•¬e_þo£_Úe_deviû
(
deviû
);

916 
	`li¡_add
(&
deviû
->
dev_li¡
, &
³ndšg_put
);

918 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

926 !
	`li¡_em±y
(&
³ndšg_put
)) {

927 
deviû
 = 
	`li¡_fœ¡_’Œy
(&
³ndšg_put
,

928 
bŒfs_deviû
, 
dev_li¡
);

929 
	`li¡_d–
(&
deviû
->
dev_li¡
);

930 
	`bŒfs_þo£_bdev
(
deviû
);

931 
	`ÿÎ_rcu
(&
deviû
->
rcu
, 
ä“_deviû
);

934 
	`WARN_ON
(
fs_deviûs
->
Ý’_deviûs
);

935 
	`WARN_ON
(
fs_deviûs
->
rw_deviûs
);

936 
fs_deviûs
->
Ý’ed
 = 0;

937 
fs_deviûs
->
£edšg
 = 0;

940 
	}
}

942 
	$bŒfs_þo£_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
)

944 
bŒfs_fs_deviûs
 *
£ed_deviûs
 = 
NULL
;

945 
»t
;

947 
	`mu‹x_lock
(&
uuid_mu‹x
);

948 
»t
 = 
	`__bŒfs_þo£_deviûs
(
fs_deviûs
);

949 ià(!
fs_deviûs
->
Ý’ed
) {

950 
£ed_deviûs
 = 
fs_deviûs
->
£ed
;

951 
fs_deviûs
->
£ed
 = 
NULL
;

953 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

955 
£ed_deviûs
) {

956 
fs_deviûs
 = 
£ed_deviûs
;

957 
£ed_deviûs
 = 
fs_deviûs
->
£ed
;

958 
	`__bŒfs_þo£_deviûs
(
fs_deviûs
);

959 
	`ä“_fs_deviûs
(
fs_deviûs
);

966 
	`rcu_b¬r›r
();

967  
»t
;

968 
	}
}

970 
	$__bŒfs_Ý’_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

971 
fmode_t
 
æags
, *
hÞd”
)

973 
»que¡_queue
 *
q
;

974 
block_deviû
 *
bdev
;

975 
li¡_h—d
 *
h—d
 = &
fs_deviûs
->
deviûs
;

976 
bŒfs_deviû
 *
deviû
;

977 
bŒfs_deviû
 *
Ï‹¡_dev
 = 
NULL
;

978 
bufãr_h—d
 *
bh
;

979 
bŒfs_su³r_block
 *
disk_su³r
;

980 
u64
 
devid
;

981 
£edšg
 = 1;

982 
»t
 = 0;

984 
æags
 |ð
FMODE_EXCL
;

986 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
h—d
, 
dev_li¡
) {

987 ià(
deviû
->
bdev
)

989 ià(!
deviû
->
Çme
)

993 ià(
	`bŒfs_g‘_bdev_ªd_sb
(
deviû
->
Çme
->
¡r
, 
æags
, 
hÞd”
, 1,

994 &
bdev
, &
bh
))

997 
disk_su³r
 = (
bŒfs_su³r_block
 *)
bh
->
b_d©a
;

998 
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

999 ià(
devid
 !ð
deviû
->devid)

1000 
”rÜ_b»l£
;

1002 ià(
	`memcmp
(
deviû
->
uuid
, 
disk_su³r
->
dev_™em
.uuid,

1003 
BTRFS_UUID_SIZE
))

1004 
”rÜ_b»l£
;

1006 
deviû
->
g’”©iÚ
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

1007 ià(!
Ï‹¡_dev
 ||

1008 
deviû
->
g’”©iÚ
 > 
Ï‹¡_dev
->generation)

1009 
Ï‹¡_dev
 = 
deviû
;

1011 ià(
	`bŒfs_su³r_æags
(
disk_su³r
è& 
BTRFS_SUPER_FLAG_SEEDING
) {

1012 
deviû
->
wr™—bË
 = 0;

1014 
deviû
->
wr™—bË
 = !
	`bdev_»ad_Úly
(
bdev
);

1015 
£edšg
 = 0;

1018 
q
 = 
	`bdev_g‘_queue
(
bdev
);

1019 ià(
	`blk_queue_disÿrd
(
q
))

1020 
deviû
->
ÿn_disÿrd
 = 1;

1021 ià(!
	`blk_queue_nÚrÙ
(
q
))

1022 
fs_deviûs
->
rÙ©šg
 = 1;

1024 
deviû
->
bdev
 = bdev;

1025 
deviû
->
š_fs_m‘ad©a
 = 0;

1026 
deviû
->
mode
 = 
æags
;

1028 
fs_deviûs
->
Ý’_deviûs
++;

1029 ià(
deviû
->
wr™—bË
 &&

1030 
deviû
->
devid
 !ð
BTRFS_DEV_REPLACE_DEVID
) {

1031 
fs_deviûs
->
rw_deviûs
++;

1032 
	`li¡_add
(&
deviû
->
dev_®loc_li¡
,

1033 &
fs_deviûs
->
®loc_li¡
);

1035 
	`b»l£
(
bh
);

1038 
”rÜ_b»l£
:

1039 
	`b»l£
(
bh
);

1040 
	`blkdev_put
(
bdev
, 
æags
);

1043 ià(
fs_deviûs
->
Ý’_deviûs
 == 0) {

1044 
»t
 = -
EINVAL
;

1045 
out
;

1047 
fs_deviûs
->
£edšg
 = seeding;

1048 
fs_deviûs
->
Ý’ed
 = 1;

1049 
fs_deviûs
->
Ï‹¡_bdev
 = 
Ï‹¡_dev
->
bdev
;

1050 
fs_deviûs
->
tÙ®_rw_by‹s
 = 0;

1051 
out
:

1052  
»t
;

1053 
	}
}

1055 
	$bŒfs_Ý’_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

1056 
fmode_t
 
æags
, *
hÞd”
)

1058 
»t
;

1060 
	`mu‹x_lock
(&
uuid_mu‹x
);

1061 ià(
fs_deviûs
->
Ý’ed
) {

1062 
fs_deviûs
->
Ý’ed
++;

1063 
»t
 = 0;

1065 
»t
 = 
	`__bŒfs_Ý’_deviûs
(
fs_deviûs
, 
æags
, 
hÞd”
);

1067 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1068  
»t
;

1069 
	}
}

1071 
	$bŒfs_»Ëa£_disk_su³r
(
·ge
 *page)

1073 
	`kunm­
(
·ge
);

1074 
	`put_·ge
(
·ge
);

1075 
	}
}

1077 
	$bŒfs_»ad_disk_su³r
(
block_deviû
 *
bdev
, 
u64
 
by‹Ä
,

1078 
·ge
 **·ge, 
bŒfs_su³r_block
 **
disk_su³r
)

1080 *
p
;

1081 
pgoff_t
 
šdex
;

1084 ià(
by‹Ä
 + 
PAGE_SIZE
 >ð
	`i_size_»ad
(
bdev
->
bd_šode
))

1088 ià((**
disk_su³r
è> 
PAGE_SIZE
)

1092 
šdex
 = 
by‹Ä
 >> 
PAGE_SHIFT
;

1093 ià((
by‹Ä
 + (**
disk_su³r
è- 1è>> 
PAGE_SHIFT
 !ð
šdex
)

1097 *
·ge
 = 
	`»ad_ÿche_·ge_gå
(
bdev
->
bd_šode
->
i_m­pšg
,

1098 
šdex
, 
GFP_KERNEL
);

1100 ià(
	`IS_ERR_OR_NULL
(*
·ge
))

1103 
p
 = 
	`km­
(*
·ge
);

1106 *
disk_su³r
 = 
p
 + (
by‹Ä
 & ~
PAGE_MASK
);

1108 ià(
	`bŒfs_su³r_by‹Ä
(*
disk_su³r
è!ð
by‹Ä
 ||

1109 
	`bŒfs_su³r_magic
(*
disk_su³r
è!ð
BTRFS_MAGIC
) {

1110 
	`bŒfs_»Ëa£_disk_su³r
(*
·ge
);

1114 ià((*
disk_su³r
)->
Ïb–
[0] &&

1115 (*
disk_su³r
)->
Ïb–
[
BTRFS_LABEL_SIZE
 - 1])

1116 (*
disk_su³r
)->
Ïb–
[
BTRFS_LABEL_SIZE
 - 1] = '\0';

1119 
	}
}

1126 
	$bŒfs_sÿn_Úe_deviû
(cÚ¡ *
·th
, 
fmode_t
 
æags
, *
hÞd”
,

1127 
bŒfs_fs_deviûs
 **
fs_deviûs_»t
)

1129 
bŒfs_su³r_block
 *
disk_su³r
;

1130 
block_deviû
 *
bdev
;

1131 
·ge
 *page;

1132 
»t
 = -
EINVAL
;

1133 
u64
 
devid
;

1134 
u64
 
Œªsid
;

1135 
u64
 
tÙ®_deviûs
;

1136 
u64
 
by‹Ä
;

1144 
by‹Ä
 = 
	`bŒfs_sb_off£t
(0);

1145 
æags
 |ð
FMODE_EXCL
;

1146 
	`mu‹x_lock
(&
uuid_mu‹x
);

1148 
bdev
 = 
	`blkdev_g‘_by_·th
(
·th
, 
æags
, 
hÞd”
);

1149 ià(
	`IS_ERR
(
bdev
)) {

1150 
»t
 = 
	`PTR_ERR
(
bdev
);

1151 
”rÜ
;

1154 ià(
	`bŒfs_»ad_disk_su³r
(
bdev
, 
by‹Ä
, &
·ge
, &
disk_su³r
))

1155 
”rÜ_bdev_put
;

1157 
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

1158 
Œªsid
 = 
	`bŒfs_su³r_g’”©iÚ
(
disk_su³r
);

1159 
tÙ®_deviûs
 = 
	`bŒfs_su³r_num_deviûs
(
disk_su³r
);

1161 
»t
 = 
	`deviû_li¡_add
(
·th
, 
disk_su³r
, 
devid
, 
fs_deviûs_»t
);

1162 ià(
»t
 > 0) {

1163 ià(
disk_su³r
->
Ïb–
[0]) {

1164 
	`´_šfo
("BTRFS: deviû†ab– % ", 
disk_su³r
->
Ïb–
);

1166 
	`´_šfo
("BTRFS: deviû fsid %pU ", 
disk_su³r
->
fsid
);

1169 
	`´_cÚt
("devid %Îu¿nsid %Îu %s\n", 
devid
, 
Œªsid
, 
·th
);

1170 
»t
 = 0;

1172 ià(!
»t
 && 
fs_deviûs_»t
)

1173 (*
fs_deviûs_»t
)->
tÙ®_deviûs
 =otal_devices;

1175 
	`bŒfs_»Ëa£_disk_su³r
(
·ge
);

1177 
”rÜ_bdev_put
:

1178 
	`blkdev_put
(
bdev
, 
æags
);

1179 
”rÜ
:

1180 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1181  
»t
;

1182 
	}
}

1185 
	$bŒfs_accouÁ_dev_ex‹Ás_size
(
bŒfs_deviû
 *
deviû
, 
u64
 
¡¬t
,

1186 
u64
 
’d
, u64 *
Ëngth
)

1188 
bŒfs_key
 
key
;

1189 
bŒfs_roÙ
 *
roÙ
 = 
deviû
->
fs_šfo
->
dev_roÙ
;

1190 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
;

1191 
bŒfs_·th
 *
·th
;

1192 
u64
 
ex‹Á_’d
;

1193 
»t
;

1194 
¦Ù
;

1195 
ex‹Á_bufãr
 *
l
;

1197 *
Ëngth
 = 0;

1199 ià(
¡¬t
 >ð
deviû
->
tÙ®_by‹s
 || deviû->
is_tgtdev_fÜ_dev_»¶aû
)

1202 
·th
 = 
	`bŒfs_®loc_·th
();

1203 ià(!
·th
)

1204  -
ENOMEM
;

1205 
·th
->
»ada
 = 
READA_FORWARD
;

1207 
key
.
objeùid
 = 
deviû
->
devid
;

1208 
key
.
off£t
 = 
¡¬t
;

1209 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

1211 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1212 ià(
»t
 < 0)

1213 
out
;

1214 ià(
»t
 > 0) {

1215 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
key
.
objeùid
, key.
ty³
);

1216 ià(
»t
 < 0)

1217 
out
;

1221 
l
 = 
·th
->
nodes
[0];

1222 
¦Ù
 = 
·th
->
¦Ùs
[0];

1223 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
l
)) {

1224 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1225 ià(
»t
 == 0)

1227 ià(
»t
 < 0)

1228 
out
;

1232 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
¦Ù
);

1234 ià(
key
.
objeùid
 < 
deviû
->
devid
)

1235 
Ãxt
;

1237 ià(
key
.
objeùid
 > 
deviû
->
devid
)

1240 ià(
key
.
ty³
 !ð
BTRFS_DEV_EXTENT_KEY
)

1241 
Ãxt
;

1243 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

1244 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
,

1245 
dev_ex‹Á
);

1246 ià(
key
.
off£t
 <ð
¡¬t
 && 
ex‹Á_’d
 > 
’d
) {

1247 *
Ëngth
 = 
’d
 - 
¡¬t
 + 1;

1249 } ià(
key
.
off£t
 <ð
¡¬t
 && 
ex‹Á_’d
 > start)

1250 *
Ëngth
 +ð
ex‹Á_’d
 - 
¡¬t
;

1251 ià(
key
.
off£t
 > 
¡¬t
 && 
ex‹Á_’d
 <ð
’d
)

1252 *
Ëngth
 +ð
ex‹Á_’d
 - 
key
.
off£t
;

1253 ià(
key
.
off£t
 > 
¡¬t
 && key.off£ˆ<ð
’d
) {

1254 *
Ëngth
 +ð
’d
 - 
key
.
off£t
 + 1;

1256 } ià(
key
.
off£t
 > 
’d
)

1259 
Ãxt
:

1260 
·th
->
¦Ùs
[0]++;

1262 
»t
 = 0;

1263 
out
:

1264 
	`bŒfs_ä“_·th
(
·th
);

1265  
»t
;

1266 
	}
}

1268 
	$cÚšs_³ndšg_ex‹Á
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
,

1269 
bŒfs_deviû
 *
deviû
,

1270 
u64
 *
¡¬t
, u64 
Ën
)

1272 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

1273 
ex‹Á_m­
 *
em
;

1274 
li¡_h—d
 *
£¬ch_li¡
 = &
fs_šfo
->
pšÃd_chunks
;

1275 
»t
 = 0;

1276 
u64
 
physiÿl_¡¬t
 = *
¡¬t
;

1278 ià(
Œª§ùiÚ
)

1279 
£¬ch_li¡
 = &
Œª§ùiÚ
->
³ndšg_chunks
;

1280 
agaš
:

1281 
	`li¡_fÜ_—ch_’Œy
(
em
, 
£¬ch_li¡
, 
li¡
) {

1282 
m­_lookup
 *
m­
;

1283 
i
;

1285 
m­
 = 
em
->
m­_lookup
;

1286 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

1287 
u64
 
’d
;

1289 ià(
m­
->
¡res
[
i
].
dev
 !ð
deviû
)

1291 ià(
m­
->
¡res
[
i
].
physiÿl
 >ð
physiÿl_¡¬t
 + 
Ën
 ||

1292 
m­
->
¡res
[
i
].
physiÿl
 + 
em
->
Üig_block_Ën
 <=

1293 
physiÿl_¡¬t
)

1307 
’d
 = 
m­
->
¡res
[
i
].
physiÿl
 + 
em
->
Üig_block_Ën
;

1308 ià(
’d
 > *
¡¬t
) {

1309 *
¡¬t
 = 
’d
;

1310 
»t
 = 1;

1314 ià(
£¬ch_li¡
 !ð&
fs_šfo
->
pšÃd_chunks
) {

1315 
£¬ch_li¡
 = &
fs_šfo
->
pšÃd_chunks
;

1316 
agaš
;

1319  
»t
;

1320 
	}
}

1344 
	$fšd_ä“_dev_ex‹Á_¡¬t
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
,

1345 
bŒfs_deviû
 *
deviû
, 
u64
 
num_by‹s
,

1346 
u64
 
£¬ch_¡¬t
, u64 *
¡¬t
, u64 *
Ën
)

1348 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

1349 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

1350 
bŒfs_key
 
key
;

1351 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
;

1352 
bŒfs_·th
 *
·th
;

1353 
u64
 
hÞe_size
;

1354 
u64
 
max_hÞe_¡¬t
;

1355 
u64
 
max_hÞe_size
;

1356 
u64
 
ex‹Á_’d
;

1357 
u64
 
£¬ch_’d
 = 
deviû
->
tÙ®_by‹s
;

1358 
»t
;

1359 
¦Ù
;

1360 
ex‹Á_bufãr
 *
l
;

1367 
£¬ch_¡¬t
 = 
	`max_t
(
u64
, s—rch_¡¬t, 
SZ_1M
);

1369 
·th
 = 
	`bŒfs_®loc_·th
();

1370 ià(!
·th
)

1371  -
ENOMEM
;

1373 
max_hÞe_¡¬t
 = 
£¬ch_¡¬t
;

1374 
max_hÞe_size
 = 0;

1376 
agaš
:

1377 ià(
£¬ch_¡¬t
 >ð
£¬ch_’d
 || 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
) {

1378 
»t
 = -
ENOSPC
;

1379 
out
;

1382 
·th
->
»ada
 = 
READA_FORWARD
;

1383 
·th
->
£¬ch_comm™_roÙ
 = 1;

1384 
·th
->
sk_lockšg
 = 1;

1386 
key
.
objeùid
 = 
deviû
->
devid
;

1387 
key
.
off£t
 = 
£¬ch_¡¬t
;

1388 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

1390 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

1391 ià(
»t
 < 0)

1392 
out
;

1393 ià(
»t
 > 0) {

1394 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
key
.
objeùid
, key.
ty³
);

1395 ià(
»t
 < 0)

1396 
out
;

1400 
l
 = 
·th
->
nodes
[0];

1401 
¦Ù
 = 
·th
->
¦Ùs
[0];

1402 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
l
)) {

1403 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

1404 ià(
»t
 == 0)

1406 ià(
»t
 < 0)

1407 
out
;

1411 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
¦Ù
);

1413 ià(
key
.
objeùid
 < 
deviû
->
devid
)

1414 
Ãxt
;

1416 ià(
key
.
objeùid
 > 
deviû
->
devid
)

1419 ià(
key
.
ty³
 !ð
BTRFS_DEV_EXTENT_KEY
)

1420 
Ãxt
;

1422 ià(
key
.
off£t
 > 
£¬ch_¡¬t
) {

1423 
hÞe_size
 = 
key
.
off£t
 - 
£¬ch_¡¬t
;

1429 ià(
	`cÚšs_³ndšg_ex‹Á
(
Œª§ùiÚ
, 
deviû
,

1430 &
£¬ch_¡¬t
,

1431 
hÞe_size
)) {

1432 ià(
key
.
off£t
 >ð
£¬ch_¡¬t
) {

1433 
hÞe_size
 = 
key
.
off£t
 - 
£¬ch_¡¬t
;

1435 
	`WARN_ON_ONCE
(1);

1436 
hÞe_size
 = 0;

1440 ià(
hÞe_size
 > 
max_hÞe_size
) {

1441 
max_hÞe_¡¬t
 = 
£¬ch_¡¬t
;

1442 
max_hÞe_size
 = 
hÞe_size
;

1454 ià(
hÞe_size
 >ð
num_by‹s
) {

1455 
»t
 = 0;

1456 
out
;

1460 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

1461 
ex‹Á_’d
 = 
key
.
off£t
 + 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
,

1462 
dev_ex‹Á
);

1463 ià(
ex‹Á_’d
 > 
£¬ch_¡¬t
)

1464 
£¬ch_¡¬t
 = 
ex‹Á_’d
;

1465 
Ãxt
:

1466 
·th
->
¦Ùs
[0]++;

1467 
	`cÚd_»sched
();

1475 ià(
£¬ch_’d
 > 
£¬ch_¡¬t
) {

1476 
hÞe_size
 = 
£¬ch_’d
 - 
£¬ch_¡¬t
;

1478 ià(
	`cÚšs_³ndšg_ex‹Á
(
Œª§ùiÚ
, 
deviû
, &
£¬ch_¡¬t
,

1479 
hÞe_size
)) {

1480 
	`bŒfs_»Ëa£_·th
(
·th
);

1481 
agaš
;

1484 ià(
hÞe_size
 > 
max_hÞe_size
) {

1485 
max_hÞe_¡¬t
 = 
£¬ch_¡¬t
;

1486 
max_hÞe_size
 = 
hÞe_size
;

1491 ià(
max_hÞe_size
 < 
num_by‹s
)

1492 
»t
 = -
ENOSPC
;

1494 
»t
 = 0;

1496 
out
:

1497 
	`bŒfs_ä“_·th
(
·th
);

1498 *
¡¬t
 = 
max_hÞe_¡¬t
;

1499 ià(
Ën
)

1500 *
Ën
 = 
max_hÞe_size
;

1501  
»t
;

1502 
	}
}

1504 
	$fšd_ä“_dev_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1505 
bŒfs_deviû
 *
deviû
, 
u64
 
num_by‹s
,

1506 
u64
 *
¡¬t
, u64 *
Ën
)

1509  
	`fšd_ä“_dev_ex‹Á_¡¬t
(
Œªs
->
Œª§ùiÚ
, 
deviû
,

1510 
num_by‹s
, 0, 
¡¬t
, 
Ën
);

1511 
	}
}

1513 
	$bŒfs_ä“_dev_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1514 
bŒfs_deviû
 *
deviû
,

1515 
u64
 
¡¬t
, u64 *
dev_ex‹Á_Ën
)

1517 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

1518 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

1519 
»t
;

1520 
bŒfs_·th
 *
·th
;

1521 
bŒfs_key
 
key
;

1522 
bŒfs_key
 
found_key
;

1523 
ex‹Á_bufãr
 *
Ëaf
 = 
NULL
;

1524 
bŒfs_dev_ex‹Á
 *
ex‹Á
 = 
NULL
;

1526 
·th
 = 
	`bŒfs_®loc_·th
();

1527 ià(!
·th
)

1528  -
ENOMEM
;

1530 
key
.
objeùid
 = 
deviû
->
devid
;

1531 
key
.
off£t
 = 
¡¬t
;

1532 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

1533 
agaš
:

1534 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1535 ià(
»t
 > 0) {

1536 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 
key
.
objeùid
,

1537 
BTRFS_DEV_EXTENT_KEY
);

1538 ià(
»t
)

1539 
out
;

1540 
Ëaf
 = 
·th
->
nodes
[0];

1541 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

1542 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1543 
bŒfs_dev_ex‹Á
);

1544 
	`BUG_ON
(
found_key
.
off£t
 > 
¡¬t
 || found_key.offset +

1545 
	`bŒfs_dev_ex‹Á_Ëngth
(
Ëaf
, 
ex‹Á
è< 
¡¬t
);

1546 
key
 = 
found_key
;

1547 
	`bŒfs_»Ëa£_·th
(
·th
);

1548 
agaš
;

1549 } ià(
»t
 == 0) {

1550 
Ëaf
 = 
·th
->
nodes
[0];

1551 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1552 
bŒfs_dev_ex‹Á
);

1554 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, "Slot search failed");

1555 
out
;

1558 *
dev_ex‹Á_Ën
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
Ëaf
, 
ex‹Á
);

1560 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1561 ià(
»t
) {

1562 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

1565 
	`£t_b™
(
BTRFS_TRANS_HAVE_FREE_BGS
, &
Œªs
->
Œª§ùiÚ
->
æags
);

1567 
out
:

1568 
	`bŒfs_ä“_·th
(
·th
);

1569  
»t
;

1570 
	}
}

1572 
	$bŒfs_®loc_dev_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1573 
bŒfs_deviû
 *
deviû
,

1574 
u64
 
chunk_off£t
, u64 
¡¬t
, u64 
num_by‹s
)

1576 
»t
;

1577 
bŒfs_·th
 *
·th
;

1578 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

1579 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

1580 
bŒfs_dev_ex‹Á
 *
ex‹Á
;

1581 
ex‹Á_bufãr
 *
Ëaf
;

1582 
bŒfs_key
 
key
;

1584 
	`WARN_ON
(!
deviû
->
š_fs_m‘ad©a
);

1585 
	`WARN_ON
(
deviû
->
is_tgtdev_fÜ_dev_»¶aû
);

1586 
·th
 = 
	`bŒfs_®loc_·th
();

1587 ià(!
·th
)

1588  -
ENOMEM
;

1590 
key
.
objeùid
 = 
deviû
->
devid
;

1591 
key
.
off£t
 = 
¡¬t
;

1592 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

1593 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

1594 (*
ex‹Á
));

1595 ià(
»t
)

1596 
out
;

1598 
Ëaf
 = 
·th
->
nodes
[0];

1599 
ex‹Á
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

1600 
bŒfs_dev_ex‹Á
);

1601 
	`bŒfs_£t_dev_ex‹Á_chunk_Œ“
(
Ëaf
, 
ex‹Á
,

1602 
BTRFS_CHUNK_TREE_OBJECTID
);

1603 
	`bŒfs_£t_dev_ex‹Á_chunk_objeùid
(
Ëaf
, 
ex‹Á
,

1604 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
);

1605 
	`bŒfs_£t_dev_ex‹Á_chunk_off£t
(
Ëaf
, 
ex‹Á
, 
chunk_off£t
);

1607 
	`bŒfs_£t_dev_ex‹Á_Ëngth
(
Ëaf
, 
ex‹Á
, 
num_by‹s
);

1608 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1609 
out
:

1610 
	`bŒfs_ä“_·th
(
·th
);

1611  
»t
;

1612 
	}
}

1614 
u64
 
	$fšd_Ãxt_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
)

1616 
ex‹Á_m­_Œ“
 *
em_Œ“
;

1617 
ex‹Á_m­
 *
em
;

1618 
rb_node
 *
n
;

1619 
u64
 
»t
 = 0;

1621 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

1622 
	`»ad_lock
(&
em_Œ“
->
lock
);

1623 
n
 = 
	`rb_Ï¡
(&
em_Œ“
->
m­
);

1624 ià(
n
) {

1625 
em
 = 
	`rb_’Œy
(
n
, 
ex‹Á_m­
, 
rb_node
);

1626 
»t
 = 
em
->
¡¬t
 +ƒm->
Ën
;

1628 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

1630  
»t
;

1631 
	}
}

1633 
nošlše
 
	$fšd_Ãxt_devid
(
bŒfs_fs_šfo
 *
fs_šfo
,

1634 
u64
 *
devid_»t
)

1636 
»t
;

1637 
bŒfs_key
 
key
;

1638 
bŒfs_key
 
found_key
;

1639 
bŒfs_·th
 *
·th
;

1641 
·th
 = 
	`bŒfs_®loc_·th
();

1642 ià(!
·th
)

1643  -
ENOMEM
;

1645 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

1646 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

1647 
key
.
off£t
 = (
u64
)-1;

1649 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
chunk_roÙ
, &
key
, 
·th
, 0, 0);

1650 ià(
»t
 < 0)

1651 
”rÜ
;

1653 
	`BUG_ON
(
»t
 == 0);

1655 
»t
 = 
	`bŒfs_´evious_™em
(
fs_šfo
->
chunk_roÙ
, 
·th
,

1656 
BTRFS_DEV_ITEMS_OBJECTID
,

1657 
BTRFS_DEV_ITEM_KEY
);

1658 ià(
»t
) {

1659 *
devid_»t
 = 1;

1661 
	`bŒfs_™em_key_to_ýu
(
·th
->
nodes
[0], &
found_key
,

1662 
·th
->
¦Ùs
[0]);

1663 *
devid_»t
 = 
found_key
.
off£t
 + 1;

1665 
»t
 = 0;

1666 
”rÜ
:

1667 
	`bŒfs_ä“_·th
(
·th
);

1668  
»t
;

1669 
	}
}

1675 
	$bŒfs_add_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

1676 
bŒfs_fs_šfo
 *
fs_šfo
,

1677 
bŒfs_deviû
 *
deviû
)

1679 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

1680 
»t
;

1681 
bŒfs_·th
 *
·th
;

1682 
bŒfs_dev_™em
 *
dev_™em
;

1683 
ex‹Á_bufãr
 *
Ëaf
;

1684 
bŒfs_key
 
key
;

1685 
±r
;

1687 
·th
 = 
	`bŒfs_®loc_·th
();

1688 ià(!
·th
)

1689  -
ENOMEM
;

1691 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

1692 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

1693 
key
.
off£t
 = 
deviû
->
devid
;

1695 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

1696 (*
dev_™em
));

1697 ià(
»t
)

1698 
out
;

1700 
Ëaf
 = 
·th
->
nodes
[0];

1701 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_™em
);

1703 
	`bŒfs_£t_deviû_id
(
Ëaf
, 
dev_™em
, 
deviû
->
devid
);

1704 
	`bŒfs_£t_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
, 0);

1705 
	`bŒfs_£t_deviû_ty³
(
Ëaf
, 
dev_™em
, 
deviû
->
ty³
);

1706 
	`bŒfs_£t_deviû_io_®ign
(
Ëaf
, 
dev_™em
, 
deviû
->
io_®ign
);

1707 
	`bŒfs_£t_deviû_io_width
(
Ëaf
, 
dev_™em
, 
deviû
->
io_width
);

1708 
	`bŒfs_£t_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
, 
deviû
->
£ùÜ_size
);

1709 
	`bŒfs_£t_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
,

1710 
	`bŒfs_deviû_g‘_disk_tÙ®_by‹s
(
deviû
));

1711 
	`bŒfs_£t_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
,

1712 
	`bŒfs_deviû_g‘_by‹s_u£d
(
deviû
));

1713 
	`bŒfs_£t_deviû_group
(
Ëaf
, 
dev_™em
, 0);

1714 
	`bŒfs_£t_deviû_£ek_¥“d
(
Ëaf
, 
dev_™em
, 0);

1715 
	`bŒfs_£t_deviû_bªdwidth
(
Ëaf
, 
dev_™em
, 0);

1716 
	`bŒfs_£t_deviû_¡¬t_off£t
(
Ëaf
, 
dev_™em
, 0);

1718 
±r
 = 
	`bŒfs_deviû_uuid
(
dev_™em
);

1719 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
deviû
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

1720 
±r
 = 
	`bŒfs_deviû_fsid
(
dev_™em
);

1721 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
fs_šfo
->
fsid
, 
±r
, 
BTRFS_FSID_SIZE
);

1722 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

1724 
»t
 = 0;

1725 
out
:

1726 
	`bŒfs_ä“_·th
(
·th
);

1727  
»t
;

1728 
	}
}

1734 
	$upd©e_dev_time
(cÚ¡ *
·th_Çme
)

1736 
fže
 *
fžp
;

1738 
fžp
 = 
	`fžp_Ý’
(
·th_Çme
, 
O_RDWR
, 0);

1739 ià(
	`IS_ERR
(
fžp
))

1741 
	`fže_upd©e_time
(
fžp
);

1742 
	`fžp_þo£
(
fžp
, 
NULL
);

1743 
	}
}

1745 
	$bŒfs_rm_dev_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

1746 
bŒfs_deviû
 *
deviû
)

1748 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

1749 
»t
;

1750 
bŒfs_·th
 *
·th
;

1751 
bŒfs_key
 
key
;

1752 
bŒfs_Œªs_hªdË
 *
Œªs
;

1754 
·th
 = 
	`bŒfs_®loc_·th
();

1755 ià(!
·th
)

1756  -
ENOMEM
;

1758 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

1759 ià(
	`IS_ERR
(
Œªs
)) {

1760 
	`bŒfs_ä“_·th
(
·th
);

1761  
	`PTR_ERR
(
Œªs
);

1763 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

1764 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

1765 
key
.
off£t
 = 
deviû
->
devid
;

1767 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

1768 ià(
»t
 < 0)

1769 
out
;

1771 ià(
»t
 > 0) {

1772 
»t
 = -
ENOENT
;

1773 
out
;

1776 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

1777 ià(
»t
)

1778 
out
;

1779 
out
:

1780 
	`bŒfs_ä“_·th
(
·th
);

1781 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

1782  
»t
;

1783 
	}
}

1790 
	$bŒfs_check_¿id_mš_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
,

1791 
u64
 
num_deviûs
)

1793 
u64
 
®l_avaž
;

1794 
£q
;

1795 
i
;

1798 
£q
 = 
	`»ad_£qbegš
(&
fs_šfo
->
´ofžes_lock
);

1800 
®l_avaž
 = 
fs_šfo
->
avaž_d©a_®loc_b™s
 |

1801 
fs_šfo
->
avaž_sy¡em_®loc_b™s
 |

1802 
fs_šfo
->
avaž_m‘ad©a_®loc_b™s
;

1803 } 
	`»ad_£q»Œy
(&
fs_šfo
->
´ofžes_lock
, 
£q
));

1805 
i
 = 0; i < 
BTRFS_NR_RAID_TYPES
; i++) {

1806 ià(!(
®l_avaž
 & 
bŒfs_¿id_group
[
i
]))

1809 ià(
num_deviûs
 < 
bŒfs_¿id_¬¿y
[
i
].
devs_mš
) {

1810 
»t
 = 
bŒfs_¿id_mšdev_”rÜ
[
i
];

1812 ià(
»t
)

1813  
»t
;

1818 
	}
}

1820 
bŒfs_deviû
 *
	$bŒfs_fšd_Ãxt_aùive_deviû
(
bŒfs_fs_deviûs
 *
fs_devs
,

1821 
bŒfs_deviû
 *
deviû
)

1823 
bŒfs_deviû
 *
Ãxt_deviû
;

1825 
	`li¡_fÜ_—ch_’Œy
(
Ãxt_deviû
, &
fs_devs
->
deviûs
, 
dev_li¡
) {

1826 ià(
Ãxt_deviû
 !ð
deviû
 &&

1827 !
Ãxt_deviû
->
missšg
 &&‚ext_deviû->
bdev
)

1828  
Ãxt_deviû
;

1831  
NULL
;

1832 
	}
}

1840 
	$bŒfs_assign_Ãxt_aùive_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

1841 
bŒfs_deviû
 *
deviû
, bŒfs_deviû *
this_dev
)

1843 
bŒfs_deviû
 *
Ãxt_deviû
;

1845 ià(
this_dev
)

1846 
Ãxt_deviû
 = 
this_dev
;

1848 
Ãxt_deviû
 = 
	`bŒfs_fšd_Ãxt_aùive_deviû
(
fs_šfo
->
fs_deviûs
,

1849 
deviû
);

1850 
	`ASSERT
(
Ãxt_deviû
);

1852 ià(
fs_šfo
->
sb
->
s_bdev
 &&

1853 (
fs_šfo
->
sb
->
s_bdev
 =ð
deviû
->
bdev
))

1854 
fs_šfo
->
sb
->
s_bdev
 = 
Ãxt_deviû
->
bdev
;

1856 ià(
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
 =ð
deviû
->
bdev
)

1857 
fs_šfo
->
fs_deviûs
->
Ï‹¡_bdev
 = 
Ãxt_deviû
->
bdev
;

1858 
	}
}

1860 
	$bŒfs_rm_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
deviû_·th
,

1861 
u64
 
devid
)

1863 
bŒfs_deviû
 *
deviû
;

1864 
bŒfs_fs_deviûs
 *
cur_deviûs
;

1865 
u64
 
num_deviûs
;

1866 
»t
 = 0;

1868 
	`mu‹x_lock
(&
uuid_mu‹x
);

1870 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->num_devices;

1871 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 0);

1872 ià(
	`bŒfs_dev_»¶aû_is_Úgošg
(&
fs_šfo
->
dev_»¶aû
)) {

1873 
	`WARN_ON
(
num_deviûs
 < 1);

1874 
num_deviûs
--;

1876 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

1878 
»t
 = 
	`bŒfs_check_¿id_mš_deviûs
(
fs_šfo
, 
num_deviûs
 - 1);

1879 ià(
»t
)

1880 
out
;

1882 
»t
 = 
	`bŒfs_fšd_deviû_by_dev¥ec
(
fs_šfo
, 
devid
, 
deviû_·th
,

1883 &
deviû
);

1884 ià(
»t
)

1885 
out
;

1887 ià(
deviû
->
is_tgtdev_fÜ_dev_»¶aû
) {

1888 
»t
 = 
BTRFS_ERROR_DEV_TGT_REPLACE
;

1889 
out
;

1892 ià(
deviû
->
wr™—bË
 && 
fs_šfo
->
fs_deviûs
->
rw_deviûs
 == 1) {

1893 
»t
 = 
BTRFS_ERROR_DEV_ONLY_WRITABLE
;

1894 
out
;

1897 ià(
deviû
->
wr™—bË
) {

1898 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

1899 
	`li¡_d–_š™
(&
deviû
->
dev_®loc_li¡
);

1900 
deviû
->
fs_deviûs
->
rw_deviûs
--;

1901 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

1904 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1905 
»t
 = 
	`bŒfs_shršk_deviû
(
deviû
, 0);

1906 
	`mu‹x_lock
(&
uuid_mu‹x
);

1907 ià(
»t
)

1908 
”rÜ_undo
;

1915 
»t
 = 
	`bŒfs_rm_dev_™em
(
fs_šfo
, 
deviû
);

1916 ià(
»t
)

1917 
”rÜ_undo
;

1919 
deviû
->
š_fs_m‘ad©a
 = 0;

1920 
	`bŒfs_süub_ÿnûl_dev
(
fs_šfo
, 
deviû
);

1932 
cur_deviûs
 = 
deviû
->
fs_deviûs
;

1933 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

1934 
	`li¡_d–_rcu
(&
deviû
->
dev_li¡
);

1936 
deviû
->
fs_deviûs
->
num_deviûs
--;

1937 
deviû
->
fs_deviûs
->
tÙ®_deviûs
--;

1939 ià(
deviû
->
missšg
)

1940 
deviû
->
fs_deviûs
->
missšg_deviûs
--;

1942 
	`bŒfs_assign_Ãxt_aùive_deviû
(
fs_šfo
, 
deviû
, 
NULL
);

1944 ià(
deviû
->
bdev
) {

1945 
deviû
->
fs_deviûs
->
Ý’_deviûs
--;

1947 
	`bŒfs_sysfs_rm_deviû_lšk
(
fs_šfo
->
fs_deviûs
, 
deviû
);

1950 
num_deviûs
 = 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cÝy
) - 1;

1951 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cÝy
, 
num_deviûs
);

1952 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

1959 ià(
deviû
->
wr™—bË
)

1960 
	`bŒfs_sü©ch_su³rblocks
(
deviû
->
bdev
, deviû->
Çme
->
¡r
);

1962 
	`bŒfs_þo£_bdev
(
deviû
);

1963 
	`ÿÎ_rcu
(&
deviû
->
rcu
, 
ä“_deviû
);

1965 ià(
cur_deviûs
->
Ý’_deviûs
 == 0) {

1966 
bŒfs_fs_deviûs
 *
fs_deviûs
;

1967 
fs_deviûs
 = 
fs_šfo
->fs_devices;

1968 
fs_deviûs
) {

1969 ià(
fs_deviûs
->
£ed
 =ð
cur_deviûs
) {

1970 
fs_deviûs
->
£ed
 = 
cur_deviûs
->seed;

1973 
fs_deviûs
 = fs_deviûs->
£ed
;

1975 
cur_deviûs
->
£ed
 = 
NULL
;

1976 
	`__bŒfs_þo£_deviûs
(
cur_deviûs
);

1977 
	`ä“_fs_deviûs
(
cur_deviûs
);

1980 
out
:

1981 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

1982  
»t
;

1984 
”rÜ_undo
:

1985 ià(
deviû
->
wr™—bË
) {

1986 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

1987 
	`li¡_add
(&
deviû
->
dev_®loc_li¡
,

1988 &
fs_šfo
->
fs_deviûs
->
®loc_li¡
);

1989 
deviû
->
fs_deviûs
->
rw_deviûs
++;

1990 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

1992 
out
;

1993 
	}
}

1995 
	$bŒfs_rm_dev_»¶aû_»move_¤cdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

1996 
bŒfs_deviû
 *
¤cdev
)

1998 
bŒfs_fs_deviûs
 *
fs_deviûs
;

2000 
	`WARN_ON
(!
	`mu‹x_is_locked
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
));

2008 
fs_deviûs
 = 
¤cdev
->fs_devices;

2010 
	`li¡_d–_rcu
(&
¤cdev
->
dev_li¡
);

2011 
	`li¡_d–_rcu
(&
¤cdev
->
dev_®loc_li¡
);

2012 
fs_deviûs
->
num_deviûs
--;

2013 ià(
¤cdev
->
missšg
)

2014 
fs_deviûs
->
missšg_deviûs
--;

2016 ià(
¤cdev
->
wr™—bË
)

2017 
fs_deviûs
->
rw_deviûs
--;

2019 ià(
¤cdev
->
bdev
)

2020 
fs_deviûs
->
Ý’_deviûs
--;

2021 
	}
}

2023 
	$bŒfs_rm_dev_»¶aû_ä“_¤cdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

2024 
bŒfs_deviû
 *
¤cdev
)

2026 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
¤cdev
->fs_devices;

2028 ià(
¤cdev
->
wr™—bË
) {

2030 
	`bŒfs_sü©ch_su³rblocks
(
¤cdev
->
bdev
, srcdev->
Çme
->
¡r
);

2033 
	`bŒfs_þo£_bdev
(
¤cdev
);

2035 
	`ÿÎ_rcu
(&
¤cdev
->
rcu
, 
ä“_deviû
);

2041 
	`BUG_ON
(!
fs_deviûs
->
num_deviûs
 && !fs_deviûs->
£edšg
);

2044 ià(!
fs_deviûs
->
num_deviûs
) {

2045 
bŒfs_fs_deviûs
 *
tmp_fs_deviûs
;

2047 
tmp_fs_deviûs
 = 
fs_šfo
->
fs_deviûs
;

2048 
tmp_fs_deviûs
) {

2049 ià(
tmp_fs_deviûs
->
£ed
 =ð
fs_deviûs
) {

2050 
tmp_fs_deviûs
->
£ed
 = 
fs_deviûs
->seed;

2053 
tmp_fs_deviûs
 =mp_fs_deviûs->
£ed
;

2055 
fs_deviûs
->
£ed
 = 
NULL
;

2056 
	`__bŒfs_þo£_deviûs
(
fs_deviûs
);

2057 
	`ä“_fs_deviûs
(
fs_deviûs
);

2059 
	}
}

2061 
	$bŒfs_de¡roy_dev_»¶aû_tgtdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

2062 
bŒfs_deviû
 *
tgtdev
)

2064 
	`mu‹x_lock
(&
uuid_mu‹x
);

2065 
	`WARN_ON
(!
tgtdev
);

2066 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2068 
	`bŒfs_sysfs_rm_deviû_lšk
(
fs_šfo
->
fs_deviûs
, 
tgtdev
);

2070 ià(
tgtdev
->
bdev
)

2071 
fs_šfo
->
fs_deviûs
->
Ý’_deviûs
--;

2073 
fs_šfo
->
fs_deviûs
->
num_deviûs
--;

2075 
	`bŒfs_assign_Ãxt_aùive_deviû
(
fs_šfo
, 
tgtdev
, 
NULL
);

2077 
	`li¡_d–_rcu
(&
tgtdev
->
dev_li¡
);

2079 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2080 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2089 
	`bŒfs_sü©ch_su³rblocks
(
tgtdev
->
bdev
,gtdev->
Çme
->
¡r
);

2091 
	`bŒfs_þo£_bdev
(
tgtdev
);

2092 
	`ÿÎ_rcu
(&
tgtdev
->
rcu
, 
ä“_deviû
);

2093 
	}
}

2095 
	$bŒfs_fšd_deviû_by_·th
(
bŒfs_fs_šfo
 *
fs_šfo
,

2096 cÚ¡ *
deviû_·th
,

2097 
bŒfs_deviû
 **
deviû
)

2099 
»t
 = 0;

2100 
bŒfs_su³r_block
 *
disk_su³r
;

2101 
u64
 
devid
;

2102 
u8
 *
dev_uuid
;

2103 
block_deviû
 *
bdev
;

2104 
bufãr_h—d
 *
bh
;

2106 *
deviû
 = 
NULL
;

2107 
»t
 = 
	`bŒfs_g‘_bdev_ªd_sb
(
deviû_·th
, 
FMODE_READ
,

2108 
fs_šfo
->
bdev_hÞd”
, 0, &
bdev
, &
bh
);

2109 ià(
»t
)

2110  
»t
;

2111 
disk_su³r
 = (
bŒfs_su³r_block
 *)
bh
->
b_d©a
;

2112 
devid
 = 
	`bŒfs_¡ack_deviû_id
(&
disk_su³r
->
dev_™em
);

2113 
dev_uuid
 = 
disk_su³r
->
dev_™em
.
uuid
;

2114 *
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
, 
disk_su³r
->
fsid
);

2115 
	`b»l£
(
bh
);

2116 ià(!*
deviû
)

2117 
»t
 = -
ENOENT
;

2118 
	`blkdev_put
(
bdev
, 
FMODE_READ
);

2119  
»t
;

2120 
	}
}

2122 
	$bŒfs_fšd_deviû_missšg_Ü_by_·th
(
bŒfs_fs_šfo
 *
fs_šfo
,

2123 cÚ¡ *
deviû_·th
,

2124 
bŒfs_deviû
 **
deviû
)

2126 *
deviû
 = 
NULL
;

2127 ià(
	`¡rcmp
(
deviû_·th
, "missing") == 0) {

2128 
li¡_h—d
 *
deviûs
;

2129 
bŒfs_deviû
 *
tmp
;

2131 
deviûs
 = &
fs_šfo
->
fs_deviûs
->devices;

2136 
	`li¡_fÜ_—ch_’Œy
(
tmp
, 
deviûs
, 
dev_li¡
) {

2137 ià(
tmp
->
š_fs_m‘ad©a
 && !tmp->
bdev
) {

2138 *
deviû
 = 
tmp
;

2143 ià(!*
deviû
)

2144  
BTRFS_ERROR_DEV_MISSING_NOT_FOUND
;

2148  
	`bŒfs_fšd_deviû_by_·th
(
fs_šfo
, 
deviû_·th
, 
deviû
);

2150 
	}
}

2155 
	$bŒfs_fšd_deviû_by_dev¥ec
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

2156 cÚ¡ *
dev·th
,

2157 
bŒfs_deviû
 **
deviû
)

2159 
»t
;

2161 ià(
devid
) {

2162 
»t
 = 0;

2163 *
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
NULL
, NULL);

2164 ià(!*
deviû
)

2165 
»t
 = -
ENOENT
;

2167 ià(!
dev·th
 || !devpath[0])

2168  -
EINVAL
;

2170 
»t
 = 
	`bŒfs_fšd_deviû_missšg_Ü_by_·th
(
fs_šfo
, 
dev·th
,

2171 
deviû
);

2173  
»t
;

2174 
	}
}

2179 
	$bŒfs_´•¬e_¥rout
(
bŒfs_fs_šfo
 *
fs_šfo
)

2181 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2182 
bŒfs_fs_deviûs
 *
Þd_deviûs
;

2183 
bŒfs_fs_deviûs
 *
£ed_deviûs
;

2184 
bŒfs_su³r_block
 *
disk_su³r
 = 
fs_šfo
->
su³r_cÝy
;

2185 
bŒfs_deviû
 *
deviû
;

2186 
u64
 
su³r_æags
;

2188 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
uuid_mu‹x
));

2189 ià(!
fs_deviûs
->
£edšg
)

2190  -
EINVAL
;

2192 
£ed_deviûs
 = 
	`®loc_fs_deviûs
(
NULL
);

2193 ià(
	`IS_ERR
(
£ed_deviûs
))

2194  
	`PTR_ERR
(
£ed_deviûs
);

2196 
Þd_deviûs
 = 
	`þÚe_fs_deviûs
(
fs_deviûs
);

2197 ià(
	`IS_ERR
(
Þd_deviûs
)) {

2198 
	`kä“
(
£ed_deviûs
);

2199  
	`PTR_ERR
(
Þd_deviûs
);

2202 
	`li¡_add
(&
Þd_deviûs
->
li¡
, &
fs_uuids
);

2204 
	`memýy
(
£ed_deviûs
, 
fs_deviûs
, (*seed_devices));

2205 
£ed_deviûs
->
Ý’ed
 = 1;

2206 
	`INIT_LIST_HEAD
(&
£ed_deviûs
->
deviûs
);

2207 
	`INIT_LIST_HEAD
(&
£ed_deviûs
->
®loc_li¡
);

2208 
	`mu‹x_š™
(&
£ed_deviûs
->
deviû_li¡_mu‹x
);

2210 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2211 
	`li¡_¥liû_š™_rcu
(&
fs_deviûs
->
deviûs
, &
£ed_deviûs
->devices,

2212 
synchrÚize_rcu
);

2213 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
£ed_deviûs
->
deviûs
, 
dev_li¡
)

2214 
deviû
->
fs_deviûs
 = 
£ed_deviûs
;

2216 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2217 
	`li¡_¥liû_š™
(&
fs_deviûs
->
®loc_li¡
, &
£ed_deviûs
->alloc_list);

2218 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2220 
fs_deviûs
->
£edšg
 = 0;

2221 
fs_deviûs
->
num_deviûs
 = 0;

2222 
fs_deviûs
->
Ý’_deviûs
 = 0;

2223 
fs_deviûs
->
missšg_deviûs
 = 0;

2224 
fs_deviûs
->
rÙ©šg
 = 0;

2225 
fs_deviûs
->
£ed
 = 
£ed_deviûs
;

2227 
	`g’”©e_¿ndom_uuid
(
fs_deviûs
->
fsid
);

2228 
	`memýy
(
fs_šfo
->
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
);

2229 
	`memýy
(
disk_su³r
->
fsid
, 
fs_deviûs
->fsid, 
BTRFS_FSID_SIZE
);

2230 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2232 
su³r_æags
 = 
	`bŒfs_su³r_æags
(
disk_su³r
) &

2233 ~
BTRFS_SUPER_FLAG_SEEDING
;

2234 
	`bŒfs_£t_su³r_æags
(
disk_su³r
, 
su³r_æags
);

2237 
	}
}

2242 
	$bŒfs_fšish_¥rout
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2243 
bŒfs_fs_šfo
 *
fs_šfo
)

2245 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

2246 
bŒfs_·th
 *
·th
;

2247 
ex‹Á_bufãr
 *
Ëaf
;

2248 
bŒfs_dev_™em
 *
dev_™em
;

2249 
bŒfs_deviû
 *
deviû
;

2250 
bŒfs_key
 
key
;

2251 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

2252 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

2253 
u64
 
devid
;

2254 
»t
;

2256 
·th
 = 
	`bŒfs_®loc_·th
();

2257 ià(!
·th
)

2258  -
ENOMEM
;

2260 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2261 
key
.
off£t
 = 0;

2262 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

2265 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

2266 ià(
»t
 < 0)

2267 
”rÜ
;

2269 
Ëaf
 = 
·th
->
nodes
[0];

2270 
Ãxt_¦Ù
:

2271 ià(
·th
->
¦Ùs
[0] >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

2272 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

2273 ià(
»t
 > 0)

2275 ià(
»t
 < 0)

2276 
”rÜ
;

2277 
Ëaf
 = 
·th
->
nodes
[0];

2278 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2279 
	`bŒfs_»Ëa£_·th
(
·th
);

2283 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
key
, 
·th
->
¦Ùs
[0]);

2284 ià(
key
.
objeùid
 !ð
BTRFS_DEV_ITEMS_OBJECTID
 ||

2285 
key
.
ty³
 !ð
BTRFS_DEV_ITEM_KEY
)

2288 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

2289 
bŒfs_dev_™em
);

2290 
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

2291 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
dev_uuid
, 
	`bŒfs_deviû_uuid
(
dev_™em
),

2292 
BTRFS_UUID_SIZE
);

2293 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
fs_uuid
, 
	`bŒfs_deviû_fsid
(
dev_™em
),

2294 
BTRFS_FSID_SIZE
);

2295 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
, 
fs_uuid
);

2296 
	`BUG_ON
(!
deviû
);

2298 ià(
deviû
->
fs_deviûs
->
£edšg
) {

2299 
	`bŒfs_£t_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
,

2300 
deviû
->
g’”©iÚ
);

2301 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2304 
·th
->
¦Ùs
[0]++;

2305 
Ãxt_¦Ù
;

2307 
»t
 = 0;

2308 
”rÜ
:

2309 
	`bŒfs_ä“_·th
(
·th
);

2310  
»t
;

2311 
	}
}

2313 
	$bŒfs_š™_Ãw_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
deviû_·th
)

2315 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

2316 
»que¡_queue
 *
q
;

2317 
bŒfs_Œªs_hªdË
 *
Œªs
;

2318 
bŒfs_deviû
 *
deviû
;

2319 
block_deviû
 *
bdev
;

2320 
li¡_h—d
 *
deviûs
;

2321 
su³r_block
 *
sb
 = 
fs_šfo
->sb;

2322 
rcu_¡ršg
 *
Çme
;

2323 
u64
 
tmp
;

2324 
£edšg_dev
 = 0;

2325 
»t
 = 0;

2327 ià(
	`sb_rdÚly
(
sb
è&& !
fs_šfo
->
fs_deviûs
->
£edšg
)

2328  -
EROFS
;

2330 
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
FMODE_WRITE
 | 
FMODE_EXCL
,

2331 
fs_šfo
->
bdev_hÞd”
);

2332 ià(
	`IS_ERR
(
bdev
))

2333  
	`PTR_ERR
(
bdev
);

2335 ià(
fs_šfo
->
fs_deviûs
->
£edšg
) {

2336 
£edšg_dev
 = 1;

2337 
	`down_wr™e
(&
sb
->
s_umouÁ
);

2338 
	`mu‹x_lock
(&
uuid_mu‹x
);

2341 
	`fžem­_wr™e_ªd_wa™
(
bdev
->
bd_šode
->
i_m­pšg
);

2343 
deviûs
 = &
fs_šfo
->
fs_deviûs
->devices;

2345 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2346 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
deviûs
, 
dev_li¡
) {

2347 ià(
deviû
->
bdev
 == bdev) {

2348 
»t
 = -
EEXIST
;

2349 
	`mu‹x_uÆock
(

2350 &
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2351 
”rÜ
;

2354 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2356 
deviû
 = 
	`bŒfs_®loc_deviû
(
fs_šfo
, 
NULL
, NULL);

2357 ià(
	`IS_ERR
(
deviû
)) {

2359 
»t
 = 
	`PTR_ERR
(
deviû
);

2360 
”rÜ
;

2363 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
deviû_·th
, 
GFP_KERNEL
);

2364 ià(!
Çme
) {

2365 
	`kä“
(
deviû
);

2366 
»t
 = -
ENOMEM
;

2367 
”rÜ
;

2369 
	`rcu_assign_poš‹r
(
deviû
->
Çme
,‚ame);

2371 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

2372 ià(
	`IS_ERR
(
Œªs
)) {

2373 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

2374 
	`kä“
(
deviû
);

2375 
»t
 = 
	`PTR_ERR
(
Œªs
);

2376 
”rÜ
;

2379 
q
 = 
	`bdev_g‘_queue
(
bdev
);

2380 ià(
	`blk_queue_disÿrd
(
q
))

2381 
deviû
->
ÿn_disÿrd
 = 1;

2382 
deviû
->
wr™—bË
 = 1;

2383 
deviû
->
g’”©iÚ
 = 
Œªs
->
Œªsid
;

2384 
deviû
->
io_width
 = 
fs_šfo
->
£ùÜsize
;

2385 
deviû
->
io_®ign
 = 
fs_šfo
->
£ùÜsize
;

2386 
deviû
->
£ùÜ_size
 = 
fs_šfo
->
£ùÜsize
;

2387 
deviû
->
tÙ®_by‹s
 = 
	`round_down
(
	`i_size_»ad
(
bdev
->
bd_šode
),

2388 
fs_šfo
->
£ùÜsize
);

2389 
deviû
->
disk_tÙ®_by‹s
 = deviû->
tÙ®_by‹s
;

2390 
deviû
->
comm™_tÙ®_by‹s
 = deviû->
tÙ®_by‹s
;

2391 
deviû
->
fs_šfo
 = fs_info;

2392 
deviû
->
bdev
 = bdev;

2393 
deviû
->
š_fs_m‘ad©a
 = 1;

2394 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
 = 0;

2395 
deviû
->
mode
 = 
FMODE_EXCL
;

2396 
deviû
->
dev_¡©s_v®id
 = 1;

2397 
	`£t_blocksize
(
deviû
->
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

2399 ià(
£edšg_dev
) {

2400 
sb
->
s_æags
 &ð~
MS_RDONLY
;

2401 
»t
 = 
	`bŒfs_´•¬e_¥rout
(
fs_šfo
);

2402 
	`BUG_ON
(
»t
);

2405 
deviû
->
fs_deviûs
 = 
fs_šfo
->fs_devices;

2407 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2408 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2409 
	`li¡_add_rcu
(&
deviû
->
dev_li¡
, &
fs_šfo
->
fs_deviûs
->
deviûs
);

2410 
	`li¡_add
(&
deviû
->
dev_®loc_li¡
,

2411 &
fs_šfo
->
fs_deviûs
->
®loc_li¡
);

2412 
fs_šfo
->
fs_deviûs
->
num_deviûs
++;

2413 
fs_šfo
->
fs_deviûs
->
Ý’_deviûs
++;

2414 
fs_šfo
->
fs_deviûs
->
rw_deviûs
++;

2415 
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
++;

2416 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ð
deviû
->
tÙ®_by‹s
;

2418 
	`©omic64_add
(
deviû
->
tÙ®_by‹s
, &
fs_šfo
->
ä“_chunk_¥aû
);

2420 ià(!
	`blk_queue_nÚrÙ
(
q
))

2421 
fs_šfo
->
fs_deviûs
->
rÙ©šg
 = 1;

2423 
tmp
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
);

2424 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
,

2425 
	`round_down
(
tmp
 + 
deviû
->
tÙ®_by‹s
, 
fs_šfo
->
£ùÜsize
));

2427 
tmp
 = 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cÝy
);

2428 
	`bŒfs_£t_su³r_num_deviûs
(
fs_šfo
->
su³r_cÝy
, 
tmp
 + 1);

2431 
	`bŒfs_sysfs_add_deviû_lšk
(
fs_šfo
->
fs_deviûs
, 
deviû
);

2437 
	`bŒfs_þ—r_¥aû_šfo_fuÎ
(
fs_šfo
);

2439 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2440 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2442 ià(
£edšg_dev
) {

2443 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2444 
»t
 = 
	`š™_fœ¡_rw_deviû
(
Œªs
, 
fs_šfo
);

2445 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2446 ià(
»t
) {

2447 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2448 
”rÜ_Œªs
;

2452 
»t
 = 
	`bŒfs_add_deviû
(
Œªs
, 
fs_šfo
, 
deviû
);

2453 ià(
»t
) {

2454 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2455 
”rÜ_Œªs
;

2458 ià(
£edšg_dev
) {

2459 
fsid_buf
[
BTRFS_UUID_UNPARSED_SIZE
];

2461 
»t
 = 
	`bŒfs_fšish_¥rout
(
Œªs
, 
fs_šfo
);

2462 ià(
»t
) {

2463 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2464 
”rÜ_Œªs
;

2470 
	`¢´štf
(
fsid_buf
, 
BTRFS_UUID_UNPARSED_SIZE
, "%pU",

2471 
fs_šfo
->
fsid
);

2472 ià(
	`kobjeù_»Çme
(&
fs_šfo
->
fs_deviûs
->
fsid_kobj
, 
fsid_buf
))

2473 
	`bŒfs_w¬n
(
fs_šfo
,

2477 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2479 ià(
£edšg_dev
) {

2480 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2481 
	`up_wr™e
(&
sb
->
s_umouÁ
);

2483 ià(
»t
)

2484  
»t
;

2486 
»t
 = 
	`bŒfs_»loÿ‹_sys_chunks
(
fs_šfo
);

2487 ià(
»t
 < 0)

2488 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2490 
Œªs
 = 
	`bŒfs_©ch_Œª§ùiÚ
(
roÙ
);

2491 ià(
	`IS_ERR
(
Œªs
)) {

2492 ià(
	`PTR_ERR
(
Œªs
è=ð-
ENOENT
)

2494  
	`PTR_ERR
(
Œªs
);

2496 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

2500 
	`upd©e_dev_time
(
deviû_·th
);

2501  
»t
;

2503 
”rÜ_Œªs
:

2504 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2505 
	`rcu_¡ršg_ä“
(
deviû
->
Çme
);

2506 
	`bŒfs_sysfs_rm_deviû_lšk
(
fs_šfo
->
fs_deviûs
, 
deviû
);

2507 
	`kä“
(
deviû
);

2508 
”rÜ
:

2509 
	`blkdev_put
(
bdev
, 
FMODE_EXCL
);

2510 ià(
£edšg_dev
) {

2511 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

2512 
	`up_wr™e
(&
sb
->
s_umouÁ
);

2514  
»t
;

2515 
	}
}

2517 
	$bŒfs_š™_dev_»¶aû_tgtdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

2518 cÚ¡ *
deviû_·th
,

2519 
bŒfs_deviû
 *
¤cdev
,

2520 
bŒfs_deviû
 **
deviû_out
)

2522 
»que¡_queue
 *
q
;

2523 
bŒfs_deviû
 *
deviû
;

2524 
block_deviû
 *
bdev
;

2525 
li¡_h—d
 *
deviûs
;

2526 
rcu_¡ršg
 *
Çme
;

2527 
u64
 
devid
 = 
BTRFS_DEV_REPLACE_DEVID
;

2528 
»t
 = 0;

2530 *
deviû_out
 = 
NULL
;

2531 ià(
fs_šfo
->
fs_deviûs
->
£edšg
) {

2532 
	`bŒfs_”r
(
fs_šfo
, "the filesystem is‡ seed filesystem!");

2533  -
EINVAL
;

2536 
bdev
 = 
	`blkdev_g‘_by_·th
(
deviû_·th
, 
FMODE_WRITE
 | 
FMODE_EXCL
,

2537 
fs_šfo
->
bdev_hÞd”
);

2538 ià(
	`IS_ERR
(
bdev
)) {

2539 
	`bŒfs_”r
(
fs_šfo
, "rg‘ deviû % i šv®id!", 
deviû_·th
);

2540  
	`PTR_ERR
(
bdev
);

2543 
	`fžem­_wr™e_ªd_wa™
(
bdev
->
bd_šode
->
i_m­pšg
);

2545 
deviûs
 = &
fs_šfo
->
fs_deviûs
->devices;

2546 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
deviûs
, 
dev_li¡
) {

2547 ià(
deviû
->
bdev
 == bdev) {

2548 
	`bŒfs_”r
(
fs_šfo
,

2550 
»t
 = -
EEXIST
;

2551 
”rÜ
;

2556 ià(
	`i_size_»ad
(
bdev
->
bd_šode
) <

2557 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
¤cdev
)) {

2558 
	`bŒfs_”r
(
fs_šfo
,

2560 
»t
 = -
EINVAL
;

2561 
”rÜ
;

2565 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
devid
, NULL);

2566 ià(
	`IS_ERR
(
deviû
)) {

2567 
»t
 = 
	`PTR_ERR
(
deviû
);

2568 
”rÜ
;

2571 
Çme
 = 
	`rcu_¡ršg_¡rdup
(
deviû_·th
, 
GFP_KERNEL
);

2572 ià(!
Çme
) {

2573 
	`kä“
(
deviû
);

2574 
»t
 = -
ENOMEM
;

2575 
”rÜ
;

2577 
	`rcu_assign_poš‹r
(
deviû
->
Çme
,‚ame);

2579 
q
 = 
	`bdev_g‘_queue
(
bdev
);

2580 ià(
	`blk_queue_disÿrd
(
q
))

2581 
deviû
->
ÿn_disÿrd
 = 1;

2582 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2583 
deviû
->
wr™—bË
 = 1;

2584 
deviû
->
g’”©iÚ
 = 0;

2585 
deviû
->
io_width
 = 
fs_šfo
->
£ùÜsize
;

2586 
deviû
->
io_®ign
 = 
fs_šfo
->
£ùÜsize
;

2587 
deviû
->
£ùÜ_size
 = 
fs_šfo
->
£ùÜsize
;

2588 
deviû
->
tÙ®_by‹s
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
¤cdev
);

2589 
deviû
->
disk_tÙ®_by‹s
 = 
	`bŒfs_deviû_g‘_disk_tÙ®_by‹s
(
¤cdev
);

2590 
deviû
->
by‹s_u£d
 = 
	`bŒfs_deviû_g‘_by‹s_u£d
(
¤cdev
);

2591 
	`ASSERT
(
	`li¡_em±y
(&
¤cdev
->
»sized_li¡
));

2592 
deviû
->
comm™_tÙ®_by‹s
 = 
¤cdev
->commit_total_bytes;

2593 
deviû
->
comm™_by‹s_u£d
 = deviû->
by‹s_u£d
;

2594 
deviû
->
fs_šfo
 = fs_info;

2595 
deviû
->
bdev
 = bdev;

2596 
deviû
->
š_fs_m‘ad©a
 = 1;

2597 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
 = 1;

2598 
deviû
->
mode
 = 
FMODE_EXCL
;

2599 
deviû
->
dev_¡©s_v®id
 = 1;

2600 
	`£t_blocksize
(
deviû
->
bdev
, 
BTRFS_BDEV_BLOCKSIZE
);

2601 
deviû
->
fs_deviûs
 = 
fs_šfo
->fs_devices;

2602 
	`li¡_add
(&
deviû
->
dev_li¡
, &
fs_šfo
->
fs_deviûs
->
deviûs
);

2603 
fs_šfo
->
fs_deviûs
->
num_deviûs
++;

2604 
fs_šfo
->
fs_deviûs
->
Ý’_deviûs
++;

2605 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

2607 *
deviû_out
 = 
deviû
;

2608  
»t
;

2610 
”rÜ
:

2611 
	`blkdev_put
(
bdev
, 
FMODE_EXCL
);

2612  
»t
;

2613 
	}
}

2615 
	$bŒfs_š™_dev_»¶aû_tgtdev_fÜ_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
,

2616 
bŒfs_deviû
 *
tgtdev
)

2618 
u32
 
£ùÜsize
 = 
fs_šfo
->sectorsize;

2620 
	`WARN_ON
(
fs_šfo
->
fs_deviûs
->
rw_deviûs
 == 0);

2621 
tgtdev
->
io_width
 = 
£ùÜsize
;

2622 
tgtdev
->
io_®ign
 = 
£ùÜsize
;

2623 
tgtdev
->
£ùÜ_size
 = 
£ùÜsize
;

2624 
tgtdev
->
fs_šfo
 = fs_info;

2625 
tgtdev
->
š_fs_m‘ad©a
 = 1;

2626 
	}
}

2628 
nošlše
 
	$bŒfs_upd©e_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2629 
bŒfs_deviû
 *
deviû
)

2631 
»t
;

2632 
bŒfs_·th
 *
·th
;

2633 
bŒfs_roÙ
 *
roÙ
 = 
deviû
->
fs_šfo
->
chunk_roÙ
;

2634 
bŒfs_dev_™em
 *
dev_™em
;

2635 
ex‹Á_bufãr
 *
Ëaf
;

2636 
bŒfs_key
 
key
;

2638 
·th
 = 
	`bŒfs_®loc_·th
();

2639 ià(!
·th
)

2640  -
ENOMEM
;

2642 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

2643 
key
.
ty³
 = 
BTRFS_DEV_ITEM_KEY
;

2644 
key
.
off£t
 = 
deviû
->
devid
;

2646 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, 0, 1);

2647 ià(
»t
 < 0)

2648 
out
;

2650 ià(
»t
 > 0) {

2651 
»t
 = -
ENOENT
;

2652 
out
;

2655 
Ëaf
 = 
·th
->
nodes
[0];

2656 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_™em
);

2658 
	`bŒfs_£t_deviû_id
(
Ëaf
, 
dev_™em
, 
deviû
->
devid
);

2659 
	`bŒfs_£t_deviû_ty³
(
Ëaf
, 
dev_™em
, 
deviû
->
ty³
);

2660 
	`bŒfs_£t_deviû_io_®ign
(
Ëaf
, 
dev_™em
, 
deviû
->
io_®ign
);

2661 
	`bŒfs_£t_deviû_io_width
(
Ëaf
, 
dev_™em
, 
deviû
->
io_width
);

2662 
	`bŒfs_£t_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
, 
deviû
->
£ùÜ_size
);

2663 
	`bŒfs_£t_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
,

2664 
	`bŒfs_deviû_g‘_disk_tÙ®_by‹s
(
deviû
));

2665 
	`bŒfs_£t_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
,

2666 
	`bŒfs_deviû_g‘_by‹s_u£d
(
deviû
));

2667 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

2669 
out
:

2670 
	`bŒfs_ä“_·th
(
·th
);

2671  
»t
;

2672 
	}
}

2674 
	$bŒfs_grow_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2675 
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
)

2677 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

2678 
bŒfs_su³r_block
 *
su³r_cÝy
 = 
fs_šfo
->super_copy;

2679 
bŒfs_fs_deviûs
 *
fs_deviûs
;

2680 
u64
 
Þd_tÙ®
;

2681 
u64
 
diff
;

2683 ià(!
deviû
->
wr™—bË
)

2684  -
EACCES
;

2686 
Ãw_size
 = 
	`round_down
Òew_size, 
fs_šfo
->
£ùÜsize
);

2688 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2689 
Þd_tÙ®
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
su³r_cÝy
);

2690 
diff
 = 
	`round_down
(
Ãw_size
 - 
deviû
->
tÙ®_by‹s
, 
fs_šfo
->
£ùÜsize
);

2692 ià(
Ãw_size
 <ð
deviû
->
tÙ®_by‹s
 ||

2693 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
) {

2694 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2695  -
EINVAL
;

2698 
fs_deviûs
 = 
fs_šfo
->fs_devices;

2700 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
su³r_cÝy
,

2701 
	`round_down
(
Þd_tÙ®
 + 
diff
, 
fs_šfo
->
£ùÜsize
));

2702 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ð
diff
;

2704 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

2705 
	`bŒfs_deviû_£t_disk_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

2706 
	`bŒfs_þ—r_¥aû_šfo_fuÎ
(
deviû
->
fs_šfo
);

2707 ià(
	`li¡_em±y
(&
deviû
->
»sized_li¡
))

2708 
	`li¡_add_ž
(&
deviû
->
»sized_li¡
,

2709 &
fs_deviûs
->
»sized_deviûs
);

2710 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2712  
	`bŒfs_upd©e_deviû
(
Œªs
, 
deviû
);

2713 
	}
}

2715 
	$bŒfs_ä“_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2716 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

2718 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

2719 
»t
;

2720 
bŒfs_·th
 *
·th
;

2721 
bŒfs_key
 
key
;

2723 
·th
 = 
	`bŒfs_®loc_·th
();

2724 ià(!
·th
)

2725  -
ENOMEM
;

2727 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

2728 
key
.
off£t
 = 
chunk_off£t
;

2729 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

2731 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

2732 ià(
»t
 < 0)

2733 
out
;

2734 ià(
»t
 > 0) {

2735 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, -
ENOENT
,

2737 
»t
 = -
ENOENT
;

2738 
out
;

2741 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

2742 ià(
»t
 < 0)

2743 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
,

2745 
out
:

2746 
	`bŒfs_ä“_·th
(
·th
);

2747  
»t
;

2748 
	}
}

2750 
	$bŒfs_d–_sys_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

2752 
bŒfs_su³r_block
 *
su³r_cÝy
 = 
fs_šfo
->super_copy;

2753 
bŒfs_disk_key
 *
disk_key
;

2754 
bŒfs_chunk
 *
chunk
;

2755 
u8
 *
±r
;

2756 
»t
 = 0;

2757 
u32
 
num_¡res
;

2758 
u32
 
¬¿y_size
;

2759 
u32
 
Ën
 = 0;

2760 
u32
 
cur
;

2761 
bŒfs_key
 
key
;

2763 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2764 
¬¿y_size
 = 
	`bŒfs_su³r_sys_¬¿y_size
(
su³r_cÝy
);

2766 
±r
 = 
su³r_cÝy
->
sys_chunk_¬¿y
;

2767 
cur
 = 0;

2769 
cur
 < 
¬¿y_size
) {

2770 
disk_key
 = (
bŒfs_disk_key
 *)
±r
;

2771 
	`bŒfs_disk_key_to_ýu
(&
key
, 
disk_key
);

2773 
Ën
 = (*
disk_key
);

2775 ià(
key
.
ty³
 =ð
BTRFS_CHUNK_ITEM_KEY
) {

2776 
chunk
 = (
bŒfs_chunk
 *)(
±r
 + 
Ën
);

2777 
num_¡res
 = 
	`bŒfs_¡ack_chunk_num_¡res
(
chunk
);

2778 
Ën
 +ð
	`bŒfs_chunk_™em_size
(
num_¡res
);

2780 
»t
 = -
EIO
;

2783 ià(
key
.
objeùid
 =ð
BTRFS_FIRST_CHUNK_TREE_OBJECTID
 &&

2784 
key
.
off£t
 =ð
chunk_off£t
) {

2785 
	`memmove
(
±r
,…Œ + 
Ën
, 
¬¿y_size
 - (
cur
 +†en));

2786 
¬¿y_size
 -ð
Ën
;

2787 
	`bŒfs_£t_su³r_sys_¬¿y_size
(
su³r_cÝy
, 
¬¿y_size
);

2789 
±r
 +ð
Ën
;

2790 
cur
 +ð
Ën
;

2793 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2794  
»t
;

2795 
	}
}

2797 
ex‹Á_m­
 *
	$g‘_chunk_m­
(
bŒfs_fs_šfo
 *
fs_šfo
,

2798 
u64
 
logiÿl
, u64 
Ëngth
)

2800 
ex‹Á_m­_Œ“
 *
em_Œ“
;

2801 
ex‹Á_m­
 *
em
;

2803 
em_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
.
m­_Œ“
;

2804 
	`»ad_lock
(&
em_Œ“
->
lock
);

2805 
em
 = 
	`lookup_ex‹Á_m­pšg
(
em_Œ“
, 
logiÿl
, 
Ëngth
);

2806 
	`»ad_uÆock
(&
em_Œ“
->
lock
);

2808 ià(!
em
) {

2809 
	`bŒfs_ü™
(
fs_šfo
, "unableo find†ogical %llu†ength %llu",

2810 
logiÿl
, 
Ëngth
);

2811  
	`ERR_PTR
(-
EINVAL
);

2814 ià(
em
->
¡¬t
 > 
logiÿl
 ||ƒm->¡¬ˆ+ƒm->
Ën
 <†ogical) {

2815 
	`bŒfs_ü™
(
fs_šfo
,

2817 
logiÿl
, 
Ëngth
, 
em
->
¡¬t
,ƒm->¡¬ˆ+ƒm->
Ën
);

2818 
	`ä“_ex‹Á_m­
(
em
);

2819  
	`ERR_PTR
(-
EINVAL
);

2823  
em
;

2824 
	}
}

2826 
	$bŒfs_»move_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

2827 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

2829 
ex‹Á_m­
 *
em
;

2830 
m­_lookup
 *
m­
;

2831 
u64
 
dev_ex‹Á_Ën
 = 0;

2832 
i
, 
»t
 = 0;

2833 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

2835 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 1);

2836 ià(
	`IS_ERR
(
em
)) {

2842 
	`ASSERT
(0);

2843  
	`PTR_ERR
(
em
);

2845 
m­
 = 
em
->
m­_lookup
;

2846 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2847 
	`check_sy¡em_chunk
(
Œªs
, 
fs_šfo
, 
m­
->
ty³
);

2848 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2855 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2856 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

2857 
bŒfs_deviû
 *
deviû
 = 
m­
->
¡res
[
i
].
dev
;

2858 
»t
 = 
	`bŒfs_ä“_dev_ex‹Á
(
Œªs
, 
deviû
,

2859 
m­
->
¡res
[
i
].
physiÿl
,

2860 &
dev_ex‹Á_Ën
);

2861 ià(
»t
) {

2862 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2863 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2864 
out
;

2867 ià(
deviû
->
by‹s_u£d
 > 0) {

2868 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

2869 
	`bŒfs_deviû_£t_by‹s_u£d
(
deviû
,

2870 
deviû
->
by‹s_u£d
 - 
dev_ex‹Á_Ën
);

2871 
	`©omic64_add
(
dev_ex‹Á_Ën
, &
fs_šfo
->
ä“_chunk_¥aû
);

2872 
	`bŒfs_þ—r_¥aû_šfo_fuÎ
(
fs_šfo
);

2873 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

2876 ià(
m­
->
¡res
[
i
].
dev
) {

2877 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
m­
->
¡res
[
i
].
dev
);

2878 ià(
»t
) {

2879 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2880 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2881 
out
;

2885 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

2887 
»t
 = 
	`bŒfs_ä“_chunk
(
Œªs
, 
fs_šfo
, 
chunk_off£t
);

2888 ià(
»t
) {

2889 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2890 
out
;

2893 
	`Œaû_bŒfs_chunk_ä“
(
fs_šfo
, 
m­
, 
chunk_off£t
, 
em
->
Ën
);

2895 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

2896 
»t
 = 
	`bŒfs_d–_sys_chunk
(
fs_šfo
, 
chunk_off£t
);

2897 ià(
»t
) {

2898 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2899 
out
;

2903 
»t
 = 
	`bŒfs_»move_block_group
(
Œªs
, 
fs_šfo
, 
chunk_off£t
, 
em
);

2904 ià(
»t
) {

2905 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

2906 
out
;

2909 
out
:

2911 
	`ä“_ex‹Á_m­
(
em
);

2912  
»t
;

2913 
	}
}

2915 
	$bŒfs_»loÿ‹_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

2917 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

2918 
bŒfs_Œªs_hªdË
 *
Œªs
;

2919 
»t
;

2933 
	`ASSERT
(
	`mu‹x_is_locked
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
));

2935 
»t
 = 
	`bŒfs_ÿn_»loÿ‹
(
fs_šfo
, 
chunk_off£t
);

2936 ià(
»t
)

2937  -
ENOSPC
;

2940 
	`bŒfs_süub_·u£
(
fs_šfo
);

2941 
»t
 = 
	`bŒfs_»loÿ‹_block_group
(
fs_šfo
, 
chunk_off£t
);

2942 
	`bŒfs_süub_cÚtšue
(
fs_šfo
);

2943 ià(
»t
)

2944  
»t
;

2946 
Œªs
 = 
	`bŒfs_¡¬t_Œªs_»move_block_group
(
roÙ
->
fs_šfo
,

2947 
chunk_off£t
);

2948 ià(
	`IS_ERR
(
Œªs
)) {

2949 
»t
 = 
	`PTR_ERR
(
Œªs
);

2950 
	`bŒfs_hªdË_fs_”rÜ
(
roÙ
->
fs_šfo
, 
»t
, 
NULL
);

2951  
»t
;

2958 
»t
 = 
	`bŒfs_»move_chunk
(
Œªs
, 
fs_šfo
, 
chunk_off£t
);

2959 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

2960  
»t
;

2961 
	}
}

2963 
	$bŒfs_»loÿ‹_sys_chunks
(
bŒfs_fs_šfo
 *
fs_šfo
)

2965 
bŒfs_roÙ
 *
chunk_roÙ
 = 
fs_šfo
->chunk_root;

2966 
bŒfs_·th
 *
·th
;

2967 
ex‹Á_bufãr
 *
Ëaf
;

2968 
bŒfs_chunk
 *
chunk
;

2969 
bŒfs_key
 
key
;

2970 
bŒfs_key
 
found_key
;

2971 
u64
 
chunk_ty³
;

2972 
boÞ
 
»Œ›d
 = 
çl£
;

2973 
çžed
 = 0;

2974 
»t
;

2976 
·th
 = 
	`bŒfs_®loc_·th
();

2977 ià(!
·th
)

2978  -
ENOMEM
;

2980 
agaš
:

2981 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

2982 
key
.
off£t
 = (
u64
)-1;

2983 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

2986 
	`mu‹x_lock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

2987 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
chunk_roÙ
, &
key
, 
·th
, 0, 0);

2988 ià(
»t
 < 0) {

2989 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

2990 
”rÜ
;

2992 
	`BUG_ON
(
»t
 == 0);

2994 
»t
 = 
	`bŒfs_´evious_™em
(
chunk_roÙ
, 
·th
, 
key
.
objeùid
,

2995 
key
.
ty³
);

2996 ià(
»t
)

2997 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

2998 ià(
»t
 < 0)

2999 
”rÜ
;

3000 ià(
»t
 > 0)

3003 
Ëaf
 = 
·th
->
nodes
[0];

3004 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
·th
->
¦Ùs
[0]);

3006 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0],

3007 
bŒfs_chunk
);

3008 
chunk_ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

3009 
	`bŒfs_»Ëa£_·th
(
·th
);

3011 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

3012 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
found_key
.
off£t
);

3013 ià(
»t
 =ð-
ENOSPC
)

3014 
çžed
++;

3016 
	`BUG_ON
(
»t
);

3018 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3020 ià(
found_key
.
off£t
 == 0)

3022 
key
.
off£t
 = 
found_key
.offset - 1;

3024 
»t
 = 0;

3025 ià(
çžed
 && !
»Œ›d
) {

3026 
çžed
 = 0;

3027 
»Œ›d
 = 
Œue
;

3028 
agaš
;

3029 } ià(
	`WARN_ON
(
çžed
 && 
»Œ›d
)) {

3030 
»t
 = -
ENOSPC
;

3032 
”rÜ
:

3033 
	`bŒfs_ä“_·th
(
·th
);

3034  
»t
;

3035 
	}
}

3037 
	$š£¹_b®ªû_™em
(
bŒfs_fs_šfo
 *
fs_šfo
,

3038 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
)

3040 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3041 
bŒfs_Œªs_hªdË
 *
Œªs
;

3042 
bŒfs_b®ªû_™em
 *
™em
;

3043 
bŒfs_disk_b®ªû_¬gs
 
disk_b¬gs
;

3044 
bŒfs_·th
 *
·th
;

3045 
ex‹Á_bufãr
 *
Ëaf
;

3046 
bŒfs_key
 
key
;

3047 
»t
, 
”r
;

3049 
·th
 = 
	`bŒfs_®loc_·th
();

3050 ià(!
·th
)

3051  -
ENOMEM
;

3053 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

3054 ià(
	`IS_ERR
(
Œªs
)) {

3055 
	`bŒfs_ä“_·th
(
·th
);

3056  
	`PTR_ERR
(
Œªs
);

3059 
key
.
objeùid
 = 
BTRFS_BALANCE_OBJECTID
;

3060 
key
.
ty³
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3061 
key
.
off£t
 = 0;

3063 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
roÙ
, 
·th
, &
key
,

3064 (*
™em
));

3065 ià(
»t
)

3066 
out
;

3068 
Ëaf
 = 
·th
->
nodes
[0];

3069 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_b®ªû_™em
);

3071 
	`memz”o_ex‹Á_bufãr
(
Ëaf
, ()
™em
, (*item));

3073 
	`bŒfs_ýu_b®ªû_¬gs_to_disk
(&
disk_b¬gs
, &
bùl
->
d©a
);

3074 
	`bŒfs_£t_b®ªû_d©a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

3075 
	`bŒfs_ýu_b®ªû_¬gs_to_disk
(&
disk_b¬gs
, &
bùl
->
m‘a
);

3076 
	`bŒfs_£t_b®ªû_m‘a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

3077 
	`bŒfs_ýu_b®ªû_¬gs_to_disk
(&
disk_b¬gs
, &
bùl
->
sys
);

3078 
	`bŒfs_£t_b®ªû_sys
(
Ëaf
, 
™em
, &
disk_b¬gs
);

3080 
	`bŒfs_£t_b®ªû_æags
(
Ëaf
, 
™em
, 
bùl
->
æags
);

3082 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

3083 
out
:

3084 
	`bŒfs_ä“_·th
(
·th
);

3085 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3086 ià(
”r
 && !
»t
)

3087 
»t
 = 
”r
;

3088  
»t
;

3089 
	}
}

3091 
	$d–_b®ªû_™em
(
bŒfs_fs_šfo
 *
fs_šfo
)

3093 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

3094 
bŒfs_Œªs_hªdË
 *
Œªs
;

3095 
bŒfs_·th
 *
·th
;

3096 
bŒfs_key
 
key
;

3097 
»t
, 
”r
;

3099 
·th
 = 
	`bŒfs_®loc_·th
();

3100 ià(!
·th
)

3101  -
ENOMEM
;

3103 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

3104 ià(
	`IS_ERR
(
Œªs
)) {

3105 
	`bŒfs_ä“_·th
(
·th
);

3106  
	`PTR_ERR
(
Œªs
);

3109 
key
.
objeùid
 = 
BTRFS_BALANCE_OBJECTID
;

3110 
key
.
ty³
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3111 
key
.
off£t
 = 0;

3113 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
roÙ
, &
key
, 
·th
, -1, 1);

3114 ià(
»t
 < 0)

3115 
out
;

3116 ià(
»t
 > 0) {

3117 
»t
 = -
ENOENT
;

3118 
out
;

3121 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
roÙ
, 
·th
);

3122 
out
:

3123 
	`bŒfs_ä“_·th
(
·th
);

3124 
”r
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

3125 ià(
”r
 && !
»t
)

3126 
»t
 = 
”r
;

3127  
»t
;

3128 
	}
}

3134 
	$upd©e_b®ªû_¬gs
(
bŒfs_b®ªû_cÚŒÞ
 *
bùl
)

3139 ià(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3140 
bùl
->
d©a
.
æags
 |ð
BTRFS_BALANCE_ARGS_SOFT
;

3141 ià(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3142 
bùl
->
sys
.
æags
 |ð
BTRFS_BALANCE_ARGS_SOFT
;

3143 ià(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)

3144 
bùl
->
m‘a
.
æags
 |ð
BTRFS_BALANCE_ARGS_SOFT
;

3153 ià(!(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3154 !(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3155 !(
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3156 
bùl
->
d©a
.
æags
 |ð
BTRFS_BALANCE_ARGS_USAGE
;

3157 
bùl
->
d©a
.
u§ge
 = 90;

3159 ià(!(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3160 !(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3161 !(
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3162 
bùl
->
sys
.
æags
 |ð
BTRFS_BALANCE_ARGS_USAGE
;

3163 
bùl
->
sys
.
u§ge
 = 90;

3165 ià(!(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3166 !(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3167 !(
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
)) {

3168 
bùl
->
m‘a
.
æags
 |ð
BTRFS_BALANCE_ARGS_USAGE
;

3169 
bùl
->
m‘a
.
u§ge
 = 90;

3171 
	}
}

3178 
	$£t_b®ªû_cÚŒÞ
(
bŒfs_b®ªû_cÚŒÞ
 *
bùl
)

3180 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bùl
->fs_info;

3182 
	`BUG_ON
(
fs_šfo
->
b®ªû_ùl
);

3184 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3185 
fs_šfo
->
b®ªû_ùl
 = 
bùl
;

3186 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3187 
	}
}

3189 
	$un£t_b®ªû_cÚŒÞ
(
bŒfs_fs_šfo
 *
fs_šfo
)

3191 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

3193 
	`BUG_ON
(!
fs_šfo
->
b®ªû_ùl
);

3195 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3196 
fs_šfo
->
b®ªû_ùl
 = 
NULL
;

3197 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3199 
	`kä“
(
bùl
);

3200 
	}
}

3206 
	$chunk_´ofžes_fž‹r
(
u64
 
chunk_ty³
,

3207 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3209 
chunk_ty³
 = 
	`chunk_to_ex‹nded
(chunk_type) &

3210 
BTRFS_EXTENDED_PROFILE_MASK
;

3212 ià(
b¬gs
->
´ofžes
 & 
chunk_ty³
)

3216 
	}
}

3218 
	$chunk_u§ge_¿nge_fž‹r
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
,

3219 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3221 
bŒfs_block_group_ÿche
 *
ÿche
;

3222 
u64
 
chunk_u£d
;

3223 
u64
 
u£r_th»sh_mš
;

3224 
u64
 
u£r_th»sh_max
;

3225 
»t
 = 1;

3227 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3228 
chunk_u£d
 = 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
);

3230 ià(
b¬gs
->
u§ge_mš
 == 0)

3231 
u£r_th»sh_mš
 = 0;

3233 
u£r_th»sh_mš
 = 
	`div_çùÜ_fše
(
ÿche
->
key
.
off£t
,

3234 
b¬gs
->
u§ge_mš
);

3236 ià(
b¬gs
->
u§ge_max
 == 0)

3237 
u£r_th»sh_max
 = 1;

3238 ià(
b¬gs
->
u§ge_max
 > 100)

3239 
u£r_th»sh_max
 = 
ÿche
->
key
.
off£t
;

3241 
u£r_th»sh_max
 = 
	`div_çùÜ_fše
(
ÿche
->
key
.
off£t
,

3242 
b¬gs
->
u§ge_max
);

3244 ià(
u£r_th»sh_mš
 <ð
chunk_u£d
 && chunk_u£d < 
u£r_th»sh_max
)

3245 
»t
 = 0;

3247 
	`bŒfs_put_block_group
(
ÿche
);

3248  
»t
;

3249 
	}
}

3251 
	$chunk_u§ge_fž‹r
(
bŒfs_fs_šfo
 *
fs_šfo
,

3252 
u64
 
chunk_off£t
, 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3254 
bŒfs_block_group_ÿche
 *
ÿche
;

3255 
u64
 
chunk_u£d
, 
u£r_th»sh
;

3256 
»t
 = 1;

3258 
ÿche
 = 
	`bŒfs_lookup_block_group
(
fs_šfo
, 
chunk_off£t
);

3259 
chunk_u£d
 = 
	`bŒfs_block_group_u£d
(&
ÿche
->
™em
);

3261 ià(
b¬gs
->
u§ge_mš
 == 0)

3262 
u£r_th»sh
 = 1;

3263 ià(
b¬gs
->
u§ge
 > 100)

3264 
u£r_th»sh
 = 
ÿche
->
key
.
off£t
;

3266 
u£r_th»sh
 = 
	`div_çùÜ_fše
(
ÿche
->
key
.
off£t
,

3267 
b¬gs
->
u§ge
);

3269 ià(
chunk_u£d
 < 
u£r_th»sh
)

3270 
»t
 = 0;

3272 
	`bŒfs_put_block_group
(
ÿche
);

3273  
»t
;

3274 
	}
}

3276 
	$chunk_devid_fž‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3277 
bŒfs_chunk
 *
chunk
,

3278 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3280 
bŒfs_¡re
 *
¡re
;

3281 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

3282 
i
;

3284 
i
 = 0; i < 
num_¡res
; i++) {

3285 
¡re
 = 
	`bŒfs_¡re_Ä
(
chunk
, 
i
);

3286 ià(
	`bŒfs_¡re_devid
(
Ëaf
, 
¡re
è=ð
b¬gs
->
devid
)

3291 
	}
}

3294 
	$chunk_d¿nge_fž‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3295 
bŒfs_chunk
 *
chunk
,

3296 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3298 
bŒfs_¡re
 *
¡re
;

3299 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

3300 
u64
 
¡re_off£t
;

3301 
u64
 
¡re_Ëngth
;

3302 
çùÜ
;

3303 
i
;

3305 ià(!(
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_DEVID
))

3308 ià(
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
è& (
BTRFS_BLOCK_GROUP_DUP
 |

3309 
BTRFS_BLOCK_GROUP_RAID1
 | 
BTRFS_BLOCK_GROUP_RAID10
)) {

3310 
çùÜ
 = 
num_¡res
 / 2;

3311 } ià(
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
è& 
BTRFS_BLOCK_GROUP_RAID5
) {

3312 
çùÜ
 = 
num_¡res
 - 1;

3313 } ià(
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
è& 
BTRFS_BLOCK_GROUP_RAID6
) {

3314 
çùÜ
 = 
num_¡res
 - 2;

3316 
çùÜ
 = 
num_¡res
;

3319 
i
 = 0; i < 
num_¡res
; i++) {

3320 
¡re
 = 
	`bŒfs_¡re_Ä
(
chunk
, 
i
);

3321 ià(
	`bŒfs_¡re_devid
(
Ëaf
, 
¡re
è!ð
b¬gs
->
devid
)

3324 
¡re_off£t
 = 
	`bŒfs_¡re_off£t
(
Ëaf
, 
¡re
);

3325 
¡re_Ëngth
 = 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
);

3326 
¡re_Ëngth
 = 
	`div_u64
(¡re_Ëngth, 
çùÜ
);

3328 ià(
¡re_off£t
 < 
b¬gs
->
³nd
 &&

3329 
¡re_off£t
 + 
¡re_Ëngth
 > 
b¬gs
->
p¡¬t
)

3334 
	}
}

3337 
	$chunk_v¿nge_fž‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3338 
bŒfs_chunk
 *
chunk
,

3339 
u64
 
chunk_off£t
,

3340 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3342 ià(
chunk_off£t
 < 
b¬gs
->
v’d
 &&

3343 
chunk_off£t
 + 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
è> 
b¬gs
->
v¡¬t
)

3348 
	}
}

3350 
	$chunk_¡res_¿nge_fž‹r
(
ex‹Á_bufãr
 *
Ëaf
,

3351 
bŒfs_chunk
 *
chunk
,

3352 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3354 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

3356 ià(
b¬gs
->
¡res_mš
 <ð
num_¡res


3357 && 
num_¡res
 <ð
b¬gs
->
¡res_max
)

3361 
	}
}

3363 
	$chunk_soá_cÚv”t_fž‹r
(
u64
 
chunk_ty³
,

3364 
bŒfs_b®ªû_¬gs
 *
b¬gs
)

3366 ià(!(
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
))

3369 
chunk_ty³
 = 
	`chunk_to_ex‹nded
(chunk_type) &

3370 
BTRFS_EXTENDED_PROFILE_MASK
;

3372 ià(
b¬gs
->
rg‘
 =ð
chunk_ty³
)

3376 
	}
}

3378 
	$should_b®ªû_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

3379 
ex‹Á_bufãr
 *
Ëaf
,

3380 
bŒfs_chunk
 *
chunk
, 
u64
 
chunk_off£t
)

3382 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

3383 
bŒfs_b®ªû_¬gs
 *
b¬gs
 = 
NULL
;

3384 
u64
 
chunk_ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

3387 ià(!((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_TYPE_MASK
) &

3388 (
bùl
->
æags
 & 
BTRFS_BALANCE_TYPE_MASK
))) {

3392 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
)

3393 
b¬gs
 = &
bùl
->
d©a
;

3394 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

3395 
b¬gs
 = &
bùl
->
sys
;

3396 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
)

3397 
b¬gs
 = &
bùl
->
m‘a
;

3400 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_PROFILES
) &&

3401 
	`chunk_´ofžes_fž‹r
(
chunk_ty³
, 
b¬gs
)) {

3406 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_USAGE
) &&

3407 
	`chunk_u§ge_fž‹r
(
fs_šfo
, 
chunk_off£t
, 
b¬gs
)) {

3409 } ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_USAGE_RANGE
) &&

3410 
	`chunk_u§ge_¿nge_fž‹r
(
fs_šfo
, 
chunk_off£t
, 
b¬gs
)) {

3415 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_DEVID
) &&

3416 
	`chunk_devid_fž‹r
(
Ëaf
, 
chunk
, 
b¬gs
)) {

3421 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_DRANGE
) &&

3422 
	`chunk_d¿nge_fž‹r
(
Ëaf
, 
chunk
, 
b¬gs
)) {

3427 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_VRANGE
) &&

3428 
	`chunk_v¿nge_fž‹r
(
Ëaf
, 
chunk
, 
chunk_off£t
, 
b¬gs
)) {

3433 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_STRIPES_RANGE
) &&

3434 
	`chunk_¡res_¿nge_fž‹r
(
Ëaf
, 
chunk
, 
b¬gs
)) {

3439 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_SOFT
) &&

3440 
	`chunk_soá_cÚv”t_fž‹r
(
chunk_ty³
, 
b¬gs
)) {

3447 ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_LIMIT
)) {

3448 ià(
b¬gs
->
lim™
 == 0)

3451 
b¬gs
->
lim™
--;

3452 } ià((
b¬gs
->
æags
 & 
BTRFS_BALANCE_ARGS_LIMIT_RANGE
)) {

3458 ià(
b¬gs
->
lim™_max
 == 0)

3461 
b¬gs
->
lim™_max
--;

3465 
	}
}

3467 
	$__bŒfs_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

3469 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
 = 
fs_šfo
->
b®ªû_ùl
;

3470 
bŒfs_roÙ
 *
chunk_roÙ
 = 
fs_šfo
->chunk_root;

3471 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

3472 
li¡_h—d
 *
deviûs
;

3473 
bŒfs_deviû
 *
deviû
;

3474 
u64
 
Þd_size
;

3475 
u64
 
size_to_ä“
;

3476 
u64
 
chunk_ty³
;

3477 
bŒfs_chunk
 *
chunk
;

3478 
bŒfs_·th
 *
·th
 = 
NULL
;

3479 
bŒfs_key
 
key
;

3480 
bŒfs_key
 
found_key
;

3481 
bŒfs_Œªs_hªdË
 *
Œªs
;

3482 
ex‹Á_bufãr
 *
Ëaf
;

3483 
¦Ù
;

3484 
»t
;

3485 
’o¥c_”rÜs
 = 0;

3486 
boÞ
 
couÁšg
 = 
Œue
;

3488 
u64
 
lim™_d©a
 = 
bùl
->
d©a
.
lim™
;

3489 
u64
 
lim™_m‘a
 = 
bùl
->
m‘a
.
lim™
;

3490 
u64
 
lim™_sys
 = 
bùl
->
sys
.
lim™
;

3491 
u32
 
couÁ_d©a
 = 0;

3492 
u32
 
couÁ_m‘a
 = 0;

3493 
u32
 
couÁ_sys
 = 0;

3494 
chunk_»£rved
 = 0;

3495 
u64
 
by‹s_u£d
 = 0;

3498 
deviûs
 = &
fs_šfo
->
fs_deviûs
->devices;

3499 
	`li¡_fÜ_—ch_’Œy
(
deviû
, 
deviûs
, 
dev_li¡
) {

3500 
Þd_size
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
deviû
);

3501 
size_to_ä“
 = 
	`div_çùÜ
(
Þd_size
, 1);

3502 
size_to_ä“
 = 
	`mš_t
(
u64
, size_to_ä“, 
SZ_1M
);

3503 ià(!
deviû
->
wr™—bË
 ||

3504 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
deviû
) -

3505 
	`bŒfs_deviû_g‘_by‹s_u£d
(
deviû
è> 
size_to_ä“
 ||

3506 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
)

3509 
»t
 = 
	`bŒfs_shršk_deviû
(
deviû
, 
Þd_size
 - 
size_to_ä“
);

3510 ià(
»t
 =ð-
ENOSPC
)

3512 ià(
»t
) {

3514 
	`WARN_ON
(
»t
 > 0);

3515 
”rÜ
;

3518 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
dev_roÙ
, 0);

3519 ià(
	`IS_ERR
(
Œªs
)) {

3520 
»t
 = 
	`PTR_ERR
(
Œªs
);

3521 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

3523 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
»t
,

3524 
Þd_size
, old_siz- 
size_to_ä“
);

3525 
”rÜ
;

3528 
»t
 = 
	`bŒfs_grow_deviû
(
Œªs
, 
deviû
, 
Þd_size
);

3529 ià(
»t
) {

3530 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3532 
	`WARN_ON
(
»t
 > 0);

3533 
	`bŒfs_šfo_š_rcu
(
fs_šfo
,

3535 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
»t
,

3536 
Þd_size
, old_siz- 
size_to_ä“
);

3537 
”rÜ
;

3540 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3544 
·th
 = 
	`bŒfs_®loc_·th
();

3545 ià(!
·th
) {

3546 
»t
 = -
ENOMEM
;

3547 
”rÜ
;

3551 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3552 
	`mem£t
(&
bùl
->
¡©
, 0, (bctl->stat));

3553 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3554 
agaš
:

3555 ià(!
couÁšg
) {

3560 
bùl
->
d©a
.
lim™
 = 
lim™_d©a
;

3561 
bùl
->
m‘a
.
lim™
 = 
lim™_m‘a
;

3562 
bùl
->
sys
.
lim™
 = 
lim™_sys
;

3564 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

3565 
key
.
off£t
 = (
u64
)-1;

3566 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

3569 ià((!
couÁšg
 && 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
)) ||

3570 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
)) {

3571 
»t
 = -
ECANCELED
;

3572 
”rÜ
;

3575 
	`mu‹x_lock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3576 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
chunk_roÙ
, &
key
, 
·th
, 0, 0);

3577 ià(
»t
 < 0) {

3578 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3579 
”rÜ
;

3586 ià(
»t
 == 0)

3587 
	`BUG
();

3589 
»t
 = 
	`bŒfs_´evious_™em
(
chunk_roÙ
, 
·th
, 0,

3590 
BTRFS_CHUNK_ITEM_KEY
);

3591 ià(
»t
) {

3592 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3593 
»t
 = 0;

3597 
Ëaf
 = 
·th
->
nodes
[0];

3598 
¦Ù
 = 
·th
->
¦Ùs
[0];

3599 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

3601 ià(
found_key
.
objeùid
 !ð
key
.objectid) {

3602 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3606 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_chunk
);

3607 
chunk_ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

3609 ià(!
couÁšg
) {

3610 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3611 
bùl
->
¡©
.
cÚsid”ed
++;

3612 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3615 
»t
 = 
	`should_b®ªû_chunk
(
fs_šfo
, 
Ëaf
, 
chunk
,

3616 
found_key
.
off£t
);

3618 
	`bŒfs_»Ëa£_·th
(
·th
);

3619 ià(!
»t
) {

3620 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3621 
loÝ
;

3624 ià(
couÁšg
) {

3625 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3626 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3627 
bùl
->
¡©
.
ex³ùed
++;

3628 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3630 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
)

3631 
couÁ_d©a
++;

3632 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
)

3633 
couÁ_sys
++;

3634 ià(
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
)

3635 
couÁ_m‘a
++;

3637 
loÝ
;

3644 ià(((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

3645 
couÁ_d©a
 < 
bùl
->
d©a
.
lim™_mš
)

3646 || ((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
) &&

3647 
couÁ_m‘a
 < 
bùl
->
m‘a
.
lim™_mš
)

3648 || ((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) &&

3649 
couÁ_sys
 < 
bùl
->
sys
.
lim™_mš
)) {

3650 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3651 
loÝ
;

3654 
	`ASSERT
(
fs_šfo
->
d©a_sšfo
);

3655 
	`¥š_lock
(&
fs_šfo
->
d©a_sšfo
->
lock
);

3656 
by‹s_u£d
 = 
fs_šfo
->
d©a_sšfo
->bytes_used;

3657 
	`¥š_uÆock
(&
fs_šfo
->
d©a_sšfo
->
lock
);

3659 ià((
chunk_ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) &&

3660 !
chunk_»£rved
 && !
by‹s_u£d
) {

3661 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
chunk_roÙ
, 0);

3662 ià(
	`IS_ERR
(
Œªs
)) {

3663 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3664 
»t
 = 
	`PTR_ERR
(
Œªs
);

3665 
”rÜ
;

3668 
»t
 = 
	`bŒfs_fÜû_chunk_®loc
(
Œªs
, 
fs_šfo
,

3669 
BTRFS_BLOCK_GROUP_DATA
);

3670 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

3671 ià(
»t
 < 0) {

3672 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3673 
”rÜ
;

3675 
chunk_»£rved
 = 1;

3678 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
found_key
.
off£t
);

3679 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

3680 ià(
»t
 &&„‘ !ð-
ENOSPC
)

3681 
”rÜ
;

3682 ià(
»t
 =ð-
ENOSPC
) {

3683 
’o¥c_”rÜs
++;

3685 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3686 
bùl
->
¡©
.
com¶‘ed
++;

3687 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3689 
loÝ
:

3690 ià(
found_key
.
off£t
 == 0)

3692 
key
.
off£t
 = 
found_key
.offset - 1;

3695 ià(
couÁšg
) {

3696 
	`bŒfs_»Ëa£_·th
(
·th
);

3697 
couÁšg
 = 
çl£
;

3698 
agaš
;

3700 
”rÜ
:

3701 
	`bŒfs_ä“_·th
(
·th
);

3702 ià(
’o¥c_”rÜs
) {

3703 
	`bŒfs_šfo
(
fs_šfo
, "%dƒnospcƒrrors during balance",

3704 
’o¥c_”rÜs
);

3705 ià(!
»t
)

3706 
»t
 = -
ENOSPC
;

3709  
»t
;

3710 
	}
}

3717 
	$®loc_´ofže_is_v®id
(
u64
 
æags
, 
ex‹nded
)

3719 
u64
 
mask
 = (
ex‹nded
 ? 
BTRFS_EXTENDED_PROFILE_MASK
 :

3720 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

3722 
æags
 &ð~
BTRFS_BLOCK_GROUP_TYPE_MASK
;

3725 ià(
æags
 & ~
mask
)

3729 ià(
æags
 == 0)

3730  !
ex‹nded
;

3733  (
æags
 & (flags - 1)) == 0;

3734 
	}
}

3736 
šlše
 
	$b®ªû_Ãed_þo£
(
bŒfs_fs_šfo
 *
fs_šfo
)

3739  
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
) ||

3740 (
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
) == 0 &&

3741 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
) == 0);

3742 
	}
}

3744 
	$__ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

3746 
»t
;

3748 
	`un£t_b®ªû_cÚŒÞ
(
fs_šfo
);

3749 
»t
 = 
	`d–_b®ªû_™em
(
fs_šfo
);

3750 ià(
»t
)

3751 
	`bŒfs_hªdË_fs_”rÜ
(
fs_šfo
, 
»t
, 
NULL
);

3753 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

3754 
	}
}

3757 
šlše
 
	$v®id©e_cÚv”t_´ofže
(
bŒfs_b®ªû_¬gs
 *
bùl_¬g
,

3758 
u64
 
®lowed
)

3760  ((
bùl_¬g
->
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

3761 (!
	`®loc_´ofže_is_v®id
(
bùl_¬g
->
rg‘
, 1) ||

3762 (
bùl_¬g
->
rg‘
 & ~
®lowed
)));

3763 
	}
}

3768 
	$bŒfs_b®ªû
(
bŒfs_b®ªû_cÚŒÞ
 *
bùl
,

3769 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
)

3771 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bùl
->fs_info;

3772 
u64
 
m‘a_rg‘
, 
d©a_rg‘
;

3773 
u64
 
®lowed
;

3774 
mixed
 = 0;

3775 
»t
;

3776 
u64
 
num_deviûs
;

3777 
£q
;

3779 ià(
	`bŒfs_fs_þosšg
(
fs_šfo
) ||

3780 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_·u£_»q
) ||

3781 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ÿnûl_»q
)) {

3782 
»t
 = -
EINVAL
;

3783 
out
;

3786 
®lowed
 = 
	`bŒfs_su³r_šcom·t_æags
(
fs_šfo
->
su³r_cÝy
);

3787 ià(
®lowed
 & 
BTRFS_FEATURE_INCOMPAT_MIXED_GROUPS
)

3788 
mixed
 = 1;

3794 
®lowed
 = 
BTRFS_BALANCE_DATA
 | 
BTRFS_BALANCE_METADATA
;

3795 ià(
mixed
 && (
bùl
->
æags
 & 
®lowed
)) {

3796 ià(!(
bùl
->
æags
 & 
BTRFS_BALANCE_DATA
) ||

3797 !(
bùl
->
æags
 & 
BTRFS_BALANCE_METADATA
) ||

3798 
	`memcmp
(&
bùl
->
d©a
, &bùl->
m‘a
, (bctl->data))) {

3799 
	`bŒfs_”r
(
fs_šfo
,

3801 
»t
 = -
EINVAL
;

3802 
out
;

3806 
num_deviûs
 = 
fs_šfo
->
fs_deviûs
->num_devices;

3807 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 0);

3808 ià(
	`bŒfs_dev_»¶aû_is_Úgošg
(&
fs_šfo
->
dev_»¶aû
)) {

3809 
	`BUG_ON
(
num_deviûs
 < 1);

3810 
num_deviûs
--;

3812 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

3813 
®lowed
 = 
BTRFS_AVAIL_ALLOC_BIT_SINGLE
 | 
BTRFS_BLOCK_GROUP_DUP
;

3814 ià(
num_deviûs
 > 1)

3815 
®lowed
 |ð(
BTRFS_BLOCK_GROUP_RAID0
 | 
BTRFS_BLOCK_GROUP_RAID1
);

3816 ià(
num_deviûs
 > 2)

3817 
®lowed
 |ð
BTRFS_BLOCK_GROUP_RAID5
;

3818 ià(
num_deviûs
 > 3)

3819 
®lowed
 |ð(
BTRFS_BLOCK_GROUP_RAID10
 |

3820 
BTRFS_BLOCK_GROUP_RAID6
);

3821 ià(
	`v®id©e_cÚv”t_´ofže
(&
bùl
->
d©a
, 
®lowed
)) {

3822 
	`bŒfs_”r
(
fs_šfo
,

3824 
bùl
->
d©a
.
rg‘
);

3825 
»t
 = -
EINVAL
;

3826 
out
;

3828 ià(
	`v®id©e_cÚv”t_´ofže
(&
bùl
->
m‘a
, 
®lowed
)) {

3829 
	`bŒfs_”r
(
fs_šfo
,

3831 
bùl
->
m‘a
.
rg‘
);

3832 
»t
 = -
EINVAL
;

3833 
out
;

3835 ià(
	`v®id©e_cÚv”t_´ofže
(&
bùl
->
sys
, 
®lowed
)) {

3836 
	`bŒfs_”r
(
fs_šfo
,

3838 
bùl
->
sys
.
rg‘
);

3839 
»t
 = -
EINVAL
;

3840 
out
;

3844 
®lowed
 = 
BTRFS_BLOCK_GROUP_DUP
 | 
BTRFS_BLOCK_GROUP_RAID1
 |

3845 
BTRFS_BLOCK_GROUP_RAID10
 |

3846 
BTRFS_BLOCK_GROUP_RAID5
 |

3847 
BTRFS_BLOCK_GROUP_RAID6
;

3849 
£q
 = 
	`»ad_£qbegš
(&
fs_šfo
->
´ofžes_lock
);

3851 ià(((
bùl
->
sys
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

3852 (
fs_šfo
->
avaž_sy¡em_®loc_b™s
 & 
®lowed
) &&

3853 !(
bùl
->
sys
.
rg‘
 & 
®lowed
)) ||

3854 ((
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) &&

3855 (
fs_šfo
->
avaž_m‘ad©a_®loc_b™s
 & 
®lowed
) &&

3856 !(
bùl
->
m‘a
.
rg‘
 & 
®lowed
))) {

3857 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_FORCE
) {

3858 
	`bŒfs_šfo
(
fs_šfo
,

3861 
	`bŒfs_”r
(
fs_šfo
,

3863 
»t
 = -
EINVAL
;

3864 
out
;

3867 } 
	`»ad_£q»Œy
(&
fs_šfo
->
´ofžes_lock
, 
£q
));

3870 
m‘a_rg‘
 = (
bùl
->
m‘a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) ?

3871 
bùl
->
m‘a
.
rg‘
 : 
fs_šfo
->
avaž_m‘ad©a_®loc_b™s
;

3872 
d©a_rg‘
 = (
bùl
->
d©a
.
æags
 & 
BTRFS_BALANCE_ARGS_CONVERT
) ?

3873 
bùl
->
d©a
.
rg‘
 : 
fs_šfo
->
avaž_d©a_®loc_b™s
;

3874 ià(
	`bŒfs_g‘_num_tÞ”©ed_disk_b¬r›r_çžu»s
(
m‘a_rg‘
) <

3875 
	`bŒfs_g‘_num_tÞ”©ed_disk_b¬r›r_çžu»s
(
d©a_rg‘
)) {

3876 
	`bŒfs_w¬n
(
fs_šfo
,

3878 
m‘a_rg‘
, 
d©a_rg‘
);

3881 
»t
 = 
	`š£¹_b®ªû_™em
(
fs_šfo
, 
bùl
);

3882 ià(
»t
 &&„‘ !ð-
EEXIST
)

3883 
out
;

3885 ià(!(
bùl
->
æags
 & 
BTRFS_BALANCE_RESUME
)) {

3886 
	`BUG_ON
(
»t
 =ð-
EEXIST
);

3887 
	`£t_b®ªû_cÚŒÞ
(
bùl
);

3889 
	`BUG_ON
(
»t
 !ð-
EEXIST
);

3890 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3891 
	`upd©e_b®ªû_¬gs
(
bùl
);

3892 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3895 
	`©omic_šc
(&
fs_šfo
->
b®ªû_ruÂšg
);

3896 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3898 
»t
 = 
	`__bŒfs_b®ªû
(
fs_šfo
);

3900 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

3901 
	`©omic_dec
(&
fs_šfo
->
b®ªû_ruÂšg
);

3903 ià(
b¬gs
) {

3904 
	`mem£t
(
b¬gs
, 0, (*bargs));

3905 
	`upd©e_ioùl_b®ªû_¬gs
(
fs_šfo
, 0, 
b¬gs
);

3908 ià((
»t
 &&„‘ !ð-
ECANCELED
 &&„‘ !ð-
ENOSPC
) ||

3909 
	`b®ªû_Ãed_þo£
(
fs_šfo
)) {

3910 
	`__ÿnûl_b®ªû
(
fs_šfo
);

3913 
	`wake_up
(&
fs_šfo
->
b®ªû_wa™_q
);

3915  
»t
;

3916 
out
:

3917 ià(
bùl
->
æags
 & 
BTRFS_BALANCE_RESUME
)

3918 
	`__ÿnûl_b®ªû
(
fs_šfo
);

3920 
	`kä“
(
bùl
);

3921 
	`þ—r_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
);

3923  
»t
;

3924 
	}
}

3926 
	$b®ªû_kth»ad
(*
d©a
)

3928 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

3929 
»t
 = 0;

3931 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

3932 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

3934 ià(
fs_šfo
->
b®ªû_ùl
) {

3935 
	`bŒfs_šfo
(
fs_šfo
, "continuing balance");

3936 
»t
 = 
	`bŒfs_b®ªû
(
fs_šfo
->
b®ªû_ùl
, 
NULL
);

3939 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

3940 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

3942  
»t
;

3943 
	}
}

3945 
	$bŒfs_»sume_b®ªû_async
(
bŒfs_fs_šfo
 *
fs_šfo
)

3947 
sk_¡ruù
 *
tsk
;

3949 
	`¥š_lock
(&
fs_šfo
->
b®ªû_lock
);

3950 ià(!
fs_šfo
->
b®ªû_ùl
) {

3951 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3954 
	`¥š_uÆock
(&
fs_šfo
->
b®ªû_lock
);

3956 ià(
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
SKIP_BALANCE
)) {

3957 
	`bŒfs_šfo
(
fs_šfo
, "force skipping balance");

3961 
tsk
 = 
	`kth»ad_run
(
b®ªû_kth»ad
, 
fs_šfo
, "btrfs-balance");

3962  
	`PTR_ERR_OR_ZERO
(
tsk
);

3963 
	}
}

3965 
	$bŒfs_»cov”_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

3967 
bŒfs_b®ªû_cÚŒÞ
 *
bùl
;

3968 
bŒfs_b®ªû_™em
 *
™em
;

3969 
bŒfs_disk_b®ªû_¬gs
 
disk_b¬gs
;

3970 
bŒfs_·th
 *
·th
;

3971 
ex‹Á_bufãr
 *
Ëaf
;

3972 
bŒfs_key
 
key
;

3973 
»t
;

3975 
·th
 = 
	`bŒfs_®loc_·th
();

3976 ià(!
·th
)

3977  -
ENOMEM
;

3979 
key
.
objeùid
 = 
BTRFS_BALANCE_OBJECTID
;

3980 
key
.
ty³
 = 
BTRFS_TEMPORARY_ITEM_KEY
;

3981 
key
.
off£t
 = 0;

3983 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
fs_šfo
->
Œ“_roÙ
, &
key
, 
·th
, 0, 0);

3984 ià(
»t
 < 0)

3985 
out
;

3986 ià(
»t
 > 0) {

3987 
»t
 = 0;

3988 
out
;

3991 
bùl
 = 
	`kz®loc
((*bùl), 
GFP_NOFS
);

3992 ià(!
bùl
) {

3993 
»t
 = -
ENOMEM
;

3994 
out
;

3997 
Ëaf
 = 
·th
->
nodes
[0];

3998 
™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
·th
->
¦Ùs
[0], 
bŒfs_b®ªû_™em
);

4000 
bùl
->
fs_šfo
 = fs_info;

4001 
bùl
->
æags
 = 
	`bŒfs_b®ªû_æags
(
Ëaf
, 
™em
);

4002 
bùl
->
æags
 |ð
BTRFS_BALANCE_RESUME
;

4004 
	`bŒfs_b®ªû_d©a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

4005 
	`bŒfs_disk_b®ªû_¬gs_to_ýu
(&
bùl
->
d©a
, &
disk_b¬gs
);

4006 
	`bŒfs_b®ªû_m‘a
(
Ëaf
, 
™em
, &
disk_b¬gs
);

4007 
	`bŒfs_disk_b®ªû_¬gs_to_ýu
(&
bùl
->
m‘a
, &
disk_b¬gs
);

4008 
	`bŒfs_b®ªû_sys
(
Ëaf
, 
™em
, &
disk_b¬gs
);

4009 
	`bŒfs_disk_b®ªû_¬gs_to_ýu
(&
bùl
->
sys
, &
disk_b¬gs
);

4011 
	`WARN_ON
(
	`‹¡_ªd_£t_b™
(
BTRFS_FS_EXCL_OP
, &
fs_šfo
->
æags
));

4013 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

4014 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4016 
	`£t_b®ªû_cÚŒÞ
(
bùl
);

4018 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4019 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

4020 
out
:

4021 
	`bŒfs_ä“_·th
(
·th
);

4022  
»t
;

4023 
	}
}

4025 
	$bŒfs_·u£_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

4027 
»t
 = 0;

4029 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4030 ià(!
fs_šfo
->
b®ªû_ùl
) {

4031 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4032  -
ENOTCONN
;

4035 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
)) {

4036 
	`©omic_šc
(&
fs_šfo
->
b®ªû_·u£_»q
);

4037 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4039 
	`wa™_ev’t
(
fs_šfo
->
b®ªû_wa™_q
,

4040 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
) == 0);

4042 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4044 
	`BUG_ON
(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
));

4045 
	`©omic_dec
(&
fs_šfo
->
b®ªû_·u£_»q
);

4047 
»t
 = -
ENOTCONN
;

4050 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4051  
»t
;

4052 
	}
}

4054 
	$bŒfs_ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
)

4056 ià(
	`sb_rdÚly
(
fs_šfo
->
sb
))

4057  -
EROFS
;

4059 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4060 ià(!
fs_šfo
->
b®ªû_ùl
) {

4061 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4062  -
ENOTCONN
;

4065 
	`©omic_šc
(&
fs_šfo
->
b®ªû_ÿnûl_»q
);

4070 ià(
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
)) {

4071 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4072 
	`wa™_ev’t
(
fs_šfo
->
b®ªû_wa™_q
,

4073 
	`©omic_»ad
(&
fs_šfo
->
b®ªû_ruÂšg
) == 0);

4074 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4077 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4078 
	`mu‹x_lock
(&
fs_šfo
->
vÞume_mu‹x
);

4079 
	`mu‹x_lock
(&
fs_šfo
->
b®ªû_mu‹x
);

4081 ià(
fs_šfo
->
b®ªû_ùl
)

4082 
	`__ÿnûl_b®ªû
(
fs_šfo
);

4084 
	`mu‹x_uÆock
(&
fs_šfo
->
vÞume_mu‹x
);

4087 
	`BUG_ON
(
fs_šfo
->
b®ªû_ùl
 || 
	`©omic_»ad
(&fs_šfo->
b®ªû_ruÂšg
));

4088 
	`©omic_dec
(&
fs_šfo
->
b®ªû_ÿnûl_»q
);

4089 
	`mu‹x_uÆock
(&
fs_šfo
->
b®ªû_mu‹x
);

4091 
	}
}

4093 
	$bŒfs_uuid_sÿn_kth»ad
(*
d©a
)

4095 
bŒfs_fs_šfo
 *
fs_šfo
 = 
d©a
;

4096 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

4097 
bŒfs_key
 
key
;

4098 
bŒfs_·th
 *
·th
 = 
NULL
;

4099 
»t
 = 0;

4100 
ex‹Á_bufãr
 *
eb
;

4101 
¦Ù
;

4102 
bŒfs_roÙ_™em
 
roÙ_™em
;

4103 
u32
 
™em_size
;

4104 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
NULL
;

4106 
·th
 = 
	`bŒfs_®loc_·th
();

4107 ià(!
·th
) {

4108 
»t
 = -
ENOMEM
;

4109 
out
;

4112 
key
.
objeùid
 = 0;

4113 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4114 
key
.
off£t
 = 0;

4117 
»t
 = 
	`bŒfs_£¬ch_fÜw¬d
(
roÙ
, &
key
, 
·th
, 0);

4118 ià(
»t
) {

4119 ià(
»t
 > 0)

4120 
»t
 = 0;

4124 ià(
key
.
ty³
 !ð
BTRFS_ROOT_ITEM_KEY
 ||

4125 (
key
.
objeùid
 < 
BTRFS_FIRST_FREE_OBJECTID
 &&

4126 
key
.
objeùid
 !ð
BTRFS_FS_TREE_OBJECTID
) ||

4127 
key
.
objeùid
 > 
BTRFS_LAST_FREE_OBJECTID
)

4128 
sk
;

4130 
eb
 = 
·th
->
nodes
[0];

4131 
¦Ù
 = 
·th
->
¦Ùs
[0];

4132 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

4133 ià(
™em_size
 < (
roÙ_™em
))

4134 
sk
;

4136 
	`»ad_ex‹Á_bufãr
(
eb
, &
roÙ_™em
,

4137 
	`bŒfs_™em_±r_off£t
(
eb
, 
¦Ù
),

4138 ()(
roÙ_™em
));

4139 ià(
	`bŒfs_roÙ_»fs
(&
roÙ_™em
) == 0)

4140 
sk
;

4142 ià(!
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
uuid
) ||

4143 !
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
»ûived_uuid
)) {

4144 ià(
Œªs
)

4145 
upd©e_Œ“
;

4147 
	`bŒfs_»Ëa£_·th
(
·th
);

4152 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
fs_šfo
->
uuid_roÙ
, 2);

4153 ià(
	`IS_ERR
(
Œªs
)) {

4154 
»t
 = 
	`PTR_ERR
(
Œªs
);

4159 
sk
;

4161 
upd©e_Œ“
:

4162 ià(!
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
uuid
)) {

4163 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
fs_šfo
,

4164 
roÙ_™em
.
uuid
,

4165 
BTRFS_UUID_KEY_SUBVOL
,

4166 
key
.
objeùid
);

4167 ià(
»t
 < 0) {

4168 
	`bŒfs_w¬n
(
fs_šfo
, "uuid_tree_add failed %d",

4169 
»t
);

4174 ià(!
	`bŒfs_is_em±y_uuid
(
roÙ_™em
.
»ûived_uuid
)) {

4175 
»t
 = 
	`bŒfs_uuid_Œ“_add
(
Œªs
, 
fs_šfo
,

4176 
roÙ_™em
.
»ûived_uuid
,

4177 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
,

4178 
key
.
objeùid
);

4179 ià(
»t
 < 0) {

4180 
	`bŒfs_w¬n
(
fs_šfo
, "uuid_tree_add failed %d",

4181 
»t
);

4186 
sk
:

4187 ià(
Œªs
) {

4188 
»t
 = 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4189 
Œªs
 = 
NULL
;

4190 ià(
»t
)

4194 
	`bŒfs_»Ëa£_·th
(
·th
);

4195 ià(
key
.
off£t
 < (
u64
)-1) {

4196 
key
.
off£t
++;

4197 } ià(
key
.
ty³
 < 
BTRFS_ROOT_ITEM_KEY
) {

4198 
key
.
off£t
 = 0;

4199 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4200 } ià(
key
.
objeùid
 < (
u64
)-1) {

4201 
key
.
off£t
 = 0;

4202 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4203 
key
.
objeùid
++;

4207 
	`cÚd_»sched
();

4210 
out
:

4211 
	`bŒfs_ä“_·th
(
·th
);

4212 ià(
Œªs
 && !
	`IS_ERR
(trans))

4213 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4214 ià(
»t
)

4215 
	`bŒfs_w¬n
(
fs_šfo
, "bŒfs_uuid_sÿn_kth»ad fažed %d", 
»t
);

4217 
	`£t_b™
(
BTRFS_FS_UPDATE_UUID_TREE_GEN
, &
fs_šfo
->
æags
);

4218 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

4220 
	}
}

4229 
	$bŒfs_check_uuid_Œ“_’Œy
(
bŒfs_fs_šfo
 *
fs_šfo
,

4230 
u8
 *
uuid
, u8 
ty³
, 
u64
 
subid
)

4232 
bŒfs_key
 
key
;

4233 
»t
 = 0;

4234 
bŒfs_roÙ
 *
subvÞ_roÙ
;

4236 ià(
ty³
 !ð
BTRFS_UUID_KEY_SUBVOL
 &&

4237 
ty³
 !ð
BTRFS_UUID_KEY_RECEIVED_SUBVOL
)

4238 
out
;

4240 
key
.
objeùid
 = 
subid
;

4241 
key
.
ty³
 = 
BTRFS_ROOT_ITEM_KEY
;

4242 
key
.
off£t
 = (
u64
)-1;

4243 
subvÞ_roÙ
 = 
	`bŒfs_»ad_fs_roÙ_no_Çme
(
fs_šfo
, &
key
);

4244 ià(
	`IS_ERR
(
subvÞ_roÙ
)) {

4245 
»t
 = 
	`PTR_ERR
(
subvÞ_roÙ
);

4246 ià(
»t
 =ð-
ENOENT
)

4247 
»t
 = 1;

4248 
out
;

4251 
ty³
) {

4252 
BTRFS_UUID_KEY_SUBVOL
:

4253 ià(
	`memcmp
(
uuid
, 
subvÞ_roÙ
->
roÙ_™em
.uuid, 
BTRFS_UUID_SIZE
))

4254 
»t
 = 1;

4256 
BTRFS_UUID_KEY_RECEIVED_SUBVOL
:

4257 ià(
	`memcmp
(
uuid
, 
subvÞ_roÙ
->
roÙ_™em
.
»ûived_uuid
,

4258 
BTRFS_UUID_SIZE
))

4259 
»t
 = 1;

4263 
out
:

4264  
»t
;

4265 
	}
}

4267 
	$bŒfs_uuid_»sÿn_kth»ad
(*
d©a
)

4269 
bŒfs_fs_šfo
 *
fs_šfo
 = (bŒfs_fs_šfØ*)
d©a
;

4270 
»t
;

4277 
»t
 = 
	`bŒfs_uuid_Œ“_™”©e
(
fs_šfo
, 
bŒfs_check_uuid_Œ“_’Œy
);

4278 ià(
»t
 < 0) {

4279 
	`bŒfs_w¬n
(
fs_šfo
, "™”©šg uuid_Œ“ fažed %d", 
»t
);

4280 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

4281  
»t
;

4283  
	`bŒfs_uuid_sÿn_kth»ad
(
d©a
);

4284 
	}
}

4286 
	$bŒfs_ü—‹_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

4288 
bŒfs_Œªs_hªdË
 *
Œªs
;

4289 
bŒfs_roÙ
 *
Œ“_roÙ
 = 
fs_šfo
->tree_root;

4290 
bŒfs_roÙ
 *
uuid_roÙ
;

4291 
sk_¡ruù
 *
sk
;

4292 
»t
;

4298 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
Œ“_roÙ
, 2);

4299 ià(
	`IS_ERR
(
Œªs
))

4300  
	`PTR_ERR
(
Œªs
);

4302 
uuid_roÙ
 = 
	`bŒfs_ü—‹_Œ“
(
Œªs
, 
fs_šfo
,

4303 
BTRFS_UUID_TREE_OBJECTID
);

4304 ià(
	`IS_ERR
(
uuid_roÙ
)) {

4305 
»t
 = 
	`PTR_ERR
(
uuid_roÙ
);

4306 
	`bŒfs_abÜt_Œª§ùiÚ
(
Œªs
, 
»t
);

4307 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4308  
»t
;

4311 
fs_šfo
->
uuid_roÙ
 = uuid_root;

4313 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4314 ià(
»t
)

4315  
»t
;

4317 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

4318 
sk
 = 
	`kth»ad_run
(
bŒfs_uuid_sÿn_kth»ad
, 
fs_šfo
, "btrfs-uuid");

4319 ià(
	`IS_ERR
(
sk
)) {

4321 
	`bŒfs_w¬n
(
fs_šfo
, "failedo start uuid_scanask");

4322 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

4323  
	`PTR_ERR
(
sk
);

4327 
	}
}

4329 
	$bŒfs_check_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

4331 
sk_¡ruù
 *
sk
;

4333 
	`down
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

4334 
sk
 = 
	`kth»ad_run
(
bŒfs_uuid_»sÿn_kth»ad
, 
fs_šfo
, "btrfs-uuid");

4335 ià(
	`IS_ERR
(
sk
)) {

4337 
	`bŒfs_w¬n
(
fs_šfo
, "failedo start uuid_rescanask");

4338 
	`up
(&
fs_šfo
->
uuid_Œ“_»sÿn_£m
);

4339  
	`PTR_ERR
(
sk
);

4343 
	}
}

4350 
	$bŒfs_shršk_deviû
(
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
)

4352 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

4353 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
dev_roÙ
;

4354 
bŒfs_Œªs_hªdË
 *
Œªs
;

4355 
bŒfs_dev_ex‹Á
 *
dev_ex‹Á
 = 
NULL
;

4356 
bŒfs_·th
 *
·th
;

4357 
u64
 
Ëngth
;

4358 
u64
 
chunk_off£t
;

4359 
»t
;

4360 
¦Ù
;

4361 
çžed
 = 0;

4362 
boÞ
 
»Œ›d
 = 
çl£
;

4363 
boÞ
 
checked_³ndšg_chunks
 = 
çl£
;

4364 
ex‹Á_bufãr
 *
l
;

4365 
bŒfs_key
 
key
;

4366 
bŒfs_su³r_block
 *
su³r_cÝy
 = 
fs_šfo
->super_copy;

4367 
u64
 
Þd_tÙ®
 = 
	`bŒfs_su³r_tÙ®_by‹s
(
su³r_cÝy
);

4368 
u64
 
Þd_size
 = 
	`bŒfs_deviû_g‘_tÙ®_by‹s
(
deviû
);

4369 
u64
 
diff
;

4371 
Ãw_size
 = 
	`round_down
Òew_size, 
fs_šfo
->
£ùÜsize
);

4372 
diff
 = 
	`round_down
(
Þd_size
 - 
Ãw_size
, 
fs_šfo
->
£ùÜsize
);

4374 ià(
deviû
->
is_tgtdev_fÜ_dev_»¶aû
)

4375  -
EINVAL
;

4377 
·th
 = 
	`bŒfs_®loc_·th
();

4378 ià(!
·th
)

4379  -
ENOMEM
;

4381 
·th
->
»ada
 = 
READA_FORWARD
;

4383 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4385 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

4386 ià(
deviû
->
wr™—bË
) {

4387 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 -ð
diff
;

4388 
	`©omic64_sub
(
diff
, &
fs_šfo
->
ä“_chunk_¥aû
);

4390 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4392 
agaš
:

4393 
key
.
objeùid
 = 
deviû
->
devid
;

4394 
key
.
off£t
 = (
u64
)-1;

4395 
key
.
ty³
 = 
BTRFS_DEV_EXTENT_KEY
;

4398 
	`mu‹x_lock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

4399 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

4400 ià(
»t
 < 0) {

4401 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

4402 
dÚe
;

4405 
»t
 = 
	`bŒfs_´evious_™em
(
roÙ
, 
·th
, 0, 
key
.
ty³
);

4406 ià(
»t
)

4407 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

4408 ià(
»t
 < 0)

4409 
dÚe
;

4410 ià(
»t
) {

4411 
»t
 = 0;

4412 
	`bŒfs_»Ëa£_·th
(
·th
);

4416 
l
 = 
·th
->
nodes
[0];

4417 
¦Ù
 = 
·th
->
¦Ùs
[0];

4418 
	`bŒfs_™em_key_to_ýu
(
l
, &
key
, 
·th
->
¦Ùs
[0]);

4420 ià(
key
.
objeùid
 !ð
deviû
->
devid
) {

4421 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

4422 
	`bŒfs_»Ëa£_·th
(
·th
);

4426 
dev_ex‹Á
 = 
	`bŒfs_™em_±r
(
l
, 
¦Ù
, 
bŒfs_dev_ex‹Á
);

4427 
Ëngth
 = 
	`bŒfs_dev_ex‹Á_Ëngth
(
l
, 
dev_ex‹Á
);

4429 ià(
key
.
off£t
 + 
Ëngth
 <ð
Ãw_size
) {

4430 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

4431 
	`bŒfs_»Ëa£_·th
(
·th
);

4435 
chunk_off£t
 = 
	`bŒfs_dev_ex‹Á_chunk_off£t
(
l
, 
dev_ex‹Á
);

4436 
	`bŒfs_»Ëa£_·th
(
·th
);

4438 
»t
 = 
	`bŒfs_»loÿ‹_chunk
(
fs_šfo
, 
chunk_off£t
);

4439 
	`mu‹x_uÆock
(&
fs_šfo
->
d–‘e_unu£d_bgs_mu‹x
);

4440 ià(
»t
 &&„‘ !ð-
ENOSPC
)

4441 
dÚe
;

4442 ià(
»t
 =ð-
ENOSPC
)

4443 
çžed
++;

4444 } 
key
.
off£t
-- > 0);

4446 ià(
çžed
 && !
»Œ›d
) {

4447 
çžed
 = 0;

4448 
»Œ›d
 = 
Œue
;

4449 
agaš
;

4450 } ià(
çžed
 && 
»Œ›d
) {

4451 
»t
 = -
ENOSPC
;

4452 
dÚe
;

4456 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 0);

4457 ià(
	`IS_ERR
(
Œªs
)) {

4458 
»t
 = 
	`PTR_ERR
(
Œªs
);

4459 
dÚe
;

4462 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4476 ià(!
checked_³ndšg_chunks
) {

4477 
u64
 
¡¬t
 = 
Ãw_size
;

4478 
u64
 
Ën
 = 
Þd_size
 - 
Ãw_size
;

4480 ià(
	`cÚšs_³ndšg_ex‹Á
(
Œªs
->
Œª§ùiÚ
, 
deviû
,

4481 &
¡¬t
, 
Ën
)) {

4482 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4483 
checked_³ndšg_chunks
 = 
Œue
;

4484 
çžed
 = 0;

4485 
»Œ›d
 = 
çl£
;

4486 
»t
 = 
	`bŒfs_comm™_Œª§ùiÚ
(
Œªs
);

4487 ià(
»t
)

4488 
dÚe
;

4489 
agaš
;

4493 
	`bŒfs_deviû_£t_disk_tÙ®_by‹s
(
deviû
, 
Ãw_size
);

4494 ià(
	`li¡_em±y
(&
deviû
->
»sized_li¡
))

4495 
	`li¡_add_ž
(&
deviû
->
»sized_li¡
,

4496 &
fs_šfo
->
fs_deviûs
->
»sized_deviûs
);

4498 
	`WARN_ON
(
diff
 > 
Þd_tÙ®
);

4499 
	`bŒfs_£t_su³r_tÙ®_by‹s
(
su³r_cÝy
,

4500 
	`round_down
(
Þd_tÙ®
 - 
diff
, 
fs_šfo
->
£ùÜsize
));

4501 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4504 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
deviû
);

4505 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

4506 
dÚe
:

4507 
	`bŒfs_ä“_·th
(
·th
);

4508 ià(
»t
) {

4509 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4510 
	`bŒfs_deviû_£t_tÙ®_by‹s
(
deviû
, 
Þd_size
);

4511 ià(
deviû
->
wr™—bË
)

4512 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ð
diff
;

4513 
	`©omic64_add
(
diff
, &
fs_šfo
->
ä“_chunk_¥aû
);

4514 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4516  
»t
;

4517 
	}
}

4519 
	$bŒfs_add_sy¡em_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
,

4520 
bŒfs_key
 *
key
,

4521 
bŒfs_chunk
 *
chunk
, 
™em_size
)

4523 
bŒfs_su³r_block
 *
su³r_cÝy
 = 
fs_šfo
->super_copy;

4524 
bŒfs_disk_key
 
disk_key
;

4525 
u32
 
¬¿y_size
;

4526 
u8
 *
±r
;

4528 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

4529 
¬¿y_size
 = 
	`bŒfs_su³r_sys_¬¿y_size
(
su³r_cÝy
);

4530 ià(
¬¿y_size
 + 
™em_size
 + (
disk_key
)

4531 > 
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
) {

4532 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4533  -
EFBIG
;

4536 
±r
 = 
su³r_cÝy
->
sys_chunk_¬¿y
 + 
¬¿y_size
;

4537 
	`bŒfs_ýu_key_to_disk
(&
disk_key
, 
key
);

4538 
	`memýy
(
±r
, &
disk_key
, (disk_key));

4539 
±r
 +ð(
disk_key
);

4540 
	`memýy
(
±r
, 
chunk
, 
™em_size
);

4541 
™em_size
 +ð(
disk_key
);

4542 
	`bŒfs_£t_su³r_sys_¬¿y_size
(
su³r_cÝy
, 
¬¿y_size
 + 
™em_size
);

4543 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

4546 
	}
}

4551 
	$bŒfs_cmp_deviû_šfo
(cÚ¡ *
a
, cÚ¡ *
b
)

4553 cÚ¡ 
bŒfs_deviû_šfo
 *
di_a
 = 
a
;

4554 cÚ¡ 
bŒfs_deviû_šfo
 *
di_b
 = 
b
;

4556 ià(
di_a
->
max_avaž
 > 
di_b
->max_avail)

4558 ià(
di_a
->
max_avaž
 < 
di_b
->max_avail)

4560 ià(
di_a
->
tÙ®_avaž
 > 
di_b
->total_avail)

4562 ià(
di_a
->
tÙ®_avaž
 < 
di_b
->total_avail)

4565 
	}
}

4567 
	$check_¿id56_šcom·t_æag
(
bŒfs_fs_šfo
 *
šfo
, 
u64
 
ty³
)

4569 ià(!(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
))

4572 
	`bŒfs_£t_fs_šcom·t
(
šfo
, 
RAID56
);

4573 
	}
}

4575 
	#BTRFS_MAX_DEVS
(
r
è((
	`BTRFS_MAX_ITEM_SIZE
Ô->
fs_šfo
) \

4576 - (
bŒfs_chunk
)) \

4577 / (
bŒfs_¡re
è+ 1)

	)

4579 
	#BTRFS_MAX_DEVS_SYS_CHUNK
 ((
BTRFS_SYSTEM_CHUNK_ARRAY_SIZE
 \

4580 - 2 * (
bŒfs_disk_key
) \

4581 - 2 * (
bŒfs_chunk
)) \

4582 / (
bŒfs_¡re
è+ 1)

	)

4584 
	$__bŒfs_®loc_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4585 
u64
 
¡¬t
, u64 
ty³
)

4587 
bŒfs_fs_šfo
 *
šfo
 = 
Œªs
->
fs_šfo
;

4588 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
šfo
->fs_devices;

4589 
bŒfs_deviû
 *
deviû
;

4590 
m­_lookup
 *
m­
 = 
NULL
;

4591 
ex‹Á_m­_Œ“
 *
em_Œ“
;

4592 
ex‹Á_m­
 *
em
;

4593 
bŒfs_deviû_šfo
 *
deviûs_šfo
 = 
NULL
;

4594 
u64
 
tÙ®_avaž
;

4595 
num_¡res
;

4596 
d©a_¡res
;

4598 
sub_¡res
;

4599 
dev_¡res
;

4600 
devs_max
;

4601 
devs_mš
;

4602 
devs_šüem’t
;

4603 
ncÝ›s
;

4604 
»t
;

4605 
u64
 
max_¡re_size
;

4606 
u64
 
max_chunk_size
;

4607 
u64
 
¡re_size
;

4608 
u64
 
num_by‹s
;

4609 
ndevs
;

4610 
i
;

4611 
j
;

4612 
šdex
;

4614 
	`BUG_ON
(!
	`®loc_´ofže_is_v®id
(
ty³
, 0));

4616 ià(
	`li¡_em±y
(&
fs_deviûs
->
®loc_li¡
))

4617  -
ENOSPC
;

4619 
šdex
 = 
	`__g‘_¿id_šdex
(
ty³
);

4621 
sub_¡res
 = 
bŒfs_¿id_¬¿y
[
šdex
].sub_stripes;

4622 
dev_¡res
 = 
bŒfs_¿id_¬¿y
[
šdex
].dev_stripes;

4623 
devs_max
 = 
bŒfs_¿id_¬¿y
[
šdex
].devs_max;

4624 
devs_mš
 = 
bŒfs_¿id_¬¿y
[
šdex
].devs_min;

4625 
devs_šüem’t
 = 
bŒfs_¿id_¬¿y
[
šdex
].devs_increment;

4626 
ncÝ›s
 = 
bŒfs_¿id_¬¿y
[
šdex
].ncopies;

4628 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_DATA
) {

4629 
max_¡re_size
 = 
SZ_1G
;

4630 
max_chunk_size
 = 10 * 
max_¡re_size
;

4631 ià(!
devs_max
)

4632 
devs_max
 = 
	`BTRFS_MAX_DEVS
(
šfo
->
chunk_roÙ
);

4633 } ià(
ty³
 & 
BTRFS_BLOCK_GROUP_METADATA
) {

4635 ià(
fs_deviûs
->
tÙ®_rw_by‹s
 > 50ULL * 
SZ_1G
)

4636 
max_¡re_size
 = 
SZ_1G
;

4638 
max_¡re_size
 = 
SZ_256M
;

4639 
max_chunk_size
 = 
max_¡re_size
;

4640 ià(!
devs_max
)

4641 
devs_max
 = 
	`BTRFS_MAX_DEVS
(
šfo
->
chunk_roÙ
);

4642 } ià(
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

4643 
max_¡re_size
 = 
SZ_32M
;

4644 
max_chunk_size
 = 2 * 
max_¡re_size
;

4645 ià(!
devs_max
)

4646 
devs_max
 = 
BTRFS_MAX_DEVS_SYS_CHUNK
;

4648 
	`bŒfs_”r
(
šfo
, "invalid chunkype 0x%llx„equested",

4649 
ty³
);

4650 
	`BUG_ON
(1);

4654 
max_chunk_size
 = 
	`mš
(
	`div_çùÜ
(
fs_deviûs
->
tÙ®_rw_by‹s
, 1),

4655 
max_chunk_size
);

4657 
deviûs_šfo
 = 
	`kÿÎoc
(
fs_deviûs
->
rw_deviûs
, (*devices_info),

4658 
GFP_NOFS
);

4659 ià(!
deviûs_šfo
)

4660  -
ENOMEM
;

4666 
ndevs
 = 0;

4667 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
®loc_li¡
, 
dev_®loc_li¡
) {

4668 
u64
 
max_avaž
;

4669 
u64
 
dev_off£t
;

4671 ià(!
deviû
->
wr™—bË
) {

4672 
	`WARN
(1, 
KERN_ERR


4677 ià(!
deviû
->
š_fs_m‘ad©a
 ||

4678 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
)

4681 ià(
deviû
->
tÙ®_by‹s
 > deviû->
by‹s_u£d
)

4682 
tÙ®_avaž
 = 
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
;

4684 
tÙ®_avaž
 = 0;

4687 ià(
tÙ®_avaž
 == 0)

4690 
»t
 = 
	`fšd_ä“_dev_ex‹Á
(
Œªs
, 
deviû
,

4691 
max_¡re_size
 * 
dev_¡res
,

4692 &
dev_off£t
, &
max_avaž
);

4693 ià(
»t
 &&„‘ !ð-
ENOSPC
)

4694 
”rÜ
;

4696 ià(
»t
 == 0)

4697 
max_avaž
 = 
max_¡re_size
 * 
dev_¡res
;

4699 ià(
max_avaž
 < 
BTRFS_STRIPE_LEN
 * 
dev_¡res
)

4702 ià(
ndevs
 =ð
fs_deviûs
->
rw_deviûs
) {

4703 
	`WARN
(1, "%s: found morehan %llu devices\n",

4704 
__func__
, 
fs_deviûs
->
rw_deviûs
);

4707 
deviûs_šfo
[
ndevs
].
dev_off£t
 = dev_offset;

4708 
deviûs_šfo
[
ndevs
].
max_avaž
 = max_avail;

4709 
deviûs_šfo
[
ndevs
].
tÙ®_avaž
 =otal_avail;

4710 
deviûs_šfo
[
ndevs
].
dev
 = 
deviû
;

4711 ++
ndevs
;

4717 
	`sÜt
(
deviûs_šfo
, 
ndevs
, (
bŒfs_deviû_šfo
),

4718 
bŒfs_cmp_deviû_šfo
, 
NULL
);

4721 
ndevs
 = 
	`round_down
Òdevs, 
devs_šüem’t
);

4723 ià(
ndevs
 < 
devs_šüem’t
 * 
sub_¡res
 ||‚dev < 
devs_mš
) {

4724 
»t
 = -
ENOSPC
;

4725 
”rÜ
;

4728 
ndevs
 = 
	`mš
Òdevs, 
devs_max
);

4734 
¡re_size
 = 
deviûs_šfo
[
ndevs
-1].
max_avaž
;

4735 
num_¡res
 = 
ndevs
 * 
dev_¡res
;

4741 
d©a_¡res
 = 
num_¡res
 / 
ncÝ›s
;

4743 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
)

4744 
d©a_¡res
 = 
num_¡res
 - 1;

4746 ià(
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

4747 
d©a_¡res
 = 
num_¡res
 - 2;

4754 ià(
¡re_size
 * 
d©a_¡res
 > 
max_chunk_size
) {

4755 
u64
 
mask
 = (1ULL << 24) - 1;

4757 
¡re_size
 = 
	`div_u64
(
max_chunk_size
, 
d©a_¡res
);

4760 
¡re_size
 = (¡re_siz+ 
mask
) & ~mask;

4765 ià(
¡re_size
 > 
deviûs_šfo
[
ndevs
-1].
max_avaž
)

4766 
¡re_size
 = 
deviûs_šfo
[
ndevs
-1].
max_avaž
;

4769 
¡re_size
 = 
	`div_u64
(¡re_size, 
dev_¡res
);

4772 
¡re_size
 = 
	`round_down
(¡re_size, 
BTRFS_STRIPE_LEN
);

4774 
m­
 = 
	`km®loc
(
	`m­_lookup_size
(
num_¡res
), 
GFP_NOFS
);

4775 ià(!
m­
) {

4776 
»t
 = -
ENOMEM
;

4777 
”rÜ
;

4779 
m­
->
num_¡res
 =‚um_stripes;

4781 
i
 = 0; i < 
ndevs
; ++i) {

4782 
j
 = 0; j < 
dev_¡res
; ++j) {

4783 
s
 = 
i
 * 
dev_¡res
 + 
j
;

4784 
m­
->
¡res
[
s
].
dev
 = 
deviûs_šfo
[
i
].dev;

4785 
m­
->
¡res
[
s
].
physiÿl
 = 
deviûs_šfo
[
i
].
dev_off£t
 +

4786 
j
 * 
¡re_size
;

4789 
m­
->
¡re_Ën
 = 
BTRFS_STRIPE_LEN
;

4790 
m­
->
io_®ign
 = 
BTRFS_STRIPE_LEN
;

4791 
m­
->
io_width
 = 
BTRFS_STRIPE_LEN
;

4792 
m­
->
ty³
 =ype;

4793 
m­
->
sub_¡res
 = sub_stripes;

4795 
num_by‹s
 = 
¡re_size
 * 
d©a_¡res
;

4797 
	`Œaû_bŒfs_chunk_®loc
(
šfo
, 
m­
, 
¡¬t
, 
num_by‹s
);

4799 
em
 = 
	`®loc_ex‹Á_m­
();

4800 ià(!
em
) {

4801 
	`kä“
(
m­
);

4802 
»t
 = -
ENOMEM
;

4803 
”rÜ
;

4805 
	`£t_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
);

4806 
em
->
m­_lookup
 = 
m­
;

4807 
em
->
¡¬t
 = start;

4808 
em
->
Ën
 = 
num_by‹s
;

4809 
em
->
block_¡¬t
 = 0;

4810 
em
->
block_Ën
 =ƒm->
Ën
;

4811 
em
->
Üig_block_Ën
 = 
¡re_size
;

4813 
em_Œ“
 = &
šfo
->
m­pšg_Œ“
.
m­_Œ“
;

4814 
	`wr™e_lock
(&
em_Œ“
->
lock
);

4815 
»t
 = 
	`add_ex‹Á_m­pšg
(
em_Œ“
, 
em
, 0);

4816 ià(!
»t
) {

4817 
	`li¡_add_ž
(&
em
->
li¡
, &
Œªs
->
Œª§ùiÚ
->
³ndšg_chunks
);

4818 
	`»fcouÁ_šc
(&
em
->
»fs
);

4820 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

4821 ià(
»t
) {

4822 
	`ä“_ex‹Á_m­
(
em
);

4823 
”rÜ
;

4826 
»t
 = 
	`bŒfs_make_block_group
(
Œªs
, 
šfo
, 0, 
ty³
, 
¡¬t
, 
num_by‹s
);

4827 ià(
»t
)

4828 
”rÜ_d–_ex‹Á
;

4830 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

4831 
num_by‹s
 = 
m­
->
¡res
[
i
].
dev
->
by‹s_u£d
 + 
¡re_size
;

4832 
	`bŒfs_deviû_£t_by‹s_u£d
(
m­
->
¡res
[
i
].
dev
, 
num_by‹s
);

4835 
	`©omic64_sub
(
¡re_size
 * 
m­
->
num_¡res
, &
šfo
->
ä“_chunk_¥aû
);

4837 
	`ä“_ex‹Á_m­
(
em
);

4838 
	`check_¿id56_šcom·t_æag
(
šfo
, 
ty³
);

4840 
	`kä“
(
deviûs_šfo
);

4843 
”rÜ_d–_ex‹Á
:

4844 
	`wr™e_lock
(&
em_Œ“
->
lock
);

4845 
	`»move_ex‹Á_m­pšg
(
em_Œ“
, 
em
);

4846 
	`wr™e_uÆock
(&
em_Œ“
->
lock
);

4849 
	`ä“_ex‹Á_m­
(
em
);

4851 
	`ä“_ex‹Á_m­
(
em
);

4853 
	`ä“_ex‹Á_m­
(
em
);

4854 
”rÜ
:

4855 
	`kä“
(
deviûs_šfo
);

4856  
»t
;

4857 
	}
}

4859 
	$bŒfs_fšish_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4860 
bŒfs_fs_šfo
 *
fs_šfo
,

4861 
u64
 
chunk_off£t
, u64 
chunk_size
)

4863 
bŒfs_roÙ
 *
ex‹Á_roÙ
 = 
fs_šfo
->extent_root;

4864 
bŒfs_roÙ
 *
chunk_roÙ
 = 
fs_šfo
->chunk_root;

4865 
bŒfs_key
 
key
;

4866 
bŒfs_deviû
 *
deviû
;

4867 
bŒfs_chunk
 *
chunk
;

4868 
bŒfs_¡re
 *
¡re
;

4869 
ex‹Á_m­
 *
em
;

4870 
m­_lookup
 *
m­
;

4871 
size_t
 
™em_size
;

4872 
u64
 
dev_off£t
;

4873 
u64
 
¡re_size
;

4874 
i
 = 0;

4875 
»t
 = 0;

4877 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 
chunk_size
);

4878 ià(
	`IS_ERR
(
em
))

4879  
	`PTR_ERR
(
em
);

4881 
m­
 = 
em
->
m­_lookup
;

4882 
™em_size
 = 
	`bŒfs_chunk_™em_size
(
m­
->
num_¡res
);

4883 
¡re_size
 = 
em
->
Üig_block_Ën
;

4885 
chunk
 = 
	`kz®loc
(
™em_size
, 
GFP_NOFS
);

4886 ià(!
chunk
) {

4887 
»t
 = -
ENOMEM
;

4888 
out
;

4898 
	`mu‹x_lock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4899 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

4900 
deviû
 = 
m­
->
¡res
[
i
].
dev
;

4901 
dev_off£t
 = 
m­
->
¡res
[
i
].
physiÿl
;

4903 
»t
 = 
	`bŒfs_upd©e_deviû
(
Œªs
, 
deviû
);

4904 ià(
»t
)

4906 
»t
 = 
	`bŒfs_®loc_dev_ex‹Á
(
Œªs
, 
deviû
, 
chunk_off£t
,

4907 
dev_off£t
, 
¡re_size
);

4908 ià(
»t
)

4911 ià(
»t
) {

4912 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4913 
out
;

4916 
¡re
 = &
chunk
->stripe;

4917 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

4918 
deviû
 = 
m­
->
¡res
[
i
].
dev
;

4919 
dev_off£t
 = 
m­
->
¡res
[
i
].
physiÿl
;

4921 
	`bŒfs_£t_¡ack_¡re_devid
(
¡re
, 
deviû
->
devid
);

4922 
	`bŒfs_£t_¡ack_¡re_off£t
(
¡re
, 
dev_off£t
);

4923 
	`memýy
(
¡re
->
dev_uuid
, 
deviû
->
uuid
, 
BTRFS_UUID_SIZE
);

4924 
¡re
++;

4926 
	`mu‹x_uÆock
(&
fs_šfo
->
fs_deviûs
->
deviû_li¡_mu‹x
);

4928 
	`bŒfs_£t_¡ack_chunk_Ëngth
(
chunk
, 
chunk_size
);

4929 
	`bŒfs_£t_¡ack_chunk_owÃr
(
chunk
, 
ex‹Á_roÙ
->
roÙ_key
.
objeùid
);

4930 
	`bŒfs_£t_¡ack_chunk_¡re_Ën
(
chunk
, 
m­
->
¡re_Ën
);

4931 
	`bŒfs_£t_¡ack_chunk_ty³
(
chunk
, 
m­
->
ty³
);

4932 
	`bŒfs_£t_¡ack_chunk_num_¡res
(
chunk
, 
m­
->
num_¡res
);

4933 
	`bŒfs_£t_¡ack_chunk_io_®ign
(
chunk
, 
m­
->
¡re_Ën
);

4934 
	`bŒfs_£t_¡ack_chunk_io_width
(
chunk
, 
m­
->
¡re_Ën
);

4935 
	`bŒfs_£t_¡ack_chunk_£ùÜ_size
(
chunk
, 
fs_šfo
->
£ùÜsize
);

4936 
	`bŒfs_£t_¡ack_chunk_sub_¡res
(
chunk
, 
m­
->
sub_¡res
);

4938 
key
.
objeùid
 = 
BTRFS_FIRST_CHUNK_TREE_OBJECTID
;

4939 
key
.
ty³
 = 
BTRFS_CHUNK_ITEM_KEY
;

4940 
key
.
off£t
 = 
chunk_off£t
;

4942 
»t
 = 
	`bŒfs_š£¹_™em
(
Œªs
, 
chunk_roÙ
, &
key
, 
chunk
, 
™em_size
);

4943 ià(
»t
 =ð0 && 
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) {

4948 
»t
 = 
	`bŒfs_add_sy¡em_chunk
(
fs_šfo
, &
key
, 
chunk
, 
™em_size
);

4951 
out
:

4952 
	`kä“
(
chunk
);

4953 
	`ä“_ex‹Á_m­
(
em
);

4954  
»t
;

4955 
	}
}

4964 
	$bŒfs_®loc_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4965 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
)

4967 
u64
 
chunk_off£t
;

4969 
	`ASSERT
(
	`mu‹x_is_locked
(&
fs_šfo
->
chunk_mu‹x
));

4970 
chunk_off£t
 = 
	`fšd_Ãxt_chunk
(
fs_šfo
);

4971  
	`__bŒfs_®loc_chunk
(
Œªs
, 
chunk_off£t
, 
ty³
);

4972 
	}
}

4974 
nošlše
 
	$š™_fœ¡_rw_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

4975 
bŒfs_fs_šfo
 *
fs_šfo
)

4977 
u64
 
chunk_off£t
;

4978 
u64
 
sys_chunk_off£t
;

4979 
u64
 
®loc_´ofže
;

4980 
»t
;

4982 
chunk_off£t
 = 
	`fšd_Ãxt_chunk
(
fs_šfo
);

4983 
®loc_´ofže
 = 
	`bŒfs_m‘ad©a_®loc_´ofže
(
fs_šfo
);

4984 
»t
 = 
	`__bŒfs_®loc_chunk
(
Œªs
, 
chunk_off£t
, 
®loc_´ofže
);

4985 ià(
»t
)

4986  
»t
;

4988 
sys_chunk_off£t
 = 
	`fšd_Ãxt_chunk
(
fs_šfo
);

4989 
®loc_´ofže
 = 
	`bŒfs_sy¡em_®loc_´ofže
(
fs_šfo
);

4990 
»t
 = 
	`__bŒfs_®loc_chunk
(
Œªs
, 
sys_chunk_off£t
, 
®loc_´ofže
);

4991  
»t
;

4992 
	}
}

4994 
šlše
 
	$bŒfs_chunk_max_”rÜs
(
m­_lookup
 *
m­
)

4996 
max_”rÜs
;

4998 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID1
 |

4999 
BTRFS_BLOCK_GROUP_RAID10
 |

5000 
BTRFS_BLOCK_GROUP_RAID5
 |

5001 
BTRFS_BLOCK_GROUP_DUP
)) {

5002 
max_”rÜs
 = 1;

5003 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
) {

5004 
max_”rÜs
 = 2;

5006 
max_”rÜs
 = 0;

5009  
max_”rÜs
;

5010 
	}
}

5012 
	$bŒfs_chunk_»adÚly
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
)

5014 
ex‹Á_m­
 *
em
;

5015 
m­_lookup
 *
m­
;

5016 
»adÚly
 = 0;

5017 
miss_ndevs
 = 0;

5018 
i
;

5020 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
chunk_off£t
, 1);

5021 ià(
	`IS_ERR
(
em
))

5024 
m­
 = 
em
->
m­_lookup
;

5025 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

5026 ià(
m­
->
¡res
[
i
].
dev
->
missšg
) {

5027 
miss_ndevs
++;

5031 ià(!
m­
->
¡res
[
i
].
dev
->
wr™—bË
) {

5032 
»adÚly
 = 1;

5033 
’d
;

5042 ià(
miss_ndevs
 > 
	`bŒfs_chunk_max_”rÜs
(
m­
))

5043 
»adÚly
 = 1;

5044 
’d
:

5045 
	`ä“_ex‹Á_m­
(
em
);

5046  
»adÚly
;

5047 
	}
}

5049 
	$bŒfs_m­pšg_š™
(
bŒfs_m­pšg_Œ“
 *
Œ“
)

5051 
	`ex‹Á_m­_Œ“_š™
(&
Œ“
->
m­_Œ“
);

5052 
	}
}

5054 
	$bŒfs_m­pšg_Œ“_ä“
(
bŒfs_m­pšg_Œ“
 *
Œ“
)

5056 
ex‹Á_m­
 *
em
;

5059 
	`wr™e_lock
(&
Œ“
->
m­_Œ“
.
lock
);

5060 
em
 = 
	`lookup_ex‹Á_m­pšg
(&
Œ“
->
m­_Œ“
, 0, (
u64
)-1);

5061 ià(
em
)

5062 
	`»move_ex‹Á_m­pšg
(&
Œ“
->
m­_Œ“
, 
em
);

5063 
	`wr™e_uÆock
(&
Œ“
->
m­_Œ“
.
lock
);

5064 ià(!
em
)

5067 
	`ä“_ex‹Á_m­
(
em
);

5069 
	`ä“_ex‹Á_m­
(
em
);

5071 
	}
}

5073 
	$bŒfs_num_cÝ›s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ën
)

5075 
ex‹Á_m­
 *
em
;

5076 
m­_lookup
 *
m­
;

5077 
»t
;

5079 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ën
);

5080 ià(
	`IS_ERR
(
em
))

5089 
m­
 = 
em
->
m­_lookup
;

5090 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_DUP
 | 
BTRFS_BLOCK_GROUP_RAID1
))

5091 
»t
 = 
m­
->
num_¡res
;

5092 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
)

5093 
»t
 = 
m­
->
sub_¡res
;

5094 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
)

5095 
»t
 = 2;

5096 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

5097 
»t
 = 3;

5099 
»t
 = 1;

5100 
	`ä“_ex‹Á_m­
(
em
);

5102 
	`bŒfs_dev_»¶aû_lock
(&
fs_šfo
->
dev_»¶aû
, 0);

5103 ià(
	`bŒfs_dev_»¶aû_is_Úgošg
(&
fs_šfo
->
dev_»¶aû
) &&

5104 
fs_šfo
->
dev_»¶aû
.
tgtdev
)

5105 
»t
++;

5106 
	`bŒfs_dev_»¶aû_uÆock
(&
fs_šfo
->
dev_»¶aû
, 0);

5108  
»t
;

5109 
	}
}

5111 
	$bŒfs_fuÎ_¡re_Ën
(
bŒfs_fs_šfo
 *
fs_šfo
,

5112 
u64
 
logiÿl
)

5114 
ex‹Á_m­
 *
em
;

5115 
m­_lookup
 *
m­
;

5116 
Ën
 = 
fs_šfo
->
£ùÜsize
;

5118 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ën
);

5120 ià(!
	`WARN_ON
(
	`IS_ERR
(
em
))) {

5121 
m­
 = 
em
->
m­_lookup
;

5122 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

5123 
Ën
 = 
m­
->
¡re_Ën
 * 
	`Ä_d©a_¡res
(map);

5124 
	`ä“_ex‹Á_m­
(
em
);

5126  
Ën
;

5127 
	}
}

5129 
	$bŒfs_is_·r™y_mœrÜ
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ën
)

5131 
ex‹Á_m­
 *
em
;

5132 
m­_lookup
 *
m­
;

5133 
»t
 = 0;

5135 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ën
);

5137 if(!
	`WARN_ON
(
	`IS_ERR
(
em
))) {

5138 
m­
 = 
em
->
m­_lookup
;

5139 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
)

5140 
»t
 = 1;

5141 
	`ä“_ex‹Á_m­
(
em
);

5143  
»t
;

5144 
	}
}

5146 
	$fšd_live_mœrÜ
(
bŒfs_fs_šfo
 *
fs_šfo
,

5147 
m­_lookup
 *
m­
, 
fœ¡
, 
num
,

5148 
Ýtim®
, 
dev_»¶aû_is_Úgošg
)

5150 
i
;

5151 
tÞ”ªû
;

5152 
bŒfs_deviû
 *
¤cdev
;

5154 ià(
dev_»¶aû_is_Úgošg
 &&

5155 
fs_šfo
->
dev_»¶aû
.
cÚt_»adšg_äom_¤cdev_mode
 ==

5156 
BTRFS_DEV_REPLACE_ITEM_CONT_READING_FROM_SRCDEV_MODE_AVOID
)

5157 
¤cdev
 = 
fs_šfo
->
dev_»¶aû
.srcdev;

5159 
¤cdev
 = 
NULL
;

5166 
tÞ”ªû
 = 0;olerance < 2;olerance++) {

5167 ià(
m­
->
¡res
[
Ýtim®
].
dev
->
bdev
 &&

5168 (
tÞ”ªû
 || 
m­
->
¡res
[
Ýtim®
].
dev
 !ð
¤cdev
))

5169  
Ýtim®
;

5170 
i
 = 
fœ¡
; i < fœ¡ + 
num
; i++) {

5171 ià(
m­
->
¡res
[
i
].
dev
->
bdev
 &&

5172 (
tÞ”ªû
 || 
m­
->
¡res
[
i
].
dev
 !ð
¤cdev
))

5173  
i
;

5180  
Ýtim®
;

5181 
	}
}

5183 
šlše
 
	$·r™y_sm®Ër
(
u64
 
a
, u64 
b
)

5185  
a
 > 
b
;

5186 
	}
}

5189 
	$sÜt_·r™y_¡res
(
bŒfs_bio
 *
bbio
, 
num_¡res
)

5191 
bŒfs_bio_¡re
 
s
;

5192 
i
;

5193 
u64
 
l
;

5194 
agaš
 = 1;

5196 
agaš
) {

5197 
agaš
 = 0;

5198 
i
 = 0; i < 
num_¡res
 - 1; i++) {

5199 ià(
	`·r™y_sm®Ër
(
bbio
->
¿id_m­
[
i
],

5200 
bbio
->
¿id_m­
[
i
+1])) {

5201 
s
 = 
bbio
->
¡res
[
i
];

5202 
l
 = 
bbio
->
¿id_m­
[
i
];

5203 
bbio
->
¡res
[
i
] = bbio->stripes[i+1];

5204 
bbio
->
¿id_m­
[
i
] = bbio->raid_map[i+1];

5205 
bbio
->
¡res
[
i
+1] = 
s
;

5206 
bbio
->
¿id_m­
[
i
+1] = 
l
;

5208 
agaš
 = 1;

5212 
	}
}

5214 
bŒfs_bio
 *
	$®loc_bŒfs_bio
(
tÙ®_¡res
, 
»®_¡res
)

5216 
bŒfs_bio
 *
bbio
 = 
	`kz®loc
(

5218 (
bŒfs_bio
) +

5220 (
bŒfs_bio_¡re
è* (
tÙ®_¡res
) +

5222 (è* (
»®_¡res
) +

5227 (
u64
è* (
tÙ®_¡res
),

5228 
GFP_NOFS
|
__GFP_NOFAIL
);

5230 
	`©omic_£t
(&
bbio
->
”rÜ
, 0);

5231 
	`»fcouÁ_£t
(&
bbio
->
»fs
, 1);

5233  
bbio
;

5234 
	}
}

5236 
	$bŒfs_g‘_bbio
(
bŒfs_bio
 *
bbio
)

5238 
	`WARN_ON
(!
	`»fcouÁ_»ad
(&
bbio
->
»fs
));

5239 
	`»fcouÁ_šc
(&
bbio
->
»fs
);

5240 
	}
}

5242 
	$bŒfs_put_bbio
(
bŒfs_bio
 *
bbio
)

5244 ià(!
bbio
)

5246 ià(
	`»fcouÁ_dec_ªd_‹¡
(&
bbio
->
»fs
))

5247 
	`kä“
(
bbio
);

5248 
	}
}

5255 
	$__bŒfs_m­_block_fÜ_disÿrd
(
bŒfs_fs_šfo
 *
fs_šfo
,

5256 
u64
 
logiÿl
, u64 
Ëngth
,

5257 
bŒfs_bio
 **
bbio_»t
)

5259 
ex‹Á_m­
 *
em
;

5260 
m­_lookup
 *
m­
;

5261 
bŒfs_bio
 *
bbio
;

5262 
u64
 
off£t
;

5263 
u64
 
¡re_Ä
;

5264 
u64
 
¡re_Ä_’d
;

5265 
u64
 
¡re_’d_off£t
;

5266 
u64
 
¡re_út
;

5267 
u64
 
¡re_Ën
;

5268 
u64
 
¡re_off£t
;

5269 
u64
 
num_¡res
;

5270 
u32
 
¡re_šdex
;

5271 
u32
 
çùÜ
 = 0;

5272 
u32
 
sub_¡res
 = 0;

5273 
u64
 
¡res_³r_dev
 = 0;

5274 
u32
 
»maššg_¡res
 = 0;

5275 
u32
 
Ï¡_¡re
 = 0;

5276 
»t
 = 0;

5277 
i
;

5280 
	`ASSERT
(
bbio_»t
);

5282 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, 
Ëngth
);

5283 ià(
	`IS_ERR
(
em
))

5284  
	`PTR_ERR
(
em
);

5286 
m­
 = 
em
->
m­_lookup
;

5288 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

5289 
»t
 = -
EOPNOTSUPP
;

5290 
out
;

5293 
off£t
 = 
logiÿl
 - 
em
->
¡¬t
;

5294 
Ëngth
 = 
	`mš_t
(
u64
, 
em
->
Ën
 - 
off£t
,†ength);

5296 
¡re_Ën
 = 
m­
->stripe_len;

5301 
¡re_Ä
 = 
	`div64_u64
(
off£t
, 
¡re_Ën
);

5304 
¡re_off£t
 = 
off£t
 - 
¡re_Ä
 * 
¡re_Ën
;

5306 
¡re_Ä_’d
 = 
	`round_up
(
off£t
 + 
Ëngth
, 
m­
->
¡re_Ën
);

5307 
¡re_Ä_’d
 = 
	`div64_u64
(¡re_Ä_’d, 
m­
->
¡re_Ën
);

5308 
¡re_út
 = 
¡re_Ä_’d
 - 
¡re_Ä
;

5309 
¡re_’d_off£t
 = 
¡re_Ä_’d
 * 
m­
->
¡re_Ën
 -

5310 (
off£t
 + 
Ëngth
);

5316 
num_¡res
 = 1;

5317 
¡re_šdex
 = 0;

5318 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

5319 
BTRFS_BLOCK_GROUP_RAID10
)) {

5320 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
)

5321 
sub_¡res
 = 1;

5323 
sub_¡res
 = 
m­
->sub_stripes;

5325 
çùÜ
 = 
m­
->
num_¡res
 / 
sub_¡res
;

5326 
num_¡res
 = 
	`mš_t
(
u64
, 
m­
->num_stripes,

5327 
sub_¡res
 * 
¡re_út
);

5328 
¡re_Ä
 = 
	`div_u64_»m
(¡re_Ä, 
çùÜ
, &
¡re_šdex
);

5329 
¡re_šdex
 *ð
sub_¡res
;

5330 
¡res_³r_dev
 = 
	`div_u64_»m
(
¡re_út
, 
çùÜ
,

5331 &
»maššg_¡res
);

5332 
	`div_u64_»m
(
¡re_Ä_’d
 - 1, 
çùÜ
, &
Ï¡_¡re
);

5333 
Ï¡_¡re
 *ð
sub_¡res
;

5334 } ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID1
 |

5335 
BTRFS_BLOCK_GROUP_DUP
)) {

5336 
num_¡res
 = 
m­
->num_stripes;

5338 
¡re_Ä
 = 
	`div_u64_»m
(¡re_Ä, 
m­
->
num_¡res
,

5339 &
¡re_šdex
);

5342 
bbio
 = 
	`®loc_bŒfs_bio
(
num_¡res
, 0);

5343 ià(!
bbio
) {

5344 
»t
 = -
ENOMEM
;

5345 
out
;

5348 
i
 = 0; i < 
num_¡res
; i++) {

5349 
bbio
->
¡res
[
i
].
physiÿl
 =

5350 
m­
->
¡res
[
¡re_šdex
].
physiÿl
 +

5351 
¡re_off£t
 + 
¡re_Ä
 * 
m­
->
¡re_Ën
;

5352 
bbio
->
¡res
[
i
].
dev
 = 
m­
->¡res[
¡re_šdex
].dev;

5354 ià(
m­
->
ty³
 & (
BTRFS_BLOCK_GROUP_RAID0
 |

5355 
BTRFS_BLOCK_GROUP_RAID10
)) {

5356 
bbio
->
¡res
[
i
].
Ëngth
 = 
¡res_³r_dev
 *

5357 
m­
->
¡re_Ën
;

5359 ià(
i
 / 
sub_¡res
 < 
»maššg_¡res
)

5360 
bbio
->
¡res
[
i
].
Ëngth
 +=

5361 
m­
->
¡re_Ën
;

5371 ià(
i
 < 
sub_¡res
)

5372 
bbio
->
¡res
[
i
].
Ëngth
 -=

5373 
¡re_off£t
;

5375 ià(
¡re_šdex
 >ð
Ï¡_¡re
 &&

5376 
¡re_šdex
 <ð(
Ï¡_¡re
 +

5377 
sub_¡res
 - 1))

5378 
bbio
->
¡res
[
i
].
Ëngth
 -=

5379 
¡re_’d_off£t
;

5381 ià(
i
 =ð
sub_¡res
 - 1)

5382 
¡re_off£t
 = 0;

5384 
bbio
->
¡res
[
i
].
Ëngth
 =†ength;

5387 
¡re_šdex
++;

5388 ià(
¡re_šdex
 =ð
m­
->
num_¡res
) {

5389 
¡re_šdex
 = 0;

5390 
¡re_Ä
++;

5394 *
bbio_»t
 = 
bbio
;

5395 
bbio
->
m­_ty³
 = 
m­
->
ty³
;

5396 
bbio
->
num_¡res
 =‚um_stripes;

5397 
out
:

5398 
	`ä“_ex‹Á_m­
(
em
);

5399  
»t
;

5400 
	}
}

5415 
	$g‘_exŒa_mœrÜ_äom_»¶aû
(
bŒfs_fs_šfo
 *
fs_šfo
,

5416 
u64
 
logiÿl
, u64 
Ëngth
,

5417 
u64
 
¤cdev_devid
, *
mœrÜ_num
,

5418 
u64
 *
physiÿl
)

5420 
bŒfs_bio
 *
bbio
 = 
NULL
;

5421 
num_¡res
;

5422 
šdex_¤cdev
 = 0;

5423 
found
 = 0;

5424 
u64
 
physiÿl_of_found
 = 0;

5425 
i
;

5426 
»t
 = 0;

5428 
»t
 = 
	`__bŒfs_m­_block
(
fs_šfo
, 
BTRFS_MAP_GET_READ_MIRRORS
,

5429 
logiÿl
, &
Ëngth
, &
bbio
, 0, 0);

5430 ià(
»t
) {

5431 
	`ASSERT
(
bbio
 =ð
NULL
);

5432  
»t
;

5435 
num_¡res
 = 
bbio
->num_stripes;

5436 ià(*
mœrÜ_num
 > 
num_¡res
) {

5442 
	`bŒfs_put_bbio
(
bbio
);

5443  -
EIO
;

5451 
i
 = 0; i < 
num_¡res
; i++) {

5452 ià(
bbio
->
¡res
[
i
].
dev
->
devid
 !ð
¤cdev_devid
)

5459 ià(
found
 &&

5460 
physiÿl_of_found
 <ð
bbio
->
¡res
[
i
].
physiÿl
)

5463 
šdex_¤cdev
 = 
i
;

5464 
found
 = 1;

5465 
physiÿl_of_found
 = 
bbio
->
¡res
[
i
].
physiÿl
;

5468 
	`bŒfs_put_bbio
(
bbio
);

5470 
	`ASSERT
(
found
);

5471 ià(!
found
)

5472  -
EIO
;

5474 *
mœrÜ_num
 = 
šdex_¤cdev
 + 1;

5475 *
physiÿl
 = 
physiÿl_of_found
;

5476  
»t
;

5477 
	}
}

5479 
	$hªdË_Ýs_Ú_dev_»¶aû
(
bŒfs_m­_Ý
 
Ý
,

5480 
bŒfs_bio
 **
bbio_»t
,

5481 
bŒfs_dev_»¶aû
 *
dev_»¶aû
,

5482 *
num_¡res_»t
, *
max_”rÜs_»t
)

5484 
bŒfs_bio
 *
bbio
 = *
bbio_»t
;

5485 
u64
 
¤cdev_devid
 = 
dev_»¶aû
->
¤cdev
->
devid
;

5486 
tgtdev_šdexes
 = 0;

5487 
num_¡res
 = *
num_¡res_»t
;

5488 
max_”rÜs
 = *
max_”rÜs_»t
;

5489 
i
;

5491 ià(
Ý
 =ð
BTRFS_MAP_WRITE
) {

5492 
šdex_wh”e_to_add
;

5505 
šdex_wh”e_to_add
 = 
num_¡res
;

5506 
i
 = 0; i < 
num_¡res
; i++) {

5507 ià(
bbio
->
¡res
[
i
].
dev
->
devid
 =ð
¤cdev_devid
) {

5509 
bŒfs_bio_¡re
 *
Ãw
 =

5510 
bbio
->
¡res
 + 
šdex_wh”e_to_add
;

5511 
bŒfs_bio_¡re
 *
Þd
 =

5512 
bbio
->
¡res
 + 
i
;

5514 
Ãw
->
physiÿl
 = 
Þd
->physical;

5515 
Ãw
->
Ëngth
 = 
Þd
->length;

5516 
Ãw
->
dev
 = 
dev_»¶aû
->
tgtdev
;

5517 
bbio
->
tgtdev_m­
[
i
] = 
šdex_wh”e_to_add
;

5518 
šdex_wh”e_to_add
++;

5519 
max_”rÜs
++;

5520 
tgtdev_šdexes
++;

5523 
num_¡res
 = 
šdex_wh”e_to_add
;

5524 } ià(
Ý
 =ð
BTRFS_MAP_GET_READ_MIRRORS
) {

5525 
šdex_¤cdev
 = 0;

5526 
found
 = 0;

5527 
u64
 
physiÿl_of_found
 = 0;

5536 
i
 = 0; i < 
num_¡res
; i++) {

5537 ià(
bbio
->
¡res
[
i
].
dev
->
devid
 =ð
¤cdev_devid
) {

5543 ià(
found
 &&

5544 
physiÿl_of_found
 <=

5545 
bbio
->
¡res
[
i
].
physiÿl
)

5547 
šdex_¤cdev
 = 
i
;

5548 
found
 = 1;

5549 
physiÿl_of_found
 = 
bbio
->
¡res
[
i
].
physiÿl
;

5552 ià(
found
) {

5553 
bŒfs_bio_¡re
 *
tgtdev_¡re
 =

5554 
bbio
->
¡res
 + 
num_¡res
;

5556 
tgtdev_¡re
->
physiÿl
 = 
physiÿl_of_found
;

5557 
tgtdev_¡re
->
Ëngth
 =

5558 
bbio
->
¡res
[
šdex_¤cdev
].
Ëngth
;

5559 
tgtdev_¡re
->
dev
 = 
dev_»¶aû
->
tgtdev
;

5560 
bbio
->
tgtdev_m­
[
šdex_¤cdev
] = 
num_¡res
;

5562 
tgtdev_šdexes
++;

5563 
num_¡res
++;

5567 *
num_¡res_»t
 = 
num_¡res
;

5568 *
max_”rÜs_»t
 = 
max_”rÜs
;

5569 
bbio
->
num_tgtdevs
 = 
tgtdev_šdexes
;

5570 *
bbio_»t
 = 
bbio
;

5571 
	}
}

5573 
boÞ
 
	$Ãed_fuÎ_¡re
(
bŒfs_m­_Ý
 
Ý
)

5575  (
Ý
 =ð
BTRFS_MAP_WRITE
 || o°=ð
BTRFS_MAP_GET_READ_MIRRORS
);

5576 
	}
}

5578 
	$__bŒfs_m­_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

5579 
bŒfs_m­_Ý
 
Ý
,

5580 
u64
 
logiÿl
, u64 *
Ëngth
,

5581 
bŒfs_bio
 **
bbio_»t
,

5582 
mœrÜ_num
, 
Ãed_¿id_m­
)

5584 
ex‹Á_m­
 *
em
;

5585 
m­_lookup
 *
m­
;

5586 
u64
 
off£t
;

5587 
u64
 
¡re_off£t
;

5588 
u64
 
¡re_Ä
;

5589 
u64
 
¡re_Ën
;

5590 
u32
 
¡re_šdex
;

5591 
i
;

5592 
»t
 = 0;

5593 
num_¡res
;

5594 
max_”rÜs
 = 0;

5595 
tgtdev_šdexes
 = 0;

5596 
bŒfs_bio
 *
bbio
 = 
NULL
;

5597 
bŒfs_dev_»¶aû
 *
dev_»¶aû
 = &
fs_šfo
->dev_replace;

5598 
dev_»¶aû_is_Úgošg
 = 0;

5599 
num_®loc_¡res
;

5600 
·tch_the_fœ¡_¡re_fÜ_dev_»¶aû
 = 0;

5601 
u64
 
physiÿl_to_·tch_š_fœ¡_¡re
 = 0;

5602 
u64
 
¿id56_fuÎ_¡re_¡¬t
 = (u64)-1;

5604 ià(
Ý
 =ð
BTRFS_MAP_DISCARD
)

5605  
	`__bŒfs_m­_block_fÜ_disÿrd
(
fs_šfo
, 
logiÿl
,

5606 *
Ëngth
, 
bbio_»t
);

5608 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
logiÿl
, *
Ëngth
);

5609 ià(
	`IS_ERR
(
em
))

5610  
	`PTR_ERR
(
em
);

5612 
m­
 = 
em
->
m­_lookup
;

5613 
off£t
 = 
logiÿl
 - 
em
->
¡¬t
;

5615 
¡re_Ën
 = 
m­
->stripe_len;

5616 
¡re_Ä
 = 
off£t
;

5621 
¡re_Ä
 = 
	`div64_u64
(¡re_Ä, 
¡re_Ën
);

5623 
¡re_off£t
 = 
¡re_Ä
 * 
¡re_Ën
;

5624 ià(
off£t
 < 
¡re_off£t
) {

5625 
	`bŒfs_ü™
(
fs_šfo
,

5627 
¡re_off£t
, 
off£t
, 
em
->
¡¬t
, 
logiÿl
,

5628 
¡re_Ën
);

5629 
	`ä“_ex‹Á_m­
(
em
);

5630  -
EINVAL
;

5634 
¡re_off£t
 = 
off£t
 - stripe_offset;

5637 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

5638 
fuÎ_¡re_Ën
 = 
¡re_Ën
 * 
	`Ä_d©a_¡res
(
m­
);

5639 
¿id56_fuÎ_¡re_¡¬t
 = 
off£t
;

5644 
¿id56_fuÎ_¡re_¡¬t
 = 
	`div64_u64
(raid56_full_stripe_start,

5645 
fuÎ_¡re_Ën
);

5646 
¿id56_fuÎ_¡re_¡¬t
 *ð
fuÎ_¡re_Ën
;

5649 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) {

5650 
u64
 
max_Ën
;

5654 ià((
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) &&

5655 (
Ý
 =ð
BTRFS_MAP_WRITE
)) {

5656 
max_Ën
 = 
¡re_Ën
 * 
	`Ä_d©a_¡res
(
m­
) -

5657 (
off£t
 - 
¿id56_fuÎ_¡re_¡¬t
);

5660 
max_Ën
 = 
¡re_Ën
 - 
¡re_off£t
;

5662 *
Ëngth
 = 
	`mš_t
(
u64
, 
em
->
Ën
 - 
off£t
, 
max_Ën
);

5664 *
Ëngth
 = 
em
->
Ën
 - 
off£t
;

5669 ià(!
bbio_»t
)

5670 
out
;

5672 
	`bŒfs_dev_»¶aû_lock
(
dev_»¶aû
, 0);

5673 
dev_»¶aû_is_Úgošg
 = 
	`bŒfs_dev_»¶aû_is_Úgošg
(
dev_»¶aû
);

5674 ià(!
dev_»¶aû_is_Úgošg
)

5675 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

5677 
	`bŒfs_dev_»¶aû_£t_lock_blockšg
(
dev_»¶aû
);

5679 ià(
dev_»¶aû_is_Úgošg
 && 
mœrÜ_num
 =ð
m­
->
num_¡res
 + 1 &&

5680 !
	`Ãed_fuÎ_¡re
(
Ý
è&& 
dev_»¶aû
->
tgtdev
 !ð
NULL
) {

5681 
»t
 = 
	`g‘_exŒa_mœrÜ_äom_»¶aû
(
fs_šfo
, 
logiÿl
, *
Ëngth
,

5682 
dev_»¶aû
->
¤cdev
->
devid
,

5683 &
mœrÜ_num
,

5684 &
physiÿl_to_·tch_š_fœ¡_¡re
);

5685 ià(
»t
)

5686 
out
;

5688 
·tch_the_fœ¡_¡re_fÜ_dev_»¶aû
 = 1;

5689 } ià(
mœrÜ_num
 > 
m­
->
num_¡res
) {

5690 
mœrÜ_num
 = 0;

5693 
num_¡res
 = 1;

5694 
¡re_šdex
 = 0;

5695 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
) {

5696 
¡re_Ä
 = 
	`div_u64_»m
(¡re_Ä, 
m­
->
num_¡res
,

5697 &
¡re_šdex
);

5698 ià(
Ý
 !ð
BTRFS_MAP_WRITE
 && o°!ð
BTRFS_MAP_GET_READ_MIRRORS
)

5699 
mœrÜ_num
 = 1;

5700 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1
) {

5701 ià(
Ý
 =ð
BTRFS_MAP_WRITE
 || o°=ð
BTRFS_MAP_GET_READ_MIRRORS
)

5702 
num_¡res
 = 
m­
->num_stripes;

5703 ià(
mœrÜ_num
)

5704 
¡re_šdex
 = 
mœrÜ_num
 - 1;

5706 
¡re_šdex
 = 
	`fšd_live_mœrÜ
(
fs_šfo
, 
m­
, 0,

5707 
m­
->
num_¡res
,

5708 
cu¼’t
->
pid
 % 
m­
->
num_¡res
,

5709 
dev_»¶aû_is_Úgošg
);

5710 
mœrÜ_num
 = 
¡re_šdex
 + 1;

5713 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_DUP
) {

5714 ià(
Ý
 =ð
BTRFS_MAP_WRITE
 || o°=ð
BTRFS_MAP_GET_READ_MIRRORS
) {

5715 
num_¡res
 = 
m­
->num_stripes;

5716 } ià(
mœrÜ_num
) {

5717 
¡re_šdex
 = 
mœrÜ_num
 - 1;

5719 
mœrÜ_num
 = 1;

5722 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
) {

5723 
u32
 
çùÜ
 = 
m­
->
num_¡res
 / m­->
sub_¡res
;

5725 
¡re_Ä
 = 
	`div_u64_»m
(¡re_Ä, 
çùÜ
, &
¡re_šdex
);

5726 
¡re_šdex
 *ð
m­
->
sub_¡res
;

5728 ià(
Ý
 =ð
BTRFS_MAP_WRITE
 || o°=ð
BTRFS_MAP_GET_READ_MIRRORS
)

5729 
num_¡res
 = 
m­
->
sub_¡res
;

5730 ià(
mœrÜ_num
)

5731 
¡re_šdex
 +ð
mœrÜ_num
 - 1;

5733 
Þd_¡re_šdex
 = 
¡re_šdex
;

5734 
¡re_šdex
 = 
	`fšd_live_mœrÜ
(
fs_šfo
, 
m­
,

5735 
¡re_šdex
,

5736 
m­
->
sub_¡res
, 
¡re_šdex
 +

5737 
cu¼’t
->
pid
 % 
m­
->
sub_¡res
,

5738 
dev_»¶aû_is_Úgošg
);

5739 
mœrÜ_num
 = 
¡re_šdex
 - 
Þd_¡re_šdex
 + 1;

5742 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

5743 ià(
Ãed_¿id_m­
 &&

5744 (
Ý
 =ð
BTRFS_MAP_WRITE
 || o°=ð
BTRFS_MAP_GET_READ_MIRRORS
 ||

5745 
mœrÜ_num
 > 1)) {

5747 
¡re_Ä
 = 
	`div64_u64
(
¿id56_fuÎ_¡re_¡¬t
,

5748 
¡re_Ën
 * 
	`Ä_d©a_¡res
(
m­
));

5751 
num_¡res
 = 
m­
->num_stripes;

5752 
max_”rÜs
 = 
	`Ä_·r™y_¡res
(
m­
);

5754 *
Ëngth
 = 
m­
->
¡re_Ën
;

5755 
¡re_šdex
 = 0;

5756 
¡re_off£t
 = 0;

5763 
¡re_Ä
 = 
	`div_u64_»m
(stripe_nr,

5764 
	`Ä_d©a_¡res
(
m­
), &
¡re_šdex
);

5765 ià(
mœrÜ_num
 > 1)

5766 
¡re_šdex
 = 
	`Ä_d©a_¡res
(
m­
) +

5767 
mœrÜ_num
 - 2;

5770 
	`div_u64_»m
(
¡re_Ä
 + 
¡re_šdex
, 
m­
->
num_¡res
,

5771 &
¡re_šdex
);

5772 ià((
Ý
 !ð
BTRFS_MAP_WRITE
 &&

5773 
Ý
 !ð
BTRFS_MAP_GET_READ_MIRRORS
) &&

5774 
mœrÜ_num
 <= 1)

5775 
mœrÜ_num
 = 1;

5783 
¡re_Ä
 = 
	`div_u64_»m
(¡re_Ä, 
m­
->
num_¡res
,

5784 &
¡re_šdex
);

5785 
mœrÜ_num
 = 
¡re_šdex
 + 1;

5787 ià(
¡re_šdex
 >ð
m­
->
num_¡res
) {

5788 
	`bŒfs_ü™
(
fs_šfo
,

5790 
¡re_šdex
, 
m­
->
num_¡res
);

5791 
»t
 = -
EINVAL
;

5792 
out
;

5795 
num_®loc_¡res
 = 
num_¡res
;

5796 ià(
dev_»¶aû_is_Úgošg
 && 
dev_»¶aû
->
tgtdev
 !ð
NULL
) {

5797 ià(
Ý
 =ð
BTRFS_MAP_WRITE
)

5798 
num_®loc_¡res
 <<= 1;

5799 ià(
Ý
 =ð
BTRFS_MAP_GET_READ_MIRRORS
)

5800 
num_®loc_¡res
++;

5801 
tgtdev_šdexes
 = 
num_¡res
;

5804 
bbio
 = 
	`®loc_bŒfs_bio
(
num_®loc_¡res
, 
tgtdev_šdexes
);

5805 ià(!
bbio
) {

5806 
»t
 = -
ENOMEM
;

5807 
out
;

5809 ià(
dev_»¶aû_is_Úgošg
 && 
dev_»¶aû
->
tgtdev
 !ð
NULL
)

5810 
bbio
->
tgtdev_m­
 = (*)(bbio->
¡res
 + 
num_®loc_¡res
);

5813 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
 && 
Ãed_¿id_m­
 &&

5814 (
	`Ãed_fuÎ_¡re
(
Ý
è|| 
mœrÜ_num
 > 1)) {

5815 
u64
 
tmp
;

5816 
rÙ
;

5818 
bbio
->
¿id_m­
 = (
u64
 *)((*)bbio->
¡res
 +

5819 (
bŒfs_bio_¡re
) *

5820 
num_®loc_¡res
 +

5821 (è* 
tgtdev_šdexes
);

5824 
	`div_u64_»m
(
¡re_Ä
, 
num_¡res
, &
rÙ
);

5827 
tmp
 = 
¡re_Ä
 * 
	`Ä_d©a_¡res
(
m­
);

5828 
i
 = 0; i < 
	`Ä_d©a_¡res
(
m­
); i++)

5829 
bbio
->
¿id_m­
[(
i
+
rÙ
è% 
num_¡res
] =

5830 
em
->
¡¬t
 + (
tmp
 + 
i
è* 
m­
->
¡re_Ën
;

5832 
bbio
->
¿id_m­
[(
i
+
rÙ
è% 
m­
->
num_¡res
] = 
RAID5_P_STRIPE
;

5833 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
)

5834 
bbio
->
¿id_m­
[(
i
+
rÙ
+1è% 
num_¡res
] =

5835 
RAID6_Q_STRIPE
;

5839 
i
 = 0; i < 
num_¡res
; i++) {

5840 
bbio
->
¡res
[
i
].
physiÿl
 =

5841 
m­
->
¡res
[
¡re_šdex
].
physiÿl
 +

5842 
¡re_off£t
 +

5843 
¡re_Ä
 * 
m­
->
¡re_Ën
;

5844 
bbio
->
¡res
[
i
].
dev
 =

5845 
m­
->
¡res
[
¡re_šdex
].
dev
;

5846 
¡re_šdex
++;

5849 ià(
	`Ãed_fuÎ_¡re
(
Ý
))

5850 
max_”rÜs
 = 
	`bŒfs_chunk_max_”rÜs
(
m­
);

5852 ià(
bbio
->
¿id_m­
)

5853 
	`sÜt_·r™y_¡res
(
bbio
, 
num_¡res
);

5855 ià(
dev_»¶aû_is_Úgošg
 && 
dev_»¶aû
->
tgtdev
 !ð
NULL
 &&

5856 
	`Ãed_fuÎ_¡re
(
Ý
)) {

5857 
	`hªdË_Ýs_Ú_dev_»¶aû
(
Ý
, &
bbio
, 
dev_»¶aû
, &
num_¡res
,

5858 &
max_”rÜs
);

5861 *
bbio_»t
 = 
bbio
;

5862 
bbio
->
m­_ty³
 = 
m­
->
ty³
;

5863 
bbio
->
num_¡res
 =‚um_stripes;

5864 
bbio
->
max_”rÜs
 = max_errors;

5865 
bbio
->
mœrÜ_num
 = mirror_num;

5872 ià(
·tch_the_fœ¡_¡re_fÜ_dev_»¶aû
 && 
num_¡res
 > 0) {

5873 
	`WARN_ON
(
num_¡res
 > 1);

5874 
bbio
->
¡res
[0].
dev
 = 
dev_»¶aû
->
tgtdev
;

5875 
bbio
->
¡res
[0].
physiÿl
 = 
physiÿl_to_·tch_š_fœ¡_¡re
;

5876 
bbio
->
mœrÜ_num
 = 
m­
->
num_¡res
 + 1;

5878 
out
:

5879 ià(
dev_»¶aû_is_Úgošg
) {

5880 
	`bŒfs_dev_»¶aû_þ—r_lock_blockšg
(
dev_»¶aû
);

5881 
	`bŒfs_dev_»¶aû_uÆock
(
dev_»¶aû
, 0);

5883 
	`ä“_ex‹Á_m­
(
em
);

5884  
»t
;

5885 
	}
}

5887 
	$bŒfs_m­_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_m­_Ý
 
Ý
,

5888 
u64
 
logiÿl
, u64 *
Ëngth
,

5889 
bŒfs_bio
 **
bbio_»t
, 
mœrÜ_num
)

5891  
	`__bŒfs_m­_block
(
fs_šfo
, 
Ý
, 
logiÿl
, 
Ëngth
, 
bbio_»t
,

5892 
mœrÜ_num
, 0);

5893 
	}
}

5896 
	$bŒfs_m­_sblock
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_m­_Ý
 
Ý
,

5897 
u64
 
logiÿl
, u64 *
Ëngth
,

5898 
bŒfs_bio
 **
bbio_»t
)

5900  
	`__bŒfs_m­_block
(
fs_šfo
, 
Ý
, 
logiÿl
, 
Ëngth
, 
bbio_»t
, 0, 1);

5901 
	}
}

5903 
	$bŒfs_rm­_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

5904 
u64
 
chunk_¡¬t
, u64 
physiÿl
, u64 
devid
,

5905 
u64
 **
logiÿl
, *
Çddrs
, *
¡re_Ën
)

5907 
ex‹Á_m­
 *
em
;

5908 
m­_lookup
 *
m­
;

5909 
u64
 *
buf
;

5910 
u64
 
by‹Ä
;

5911 
u64
 
Ëngth
;

5912 
u64
 
¡re_Ä
;

5913 
u64
 
rm­_Ën
;

5914 
i
, 
j
, 
Ä
 = 0;

5916 
em
 = 
	`g‘_chunk_m­
(
fs_šfo
, 
chunk_¡¬t
, 1);

5917 ià(
	`IS_ERR
(
em
))

5918  -
EIO
;

5920 
m­
 = 
em
->
m­_lookup
;

5921 
Ëngth
 = 
em
->
Ën
;

5922 
rm­_Ën
 = 
m­
->
¡re_Ën
;

5924 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
)

5925 
Ëngth
 = 
	`div_u64
Ö’gth, 
m­
->
num_¡res
 / m­->
sub_¡res
);

5926 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
)

5927 
Ëngth
 = 
	`div_u64
Ö’gth, 
m­
->
num_¡res
);

5928 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) {

5929 
Ëngth
 = 
	`div_u64
Ö’gth, 
	`Ä_d©a_¡res
(
m­
));

5930 
rm­_Ën
 = 
m­
->
¡re_Ën
 * 
	`Ä_d©a_¡res
(map);

5933 
buf
 = 
	`kÿÎoc
(
m­
->
num_¡res
, (
u64
), 
GFP_NOFS
);

5934 
	`BUG_ON
(!
buf
);

5936 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

5937 ià(
devid
 && 
m­
->
¡res
[
i
].
dev
->devid != devid)

5939 ià(
m­
->
¡res
[
i
].
physiÿl
 >…hysical ||

5940 
m­
->
¡res
[
i
].
physiÿl
 + 
Ëngth
 <=…hysical)

5943 
¡re_Ä
 = 
physiÿl
 - 
m­
->
¡res
[
i
].physical;

5944 
¡re_Ä
 = 
	`div64_u64
(¡re_Ä, 
m­
->
¡re_Ën
);

5946 ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
) {

5947 
¡re_Ä
 = sŒe_Ä * 
m­
->
num_¡res
 + 
i
;

5948 
¡re_Ä
 = 
	`div_u64
(¡re_Ä, 
m­
->
sub_¡res
);

5949 } ià(
m­
->
ty³
 & 
BTRFS_BLOCK_GROUP_RAID0
) {

5950 
¡re_Ä
 = sŒe_Ä * 
m­
->
num_¡res
 + 
i
;

5955 
by‹Ä
 = 
chunk_¡¬t
 + 
¡re_Ä
 * 
rm­_Ën
;

5956 
	`WARN_ON
(
Ä
 >ð
m­
->
num_¡res
);

5957 
j
 = 0; j < 
Ä
; j++) {

5958 ià(
buf
[
j
] =ð
by‹Ä
)

5961 ià(
j
 =ð
Ä
) {

5962 
	`WARN_ON
(
Ä
 >ð
m­
->
num_¡res
);

5963 
buf
[
Ä
++] = 
by‹Ä
;

5967 *
logiÿl
 = 
buf
;

5968 *
Çddrs
 = 
Ä
;

5969 *
¡re_Ën
 = 
rm­_Ën
;

5971 
	`ä“_ex‹Á_m­
(
em
);

5973 
	}
}

5975 
šlše
 
	$bŒfs_’d_bbio
(
bŒfs_bio
 *
bbio
, 
bio
 *bio)

5977 
bio
->
bi_´iv©e
 = 
bbio
->
´iv©e
;

5978 
bio
->
bi_’d_io
 = 
bbio
->
’d_io
;

5979 
	`bio_’dio
(
bio
);

5981 
	`bŒfs_put_bbio
(
bbio
);

5982 
	}
}

5984 
	$bŒfs_’d_bio
(
bio
 *bio)

5986 
bŒfs_bio
 *
bbio
 = 
bio
->
bi_´iv©e
;

5987 
is_Üig_bio
 = 0;

5989 ià(
bio
->
bi_¡©us
) {

5990 
	`©omic_šc
(&
bbio
->
”rÜ
);

5991 ià(
bio
->
bi_¡©us
 =ð
BLK_STS_IOERR
 ||

5992 
bio
->
bi_¡©us
 =ð
BLK_STS_TARGET
) {

5993 
¡re_šdex
 =

5994 
	`bŒfs_io_bio
(
bio
)->
¡re_šdex
;

5995 
bŒfs_deviû
 *
dev
;

5997 
	`BUG_ON
(
¡re_šdex
 >ð
bbio
->
num_¡res
);

5998 
dev
 = 
bbio
->
¡res
[
¡re_šdex
].dev;

5999 ià(
dev
->
bdev
) {

6000 ià(
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
)

6001 
	`bŒfs_dev_¡©_šc
(
dev
,

6002 
BTRFS_DEV_STAT_WRITE_ERRS
);

6004 
	`bŒfs_dev_¡©_šc
(
dev
,

6005 
BTRFS_DEV_STAT_READ_ERRS
);

6006 ià(
bio
->
bi_Ýf
 & 
REQ_PREFLUSH
)

6007 
	`bŒfs_dev_¡©_šc
(
dev
,

6008 
BTRFS_DEV_STAT_FLUSH_ERRS
);

6009 
	`bŒfs_dev_¡©_´št_Ú_”rÜ
(
dev
);

6014 ià(
bio
 =ð
bbio
->
Üig_bio
)

6015 
is_Üig_bio
 = 1;

6017 
	`bŒfs_bio_couÁ”_dec
(
bbio
->
fs_šfo
);

6019 ià(
	`©omic_dec_ªd_‹¡
(&
bbio
->
¡res_³ndšg
)) {

6020 ià(!
is_Üig_bio
) {

6021 
	`bio_put
(
bio
);

6022 
bio
 = 
bbio
->
Üig_bio
;

6025 
	`bŒfs_io_bio
(
bio
)->
mœrÜ_num
 = 
bbio
->mirror_num;

6029 ià(
	`©omic_»ad
(&
bbio
->
”rÜ
è> bbio->
max_”rÜs
) {

6030 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

6036 
bio
->
bi_¡©us
 = 0;

6039 
	`bŒfs_’d_bbio
(
bbio
, 
bio
);

6040 } ià(!
is_Üig_bio
) {

6041 
	`bio_put
(
bio
);

6043 
	}
}

6052 
nošlše
 
	$bŒfs_scheduË_bio
(
bŒfs_deviû
 *
deviû
,

6053 
bio
 *bio)

6055 
bŒfs_fs_šfo
 *
fs_šfo
 = 
deviû
->fs_info;

6056 
should_queue
 = 1;

6057 
bŒfs_³ndšg_bios
 *
³ndšg_bios
;

6059 ià(
deviû
->
missšg
 || !deviû->
bdev
) {

6060 
	`bio_io_”rÜ
(
bio
);

6065 ià(
	`bio_Ý
(
bio
è=ð
REQ_OP_READ
) {

6066 
	`bio_g‘
(
bio
);

6067 
	`bŒfsic_subm™_bio
(
bio
);

6068 
	`bio_put
(
bio
);

6078 
	`©omic_šc
(&
fs_šfo
->
Ä_async_bios
);

6079 
	`WARN_ON
(
bio
->
bi_Ãxt
);

6080 
bio
->
bi_Ãxt
 = 
NULL
;

6082 
	`¥š_lock
(&
deviû
->
io_lock
);

6083 ià(
	`Ý_is_sync
(
bio
->
bi_Ýf
))

6084 
³ndšg_bios
 = &
deviû
->
³ndšg_sync_bios
;

6086 
³ndšg_bios
 = &
deviû
->pending_bios;

6088 ià(
³ndšg_bios
->
ž
)

6089 
³ndšg_bios
->
ž
->
bi_Ãxt
 = 
bio
;

6091 
³ndšg_bios
->
ž
 = 
bio
;

6092 ià(!
³ndšg_bios
->
h—d
)

6093 
³ndšg_bios
->
h—d
 = 
bio
;

6094 ià(
deviû
->
ruÂšg_³ndšg
)

6095 
should_queue
 = 0;

6097 
	`¥š_uÆock
(&
deviû
->
io_lock
);

6099 ià(
should_queue
)

6100 
	`bŒfs_queue_wÜk
(
fs_šfo
->
subm™_wÜk”s
, &
deviû
->
wÜk
);

6101 
	}
}

6103 
	$subm™_¡re_bio
(
bŒfs_bio
 *
bbio
, 
bio
 *bio,

6104 
u64
 
physiÿl
, 
dev_Ä
, 
async
)

6106 
bŒfs_deviû
 *
dev
 = 
bbio
->
¡res
[
dev_Ä
].dev;

6107 
bŒfs_fs_šfo
 *
fs_šfo
 = 
bbio
->fs_info;

6109 
bio
->
bi_´iv©e
 = 
bbio
;

6110 
	`bŒfs_io_bio
(
bio
)->
¡re_šdex
 = 
dev_Ä
;

6111 
bio
->
bi_’d_io
 = 
bŒfs_’d_bio
;

6112 
bio
->
bi_™”
.
bi_£ùÜ
 = 
physiÿl
 >> 9;

6113 #ifdeà
DEBUG


6115 
rcu_¡ršg
 *
Çme
;

6117 
	`rcu_»ad_lock
();

6118 
Çme
 = 
	`rcu_d”eã»nû
(
dev
->name);

6119 
	`bŒfs_debug
(
fs_šfo
,

6121 
	`bio_Ý
(
bio
), bio->
bi_Ýf
,

6122 (
u64
)
bio
->
bi_™”
.
bi_£ùÜ
,

6123 (
u_lÚg
)
dev
->
bdev
->
bd_dev
, 
Çme
->
¡r
, dev->
devid
,

6124 
bio
->
bi_™”
.
bi_size
);

6125 
	`rcu_»ad_uÆock
();

6128 
	`bio_£t_dev
(
bio
, 
dev
->
bdev
);

6130 
	`bŒfs_bio_couÁ”_šc_noblocked
(
fs_šfo
);

6132 ià(
async
)

6133 
	`bŒfs_scheduË_bio
(
dev
, 
bio
);

6135 
	`bŒfsic_subm™_bio
(
bio
);

6136 
	}
}

6138 
	$bbio_”rÜ
(
bŒfs_bio
 *
bbio
, 
bio
 *bio, 
u64
 
logiÿl
)

6140 
	`©omic_šc
(&
bbio
->
”rÜ
);

6141 ià(
	`©omic_dec_ªd_‹¡
(&
bbio
->
¡res_³ndšg
)) {

6143 
	`WARN_ON
(
bio
 !ð
bbio
->
Üig_bio
);

6145 
	`bŒfs_io_bio
(
bio
)->
mœrÜ_num
 = 
bbio
->mirror_num;

6146 
bio
->
bi_™”
.
bi_£ùÜ
 = 
logiÿl
 >> 9;

6147 
bio
->
bi_¡©us
 = 
BLK_STS_IOERR
;

6148 
	`bŒfs_’d_bbio
(
bbio
, 
bio
);

6150 
	}
}

6152 
blk_¡©us_t
 
	$bŒfs_m­_bio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

6153 
mœrÜ_num
, 
async_subm™
)

6155 
bŒfs_deviû
 *
dev
;

6156 
bio
 *
fœ¡_bio
 = bio;

6157 
u64
 
logiÿl
 = (u64)
bio
->
bi_™”
.
bi_£ùÜ
 << 9;

6158 
u64
 
Ëngth
 = 0;

6159 
u64
 
m­_Ëngth
;

6160 
»t
;

6161 
dev_Ä
;

6162 
tÙ®_devs
;

6163 
bŒfs_bio
 *
bbio
 = 
NULL
;

6165 
Ëngth
 = 
bio
->
bi_™”
.
bi_size
;

6166 
m­_Ëngth
 = 
Ëngth
;

6168 
	`bŒfs_bio_couÁ”_šc_blocked
(
fs_šfo
);

6169 
»t
 = 
	`__bŒfs_m­_block
(
fs_šfo
, 
	`bŒfs_Ý
(
bio
), 
logiÿl
,

6170 &
m­_Ëngth
, &
bbio
, 
mœrÜ_num
, 1);

6171 ià(
»t
) {

6172 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

6173  
	`”ºo_to_blk_¡©us
(
»t
);

6176 
tÙ®_devs
 = 
bbio
->
num_¡res
;

6177 
bbio
->
Üig_bio
 = 
fœ¡_bio
;

6178 
bbio
->
´iv©e
 = 
fœ¡_bio
->
bi_´iv©e
;

6179 
bbio
->
’d_io
 = 
fœ¡_bio
->
bi_’d_io
;

6180 
bbio
->
fs_šfo
 = fs_info;

6181 
	`©omic_£t
(&
bbio
->
¡res_³ndšg
, bbio->
num_¡res
);

6183 ià((
bbio
->
m­_ty³
 & 
BTRFS_BLOCK_GROUP_RAID56_MASK
) &&

6184 ((
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
è|| (
mœrÜ_num
 > 1))) {

6187 ià(
	`bio_Ý
(
bio
è=ð
REQ_OP_WRITE
) {

6188 
»t
 = 
	`¿id56_·r™y_wr™e
(
fs_šfo
, 
bio
, 
bbio
,

6189 
m­_Ëngth
);

6191 
»t
 = 
	`¿id56_·r™y_»cov”
(
fs_šfo
, 
bio
, 
bbio
,

6192 
m­_Ëngth
, 
mœrÜ_num
, 1);

6195 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

6196  
	`”ºo_to_blk_¡©us
(
»t
);

6199 ià(
m­_Ëngth
 < 
Ëngth
) {

6200 
	`bŒfs_ü™
(
fs_šfo
,

6202 
logiÿl
, 
Ëngth
, 
m­_Ëngth
);

6203 
	`BUG
();

6206 
dev_Ä
 = 0; dev_Ä < 
tÙ®_devs
; dev_nr++) {

6207 
dev
 = 
bbio
->
¡res
[
dev_Ä
].dev;

6208 ià(!
dev
 || !dev->
bdev
 ||

6209 (
	`bio_Ý
(
fœ¡_bio
è=ð
REQ_OP_WRITE
 && !
dev
->
wr™—bË
)) {

6210 
	`bbio_”rÜ
(
bbio
, 
fœ¡_bio
, 
logiÿl
);

6214 ià(
dev_Ä
 < 
tÙ®_devs
 - 1)

6215 
bio
 = 
	`bŒfs_bio_þÚe
(
fœ¡_bio
);

6217 
bio
 = 
fœ¡_bio
;

6219 
	`subm™_¡re_bio
(
bbio
, 
bio
, bbio->
¡res
[
dev_Ä
].
physiÿl
,

6220 
dev_Ä
, 
async_subm™
);

6222 
	`bŒfs_bio_couÁ”_dec
(
fs_šfo
);

6223  
BLK_STS_OK
;

6224 
	}
}

6226 
bŒfs_deviû
 *
	$bŒfs_fšd_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

6227 
u8
 *
uuid
, u8 *
fsid
)

6229 
bŒfs_deviû
 *
deviû
;

6230 
bŒfs_fs_deviûs
 *
cur_deviûs
;

6232 
cur_deviûs
 = 
fs_šfo
->
fs_deviûs
;

6233 
cur_deviûs
) {

6234 ià(!
fsid
 ||

6235 !
	`memcmp
(
cur_deviûs
->
fsid
, fsid, 
BTRFS_FSID_SIZE
)) {

6236 
deviû
 = 
	`fšd_deviû
(
cur_deviûs
, 
devid
, 
uuid
);

6237 ià(
deviû
)

6238  
deviû
;

6240 
cur_deviûs
 = cur_deviûs->
£ed
;

6242  
NULL
;

6243 
	}
}

6245 
bŒfs_deviû
 *
	$add_missšg_dev
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

6246 
u64
 
devid
, 
u8
 *
dev_uuid
)

6248 
bŒfs_deviû
 *
deviû
;

6250 
deviû
 = 
	`bŒfs_®loc_deviû
(
NULL
, &
devid
, 
dev_uuid
);

6251 ià(
	`IS_ERR
(
deviû
))

6252  
NULL
;

6254 
	`li¡_add
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

6255 
deviû
->
fs_deviûs
 = fs_devices;

6256 
fs_deviûs
->
num_deviûs
++;

6258 
deviû
->
missšg
 = 1;

6259 
fs_deviûs
->
missšg_deviûs
++;

6261  
deviû
;

6262 
	}
}

6277 
bŒfs_deviû
 *
	$bŒfs_®loc_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

6278 cÚ¡ 
u64
 *
devid
,

6279 cÚ¡ 
u8
 *
uuid
)

6281 
bŒfs_deviû
 *
dev
;

6282 
u64
 
tmp
;

6284 ià(
	`WARN_ON
(!
devid
 && !
fs_šfo
))

6285  
	`ERR_PTR
(-
EINVAL
);

6287 
dev
 = 
	`__®loc_deviû
();

6288 ià(
	`IS_ERR
(
dev
))

6289  
dev
;

6291 ià(
devid
)

6292 
tmp
 = *
devid
;

6294 
»t
;

6296 
»t
 = 
	`fšd_Ãxt_devid
(
fs_šfo
, &
tmp
);

6297 ià(
»t
) {

6298 
	`kä“
(
dev
);

6299  
	`ERR_PTR
(
»t
);

6302 
dev
->
devid
 = 
tmp
;

6304 ià(
uuid
)

6305 
	`memýy
(
dev
->
uuid
, uuid, 
BTRFS_UUID_SIZE
);

6307 
	`g’”©e_¿ndom_uuid
(
dev
->
uuid
);

6309 
	`bŒfs_š™_wÜk
(&
dev
->
wÜk
, 
bŒfs_subm™_h–³r
,

6310 
³ndšg_bios_â
, 
NULL
, NULL);

6312  
dev
;

6313 
	}
}

6316 
	$bŒfs_check_chunk_v®id
(
bŒfs_fs_šfo
 *
fs_šfo
,

6317 
ex‹Á_bufãr
 *
Ëaf
,

6318 
bŒfs_chunk
 *
chunk
, 
u64
 
logiÿl
)

6320 
u64
 
Ëngth
;

6321 
u64
 
¡re_Ën
;

6322 
u16
 
num_¡res
;

6323 
u16
 
sub_¡res
;

6324 
u64
 
ty³
;

6326 
Ëngth
 = 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
);

6327 
¡re_Ën
 = 
	`bŒfs_chunk_¡re_Ën
(
Ëaf
, 
chunk
);

6328 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

6329 
sub_¡res
 = 
	`bŒfs_chunk_sub_¡res
(
Ëaf
, 
chunk
);

6330 
ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

6332 ià(!
num_¡res
) {

6333 
	`bŒfs_”r
(
fs_šfo
, "invalid chunk‚um_stripes: %u",

6334 
num_¡res
);

6335  -
EIO
;

6337 ià(!
	`IS_ALIGNED
(
logiÿl
, 
fs_šfo
->
£ùÜsize
)) {

6338 
	`bŒfs_”r
(
fs_šfo
, "šv®id chunk†ogiÿÈ%Îu", 
logiÿl
);

6339  -
EIO
;

6341 ià(
	`bŒfs_chunk_£ùÜ_size
(
Ëaf
, 
chunk
è!ð
fs_šfo
->
£ùÜsize
) {

6342 
	`bŒfs_”r
(
fs_šfo
, "invalid chunk sectorsize %u",

6343 
	`bŒfs_chunk_£ùÜ_size
(
Ëaf
, 
chunk
));

6344  -
EIO
;

6346 ià(!
Ëngth
 || !
	`IS_ALIGNED
Ö’gth, 
fs_šfo
->
£ùÜsize
)) {

6347 
	`bŒfs_”r
(
fs_šfo
, "šv®id chunk†’gth %Îu", 
Ëngth
);

6348  -
EIO
;

6350 ià(!
	`is_pow”_of_2
(
¡re_Ën
è|| sŒe_ËÀ!ð
BTRFS_STRIPE_LEN
) {

6351 
	`bŒfs_”r
(
fs_šfo
, "invalid chunk stripe†ength: %llu",

6352 
¡re_Ën
);

6353  -
EIO
;

6355 ià(~(
BTRFS_BLOCK_GROUP_TYPE_MASK
 | 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) &

6356 
ty³
) {

6357 
	`bŒfs_”r
(
fs_šfo
, "unrecognized chunkype: %llu",

6358 ~(
BTRFS_BLOCK_GROUP_TYPE_MASK
 |

6359 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) &

6360 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
));

6361  -
EIO
;

6363 ià((
ty³
 & 
BTRFS_BLOCK_GROUP_RAID10
 && 
sub_¡res
 != 2) ||

6364 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID1
 && 
num_¡res
 < 1) ||

6365 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID5
 && 
num_¡res
 < 2) ||

6366 (
ty³
 & 
BTRFS_BLOCK_GROUP_RAID6
 && 
num_¡res
 < 3) ||

6367 (
ty³
 & 
BTRFS_BLOCK_GROUP_DUP
 && 
num_¡res
 > 2) ||

6368 ((
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
) == 0 &&

6369 
num_¡res
 != 1)) {

6370 
	`bŒfs_”r
(
fs_šfo
,

6372 
num_¡res
, 
sub_¡res
,

6373 
ty³
 & 
BTRFS_BLOCK_GROUP_PROFILE_MASK
);

6374  -
EIO
;

6378 
	}
}

6380 
	$»ad_Úe_chunk
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_key
 *
key
,

6381 
ex‹Á_bufãr
 *
Ëaf
,

6382 
bŒfs_chunk
 *
chunk
)

6384 
bŒfs_m­pšg_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

6385 
m­_lookup
 *
m­
;

6386 
ex‹Á_m­
 *
em
;

6387 
u64
 
logiÿl
;

6388 
u64
 
Ëngth
;

6389 
u64
 
devid
;

6390 
u8
 
uuid
[
BTRFS_UUID_SIZE
];

6391 
num_¡res
;

6392 
»t
;

6393 
i
;

6395 
logiÿl
 = 
key
->
off£t
;

6396 
Ëngth
 = 
	`bŒfs_chunk_Ëngth
(
Ëaf
, 
chunk
);

6397 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
Ëaf
, 
chunk
);

6399 
»t
 = 
	`bŒfs_check_chunk_v®id
(
fs_šfo
, 
Ëaf
, 
chunk
, 
logiÿl
);

6400 ià(
»t
)

6401  
»t
;

6403 
	`»ad_lock
(&
m­_Œ“
->m­_Œ“.
lock
);

6404 
em
 = 
	`lookup_ex‹Á_m­pšg
(&
m­_Œ“
->m­_Œ“, 
logiÿl
, 1);

6405 
	`»ad_uÆock
(&
m­_Œ“
->m­_Œ“.
lock
);

6408 ià(
em
 &&ƒm->
¡¬t
 <ð
logiÿl
 &&ƒm->¡¬ˆ+ƒm->
Ën
 >†ogical) {

6409 
	`ä“_ex‹Á_m­
(
em
);

6411 } ià(
em
) {

6412 
	`ä“_ex‹Á_m­
(
em
);

6415 
em
 = 
	`®loc_ex‹Á_m­
();

6416 ià(!
em
)

6417  -
ENOMEM
;

6418 
m­
 = 
	`km®loc
(
	`m­_lookup_size
(
num_¡res
), 
GFP_NOFS
);

6419 ià(!
m­
) {

6420 
	`ä“_ex‹Á_m­
(
em
);

6421  -
ENOMEM
;

6424 
	`£t_b™
(
EXTENT_FLAG_FS_MAPPING
, &
em
->
æags
);

6425 
em
->
m­_lookup
 = 
m­
;

6426 
em
->
¡¬t
 = 
logiÿl
;

6427 
em
->
Ën
 = 
Ëngth
;

6428 
em
->
Üig_¡¬t
 = 0;

6429 
em
->
block_¡¬t
 = 0;

6430 
em
->
block_Ën
 =ƒm->
Ën
;

6432 
m­
->
num_¡res
 =‚um_stripes;

6433 
m­
->
io_width
 = 
	`bŒfs_chunk_io_width
(
Ëaf
, 
chunk
);

6434 
m­
->
io_®ign
 = 
	`bŒfs_chunk_io_®ign
(
Ëaf
, 
chunk
);

6435 
m­
->
¡re_Ën
 = 
	`bŒfs_chunk_¡re_Ën
(
Ëaf
, 
chunk
);

6436 
m­
->
ty³
 = 
	`bŒfs_chunk_ty³
(
Ëaf
, 
chunk
);

6437 
m­
->
sub_¡res
 = 
	`bŒfs_chunk_sub_¡res
(
Ëaf
, 
chunk
);

6438 
i
 = 0; i < 
num_¡res
; i++) {

6439 
m­
->
¡res
[
i
].
physiÿl
 =

6440 
	`bŒfs_¡re_off£t_Ä
(
Ëaf
, 
chunk
, 
i
);

6441 
devid
 = 
	`bŒfs_¡re_devid_Ä
(
Ëaf
, 
chunk
, 
i
);

6442 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
uuid
, ()

6443 
	`bŒfs_¡re_dev_uuid_Ä
(
chunk
, 
i
),

6444 
BTRFS_UUID_SIZE
);

6445 
m­
->
¡res
[
i
].
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
,

6446 
uuid
, 
NULL
);

6447 ià(!
m­
->
¡res
[
i
].
dev
 &&

6448 !
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DEGRADED
)) {

6449 
	`ä“_ex‹Á_m­
(
em
);

6450 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
uuid
);

6451  -
EIO
;

6453 ià(!
m­
->
¡res
[
i
].
dev
) {

6454 
m­
->
¡res
[
i
].
dev
 =

6455 
	`add_missšg_dev
(
fs_šfo
->
fs_deviûs
, 
devid
,

6456 
uuid
);

6457 ià(!
m­
->
¡res
[
i
].
dev
) {

6458 
	`ä“_ex‹Á_m­
(
em
);

6459  -
EIO
;

6461 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
uuid
);

6463 
m­
->
¡res
[
i
].
dev
->
š_fs_m‘ad©a
 = 1;

6466 
	`wr™e_lock
(&
m­_Œ“
->m­_Œ“.
lock
);

6467 
»t
 = 
	`add_ex‹Á_m­pšg
(&
m­_Œ“
->m­_Œ“, 
em
, 0);

6468 
	`wr™e_uÆock
(&
m­_Œ“
->m­_Œ“.
lock
);

6469 
	`BUG_ON
(
»t
);

6470 
	`ä“_ex‹Á_m­
(
em
);

6473 
	}
}

6475 
	$fžl_deviû_äom_™em
(
ex‹Á_bufãr
 *
Ëaf
,

6476 
bŒfs_dev_™em
 *
dev_™em
,

6477 
bŒfs_deviû
 *
deviû
)

6479 
±r
;

6481 
deviû
->
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

6482 
deviû
->
disk_tÙ®_by‹s
 = 
	`bŒfs_deviû_tÙ®_by‹s
(
Ëaf
, 
dev_™em
);

6483 
deviû
->
tÙ®_by‹s
 = deviû->
disk_tÙ®_by‹s
;

6484 
deviû
->
comm™_tÙ®_by‹s
 = deviû->
disk_tÙ®_by‹s
;

6485 
deviû
->
by‹s_u£d
 = 
	`bŒfs_deviû_by‹s_u£d
(
Ëaf
, 
dev_™em
);

6486 
deviû
->
comm™_by‹s_u£d
 = deviû->
by‹s_u£d
;

6487 
deviû
->
ty³
 = 
	`bŒfs_deviû_ty³
(
Ëaf
, 
dev_™em
);

6488 
deviû
->
io_®ign
 = 
	`bŒfs_deviû_io_®ign
(
Ëaf
, 
dev_™em
);

6489 
deviû
->
io_width
 = 
	`bŒfs_deviû_io_width
(
Ëaf
, 
dev_™em
);

6490 
deviû
->
£ùÜ_size
 = 
	`bŒfs_deviû_£ùÜ_size
(
Ëaf
, 
dev_™em
);

6491 
	`WARN_ON
(
deviû
->
devid
 =ð
BTRFS_DEV_REPLACE_DEVID
);

6492 
deviû
->
is_tgtdev_fÜ_dev_»¶aû
 = 0;

6494 
±r
 = 
	`bŒfs_deviû_uuid
(
dev_™em
);

6495 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
deviû
->
uuid
, 
±r
, 
BTRFS_UUID_SIZE
);

6496 
	}
}

6498 
bŒfs_fs_deviûs
 *
	$Ý’_£ed_deviûs
(
bŒfs_fs_šfo
 *
fs_šfo
,

6499 
u8
 *
fsid
)

6501 
bŒfs_fs_deviûs
 *
fs_deviûs
;

6502 
»t
;

6504 
	`BUG_ON
(!
	`mu‹x_is_locked
(&
uuid_mu‹x
));

6505 
	`ASSERT
(
fsid
);

6507 
fs_deviûs
 = 
fs_šfo
->fs_deviûs->
£ed
;

6508 
fs_deviûs
) {

6509 ià(!
	`memcmp
(
fs_deviûs
->
fsid
, fsid, 
BTRFS_FSID_SIZE
))

6510  
fs_deviûs
;

6512 
fs_deviûs
 = fs_deviûs->
£ed
;

6515 
fs_deviûs
 = 
	`fšd_fsid
(
fsid
);

6516 ià(!
fs_deviûs
) {

6517 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DEGRADED
))

6518  
	`ERR_PTR
(-
ENOENT
);

6520 
fs_deviûs
 = 
	`®loc_fs_deviûs
(
fsid
);

6521 ià(
	`IS_ERR
(
fs_deviûs
))

6522  
fs_deviûs
;

6524 
fs_deviûs
->
£edšg
 = 1;

6525 
fs_deviûs
->
Ý’ed
 = 1;

6526  
fs_deviûs
;

6529 
fs_deviûs
 = 
	`þÚe_fs_deviûs
(fs_devices);

6530 ià(
	`IS_ERR
(
fs_deviûs
))

6531  
fs_deviûs
;

6533 
»t
 = 
	`__bŒfs_Ý’_deviûs
(
fs_deviûs
, 
FMODE_READ
,

6534 
fs_šfo
->
bdev_hÞd”
);

6535 ià(
»t
) {

6536 
	`ä“_fs_deviûs
(
fs_deviûs
);

6537 
fs_deviûs
 = 
	`ERR_PTR
(
»t
);

6538 
out
;

6541 ià(!
fs_deviûs
->
£edšg
) {

6542 
	`__bŒfs_þo£_deviûs
(
fs_deviûs
);

6543 
	`ä“_fs_deviûs
(
fs_deviûs
);

6544 
fs_deviûs
 = 
	`ERR_PTR
(-
EINVAL
);

6545 
out
;

6548 
fs_deviûs
->
£ed
 = 
fs_šfo
->fs_devices->seed;

6549 
fs_šfo
->
fs_deviûs
->
£ed
 = fs_devices;

6550 
out
:

6551  
fs_deviûs
;

6552 
	}
}

6554 
	$»ad_Úe_dev
(
bŒfs_fs_šfo
 *
fs_šfo
,

6555 
ex‹Á_bufãr
 *
Ëaf
,

6556 
bŒfs_dev_™em
 *
dev_™em
)

6558 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

6559 
bŒfs_deviû
 *
deviû
;

6560 
u64
 
devid
;

6561 
»t
;

6562 
u8
 
fs_uuid
[
BTRFS_FSID_SIZE
];

6563 
u8
 
dev_uuid
[
BTRFS_UUID_SIZE
];

6565 
devid
 = 
	`bŒfs_deviû_id
(
Ëaf
, 
dev_™em
);

6566 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
dev_uuid
, 
	`bŒfs_deviû_uuid
(
dev_™em
),

6567 
BTRFS_UUID_SIZE
);

6568 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
fs_uuid
, 
	`bŒfs_deviû_fsid
(
dev_™em
),

6569 
BTRFS_FSID_SIZE
);

6571 ià(
	`memcmp
(
fs_uuid
, 
fs_šfo
->
fsid
, 
BTRFS_FSID_SIZE
)) {

6572 
fs_deviûs
 = 
	`Ý’_£ed_deviûs
(
fs_šfo
, 
fs_uuid
);

6573 ià(
	`IS_ERR
(
fs_deviûs
))

6574  
	`PTR_ERR
(
fs_deviûs
);

6577 
deviû
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
, 
fs_uuid
);

6578 ià(!
deviû
) {

6579 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DEGRADED
)) {

6580 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
);

6581  -
EIO
;

6584 
deviû
 = 
	`add_missšg_dev
(
fs_deviûs
, 
devid
, 
dev_uuid
);

6585 ià(!
deviû
)

6586  -
ENOMEM
;

6587 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
);

6589 ià(!
deviû
->
bdev
) {

6590 
	`bŒfs_»pÜt_missšg_deviû
(
fs_šfo
, 
devid
, 
dev_uuid
);

6591 ià(!
	`bŒfs_‹¡_Ýt
(
fs_šfo
, 
DEGRADED
))

6592  -
EIO
;

6595 if(!
deviû
->
bdev
 && !deviû->
missšg
) {

6602 
deviû
->
fs_deviûs
->
missšg_deviûs
++;

6603 
deviû
->
missšg
 = 1;

6607 ià(
deviû
->
fs_deviûs
 != fs_devices) {

6608 
	`ASSERT
(
deviû
->
missšg
);

6610 
	`li¡_move
(&
deviû
->
dev_li¡
, &
fs_deviûs
->
deviûs
);

6611 
deviû
->
fs_deviûs
->
num_deviûs
--;

6612 
fs_deviûs
->
num_deviûs
++;

6614 
deviû
->
fs_deviûs
->
missšg_deviûs
--;

6615 
fs_deviûs
->
missšg_deviûs
++;

6617 
deviû
->
fs_deviûs
 = fs_devices;

6621 ià(
deviû
->
fs_deviûs
 !ð
fs_šfo
->fs_devices) {

6622 
	`BUG_ON
(
deviû
->
wr™—bË
);

6623 ià(
deviû
->
g’”©iÚ
 !=

6624 
	`bŒfs_deviû_g’”©iÚ
(
Ëaf
, 
dev_™em
))

6625  -
EINVAL
;

6628 
	`fžl_deviû_äom_™em
(
Ëaf
, 
dev_™em
, 
deviû
);

6629 
deviû
->
š_fs_m‘ad©a
 = 1;

6630 ià(
deviû
->
wr™—bË
 && !deviû->
is_tgtdev_fÜ_dev_»¶aû
) {

6631 
deviû
->
fs_deviûs
->
tÙ®_rw_by‹s
 +ðdeviû->
tÙ®_by‹s
;

6632 
	`©omic64_add
(
deviû
->
tÙ®_by‹s
 - deviû->
by‹s_u£d
,

6633 &
fs_šfo
->
ä“_chunk_¥aû
);

6635 
»t
 = 0;

6636  
»t
;

6637 
	}
}

6639 
	$bŒfs_»ad_sys_¬¿y
(
bŒfs_fs_šfo
 *
fs_šfo
)

6641 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
Œ“_roÙ
;

6642 
bŒfs_su³r_block
 *
su³r_cÝy
 = 
fs_šfo
->super_copy;

6643 
ex‹Á_bufãr
 *
sb
;

6644 
bŒfs_disk_key
 *
disk_key
;

6645 
bŒfs_chunk
 *
chunk
;

6646 
u8
 *
¬¿y_±r
;

6647 
sb_¬¿y_off£t
;

6648 
»t
 = 0;

6649 
u32
 
num_¡res
;

6650 
u32
 
¬¿y_size
;

6651 
u32
 
Ën
 = 0;

6652 
u32
 
cur_off£t
;

6653 
u64
 
ty³
;

6654 
bŒfs_key
 
key
;

6656 
	`ASSERT
(
BTRFS_SUPER_INFO_SIZE
 <ð
fs_šfo
->
nodesize
);

6662 
sb
 = 
	`bŒfs_fšd_ü—‹_Œ“_block
(
fs_šfo
, 
BTRFS_SUPER_INFO_OFFSET
);

6663 ià(
	`IS_ERR
(
sb
))

6664  
	`PTR_ERR
(
sb
);

6665 
	`£t_ex‹Á_bufãr_u±od©e
(
sb
);

6666 
	`bŒfs_£t_bufãr_lockd•_þass
(
roÙ
->
roÙ_key
.
objeùid
, 
sb
, 0);

6679 ià(
PAGE_SIZE
 > 
BTRFS_SUPER_INFO_SIZE
)

6680 
	`S‘PageU±od©e
(
sb
->
·ges
[0]);

6682 
	`wr™e_ex‹Á_bufãr
(
sb
, 
su³r_cÝy
, 0, 
BTRFS_SUPER_INFO_SIZE
);

6683 
¬¿y_size
 = 
	`bŒfs_su³r_sys_¬¿y_size
(
su³r_cÝy
);

6685 
¬¿y_±r
 = 
su³r_cÝy
->
sys_chunk_¬¿y
;

6686 
sb_¬¿y_off£t
 = 
	`off£tof
(
bŒfs_su³r_block
, 
sys_chunk_¬¿y
);

6687 
cur_off£t
 = 0;

6689 
cur_off£t
 < 
¬¿y_size
) {

6690 
disk_key
 = (
bŒfs_disk_key
 *)
¬¿y_±r
;

6691 
Ën
 = (*
disk_key
);

6692 ià(
cur_off£t
 + 
Ën
 > 
¬¿y_size
)

6693 
out_shÜt_»ad
;

6695 
	`bŒfs_disk_key_to_ýu
(&
key
, 
disk_key
);

6697 
¬¿y_±r
 +ð
Ën
;

6698 
sb_¬¿y_off£t
 +ð
Ën
;

6699 
cur_off£t
 +ð
Ën
;

6701 ià(
key
.
ty³
 =ð
BTRFS_CHUNK_ITEM_KEY
) {

6702 
chunk
 = (
bŒfs_chunk
 *)
sb_¬¿y_off£t
;

6707 
Ën
 = 
	`bŒfs_chunk_™em_size
(1);

6708 ià(
cur_off£t
 + 
Ën
 > 
¬¿y_size
)

6709 
out_shÜt_»ad
;

6711 
num_¡res
 = 
	`bŒfs_chunk_num_¡res
(
sb
, 
chunk
);

6712 ià(!
num_¡res
) {

6713 
	`bŒfs_”r
(
fs_šfo
,

6715 
num_¡res
, 
cur_off£t
);

6716 
»t
 = -
EIO
;

6720 
ty³
 = 
	`bŒfs_chunk_ty³
(
sb
, 
chunk
);

6721 ià((
ty³
 & 
BTRFS_BLOCK_GROUP_SYSTEM
) == 0) {

6722 
	`bŒfs_”r
(
fs_šfo
,

6724 
ty³
, 
cur_off£t
);

6725 
»t
 = -
EIO
;

6729 
Ën
 = 
	`bŒfs_chunk_™em_size
(
num_¡res
);

6730 ià(
cur_off£t
 + 
Ën
 > 
¬¿y_size
)

6731 
out_shÜt_»ad
;

6733 
»t
 = 
	`»ad_Úe_chunk
(
fs_šfo
, &
key
, 
sb
, 
chunk
);

6734 ià(
»t
)

6737 
	`bŒfs_”r
(
fs_šfo
,

6739 (
u32
)
key
.
ty³
, 
cur_off£t
);

6740 
»t
 = -
EIO
;

6743 
¬¿y_±r
 +ð
Ën
;

6744 
sb_¬¿y_off£t
 +ð
Ën
;

6745 
cur_off£t
 +ð
Ën
;

6747 
	`þ—r_ex‹Á_bufãr_u±od©e
(
sb
);

6748 
	`ä“_ex‹Á_bufãr_¡®e
(
sb
);

6749  
»t
;

6751 
out_shÜt_»ad
:

6752 
	`bŒfs_”r
(
fs_šfo
, "sys_arrayoo shorto„ead %u bytes‡t offset %u",

6753 
Ën
, 
cur_off£t
);

6754 
	`þ—r_ex‹Á_bufãr_u±od©e
(
sb
);

6755 
	`ä“_ex‹Á_bufãr_¡®e
(
sb
);

6756  -
EIO
;

6757 
	}
}

6759 
	$bŒfs_»pÜt_missšg_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

6760 
u8
 *
uuid
)

6762 
	`bŒfs_w¬n_¾
(
fs_šfo
, "devid %Îu uuid %pU i missšg", 
devid
, 
uuid
);

6763 
	}
}

6771 
boÞ
 
	$bŒfs_check_rw_deg¿dabË
(
bŒfs_fs_šfo
 *
fs_šfo
)

6773 
bŒfs_m­pšg_Œ“
 *
m­_Œ“
 = &
fs_šfo
->
m­pšg_Œ“
;

6774 
ex‹Á_m­
 *
em
;

6775 
u64
 
Ãxt_¡¬t
 = 0;

6776 
boÞ
 
»t
 = 
Œue
;

6778 
	`»ad_lock
(&
m­_Œ“
->m­_Œ“.
lock
);

6779 
em
 = 
	`lookup_ex‹Á_m­pšg
(&
m­_Œ“
->m­_Œ“, 0, (
u64
)-1);

6780 
	`»ad_uÆock
(&
m­_Œ“
->m­_Œ“.
lock
);

6782 ià(!
em
) {

6783 
»t
 = 
çl£
;

6784 
out
;

6786 
em
) {

6787 
m­_lookup
 *
m­
;

6788 
missšg
 = 0;

6789 
max_tÞ”©ed
;

6790 
i
;

6792 
m­
 = 
em
->
m­_lookup
;

6793 
max_tÞ”©ed
 =

6794 
	`bŒfs_g‘_num_tÞ”©ed_disk_b¬r›r_çžu»s
(

6795 
m­
->
ty³
);

6796 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

6797 
bŒfs_deviû
 *
dev
 = 
m­
->
¡res
[
i
].dev;

6799 ià(!
dev
 || !dev->
bdev
 || dev->
missšg
 ||

6800 
dev
->
Ï¡_æush_”rÜ
)

6801 
missšg
++;

6803 ià(
missšg
 > 
max_tÞ”©ed
) {

6804 
	`bŒfs_w¬n
(
fs_šfo
,

6806 
em
->
¡¬t
, 
missšg
, 
max_tÞ”©ed
);

6807 
	`ä“_ex‹Á_m­
(
em
);

6808 
»t
 = 
çl£
;

6809 
out
;

6811 
Ãxt_¡¬t
 = 
	`ex‹Á_m­_’d
(
em
);

6812 
	`ä“_ex‹Á_m­
(
em
);

6814 
	`»ad_lock
(&
m­_Œ“
->m­_Œ“.
lock
);

6815 
em
 = 
	`lookup_ex‹Á_m­pšg
(&
m­_Œ“
->m­_Œ“, 
Ãxt_¡¬t
,

6816 (
u64
)(-1è- 
Ãxt_¡¬t
);

6817 
	`»ad_uÆock
(&
m­_Œ“
->m­_Œ“.
lock
);

6819 
out
:

6820  
»t
;

6821 
	}
}

6823 
	$bŒfs_»ad_chunk_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
)

6825 
bŒfs_roÙ
 *
roÙ
 = 
fs_šfo
->
chunk_roÙ
;

6826 
bŒfs_·th
 *
·th
;

6827 
ex‹Á_bufãr
 *
Ëaf
;

6828 
bŒfs_key
 
key
;

6829 
bŒfs_key
 
found_key
;

6830 
»t
;

6831 
¦Ù
;

6832 
u64
 
tÙ®_dev
 = 0;

6834 
·th
 = 
	`bŒfs_®loc_·th
();

6835 ià(!
·th
)

6836  -
ENOMEM
;

6838 
	`mu‹x_lock
(&
uuid_mu‹x
);

6839 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

6847 
key
.
objeùid
 = 
BTRFS_DEV_ITEMS_OBJECTID
;

6848 
key
.
off£t
 = 0;

6849 
key
.
ty³
 = 0;

6850 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

6851 ià(
»t
 < 0)

6852 
”rÜ
;

6854 
Ëaf
 = 
·th
->
nodes
[0];

6855 
¦Ù
 = 
·th
->
¦Ùs
[0];

6856 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

6857 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

6858 ià(
»t
 == 0)

6860 ià(
»t
 < 0)

6861 
”rÜ
;

6864 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

6865 ià(
found_key
.
ty³
 =ð
BTRFS_DEV_ITEM_KEY
) {

6866 
bŒfs_dev_™em
 *
dev_™em
;

6867 
dev_™em
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
,

6868 
bŒfs_dev_™em
);

6869 
»t
 = 
	`»ad_Úe_dev
(
fs_šfo
, 
Ëaf
, 
dev_™em
);

6870 ià(
»t
)

6871 
”rÜ
;

6872 
tÙ®_dev
++;

6873 } ià(
found_key
.
ty³
 =ð
BTRFS_CHUNK_ITEM_KEY
) {

6874 
bŒfs_chunk
 *
chunk
;

6875 
chunk
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_chunk
);

6876 
»t
 = 
	`»ad_Úe_chunk
(
fs_šfo
, &
found_key
, 
Ëaf
, 
chunk
);

6877 ià(
»t
)

6878 
”rÜ
;

6880 
·th
->
¦Ùs
[0]++;

6887 ià(
tÙ®_dev
 !ð
fs_šfo
->
fs_deviûs
->
tÙ®_deviûs
) {

6888 
	`bŒfs_”r
(
fs_šfo
,

6890 
	`bŒfs_su³r_num_deviûs
(
fs_šfo
->
su³r_cÝy
),

6891 
tÙ®_dev
);

6892 
»t
 = -
EINVAL
;

6893 
”rÜ
;

6895 ià(
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
) <

6896 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
) {

6897 
	`bŒfs_”r
(
fs_šfo
,

6899 
	`bŒfs_su³r_tÙ®_by‹s
(
fs_šfo
->
su³r_cÝy
),

6900 
fs_šfo
->
fs_deviûs
->
tÙ®_rw_by‹s
);

6901 
»t
 = -
EINVAL
;

6902 
”rÜ
;

6904 
»t
 = 0;

6905 
”rÜ
:

6906 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

6907 
	`mu‹x_uÆock
(&
uuid_mu‹x
);

6909 
	`bŒfs_ä“_·th
(
·th
);

6910  
»t
;

6911 
	}
}

6913 
	$bŒfs_š™_deviûs_Ï‹
(
bŒfs_fs_šfo
 *
fs_šfo
)

6915 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

6916 
bŒfs_deviû
 *
deviû
;

6918 
fs_deviûs
) {

6919 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

6920 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
)

6921 
deviû
->
fs_šfo
 = fs_info;

6922 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

6924 
fs_deviûs
 = fs_deviûs->
£ed
;

6926 
	}
}

6928 
	$__bŒfs_»£t_dev_¡©s
(
bŒfs_deviû
 *
dev
)

6930 
i
;

6932 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

6933 
	`bŒfs_dev_¡©_»£t
(
dev
, 
i
);

6934 
	}
}

6936 
	$bŒfs_š™_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
)

6938 
bŒfs_key
 
key
;

6939 
bŒfs_key
 
found_key
;

6940 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

6941 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

6942 
ex‹Á_bufãr
 *
eb
;

6943 
¦Ù
;

6944 
»t
 = 0;

6945 
bŒfs_deviû
 *
deviû
;

6946 
bŒfs_·th
 *
·th
 = 
NULL
;

6947 
i
;

6949 
·th
 = 
	`bŒfs_®loc_·th
();

6950 ià(!
·th
) {

6951 
»t
 = -
ENOMEM
;

6952 
out
;

6955 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

6956 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

6957 
™em_size
;

6958 
bŒfs_dev_¡©s_™em
 *
±r
;

6960 
key
.
objeùid
 = 
BTRFS_DEV_STATS_OBJECTID
;

6961 
key
.
ty³
 = 
BTRFS_PERSISTENT_ITEM_KEY
;

6962 
key
.
off£t
 = 
deviû
->
devid
;

6963 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
dev_roÙ
, &
key
, 
·th
, 0, 0);

6964 ià(
»t
) {

6965 
	`__bŒfs_»£t_dev_¡©s
(
deviû
);

6966 
deviû
->
dev_¡©s_v®id
 = 1;

6967 
	`bŒfs_»Ëa£_·th
(
·th
);

6970 
¦Ù
 = 
·th
->
¦Ùs
[0];

6971 
eb
 = 
·th
->
nodes
[0];

6972 
	`bŒfs_™em_key_to_ýu
(
eb
, &
found_key
, 
¦Ù
);

6973 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
eb
, 
¦Ù
);

6975 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
¦Ù
,

6976 
bŒfs_dev_¡©s_™em
);

6978 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++) {

6979 ià(
™em_size
 >ð(1 + 
i
è* (
__Ë64
))

6980 
	`bŒfs_dev_¡©_£t
(
deviû
, 
i
,

6981 
	`bŒfs_dev_¡©s_v®ue
(
eb
, 
±r
, 
i
));

6983 
	`bŒfs_dev_¡©_»£t
(
deviû
, 
i
);

6986 
deviû
->
dev_¡©s_v®id
 = 1;

6987 
	`bŒfs_dev_¡©_´št_Ú_lßd
(
deviû
);

6988 
	`bŒfs_»Ëa£_·th
(
·th
);

6990 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

6992 
out
:

6993 
	`bŒfs_ä“_·th
(
·th
);

6994  
»t
 < 0 ?„et : 0;

6995 
	}
}

6997 
	$upd©e_dev_¡©_™em
(
bŒfs_Œªs_hªdË
 *
Œªs
,

6998 
bŒfs_fs_šfo
 *
fs_šfo
,

6999 
bŒfs_deviû
 *
deviû
)

7001 
bŒfs_roÙ
 *
dev_roÙ
 = 
fs_šfo
->dev_root;

7002 
bŒfs_·th
 *
·th
;

7003 
bŒfs_key
 
key
;

7004 
ex‹Á_bufãr
 *
eb
;

7005 
bŒfs_dev_¡©s_™em
 *
±r
;

7006 
»t
;

7007 
i
;

7009 
key
.
objeùid
 = 
BTRFS_DEV_STATS_OBJECTID
;

7010 
key
.
ty³
 = 
BTRFS_PERSISTENT_ITEM_KEY
;

7011 
key
.
off£t
 = 
deviû
->
devid
;

7013 
·th
 = 
	`bŒfs_®loc_·th
();

7014 ià(!
·th
)

7015  -
ENOMEM
;

7016 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
Œªs
, 
dev_roÙ
, &
key
, 
·th
, -1, 1);

7017 ià(
»t
 < 0) {

7018 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

7020 
»t
, 
	`rcu_¡r_d”ef
(
deviû
->
Çme
));

7021 
out
;

7024 ià(
»t
 == 0 &&

7025 
	`bŒfs_™em_size_Ä
(
·th
->
nodes
[0],…©h->
¦Ùs
[0]è< (*
±r
)) {

7027 
»t
 = 
	`bŒfs_d–_™em
(
Œªs
, 
dev_roÙ
, 
·th
);

7028 ià(
»t
 != 0) {

7029 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

7031 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
»t
);

7032 
out
;

7034 
»t
 = 1;

7037 ià(
»t
 == 1) {

7039 
	`bŒfs_»Ëa£_·th
(
·th
);

7040 
»t
 = 
	`bŒfs_š£¹_em±y_™em
(
Œªs
, 
dev_roÙ
, 
·th
,

7041 &
key
, (*
±r
));

7042 ià(
»t
 < 0) {

7043 
	`bŒfs_w¬n_š_rcu
(
fs_šfo
,

7045 
	`rcu_¡r_d”ef
(
deviû
->
Çme
), 
»t
);

7046 
out
;

7050 
eb
 = 
·th
->
nodes
[0];

7051 
±r
 = 
	`bŒfs_™em_±r
(
eb
, 
·th
->
¦Ùs
[0], 
bŒfs_dev_¡©s_™em
);

7052 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

7053 
	`bŒfs_£t_dev_¡©s_v®ue
(
eb
, 
±r
, 
i
,

7054 
	`bŒfs_dev_¡©_»ad
(
deviû
, 
i
));

7055 
	`bŒfs_m¬k_bufãr_dœty
(
eb
);

7057 
out
:

7058 
	`bŒfs_ä“_·th
(
·th
);

7059  
»t
;

7060 
	}
}

7065 
	$bŒfs_run_dev_¡©s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

7066 
bŒfs_fs_šfo
 *
fs_šfo
)

7068 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7069 
bŒfs_deviû
 *
deviû
;

7070 
¡©s_út
;

7071 
»t
 = 0;

7073 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7074 
	`li¡_fÜ_—ch_’Œy
(
deviû
, &
fs_deviûs
->
deviûs
, 
dev_li¡
) {

7075 ià(!
deviû
->
dev_¡©s_v®id
 || !
	`bŒfs_dev_¡©s_dœty
(device))

7078 
¡©s_út
 = 
	`©omic_»ad
(&
deviû
->
dev_¡©s_cút
);

7079 
»t
 = 
	`upd©e_dev_¡©_™em
(
Œªs
, 
fs_šfo
, 
deviû
);

7080 ià(!
»t
)

7081 
	`©omic_sub
(
¡©s_út
, &
deviû
->
dev_¡©s_cút
);

7083 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7085  
»t
;

7086 
	}
}

7088 
	$bŒfs_dev_¡©_šc_ªd_´št
(
bŒfs_deviû
 *
dev
, 
šdex
)

7090 
	`bŒfs_dev_¡©_šc
(
dev
, 
šdex
);

7091 
	`bŒfs_dev_¡©_´št_Ú_”rÜ
(
dev
);

7092 
	}
}

7094 
	$bŒfs_dev_¡©_´št_Ú_”rÜ
(
bŒfs_deviû
 *
dev
)

7096 ià(!
dev
->
dev_¡©s_v®id
)

7098 
	`bŒfs_”r_¾_š_rcu
(
dev
->
fs_šfo
,

7100 
	`rcu_¡r_d”ef
(
dev
->
Çme
),

7101 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

7102 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
),

7103 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

7104 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

7105 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

7106 
	}
}

7108 
	$bŒfs_dev_¡©_´št_Ú_lßd
(
bŒfs_deviû
 *
dev
)

7110 
i
;

7112 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

7113 ià(
	`bŒfs_dev_¡©_»ad
(
dev
, 
i
) != 0)

7115 ià(
i
 =ð
BTRFS_DEV_STAT_VALUES_MAX
)

7118 
	`bŒfs_šfo_š_rcu
(
dev
->
fs_šfo
,

7120 
	`rcu_¡r_d”ef
(
dev
->
Çme
),

7121 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_WRITE_ERRS
),

7122 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_READ_ERRS
),

7123 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_FLUSH_ERRS
),

7124 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_CORRUPTION_ERRS
),

7125 
	`bŒfs_dev_¡©_»ad
(
dev
, 
BTRFS_DEV_STAT_GENERATION_ERRS
));

7126 
	}
}

7128 
	$bŒfs_g‘_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
,

7129 
bŒfs_ioùl_g‘_dev_¡©s
 *
¡©s
)

7131 
bŒfs_deviû
 *
dev
;

7132 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7133 
i
;

7135 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7136 
dev
 = 
	`bŒfs_fšd_deviû
(
fs_šfo
, 
¡©s
->
devid
, 
NULL
, NULL);

7137 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7139 ià(!
dev
) {

7140 
	`bŒfs_w¬n
(
fs_šfo
, "get dev_stats failed, device‚ot found");

7141  -
ENODEV
;

7142 } ià(!
dev
->
dev_¡©s_v®id
) {

7143 
	`bŒfs_w¬n
(
fs_šfo
, "get dev_stats failed,‚ot yet valid");

7144  -
ENODEV
;

7145 } ià(
¡©s
->
æags
 & 
BTRFS_DEV_STATS_RESET
) {

7146 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++) {

7147 ià(
¡©s
->
Ä_™ems
 > 
i
)

7148 
¡©s
->
v®ues
[
i
] =

7149 
	`bŒfs_dev_¡©_»ad_ªd_»£t
(
dev
, 
i
);

7151 
	`bŒfs_dev_¡©_»£t
(
dev
, 
i
);

7154 
i
 = 0; i < 
BTRFS_DEV_STAT_VALUES_MAX
; i++)

7155 ià(
¡©s
->
Ä_™ems
 > 
i
)

7156 
¡©s
->
v®ues
[
i
] = 
	`bŒfs_dev_¡©_»ad
(
dev
, i);

7158 ià(
¡©s
->
Ä_™ems
 > 
BTRFS_DEV_STAT_VALUES_MAX
)

7159 
¡©s
->
Ä_™ems
 = 
BTRFS_DEV_STAT_VALUES_MAX
;

7161 
	}
}

7163 
	$bŒfs_sü©ch_su³rblocks
(
block_deviû
 *
bdev
, cÚ¡ *
deviû_·th
)

7165 
bufãr_h—d
 *
bh
;

7166 
bŒfs_su³r_block
 *
disk_su³r
;

7167 
cÝy_num
;

7169 ià(!
bdev
)

7172 
cÝy_num
 = 0; cÝy_num < 
BTRFS_SUPER_MIRROR_MAX
;

7173 
cÝy_num
++) {

7175 ià(
	`bŒfs_»ad_dev_Úe_su³r
(
bdev
, 
cÝy_num
, &
bh
))

7178 
disk_su³r
 = (
bŒfs_su³r_block
 *)
bh
->
b_d©a
;

7180 
	`mem£t
(&
disk_su³r
->
magic
, 0, (disk_super->magic));

7181 
	`£t_bufãr_dœty
(
bh
);

7182 
	`sync_dœty_bufãr
(
bh
);

7183 
	`b»l£
(
bh
);

7187 
	`bŒfs_kobjeù_uev’t
(
bdev
, 
KOBJ_CHANGE
);

7190 
	`upd©e_dev_time
(
deviû_·th
);

7191 
	}
}

7197 
	$bŒfs_upd©e_comm™_deviû_size
(
bŒfs_fs_šfo
 *
fs_šfo
)

7199 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7200 
bŒfs_deviû
 *
cu¼
, *
Ãxt
;

7202 ià(
	`li¡_em±y
(&
fs_deviûs
->
»sized_deviûs
))

7205 
	`mu‹x_lock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7206 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

7207 
	`li¡_fÜ_—ch_’Œy_§ã
(
cu¼
, 
Ãxt
, &
fs_deviûs
->
»sized_deviûs
,

7208 
»sized_li¡
) {

7209 
	`li¡_d–_š™
(&
cu¼
->
»sized_li¡
);

7210 
cu¼
->
comm™_tÙ®_by‹s
 = cu¼->
disk_tÙ®_by‹s
;

7212 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

7213 
	`mu‹x_uÆock
(&
fs_deviûs
->
deviû_li¡_mu‹x
);

7214 
	}
}

7217 
	$bŒfs_upd©e_comm™_deviû_by‹s_u£d
(
bŒfs_fs_šfo
 *
fs_šfo
,

7218 
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
)

7220 
ex‹Á_m­
 *
em
;

7221 
m­_lookup
 *
m­
;

7222 
bŒfs_deviû
 *
dev
;

7223 
i
;

7225 ià(
	`li¡_em±y
(&
Œª§ùiÚ
->
³ndšg_chunks
))

7229 
	`mu‹x_lock
(&
fs_šfo
->
chunk_mu‹x
);

7230 
	`li¡_fÜ_—ch_’Œy
(
em
, &
Œª§ùiÚ
->
³ndšg_chunks
, 
li¡
) {

7231 
m­
 = 
em
->
m­_lookup
;

7233 
i
 = 0; i < 
m­
->
num_¡res
; i++) {

7234 
dev
 = 
m­
->
¡res
[
i
].dev;

7235 
dev
->
comm™_by‹s_u£d
 = dev->
by‹s_u£d
;

7238 
	`mu‹x_uÆock
(&
fs_šfo
->
chunk_mu‹x
);

7239 
	}
}

7241 
	$bŒfs_£t_fs_šfo_±r
(
bŒfs_fs_šfo
 *
fs_šfo
)

7243 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7244 
fs_deviûs
) {

7245 
fs_deviûs
->
fs_šfo
 = fs_info;

7246 
fs_deviûs
 = fs_deviûs->
£ed
;

7248 
	}
}

7250 
	$bŒfs_»£t_fs_šfo_±r
(
bŒfs_fs_šfo
 *
fs_šfo
)

7252 
bŒfs_fs_deviûs
 *
fs_deviûs
 = 
fs_šfo
->fs_devices;

7253 
fs_deviûs
) {

7254 
fs_deviûs
->
fs_šfo
 = 
NULL
;

7255 
fs_deviûs
 = fs_deviûs->
£ed
;

7257 
	}
}

	@volumes.h

19 #iâdeà
__BTRFS_VOLUMES_


20 
	#__BTRFS_VOLUMES_


	)

22 
	~<lšux/bio.h
>

23 
	~<lšux/sÜt.h
>

24 
	~<lšux/bŒfs.h
>

25 
	~"async-th»ad.h
"

27 
mu‹x
 
uuid_mu‹x
;

29 
	#BTRFS_STRIPE_LEN
 
SZ_64K


	)

31 
	gbufãr_h—d
;

32 
	sbŒfs_³ndšg_bios
 {

33 
bio
 *
	mh—d
;

34 
bio
 *
	mž
;

41 #ià
BITS_PER_LONG
==32 && 
defšed
(
CONFIG_SMP
)

42 
	~<lšux/£qlock.h
>

43 
	#__BTRFS_NEED_DEVICE_DATA_ORDERED


	)

44 
	#bŒfs_deviû_d©a_Üd”ed_š™
(
deviû
) \

45 
	`£qcouÁ_š™
(&
deviû
->
d©a_£qcouÁ
)

	)

47 
	#bŒfs_deviû_d©a_Üd”ed_š™
(
deviû
èdØ{ } 0)

	)

50 
	sbŒfs_deviû
 {

51 
li¡_h—d
 
	mdev_li¡
;

52 
li¡_h—d
 
	mdev_®loc_li¡
;

53 
bŒfs_fs_deviûs
 *
	mfs_deviûs
;

54 
bŒfs_fs_šfo
 *
	mfs_šfo
;

56 
rcu_¡ršg
 *
	mÇme
;

58 
u64
 
	mg’”©iÚ
;

60 
¥šlock_t
 
io_lock
 
	m____ÿch–še_®igÃd
;

61 
	mruÂšg_³ndšg
;

63 
bŒfs_³ndšg_bios
 
	m³ndšg_bios
;

65 
bŒfs_³ndšg_bios
 
	m³ndšg_sync_bios
;

67 
block_deviû
 *
	mbdev
;

70 
fmode_t
 
	mmode
;

72 
	mwr™—bË
;

73 
	mš_fs_m‘ad©a
;

74 
	mmissšg
;

75 
	mÿn_disÿrd
;

76 
	mis_tgtdev_fÜ_dev_»¶aû
;

77 
blk_¡©us_t
 
	mÏ¡_æush_”rÜ
;

78 
	mæush_bio_£Á
;

80 #ifdeà
__BTRFS_NEED_DEVICE_DATA_ORDERED


81 
£qcouÁ_t
 
	md©a_£qcouÁ
;

85 
u64
 
	mdevid
;

88 
u64
 
	mtÙ®_by‹s
;

91 
u64
 
	mdisk_tÙ®_by‹s
;

94 
u64
 
	mby‹s_u£d
;

97 
u32
 
	mio_®ign
;

100 
u32
 
	mio_width
;

102 
u64
 
	mty³
;

105 
u32
 
	m£ùÜ_size
;

108 
u8
 
	muuid
[
BTRFS_UUID_SIZE
];

116 
u64
 
	mcomm™_tÙ®_by‹s
;

119 
u64
 
	mcomm™_by‹s_u£d
;

125 
li¡_h—d
 
	m»sized_li¡
;

128 
bio
 *
	mæush_bio
;

129 
com¶‘iÚ
 
	mæush_wa™
;

132 
süub_ùx
 *
	msüub_deviû
;

134 
bŒfs_wÜk
 
	mwÜk
;

135 
rcu_h—d
 
	mrcu
;

136 
wÜk_¡ruù
 
	mrcu_wÜk
;

139 
¥šlock_t
 
	m»ada_lock
;

140 
©omic_t
 
	m»ada_š_æight
;

141 
u64
 
	m»ada_Ãxt
;

142 
»ada_zÚe
 *
	m»ada_cu¼_zÚe
;

143 
¿dix_Œ“_roÙ
 
	m»ada_zÚes
;

144 
¿dix_Œ“_roÙ
 
	m»ada_ex‹Ás
;

148 
	mdev_¡©s_v®id
;

151 
©omic_t
 
	mdev_¡©s_cút
;

152 
©omic_t
 
	mdev_¡©_v®ues
[
BTRFS_DEV_STAT_VALUES_MAX
];

159 #ià
BITS_PER_LONG
==32 && 
defšed
(
CONFIG_SMP
)

160 
	#BTRFS_DEVICE_GETSET_FUNCS
(
Çme
) \

161 
šlše
 
u64
 \

162 
bŒfs_deviû_g‘_
##
	`Çme
(cÚ¡ 
bŒfs_deviû
 *
dev
) \

164 
u64
 
size
; \

165 
£q
; \

168 
£q
 = 
	`»ad_£qcouÁ_begš
(&
dev
->
d©a_£qcouÁ
); \

169 
size
 = 
dev
->
Çme
; \

170 } 
	`»ad_£qcouÁ_»Œy
(&
dev
->
d©a_£qcouÁ
, 
£q
)); \

171  
size
; \

174 
šlše
 \

175 
bŒfs_deviû_£t_
##
	`Çme
(
bŒfs_deviû
 *
dev
, 
u64
 
size
) \

177 
	`´“m±_di§bË
(); \

178 
	`wr™e_£qcouÁ_begš
(&
dev
->
d©a_£qcouÁ
); \

179 
dev
->
Çme
 = 
size
; \

180 
	`wr™e_£qcouÁ_’d
(&
dev
->
d©a_£qcouÁ
); \

181 
	`´“m±_’abË
(); \

182 }

	)

183 #–ià
BITS_PER_LONG
==32 && 
defšed
(
CONFIG_PREEMPT
)

184 
	#BTRFS_DEVICE_GETSET_FUNCS
(
Çme
) \

185 
šlše
 
u64
 \

186 
bŒfs_deviû_g‘_
##
	`Çme
(cÚ¡ 
bŒfs_deviû
 *
dev
) \

188 
u64
 
size
; \

190 
	`´“m±_di§bË
(); \

191 
size
 = 
dev
->
Çme
; \

192 
	`´“m±_’abË
(); \

193  
size
; \

196 
šlše
 \

197 
bŒfs_deviû_£t_
##
	`Çme
(
bŒfs_deviû
 *
dev
, 
u64
 
size
) \

199 
	`´“m±_di§bË
(); \

200 
dev
->
Çme
 = 
size
; \

201 
	`´“m±_’abË
(); \

202 }

	)

204 
	#BTRFS_DEVICE_GETSET_FUNCS
(
Çme
) \

205 
šlše
 
u64
 \

206 
bŒfs_deviû_g‘_
##
	`Çme
(cÚ¡ 
bŒfs_deviû
 *
dev
) \

208  
dev
->
Çme
; \

211 
šlše
 \

212 
bŒfs_deviû_£t_
##
	`Çme
(
bŒfs_deviû
 *
dev
, 
u64
 
size
) \

214 
dev
->
Çme
 = 
size
; \

215 }

	)

218 
BTRFS_DEVICE_GETSET_FUNCS
(
tÙ®_by‹s
);

219 
BTRFS_DEVICE_GETSET_FUNCS
(
disk_tÙ®_by‹s
);

220 
BTRFS_DEVICE_GETSET_FUNCS
(
by‹s_u£d
);

222 
	sbŒfs_fs_deviûs
 {

223 
u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

225 
u64
 
	mnum_deviûs
;

226 
u64
 
	mÝ’_deviûs
;

227 
u64
 
	mrw_deviûs
;

228 
u64
 
	mmissšg_deviûs
;

229 
u64
 
	mtÙ®_rw_by‹s
;

230 
u64
 
	mtÙ®_deviûs
;

231 
block_deviû
 *
	mÏ‹¡_bdev
;

239 
mu‹x
 
	mdeviû_li¡_mu‹x
;

240 
li¡_h—d
 
	mdeviûs
;

242 
li¡_h—d
 
	m»sized_deviûs
;

244 
li¡_h—d
 
	m®loc_li¡
;

245 
li¡_h—d
 
	mli¡
;

247 
bŒfs_fs_deviûs
 *
	m£ed
;

248 
	m£edšg
;

250 
	mÝ’ed
;

255 
	mrÙ©šg
;

257 
bŒfs_fs_šfo
 *
	mfs_šfo
;

259 
kobjeù
 
	mfsid_kobj
;

260 
kobjeù
 *
	mdeviû_dœ_kobj
;

261 
com¶‘iÚ
 
	mkobj_uÄegi¡”
;

264 
	#BTRFS_BIO_INLINE_CSUM_SIZE
 64

	)

275 (
	tbŒfs_io_bio_’d_io_t
è(
	tbŒfs_io_bio
 *
	tbio
, 
	t”r
);

276 
	sbŒfs_io_bio
 {

277 
mœrÜ_num
;

278 
¡re_šdex
;

279 
u64
 
logiÿl
;

280 
u8
 *
csum
;

281 
u8
 
csum_šlše
[
BTRFS_BIO_INLINE_CSUM_SIZE
];

282 
u8
 *
csum_®loÿ‹d
;

283 
bŒfs_io_bio_’d_io_t
 *
’d_io
;

284 
bvec_™”
 
™”
;

289 
bio
 bio;

292 
šlše
 
bŒfs_io_bio
 *
	$bŒfs_io_bio
(
bio
 *bio)

294  
	`cÚš”_of
(
bio
, 
bŒfs_io_bio
, bio);

295 
	}
}

297 
	sbŒfs_bio_¡re
 {

298 
bŒfs_deviû
 *
	mdev
;

299 
u64
 
	mphysiÿl
;

300 
u64
 
	mËngth
;

303 
	gbŒfs_bio
;

304 (
	tbŒfs_bio_’d_io_t
è(
	tbŒfs_bio
 *
	tbio
, 
	t”r
);

306 
	sbŒfs_bio
 {

307 
»fcouÁ_t
 
»fs
;

308 
©omic_t
 
¡res_³ndšg
;

309 
bŒfs_fs_šfo
 *
fs_šfo
;

310 
u64
 
m­_ty³
;

311 
bio_’d_io_t
 *
’d_io
;

312 
bio
 *
Üig_bio
;

313 
æags
;

314 *
´iv©e
;

315 
©omic_t
 
”rÜ
;

316 
max_”rÜs
;

317 
num_¡res
;

318 
mœrÜ_num
;

319 
num_tgtdevs
;

320 *
tgtdev_m­
;

326 
u64
 *
¿id_m­
;

327 
bŒfs_bio_¡re
 
¡res
[];

330 
	sbŒfs_deviû_šfo
 {

331 
bŒfs_deviû
 *
dev
;

332 
u64
 
dev_off£t
;

333 
u64
 
max_avaž
;

334 
u64
 
tÙ®_avaž
;

337 
	sbŒfs_¿id_©Œ
 {

338 
sub_¡res
;

339 
dev_¡res
;

340 
devs_max
;

341 
devs_mš
;

342 
tÞ”©ed_çžu»s
;

343 
devs_šüem’t
;

344 
ncÝ›s
;

347 cÚ¡ 
bŒfs_¿id_©Œ
 
bŒfs_¿id_¬¿y
[
BTRFS_NR_RAID_TYPES
];

348 cÚ¡ 
bŒfs_¿id_mšdev_”rÜ
[
BTRFS_NR_RAID_TYPES
];

349 cÚ¡ 
u64
 
bŒfs_¿id_group
[
BTRFS_NR_RAID_TYPES
];

351 
	sm­_lookup
 {

352 
u64
 
ty³
;

353 
io_®ign
;

354 
io_width
;

355 
u64
 
¡re_Ën
;

356 
num_¡res
;

357 
sub_¡res
;

358 
bŒfs_bio_¡re
 
¡res
[];

361 
	#m­_lookup_size
(
n
è((
m­_lookup
) + \

362 ((
bŒfs_bio_¡re
è* (
n
)))

	)

364 
bŒfs_b®ªû_¬gs
;

365 
bŒfs_b®ªû_´og»ss
;

366 
	sbŒfs_b®ªû_cÚŒÞ
 {

367 
bŒfs_fs_šfo
 *
fs_šfo
;

369 
bŒfs_b®ªû_¬gs
 
d©a
;

370 
bŒfs_b®ªû_¬gs
 
m‘a
;

371 
bŒfs_b®ªû_¬gs
 
sys
;

373 
u64
 
æags
;

375 
bŒfs_b®ªû_´og»ss
 
¡©
;

378 
	ebŒfs_m­_Ý
 {

379 
BTRFS_MAP_READ
,

380 
BTRFS_MAP_WRITE
,

381 
BTRFS_MAP_DISCARD
,

382 
BTRFS_MAP_GET_READ_MIRRORS
,

385 
šlše
 
bŒfs_m­_Ý
 
	$bŒfs_Ý
(
bio
 *bio)

387 
	`bio_Ý
(
bio
)) {

388 
REQ_OP_DISCARD
:

389  
BTRFS_MAP_DISCARD
;

390 
REQ_OP_WRITE
:

391  
BTRFS_MAP_WRITE
;

393 
	`WARN_ON_ONCE
(1);

394 
REQ_OP_READ
:

395  
BTRFS_MAP_READ
;

397 
	}
}

399 
bŒfs_accouÁ_dev_ex‹Ás_size
(
bŒfs_deviû
 *
deviû
, 
u64
 
¡¬t
,

400 
u64
 
’d
, u64 *
Ëngth
);

401 
bŒfs_g‘_bbio
(
bŒfs_bio
 *
bbio
);

402 
bŒfs_put_bbio
(
bŒfs_bio
 *
bbio
);

403 
bŒfs_m­_block
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_m­_Ý
 
Ý
,

404 
u64
 
logiÿl
, u64 *
Ëngth
,

405 
bŒfs_bio
 **
bbio_»t
, 
mœrÜ_num
);

406 
bŒfs_m­_sblock
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bŒfs_m­_Ý
 
Ý
,

407 
u64
 
logiÿl
, u64 *
Ëngth
,

408 
bŒfs_bio
 **
bbio_»t
);

409 
bŒfs_rm­_block
(
bŒfs_fs_šfo
 *
fs_šfo
,

410 
u64
 
chunk_¡¬t
, u64 
physiÿl
, u64 
devid
,

411 
u64
 **
logiÿl
, *
Çddrs
, *
¡re_Ën
);

412 
bŒfs_»ad_sys_¬¿y
(
bŒfs_fs_šfo
 *
fs_šfo
);

413 
bŒfs_»ad_chunk_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

414 
bŒfs_®loc_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

415 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
ty³
);

416 
bŒfs_m­pšg_š™
(
bŒfs_m­pšg_Œ“
 *
Œ“
);

417 
bŒfs_m­pšg_Œ“_ä“
(
bŒfs_m­pšg_Œ“
 *
Œ“
);

418 
blk_¡©us_t
 
bŒfs_m­_bio
(
bŒfs_fs_šfo
 *
fs_šfo
, 
bio
 *bio,

419 
mœrÜ_num
, 
async_subm™
);

420 
bŒfs_Ý’_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
,

421 
fmode_t
 
æags
, *
hÞd”
);

422 
bŒfs_sÿn_Úe_deviû
(cÚ¡ *
·th
, 
fmode_t
 
æags
, *
hÞd”
,

423 
bŒfs_fs_deviûs
 **
fs_deviûs_»t
);

424 
bŒfs_þo£_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
);

425 
bŒfs_þo£_exŒa_deviûs
(
bŒfs_fs_deviûs
 *
fs_deviûs
, 
¡•
);

426 
bŒfs_assign_Ãxt_aùive_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

427 
bŒfs_deviû
 *
deviû
, bŒfs_deviû *
this_dev
);

428 
bŒfs_fšd_deviû_missšg_Ü_by_·th
(
bŒfs_fs_šfo
 *
fs_šfo
,

429 cÚ¡ *
deviû_·th
,

430 
bŒfs_deviû
 **
deviû
);

431 
bŒfs_fšd_deviû_by_dev¥ec
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

432 cÚ¡ *
dev·th
,

433 
bŒfs_deviû
 **
deviû
);

434 
bŒfs_deviû
 *
bŒfs_®loc_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

435 cÚ¡ 
u64
 *
devid
,

436 cÚ¡ 
u8
 *
uuid
);

437 
bŒfs_rm_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
,

438 cÚ¡ *
deviû_·th
, 
u64
 
devid
);

439 
bŒfs_þ—nup_fs_uuids
();

440 
bŒfs_num_cÝ›s
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
logiÿl
, u64 
Ën
);

441 
bŒfs_grow_deviû
(
bŒfs_Œªs_hªdË
 *
Œªs
,

442 
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
);

443 
bŒfs_deviû
 *
bŒfs_fšd_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

444 
u8
 *
uuid
, u8 *
fsid
);

445 
bŒfs_shršk_deviû
(
bŒfs_deviû
 *
deviû
, 
u64
 
Ãw_size
);

446 
bŒfs_š™_Ãw_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, cÚ¡ *
·th
);

447 
bŒfs_š™_dev_»¶aû_tgtdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

448 cÚ¡ *
deviû_·th
,

449 
bŒfs_deviû
 *
¤cdev
,

450 
bŒfs_deviû
 **
deviû_out
);

451 
bŒfs_b®ªû
(
bŒfs_b®ªû_cÚŒÞ
 *
bùl
,

452 
bŒfs_ioùl_b®ªû_¬gs
 *
b¬gs
);

453 
bŒfs_»sume_b®ªû_async
(
bŒfs_fs_šfo
 *
fs_šfo
);

454 
bŒfs_»cov”_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

455 
bŒfs_·u£_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

456 
bŒfs_ÿnûl_b®ªû
(
bŒfs_fs_šfo
 *
fs_šfo
);

457 
bŒfs_ü—‹_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

458 
bŒfs_check_uuid_Œ“
(
bŒfs_fs_šfo
 *
fs_šfo
);

459 
bŒfs_chunk_»adÚly
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
);

460 
fšd_ä“_dev_ex‹Á_¡¬t
(
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
,

461 
bŒfs_deviû
 *
deviû
, 
u64
 
num_by‹s
,

462 
u64
 
£¬ch_¡¬t
, u64 *
¡¬t
, u64 *
max_avaž
);

463 
fšd_ä“_dev_ex‹Á
(
bŒfs_Œªs_hªdË
 *
Œªs
,

464 
bŒfs_deviû
 *
deviû
, 
u64
 
num_by‹s
,

465 
u64
 *
¡¬t
, u64 *
max_avaž
);

466 
bŒfs_dev_¡©_šc_ªd_´št
(
bŒfs_deviû
 *
dev
, 
šdex
);

467 
bŒfs_g‘_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
,

468 
bŒfs_ioùl_g‘_dev_¡©s
 *
¡©s
);

469 
bŒfs_š™_deviûs_Ï‹
(
bŒfs_fs_šfo
 *
fs_šfo
);

470 
bŒfs_š™_dev_¡©s
(
bŒfs_fs_šfo
 *
fs_šfo
);

471 
bŒfs_run_dev_¡©s
(
bŒfs_Œªs_hªdË
 *
Œªs
,

472 
bŒfs_fs_šfo
 *
fs_šfo
);

473 
bŒfs_rm_dev_»¶aû_»move_¤cdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

474 
bŒfs_deviû
 *
¤cdev
);

475 
bŒfs_rm_dev_»¶aû_ä“_¤cdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

476 
bŒfs_deviû
 *
¤cdev
);

477 
bŒfs_de¡roy_dev_»¶aû_tgtdev
(
bŒfs_fs_šfo
 *
fs_šfo
,

478 
bŒfs_deviû
 *
tgtdev
);

479 
bŒfs_š™_dev_»¶aû_tgtdev_fÜ_»sume
(
bŒfs_fs_šfo
 *
fs_šfo
,

480 
bŒfs_deviû
 *
tgtdev
);

481 
bŒfs_sü©ch_su³rblocks
(
block_deviû
 *
bdev
, cÚ¡ *
deviû_·th
);

482 
bŒfs_is_·r™y_mœrÜ
(
bŒfs_fs_šfo
 *
fs_šfo
,

483 
u64
 
logiÿl
, u64 
Ën
);

484 
bŒfs_fuÎ_¡re_Ën
(
bŒfs_fs_šfo
 *
fs_šfo
,

485 
u64
 
logiÿl
);

486 
bŒfs_fšish_chunk_®loc
(
bŒfs_Œªs_hªdË
 *
Œªs
,

487 
bŒfs_fs_šfo
 *
fs_šfo
,

488 
u64
 
chunk_off£t
, u64 
chunk_size
);

489 
bŒfs_»move_chunk
(
bŒfs_Œªs_hªdË
 *
Œªs
,

490 
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
chunk_off£t
);

492 
šlše
 
	$bŒfs_dev_¡©s_dœty
(
bŒfs_deviû
 *
dev
)

494  
	`©omic_»ad
(&
dev
->
dev_¡©s_cút
);

495 
	}
}

497 
šlše
 
	$bŒfs_dev_¡©_šc
(
bŒfs_deviû
 *
dev
,

498 
šdex
)

500 
	`©omic_šc
(
dev
->
dev_¡©_v®ues
 + 
šdex
);

501 
	`smp_mb__befÜe_©omic
();

502 
	`©omic_šc
(&
dev
->
dev_¡©s_cút
);

503 
	}
}

505 
šlše
 
	$bŒfs_dev_¡©_»ad
(
bŒfs_deviû
 *
dev
,

506 
šdex
)

508  
	`©omic_»ad
(
dev
->
dev_¡©_v®ues
 + 
šdex
);

509 
	}
}

511 
šlše
 
	$bŒfs_dev_¡©_»ad_ªd_»£t
(
bŒfs_deviû
 *
dev
,

512 
šdex
)

514 
»t
;

516 
»t
 = 
	`©omic_xchg
(
dev
->
dev_¡©_v®ues
 + 
šdex
, 0);

517 
	`smp_mb__befÜe_©omic
();

518 
	`©omic_šc
(&
dev
->
dev_¡©s_cút
);

519  
»t
;

520 
	}
}

522 
šlše
 
	$bŒfs_dev_¡©_£t
(
bŒfs_deviû
 *
dev
,

523 
šdex
, 
v®
)

525 
	`©omic_£t
(
dev
->
dev_¡©_v®ues
 + 
šdex
, 
v®
);

526 
	`smp_mb__befÜe_©omic
();

527 
	`©omic_šc
(&
dev
->
dev_¡©s_cút
);

528 
	}
}

530 
šlše
 
	$bŒfs_dev_¡©_»£t
(
bŒfs_deviû
 *
dev
,

531 
šdex
)

533 
	`bŒfs_dev_¡©_£t
(
dev
, 
šdex
, 0);

534 
	}
}

536 
bŒfs_upd©e_comm™_deviû_size
(
bŒfs_fs_šfo
 *
fs_šfo
);

537 
bŒfs_upd©e_comm™_deviû_by‹s_u£d
(
bŒfs_fs_šfo
 *
fs_šfo
,

538 
bŒfs_Œª§ùiÚ
 *
Œª§ùiÚ
);

540 
li¡_h—d
 *
bŒfs_g‘_fs_uuids
();

541 
bŒfs_£t_fs_šfo_±r
(
bŒfs_fs_šfo
 *
fs_šfo
);

542 
bŒfs_»£t_fs_šfo_±r
(
bŒfs_fs_šfo
 *
fs_šfo
);

544 
boÞ
 
bŒfs_check_rw_deg¿dabË
(
bŒfs_fs_šfo
 *
fs_šfo
);

545 
bŒfs_»pÜt_missšg_deviû
(
bŒfs_fs_šfo
 *
fs_šfo
, 
u64
 
devid
,

546 
u8
 *
uuid
);

	@xattr.c

19 
	~<lšux/š™.h
>

20 
	~<lšux/fs.h
>

21 
	~<lšux/¦ab.h
>

22 
	~<lšux/rw£m.h
>

23 
	~<lšux/x©Œ.h
>

24 
	~<lšux/£cur™y.h
>

25 
	~<lšux/posix_aþ_x©Œ.h
>

26 
	~"ù»e.h
"

27 
	~"bŒfs_šode.h
"

28 
	~"Œª§ùiÚ.h
"

29 
	~"x©Œ.h
"

30 
	~"disk-io.h
"

31 
	~"´Ýs.h
"

32 
	~"lockšg.h
"

35 
ssize_t
 
	$__bŒfs_g‘x©Œ
(
šode
 *šode, cÚ¡ *
Çme
,

36 *
bufãr
, 
size_t
 
size
)

38 
bŒfs_dœ_™em
 *
di
;

39 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

40 
bŒfs_·th
 *
·th
;

41 
ex‹Á_bufãr
 *
Ëaf
;

42 
»t
 = 0;

43 
d©a_±r
;

45 
·th
 = 
	`bŒfs_®loc_·th
();

46 ià(!
·th
)

47  -
ENOMEM
;

50 
di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

51 
Çme
, 
	`¡¾’
(name), 0);

52 ià(!
di
) {

53 
»t
 = -
ENODATA
;

54 
out
;

55 } ià(
	`IS_ERR
(
di
)) {

56 
»t
 = 
	`PTR_ERR
(
di
);

57 
out
;

60 
Ëaf
 = 
·th
->
nodes
[0];

62 ià(!
size
) {

63 
»t
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

64 
out
;

68 ià(
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
è> 
size
) {

69 
»t
 = -
ERANGE
;

70 
out
;

80 
d©a_±r
 = ()((*)(
di
 + 1) +

81 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
));

82 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
bufãr
, 
d©a_±r
,

83 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
));

84 
»t
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

86 
out
:

87 
	`bŒfs_ä“_·th
(
·th
);

88  
»t
;

89 
	}
}

91 
	$do_£tx©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

92 
šode
 *šode, cÚ¡ *
Çme
,

93 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
)

95 
bŒfs_dœ_™em
 *
di
 = 
NULL
;

96 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

97 
bŒfs_fs_šfo
 *
fs_šfo
 = 
roÙ
->fs_info;

98 
bŒfs_·th
 *
·th
;

99 
size_t
 
Çme_Ën
 = 
	`¡¾’
(
Çme
);

100 
»t
 = 0;

102 ià(
Çme_Ën
 + 
size
 > 
	`BTRFS_MAX_XATTR_SIZE
(
roÙ
->
fs_šfo
))

103  -
ENOSPC
;

105 
·th
 = 
	`bŒfs_®loc_·th
();

106 ià(!
·th
)

107  -
ENOMEM
;

108 
·th
->
sk_»Ëa£_Ú_”rÜ
 = 1;

110 ià(!
v®ue
) {

111 
di
 = 
	`bŒfs_lookup_x©Œ
(
Œªs
, 
roÙ
, 
·th
,

112 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
Çme
, 
Çme_Ën
, -1);

113 ià(!
di
 && (
æags
 & 
XATTR_REPLACE
))

114 
»t
 = -
ENODATA
;

115 ià(
	`IS_ERR
(
di
))

116 
»t
 = 
	`PTR_ERR
(
di
);

117 ià(
di
)

118 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

119 
out
;

129 ià(
æags
 & 
XATTR_REPLACE
) {

130 
	`ASSERT
(
	`šode_is_locked
(
šode
));

131 
di
 = 
	`bŒfs_lookup_x©Œ
(
NULL
, 
roÙ
, 
·th
,

132 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)), 
Çme
, 
Çme_Ën
, 0);

133 ià(!
di
)

134 
»t
 = -
ENODATA
;

135 ià(
	`IS_ERR
(
di
))

136 
»t
 = 
	`PTR_ERR
(
di
);

137 ià(
»t
)

138 
out
;

139 
	`bŒfs_»Ëa£_·th
(
·th
);

140 
di
 = 
NULL
;

143 
»t
 = 
	`bŒfs_š£¹_x©Œ_™em
(
Œªs
, 
roÙ
, 
·th
, 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
)),

144 
Çme
, 
Çme_Ën
, 
v®ue
, 
size
);

145 ià(
»t
 =ð-
EOVERFLOW
) {

151 
»t
 = 0;

152 
	`bŒfs_as£¹_Œ“_locked
(
·th
->
nodes
[0]);

153 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

154 ià(!
di
 && !(
æags
 & 
XATTR_REPLACE
)) {

155 
»t
 = -
ENOSPC
;

156 
out
;

158 } ià(
»t
 =ð-
EEXIST
) {

159 
»t
 = 0;

160 
di
 = 
	`bŒfs_m©ch_dœ_™em_Çme
(
fs_šfo
, 
·th
, 
Çme
, 
Çme_Ën
);

161 
	`ASSERT
(
di
);

162 } ià(
»t
) {

163 
out
;

166 ià(
di
 && (
æags
 & 
XATTR_CREATE
)) {

167 
»t
 = -
EEXIST
;

168 
out
;

171 ià(
di
) {

179 cÚ¡ 
¦Ù
 = 
·th
->
¦Ùs
[0];

180 
ex‹Á_bufãr
 *
Ëaf
 = 
·th
->
nodes
[0];

181 cÚ¡ 
u16
 
Þd_d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

182 cÚ¡ 
u32
 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

183 cÚ¡ 
u32
 
d©a_size
 = (*
di
è+ 
Çme_Ën
 + 
size
;

184 
bŒfs_™em
 *
™em
;

185 
d©a_±r
;

186 *
±r
;

188 ià(
size
 > 
Þd_d©a_Ën
) {

189 ià(
	`bŒfs_Ëaf_ä“_¥aû
(
fs_šfo
, 
Ëaf
) <

190 (
size
 - 
Þd_d©a_Ën
)) {

191 
»t
 = -
ENOSPC
;

192 
out
;

196 ià(
Þd_d©a_Ën
 + 
Çme_Ën
 + (*
di
è=ð
™em_size
) {

198 ià(
size
 > 
Þd_d©a_Ën
)

199 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
,

200 
size
 - 
Þd_d©a_Ën
);

201 ià(
size
 < 
Þd_d©a_Ën
)

202 
	`bŒfs_Œunÿ‹_™em
(
fs_šfo
, 
·th
,

203 
d©a_size
, 1);

206 
»t
 = 
	`bŒfs_d–‘e_Úe_dœ_Çme
(
Œªs
, 
roÙ
, 
·th
, 
di
);

207 ià(
»t
)

208 
out
;

209 
	`bŒfs_ex‹nd_™em
(
fs_šfo
, 
·th
, 
d©a_size
);

212 
™em
 = 
	`bŒfs_™em_Ä
(
¦Ù
);

213 
±r
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, );

214 
±r
 +ð
	`bŒfs_™em_size
(
Ëaf
, 
™em
è- 
d©a_size
;

215 
di
 = (
bŒfs_dœ_™em
 *)
±r
;

216 
	`bŒfs_£t_dœ_d©a_Ën
(
Ëaf
, 
di
, 
size
);

217 
d©a_±r
 = (()(
di
 + 1)è+ 
Çme_Ën
;

218 
	`wr™e_ex‹Á_bufãr
(
Ëaf
, 
v®ue
, 
d©a_±r
, 
size
);

219 
	`bŒfs_m¬k_bufãr_dœty
(
Ëaf
);

227 
out
:

228 
	`bŒfs_ä“_·th
(
·th
);

229  
»t
;

230 
	}
}

235 
	$__bŒfs_£tx©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

236 
šode
 *šode, cÚ¡ *
Çme
,

237 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
)

239 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

240 
»t
;

242 ià(
	`bŒfs_roÙ_»adÚly
(
roÙ
))

243  -
EROFS
;

245 ià(
Œªs
)

246  
	`do_£tx©Œ
(
Œªs
, 
šode
, 
Çme
, 
v®ue
, 
size
, 
æags
);

248 
Œªs
 = 
	`bŒfs_¡¬t_Œª§ùiÚ
(
roÙ
, 2);

249 ià(
	`IS_ERR
(
Œªs
))

250  
	`PTR_ERR
(
Œªs
);

252 
»t
 = 
	`do_£tx©Œ
(
Œªs
, 
šode
, 
Çme
, 
v®ue
, 
size
, 
æags
);

253 ià(
»t
)

254 
out
;

256 
	`šode_šc_iv”siÚ
(
šode
);

257 
šode
->
i_ùime
 = 
	`cu¼’t_time
(inode);

258 
	`£t_b™
(
BTRFS_INODE_COPY_EVERYTHING
, &
	`BTRFS_I
(
šode
)->
ruÁime_æags
);

259 
»t
 = 
	`bŒfs_upd©e_šode
(
Œªs
, 
roÙ
, 
šode
);

260 
	`BUG_ON
(
»t
);

261 
out
:

262 
	`bŒfs_’d_Œª§ùiÚ
(
Œªs
);

263  
»t
;

264 
	}
}

266 
ssize_t
 
	$bŒfs_li¡x©Œ
(
d’Œy
 *d’Œy, *
bufãr
, 
size_t
 
size
)

268 
bŒfs_key
 
key
;

269 
šode
 *šodð
	`d_šode
(
d’Œy
);

270 
bŒfs_fs_šfo
 *
fs_šfo
 = 
	`bŒfs_sb
(
šode
->
i_sb
);

271 
bŒfs_roÙ
 *
roÙ
 = 
	`BTRFS_I
(
šode
)->root;

272 
bŒfs_·th
 *
·th
;

273 
»t
 = 0;

274 
size_t
 
tÙ®_size
 = 0, 
size_Ëá
 = 
size
;

281 
key
.
objeùid
 = 
	`bŒfs_šo
(
	`BTRFS_I
(
šode
));

282 
key
.
ty³
 = 
BTRFS_XATTR_ITEM_KEY
;

283 
key
.
off£t
 = 0;

285 
·th
 = 
	`bŒfs_®loc_·th
();

286 ià(!
·th
)

287  -
ENOMEM
;

288 
·th
->
»ada
 = 
READA_FORWARD
;

291 
»t
 = 
	`bŒfs_£¬ch_¦Ù
(
NULL
, 
roÙ
, &
key
, 
·th
, 0, 0);

292 ià(
»t
 < 0)

293 
”r
;

296 
ex‹Á_bufãr
 *
Ëaf
;

297 
¦Ù
;

298 
bŒfs_dœ_™em
 *
di
;

299 
bŒfs_key
 
found_key
;

300 
u32
 
™em_size
;

301 
u32
 
cur
;

303 
Ëaf
 = 
·th
->
nodes
[0];

304 
¦Ù
 = 
·th
->
¦Ùs
[0];

307 ià(
¦Ù
 >ð
	`bŒfs_h—d”_Ä™ems
(
Ëaf
)) {

312 
»t
 = 
	`bŒfs_Ãxt_Ëaf
(
roÙ
, 
·th
);

313 ià(
»t
 < 0)

314 
”r
;

315 ià(
»t
 > 0)

320 
	`bŒfs_™em_key_to_ýu
(
Ëaf
, &
found_key
, 
¦Ù
);

323 ià(
found_key
.
objeùid
 !ð
key
.objectid)

325 ià(
found_key
.
ty³
 > 
BTRFS_XATTR_ITEM_KEY
)

327 ià(
found_key
.
ty³
 < 
BTRFS_XATTR_ITEM_KEY
)

328 
Ãxt_™em
;

330 
di
 = 
	`bŒfs_™em_±r
(
Ëaf
, 
¦Ù
, 
bŒfs_dœ_™em
);

331 
™em_size
 = 
	`bŒfs_™em_size_Ä
(
Ëaf
, 
¦Ù
);

332 
cur
 = 0;

333 
cur
 < 
™em_size
) {

334 
u16
 
Çme_Ën
 = 
	`bŒfs_dœ_Çme_Ën
(
Ëaf
, 
di
);

335 
u16
 
d©a_Ën
 = 
	`bŒfs_dœ_d©a_Ën
(
Ëaf
, 
di
);

336 
u32
 
this_Ën
 = (*
di
è+ 
Çme_Ën
 + 
d©a_Ën
;

337 
Çme_±r
 = ()(
di
 + 1);

339 ià(
	`v”ify_dœ_™em
(
fs_šfo
, 
Ëaf
, 
¦Ù
, 
di
)) {

340 
»t
 = -
EIO
;

341 
”r
;

344 
tÙ®_size
 +ð
Çme_Ën
 + 1;

349 ià(!
size
)

350 
Ãxt
;

352 ià(!
bufãr
 || (
Çme_Ën
 + 1è> 
size_Ëá
) {

353 
»t
 = -
ERANGE
;

354 
”r
;

357 
	`»ad_ex‹Á_bufãr
(
Ëaf
, 
bufãr
, 
Çme_±r
, 
Çme_Ën
);

358 
bufãr
[
Çme_Ën
] = '\0';

360 
size_Ëá
 -ð
Çme_Ën
 + 1;

361 
bufãr
 +ð
Çme_Ën
 + 1;

362 
Ãxt
:

363 
cur
 +ð
this_Ën
;

364 
di
 = (
bŒfs_dœ_™em
 *)((*)d˜+ 
this_Ën
);

366 
Ãxt_™em
:

367 
·th
->
¦Ùs
[0]++;

369 
»t
 = 
tÙ®_size
;

371 
”r
:

372 
	`bŒfs_ä“_·th
(
·th
);

374  
»t
;

375 
	}
}

377 
	$bŒfs_x©Œ_hªdËr_g‘
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

378 
d’Œy
 *
unu£d
, 
šode
 *inode,

379 cÚ¡ *
Çme
, *
bufãr
, 
size_t
 
size
)

381 
Çme
 = 
	`x©Œ_fuÎ_Çme
(
hªdËr
,‚ame);

382  
	`__bŒfs_g‘x©Œ
(
šode
, 
Çme
, 
bufãr
, 
size
);

383 
	}
}

385 
	$bŒfs_x©Œ_hªdËr_£t
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

386 
d’Œy
 *
unu£d
, 
šode
 *inode,

387 cÚ¡ *
Çme
, cÚ¡ *
bufãr
,

388 
size_t
 
size
, 
æags
)

390 
Çme
 = 
	`x©Œ_fuÎ_Çme
(
hªdËr
,‚ame);

391  
	`__bŒfs_£tx©Œ
(
NULL
, 
šode
, 
Çme
, 
bufãr
, 
size
, 
æags
);

392 
	}
}

394 
	$bŒfs_x©Œ_hªdËr_£t_´Ý
(cÚ¡ 
x©Œ_hªdËr
 *
hªdËr
,

395 
d’Œy
 *
unu£d
, 
šode
 *inode,

396 cÚ¡ *
Çme
, cÚ¡ *
v®ue
,

397 
size_t
 
size
, 
æags
)

399 
Çme
 = 
	`x©Œ_fuÎ_Çme
(
hªdËr
,‚ame);

400  
	`bŒfs_£t_´Ý
(
šode
, 
Çme
, 
v®ue
, 
size
, 
æags
);

401 
	}
}

403 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_£cur™y_x©Œ_hªdËr
 = {

404 .
´efix
 = 
XATTR_SECURITY_PREFIX
,

405 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

406 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t
,

409 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_Œu¡ed_x©Œ_hªdËr
 = {

410 .
´efix
 = 
XATTR_TRUSTED_PREFIX
,

411 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

412 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t
,

415 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_u£r_x©Œ_hªdËr
 = {

416 .
´efix
 = 
XATTR_USER_PREFIX
,

417 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

418 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t
,

421 cÚ¡ 
x©Œ_hªdËr
 
	gbŒfs_bŒfs_x©Œ_hªdËr
 = {

422 .
´efix
 = 
XATTR_BTRFS_PREFIX
,

423 .
	gg‘
 = 
bŒfs_x©Œ_hªdËr_g‘
,

424 .
	g£t
 = 
bŒfs_x©Œ_hªdËr_£t_´Ý
,

427 cÚ¡ 
x©Œ_hªdËr
 *
	gbŒfs_x©Œ_hªdËrs
[] = {

428 &
bŒfs_£cur™y_x©Œ_hªdËr
,

429 #ifdeà
CONFIG_BTRFS_FS_POSIX_ACL


430 &
posix_aþ_acûss_x©Œ_hªdËr
,

431 &
posix_aþ_deçuÉ_x©Œ_hªdËr
,

433 &
bŒfs_Œu¡ed_x©Œ_hªdËr
,

434 &
bŒfs_u£r_x©Œ_hªdËr
,

435 &
bŒfs_bŒfs_x©Œ_hªdËr
,

436 
NULL
,

439 
	$bŒfs_š™x©Œs
(
šode
 *inode,

440 cÚ¡ 
x©Œ
 *
x©Œ_¬¿y
, *
fs_šfo
)

442 cÚ¡ 
x©Œ
 *xattr;

443 
bŒfs_Œªs_hªdË
 *
Œªs
 = 
fs_šfo
;

444 *
Çme
;

445 
”r
 = 0;

447 
x©Œ
 = 
x©Œ_¬¿y
; x©Œ->
Çme
 !ð
NULL
; xattr++) {

448 
Çme
 = 
	`km®loc
(
XATTR_SECURITY_PREFIX_LEN
 +

449 
	`¡¾’
(
x©Œ
->
Çme
è+ 1, 
GFP_KERNEL
);

450 ià(!
Çme
) {

451 
”r
 = -
ENOMEM
;

454 
	`¡rýy
(
Çme
, 
XATTR_SECURITY_PREFIX
);

455 
	`¡rýy
(
Çme
 + 
XATTR_SECURITY_PREFIX_LEN
, 
x©Œ
->name);

456 
”r
 = 
	`__bŒfs_£tx©Œ
(
Œªs
, 
šode
, 
Çme
,

457 
x©Œ
->
v®ue
, x©Œ->
v®ue_Ën
, 0);

458 
	`kä“
(
Çme
);

459 ià(
”r
 < 0)

462  
”r
;

463 
	}
}

465 
	$bŒfs_x©Œ_£cur™y_š™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

466 
šode
 *šode, šod*
dœ
,

467 cÚ¡ 
q¡r
 *qstr)

469  
	`£cur™y_šode_š™_£cur™y
(
šode
, 
dœ
, 
q¡r
,

470 &
bŒfs_š™x©Œs
, 
Œªs
);

471 
	}
}

	@xattr.h

19 #iâdeà
__XATTR__


20 
	#__XATTR__


	)

22 
	~<lšux/x©Œ.h
>

24 cÚ¡ 
x©Œ_hªdËr
 *
bŒfs_x©Œ_hªdËrs
[];

26 
ssize_t
 
__bŒfs_g‘x©Œ
(
šode
 *šode, cÚ¡ *
Çme
,

27 *
bufãr
, 
size_t
 
size
);

28 
__bŒfs_£tx©Œ
(
bŒfs_Œªs_hªdË
 *
Œªs
,

29 
šode
 *šode, cÚ¡ *
Çme
,

30 cÚ¡ *
v®ue
, 
size_t
 
size
, 
æags
);

32 
bŒfs_x©Œ_£cur™y_š™
(
bŒfs_Œªs_hªdË
 *
Œªs
,

33 
šode
 *šode, šod*
dœ
,

34 cÚ¡ 
q¡r
 *qstr);

	@zlib.c

23 
	~<lšux/k”Ãl.h
>

24 
	~<lšux/¦ab.h
>

25 
	~<lšux/zlib.h
>

26 
	~<lšux/zutž.h
>

27 
	~<lšux/mm.h
>

28 
	~<lšux/š™.h
>

29 
	~<lšux/”r.h
>

30 
	~<lšux/sched.h
>

31 
	~<lšux/·gem­.h
>

32 
	~<lšux/bio.h
>

33 
	~<lšux/»fcouÁ.h
>

34 
	~"com´essiÚ.h
"

36 
	swÜk¥aû
 {

37 
z_¡»am
 
	m¡rm
;

38 *
	mbuf
;

39 
li¡_h—d
 
	mli¡
;

42 
	$zlib_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
)

44 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

46 
	`kvä“
(
wÜk¥aû
->
¡rm
.workspace);

47 
	`kä“
(
wÜk¥aû
->
buf
);

48 
	`kä“
(
wÜk¥aû
);

49 
	}
}

51 
li¡_h—d
 *
	$zlib_®loc_wÜk¥aû
()

53 
wÜk¥aû
 *workspace;

54 
wÜk¥aûsize
;

56 
wÜk¥aû
 = 
	`kz®loc
((*wÜk¥aû), 
GFP_KERNEL
);

57 ià(!
wÜk¥aû
)

58  
	`ERR_PTR
(-
ENOMEM
);

60 
wÜk¥aûsize
 = 
	`max
(
	`zlib_deæ©e_wÜk¥aûsize
(
MAX_WBITS
, 
MAX_MEM_LEVEL
),

61 
	`zlib_šæ©e_wÜk¥aûsize
());

62 
wÜk¥aû
->
¡rm
.wÜk¥aû = 
	`kvm®loc
(
wÜk¥aûsize
, 
GFP_KERNEL
);

63 
wÜk¥aû
->
buf
 = 
	`km®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

64 ià(!
wÜk¥aû
->
¡rm
.wÜk¥aû || !wÜk¥aû->
buf
)

65 
çž
;

67 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
li¡
);

69  &
wÜk¥aû
->
li¡
;

70 
çž
:

71 
	`zlib_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

72  
	`ERR_PTR
(-
ENOMEM
);

73 
	}
}

75 
	$zlib_com´ess_·ges
(
li¡_h—d
 *
ws
,

76 
add»ss_¥aû
 *
m­pšg
,

77 
u64
 
¡¬t
,

78 
·ge
 **
·ges
,

79 *
out_·ges
,

80 *
tÙ®_š
,

81 *
tÙ®_out
)

83 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

84 
»t
;

85 *
d©a_š
;

86 *
ýage_out
;

87 
Ä_·ges
 = 0;

88 
·ge
 *
š_·ge
 = 
NULL
;

89 
·ge
 *
out_·ge
 = 
NULL
;

90 
by‹s_Ëá
;

91 
Ën
 = *
tÙ®_out
;

92 
Ä_de¡_·ges
 = *
out_·ges
;

93 cÚ¡ 
max_out
 = 
Ä_de¡_·ges
 * 
PAGE_SIZE
;

95 *
out_·ges
 = 0;

96 *
tÙ®_out
 = 0;

97 *
tÙ®_š
 = 0;

99 ià(
Z_OK
 !ð
	`zlib_deæ©eIn™
(&
wÜk¥aû
->
¡rm
, 3)) {

100 
	`´_w¬n
("BTRFS: deflateInit failed\n");

101 
»t
 = -
EIO
;

102 
out
;

105 
wÜk¥aû
->
¡rm
.
tÙ®_š
 = 0;

106 
wÜk¥aû
->
¡rm
.
tÙ®_out
 = 0;

108 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

109 
d©a_š
 = 
	`km­
(
š_·ge
);

111 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

112 ià(
out_·ge
 =ð
NULL
) {

113 
»t
 = -
ENOMEM
;

114 
out
;

116 
ýage_out
 = 
	`km­
(
out_·ge
);

117 
·ges
[0] = 
out_·ge
;

118 
Ä_·ges
 = 1;

120 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

121 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = 
ýage_out
;

122 
wÜk¥aû
->
¡rm
.
avaž_out
 = 
PAGE_SIZE
;

123 
wÜk¥aû
->
¡rm
.
avaž_š
 = 
	`mš
(
Ën
, 
PAGE_SIZE
);

125 
wÜk¥aû
->
¡rm
.
tÙ®_š
 < 
Ën
) {

126 
»t
 = 
	`zlib_deæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_SYNC_FLUSH
);

127 ià(
»t
 !ð
Z_OK
) {

128 
	`´_debug
("BTRFS: deflate in†oop„eturned %d\n",

129 
»t
);

130 
	`zlib_deæ©eEnd
(&
wÜk¥aû
->
¡rm
);

131 
»t
 = -
EIO
;

132 
out
;

136 ià(
wÜk¥aû
->
¡rm
.
tÙ®_š
 > 8192 &&

137 
wÜk¥aû
->
¡rm
.
tÙ®_š
 <

138 
wÜk¥aû
->
¡rm
.
tÙ®_out
) {

139 
»t
 = -
E2BIG
;

140 
out
;

146 ià(
wÜk¥aû
->
¡rm
.
avaž_out
 == 0) {

147 
	`kunm­
(
out_·ge
);

148 ià(
Ä_·ges
 =ð
Ä_de¡_·ges
) {

149 
out_·ge
 = 
NULL
;

150 
»t
 = -
E2BIG
;

151 
out
;

153 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

154 ià(
out_·ge
 =ð
NULL
) {

155 
»t
 = -
ENOMEM
;

156 
out
;

158 
ýage_out
 = 
	`km­
(
out_·ge
);

159 
·ges
[
Ä_·ges
] = 
out_·ge
;

160 
Ä_·ges
++;

161 
wÜk¥aû
->
¡rm
.
avaž_out
 = 
PAGE_SIZE
;

162 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = 
ýage_out
;

165 ià(
wÜk¥aû
->
¡rm
.
tÙ®_š
 >ð
Ën
)

169 ià(
wÜk¥aû
->
¡rm
.
avaž_š
 == 0) {

170 ià(
wÜk¥aû
->
¡rm
.
tÙ®_out
 > 
max_out
)

173 
by‹s_Ëá
 = 
Ën
 - 
wÜk¥aû
->
¡rm
.
tÙ®_š
;

174 
	`kunm­
(
š_·ge
);

175 
	`put_·ge
(
š_·ge
);

177 
¡¬t
 +ð
PAGE_SIZE
;

178 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
,

179 
¡¬t
 >> 
PAGE_SHIFT
);

180 
d©a_š
 = 
	`km­
(
š_·ge
);

181 
wÜk¥aû
->
¡rm
.
avaž_š
 = 
	`mš
(
by‹s_Ëá
,

182 
PAGE_SIZE
);

183 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

186 
wÜk¥aû
->
¡rm
.
avaž_š
 = 0;

187 
»t
 = 
	`zlib_deæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_FINISH
);

188 
	`zlib_deæ©eEnd
(&
wÜk¥aû
->
¡rm
);

190 ià(
»t
 !ð
Z_STREAM_END
) {

191 
»t
 = -
EIO
;

192 
out
;

195 ià(
wÜk¥aû
->
¡rm
.
tÙ®_out
 >ðwÜk¥aû->¡rm.
tÙ®_š
) {

196 
»t
 = -
E2BIG
;

197 
out
;

200 
»t
 = 0;

201 *
tÙ®_out
 = 
wÜk¥aû
->
¡rm
.total_out;

202 *
tÙ®_š
 = 
wÜk¥aû
->
¡rm
.total_in;

203 
out
:

204 *
out_·ges
 = 
Ä_·ges
;

205 ià(
out_·ge
)

206 
	`kunm­
(
out_·ge
);

208 ià(
š_·ge
) {

209 
	`kunm­
(
š_·ge
);

210 
	`put_·ge
(
š_·ge
);

212  
»t
;

213 
	}
}

215 
	$zlib_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
)

217 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

218 
»t
 = 0, 
»t2
;

219 
wb™s
 = 
MAX_WBITS
;

220 *
d©a_š
;

221 
size_t
 
tÙ®_out
 = 0;

222 
·ge_š_šdex
 = 0;

223 
size_t
 
¤þ’
 = 
cb
->
com´es£d_Ën
;

224 
tÙ®_·ges_š
 = 
	`DIV_ROUND_UP
(
¤þ’
, 
PAGE_SIZE
);

225 
buf_¡¬t
;

226 
·ge
 **
·ges_š
 = 
cb
->
com´es£d_·ges
;

227 
u64
 
disk_¡¬t
 = 
cb
->
¡¬t
;

228 
bio
 *
Üig_bio
 = 
cb
->orig_bio;

230 
d©a_š
 = 
	`km­
(
·ges_š
[
·ge_š_šdex
]);

231 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

232 
wÜk¥aû
->
¡rm
.
avaž_š
 = 
	`mš_t
(
size_t
, 
¤þ’
, 
PAGE_SIZE
);

233 
wÜk¥aû
->
¡rm
.
tÙ®_š
 = 0;

235 
wÜk¥aû
->
¡rm
.
tÙ®_out
 = 0;

236 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

237 
wÜk¥aû
->
¡rm
.
avaž_out
 = 
PAGE_SIZE
;

241 ià(
¤þ’
 > 2 && !(
d©a_š
[1] & 
PRESET_DICT
) &&

242 ((
d©a_š
[0] & 0x0fè=ð
Z_DEFLATED
) &&

243 !(((
d©a_š
[0]<<8) + data_in[1]) % 31)) {

245 
wb™s
 = -((
d©a_š
[0] >> 4) + 8);

246 
wÜk¥aû
->
¡rm
.
Ãxt_š
 += 2;

247 
wÜk¥aû
->
¡rm
.
avaž_š
 -= 2;

250 ià(
Z_OK
 !ð
	`zlib_šæ©eIn™2
(&
wÜk¥aû
->
¡rm
, 
wb™s
)) {

251 
	`´_w¬n
("BTRFS: inflateInit failed\n");

252 
	`kunm­
(
·ges_š
[
·ge_š_šdex
]);

253  -
EIO
;

255 
wÜk¥aû
->
¡rm
.
tÙ®_š
 < 
¤þ’
) {

256 
»t
 = 
	`zlib_šæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_NO_FLUSH
);

257 ià(
»t
 !ð
Z_OK
 &&„‘ !ð
Z_STREAM_END
)

260 
buf_¡¬t
 = 
tÙ®_out
;

261 
tÙ®_out
 = 
wÜk¥aû
->
¡rm
.total_out;

264 ià(
buf_¡¬t
 =ð
tÙ®_out
)

267 
»t2
 = 
	`bŒfs_decom´ess_buf2·ge
(
wÜk¥aû
->
buf
, 
buf_¡¬t
,

268 
tÙ®_out
, 
disk_¡¬t
,

269 
Üig_bio
);

270 ià(
»t2
 == 0) {

271 
»t
 = 0;

272 
dÚe
;

275 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

276 
wÜk¥aû
->
¡rm
.
avaž_out
 = 
PAGE_SIZE
;

278 ià(
wÜk¥aû
->
¡rm
.
avaž_š
 == 0) {

279 
tmp
;

280 
	`kunm­
(
·ges_š
[
·ge_š_šdex
]);

281 
·ge_š_šdex
++;

282 ià(
·ge_š_šdex
 >ð
tÙ®_·ges_š
) {

283 
d©a_š
 = 
NULL
;

286 
d©a_š
 = 
	`km­
(
·ges_š
[
·ge_š_šdex
]);

287 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

288 
tmp
 = 
¤þ’
 - 
wÜk¥aû
->
¡rm
.
tÙ®_š
;

289 
wÜk¥aû
->
¡rm
.
avaž_š
 = 
	`mš
(
tmp
,

290 
PAGE_SIZE
);

293 ià(
»t
 !ð
Z_STREAM_END
)

294 
»t
 = -
EIO
;

296 
»t
 = 0;

297 
dÚe
:

298 
	`zlib_šæ©eEnd
(&
wÜk¥aû
->
¡rm
);

299 ià(
d©a_š
)

300 
	`kunm­
(
·ges_š
[
·ge_š_šdex
]);

301 ià(!
»t
)

302 
	`z”o_fžl_bio
(
Üig_bio
);

303  
»t
;

304 
	}
}

306 
	$zlib_decom´ess
(
li¡_h—d
 *
ws
, *
d©a_š
,

307 
·ge
 *
de¡_·ge
,

308 
¡¬t_by‹
,

309 
size_t
 
¤þ’
, size_ˆ
de¡Ën
)

311 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

312 
»t
 = 0;

313 
wb™s
 = 
MAX_WBITS
;

314 
by‹s_Ëá
;

315 
tÙ®_out
 = 0;

316 
pg_off£t
 = 0;

317 *
kaddr
;

319 
de¡Ën
 = 
	`mš_t
(, de¡Ën, 
PAGE_SIZE
);

320 
by‹s_Ëá
 = 
de¡Ën
;

322 
wÜk¥aû
->
¡rm
.
Ãxt_š
 = 
d©a_š
;

323 
wÜk¥aû
->
¡rm
.
avaž_š
 = 
¤þ’
;

324 
wÜk¥aû
->
¡rm
.
tÙ®_š
 = 0;

326 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

327 
wÜk¥aû
->
¡rm
.
avaž_out
 = 
PAGE_SIZE
;

328 
wÜk¥aû
->
¡rm
.
tÙ®_out
 = 0;

331 ià(
¤þ’
 > 2 && !(
d©a_š
[1] & 
PRESET_DICT
) &&

332 ((
d©a_š
[0] & 0x0fè=ð
Z_DEFLATED
) &&

333 !(((
d©a_š
[0]<<8) + data_in[1]) % 31)) {

335 
wb™s
 = -((
d©a_š
[0] >> 4) + 8);

336 
wÜk¥aû
->
¡rm
.
Ãxt_š
 += 2;

337 
wÜk¥aû
->
¡rm
.
avaž_š
 -= 2;

340 ià(
Z_OK
 !ð
	`zlib_šæ©eIn™2
(&
wÜk¥aû
->
¡rm
, 
wb™s
)) {

341 
	`´_w¬n
("BTRFS: inflateInit failed\n");

342  -
EIO
;

345 
by‹s_Ëá
 > 0) {

346 
buf_¡¬t
;

347 
buf_off£t
;

348 
by‹s
;

350 
»t
 = 
	`zlib_šæ©e
(&
wÜk¥aû
->
¡rm
, 
Z_NO_FLUSH
);

351 ià(
»t
 !ð
Z_OK
 &&„‘ !ð
Z_STREAM_END
)

354 
buf_¡¬t
 = 
tÙ®_out
;

355 
tÙ®_out
 = 
wÜk¥aû
->
¡rm
.total_out;

357 ià(
tÙ®_out
 =ð
buf_¡¬t
) {

358 
»t
 = -
EIO
;

362 ià(
tÙ®_out
 <ð
¡¬t_by‹
)

363 
Ãxt
;

365 ià(
tÙ®_out
 > 
¡¬t_by‹
 && 
buf_¡¬t
 < start_byte)

366 
buf_off£t
 = 
¡¬t_by‹
 - 
buf_¡¬t
;

368 
buf_off£t
 = 0;

370 
by‹s
 = 
	`mš
(
PAGE_SIZE
 - 
pg_off£t
,

371 
PAGE_SIZE
 - 
buf_off£t
);

372 
by‹s
 = 
	`mš
(by‹s, 
by‹s_Ëá
);

374 
kaddr
 = 
	`km­_©omic
(
de¡_·ge
);

375 
	`memýy
(
kaddr
 + 
pg_off£t
, 
wÜk¥aû
->
buf
 + 
buf_off£t
, 
by‹s
);

376 
	`kunm­_©omic
(
kaddr
);

378 
pg_off£t
 +ð
by‹s
;

379 
by‹s_Ëá
 -ð
by‹s
;

380 
Ãxt
:

381 
wÜk¥aû
->
¡rm
.
Ãxt_out
 = wÜk¥aû->
buf
;

382 
wÜk¥aû
->
¡rm
.
avaž_out
 = 
PAGE_SIZE
;

385 ià(
»t
 !ð
Z_STREAM_END
 && 
by‹s_Ëá
 != 0)

386 
»t
 = -
EIO
;

388 
»t
 = 0;

390 
	`zlib_šæ©eEnd
(&
wÜk¥aû
->
¡rm
);

397 ià(
pg_off£t
 < 
de¡Ën
) {

398 
kaddr
 = 
	`km­_©omic
(
de¡_·ge
);

399 
	`mem£t
(
kaddr
 + 
pg_off£t
, 0, 
de¡Ën
 -…g_offset);

400 
	`kunm­_©omic
(
kaddr
);

402  
»t
;

403 
	}
}

405 cÚ¡ 
bŒfs_com´ess_Ý
 
	gbŒfs_zlib_com´ess
 = {

406 .
®loc_wÜk¥aû
 = 
zlib_®loc_wÜk¥aû
,

407 .
	gä“_wÜk¥aû
 = 
zlib_ä“_wÜk¥aû
,

408 .
	gcom´ess_·ges
 = 
zlib_com´ess_·ges
,

409 .
	gdecom´ess_bio
 = 
zlib_decom´ess_bio
,

410 .
	gdecom´ess
 = 
zlib_decom´ess
,

	@zstd.c

14 
	~<lšux/bio.h
>

15 
	~<lšux/”r.h
>

16 
	~<lšux/š™.h
>

17 
	~<lšux/k”Ãl.h
>

18 
	~<lšux/mm.h
>

19 
	~<lšux/·gem­.h
>

20 
	~<lšux/»fcouÁ.h
>

21 
	~<lšux/sched.h
>

22 
	~<lšux/¦ab.h
>

23 
	~<lšux/z¡d.h
>

24 
	~"com´essiÚ.h
"

26 
	#ZSTD_BTRFS_MAX_WINDOWLOG
 17

	)

27 
	#ZSTD_BTRFS_MAX_INPUT
 (1 << 
ZSTD_BTRFS_MAX_WINDOWLOG
)

	)

28 
	#ZSTD_BTRFS_DEFAULT_LEVEL
 3

	)

30 
ZSTD_·¿m‘”s
 
	$z¡d_g‘_bŒfs_·¿m‘”s
(
size_t
 
¤c_Ën
)

32 
ZSTD_·¿m‘”s
 
·¿ms
 = 
	`ZSTD_g‘P¬ams
(
ZSTD_BTRFS_DEFAULT_LEVEL
,

33 
¤c_Ën
, 0);

35 ià(
·¿ms
.
cP¬ams
.
wšdowLog
 > 
ZSTD_BTRFS_MAX_WINDOWLOG
)

36 
·¿ms
.
cP¬ams
.
wšdowLog
 = 
ZSTD_BTRFS_MAX_WINDOWLOG
;

37 
	`WARN_ON
(
¤c_Ën
 > 
ZSTD_BTRFS_MAX_INPUT
);

38  
·¿ms
;

39 
	}
}

41 
	swÜk¥aû
 {

42 *
	mmem
;

43 
size_t
 
	msize
;

44 *
	mbuf
;

45 
li¡_h—d
 
	mli¡
;

48 
	$z¡d_ä“_wÜk¥aû
(
li¡_h—d
 *
ws
)

50 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

52 
	`kvä“
(
wÜk¥aû
->
mem
);

53 
	`kä“
(
wÜk¥aû
->
buf
);

54 
	`kä“
(
wÜk¥aû
);

55 
	}
}

57 
li¡_h—d
 *
	$z¡d_®loc_wÜk¥aû
()

59 
ZSTD_·¿m‘”s
 
·¿ms
 =

60 
	`z¡d_g‘_bŒfs_·¿m‘”s
(
ZSTD_BTRFS_MAX_INPUT
);

61 
wÜk¥aû
 *workspace;

63 
wÜk¥aû
 = 
	`kz®loc
((*wÜk¥aû), 
GFP_KERNEL
);

64 ià(!
wÜk¥aû
)

65  
	`ERR_PTR
(-
ENOMEM
);

67 
wÜk¥aû
->
size
 = 
	`max_t
(
size_t
,

68 
	`ZSTD_CSŒ—mWÜk¥aûBound
(
·¿ms
.
cP¬ams
),

69 
	`ZSTD_DSŒ—mWÜk¥aûBound
(
ZSTD_BTRFS_MAX_INPUT
));

70 
wÜk¥aû
->
mem
 = 
	`kvm®loc
(wÜk¥aû->
size
, 
GFP_KERNEL
);

71 
wÜk¥aû
->
buf
 = 
	`km®loc
(
PAGE_SIZE
, 
GFP_KERNEL
);

72 ià(!
wÜk¥aû
->
mem
 || !wÜk¥aû->
buf
)

73 
çž
;

75 
	`INIT_LIST_HEAD
(&
wÜk¥aû
->
li¡
);

77  &
wÜk¥aû
->
li¡
;

78 
çž
:

79 
	`z¡d_ä“_wÜk¥aû
(&
wÜk¥aû
->
li¡
);

80  
	`ERR_PTR
(-
ENOMEM
);

81 
	}
}

83 
	$z¡d_com´ess_·ges
(
li¡_h—d
 *
ws
,

84 
add»ss_¥aû
 *
m­pšg
,

85 
u64
 
¡¬t
,

86 
·ge
 **
·ges
,

87 *
out_·ges
,

88 *
tÙ®_š
,

89 *
tÙ®_out
)

91 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

92 
ZSTD_CSŒ—m
 *
¡»am
;

93 
»t
 = 0;

94 
Ä_·ges
 = 0;

95 
·ge
 *
š_·ge
 = 
NULL
;

96 
·ge
 *
out_·ge
 = 
NULL
;

97 
ZSTD_šBufãr
 
š_buf
 = { 
NULL
, 0, 0 };

98 
ZSTD_outBufãr
 
out_buf
 = { 
NULL
, 0, 0 };

99 
tÙ_š
 = 0;

100 
tÙ_out
 = 0;

101 
Ën
 = *
tÙ®_out
;

102 cÚ¡ 
Ä_de¡_·ges
 = *
out_·ges
;

103 
max_out
 = 
Ä_de¡_·ges
 * 
PAGE_SIZE
;

104 
ZSTD_·¿m‘”s
 
·¿ms
 = 
	`z¡d_g‘_bŒfs_·¿m‘”s
(
Ën
);

106 *
out_·ges
 = 0;

107 *
tÙ®_out
 = 0;

108 *
tÙ®_š
 = 0;

111 
¡»am
 = 
	`ZSTD_š™CSŒ—m
(
·¿ms
, 
Ën
, 
wÜk¥aû
->
mem
,

112 
wÜk¥aû
->
size
);

113 ià(!
¡»am
) {

114 
	`´_w¬n
("BTRFS: ZSTD_initCStream failed\n");

115 
»t
 = -
EIO
;

116 
out
;

120 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

121 
š_buf
.
¤c
 = 
	`km­
(
š_·ge
);

122 
š_buf
.
pos
 = 0;

123 
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
Ën
, 
PAGE_SIZE
);

127 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

128 ià(
out_·ge
 =ð
NULL
) {

129 
»t
 = -
ENOMEM
;

130 
out
;

132 
·ges
[
Ä_·ges
++] = 
out_·ge
;

133 
out_buf
.
d¡
 = 
	`km­
(
out_·ge
);

134 
out_buf
.
pos
 = 0;

135 
out_buf
.
size
 = 
	`mš_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

138 
size_t
 
»t2
;

140 
»t2
 = 
	`ZSTD_com´essSŒ—m
(
¡»am
, &
out_buf
, &
š_buf
);

141 ià(
	`ZSTD_isE¼Ü
(
»t2
)) {

142 
	`´_debug
("BTRFS: ZSTD_compressStream„eturned %d\n",

143 
	`ZSTD_g‘E¼ÜCode
(
»t2
));

144 
»t
 = -
EIO
;

145 
out
;

149 ià(
tÙ_š
 + 
š_buf
.
pos
 > 8192 &&

150 
tÙ_š
 + 
š_buf
.
pos
 <

151 
tÙ_out
 + 
out_buf
.
pos
) {

152 
»t
 = -
E2BIG
;

153 
out
;

157 ià(
out_buf
.
pos
 >ð
max_out
) {

158 
tÙ_out
 +ð
out_buf
.
pos
;

159 
»t
 = -
E2BIG
;

160 
out
;

164 ià(
out_buf
.
pos
 =ðout_buf.
size
) {

165 
tÙ_out
 +ð
PAGE_SIZE
;

166 
max_out
 -ð
PAGE_SIZE
;

167 
	`kunm­
(
out_·ge
);

168 ià(
Ä_·ges
 =ð
Ä_de¡_·ges
) {

169 
out_·ge
 = 
NULL
;

170 
»t
 = -
E2BIG
;

171 
out
;

173 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

174 ià(
out_·ge
 =ð
NULL
) {

175 
»t
 = -
ENOMEM
;

176 
out
;

178 
·ges
[
Ä_·ges
++] = 
out_·ge
;

179 
out_buf
.
d¡
 = 
	`km­
(
out_·ge
);

180 
out_buf
.
pos
 = 0;

181 
out_buf
.
size
 = 
	`mš_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

185 ià(
š_buf
.
pos
 >ð
Ën
) {

186 
tÙ_š
 +ð
š_buf
.
pos
;

191 ià(
š_buf
.
pos
 =ðš_buf.
size
) {

192 
tÙ_š
 +ð
PAGE_SIZE
;

193 
	`kunm­
(
š_·ge
);

194 
	`put_·ge
(
š_·ge
);

196 
¡¬t
 +ð
PAGE_SIZE
;

197 
Ën
 -ð
PAGE_SIZE
;

198 
š_·ge
 = 
	`fšd_g‘_·ge
(
m­pšg
, 
¡¬t
 >> 
PAGE_SHIFT
);

199 
š_buf
.
¤c
 = 
	`km­
(
š_·ge
);

200 
š_buf
.
pos
 = 0;

201 
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
Ën
, 
PAGE_SIZE
);

205 
size_t
 
»t2
;

207 
»t2
 = 
	`ZSTD_’dSŒ—m
(
¡»am
, &
out_buf
);

208 ià(
	`ZSTD_isE¼Ü
(
»t2
)) {

209 
	`´_debug
("BTRFS: ZSTD_endStream„eturned %d\n",

210 
	`ZSTD_g‘E¼ÜCode
(
»t2
));

211 
»t
 = -
EIO
;

212 
out
;

214 ià(
»t2
 == 0) {

215 
tÙ_out
 +ð
out_buf
.
pos
;

218 ià(
out_buf
.
pos
 >ð
max_out
) {

219 
tÙ_out
 +ð
out_buf
.
pos
;

220 
»t
 = -
E2BIG
;

221 
out
;

224 
tÙ_out
 +ð
PAGE_SIZE
;

225 
max_out
 -ð
PAGE_SIZE
;

226 
	`kunm­
(
out_·ge
);

227 ià(
Ä_·ges
 =ð
Ä_de¡_·ges
) {

228 
out_·ge
 = 
NULL
;

229 
»t
 = -
E2BIG
;

230 
out
;

232 
out_·ge
 = 
	`®loc_·ge
(
GFP_NOFS
 | 
__GFP_HIGHMEM
);

233 ià(
out_·ge
 =ð
NULL
) {

234 
»t
 = -
ENOMEM
;

235 
out
;

237 
·ges
[
Ä_·ges
++] = 
out_·ge
;

238 
out_buf
.
d¡
 = 
	`km­
(
out_·ge
);

239 
out_buf
.
pos
 = 0;

240 
out_buf
.
size
 = 
	`mš_t
(
size_t
, 
max_out
, 
PAGE_SIZE
);

243 ià(
tÙ_out
 >ð
tÙ_š
) {

244 
»t
 = -
E2BIG
;

245 
out
;

248 
»t
 = 0;

249 *
tÙ®_š
 = 
tÙ_š
;

250 *
tÙ®_out
 = 
tÙ_out
;

251 
out
:

252 *
out_·ges
 = 
Ä_·ges
;

254 ià(
š_·ge
) {

255 
	`kunm­
(
š_·ge
);

256 
	`put_·ge
(
š_·ge
);

258 ià(
out_·ge
)

259 
	`kunm­
(
out_·ge
);

260  
»t
;

261 
	}
}

263 
	$z¡d_decom´ess_bio
(
li¡_h—d
 *
ws
, 
com´es£d_bio
 *
cb
)

265 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

266 
·ge
 **
·ges_š
 = 
cb
->
com´es£d_·ges
;

267 
u64
 
disk_¡¬t
 = 
cb
->
¡¬t
;

268 
bio
 *
Üig_bio
 = 
cb
->orig_bio;

269 
size_t
 
¤þ’
 = 
cb
->
com´es£d_Ën
;

270 
ZSTD_DSŒ—m
 *
¡»am
;

271 
»t
 = 0;

272 
·ge_š_šdex
 = 0;

273 
tÙ®_·ges_š
 = 
	`DIV_ROUND_UP
(
¤þ’
, 
PAGE_SIZE
);

274 
buf_¡¬t
;

275 
tÙ®_out
 = 0;

276 
ZSTD_šBufãr
 
š_buf
 = { 
NULL
, 0, 0 };

277 
ZSTD_outBufãr
 
out_buf
 = { 
NULL
, 0, 0 };

279 
¡»am
 = 
	`ZSTD_š™DSŒ—m
(

280 
ZSTD_BTRFS_MAX_INPUT
, 
wÜk¥aû
->
mem
, wÜk¥aû->
size
);

281 ià(!
¡»am
) {

282 
	`´_debug
("BTRFS: ZSTD_initDStream failed\n");

283 
»t
 = -
EIO
;

284 
dÚe
;

287 
š_buf
.
¤c
 = 
	`km­
(
·ges_š
[
·ge_š_šdex
]);

288 
š_buf
.
pos
 = 0;

289 
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
¤þ’
, 
PAGE_SIZE
);

291 
out_buf
.
d¡
 = 
wÜk¥aû
->
buf
;

292 
out_buf
.
pos
 = 0;

293 
out_buf
.
size
 = 
PAGE_SIZE
;

296 
size_t
 
»t2
;

298 
»t2
 = 
	`ZSTD_decom´essSŒ—m
(
¡»am
, &
out_buf
, &
š_buf
);

299 ià(
	`ZSTD_isE¼Ü
(
»t2
)) {

300 
	`´_debug
("BTRFS: ZSTD_decompressStream„eturned %d\n",

301 
	`ZSTD_g‘E¼ÜCode
(
»t2
));

302 
»t
 = -
EIO
;

303 
dÚe
;

305 
buf_¡¬t
 = 
tÙ®_out
;

306 
tÙ®_out
 +ð
out_buf
.
pos
;

307 
out_buf
.
pos
 = 0;

309 
»t
 = 
	`bŒfs_decom´ess_buf2·ge
(
out_buf
.
d¡
, 
buf_¡¬t
,

310 
tÙ®_out
, 
disk_¡¬t
, 
Üig_bio
);

311 ià(
»t
 == 0)

314 ià(
š_buf
.
pos
 >ð
¤þ’
)

318 ià(
»t2
 == 0)

321 ià(
š_buf
.
pos
 =ðš_buf.
size
) {

322 
	`kunm­
(
·ges_š
[
·ge_š_šdex
++]);

323 ià(
·ge_š_šdex
 >ð
tÙ®_·ges_š
) {

324 
š_buf
.
¤c
 = 
NULL
;

325 
»t
 = -
EIO
;

326 
dÚe
;

328 
¤þ’
 -ð
PAGE_SIZE
;

329 
š_buf
.
¤c
 = 
	`km­
(
·ges_š
[
·ge_š_šdex
]);

330 
š_buf
.
pos
 = 0;

331 
š_buf
.
size
 = 
	`mš_t
(
size_t
, 
¤þ’
, 
PAGE_SIZE
);

334 
»t
 = 0;

335 
	`z”o_fžl_bio
(
Üig_bio
);

336 
dÚe
:

337 ià(
š_buf
.
¤c
)

338 
	`kunm­
(
·ges_š
[
·ge_š_šdex
]);

339  
»t
;

340 
	}
}

342 
	$z¡d_decom´ess
(
li¡_h—d
 *
ws
, *
d©a_š
,

343 
·ge
 *
de¡_·ge
,

344 
¡¬t_by‹
,

345 
size_t
 
¤þ’
, size_ˆ
de¡Ën
)

347 
wÜk¥aû
 *wÜk¥aû = 
	`li¡_’Œy
(
ws
, wÜk¥aû, 
li¡
);

348 
ZSTD_DSŒ—m
 *
¡»am
;

349 
»t
 = 0;

350 
size_t
 
»t2
;

351 
ZSTD_šBufãr
 
š_buf
 = { 
NULL
, 0, 0 };

352 
ZSTD_outBufãr
 
out_buf
 = { 
NULL
, 0, 0 };

353 
tÙ®_out
 = 0;

354 
pg_off£t
 = 0;

355 *
kaddr
;

357 
¡»am
 = 
	`ZSTD_š™DSŒ—m
(

358 
ZSTD_BTRFS_MAX_INPUT
, 
wÜk¥aû
->
mem
, wÜk¥aû->
size
);

359 ià(!
¡»am
) {

360 
	`´_w¬n
("BTRFS: ZSTD_initDStream failed\n");

361 
»t
 = -
EIO
;

362 
fšish
;

365 
de¡Ën
 = 
	`mš_t
(
size_t
, de¡Ën, 
PAGE_SIZE
);

367 
š_buf
.
¤c
 = 
d©a_š
;

368 
š_buf
.
pos
 = 0;

369 
š_buf
.
size
 = 
¤þ’
;

371 
out_buf
.
d¡
 = 
wÜk¥aû
->
buf
;

372 
out_buf
.
pos
 = 0;

373 
out_buf
.
size
 = 
PAGE_SIZE
;

375 
»t2
 = 1;

376 
pg_off£t
 < 
de¡Ën
 && 
š_buf
.
pos
 < in_buf.
size
) {

377 
buf_¡¬t
;

378 
buf_off£t
;

379 
by‹s
;

382 ià(
»t2
 == 0) {

383 
	`´_debug
("BTRFS: ZSTD_decompressStreamƒndedƒarly\n");

384 
»t
 = -
EIO
;

385 
fšish
;

387 
»t2
 = 
	`ZSTD_decom´essSŒ—m
(
¡»am
, &
out_buf
, &
š_buf
);

388 ià(
	`ZSTD_isE¼Ü
(
»t2
)) {

389 
	`´_debug
("BTRFS: ZSTD_decompressStream„eturned %d\n",

390 
	`ZSTD_g‘E¼ÜCode
(
»t2
));

391 
»t
 = -
EIO
;

392 
fšish
;

395 
buf_¡¬t
 = 
tÙ®_out
;

396 
tÙ®_out
 +ð
out_buf
.
pos
;

397 
out_buf
.
pos
 = 0;

399 ià(
tÙ®_out
 <ð
¡¬t_by‹
)

402 ià(
tÙ®_out
 > 
¡¬t_by‹
 && 
buf_¡¬t
 < start_byte)

403 
buf_off£t
 = 
¡¬t_by‹
 - 
buf_¡¬t
;

405 
buf_off£t
 = 0;

407 
by‹s
 = 
	`mš_t
(, 
de¡Ën
 - 
pg_off£t
,

408 
out_buf
.
size
 - 
buf_off£t
);

410 
kaddr
 = 
	`km­_©omic
(
de¡_·ge
);

411 
	`memýy
(
kaddr
 + 
pg_off£t
, 
out_buf
.
d¡
 + 
buf_off£t
, 
by‹s
);

412 
	`kunm­_©omic
(
kaddr
);

414 
pg_off£t
 +ð
by‹s
;

416 
»t
 = 0;

417 
fšish
:

418 ià(
pg_off£t
 < 
de¡Ën
) {

419 
kaddr
 = 
	`km­_©omic
(
de¡_·ge
);

420 
	`mem£t
(
kaddr
 + 
pg_off£t
, 0, 
de¡Ën
 -…g_offset);

421 
	`kunm­_©omic
(
kaddr
);

423  
»t
;

424 
	}
}

426 cÚ¡ 
bŒfs_com´ess_Ý
 
	gbŒfs_z¡d_com´ess
 = {

427 .
®loc_wÜk¥aû
 = 
z¡d_®loc_wÜk¥aû
,

428 .
	gä“_wÜk¥aû
 = 
z¡d_ä“_wÜk¥aû
,

429 .
	gcom´ess_·ges
 = 
z¡d_com´ess_·ges
,

430 .
	gdecom´ess_bio
 = 
z¡d_decom´ess_bio
,

431 .
	gdecom´ess
 = 
z¡d_decom´ess
,

	@/usr/include/linux/btrfs.h

19 #iâdeà
_LINUX_BTRFS_H


20 
	#_LINUX_BTRFS_H


	)

21 
	~<lšux/ty³s.h
>

22 
	~<lšux/ioùl.h
>

24 
	#BTRFS_IOCTL_MAGIC
 0x94

	)

25 
	#BTRFS_VOL_NAME_MAX
 255

	)

28 
	#BTRFS_PATH_NAME_MAX
 4087

	)

29 
	sbŒfs_ioùl_vÞ_¬gs
 {

30 
__s64
 
	mfd
;

31 
	mÇme
[
BTRFS_PATH_NAME_MAX
 + 1];

34 
	#BTRFS_DEVICE_PATH_NAME_MAX
 1024

	)

36 
	#BTRFS_SUBVOL_CREATE_ASYNC
 (1ULL << 0)

	)

37 
	#BTRFS_SUBVOL_RDONLY
 (1ULL << 1)

	)

38 
	#BTRFS_SUBVOL_QGROUP_INHERIT
 (1ULL << 2)

	)

39 
	#BTRFS_FSID_SIZE
 16

	)

40 
	#BTRFS_UUID_SIZE
 16

	)

41 
	#BTRFS_UUID_UNPARSED_SIZE
 37

	)

43 
	#BTRFS_QGROUP_INHERIT_SET_LIMITS
 (1ULL << 0)

	)

45 
	sbŒfs_qgroup_lim™
 {

46 
__u64
 
	mæags
;

47 
__u64
 
	mmax_rãr
;

48 
__u64
 
	mmax_exþ
;

49 
__u64
 
	mrsv_rãr
;

50 
__u64
 
	mrsv_exþ
;

53 
	sbŒfs_qgroup_šh”™
 {

54 
__u64
 
	mæags
;

55 
__u64
 
	mnum_qgroups
;

56 
__u64
 
	mnum_»f_cÝ›s
;

57 
__u64
 
	mnum_exþ_cÝ›s
;

58 
bŒfs_qgroup_lim™
 
	mlim
;

59 
__u64
 
	mqgroups
[0];

62 
	sbŒfs_ioùl_qgroup_lim™_¬gs
 {

63 
__u64
 
	mqgroupid
;

64 
bŒfs_qgroup_lim™
 
	mlim
;

67 
	#BTRFS_SUBVOL_NAME_MAX
 4039

	)

68 
	sbŒfs_ioùl_vÞ_¬gs_v2
 {

69 
__s64
 
	mfd
;

70 
__u64
 
	mŒªsid
;

71 
__u64
 
	mæags
;

74 
__u64
 
	msize
;

75 
bŒfs_qgroup_šh”™
 *
	mqgroup_šh”™
;

77 
__u64
 
	munu£d
[4];

79 
	mÇme
[
BTRFS_SUBVOL_NAME_MAX
 + 1];

86 
	sbŒfs_süub_´og»ss
 {

87 
__u64
 
	md©a_ex‹Ás_süubbed
;

88 
__u64
 
	mŒ“_ex‹Ás_süubbed
;

89 
__u64
 
	md©a_by‹s_süubbed
;

90 
__u64
 
	mŒ“_by‹s_süubbed
;

91 
__u64
 
	m»ad_”rÜs
;

92 
__u64
 
	mcsum_”rÜs
;

93 
__u64
 
	mv”ify_”rÜs
;

97 
__u64
 
	mno_csum
;

100 
__u64
 
	mcsum_disÿrds
;

102 
__u64
 
	msu³r_”rÜs
;

103 
__u64
 
	mm®loc_”rÜs
;

106 
__u64
 
	muncÜ»ùabË_”rÜs
;

109 
__u64
 
	mcÜ»ùed_”rÜs
;

110 
__u64
 
	mÏ¡_physiÿl
;

113 
__u64
 
	munv”if›d_”rÜs
;

119 
	#BTRFS_SCRUB_READONLY
 1

	)

120 
	sbŒfs_ioùl_süub_¬gs
 {

121 
__u64
 
	mdevid
;

122 
__u64
 
	m¡¬t
;

123 
__u64
 
	m’d
;

124 
__u64
 
	mæags
;

125 
bŒfs_süub_´og»ss
 
	m´og»ss
;

127 
__u64
 
	munu£d
[(1024-32-(
bŒfs_süub_´og»ss
))/8];

130 
	#BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_ALWAYS
 0

	)

131 
	#BTRFS_IOCTL_DEV_REPLACE_CONT_READING_FROM_SRCDEV_MODE_AVOID
 1

	)

132 
	sbŒfs_ioùl_dev_»¶aû_¡¬t_·¿ms
 {

133 
__u64
 
	m¤cdevid
;

134 
__u64
 
	mcÚt_»adšg_äom_¤cdev_mode
;

136 
__u8
 
	m¤cdev_Çme
[
BTRFS_DEVICE_PATH_NAME_MAX
 + 1];

137 
__u8
 
	mtgtdev_Çme
[
BTRFS_DEVICE_PATH_NAME_MAX
 + 1];

140 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_NEVER_STARTED
 0

	)

141 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_STARTED
 1

	)

142 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_FINISHED
 2

	)

143 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_CANCELED
 3

	)

144 
	#BTRFS_IOCTL_DEV_REPLACE_STATE_SUSPENDED
 4

	)

145 
	sbŒfs_ioùl_dev_»¶aû_¡©us_·¿ms
 {

146 
__u64
 
	m»¶aû_¡©e
;

147 
__u64
 
	m´og»ss_1000
;

148 
__u64
 
	mtime_¡¬‹d
;

149 
__u64
 
	mtime_¡Ý³d
;

150 
__u64
 
	mnum_wr™e_”rÜs
;

151 
__u64
 
	mnum_uncÜ»ùabË_»ad_”rÜs
;

154 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_START
 0

	)

155 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_STATUS
 1

	)

156 
	#BTRFS_IOCTL_DEV_REPLACE_CMD_CANCEL
 2

	)

157 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_NO_ERROR
 0

	)

158 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_NOT_STARTED
 1

	)

159 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_ALREADY_STARTED
 2

	)

160 
	#BTRFS_IOCTL_DEV_REPLACE_RESULT_SCRUB_INPROGRESS
 3

	)

161 
	sbŒfs_ioùl_dev_»¶aû_¬gs
 {

162 
__u64
 
	mcmd
;

163 
__u64
 
	m»suÉ
;

166 
bŒfs_ioùl_dev_»¶aû_¡¬t_·¿ms
 
	m¡¬t
;

167 
bŒfs_ioùl_dev_»¶aû_¡©us_·¿ms
 
	m¡©us
;

170 
__u64
 
	m¥¬e
[64];

173 
	sbŒfs_ioùl_dev_šfo_¬gs
 {

174 
__u64
 
	mdevid
;

175 
__u8
 
	muuid
[
BTRFS_UUID_SIZE
];

176 
__u64
 
	mby‹s_u£d
;

177 
__u64
 
	mtÙ®_by‹s
;

178 
__u64
 
	munu£d
[379];

179 
__u8
 
	m·th
[
BTRFS_DEVICE_PATH_NAME_MAX
];

182 
	sbŒfs_ioùl_fs_šfo_¬gs
 {

183 
__u64
 
	mmax_id
;

184 
__u64
 
	mnum_deviûs
;

185 
__u8
 
	mfsid
[
BTRFS_FSID_SIZE
];

186 
__u32
 
	mnodesize
;

187 
__u32
 
	m£ùÜsize
;

188 
__u32
 
	mþÚe_®ignm’t
;

189 
__u32
 
	m»£rved32
;

190 
__u64
 
	m»£rved
[122];

193 
	sbŒfs_ioùl_ã©u»_æags
 {

194 
__u64
 
	mcom·t_æags
;

195 
__u64
 
	mcom·t_ro_æags
;

196 
__u64
 
	mšcom·t_æags
;

200 
	#BTRFS_BALANCE_CTL_PAUSE
 1

	)

201 
	#BTRFS_BALANCE_CTL_CANCEL
 2

	)

207 
	sbŒfs_b®ªû_¬gs
 {

208 
__u64
 
	m´ofžes
;

210 
__Ë64
 
	mu§ge
;

212 
__Ë32
 
	mu§ge_mš
;

213 
__Ë32
 
	mu§ge_max
;

216 
__u64
 
	mdevid
;

217 
__u64
 
	mp¡¬t
;

218 
__u64
 
	m³nd
;

219 
__u64
 
	mv¡¬t
;

220 
__u64
 
	mv’d
;

222 
__u64
 
	mrg‘
;

224 
__u64
 
	mæags
;

232 
__u64
 
	mlim™
;

234 
__u32
 
	mlim™_mš
;

235 
__u32
 
	mlim™_max
;

243 
__Ë32
 
	m¡res_mš
;

244 
__Ë32
 
	m¡res_max
;

246 
__u64
 
	munu£d
[6];

247 } 
__©Œibu‹__
 ((
__·cked__
));

250 
	sbŒfs_b®ªû_´og»ss
 {

251 
__u64
 
	mex³ùed
;

253 
__u64
 
	mcÚsid”ed
;

254 
__u64
 
	mcom¶‘ed
;

257 
	#BTRFS_BALANCE_STATE_RUNNING
 (1ULL << 0)

	)

258 
	#BTRFS_BALANCE_STATE_PAUSE_REQ
 (1ULL << 1)

	)

259 
	#BTRFS_BALANCE_STATE_CANCEL_REQ
 (1ULL << 2)

	)

261 
	sbŒfs_ioùl_b®ªû_¬gs
 {

262 
__u64
 
	mæags
;

263 
__u64
 
	m¡©e
;

265 
bŒfs_b®ªû_¬gs
 
	md©a
;

266 
bŒfs_b®ªû_¬gs
 
	mm‘a
;

267 
bŒfs_b®ªû_¬gs
 
	msys
;

269 
bŒfs_b®ªû_´og»ss
 
	m¡©
;

271 
__u64
 
	munu£d
[72];

274 
	#BTRFS_INO_LOOKUP_PATH_MAX
 4080

	)

275 
	sbŒfs_ioùl_šo_lookup_¬gs
 {

276 
__u64
 
	mŒ“id
;

277 
__u64
 
	mobjeùid
;

278 
	mÇme
[
BTRFS_INO_LOOKUP_PATH_MAX
];

281 
	sbŒfs_ioùl_£¬ch_key
 {

283 
__u64
 
	mŒ“_id
;

286 
__u64
 
	mmš_objeùid
;

287 
__u64
 
	mmax_objeùid
;

290 
__u64
 
	mmš_off£t
;

291 
__u64
 
	mmax_off£t
;

294 
__u64
 
	mmš_Œªsid
;

295 
__u64
 
	mmax_Œªsid
;

298 
__u32
 
	mmš_ty³
;

299 
__u32
 
	mmax_ty³
;

305 
__u32
 
	mÄ_™ems
;

308 
__u32
 
	munu£d
;

311 
__u64
 
	munu£d1
;

312 
__u64
 
	munu£d2
;

313 
__u64
 
	munu£d3
;

314 
__u64
 
	munu£d4
;

317 
	sbŒfs_ioùl_£¬ch_h—d”
 {

318 
__u64
 
	mŒªsid
;

319 
__u64
 
	mobjeùid
;

320 
__u64
 
	moff£t
;

321 
__u32
 
	mty³
;

322 
__u32
 
	mËn
;

325 
	#BTRFS_SEARCH_ARGS_BUFSIZE
 (4096 - (
bŒfs_ioùl_£¬ch_key
))

	)

331 
	sbŒfs_ioùl_£¬ch_¬gs
 {

332 
bŒfs_ioùl_£¬ch_key
 
	mkey
;

333 
	mbuf
[
BTRFS_SEARCH_ARGS_BUFSIZE
];

336 
	sbŒfs_ioùl_£¬ch_¬gs_v2
 {

337 
bŒfs_ioùl_£¬ch_key
 
	mkey
;

338 
__u64
 
	mbuf_size
;

341 
__u64
 
	mbuf
[0];

344 
	sbŒfs_ioùl_þÚe_¿nge_¬gs
 {

345 
__s64
 
	m¤c_fd
;

346 
__u64
 
	m¤c_off£t
, 
	m¤c_Ëngth
;

347 
__u64
 
	mde¡_off£t
;

351 
	#BTRFS_DEFRAG_RANGE_COMPRESS
 1

	)

352 
	#BTRFS_DEFRAG_RANGE_START_IO
 2

	)

354 
	#BTRFS_SAME_DATA_DIFFERS
 1

	)

356 
	sbŒfs_ioùl_§me_ex‹Á_šfo
 {

357 
__s64
 
	mfd
;

358 
__u64
 
	mlogiÿl_off£t
;

359 
__u64
 
	mby‹s_dedu³d
;

366 
__s32
 
	m¡©us
;

367 
__u32
 
	m»£rved
;

370 
	sbŒfs_ioùl_§me_¬gs
 {

371 
__u64
 
	mlogiÿl_off£t
;

372 
__u64
 
	mËngth
;

373 
__u16
 
	mde¡_couÁ
;

374 
__u16
 
	m»£rved1
;

375 
__u32
 
	m»£rved2
;

376 
bŒfs_ioùl_§me_ex‹Á_šfo
 
	mšfo
[0];

379 
	sbŒfs_ioùl_¥aû_šfo
 {

380 
__u64
 
	mæags
;

381 
__u64
 
	mtÙ®_by‹s
;

382 
__u64
 
	mu£d_by‹s
;

385 
	sbŒfs_ioùl_¥aû_¬gs
 {

386 
__u64
 
	m¥aû_¦Ùs
;

387 
__u64
 
	mtÙ®_¥aûs
;

388 
bŒfs_ioùl_¥aû_šfo
 
	m¥aûs
[0];

391 
	sbŒfs_d©a_cÚš”
 {

392 
__u32
 
	mby‹s_Ëá
;

393 
__u32
 
	mby‹s_missšg
;

394 
__u32
 
	m–em_út
;

395 
__u32
 
	m–em_mis£d
;

396 
__u64
 
	mv®
[0];

399 
	sbŒfs_ioùl_šo_·th_¬gs
 {

400 
__u64
 
	mšum
;

401 
__u64
 
	msize
;

402 
__u64
 
	m»£rved
[4];

404 
__u64
 
	mf¥©h
;

407 
	sbŒfs_ioùl_logiÿl_šo_¬gs
 {

408 
__u64
 
	mlogiÿl
;

409 
__u64
 
	msize
;

410 
__u64
 
	m»£rved
[4];

412 
__u64
 
	mšodes
;

415 
	ebŒfs_dev_¡©_v®ues
 {

417 
	mBTRFS_DEV_STAT_WRITE_ERRS
,

418 
	mBTRFS_DEV_STAT_READ_ERRS
,

419 
	mBTRFS_DEV_STAT_FLUSH_ERRS
,

422 
	mBTRFS_DEV_STAT_CORRUPTION_ERRS
,

428 
	mBTRFS_DEV_STAT_GENERATION_ERRS
,

431 
	mBTRFS_DEV_STAT_VALUES_MAX


435 
	#BTRFS_DEV_STATS_RESET
 (1ULL << 0)

	)

437 
	sbŒfs_ioùl_g‘_dev_¡©s
 {

438 
__u64
 
	mdevid
;

439 
__u64
 
	mÄ_™ems
;

440 
__u64
 
	mæags
;

443 
__u64
 
	mv®ues
[
BTRFS_DEV_STAT_VALUES_MAX
];

445 
__u64
 
	munu£d
[128 - 2 - 
BTRFS_DEV_STAT_VALUES_MAX
];

448 
	#BTRFS_QUOTA_CTL_ENABLE
 1

	)

449 
	#BTRFS_QUOTA_CTL_DISABLE
 2

	)

450 
	#BTRFS_QUOTA_CTL_RESCAN__NOTUSED
 3

	)

451 
	sbŒfs_ioùl_quÙa_ùl_¬gs
 {

452 
__u64
 
	mcmd
;

453 
__u64
 
	m¡©us
;

456 
	sbŒfs_ioùl_quÙa_»sÿn_¬gs
 {

457 
__u64
 
	mæags
;

458 
__u64
 
	m´og»ss
;

459 
__u64
 
	m»£rved
[6];

462 
	sbŒfs_ioùl_qgroup_assign_¬gs
 {

463 
__u64
 
	massign
;

464 
__u64
 
	m¤c
;

465 
__u64
 
	md¡
;

468 
	sbŒfs_ioùl_qgroup_ü—‹_¬gs
 {

469 
__u64
 
	mü—‹
;

470 
__u64
 
	mqgroupid
;

472 
	sbŒfs_ioùl_time¥ec
 {

473 
__u64
 
	m£c
;

474 
__u32
 
	mn£c
;

477 
	sbŒfs_ioùl_»ûived_subvÞ_¬gs
 {

478 
	muuid
[
BTRFS_UUID_SIZE
];

479 
__u64
 
	m¡¿nsid
;

480 
__u64
 
	m¹¿nsid
;

481 
bŒfs_ioùl_time¥ec
 
	m¡ime
;

482 
bŒfs_ioùl_time¥ec
 
	m¹ime
;

483 
__u64
 
	mæags
;

484 
__u64
 
	m»£rved
[16];

492 
	#BTRFS_SEND_FLAG_NO_FILE_DATA
 0x1

	)

498 
	#BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
 0x2

	)

505 
	#BTRFS_SEND_FLAG_OMIT_END_CMD
 0x4

	)

507 
	#BTRFS_SEND_FLAG_MASK
 \

508 (
BTRFS_SEND_FLAG_NO_FILE_DATA
 | \

509 
BTRFS_SEND_FLAG_OMIT_STREAM_HEADER
 | \

510 
BTRFS_SEND_FLAG_OMIT_END_CMD
)

	)

512 
	sbŒfs_ioùl_£nd_¬gs
 {

513 
__s64
 
	m£nd_fd
;

514 
__u64
 
	mþÚe_sourûs_couÁ
;

515 
__u64
 *
	mþÚe_sourûs
;

516 
__u64
 
	m·»Á_roÙ
;

517 
__u64
 
	mæags
;

518 
__u64
 
	m»£rved
[4];

522 
	ebŒfs_”r_code
 {

523 
	mBTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
 = 1,

524 
	mBTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
,

525 
	mBTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
,

526 
	mBTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
,

527 
	mBTRFS_ERROR_DEV_TGT_REPLACE
,

528 
	mBTRFS_ERROR_DEV_MISSING_NOT_FOUND
,

529 
	mBTRFS_ERROR_DEV_ONLY_WRITABLE
,

530 
	mBTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS


535 
__šlše__
 *
	$bŒfs_”r_¡r
(
bŒfs_”r_code
 
”r_code
)

537 
”r_code
) {

538 
BTRFS_ERROR_DEV_RAID1_MIN_NOT_MET
:

540 
BTRFS_ERROR_DEV_RAID10_MIN_NOT_MET
:

542 
BTRFS_ERROR_DEV_RAID5_MIN_NOT_MET
:

544 
BTRFS_ERROR_DEV_RAID6_MIN_NOT_MET
:

546 
BTRFS_ERROR_DEV_TGT_REPLACE
:

548 
BTRFS_ERROR_DEV_MISSING_NOT_FOUND
:

550 
BTRFS_ERROR_DEV_ONLY_WRITABLE
:

552 
BTRFS_ERROR_DEV_EXCL_RUN_IN_PROGRESS
:

556  
NULL
;

558 
	}
}

560 
	#BTRFS_IOC_SNAP_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 1, \

561 
bŒfs_ioùl_vÞ_¬gs
)

	)

562 
	#BTRFS_IOC_DEFRAG
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 2, \

563 
bŒfs_ioùl_vÞ_¬gs
)

	)

564 
	#BTRFS_IOC_RESIZE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 3, \

565 
bŒfs_ioùl_vÞ_¬gs
)

	)

566 
	#BTRFS_IOC_SCAN_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 4, \

567 
bŒfs_ioùl_vÞ_¬gs
)

	)

572 
	#BTRFS_IOC_TRANS_START
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 6)

	)

573 
	#BTRFS_IOC_TRANS_END
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 7)

	)

574 
	#BTRFS_IOC_SYNC
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 8)

	)

576 
	#BTRFS_IOC_CLONE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 9, )

	)

577 
	#BTRFS_IOC_ADD_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 10, \

578 
bŒfs_ioùl_vÞ_¬gs
)

	)

579 
	#BTRFS_IOC_RM_DEV
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 11, \

580 
bŒfs_ioùl_vÞ_¬gs
)

	)

581 
	#BTRFS_IOC_BALANCE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 12, \

582 
bŒfs_ioùl_vÞ_¬gs
)

	)

584 
	#BTRFS_IOC_CLONE_RANGE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 13, \

585 
bŒfs_ioùl_þÚe_¿nge_¬gs
)

	)

587 
	#BTRFS_IOC_SUBVOL_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 14, \

588 
bŒfs_ioùl_vÞ_¬gs
)

	)

589 
	#BTRFS_IOC_SNAP_DESTROY
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 15, \

590 
bŒfs_ioùl_vÞ_¬gs
)

	)

591 
	#BTRFS_IOC_DEFRAG_RANGE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 16, \

592 
bŒfs_ioùl_deäag_¿nge_¬gs
)

	)

593 
	#BTRFS_IOC_TREE_SEARCH
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 17, \

594 
bŒfs_ioùl_£¬ch_¬gs
)

	)

595 
	#BTRFS_IOC_TREE_SEARCH_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 17, \

596 
bŒfs_ioùl_£¬ch_¬gs_v2
)

	)

597 
	#BTRFS_IOC_INO_LOOKUP
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 18, \

598 
bŒfs_ioùl_šo_lookup_¬gs
)

	)

599 
	#BTRFS_IOC_DEFAULT_SUBVOL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 19, 
__u64
)

	)

600 
	#BTRFS_IOC_SPACE_INFO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 20, \

601 
bŒfs_ioùl_¥aû_¬gs
)

	)

602 
	#BTRFS_IOC_START_SYNC
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 24, 
__u64
)

	)

603 
	#BTRFS_IOC_WAIT_SYNC
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 22, 
__u64
)

	)

604 
	#BTRFS_IOC_SNAP_CREATE_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 23, \

605 
bŒfs_ioùl_vÞ_¬gs_v2
)

	)

606 
	#BTRFS_IOC_SUBVOL_CREATE_V2
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 24, \

607 
bŒfs_ioùl_vÞ_¬gs_v2
)

	)

608 
	#BTRFS_IOC_SUBVOL_GETFLAGS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 25, 
__u64
)

	)

609 
	#BTRFS_IOC_SUBVOL_SETFLAGS
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 26, 
__u64
)

	)

610 
	#BTRFS_IOC_SCRUB
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 27, \

611 
bŒfs_ioùl_süub_¬gs
)

	)

612 
	#BTRFS_IOC_SCRUB_CANCEL
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 28)

	)

613 
	#BTRFS_IOC_SCRUB_PROGRESS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 29, \

614 
bŒfs_ioùl_süub_¬gs
)

	)

615 
	#BTRFS_IOC_DEV_INFO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 30, \

616 
bŒfs_ioùl_dev_šfo_¬gs
)

	)

617 
	#BTRFS_IOC_FS_INFO
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 31, \

618 
bŒfs_ioùl_fs_šfo_¬gs
)

	)

619 
	#BTRFS_IOC_BALANCE_V2
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 32, \

620 
bŒfs_ioùl_b®ªû_¬gs
)

	)

621 
	#BTRFS_IOC_BALANCE_CTL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 33, )

	)

622 
	#BTRFS_IOC_BALANCE_PROGRESS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 34, \

623 
bŒfs_ioùl_b®ªû_¬gs
)

	)

624 
	#BTRFS_IOC_INO_PATHS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 35, \

625 
bŒfs_ioùl_šo_·th_¬gs
)

	)

626 
	#BTRFS_IOC_LOGICAL_INO
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 36, \

627 
bŒfs_ioùl_šo_·th_¬gs
)

	)

628 
	#BTRFS_IOC_SET_RECEIVED_SUBVOL
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 37, \

629 
bŒfs_ioùl_»ûived_subvÞ_¬gs
)

	)

630 
	#BTRFS_IOC_SEND
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 38, 
bŒfs_ioùl_£nd_¬gs
)

	)

631 
	#BTRFS_IOC_DEVICES_READY
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 39, \

632 
bŒfs_ioùl_vÞ_¬gs
)

	)

633 
	#BTRFS_IOC_QUOTA_CTL
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 40, \

634 
bŒfs_ioùl_quÙa_ùl_¬gs
)

	)

635 
	#BTRFS_IOC_QGROUP_ASSIGN
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 41, \

636 
bŒfs_ioùl_qgroup_assign_¬gs
)

	)

637 
	#BTRFS_IOC_QGROUP_CREATE
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 42, \

638 
bŒfs_ioùl_qgroup_ü—‹_¬gs
)

	)

639 
	#BTRFS_IOC_QGROUP_LIMIT
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 43, \

640 
bŒfs_ioùl_qgroup_lim™_¬gs
)

	)

641 
	#BTRFS_IOC_QUOTA_RESCAN
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 44, \

642 
bŒfs_ioùl_quÙa_»sÿn_¬gs
)

	)

643 
	#BTRFS_IOC_QUOTA_RESCAN_STATUS
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 45, \

644 
bŒfs_ioùl_quÙa_»sÿn_¬gs
)

	)

645 
	#BTRFS_IOC_QUOTA_RESCAN_WAIT
 
	`_IO
(
BTRFS_IOCTL_MAGIC
, 46)

	)

646 
	#BTRFS_IOC_GET_FSLABEL
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 49, \

647 [
BTRFS_LABEL_SIZE
])

	)

648 
	#BTRFS_IOC_SET_FSLABEL
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 50, \

649 [
BTRFS_LABEL_SIZE
])

	)

650 
	#BTRFS_IOC_GET_DEV_STATS
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 52, \

651 
bŒfs_ioùl_g‘_dev_¡©s
)

	)

652 
	#BTRFS_IOC_DEV_REPLACE
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 53, \

653 
bŒfs_ioùl_dev_»¶aû_¬gs
)

	)

654 
	#BTRFS_IOC_FILE_EXTENT_SAME
 
	`_IOWR
(
BTRFS_IOCTL_MAGIC
, 54, \

655 
bŒfs_ioùl_§me_¬gs
)

	)

656 
	#BTRFS_IOC_GET_FEATURES
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 57, \

657 
bŒfs_ioùl_ã©u»_æags
)

	)

658 
	#BTRFS_IOC_SET_FEATURES
 
	`_IOW
(
BTRFS_IOCTL_MAGIC
, 57, \

659 
bŒfs_ioùl_ã©u»_æags
[2])

	)

660 
	#BTRFS_IOC_GET_SUPPORTED_FEATURES
 
	`_IOR
(
BTRFS_IOCTL_MAGIC
, 57, \

661 
bŒfs_ioùl_ã©u»_æags
[3])

	)

	@/usr/include/linux/capability.h

13 #iâdeà
_LINUX_CAPABILITY_H


14 
	#_LINUX_CAPABILITY_H


	)

16 
	~<lšux/ty³s.h
>

18 
	gsk_¡ruù
;

31 
	#_LINUX_CAPABILITY_VERSION_1
 0x19980330

	)

32 
	#_LINUX_CAPABILITY_U32S_1
 1

	)

34 
	#_LINUX_CAPABILITY_VERSION_2
 0x20071026

	)

35 
	#_LINUX_CAPABILITY_U32S_2
 2

	)

37 
	#_LINUX_CAPABILITY_VERSION_3
 0x20080522

	)

38 
	#_LINUX_CAPABILITY_U32S_3
 2

	)

40 
	s__u£r_ÿp_h—d”_¡ruù
 {

41 
__u32
 
	mv”siÚ
;

42 
	mpid
;

43 } *
	tÿp_u£r_h—d”_t
;

45 
	s__u£r_ÿp_d©a_¡ruù
 {

46 
__u32
 
	mefãùive
;

47 
__u32
 
	m³rm™‹d
;

48 
__u32
 
	mšh”™abË
;

49 } *
	tÿp_u£r_d©a_t
;

52 
	#VFS_CAP_REVISION_MASK
 0xFF000000

	)

53 
	#VFS_CAP_REVISION_SHIFT
 24

	)

54 
	#VFS_CAP_FLAGS_MASK
 ~
VFS_CAP_REVISION_MASK


	)

55 
	#VFS_CAP_FLAGS_EFFECTIVE
 0x000001

	)

57 
	#VFS_CAP_REVISION_1
 0x01000000

	)

58 
	#VFS_CAP_U32_1
 1

	)

59 
	#XATTR_CAPS_SZ_1
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_1
))

	)

61 
	#VFS_CAP_REVISION_2
 0x02000000

	)

62 
	#VFS_CAP_U32_2
 2

	)

63 
	#XATTR_CAPS_SZ_2
 ((
__Ë32
)*(1 + 2*
VFS_CAP_U32_2
))

	)

65 
	#VFS_CAP_REVISION_3
 0x03000000

	)

66 
	#VFS_CAP_U32_3
 2

	)

67 
	#XATTR_CAPS_SZ_3
 ((
__Ë32
)*(2 + 2*
VFS_CAP_U32_3
))

	)

69 
	#XATTR_CAPS_SZ
 
XATTR_CAPS_SZ_3


	)

70 
	#VFS_CAP_U32
 
VFS_CAP_U32_3


	)

71 
	#VFS_CAP_REVISION
 
VFS_CAP_REVISION_3


	)

73 
	svfs_ÿp_d©a
 {

74 
__Ë32
 
	mmagic_‘c
;

76 
__Ë32
 
	m³rm™‹d
;

77 
__Ë32
 
	mšh”™abË
;

78 } 
	md©a
[
VFS_CAP_U32
];

84 
	svfs_ns_ÿp_d©a
 {

85 
__Ë32
 
	mmagic_‘c
;

87 
__Ë32
 
	m³rm™‹d
;

88 
__Ë32
 
	mšh”™abË
;

89 } 
	md©a
[
VFS_CAP_U32
];

90 
__Ë32
 
	mroÙid
;

99 
	#_LINUX_CAPABILITY_VERSION
 
_LINUX_CAPABILITY_VERSION_1


	)

100 
	#_LINUX_CAPABILITY_U32S
 
_LINUX_CAPABILITY_U32S_1


	)

112 
	#CAP_CHOWN
 0

	)

118 
	#CAP_DAC_OVERRIDE
 1

	)

124 
	#CAP_DAC_READ_SEARCH
 2

	)

130 
	#CAP_FOWNER
 3

	)

139 
	#CAP_FSETID
 4

	)

145 
	#CAP_KILL
 5

	)

151 
	#CAP_SETGID
 6

	)

156 
	#CAP_SETUID
 7

	)

173 
	#CAP_SETPCAP
 8

	)

177 
	#CAP_LINUX_IMMUTABLE
 9

	)

182 
	#CAP_NET_BIND_SERVICE
 10

	)

186 
	#CAP_NET_BROADCAST
 11

	)

202 
	#CAP_NET_ADMIN
 12

	)

208 
	#CAP_NET_RAW
 13

	)

214 
	#CAP_IPC_LOCK
 14

	)

218 
	#CAP_IPC_OWNER
 15

	)

221 
	#CAP_SYS_MODULE
 16

	)

226 
	#CAP_SYS_RAWIO
 17

	)

230 
	#CAP_SYS_CHROOT
 18

	)

234 
	#CAP_SYS_PTRACE
 19

	)

238 
	#CAP_SYS_PACCT
 20

	)

277 
	#CAP_SYS_ADMIN
 21

	)

281 
	#CAP_SYS_BOOT
 22

	)

290 
	#CAP_SYS_NICE
 23

	)

304 
	#CAP_SYS_RESOURCE
 24

	)

310 
	#CAP_SYS_TIME
 25

	)

315 
	#CAP_SYS_TTY_CONFIG
 26

	)

319 
	#CAP_MKNOD
 27

	)

323 
	#CAP_LEASE
 28

	)

327 
	#CAP_AUDIT_WRITE
 29

	)

331 
	#CAP_AUDIT_CONTROL
 30

	)

333 
	#CAP_SETFCAP
 31

	)

341 
	#CAP_MAC_OVERRIDE
 32

	)

350 
	#CAP_MAC_ADMIN
 33

	)

354 
	#CAP_SYSLOG
 34

	)

358 
	#CAP_WAKE_ALARM
 35

	)

362 
	#CAP_BLOCK_SUSPEND
 36

	)

366 
	#CAP_AUDIT_READ
 37

	)

369 
	#CAP_LAST_CAP
 
CAP_AUDIT_READ


	)

371 
	#ÿp_v®id
(
x
è((xè>ð0 && (xè<ð
CAP_LAST_CAP
)

	)

377 
	#CAP_TO_INDEX
(
x
è((xè>> 5è

	)

378 
	#CAP_TO_MASK
(
x
è(1 << ((xè& 31)è

	)

	@/usr/include/linux/falloc.h

1 #iâdeà
_FALLOC_H_


2 
	#_FALLOC_H_


	)

4 
	#FALLOC_FL_KEEP_SIZE
 0x01

	)

5 
	#FALLOC_FL_PUNCH_HOLE
 0x02

	)

6 
	#FALLOC_FL_NO_HIDE_STALE
 0x04

	)

28 
	#FALLOC_FL_COLLAPSE_RANGE
 0x08

	)

42 
	#FALLOC_FL_ZERO_RANGE
 0x10

	)

59 
	#FALLOC_FL_INSERT_RANGE
 0x20

	)

	@/usr/include/linux/fs.h

1 #iâdeà
_LINUX_FS_H


2 
	#_LINUX_FS_H


	)

9 
	~<lšux/lim™s.h
>

10 
	~<lšux/ioùl.h
>

11 
	~<lšux/ty³s.h
>

24 #undeà
NR_OPEN


25 
	#INR_OPEN_CUR
 1024

	)

26 
	#INR_OPEN_MAX
 4096

	)

28 
	#BLOCK_SIZE_BITS
 10

	)

29 
	#BLOCK_SIZE
 (1<<
BLOCK_SIZE_BITS
)

	)

31 
	#SEEK_SET
 0

	)

32 
	#SEEK_CUR
 1

	)

33 
	#SEEK_END
 2

	)

34 
	#SEEK_DATA
 3

	)

35 
	#SEEK_HOLE
 4

	)

36 
	#SEEK_MAX
 
SEEK_HOLE


	)

38 
	#RENAME_NOREPLACE
 (1 << 0è

	)

39 
	#RENAME_EXCHANGE
 (1 << 1è

	)

40 
	#RENAME_WHITEOUT
 (1 << 2è

	)

42 
	sf¡rim_¿nge
 {

43 
__u64
 
	m¡¬t
;

44 
__u64
 
	mËn
;

45 
__u64
 
	mmšËn
;

49 
	sfžes_¡©_¡ruù
 {

50 
	mÄ_fžes
;

51 
	mÄ_ä“_fžes
;

52 
	mmax_fžes
;

55 
	sšodes_¡©_t
 {

56 
	mÄ_šodes
;

57 
	mÄ_unu£d
;

58 
	mdummy
[5];

62 
	#NR_FILE
 8192

	)

68 
	#MS_RDONLY
 1

	)

69 
	#MS_NOSUID
 2

	)

70 
	#MS_NODEV
 4

	)

71 
	#MS_NOEXEC
 8

	)

72 
	#MS_SYNCHRONOUS
 16

	)

73 
	#MS_REMOUNT
 32

	)

74 
	#MS_MANDLOCK
 64

	)

75 
	#MS_DIRSYNC
 128

	)

76 
	#MS_NOATIME
 1024

	)

77 
	#MS_NODIRATIME
 2048

	)

78 
	#MS_BIND
 4096

	)

79 
	#MS_MOVE
 8192

	)

80 
	#MS_REC
 16384

	)

81 
	#MS_VERBOSE
 32768

	)

83 
	#MS_SILENT
 32768

	)

84 
	#MS_POSIXACL
 (1<<16è

	)

85 
	#MS_UNBINDABLE
 (1<<17è

	)

86 
	#MS_PRIVATE
 (1<<18è

	)

87 
	#MS_SLAVE
 (1<<19è

	)

88 
	#MS_SHARED
 (1<<20è

	)

89 
	#MS_RELATIME
 (1<<21è

	)

90 
	#MS_KERNMOUNT
 (1<<22è

	)

91 
	#MS_I_VERSION
 (1<<23è

	)

92 
	#MS_STRICTATIME
 (1<<24è

	)

93 
	#MS_LAZYTIME
 (1<<25è

	)

96 
	#MS_SUBMOUNT
 (1<<26)

	)

97 
	#MS_NOSEC
 (1<<28)

	)

98 
	#MS_BORN
 (1<<29)

	)

99 
	#MS_ACTIVE
 (1<<30)

	)

100 
	#MS_NOUSER
 (1<<31)

	)

105 
	#MS_RMT_MASK
 (
MS_RDONLY
|
MS_SYNCHRONOUS
|
MS_MANDLOCK
|
MS_I_VERSION
|\

106 
MS_LAZYTIME
)

	)

111 
	#MS_MGC_VAL
 0xC0ED0000

	)

112 
	#MS_MGC_MSK
 0xffff0000

	)

117 
	#BLKROSET
 
	`_IO
(0x12,93è

	)

118 
	#BLKROGET
 
	`_IO
(0x12,94è

	)

119 
	#BLKRRPART
 
	`_IO
(0x12,95è

	)

120 
	#BLKGETSIZE
 
	`_IO
(0x12,96è

	)

121 
	#BLKFLSBUF
 
	`_IO
(0x12,97è

	)

122 
	#BLKRASET
 
	`_IO
(0x12,98è

	)

123 
	#BLKRAGET
 
	`_IO
(0x12,99è

	)

124 
	#BLKFRASET
 
	`_IO
(0x12,100)

	)

125 
	#BLKFRAGET
 
	`_IO
(0x12,101)

	)

126 
	#BLKSECTSET
 
	`_IO
(0x12,102)

	)

127 
	#BLKSECTGET
 
	`_IO
(0x12,103)

	)

128 
	#BLKSSZGET
 
	`_IO
(0x12,104)

	)

130 
	#BLKPG
 
	`_IO
(0x12,105)

	)

134 
	#BLKELVGET
 
	`_IOR
(0x12,106,
size_t
)

	)

135 
	#BLKELVSET
 
	`_IOW
(0x12,107,
size_t
)

	)

140 
	#BLKBSZGET
 
	`_IOR
(0x12,112,
size_t
)

	)

141 
	#BLKBSZSET
 
	`_IOW
(0x12,113,
size_t
)

	)

142 
	#BLKGETSIZE64
 
	`_IOR
(0x12,114,
size_t
è

	)

143 
	#BLKTRACESETUP
 
	`_IOWR
(0x12,115,
blk_u£r_Œaû_£tup
)

	)

144 
	#BLKTRACESTART
 
	`_IO
(0x12,116)

	)

145 
	#BLKTRACESTOP
 
	`_IO
(0x12,117)

	)

146 
	#BLKTRACETEARDOWN
 
	`_IO
(0x12,118)

	)

147 
	#BLKDISCARD
 
	`_IO
(0x12,119)

	)

148 
	#BLKIOMIN
 
	`_IO
(0x12,120)

	)

149 
	#BLKIOOPT
 
	`_IO
(0x12,121)

	)

150 
	#BLKALIGNOFF
 
	`_IO
(0x12,122)

	)

151 
	#BLKPBSZGET
 
	`_IO
(0x12,123)

	)

152 
	#BLKDISCARDZEROES
 
	`_IO
(0x12,124)

	)

153 
	#BLKSECDISCARD
 
	`_IO
(0x12,125)

	)

154 
	#BLKROTATIONAL
 
	`_IO
(0x12,126)

	)

155 
	#BLKZEROOUT
 
	`_IO
(0x12,127)

	)

157 
	#BMAP_IOCTL
 1

	)

158 
	#FIBMAP
 
	`_IO
(0x00,1è

	)

159 
	#FIGETBSZ
 
	`_IO
(0x00,2è

	)

160 
	#FIFREEZE
 
	`_IOWR
('X', 119, è

	)

161 
	#FITHAW
 
	`_IOWR
('X', 120, è

	)

162 
	#FITRIM
 
	`_IOWR
('X', 121, 
f¡rim_¿nge
è

	)

164 
	#FS_IOC_GETFLAGS
 
	`_IOR
('f', 1, )

	)

165 
	#FS_IOC_SETFLAGS
 
	`_IOW
('f', 2, )

	)

166 
	#FS_IOC_GETVERSION
 
	`_IOR
('v', 1, )

	)

167 
	#FS_IOC_SETVERSION
 
	`_IOW
('v', 2, )

	)

168 
	#FS_IOC_FIEMAP
 
	`_IOWR
('f', 11, 
f›m­
)

	)

169 
	#FS_IOC32_GETFLAGS
 
	`_IOR
('f', 1, )

	)

170 
	#FS_IOC32_SETFLAGS
 
	`_IOW
('f', 2, )

	)

171 
	#FS_IOC32_GETVERSION
 
	`_IOR
('v', 1, )

	)

172 
	#FS_IOC32_SETVERSION
 
	`_IOW
('v', 2, )

	)

177 
	#FS_SECRM_FL
 0x00000001

	)

178 
	#FS_UNRM_FL
 0x00000002

	)

179 
	#FS_COMPR_FL
 0x00000004

	)

180 
	#FS_SYNC_FL
 0x00000008

	)

181 
	#FS_IMMUTABLE_FL
 0x00000010

	)

182 
	#FS_APPEND_FL
 0x00000020

	)

183 
	#FS_NODUMP_FL
 0x00000040

	)

184 
	#FS_NOATIME_FL
 0x00000080

	)

186 
	#FS_DIRTY_FL
 0x00000100

	)

187 
	#FS_COMPRBLK_FL
 0x00000200

	)

188 
	#FS_NOCOMP_FL
 0x00000400

	)

189 
	#FS_ECOMPR_FL
 0x00000800

	)

191 
	#FS_BTREE_FL
 0x00001000

	)

192 
	#FS_INDEX_FL
 0x00001000

	)

193 
	#FS_IMAGIC_FL
 0x00002000

	)

194 
	#FS_JOURNAL_DATA_FL
 0x00004000

	)

195 
	#FS_NOTAIL_FL
 0x00008000

	)

196 
	#FS_DIRSYNC_FL
 0x00010000

	)

197 
	#FS_TOPDIR_FL
 0x00020000

	)

198 
	#FS_EXTENT_FL
 0x00080000

	)

199 
	#FS_DIRECTIO_FL
 0x00100000

	)

200 
	#FS_NOCOW_FL
 0x00800000

	)

201 
	#FS_PROJINHERIT_FL
 0x20000000

	)

202 
	#FS_RESERVED_FL
 0x80000000

	)

204 
	#FS_FL_USER_VISIBLE
 0x0003DFFF

	)

205 
	#FS_FL_USER_MODIFIABLE
 0x000380FF

	)

208 
	#SYNC_FILE_RANGE_WAIT_BEFORE
 1

	)

209 
	#SYNC_FILE_RANGE_WRITE
 2

	)

210 
	#SYNC_FILE_RANGE_WAIT_AFTER
 4

	)

	@/usr/include/linux/kernel.h

1 #iâdeà
_LINUX_KERNEL_H


2 
	#_LINUX_KERNEL_H


	)

4 
	~<lšux/sysšfo.h
>

9 
	#__ALIGN_KERNEL
(
x
, 
a
è
	`__ALIGN_KERNEL_MASK
(x, (
	`ty³of
(x))×è- 1)

	)

10 
	#__ALIGN_KERNEL_MASK
(
x
, 
mask
è(((xè+ (mask)è& ~(mask))

	)

	@/usr/include/linux/magic.h

1 #iâdeà
__LINUX_MAGIC_H__


2 
	#__LINUX_MAGIC_H__


	)

4 
	#ADFS_SUPER_MAGIC
 0xadf5

	)

5 
	#AFFS_SUPER_MAGIC
 0xadff

	)

6 
	#AFS_SUPER_MAGIC
 0x5346414F

	)

7 
	#AUTOFS_SUPER_MAGIC
 0x0187

	)

8 
	#CODA_SUPER_MAGIC
 0x73757245

	)

9 
	#CRAMFS_MAGIC
 0x28cd3d45

	)

10 
	#CRAMFS_MAGIC_WEND
 0x453dcd28

	)

11 
	#DEBUGFS_MAGIC
 0x64626720

	)

12 
	#SECURITYFS_MAGIC
 0x73636673

	)

13 
	#SELINUX_MAGIC
 0xf97cff8c

	)

14 
	#SMACK_MAGIC
 0x43415d53

	)

15 
	#RAMFS_MAGIC
 0x858458f6

	)

16 
	#TMPFS_MAGIC
 0x01021994

	)

17 
	#HUGETLBFS_MAGIC
 0x958458f6

	)

18 
	#SQUASHFS_MAGIC
 0x73717368

	)

19 
	#ECRYPTFS_SUPER_MAGIC
 0xf15f

	)

20 
	#EFS_SUPER_MAGIC
 0x414A53

	)

21 
	#EXT2_SUPER_MAGIC
 0xEF53

	)

22 
	#EXT3_SUPER_MAGIC
 0xEF53

	)

23 
	#XENFS_SUPER_MAGIC
 0xabba1974

	)

24 
	#EXT4_SUPER_MAGIC
 0xEF53

	)

25 
	#BTRFS_SUPER_MAGIC
 0x9123683E

	)

26 
	#NILFS_SUPER_MAGIC
 0x3434

	)

27 
	#F2FS_SUPER_MAGIC
 0xF2F52010

	)

28 
	#HPFS_SUPER_MAGIC
 0xf995e849

	)

29 
	#ISOFS_SUPER_MAGIC
 0x9660

	)

30 
	#JFFS2_SUPER_MAGIC
 0x72b6

	)

31 
	#PSTOREFS_MAGIC
 0x6165676C

	)

32 
	#EFIVARFS_MAGIC
 0xde5e81e4

	)

33 
	#HOSTFS_SUPER_MAGIC
 0x00c0fãe

	)

35 
	#MINIX_SUPER_MAGIC
 0x137F

	)

36 
	#MINIX_SUPER_MAGIC2
 0x138F

	)

37 
	#MINIX2_SUPER_MAGIC
 0x2468

	)

38 
	#MINIX2_SUPER_MAGIC2
 0x2478

	)

39 
	#MINIX3_SUPER_MAGIC
 0x4d5¨

	)

41 
	#MSDOS_SUPER_MAGIC
 0x4d44

	)

42 
	#NCP_SUPER_MAGIC
 0x564ø

	)

43 
	#NFS_SUPER_MAGIC
 0x6969

	)

44 
	#OPENPROM_SUPER_MAGIC
 0x9ç1

	)

45 
	#QNX4_SUPER_MAGIC
 0x002à

	)

46 
	#QNX6_SUPER_MAGIC
 0x68191122

	)

48 
	#REISERFS_SUPER_MAGIC
 0x52654973

	)

51 
	#REISERFS_SUPER_MAGIC_STRING
 "ReIsErFs"

	)

52 
	#REISER2FS_SUPER_MAGIC_STRING
 "ReIsEr2Fs"

	)

53 
	#REISER2FS_JR_SUPER_MAGIC_STRING
 "ReIsEr3Fs"

	)

55 
	#SMB_SUPER_MAGIC
 0x517B

	)

56 
	#CGROUP_SUPER_MAGIC
 0x27e0eb

	)

59 
	#STACK_END_MAGIC
 0x57AC6E9D

	)

61 
	#TRACEFS_MAGIC
 0x74726163

	)

63 
	#V9FS_MAGIC
 0x01021997

	)

65 
	#BDEVFS_MAGIC
 0x62646576

	)

66 
	#BINFMTFS_MAGIC
 0x42494e4d

	)

67 
	#DEVPTS_SUPER_MAGIC
 0x1cd1

	)

68 
	#FUTEXFS_SUPER_MAGIC
 0xBAD1DEA

	)

69 
	#PIPEFS_MAGIC
 0x50495045

	)

70 
	#PROC_SUPER_MAGIC
 0x9ç0

	)

71 
	#SOCKFS_MAGIC
 0x534F434B

	)

72 
	#SYSFS_MAGIC
 0x62656572

	)

73 
	#USBDEVICE_SUPER_MAGIC
 0x9ç2

	)

74 
	#MTD_INODE_FS_MAGIC
 0x11307854

	)

75 
	#ANON_INODE_FS_MAGIC
 0x09041934

	)

76 
	#BTRFS_TEST_MAGIC
 0x73727279

	)

77 
	#NSFS_MAGIC
 0x6e736673

	)

78 
	#BPF_FS_MAGIC
 0xÿã4a11

	)

	@/usr/include/linux/random.h

7 #iâdeà
_LINUX_RANDOM_H


8 
	#_LINUX_RANDOM_H


	)

10 
	~<lšux/ty³s.h
>

11 
	~<lšux/ioùl.h
>

12 
	~<lšux/œqÄ.h
>

17 
	#RNDGETENTCNT
 
	`_IOR
Ð'R', 0x00, )

	)

20 
	#RNDADDTOENTCNT
 
	`_IOW
Ð'R', 0x01, )

	)

23 
	#RNDGETPOOL
 
	`_IOR
Ð'R', 0x02, [2] )

	)

29 
	#RNDADDENTROPY
 
	`_IOW
Ð'R', 0x03, [2] )

	)

32 
	#RNDZAPENTCNT
 
	`_IO
Ð'R', 0x04 )

	)

35 
	#RNDCLEARPOOL
 
	`_IO
Ð'R', 0x06 )

	)

37 
	s¿nd_poÞ_šfo
 {

38 
	m’ŒÝy_couÁ
;

39 
	mbuf_size
;

40 
__u32
 
	mbuf
[0];

49 
	#GRND_NONBLOCK
 0x0001

	)

50 
	#GRND_RANDOM
 0x0002

	)

	@/usr/include/linux/sched.h

1 #iâdeà
_LINUX_SCHED_H


2 
	#_LINUX_SCHED_H


	)

7 
	#CSIGNAL
 0x000000fà

	)

8 
	#CLONE_VM
 0x00000100

	)

9 
	#CLONE_FS
 0x00000200

	)

10 
	#CLONE_FILES
 0x00000400

	)

11 
	#CLONE_SIGHAND
 0x00000800

	)

12 
	#CLONE_PTRACE
 0x00002000

	)

13 
	#CLONE_VFORK
 0x00004000

	)

14 
	#CLONE_PARENT
 0x00008000

	)

15 
	#CLONE_THREAD
 0x00010000

	)

16 
	#CLONE_NEWNS
 0x00020000

	)

17 
	#CLONE_SYSVSEM
 0x00040000

	)

18 
	#CLONE_SETTLS
 0x00080000

	)

19 
	#CLONE_PARENT_SETTID
 0x00100000

	)

20 
	#CLONE_CHILD_CLEARTID
 0x00200000

	)

21 
	#CLONE_DETACHED
 0x00400000

	)

22 
	#CLONE_UNTRACED
 0x00800000

	)

23 
	#CLONE_CHILD_SETTID
 0x01000000

	)

24 
	#CLONE_NEWCGROUP
 0x02000000

	)

25 
	#CLONE_NEWUTS
 0x04000000

	)

26 
	#CLONE_NEWIPC
 0x08000000

	)

27 
	#CLONE_NEWUSER
 0x10000000

	)

28 
	#CLONE_NEWPID
 0x20000000

	)

29 
	#CLONE_NEWNET
 0x40000000

	)

30 
	#CLONE_IO
 0x80000000

	)

35 
	#SCHED_NORMAL
 0

	)

36 
	#SCHED_FIFO
 1

	)

37 
	#SCHED_RR
 2

	)

38 
	#SCHED_BATCH
 3

	)

40 
	#SCHED_IDLE
 5

	)

41 
	#SCHED_DEADLINE
 6

	)

44 
	#SCHED_RESET_ON_FORK
 0x40000000

	)

49 
	#SCHED_FLAG_RESET_ON_FORK
 0x01

	)

	@/usr/include/linux/string.h

1 #iâdeà
_LINUX_STRING_H_


2 
	#_LINUX_STRING_H_


	)

6 
	~<¡ršg.h
>

	@/usr/include/linux/time.h

1 #iâdeà
_LINUX_TIME_H


2 
	#_LINUX_TIME_H


	)

4 
	~<lšux/ty³s.h
>

7 #iâdeà
_STRUCT_TIMESPEC


8 
	#_STRUCT_TIMESPEC


	)

9 
	stime¥ec
 {

10 
__k”Ãl_time_t
 
	mtv_£c
;

11 
	mtv_n£c
;

15 
	stimev®
 {

16 
__k”Ãl_time_t
 
	mtv_£c
;

17 
__k”Ãl_su£cÚds_t
 
	mtv_u£c
;

20 
	stimezÚe
 {

21 
	mtz_mšu‹swe¡
;

22 
	mtz_d¡time
;

30 
	#ITIMER_REAL
 0

	)

31 
	#ITIMER_VIRTUAL
 1

	)

32 
	#ITIMER_PROF
 2

	)

34 
	s™im”¥ec
 {

35 
time¥ec
 
	m™_š‹rv®
;

36 
time¥ec
 
	m™_v®ue
;

39 
	s™im”v®
 {

40 
timev®
 
	m™_š‹rv®
;

41 
timev®
 
	m™_v®ue
;

47 
	#CLOCK_REALTIME
 0

	)

48 
	#CLOCK_MONOTONIC
 1

	)

49 
	#CLOCK_PROCESS_CPUTIME_ID
 2

	)

50 
	#CLOCK_THREAD_CPUTIME_ID
 3

	)

51 
	#CLOCK_MONOTONIC_RAW
 4

	)

52 
	#CLOCK_REALTIME_COARSE
 5

	)

53 
	#CLOCK_MONOTONIC_COARSE
 6

	)

54 
	#CLOCK_BOOTTIME
 7

	)

55 
	#CLOCK_REALTIME_ALARM
 8

	)

56 
	#CLOCK_BOOTTIME_ALARM
 9

	)

57 
	#CLOCK_SGI_CYCLE
 10

	)

58 
	#CLOCK_TAI
 11

	)

60 
	#MAX_CLOCKS
 16

	)

61 
	#CLOCKS_MASK
 (
CLOCK_REALTIME
 | 
CLOCK_MONOTONIC
)

	)

62 
	#CLOCKS_MONO
 
CLOCK_MONOTONIC


	)

67 
	#TIMER_ABSTIME
 0x01

	)

	@/usr/include/linux/types.h

1 #iâdeà
_LINUX_TYPES_H


2 
	#_LINUX_TYPES_H


	)

4 
	~<asm/ty³s.h
>

6 #iâdeà
__ASSEMBLY__


8 
	~<lšux/posix_ty³s.h
>

16 #ifdeà
__CHECKER__


17 
	#__b™wi£__
 
	`__©Œibu‹__
((
b™wi£
))

	)

19 
	#__b™wi£__


	)

21 #ifdeà
__CHECK_ENDIAN__


22 
	#__b™wi£
 
__b™wi£__


	)

24 
	#__b™wi£


	)

27 
__u16
 
	t__b™wi£
 
	t__Ë16
;

28 
__u16
 
	t__b™wi£
 
	t__be16
;

29 
__u32
 
	t__b™wi£
 
	t__Ë32
;

30 
__u32
 
	t__b™wi£
 
	t__be32
;

31 
__u64
 
	t__b™wi£
 
	t__Ë64
;

32 
__u64
 
	t__b™wi£
 
	t__be64
;

34 
__u16
 
	t__b™wi£
 
	t__sum16
;

35 
__u32
 
	t__b™wi£
 
	t__wsum
;

46 
	#__®igÃd_u64
 
__u64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

47 
	#__®igÃd_be64
 
__be64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

48 
	#__®igÃd_Ë64
 
__Ë64
 
	`__©Œibu‹__
((
	`®igÃd
(8)))

	)

	@/usr/include/linux/uio.h

9 #iâdeà
__LINUX_UIO_H


10 
	#__LINUX_UIO_H


	)

13 
	~<lšux/ty³s.h
>

16 
	siovec


18 *
	miov_ba£
;

19 
__k”Ãl_size_t
 
	miov_Ën
;

26 
	#UIO_FASTIOV
 8

	)

27 
	#UIO_MAXIOV
 1024

	)

	@/usr/include/linux/uuid.h

21 #iâdeà
_LINUX_UUID_H_


22 
	#_LINUX_UUID_H_


	)

24 
	~<lšux/ty³s.h
>

25 
	~<lšux/¡ršg.h
>

28 
__u8
 
	mb
[16];

29 } 
	tuuid_Ë
;

32 
__u8
 
	mb
[16];

33 } 
	tuuid_be
;

35 
	#UUID_LE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

36 ((
uuid_Ë
) \

37 {{ (
a
) & 0xff, ((a) >> 8) & 0xff, ((a) >> 16) & 0xff, ((a) >> 24) & 0xff, \

38 (
b
) & 0xff, ((b) >> 8) & 0xff, \

39 (
c
) & 0xff, ((c) >> 8) & 0xff, \

40 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

42 
	#UUID_BE
(
a
, 
b
, 
c
, 
d0
, 
d1
, 
d2
, 
d3
, 
d4
, 
d5
, 
d6
, 
d7
) \

43 ((
uuid_be
) \

44 {{ ((
a
) >> 24) & 0xff, ((a) >> 16) & 0xff, ((a) >> 8) & 0xff, (a) & 0xff, \

45 ((
b
) >> 8) & 0xff, (b) & 0xff, \

46 ((
c
) >> 8) & 0xff, (c) & 0xff, \

47 (
d0
), (
d1
), (
d2
), (
d3
), (
d4
), (
d5
), (
d6
), (
d7
è}})

	)

49 
	#NULL_UUID_LE
 \

50 
	`UUID_LE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

51 0x00, 0x00, 0x00, 0x00)

	)

53 
	#NULL_UUID_BE
 \

54 
	`UUID_BE
(0x00000000, 0x0000, 0x0000, 0x00, 0x00, 0x00, 0x00, \

55 0x00, 0x00, 0x00, 0x00)

	)

	@/usr/include/linux/wait.h

1 #iâdeà
_LINUX_WAIT_H


2 
	#_LINUX_WAIT_H


	)

4 
	#WNOHANG
 0x00000001

	)

5 
	#WUNTRACED
 0x00000002

	)

6 
	#WSTOPPED
 
WUNTRACED


	)

7 
	#WEXITED
 0x00000004

	)

8 
	#WCONTINUED
 0x00000008

	)

9 
	#WNOWAIT
 0x01000000

	)

11 
	#__WNOTHREAD
 0x20000000

	)

12 
	#__WALL
 0x40000000

	)

13 
	#__WCLONE
 0x80000000

	)

16 
	#P_ALL
 0

	)

17 
	#P_PID
 1

	)

18 
	#P_PGID
 2

	)

	@/usr/include/linux/xattr.h

11 
	~<lšux/libc-com·t.h
>

13 #iâdeà
_LINUX_XATTR_H


14 
	#_LINUX_XATTR_H


	)

16 #ià
__UAPI_DEF_XATTR


17 
	#__USE_KERNEL_XATTR_DEFS


	)

19 
	#XATTR_CREATE
 0x1

	)

20 
	#XATTR_REPLACE
 0x2

	)

24 
	#XATTR_OS2_PREFIX
 "os2."

	)

25 
	#XATTR_OS2_PREFIX_LEN
 ((
XATTR_OS2_PREFIX
è- 1)

	)

27 
	#XATTR_MAC_OSX_PREFIX
 "osx."

	)

28 
	#XATTR_MAC_OSX_PREFIX_LEN
 ((
XATTR_MAC_OSX_PREFIX
è- 1)

	)

30 
	#XATTR_BTRFS_PREFIX
 "bŒfs."

	)

31 
	#XATTR_BTRFS_PREFIX_LEN
 ((
XATTR_BTRFS_PREFIX
è- 1)

	)

33 
	#XATTR_SECURITY_PREFIX
 "£cur™y."

	)

34 
	#XATTR_SECURITY_PREFIX_LEN
 ((
XATTR_SECURITY_PREFIX
è- 1)

	)

36 
	#XATTR_SYSTEM_PREFIX
 "sy¡em."

	)

37 
	#XATTR_SYSTEM_PREFIX_LEN
 ((
XATTR_SYSTEM_PREFIX
è- 1)

	)

39 
	#XATTR_TRUSTED_PREFIX
 "Œu¡ed."

	)

40 
	#XATTR_TRUSTED_PREFIX_LEN
 ((
XATTR_TRUSTED_PREFIX
è- 1)

	)

42 
	#XATTR_USER_PREFIX
 "u£r."

	)

43 
	#XATTR_USER_PREFIX_LEN
 ((
XATTR_USER_PREFIX
è- 1)

	)

46 
	#XATTR_EVM_SUFFIX
 "evm"

	)

47 
	#XATTR_NAME_EVM
 
XATTR_SECURITY_PREFIX
 
XATTR_EVM_SUFFIX


	)

49 
	#XATTR_IMA_SUFFIX
 "ima"

	)

50 
	#XATTR_NAME_IMA
 
XATTR_SECURITY_PREFIX
 
XATTR_IMA_SUFFIX


	)

52 
	#XATTR_SELINUX_SUFFIX
 "£lšux"

	)

53 
	#XATTR_NAME_SELINUX
 
XATTR_SECURITY_PREFIX
 
XATTR_SELINUX_SUFFIX


	)

55 
	#XATTR_SMACK_SUFFIX
 "SMACK64"

	)

56 
	#XATTR_SMACK_IPIN
 "SMACK64IPIN"

	)

57 
	#XATTR_SMACK_IPOUT
 "SMACK64IPOUT"

	)

58 
	#XATTR_SMACK_EXEC
 "SMACK64EXEC"

	)

59 
	#XATTR_SMACK_TRANSMUTE
 "SMACK64TRANSMUTE"

	)

60 
	#XATTR_SMACK_MMAP
 "SMACK64MMAP"

	)

61 
	#XATTR_NAME_SMACK
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_SUFFIX


	)

62 
	#XATTR_NAME_SMACKIPIN
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPIN


	)

63 
	#XATTR_NAME_SMACKIPOUT
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_IPOUT


	)

64 
	#XATTR_NAME_SMACKEXEC
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_EXEC


	)

65 
	#XATTR_NAME_SMACKTRANSMUTE
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_TRANSMUTE


	)

66 
	#XATTR_NAME_SMACKMMAP
 
XATTR_SECURITY_PREFIX
 
XATTR_SMACK_MMAP


	)

68 
	#XATTR_CAPS_SUFFIX
 "ÿ·bž™y"

	)

69 
	#XATTR_NAME_CAPS
 
XATTR_SECURITY_PREFIX
 
XATTR_CAPS_SUFFIX


	)

71 
	#XATTR_POSIX_ACL_ACCESS
 "posix_aþ_acûss"

	)

72 
	#XATTR_NAME_POSIX_ACL_ACCESS
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_ACCESS


	)

73 
	#XATTR_POSIX_ACL_DEFAULT
 "posix_aþ_deçuÉ"

	)

74 
	#XATTR_NAME_POSIX_ACL_DEFAULT
 
XATTR_SYSTEM_PREFIX
 
XATTR_POSIX_ACL_DEFAULT


	)

	@/usr/include/linux/ioctl.h

1 #iâdeà
_LINUX_IOCTL_H


2 
	#_LINUX_IOCTL_H


	)

4 
	~<asm/ioùl.h
>

	@/usr/include/linux/irqnr.h

	@/usr/include/linux/libc-compat.h

48 #iâdeà
_LIBC_COMPAT_H


49 
	#_LIBC_COMPAT_H


	)

52 #ià
defšed
(
__GLIBC__
)

55 #ià
defšed
(
_NET_IF_H
è&& defšed(
__USE_MISC
)

60 
	#__UAPI_DEF_IF_IFCONF
 0

	)

61 
	#__UAPI_DEF_IF_IFMAP
 0

	)

62 
	#__UAPI_DEF_IF_IFNAMSIZ
 0

	)

63 
	#__UAPI_DEF_IF_IFREQ
 0

	)

65 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 0

	)

67 #iâdeà
__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO


68 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

77 
	#__UAPI_DEF_IF_IFCONF
 1

	)

78 
	#__UAPI_DEF_IF_IFMAP
 1

	)

79 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

80 
	#__UAPI_DEF_IF_IFREQ
 1

	)

82 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

84 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

89 #ià
defšed
(
_NETINET_IN_H
)

93 
	#__UAPI_DEF_IN_ADDR
 0

	)

94 
	#__UAPI_DEF_IN_IPPROTO
 0

	)

95 
	#__UAPI_DEF_IN_PKTINFO
 0

	)

96 
	#__UAPI_DEF_IP_MREQ
 0

	)

97 
	#__UAPI_DEF_SOCKADDR_IN
 0

	)

98 
	#__UAPI_DEF_IN_CLASS
 0

	)

100 
	#__UAPI_DEF_IN6_ADDR
 0

	)

105 #ià
defšed
(
__USE_MISC
è|| defšed (
__USE_GNU
)

106 
	#__UAPI_DEF_IN6_ADDR_ALT
 0

	)

108 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

110 
	#__UAPI_DEF_SOCKADDR_IN6
 0

	)

111 
	#__UAPI_DEF_IPV6_MREQ
 0

	)

112 
	#__UAPI_DEF_IPPROTO_V6
 0

	)

113 
	#__UAPI_DEF_IPV6_OPTIONS
 0

	)

114 
	#__UAPI_DEF_IN6_PKTINFO
 0

	)

115 
	#__UAPI_DEF_IP6_MTUINFO
 0

	)

122 
	#__UAPI_DEF_IN_ADDR
 1

	)

123 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

124 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

125 
	#__UAPI_DEF_IP_MREQ
 1

	)

126 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

127 
	#__UAPI_DEF_IN_CLASS
 1

	)

129 
	#__UAPI_DEF_IN6_ADDR
 1

	)

132 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

133 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

134 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

135 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

136 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

137 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

138 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

143 #ià
defšed
(
_SYS_XATTR_H
)

144 
	#__UAPI_DEF_XATTR
 0

	)

146 
	#__UAPI_DEF_XATTR
 1

	)

155 
	#__UAPI_DEF_IF_IFCONF
 1

	)

156 
	#__UAPI_DEF_IF_IFMAP
 1

	)

157 
	#__UAPI_DEF_IF_IFNAMSIZ
 1

	)

158 
	#__UAPI_DEF_IF_IFREQ
 1

	)

160 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS
 1

	)

162 
	#__UAPI_DEF_IF_NET_DEVICE_FLAGS_LOWER_UP_DORMANT_ECHO
 1

	)

165 
	#__UAPI_DEF_IN_ADDR
 1

	)

166 
	#__UAPI_DEF_IN_IPPROTO
 1

	)

167 
	#__UAPI_DEF_IN_PKTINFO
 1

	)

168 
	#__UAPI_DEF_IP_MREQ
 1

	)

169 
	#__UAPI_DEF_SOCKADDR_IN
 1

	)

170 
	#__UAPI_DEF_IN_CLASS
 1

	)

173 
	#__UAPI_DEF_IN6_ADDR
 1

	)

174 
	#__UAPI_DEF_IN6_ADDR_ALT
 1

	)

175 
	#__UAPI_DEF_SOCKADDR_IN6
 1

	)

176 
	#__UAPI_DEF_IPV6_MREQ
 1

	)

177 
	#__UAPI_DEF_IPPROTO_V6
 1

	)

178 
	#__UAPI_DEF_IPV6_OPTIONS
 1

	)

179 
	#__UAPI_DEF_IN6_PKTINFO
 1

	)

180 
	#__UAPI_DEF_IP6_MTUINFO
 1

	)

183 
	#__UAPI_DEF_XATTR
 1

	)

	@/usr/include/linux/limits.h

1 #iâdeà
_LINUX_LIMITS_H


2 
	#_LINUX_LIMITS_H


	)

4 
	#NR_OPEN
 1024

	)

6 
	#NGROUPS_MAX
 65536

	)

7 
	#ARG_MAX
 131072

	)

8 
	#LINK_MAX
 127

	)

9 
	#MAX_CANON
 255

	)

10 
	#MAX_INPUT
 255

	)

11 
	#NAME_MAX
 255

	)

12 
	#PATH_MAX
 4096

	)

13 
	#PIPE_BUF
 4096

	)

14 
	#XATTR_NAME_MAX
 255

	)

15 
	#XATTR_SIZE_MAX
 65536

	)

16 
	#XATTR_LIST_MAX
 65536

	)

18 
	#RTSIG_MAX
 32

	)

	@/usr/include/linux/posix_types.h

1 #iâdeà
_LINUX_POSIX_TYPES_H


2 
	#_LINUX_POSIX_TYPES_H


	)

4 
	~<lšux/¡ddef.h
>

21 #undeà
__FD_SETSIZE


22 
	#__FD_SETSIZE
 1024

	)

25 
	mfds_b™s
[
__FD_SETSIZE
 / (8 * ())];

26 } 
	t__k”Ãl_fd_£t
;

29 (*
	t__k”Ãl_sighªdËr_t
)();

32 
	t__k”Ãl_key_t
;

33 
	t__k”Ãl_mqd_t
;

35 
	~<asm/posix_ty³s.h
>

	@/usr/include/linux/sysinfo.h

1 #iâdeà
_LINUX_SYSINFO_H


2 
	#_LINUX_SYSINFO_H


	)

4 
	~<lšux/ty³s.h
>

6 
	#SI_LOAD_SHIFT
 16

	)

7 
	ssysšfo
 {

8 
__k”Ãl_lÚg_t
 
	mu±ime
;

9 
__k”Ãl_ulÚg_t
 
	mlßds
[3];

10 
__k”Ãl_ulÚg_t
 
	mtÙ®¿m
;

11 
__k”Ãl_ulÚg_t
 
	mä“¿m
;

12 
__k”Ãl_ulÚg_t
 
	msh¬ed¿m
;

13 
__k”Ãl_ulÚg_t
 
	mbufã¼am
;

14 
__k”Ãl_ulÚg_t
 
	mtÙ®sw­
;

15 
__k”Ãl_ulÚg_t
 
	mä“sw­
;

16 
__u16
 
	m´ocs
;

17 
__u16
 
	m·d
;

18 
__k”Ãl_ulÚg_t
 
	mtÙ®high
;

19 
__k”Ãl_ulÚg_t
 
	mä“high
;

20 
__u32
 
	mmem_un™
;

21 
	m_f
[20-2*(
__k”Ãl_ulÚg_t
)-(
__u32
)];

	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


30 
	#__Ãed_size_t


	)

31 
	#__Ãed_NULL


	)

32 
	~<¡ddef.h
>

35 #ià
defšed
 
__ýlu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

36 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

40 
__BEGIN_NAMESPACE_STD


42 *
	$memýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

48 
__END_NAMESPACE_STD


53 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


54 *
	$memcýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

55 
__c
, 
size_t
 
__n
)

56 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 
__BEGIN_NAMESPACE_STD


62 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

65 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

66 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

69 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


72 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

74 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

75 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

77 #ifdeà
__OPTIMIZE__


78 
__ex‹º_®ways_šlše
 *

79 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


81  
	`__bužtš_memchr
 (
__s
, 
__c
, 
__n
);

84 
__ex‹º_®ways_šlše
 const *

85 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


87  
	`__bužtš_memchr
 (
__s
, 
__c
, 
__n
);

90 
	}
}

92 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

93 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

95 
__END_NAMESPACE_STD


97 #ifdeà
__USE_GNU


100 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


101 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

102 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

106 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

107 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


112 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

113 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

117 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

118 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

123 
__BEGIN_NAMESPACE_STD


125 *
	$¡rýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

128 *
	$¡ºýy
 (*
__»¡riù
 
__de¡
,

129 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

133 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

134 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

137 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

140 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

141 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

147 
	$¡rcÞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

148 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

150 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

151 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

152 
__THROW
 
	`__nÚnuÎ
 ((2));

153 
__END_NAMESPACE_STD


155 #ifdeà
__USE_XOPEN2K8


159 
	~<xloÿË.h
>

162 
	$¡rcÞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
__loÿË_t
 
__l
)

163 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

165 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

166 
__loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

169 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


171 *
	$¡rdup
 (cÚ¡ *
__s
)

172 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_XOPEN2K8


179 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

180 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

183 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


185 
	#¡rdu·
(
s
) \

186 (
__ex‹nsiÚ__
 \

188 cÚ¡ *
__Þd
 = (
s
); \

189 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Þd
) + 1; \

190 *
__Ãw
 = (*è
	`__bužtš_®loÿ
 (
__Ën
); \

191 (*è
	`memýy
 (
__Ãw
, 
__Þd
, 
__Ën
); \

192 
	}
}))

	)

195 
	#¡ºdu·
(
s
, 
n
) \

196 (
__ex‹nsiÚ__
 \

198 cÚ¡ *
__Þd
 = (
s
); \

199 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Þd
, (
n
)); \

200 *
__Ãw
 = (*è
	`__bužtš_®loÿ
 (
__Ën
 + 1); \

201 
__Ãw
[
__Ën
] = '\0'; \

202 (*è
	`memýy
 (
__Ãw
, 
__Þd
, 
__Ën
); \

203 }))

	)

206 
	g__BEGIN_NAMESPACE_STD


208 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


211 *
¡rchr
 (*
__s
, 
__c
)

212 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

213 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

214 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

216 #ifdeà
__OPTIMIZE__


217 
__ex‹º_®ways_šlše
 *

218 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


220  
__bužtš_¡rchr
 (
__s
, 
__c
);

223 
__ex‹º_®ways_šlše
 const *

224 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


226  
__bužtš_¡rchr
 (
__s
, 
__c
);

231 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

232 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

235 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


238 *
	`¡¼chr
 (*
__s
, 
__c
)

239 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

240 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

241 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__OPTIMIZE__


244 
__ex‹º_®ways_šlše
 *

245 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


247  
	`__bužtš_¡¼chr
 (
__s
, 
__c
);

250 
__ex‹º_®ways_šlše
 const *

251 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


253  
	`__bužtš_¡¼chr
 (
__s
, 
__c
);

256 
	}
}

258 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

259 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

261 
__END_NAMESPACE_STD


263 #ifdeà
__USE_GNU


266 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


267 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

268 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

269 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

270 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

277 
__BEGIN_NAMESPACE_STD


280 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

281 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


290 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

291 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

292 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

293 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

295 #ifdeà
__OPTIMIZE__


296 
__ex‹º_®ways_šlše
 *

297 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


299  
	`__bužtš_¡½brk
 (
__s
, 
__acû±
);

302 
__ex‹º_®ways_šlše
 const *

303 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


305  
	`__bužtš_¡½brk
 (
__s
, 
__acû±
);

308 
	}
}

310 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

311 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


317 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

318 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

319 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

320 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

322 #ifdeà
__OPTIMIZE__


323 
__ex‹º_®ways_šlše
 *

324 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


326  
	`__bužtš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

329 
__ex‹º_®ways_šlše
 const *

330 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


332  
	`__bužtš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

335 
	}
}

337 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

338 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

343 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

344 
__THROW
 
	`__nÚnuÎ
 ((2));

345 
__END_NAMESPACE_STD


349 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

350 cÚ¡ *
__»¡riù
 
__d–im
,

351 **
__»¡riù
 
__§ve_±r
)

352 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

353 #ifdeà
__USE_POSIX


354 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

355 **
__»¡riù
 
__§ve_±r
)

356 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

359 #ifdeà
__USE_GNU


361 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


362 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

363 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

365 cÚ¡ *
__ÃedË
)

366 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

368 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

369 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

373 #ifdeà
__USE_GNU


377 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

378 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

379 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

383 *
	$__mempýy
 (*
__»¡riù
 
__de¡
,

384 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

386 *
	$mempýy
 (*
__»¡riù
 
__de¡
,

387 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

388 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

392 
__BEGIN_NAMESPACE_STD


394 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

395 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 
__END_NAMESPACE_STD


398 #ifdef 
__USE_XOPEN2K8


401 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

402 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

406 
__BEGIN_NAMESPACE_STD


408 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

409 
__END_NAMESPACE_STD


410 #ifdeà
__USE_XOPEN2K


418 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


421 #ifdeà
__REDIRECT_NTH


422 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

423 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

424 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

426 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

427 
__THROW
 
	`__nÚnuÎ
 ((2));

428 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

433 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

434 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

438 #ifdeà
__USE_XOPEN2K8


440 *
	$¡»¼Ü_l
 (
__”ºum
, 
__loÿË_t
 
__l
è
__THROW
;

446 
	$__bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

448 #ifdeà
__USE_MISC


450 
	$bcÝy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

451 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

454 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

457 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

458 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

461 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


464 *
	`šdex
 (*
__s
, 
__c
)

465 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

466 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

467 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

469 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


470 
__ex‹º_®ways_šlše
 *

471 
	`šdex
 (*
__s
, 
__c
è
__THROW


473  
	`__bužtš_šdex
 (
__s
, 
__c
);

476 
__ex‹º_®ways_šlše
 const *

477 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


479  
	`__bužtš_šdex
 (
__s
, 
__c
);

482 
	}
}

484 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

485 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

489 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


492 *
	`ršdex
 (*
__s
, 
__c
)

493 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

494 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

495 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

497 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__CORRECT_ISO_CPP_STRINGS_H_PROTO


498 
__ex‹º_®ways_šlše
 *

499 
	`ršdex
 (*
__s
, 
__c
è
__THROW


501  
	`__bužtš_ršdex
 (
__s
, 
__c
);

504 
__ex‹º_®ways_šlše
 const *

505 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


507  
	`__bužtš_ršdex
 (
__s
, 
__c
);

510 
	}
}

512 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

513 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

518 
	$ffs
 (
__i
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

522 #ifdef 
__USE_GNU


523 
	$ff¦
 (
__l
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

524 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

525 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

529 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

530 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

533 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

534 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

537 #ifdef 
__USE_GNU


540 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

541 
__loÿË_t
 
__loc
)

542 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

544 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

545 
size_t
 
__n
, 
__loÿË_t
 
__loc
)

546 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

549 #ifdef 
__USE_MISC


552 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

553 cÚ¡ *
__»¡riù
 
__d–im
)

554 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdef 
__USE_XOPEN2K8


559 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

562 *
	$__¡pýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

563 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

564 *
	$¡pýy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

565 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

569 *
	$__¡²ýy
 (*
__»¡riù
 
__de¡
,

570 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

571 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

572 *
	$¡²ýy
 (*
__»¡riù
 
__de¡
,

573 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

574 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

577 #ifdef 
__USE_GNU


579 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

580 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

583 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

586 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

588 #iâdeà
ba£Çme


593 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


594 "C++" *
	$ba£Çme
 (*
__fž’ame
)

595 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

596 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__fž’ame
)

597 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

599 *
	$ba£Çme
 (cÚ¡ *
__fž’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

605 #ià
defšed
 
__GNUC__
 && __GNUC__ >= 2

606 #ià
defšed
 
__OPTIMIZE__
 && !defšed 
__OPTIMIZE_SIZE__
 \

607 && !
defšed
 
__NO_INLINE__
 && !defšed 
__ýlu¥lus


627 
	~<b™s/¡ršg.h
>

630 
	~<b™s/¡ršg2.h
>

633 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


635 
	~<b™s/¡ršg3.h
>

639 #ià
defšed
 
__USE_GNU
 && defšed 
__OPTIMIZE__
 \

640 && 
defšed
 
__ex‹º_®ways_šlše
 && 
	$__GNUC_PREREQ
 (3,2)

641 #ià!
defšed
 
_FORCE_INLINES
 && !defšed 
_HAVE_STRING_ARCH_mempýy


643 #undeà
mempýy


644 #undeà
__mempýy


645 
	#mempýy
(
de¡
, 
¤c
, 
n
è
	`__mempýy_šlše
 (de¡, src,‚)

	)

646 
	#__mempýy
(
de¡
, 
¤c
, 
n
è
	`__mempýy_šlše
 (de¡, src,‚)

	)

648 
__ex‹º_®ways_šlše
 *

649 
	$__mempýy_šlše
 (*
__»¡riù
 
__de¡
,

650 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

652  (*è
	`memýy
 (
__de¡
, 
__¤c
, 
__n
) + __n;

653 
	}
}

658 
	g__END_DECLS


	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

97 #undeà
__USE_ISOC11


98 #undeà
__USE_ISOC99


99 #undeà
__USE_ISOC95


100 #undeà
__USE_ISOCXX11


101 #undeà
__USE_POSIX


102 #undeà
__USE_POSIX2


103 #undeà
__USE_POSIX199309


104 #undeà
__USE_POSIX199506


105 #undeà
__USE_XOPEN


106 #undeà
__USE_XOPEN_EXTENDED


107 #undeà
__USE_UNIX98


108 #undeà
__USE_XOPEN2K


109 #undeà
__USE_XOPEN2KXSI


110 #undeà
__USE_XOPEN2K8


111 #undeà
__USE_XOPEN2K8XSI


112 #undeà
__USE_LARGEFILE


113 #undeà
__USE_LARGEFILE64


114 #undeà
__USE_FILE_OFFSET64


115 #undeà
__USE_MISC


116 #undeà
__USE_ATFILE


117 #undeà
__USE_GNU


118 #undeà
__USE_REENTRANT


119 #undeà
__USE_FORTIFY_LEVEL


120 #undeà
__KERNEL_STRICT_NAMES


124 #iâdeà
_LOOSE_KERNEL_NAMES


125 
	#__KERNEL_STRICT_NAMES


	)

135 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


136 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

137 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ð((
maj
è<< 16è+ (
mš
))

	)

139 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

146 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

147 && !
defšed
 
	g_DEFAULT_SOURCE


152 #undeà
_DEFAULT_SOURCE


153 
	#_DEFAULT_SOURCE
 1

	)

157 #ifdeà
_GNU_SOURCE


158 #undeà
_ISOC95_SOURCE


159 
	#_ISOC95_SOURCE
 1

	)

160 #undeà
_ISOC99_SOURCE


161 
	#_ISOC99_SOURCE
 1

	)

162 #undeà
_ISOC11_SOURCE


163 
	#_ISOC11_SOURCE
 1

	)

164 #undeà
_POSIX_SOURCE


165 
	#_POSIX_SOURCE
 1

	)

166 #undeà
_POSIX_C_SOURCE


167 
	#_POSIX_C_SOURCE
 200809L

	)

168 #undeà
_XOPEN_SOURCE


169 
	#_XOPEN_SOURCE
 700

	)

170 #undeà
_XOPEN_SOURCE_EXTENDED


171 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

172 #undeà
_LARGEFILE64_SOURCE


173 
	#_LARGEFILE64_SOURCE
 1

	)

174 #undeà
_DEFAULT_SOURCE


175 
	#_DEFAULT_SOURCE
 1

	)

176 #undeà
_ATFILE_SOURCE


177 
	#_ATFILE_SOURCE
 1

	)

182 #ià(
defšed
 
_DEFAULT_SOURCE
 \

183 || (!
defšed
 
	g__STRICT_ANSI__
 \

184 && !
defšed
 
	g_ISOC99_SOURCE
 \

185 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

186 && !
defšed
 
	g_XOPEN_SOURCE
))

187 #undeà
_DEFAULT_SOURCE


188 
	#_DEFAULT_SOURCE
 1

	)

192 #ià(
defšed
 
_ISOC11_SOURCE
 \

193 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

194 
	#__USE_ISOC11
 1

	)

198 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

199 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

200 
	#__USE_ISOC99
 1

	)

204 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

205 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

206 
	#__USE_ISOC95
 1

	)

213 #ià((
defšed
 
__ýlu¥lus
 && __cplusplus >= 201103L) \

214 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

215 
	#__USE_ISOCXX11
 1

	)

221 #ifdeà
_DEFAULT_SOURCE


222 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


223 
	#__USE_POSIX_IMPLICITLY
 1

	)

225 #undeà
_POSIX_SOURCE


226 
	#_POSIX_SOURCE
 1

	)

227 #undeà
_POSIX_C_SOURCE


228 
	#_POSIX_C_SOURCE
 200809L

	)

230 #ià((!
defšed
 
__STRICT_ANSI__
 \

231 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

232 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

233 
	#_POSIX_SOURCE
 1

	)

234 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

235 
	#_POSIX_C_SOURCE
 2

	)

236 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

237 
	#_POSIX_C_SOURCE
 199506L

	)

238 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

239 
	#_POSIX_C_SOURCE
 200112L

	)

241 
	#_POSIX_C_SOURCE
 200809L

	)

243 
	#__USE_POSIX_IMPLICITLY
 1

	)

246 #ià(
defšed
 
_POSIX_SOURCE
 \

247 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

248 || 
defšed
 
_XOPEN_SOURCE
)

249 
	#__USE_POSIX
 1

	)

252 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ð2 || defšed 
_XOPEN_SOURCE


253 
	#__USE_POSIX2
 1

	)

256 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

257 
	#__USE_POSIX199309
 1

	)

260 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

261 
	#__USE_POSIX199506
 1

	)

264 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

265 
	#__USE_XOPEN2K
 1

	)

266 #undeà
__USE_ISOC95


267 
	#__USE_ISOC95
 1

	)

268 #undeà
__USE_ISOC99


269 
	#__USE_ISOC99
 1

	)

272 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

273 
	#__USE_XOPEN2K8
 1

	)

274 #undeà
_ATFILE_SOURCE


275 
	#_ATFILE_SOURCE
 1

	)

278 #ifdef 
_XOPEN_SOURCE


279 
	#__USE_XOPEN
 1

	)

280 #ià(
_XOPEN_SOURCE
 - 0) >= 500

281 
	#__USE_XOPEN_EXTENDED
 1

	)

282 
	#__USE_UNIX98
 1

	)

283 #undeà
_LARGEFILE_SOURCE


284 
	#_LARGEFILE_SOURCE
 1

	)

285 #ià(
_XOPEN_SOURCE
 - 0) >= 600

286 #ià(
_XOPEN_SOURCE
 - 0) >= 700

287 
	#__USE_XOPEN2K8
 1

	)

288 
	#__USE_XOPEN2K8XSI
 1

	)

290 
	#__USE_XOPEN2K
 1

	)

291 
	#__USE_XOPEN2KXSI
 1

	)

292 #undeà
__USE_ISOC95


293 
	#__USE_ISOC95
 1

	)

294 #undeà
__USE_ISOC99


295 
	#__USE_ISOC99
 1

	)

298 #ifdeà
_XOPEN_SOURCE_EXTENDED


299 
	#__USE_XOPEN_EXTENDED
 1

	)

304 #ifdeà
_LARGEFILE_SOURCE


305 
	#__USE_LARGEFILE
 1

	)

308 #ifdeà
_LARGEFILE64_SOURCE


309 
	#__USE_LARGEFILE64
 1

	)

312 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

313 
	#__USE_FILE_OFFSET64
 1

	)

316 #ià
defšed
 
_DEFAULT_SOURCE


317 
	#__USE_MISC
 1

	)

320 #ifdef 
_ATFILE_SOURCE


321 
	#__USE_ATFILE
 1

	)

324 #ifdef 
_GNU_SOURCE


325 
	#__USE_GNU
 1

	)

328 #ià
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE


329 
	#__USE_REENTRANT
 1

	)

332 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

333 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

334 #ià
_FORTIFY_SOURCE
 > 1

335 
	#__USE_FORTIFY_LEVEL
 2

	)

337 
	#__USE_FORTIFY_LEVEL
 1

	)

340 
	#__USE_FORTIFY_LEVEL
 0

	)

345 
	~<¡dc-´edef.h
>

353 #undeà
__GNU_LIBRARY__


354 
	#__GNU_LIBRARY__
 6

	)

358 
	#__GLIBC__
 2

	)

359 
	#__GLIBC_MINOR__
 23

	)

361 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

362 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ð((
maj
è<< 16è+ (
mš
))

	)

365 #iâdeà
__ASSEMBLER__


366 #iâdeà
_SYS_CDEFS_H


367 
	~<sys/cdefs.h
>

372 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


373 
	#__USE_LARGEFILE
 1

	)

374 
	#__USE_LARGEFILE64
 1

	)

380 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

381 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

382 && 
defšed
 
	g__ex‹º_šlše


383 
	#__USE_EXTERN_INLINES
 1

	)

391 
	~<gnu/¡ubs.h
>

	@/usr/include/linux/stddef.h

	@/usr/include/xlocale.h

20 #iâdeà
_XLOCALE_H


21 
	#_XLOCALE_H
 1

	)

27 
	s__loÿË_¡ruù


30 
__loÿË_d©a
 *
	m__loÿËs
[13];

33 cÚ¡ *
	m__ùy³_b
;

34 cÚ¡ *
	m__ùy³_tÞow”
;

35 cÚ¡ *
	m__ùy³_touµ”
;

38 cÚ¡ *
	m__Çmes
[13];

39 } *
	t__loÿË_t
;

42 
__loÿË_t
 
	tloÿË_t
;

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

55 
	#__STDC_ISO_10646__
 201505L

	)

58 
	#__STDC_NO_THREADS__
 1

	)

	@
1
.
1
/usr/include
119
1846
Module.symvers
acl.c
async-thread.c
async-thread.h
backref.c
backref.h
btrfs.mod.c
btrfs_inode.h
check-integrity.c
check-integrity.h
compression.c
compression.h
ctree.c
ctree.h
dedupe.h
delayed-inode.c
delayed-inode.h
delayed-ref.c
delayed-ref.h
dev-replace.c
dev-replace.h
dir-item.c
disk-io.c
disk-io.h
export.c
export.h
extent-tree.c
extent_io.c
extent_io.h
extent_map.c
extent_map.h
file-item.c
file.c
free-space-cache.c
free-space-cache.h
free-space-tree.c
free-space-tree.h
hash.c
hash.h
inode-item.c
inode-map.c
inode-map.h
inode.c
ioctl.c
locking.c
locking.h
lzo.c
math.h
ordered-data.c
ordered-data.h
orphan.c
print-tree.c
print-tree.h
props.c
props.h
qgroup.c
qgroup.h
raid56.c
raid56.h
rcu-string.h
reada.c
relocation.c
root-tree.c
scrub.c
send.c
send.h
struct-funcs.c
super.c
sysfs.c
sysfs.h
tags
tests/btrfs-tests.c
tests/btrfs-tests.h
tests/extent-buffer-tests.c
tests/extent-io-tests.c
tests/free-space-tests.c
tests/free-space-tree-tests.c
tests/inode-tests.c
tests/qgroup-tests.c
transaction.c
transaction.h
tree-defrag.c
tree-log.c
tree-log.h
ulist.c
ulist.h
uuid-tree.c
volumes.c
volumes.h
xattr.c
xattr.h
zlib.c
zstd.c
/usr/include/linux/btrfs.h
/usr/include/linux/capability.h
/usr/include/linux/falloc.h
/usr/include/linux/fs.h
/usr/include/linux/kernel.h
/usr/include/linux/magic.h
/usr/include/linux/random.h
/usr/include/linux/sched.h
/usr/include/linux/string.h
/usr/include/linux/time.h
/usr/include/linux/types.h
/usr/include/linux/uio.h
/usr/include/linux/uuid.h
/usr/include/linux/wait.h
/usr/include/linux/xattr.h
/usr/include/linux/ioctl.h
/usr/include/linux/irqnr.h
/usr/include/linux/libc-compat.h
/usr/include/linux/limits.h
/usr/include/linux/posix_types.h
/usr/include/linux/sysinfo.h
/usr/include/string.h
/usr/include/features.h
/usr/include/linux/stddef.h
/usr/include/xlocale.h
/usr/include/stdc-predef.h
